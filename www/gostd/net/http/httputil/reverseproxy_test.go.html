<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8119938">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8119993">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8120047">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8120098">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8120123">package</span>&nbsp;<span class="ident" id="8120131">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8120141">import</span>&nbsp;<span class="op" id="8120148">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120151">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120164">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120176">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120197">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120208">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120219">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8120230">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8120237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8120240">const</span>&nbsp;<span class="ident" id="8120246">fakeHopHeader</span>&nbsp;<span class="op" id="8120260">=</span>&nbsp;<span class="string" id="8120262">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8120292">func</span>&nbsp;<span class="ident" id="8120297">init</span><span class="op" id="8120301">(</span><span class="op" id="8120302">)</span>&nbsp;<span class="op" id="8120304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120307">hopHeaders</span>&nbsp;<span class="op" id="8120318">=</span>&nbsp;<span class="builtinfunc" id="8120320">append</span><span class="op" id="8120326">(</span><span class="ident" id="8120327">hopHeaders</span><span class="op" id="8120337">,</span>&nbsp;<span class="ident" id="8120339">fakeHopHeader</span><span class="op" id="8120352">)</span><br>
<span class="lineno"></span><span class="op" id="8120354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8120357">func</span>&nbsp;<span class="ident" id="8120362">TestReverseProxy</span><span class="op" id="8120378">(</span><span class="ident" id="8120379">t</span>&nbsp;<span class="op" id="8120381">*</span><span class="ident" id="8120382">testing</span><span class="op" id="8120389">.</span><span class="ident" id="8120390">T</span><span class="op" id="8120391">)</span>&nbsp;<span class="op" id="8120393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120396">const</span>&nbsp;<span class="ident" id="8120402">backendResponse</span>&nbsp;<span class="op" id="8120418">=</span>&nbsp;<span class="string" id="8120420">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120440">const</span>&nbsp;<span class="ident" id="8120446">backendStatus</span>&nbsp;<span class="op" id="8120460">=</span>&nbsp;<span class="num" id="8120462">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120467">backend</span>&nbsp;<span class="op" id="8120475">:=</span>&nbsp;<span class="ident" id="8120478">httptest</span><span class="op" id="8120486">.</span><span class="ident" id="8120487">NewServer</span><span class="op" id="8120496">(</span><span class="ident" id="8120497">http</span><span class="op" id="8120501">.</span><span class="ident" id="8120502">HandlerFunc</span><span class="op" id="8120513">(</span><span class="keyword" id="8120514">func</span><span class="op" id="8120518">(</span><span class="ident" id="8120519">w</span>&nbsp;<span class="ident" id="8120521">http</span><span class="op" id="8120525">.</span><span class="ident" id="8120526">ResponseWriter</span><span class="op" id="8120540">,</span>&nbsp;<span class="ident" id="8120542">r</span>&nbsp;<span class="op" id="8120544">*</span><span class="ident" id="8120545">http</span><span class="op" id="8120549">.</span><span class="ident" id="8120550">Request</span><span class="op" id="8120557">)</span>&nbsp;<span class="op" id="8120559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120563">if</span>&nbsp;<span class="builtinfunc" id="8120566">len</span><span class="op" id="8120569">(</span><span class="ident" id="8120570">r</span><span class="op" id="8120571">.</span><span class="ident" id="8120572">TransferEncoding</span><span class="op" id="8120588">)</span>&nbsp;<span class="op" id="8120590">&gt;</span>&nbsp;<span class="num" id="8120592">0</span>&nbsp;<span class="op" id="8120594">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120599">t</span><span class="op" id="8120600">.</span><span class="ident" id="8120601">Errorf</span><span class="op" id="8120607">(</span><span class="string" id="8120608">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="8120653">,</span>&nbsp;<span class="ident" id="8120655">r</span><span class="op" id="8120656">.</span><span class="ident" id="8120657">TransferEncoding</span><span class="op" id="8120673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120681">if</span>&nbsp;<span class="ident" id="8120684">r</span><span class="op" id="8120685">.</span><span class="ident" id="8120686">Header</span><span class="op" id="8120692">.</span><span class="ident" id="8120693">Get</span><span class="op" id="8120696">(</span><span class="string" id="8120697">&#34;X-Forwarded-For&#34;</span><span class="op" id="8120714">)</span>&nbsp;<span class="op" id="8120716">==</span>&nbsp;<span class="string" id="8120719">&#34;&#34;</span>&nbsp;<span class="op" id="8120722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120727">t</span><span class="op" id="8120728">.</span><span class="ident" id="8120729">Errorf</span><span class="op" id="8120735">(</span><span class="string" id="8120736">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8120771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120775">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120779">if</span>&nbsp;<span class="ident" id="8120782">c</span>&nbsp;<span class="op" id="8120784">:=</span>&nbsp;<span class="ident" id="8120787">r</span><span class="op" id="8120788">.</span><span class="ident" id="8120789">Header</span><span class="op" id="8120795">.</span><span class="ident" id="8120796">Get</span><span class="op" id="8120799">(</span><span class="string" id="8120800">&#34;Connection&#34;</span><span class="op" id="8120812">)</span><span class="op" id="8120813">;</span>&nbsp;<span class="ident" id="8120815">c</span>&nbsp;<span class="op" id="8120817">!=</span>&nbsp;<span class="string" id="8120820">&#34;&#34;</span>&nbsp;<span class="op" id="8120823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120828">t</span><span class="op" id="8120829">.</span><span class="ident" id="8120830">Errorf</span><span class="op" id="8120836">(</span><span class="string" id="8120837">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8120877">,</span>&nbsp;<span class="ident" id="8120879">c</span><span class="op" id="8120880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120888">if</span>&nbsp;<span class="ident" id="8120891">c</span>&nbsp;<span class="op" id="8120893">:=</span>&nbsp;<span class="ident" id="8120896">r</span><span class="op" id="8120897">.</span><span class="ident" id="8120898">Header</span><span class="op" id="8120904">.</span><span class="ident" id="8120905">Get</span><span class="op" id="8120908">(</span><span class="string" id="8120909">&#34;Upgrade&#34;</span><span class="op" id="8120918">)</span><span class="op" id="8120919">;</span>&nbsp;<span class="ident" id="8120921">c</span>&nbsp;<span class="op" id="8120923">!=</span>&nbsp;<span class="string" id="8120926">&#34;&#34;</span>&nbsp;<span class="op" id="8120929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8120934">t</span><span class="op" id="8120935">.</span><span class="ident" id="8120936">Errorf</span><span class="op" id="8120942">(</span><span class="string" id="8120943">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8120980">,</span>&nbsp;<span class="ident" id="8120982">c</span><span class="op" id="8120983">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8120987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8120991">if</span>&nbsp;<span class="ident" id="8120994">g</span><span class="op" id="8120995">,</span>&nbsp;<span class="ident" id="8120997">e</span>&nbsp;<span class="op" id="8120999">:=</span>&nbsp;<span class="ident" id="8121002">r</span><span class="op" id="8121003">.</span><span class="ident" id="8121004">Host</span><span class="op" id="8121008">,</span>&nbsp;<span class="string" id="8121010">&#34;some-name&#34;</span><span class="op" id="8121021">;</span>&nbsp;<span class="ident" id="8121023">g</span>&nbsp;<span class="op" id="8121025">!=</span>&nbsp;<span class="ident" id="8121028">e</span>&nbsp;<span class="op" id="8121030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121035">t</span><span class="op" id="8121036">.</span><span class="ident" id="8121037">Errorf</span><span class="op" id="8121043">(</span><span class="string" id="8121044">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8121081">,</span>&nbsp;<span class="ident" id="8121083">g</span><span class="op" id="8121084">,</span>&nbsp;<span class="ident" id="8121086">e</span><span class="op" id="8121087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8121091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121095">w</span><span class="op" id="8121096">.</span><span class="ident" id="8121097">Header</span><span class="op" id="8121103">(</span><span class="op" id="8121104">)</span><span class="op" id="8121105">.</span><span class="ident" id="8121106">Set</span><span class="op" id="8121109">(</span><span class="string" id="8121110">&#34;X-Foo&#34;</span><span class="op" id="8121117">,</span>&nbsp;<span class="string" id="8121119">&#34;bar&#34;</span><span class="op" id="8121124">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121128">w</span><span class="op" id="8121129">.</span><span class="ident" id="8121130">Header</span><span class="op" id="8121136">(</span><span class="op" id="8121137">)</span><span class="op" id="8121138">.</span><span class="ident" id="8121139">Set</span><span class="op" id="8121142">(</span><span class="string" id="8121143">&#34;Upgrade&#34;</span><span class="op" id="8121152">,</span>&nbsp;<span class="string" id="8121154">&#34;foo&#34;</span><span class="op" id="8121159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121163">w</span><span class="op" id="8121164">.</span><span class="ident" id="8121165">Header</span><span class="op" id="8121171">(</span><span class="op" id="8121172">)</span><span class="op" id="8121173">.</span><span class="ident" id="8121174">Set</span><span class="op" id="8121177">(</span><span class="ident" id="8121178">fakeHopHeader</span><span class="op" id="8121191">,</span>&nbsp;<span class="string" id="8121193">&#34;foo&#34;</span><span class="op" id="8121198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121202">w</span><span class="op" id="8121203">.</span><span class="ident" id="8121204">Header</span><span class="op" id="8121210">(</span><span class="op" id="8121211">)</span><span class="op" id="8121212">.</span><span class="ident" id="8121213">Add</span><span class="op" id="8121216">(</span><span class="string" id="8121217">&#34;X-Multi-Value&#34;</span><span class="op" id="8121232">,</span>&nbsp;<span class="string" id="8121234">&#34;foo&#34;</span><span class="op" id="8121239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121243">w</span><span class="op" id="8121244">.</span><span class="ident" id="8121245">Header</span><span class="op" id="8121251">(</span><span class="op" id="8121252">)</span><span class="op" id="8121253">.</span><span class="ident" id="8121254">Add</span><span class="op" id="8121257">(</span><span class="string" id="8121258">&#34;X-Multi-Value&#34;</span><span class="op" id="8121273">,</span>&nbsp;<span class="string" id="8121275">&#34;bar&#34;</span><span class="op" id="8121280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121284">http</span><span class="op" id="8121288">.</span><span class="ident" id="8121289">SetCookie</span><span class="op" id="8121298">(</span><span class="ident" id="8121299">w</span><span class="op" id="8121300">,</span>&nbsp;<span class="op" id="8121302">&amp;</span><span class="ident" id="8121303">http</span><span class="op" id="8121307">.</span><span class="ident" id="8121308">Cookie</span><span class="op" id="8121314">{</span><span class="ident" id="8121315">Name</span><span class="op" id="8121319">:</span>&nbsp;<span class="string" id="8121321">&#34;flavor&#34;</span><span class="op" id="8121329">,</span>&nbsp;<span class="ident" id="8121331">Value</span><span class="op" id="8121336">:</span>&nbsp;<span class="string" id="8121338">&#34;chocolateChip&#34;</span><span class="op" id="8121353">}</span><span class="op" id="8121354">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121358">w</span><span class="op" id="8121359">.</span><span class="ident" id="8121360">WriteHeader</span><span class="op" id="8121371">(</span><span class="ident" id="8121372">backendStatus</span><span class="op" id="8121385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121389">w</span><span class="op" id="8121390">.</span><span class="ident" id="8121391">Write</span><span class="op" id="8121396">(</span><span class="op" id="8121397">[</span><span class="op" id="8121398">]</span><span class="builtintype" id="8121399">byte</span><span class="op" id="8121403">(</span><span class="ident" id="8121404">backendResponse</span><span class="op" id="8121419">)</span><span class="op" id="8121420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8121423">}</span><span class="op" id="8121424">)</span><span class="op" id="8121425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8121428">defer</span>&nbsp;<span class="ident" id="8121434">backend</span><span class="op" id="8121441">.</span><span class="ident" id="8121442">Close</span><span class="op" id="8121447">(</span><span class="op" id="8121448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121451">backendURL</span><span class="op" id="8121461">,</span>&nbsp;<span class="ident" id="8121463">err</span>&nbsp;<span class="op" id="8121467">:=</span>&nbsp;<span class="ident" id="8121470">url</span><span class="op" id="8121473">.</span><span class="ident" id="8121474">Parse</span><span class="op" id="8121479">(</span><span class="ident" id="8121480">backend</span><span class="op" id="8121487">.</span><span class="ident" id="8121488">URL</span><span class="op" id="8121491">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8121494">if</span>&nbsp;<span class="ident" id="8121497">err</span>&nbsp;<span class="op" id="8121501">!=</span>&nbsp;<span class="builtintype" id="8121504">nil</span>&nbsp;<span class="op" id="8121508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121512">t</span><span class="op" id="8121513">.</span><span class="ident" id="8121514">Fatal</span><span class="op" id="8121519">(</span><span class="ident" id="8121520">err</span><span class="op" id="8121523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8121526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121529">proxyHandler</span>&nbsp;<span class="op" id="8121542">:=</span>&nbsp;<span class="ident" id="8121545">NewSingleHostReverseProxy</span><span class="op" id="8121570">(</span><span class="ident" id="8121571">backendURL</span><span class="op" id="8121581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121584">frontend</span>&nbsp;<span class="op" id="8121593">:=</span>&nbsp;<span class="ident" id="8121596">httptest</span><span class="op" id="8121604">.</span><span class="ident" id="8121605">NewServer</span><span class="op" id="8121614">(</span><span class="ident" id="8121615">proxyHandler</span><span class="op" id="8121627">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8121630">defer</span>&nbsp;<span class="ident" id="8121636">frontend</span><span class="op" id="8121644">.</span><span class="ident" id="8121645">Close</span><span class="op" id="8121650">(</span><span class="op" id="8121651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121655">getReq</span><span class="op" id="8121661">,</span>&nbsp;<span class="ident" id="8121663">_</span>&nbsp;<span class="op" id="8121665">:=</span>&nbsp;<span class="ident" id="8121668">http</span><span class="op" id="8121672">.</span><span class="ident" id="8121673">NewRequest</span><span class="op" id="8121683">(</span><span class="string" id="8121684">&#34;GET&#34;</span><span class="op" id="8121689">,</span>&nbsp;<span class="ident" id="8121691">frontend</span><span class="op" id="8121699">.</span><span class="ident" id="8121700">URL</span><span class="op" id="8121703">,</span>&nbsp;<span class="builtintype" id="8121705">nil</span><span class="op" id="8121708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121711">getReq</span><span class="op" id="8121717">.</span><span class="ident" id="8121718">Host</span>&nbsp;<span class="op" id="8121723">=</span>&nbsp;<span class="string" id="8121725">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121738">getReq</span><span class="op" id="8121744">.</span><span class="ident" id="8121745">Header</span><span class="op" id="8121751">.</span><span class="ident" id="8121752">Set</span><span class="op" id="8121755">(</span><span class="string" id="8121756">&#34;Connection&#34;</span><span class="op" id="8121768">,</span>&nbsp;<span class="string" id="8121770">&#34;close&#34;</span><span class="op" id="8121777">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121780">getReq</span><span class="op" id="8121786">.</span><span class="ident" id="8121787">Header</span><span class="op" id="8121793">.</span><span class="ident" id="8121794">Set</span><span class="op" id="8121797">(</span><span class="string" id="8121798">&#34;Upgrade&#34;</span><span class="op" id="8121807">,</span>&nbsp;<span class="string" id="8121809">&#34;foo&#34;</span><span class="op" id="8121814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121817">getReq</span><span class="op" id="8121823">.</span><span class="ident" id="8121824">Close</span>&nbsp;<span class="op" id="8121830">=</span>&nbsp;<span class="builtintype" id="8121832">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121838">res</span><span class="op" id="8121841">,</span>&nbsp;<span class="ident" id="8121843">err</span>&nbsp;<span class="op" id="8121847">:=</span>&nbsp;<span class="ident" id="8121850">http</span><span class="op" id="8121854">.</span><span class="ident" id="8121855">DefaultClient</span><span class="op" id="8121868">.</span><span class="ident" id="8121869">Do</span><span class="op" id="8121871">(</span><span class="ident" id="8121872">getReq</span><span class="op" id="8121878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8121881">if</span>&nbsp;<span class="ident" id="8121884">err</span>&nbsp;<span class="op" id="8121888">!=</span>&nbsp;<span class="builtintype" id="8121891">nil</span>&nbsp;<span class="op" id="8121895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121899">t</span><span class="op" id="8121900">.</span><span class="ident" id="8121901">Fatalf</span><span class="op" id="8121907">(</span><span class="string" id="8121908">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8121917">,</span>&nbsp;<span class="ident" id="8121919">err</span><span class="op" id="8121922">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8121925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8121928">if</span>&nbsp;<span class="ident" id="8121931">g</span><span class="op" id="8121932">,</span>&nbsp;<span class="ident" id="8121934">e</span>&nbsp;<span class="op" id="8121936">:=</span>&nbsp;<span class="ident" id="8121939">res</span><span class="op" id="8121942">.</span><span class="ident" id="8121943">StatusCode</span><span class="op" id="8121953">,</span>&nbsp;<span class="ident" id="8121955">backendStatus</span><span class="op" id="8121968">;</span>&nbsp;<span class="ident" id="8121970">g</span>&nbsp;<span class="op" id="8121972">!=</span>&nbsp;<span class="ident" id="8121975">e</span>&nbsp;<span class="op" id="8121977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8121981">t</span><span class="op" id="8121982">.</span><span class="ident" id="8121983">Errorf</span><span class="op" id="8121989">(</span><span class="string" id="8121990">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8122026">,</span>&nbsp;<span class="ident" id="8122028">g</span><span class="op" id="8122029">,</span>&nbsp;<span class="ident" id="8122031">e</span><span class="op" id="8122032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122038">if</span>&nbsp;<span class="ident" id="8122041">g</span><span class="op" id="8122042">,</span>&nbsp;<span class="ident" id="8122044">e</span>&nbsp;<span class="op" id="8122046">:=</span>&nbsp;<span class="ident" id="8122049">res</span><span class="op" id="8122052">.</span><span class="ident" id="8122053">Header</span><span class="op" id="8122059">.</span><span class="ident" id="8122060">Get</span><span class="op" id="8122063">(</span><span class="string" id="8122064">&#34;X-Foo&#34;</span><span class="op" id="8122071">)</span><span class="op" id="8122072">,</span>&nbsp;<span class="string" id="8122074">&#34;bar&#34;</span><span class="op" id="8122079">;</span>&nbsp;<span class="ident" id="8122081">g</span>&nbsp;<span class="op" id="8122083">!=</span>&nbsp;<span class="ident" id="8122086">e</span>&nbsp;<span class="op" id="8122088">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122092">t</span><span class="op" id="8122093">.</span><span class="ident" id="8122094">Errorf</span><span class="op" id="8122100">(</span><span class="string" id="8122101">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8122128">,</span>&nbsp;<span class="ident" id="8122130">g</span><span class="op" id="8122131">,</span>&nbsp;<span class="ident" id="8122133">e</span><span class="op" id="8122134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122140">if</span>&nbsp;<span class="ident" id="8122143">c</span>&nbsp;<span class="op" id="8122145">:=</span>&nbsp;<span class="ident" id="8122148">res</span><span class="op" id="8122151">.</span><span class="ident" id="8122152">Header</span><span class="op" id="8122158">.</span><span class="ident" id="8122159">Get</span><span class="op" id="8122162">(</span><span class="ident" id="8122163">fakeHopHeader</span><span class="op" id="8122176">)</span><span class="op" id="8122177">;</span>&nbsp;<span class="ident" id="8122179">c</span>&nbsp;<span class="op" id="8122181">!=</span>&nbsp;<span class="string" id="8122184">&#34;&#34;</span>&nbsp;<span class="op" id="8122187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122191">t</span><span class="op" id="8122192">.</span><span class="ident" id="8122193">Errorf</span><span class="op" id="8122199">(</span><span class="string" id="8122200">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8122224">,</span>&nbsp;<span class="ident" id="8122226">fakeHopHeader</span><span class="op" id="8122239">,</span>&nbsp;<span class="ident" id="8122241">c</span><span class="op" id="8122242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122245">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122248">if</span>&nbsp;<span class="ident" id="8122251">g</span><span class="op" id="8122252">,</span>&nbsp;<span class="ident" id="8122254">e</span>&nbsp;<span class="op" id="8122256">:=</span>&nbsp;<span class="builtinfunc" id="8122259">len</span><span class="op" id="8122262">(</span><span class="ident" id="8122263">res</span><span class="op" id="8122266">.</span><span class="ident" id="8122267">Header</span><span class="op" id="8122273">[</span><span class="string" id="8122274">&#34;X-Multi-Value&#34;</span><span class="op" id="8122289">]</span><span class="op" id="8122290">)</span><span class="op" id="8122291">,</span>&nbsp;<span class="num" id="8122293">2</span><span class="op" id="8122294">;</span>&nbsp;<span class="ident" id="8122296">g</span>&nbsp;<span class="op" id="8122298">!=</span>&nbsp;<span class="ident" id="8122301">e</span>&nbsp;<span class="op" id="8122303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122307">t</span><span class="op" id="8122308">.</span><span class="ident" id="8122309">Errorf</span><span class="op" id="8122315">(</span><span class="string" id="8122316">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8122365">,</span>&nbsp;<span class="ident" id="8122367">g</span><span class="op" id="8122368">,</span>&nbsp;<span class="ident" id="8122370">e</span><span class="op" id="8122371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122377">if</span>&nbsp;<span class="ident" id="8122380">g</span><span class="op" id="8122381">,</span>&nbsp;<span class="ident" id="8122383">e</span>&nbsp;<span class="op" id="8122385">:=</span>&nbsp;<span class="builtinfunc" id="8122388">len</span><span class="op" id="8122391">(</span><span class="ident" id="8122392">res</span><span class="op" id="8122395">.</span><span class="ident" id="8122396">Header</span><span class="op" id="8122402">[</span><span class="string" id="8122403">&#34;Set-Cookie&#34;</span><span class="op" id="8122415">]</span><span class="op" id="8122416">)</span><span class="op" id="8122417">,</span>&nbsp;<span class="num" id="8122419">1</span><span class="op" id="8122420">;</span>&nbsp;<span class="ident" id="8122422">g</span>&nbsp;<span class="op" id="8122424">!=</span>&nbsp;<span class="ident" id="8122427">e</span>&nbsp;<span class="op" id="8122429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122433">t</span><span class="op" id="8122434">.</span><span class="ident" id="8122435">Fatalf</span><span class="op" id="8122441">(</span><span class="string" id="8122442">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8122470">,</span>&nbsp;<span class="ident" id="8122472">g</span><span class="op" id="8122473">,</span>&nbsp;<span class="ident" id="8122475">e</span><span class="op" id="8122476">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122482">if</span>&nbsp;<span class="ident" id="8122485">cookie</span>&nbsp;<span class="op" id="8122492">:=</span>&nbsp;<span class="ident" id="8122495">res</span><span class="op" id="8122498">.</span><span class="ident" id="8122499">Cookies</span><span class="op" id="8122506">(</span><span class="op" id="8122507">)</span><span class="op" id="8122508">[</span><span class="num" id="8122509">0</span><span class="op" id="8122510">]</span><span class="op" id="8122511">;</span>&nbsp;<span class="ident" id="8122513">cookie</span><span class="op" id="8122519">.</span><span class="ident" id="8122520">Name</span>&nbsp;<span class="op" id="8122525">!=</span>&nbsp;<span class="string" id="8122528">&#34;flavor&#34;</span>&nbsp;<span class="op" id="8122537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122541">t</span><span class="op" id="8122542">.</span><span class="ident" id="8122543">Errorf</span><span class="op" id="8122549">(</span><span class="string" id="8122550">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="8122572">,</span>&nbsp;<span class="ident" id="8122574">cookie</span><span class="op" id="8122580">.</span><span class="ident" id="8122581">Name</span><span class="op" id="8122585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122591">bodyBytes</span><span class="op" id="8122600">,</span>&nbsp;<span class="ident" id="8122602">_</span>&nbsp;<span class="op" id="8122604">:=</span>&nbsp;<span class="ident" id="8122607">ioutil</span><span class="op" id="8122613">.</span><span class="ident" id="8122614">ReadAll</span><span class="op" id="8122621">(</span><span class="ident" id="8122622">res</span><span class="op" id="8122625">.</span><span class="ident" id="8122626">Body</span><span class="op" id="8122630">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122633">if</span>&nbsp;<span class="ident" id="8122636">g</span><span class="op" id="8122637">,</span>&nbsp;<span class="ident" id="8122639">e</span>&nbsp;<span class="op" id="8122641">:=</span>&nbsp;<span class="builtintype" id="8122644">string</span><span class="op" id="8122650">(</span><span class="ident" id="8122651">bodyBytes</span><span class="op" id="8122660">)</span><span class="op" id="8122661">,</span>&nbsp;<span class="ident" id="8122663">backendResponse</span><span class="op" id="8122678">;</span>&nbsp;<span class="ident" id="8122680">g</span>&nbsp;<span class="op" id="8122682">!=</span>&nbsp;<span class="ident" id="8122685">e</span>&nbsp;<span class="op" id="8122687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122691">t</span><span class="op" id="8122692">.</span><span class="ident" id="8122693">Errorf</span><span class="op" id="8122699">(</span><span class="string" id="8122700">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8122726">,</span>&nbsp;<span class="ident" id="8122728">g</span><span class="op" id="8122729">,</span>&nbsp;<span class="ident" id="8122731">e</span><span class="op" id="8122732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8122735">}</span><br>
<span class="lineno"></span><span class="op" id="8122737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8122740">func</span>&nbsp;<span class="ident" id="8122745">TestXForwardedFor</span><span class="op" id="8122762">(</span><span class="ident" id="8122763">t</span>&nbsp;<span class="op" id="8122765">*</span><span class="ident" id="8122766">testing</span><span class="op" id="8122773">.</span><span class="ident" id="8122774">T</span><span class="op" id="8122775">)</span>&nbsp;<span class="op" id="8122777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122780">const</span>&nbsp;<span class="ident" id="8122786">prevForwardedFor</span>&nbsp;<span class="op" id="8122803">=</span>&nbsp;<span class="string" id="8122805">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122818">const</span>&nbsp;<span class="ident" id="8122824">backendResponse</span>&nbsp;<span class="op" id="8122840">=</span>&nbsp;<span class="string" id="8122842">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122862">const</span>&nbsp;<span class="ident" id="8122868">backendStatus</span>&nbsp;<span class="op" id="8122882">=</span>&nbsp;<span class="num" id="8122884">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8122889">backend</span>&nbsp;<span class="op" id="8122897">:=</span>&nbsp;<span class="ident" id="8122900">httptest</span><span class="op" id="8122908">.</span><span class="ident" id="8122909">NewServer</span><span class="op" id="8122918">(</span><span class="ident" id="8122919">http</span><span class="op" id="8122923">.</span><span class="ident" id="8122924">HandlerFunc</span><span class="op" id="8122935">(</span><span class="keyword" id="8122936">func</span><span class="op" id="8122940">(</span><span class="ident" id="8122941">w</span>&nbsp;<span class="ident" id="8122943">http</span><span class="op" id="8122947">.</span><span class="ident" id="8122948">ResponseWriter</span><span class="op" id="8122962">,</span>&nbsp;<span class="ident" id="8122964">r</span>&nbsp;<span class="op" id="8122966">*</span><span class="ident" id="8122967">http</span><span class="op" id="8122971">.</span><span class="ident" id="8122972">Request</span><span class="op" id="8122979">)</span>&nbsp;<span class="op" id="8122981">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8122985">if</span>&nbsp;<span class="ident" id="8122988">r</span><span class="op" id="8122989">.</span><span class="ident" id="8122990">Header</span><span class="op" id="8122996">.</span><span class="ident" id="8122997">Get</span><span class="op" id="8123000">(</span><span class="string" id="8123001">&#34;X-Forwarded-For&#34;</span><span class="op" id="8123018">)</span>&nbsp;<span class="op" id="8123020">==</span>&nbsp;<span class="string" id="8123023">&#34;&#34;</span>&nbsp;<span class="op" id="8123026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123031">t</span><span class="op" id="8123032">.</span><span class="ident" id="8123033">Errorf</span><span class="op" id="8123039">(</span><span class="string" id="8123040">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8123075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123083">if</span>&nbsp;<span class="op" id="8123086">!</span><span class="ident" id="8123087">strings</span><span class="op" id="8123094">.</span><span class="ident" id="8123095">Contains</span><span class="op" id="8123103">(</span><span class="ident" id="8123104">r</span><span class="op" id="8123105">.</span><span class="ident" id="8123106">Header</span><span class="op" id="8123112">.</span><span class="ident" id="8123113">Get</span><span class="op" id="8123116">(</span><span class="string" id="8123117">&#34;X-Forwarded-For&#34;</span><span class="op" id="8123134">)</span><span class="op" id="8123135">,</span>&nbsp;<span class="ident" id="8123137">prevForwardedFor</span><span class="op" id="8123153">)</span>&nbsp;<span class="op" id="8123155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123160">t</span><span class="op" id="8123161">.</span><span class="ident" id="8123162">Errorf</span><span class="op" id="8123168">(</span><span class="string" id="8123169">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="8123212">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123220">w</span><span class="op" id="8123221">.</span><span class="ident" id="8123222">WriteHeader</span><span class="op" id="8123233">(</span><span class="ident" id="8123234">backendStatus</span><span class="op" id="8123247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123251">w</span><span class="op" id="8123252">.</span><span class="ident" id="8123253">Write</span><span class="op" id="8123258">(</span><span class="op" id="8123259">[</span><span class="op" id="8123260">]</span><span class="builtintype" id="8123261">byte</span><span class="op" id="8123265">(</span><span class="ident" id="8123266">backendResponse</span><span class="op" id="8123281">)</span><span class="op" id="8123282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123285">}</span><span class="op" id="8123286">)</span><span class="op" id="8123287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123290">defer</span>&nbsp;<span class="ident" id="8123296">backend</span><span class="op" id="8123303">.</span><span class="ident" id="8123304">Close</span><span class="op" id="8123309">(</span><span class="op" id="8123310">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123313">backendURL</span><span class="op" id="8123323">,</span>&nbsp;<span class="ident" id="8123325">err</span>&nbsp;<span class="op" id="8123329">:=</span>&nbsp;<span class="ident" id="8123332">url</span><span class="op" id="8123335">.</span><span class="ident" id="8123336">Parse</span><span class="op" id="8123341">(</span><span class="ident" id="8123342">backend</span><span class="op" id="8123349">.</span><span class="ident" id="8123350">URL</span><span class="op" id="8123353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123356">if</span>&nbsp;<span class="ident" id="8123359">err</span>&nbsp;<span class="op" id="8123363">!=</span>&nbsp;<span class="builtintype" id="8123366">nil</span>&nbsp;<span class="op" id="8123370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123374">t</span><span class="op" id="8123375">.</span><span class="ident" id="8123376">Fatal</span><span class="op" id="8123381">(</span><span class="ident" id="8123382">err</span><span class="op" id="8123385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123391">proxyHandler</span>&nbsp;<span class="op" id="8123404">:=</span>&nbsp;<span class="ident" id="8123407">NewSingleHostReverseProxy</span><span class="op" id="8123432">(</span><span class="ident" id="8123433">backendURL</span><span class="op" id="8123443">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123446">frontend</span>&nbsp;<span class="op" id="8123455">:=</span>&nbsp;<span class="ident" id="8123458">httptest</span><span class="op" id="8123466">.</span><span class="ident" id="8123467">NewServer</span><span class="op" id="8123476">(</span><span class="ident" id="8123477">proxyHandler</span><span class="op" id="8123489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123492">defer</span>&nbsp;<span class="ident" id="8123498">frontend</span><span class="op" id="8123506">.</span><span class="ident" id="8123507">Close</span><span class="op" id="8123512">(</span><span class="op" id="8123513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123517">getReq</span><span class="op" id="8123523">,</span>&nbsp;<span class="ident" id="8123525">_</span>&nbsp;<span class="op" id="8123527">:=</span>&nbsp;<span class="ident" id="8123530">http</span><span class="op" id="8123534">.</span><span class="ident" id="8123535">NewRequest</span><span class="op" id="8123545">(</span><span class="string" id="8123546">&#34;GET&#34;</span><span class="op" id="8123551">,</span>&nbsp;<span class="ident" id="8123553">frontend</span><span class="op" id="8123561">.</span><span class="ident" id="8123562">URL</span><span class="op" id="8123565">,</span>&nbsp;<span class="builtintype" id="8123567">nil</span><span class="op" id="8123570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123573">getReq</span><span class="op" id="8123579">.</span><span class="ident" id="8123580">Host</span>&nbsp;<span class="op" id="8123585">=</span>&nbsp;<span class="string" id="8123587">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123600">getReq</span><span class="op" id="8123606">.</span><span class="ident" id="8123607">Header</span><span class="op" id="8123613">.</span><span class="ident" id="8123614">Set</span><span class="op" id="8123617">(</span><span class="string" id="8123618">&#34;Connection&#34;</span><span class="op" id="8123630">,</span>&nbsp;<span class="string" id="8123632">&#34;close&#34;</span><span class="op" id="8123639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123642">getReq</span><span class="op" id="8123648">.</span><span class="ident" id="8123649">Header</span><span class="op" id="8123655">.</span><span class="ident" id="8123656">Set</span><span class="op" id="8123659">(</span><span class="string" id="8123660">&#34;X-Forwarded-For&#34;</span><span class="op" id="8123677">,</span>&nbsp;<span class="ident" id="8123679">prevForwardedFor</span><span class="op" id="8123695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123698">getReq</span><span class="op" id="8123704">.</span><span class="ident" id="8123705">Close</span>&nbsp;<span class="op" id="8123711">=</span>&nbsp;<span class="builtintype" id="8123713">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123719">res</span><span class="op" id="8123722">,</span>&nbsp;<span class="ident" id="8123724">err</span>&nbsp;<span class="op" id="8123728">:=</span>&nbsp;<span class="ident" id="8123731">http</span><span class="op" id="8123735">.</span><span class="ident" id="8123736">DefaultClient</span><span class="op" id="8123749">.</span><span class="ident" id="8123750">Do</span><span class="op" id="8123752">(</span><span class="ident" id="8123753">getReq</span><span class="op" id="8123759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123762">if</span>&nbsp;<span class="ident" id="8123765">err</span>&nbsp;<span class="op" id="8123769">!=</span>&nbsp;<span class="builtintype" id="8123772">nil</span>&nbsp;<span class="op" id="8123776">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123780">t</span><span class="op" id="8123781">.</span><span class="ident" id="8123782">Fatalf</span><span class="op" id="8123788">(</span><span class="string" id="8123789">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8123798">,</span>&nbsp;<span class="ident" id="8123800">err</span><span class="op" id="8123803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123809">if</span>&nbsp;<span class="ident" id="8123812">g</span><span class="op" id="8123813">,</span>&nbsp;<span class="ident" id="8123815">e</span>&nbsp;<span class="op" id="8123817">:=</span>&nbsp;<span class="ident" id="8123820">res</span><span class="op" id="8123823">.</span><span class="ident" id="8123824">StatusCode</span><span class="op" id="8123834">,</span>&nbsp;<span class="ident" id="8123836">backendStatus</span><span class="op" id="8123849">;</span>&nbsp;<span class="ident" id="8123851">g</span>&nbsp;<span class="op" id="8123853">!=</span>&nbsp;<span class="ident" id="8123856">e</span>&nbsp;<span class="op" id="8123858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123862">t</span><span class="op" id="8123863">.</span><span class="ident" id="8123864">Errorf</span><span class="op" id="8123870">(</span><span class="string" id="8123871">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8123907">,</span>&nbsp;<span class="ident" id="8123909">g</span><span class="op" id="8123910">,</span>&nbsp;<span class="ident" id="8123912">e</span><span class="op" id="8123913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8123916">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8123919">bodyBytes</span><span class="op" id="8123928">,</span>&nbsp;<span class="ident" id="8123930">_</span>&nbsp;<span class="op" id="8123932">:=</span>&nbsp;<span class="ident" id="8123935">ioutil</span><span class="op" id="8123941">.</span><span class="ident" id="8123942">ReadAll</span><span class="op" id="8123949">(</span><span class="ident" id="8123950">res</span><span class="op" id="8123953">.</span><span class="ident" id="8123954">Body</span><span class="op" id="8123958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8123961">if</span>&nbsp;<span class="ident" id="8123964">g</span><span class="op" id="8123965">,</span>&nbsp;<span class="ident" id="8123967">e</span>&nbsp;<span class="op" id="8123969">:=</span>&nbsp;<span class="builtintype" id="8123972">string</span><span class="op" id="8123978">(</span><span class="ident" id="8123979">bodyBytes</span><span class="op" id="8123988">)</span><span class="op" id="8123989">,</span>&nbsp;<span class="ident" id="8123991">backendResponse</span><span class="op" id="8124006">;</span>&nbsp;<span class="ident" id="8124008">g</span>&nbsp;<span class="op" id="8124010">!=</span>&nbsp;<span class="ident" id="8124013">e</span>&nbsp;<span class="op" id="8124015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124019">t</span><span class="op" id="8124020">.</span><span class="ident" id="8124021">Errorf</span><span class="op" id="8124027">(</span><span class="string" id="8124028">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8124054">,</span>&nbsp;<span class="ident" id="8124056">g</span><span class="op" id="8124057">,</span>&nbsp;<span class="ident" id="8124059">e</span><span class="op" id="8124060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124063">}</span><br>
<span class="lineno"></span><span class="op" id="8124065">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="8124068">var</span>&nbsp;<span class="ident" id="8124072">proxyQueryTests</span>&nbsp;<span class="op" id="8124088">=</span>&nbsp;<span class="op" id="8124090">[</span><span class="op" id="8124091">]</span><span class="keyword" id="8124092">struct</span>&nbsp;<span class="op" id="8124099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124102">baseSuffix</span>&nbsp;<span class="builtintype" id="8124113">string</span>&nbsp;<span class="comment" id="8124120">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124153">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="8124164">string</span>&nbsp;<span class="comment" id="8124171">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124215">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8124226">string</span>&nbsp;<span class="comment" id="8124233">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="8124294">}</span><span class="op" id="8124295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124298">{</span><span class="string" id="8124299">&#34;&#34;</span><span class="op" id="8124301">,</span>&nbsp;<span class="string" id="8124303">&#34;&#34;</span><span class="op" id="8124305">,</span>&nbsp;<span class="string" id="8124307">&#34;&#34;</span><span class="op" id="8124309">}</span><span class="op" id="8124310">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124313">{</span><span class="string" id="8124314">&#34;?sta=tic&#34;</span><span class="op" id="8124324">,</span>&nbsp;<span class="string" id="8124326">&#34;?us=er&#34;</span><span class="op" id="8124334">,</span>&nbsp;<span class="string" id="8124336">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="8124351">}</span><span class="op" id="8124352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124355">{</span><span class="string" id="8124356">&#34;&#34;</span><span class="op" id="8124358">,</span>&nbsp;<span class="string" id="8124360">&#34;?us=er&#34;</span><span class="op" id="8124368">,</span>&nbsp;<span class="string" id="8124370">&#34;us=er&#34;</span><span class="op" id="8124377">}</span><span class="op" id="8124378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124381">{</span><span class="string" id="8124382">&#34;?sta=tic&#34;</span><span class="op" id="8124392">,</span>&nbsp;<span class="string" id="8124394">&#34;&#34;</span><span class="op" id="8124396">,</span>&nbsp;<span class="string" id="8124398">&#34;sta=tic&#34;</span><span class="op" id="8124407">}</span><span class="op" id="8124408">,</span><br>
<span class="lineno">145</span><span class="op" id="8124410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8124413">func</span>&nbsp;<span class="ident" id="8124418">TestReverseProxyQuery</span><span class="op" id="8124439">(</span><span class="ident" id="8124440">t</span>&nbsp;<span class="op" id="8124442">*</span><span class="ident" id="8124443">testing</span><span class="op" id="8124450">.</span><span class="ident" id="8124451">T</span><span class="op" id="8124452">)</span>&nbsp;<span class="op" id="8124454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124457">backend</span>&nbsp;<span class="op" id="8124465">:=</span>&nbsp;<span class="ident" id="8124468">httptest</span><span class="op" id="8124476">.</span><span class="ident" id="8124477">NewServer</span><span class="op" id="8124486">(</span><span class="ident" id="8124487">http</span><span class="op" id="8124491">.</span><span class="ident" id="8124492">HandlerFunc</span><span class="op" id="8124503">(</span><span class="keyword" id="8124504">func</span><span class="op" id="8124508">(</span><span class="ident" id="8124509">w</span>&nbsp;<span class="ident" id="8124511">http</span><span class="op" id="8124515">.</span><span class="ident" id="8124516">ResponseWriter</span><span class="op" id="8124530">,</span>&nbsp;<span class="ident" id="8124532">r</span>&nbsp;<span class="op" id="8124534">*</span><span class="ident" id="8124535">http</span><span class="op" id="8124539">.</span><span class="ident" id="8124540">Request</span><span class="op" id="8124547">)</span>&nbsp;<span class="op" id="8124549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124553">w</span><span class="op" id="8124554">.</span><span class="ident" id="8124555">Header</span><span class="op" id="8124561">(</span><span class="op" id="8124562">)</span><span class="op" id="8124563">.</span><span class="ident" id="8124564">Set</span><span class="op" id="8124567">(</span><span class="string" id="8124568">&#34;X-Got-Query&#34;</span><span class="op" id="8124581">,</span>&nbsp;<span class="ident" id="8124583">r</span><span class="op" id="8124584">.</span><span class="ident" id="8124585">URL</span><span class="op" id="8124588">.</span><span class="ident" id="8124589">RawQuery</span><span class="op" id="8124597">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124601">w</span><span class="op" id="8124602">.</span><span class="ident" id="8124603">Write</span><span class="op" id="8124608">(</span><span class="op" id="8124609">[</span><span class="op" id="8124610">]</span><span class="builtintype" id="8124611">byte</span><span class="op" id="8124615">(</span><span class="string" id="8124616">&#34;hi&#34;</span><span class="op" id="8124620">)</span><span class="op" id="8124621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124624">}</span><span class="op" id="8124625">)</span><span class="op" id="8124626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8124629">defer</span>&nbsp;<span class="ident" id="8124635">backend</span><span class="op" id="8124642">.</span><span class="ident" id="8124643">Close</span><span class="op" id="8124648">(</span><span class="op" id="8124649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8124653">for</span>&nbsp;<span class="ident" id="8124657">i</span><span class="op" id="8124658">,</span>&nbsp;<span class="ident" id="8124660">tt</span>&nbsp;<span class="op" id="8124663">:=</span>&nbsp;<span class="keyword" id="8124666">range</span>&nbsp;<span class="ident" id="8124672">proxyQueryTests</span>&nbsp;<span class="op" id="8124688">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124692">backendURL</span><span class="op" id="8124702">,</span>&nbsp;<span class="ident" id="8124704">err</span>&nbsp;<span class="op" id="8124708">:=</span>&nbsp;<span class="ident" id="8124711">url</span><span class="op" id="8124714">.</span><span class="ident" id="8124715">Parse</span><span class="op" id="8124720">(</span><span class="ident" id="8124721">backend</span><span class="op" id="8124728">.</span><span class="ident" id="8124729">URL</span>&nbsp;<span class="op" id="8124733">+</span>&nbsp;<span class="ident" id="8124735">tt</span><span class="op" id="8124737">.</span><span class="ident" id="8124738">baseSuffix</span><span class="op" id="8124748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8124752">if</span>&nbsp;<span class="ident" id="8124755">err</span>&nbsp;<span class="op" id="8124759">!=</span>&nbsp;<span class="builtintype" id="8124762">nil</span>&nbsp;<span class="op" id="8124766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124771">t</span><span class="op" id="8124772">.</span><span class="ident" id="8124773">Fatal</span><span class="op" id="8124778">(</span><span class="ident" id="8124779">err</span><span class="op" id="8124782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8124786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124790">frontend</span>&nbsp;<span class="op" id="8124799">:=</span>&nbsp;<span class="ident" id="8124802">httptest</span><span class="op" id="8124810">.</span><span class="ident" id="8124811">NewServer</span><span class="op" id="8124820">(</span><span class="ident" id="8124821">NewSingleHostReverseProxy</span><span class="op" id="8124846">(</span><span class="ident" id="8124847">backendURL</span><span class="op" id="8124857">)</span><span class="op" id="8124858">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124862">req</span><span class="op" id="8124865">,</span>&nbsp;<span class="ident" id="8124867">_</span>&nbsp;<span class="op" id="8124869">:=</span>&nbsp;<span class="ident" id="8124872">http</span><span class="op" id="8124876">.</span><span class="ident" id="8124877">NewRequest</span><span class="op" id="8124887">(</span><span class="string" id="8124888">&#34;GET&#34;</span><span class="op" id="8124893">,</span>&nbsp;<span class="ident" id="8124895">frontend</span><span class="op" id="8124903">.</span><span class="ident" id="8124904">URL</span><span class="op" id="8124907">+</span><span class="ident" id="8124908">tt</span><span class="op" id="8124910">.</span><span class="ident" id="8124911">reqSuffix</span><span class="op" id="8124920">,</span>&nbsp;<span class="builtintype" id="8124922">nil</span><span class="op" id="8124925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124929">req</span><span class="op" id="8124932">.</span><span class="ident" id="8124933">Close</span>&nbsp;<span class="op" id="8124939">=</span>&nbsp;<span class="builtintype" id="8124941">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8124948">res</span><span class="op" id="8124951">,</span>&nbsp;<span class="ident" id="8124953">err</span>&nbsp;<span class="op" id="8124957">:=</span>&nbsp;<span class="ident" id="8124960">http</span><span class="op" id="8124964">.</span><span class="ident" id="8124965">DefaultClient</span><span class="op" id="8124978">.</span><span class="ident" id="8124979">Do</span><span class="op" id="8124981">(</span><span class="ident" id="8124982">req</span><span class="op" id="8124985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8124989">if</span>&nbsp;<span class="ident" id="8124992">err</span>&nbsp;<span class="op" id="8124996">!=</span>&nbsp;<span class="builtintype" id="8124999">nil</span>&nbsp;<span class="op" id="8125003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125008">t</span><span class="op" id="8125009">.</span><span class="ident" id="8125010">Fatalf</span><span class="op" id="8125016">(</span><span class="string" id="8125017">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="8125030">,</span>&nbsp;<span class="ident" id="8125032">i</span><span class="op" id="8125033">,</span>&nbsp;<span class="ident" id="8125035">err</span><span class="op" id="8125038">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125046">if</span>&nbsp;<span class="ident" id="8125049">g</span><span class="op" id="8125050">,</span>&nbsp;<span class="ident" id="8125052">e</span>&nbsp;<span class="op" id="8125054">:=</span>&nbsp;<span class="ident" id="8125057">res</span><span class="op" id="8125060">.</span><span class="ident" id="8125061">Header</span><span class="op" id="8125067">.</span><span class="ident" id="8125068">Get</span><span class="op" id="8125071">(</span><span class="string" id="8125072">&#34;X-Got-Query&#34;</span><span class="op" id="8125085">)</span><span class="op" id="8125086">,</span>&nbsp;<span class="ident" id="8125088">tt</span><span class="op" id="8125090">.</span><span class="ident" id="8125091">want</span><span class="op" id="8125095">;</span>&nbsp;<span class="ident" id="8125097">g</span>&nbsp;<span class="op" id="8125099">!=</span>&nbsp;<span class="ident" id="8125102">e</span>&nbsp;<span class="op" id="8125104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125109">t</span><span class="op" id="8125110">.</span><span class="ident" id="8125111">Errorf</span><span class="op" id="8125117">(</span><span class="string" id="8125118">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8125149">,</span>&nbsp;<span class="ident" id="8125151">i</span><span class="op" id="8125152">,</span>&nbsp;<span class="ident" id="8125154">g</span><span class="op" id="8125155">,</span>&nbsp;<span class="ident" id="8125157">e</span><span class="op" id="8125158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125166">res</span><span class="op" id="8125169">.</span><span class="ident" id="8125170">Body</span><span class="op" id="8125174">.</span><span class="ident" id="8125175">Close</span><span class="op" id="8125180">(</span><span class="op" id="8125181">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125185">frontend</span><span class="op" id="8125193">.</span><span class="ident" id="8125194">Close</span><span class="op" id="8125199">(</span><span class="op" id="8125200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125203">}</span><br>
<span class="lineno"></span><span class="op" id="8125205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8125208">func</span>&nbsp;<span class="ident" id="8125213">TestReverseProxyFlushInterval</span><span class="op" id="8125242">(</span><span class="ident" id="8125243">t</span>&nbsp;<span class="op" id="8125245">*</span><span class="ident" id="8125246">testing</span><span class="op" id="8125253">.</span><span class="ident" id="8125254">T</span><span class="op" id="8125255">)</span>&nbsp;<span class="op" id="8125257">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125260">const</span>&nbsp;<span class="ident" id="8125266">expected</span>&nbsp;<span class="op" id="8125275">=</span>&nbsp;<span class="string" id="8125277">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125283">backend</span>&nbsp;<span class="op" id="8125291">:=</span>&nbsp;<span class="ident" id="8125294">httptest</span><span class="op" id="8125302">.</span><span class="ident" id="8125303">NewServer</span><span class="op" id="8125312">(</span><span class="ident" id="8125313">http</span><span class="op" id="8125317">.</span><span class="ident" id="8125318">HandlerFunc</span><span class="op" id="8125329">(</span><span class="keyword" id="8125330">func</span><span class="op" id="8125334">(</span><span class="ident" id="8125335">w</span>&nbsp;<span class="ident" id="8125337">http</span><span class="op" id="8125341">.</span><span class="ident" id="8125342">ResponseWriter</span><span class="op" id="8125356">,</span>&nbsp;<span class="ident" id="8125358">r</span>&nbsp;<span class="op" id="8125360">*</span><span class="ident" id="8125361">http</span><span class="op" id="8125365">.</span><span class="ident" id="8125366">Request</span><span class="op" id="8125373">)</span>&nbsp;<span class="op" id="8125375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125379">w</span><span class="op" id="8125380">.</span><span class="ident" id="8125381">Write</span><span class="op" id="8125386">(</span><span class="op" id="8125387">[</span><span class="op" id="8125388">]</span><span class="builtintype" id="8125389">byte</span><span class="op" id="8125393">(</span><span class="ident" id="8125394">expected</span><span class="op" id="8125402">)</span><span class="op" id="8125403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125406">}</span><span class="op" id="8125407">)</span><span class="op" id="8125408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125411">defer</span>&nbsp;<span class="ident" id="8125417">backend</span><span class="op" id="8125424">.</span><span class="ident" id="8125425">Close</span><span class="op" id="8125430">(</span><span class="op" id="8125431">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125435">backendURL</span><span class="op" id="8125445">,</span>&nbsp;<span class="ident" id="8125447">err</span>&nbsp;<span class="op" id="8125451">:=</span>&nbsp;<span class="ident" id="8125454">url</span><span class="op" id="8125457">.</span><span class="ident" id="8125458">Parse</span><span class="op" id="8125463">(</span><span class="ident" id="8125464">backend</span><span class="op" id="8125471">.</span><span class="ident" id="8125472">URL</span><span class="op" id="8125475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125478">if</span>&nbsp;<span class="ident" id="8125481">err</span>&nbsp;<span class="op" id="8125485">!=</span>&nbsp;<span class="builtintype" id="8125488">nil</span>&nbsp;<span class="op" id="8125492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125496">t</span><span class="op" id="8125497">.</span><span class="ident" id="8125498">Fatal</span><span class="op" id="8125503">(</span><span class="ident" id="8125504">err</span><span class="op" id="8125507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125510">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125514">proxyHandler</span>&nbsp;<span class="op" id="8125527">:=</span>&nbsp;<span class="ident" id="8125530">NewSingleHostReverseProxy</span><span class="op" id="8125555">(</span><span class="ident" id="8125556">backendURL</span><span class="op" id="8125566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125569">proxyHandler</span><span class="op" id="8125581">.</span><span class="ident" id="8125582">FlushInterval</span>&nbsp;<span class="op" id="8125596">=</span>&nbsp;<span class="ident" id="8125598">time</span><span class="op" id="8125602">.</span><span class="ident" id="8125603">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125617">done</span>&nbsp;<span class="op" id="8125622">:=</span>&nbsp;<span class="builtinfunc" id="8125625">make</span><span class="op" id="8125629">(</span><span class="keyword" id="8125630">chan</span>&nbsp;<span class="builtintype" id="8125635">bool</span><span class="op" id="8125639">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125642">onExitFlushLoop</span>&nbsp;<span class="op" id="8125658">=</span>&nbsp;<span class="keyword" id="8125660">func</span><span class="op" id="8125664">(</span><span class="op" id="8125665">)</span>&nbsp;<span class="op" id="8125667">{</span>&nbsp;<span class="ident" id="8125669">done</span>&nbsp;<span class="op" id="8125674">&lt;-</span>&nbsp;<span class="builtintype" id="8125677">true</span>&nbsp;<span class="op" id="8125682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125685">defer</span>&nbsp;<span class="keyword" id="8125691">func</span><span class="op" id="8125695">(</span><span class="op" id="8125696">)</span>&nbsp;<span class="op" id="8125698">{</span>&nbsp;<span class="ident" id="8125700">onExitFlushLoop</span>&nbsp;<span class="op" id="8125716">=</span>&nbsp;<span class="builtintype" id="8125718">nil</span>&nbsp;<span class="op" id="8125722">}</span><span class="op" id="8125723">(</span><span class="op" id="8125724">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125728">frontend</span>&nbsp;<span class="op" id="8125737">:=</span>&nbsp;<span class="ident" id="8125740">httptest</span><span class="op" id="8125748">.</span><span class="ident" id="8125749">NewServer</span><span class="op" id="8125758">(</span><span class="ident" id="8125759">proxyHandler</span><span class="op" id="8125771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125774">defer</span>&nbsp;<span class="ident" id="8125780">frontend</span><span class="op" id="8125788">.</span><span class="ident" id="8125789">Close</span><span class="op" id="8125794">(</span><span class="op" id="8125795">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125799">req</span><span class="op" id="8125802">,</span>&nbsp;<span class="ident" id="8125804">_</span>&nbsp;<span class="op" id="8125806">:=</span>&nbsp;<span class="ident" id="8125809">http</span><span class="op" id="8125813">.</span><span class="ident" id="8125814">NewRequest</span><span class="op" id="8125824">(</span><span class="string" id="8125825">&#34;GET&#34;</span><span class="op" id="8125830">,</span>&nbsp;<span class="ident" id="8125832">frontend</span><span class="op" id="8125840">.</span><span class="ident" id="8125841">URL</span><span class="op" id="8125844">,</span>&nbsp;<span class="builtintype" id="8125846">nil</span><span class="op" id="8125849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125852">req</span><span class="op" id="8125855">.</span><span class="ident" id="8125856">Close</span>&nbsp;<span class="op" id="8125862">=</span>&nbsp;<span class="builtintype" id="8125864">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125870">res</span><span class="op" id="8125873">,</span>&nbsp;<span class="ident" id="8125875">err</span>&nbsp;<span class="op" id="8125879">:=</span>&nbsp;<span class="ident" id="8125882">http</span><span class="op" id="8125886">.</span><span class="ident" id="8125887">DefaultClient</span><span class="op" id="8125900">.</span><span class="ident" id="8125901">Do</span><span class="op" id="8125903">(</span><span class="ident" id="8125904">req</span><span class="op" id="8125907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125910">if</span>&nbsp;<span class="ident" id="8125913">err</span>&nbsp;<span class="op" id="8125917">!=</span>&nbsp;<span class="builtintype" id="8125920">nil</span>&nbsp;<span class="op" id="8125924">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8125928">t</span><span class="op" id="8125929">.</span><span class="ident" id="8125930">Fatalf</span><span class="op" id="8125936">(</span><span class="string" id="8125937">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8125946">,</span>&nbsp;<span class="ident" id="8125948">err</span><span class="op" id="8125951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8125954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125957">defer</span>&nbsp;<span class="ident" id="8125963">res</span><span class="op" id="8125966">.</span><span class="ident" id="8125967">Body</span><span class="op" id="8125971">.</span><span class="ident" id="8125972">Close</span><span class="op" id="8125977">(</span><span class="op" id="8125978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8125981">if</span>&nbsp;<span class="ident" id="8125984">bodyBytes</span><span class="op" id="8125993">,</span>&nbsp;<span class="ident" id="8125995">_</span>&nbsp;<span class="op" id="8125997">:=</span>&nbsp;<span class="ident" id="8126000">ioutil</span><span class="op" id="8126006">.</span><span class="ident" id="8126007">ReadAll</span><span class="op" id="8126014">(</span><span class="ident" id="8126015">res</span><span class="op" id="8126018">.</span><span class="ident" id="8126019">Body</span><span class="op" id="8126023">)</span><span class="op" id="8126024">;</span>&nbsp;<span class="builtintype" id="8126026">string</span><span class="op" id="8126032">(</span><span class="ident" id="8126033">bodyBytes</span><span class="op" id="8126042">)</span>&nbsp;<span class="op" id="8126044">!=</span>&nbsp;<span class="ident" id="8126047">expected</span>&nbsp;<span class="op" id="8126056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8126060">t</span><span class="op" id="8126061">.</span><span class="ident" id="8126062">Errorf</span><span class="op" id="8126068">(</span><span class="string" id="8126069">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8126095">,</span>&nbsp;<span class="ident" id="8126097">bodyBytes</span><span class="op" id="8126106">,</span>&nbsp;<span class="ident" id="8126108">expected</span><span class="op" id="8126116">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8126119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8126123">select</span>&nbsp;<span class="op" id="8126130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8126133">case</span>&nbsp;<span class="op" id="8126138">&lt;-</span><span class="ident" id="8126140">done</span><span class="op" id="8126144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8126148">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8126155">case</span>&nbsp;<span class="op" id="8126160">&lt;-</span><span class="ident" id="8126162">time</span><span class="op" id="8126166">.</span><span class="ident" id="8126167">After</span><span class="op" id="8126172">(</span><span class="num" id="8126173">5</span>&nbsp;<span class="op" id="8126175">*</span>&nbsp;<span class="ident" id="8126177">time</span><span class="op" id="8126181">.</span><span class="ident" id="8126182">Second</span><span class="op" id="8126188">)</span><span class="op" id="8126189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8126193">t</span><span class="op" id="8126194">.</span><span class="ident" id="8126195">Error</span><span class="op" id="8126200">(</span><span class="string" id="8126201">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="8126244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8126247">}</span><br>
<span class="lineno"></span><span class="op" id="8126249">}</span>
</div>
</body>
</html>
