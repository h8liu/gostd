<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3857754">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3857810">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3857864">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3857915">package</span>&nbsp;<span class="ident" id="3857923">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3857929">import</span>&nbsp;<span class="op" id="3857936">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3857939">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3857949">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3857955">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3857966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3857969">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3858044">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3858121">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3858200">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3858279">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3858303">var</span>&nbsp;<span class="ident" id="3858307">smallPrimes</span>&nbsp;<span class="op" id="3858319">=</span>&nbsp;<span class="op" id="3858321">[</span><span class="op" id="3858322">]</span><span class="builtintype" id="3858323">uint8</span><span class="op" id="3858328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3858331">3</span><span class="op" id="3858332">,</span>&nbsp;<span class="num" id="3858334">5</span><span class="op" id="3858335">,</span>&nbsp;<span class="num" id="3858337">7</span><span class="op" id="3858338">,</span>&nbsp;<span class="num" id="3858340">11</span><span class="op" id="3858342">,</span>&nbsp;<span class="num" id="3858344">13</span><span class="op" id="3858346">,</span>&nbsp;<span class="num" id="3858348">17</span><span class="op" id="3858350">,</span>&nbsp;<span class="num" id="3858352">19</span><span class="op" id="3858354">,</span>&nbsp;<span class="num" id="3858356">23</span><span class="op" id="3858358">,</span>&nbsp;<span class="num" id="3858360">29</span><span class="op" id="3858362">,</span>&nbsp;<span class="num" id="3858364">31</span><span class="op" id="3858366">,</span>&nbsp;<span class="num" id="3858368">37</span><span class="op" id="3858370">,</span>&nbsp;<span class="num" id="3858372">41</span><span class="op" id="3858374">,</span>&nbsp;<span class="num" id="3858376">43</span><span class="op" id="3858378">,</span>&nbsp;<span class="num" id="3858380">47</span><span class="op" id="3858382">,</span>&nbsp;<span class="num" id="3858384">53</span><span class="op" id="3858386">,</span><br>
<span class="lineno">20</span><span class="op" id="3858388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858391">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3858471">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3858549">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3858619">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3858634">var</span>&nbsp;<span class="ident" id="3858638">smallPrimesProduct</span>&nbsp;<span class="op" id="3858657">=</span>&nbsp;<span class="builtinfunc" id="3858659">new</span><span class="op" id="3858662">(</span><span class="ident" id="3858663">big</span><span class="op" id="3858666">.</span><span class="ident" id="3858667">Int</span><span class="op" id="3858670">)</span><span class="op" id="3858671">.</span><span class="ident" id="3858672">SetUint64</span><span class="op" id="3858681">(</span><span class="num" id="3858682">16294579238595022365</span><span class="op" id="3858702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858705">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3858775">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3858801">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3858880">func</span>&nbsp;<span class="ident" id="3858885">Prime</span><span class="op" id="3858890">(</span><span class="ident" id="3858891">rand</span>&nbsp;<span class="ident" id="3858896">io</span><span class="op" id="3858898">.</span><span class="ident" id="3858899">Reader</span><span class="op" id="3858905">,</span>&nbsp;<span class="ident" id="3858907">bits</span>&nbsp;<span class="builtintype" id="3858912">int</span><span class="op" id="3858915">)</span>&nbsp;<span class="op" id="3858917">(</span><span class="ident" id="3858918">p</span>&nbsp;<span class="op" id="3858920">*</span><span class="ident" id="3858921">big</span><span class="op" id="3858924">.</span><span class="ident" id="3858925">Int</span><span class="op" id="3858928">,</span>&nbsp;<span class="ident" id="3858930">err</span>&nbsp;<span class="builtintype" id="3858934">error</span><span class="op" id="3858939">)</span>&nbsp;<span class="op" id="3858941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858944">if</span>&nbsp;<span class="ident" id="3858947">bits</span>&nbsp;<span class="op" id="3858952">&lt;</span>&nbsp;<span class="num" id="3858954">2</span>&nbsp;<span class="op" id="3858956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858960">err</span>&nbsp;<span class="op" id="3858964">=</span>&nbsp;<span class="ident" id="3858966">errors</span><span class="op" id="3858972">.</span><span class="ident" id="3858973">New</span><span class="op" id="3858976">(</span><span class="string" id="3858977">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3859025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859029">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859041">b</span>&nbsp;<span class="op" id="3859043">:=</span>&nbsp;<span class="builtintype" id="3859046">uint</span><span class="op" id="3859050">(</span><span class="ident" id="3859051">bits</span>&nbsp;<span class="op" id="3859056">%</span>&nbsp;<span class="num" id="3859058">8</span><span class="op" id="3859059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859062">if</span>&nbsp;<span class="ident" id="3859065">b</span>&nbsp;<span class="op" id="3859067">==</span>&nbsp;<span class="num" id="3859070">0</span>&nbsp;<span class="op" id="3859072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859076">b</span>&nbsp;<span class="op" id="3859078">=</span>&nbsp;<span class="num" id="3859080">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859087">bytes</span>&nbsp;<span class="op" id="3859093">:=</span>&nbsp;<span class="builtinfunc" id="3859096">make</span><span class="op" id="3859100">(</span><span class="op" id="3859101">[</span><span class="op" id="3859102">]</span><span class="builtintype" id="3859103">byte</span><span class="op" id="3859107">,</span>&nbsp;<span class="op" id="3859109">(</span><span class="ident" id="3859110">bits</span><span class="op" id="3859114">+</span><span class="num" id="3859115">7</span><span class="op" id="3859116">)</span><span class="op" id="3859117">/</span><span class="num" id="3859118">8</span><span class="op" id="3859119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859122">p</span>&nbsp;<span class="op" id="3859124">=</span>&nbsp;<span class="builtinfunc" id="3859126">new</span><span class="op" id="3859129">(</span><span class="ident" id="3859130">big</span><span class="op" id="3859133">.</span><span class="ident" id="3859134">Int</span><span class="op" id="3859137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859141">bigMod</span>&nbsp;<span class="op" id="3859148">:=</span>&nbsp;<span class="builtinfunc" id="3859151">new</span><span class="op" id="3859154">(</span><span class="ident" id="3859155">big</span><span class="op" id="3859158">.</span><span class="ident" id="3859159">Int</span><span class="op" id="3859162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859166">for</span>&nbsp;<span class="op" id="3859170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859174">_</span><span class="op" id="3859175">,</span>&nbsp;<span class="ident" id="3859177">err</span>&nbsp;<span class="op" id="3859181">=</span>&nbsp;<span class="ident" id="3859183">io</span><span class="op" id="3859185">.</span><span class="ident" id="3859186">ReadFull</span><span class="op" id="3859194">(</span><span class="ident" id="3859195">rand</span><span class="op" id="3859199">,</span>&nbsp;<span class="ident" id="3859201">bytes</span><span class="op" id="3859206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859210">if</span>&nbsp;<span class="ident" id="3859213">err</span>&nbsp;<span class="op" id="3859217">!=</span>&nbsp;<span class="ident" id="3859220">nil</span>&nbsp;<span class="op" id="3859224">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859229">return</span>&nbsp;<span class="ident" id="3859236">nil</span><span class="op" id="3859239">,</span>&nbsp;<span class="ident" id="3859241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859252">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859333">bytes</span><span class="op" id="3859338">[</span><span class="num" id="3859339">0</span><span class="op" id="3859340">]</span>&nbsp;<span class="op" id="3859342">&amp;=</span>&nbsp;<span class="builtintype" id="3859345">uint8</span><span class="op" id="3859350">(</span><span class="builtintype" id="3859351">int</span><span class="op" id="3859354">(</span><span class="num" id="3859355">1</span><span class="op" id="3859356">&lt;&lt;</span><span class="ident" id="3859358">b</span><span class="op" id="3859359">)</span>&nbsp;<span class="op" id="3859361">-</span>&nbsp;<span class="num" id="3859363">1</span><span class="op" id="3859364">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859368">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859447">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859508">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859574">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859616">if</span>&nbsp;<span class="ident" id="3859619">b</span>&nbsp;<span class="op" id="3859621">&gt;=</span>&nbsp;<span class="num" id="3859624">2</span>&nbsp;<span class="op" id="3859626">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859631">bytes</span><span class="op" id="3859636">[</span><span class="num" id="3859637">0</span><span class="op" id="3859638">]</span>&nbsp;<span class="op" id="3859640">|=</span>&nbsp;<span class="num" id="3859643">3</span>&nbsp;<span class="op" id="3859645">&lt;&lt;</span>&nbsp;<span class="op" id="3859648">(</span><span class="ident" id="3859649">b</span>&nbsp;<span class="op" id="3859651">-</span>&nbsp;<span class="num" id="3859653">2</span><span class="op" id="3859654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859658">}</span>&nbsp;<span class="keyword" id="3859660">else</span>&nbsp;<span class="op" id="3859665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859670">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859713">bytes</span><span class="op" id="3859718">[</span><span class="num" id="3859719">0</span><span class="op" id="3859720">]</span>&nbsp;<span class="op" id="3859722">|=</span>&nbsp;<span class="num" id="3859725">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859730">if</span>&nbsp;<span class="builtinfunc" id="3859733">len</span><span class="op" id="3859736">(</span><span class="ident" id="3859737">bytes</span><span class="op" id="3859742">)</span>&nbsp;<span class="op" id="3859744">&gt;</span>&nbsp;<span class="num" id="3859746">1</span>&nbsp;<span class="op" id="3859748">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859754">bytes</span><span class="op" id="3859759">[</span><span class="num" id="3859760">1</span><span class="op" id="3859761">]</span>&nbsp;<span class="op" id="3859763">|=</span>&nbsp;<span class="num" id="3859766">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859782">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859861">bytes</span><span class="op" id="3859866">[</span><span class="builtinfunc" id="3859867">len</span><span class="op" id="3859870">(</span><span class="ident" id="3859871">bytes</span><span class="op" id="3859876">)</span><span class="op" id="3859877">-</span><span class="num" id="3859878">1</span><span class="op" id="3859879">]</span>&nbsp;<span class="op" id="3859881">|=</span>&nbsp;<span class="num" id="3859884">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859889">p</span><span class="op" id="3859890">.</span><span class="ident" id="3859891">SetBytes</span><span class="op" id="3859899">(</span><span class="ident" id="3859900">bytes</span><span class="op" id="3859905">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859910">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859976">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860042">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860108">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860172">bigMod</span><span class="op" id="3860178">.</span><span class="ident" id="3860179">Mod</span><span class="op" id="3860182">(</span><span class="ident" id="3860183">p</span><span class="op" id="3860184">,</span>&nbsp;<span class="ident" id="3860186">smallPrimesProduct</span><span class="op" id="3860204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860208">mod</span>&nbsp;<span class="op" id="3860212">:=</span>&nbsp;<span class="ident" id="3860215">bigMod</span><span class="op" id="3860221">.</span><span class="ident" id="3860222">Uint64</span><span class="op" id="3860228">(</span><span class="op" id="3860229">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860233">NextDelta</span><span class="op" id="3860242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860246">for</span>&nbsp;<span class="ident" id="3860250">delta</span>&nbsp;<span class="op" id="3860256">:=</span>&nbsp;<span class="ident" id="3860259">uint64</span><span class="op" id="3860265">(</span><span class="num" id="3860266">0</span><span class="op" id="3860267">)</span><span class="op" id="3860268">;</span>&nbsp;<span class="ident" id="3860270">delta</span>&nbsp;<span class="op" id="3860276">&lt;</span>&nbsp;<span class="num" id="3860278">1</span><span class="op" id="3860279">&lt;&lt;</span><span class="num" id="3860281">20</span><span class="op" id="3860283">;</span>&nbsp;<span class="ident" id="3860285">delta</span>&nbsp;<span class="op" id="3860291">+=</span>&nbsp;<span class="num" id="3860294">2</span>&nbsp;<span class="op" id="3860296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860301">m</span>&nbsp;<span class="op" id="3860303">:=</span>&nbsp;<span class="ident" id="3860306">mod</span>&nbsp;<span class="op" id="3860310">+</span>&nbsp;<span class="ident" id="3860312">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860321">for</span>&nbsp;<span class="ident" id="3860325">_</span><span class="op" id="3860326">,</span>&nbsp;<span class="ident" id="3860328">prime</span>&nbsp;<span class="op" id="3860334">:=</span>&nbsp;<span class="keyword" id="3860337">range</span>&nbsp;<span class="ident" id="3860343">smallPrimes</span>&nbsp;<span class="op" id="3860355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860361">if</span>&nbsp;<span class="ident" id="3860364">m</span><span class="op" id="3860365">%</span><span class="ident" id="3860366">uint64</span><span class="op" id="3860372">(</span><span class="ident" id="3860373">prime</span><span class="op" id="3860378">)</span>&nbsp;<span class="op" id="3860380">==</span>&nbsp;<span class="num" id="3860383">0</span>&nbsp;<span class="op" id="3860385">&amp;&amp;</span>&nbsp;<span class="op" id="3860388">(</span><span class="ident" id="3860389">bits</span>&nbsp;<span class="op" id="3860394">&gt;</span>&nbsp;<span class="num" id="3860396">6</span>&nbsp;<span class="op" id="3860398">||</span>&nbsp;<span class="ident" id="3860401">m</span>&nbsp;<span class="op" id="3860403">!=</span>&nbsp;<span class="ident" id="3860406">uint64</span><span class="op" id="3860412">(</span><span class="ident" id="3860413">prime</span><span class="op" id="3860418">)</span><span class="op" id="3860419">)</span>&nbsp;<span class="op" id="3860421">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860428">continue</span>&nbsp;<span class="ident" id="3860437">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860462">if</span>&nbsp;<span class="ident" id="3860465">delta</span>&nbsp;<span class="op" id="3860471">&gt;</span>&nbsp;<span class="num" id="3860473">0</span>&nbsp;<span class="op" id="3860475">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860481">bigMod</span><span class="op" id="3860487">.</span><span class="ident" id="3860488">SetUint64</span><span class="op" id="3860497">(</span><span class="ident" id="3860498">delta</span><span class="op" id="3860503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860509">p</span><span class="op" id="3860510">.</span><span class="ident" id="3860511">Add</span><span class="op" id="3860514">(</span><span class="ident" id="3860515">p</span><span class="op" id="3860516">,</span>&nbsp;<span class="ident" id="3860518">bigMod</span><span class="op" id="3860524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860534">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860542">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860547">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860613">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860674">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860685">if</span>&nbsp;<span class="ident" id="3860688">p</span><span class="op" id="3860689">.</span><span class="ident" id="3860690">ProbablyPrime</span><span class="op" id="3860703">(</span><span class="num" id="3860704">20</span><span class="op" id="3860706">)</span>&nbsp;<span class="op" id="3860708">&amp;&amp;</span>&nbsp;<span class="ident" id="3860711">p</span><span class="op" id="3860712">.</span><span class="ident" id="3860713">BitLen</span><span class="op" id="3860719">(</span><span class="op" id="3860720">)</span>&nbsp;<span class="op" id="3860722">==</span>&nbsp;<span class="ident" id="3860725">bits</span>&nbsp;<span class="op" id="3860730">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860735">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860747">}</span><br>
<span class="lineno"></span><span class="op" id="3860749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3860752">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3860826">func</span>&nbsp;<span class="ident" id="3860831">Int</span><span class="op" id="3860834">(</span><span class="ident" id="3860835">rand</span>&nbsp;<span class="ident" id="3860840">io</span><span class="op" id="3860842">.</span><span class="ident" id="3860843">Reader</span><span class="op" id="3860849">,</span>&nbsp;<span class="ident" id="3860851">max</span>&nbsp;<span class="op" id="3860855">*</span><span class="ident" id="3860856">big</span><span class="op" id="3860859">.</span><span class="ident" id="3860860">Int</span><span class="op" id="3860863">)</span>&nbsp;<span class="op" id="3860865">(</span><span class="ident" id="3860866">n</span>&nbsp;<span class="op" id="3860868">*</span><span class="ident" id="3860869">big</span><span class="op" id="3860872">.</span><span class="ident" id="3860873">Int</span><span class="op" id="3860876">,</span>&nbsp;<span class="ident" id="3860878">err</span>&nbsp;<span class="builtintype" id="3860882">error</span><span class="op" id="3860887">)</span>&nbsp;<span class="op" id="3860889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860892">if</span>&nbsp;<span class="ident" id="3860895">max</span><span class="op" id="3860898">.</span><span class="ident" id="3860899">Sign</span><span class="op" id="3860903">(</span><span class="op" id="3860904">)</span>&nbsp;<span class="op" id="3860906">&lt;=</span>&nbsp;<span class="num" id="3860909">0</span>&nbsp;<span class="op" id="3860911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3860915">panic</span><span class="op" id="3860920">(</span><span class="string" id="3860921">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3860959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860962">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860965">k</span>&nbsp;<span class="op" id="3860967">:=</span>&nbsp;<span class="op" id="3860970">(</span><span class="ident" id="3860971">max</span><span class="op" id="3860974">.</span><span class="ident" id="3860975">BitLen</span><span class="op" id="3860981">(</span><span class="op" id="3860982">)</span>&nbsp;<span class="op" id="3860984">+</span>&nbsp;<span class="num" id="3860986">7</span><span class="op" id="3860987">)</span>&nbsp;<span class="op" id="3860989">/</span>&nbsp;<span class="num" id="3860991">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860995">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861060">b</span>&nbsp;<span class="op" id="3861062">:=</span>&nbsp;<span class="builtintype" id="3861065">uint</span><span class="op" id="3861069">(</span><span class="ident" id="3861070">max</span><span class="op" id="3861073">.</span><span class="ident" id="3861074">BitLen</span><span class="op" id="3861080">(</span><span class="op" id="3861081">)</span>&nbsp;<span class="op" id="3861083">%</span>&nbsp;<span class="num" id="3861085">8</span><span class="op" id="3861086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861089">if</span>&nbsp;<span class="ident" id="3861092">b</span>&nbsp;<span class="op" id="3861094">==</span>&nbsp;<span class="num" id="3861097">0</span>&nbsp;<span class="op" id="3861099">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861103">b</span>&nbsp;<span class="op" id="3861105">=</span>&nbsp;<span class="num" id="3861107">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861114">bytes</span>&nbsp;<span class="op" id="3861120">:=</span>&nbsp;<span class="builtinfunc" id="3861123">make</span><span class="op" id="3861127">(</span><span class="op" id="3861128">[</span><span class="op" id="3861129">]</span><span class="builtintype" id="3861130">byte</span><span class="op" id="3861134">,</span>&nbsp;<span class="ident" id="3861136">k</span><span class="op" id="3861137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861140">n</span>&nbsp;<span class="op" id="3861142">=</span>&nbsp;<span class="builtinfunc" id="3861144">new</span><span class="op" id="3861147">(</span><span class="ident" id="3861148">big</span><span class="op" id="3861151">.</span><span class="ident" id="3861152">Int</span><span class="op" id="3861155">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861159">for</span>&nbsp;<span class="op" id="3861163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861167">_</span><span class="op" id="3861168">,</span>&nbsp;<span class="ident" id="3861170">err</span>&nbsp;<span class="op" id="3861174">=</span>&nbsp;<span class="ident" id="3861176">io</span><span class="op" id="3861178">.</span><span class="ident" id="3861179">ReadFull</span><span class="op" id="3861187">(</span><span class="ident" id="3861188">rand</span><span class="op" id="3861192">,</span>&nbsp;<span class="ident" id="3861194">bytes</span><span class="op" id="3861199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861203">if</span>&nbsp;<span class="ident" id="3861206">err</span>&nbsp;<span class="op" id="3861210">!=</span>&nbsp;<span class="ident" id="3861213">nil</span>&nbsp;<span class="op" id="3861217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861222">return</span>&nbsp;<span class="ident" id="3861229">nil</span><span class="op" id="3861232">,</span>&nbsp;<span class="ident" id="3861234">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3861245">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3861307">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861341">bytes</span><span class="op" id="3861346">[</span><span class="num" id="3861347">0</span><span class="op" id="3861348">]</span>&nbsp;<span class="op" id="3861350">&amp;=</span>&nbsp;<span class="builtintype" id="3861353">uint8</span><span class="op" id="3861358">(</span><span class="builtintype" id="3861359">int</span><span class="op" id="3861362">(</span><span class="num" id="3861363">1</span><span class="op" id="3861364">&lt;&lt;</span><span class="ident" id="3861366">b</span><span class="op" id="3861367">)</span>&nbsp;<span class="op" id="3861369">-</span>&nbsp;<span class="num" id="3861371">1</span><span class="op" id="3861372">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861377">n</span><span class="op" id="3861378">.</span><span class="ident" id="3861379">SetBytes</span><span class="op" id="3861387">(</span><span class="ident" id="3861388">bytes</span><span class="op" id="3861393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861397">if</span>&nbsp;<span class="ident" id="3861400">n</span><span class="op" id="3861401">.</span><span class="ident" id="3861402">Cmp</span><span class="op" id="3861405">(</span><span class="ident" id="3861406">max</span><span class="op" id="3861409">)</span>&nbsp;<span class="op" id="3861411">&lt;</span>&nbsp;<span class="num" id="3861413">0</span>&nbsp;<span class="op" id="3861415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861429">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861432">}</span><br>
<span class="lineno"></span><span class="op" id="3861434">}</span>
</div>
</body>
</html>
