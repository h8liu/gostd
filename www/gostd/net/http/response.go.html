<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4904410">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4904465">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4904519">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4904570">//&nbsp;HTTP&nbsp;Response&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4904609">package</span>&nbsp;<span class="ident" id="4904617">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4904623">import</span>&nbsp;<span class="op" id="4904630">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904633">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904642">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904651">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904665">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904675">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904681">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904698">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904709">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904720">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4904730">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4904733">var</span>&nbsp;<span class="ident" id="4904737">respExcludeHeader</span>&nbsp;<span class="op" id="4904755">=</span>&nbsp;<span class="keyword" id="4904757">map</span><span class="op" id="4904760">[</span><span class="builtintype" id="4904761">string</span><span class="op" id="4904767">]</span><span class="builtintype" id="4904768">bool</span><span class="op" id="4904772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904775">&#34;Content-Length&#34;</span><span class="op" id="4904791">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904796">true</span><span class="op" id="4904800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904803">&#34;Transfer-Encoding&#34;</span><span class="op" id="4904822">:</span>&nbsp;<span class="builtintype" id="4904824">true</span><span class="op" id="4904828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4904831">&#34;Trailer&#34;</span><span class="op" id="4904840">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904852">true</span><span class="op" id="4904856">,</span><br>
<span class="lineno">25</span><span class="op" id="4904858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4904861">//&nbsp;Response&nbsp;represents&nbsp;the&nbsp;response&nbsp;from&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4904919">//</span><br>
<span class="lineno"></span><span class="keyword" id="4904922">type</span>&nbsp;<span class="ident" id="4904927">Response</span>&nbsp;<span class="keyword" id="4904936">struct</span>&nbsp;<span class="op" id="4904943">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904946">Status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904957">string</span>&nbsp;<span class="comment" id="4904964">//&nbsp;e.g.&nbsp;&#34;200&nbsp;OK&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904982">StatusCode</span>&nbsp;<span class="builtintype" id="4904993">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4905000">//&nbsp;e.g.&nbsp;200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905013">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4905024">string</span>&nbsp;<span class="comment" id="4905031">//&nbsp;e.g.&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905051">ProtoMajor</span>&nbsp;<span class="builtintype" id="4905062">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4905069">//&nbsp;e.g.&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905080">ProtoMinor</span>&nbsp;<span class="builtintype" id="4905091">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4905098">//&nbsp;e.g.&nbsp;0</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905110">//&nbsp;Header&nbsp;maps&nbsp;header&nbsp;keys&nbsp;to&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;response&nbsp;had&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905179">//&nbsp;headers&nbsp;with&nbsp;the&nbsp;same&nbsp;key,&nbsp;they&nbsp;may&nbsp;be&nbsp;concatenated,&nbsp;with&nbsp;comma</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905247">//&nbsp;delimiters.&nbsp;&nbsp;(Section&nbsp;4.2&nbsp;of&nbsp;RFC&nbsp;2616&nbsp;requires&nbsp;that&nbsp;multiple&nbsp;headers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905320">//&nbsp;be&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;a&nbsp;comma-delimited&nbsp;sequence.)&nbsp;Values</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905390">//&nbsp;duplicated&nbsp;by&nbsp;other&nbsp;fields&nbsp;in&nbsp;this&nbsp;struct&nbsp;(e.g.,&nbsp;ContentLength)&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905462">//&nbsp;omitted&nbsp;from&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905487">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905491">//&nbsp;Keys&nbsp;in&nbsp;the&nbsp;map&nbsp;are&nbsp;canonicalized&nbsp;(see&nbsp;CanonicalHeaderKey).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905555">Header</span>&nbsp;<span class="ident" id="4905562">Header</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905571">//&nbsp;Body&nbsp;represents&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905610">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905614">//&nbsp;The&nbsp;http&nbsp;Client&nbsp;and&nbsp;Transport&nbsp;guarantee&nbsp;that&nbsp;Body&nbsp;is&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905678">//&nbsp;non-nil,&nbsp;even&nbsp;on&nbsp;responses&nbsp;without&nbsp;a&nbsp;body&nbsp;or&nbsp;responses&nbsp;with</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905742">//&nbsp;a&nbsp;zero-length&nbsp;body.&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905803">//&nbsp;close&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905819">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905823">//&nbsp;The&nbsp;Body&nbsp;is&nbsp;automatically&nbsp;dechunked&nbsp;if&nbsp;the&nbsp;server&nbsp;replied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905885">//&nbsp;with&nbsp;a&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905925">Body</span>&nbsp;<span class="ident" id="4905930">io</span><span class="op" id="4905932">.</span><span class="ident" id="4905933">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905946">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.&nbsp;&nbsp;The</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906015">//&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.&nbsp;&nbsp;Unless&nbsp;Request.Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906089">//&nbsp;is&nbsp;&#34;HEAD&#34;,&nbsp;values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906160">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906183">ContentLength</span>&nbsp;<span class="ident" id="4906197">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906205">//&nbsp;Contains&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outer-most&nbsp;to&nbsp;inner-most.&nbsp;Value&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906277">//&nbsp;nil,&nbsp;means&nbsp;that&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906326">TransferEncoding</span>&nbsp;<span class="op" id="4906343">[</span><span class="op" id="4906344">]</span><span class="builtintype" id="4906345">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906354">//&nbsp;Close&nbsp;records&nbsp;whether&nbsp;the&nbsp;header&nbsp;directed&nbsp;that&nbsp;the&nbsp;connection&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906423">//&nbsp;closed&nbsp;after&nbsp;reading&nbsp;Body.&nbsp;&nbsp;The&nbsp;value&nbsp;is&nbsp;advice&nbsp;for&nbsp;clients:&nbsp;neither</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906496">//&nbsp;ReadResponse&nbsp;nor&nbsp;Response.Write&nbsp;ever&nbsp;closes&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906558">Close</span>&nbsp;<span class="builtintype" id="4906564">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906571">//&nbsp;Trailer&nbsp;maps&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;values,&nbsp;in&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906624">//&nbsp;format&nbsp;as&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906650">Trailer</span>&nbsp;<span class="ident" id="4906658">Header</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906667">//&nbsp;The&nbsp;Request&nbsp;that&nbsp;was&nbsp;sent&nbsp;to&nbsp;obtain&nbsp;this&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906722">//&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;nil&nbsp;(having&nbsp;already&nbsp;been&nbsp;consumed).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906780">//&nbsp;This&nbsp;is&nbsp;only&nbsp;populated&nbsp;for&nbsp;Client&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906828">Request</span>&nbsp;<span class="op" id="4906836">*</span><span class="ident" id="4906837">Request</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906847">//&nbsp;TLS&nbsp;contains&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906914">//&nbsp;response&nbsp;was&nbsp;received.&nbsp;It&nbsp;is&nbsp;nil&nbsp;for&nbsp;unencrypted&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906978">//&nbsp;The&nbsp;pointer&nbsp;is&nbsp;shared&nbsp;between&nbsp;responses&nbsp;and&nbsp;should&nbsp;not&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907040">//&nbsp;modified.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907054">TLS</span>&nbsp;<span class="op" id="4907058">*</span><span class="ident" id="4907059">tls</span><span class="op" id="4907062">.</span><span class="ident" id="4907063">ConnectionState</span><br>
<span class="lineno"></span><span class="op" id="4907079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4907082">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;cookies&nbsp;set&nbsp;in&nbsp;the&nbsp;Set-Cookie&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="4907155">func</span>&nbsp;<span class="op" id="4907160">(</span><span class="ident" id="4907161">r</span>&nbsp;<span class="op" id="4907163">*</span><span class="ident" id="4907164">Response</span><span class="op" id="4907172">)</span>&nbsp;<span class="ident" id="4907174">Cookies</span><span class="op" id="4907181">(</span><span class="op" id="4907182">)</span>&nbsp;<span class="op" id="4907184">[</span><span class="op" id="4907185">]</span><span class="op" id="4907186">*</span><span class="ident" id="4907187">Cookie</span>&nbsp;<span class="op" id="4907194">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907197">return</span>&nbsp;<span class="ident" id="4907204">readSetCookies</span><span class="op" id="4907218">(</span><span class="ident" id="4907219">r</span><span class="op" id="4907220">.</span><span class="ident" id="4907221">Header</span><span class="op" id="4907227">)</span><br>
<span class="lineno"></span><span class="op" id="4907229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4907232">var</span>&nbsp;<span class="ident" id="4907236">ErrNoLocation</span>&nbsp;<span class="op" id="4907250">=</span>&nbsp;<span class="ident" id="4907252">errors</span><span class="op" id="4907258">.</span><span class="ident" id="4907259">New</span><span class="op" id="4907262">(</span><span class="string" id="4907263">&#34;http:&nbsp;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="4907301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4907304">//&nbsp;Location&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;response&#39;s&nbsp;&#34;Location&#34;&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="4907369">//&nbsp;if&nbsp;present.&nbsp;&nbsp;Relative&nbsp;redirects&nbsp;are&nbsp;resolved&nbsp;relative&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4907429">//&nbsp;the&nbsp;Response&#39;s&nbsp;Request.&nbsp;&nbsp;ErrNoLocation&nbsp;is&nbsp;returned&nbsp;if&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4907489">//&nbsp;Location&nbsp;header&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span><span class="keyword" id="4907520">func</span>&nbsp;<span class="op" id="4907525">(</span><span class="ident" id="4907526">r</span>&nbsp;<span class="op" id="4907528">*</span><span class="ident" id="4907529">Response</span><span class="op" id="4907537">)</span>&nbsp;<span class="ident" id="4907539">Location</span><span class="op" id="4907547">(</span><span class="op" id="4907548">)</span>&nbsp;<span class="op" id="4907550">(</span><span class="op" id="4907551">*</span><span class="ident" id="4907552">url</span><span class="op" id="4907555">.</span><span class="ident" id="4907556">URL</span><span class="op" id="4907559">,</span>&nbsp;<span class="builtintype" id="4907561">error</span><span class="op" id="4907566">)</span>&nbsp;<span class="op" id="4907568">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907571">lv</span>&nbsp;<span class="op" id="4907574">:=</span>&nbsp;<span class="ident" id="4907577">r</span><span class="op" id="4907578">.</span><span class="ident" id="4907579">Header</span><span class="op" id="4907585">.</span><span class="ident" id="4907586">Get</span><span class="op" id="4907589">(</span><span class="string" id="4907590">&#34;Location&#34;</span><span class="op" id="4907600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907603">if</span>&nbsp;<span class="ident" id="4907606">lv</span>&nbsp;<span class="op" id="4907609">==</span>&nbsp;<span class="string" id="4907612">&#34;&#34;</span>&nbsp;<span class="op" id="4907615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907619">return</span>&nbsp;<span class="ident" id="4907626">nil</span><span class="op" id="4907629">,</span>&nbsp;<span class="ident" id="4907631">ErrNoLocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907649">if</span>&nbsp;<span class="ident" id="4907652">r</span><span class="op" id="4907653">.</span><span class="ident" id="4907654">Request</span>&nbsp;<span class="op" id="4907662">!=</span>&nbsp;<span class="ident" id="4907665">nil</span>&nbsp;<span class="op" id="4907669">&amp;&amp;</span>&nbsp;<span class="ident" id="4907672">r</span><span class="op" id="4907673">.</span><span class="ident" id="4907674">Request</span><span class="op" id="4907681">.</span><span class="ident" id="4907682">URL</span>&nbsp;<span class="op" id="4907686">!=</span>&nbsp;<span class="ident" id="4907689">nil</span>&nbsp;<span class="op" id="4907693">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907697">return</span>&nbsp;<span class="ident" id="4907704">r</span><span class="op" id="4907705">.</span><span class="ident" id="4907706">Request</span><span class="op" id="4907713">.</span><span class="ident" id="4907714">URL</span><span class="op" id="4907717">.</span><span class="ident" id="4907718">Parse</span><span class="op" id="4907723">(</span><span class="ident" id="4907724">lv</span><span class="op" id="4907726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907732">return</span>&nbsp;<span class="ident" id="4907739">url</span><span class="op" id="4907742">.</span><span class="ident" id="4907743">Parse</span><span class="op" id="4907748">(</span><span class="ident" id="4907749">lv</span><span class="op" id="4907751">)</span><br>
<span class="lineno"></span><span class="op" id="4907753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="4907756">//&nbsp;ReadResponse&nbsp;reads&nbsp;and&nbsp;returns&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="4907815">//&nbsp;The&nbsp;req&nbsp;parameter&nbsp;optionally&nbsp;specifies&nbsp;the&nbsp;Request&nbsp;that&nbsp;corresponds</span><br>
<span class="lineno"></span><span class="comment" id="4907886">//&nbsp;to&nbsp;this&nbsp;Response.&nbsp;If&nbsp;nil,&nbsp;a&nbsp;GET&nbsp;request&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="4907941">//&nbsp;Clients&nbsp;must&nbsp;call&nbsp;resp.Body.Close&nbsp;when&nbsp;finished&nbsp;reading&nbsp;resp.Body.</span><br>
<span class="lineno"></span><span class="comment" id="4908011">//&nbsp;After&nbsp;that&nbsp;call,&nbsp;clients&nbsp;can&nbsp;inspect&nbsp;resp.Trailer&nbsp;to&nbsp;find&nbsp;key/value</span><br>
<span class="lineno">115</span><span class="comment" id="4908082">//&nbsp;pairs&nbsp;included&nbsp;in&nbsp;the&nbsp;response&nbsp;trailer.</span><br>
<span class="lineno"></span><span class="keyword" id="4908125">func</span>&nbsp;<span class="ident" id="4908130">ReadResponse</span><span class="op" id="4908142">(</span><span class="ident" id="4908143">r</span>&nbsp;<span class="op" id="4908145">*</span><span class="ident" id="4908146">bufio</span><span class="op" id="4908151">.</span><span class="ident" id="4908152">Reader</span><span class="op" id="4908158">,</span>&nbsp;<span class="ident" id="4908160">req</span>&nbsp;<span class="op" id="4908164">*</span><span class="ident" id="4908165">Request</span><span class="op" id="4908172">)</span>&nbsp;<span class="op" id="4908174">(</span><span class="op" id="4908175">*</span><span class="ident" id="4908176">Response</span><span class="op" id="4908184">,</span>&nbsp;<span class="builtintype" id="4908186">error</span><span class="op" id="4908191">)</span>&nbsp;<span class="op" id="4908193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908196">tp</span>&nbsp;<span class="op" id="4908199">:=</span>&nbsp;<span class="ident" id="4908202">textproto</span><span class="op" id="4908211">.</span><span class="ident" id="4908212">NewReader</span><span class="op" id="4908221">(</span><span class="ident" id="4908222">r</span><span class="op" id="4908223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908226">resp</span>&nbsp;<span class="op" id="4908231">:=</span>&nbsp;<span class="op" id="4908234">&amp;</span><span class="ident" id="4908235">Response</span><span class="op" id="4908243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908247">Request</span><span class="op" id="4908254">:</span>&nbsp;<span class="ident" id="4908256">req</span><span class="op" id="4908259">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908266">//&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908308">line</span><span class="op" id="4908312">,</span>&nbsp;<span class="ident" id="4908314">err</span>&nbsp;<span class="op" id="4908318">:=</span>&nbsp;<span class="ident" id="4908321">tp</span><span class="op" id="4908323">.</span><span class="ident" id="4908324">ReadLine</span><span class="op" id="4908332">(</span><span class="op" id="4908333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908336">if</span>&nbsp;<span class="ident" id="4908339">err</span>&nbsp;<span class="op" id="4908343">!=</span>&nbsp;<span class="ident" id="4908346">nil</span>&nbsp;<span class="op" id="4908350">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908354">if</span>&nbsp;<span class="ident" id="4908357">err</span>&nbsp;<span class="op" id="4908361">==</span>&nbsp;<span class="ident" id="4908364">io</span><span class="op" id="4908366">.</span><span class="ident" id="4908367">EOF</span>&nbsp;<span class="op" id="4908371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908376">err</span>&nbsp;<span class="op" id="4908380">=</span>&nbsp;<span class="ident" id="4908382">io</span><span class="op" id="4908384">.</span><span class="ident" id="4908385">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908408">return</span>&nbsp;<span class="ident" id="4908415">nil</span><span class="op" id="4908418">,</span>&nbsp;<span class="ident" id="4908420">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908425">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908428">f</span>&nbsp;<span class="op" id="4908430">:=</span>&nbsp;<span class="ident" id="4908433">strings</span><span class="op" id="4908440">.</span><span class="ident" id="4908441">SplitN</span><span class="op" id="4908447">(</span><span class="ident" id="4908448">line</span><span class="op" id="4908452">,</span>&nbsp;<span class="string" id="4908454">&#34;&nbsp;&#34;</span><span class="op" id="4908457">,</span>&nbsp;<span class="num" id="4908459">3</span><span class="op" id="4908460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908463">if</span>&nbsp;<span class="builtinfunc" id="4908466">len</span><span class="op" id="4908469">(</span><span class="ident" id="4908470">f</span><span class="op" id="4908471">)</span>&nbsp;<span class="op" id="4908473">&lt;</span>&nbsp;<span class="num" id="4908475">2</span>&nbsp;<span class="op" id="4908477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908481">return</span>&nbsp;<span class="ident" id="4908488">nil</span><span class="op" id="4908491">,</span>&nbsp;<span class="op" id="4908493">&amp;</span><span class="ident" id="4908494">badStringError</span><span class="op" id="4908508">{</span><span class="string" id="4908509">&#34;malformed&nbsp;HTTP&nbsp;response&#34;</span><span class="op" id="4908534">,</span>&nbsp;<span class="ident" id="4908536">line</span><span class="op" id="4908540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908546">reasonPhrase</span>&nbsp;<span class="op" id="4908559">:=</span>&nbsp;<span class="string" id="4908562">&#34;&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908566">if</span>&nbsp;<span class="builtinfunc" id="4908569">len</span><span class="op" id="4908572">(</span><span class="ident" id="4908573">f</span><span class="op" id="4908574">)</span>&nbsp;<span class="op" id="4908576">&gt;</span>&nbsp;<span class="num" id="4908578">2</span>&nbsp;<span class="op" id="4908580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908584">reasonPhrase</span>&nbsp;<span class="op" id="4908597">=</span>&nbsp;<span class="ident" id="4908599">f</span><span class="op" id="4908600">[</span><span class="num" id="4908601">2</span><span class="op" id="4908602">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908608">resp</span><span class="op" id="4908612">.</span><span class="ident" id="4908613">Status</span>&nbsp;<span class="op" id="4908620">=</span>&nbsp;<span class="ident" id="4908622">f</span><span class="op" id="4908623">[</span><span class="num" id="4908624">1</span><span class="op" id="4908625">]</span>&nbsp;<span class="op" id="4908627">+</span>&nbsp;<span class="string" id="4908629">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4908633">+</span>&nbsp;<span class="ident" id="4908635">reasonPhrase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908649">resp</span><span class="op" id="4908653">.</span><span class="ident" id="4908654">StatusCode</span><span class="op" id="4908664">,</span>&nbsp;<span class="ident" id="4908666">err</span>&nbsp;<span class="op" id="4908670">=</span>&nbsp;<span class="ident" id="4908672">strconv</span><span class="op" id="4908679">.</span><span class="ident" id="4908680">Atoi</span><span class="op" id="4908684">(</span><span class="ident" id="4908685">f</span><span class="op" id="4908686">[</span><span class="num" id="4908687">1</span><span class="op" id="4908688">]</span><span class="op" id="4908689">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908692">if</span>&nbsp;<span class="ident" id="4908695">err</span>&nbsp;<span class="op" id="4908699">!=</span>&nbsp;<span class="ident" id="4908702">nil</span>&nbsp;<span class="op" id="4908706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908710">return</span>&nbsp;<span class="ident" id="4908717">nil</span><span class="op" id="4908720">,</span>&nbsp;<span class="op" id="4908722">&amp;</span><span class="ident" id="4908723">badStringError</span><span class="op" id="4908737">{</span><span class="string" id="4908738">&#34;malformed&nbsp;HTTP&nbsp;status&nbsp;code&#34;</span><span class="op" id="4908766">,</span>&nbsp;<span class="ident" id="4908768">f</span><span class="op" id="4908769">[</span><span class="num" id="4908770">1</span><span class="op" id="4908771">]</span><span class="op" id="4908772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908779">resp</span><span class="op" id="4908783">.</span><span class="ident" id="4908784">Proto</span>&nbsp;<span class="op" id="4908790">=</span>&nbsp;<span class="ident" id="4908792">f</span><span class="op" id="4908793">[</span><span class="num" id="4908794">0</span><span class="op" id="4908795">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908798">var</span>&nbsp;<span class="ident" id="4908802">ok</span>&nbsp;<span class="builtintype" id="4908805">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908811">if</span>&nbsp;<span class="ident" id="4908814">resp</span><span class="op" id="4908818">.</span><span class="ident" id="4908819">ProtoMajor</span><span class="op" id="4908829">,</span>&nbsp;<span class="ident" id="4908831">resp</span><span class="op" id="4908835">.</span><span class="ident" id="4908836">ProtoMinor</span><span class="op" id="4908846">,</span>&nbsp;<span class="ident" id="4908848">ok</span>&nbsp;<span class="op" id="4908851">=</span>&nbsp;<span class="ident" id="4908853">ParseHTTPVersion</span><span class="op" id="4908869">(</span><span class="ident" id="4908870">resp</span><span class="op" id="4908874">.</span><span class="ident" id="4908875">Proto</span><span class="op" id="4908880">)</span><span class="op" id="4908881">;</span>&nbsp;<span class="op" id="4908883">!</span><span class="ident" id="4908884">ok</span>&nbsp;<span class="op" id="4908887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908891">return</span>&nbsp;<span class="ident" id="4908898">nil</span><span class="op" id="4908901">,</span>&nbsp;<span class="op" id="4908903">&amp;</span><span class="ident" id="4908904">badStringError</span><span class="op" id="4908918">{</span><span class="string" id="4908919">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op" id="4908943">,</span>&nbsp;<span class="ident" id="4908945">resp</span><span class="op" id="4908949">.</span><span class="ident" id="4908950">Proto</span><span class="op" id="4908955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908962">//&nbsp;Parse&nbsp;the&nbsp;response&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908994">mimeHeader</span><span class="op" id="4909004">,</span>&nbsp;<span class="ident" id="4909006">err</span>&nbsp;<span class="op" id="4909010">:=</span>&nbsp;<span class="ident" id="4909013">tp</span><span class="op" id="4909015">.</span><span class="ident" id="4909016">ReadMIMEHeader</span><span class="op" id="4909030">(</span><span class="op" id="4909031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909034">if</span>&nbsp;<span class="ident" id="4909037">err</span>&nbsp;<span class="op" id="4909041">!=</span>&nbsp;<span class="ident" id="4909044">nil</span>&nbsp;<span class="op" id="4909048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909052">if</span>&nbsp;<span class="ident" id="4909055">err</span>&nbsp;<span class="op" id="4909059">==</span>&nbsp;<span class="ident" id="4909062">io</span><span class="op" id="4909064">.</span><span class="ident" id="4909065">EOF</span>&nbsp;<span class="op" id="4909069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909074">err</span>&nbsp;<span class="op" id="4909078">=</span>&nbsp;<span class="ident" id="4909080">io</span><span class="op" id="4909082">.</span><span class="ident" id="4909083">ErrUnexpectedEOF</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909106">return</span>&nbsp;<span class="ident" id="4909113">nil</span><span class="op" id="4909116">,</span>&nbsp;<span class="ident" id="4909118">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909126">resp</span><span class="op" id="4909130">.</span><span class="ident" id="4909131">Header</span>&nbsp;<span class="op" id="4909138">=</span>&nbsp;<span class="ident" id="4909140">Header</span><span class="op" id="4909146">(</span><span class="ident" id="4909147">mimeHeader</span><span class="op" id="4909157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909161">fixPragmaCacheControl</span><span class="op" id="4909182">(</span><span class="ident" id="4909183">resp</span><span class="op" id="4909187">.</span><span class="ident" id="4909188">Header</span><span class="op" id="4909194">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909198">err</span>&nbsp;<span class="op" id="4909202">=</span>&nbsp;<span class="ident" id="4909204">readTransfer</span><span class="op" id="4909216">(</span><span class="ident" id="4909217">resp</span><span class="op" id="4909221">,</span>&nbsp;<span class="ident" id="4909223">r</span><span class="op" id="4909224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909227">if</span>&nbsp;<span class="ident" id="4909230">err</span>&nbsp;<span class="op" id="4909234">!=</span>&nbsp;<span class="ident" id="4909237">nil</span>&nbsp;<span class="op" id="4909241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909245">return</span>&nbsp;<span class="ident" id="4909252">nil</span><span class="op" id="4909255">,</span>&nbsp;<span class="ident" id="4909257">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909266">return</span>&nbsp;<span class="ident" id="4909273">resp</span><span class="op" id="4909277">,</span>&nbsp;<span class="ident" id="4909279">nil</span><br>
<span class="lineno"></span><span class="op" id="4909283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="4909286">//&nbsp;RFC2616:&nbsp;Should&nbsp;treat</span><br>
<span class="lineno"></span><span class="comment" id="4909311">//&nbsp;&nbsp;&nbsp;&nbspPragma:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="comment" id="4909331">//&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="4909339">//&nbsp;&nbsp;&nbsp;&nbspCache-Control:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="keyword" id="4909366">func</span>&nbsp;<span class="ident" id="4909371">fixPragmaCacheControl</span><span class="op" id="4909392">(</span><span class="ident" id="4909393">header</span>&nbsp;<span class="ident" id="4909400">Header</span><span class="op" id="4909406">)</span>&nbsp;<span class="op" id="4909408">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909411">if</span>&nbsp;<span class="ident" id="4909414">hp</span><span class="op" id="4909416">,</span>&nbsp;<span class="ident" id="4909418">ok</span>&nbsp;<span class="op" id="4909421">:=</span>&nbsp;<span class="ident" id="4909424">header</span><span class="op" id="4909430">[</span><span class="string" id="4909431">&#34;Pragma&#34;</span><span class="op" id="4909439">]</span><span class="op" id="4909440">;</span>&nbsp;<span class="ident" id="4909442">ok</span>&nbsp;<span class="op" id="4909445">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4909448">len</span><span class="op" id="4909451">(</span><span class="ident" id="4909452">hp</span><span class="op" id="4909454">)</span>&nbsp;<span class="op" id="4909456">&gt;</span>&nbsp;<span class="num" id="4909458">0</span>&nbsp;<span class="op" id="4909460">&amp;&amp;</span>&nbsp;<span class="ident" id="4909463">hp</span><span class="op" id="4909465">[</span><span class="num" id="4909466">0</span><span class="op" id="4909467">]</span>&nbsp;<span class="op" id="4909469">==</span>&nbsp;<span class="string" id="4909472">&#34;no-cache&#34;</span>&nbsp;<span class="op" id="4909483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909487">if</span>&nbsp;<span class="ident" id="4909490">_</span><span class="op" id="4909491">,</span>&nbsp;<span class="ident" id="4909493">presentcc</span>&nbsp;<span class="op" id="4909503">:=</span>&nbsp;<span class="ident" id="4909506">header</span><span class="op" id="4909512">[</span><span class="string" id="4909513">&#34;Cache-Control&#34;</span><span class="op" id="4909528">]</span><span class="op" id="4909529">;</span>&nbsp;<span class="op" id="4909531">!</span><span class="ident" id="4909532">presentcc</span>&nbsp;<span class="op" id="4909542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909547">header</span><span class="op" id="4909553">[</span><span class="string" id="4909554">&#34;Cache-Control&#34;</span><span class="op" id="4909569">]</span>&nbsp;<span class="op" id="4909571">=</span>&nbsp;<span class="op" id="4909573">[</span><span class="op" id="4909574">]</span><span class="builtintype" id="4909575">string</span><span class="op" id="4909581">{</span><span class="string" id="4909582">&#34;no-cache&#34;</span><span class="op" id="4909592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909599">}</span><br>
<span class="lineno">180</span><span class="op" id="4909601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4909604">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="4909659">//&nbsp;in&nbsp;the&nbsp;response&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword" id="4909703">func</span>&nbsp;<span class="op" id="4909708">(</span><span class="ident" id="4909709">r</span>&nbsp;<span class="op" id="4909711">*</span><span class="ident" id="4909712">Response</span><span class="op" id="4909720">)</span>&nbsp;<span class="ident" id="4909722">ProtoAtLeast</span><span class="op" id="4909734">(</span><span class="ident" id="4909735">major</span><span class="op" id="4909740">,</span>&nbsp;<span class="ident" id="4909742">minor</span>&nbsp;<span class="builtintype" id="4909748">int</span><span class="op" id="4909751">)</span>&nbsp;<span class="builtintype" id="4909753">bool</span>&nbsp;<span class="op" id="4909758">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909761">return</span>&nbsp;<span class="ident" id="4909768">r</span><span class="op" id="4909769">.</span><span class="ident" id="4909770">ProtoMajor</span>&nbsp;<span class="op" id="4909781">&gt;</span>&nbsp;<span class="ident" id="4909783">major</span>&nbsp;<span class="op" id="4909789">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909794">r</span><span class="op" id="4909795">.</span><span class="ident" id="4909796">ProtoMajor</span>&nbsp;<span class="op" id="4909807">==</span>&nbsp;<span class="ident" id="4909810">major</span>&nbsp;<span class="op" id="4909816">&amp;&amp;</span>&nbsp;<span class="ident" id="4909819">r</span><span class="op" id="4909820">.</span><span class="ident" id="4909821">ProtoMinor</span>&nbsp;<span class="op" id="4909832">&gt;=</span>&nbsp;<span class="ident" id="4909835">minor</span><br>
<span class="lineno"></span><span class="op" id="4909841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4909844">//&nbsp;Writes&nbsp;the&nbsp;response&nbsp;(header,&nbsp;body&nbsp;and&nbsp;trailer)&nbsp;in&nbsp;wire&nbsp;format.&nbsp;This&nbsp;method</span><br>
<span class="lineno">190</span><span class="comment" id="4909922">//&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;response:</span><br>
<span class="lineno"></span><span class="comment" id="4909972">//</span><br>
<span class="lineno"></span><span class="comment" id="4909975">//&nbsp;&nbsp;StatusCode</span><br>
<span class="lineno"></span><span class="comment" id="4909990">//&nbsp;&nbsp;ProtoMajor</span><br>
<span class="lineno"></span><span class="comment" id="4910005">//&nbsp;&nbsp;ProtoMinor</span><br>
<span class="lineno">195</span><span class="comment" id="4910020">//&nbsp;&nbsp;Request.Method</span><br>
<span class="lineno"></span><span class="comment" id="4910039">//&nbsp;&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment" id="4910060">//&nbsp;&nbsp;Trailer</span><br>
<span class="lineno"></span><span class="comment" id="4910072">//&nbsp;&nbsp;Body</span><br>
<span class="lineno"></span><span class="comment" id="4910081">//&nbsp;&nbsp;ContentLength</span><br>
<span class="lineno">200</span><span class="comment" id="4910099">//&nbsp;&nbsp;Header,&nbsp;values&nbsp;for&nbsp;non-canonical&nbsp;keys&nbsp;will&nbsp;have&nbsp;unpredictable&nbsp;behavior</span><br>
<span class="lineno"></span><span class="comment" id="4910174">//</span><br>
<span class="lineno"></span><span class="comment" id="4910177">//&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4910213">func</span>&nbsp;<span class="op" id="4910218">(</span><span class="ident" id="4910219">r</span>&nbsp;<span class="op" id="4910221">*</span><span class="ident" id="4910222">Response</span><span class="op" id="4910230">)</span>&nbsp;<span class="ident" id="4910232">Write</span><span class="op" id="4910237">(</span><span class="ident" id="4910238">w</span>&nbsp;<span class="ident" id="4910240">io</span><span class="op" id="4910242">.</span><span class="ident" id="4910243">Writer</span><span class="op" id="4910249">)</span>&nbsp;<span class="builtintype" id="4910251">error</span>&nbsp;<span class="op" id="4910257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910260">//&nbsp;Status&nbsp;line</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910276">text</span>&nbsp;<span class="op" id="4910281">:=</span>&nbsp;<span class="ident" id="4910284">r</span><span class="op" id="4910285">.</span><span class="ident" id="4910286">Status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910294">if</span>&nbsp;<span class="ident" id="4910297">text</span>&nbsp;<span class="op" id="4910302">==</span>&nbsp;<span class="string" id="4910305">&#34;&#34;</span>&nbsp;<span class="op" id="4910308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910312">var</span>&nbsp;<span class="ident" id="4910316">ok</span>&nbsp;<span class="builtintype" id="4910319">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910326">text</span><span class="op" id="4910330">,</span>&nbsp;<span class="ident" id="4910332">ok</span>&nbsp;<span class="op" id="4910335">=</span>&nbsp;<span class="ident" id="4910337">statusText</span><span class="op" id="4910347">[</span><span class="ident" id="4910348">r</span><span class="op" id="4910349">.</span><span class="ident" id="4910350">StatusCode</span><span class="op" id="4910360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910364">if</span>&nbsp;<span class="op" id="4910367">!</span><span class="ident" id="4910368">ok</span>&nbsp;<span class="op" id="4910371">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910376">text</span>&nbsp;<span class="op" id="4910381">=</span>&nbsp;<span class="string" id="4910383">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4910398">+</span>&nbsp;<span class="ident" id="4910400">strconv</span><span class="op" id="4910407">.</span><span class="ident" id="4910408">Itoa</span><span class="op" id="4910412">(</span><span class="ident" id="4910413">r</span><span class="op" id="4910414">.</span><span class="ident" id="4910415">StatusCode</span><span class="op" id="4910425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910435">protoMajor</span><span class="op" id="4910445">,</span>&nbsp;<span class="ident" id="4910447">protoMinor</span>&nbsp;<span class="op" id="4910458">:=</span>&nbsp;<span class="ident" id="4910461">strconv</span><span class="op" id="4910468">.</span><span class="ident" id="4910469">Itoa</span><span class="op" id="4910473">(</span><span class="ident" id="4910474">r</span><span class="op" id="4910475">.</span><span class="ident" id="4910476">ProtoMajor</span><span class="op" id="4910486">)</span><span class="op" id="4910487">,</span>&nbsp;<span class="ident" id="4910489">strconv</span><span class="op" id="4910496">.</span><span class="ident" id="4910497">Itoa</span><span class="op" id="4910501">(</span><span class="ident" id="4910502">r</span><span class="op" id="4910503">.</span><span class="ident" id="4910504">ProtoMinor</span><span class="op" id="4910514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910517">statusCode</span>&nbsp;<span class="op" id="4910528">:=</span>&nbsp;<span class="ident" id="4910531">strconv</span><span class="op" id="4910538">.</span><span class="ident" id="4910539">Itoa</span><span class="op" id="4910543">(</span><span class="ident" id="4910544">r</span><span class="op" id="4910545">.</span><span class="ident" id="4910546">StatusCode</span><span class="op" id="4910556">)</span>&nbsp;<span class="op" id="4910558">+</span>&nbsp;<span class="string" id="4910560">&#34;&nbsp;&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910565">text</span>&nbsp;<span class="op" id="4910570">=</span>&nbsp;<span class="ident" id="4910572">strings</span><span class="op" id="4910579">.</span><span class="ident" id="4910580">TrimPrefix</span><span class="op" id="4910590">(</span><span class="ident" id="4910591">text</span><span class="op" id="4910595">,</span>&nbsp;<span class="ident" id="4910597">statusCode</span><span class="op" id="4910607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910610">if</span>&nbsp;<span class="ident" id="4910613">_</span><span class="op" id="4910614">,</span>&nbsp;<span class="ident" id="4910616">err</span>&nbsp;<span class="op" id="4910620">:=</span>&nbsp;<span class="ident" id="4910623">io</span><span class="op" id="4910625">.</span><span class="ident" id="4910626">WriteString</span><span class="op" id="4910637">(</span><span class="ident" id="4910638">w</span><span class="op" id="4910639">,</span>&nbsp;<span class="string" id="4910641">&#34;HTTP/&#34;</span><span class="op" id="4910648">+</span><span class="ident" id="4910649">protoMajor</span><span class="op" id="4910659">+</span><span class="string" id="4910660">&#34;.&#34;</span><span class="op" id="4910663">+</span><span class="ident" id="4910664">protoMinor</span><span class="op" id="4910674">+</span><span class="string" id="4910675">&#34;&nbsp;&#34;</span><span class="op" id="4910678">+</span><span class="ident" id="4910679">statusCode</span><span class="op" id="4910689">+</span><span class="ident" id="4910690">text</span><span class="op" id="4910694">+</span><span class="string" id="4910695">&#34;\r\n&#34;</span><span class="op" id="4910701">)</span><span class="op" id="4910702">;</span>&nbsp;<span class="ident" id="4910704">err</span>&nbsp;<span class="op" id="4910708">!=</span>&nbsp;<span class="ident" id="4910711">nil</span>&nbsp;<span class="op" id="4910715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910719">return</span>&nbsp;<span class="ident" id="4910726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910735">//&nbsp;Clone&nbsp;it,&nbsp;so&nbsp;we&nbsp;can&nbsp;modify&nbsp;r1&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910780">r1</span>&nbsp;<span class="op" id="4910783">:=</span>&nbsp;<span class="builtinfunc" id="4910786">new</span><span class="op" id="4910789">(</span><span class="ident" id="4910790">Response</span><span class="op" id="4910798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910801">*</span><span class="ident" id="4910802">r1</span>&nbsp;<span class="op" id="4910805">=</span>&nbsp;<span class="op" id="4910807">*</span><span class="ident" id="4910808">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910811">if</span>&nbsp;<span class="ident" id="4910814">r1</span><span class="op" id="4910816">.</span><span class="ident" id="4910817">ContentLength</span>&nbsp;<span class="op" id="4910831">==</span>&nbsp;<span class="num" id="4910834">0</span>&nbsp;<span class="op" id="4910836">&amp;&amp;</span>&nbsp;<span class="ident" id="4910839">r1</span><span class="op" id="4910841">.</span><span class="ident" id="4910842">Body</span>&nbsp;<span class="op" id="4910847">!=</span>&nbsp;<span class="ident" id="4910850">nil</span>&nbsp;<span class="op" id="4910854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910858">//&nbsp;Is&nbsp;it&nbsp;actually&nbsp;0&nbsp;length?&nbsp;Or&nbsp;just&nbsp;unknown?</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910905">var</span>&nbsp;<span class="ident" id="4910909">buf</span>&nbsp;<span class="op" id="4910913">[</span><span class="num" id="4910914">1</span><span class="op" id="4910915">]</span><span class="builtintype" id="4910916">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910923">n</span><span class="op" id="4910924">,</span>&nbsp;<span class="ident" id="4910926">err</span>&nbsp;<span class="op" id="4910930">:=</span>&nbsp;<span class="ident" id="4910933">r1</span><span class="op" id="4910935">.</span><span class="ident" id="4910936">Body</span><span class="op" id="4910940">.</span><span class="ident" id="4910941">Read</span><span class="op" id="4910945">(</span><span class="ident" id="4910946">buf</span><span class="op" id="4910949">[</span><span class="op" id="4910950">:</span><span class="op" id="4910951">]</span><span class="op" id="4910952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910956">if</span>&nbsp;<span class="ident" id="4910959">err</span>&nbsp;<span class="op" id="4910963">!=</span>&nbsp;<span class="ident" id="4910966">nil</span>&nbsp;<span class="op" id="4910970">&amp;&amp;</span>&nbsp;<span class="ident" id="4910973">err</span>&nbsp;<span class="op" id="4910977">!=</span>&nbsp;<span class="ident" id="4910980">io</span><span class="op" id="4910982">.</span><span class="ident" id="4910983">EOF</span>&nbsp;<span class="op" id="4910987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910992">return</span>&nbsp;<span class="ident" id="4910999">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911005">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911009">if</span>&nbsp;<span class="ident" id="4911012">n</span>&nbsp;<span class="op" id="4911014">==</span>&nbsp;<span class="num" id="4911017">0</span>&nbsp;<span class="op" id="4911019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911024">//&nbsp;Reset&nbsp;it&nbsp;to&nbsp;a&nbsp;known&nbsp;zero&nbsp;reader,&nbsp;in&nbsp;case&nbsp;underlying&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911086">//&nbsp;is&nbsp;unhappy&nbsp;being&nbsp;read&nbsp;repeatedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911126">r1</span><span class="op" id="4911128">.</span><span class="ident" id="4911129">Body</span>&nbsp;<span class="op" id="4911134">=</span>&nbsp;<span class="ident" id="4911136">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911148">}</span>&nbsp;<span class="keyword" id="4911150">else</span>&nbsp;<span class="op" id="4911155">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911160">r1</span><span class="op" id="4911162">.</span><span class="ident" id="4911163">ContentLength</span>&nbsp;<span class="op" id="4911177">=</span>&nbsp;<span class="op" id="4911179">-</span><span class="num" id="4911180">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911185">r1</span><span class="op" id="4911187">.</span><span class="ident" id="4911188">Body</span>&nbsp;<span class="op" id="4911193">=</span>&nbsp;<span class="keyword" id="4911195">struct</span>&nbsp;<span class="op" id="4911202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911208">io</span><span class="op" id="4911210">.</span><span class="ident" id="4911211">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911222">io</span><span class="op" id="4911224">.</span><span class="ident" id="4911225">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911235">}</span><span class="op" id="4911236">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911242">io</span><span class="op" id="4911244">.</span><span class="ident" id="4911245">MultiReader</span><span class="op" id="4911256">(</span><span class="ident" id="4911257">bytes</span><span class="op" id="4911262">.</span><span class="ident" id="4911263">NewReader</span><span class="op" id="4911272">(</span><span class="ident" id="4911273">buf</span><span class="op" id="4911276">[</span><span class="op" id="4911277">:</span><span class="num" id="4911278">1</span><span class="op" id="4911279">]</span><span class="op" id="4911280">)</span><span class="op" id="4911281">,</span>&nbsp;<span class="ident" id="4911283">r</span><span class="op" id="4911284">.</span><span class="ident" id="4911285">Body</span><span class="op" id="4911289">)</span><span class="op" id="4911290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911296">r</span><span class="op" id="4911297">.</span><span class="ident" id="4911298">Body</span><span class="op" id="4911302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911314">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911317">//&nbsp;If&nbsp;we&#39;re&nbsp;sending&nbsp;a&nbsp;non-chunked&nbsp;HTTP/1.1&nbsp;response&nbsp;without&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911380">//&nbsp;content-length,&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;do&nbsp;that&nbsp;is&nbsp;the&nbsp;old&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911444">//&nbsp;way,&nbsp;by&nbsp;noting&nbsp;the&nbsp;EOF&nbsp;with&nbsp;a&nbsp;connection&nbsp;close,&nbsp;so&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911507">//&nbsp;to&nbsp;set&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911525">if</span>&nbsp;<span class="ident" id="4911528">r1</span><span class="op" id="4911530">.</span><span class="ident" id="4911531">ContentLength</span>&nbsp;<span class="op" id="4911545">==</span>&nbsp;<span class="op" id="4911548">-</span><span class="num" id="4911549">1</span>&nbsp;<span class="op" id="4911551">&amp;&amp;</span>&nbsp;<span class="op" id="4911554">!</span><span class="ident" id="4911555">r1</span><span class="op" id="4911557">.</span><span class="ident" id="4911558">Close</span>&nbsp;<span class="op" id="4911564">&amp;&amp;</span>&nbsp;<span class="ident" id="4911567">r1</span><span class="op" id="4911569">.</span><span class="ident" id="4911570">ProtoAtLeast</span><span class="op" id="4911582">(</span><span class="num" id="4911583">1</span><span class="op" id="4911584">,</span>&nbsp;<span class="num" id="4911586">1</span><span class="op" id="4911587">)</span>&nbsp;<span class="op" id="4911589">&amp;&amp;</span>&nbsp;<span class="op" id="4911592">!</span><span class="ident" id="4911593">chunked</span><span class="op" id="4911600">(</span><span class="ident" id="4911601">r1</span><span class="op" id="4911603">.</span><span class="ident" id="4911604">TransferEncoding</span><span class="op" id="4911620">)</span>&nbsp;<span class="op" id="4911622">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911626">r1</span><span class="op" id="4911628">.</span><span class="ident" id="4911629">Close</span>&nbsp;<span class="op" id="4911635">=</span>&nbsp;<span class="builtintype" id="4911637">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911647">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911692">tw</span><span class="op" id="4911694">,</span>&nbsp;<span class="ident" id="4911696">err</span>&nbsp;<span class="op" id="4911700">:=</span>&nbsp;<span class="ident" id="4911703">newTransferWriter</span><span class="op" id="4911720">(</span><span class="ident" id="4911721">r1</span><span class="op" id="4911723">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911726">if</span>&nbsp;<span class="ident" id="4911729">err</span>&nbsp;<span class="op" id="4911733">!=</span>&nbsp;<span class="ident" id="4911736">nil</span>&nbsp;<span class="op" id="4911740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911744">return</span>&nbsp;<span class="ident" id="4911751">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911759">err</span>&nbsp;<span class="op" id="4911763">=</span>&nbsp;<span class="ident" id="4911765">tw</span><span class="op" id="4911767">.</span><span class="ident" id="4911768">WriteHeader</span><span class="op" id="4911779">(</span><span class="ident" id="4911780">w</span><span class="op" id="4911781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911784">if</span>&nbsp;<span class="ident" id="4911787">err</span>&nbsp;<span class="op" id="4911791">!=</span>&nbsp;<span class="ident" id="4911794">nil</span>&nbsp;<span class="op" id="4911798">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911802">return</span>&nbsp;<span class="ident" id="4911809">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911818">//&nbsp;Rest&nbsp;of&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911837">err</span>&nbsp;<span class="op" id="4911841">=</span>&nbsp;<span class="ident" id="4911843">r</span><span class="op" id="4911844">.</span><span class="ident" id="4911845">Header</span><span class="op" id="4911851">.</span><span class="ident" id="4911852">WriteSubset</span><span class="op" id="4911863">(</span><span class="ident" id="4911864">w</span><span class="op" id="4911865">,</span>&nbsp;<span class="ident" id="4911867">respExcludeHeader</span><span class="op" id="4911884">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911887">if</span>&nbsp;<span class="ident" id="4911890">err</span>&nbsp;<span class="op" id="4911894">!=</span>&nbsp;<span class="ident" id="4911897">nil</span>&nbsp;<span class="op" id="4911901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911905">return</span>&nbsp;<span class="ident" id="4911912">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911921">//&nbsp;contentLengthAlreadySent&nbsp;may&nbsp;have&nbsp;been&nbsp;already&nbsp;sent&nbsp;for</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911981">//&nbsp;POST/PUT&nbsp;requests,&nbsp;even&nbsp;if&nbsp;zero&nbsp;length.&nbsp;See&nbsp;Issue&nbsp;8180.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912041">contentLengthAlreadySent</span>&nbsp;<span class="op" id="4912066">:=</span>&nbsp;<span class="ident" id="4912069">tw</span><span class="op" id="4912071">.</span><span class="ident" id="4912072">shouldSendContentLength</span><span class="op" id="4912095">(</span><span class="op" id="4912096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912099">if</span>&nbsp;<span class="ident" id="4912102">r1</span><span class="op" id="4912104">.</span><span class="ident" id="4912105">ContentLength</span>&nbsp;<span class="op" id="4912119">==</span>&nbsp;<span class="num" id="4912122">0</span>&nbsp;<span class="op" id="4912124">&amp;&amp;</span>&nbsp;<span class="op" id="4912127">!</span><span class="ident" id="4912128">chunked</span><span class="op" id="4912135">(</span><span class="ident" id="4912136">r1</span><span class="op" id="4912138">.</span><span class="ident" id="4912139">TransferEncoding</span><span class="op" id="4912155">)</span>&nbsp;<span class="op" id="4912157">&amp;&amp;</span>&nbsp;<span class="op" id="4912160">!</span><span class="ident" id="4912161">contentLengthAlreadySent</span>&nbsp;<span class="op" id="4912186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912190">if</span>&nbsp;<span class="ident" id="4912193">_</span><span class="op" id="4912194">,</span>&nbsp;<span class="ident" id="4912196">err</span>&nbsp;<span class="op" id="4912200">:=</span>&nbsp;<span class="ident" id="4912203">io</span><span class="op" id="4912205">.</span><span class="ident" id="4912206">WriteString</span><span class="op" id="4912217">(</span><span class="ident" id="4912218">w</span><span class="op" id="4912219">,</span>&nbsp;<span class="string" id="4912221">&#34;Content-Length:&nbsp;0\r\n&#34;</span><span class="op" id="4912244">)</span><span class="op" id="4912245">;</span>&nbsp;<span class="ident" id="4912247">err</span>&nbsp;<span class="op" id="4912251">!=</span>&nbsp;<span class="ident" id="4912254">nil</span>&nbsp;<span class="op" id="4912258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912263">return</span>&nbsp;<span class="ident" id="4912270">err</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912283">//&nbsp;End-of-header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912301">if</span>&nbsp;<span class="ident" id="4912304">_</span><span class="op" id="4912305">,</span>&nbsp;<span class="ident" id="4912307">err</span>&nbsp;<span class="op" id="4912311">:=</span>&nbsp;<span class="ident" id="4912314">io</span><span class="op" id="4912316">.</span><span class="ident" id="4912317">WriteString</span><span class="op" id="4912328">(</span><span class="ident" id="4912329">w</span><span class="op" id="4912330">,</span>&nbsp;<span class="string" id="4912332">&#34;\r\n&#34;</span><span class="op" id="4912338">)</span><span class="op" id="4912339">;</span>&nbsp;<span class="ident" id="4912341">err</span>&nbsp;<span class="op" id="4912345">!=</span>&nbsp;<span class="ident" id="4912348">nil</span>&nbsp;<span class="op" id="4912352">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912356">return</span>&nbsp;<span class="ident" id="4912363">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912372">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912399">err</span>&nbsp;<span class="op" id="4912403">=</span>&nbsp;<span class="ident" id="4912405">tw</span><span class="op" id="4912407">.</span><span class="ident" id="4912408">WriteBody</span><span class="op" id="4912417">(</span><span class="ident" id="4912418">w</span><span class="op" id="4912419">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912422">if</span>&nbsp;<span class="ident" id="4912425">err</span>&nbsp;<span class="op" id="4912429">!=</span>&nbsp;<span class="ident" id="4912432">nil</span>&nbsp;<span class="op" id="4912436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912440">return</span>&nbsp;<span class="ident" id="4912447">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912456">//&nbsp;Success</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912468">return</span>&nbsp;<span class="ident" id="4912475">nil</span><br>
<span class="lineno"></span><span class="op" id="4912479">}</span>
</div>
</body>
</html>
