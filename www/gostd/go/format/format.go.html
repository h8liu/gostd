<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html" class="current">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5016349">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5016404">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5016458">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5016509">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="5016572">package</span>&nbsp;<span class="ident" id="5016580">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5016588">import</span>&nbsp;<span class="op" id="5016595">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016598">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016607">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016614">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016624">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016637">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016651">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016663">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5016669">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5016679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5016682">var</span>&nbsp;<span class="ident" id="5016686">config</span>&nbsp;<span class="op" id="5016693">=</span>&nbsp;<span class="ident" id="5016695">printer</span><span class="op" id="5016702">.</span><span class="ident" id="5016703">Config</span><span class="op" id="5016709">{</span><span class="ident" id="5016710">Mode</span><span class="op" id="5016714">:</span>&nbsp;<span class="ident" id="5016716">printer</span><span class="op" id="5016723">.</span><span class="ident" id="5016724">UseSpaces</span>&nbsp;<span class="op" id="5016734">|</span>&nbsp;<span class="ident" id="5016736">printer</span><span class="op" id="5016743">.</span><span class="ident" id="5016744">TabIndent</span><span class="op" id="5016753">,</span>&nbsp;<span class="ident" id="5016755">Tabwidth</span><span class="op" id="5016763">:</span>&nbsp;<span class="num" id="5016765">8</span><span class="op" id="5016766">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5016769">const</span>&nbsp;<span class="ident" id="5016775">parserMode</span>&nbsp;<span class="op" id="5016786">=</span>&nbsp;<span class="ident" id="5016788">parser</span><span class="op" id="5016794">.</span><span class="ident" id="5016795">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5016810">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="5016886">//</span><br>
<span class="lineno">25</span><span class="comment" id="5016889">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="5016961">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="5017034">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5017104">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5017176">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="5017245">//</span><br>
<span class="lineno"></span><span class="comment" id="5017248">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="5017319">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="5017391">//</span><br>
<span class="lineno"></span><span class="keyword" id="5017394">func</span>&nbsp;<span class="ident" id="5017399">Node</span><span class="op" id="5017403">(</span><span class="ident" id="5017404">dst</span>&nbsp;<span class="ident" id="5017408">io</span><span class="op" id="5017410">.</span><span class="ident" id="5017411">Writer</span><span class="op" id="5017417">,</span>&nbsp;<span class="ident" id="5017419">fset</span>&nbsp;<span class="op" id="5017424">*</span><span class="ident" id="5017425">token</span><span class="op" id="5017430">.</span><span class="ident" id="5017431">FileSet</span><span class="op" id="5017438">,</span>&nbsp;<span class="ident" id="5017440">node</span>&nbsp;<span class="keyword" id="5017445">interface</span><span class="op" id="5017454">{</span><span class="op" id="5017455">}</span><span class="op" id="5017456">)</span>&nbsp;<span class="builtintype" id="5017458">error</span>&nbsp;<span class="op" id="5017464">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5017467">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017530">var</span>&nbsp;<span class="ident" id="5017534">file</span>&nbsp;<span class="op" id="5017539">*</span><span class="ident" id="5017540">ast</span><span class="op" id="5017543">.</span><span class="ident" id="5017544">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017550">var</span>&nbsp;<span class="ident" id="5017554">cnode</span>&nbsp;<span class="op" id="5017560">*</span><span class="ident" id="5017561">printer</span><span class="op" id="5017568">.</span><span class="ident" id="5017569">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017584">switch</span>&nbsp;<span class="ident" id="5017591">n</span>&nbsp;<span class="op" id="5017593">:=</span>&nbsp;<span class="ident" id="5017596">node</span><span class="op" id="5017600">.</span><span class="op" id="5017601">(</span><span class="keyword" id="5017602">type</span><span class="op" id="5017606">)</span>&nbsp;<span class="op" id="5017608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017611">case</span>&nbsp;<span class="op" id="5017616">*</span><span class="ident" id="5017617">ast</span><span class="op" id="5017620">.</span><span class="ident" id="5017621">File</span><span class="op" id="5017625">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5017629">file</span>&nbsp;<span class="op" id="5017634">=</span>&nbsp;<span class="ident" id="5017636">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017639">case</span>&nbsp;<span class="op" id="5017644">*</span><span class="ident" id="5017645">printer</span><span class="op" id="5017652">.</span><span class="ident" id="5017653">CommentedNode</span><span class="op" id="5017666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017670">if</span>&nbsp;<span class="ident" id="5017673">f</span><span class="op" id="5017674">,</span>&nbsp;<span class="ident" id="5017676">ok</span>&nbsp;<span class="op" id="5017679">:=</span>&nbsp;<span class="ident" id="5017682">n</span><span class="op" id="5017683">.</span><span class="ident" id="5017684">Node</span><span class="op" id="5017688">.</span><span class="op" id="5017689">(</span><span class="op" id="5017690">*</span><span class="ident" id="5017691">ast</span><span class="op" id="5017694">.</span><span class="ident" id="5017695">File</span><span class="op" id="5017699">)</span><span class="op" id="5017700">;</span>&nbsp;<span class="ident" id="5017702">ok</span>&nbsp;<span class="op" id="5017705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5017710">file</span>&nbsp;<span class="op" id="5017715">=</span>&nbsp;<span class="ident" id="5017717">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5017722">cnode</span>&nbsp;<span class="op" id="5017728">=</span>&nbsp;<span class="ident" id="5017730">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5017734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5017737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5017741">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017772">if</span>&nbsp;<span class="ident" id="5017775">file</span>&nbsp;<span class="op" id="5017780">!=</span>&nbsp;<span class="builtintype" id="5017783">nil</span>&nbsp;<span class="op" id="5017787">&amp;&amp;</span>&nbsp;<span class="ident" id="5017790">hasUnsortedImports</span><span class="op" id="5017808">(</span><span class="ident" id="5017809">file</span><span class="op" id="5017813">)</span>&nbsp;<span class="op" id="5017815">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5017819">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5017887">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017928">var</span>&nbsp;<span class="ident" id="5017932">buf</span>&nbsp;<span class="ident" id="5017936">bytes</span><span class="op" id="5017941">.</span><span class="ident" id="5017942">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5017951">err</span>&nbsp;<span class="op" id="5017955">:=</span>&nbsp;<span class="ident" id="5017958">config</span><span class="op" id="5017964">.</span><span class="ident" id="5017965">Fprint</span><span class="op" id="5017971">(</span><span class="op" id="5017972">&amp;</span><span class="ident" id="5017973">buf</span><span class="op" id="5017976">,</span>&nbsp;<span class="ident" id="5017978">fset</span><span class="op" id="5017982">,</span>&nbsp;<span class="ident" id="5017984">file</span><span class="op" id="5017988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5017992">if</span>&nbsp;<span class="ident" id="5017995">err</span>&nbsp;<span class="op" id="5017999">!=</span>&nbsp;<span class="builtintype" id="5018002">nil</span>&nbsp;<span class="op" id="5018006">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5018011">return</span>&nbsp;<span class="ident" id="5018018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5018024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5018028">file</span><span class="op" id="5018032">,</span>&nbsp;<span class="ident" id="5018034">err</span>&nbsp;<span class="op" id="5018038">=</span>&nbsp;<span class="ident" id="5018040">parser</span><span class="op" id="5018046">.</span><span class="ident" id="5018047">ParseFile</span><span class="op" id="5018056">(</span><span class="ident" id="5018057">fset</span><span class="op" id="5018061">,</span>&nbsp;<span class="string" id="5018063">&#34;&#34;</span><span class="op" id="5018065">,</span>&nbsp;<span class="ident" id="5018067">buf</span><span class="op" id="5018070">.</span><span class="ident" id="5018071">Bytes</span><span class="op" id="5018076">(</span><span class="op" id="5018077">)</span><span class="op" id="5018078">,</span>&nbsp;<span class="ident" id="5018080">parserMode</span><span class="op" id="5018090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5018094">if</span>&nbsp;<span class="ident" id="5018097">err</span>&nbsp;<span class="op" id="5018101">!=</span>&nbsp;<span class="builtintype" id="5018104">nil</span>&nbsp;<span class="op" id="5018108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5018113">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5018180">return</span>&nbsp;<span class="ident" id="5018187">fmt</span><span class="op" id="5018190">.</span><span class="ident" id="5018191">Errorf</span><span class="op" id="5018197">(</span><span class="string" id="5018198">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="5018231">,</span>&nbsp;<span class="ident" id="5018233">err</span><span class="op" id="5018236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5018240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5018244">ast</span><span class="op" id="5018247">.</span><span class="ident" id="5018248">SortImports</span><span class="op" id="5018259">(</span><span class="ident" id="5018260">fset</span><span class="op" id="5018264">,</span>&nbsp;<span class="ident" id="5018266">file</span><span class="op" id="5018270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5018275">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5018314">node</span>&nbsp;<span class="op" id="5018319">=</span>&nbsp;<span class="ident" id="5018321">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5018328">if</span>&nbsp;<span class="ident" id="5018331">cnode</span>&nbsp;<span class="op" id="5018337">!=</span>&nbsp;<span class="builtintype" id="5018340">nil</span>&nbsp;<span class="op" id="5018344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5018349">node</span>&nbsp;<span class="op" id="5018354">=</span>&nbsp;<span class="op" id="5018356">&amp;</span><span class="ident" id="5018357">printer</span><span class="op" id="5018364">.</span><span class="ident" id="5018365">CommentedNode</span><span class="op" id="5018378">{</span><span class="ident" id="5018379">Node</span><span class="op" id="5018383">:</span>&nbsp;<span class="ident" id="5018385">file</span><span class="op" id="5018389">,</span>&nbsp;<span class="ident" id="5018391">Comments</span><span class="op" id="5018399">:</span>&nbsp;<span class="ident" id="5018401">cnode</span><span class="op" id="5018406">.</span><span class="ident" id="5018407">Comments</span><span class="op" id="5018415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5018419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5018422">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5018426">return</span>&nbsp;<span class="ident" id="5018433">config</span><span class="op" id="5018439">.</span><span class="ident" id="5018440">Fprint</span><span class="op" id="5018446">(</span><span class="ident" id="5018447">dst</span><span class="op" id="5018450">,</span>&nbsp;<span class="ident" id="5018452">fset</span><span class="op" id="5018456">,</span>&nbsp;<span class="ident" id="5018458">node</span><span class="op" id="5018462">)</span><br>
<span class="lineno"></span><span class="op" id="5018464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5018467">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="5018537">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="5018607">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="5018678">//</span><br>
<span class="lineno"></span><span class="comment" id="5018681">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5018755">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="5018831">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5018908">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5018989">//</span><br>
<span class="lineno"></span><span class="keyword" id="5018992">func</span>&nbsp;<span class="ident" id="5018997">Source</span><span class="op" id="5019003">(</span><span class="ident" id="5019004">src</span>&nbsp;<span class="op" id="5019008">[</span><span class="op" id="5019009">]</span><span class="builtintype" id="5019010">byte</span><span class="op" id="5019014">)</span>&nbsp;<span class="op" id="5019016">(</span><span class="op" id="5019017">[</span><span class="op" id="5019018">]</span><span class="builtintype" id="5019019">byte</span><span class="op" id="5019023">,</span>&nbsp;<span class="builtintype" id="5019025">error</span><span class="op" id="5019030">)</span>&nbsp;<span class="op" id="5019032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5019035">fset</span>&nbsp;<span class="op" id="5019040">:=</span>&nbsp;<span class="ident" id="5019043">token</span><span class="op" id="5019048">.</span><span class="ident" id="5019049">NewFileSet</span><span class="op" id="5019059">(</span><span class="op" id="5019060">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5019063">file</span><span class="op" id="5019067">,</span>&nbsp;<span class="ident" id="5019069">sourceAdj</span><span class="op" id="5019078">,</span>&nbsp;<span class="ident" id="5019080">indentAdj</span><span class="op" id="5019089">,</span>&nbsp;<span class="ident" id="5019091">err</span>&nbsp;<span class="op" id="5019095">:=</span>&nbsp;<span class="ident" id="5019098">parse</span><span class="op" id="5019103">(</span><span class="ident" id="5019104">fset</span><span class="op" id="5019108">,</span>&nbsp;<span class="string" id="5019110">&#34;&#34;</span><span class="op" id="5019112">,</span>&nbsp;<span class="ident" id="5019114">src</span><span class="op" id="5019117">,</span>&nbsp;<span class="builtintype" id="5019119">true</span><span class="op" id="5019123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019126">if</span>&nbsp;<span class="ident" id="5019129">err</span>&nbsp;<span class="op" id="5019133">!=</span>&nbsp;<span class="builtintype" id="5019136">nil</span>&nbsp;<span class="op" id="5019140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019144">return</span>&nbsp;<span class="builtintype" id="5019151">nil</span><span class="op" id="5019154">,</span>&nbsp;<span class="ident" id="5019156">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5019161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019165">if</span>&nbsp;<span class="ident" id="5019168">sourceAdj</span>&nbsp;<span class="op" id="5019178">==</span>&nbsp;<span class="builtintype" id="5019181">nil</span>&nbsp;<span class="op" id="5019185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019189">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019216">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5019259">ast</span><span class="op" id="5019262">.</span><span class="ident" id="5019263">SortImports</span><span class="op" id="5019274">(</span><span class="ident" id="5019275">fset</span><span class="op" id="5019279">,</span>&nbsp;<span class="ident" id="5019281">file</span><span class="op" id="5019285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5019288">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019292">return</span>&nbsp;<span class="ident" id="5019299">format</span><span class="op" id="5019305">(</span><span class="ident" id="5019306">fset</span><span class="op" id="5019310">,</span>&nbsp;<span class="ident" id="5019312">file</span><span class="op" id="5019316">,</span>&nbsp;<span class="ident" id="5019318">sourceAdj</span><span class="op" id="5019327">,</span>&nbsp;<span class="ident" id="5019329">indentAdj</span><span class="op" id="5019338">,</span>&nbsp;<span class="ident" id="5019340">src</span><span class="op" id="5019343">,</span>&nbsp;<span class="ident" id="5019345">config</span><span class="op" id="5019351">)</span><br>
<span class="lineno"></span><span class="op" id="5019353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5019356">func</span>&nbsp;<span class="ident" id="5019361">hasUnsortedImports</span><span class="op" id="5019379">(</span><span class="ident" id="5019380">file</span>&nbsp;<span class="op" id="5019385">*</span><span class="ident" id="5019386">ast</span><span class="op" id="5019389">.</span><span class="ident" id="5019390">File</span><span class="op" id="5019394">)</span>&nbsp;<span class="builtintype" id="5019396">bool</span>&nbsp;<span class="op" id="5019401">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019404">for</span>&nbsp;<span class="ident" id="5019408">_</span><span class="op" id="5019409">,</span>&nbsp;<span class="ident" id="5019411">d</span>&nbsp;<span class="op" id="5019413">:=</span>&nbsp;<span class="keyword" id="5019416">range</span>&nbsp;<span class="ident" id="5019422">file</span><span class="op" id="5019426">.</span><span class="ident" id="5019427">Decls</span>&nbsp;<span class="op" id="5019433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5019437">d</span><span class="op" id="5019438">,</span>&nbsp;<span class="ident" id="5019440">ok</span>&nbsp;<span class="op" id="5019443">:=</span>&nbsp;<span class="ident" id="5019446">d</span><span class="op" id="5019447">.</span><span class="op" id="5019448">(</span><span class="op" id="5019449">*</span><span class="ident" id="5019450">ast</span><span class="op" id="5019453">.</span><span class="ident" id="5019454">GenDecl</span><span class="op" id="5019461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019465">if</span>&nbsp;<span class="op" id="5019468">!</span><span class="ident" id="5019469">ok</span>&nbsp;<span class="op" id="5019472">||</span>&nbsp;<span class="ident" id="5019475">d</span><span class="op" id="5019476">.</span><span class="ident" id="5019477">Tok</span>&nbsp;<span class="op" id="5019481">!=</span>&nbsp;<span class="ident" id="5019484">token</span><span class="op" id="5019489">.</span><span class="ident" id="5019490">IMPORT</span>&nbsp;<span class="op" id="5019497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019502">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019550">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019582">return</span>&nbsp;<span class="builtintype" id="5019589">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5019597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019601">if</span>&nbsp;<span class="ident" id="5019604">d</span><span class="op" id="5019605">.</span><span class="ident" id="5019606">Lparen</span><span class="op" id="5019612">.</span><span class="ident" id="5019613">IsValid</span><span class="op" id="5019620">(</span><span class="op" id="5019621">)</span>&nbsp;<span class="op" id="5019623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019628">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019683">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019740">return</span>&nbsp;<span class="builtintype" id="5019747">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5019754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5019758">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5019803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5019806">return</span>&nbsp;<span class="builtintype" id="5019813">false</span><br>
<span class="lineno">115</span><span class="op" id="5019819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5019822">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="5019902">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="5019923">//</span><br>
<span class="lineno">120</span><span class="comment" id="5019926">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5019997">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="5020064">//</span><br>
<span class="lineno"></span><span class="comment" id="5020067">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5020124">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="5020181">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="5020237">func</span>&nbsp;<span class="ident" id="5020242">parse</span><span class="op" id="5020247">(</span><span class="ident" id="5020248">fset</span>&nbsp;<span class="op" id="5020253">*</span><span class="ident" id="5020254">token</span><span class="op" id="5020259">.</span><span class="ident" id="5020260">FileSet</span><span class="op" id="5020267">,</span>&nbsp;<span class="ident" id="5020269">filename</span>&nbsp;<span class="builtintype" id="5020278">string</span><span class="op" id="5020284">,</span>&nbsp;<span class="ident" id="5020286">src</span>&nbsp;<span class="op" id="5020290">[</span><span class="op" id="5020291">]</span><span class="builtintype" id="5020292">byte</span><span class="op" id="5020296">,</span>&nbsp;<span class="ident" id="5020298">fragmentOk</span>&nbsp;<span class="builtintype" id="5020309">bool</span><span class="op" id="5020313">)</span>&nbsp;<span class="op" id="5020315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5020318">file</span>&nbsp;<span class="op" id="5020323">*</span><span class="ident" id="5020324">ast</span><span class="op" id="5020327">.</span><span class="ident" id="5020328">File</span><span class="op" id="5020332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5020335">sourceAdj</span>&nbsp;<span class="keyword" id="5020345">func</span><span class="op" id="5020349">(</span><span class="ident" id="5020350">src</span>&nbsp;<span class="op" id="5020354">[</span><span class="op" id="5020355">]</span><span class="builtintype" id="5020356">byte</span><span class="op" id="5020360">,</span>&nbsp;<span class="ident" id="5020362">indent</span>&nbsp;<span class="builtintype" id="5020369">int</span><span class="op" id="5020372">)</span>&nbsp;<span class="op" id="5020374">[</span><span class="op" id="5020375">]</span><span class="builtintype" id="5020376">byte</span><span class="op" id="5020380">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5020383">indentAdj</span>&nbsp;<span class="builtintype" id="5020393">int</span><span class="op" id="5020396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5020399">err</span>&nbsp;<span class="builtintype" id="5020403">error</span><span class="op" id="5020408">,</span><br>
<span class="lineno"></span><span class="op" id="5020410">)</span>&nbsp;<span class="op" id="5020412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020415">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5020445">file</span><span class="op" id="5020449">,</span>&nbsp;<span class="ident" id="5020451">err</span>&nbsp;<span class="op" id="5020455">=</span>&nbsp;<span class="ident" id="5020457">parser</span><span class="op" id="5020463">.</span><span class="ident" id="5020464">ParseFile</span><span class="op" id="5020473">(</span><span class="ident" id="5020474">fset</span><span class="op" id="5020478">,</span>&nbsp;<span class="ident" id="5020480">filename</span><span class="op" id="5020488">,</span>&nbsp;<span class="ident" id="5020490">src</span><span class="op" id="5020493">,</span>&nbsp;<span class="ident" id="5020495">parserMode</span><span class="op" id="5020505">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020508">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020599">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020661">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5020728">if</span>&nbsp;<span class="ident" id="5020731">err</span>&nbsp;<span class="op" id="5020735">==</span>&nbsp;<span class="builtintype" id="5020738">nil</span>&nbsp;<span class="op" id="5020742">||</span>&nbsp;<span class="op" id="5020745">!</span><span class="ident" id="5020746">fragmentOk</span>&nbsp;<span class="op" id="5020757">||</span>&nbsp;<span class="op" id="5020760">!</span><span class="ident" id="5020761">strings</span><span class="op" id="5020768">.</span><span class="ident" id="5020769">Contains</span><span class="op" id="5020777">(</span><span class="ident" id="5020778">err</span><span class="op" id="5020781">.</span><span class="ident" id="5020782">Error</span><span class="op" id="5020787">(</span><span class="op" id="5020788">)</span><span class="op" id="5020789">,</span>&nbsp;<span class="string" id="5020791">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="5020811">)</span>&nbsp;<span class="op" id="5020813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5020817">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5020825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020829">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020886">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020921">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5020983">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021018">psrc</span>&nbsp;<span class="op" id="5021023">:=</span>&nbsp;<span class="builtinfunc" id="5021026">append</span><span class="op" id="5021032">(</span><span class="op" id="5021033">[</span><span class="op" id="5021034">]</span><span class="builtintype" id="5021035">byte</span><span class="op" id="5021039">(</span><span class="string" id="5021040">&#34;package&nbsp;p;&#34;</span><span class="op" id="5021052">)</span><span class="op" id="5021053">,</span>&nbsp;<span class="ident" id="5021055">src</span><span class="op" id="5021058">...</span><span class="op" id="5021061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021064">file</span><span class="op" id="5021068">,</span>&nbsp;<span class="ident" id="5021070">err</span>&nbsp;<span class="op" id="5021074">=</span>&nbsp;<span class="ident" id="5021076">parser</span><span class="op" id="5021082">.</span><span class="ident" id="5021083">ParseFile</span><span class="op" id="5021092">(</span><span class="ident" id="5021093">fset</span><span class="op" id="5021097">,</span>&nbsp;<span class="ident" id="5021099">filename</span><span class="op" id="5021107">,</span>&nbsp;<span class="ident" id="5021109">psrc</span><span class="op" id="5021113">,</span>&nbsp;<span class="ident" id="5021115">parserMode</span><span class="op" id="5021125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021128">if</span>&nbsp;<span class="ident" id="5021131">err</span>&nbsp;<span class="op" id="5021135">==</span>&nbsp;<span class="builtintype" id="5021138">nil</span>&nbsp;<span class="op" id="5021142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021146">sourceAdj</span>&nbsp;<span class="op" id="5021156">=</span>&nbsp;<span class="keyword" id="5021158">func</span><span class="op" id="5021162">(</span><span class="ident" id="5021163">src</span>&nbsp;<span class="op" id="5021167">[</span><span class="op" id="5021168">]</span><span class="builtintype" id="5021169">byte</span><span class="op" id="5021173">,</span>&nbsp;<span class="ident" id="5021175">indent</span>&nbsp;<span class="builtintype" id="5021182">int</span><span class="op" id="5021185">)</span>&nbsp;<span class="op" id="5021187">[</span><span class="op" id="5021188">]</span><span class="builtintype" id="5021189">byte</span>&nbsp;<span class="op" id="5021194">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021199">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021232">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021272">src</span>&nbsp;<span class="op" id="5021276">=</span>&nbsp;<span class="ident" id="5021278">src</span><span class="op" id="5021281">[</span><span class="ident" id="5021282">indent</span><span class="op" id="5021288">+</span><span class="builtinfunc" id="5021289">len</span><span class="op" id="5021292">(</span><span class="string" id="5021293">&#34;package&nbsp;p\n&#34;</span><span class="op" id="5021306">)</span><span class="op" id="5021307">:</span><span class="op" id="5021308">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021313">return</span>&nbsp;<span class="ident" id="5021320">bytes</span><span class="op" id="5021325">.</span><span class="ident" id="5021326">TrimSpace</span><span class="op" id="5021335">(</span><span class="ident" id="5021336">src</span><span class="op" id="5021339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5021343">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021347">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5021355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021358">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021419">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021477">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021517">if</span>&nbsp;<span class="op" id="5021520">!</span><span class="ident" id="5021521">strings</span><span class="op" id="5021528">.</span><span class="ident" id="5021529">Contains</span><span class="op" id="5021537">(</span><span class="ident" id="5021538">err</span><span class="op" id="5021541">.</span><span class="ident" id="5021542">Error</span><span class="op" id="5021547">(</span><span class="op" id="5021548">)</span><span class="op" id="5021549">,</span>&nbsp;<span class="string" id="5021551">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="5021573">)</span>&nbsp;<span class="op" id="5021575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021579">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5021587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021591">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021646">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021701">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021758">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5021820">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021855">fsrc</span>&nbsp;<span class="op" id="5021860">:=</span>&nbsp;<span class="builtinfunc" id="5021863">append</span><span class="op" id="5021869">(</span><span class="builtinfunc" id="5021870">append</span><span class="op" id="5021876">(</span><span class="op" id="5021877">[</span><span class="op" id="5021878">]</span><span class="builtintype" id="5021879">byte</span><span class="op" id="5021883">(</span><span class="string" id="5021884">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5021907">)</span><span class="op" id="5021908">,</span>&nbsp;<span class="ident" id="5021910">src</span><span class="op" id="5021913">...</span><span class="op" id="5021916">)</span><span class="op" id="5021917">,</span>&nbsp;<span class="string" id="5021919">&#39;\n&#39;</span><span class="op" id="5021923">,</span>&nbsp;<span class="string" id="5021925">&#39;}&#39;</span><span class="op" id="5021928">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5021931">file</span><span class="op" id="5021935">,</span>&nbsp;<span class="ident" id="5021937">err</span>&nbsp;<span class="op" id="5021941">=</span>&nbsp;<span class="ident" id="5021943">parser</span><span class="op" id="5021949">.</span><span class="ident" id="5021950">ParseFile</span><span class="op" id="5021959">(</span><span class="ident" id="5021960">fset</span><span class="op" id="5021964">,</span>&nbsp;<span class="ident" id="5021966">filename</span><span class="op" id="5021974">,</span>&nbsp;<span class="ident" id="5021976">fsrc</span><span class="op" id="5021980">,</span>&nbsp;<span class="ident" id="5021982">parserMode</span><span class="op" id="5021992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5021995">if</span>&nbsp;<span class="ident" id="5021998">err</span>&nbsp;<span class="op" id="5022002">==</span>&nbsp;<span class="builtintype" id="5022005">nil</span>&nbsp;<span class="op" id="5022009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022013">sourceAdj</span>&nbsp;<span class="op" id="5022023">=</span>&nbsp;<span class="keyword" id="5022025">func</span><span class="op" id="5022029">(</span><span class="ident" id="5022030">src</span>&nbsp;<span class="op" id="5022034">[</span><span class="op" id="5022035">]</span><span class="builtintype" id="5022036">byte</span><span class="op" id="5022040">,</span>&nbsp;<span class="ident" id="5022042">indent</span>&nbsp;<span class="builtintype" id="5022049">int</span><span class="op" id="5022052">)</span>&nbsp;<span class="op" id="5022054">[</span><span class="op" id="5022055">]</span><span class="builtintype" id="5022056">byte</span>&nbsp;<span class="op" id="5022061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022066">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5022101">if</span>&nbsp;<span class="ident" id="5022104">indent</span>&nbsp;<span class="op" id="5022111">&lt;</span>&nbsp;<span class="num" id="5022113">0</span>&nbsp;<span class="op" id="5022115">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022121">indent</span>&nbsp;<span class="op" id="5022128">=</span>&nbsp;<span class="num" id="5022130">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5022135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022140">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022167">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022209">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022278">src</span>&nbsp;<span class="op" id="5022282">=</span>&nbsp;<span class="ident" id="5022284">src</span><span class="op" id="5022287">[</span><span class="num" id="5022288">2</span><span class="op" id="5022289">*</span><span class="ident" id="5022290">indent</span><span class="op" id="5022296">+</span><span class="builtinfunc" id="5022297">len</span><span class="op" id="5022300">(</span><span class="string" id="5022301">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5022326">)</span><span class="op" id="5022327">:</span><span class="op" id="5022328">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022333">src</span>&nbsp;<span class="op" id="5022337">=</span>&nbsp;<span class="ident" id="5022339">src</span><span class="op" id="5022342">[</span><span class="op" id="5022343">:</span><span class="builtinfunc" id="5022344">len</span><span class="op" id="5022347">(</span><span class="ident" id="5022348">src</span><span class="op" id="5022351">)</span><span class="op" id="5022352">-</span><span class="op" id="5022353">(</span><span class="ident" id="5022354">indent</span><span class="op" id="5022360">+</span><span class="builtinfunc" id="5022361">len</span><span class="op" id="5022364">(</span><span class="string" id="5022365">&#34;\n}\n&#34;</span><span class="op" id="5022372">)</span><span class="op" id="5022373">)</span><span class="op" id="5022374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5022379">return</span>&nbsp;<span class="ident" id="5022386">bytes</span><span class="op" id="5022391">.</span><span class="ident" id="5022392">TrimSpace</span><span class="op" id="5022401">(</span><span class="ident" id="5022402">src</span><span class="op" id="5022405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5022409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022413">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022471">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022504">indentAdj</span>&nbsp;<span class="op" id="5022514">=</span>&nbsp;<span class="op" id="5022516">-</span><span class="num" id="5022517">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5022520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022524">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5022558">return</span><br>
<span class="lineno"></span><span class="op" id="5022565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5022568">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5022638">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="5022707">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="5022725">func</span>&nbsp;<span class="ident" id="5022730">format</span><span class="op" id="5022736">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022739">fset</span>&nbsp;<span class="op" id="5022744">*</span><span class="ident" id="5022745">token</span><span class="op" id="5022750">.</span><span class="ident" id="5022751">FileSet</span><span class="op" id="5022758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022761">file</span>&nbsp;<span class="op" id="5022766">*</span><span class="ident" id="5022767">ast</span><span class="op" id="5022770">.</span><span class="ident" id="5022771">File</span><span class="op" id="5022775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022778">sourceAdj</span>&nbsp;<span class="keyword" id="5022788">func</span><span class="op" id="5022792">(</span><span class="ident" id="5022793">src</span>&nbsp;<span class="op" id="5022797">[</span><span class="op" id="5022798">]</span><span class="builtintype" id="5022799">byte</span><span class="op" id="5022803">,</span>&nbsp;<span class="ident" id="5022805">indent</span>&nbsp;<span class="builtintype" id="5022812">int</span><span class="op" id="5022815">)</span>&nbsp;<span class="op" id="5022817">[</span><span class="op" id="5022818">]</span><span class="builtintype" id="5022819">byte</span><span class="op" id="5022823">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022826">indentAdj</span>&nbsp;<span class="builtintype" id="5022836">int</span><span class="op" id="5022839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022842">src</span>&nbsp;<span class="op" id="5022846">[</span><span class="op" id="5022847">]</span><span class="builtintype" id="5022848">byte</span><span class="op" id="5022852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022855">cfg</span>&nbsp;<span class="ident" id="5022859">printer</span><span class="op" id="5022866">.</span><span class="ident" id="5022867">Config</span><span class="op" id="5022873">,</span><br>
<span class="lineno"></span><span class="op" id="5022875">)</span>&nbsp;<span class="op" id="5022877">(</span><span class="op" id="5022878">[</span><span class="op" id="5022879">]</span><span class="builtintype" id="5022880">byte</span><span class="op" id="5022884">,</span>&nbsp;<span class="builtintype" id="5022886">error</span><span class="op" id="5022891">)</span>&nbsp;<span class="op" id="5022893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5022896">if</span>&nbsp;<span class="ident" id="5022899">sourceAdj</span>&nbsp;<span class="op" id="5022909">==</span>&nbsp;<span class="builtintype" id="5022912">nil</span>&nbsp;<span class="op" id="5022916">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5022920">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5022947">var</span>&nbsp;<span class="ident" id="5022951">buf</span>&nbsp;<span class="ident" id="5022955">bytes</span><span class="op" id="5022960">.</span><span class="ident" id="5022961">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5022970">err</span>&nbsp;<span class="op" id="5022974">:=</span>&nbsp;<span class="ident" id="5022977">cfg</span><span class="op" id="5022980">.</span><span class="ident" id="5022981">Fprint</span><span class="op" id="5022987">(</span><span class="op" id="5022988">&amp;</span><span class="ident" id="5022989">buf</span><span class="op" id="5022992">,</span>&nbsp;<span class="ident" id="5022994">fset</span><span class="op" id="5022998">,</span>&nbsp;<span class="ident" id="5023000">file</span><span class="op" id="5023004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023008">if</span>&nbsp;<span class="ident" id="5023011">err</span>&nbsp;<span class="op" id="5023015">!=</span>&nbsp;<span class="builtintype" id="5023018">nil</span>&nbsp;<span class="op" id="5023022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023027">return</span>&nbsp;<span class="builtintype" id="5023034">nil</span><span class="op" id="5023037">,</span>&nbsp;<span class="ident" id="5023039">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023049">return</span>&nbsp;<span class="ident" id="5023056">buf</span><span class="op" id="5023059">.</span><span class="ident" id="5023060">Bytes</span><span class="op" id="5023065">(</span><span class="op" id="5023066">)</span><span class="op" id="5023067">,</span>&nbsp;<span class="builtintype" id="5023069">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023078">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023103">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023144">i</span><span class="op" id="5023145">,</span>&nbsp;<span class="ident" id="5023147">j</span>&nbsp;<span class="op" id="5023149">:=</span>&nbsp;<span class="num" id="5023152">0</span><span class="op" id="5023153">,</span>&nbsp;<span class="num" id="5023155">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023158">for</span>&nbsp;<span class="ident" id="5023162">j</span>&nbsp;<span class="op" id="5023164">&lt;</span>&nbsp;<span class="builtinfunc" id="5023166">len</span><span class="op" id="5023169">(</span><span class="ident" id="5023170">src</span><span class="op" id="5023173">)</span>&nbsp;<span class="op" id="5023175">&amp;&amp;</span>&nbsp;<span class="ident" id="5023178">isSpace</span><span class="op" id="5023185">(</span><span class="ident" id="5023186">src</span><span class="op" id="5023189">[</span><span class="ident" id="5023190">j</span><span class="op" id="5023191">]</span><span class="op" id="5023192">)</span>&nbsp;<span class="op" id="5023194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023198">if</span>&nbsp;<span class="ident" id="5023201">src</span><span class="op" id="5023204">[</span><span class="ident" id="5023205">j</span><span class="op" id="5023206">]</span>&nbsp;<span class="op" id="5023208">==</span>&nbsp;<span class="string" id="5023211">&#39;\n&#39;</span>&nbsp;<span class="op" id="5023216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023221">i</span>&nbsp;<span class="op" id="5023223">=</span>&nbsp;<span class="ident" id="5023225">j</span>&nbsp;<span class="op" id="5023227">+</span>&nbsp;<span class="num" id="5023229">1</span>&nbsp;<span class="comment" id="5023231">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023282">j</span><span class="op" id="5023283">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023290">var</span>&nbsp;<span class="ident" id="5023294">res</span>&nbsp;<span class="op" id="5023298">[</span><span class="op" id="5023299">]</span><span class="builtintype" id="5023300">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023306">res</span>&nbsp;<span class="op" id="5023310">=</span>&nbsp;<span class="builtinfunc" id="5023312">append</span><span class="op" id="5023318">(</span><span class="ident" id="5023319">res</span><span class="op" id="5023322">,</span>&nbsp;<span class="ident" id="5023324">src</span><span class="op" id="5023327">[</span><span class="op" id="5023328">:</span><span class="ident" id="5023329">i</span><span class="op" id="5023330">]</span><span class="op" id="5023331">...</span><span class="op" id="5023334">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023338">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023396">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023445">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023488">indent</span>&nbsp;<span class="op" id="5023495">:=</span>&nbsp;<span class="num" id="5023498">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023501">hasSpace</span>&nbsp;<span class="op" id="5023510">:=</span>&nbsp;<span class="builtintype" id="5023513">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023520">for</span>&nbsp;<span class="ident" id="5023524">_</span><span class="op" id="5023525">,</span>&nbsp;<span class="ident" id="5023527">b</span>&nbsp;<span class="op" id="5023529">:=</span>&nbsp;<span class="keyword" id="5023532">range</span>&nbsp;<span class="ident" id="5023538">src</span><span class="op" id="5023541">[</span><span class="ident" id="5023542">i</span><span class="op" id="5023543">:</span><span class="ident" id="5023544">j</span><span class="op" id="5023545">]</span>&nbsp;<span class="op" id="5023547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023551">switch</span>&nbsp;<span class="ident" id="5023558">b</span>&nbsp;<span class="op" id="5023560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023564">case</span>&nbsp;<span class="string" id="5023569">&#39;&nbsp;&#39;</span><span class="op" id="5023572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023577">hasSpace</span>&nbsp;<span class="op" id="5023586">=</span>&nbsp;<span class="builtintype" id="5023588">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023595">case</span>&nbsp;<span class="string" id="5023600">&#39;\t&#39;</span><span class="op" id="5023604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023609">indent</span><span class="op" id="5023615">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023626">if</span>&nbsp;<span class="ident" id="5023629">indent</span>&nbsp;<span class="op" id="5023636">==</span>&nbsp;<span class="num" id="5023639">0</span>&nbsp;<span class="op" id="5023641">&amp;&amp;</span>&nbsp;<span class="ident" id="5023644">hasSpace</span>&nbsp;<span class="op" id="5023653">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023657">indent</span>&nbsp;<span class="op" id="5023664">=</span>&nbsp;<span class="num" id="5023666">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023672">for</span>&nbsp;<span class="ident" id="5023676">i</span>&nbsp;<span class="op" id="5023678">:=</span>&nbsp;<span class="num" id="5023681">0</span><span class="op" id="5023682">;</span>&nbsp;<span class="ident" id="5023684">i</span>&nbsp;<span class="op" id="5023686">&lt;</span>&nbsp;<span class="ident" id="5023688">indent</span><span class="op" id="5023694">;</span>&nbsp;<span class="ident" id="5023696">i</span><span class="op" id="5023697">++</span>&nbsp;<span class="op" id="5023700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023704">res</span>&nbsp;<span class="op" id="5023708">=</span>&nbsp;<span class="builtinfunc" id="5023710">append</span><span class="op" id="5023716">(</span><span class="ident" id="5023717">res</span><span class="op" id="5023720">,</span>&nbsp;<span class="string" id="5023722">&#39;\t&#39;</span><span class="op" id="5023726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023729">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023733">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023756">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023809">cfg</span><span class="op" id="5023812">.</span><span class="ident" id="5023813">Indent</span>&nbsp;<span class="op" id="5023820">=</span>&nbsp;<span class="ident" id="5023822">indent</span>&nbsp;<span class="op" id="5023829">+</span>&nbsp;<span class="ident" id="5023831">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023842">var</span>&nbsp;<span class="ident" id="5023846">buf</span>&nbsp;<span class="ident" id="5023850">bytes</span><span class="op" id="5023855">.</span><span class="ident" id="5023856">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023864">err</span>&nbsp;<span class="op" id="5023868">:=</span>&nbsp;<span class="ident" id="5023871">cfg</span><span class="op" id="5023874">.</span><span class="ident" id="5023875">Fprint</span><span class="op" id="5023881">(</span><span class="op" id="5023882">&amp;</span><span class="ident" id="5023883">buf</span><span class="op" id="5023886">,</span>&nbsp;<span class="ident" id="5023888">fset</span><span class="op" id="5023892">,</span>&nbsp;<span class="ident" id="5023894">file</span><span class="op" id="5023898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023901">if</span>&nbsp;<span class="ident" id="5023904">err</span>&nbsp;<span class="op" id="5023908">!=</span>&nbsp;<span class="builtintype" id="5023911">nil</span>&nbsp;<span class="op" id="5023915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5023919">return</span>&nbsp;<span class="builtintype" id="5023926">nil</span><span class="op" id="5023929">,</span>&nbsp;<span class="ident" id="5023931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5023936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5023939">res</span>&nbsp;<span class="op" id="5023943">=</span>&nbsp;<span class="builtinfunc" id="5023945">append</span><span class="op" id="5023951">(</span><span class="ident" id="5023952">res</span><span class="op" id="5023955">,</span>&nbsp;<span class="ident" id="5023957">sourceAdj</span><span class="op" id="5023966">(</span><span class="ident" id="5023967">buf</span><span class="op" id="5023970">.</span><span class="ident" id="5023971">Bytes</span><span class="op" id="5023976">(</span><span class="op" id="5023977">)</span><span class="op" id="5023978">,</span>&nbsp;<span class="ident" id="5023980">cfg</span><span class="op" id="5023983">.</span><span class="ident" id="5023984">Indent</span><span class="op" id="5023990">)</span><span class="op" id="5023991">...</span><span class="op" id="5023994">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5023998">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024039">i</span>&nbsp;<span class="op" id="5024041">=</span>&nbsp;<span class="builtinfunc" id="5024043">len</span><span class="op" id="5024046">(</span><span class="ident" id="5024047">src</span><span class="op" id="5024050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5024053">for</span>&nbsp;<span class="ident" id="5024057">i</span>&nbsp;<span class="op" id="5024059">&gt;</span>&nbsp;<span class="num" id="5024061">0</span>&nbsp;<span class="op" id="5024063">&amp;&amp;</span>&nbsp;<span class="ident" id="5024066">isSpace</span><span class="op" id="5024073">(</span><span class="ident" id="5024074">src</span><span class="op" id="5024077">[</span><span class="ident" id="5024078">i</span><span class="op" id="5024079">-</span><span class="num" id="5024080">1</span><span class="op" id="5024081">]</span><span class="op" id="5024082">)</span>&nbsp;<span class="op" id="5024084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024088">i</span><span class="op" id="5024089">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5024093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5024096">return</span>&nbsp;<span class="builtinfunc" id="5024103">append</span><span class="op" id="5024109">(</span><span class="ident" id="5024110">res</span><span class="op" id="5024113">,</span>&nbsp;<span class="ident" id="5024115">src</span><span class="op" id="5024118">[</span><span class="ident" id="5024119">i</span><span class="op" id="5024120">:</span><span class="op" id="5024121">]</span><span class="op" id="5024122">...</span><span class="op" id="5024125">)</span><span class="op" id="5024126">,</span>&nbsp;<span class="builtintype" id="5024128">nil</span><br>
<span class="lineno"></span><span class="op" id="5024132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5024135">func</span>&nbsp;<span class="ident" id="5024140">isSpace</span><span class="op" id="5024147">(</span><span class="ident" id="5024148">b</span>&nbsp;<span class="builtintype" id="5024150">byte</span><span class="op" id="5024154">)</span>&nbsp;<span class="builtintype" id="5024156">bool</span>&nbsp;<span class="op" id="5024161">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5024164">return</span>&nbsp;<span class="ident" id="5024171">b</span>&nbsp;<span class="op" id="5024173">==</span>&nbsp;<span class="string" id="5024176">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5024180">||</span>&nbsp;<span class="ident" id="5024183">b</span>&nbsp;<span class="op" id="5024185">==</span>&nbsp;<span class="string" id="5024188">&#39;\t&#39;</span>&nbsp;<span class="op" id="5024193">||</span>&nbsp;<span class="ident" id="5024196">b</span>&nbsp;<span class="op" id="5024198">==</span>&nbsp;<span class="string" id="5024201">&#39;\n&#39;</span>&nbsp;<span class="op" id="5024206">||</span>&nbsp;<span class="ident" id="5024209">b</span>&nbsp;<span class="op" id="5024211">==</span>&nbsp;<span class="string" id="5024214">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="5024219">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
