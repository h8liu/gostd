<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3782203">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3782258">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3782312">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3782363">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3782409">package</span>&nbsp;<span class="ident" id="3782417">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3782422">import</span>&nbsp;<span class="op" id="3782429">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782432">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782441">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782458">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782475">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782490">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782500">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782507">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782513">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782520">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3782528">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3782535">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3782538">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3782581">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3782622">type</span>&nbsp;<span class="ident" id="3782627">Conn</span>&nbsp;<span class="keyword" id="3782632">struct</span>&nbsp;<span class="op" id="3782639">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3782642">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782655">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782664">net</span><span class="op" id="3782667">.</span><span class="ident" id="3782668">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782674">isClient</span>&nbsp;<span class="builtintype" id="3782683">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3782690">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782748">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3782766">sync</span><span class="op" id="3782770">.</span><span class="ident" id="3782771">Mutex</span>&nbsp;<span class="comment" id="3782777">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782828">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3782846">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782857">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782892">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3782910">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782921">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782937">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3782955">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3782966">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3782998">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783016">*</span><span class="ident" id="3783017">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783027">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783067">handshakeComplete</span>&nbsp;<span class="builtintype" id="3783085">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783091">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3783109">bool</span>&nbsp;<span class="comment" id="3783114">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783167">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3783185">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783193">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783211">[</span><span class="op" id="3783212">]</span><span class="builtintype" id="3783213">byte</span>&nbsp;<span class="comment" id="3783218">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783244">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3783262">[</span><span class="op" id="3783263">]</span><span class="op" id="3783264">*</span><span class="ident" id="3783265">x509</span><span class="op" id="3783269">.</span><span class="ident" id="3783270">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783283">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783352">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783401">verifiedChains</span>&nbsp;<span class="op" id="3783416">[</span><span class="op" id="3783417">]</span><span class="op" id="3783418">[</span><span class="op" id="3783419">]</span><span class="op" id="3783420">*</span><span class="ident" id="3783421">x509</span><span class="op" id="3783425">.</span><span class="ident" id="3783426">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783439">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783512">serverName</span>&nbsp;<span class="builtintype" id="3783523">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783531">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783598">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783661">firstFinished</span>&nbsp;<span class="op" id="3783675">[</span><span class="num" id="3783676">12</span><span class="op" id="3783678">]</span><span class="builtintype" id="3783679">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783686">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3783709">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783717">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3783740">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3783747">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783764">in</span><span class="op" id="3783766">,</span>&nbsp;<span class="ident" id="3783768">out</span>&nbsp;&nbsp;<span class="ident" id="3783773">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783786">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783811">rawInput</span>&nbsp;<span class="op" id="3783820">*</span><span class="ident" id="3783821">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783833">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783867">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3783876">*</span><span class="ident" id="3783877">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3783889">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783929">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3783938">bytes</span><span class="op" id="3783943">.</span><span class="ident" id="3783944">Buffer</span>&nbsp;<span class="comment" id="3783951">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3783990">tmp</span>&nbsp;<span class="op" id="3783994">[</span><span class="num" id="3783995">16</span><span class="op" id="3783997">]</span><span class="builtintype" id="3783998">byte</span><br>
<span class="lineno"></span><span class="op" id="3784003">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3784006">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3784037">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3784086">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3784119">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3784167">func</span>&nbsp;<span class="op" id="3784172">(</span><span class="ident" id="3784173">c</span>&nbsp;<span class="op" id="3784175">*</span><span class="ident" id="3784176">Conn</span><span class="op" id="3784180">)</span>&nbsp;<span class="ident" id="3784182">LocalAddr</span><span class="op" id="3784191">(</span><span class="op" id="3784192">)</span>&nbsp;<span class="ident" id="3784194">net</span><span class="op" id="3784197">.</span><span class="ident" id="3784198">Addr</span>&nbsp;<span class="op" id="3784203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3784206">return</span>&nbsp;<span class="ident" id="3784213">c</span><span class="op" id="3784214">.</span><span class="ident" id="3784215">conn</span><span class="op" id="3784219">.</span><span class="ident" id="3784220">LocalAddr</span><span class="op" id="3784229">(</span><span class="op" id="3784230">)</span><br>
<span class="lineno"></span><span class="op" id="3784232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3784235">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3784285">func</span>&nbsp;<span class="op" id="3784290">(</span><span class="ident" id="3784291">c</span>&nbsp;<span class="op" id="3784293">*</span><span class="ident" id="3784294">Conn</span><span class="op" id="3784298">)</span>&nbsp;<span class="ident" id="3784300">RemoteAddr</span><span class="op" id="3784310">(</span><span class="op" id="3784311">)</span>&nbsp;<span class="ident" id="3784313">net</span><span class="op" id="3784316">.</span><span class="ident" id="3784317">Addr</span>&nbsp;<span class="op" id="3784322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3784325">return</span>&nbsp;<span class="ident" id="3784332">c</span><span class="op" id="3784333">.</span><span class="ident" id="3784334">conn</span><span class="op" id="3784338">.</span><span class="ident" id="3784339">RemoteAddr</span><span class="op" id="3784349">(</span><span class="op" id="3784350">)</span><br>
<span class="lineno"></span><span class="op" id="3784352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3784355">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3784436">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3784498">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3784605">func</span>&nbsp;<span class="op" id="3784610">(</span><span class="ident" id="3784611">c</span>&nbsp;<span class="op" id="3784613">*</span><span class="ident" id="3784614">Conn</span><span class="op" id="3784618">)</span>&nbsp;<span class="ident" id="3784620">SetDeadline</span><span class="op" id="3784631">(</span><span class="ident" id="3784632">t</span>&nbsp;<span class="ident" id="3784634">time</span><span class="op" id="3784638">.</span><span class="ident" id="3784639">Time</span><span class="op" id="3784643">)</span>&nbsp;<span class="builtintype" id="3784645">error</span>&nbsp;<span class="op" id="3784651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3784654">return</span>&nbsp;<span class="ident" id="3784661">c</span><span class="op" id="3784662">.</span><span class="ident" id="3784663">conn</span><span class="op" id="3784667">.</span><span class="ident" id="3784668">SetDeadline</span><span class="op" id="3784679">(</span><span class="ident" id="3784680">t</span><span class="op" id="3784681">)</span><br>
<span class="lineno">80</span><span class="op" id="3784683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3784686">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3784758">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3784810">func</span>&nbsp;<span class="op" id="3784815">(</span><span class="ident" id="3784816">c</span>&nbsp;<span class="op" id="3784818">*</span><span class="ident" id="3784819">Conn</span><span class="op" id="3784823">)</span>&nbsp;<span class="ident" id="3784825">SetReadDeadline</span><span class="op" id="3784840">(</span><span class="ident" id="3784841">t</span>&nbsp;<span class="ident" id="3784843">time</span><span class="op" id="3784847">.</span><span class="ident" id="3784848">Time</span><span class="op" id="3784852">)</span>&nbsp;<span class="builtintype" id="3784854">error</span>&nbsp;<span class="op" id="3784860">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3784863">return</span>&nbsp;<span class="ident" id="3784870">c</span><span class="op" id="3784871">.</span><span class="ident" id="3784872">conn</span><span class="op" id="3784876">.</span><span class="ident" id="3784877">SetReadDeadline</span><span class="op" id="3784892">(</span><span class="ident" id="3784893">t</span><span class="op" id="3784894">)</span><br>
<span class="lineno"></span><span class="op" id="3784896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3784899">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3784973">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3785026">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3785133">func</span>&nbsp;<span class="op" id="3785138">(</span><span class="ident" id="3785139">c</span>&nbsp;<span class="op" id="3785141">*</span><span class="ident" id="3785142">Conn</span><span class="op" id="3785146">)</span>&nbsp;<span class="ident" id="3785148">SetWriteDeadline</span><span class="op" id="3785164">(</span><span class="ident" id="3785165">t</span>&nbsp;<span class="ident" id="3785167">time</span><span class="op" id="3785171">.</span><span class="ident" id="3785172">Time</span><span class="op" id="3785176">)</span>&nbsp;<span class="builtintype" id="3785178">error</span>&nbsp;<span class="op" id="3785184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3785187">return</span>&nbsp;<span class="ident" id="3785194">c</span><span class="op" id="3785195">.</span><span class="ident" id="3785196">conn</span><span class="op" id="3785200">.</span><span class="ident" id="3785201">SetWriteDeadline</span><span class="op" id="3785217">(</span><span class="ident" id="3785218">t</span><span class="op" id="3785219">)</span><br>
<span class="lineno"></span><span class="op" id="3785221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3785224">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3785283">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3785327">type</span>&nbsp;<span class="ident" id="3785332">halfConn</span>&nbsp;<span class="keyword" id="3785341">struct</span>&nbsp;<span class="op" id="3785348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785351">sync</span><span class="op" id="3785355">.</span><span class="ident" id="3785356">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785364">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3785372">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3785384">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785410">version</span>&nbsp;<span class="builtintype" id="3785418">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3785430">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785451">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3785459">interface</span><span class="op" id="3785468">{</span><span class="op" id="3785469">}</span>&nbsp;<span class="comment" id="3785471">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785492">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785500">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785513">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3785521">[</span><span class="num" id="3785522">8</span><span class="op" id="3785523">]</span><span class="builtintype" id="3785524">byte</span>&nbsp;<span class="comment" id="3785529">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785556">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3785564">*</span><span class="ident" id="3785565">block</span>&nbsp;&nbsp;<span class="comment" id="3785572">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785597">nextCipher</span>&nbsp;<span class="keyword" id="3785608">interface</span><span class="op" id="3785617">{</span><span class="op" id="3785618">}</span>&nbsp;<span class="comment" id="3785620">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785646">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3785657">macFunction</span>&nbsp;<span class="comment" id="3785669">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3785693">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785748">inDigestBuf</span><span class="op" id="3785759">,</span>&nbsp;<span class="ident" id="3785761">outDigestBuf</span>&nbsp;<span class="op" id="3785774">[</span><span class="op" id="3785775">]</span><span class="builtintype" id="3785776">byte</span><br>
<span class="lineno"></span><span class="op" id="3785781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3785784">func</span>&nbsp;<span class="op" id="3785789">(</span><span class="ident" id="3785790">hc</span>&nbsp;<span class="op" id="3785793">*</span><span class="ident" id="3785794">halfConn</span><span class="op" id="3785802">)</span>&nbsp;<span class="ident" id="3785804">setErrorLocked</span><span class="op" id="3785818">(</span><span class="ident" id="3785819">err</span>&nbsp;<span class="builtintype" id="3785823">error</span><span class="op" id="3785828">)</span>&nbsp;<span class="builtintype" id="3785830">error</span>&nbsp;<span class="op" id="3785836">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785839">hc</span><span class="op" id="3785841">.</span><span class="ident" id="3785842">err</span>&nbsp;<span class="op" id="3785846">=</span>&nbsp;<span class="ident" id="3785848">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3785853">return</span>&nbsp;<span class="ident" id="3785860">err</span><br>
<span class="lineno"></span><span class="op" id="3785864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3785867">func</span>&nbsp;<span class="op" id="3785872">(</span><span class="ident" id="3785873">hc</span>&nbsp;<span class="op" id="3785876">*</span><span class="ident" id="3785877">halfConn</span><span class="op" id="3785885">)</span>&nbsp;<span class="builtintype" id="3785887">error</span><span class="op" id="3785892">(</span><span class="op" id="3785893">)</span>&nbsp;<span class="builtintype" id="3785895">error</span>&nbsp;<span class="op" id="3785901">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785904">hc</span><span class="op" id="3785906">.</span><span class="ident" id="3785907">Lock</span><span class="op" id="3785911">(</span><span class="op" id="3785912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785915">err</span>&nbsp;<span class="op" id="3785919">:=</span>&nbsp;<span class="ident" id="3785922">hc</span><span class="op" id="3785924">.</span><span class="ident" id="3785925">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3785930">hc</span><span class="op" id="3785932">.</span><span class="ident" id="3785933">Unlock</span><span class="op" id="3785939">(</span><span class="op" id="3785940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3785943">return</span>&nbsp;<span class="ident" id="3785950">err</span><br>
<span class="lineno"></span><span class="op" id="3785954">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3785957">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3786013">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3786061">func</span>&nbsp;<span class="op" id="3786066">(</span><span class="ident" id="3786067">hc</span>&nbsp;<span class="op" id="3786070">*</span><span class="ident" id="3786071">halfConn</span><span class="op" id="3786079">)</span>&nbsp;<span class="ident" id="3786081">prepareCipherSpec</span><span class="op" id="3786098">(</span><span class="ident" id="3786099">version</span>&nbsp;<span class="builtintype" id="3786107">uint16</span><span class="op" id="3786113">,</span>&nbsp;<span class="ident" id="3786115">cipher</span>&nbsp;<span class="keyword" id="3786122">interface</span><span class="op" id="3786131">{</span><span class="op" id="3786132">}</span><span class="op" id="3786133">,</span>&nbsp;<span class="ident" id="3786135">mac</span>&nbsp;<span class="ident" id="3786139">macFunction</span><span class="op" id="3786150">)</span>&nbsp;<span class="op" id="3786152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786155">hc</span><span class="op" id="3786157">.</span><span class="ident" id="3786158">version</span>&nbsp;<span class="op" id="3786166">=</span>&nbsp;<span class="ident" id="3786168">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786177">hc</span><span class="op" id="3786179">.</span><span class="ident" id="3786180">nextCipher</span>&nbsp;<span class="op" id="3786191">=</span>&nbsp;<span class="ident" id="3786193">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786201">hc</span><span class="op" id="3786203">.</span><span class="ident" id="3786204">nextMac</span>&nbsp;<span class="op" id="3786212">=</span>&nbsp;<span class="ident" id="3786214">mac</span><br>
<span class="lineno"></span><span class="op" id="3786218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3786221">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3786279">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3786334">func</span>&nbsp;<span class="op" id="3786339">(</span><span class="ident" id="3786340">hc</span>&nbsp;<span class="op" id="3786343">*</span><span class="ident" id="3786344">halfConn</span><span class="op" id="3786352">)</span>&nbsp;<span class="ident" id="3786354">changeCipherSpec</span><span class="op" id="3786370">(</span><span class="op" id="3786371">)</span>&nbsp;<span class="builtintype" id="3786373">error</span>&nbsp;<span class="op" id="3786379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786382">if</span>&nbsp;<span class="ident" id="3786385">hc</span><span class="op" id="3786387">.</span><span class="ident" id="3786388">nextCipher</span>&nbsp;<span class="op" id="3786399">==</span>&nbsp;<span class="ident" id="3786402">nil</span>&nbsp;<span class="op" id="3786406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786410">return</span>&nbsp;<span class="ident" id="3786417">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3786437">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786440">hc</span><span class="op" id="3786442">.</span><span class="ident" id="3786443">cipher</span>&nbsp;<span class="op" id="3786450">=</span>&nbsp;<span class="ident" id="3786452">hc</span><span class="op" id="3786454">.</span><span class="ident" id="3786455">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786467">hc</span><span class="op" id="3786469">.</span><span class="ident" id="3786470">mac</span>&nbsp;<span class="op" id="3786474">=</span>&nbsp;<span class="ident" id="3786476">hc</span><span class="op" id="3786478">.</span><span class="ident" id="3786479">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786488">hc</span><span class="op" id="3786490">.</span><span class="ident" id="3786491">nextCipher</span>&nbsp;<span class="op" id="3786502">=</span>&nbsp;<span class="ident" id="3786504">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786509">hc</span><span class="op" id="3786511">.</span><span class="ident" id="3786512">nextMac</span>&nbsp;<span class="op" id="3786520">=</span>&nbsp;<span class="ident" id="3786522">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786527">for</span>&nbsp;<span class="ident" id="3786531">i</span>&nbsp;<span class="op" id="3786533">:=</span>&nbsp;<span class="keyword" id="3786536">range</span>&nbsp;<span class="ident" id="3786542">hc</span><span class="op" id="3786544">.</span><span class="ident" id="3786545">seq</span>&nbsp;<span class="op" id="3786549">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786553">hc</span><span class="op" id="3786555">.</span><span class="ident" id="3786556">seq</span><span class="op" id="3786559">[</span><span class="ident" id="3786560">i</span><span class="op" id="3786561">]</span>&nbsp;<span class="op" id="3786563">=</span>&nbsp;<span class="num" id="3786565">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3786568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786571">return</span>&nbsp;<span class="ident" id="3786578">nil</span><br>
<span class="lineno"></span><span class="op" id="3786582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3786585">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3786627">func</span>&nbsp;<span class="op" id="3786632">(</span><span class="ident" id="3786633">hc</span>&nbsp;<span class="op" id="3786636">*</span><span class="ident" id="3786637">halfConn</span><span class="op" id="3786645">)</span>&nbsp;<span class="ident" id="3786647">incSeq</span><span class="op" id="3786653">(</span><span class="op" id="3786654">)</span>&nbsp;<span class="op" id="3786656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786659">for</span>&nbsp;<span class="ident" id="3786663">i</span>&nbsp;<span class="op" id="3786665">:=</span>&nbsp;<span class="num" id="3786668">7</span><span class="op" id="3786669">;</span>&nbsp;<span class="ident" id="3786671">i</span>&nbsp;<span class="op" id="3786673">&gt;=</span>&nbsp;<span class="num" id="3786676">0</span><span class="op" id="3786677">;</span>&nbsp;<span class="ident" id="3786679">i</span><span class="op" id="3786680">--</span>&nbsp;<span class="op" id="3786683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3786687">hc</span><span class="op" id="3786689">.</span><span class="ident" id="3786690">seq</span><span class="op" id="3786693">[</span><span class="ident" id="3786694">i</span><span class="op" id="3786695">]</span><span class="op" id="3786696">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786701">if</span>&nbsp;<span class="ident" id="3786704">hc</span><span class="op" id="3786706">.</span><span class="ident" id="3786707">seq</span><span class="op" id="3786710">[</span><span class="ident" id="3786711">i</span><span class="op" id="3786712">]</span>&nbsp;<span class="op" id="3786714">!=</span>&nbsp;<span class="num" id="3786717">0</span>&nbsp;<span class="op" id="3786719">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3786733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3786736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786740">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786785">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3786831">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3786864">panic</span><span class="op" id="3786869">(</span><span class="string" id="3786870">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3786903">)</span><br>
<span class="lineno"></span><span class="op" id="3786905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3786908">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3786956">func</span>&nbsp;<span class="op" id="3786961">(</span><span class="ident" id="3786962">hc</span>&nbsp;<span class="op" id="3786965">*</span><span class="ident" id="3786966">halfConn</span><span class="op" id="3786974">)</span>&nbsp;<span class="ident" id="3786976">resetSeq</span><span class="op" id="3786984">(</span><span class="op" id="3786985">)</span>&nbsp;<span class="op" id="3786987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3786990">for</span>&nbsp;<span class="ident" id="3786994">i</span>&nbsp;<span class="op" id="3786996">:=</span>&nbsp;<span class="keyword" id="3786999">range</span>&nbsp;<span class="ident" id="3787005">hc</span><span class="op" id="3787007">.</span><span class="ident" id="3787008">seq</span>&nbsp;<span class="op" id="3787012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787016">hc</span><span class="op" id="3787018">.</span><span class="ident" id="3787019">seq</span><span class="op" id="3787022">[</span><span class="ident" id="3787023">i</span><span class="op" id="3787024">]</span>&nbsp;<span class="op" id="3787026">=</span>&nbsp;<span class="num" id="3787028">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3787031">}</span><br>
<span class="lineno">170</span><span class="op" id="3787033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3787036">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3787116">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3787193">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3787253">func</span>&nbsp;<span class="ident" id="3787258">removePadding</span><span class="op" id="3787271">(</span><span class="ident" id="3787272">payload</span>&nbsp;<span class="op" id="3787280">[</span><span class="op" id="3787281">]</span><span class="builtintype" id="3787282">byte</span><span class="op" id="3787286">)</span>&nbsp;<span class="op" id="3787288">(</span><span class="op" id="3787289">[</span><span class="op" id="3787290">]</span><span class="builtintype" id="3787291">byte</span><span class="op" id="3787295">,</span>&nbsp;<span class="builtintype" id="3787297">byte</span><span class="op" id="3787301">)</span>&nbsp;<span class="op" id="3787303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787306">if</span>&nbsp;<span class="builtinfunc" id="3787309">len</span><span class="op" id="3787312">(</span><span class="ident" id="3787313">payload</span><span class="op" id="3787320">)</span>&nbsp;<span class="op" id="3787322">&lt;</span>&nbsp;<span class="num" id="3787324">1</span>&nbsp;<span class="op" id="3787326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787330">return</span>&nbsp;<span class="ident" id="3787337">payload</span><span class="op" id="3787344">,</span>&nbsp;<span class="num" id="3787346">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3787349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787353">paddingLen</span>&nbsp;<span class="op" id="3787364">:=</span>&nbsp;<span class="ident" id="3787367">payload</span><span class="op" id="3787374">[</span><span class="builtinfunc" id="3787375">len</span><span class="op" id="3787378">(</span><span class="ident" id="3787379">payload</span><span class="op" id="3787386">)</span><span class="op" id="3787387">-</span><span class="num" id="3787388">1</span><span class="op" id="3787389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787392">t</span>&nbsp;<span class="op" id="3787394">:=</span>&nbsp;<span class="builtintype" id="3787397">uint</span><span class="op" id="3787401">(</span><span class="builtinfunc" id="3787402">len</span><span class="op" id="3787405">(</span><span class="ident" id="3787406">payload</span><span class="op" id="3787413">)</span><span class="op" id="3787414">-</span><span class="num" id="3787415">1</span><span class="op" id="3787416">)</span>&nbsp;<span class="op" id="3787418">-</span>&nbsp;<span class="builtintype" id="3787420">uint</span><span class="op" id="3787424">(</span><span class="ident" id="3787425">paddingLen</span><span class="op" id="3787435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3787438">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787504">good</span>&nbsp;<span class="op" id="3787509">:=</span>&nbsp;<span class="builtintype" id="3787512">byte</span><span class="op" id="3787516">(</span><span class="builtintype" id="3787517">int32</span><span class="op" id="3787522">(</span><span class="op" id="3787523">^</span><span class="ident" id="3787524">t</span><span class="op" id="3787525">)</span>&nbsp;<span class="op" id="3787527">&gt;&gt;</span>&nbsp;<span class="num" id="3787530">31</span><span class="op" id="3787532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787536">toCheck</span>&nbsp;<span class="op" id="3787544">:=</span>&nbsp;<span class="num" id="3787547">255</span>&nbsp;<span class="comment" id="3787551">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3787591">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787661">if</span>&nbsp;<span class="ident" id="3787664">toCheck</span><span class="op" id="3787671">+</span><span class="num" id="3787672">1</span>&nbsp;<span class="op" id="3787674">&gt;</span>&nbsp;<span class="builtinfunc" id="3787676">len</span><span class="op" id="3787679">(</span><span class="ident" id="3787680">payload</span><span class="op" id="3787687">)</span>&nbsp;<span class="op" id="3787689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787693">toCheck</span>&nbsp;<span class="op" id="3787701">=</span>&nbsp;<span class="builtinfunc" id="3787703">len</span><span class="op" id="3787706">(</span><span class="ident" id="3787707">payload</span><span class="op" id="3787714">)</span>&nbsp;<span class="op" id="3787716">-</span>&nbsp;<span class="num" id="3787718">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3787721">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3787725">for</span>&nbsp;<span class="ident" id="3787729">i</span>&nbsp;<span class="op" id="3787731">:=</span>&nbsp;<span class="num" id="3787734">0</span><span class="op" id="3787735">;</span>&nbsp;<span class="ident" id="3787737">i</span>&nbsp;<span class="op" id="3787739">&lt;</span>&nbsp;<span class="ident" id="3787741">toCheck</span><span class="op" id="3787748">;</span>&nbsp;<span class="ident" id="3787750">i</span><span class="op" id="3787751">++</span>&nbsp;<span class="op" id="3787754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787758">t</span>&nbsp;<span class="op" id="3787760">:=</span>&nbsp;<span class="builtintype" id="3787763">uint</span><span class="op" id="3787767">(</span><span class="ident" id="3787768">paddingLen</span><span class="op" id="3787778">)</span>&nbsp;<span class="op" id="3787780">-</span>&nbsp;<span class="builtintype" id="3787782">uint</span><span class="op" id="3787786">(</span><span class="ident" id="3787787">i</span><span class="op" id="3787788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3787792">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787842">mask</span>&nbsp;<span class="op" id="3787847">:=</span>&nbsp;<span class="builtintype" id="3787850">byte</span><span class="op" id="3787854">(</span><span class="builtintype" id="3787855">int32</span><span class="op" id="3787860">(</span><span class="op" id="3787861">^</span><span class="ident" id="3787862">t</span><span class="op" id="3787863">)</span>&nbsp;<span class="op" id="3787865">&gt;&gt;</span>&nbsp;<span class="num" id="3787868">31</span><span class="op" id="3787870">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787874">b</span>&nbsp;<span class="op" id="3787876">:=</span>&nbsp;<span class="ident" id="3787879">payload</span><span class="op" id="3787886">[</span><span class="builtinfunc" id="3787887">len</span><span class="op" id="3787890">(</span><span class="ident" id="3787891">payload</span><span class="op" id="3787898">)</span><span class="op" id="3787899">-</span><span class="num" id="3787900">1</span><span class="op" id="3787901">-</span><span class="ident" id="3787902">i</span><span class="op" id="3787903">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3787907">good</span>&nbsp;<span class="op" id="3787912">&amp;^=</span>&nbsp;<span class="ident" id="3787916">mask</span><span class="op" id="3787920">&amp;</span><span class="ident" id="3787921">paddingLen</span>&nbsp;<span class="op" id="3787932">^</span>&nbsp;<span class="ident" id="3787934">mask</span><span class="op" id="3787938">&amp;</span><span class="ident" id="3787939">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3787942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3787946">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3788015">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788033">good</span>&nbsp;<span class="op" id="3788038">&amp;=</span>&nbsp;<span class="ident" id="3788041">good</span>&nbsp;<span class="op" id="3788046">&lt;&lt;</span>&nbsp;<span class="num" id="3788049">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788052">good</span>&nbsp;<span class="op" id="3788057">&amp;=</span>&nbsp;<span class="ident" id="3788060">good</span>&nbsp;<span class="op" id="3788065">&lt;&lt;</span>&nbsp;<span class="num" id="3788068">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788071">good</span>&nbsp;<span class="op" id="3788076">&amp;=</span>&nbsp;<span class="ident" id="3788079">good</span>&nbsp;<span class="op" id="3788084">&lt;&lt;</span>&nbsp;<span class="num" id="3788087">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788090">good</span>&nbsp;<span class="op" id="3788095">=</span>&nbsp;<span class="builtintype" id="3788097">uint8</span><span class="op" id="3788102">(</span><span class="builtintype" id="3788103">int8</span><span class="op" id="3788107">(</span><span class="ident" id="3788108">good</span><span class="op" id="3788112">)</span>&nbsp;<span class="op" id="3788114">&gt;&gt;</span>&nbsp;<span class="num" id="3788117">7</span><span class="op" id="3788118">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788122">toRemove</span>&nbsp;<span class="op" id="3788131">:=</span>&nbsp;<span class="ident" id="3788134">good</span><span class="op" id="3788138">&amp;</span><span class="ident" id="3788139">paddingLen</span>&nbsp;<span class="op" id="3788150">+</span>&nbsp;<span class="num" id="3788152">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788155">return</span>&nbsp;<span class="ident" id="3788162">payload</span><span class="op" id="3788169">[</span><span class="op" id="3788170">:</span><span class="builtinfunc" id="3788171">len</span><span class="op" id="3788174">(</span><span class="ident" id="3788175">payload</span><span class="op" id="3788182">)</span><span class="op" id="3788183">-</span><span class="builtintype" id="3788184">int</span><span class="op" id="3788187">(</span><span class="ident" id="3788188">toRemove</span><span class="op" id="3788196">)</span><span class="op" id="3788197">]</span><span class="op" id="3788198">,</span>&nbsp;<span class="ident" id="3788200">good</span><br>
<span class="lineno"></span><span class="op" id="3788205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3788208">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3788286">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3788361">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3788398">func</span>&nbsp;<span class="ident" id="3788403">removePaddingSSL30</span><span class="op" id="3788421">(</span><span class="ident" id="3788422">payload</span>&nbsp;<span class="op" id="3788430">[</span><span class="op" id="3788431">]</span><span class="builtintype" id="3788432">byte</span><span class="op" id="3788436">)</span>&nbsp;<span class="op" id="3788438">(</span><span class="op" id="3788439">[</span><span class="op" id="3788440">]</span><span class="builtintype" id="3788441">byte</span><span class="op" id="3788445">,</span>&nbsp;<span class="builtintype" id="3788447">byte</span><span class="op" id="3788451">)</span>&nbsp;<span class="op" id="3788453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788456">if</span>&nbsp;<span class="builtinfunc" id="3788459">len</span><span class="op" id="3788462">(</span><span class="ident" id="3788463">payload</span><span class="op" id="3788470">)</span>&nbsp;<span class="op" id="3788472">&lt;</span>&nbsp;<span class="num" id="3788474">1</span>&nbsp;<span class="op" id="3788476">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788480">return</span>&nbsp;<span class="ident" id="3788487">payload</span><span class="op" id="3788494">,</span>&nbsp;<span class="num" id="3788496">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3788499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788503">paddingLen</span>&nbsp;<span class="op" id="3788514">:=</span>&nbsp;<span class="builtintype" id="3788517">int</span><span class="op" id="3788520">(</span><span class="ident" id="3788521">payload</span><span class="op" id="3788528">[</span><span class="builtinfunc" id="3788529">len</span><span class="op" id="3788532">(</span><span class="ident" id="3788533">payload</span><span class="op" id="3788540">)</span><span class="op" id="3788541">-</span><span class="num" id="3788542">1</span><span class="op" id="3788543">]</span><span class="op" id="3788544">)</span>&nbsp;<span class="op" id="3788546">+</span>&nbsp;<span class="num" id="3788548">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788551">if</span>&nbsp;<span class="ident" id="3788554">paddingLen</span>&nbsp;<span class="op" id="3788565">&gt;</span>&nbsp;<span class="builtinfunc" id="3788567">len</span><span class="op" id="3788570">(</span><span class="ident" id="3788571">payload</span><span class="op" id="3788578">)</span>&nbsp;<span class="op" id="3788580">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788584">return</span>&nbsp;<span class="ident" id="3788591">payload</span><span class="op" id="3788598">,</span>&nbsp;<span class="num" id="3788600">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3788603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788607">return</span>&nbsp;<span class="ident" id="3788614">payload</span><span class="op" id="3788621">[</span><span class="op" id="3788622">:</span><span class="builtinfunc" id="3788623">len</span><span class="op" id="3788626">(</span><span class="ident" id="3788627">payload</span><span class="op" id="3788634">)</span><span class="op" id="3788635">-</span><span class="ident" id="3788636">paddingLen</span><span class="op" id="3788646">]</span><span class="op" id="3788647">,</span>&nbsp;<span class="num" id="3788649">255</span><br>
<span class="lineno"></span><span class="op" id="3788653">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3788656">func</span>&nbsp;<span class="ident" id="3788661">roundUp</span><span class="op" id="3788668">(</span><span class="ident" id="3788669">a</span><span class="op" id="3788670">,</span>&nbsp;<span class="ident" id="3788672">b</span>&nbsp;<span class="builtintype" id="3788674">int</span><span class="op" id="3788677">)</span>&nbsp;<span class="builtintype" id="3788679">int</span>&nbsp;<span class="op" id="3788683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3788686">return</span>&nbsp;<span class="ident" id="3788693">a</span>&nbsp;<span class="op" id="3788695">+</span>&nbsp;<span class="op" id="3788697">(</span><span class="ident" id="3788698">b</span><span class="op" id="3788699">-</span><span class="ident" id="3788700">a</span><span class="op" id="3788701">%</span><span class="ident" id="3788702">b</span><span class="op" id="3788703">)</span><span class="op" id="3788704">%</span><span class="ident" id="3788705">b</span><br>
<span class="lineno"></span><span class="op" id="3788707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3788710">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3788784">type</span>&nbsp;<span class="ident" id="3788789">cbcMode</span>&nbsp;<span class="keyword" id="3788797">interface</span>&nbsp;<span class="op" id="3788807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788810">cipher</span><span class="op" id="3788816">.</span><span class="ident" id="3788817">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3788828">SetIV</span><span class="op" id="3788833">(</span><span class="op" id="3788834">[</span><span class="op" id="3788835">]</span><span class="builtintype" id="3788836">byte</span><span class="op" id="3788840">)</span><br>
<span class="lineno"></span><span class="op" id="3788842">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3788845">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3788920">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3789000">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3789070">func</span>&nbsp;<span class="op" id="3789075">(</span><span class="ident" id="3789076">hc</span>&nbsp;<span class="op" id="3789079">*</span><span class="ident" id="3789080">halfConn</span><span class="op" id="3789088">)</span>&nbsp;<span class="ident" id="3789090">decrypt</span><span class="op" id="3789097">(</span><span class="ident" id="3789098">b</span>&nbsp;<span class="op" id="3789100">*</span><span class="ident" id="3789101">block</span><span class="op" id="3789106">)</span>&nbsp;<span class="op" id="3789108">(</span><span class="ident" id="3789109">ok</span>&nbsp;<span class="builtintype" id="3789112">bool</span><span class="op" id="3789116">,</span>&nbsp;<span class="ident" id="3789118">prefixLen</span>&nbsp;<span class="builtintype" id="3789128">int</span><span class="op" id="3789131">,</span>&nbsp;<span class="ident" id="3789133">alertValue</span>&nbsp;<span class="ident" id="3789144">alert</span><span class="op" id="3789149">)</span>&nbsp;<span class="op" id="3789151">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3789154">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789175">payload</span>&nbsp;<span class="op" id="3789183">:=</span>&nbsp;<span class="ident" id="3789186">b</span><span class="op" id="3789187">.</span><span class="ident" id="3789188">data</span><span class="op" id="3789192">[</span><span class="ident" id="3789193">recordHeaderLen</span><span class="op" id="3789208">:</span><span class="op" id="3789209">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789213">macSize</span>&nbsp;<span class="op" id="3789221">:=</span>&nbsp;<span class="num" id="3789224">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789227">if</span>&nbsp;<span class="ident" id="3789230">hc</span><span class="op" id="3789232">.</span><span class="ident" id="3789233">mac</span>&nbsp;<span class="op" id="3789237">!=</span>&nbsp;<span class="ident" id="3789240">nil</span>&nbsp;<span class="op" id="3789244">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789248">macSize</span>&nbsp;<span class="op" id="3789256">=</span>&nbsp;<span class="ident" id="3789258">hc</span><span class="op" id="3789260">.</span><span class="ident" id="3789261">mac</span><span class="op" id="3789264">.</span><span class="ident" id="3789265">Size</span><span class="op" id="3789269">(</span><span class="op" id="3789270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3789273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789277">paddingGood</span>&nbsp;<span class="op" id="3789289">:=</span>&nbsp;<span class="builtintype" id="3789292">byte</span><span class="op" id="3789296">(</span><span class="num" id="3789297">255</span><span class="op" id="3789300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789303">explicitIVLen</span>&nbsp;<span class="op" id="3789317">:=</span>&nbsp;<span class="num" id="3789320">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3789324">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789336">if</span>&nbsp;<span class="ident" id="3789339">hc</span><span class="op" id="3789341">.</span><span class="ident" id="3789342">cipher</span>&nbsp;<span class="op" id="3789349">!=</span>&nbsp;<span class="ident" id="3789352">nil</span>&nbsp;<span class="op" id="3789356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789360">switch</span>&nbsp;<span class="ident" id="3789367">c</span>&nbsp;<span class="op" id="3789369">:=</span>&nbsp;<span class="ident" id="3789372">hc</span><span class="op" id="3789374">.</span><span class="ident" id="3789375">cipher</span><span class="op" id="3789381">.</span><span class="op" id="3789382">(</span><span class="keyword" id="3789383">type</span><span class="op" id="3789387">)</span>&nbsp;<span class="op" id="3789389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789393">case</span>&nbsp;<span class="ident" id="3789398">cipher</span><span class="op" id="3789404">.</span><span class="ident" id="3789405">Stream</span><span class="op" id="3789411">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789416">c</span><span class="op" id="3789417">.</span><span class="ident" id="3789418">XORKeyStream</span><span class="op" id="3789430">(</span><span class="ident" id="3789431">payload</span><span class="op" id="3789438">,</span>&nbsp;<span class="ident" id="3789440">payload</span><span class="op" id="3789447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789451">case</span>&nbsp;<span class="ident" id="3789456">cipher</span><span class="op" id="3789462">.</span><span class="ident" id="3789463">AEAD</span><span class="op" id="3789467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789472">explicitIVLen</span>&nbsp;<span class="op" id="3789486">=</span>&nbsp;<span class="num" id="3789488">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789493">if</span>&nbsp;<span class="builtinfunc" id="3789496">len</span><span class="op" id="3789499">(</span><span class="ident" id="3789500">payload</span><span class="op" id="3789507">)</span>&nbsp;<span class="op" id="3789509">&lt;</span>&nbsp;<span class="ident" id="3789511">explicitIVLen</span>&nbsp;<span class="op" id="3789525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789531">return</span>&nbsp;<span class="builtintype" id="3789538">false</span><span class="op" id="3789543">,</span>&nbsp;<span class="num" id="3789545">0</span><span class="op" id="3789546">,</span>&nbsp;<span class="ident" id="3789548">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3789569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789574">nonce</span>&nbsp;<span class="op" id="3789580">:=</span>&nbsp;<span class="ident" id="3789583">payload</span><span class="op" id="3789590">[</span><span class="op" id="3789591">:</span><span class="num" id="3789592">8</span><span class="op" id="3789593">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789598">payload</span>&nbsp;<span class="op" id="3789606">=</span>&nbsp;<span class="ident" id="3789608">payload</span><span class="op" id="3789615">[</span><span class="num" id="3789616">8</span><span class="op" id="3789617">:</span><span class="op" id="3789618">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789624">var</span>&nbsp;<span class="ident" id="3789628">additionalData</span>&nbsp;<span class="op" id="3789643">[</span><span class="num" id="3789644">13</span><span class="op" id="3789646">]</span><span class="builtintype" id="3789647">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3789655">copy</span><span class="op" id="3789659">(</span><span class="ident" id="3789660">additionalData</span><span class="op" id="3789674">[</span><span class="op" id="3789675">:</span><span class="op" id="3789676">]</span><span class="op" id="3789677">,</span>&nbsp;<span class="ident" id="3789679">hc</span><span class="op" id="3789681">.</span><span class="ident" id="3789682">seq</span><span class="op" id="3789685">[</span><span class="op" id="3789686">:</span><span class="op" id="3789687">]</span><span class="op" id="3789688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3789693">copy</span><span class="op" id="3789697">(</span><span class="ident" id="3789698">additionalData</span><span class="op" id="3789712">[</span><span class="num" id="3789713">8</span><span class="op" id="3789714">:</span><span class="op" id="3789715">]</span><span class="op" id="3789716">,</span>&nbsp;<span class="ident" id="3789718">b</span><span class="op" id="3789719">.</span><span class="ident" id="3789720">data</span><span class="op" id="3789724">[</span><span class="op" id="3789725">:</span><span class="num" id="3789726">3</span><span class="op" id="3789727">]</span><span class="op" id="3789728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789733">n</span>&nbsp;<span class="op" id="3789735">:=</span>&nbsp;<span class="builtinfunc" id="3789738">len</span><span class="op" id="3789741">(</span><span class="ident" id="3789742">payload</span><span class="op" id="3789749">)</span>&nbsp;<span class="op" id="3789751">-</span>&nbsp;<span class="ident" id="3789753">c</span><span class="op" id="3789754">.</span><span class="ident" id="3789755">Overhead</span><span class="op" id="3789763">(</span><span class="op" id="3789764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789769">additionalData</span><span class="op" id="3789783">[</span><span class="num" id="3789784">11</span><span class="op" id="3789786">]</span>&nbsp;<span class="op" id="3789788">=</span>&nbsp;<span class="builtintype" id="3789790">byte</span><span class="op" id="3789794">(</span><span class="ident" id="3789795">n</span>&nbsp;<span class="op" id="3789797">&gt;&gt;</span>&nbsp;<span class="num" id="3789800">8</span><span class="op" id="3789801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789806">additionalData</span><span class="op" id="3789820">[</span><span class="num" id="3789821">12</span><span class="op" id="3789823">]</span>&nbsp;<span class="op" id="3789825">=</span>&nbsp;<span class="builtintype" id="3789827">byte</span><span class="op" id="3789831">(</span><span class="ident" id="3789832">n</span><span class="op" id="3789833">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789838">var</span>&nbsp;<span class="ident" id="3789842">err</span>&nbsp;<span class="builtintype" id="3789846">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789855">payload</span><span class="op" id="3789862">,</span>&nbsp;<span class="ident" id="3789864">err</span>&nbsp;<span class="op" id="3789868">=</span>&nbsp;<span class="ident" id="3789870">c</span><span class="op" id="3789871">.</span><span class="ident" id="3789872">Open</span><span class="op" id="3789876">(</span><span class="ident" id="3789877">payload</span><span class="op" id="3789884">[</span><span class="op" id="3789885">:</span><span class="num" id="3789886">0</span><span class="op" id="3789887">]</span><span class="op" id="3789888">,</span>&nbsp;<span class="ident" id="3789890">nonce</span><span class="op" id="3789895">,</span>&nbsp;<span class="ident" id="3789897">payload</span><span class="op" id="3789904">,</span>&nbsp;<span class="ident" id="3789906">additionalData</span><span class="op" id="3789920">[</span><span class="op" id="3789921">:</span><span class="op" id="3789922">]</span><span class="op" id="3789923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789928">if</span>&nbsp;<span class="ident" id="3789931">err</span>&nbsp;<span class="op" id="3789935">!=</span>&nbsp;<span class="ident" id="3789938">nil</span>&nbsp;<span class="op" id="3789942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3789948">return</span>&nbsp;<span class="builtintype" id="3789955">false</span><span class="op" id="3789960">,</span>&nbsp;<span class="num" id="3789962">0</span><span class="op" id="3789963">,</span>&nbsp;<span class="ident" id="3789965">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3789986">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3789991">b</span><span class="op" id="3789992">.</span><span class="ident" id="3789993">resize</span><span class="op" id="3789999">(</span><span class="ident" id="3790000">recordHeaderLen</span>&nbsp;<span class="op" id="3790016">+</span>&nbsp;<span class="ident" id="3790018">explicitIVLen</span>&nbsp;<span class="op" id="3790032">+</span>&nbsp;<span class="builtinfunc" id="3790034">len</span><span class="op" id="3790037">(</span><span class="ident" id="3790038">payload</span><span class="op" id="3790045">)</span><span class="op" id="3790046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790050">case</span>&nbsp;<span class="ident" id="3790055">cbcMode</span><span class="op" id="3790062">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790067">blockSize</span>&nbsp;<span class="op" id="3790077">:=</span>&nbsp;<span class="ident" id="3790080">c</span><span class="op" id="3790081">.</span><span class="ident" id="3790082">BlockSize</span><span class="op" id="3790091">(</span><span class="op" id="3790092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790097">if</span>&nbsp;<span class="ident" id="3790100">hc</span><span class="op" id="3790102">.</span><span class="ident" id="3790103">version</span>&nbsp;<span class="op" id="3790111">&gt;=</span>&nbsp;<span class="ident" id="3790114">VersionTLS11</span>&nbsp;<span class="op" id="3790127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790133">explicitIVLen</span>&nbsp;<span class="op" id="3790147">=</span>&nbsp;<span class="ident" id="3790149">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3790162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790168">if</span>&nbsp;<span class="builtinfunc" id="3790171">len</span><span class="op" id="3790174">(</span><span class="ident" id="3790175">payload</span><span class="op" id="3790182">)</span><span class="op" id="3790183">%</span><span class="ident" id="3790184">blockSize</span>&nbsp;<span class="op" id="3790194">!=</span>&nbsp;<span class="num" id="3790197">0</span>&nbsp;<span class="op" id="3790199">||</span>&nbsp;<span class="builtinfunc" id="3790202">len</span><span class="op" id="3790205">(</span><span class="ident" id="3790206">payload</span><span class="op" id="3790213">)</span>&nbsp;<span class="op" id="3790215">&lt;</span>&nbsp;<span class="ident" id="3790217">roundUp</span><span class="op" id="3790224">(</span><span class="ident" id="3790225">explicitIVLen</span><span class="op" id="3790238">+</span><span class="ident" id="3790239">macSize</span><span class="op" id="3790246">+</span><span class="num" id="3790247">1</span><span class="op" id="3790248">,</span>&nbsp;<span class="ident" id="3790250">blockSize</span><span class="op" id="3790259">)</span>&nbsp;<span class="op" id="3790261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790267">return</span>&nbsp;<span class="builtintype" id="3790274">false</span><span class="op" id="3790279">,</span>&nbsp;<span class="num" id="3790281">0</span><span class="op" id="3790282">,</span>&nbsp;<span class="ident" id="3790284">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3790305">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790311">if</span>&nbsp;<span class="ident" id="3790314">explicitIVLen</span>&nbsp;<span class="op" id="3790328">&gt;</span>&nbsp;<span class="num" id="3790330">0</span>&nbsp;<span class="op" id="3790332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790338">c</span><span class="op" id="3790339">.</span><span class="ident" id="3790340">SetIV</span><span class="op" id="3790345">(</span><span class="ident" id="3790346">payload</span><span class="op" id="3790353">[</span><span class="op" id="3790354">:</span><span class="ident" id="3790355">explicitIVLen</span><span class="op" id="3790368">]</span><span class="op" id="3790369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790375">payload</span>&nbsp;<span class="op" id="3790383">=</span>&nbsp;<span class="ident" id="3790385">payload</span><span class="op" id="3790392">[</span><span class="ident" id="3790393">explicitIVLen</span><span class="op" id="3790406">:</span><span class="op" id="3790407">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3790412">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790417">c</span><span class="op" id="3790418">.</span><span class="ident" id="3790419">CryptBlocks</span><span class="op" id="3790430">(</span><span class="ident" id="3790431">payload</span><span class="op" id="3790438">,</span>&nbsp;<span class="ident" id="3790440">payload</span><span class="op" id="3790447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3790452">if</span>&nbsp;<span class="ident" id="3790455">hc</span><span class="op" id="3790457">.</span><span class="ident" id="3790458">version</span>&nbsp;<span class="op" id="3790466">==</span>&nbsp;<span class="ident" id="3790469">VersionSSL30</span>&nbsp;<span class="op" id="3790482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790488">payload</span><span class="op" id="3790495">,</span>&nbsp;<span class="ident" id="3790497">paddingGood</span>&nbsp;<span class="op" id="3790509">=</span>&nbsp;<span class="ident" id="3790511">removePaddingSSL30</span><span class="op" id="3790529">(</span><span class="ident" id="3790530">payload</span><span class="op" id="3790537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3790542">}</span>&nbsp;<span class="keyword" id="3790544">else</span>&nbsp;<span class="op" id="3790549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790555">payload</span><span class="op" id="3790562">,</span>&nbsp;<span class="ident" id="3790564">paddingGood</span>&nbsp;<span class="op" id="3790576">=</span>&nbsp;<span class="ident" id="3790578">removePadding</span><span class="op" id="3790591">(</span><span class="ident" id="3790592">payload</span><span class="op" id="3790599">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3790604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3790609">b</span><span class="op" id="3790610">.</span><span class="ident" id="3790611">resize</span><span class="op" id="3790617">(</span><span class="ident" id="3790618">recordHeaderLen</span>&nbsp;<span class="op" id="3790634">+</span>&nbsp;<span class="ident" id="3790636">explicitIVLen</span>&nbsp;<span class="op" id="3790650">+</span>&nbsp;<span class="builtinfunc" id="3790652">len</span><span class="op" id="3790655">(</span><span class="ident" id="3790656">payload</span><span class="op" id="3790663">)</span><span class="op" id="3790664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790670">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790729">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790786">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790843">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790899">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3790949">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791007">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791027">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791033">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791089">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791119">default</span><span class="op" id="3791126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3791131">panic</span><span class="op" id="3791136">(</span><span class="string" id="3791137">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3791158">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3791162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3791165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791169">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791190">if</span>&nbsp;<span class="ident" id="3791193">hc</span><span class="op" id="3791195">.</span><span class="ident" id="3791196">mac</span>&nbsp;<span class="op" id="3791200">!=</span>&nbsp;<span class="ident" id="3791203">nil</span>&nbsp;<span class="op" id="3791207">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791211">if</span>&nbsp;<span class="builtinfunc" id="3791214">len</span><span class="op" id="3791217">(</span><span class="ident" id="3791218">payload</span><span class="op" id="3791225">)</span>&nbsp;<span class="op" id="3791227">&lt;</span>&nbsp;<span class="ident" id="3791229">macSize</span>&nbsp;<span class="op" id="3791237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791242">return</span>&nbsp;<span class="builtintype" id="3791249">false</span><span class="op" id="3791254">,</span>&nbsp;<span class="num" id="3791256">0</span><span class="op" id="3791257">,</span>&nbsp;<span class="ident" id="3791259">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3791279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3791284">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791319">n</span>&nbsp;<span class="op" id="3791321">:=</span>&nbsp;<span class="builtinfunc" id="3791324">len</span><span class="op" id="3791327">(</span><span class="ident" id="3791328">payload</span><span class="op" id="3791335">)</span>&nbsp;<span class="op" id="3791337">-</span>&nbsp;<span class="ident" id="3791339">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791349">b</span><span class="op" id="3791350">.</span><span class="ident" id="3791351">data</span><span class="op" id="3791355">[</span><span class="num" id="3791356">3</span><span class="op" id="3791357">]</span>&nbsp;<span class="op" id="3791359">=</span>&nbsp;<span class="builtintype" id="3791361">byte</span><span class="op" id="3791365">(</span><span class="ident" id="3791366">n</span>&nbsp;<span class="op" id="3791368">&gt;&gt;</span>&nbsp;<span class="num" id="3791371">8</span><span class="op" id="3791372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791376">b</span><span class="op" id="3791377">.</span><span class="ident" id="3791378">data</span><span class="op" id="3791382">[</span><span class="num" id="3791383">4</span><span class="op" id="3791384">]</span>&nbsp;<span class="op" id="3791386">=</span>&nbsp;<span class="builtintype" id="3791388">byte</span><span class="op" id="3791392">(</span><span class="ident" id="3791393">n</span><span class="op" id="3791394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791398">b</span><span class="op" id="3791399">.</span><span class="ident" id="3791400">resize</span><span class="op" id="3791406">(</span><span class="ident" id="3791407">recordHeaderLen</span>&nbsp;<span class="op" id="3791423">+</span>&nbsp;<span class="ident" id="3791425">explicitIVLen</span>&nbsp;<span class="op" id="3791439">+</span>&nbsp;<span class="ident" id="3791441">n</span><span class="op" id="3791442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791446">remoteMAC</span>&nbsp;<span class="op" id="3791456">:=</span>&nbsp;<span class="ident" id="3791459">payload</span><span class="op" id="3791466">[</span><span class="ident" id="3791467">n</span><span class="op" id="3791468">:</span><span class="op" id="3791469">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791473">localMAC</span>&nbsp;<span class="op" id="3791482">:=</span>&nbsp;<span class="ident" id="3791485">hc</span><span class="op" id="3791487">.</span><span class="ident" id="3791488">mac</span><span class="op" id="3791491">.</span><span class="ident" id="3791492">MAC</span><span class="op" id="3791495">(</span><span class="ident" id="3791496">hc</span><span class="op" id="3791498">.</span><span class="ident" id="3791499">inDigestBuf</span><span class="op" id="3791510">,</span>&nbsp;<span class="ident" id="3791512">hc</span><span class="op" id="3791514">.</span><span class="ident" id="3791515">seq</span><span class="op" id="3791518">[</span><span class="num" id="3791519">0</span><span class="op" id="3791520">:</span><span class="op" id="3791521">]</span><span class="op" id="3791522">,</span>&nbsp;<span class="ident" id="3791524">b</span><span class="op" id="3791525">.</span><span class="ident" id="3791526">data</span><span class="op" id="3791530">[</span><span class="op" id="3791531">:</span><span class="ident" id="3791532">recordHeaderLen</span><span class="op" id="3791547">]</span><span class="op" id="3791548">,</span>&nbsp;<span class="ident" id="3791550">payload</span><span class="op" id="3791557">[</span><span class="op" id="3791558">:</span><span class="ident" id="3791559">n</span><span class="op" id="3791560">]</span><span class="op" id="3791561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791566">if</span>&nbsp;<span class="ident" id="3791569">subtle</span><span class="op" id="3791575">.</span><span class="ident" id="3791576">ConstantTimeCompare</span><span class="op" id="3791595">(</span><span class="ident" id="3791596">localMAC</span><span class="op" id="3791604">,</span>&nbsp;<span class="ident" id="3791606">remoteMAC</span><span class="op" id="3791615">)</span>&nbsp;<span class="op" id="3791617">!=</span>&nbsp;<span class="num" id="3791620">1</span>&nbsp;<span class="op" id="3791622">||</span>&nbsp;<span class="ident" id="3791625">paddingGood</span>&nbsp;<span class="op" id="3791637">!=</span>&nbsp;<span class="num" id="3791640">255</span>&nbsp;<span class="op" id="3791644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791649">return</span>&nbsp;<span class="builtintype" id="3791656">false</span><span class="op" id="3791661">,</span>&nbsp;<span class="num" id="3791663">0</span><span class="op" id="3791664">,</span>&nbsp;<span class="ident" id="3791666">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3791686">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791690">hc</span><span class="op" id="3791692">.</span><span class="ident" id="3791693">inDigestBuf</span>&nbsp;<span class="op" id="3791705">=</span>&nbsp;<span class="ident" id="3791707">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3791717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3791720">hc</span><span class="op" id="3791722">.</span><span class="ident" id="3791723">incSeq</span><span class="op" id="3791729">(</span><span class="op" id="3791730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3791734">return</span>&nbsp;<span class="builtintype" id="3791741">true</span><span class="op" id="3791745">,</span>&nbsp;<span class="ident" id="3791747">recordHeaderLen</span>&nbsp;<span class="op" id="3791763">+</span>&nbsp;<span class="ident" id="3791765">explicitIVLen</span><span class="op" id="3791778">,</span>&nbsp;<span class="num" id="3791780">0</span><br>
<span class="lineno">335</span><span class="op" id="3791782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3791785">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3791863">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3791938">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3792018">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3792094">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3792109">func</span>&nbsp;<span class="ident" id="3792114">padToBlockSize</span><span class="op" id="3792128">(</span><span class="ident" id="3792129">payload</span>&nbsp;<span class="op" id="3792137">[</span><span class="op" id="3792138">]</span><span class="builtintype" id="3792139">byte</span><span class="op" id="3792143">,</span>&nbsp;<span class="ident" id="3792145">blockSize</span>&nbsp;<span class="builtintype" id="3792155">int</span><span class="op" id="3792158">)</span>&nbsp;<span class="op" id="3792160">(</span><span class="ident" id="3792161">prefix</span><span class="op" id="3792167">,</span>&nbsp;<span class="ident" id="3792169">finalBlock</span>&nbsp;<span class="op" id="3792180">[</span><span class="op" id="3792181">]</span><span class="builtintype" id="3792182">byte</span><span class="op" id="3792186">)</span>&nbsp;<span class="op" id="3792188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792191">overrun</span>&nbsp;<span class="op" id="3792199">:=</span>&nbsp;<span class="builtinfunc" id="3792202">len</span><span class="op" id="3792205">(</span><span class="ident" id="3792206">payload</span><span class="op" id="3792213">)</span>&nbsp;<span class="op" id="3792215">%</span>&nbsp;<span class="ident" id="3792217">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792228">paddingLen</span>&nbsp;<span class="op" id="3792239">:=</span>&nbsp;<span class="ident" id="3792242">blockSize</span>&nbsp;<span class="op" id="3792252">-</span>&nbsp;<span class="ident" id="3792254">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792263">prefix</span>&nbsp;<span class="op" id="3792270">=</span>&nbsp;<span class="ident" id="3792272">payload</span><span class="op" id="3792279">[</span><span class="op" id="3792280">:</span><span class="builtinfunc" id="3792281">len</span><span class="op" id="3792284">(</span><span class="ident" id="3792285">payload</span><span class="op" id="3792292">)</span><span class="op" id="3792293">-</span><span class="ident" id="3792294">overrun</span><span class="op" id="3792301">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792304">finalBlock</span>&nbsp;<span class="op" id="3792315">=</span>&nbsp;<span class="builtinfunc" id="3792317">make</span><span class="op" id="3792321">(</span><span class="op" id="3792322">[</span><span class="op" id="3792323">]</span><span class="builtintype" id="3792324">byte</span><span class="op" id="3792328">,</span>&nbsp;<span class="ident" id="3792330">blockSize</span><span class="op" id="3792339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3792342">copy</span><span class="op" id="3792346">(</span><span class="ident" id="3792347">finalBlock</span><span class="op" id="3792357">,</span>&nbsp;<span class="ident" id="3792359">payload</span><span class="op" id="3792366">[</span><span class="builtinfunc" id="3792367">len</span><span class="op" id="3792370">(</span><span class="ident" id="3792371">payload</span><span class="op" id="3792378">)</span><span class="op" id="3792379">-</span><span class="ident" id="3792380">overrun</span><span class="op" id="3792387">:</span><span class="op" id="3792388">]</span><span class="op" id="3792389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792392">for</span>&nbsp;<span class="ident" id="3792396">i</span>&nbsp;<span class="op" id="3792398">:=</span>&nbsp;<span class="ident" id="3792401">overrun</span><span class="op" id="3792408">;</span>&nbsp;<span class="ident" id="3792410">i</span>&nbsp;<span class="op" id="3792412">&lt;</span>&nbsp;<span class="ident" id="3792414">blockSize</span><span class="op" id="3792423">;</span>&nbsp;<span class="ident" id="3792425">i</span><span class="op" id="3792426">++</span>&nbsp;<span class="op" id="3792429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792433">finalBlock</span><span class="op" id="3792443">[</span><span class="ident" id="3792444">i</span><span class="op" id="3792445">]</span>&nbsp;<span class="op" id="3792447">=</span>&nbsp;<span class="builtintype" id="3792449">byte</span><span class="op" id="3792453">(</span><span class="ident" id="3792454">paddingLen</span>&nbsp;<span class="op" id="3792465">-</span>&nbsp;<span class="num" id="3792467">1</span><span class="op" id="3792468">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792474">return</span><br>
<span class="lineno"></span><span class="op" id="3792481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3792484">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3792528">func</span>&nbsp;<span class="op" id="3792533">(</span><span class="ident" id="3792534">hc</span>&nbsp;<span class="op" id="3792537">*</span><span class="ident" id="3792538">halfConn</span><span class="op" id="3792546">)</span>&nbsp;<span class="ident" id="3792548">encrypt</span><span class="op" id="3792555">(</span><span class="ident" id="3792556">b</span>&nbsp;<span class="op" id="3792558">*</span><span class="ident" id="3792559">block</span><span class="op" id="3792564">,</span>&nbsp;<span class="ident" id="3792566">explicitIVLen</span>&nbsp;<span class="builtintype" id="3792580">int</span><span class="op" id="3792583">)</span>&nbsp;<span class="op" id="3792585">(</span><span class="builtintype" id="3792586">bool</span><span class="op" id="3792590">,</span>&nbsp;<span class="ident" id="3792592">alert</span><span class="op" id="3792597">)</span>&nbsp;<span class="op" id="3792599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792602">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792610">if</span>&nbsp;<span class="ident" id="3792613">hc</span><span class="op" id="3792615">.</span><span class="ident" id="3792616">mac</span>&nbsp;<span class="op" id="3792620">!=</span>&nbsp;<span class="ident" id="3792623">nil</span>&nbsp;<span class="op" id="3792627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792631">mac</span>&nbsp;<span class="op" id="3792635">:=</span>&nbsp;<span class="ident" id="3792638">hc</span><span class="op" id="3792640">.</span><span class="ident" id="3792641">mac</span><span class="op" id="3792644">.</span><span class="ident" id="3792645">MAC</span><span class="op" id="3792648">(</span><span class="ident" id="3792649">hc</span><span class="op" id="3792651">.</span><span class="ident" id="3792652">outDigestBuf</span><span class="op" id="3792664">,</span>&nbsp;<span class="ident" id="3792666">hc</span><span class="op" id="3792668">.</span><span class="ident" id="3792669">seq</span><span class="op" id="3792672">[</span><span class="num" id="3792673">0</span><span class="op" id="3792674">:</span><span class="op" id="3792675">]</span><span class="op" id="3792676">,</span>&nbsp;<span class="ident" id="3792678">b</span><span class="op" id="3792679">.</span><span class="ident" id="3792680">data</span><span class="op" id="3792684">[</span><span class="op" id="3792685">:</span><span class="ident" id="3792686">recordHeaderLen</span><span class="op" id="3792701">]</span><span class="op" id="3792702">,</span>&nbsp;<span class="ident" id="3792704">b</span><span class="op" id="3792705">.</span><span class="ident" id="3792706">data</span><span class="op" id="3792710">[</span><span class="ident" id="3792711">recordHeaderLen</span><span class="op" id="3792726">+</span><span class="ident" id="3792727">explicitIVLen</span><span class="op" id="3792740">:</span><span class="op" id="3792741">]</span><span class="op" id="3792742">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792747">n</span>&nbsp;<span class="op" id="3792749">:=</span>&nbsp;<span class="builtinfunc" id="3792752">len</span><span class="op" id="3792755">(</span><span class="ident" id="3792756">b</span><span class="op" id="3792757">.</span><span class="ident" id="3792758">data</span><span class="op" id="3792762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792766">b</span><span class="op" id="3792767">.</span><span class="ident" id="3792768">resize</span><span class="op" id="3792774">(</span><span class="ident" id="3792775">n</span>&nbsp;<span class="op" id="3792777">+</span>&nbsp;<span class="builtinfunc" id="3792779">len</span><span class="op" id="3792782">(</span><span class="ident" id="3792783">mac</span><span class="op" id="3792786">)</span><span class="op" id="3792787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3792791">copy</span><span class="op" id="3792795">(</span><span class="ident" id="3792796">b</span><span class="op" id="3792797">.</span><span class="ident" id="3792798">data</span><span class="op" id="3792802">[</span><span class="ident" id="3792803">n</span><span class="op" id="3792804">:</span><span class="op" id="3792805">]</span><span class="op" id="3792806">,</span>&nbsp;<span class="ident" id="3792808">mac</span><span class="op" id="3792811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792815">hc</span><span class="op" id="3792817">.</span><span class="ident" id="3792818">outDigestBuf</span>&nbsp;<span class="op" id="3792831">=</span>&nbsp;<span class="ident" id="3792833">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3792838">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792842">payload</span>&nbsp;<span class="op" id="3792850">:=</span>&nbsp;<span class="ident" id="3792853">b</span><span class="op" id="3792854">.</span><span class="ident" id="3792855">data</span><span class="op" id="3792859">[</span><span class="ident" id="3792860">recordHeaderLen</span><span class="op" id="3792875">:</span><span class="op" id="3792876">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3792880">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792892">if</span>&nbsp;<span class="ident" id="3792895">hc</span><span class="op" id="3792897">.</span><span class="ident" id="3792898">cipher</span>&nbsp;<span class="op" id="3792905">!=</span>&nbsp;<span class="ident" id="3792908">nil</span>&nbsp;<span class="op" id="3792912">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792916">switch</span>&nbsp;<span class="ident" id="3792923">c</span>&nbsp;<span class="op" id="3792925">:=</span>&nbsp;<span class="ident" id="3792928">hc</span><span class="op" id="3792930">.</span><span class="ident" id="3792931">cipher</span><span class="op" id="3792937">.</span><span class="op" id="3792938">(</span><span class="keyword" id="3792939">type</span><span class="op" id="3792943">)</span>&nbsp;<span class="op" id="3792945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3792949">case</span>&nbsp;<span class="ident" id="3792954">cipher</span><span class="op" id="3792960">.</span><span class="ident" id="3792961">Stream</span><span class="op" id="3792967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3792972">c</span><span class="op" id="3792973">.</span><span class="ident" id="3792974">XORKeyStream</span><span class="op" id="3792986">(</span><span class="ident" id="3792987">payload</span><span class="op" id="3792994">,</span>&nbsp;<span class="ident" id="3792996">payload</span><span class="op" id="3793003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793007">case</span>&nbsp;<span class="ident" id="3793012">cipher</span><span class="op" id="3793018">.</span><span class="ident" id="3793019">AEAD</span><span class="op" id="3793023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793028">payloadLen</span>&nbsp;<span class="op" id="3793039">:=</span>&nbsp;<span class="builtinfunc" id="3793042">len</span><span class="op" id="3793045">(</span><span class="ident" id="3793046">b</span><span class="op" id="3793047">.</span><span class="ident" id="3793048">data</span><span class="op" id="3793052">)</span>&nbsp;<span class="op" id="3793054">-</span>&nbsp;<span class="ident" id="3793056">recordHeaderLen</span>&nbsp;<span class="op" id="3793072">-</span>&nbsp;<span class="ident" id="3793074">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793091">b</span><span class="op" id="3793092">.</span><span class="ident" id="3793093">resize</span><span class="op" id="3793099">(</span><span class="builtinfunc" id="3793100">len</span><span class="op" id="3793103">(</span><span class="ident" id="3793104">b</span><span class="op" id="3793105">.</span><span class="ident" id="3793106">data</span><span class="op" id="3793110">)</span>&nbsp;<span class="op" id="3793112">+</span>&nbsp;<span class="ident" id="3793114">c</span><span class="op" id="3793115">.</span><span class="ident" id="3793116">Overhead</span><span class="op" id="3793124">(</span><span class="op" id="3793125">)</span><span class="op" id="3793126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793131">nonce</span>&nbsp;<span class="op" id="3793137">:=</span>&nbsp;<span class="ident" id="3793140">b</span><span class="op" id="3793141">.</span><span class="ident" id="3793142">data</span><span class="op" id="3793146">[</span><span class="ident" id="3793147">recordHeaderLen</span>&nbsp;<span class="op" id="3793163">:</span>&nbsp;<span class="ident" id="3793165">recordHeaderLen</span><span class="op" id="3793180">+</span><span class="ident" id="3793181">explicitIVLen</span><span class="op" id="3793194">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793199">payload</span>&nbsp;<span class="op" id="3793207">:=</span>&nbsp;<span class="ident" id="3793210">b</span><span class="op" id="3793211">.</span><span class="ident" id="3793212">data</span><span class="op" id="3793216">[</span><span class="ident" id="3793217">recordHeaderLen</span><span class="op" id="3793232">+</span><span class="ident" id="3793233">explicitIVLen</span><span class="op" id="3793246">:</span><span class="op" id="3793247">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793252">payload</span>&nbsp;<span class="op" id="3793260">=</span>&nbsp;<span class="ident" id="3793262">payload</span><span class="op" id="3793269">[</span><span class="op" id="3793270">:</span><span class="ident" id="3793271">payloadLen</span><span class="op" id="3793281">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793287">var</span>&nbsp;<span class="ident" id="3793291">additionalData</span>&nbsp;<span class="op" id="3793306">[</span><span class="num" id="3793307">13</span><span class="op" id="3793309">]</span><span class="builtintype" id="3793310">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3793318">copy</span><span class="op" id="3793322">(</span><span class="ident" id="3793323">additionalData</span><span class="op" id="3793337">[</span><span class="op" id="3793338">:</span><span class="op" id="3793339">]</span><span class="op" id="3793340">,</span>&nbsp;<span class="ident" id="3793342">hc</span><span class="op" id="3793344">.</span><span class="ident" id="3793345">seq</span><span class="op" id="3793348">[</span><span class="op" id="3793349">:</span><span class="op" id="3793350">]</span><span class="op" id="3793351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3793356">copy</span><span class="op" id="3793360">(</span><span class="ident" id="3793361">additionalData</span><span class="op" id="3793375">[</span><span class="num" id="3793376">8</span><span class="op" id="3793377">:</span><span class="op" id="3793378">]</span><span class="op" id="3793379">,</span>&nbsp;<span class="ident" id="3793381">b</span><span class="op" id="3793382">.</span><span class="ident" id="3793383">data</span><span class="op" id="3793387">[</span><span class="op" id="3793388">:</span><span class="num" id="3793389">3</span><span class="op" id="3793390">]</span><span class="op" id="3793391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793396">additionalData</span><span class="op" id="3793410">[</span><span class="num" id="3793411">11</span><span class="op" id="3793413">]</span>&nbsp;<span class="op" id="3793415">=</span>&nbsp;<span class="builtintype" id="3793417">byte</span><span class="op" id="3793421">(</span><span class="ident" id="3793422">payloadLen</span>&nbsp;<span class="op" id="3793433">&gt;&gt;</span>&nbsp;<span class="num" id="3793436">8</span><span class="op" id="3793437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793442">additionalData</span><span class="op" id="3793456">[</span><span class="num" id="3793457">12</span><span class="op" id="3793459">]</span>&nbsp;<span class="op" id="3793461">=</span>&nbsp;<span class="builtintype" id="3793463">byte</span><span class="op" id="3793467">(</span><span class="ident" id="3793468">payloadLen</span><span class="op" id="3793478">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793484">c</span><span class="op" id="3793485">.</span><span class="ident" id="3793486">Seal</span><span class="op" id="3793490">(</span><span class="ident" id="3793491">payload</span><span class="op" id="3793498">[</span><span class="op" id="3793499">:</span><span class="num" id="3793500">0</span><span class="op" id="3793501">]</span><span class="op" id="3793502">,</span>&nbsp;<span class="ident" id="3793504">nonce</span><span class="op" id="3793509">,</span>&nbsp;<span class="ident" id="3793511">payload</span><span class="op" id="3793518">,</span>&nbsp;<span class="ident" id="3793520">additionalData</span><span class="op" id="3793534">[</span><span class="op" id="3793535">:</span><span class="op" id="3793536">]</span><span class="op" id="3793537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793541">case</span>&nbsp;<span class="ident" id="3793546">cbcMode</span><span class="op" id="3793553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793558">blockSize</span>&nbsp;<span class="op" id="3793568">:=</span>&nbsp;<span class="ident" id="3793571">c</span><span class="op" id="3793572">.</span><span class="ident" id="3793573">BlockSize</span><span class="op" id="3793582">(</span><span class="op" id="3793583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793588">if</span>&nbsp;<span class="ident" id="3793591">explicitIVLen</span>&nbsp;<span class="op" id="3793605">&gt;</span>&nbsp;<span class="num" id="3793607">0</span>&nbsp;<span class="op" id="3793609">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793615">c</span><span class="op" id="3793616">.</span><span class="ident" id="3793617">SetIV</span><span class="op" id="3793622">(</span><span class="ident" id="3793623">payload</span><span class="op" id="3793630">[</span><span class="op" id="3793631">:</span><span class="ident" id="3793632">explicitIVLen</span><span class="op" id="3793645">]</span><span class="op" id="3793646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793652">payload</span>&nbsp;<span class="op" id="3793660">=</span>&nbsp;<span class="ident" id="3793662">payload</span><span class="op" id="3793669">[</span><span class="ident" id="3793670">explicitIVLen</span><span class="op" id="3793683">:</span><span class="op" id="3793684">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3793689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793694">prefix</span><span class="op" id="3793700">,</span>&nbsp;<span class="ident" id="3793702">finalBlock</span>&nbsp;<span class="op" id="3793713">:=</span>&nbsp;<span class="ident" id="3793716">padToBlockSize</span><span class="op" id="3793730">(</span><span class="ident" id="3793731">payload</span><span class="op" id="3793738">,</span>&nbsp;<span class="ident" id="3793740">blockSize</span><span class="op" id="3793749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793754">b</span><span class="op" id="3793755">.</span><span class="ident" id="3793756">resize</span><span class="op" id="3793762">(</span><span class="ident" id="3793763">recordHeaderLen</span>&nbsp;<span class="op" id="3793779">+</span>&nbsp;<span class="ident" id="3793781">explicitIVLen</span>&nbsp;<span class="op" id="3793795">+</span>&nbsp;<span class="builtinfunc" id="3793797">len</span><span class="op" id="3793800">(</span><span class="ident" id="3793801">prefix</span><span class="op" id="3793807">)</span>&nbsp;<span class="op" id="3793809">+</span>&nbsp;<span class="builtinfunc" id="3793811">len</span><span class="op" id="3793814">(</span><span class="ident" id="3793815">finalBlock</span><span class="op" id="3793825">)</span><span class="op" id="3793826">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793831">c</span><span class="op" id="3793832">.</span><span class="ident" id="3793833">CryptBlocks</span><span class="op" id="3793844">(</span><span class="ident" id="3793845">b</span><span class="op" id="3793846">.</span><span class="ident" id="3793847">data</span><span class="op" id="3793851">[</span><span class="ident" id="3793852">recordHeaderLen</span><span class="op" id="3793867">+</span><span class="ident" id="3793868">explicitIVLen</span><span class="op" id="3793881">:</span><span class="op" id="3793882">]</span><span class="op" id="3793883">,</span>&nbsp;<span class="ident" id="3793885">prefix</span><span class="op" id="3793891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3793896">c</span><span class="op" id="3793897">.</span><span class="ident" id="3793898">CryptBlocks</span><span class="op" id="3793909">(</span><span class="ident" id="3793910">b</span><span class="op" id="3793911">.</span><span class="ident" id="3793912">data</span><span class="op" id="3793916">[</span><span class="ident" id="3793917">recordHeaderLen</span><span class="op" id="3793932">+</span><span class="ident" id="3793933">explicitIVLen</span><span class="op" id="3793946">+</span><span class="builtinfunc" id="3793947">len</span><span class="op" id="3793950">(</span><span class="ident" id="3793951">prefix</span><span class="op" id="3793957">)</span><span class="op" id="3793958">:</span><span class="op" id="3793959">]</span><span class="op" id="3793960">,</span>&nbsp;<span class="ident" id="3793962">finalBlock</span><span class="op" id="3793972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3793976">default</span><span class="op" id="3793983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3793988">panic</span><span class="op" id="3793993">(</span><span class="string" id="3793994">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3794015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794019">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794026">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794089">n</span>&nbsp;<span class="op" id="3794091">:=</span>&nbsp;<span class="builtinfunc" id="3794094">len</span><span class="op" id="3794097">(</span><span class="ident" id="3794098">b</span><span class="op" id="3794099">.</span><span class="ident" id="3794100">data</span><span class="op" id="3794104">)</span>&nbsp;<span class="op" id="3794106">-</span>&nbsp;<span class="ident" id="3794108">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794125">b</span><span class="op" id="3794126">.</span><span class="ident" id="3794127">data</span><span class="op" id="3794131">[</span><span class="num" id="3794132">3</span><span class="op" id="3794133">]</span>&nbsp;<span class="op" id="3794135">=</span>&nbsp;<span class="builtintype" id="3794137">byte</span><span class="op" id="3794141">(</span><span class="ident" id="3794142">n</span>&nbsp;<span class="op" id="3794144">&gt;&gt;</span>&nbsp;<span class="num" id="3794147">8</span><span class="op" id="3794148">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794151">b</span><span class="op" id="3794152">.</span><span class="ident" id="3794153">data</span><span class="op" id="3794157">[</span><span class="num" id="3794158">4</span><span class="op" id="3794159">]</span>&nbsp;<span class="op" id="3794161">=</span>&nbsp;<span class="builtintype" id="3794163">byte</span><span class="op" id="3794167">(</span><span class="ident" id="3794168">n</span><span class="op" id="3794169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794172">hc</span><span class="op" id="3794174">.</span><span class="ident" id="3794175">incSeq</span><span class="op" id="3794181">(</span><span class="op" id="3794182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794186">return</span>&nbsp;<span class="builtintype" id="3794193">true</span><span class="op" id="3794197">,</span>&nbsp;<span class="num" id="3794199">0</span><br>
<span class="lineno"></span><span class="op" id="3794201">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3794204">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3794240">type</span>&nbsp;<span class="ident" id="3794245">block</span>&nbsp;<span class="keyword" id="3794251">struct</span>&nbsp;<span class="op" id="3794258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794261">data</span>&nbsp;<span class="op" id="3794266">[</span><span class="op" id="3794267">]</span><span class="builtintype" id="3794268">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794274">off</span>&nbsp;&nbsp;<span class="builtintype" id="3794279">int</span>&nbsp;<span class="comment" id="3794283">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794302">link</span>&nbsp;<span class="op" id="3794307">*</span><span class="ident" id="3794308">block</span><br>
<span class="lineno"></span><span class="op" id="3794314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3794317">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3794378">func</span>&nbsp;<span class="op" id="3794383">(</span><span class="ident" id="3794384">b</span>&nbsp;<span class="op" id="3794386">*</span><span class="ident" id="3794387">block</span><span class="op" id="3794392">)</span>&nbsp;<span class="ident" id="3794394">resize</span><span class="op" id="3794400">(</span><span class="ident" id="3794401">n</span>&nbsp;<span class="builtintype" id="3794403">int</span><span class="op" id="3794406">)</span>&nbsp;<span class="op" id="3794408">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794411">if</span>&nbsp;<span class="ident" id="3794414">n</span>&nbsp;<span class="op" id="3794416">&gt;</span>&nbsp;<span class="builtinfunc" id="3794418">cap</span><span class="op" id="3794421">(</span><span class="ident" id="3794422">b</span><span class="op" id="3794423">.</span><span class="ident" id="3794424">data</span><span class="op" id="3794428">)</span>&nbsp;<span class="op" id="3794430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794434">b</span><span class="op" id="3794435">.</span><span class="ident" id="3794436">reserve</span><span class="op" id="3794443">(</span><span class="ident" id="3794444">n</span><span class="op" id="3794445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794451">b</span><span class="op" id="3794452">.</span><span class="ident" id="3794453">data</span>&nbsp;<span class="op" id="3794458">=</span>&nbsp;<span class="ident" id="3794460">b</span><span class="op" id="3794461">.</span><span class="ident" id="3794462">data</span><span class="op" id="3794466">[</span><span class="num" id="3794467">0</span><span class="op" id="3794468">:</span><span class="ident" id="3794469">n</span><span class="op" id="3794470">]</span><br>
<span class="lineno"></span><span class="op" id="3794472">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3794475">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3794549">func</span>&nbsp;<span class="op" id="3794554">(</span><span class="ident" id="3794555">b</span>&nbsp;<span class="op" id="3794557">*</span><span class="ident" id="3794558">block</span><span class="op" id="3794563">)</span>&nbsp;<span class="ident" id="3794565">reserve</span><span class="op" id="3794572">(</span><span class="ident" id="3794573">n</span>&nbsp;<span class="builtintype" id="3794575">int</span><span class="op" id="3794578">)</span>&nbsp;<span class="op" id="3794580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794583">if</span>&nbsp;<span class="builtinfunc" id="3794586">cap</span><span class="op" id="3794589">(</span><span class="ident" id="3794590">b</span><span class="op" id="3794591">.</span><span class="ident" id="3794592">data</span><span class="op" id="3794596">)</span>&nbsp;<span class="op" id="3794598">&gt;=</span>&nbsp;<span class="ident" id="3794601">n</span>&nbsp;<span class="op" id="3794603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794607">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794618">m</span>&nbsp;<span class="op" id="3794620">:=</span>&nbsp;<span class="builtinfunc" id="3794623">cap</span><span class="op" id="3794626">(</span><span class="ident" id="3794627">b</span><span class="op" id="3794628">.</span><span class="ident" id="3794629">data</span><span class="op" id="3794633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794636">if</span>&nbsp;<span class="ident" id="3794639">m</span>&nbsp;<span class="op" id="3794641">==</span>&nbsp;<span class="num" id="3794644">0</span>&nbsp;<span class="op" id="3794646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794650">m</span>&nbsp;<span class="op" id="3794652">=</span>&nbsp;<span class="num" id="3794654">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794660">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794663">for</span>&nbsp;<span class="ident" id="3794667">m</span>&nbsp;<span class="op" id="3794669">&lt;</span>&nbsp;<span class="ident" id="3794671">n</span>&nbsp;<span class="op" id="3794673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794677">m</span>&nbsp;<span class="op" id="3794679">*=</span>&nbsp;<span class="num" id="3794682">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794688">data</span>&nbsp;<span class="op" id="3794693">:=</span>&nbsp;<span class="builtinfunc" id="3794696">make</span><span class="op" id="3794700">(</span><span class="op" id="3794701">[</span><span class="op" id="3794702">]</span><span class="builtintype" id="3794703">byte</span><span class="op" id="3794707">,</span>&nbsp;<span class="builtinfunc" id="3794709">len</span><span class="op" id="3794712">(</span><span class="ident" id="3794713">b</span><span class="op" id="3794714">.</span><span class="ident" id="3794715">data</span><span class="op" id="3794719">)</span><span class="op" id="3794720">,</span>&nbsp;<span class="ident" id="3794722">m</span><span class="op" id="3794723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3794726">copy</span><span class="op" id="3794730">(</span><span class="ident" id="3794731">data</span><span class="op" id="3794735">,</span>&nbsp;<span class="ident" id="3794737">b</span><span class="op" id="3794738">.</span><span class="ident" id="3794739">data</span><span class="op" id="3794743">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3794746">b</span><span class="op" id="3794747">.</span><span class="ident" id="3794748">data</span>&nbsp;<span class="op" id="3794753">=</span>&nbsp;<span class="ident" id="3794755">data</span><br>
<span class="lineno"></span><span class="op" id="3794760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3794763">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3794834">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3794863">func</span>&nbsp;<span class="op" id="3794868">(</span><span class="ident" id="3794869">b</span>&nbsp;<span class="op" id="3794871">*</span><span class="ident" id="3794872">block</span><span class="op" id="3794877">)</span>&nbsp;<span class="ident" id="3794879">readFromUntil</span><span class="op" id="3794892">(</span><span class="ident" id="3794893">r</span>&nbsp;<span class="ident" id="3794895">io</span><span class="op" id="3794897">.</span><span class="ident" id="3794898">Reader</span><span class="op" id="3794904">,</span>&nbsp;<span class="ident" id="3794906">n</span>&nbsp;<span class="builtintype" id="3794908">int</span><span class="op" id="3794911">)</span>&nbsp;<span class="builtintype" id="3794913">error</span>&nbsp;<span class="op" id="3794919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794922">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794937">if</span>&nbsp;<span class="builtinfunc" id="3794940">len</span><span class="op" id="3794943">(</span><span class="ident" id="3794944">b</span><span class="op" id="3794945">.</span><span class="ident" id="3794946">data</span><span class="op" id="3794950">)</span>&nbsp;<span class="op" id="3794952">&gt;=</span>&nbsp;<span class="ident" id="3794955">n</span>&nbsp;<span class="op" id="3794957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3794961">return</span>&nbsp;<span class="ident" id="3794968">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3794973">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3794977">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795005">b</span><span class="op" id="3795006">.</span><span class="ident" id="3795007">reserve</span><span class="op" id="3795014">(</span><span class="ident" id="3795015">n</span><span class="op" id="3795016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795019">for</span>&nbsp;<span class="op" id="3795023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795027">m</span><span class="op" id="3795028">,</span>&nbsp;<span class="ident" id="3795030">err</span>&nbsp;<span class="op" id="3795034">:=</span>&nbsp;<span class="ident" id="3795037">r</span><span class="op" id="3795038">.</span><span class="ident" id="3795039">Read</span><span class="op" id="3795043">(</span><span class="ident" id="3795044">b</span><span class="op" id="3795045">.</span><span class="ident" id="3795046">data</span><span class="op" id="3795050">[</span><span class="builtinfunc" id="3795051">len</span><span class="op" id="3795054">(</span><span class="ident" id="3795055">b</span><span class="op" id="3795056">.</span><span class="ident" id="3795057">data</span><span class="op" id="3795061">)</span><span class="op" id="3795062">:</span><span class="builtinfunc" id="3795063">cap</span><span class="op" id="3795066">(</span><span class="ident" id="3795067">b</span><span class="op" id="3795068">.</span><span class="ident" id="3795069">data</span><span class="op" id="3795073">)</span><span class="op" id="3795074">]</span><span class="op" id="3795075">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795079">b</span><span class="op" id="3795080">.</span><span class="ident" id="3795081">data</span>&nbsp;<span class="op" id="3795086">=</span>&nbsp;<span class="ident" id="3795088">b</span><span class="op" id="3795089">.</span><span class="ident" id="3795090">data</span><span class="op" id="3795094">[</span><span class="num" id="3795095">0</span>&nbsp;<span class="op" id="3795097">:</span>&nbsp;<span class="builtinfunc" id="3795099">len</span><span class="op" id="3795102">(</span><span class="ident" id="3795103">b</span><span class="op" id="3795104">.</span><span class="ident" id="3795105">data</span><span class="op" id="3795109">)</span><span class="op" id="3795110">+</span><span class="ident" id="3795111">m</span><span class="op" id="3795112">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795116">if</span>&nbsp;<span class="builtinfunc" id="3795119">len</span><span class="op" id="3795122">(</span><span class="ident" id="3795123">b</span><span class="op" id="3795124">.</span><span class="ident" id="3795125">data</span><span class="op" id="3795129">)</span>&nbsp;<span class="op" id="3795131">&gt;=</span>&nbsp;<span class="ident" id="3795134">n</span>&nbsp;<span class="op" id="3795136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3795141">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3795187">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795237">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3795245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795249">if</span>&nbsp;<span class="ident" id="3795252">err</span>&nbsp;<span class="op" id="3795256">!=</span>&nbsp;<span class="ident" id="3795259">nil</span>&nbsp;<span class="op" id="3795263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795268">return</span>&nbsp;<span class="ident" id="3795275">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3795281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3795284">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795287">return</span>&nbsp;<span class="ident" id="3795294">nil</span><br>
<span class="lineno"></span><span class="op" id="3795298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3795301">func</span>&nbsp;<span class="op" id="3795306">(</span><span class="ident" id="3795307">b</span>&nbsp;<span class="op" id="3795309">*</span><span class="ident" id="3795310">block</span><span class="op" id="3795315">)</span>&nbsp;<span class="ident" id="3795317">Read</span><span class="op" id="3795321">(</span><span class="ident" id="3795322">p</span>&nbsp;<span class="op" id="3795324">[</span><span class="op" id="3795325">]</span><span class="builtintype" id="3795326">byte</span><span class="op" id="3795330">)</span>&nbsp;<span class="op" id="3795332">(</span><span class="ident" id="3795333">n</span>&nbsp;<span class="builtintype" id="3795335">int</span><span class="op" id="3795338">,</span>&nbsp;<span class="ident" id="3795340">err</span>&nbsp;<span class="builtintype" id="3795344">error</span><span class="op" id="3795349">)</span>&nbsp;<span class="op" id="3795351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795354">n</span>&nbsp;<span class="op" id="3795356">=</span>&nbsp;<span class="builtinfunc" id="3795358">copy</span><span class="op" id="3795362">(</span><span class="ident" id="3795363">p</span><span class="op" id="3795364">,</span>&nbsp;<span class="ident" id="3795366">b</span><span class="op" id="3795367">.</span><span class="ident" id="3795368">data</span><span class="op" id="3795372">[</span><span class="ident" id="3795373">b</span><span class="op" id="3795374">.</span><span class="ident" id="3795375">off</span><span class="op" id="3795378">:</span><span class="op" id="3795379">]</span><span class="op" id="3795380">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795383">b</span><span class="op" id="3795384">.</span><span class="ident" id="3795385">off</span>&nbsp;<span class="op" id="3795389">+=</span>&nbsp;<span class="ident" id="3795392">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795395">return</span><br>
<span class="lineno"></span><span class="op" id="3795402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3795405">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3795473">func</span>&nbsp;<span class="op" id="3795478">(</span><span class="ident" id="3795479">hc</span>&nbsp;<span class="op" id="3795482">*</span><span class="ident" id="3795483">halfConn</span><span class="op" id="3795491">)</span>&nbsp;<span class="ident" id="3795493">newBlock</span><span class="op" id="3795501">(</span><span class="op" id="3795502">)</span>&nbsp;<span class="op" id="3795504">*</span><span class="ident" id="3795505">block</span>&nbsp;<span class="op" id="3795511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795514">b</span>&nbsp;<span class="op" id="3795516">:=</span>&nbsp;<span class="ident" id="3795519">hc</span><span class="op" id="3795521">.</span><span class="ident" id="3795522">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795529">if</span>&nbsp;<span class="ident" id="3795532">b</span>&nbsp;<span class="op" id="3795534">==</span>&nbsp;<span class="ident" id="3795537">nil</span>&nbsp;<span class="op" id="3795541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795545">return</span>&nbsp;<span class="builtinfunc" id="3795552">new</span><span class="op" id="3795555">(</span><span class="ident" id="3795556">block</span><span class="op" id="3795561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3795564">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795567">hc</span><span class="op" id="3795569">.</span><span class="ident" id="3795570">bfree</span>&nbsp;<span class="op" id="3795576">=</span>&nbsp;<span class="ident" id="3795578">b</span><span class="op" id="3795579">.</span><span class="ident" id="3795580">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795586">b</span><span class="op" id="3795587">.</span><span class="ident" id="3795588">link</span>&nbsp;<span class="op" id="3795593">=</span>&nbsp;<span class="ident" id="3795595">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795600">b</span><span class="op" id="3795601">.</span><span class="ident" id="3795602">resize</span><span class="op" id="3795608">(</span><span class="num" id="3795609">0</span><span class="op" id="3795610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3795613">return</span>&nbsp;<span class="ident" id="3795620">b</span><br>
<span class="lineno"></span><span class="op" id="3795622">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3795625">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3795673">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3795739">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3795801">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3795828">func</span>&nbsp;<span class="op" id="3795833">(</span><span class="ident" id="3795834">hc</span>&nbsp;<span class="op" id="3795837">*</span><span class="ident" id="3795838">halfConn</span><span class="op" id="3795846">)</span>&nbsp;<span class="ident" id="3795848">freeBlock</span><span class="op" id="3795857">(</span><span class="ident" id="3795858">b</span>&nbsp;<span class="op" id="3795860">*</span><span class="ident" id="3795861">block</span><span class="op" id="3795866">)</span>&nbsp;<span class="op" id="3795868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795871">b</span><span class="op" id="3795872">.</span><span class="ident" id="3795873">link</span>&nbsp;<span class="op" id="3795878">=</span>&nbsp;<span class="ident" id="3795880">hc</span><span class="op" id="3795882">.</span><span class="ident" id="3795883">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3795890">hc</span><span class="op" id="3795892">.</span><span class="ident" id="3795893">bfree</span>&nbsp;<span class="op" id="3795899">=</span>&nbsp;<span class="ident" id="3795901">b</span><br>
<span class="lineno"></span><span class="op" id="3795903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3795906">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3795960">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3796006">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3796059">func</span>&nbsp;<span class="op" id="3796064">(</span><span class="ident" id="3796065">hc</span>&nbsp;<span class="op" id="3796068">*</span><span class="ident" id="3796069">halfConn</span><span class="op" id="3796077">)</span>&nbsp;<span class="ident" id="3796079">splitBlock</span><span class="op" id="3796089">(</span><span class="ident" id="3796090">b</span>&nbsp;<span class="op" id="3796092">*</span><span class="ident" id="3796093">block</span><span class="op" id="3796098">,</span>&nbsp;<span class="ident" id="3796100">n</span>&nbsp;<span class="builtintype" id="3796102">int</span><span class="op" id="3796105">)</span>&nbsp;<span class="op" id="3796107">(</span><span class="op" id="3796108">*</span><span class="ident" id="3796109">block</span><span class="op" id="3796114">,</span>&nbsp;<span class="op" id="3796116">*</span><span class="ident" id="3796117">block</span><span class="op" id="3796122">)</span>&nbsp;<span class="op" id="3796124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796127">if</span>&nbsp;<span class="builtinfunc" id="3796130">len</span><span class="op" id="3796133">(</span><span class="ident" id="3796134">b</span><span class="op" id="3796135">.</span><span class="ident" id="3796136">data</span><span class="op" id="3796140">)</span>&nbsp;<span class="op" id="3796142">&lt;=</span>&nbsp;<span class="ident" id="3796145">n</span>&nbsp;<span class="op" id="3796147">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796151">return</span>&nbsp;<span class="ident" id="3796158">b</span><span class="op" id="3796159">,</span>&nbsp;<span class="ident" id="3796161">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3796166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3796169">bb</span>&nbsp;<span class="op" id="3796172">:=</span>&nbsp;<span class="ident" id="3796175">hc</span><span class="op" id="3796177">.</span><span class="ident" id="3796178">newBlock</span><span class="op" id="3796186">(</span><span class="op" id="3796187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3796190">bb</span><span class="op" id="3796192">.</span><span class="ident" id="3796193">resize</span><span class="op" id="3796199">(</span><span class="builtinfunc" id="3796200">len</span><span class="op" id="3796203">(</span><span class="ident" id="3796204">b</span><span class="op" id="3796205">.</span><span class="ident" id="3796206">data</span><span class="op" id="3796210">)</span>&nbsp;<span class="op" id="3796212">-</span>&nbsp;<span class="ident" id="3796214">n</span><span class="op" id="3796215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3796218">copy</span><span class="op" id="3796222">(</span><span class="ident" id="3796223">bb</span><span class="op" id="3796225">.</span><span class="ident" id="3796226">data</span><span class="op" id="3796230">,</span>&nbsp;<span class="ident" id="3796232">b</span><span class="op" id="3796233">.</span><span class="ident" id="3796234">data</span><span class="op" id="3796238">[</span><span class="ident" id="3796239">n</span><span class="op" id="3796240">:</span><span class="op" id="3796241">]</span><span class="op" id="3796242">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3796245">b</span><span class="op" id="3796246">.</span><span class="ident" id="3796247">data</span>&nbsp;<span class="op" id="3796252">=</span>&nbsp;<span class="ident" id="3796254">b</span><span class="op" id="3796255">.</span><span class="ident" id="3796256">data</span><span class="op" id="3796260">[</span><span class="num" id="3796261">0</span><span class="op" id="3796262">:</span><span class="ident" id="3796263">n</span><span class="op" id="3796264">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796267">return</span>&nbsp;<span class="ident" id="3796274">b</span><span class="op" id="3796275">,</span>&nbsp;<span class="ident" id="3796277">bb</span><br>
<span class="lineno"></span><span class="op" id="3796280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3796283">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3796343">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3796382">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3796418">func</span>&nbsp;<span class="op" id="3796423">(</span><span class="ident" id="3796424">c</span>&nbsp;<span class="op" id="3796426">*</span><span class="ident" id="3796427">Conn</span><span class="op" id="3796431">)</span>&nbsp;<span class="ident" id="3796433">readRecord</span><span class="op" id="3796443">(</span><span class="ident" id="3796444">want</span>&nbsp;<span class="ident" id="3796449">recordType</span><span class="op" id="3796459">)</span>&nbsp;<span class="builtintype" id="3796461">error</span>&nbsp;<span class="op" id="3796467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3796470">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3796514">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3796565">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796627">switch</span>&nbsp;<span class="ident" id="3796634">want</span>&nbsp;<span class="op" id="3796639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796642">default</span><span class="op" id="3796649">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3796653">c</span><span class="op" id="3796654">.</span><span class="ident" id="3796655">sendAlert</span><span class="op" id="3796664">(</span><span class="ident" id="3796665">alertInternalError</span><span class="op" id="3796683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796687">return</span>&nbsp;<span class="ident" id="3796694">c</span><span class="op" id="3796695">.</span><span class="ident" id="3796696">in</span><span class="op" id="3796698">.</span><span class="ident" id="3796699">setErrorLocked</span><span class="op" id="3796713">(</span><span class="ident" id="3796714">errors</span><span class="op" id="3796720">.</span><span class="ident" id="3796721">New</span><span class="op" id="3796724">(</span><span class="string" id="3796725">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3796761">)</span><span class="op" id="3796762">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796765">case</span>&nbsp;<span class="ident" id="3796770">recordTypeHandshake</span><span class="op" id="3796789">,</span>&nbsp;<span class="ident" id="3796791">recordTypeChangeCipherSpec</span><span class="op" id="3796817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796821">if</span>&nbsp;<span class="ident" id="3796824">c</span><span class="op" id="3796825">.</span><span class="ident" id="3796826">handshakeComplete</span>&nbsp;<span class="op" id="3796844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3796849">c</span><span class="op" id="3796850">.</span><span class="ident" id="3796851">sendAlert</span><span class="op" id="3796860">(</span><span class="ident" id="3796861">alertInternalError</span><span class="op" id="3796879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3796884">return</span>&nbsp;<span class="ident" id="3796891">c</span><span class="op" id="3796892">.</span><span class="ident" id="3796893">in</span><span class="op" id="3796895">.</span><span class="ident" id="3796896">setErrorLocked</span><span class="op" id="3796910">(</span><span class="ident" id="3796911">errors</span><span class="op" id="3796917">.</span><span class="ident" id="3796918">New</span><span class="op" id="3796921">(</span><span class="string" id="3796922">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3796993">)</span><span class="op" id="3796994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3796998">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797001">case</span>&nbsp;<span class="ident" id="3797006">recordTypeApplicationData</span><span class="op" id="3797031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797035">if</span>&nbsp;<span class="op" id="3797038">!</span><span class="ident" id="3797039">c</span><span class="op" id="3797040">.</span><span class="ident" id="3797041">handshakeComplete</span>&nbsp;<span class="op" id="3797059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3797064">c</span><span class="op" id="3797065">.</span><span class="ident" id="3797066">sendAlert</span><span class="op" id="3797075">(</span><span class="ident" id="3797076">alertInternalError</span><span class="op" id="3797094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797099">return</span>&nbsp;<span class="ident" id="3797106">c</span><span class="op" id="3797107">.</span><span class="ident" id="3797108">in</span><span class="op" id="3797110">.</span><span class="ident" id="3797111">setErrorLocked</span><span class="op" id="3797125">(</span><span class="ident" id="3797126">errors</span><span class="op" id="3797132">.</span><span class="ident" id="3797133">New</span><span class="op" id="3797136">(</span><span class="string" id="3797137">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3797203">)</span><span class="op" id="3797204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3797208">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3797211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3797214">Again</span><span class="op" id="3797219">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797222">if</span>&nbsp;<span class="ident" id="3797225">c</span><span class="op" id="3797226">.</span><span class="ident" id="3797227">rawInput</span>&nbsp;<span class="op" id="3797236">==</span>&nbsp;<span class="ident" id="3797239">nil</span>&nbsp;<span class="op" id="3797243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3797247">c</span><span class="op" id="3797248">.</span><span class="ident" id="3797249">rawInput</span>&nbsp;<span class="op" id="3797258">=</span>&nbsp;<span class="ident" id="3797260">c</span><span class="op" id="3797261">.</span><span class="ident" id="3797262">in</span><span class="op" id="3797264">.</span><span class="ident" id="3797265">newBlock</span><span class="op" id="3797273">(</span><span class="op" id="3797274">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3797277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3797280">b</span>&nbsp;<span class="op" id="3797282">:=</span>&nbsp;<span class="ident" id="3797285">c</span><span class="op" id="3797286">.</span><span class="ident" id="3797287">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797298">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797324">if</span>&nbsp;<span class="ident" id="3797327">err</span>&nbsp;<span class="op" id="3797331">:=</span>&nbsp;<span class="ident" id="3797334">b</span><span class="op" id="3797335">.</span><span class="ident" id="3797336">readFromUntil</span><span class="op" id="3797349">(</span><span class="ident" id="3797350">c</span><span class="op" id="3797351">.</span><span class="ident" id="3797352">conn</span><span class="op" id="3797356">,</span>&nbsp;<span class="ident" id="3797358">recordHeaderLen</span><span class="op" id="3797373">)</span><span class="op" id="3797374">;</span>&nbsp;<span class="ident" id="3797376">err</span>&nbsp;<span class="op" id="3797380">!=</span>&nbsp;<span class="ident" id="3797383">nil</span>&nbsp;<span class="op" id="3797387">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797391">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797449">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797503">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797538">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797562">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797594">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797601">if</span>&nbsp;<span class="ident" id="3797604">e</span><span class="op" id="3797605">,</span>&nbsp;<span class="ident" id="3797607">ok</span>&nbsp;<span class="op" id="3797610">:=</span>&nbsp;<span class="ident" id="3797613">err</span><span class="op" id="3797616">.</span><span class="op" id="3797617">(</span><span class="ident" id="3797618">net</span><span class="op" id="3797621">.</span><span class="ident" id="3797622">Error</span><span class="op" id="3797627">)</span><span class="op" id="3797628">;</span>&nbsp;<span class="op" id="3797630">!</span><span class="ident" id="3797631">ok</span>&nbsp;<span class="op" id="3797634">||</span>&nbsp;<span class="op" id="3797637">!</span><span class="ident" id="3797638">e</span><span class="op" id="3797639">.</span><span class="ident" id="3797640">Temporary</span><span class="op" id="3797649">(</span><span class="op" id="3797650">)</span>&nbsp;<span class="op" id="3797652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3797657">c</span><span class="op" id="3797658">.</span><span class="ident" id="3797659">in</span><span class="op" id="3797661">.</span><span class="ident" id="3797662">setErrorLocked</span><span class="op" id="3797676">(</span><span class="ident" id="3797677">err</span><span class="op" id="3797680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3797684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797688">return</span>&nbsp;<span class="ident" id="3797695">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3797700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3797703">typ</span>&nbsp;<span class="op" id="3797707">:=</span>&nbsp;<span class="ident" id="3797710">recordType</span><span class="op" id="3797720">(</span><span class="ident" id="3797721">b</span><span class="op" id="3797722">.</span><span class="ident" id="3797723">data</span><span class="op" id="3797727">[</span><span class="num" id="3797728">0</span><span class="op" id="3797729">]</span><span class="op" id="3797730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797734">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797803">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797876">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3797948">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3797969">if</span>&nbsp;<span class="ident" id="3797972">want</span>&nbsp;<span class="op" id="3797977">==</span>&nbsp;<span class="ident" id="3797980">recordTypeHandshake</span>&nbsp;<span class="op" id="3798000">&amp;&amp;</span>&nbsp;<span class="ident" id="3798003">typ</span>&nbsp;<span class="op" id="3798007">==</span>&nbsp;<span class="num" id="3798010">0x80</span>&nbsp;<span class="op" id="3798015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3798019">c</span><span class="op" id="3798020">.</span><span class="ident" id="3798021">sendAlert</span><span class="op" id="3798030">(</span><span class="ident" id="3798031">alertProtocolVersion</span><span class="op" id="3798051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798055">return</span>&nbsp;<span class="ident" id="3798062">c</span><span class="op" id="3798063">.</span><span class="ident" id="3798064">in</span><span class="op" id="3798066">.</span><span class="ident" id="3798067">setErrorLocked</span><span class="op" id="3798081">(</span><span class="ident" id="3798082">errors</span><span class="op" id="3798088">.</span><span class="ident" id="3798089">New</span><span class="op" id="3798092">(</span><span class="string" id="3798093">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3798136">)</span><span class="op" id="3798137">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3798140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3798144">vers</span>&nbsp;<span class="op" id="3798149">:=</span>&nbsp;<span class="builtintype" id="3798152">uint16</span><span class="op" id="3798158">(</span><span class="ident" id="3798159">b</span><span class="op" id="3798160">.</span><span class="ident" id="3798161">data</span><span class="op" id="3798165">[</span><span class="num" id="3798166">1</span><span class="op" id="3798167">]</span><span class="op" id="3798168">)</span><span class="op" id="3798169">&lt;&lt;</span><span class="num" id="3798171">8</span>&nbsp;<span class="op" id="3798173">|</span>&nbsp;<span class="builtintype" id="3798175">uint16</span><span class="op" id="3798181">(</span><span class="ident" id="3798182">b</span><span class="op" id="3798183">.</span><span class="ident" id="3798184">data</span><span class="op" id="3798188">[</span><span class="num" id="3798189">2</span><span class="op" id="3798190">]</span><span class="op" id="3798191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3798194">n</span>&nbsp;<span class="op" id="3798196">:=</span>&nbsp;<span class="builtintype" id="3798199">int</span><span class="op" id="3798202">(</span><span class="ident" id="3798203">b</span><span class="op" id="3798204">.</span><span class="ident" id="3798205">data</span><span class="op" id="3798209">[</span><span class="num" id="3798210">3</span><span class="op" id="3798211">]</span><span class="op" id="3798212">)</span><span class="op" id="3798213">&lt;&lt;</span><span class="num" id="3798215">8</span>&nbsp;<span class="op" id="3798217">|</span>&nbsp;<span class="builtintype" id="3798219">int</span><span class="op" id="3798222">(</span><span class="ident" id="3798223">b</span><span class="op" id="3798224">.</span><span class="ident" id="3798225">data</span><span class="op" id="3798229">[</span><span class="num" id="3798230">4</span><span class="op" id="3798231">]</span><span class="op" id="3798232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798235">if</span>&nbsp;<span class="ident" id="3798238">c</span><span class="op" id="3798239">.</span><span class="ident" id="3798240">haveVers</span>&nbsp;<span class="op" id="3798249">&amp;&amp;</span>&nbsp;<span class="ident" id="3798252">vers</span>&nbsp;<span class="op" id="3798257">!=</span>&nbsp;<span class="ident" id="3798260">c</span><span class="op" id="3798261">.</span><span class="ident" id="3798262">vers</span>&nbsp;<span class="op" id="3798267">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3798271">c</span><span class="op" id="3798272">.</span><span class="ident" id="3798273">sendAlert</span><span class="op" id="3798282">(</span><span class="ident" id="3798283">alertProtocolVersion</span><span class="op" id="3798303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798307">return</span>&nbsp;<span class="ident" id="3798314">c</span><span class="op" id="3798315">.</span><span class="ident" id="3798316">in</span><span class="op" id="3798318">.</span><span class="ident" id="3798319">setErrorLocked</span><span class="op" id="3798333">(</span><span class="ident" id="3798334">fmt</span><span class="op" id="3798337">.</span><span class="ident" id="3798338">Errorf</span><span class="op" id="3798344">(</span><span class="string" id="3798345">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3798409">,</span>&nbsp;<span class="ident" id="3798411">vers</span><span class="op" id="3798415">,</span>&nbsp;<span class="ident" id="3798417">c</span><span class="op" id="3798418">.</span><span class="ident" id="3798419">vers</span><span class="op" id="3798423">)</span><span class="op" id="3798424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3798427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798430">if</span>&nbsp;<span class="ident" id="3798433">n</span>&nbsp;<span class="op" id="3798435">&gt;</span>&nbsp;<span class="ident" id="3798437">maxCiphertext</span>&nbsp;<span class="op" id="3798451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3798455">c</span><span class="op" id="3798456">.</span><span class="ident" id="3798457">sendAlert</span><span class="op" id="3798466">(</span><span class="ident" id="3798467">alertRecordOverflow</span><span class="op" id="3798486">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798490">return</span>&nbsp;<span class="ident" id="3798497">c</span><span class="op" id="3798498">.</span><span class="ident" id="3798499">in</span><span class="op" id="3798501">.</span><span class="ident" id="3798502">setErrorLocked</span><span class="op" id="3798516">(</span><span class="ident" id="3798517">fmt</span><span class="op" id="3798520">.</span><span class="ident" id="3798521">Errorf</span><span class="op" id="3798527">(</span><span class="string" id="3798528">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3798575">,</span>&nbsp;<span class="ident" id="3798577">n</span><span class="op" id="3798578">)</span><span class="op" id="3798579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3798582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798585">if</span>&nbsp;<span class="op" id="3798588">!</span><span class="ident" id="3798589">c</span><span class="op" id="3798590">.</span><span class="ident" id="3798591">haveVers</span>&nbsp;<span class="op" id="3798600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798604">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798645">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798682">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798739">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798776">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798832">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798881">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3798937">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3798966">if</span>&nbsp;<span class="op" id="3798969">(</span><span class="ident" id="3798970">typ</span>&nbsp;<span class="op" id="3798974">!=</span>&nbsp;<span class="ident" id="3798977">recordTypeAlert</span>&nbsp;<span class="op" id="3798993">&amp;&amp;</span>&nbsp;<span class="ident" id="3798996">typ</span>&nbsp;<span class="op" id="3799000">!=</span>&nbsp;<span class="ident" id="3799003">want</span><span class="op" id="3799007">)</span>&nbsp;<span class="op" id="3799009">||</span>&nbsp;<span class="ident" id="3799012">vers</span>&nbsp;<span class="op" id="3799017">&gt;=</span>&nbsp;<span class="num" id="3799020">0x1000</span>&nbsp;<span class="op" id="3799027">||</span>&nbsp;<span class="ident" id="3799030">n</span>&nbsp;<span class="op" id="3799032">&gt;=</span>&nbsp;<span class="num" id="3799035">0x3000</span>&nbsp;<span class="op" id="3799042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799047">c</span><span class="op" id="3799048">.</span><span class="ident" id="3799049">sendAlert</span><span class="op" id="3799058">(</span><span class="ident" id="3799059">alertUnexpectedMessage</span><span class="op" id="3799081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799086">return</span>&nbsp;<span class="ident" id="3799093">c</span><span class="op" id="3799094">.</span><span class="ident" id="3799095">in</span><span class="op" id="3799097">.</span><span class="ident" id="3799098">setErrorLocked</span><span class="op" id="3799112">(</span><span class="ident" id="3799113">fmt</span><span class="op" id="3799116">.</span><span class="ident" id="3799117">Errorf</span><span class="op" id="3799123">(</span><span class="string" id="3799124">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3799178">)</span><span class="op" id="3799179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799183">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799189">if</span>&nbsp;<span class="ident" id="3799192">err</span>&nbsp;<span class="op" id="3799196">:=</span>&nbsp;<span class="ident" id="3799199">b</span><span class="op" id="3799200">.</span><span class="ident" id="3799201">readFromUntil</span><span class="op" id="3799214">(</span><span class="ident" id="3799215">c</span><span class="op" id="3799216">.</span><span class="ident" id="3799217">conn</span><span class="op" id="3799221">,</span>&nbsp;<span class="ident" id="3799223">recordHeaderLen</span><span class="op" id="3799238">+</span><span class="ident" id="3799239">n</span><span class="op" id="3799240">)</span><span class="op" id="3799241">;</span>&nbsp;<span class="ident" id="3799243">err</span>&nbsp;<span class="op" id="3799247">!=</span>&nbsp;<span class="ident" id="3799250">nil</span>&nbsp;<span class="op" id="3799254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799258">if</span>&nbsp;<span class="ident" id="3799261">err</span>&nbsp;<span class="op" id="3799265">==</span>&nbsp;<span class="ident" id="3799268">io</span><span class="op" id="3799270">.</span><span class="ident" id="3799271">EOF</span>&nbsp;<span class="op" id="3799275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799280">err</span>&nbsp;<span class="op" id="3799284">=</span>&nbsp;<span class="ident" id="3799286">io</span><span class="op" id="3799288">.</span><span class="ident" id="3799289">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799308">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799312">if</span>&nbsp;<span class="ident" id="3799315">e</span><span class="op" id="3799316">,</span>&nbsp;<span class="ident" id="3799318">ok</span>&nbsp;<span class="op" id="3799321">:=</span>&nbsp;<span class="ident" id="3799324">err</span><span class="op" id="3799327">.</span><span class="op" id="3799328">(</span><span class="ident" id="3799329">net</span><span class="op" id="3799332">.</span><span class="ident" id="3799333">Error</span><span class="op" id="3799338">)</span><span class="op" id="3799339">;</span>&nbsp;<span class="op" id="3799341">!</span><span class="ident" id="3799342">ok</span>&nbsp;<span class="op" id="3799345">||</span>&nbsp;<span class="op" id="3799348">!</span><span class="ident" id="3799349">e</span><span class="op" id="3799350">.</span><span class="ident" id="3799351">Temporary</span><span class="op" id="3799360">(</span><span class="op" id="3799361">)</span>&nbsp;<span class="op" id="3799363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799368">c</span><span class="op" id="3799369">.</span><span class="ident" id="3799370">in</span><span class="op" id="3799372">.</span><span class="ident" id="3799373">setErrorLocked</span><span class="op" id="3799387">(</span><span class="ident" id="3799388">err</span><span class="op" id="3799391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799399">return</span>&nbsp;<span class="ident" id="3799406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799411">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3799415">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799436">b</span><span class="op" id="3799437">,</span>&nbsp;<span class="ident" id="3799439">c</span><span class="op" id="3799440">.</span><span class="ident" id="3799441">rawInput</span>&nbsp;<span class="op" id="3799450">=</span>&nbsp;<span class="ident" id="3799452">c</span><span class="op" id="3799453">.</span><span class="ident" id="3799454">in</span><span class="op" id="3799456">.</span><span class="ident" id="3799457">splitBlock</span><span class="op" id="3799467">(</span><span class="ident" id="3799468">b</span><span class="op" id="3799469">,</span>&nbsp;<span class="ident" id="3799471">recordHeaderLen</span><span class="op" id="3799486">+</span><span class="ident" id="3799487">n</span><span class="op" id="3799488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799491">ok</span><span class="op" id="3799493">,</span>&nbsp;<span class="ident" id="3799495">off</span><span class="op" id="3799498">,</span>&nbsp;<span class="ident" id="3799500">err</span>&nbsp;<span class="op" id="3799504">:=</span>&nbsp;<span class="ident" id="3799507">c</span><span class="op" id="3799508">.</span><span class="ident" id="3799509">in</span><span class="op" id="3799511">.</span><span class="ident" id="3799512">decrypt</span><span class="op" id="3799519">(</span><span class="ident" id="3799520">b</span><span class="op" id="3799521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799524">if</span>&nbsp;<span class="op" id="3799527">!</span><span class="ident" id="3799528">ok</span>&nbsp;<span class="op" id="3799531">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799535">c</span><span class="op" id="3799536">.</span><span class="ident" id="3799537">in</span><span class="op" id="3799539">.</span><span class="ident" id="3799540">setErrorLocked</span><span class="op" id="3799554">(</span><span class="ident" id="3799555">c</span><span class="op" id="3799556">.</span><span class="ident" id="3799557">sendAlert</span><span class="op" id="3799566">(</span><span class="ident" id="3799567">err</span><span class="op" id="3799570">)</span><span class="op" id="3799571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799577">b</span><span class="op" id="3799578">.</span><span class="ident" id="3799579">off</span>&nbsp;<span class="op" id="3799583">=</span>&nbsp;<span class="ident" id="3799585">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799590">data</span>&nbsp;<span class="op" id="3799595">:=</span>&nbsp;<span class="ident" id="3799598">b</span><span class="op" id="3799599">.</span><span class="ident" id="3799600">data</span><span class="op" id="3799604">[</span><span class="ident" id="3799605">b</span><span class="op" id="3799606">.</span><span class="ident" id="3799607">off</span><span class="op" id="3799610">:</span><span class="op" id="3799611">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799614">if</span>&nbsp;<span class="builtinfunc" id="3799617">len</span><span class="op" id="3799620">(</span><span class="ident" id="3799621">data</span><span class="op" id="3799625">)</span>&nbsp;<span class="op" id="3799627">&gt;</span>&nbsp;<span class="ident" id="3799629">maxPlaintext</span>&nbsp;<span class="op" id="3799642">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799646">err</span>&nbsp;<span class="op" id="3799650">:=</span>&nbsp;<span class="ident" id="3799653">c</span><span class="op" id="3799654">.</span><span class="ident" id="3799655">sendAlert</span><span class="op" id="3799664">(</span><span class="ident" id="3799665">alertRecordOverflow</span><span class="op" id="3799684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799688">c</span><span class="op" id="3799689">.</span><span class="ident" id="3799690">in</span><span class="op" id="3799692">.</span><span class="ident" id="3799693">freeBlock</span><span class="op" id="3799702">(</span><span class="ident" id="3799703">b</span><span class="op" id="3799704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799708">return</span>&nbsp;<span class="ident" id="3799715">c</span><span class="op" id="3799716">.</span><span class="ident" id="3799717">in</span><span class="op" id="3799719">.</span><span class="ident" id="3799720">setErrorLocked</span><span class="op" id="3799734">(</span><span class="ident" id="3799735">err</span><span class="op" id="3799738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799745">switch</span>&nbsp;<span class="ident" id="3799752">typ</span>&nbsp;<span class="op" id="3799756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799759">default</span><span class="op" id="3799766">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799770">c</span><span class="op" id="3799771">.</span><span class="ident" id="3799772">in</span><span class="op" id="3799774">.</span><span class="ident" id="3799775">setErrorLocked</span><span class="op" id="3799789">(</span><span class="ident" id="3799790">c</span><span class="op" id="3799791">.</span><span class="ident" id="3799792">sendAlert</span><span class="op" id="3799801">(</span><span class="ident" id="3799802">alertUnexpectedMessage</span><span class="op" id="3799824">)</span><span class="op" id="3799825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799829">case</span>&nbsp;<span class="ident" id="3799834">recordTypeAlert</span><span class="op" id="3799849">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799853">if</span>&nbsp;<span class="builtinfunc" id="3799856">len</span><span class="op" id="3799859">(</span><span class="ident" id="3799860">data</span><span class="op" id="3799864">)</span>&nbsp;<span class="op" id="3799866">!=</span>&nbsp;<span class="num" id="3799869">2</span>&nbsp;<span class="op" id="3799871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799876">c</span><span class="op" id="3799877">.</span><span class="ident" id="3799878">in</span><span class="op" id="3799880">.</span><span class="ident" id="3799881">setErrorLocked</span><span class="op" id="3799895">(</span><span class="ident" id="3799896">c</span><span class="op" id="3799897">.</span><span class="ident" id="3799898">sendAlert</span><span class="op" id="3799907">(</span><span class="ident" id="3799908">alertUnexpectedMessage</span><span class="op" id="3799930">)</span><span class="op" id="3799931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799936">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3799944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3799948">if</span>&nbsp;<span class="ident" id="3799951">alert</span><span class="op" id="3799956">(</span><span class="ident" id="3799957">data</span><span class="op" id="3799961">[</span><span class="num" id="3799962">1</span><span class="op" id="3799963">]</span><span class="op" id="3799964">)</span>&nbsp;<span class="op" id="3799966">==</span>&nbsp;<span class="ident" id="3799969">alertCloseNotify</span>&nbsp;<span class="op" id="3799986">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3799991">c</span><span class="op" id="3799992">.</span><span class="ident" id="3799993">in</span><span class="op" id="3799995">.</span><span class="ident" id="3799996">setErrorLocked</span><span class="op" id="3800010">(</span><span class="ident" id="3800011">io</span><span class="op" id="3800013">.</span><span class="ident" id="3800014">EOF</span><span class="op" id="3800017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800022">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800034">switch</span>&nbsp;<span class="ident" id="3800041">data</span><span class="op" id="3800045">[</span><span class="num" id="3800046">0</span><span class="op" id="3800047">]</span>&nbsp;<span class="op" id="3800049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800053">case</span>&nbsp;<span class="ident" id="3800058">alertLevelWarning</span><span class="op" id="3800075">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3800080">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800104">c</span><span class="op" id="3800105">.</span><span class="ident" id="3800106">in</span><span class="op" id="3800108">.</span><span class="ident" id="3800109">freeBlock</span><span class="op" id="3800118">(</span><span class="ident" id="3800119">b</span><span class="op" id="3800120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800125">goto</span>&nbsp;<span class="ident" id="3800130">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800138">case</span>&nbsp;<span class="ident" id="3800143">alertLevelError</span><span class="op" id="3800158">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800163">c</span><span class="op" id="3800164">.</span><span class="ident" id="3800165">in</span><span class="op" id="3800167">.</span><span class="ident" id="3800168">setErrorLocked</span><span class="op" id="3800182">(</span><span class="op" id="3800183">&amp;</span><span class="ident" id="3800184">net</span><span class="op" id="3800187">.</span><span class="ident" id="3800188">OpError</span><span class="op" id="3800195">{</span><span class="ident" id="3800196">Op</span><span class="op" id="3800198">:</span>&nbsp;<span class="string" id="3800200">&#34;remote&nbsp;error&#34;</span><span class="op" id="3800214">,</span>&nbsp;<span class="ident" id="3800216">Err</span><span class="op" id="3800219">:</span>&nbsp;<span class="ident" id="3800221">alert</span><span class="op" id="3800226">(</span><span class="ident" id="3800227">data</span><span class="op" id="3800231">[</span><span class="num" id="3800232">1</span><span class="op" id="3800233">]</span><span class="op" id="3800234">)</span><span class="op" id="3800235">}</span><span class="op" id="3800236">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800240">default</span><span class="op" id="3800247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800252">c</span><span class="op" id="3800253">.</span><span class="ident" id="3800254">in</span><span class="op" id="3800256">.</span><span class="ident" id="3800257">setErrorLocked</span><span class="op" id="3800271">(</span><span class="ident" id="3800272">c</span><span class="op" id="3800273">.</span><span class="ident" id="3800274">sendAlert</span><span class="op" id="3800283">(</span><span class="ident" id="3800284">alertUnexpectedMessage</span><span class="op" id="3800306">)</span><span class="op" id="3800307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800315">case</span>&nbsp;<span class="ident" id="3800320">recordTypeChangeCipherSpec</span><span class="op" id="3800346">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800350">if</span>&nbsp;<span class="ident" id="3800353">typ</span>&nbsp;<span class="op" id="3800357">!=</span>&nbsp;<span class="ident" id="3800360">want</span>&nbsp;<span class="op" id="3800365">||</span>&nbsp;<span class="builtinfunc" id="3800368">len</span><span class="op" id="3800371">(</span><span class="ident" id="3800372">data</span><span class="op" id="3800376">)</span>&nbsp;<span class="op" id="3800378">!=</span>&nbsp;<span class="num" id="3800381">1</span>&nbsp;<span class="op" id="3800383">||</span>&nbsp;<span class="ident" id="3800386">data</span><span class="op" id="3800390">[</span><span class="num" id="3800391">0</span><span class="op" id="3800392">]</span>&nbsp;<span class="op" id="3800394">!=</span>&nbsp;<span class="num" id="3800397">1</span>&nbsp;<span class="op" id="3800399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800404">c</span><span class="op" id="3800405">.</span><span class="ident" id="3800406">in</span><span class="op" id="3800408">.</span><span class="ident" id="3800409">setErrorLocked</span><span class="op" id="3800423">(</span><span class="ident" id="3800424">c</span><span class="op" id="3800425">.</span><span class="ident" id="3800426">sendAlert</span><span class="op" id="3800435">(</span><span class="ident" id="3800436">alertUnexpectedMessage</span><span class="op" id="3800458">)</span><span class="op" id="3800459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800464">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800476">err</span>&nbsp;<span class="op" id="3800480">:=</span>&nbsp;<span class="ident" id="3800483">c</span><span class="op" id="3800484">.</span><span class="ident" id="3800485">in</span><span class="op" id="3800487">.</span><span class="ident" id="3800488">changeCipherSpec</span><span class="op" id="3800504">(</span><span class="op" id="3800505">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800509">if</span>&nbsp;<span class="ident" id="3800512">err</span>&nbsp;<span class="op" id="3800516">!=</span>&nbsp;<span class="ident" id="3800519">nil</span>&nbsp;<span class="op" id="3800523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800528">c</span><span class="op" id="3800529">.</span><span class="ident" id="3800530">in</span><span class="op" id="3800532">.</span><span class="ident" id="3800533">setErrorLocked</span><span class="op" id="3800547">(</span><span class="ident" id="3800548">c</span><span class="op" id="3800549">.</span><span class="ident" id="3800550">sendAlert</span><span class="op" id="3800559">(</span><span class="ident" id="3800560">err</span><span class="op" id="3800563">.</span><span class="op" id="3800564">(</span><span class="ident" id="3800565">alert</span><span class="op" id="3800570">)</span><span class="op" id="3800571">)</span><span class="op" id="3800572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800580">case</span>&nbsp;<span class="ident" id="3800585">recordTypeApplicationData</span><span class="op" id="3800610">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800614">if</span>&nbsp;<span class="ident" id="3800617">typ</span>&nbsp;<span class="op" id="3800621">!=</span>&nbsp;<span class="ident" id="3800624">want</span>&nbsp;<span class="op" id="3800629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800634">c</span><span class="op" id="3800635">.</span><span class="ident" id="3800636">in</span><span class="op" id="3800638">.</span><span class="ident" id="3800639">setErrorLocked</span><span class="op" id="3800653">(</span><span class="ident" id="3800654">c</span><span class="op" id="3800655">.</span><span class="ident" id="3800656">sendAlert</span><span class="op" id="3800665">(</span><span class="ident" id="3800666">alertUnexpectedMessage</span><span class="op" id="3800688">)</span><span class="op" id="3800689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800694">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800706">c</span><span class="op" id="3800707">.</span><span class="ident" id="3800708">input</span>&nbsp;<span class="op" id="3800714">=</span>&nbsp;<span class="ident" id="3800716">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800720">b</span>&nbsp;<span class="op" id="3800722">=</span>&nbsp;<span class="ident" id="3800724">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800730">case</span>&nbsp;<span class="ident" id="3800735">recordTypeHandshake</span><span class="op" id="3800754">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3800758">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800817">if</span>&nbsp;<span class="ident" id="3800820">typ</span>&nbsp;<span class="op" id="3800824">!=</span>&nbsp;<span class="ident" id="3800827">want</span>&nbsp;<span class="op" id="3800832">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800837">return</span>&nbsp;<span class="ident" id="3800844">c</span><span class="op" id="3800845">.</span><span class="ident" id="3800846">in</span><span class="op" id="3800848">.</span><span class="ident" id="3800849">setErrorLocked</span><span class="op" id="3800863">(</span><span class="ident" id="3800864">c</span><span class="op" id="3800865">.</span><span class="ident" id="3800866">sendAlert</span><span class="op" id="3800875">(</span><span class="ident" id="3800876">alertNoRenegotiation</span><span class="op" id="3800896">)</span><span class="op" id="3800897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800905">c</span><span class="op" id="3800906">.</span><span class="ident" id="3800907">hand</span><span class="op" id="3800911">.</span><span class="ident" id="3800912">Write</span><span class="op" id="3800917">(</span><span class="ident" id="3800918">data</span><span class="op" id="3800922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800929">if</span>&nbsp;<span class="ident" id="3800932">b</span>&nbsp;<span class="op" id="3800934">!=</span>&nbsp;<span class="ident" id="3800937">nil</span>&nbsp;<span class="op" id="3800941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3800945">c</span><span class="op" id="3800946">.</span><span class="ident" id="3800947">in</span><span class="op" id="3800949">.</span><span class="ident" id="3800950">freeBlock</span><span class="op" id="3800959">(</span><span class="ident" id="3800960">b</span><span class="op" id="3800961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3800964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3800967">return</span>&nbsp;<span class="ident" id="3800974">c</span><span class="op" id="3800975">.</span><span class="ident" id="3800976">in</span><span class="op" id="3800978">.</span><span class="ident" id="3800979">err</span><br>
<span class="lineno"></span><span class="op" id="3800983">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3800986">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3801026">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3801047">func</span>&nbsp;<span class="op" id="3801052">(</span><span class="ident" id="3801053">c</span>&nbsp;<span class="op" id="3801055">*</span><span class="ident" id="3801056">Conn</span><span class="op" id="3801060">)</span>&nbsp;<span class="ident" id="3801062">sendAlertLocked</span><span class="op" id="3801077">(</span><span class="ident" id="3801078">err</span>&nbsp;<span class="ident" id="3801082">alert</span><span class="op" id="3801087">)</span>&nbsp;<span class="builtintype" id="3801089">error</span>&nbsp;<span class="op" id="3801095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801098">switch</span>&nbsp;<span class="ident" id="3801105">err</span>&nbsp;<span class="op" id="3801109">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801112">case</span>&nbsp;<span class="ident" id="3801117">alertNoRenegotiation</span><span class="op" id="3801137">,</span>&nbsp;<span class="ident" id="3801139">alertCloseNotify</span><span class="op" id="3801155">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801159">c</span><span class="op" id="3801160">.</span><span class="ident" id="3801161">tmp</span><span class="op" id="3801164">[</span><span class="num" id="3801165">0</span><span class="op" id="3801166">]</span>&nbsp;<span class="op" id="3801168">=</span>&nbsp;<span class="ident" id="3801170">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801189">default</span><span class="op" id="3801196">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801200">c</span><span class="op" id="3801201">.</span><span class="ident" id="3801202">tmp</span><span class="op" id="3801205">[</span><span class="num" id="3801206">0</span><span class="op" id="3801207">]</span>&nbsp;<span class="op" id="3801209">=</span>&nbsp;<span class="ident" id="3801211">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3801228">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801231">c</span><span class="op" id="3801232">.</span><span class="ident" id="3801233">tmp</span><span class="op" id="3801236">[</span><span class="num" id="3801237">1</span><span class="op" id="3801238">]</span>&nbsp;<span class="op" id="3801240">=</span>&nbsp;<span class="builtintype" id="3801242">byte</span><span class="op" id="3801246">(</span><span class="ident" id="3801247">err</span><span class="op" id="3801250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801253">c</span><span class="op" id="3801254">.</span><span class="ident" id="3801255">writeRecord</span><span class="op" id="3801266">(</span><span class="ident" id="3801267">recordTypeAlert</span><span class="op" id="3801282">,</span>&nbsp;<span class="ident" id="3801284">c</span><span class="op" id="3801285">.</span><span class="ident" id="3801286">tmp</span><span class="op" id="3801289">[</span><span class="num" id="3801290">0</span><span class="op" id="3801291">:</span><span class="num" id="3801292">2</span><span class="op" id="3801293">]</span><span class="op" id="3801294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3801297">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801358">if</span>&nbsp;<span class="ident" id="3801361">err</span>&nbsp;<span class="op" id="3801365">!=</span>&nbsp;<span class="ident" id="3801368">alertCloseNotify</span>&nbsp;<span class="op" id="3801385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801389">return</span>&nbsp;<span class="ident" id="3801396">c</span><span class="op" id="3801397">.</span><span class="ident" id="3801398">out</span><span class="op" id="3801401">.</span><span class="ident" id="3801402">setErrorLocked</span><span class="op" id="3801416">(</span><span class="op" id="3801417">&amp;</span><span class="ident" id="3801418">net</span><span class="op" id="3801421">.</span><span class="ident" id="3801422">OpError</span><span class="op" id="3801429">{</span><span class="ident" id="3801430">Op</span><span class="op" id="3801432">:</span>&nbsp;<span class="string" id="3801434">&#34;local&nbsp;error&#34;</span><span class="op" id="3801447">,</span>&nbsp;<span class="ident" id="3801449">Err</span><span class="op" id="3801452">:</span>&nbsp;<span class="ident" id="3801454">err</span><span class="op" id="3801457">}</span><span class="op" id="3801458">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3801461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801464">return</span>&nbsp;<span class="ident" id="3801471">nil</span><br>
<span class="lineno"></span><span class="op" id="3801475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3801478">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3801518">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3801538">func</span>&nbsp;<span class="op" id="3801543">(</span><span class="ident" id="3801544">c</span>&nbsp;<span class="op" id="3801546">*</span><span class="ident" id="3801547">Conn</span><span class="op" id="3801551">)</span>&nbsp;<span class="ident" id="3801553">sendAlert</span><span class="op" id="3801562">(</span><span class="ident" id="3801563">err</span>&nbsp;<span class="ident" id="3801567">alert</span><span class="op" id="3801572">)</span>&nbsp;<span class="builtintype" id="3801574">error</span>&nbsp;<span class="op" id="3801580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801583">c</span><span class="op" id="3801584">.</span><span class="ident" id="3801585">out</span><span class="op" id="3801588">.</span><span class="ident" id="3801589">Lock</span><span class="op" id="3801593">(</span><span class="op" id="3801594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801597">defer</span>&nbsp;<span class="ident" id="3801603">c</span><span class="op" id="3801604">.</span><span class="ident" id="3801605">out</span><span class="op" id="3801608">.</span><span class="ident" id="3801609">Unlock</span><span class="op" id="3801615">(</span><span class="op" id="3801616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801619">return</span>&nbsp;<span class="ident" id="3801626">c</span><span class="op" id="3801627">.</span><span class="ident" id="3801628">sendAlertLocked</span><span class="op" id="3801643">(</span><span class="ident" id="3801644">err</span><span class="op" id="3801647">)</span><br>
<span class="lineno">690</span><span class="op" id="3801649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3801652">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3801719">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3801776">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3801797">func</span>&nbsp;<span class="op" id="3801802">(</span><span class="ident" id="3801803">c</span>&nbsp;<span class="op" id="3801805">*</span><span class="ident" id="3801806">Conn</span><span class="op" id="3801810">)</span>&nbsp;<span class="ident" id="3801812">writeRecord</span><span class="op" id="3801823">(</span><span class="ident" id="3801824">typ</span>&nbsp;<span class="ident" id="3801828">recordType</span><span class="op" id="3801838">,</span>&nbsp;<span class="ident" id="3801840">data</span>&nbsp;<span class="op" id="3801845">[</span><span class="op" id="3801846">]</span><span class="builtintype" id="3801847">byte</span><span class="op" id="3801851">)</span>&nbsp;<span class="op" id="3801853">(</span><span class="ident" id="3801854">n</span>&nbsp;<span class="builtintype" id="3801856">int</span><span class="op" id="3801859">,</span>&nbsp;<span class="ident" id="3801861">err</span>&nbsp;<span class="builtintype" id="3801865">error</span><span class="op" id="3801870">)</span>&nbsp;<span class="op" id="3801872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801875">b</span>&nbsp;<span class="op" id="3801877">:=</span>&nbsp;<span class="ident" id="3801880">c</span><span class="op" id="3801881">.</span><span class="ident" id="3801882">out</span><span class="op" id="3801885">.</span><span class="ident" id="3801886">newBlock</span><span class="op" id="3801894">(</span><span class="op" id="3801895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801898">for</span>&nbsp;<span class="builtinfunc" id="3801902">len</span><span class="op" id="3801905">(</span><span class="ident" id="3801906">data</span><span class="op" id="3801910">)</span>&nbsp;<span class="op" id="3801912">&gt;</span>&nbsp;<span class="num" id="3801914">0</span>&nbsp;<span class="op" id="3801916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801920">m</span>&nbsp;<span class="op" id="3801922">:=</span>&nbsp;<span class="builtinfunc" id="3801925">len</span><span class="op" id="3801928">(</span><span class="ident" id="3801929">data</span><span class="op" id="3801933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3801937">if</span>&nbsp;<span class="ident" id="3801940">m</span>&nbsp;<span class="op" id="3801942">&gt;</span>&nbsp;<span class="ident" id="3801944">maxPlaintext</span>&nbsp;<span class="op" id="3801957">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801962">m</span>&nbsp;<span class="op" id="3801964">=</span>&nbsp;<span class="ident" id="3801966">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3801981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3801985">explicitIVLen</span>&nbsp;<span class="op" id="3801999">:=</span>&nbsp;<span class="num" id="3802002">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802006">explicitIVIsSeq</span>&nbsp;<span class="op" id="3802022">:=</span>&nbsp;<span class="builtintype" id="3802025">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802034">var</span>&nbsp;<span class="ident" id="3802038">cbc</span>&nbsp;<span class="ident" id="3802042">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802052">if</span>&nbsp;<span class="ident" id="3802055">c</span><span class="op" id="3802056">.</span><span class="ident" id="3802057">out</span><span class="op" id="3802060">.</span><span class="ident" id="3802061">version</span>&nbsp;<span class="op" id="3802069">&gt;=</span>&nbsp;<span class="ident" id="3802072">VersionTLS11</span>&nbsp;<span class="op" id="3802085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802090">var</span>&nbsp;<span class="ident" id="3802094">ok</span>&nbsp;<span class="builtintype" id="3802097">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802105">if</span>&nbsp;<span class="ident" id="3802108">cbc</span><span class="op" id="3802111">,</span>&nbsp;<span class="ident" id="3802113">ok</span>&nbsp;<span class="op" id="3802116">=</span>&nbsp;<span class="ident" id="3802118">c</span><span class="op" id="3802119">.</span><span class="ident" id="3802120">out</span><span class="op" id="3802123">.</span><span class="ident" id="3802124">cipher</span><span class="op" id="3802130">.</span><span class="op" id="3802131">(</span><span class="ident" id="3802132">cbcMode</span><span class="op" id="3802139">)</span><span class="op" id="3802140">;</span>&nbsp;<span class="ident" id="3802142">ok</span>&nbsp;<span class="op" id="3802145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802151">explicitIVLen</span>&nbsp;<span class="op" id="3802165">=</span>&nbsp;<span class="ident" id="3802167">cbc</span><span class="op" id="3802170">.</span><span class="ident" id="3802171">BlockSize</span><span class="op" id="3802180">(</span><span class="op" id="3802181">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3802186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3802190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802194">if</span>&nbsp;<span class="ident" id="3802197">explicitIVLen</span>&nbsp;<span class="op" id="3802211">==</span>&nbsp;<span class="num" id="3802214">0</span>&nbsp;<span class="op" id="3802216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802221">if</span>&nbsp;<span class="ident" id="3802224">_</span><span class="op" id="3802225">,</span>&nbsp;<span class="ident" id="3802227">ok</span>&nbsp;<span class="op" id="3802230">:=</span>&nbsp;<span class="ident" id="3802233">c</span><span class="op" id="3802234">.</span><span class="ident" id="3802235">out</span><span class="op" id="3802238">.</span><span class="ident" id="3802239">cipher</span><span class="op" id="3802245">.</span><span class="op" id="3802246">(</span><span class="ident" id="3802247">cipher</span><span class="op" id="3802253">.</span><span class="ident" id="3802254">AEAD</span><span class="op" id="3802258">)</span><span class="op" id="3802259">;</span>&nbsp;<span class="ident" id="3802261">ok</span>&nbsp;<span class="op" id="3802264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802270">explicitIVLen</span>&nbsp;<span class="op" id="3802284">=</span>&nbsp;<span class="num" id="3802286">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802292">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802338">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802385">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802435">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802482">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802533">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802554">explicitIVIsSeq</span>&nbsp;<span class="op" id="3802570">=</span>&nbsp;<span class="builtintype" id="3802572">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3802580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3802584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802588">b</span><span class="op" id="3802589">.</span><span class="ident" id="3802590">resize</span><span class="op" id="3802596">(</span><span class="ident" id="3802597">recordHeaderLen</span>&nbsp;<span class="op" id="3802613">+</span>&nbsp;<span class="ident" id="3802615">explicitIVLen</span>&nbsp;<span class="op" id="3802629">+</span>&nbsp;<span class="ident" id="3802631">m</span><span class="op" id="3802632">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802636">b</span><span class="op" id="3802637">.</span><span class="ident" id="3802638">data</span><span class="op" id="3802642">[</span><span class="num" id="3802643">0</span><span class="op" id="3802644">]</span>&nbsp;<span class="op" id="3802646">=</span>&nbsp;<span class="builtintype" id="3802648">byte</span><span class="op" id="3802652">(</span><span class="ident" id="3802653">typ</span><span class="op" id="3802656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802660">vers</span>&nbsp;<span class="op" id="3802665">:=</span>&nbsp;<span class="ident" id="3802668">c</span><span class="op" id="3802669">.</span><span class="ident" id="3802670">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802677">if</span>&nbsp;<span class="ident" id="3802680">vers</span>&nbsp;<span class="op" id="3802685">==</span>&nbsp;<span class="num" id="3802688">0</span>&nbsp;<span class="op" id="3802690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802695">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3802748">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802804">vers</span>&nbsp;<span class="op" id="3802809">=</span>&nbsp;<span class="ident" id="3802811">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3802826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802830">b</span><span class="op" id="3802831">.</span><span class="ident" id="3802832">data</span><span class="op" id="3802836">[</span><span class="num" id="3802837">1</span><span class="op" id="3802838">]</span>&nbsp;<span class="op" id="3802840">=</span>&nbsp;<span class="builtintype" id="3802842">byte</span><span class="op" id="3802846">(</span><span class="ident" id="3802847">vers</span>&nbsp;<span class="op" id="3802852">&gt;&gt;</span>&nbsp;<span class="num" id="3802855">8</span><span class="op" id="3802856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802860">b</span><span class="op" id="3802861">.</span><span class="ident" id="3802862">data</span><span class="op" id="3802866">[</span><span class="num" id="3802867">2</span><span class="op" id="3802868">]</span>&nbsp;<span class="op" id="3802870">=</span>&nbsp;<span class="builtintype" id="3802872">byte</span><span class="op" id="3802876">(</span><span class="ident" id="3802877">vers</span><span class="op" id="3802881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802885">b</span><span class="op" id="3802886">.</span><span class="ident" id="3802887">data</span><span class="op" id="3802891">[</span><span class="num" id="3802892">3</span><span class="op" id="3802893">]</span>&nbsp;<span class="op" id="3802895">=</span>&nbsp;<span class="builtintype" id="3802897">byte</span><span class="op" id="3802901">(</span><span class="ident" id="3802902">m</span>&nbsp;<span class="op" id="3802904">&gt;&gt;</span>&nbsp;<span class="num" id="3802907">8</span><span class="op" id="3802908">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802912">b</span><span class="op" id="3802913">.</span><span class="ident" id="3802914">data</span><span class="op" id="3802918">[</span><span class="num" id="3802919">4</span><span class="op" id="3802920">]</span>&nbsp;<span class="op" id="3802922">=</span>&nbsp;<span class="builtintype" id="3802924">byte</span><span class="op" id="3802928">(</span><span class="ident" id="3802929">m</span><span class="op" id="3802930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3802934">if</span>&nbsp;<span class="ident" id="3802937">explicitIVLen</span>&nbsp;<span class="op" id="3802951">&gt;</span>&nbsp;<span class="num" id="3802953">0</span>&nbsp;<span class="op" id="3802955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3802960">explicitIV</span>&nbsp;<span class="op" id="3802971">:=</span>&nbsp;<span class="ident" id="3802974">b</span><span class="op" id="3802975">.</span><span class="ident" id="3802976">data</span><span class="op" id="3802980">[</span><span class="ident" id="3802981">recordHeaderLen</span>&nbsp;<span class="op" id="3802997">:</span>&nbsp;<span class="ident" id="3802999">recordHeaderLen</span><span class="op" id="3803014">+</span><span class="ident" id="3803015">explicitIVLen</span><span class="op" id="3803028">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803033">if</span>&nbsp;<span class="ident" id="3803036">explicitIVIsSeq</span>&nbsp;<span class="op" id="3803052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3803058">copy</span><span class="op" id="3803062">(</span><span class="ident" id="3803063">explicitIV</span><span class="op" id="3803073">,</span>&nbsp;<span class="ident" id="3803075">c</span><span class="op" id="3803076">.</span><span class="ident" id="3803077">out</span><span class="op" id="3803080">.</span><span class="ident" id="3803081">seq</span><span class="op" id="3803084">[</span><span class="op" id="3803085">:</span><span class="op" id="3803086">]</span><span class="op" id="3803087">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803092">}</span>&nbsp;<span class="keyword" id="3803094">else</span>&nbsp;<span class="op" id="3803099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803105">if</span>&nbsp;<span class="ident" id="3803108">_</span><span class="op" id="3803109">,</span>&nbsp;<span class="ident" id="3803111">err</span>&nbsp;<span class="op" id="3803115">=</span>&nbsp;<span class="ident" id="3803117">io</span><span class="op" id="3803119">.</span><span class="ident" id="3803120">ReadFull</span><span class="op" id="3803128">(</span><span class="ident" id="3803129">c</span><span class="op" id="3803130">.</span><span class="ident" id="3803131">config</span><span class="op" id="3803137">.</span><span class="ident" id="3803138">rand</span><span class="op" id="3803142">(</span><span class="op" id="3803143">)</span><span class="op" id="3803144">,</span>&nbsp;<span class="ident" id="3803146">explicitIV</span><span class="op" id="3803156">)</span><span class="op" id="3803157">;</span>&nbsp;<span class="ident" id="3803159">err</span>&nbsp;<span class="op" id="3803163">!=</span>&nbsp;<span class="ident" id="3803166">nil</span>&nbsp;<span class="op" id="3803170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803177">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803192">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3803200">copy</span><span class="op" id="3803204">(</span><span class="ident" id="3803205">b</span><span class="op" id="3803206">.</span><span class="ident" id="3803207">data</span><span class="op" id="3803211">[</span><span class="ident" id="3803212">recordHeaderLen</span><span class="op" id="3803227">+</span><span class="ident" id="3803228">explicitIVLen</span><span class="op" id="3803241">:</span><span class="op" id="3803242">]</span><span class="op" id="3803243">,</span>&nbsp;<span class="ident" id="3803245">data</span><span class="op" id="3803249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803253">c</span><span class="op" id="3803254">.</span><span class="ident" id="3803255">out</span><span class="op" id="3803258">.</span><span class="ident" id="3803259">encrypt</span><span class="op" id="3803266">(</span><span class="ident" id="3803267">b</span><span class="op" id="3803268">,</span>&nbsp;<span class="ident" id="3803270">explicitIVLen</span><span class="op" id="3803283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803287">_</span><span class="op" id="3803288">,</span>&nbsp;<span class="ident" id="3803290">err</span>&nbsp;<span class="op" id="3803294">=</span>&nbsp;<span class="ident" id="3803296">c</span><span class="op" id="3803297">.</span><span class="ident" id="3803298">conn</span><span class="op" id="3803302">.</span><span class="ident" id="3803303">Write</span><span class="op" id="3803308">(</span><span class="ident" id="3803309">b</span><span class="op" id="3803310">.</span><span class="ident" id="3803311">data</span><span class="op" id="3803315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803319">if</span>&nbsp;<span class="ident" id="3803322">err</span>&nbsp;<span class="op" id="3803326">!=</span>&nbsp;<span class="ident" id="3803329">nil</span>&nbsp;<span class="op" id="3803333">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803338">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803350">n</span>&nbsp;<span class="op" id="3803352">+=</span>&nbsp;<span class="ident" id="3803355">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803359">data</span>&nbsp;<span class="op" id="3803364">=</span>&nbsp;<span class="ident" id="3803366">data</span><span class="op" id="3803370">[</span><span class="ident" id="3803371">m</span><span class="op" id="3803372">:</span><span class="op" id="3803373">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803376">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803379">c</span><span class="op" id="3803380">.</span><span class="ident" id="3803381">out</span><span class="op" id="3803384">.</span><span class="ident" id="3803385">freeBlock</span><span class="op" id="3803394">(</span><span class="ident" id="3803395">b</span><span class="op" id="3803396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803400">if</span>&nbsp;<span class="ident" id="3803403">typ</span>&nbsp;<span class="op" id="3803407">==</span>&nbsp;<span class="ident" id="3803410">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3803437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803441">err</span>&nbsp;<span class="op" id="3803445">=</span>&nbsp;<span class="ident" id="3803447">c</span><span class="op" id="3803448">.</span><span class="ident" id="3803449">out</span><span class="op" id="3803452">.</span><span class="ident" id="3803453">changeCipherSpec</span><span class="op" id="3803469">(</span><span class="op" id="3803470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803474">if</span>&nbsp;<span class="ident" id="3803477">err</span>&nbsp;<span class="op" id="3803481">!=</span>&nbsp;<span class="ident" id="3803484">nil</span>&nbsp;<span class="op" id="3803488">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3803493">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3803531">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803574">c</span><span class="op" id="3803575">.</span><span class="ident" id="3803576">tmp</span><span class="op" id="3803579">[</span><span class="num" id="3803580">0</span><span class="op" id="3803581">]</span>&nbsp;<span class="op" id="3803583">=</span>&nbsp;<span class="ident" id="3803585">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803604">c</span><span class="op" id="3803605">.</span><span class="ident" id="3803606">tmp</span><span class="op" id="3803609">[</span><span class="num" id="3803610">1</span><span class="op" id="3803611">]</span>&nbsp;<span class="op" id="3803613">=</span>&nbsp;<span class="builtintype" id="3803615">byte</span><span class="op" id="3803619">(</span><span class="ident" id="3803620">err</span><span class="op" id="3803623">.</span><span class="op" id="3803624">(</span><span class="ident" id="3803625">alert</span><span class="op" id="3803630">)</span><span class="op" id="3803631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3803636">c</span><span class="op" id="3803637">.</span><span class="ident" id="3803638">writeRecord</span><span class="op" id="3803649">(</span><span class="ident" id="3803650">recordTypeAlert</span><span class="op" id="3803665">,</span>&nbsp;<span class="ident" id="3803667">c</span><span class="op" id="3803668">.</span><span class="ident" id="3803669">tmp</span><span class="op" id="3803672">[</span><span class="num" id="3803673">0</span><span class="op" id="3803674">:</span><span class="num" id="3803675">2</span><span class="op" id="3803676">]</span><span class="op" id="3803677">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803682">return</span>&nbsp;<span class="ident" id="3803689">n</span><span class="op" id="3803690">,</span>&nbsp;<span class="ident" id="3803692">c</span><span class="op" id="3803693">.</span><span class="ident" id="3803694">out</span><span class="op" id="3803697">.</span><span class="ident" id="3803698">setErrorLocked</span><span class="op" id="3803712">(</span><span class="op" id="3803713">&amp;</span><span class="ident" id="3803714">net</span><span class="op" id="3803717">.</span><span class="ident" id="3803718">OpError</span><span class="op" id="3803725">{</span><span class="ident" id="3803726">Op</span><span class="op" id="3803728">:</span>&nbsp;<span class="string" id="3803730">&#34;local&nbsp;error&#34;</span><span class="op" id="3803743">,</span>&nbsp;<span class="ident" id="3803745">Err</span><span class="op" id="3803748">:</span>&nbsp;<span class="ident" id="3803750">err</span><span class="op" id="3803753">}</span><span class="op" id="3803754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3803761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803764">return</span><br>
<span class="lineno"></span><span class="op" id="3803771">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3803774">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3803829">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3803850">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3803886">func</span>&nbsp;<span class="op" id="3803891">(</span><span class="ident" id="3803892">c</span>&nbsp;<span class="op" id="3803894">*</span><span class="ident" id="3803895">Conn</span><span class="op" id="3803899">)</span>&nbsp;<span class="ident" id="3803901">readHandshake</span><span class="op" id="3803914">(</span><span class="op" id="3803915">)</span>&nbsp;<span class="op" id="3803917">(</span><span class="keyword" id="3803918">interface</span><span class="op" id="3803927">{</span><span class="op" id="3803928">}</span><span class="op" id="3803929">,</span>&nbsp;<span class="builtintype" id="3803931">error</span><span class="op" id="3803936">)</span>&nbsp;<span class="op" id="3803938">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803941">for</span>&nbsp;<span class="ident" id="3803945">c</span><span class="op" id="3803946">.</span><span class="ident" id="3803947">hand</span><span class="op" id="3803951">.</span><span class="ident" id="3803952">Len</span><span class="op" id="3803955">(</span><span class="op" id="3803956">)</span>&nbsp;<span class="op" id="3803958">&lt;</span>&nbsp;<span class="num" id="3803960">4</span>&nbsp;<span class="op" id="3803962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3803966">if</span>&nbsp;<span class="ident" id="3803969">err</span>&nbsp;<span class="op" id="3803973">:=</span>&nbsp;<span class="ident" id="3803976">c</span><span class="op" id="3803977">.</span><span class="ident" id="3803978">in</span><span class="op" id="3803980">.</span><span class="ident" id="3803981">err</span><span class="op" id="3803984">;</span>&nbsp;<span class="ident" id="3803986">err</span>&nbsp;<span class="op" id="3803990">!=</span>&nbsp;<span class="ident" id="3803993">nil</span>&nbsp;<span class="op" id="3803997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804002">return</span>&nbsp;<span class="ident" id="3804009">nil</span><span class="op" id="3804012">,</span>&nbsp;<span class="ident" id="3804014">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804024">if</span>&nbsp;<span class="ident" id="3804027">err</span>&nbsp;<span class="op" id="3804031">:=</span>&nbsp;<span class="ident" id="3804034">c</span><span class="op" id="3804035">.</span><span class="ident" id="3804036">readRecord</span><span class="op" id="3804046">(</span><span class="ident" id="3804047">recordTypeHandshake</span><span class="op" id="3804066">)</span><span class="op" id="3804067">;</span>&nbsp;<span class="ident" id="3804069">err</span>&nbsp;<span class="op" id="3804073">!=</span>&nbsp;<span class="ident" id="3804076">nil</span>&nbsp;<span class="op" id="3804080">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804085">return</span>&nbsp;<span class="ident" id="3804092">nil</span><span class="op" id="3804095">,</span>&nbsp;<span class="ident" id="3804097">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804110">data</span>&nbsp;<span class="op" id="3804115">:=</span>&nbsp;<span class="ident" id="3804118">c</span><span class="op" id="3804119">.</span><span class="ident" id="3804120">hand</span><span class="op" id="3804124">.</span><span class="ident" id="3804125">Bytes</span><span class="op" id="3804130">(</span><span class="op" id="3804131">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804134">n</span>&nbsp;<span class="op" id="3804136">:=</span>&nbsp;<span class="builtintype" id="3804139">int</span><span class="op" id="3804142">(</span><span class="ident" id="3804143">data</span><span class="op" id="3804147">[</span><span class="num" id="3804148">1</span><span class="op" id="3804149">]</span><span class="op" id="3804150">)</span><span class="op" id="3804151">&lt;&lt;</span><span class="num" id="3804153">16</span>&nbsp;<span class="op" id="3804156">|</span>&nbsp;<span class="builtintype" id="3804158">int</span><span class="op" id="3804161">(</span><span class="ident" id="3804162">data</span><span class="op" id="3804166">[</span><span class="num" id="3804167">2</span><span class="op" id="3804168">]</span><span class="op" id="3804169">)</span><span class="op" id="3804170">&lt;&lt;</span><span class="num" id="3804172">8</span>&nbsp;<span class="op" id="3804174">|</span>&nbsp;<span class="builtintype" id="3804176">int</span><span class="op" id="3804179">(</span><span class="ident" id="3804180">data</span><span class="op" id="3804184">[</span><span class="num" id="3804185">3</span><span class="op" id="3804186">]</span><span class="op" id="3804187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804190">if</span>&nbsp;<span class="ident" id="3804193">n</span>&nbsp;<span class="op" id="3804195">&gt;</span>&nbsp;<span class="ident" id="3804197">maxHandshake</span>&nbsp;<span class="op" id="3804210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804214">return</span>&nbsp;<span class="ident" id="3804221">nil</span><span class="op" id="3804224">,</span>&nbsp;<span class="ident" id="3804226">c</span><span class="op" id="3804227">.</span><span class="ident" id="3804228">in</span><span class="op" id="3804230">.</span><span class="ident" id="3804231">setErrorLocked</span><span class="op" id="3804245">(</span><span class="ident" id="3804246">c</span><span class="op" id="3804247">.</span><span class="ident" id="3804248">sendAlert</span><span class="op" id="3804257">(</span><span class="ident" id="3804258">alertInternalError</span><span class="op" id="3804276">)</span><span class="op" id="3804277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804283">for</span>&nbsp;<span class="ident" id="3804287">c</span><span class="op" id="3804288">.</span><span class="ident" id="3804289">hand</span><span class="op" id="3804293">.</span><span class="ident" id="3804294">Len</span><span class="op" id="3804297">(</span><span class="op" id="3804298">)</span>&nbsp;<span class="op" id="3804300">&lt;</span>&nbsp;<span class="num" id="3804302">4</span><span class="op" id="3804303">+</span><span class="ident" id="3804304">n</span>&nbsp;<span class="op" id="3804306">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804310">if</span>&nbsp;<span class="ident" id="3804313">err</span>&nbsp;<span class="op" id="3804317">:=</span>&nbsp;<span class="ident" id="3804320">c</span><span class="op" id="3804321">.</span><span class="ident" id="3804322">in</span><span class="op" id="3804324">.</span><span class="ident" id="3804325">err</span><span class="op" id="3804328">;</span>&nbsp;<span class="ident" id="3804330">err</span>&nbsp;<span class="op" id="3804334">!=</span>&nbsp;<span class="ident" id="3804337">nil</span>&nbsp;<span class="op" id="3804341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804346">return</span>&nbsp;<span class="ident" id="3804353">nil</span><span class="op" id="3804356">,</span>&nbsp;<span class="ident" id="3804358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804368">if</span>&nbsp;<span class="ident" id="3804371">err</span>&nbsp;<span class="op" id="3804375">:=</span>&nbsp;<span class="ident" id="3804378">c</span><span class="op" id="3804379">.</span><span class="ident" id="3804380">readRecord</span><span class="op" id="3804390">(</span><span class="ident" id="3804391">recordTypeHandshake</span><span class="op" id="3804410">)</span><span class="op" id="3804411">;</span>&nbsp;<span class="ident" id="3804413">err</span>&nbsp;<span class="op" id="3804417">!=</span>&nbsp;<span class="ident" id="3804420">nil</span>&nbsp;<span class="op" id="3804424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804429">return</span>&nbsp;<span class="ident" id="3804436">nil</span><span class="op" id="3804439">,</span>&nbsp;<span class="ident" id="3804441">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804453">data</span>&nbsp;<span class="op" id="3804458">=</span>&nbsp;<span class="ident" id="3804460">c</span><span class="op" id="3804461">.</span><span class="ident" id="3804462">hand</span><span class="op" id="3804466">.</span><span class="ident" id="3804467">Next</span><span class="op" id="3804471">(</span><span class="num" id="3804472">4</span>&nbsp;<span class="op" id="3804474">+</span>&nbsp;<span class="ident" id="3804476">n</span><span class="op" id="3804477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804480">var</span>&nbsp;<span class="ident" id="3804484">m</span>&nbsp;<span class="ident" id="3804486">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804504">switch</span>&nbsp;<span class="ident" id="3804511">data</span><span class="op" id="3804515">[</span><span class="num" id="3804516">0</span><span class="op" id="3804517">]</span>&nbsp;<span class="op" id="3804519">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804522">case</span>&nbsp;<span class="ident" id="3804527">typeClientHello</span><span class="op" id="3804542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804546">m</span>&nbsp;<span class="op" id="3804548">=</span>&nbsp;<span class="builtinfunc" id="3804550">new</span><span class="op" id="3804553">(</span><span class="ident" id="3804554">clientHelloMsg</span><span class="op" id="3804568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804571">case</span>&nbsp;<span class="ident" id="3804576">typeServerHello</span><span class="op" id="3804591">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804595">m</span>&nbsp;<span class="op" id="3804597">=</span>&nbsp;<span class="builtinfunc" id="3804599">new</span><span class="op" id="3804602">(</span><span class="ident" id="3804603">serverHelloMsg</span><span class="op" id="3804617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804620">case</span>&nbsp;<span class="ident" id="3804625">typeNewSessionTicket</span><span class="op" id="3804645">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804649">m</span>&nbsp;<span class="op" id="3804651">=</span>&nbsp;<span class="builtinfunc" id="3804653">new</span><span class="op" id="3804656">(</span><span class="ident" id="3804657">newSessionTicketMsg</span><span class="op" id="3804676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804679">case</span>&nbsp;<span class="ident" id="3804684">typeCertificate</span><span class="op" id="3804699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804703">m</span>&nbsp;<span class="op" id="3804705">=</span>&nbsp;<span class="builtinfunc" id="3804707">new</span><span class="op" id="3804710">(</span><span class="ident" id="3804711">certificateMsg</span><span class="op" id="3804725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804728">case</span>&nbsp;<span class="ident" id="3804733">typeCertificateRequest</span><span class="op" id="3804755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804759">m</span>&nbsp;<span class="op" id="3804761">=</span>&nbsp;<span class="op" id="3804763">&amp;</span><span class="ident" id="3804764">certificateRequestMsg</span><span class="op" id="3804785">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804790">hasSignatureAndHash</span><span class="op" id="3804809">:</span>&nbsp;<span class="ident" id="3804811">c</span><span class="op" id="3804812">.</span><span class="ident" id="3804813">vers</span>&nbsp;<span class="op" id="3804818">&gt;=</span>&nbsp;<span class="ident" id="3804821">VersionTLS12</span><span class="op" id="3804833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3804837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804840">case</span>&nbsp;<span class="ident" id="3804845">typeCertificateStatus</span><span class="op" id="3804866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804870">m</span>&nbsp;<span class="op" id="3804872">=</span>&nbsp;<span class="builtinfunc" id="3804874">new</span><span class="op" id="3804877">(</span><span class="ident" id="3804878">certificateStatusMsg</span><span class="op" id="3804898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804901">case</span>&nbsp;<span class="ident" id="3804906">typeServerKeyExchange</span><span class="op" id="3804927">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804931">m</span>&nbsp;<span class="op" id="3804933">=</span>&nbsp;<span class="builtinfunc" id="3804935">new</span><span class="op" id="3804938">(</span><span class="ident" id="3804939">serverKeyExchangeMsg</span><span class="op" id="3804959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3804962">case</span>&nbsp;<span class="ident" id="3804967">typeServerHelloDone</span><span class="op" id="3804986">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3804990">m</span>&nbsp;<span class="op" id="3804992">=</span>&nbsp;<span class="builtinfunc" id="3804994">new</span><span class="op" id="3804997">(</span><span class="ident" id="3804998">serverHelloDoneMsg</span><span class="op" id="3805016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805019">case</span>&nbsp;<span class="ident" id="3805024">typeClientKeyExchange</span><span class="op" id="3805045">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805049">m</span>&nbsp;<span class="op" id="3805051">=</span>&nbsp;<span class="builtinfunc" id="3805053">new</span><span class="op" id="3805056">(</span><span class="ident" id="3805057">clientKeyExchangeMsg</span><span class="op" id="3805077">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805080">case</span>&nbsp;<span class="ident" id="3805085">typeCertificateVerify</span><span class="op" id="3805106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805110">m</span>&nbsp;<span class="op" id="3805112">=</span>&nbsp;<span class="op" id="3805114">&amp;</span><span class="ident" id="3805115">certificateVerifyMsg</span><span class="op" id="3805135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805140">hasSignatureAndHash</span><span class="op" id="3805159">:</span>&nbsp;<span class="ident" id="3805161">c</span><span class="op" id="3805162">.</span><span class="ident" id="3805163">vers</span>&nbsp;<span class="op" id="3805168">&gt;=</span>&nbsp;<span class="ident" id="3805171">VersionTLS12</span><span class="op" id="3805183">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805190">case</span>&nbsp;<span class="ident" id="3805195">typeNextProtocol</span><span class="op" id="3805211">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805215">m</span>&nbsp;<span class="op" id="3805217">=</span>&nbsp;<span class="builtinfunc" id="3805219">new</span><span class="op" id="3805222">(</span><span class="ident" id="3805223">nextProtoMsg</span><span class="op" id="3805235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805238">case</span>&nbsp;<span class="ident" id="3805243">typeFinished</span><span class="op" id="3805255">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805259">m</span>&nbsp;<span class="op" id="3805261">=</span>&nbsp;<span class="builtinfunc" id="3805263">new</span><span class="op" id="3805266">(</span><span class="ident" id="3805267">finishedMsg</span><span class="op" id="3805278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805281">default</span><span class="op" id="3805288">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805292">return</span>&nbsp;<span class="ident" id="3805299">nil</span><span class="op" id="3805302">,</span>&nbsp;<span class="ident" id="3805304">c</span><span class="op" id="3805305">.</span><span class="ident" id="3805306">in</span><span class="op" id="3805308">.</span><span class="ident" id="3805309">setErrorLocked</span><span class="op" id="3805323">(</span><span class="ident" id="3805324">c</span><span class="op" id="3805325">.</span><span class="ident" id="3805326">sendAlert</span><span class="op" id="3805335">(</span><span class="ident" id="3805336">alertUnexpectedMessage</span><span class="op" id="3805358">)</span><span class="op" id="3805359">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3805366">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3805406">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3805456">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805511">data</span>&nbsp;<span class="op" id="3805516">=</span>&nbsp;<span class="builtinfunc" id="3805518">append</span><span class="op" id="3805524">(</span><span class="op" id="3805525">[</span><span class="op" id="3805526">]</span><span class="builtintype" id="3805527">byte</span><span class="op" id="3805531">(</span><span class="ident" id="3805532">nil</span><span class="op" id="3805535">)</span><span class="op" id="3805536">,</span>&nbsp;<span class="ident" id="3805538">data</span><span class="op" id="3805542">...</span><span class="op" id="3805545">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805549">if</span>&nbsp;<span class="op" id="3805552">!</span><span class="ident" id="3805553">m</span><span class="op" id="3805554">.</span><span class="ident" id="3805555">unmarshal</span><span class="op" id="3805564">(</span><span class="ident" id="3805565">data</span><span class="op" id="3805569">)</span>&nbsp;<span class="op" id="3805571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805575">return</span>&nbsp;<span class="ident" id="3805582">nil</span><span class="op" id="3805585">,</span>&nbsp;<span class="ident" id="3805587">c</span><span class="op" id="3805588">.</span><span class="ident" id="3805589">in</span><span class="op" id="3805591">.</span><span class="ident" id="3805592">setErrorLocked</span><span class="op" id="3805606">(</span><span class="ident" id="3805607">c</span><span class="op" id="3805608">.</span><span class="ident" id="3805609">sendAlert</span><span class="op" id="3805618">(</span><span class="ident" id="3805619">alertUnexpectedMessage</span><span class="op" id="3805641">)</span><span class="op" id="3805642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805645">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805648">return</span>&nbsp;<span class="ident" id="3805655">m</span><span class="op" id="3805656">,</span>&nbsp;<span class="ident" id="3805658">nil</span><br>
<span class="lineno"></span><span class="op" id="3805662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3805665">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3805705">func</span>&nbsp;<span class="op" id="3805710">(</span><span class="ident" id="3805711">c</span>&nbsp;<span class="op" id="3805713">*</span><span class="ident" id="3805714">Conn</span><span class="op" id="3805718">)</span>&nbsp;<span class="ident" id="3805720">Write</span><span class="op" id="3805725">(</span><span class="ident" id="3805726">b</span>&nbsp;<span class="op" id="3805728">[</span><span class="op" id="3805729">]</span><span class="builtintype" id="3805730">byte</span><span class="op" id="3805734">)</span>&nbsp;<span class="op" id="3805736">(</span><span class="builtintype" id="3805737">int</span><span class="op" id="3805740">,</span>&nbsp;<span class="builtintype" id="3805742">error</span><span class="op" id="3805747">)</span>&nbsp;<span class="op" id="3805749">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805752">if</span>&nbsp;<span class="ident" id="3805755">err</span>&nbsp;<span class="op" id="3805759">:=</span>&nbsp;<span class="ident" id="3805762">c</span><span class="op" id="3805763">.</span><span class="ident" id="3805764">Handshake</span><span class="op" id="3805773">(</span><span class="op" id="3805774">)</span><span class="op" id="3805775">;</span>&nbsp;<span class="ident" id="3805777">err</span>&nbsp;<span class="op" id="3805781">!=</span>&nbsp;<span class="ident" id="3805784">nil</span>&nbsp;<span class="op" id="3805788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805792">return</span>&nbsp;<span class="num" id="3805799">0</span><span class="op" id="3805800">,</span>&nbsp;<span class="ident" id="3805802">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3805811">c</span><span class="op" id="3805812">.</span><span class="ident" id="3805813">out</span><span class="op" id="3805816">.</span><span class="ident" id="3805817">Lock</span><span class="op" id="3805821">(</span><span class="op" id="3805822">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805825">defer</span>&nbsp;<span class="ident" id="3805831">c</span><span class="op" id="3805832">.</span><span class="ident" id="3805833">out</span><span class="op" id="3805836">.</span><span class="ident" id="3805837">Unlock</span><span class="op" id="3805843">(</span><span class="op" id="3805844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805848">if</span>&nbsp;<span class="ident" id="3805851">err</span>&nbsp;<span class="op" id="3805855">:=</span>&nbsp;<span class="ident" id="3805858">c</span><span class="op" id="3805859">.</span><span class="ident" id="3805860">out</span><span class="op" id="3805863">.</span><span class="ident" id="3805864">err</span><span class="op" id="3805867">;</span>&nbsp;<span class="ident" id="3805869">err</span>&nbsp;<span class="op" id="3805873">!=</span>&nbsp;<span class="ident" id="3805876">nil</span>&nbsp;<span class="op" id="3805880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805884">return</span>&nbsp;<span class="num" id="3805891">0</span><span class="op" id="3805892">,</span>&nbsp;<span class="ident" id="3805894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805899">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805903">if</span>&nbsp;<span class="op" id="3805906">!</span><span class="ident" id="3805907">c</span><span class="op" id="3805908">.</span><span class="ident" id="3805909">handshakeComplete</span>&nbsp;<span class="op" id="3805927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3805931">return</span>&nbsp;<span class="num" id="3805938">0</span><span class="op" id="3805939">,</span>&nbsp;<span class="ident" id="3805941">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3805961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3805965">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806027">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806092">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806153">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806214">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806218">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806263">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3806319">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806384">var</span>&nbsp;<span class="ident" id="3806388">m</span>&nbsp;<span class="builtintype" id="3806390">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806395">if</span>&nbsp;<span class="builtinfunc" id="3806398">len</span><span class="op" id="3806401">(</span><span class="ident" id="3806402">b</span><span class="op" id="3806403">)</span>&nbsp;<span class="op" id="3806405">&gt;</span>&nbsp;<span class="num" id="3806407">1</span>&nbsp;<span class="op" id="3806409">&amp;&amp;</span>&nbsp;<span class="ident" id="3806412">c</span><span class="op" id="3806413">.</span><span class="ident" id="3806414">vers</span>&nbsp;<span class="op" id="3806419">&lt;=</span>&nbsp;<span class="ident" id="3806422">VersionTLS10</span>&nbsp;<span class="op" id="3806435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806439">if</span>&nbsp;<span class="ident" id="3806442">_</span><span class="op" id="3806443">,</span>&nbsp;<span class="ident" id="3806445">ok</span>&nbsp;<span class="op" id="3806448">:=</span>&nbsp;<span class="ident" id="3806451">c</span><span class="op" id="3806452">.</span><span class="ident" id="3806453">out</span><span class="op" id="3806456">.</span><span class="ident" id="3806457">cipher</span><span class="op" id="3806463">.</span><span class="op" id="3806464">(</span><span class="ident" id="3806465">cipher</span><span class="op" id="3806471">.</span><span class="ident" id="3806472">BlockMode</span><span class="op" id="3806481">)</span><span class="op" id="3806482">;</span>&nbsp;<span class="ident" id="3806484">ok</span>&nbsp;<span class="op" id="3806487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3806492">n</span><span class="op" id="3806493">,</span>&nbsp;<span class="ident" id="3806495">err</span>&nbsp;<span class="op" id="3806499">:=</span>&nbsp;<span class="ident" id="3806502">c</span><span class="op" id="3806503">.</span><span class="ident" id="3806504">writeRecord</span><span class="op" id="3806515">(</span><span class="ident" id="3806516">recordTypeApplicationData</span><span class="op" id="3806541">,</span>&nbsp;<span class="ident" id="3806543">b</span><span class="op" id="3806544">[</span><span class="op" id="3806545">:</span><span class="num" id="3806546">1</span><span class="op" id="3806547">]</span><span class="op" id="3806548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806553">if</span>&nbsp;<span class="ident" id="3806556">err</span>&nbsp;<span class="op" id="3806560">!=</span>&nbsp;<span class="ident" id="3806563">nil</span>&nbsp;<span class="op" id="3806567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806573">return</span>&nbsp;<span class="ident" id="3806580">n</span><span class="op" id="3806581">,</span>&nbsp;<span class="ident" id="3806583">c</span><span class="op" id="3806584">.</span><span class="ident" id="3806585">out</span><span class="op" id="3806588">.</span><span class="ident" id="3806589">setErrorLocked</span><span class="op" id="3806603">(</span><span class="ident" id="3806604">err</span><span class="op" id="3806607">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3806612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3806617">m</span><span class="op" id="3806618">,</span>&nbsp;<span class="ident" id="3806620">b</span>&nbsp;<span class="op" id="3806622">=</span>&nbsp;<span class="num" id="3806624">1</span><span class="op" id="3806625">,</span>&nbsp;<span class="ident" id="3806627">b</span><span class="op" id="3806628">[</span><span class="num" id="3806629">1</span><span class="op" id="3806630">:</span><span class="op" id="3806631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3806635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3806638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3806642">n</span><span class="op" id="3806643">,</span>&nbsp;<span class="ident" id="3806645">err</span>&nbsp;<span class="op" id="3806649">:=</span>&nbsp;<span class="ident" id="3806652">c</span><span class="op" id="3806653">.</span><span class="ident" id="3806654">writeRecord</span><span class="op" id="3806665">(</span><span class="ident" id="3806666">recordTypeApplicationData</span><span class="op" id="3806691">,</span>&nbsp;<span class="ident" id="3806693">b</span><span class="op" id="3806694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806697">return</span>&nbsp;<span class="ident" id="3806704">n</span>&nbsp;<span class="op" id="3806706">+</span>&nbsp;<span class="ident" id="3806708">m</span><span class="op" id="3806709">,</span>&nbsp;<span class="ident" id="3806711">c</span><span class="op" id="3806712">.</span><span class="ident" id="3806713">out</span><span class="op" id="3806716">.</span><span class="ident" id="3806717">setErrorLocked</span><span class="op" id="3806731">(</span><span class="ident" id="3806732">err</span><span class="op" id="3806735">)</span><br>
<span class="lineno"></span><span class="op" id="3806737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3806740">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3806818">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3806884">func</span>&nbsp;<span class="op" id="3806889">(</span><span class="ident" id="3806890">c</span>&nbsp;<span class="op" id="3806892">*</span><span class="ident" id="3806893">Conn</span><span class="op" id="3806897">)</span>&nbsp;<span class="ident" id="3806899">Read</span><span class="op" id="3806903">(</span><span class="ident" id="3806904">b</span>&nbsp;<span class="op" id="3806906">[</span><span class="op" id="3806907">]</span><span class="builtintype" id="3806908">byte</span><span class="op" id="3806912">)</span>&nbsp;<span class="op" id="3806914">(</span><span class="ident" id="3806915">n</span>&nbsp;<span class="builtintype" id="3806917">int</span><span class="op" id="3806920">,</span>&nbsp;<span class="ident" id="3806922">err</span>&nbsp;<span class="builtintype" id="3806926">error</span><span class="op" id="3806931">)</span>&nbsp;<span class="op" id="3806933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806936">if</span>&nbsp;<span class="ident" id="3806939">err</span>&nbsp;<span class="op" id="3806943">=</span>&nbsp;<span class="ident" id="3806945">c</span><span class="op" id="3806946">.</span><span class="ident" id="3806947">Handshake</span><span class="op" id="3806956">(</span><span class="op" id="3806957">)</span><span class="op" id="3806958">;</span>&nbsp;<span class="ident" id="3806960">err</span>&nbsp;<span class="op" id="3806964">!=</span>&nbsp;<span class="ident" id="3806967">nil</span>&nbsp;<span class="op" id="3806971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806975">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3806983">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3806986">if</span>&nbsp;<span class="builtinfunc" id="3806989">len</span><span class="op" id="3806992">(</span><span class="ident" id="3806993">b</span><span class="op" id="3806994">)</span>&nbsp;<span class="op" id="3806996">==</span>&nbsp;<span class="num" id="3806999">0</span>&nbsp;<span class="op" id="3807001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807005">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807064">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807117">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3807125">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3807129">c</span><span class="op" id="3807130">.</span><span class="ident" id="3807131">in</span><span class="op" id="3807133">.</span><span class="ident" id="3807134">Lock</span><span class="op" id="3807138">(</span><span class="op" id="3807139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807142">defer</span>&nbsp;<span class="ident" id="3807148">c</span><span class="op" id="3807149">.</span><span class="ident" id="3807150">in</span><span class="op" id="3807152">.</span><span class="ident" id="3807153">Unlock</span><span class="op" id="3807159">(</span><span class="op" id="3807160">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807164">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807234">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807302">const</span>&nbsp;<span class="ident" id="3807308">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3807335">=</span>&nbsp;<span class="num" id="3807337">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807342">for</span>&nbsp;<span class="ident" id="3807346">emptyRecordCount</span>&nbsp;<span class="op" id="3807363">:=</span>&nbsp;<span class="num" id="3807366">0</span><span class="op" id="3807367">;</span>&nbsp;<span class="ident" id="3807369">emptyRecordCount</span>&nbsp;<span class="op" id="3807386">&lt;=</span>&nbsp;<span class="ident" id="3807389">maxConsecutiveEmptyRecords</span><span class="op" id="3807415">;</span>&nbsp;<span class="ident" id="3807417">emptyRecordCount</span><span class="op" id="3807433">++</span>&nbsp;<span class="op" id="3807436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807440">for</span>&nbsp;<span class="ident" id="3807444">c</span><span class="op" id="3807445">.</span><span class="ident" id="3807446">input</span>&nbsp;<span class="op" id="3807452">==</span>&nbsp;<span class="ident" id="3807455">nil</span>&nbsp;<span class="op" id="3807459">&amp;&amp;</span>&nbsp;<span class="ident" id="3807462">c</span><span class="op" id="3807463">.</span><span class="ident" id="3807464">in</span><span class="op" id="3807466">.</span><span class="ident" id="3807467">err</span>&nbsp;<span class="op" id="3807471">==</span>&nbsp;<span class="ident" id="3807474">nil</span>&nbsp;<span class="op" id="3807478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807483">if</span>&nbsp;<span class="ident" id="3807486">err</span>&nbsp;<span class="op" id="3807490">:=</span>&nbsp;<span class="ident" id="3807493">c</span><span class="op" id="3807494">.</span><span class="ident" id="3807495">readRecord</span><span class="op" id="3807505">(</span><span class="ident" id="3807506">recordTypeApplicationData</span><span class="op" id="3807531">)</span><span class="op" id="3807532">;</span>&nbsp;<span class="ident" id="3807534">err</span>&nbsp;<span class="op" id="3807538">!=</span>&nbsp;<span class="ident" id="3807541">nil</span>&nbsp;<span class="op" id="3807545">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807551">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807582">return</span>&nbsp;<span class="num" id="3807589">0</span><span class="op" id="3807590">,</span>&nbsp;<span class="ident" id="3807592">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3807599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3807603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807607">if</span>&nbsp;<span class="ident" id="3807610">err</span>&nbsp;<span class="op" id="3807614">:=</span>&nbsp;<span class="ident" id="3807617">c</span><span class="op" id="3807618">.</span><span class="ident" id="3807619">in</span><span class="op" id="3807621">.</span><span class="ident" id="3807622">err</span><span class="op" id="3807625">;</span>&nbsp;<span class="ident" id="3807627">err</span>&nbsp;<span class="op" id="3807631">!=</span>&nbsp;<span class="ident" id="3807634">nil</span>&nbsp;<span class="op" id="3807638">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807643">return</span>&nbsp;<span class="num" id="3807650">0</span><span class="op" id="3807651">,</span>&nbsp;<span class="ident" id="3807653">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3807659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3807664">n</span><span class="op" id="3807665">,</span>&nbsp;<span class="ident" id="3807667">err</span>&nbsp;<span class="op" id="3807671">=</span>&nbsp;<span class="ident" id="3807673">c</span><span class="op" id="3807674">.</span><span class="ident" id="3807675">input</span><span class="op" id="3807680">.</span><span class="ident" id="3807681">Read</span><span class="op" id="3807685">(</span><span class="ident" id="3807686">b</span><span class="op" id="3807687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3807691">if</span>&nbsp;<span class="ident" id="3807694">c</span><span class="op" id="3807695">.</span><span class="ident" id="3807696">input</span><span class="op" id="3807701">.</span><span class="ident" id="3807702">off</span>&nbsp;<span class="op" id="3807706">&gt;=</span>&nbsp;<span class="builtinfunc" id="3807709">len</span><span class="op" id="3807712">(</span><span class="ident" id="3807713">c</span><span class="op" id="3807714">.</span><span class="ident" id="3807715">input</span><span class="op" id="3807720">.</span><span class="ident" id="3807721">data</span><span class="op" id="3807725">)</span>&nbsp;<span class="op" id="3807727">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3807732">c</span><span class="op" id="3807733">.</span><span class="ident" id="3807734">in</span><span class="op" id="3807736">.</span><span class="ident" id="3807737">freeBlock</span><span class="op" id="3807746">(</span><span class="ident" id="3807747">c</span><span class="op" id="3807748">.</span><span class="ident" id="3807749">input</span><span class="op" id="3807754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3807759">c</span><span class="op" id="3807760">.</span><span class="ident" id="3807761">input</span>&nbsp;<span class="op" id="3807767">=</span>&nbsp;<span class="ident" id="3807769">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3807775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807780">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807837">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807896">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3807949">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808003">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808056">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808112">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808169">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808219">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808233">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3808282">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808320">if</span>&nbsp;<span class="ident" id="3808323">ri</span>&nbsp;<span class="op" id="3808326">:=</span>&nbsp;<span class="ident" id="3808329">c</span><span class="op" id="3808330">.</span><span class="ident" id="3808331">rawInput</span><span class="op" id="3808339">;</span>&nbsp;<span class="ident" id="3808341">ri</span>&nbsp;<span class="op" id="3808344">!=</span>&nbsp;<span class="ident" id="3808347">nil</span>&nbsp;<span class="op" id="3808351">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3808357">n</span>&nbsp;<span class="op" id="3808359">!=</span>&nbsp;<span class="num" id="3808362">0</span>&nbsp;<span class="op" id="3808364">&amp;&amp;</span>&nbsp;<span class="ident" id="3808367">err</span>&nbsp;<span class="op" id="3808371">==</span>&nbsp;<span class="ident" id="3808374">nil</span>&nbsp;<span class="op" id="3808378">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3808384">c</span><span class="op" id="3808385">.</span><span class="ident" id="3808386">input</span>&nbsp;<span class="op" id="3808392">==</span>&nbsp;<span class="ident" id="3808395">nil</span>&nbsp;<span class="op" id="3808399">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3808402">len</span><span class="op" id="3808405">(</span><span class="ident" id="3808406">ri</span><span class="op" id="3808408">.</span><span class="ident" id="3808409">data</span><span class="op" id="3808413">)</span>&nbsp;<span class="op" id="3808415">&gt;</span>&nbsp;<span class="num" id="3808417">0</span>&nbsp;<span class="op" id="3808419">&amp;&amp;</span>&nbsp;<span class="ident" id="3808422">recordType</span><span class="op" id="3808432">(</span><span class="ident" id="3808433">ri</span><span class="op" id="3808435">.</span><span class="ident" id="3808436">data</span><span class="op" id="3808440">[</span><span class="num" id="3808441">0</span><span class="op" id="3808442">]</span><span class="op" id="3808443">)</span>&nbsp;<span class="op" id="3808445">==</span>&nbsp;<span class="ident" id="3808448">recordTypeAlert</span>&nbsp;<span class="op" id="3808464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808469">if</span>&nbsp;<span class="ident" id="3808472">recErr</span>&nbsp;<span class="op" id="3808479">:=</span>&nbsp;<span class="ident" id="3808482">c</span><span class="op" id="3808483">.</span><span class="ident" id="3808484">readRecord</span><span class="op" id="3808494">(</span><span class="ident" id="3808495">recordTypeApplicationData</span><span class="op" id="3808520">)</span><span class="op" id="3808521">;</span>&nbsp;<span class="ident" id="3808523">recErr</span>&nbsp;<span class="op" id="3808530">!=</span>&nbsp;<span class="ident" id="3808533">nil</span>&nbsp;<span class="op" id="3808537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3808543">err</span>&nbsp;<span class="op" id="3808547">=</span>&nbsp;<span class="ident" id="3808549">recErr</span>&nbsp;<span class="comment" id="3808556">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808601">if</span>&nbsp;<span class="ident" id="3808604">n</span>&nbsp;<span class="op" id="3808606">!=</span>&nbsp;<span class="num" id="3808609">0</span>&nbsp;<span class="op" id="3808611">||</span>&nbsp;<span class="ident" id="3808614">err</span>&nbsp;<span class="op" id="3808618">!=</span>&nbsp;<span class="ident" id="3808621">nil</span>&nbsp;<span class="op" id="3808625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808630">return</span>&nbsp;<span class="ident" id="3808637">n</span><span class="op" id="3808638">,</span>&nbsp;<span class="ident" id="3808640">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808653">return</span>&nbsp;<span class="num" id="3808660">0</span><span class="op" id="3808661">,</span>&nbsp;<span class="ident" id="3808663">io</span><span class="op" id="3808665">.</span><span class="ident" id="3808666">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3808680">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3808683">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3808715">func</span>&nbsp;<span class="op" id="3808720">(</span><span class="ident" id="3808721">c</span>&nbsp;<span class="op" id="3808723">*</span><span class="ident" id="3808724">Conn</span><span class="op" id="3808728">)</span>&nbsp;<span class="ident" id="3808730">Close</span><span class="op" id="3808735">(</span><span class="op" id="3808736">)</span>&nbsp;<span class="builtintype" id="3808738">error</span>&nbsp;<span class="op" id="3808744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808747">var</span>&nbsp;<span class="ident" id="3808751">alertErr</span>&nbsp;<span class="builtintype" id="3808760">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3808768">c</span><span class="op" id="3808769">.</span><span class="ident" id="3808770">handshakeMutex</span><span class="op" id="3808784">.</span><span class="ident" id="3808785">Lock</span><span class="op" id="3808789">(</span><span class="op" id="3808790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808793">defer</span>&nbsp;<span class="ident" id="3808799">c</span><span class="op" id="3808800">.</span><span class="ident" id="3808801">handshakeMutex</span><span class="op" id="3808815">.</span><span class="ident" id="3808816">Unlock</span><span class="op" id="3808822">(</span><span class="op" id="3808823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808826">if</span>&nbsp;<span class="ident" id="3808829">c</span><span class="op" id="3808830">.</span><span class="ident" id="3808831">handshakeComplete</span>&nbsp;<span class="op" id="3808849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3808853">alertErr</span>&nbsp;<span class="op" id="3808862">=</span>&nbsp;<span class="ident" id="3808864">c</span><span class="op" id="3808865">.</span><span class="ident" id="3808866">sendAlert</span><span class="op" id="3808875">(</span><span class="ident" id="3808876">alertCloseNotify</span><span class="op" id="3808892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808895">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808899">if</span>&nbsp;<span class="ident" id="3808902">err</span>&nbsp;<span class="op" id="3808906">:=</span>&nbsp;<span class="ident" id="3808909">c</span><span class="op" id="3808910">.</span><span class="ident" id="3808911">conn</span><span class="op" id="3808915">.</span><span class="ident" id="3808916">Close</span><span class="op" id="3808921">(</span><span class="op" id="3808922">)</span><span class="op" id="3808923">;</span>&nbsp;<span class="ident" id="3808925">err</span>&nbsp;<span class="op" id="3808929">!=</span>&nbsp;<span class="ident" id="3808932">nil</span>&nbsp;<span class="op" id="3808936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808940">return</span>&nbsp;<span class="ident" id="3808947">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3808952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3808955">return</span>&nbsp;<span class="ident" id="3808962">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3808971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3808974">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3809023">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3809063">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3809116">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3809183">func</span>&nbsp;<span class="op" id="3809188">(</span><span class="ident" id="3809189">c</span>&nbsp;<span class="op" id="3809191">*</span><span class="ident" id="3809192">Conn</span><span class="op" id="3809196">)</span>&nbsp;<span class="ident" id="3809198">Handshake</span><span class="op" id="3809207">(</span><span class="op" id="3809208">)</span>&nbsp;<span class="builtintype" id="3809210">error</span>&nbsp;<span class="op" id="3809216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809219">c</span><span class="op" id="3809220">.</span><span class="ident" id="3809221">handshakeMutex</span><span class="op" id="3809235">.</span><span class="ident" id="3809236">Lock</span><span class="op" id="3809240">(</span><span class="op" id="3809241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809244">defer</span>&nbsp;<span class="ident" id="3809250">c</span><span class="op" id="3809251">.</span><span class="ident" id="3809252">handshakeMutex</span><span class="op" id="3809266">.</span><span class="ident" id="3809267">Unlock</span><span class="op" id="3809273">(</span><span class="op" id="3809274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809277">if</span>&nbsp;<span class="ident" id="3809280">err</span>&nbsp;<span class="op" id="3809284">:=</span>&nbsp;<span class="ident" id="3809287">c</span><span class="op" id="3809288">.</span><span class="ident" id="3809289">handshakeErr</span><span class="op" id="3809301">;</span>&nbsp;<span class="ident" id="3809303">err</span>&nbsp;<span class="op" id="3809307">!=</span>&nbsp;<span class="ident" id="3809310">nil</span>&nbsp;<span class="op" id="3809314">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809318">return</span>&nbsp;<span class="ident" id="3809325">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3809330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809333">if</span>&nbsp;<span class="ident" id="3809336">c</span><span class="op" id="3809337">.</span><span class="ident" id="3809338">handshakeComplete</span>&nbsp;<span class="op" id="3809356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809360">return</span>&nbsp;<span class="ident" id="3809367">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3809372">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809376">if</span>&nbsp;<span class="ident" id="3809379">c</span><span class="op" id="3809380">.</span><span class="ident" id="3809381">isClient</span>&nbsp;<span class="op" id="3809390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809394">c</span><span class="op" id="3809395">.</span><span class="ident" id="3809396">handshakeErr</span>&nbsp;<span class="op" id="3809409">=</span>&nbsp;<span class="ident" id="3809411">c</span><span class="op" id="3809412">.</span><span class="ident" id="3809413">clientHandshake</span><span class="op" id="3809428">(</span><span class="op" id="3809429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3809432">}</span>&nbsp;<span class="keyword" id="3809434">else</span>&nbsp;<span class="op" id="3809439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809443">c</span><span class="op" id="3809444">.</span><span class="ident" id="3809445">handshakeErr</span>&nbsp;<span class="op" id="3809458">=</span>&nbsp;<span class="ident" id="3809460">c</span><span class="op" id="3809461">.</span><span class="ident" id="3809462">serverHandshake</span><span class="op" id="3809477">(</span><span class="op" id="3809478">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3809481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809484">return</span>&nbsp;<span class="ident" id="3809491">c</span><span class="op" id="3809492">.</span><span class="ident" id="3809493">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3809506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3809509">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3809576">func</span>&nbsp;<span class="op" id="3809581">(</span><span class="ident" id="3809582">c</span>&nbsp;<span class="op" id="3809584">*</span><span class="ident" id="3809585">Conn</span><span class="op" id="3809589">)</span>&nbsp;<span class="ident" id="3809591">ConnectionState</span><span class="op" id="3809606">(</span><span class="op" id="3809607">)</span>&nbsp;<span class="ident" id="3809609">ConnectionState</span>&nbsp;<span class="op" id="3809625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809628">c</span><span class="op" id="3809629">.</span><span class="ident" id="3809630">handshakeMutex</span><span class="op" id="3809644">.</span><span class="ident" id="3809645">Lock</span><span class="op" id="3809649">(</span><span class="op" id="3809650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809653">defer</span>&nbsp;<span class="ident" id="3809659">c</span><span class="op" id="3809660">.</span><span class="ident" id="3809661">handshakeMutex</span><span class="op" id="3809675">.</span><span class="ident" id="3809676">Unlock</span><span class="op" id="3809682">(</span><span class="op" id="3809683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809687">var</span>&nbsp;<span class="ident" id="3809691">state</span>&nbsp;<span class="ident" id="3809697">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809714">state</span><span class="op" id="3809719">.</span><span class="ident" id="3809720">HandshakeComplete</span>&nbsp;<span class="op" id="3809738">=</span>&nbsp;<span class="ident" id="3809740">c</span><span class="op" id="3809741">.</span><span class="ident" id="3809742">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809761">if</span>&nbsp;<span class="ident" id="3809764">c</span><span class="op" id="3809765">.</span><span class="ident" id="3809766">handshakeComplete</span>&nbsp;<span class="op" id="3809784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809788">state</span><span class="op" id="3809793">.</span><span class="ident" id="3809794">Version</span>&nbsp;<span class="op" id="3809802">=</span>&nbsp;<span class="ident" id="3809804">c</span><span class="op" id="3809805">.</span><span class="ident" id="3809806">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809813">state</span><span class="op" id="3809818">.</span><span class="ident" id="3809819">NegotiatedProtocol</span>&nbsp;<span class="op" id="3809838">=</span>&nbsp;<span class="ident" id="3809840">c</span><span class="op" id="3809841">.</span><span class="ident" id="3809842">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809859">state</span><span class="op" id="3809864">.</span><span class="ident" id="3809865">DidResume</span>&nbsp;<span class="op" id="3809875">=</span>&nbsp;<span class="ident" id="3809877">c</span><span class="op" id="3809878">.</span><span class="ident" id="3809879">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809891">state</span><span class="op" id="3809896">.</span><span class="ident" id="3809897">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3809924">=</span>&nbsp;<span class="op" id="3809926">!</span><span class="ident" id="3809927">c</span><span class="op" id="3809928">.</span><span class="ident" id="3809929">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809954">state</span><span class="op" id="3809959">.</span><span class="ident" id="3809960">CipherSuite</span>&nbsp;<span class="op" id="3809972">=</span>&nbsp;<span class="ident" id="3809974">c</span><span class="op" id="3809975">.</span><span class="ident" id="3809976">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809990">state</span><span class="op" id="3809995">.</span><span class="ident" id="3809996">PeerCertificates</span>&nbsp;<span class="op" id="3810013">=</span>&nbsp;<span class="ident" id="3810015">c</span><span class="op" id="3810016">.</span><span class="ident" id="3810017">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810036">state</span><span class="op" id="3810041">.</span><span class="ident" id="3810042">VerifiedChains</span>&nbsp;<span class="op" id="3810057">=</span>&nbsp;<span class="ident" id="3810059">c</span><span class="op" id="3810060">.</span><span class="ident" id="3810061">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810078">state</span><span class="op" id="3810083">.</span><span class="ident" id="3810084">ServerName</span>&nbsp;<span class="op" id="3810095">=</span>&nbsp;<span class="ident" id="3810097">c</span><span class="op" id="3810098">.</span><span class="ident" id="3810099">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810112">if</span>&nbsp;<span class="op" id="3810115">!</span><span class="ident" id="3810116">c</span><span class="op" id="3810117">.</span><span class="ident" id="3810118">didResume</span>&nbsp;<span class="op" id="3810128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810133">state</span><span class="op" id="3810138">.</span><span class="ident" id="3810139">TLSUnique</span>&nbsp;<span class="op" id="3810149">=</span>&nbsp;<span class="ident" id="3810151">c</span><span class="op" id="3810152">.</span><span class="ident" id="3810153">firstFinished</span><span class="op" id="3810166">[</span><span class="op" id="3810167">:</span><span class="op" id="3810168">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810179">return</span>&nbsp;<span class="ident" id="3810186">state</span><br>
<span class="lineno"></span><span class="op" id="3810192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3810195">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3810269">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3810314">func</span>&nbsp;<span class="op" id="3810319">(</span><span class="ident" id="3810320">c</span>&nbsp;<span class="op" id="3810322">*</span><span class="ident" id="3810323">Conn</span><span class="op" id="3810327">)</span>&nbsp;<span class="ident" id="3810329">OCSPResponse</span><span class="op" id="3810341">(</span><span class="op" id="3810342">)</span>&nbsp;<span class="op" id="3810344">[</span><span class="op" id="3810345">]</span><span class="builtintype" id="3810346">byte</span>&nbsp;<span class="op" id="3810351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810354">c</span><span class="op" id="3810355">.</span><span class="ident" id="3810356">handshakeMutex</span><span class="op" id="3810370">.</span><span class="ident" id="3810371">Lock</span><span class="op" id="3810375">(</span><span class="op" id="3810376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810379">defer</span>&nbsp;<span class="ident" id="3810385">c</span><span class="op" id="3810386">.</span><span class="ident" id="3810387">handshakeMutex</span><span class="op" id="3810401">.</span><span class="ident" id="3810402">Unlock</span><span class="op" id="3810408">(</span><span class="op" id="3810409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810413">return</span>&nbsp;<span class="ident" id="3810420">c</span><span class="op" id="3810421">.</span><span class="ident" id="3810422">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3810435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3810438">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3810508">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3810583">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3810610">func</span>&nbsp;<span class="op" id="3810615">(</span><span class="ident" id="3810616">c</span>&nbsp;<span class="op" id="3810618">*</span><span class="ident" id="3810619">Conn</span><span class="op" id="3810623">)</span>&nbsp;<span class="ident" id="3810625">VerifyHostname</span><span class="op" id="3810639">(</span><span class="ident" id="3810640">host</span>&nbsp;<span class="builtintype" id="3810645">string</span><span class="op" id="3810651">)</span>&nbsp;<span class="builtintype" id="3810653">error</span>&nbsp;<span class="op" id="3810659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810662">c</span><span class="op" id="3810663">.</span><span class="ident" id="3810664">handshakeMutex</span><span class="op" id="3810678">.</span><span class="ident" id="3810679">Lock</span><span class="op" id="3810683">(</span><span class="op" id="3810684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810687">defer</span>&nbsp;<span class="ident" id="3810693">c</span><span class="op" id="3810694">.</span><span class="ident" id="3810695">handshakeMutex</span><span class="op" id="3810709">.</span><span class="ident" id="3810710">Unlock</span><span class="op" id="3810716">(</span><span class="op" id="3810717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810720">if</span>&nbsp;<span class="op" id="3810723">!</span><span class="ident" id="3810724">c</span><span class="op" id="3810725">.</span><span class="ident" id="3810726">isClient</span>&nbsp;<span class="op" id="3810735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810739">return</span>&nbsp;<span class="ident" id="3810746">errors</span><span class="op" id="3810752">.</span><span class="ident" id="3810753">New</span><span class="op" id="3810756">(</span><span class="string" id="3810757">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3810810">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810816">if</span>&nbsp;<span class="op" id="3810819">!</span><span class="ident" id="3810820">c</span><span class="op" id="3810821">.</span><span class="ident" id="3810822">handshakeComplete</span>&nbsp;<span class="op" id="3810840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810844">return</span>&nbsp;<span class="ident" id="3810851">errors</span><span class="op" id="3810857">.</span><span class="ident" id="3810858">New</span><span class="op" id="3810861">(</span><span class="string" id="3810862">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3810905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810911">return</span>&nbsp;<span class="ident" id="3810918">c</span><span class="op" id="3810919">.</span><span class="ident" id="3810920">peerCertificates</span><span class="op" id="3810936">[</span><span class="num" id="3810937">0</span><span class="op" id="3810938">]</span><span class="op" id="3810939">.</span><span class="ident" id="3810940">VerifyHostname</span><span class="op" id="3810954">(</span><span class="ident" id="3810955">host</span><span class="op" id="3810959">)</span><br>
<span class="lineno">1030</span><span class="op" id="3810961">}</span>
</div>
</body>
</html>
