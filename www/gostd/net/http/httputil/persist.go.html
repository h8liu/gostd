<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6341114">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6341169">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6341223">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6341274">package</span>&nbsp;<span class="ident" id="6341282">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6341292">import</span>&nbsp;<span class="op" id="6341299">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341302">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341311">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341321">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341327">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341334">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341346">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341363">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6341370">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6341373">var</span>&nbsp;<span class="op" id="6341377">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341380">ErrPersistEOF</span>&nbsp;<span class="op" id="6341394">=</span>&nbsp;<span class="op" id="6341396">&amp;</span><span class="ident" id="6341397">http</span><span class="op" id="6341401">.</span><span class="ident" id="6341402">ProtocolError</span><span class="op" id="6341415">{</span><span class="ident" id="6341416">ErrorString</span><span class="op" id="6341427">:</span>&nbsp;<span class="string" id="6341429">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6341459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341462">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6341476">=</span>&nbsp;<span class="op" id="6341478">&amp;</span><span class="ident" id="6341479">http</span><span class="op" id="6341483">.</span><span class="ident" id="6341484">ProtocolError</span><span class="op" id="6341497">{</span><span class="ident" id="6341498">ErrorString</span><span class="op" id="6341509">:</span>&nbsp;<span class="string" id="6341511">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6341538">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341541">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6341555">=</span>&nbsp;<span class="op" id="6341557">&amp;</span><span class="ident" id="6341558">http</span><span class="op" id="6341562">.</span><span class="ident" id="6341563">ProtocolError</span><span class="op" id="6341576">{</span><span class="ident" id="6341577">ErrorString</span><span class="op" id="6341588">:</span>&nbsp;<span class="string" id="6341590">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6341606">}</span><br>
<span class="lineno"></span><span class="op" id="6341608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6341611">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6341669">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6341734">var</span>&nbsp;<span class="ident" id="6341738">errClosed</span>&nbsp;<span class="op" id="6341748">=</span>&nbsp;<span class="ident" id="6341750">errors</span><span class="op" id="6341756">.</span><span class="ident" id="6341757">New</span><span class="op" id="6341760">(</span><span class="string" id="6341761">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6341797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6341800">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6341870">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6341944">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6342013">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6342088">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6342163">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6342197">//</span><br>
<span class="lineno"></span><span class="comment" id="6342200">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6342275">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6342303">type</span>&nbsp;<span class="ident" id="6342308">ServerConn</span>&nbsp;<span class="keyword" id="6342319">struct</span>&nbsp;<span class="op" id="6342326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342329">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342345">sync</span><span class="op" id="6342349">.</span><span class="ident" id="6342350">Mutex</span>&nbsp;<span class="comment" id="6342356">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342401">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342417">net</span><span class="op" id="6342420">.</span><span class="ident" id="6342421">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342427">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342443">*</span><span class="ident" id="6342444">bufio</span><span class="op" id="6342449">.</span><span class="ident" id="6342450">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342458">re</span><span class="op" id="6342460">,</span>&nbsp;<span class="ident" id="6342462">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6342474">error</span>&nbsp;<span class="comment" id="6342480">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342502">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342518">io</span><span class="op" id="6342520">.</span><span class="ident" id="6342521">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342533">nread</span><span class="op" id="6342538">,</span>&nbsp;<span class="ident" id="6342540">nwritten</span>&nbsp;<span class="builtintype" id="6342549">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342554">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342570">map</span><span class="op" id="6342573">[</span><span class="op" id="6342574">*</span><span class="ident" id="6342575">http</span><span class="op" id="6342579">.</span><span class="ident" id="6342580">Request</span><span class="op" id="6342587">]</span><span class="builtintype" id="6342588">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342595">pipe</span>&nbsp;<span class="ident" id="6342600">textproto</span><span class="op" id="6342609">.</span><span class="ident" id="6342610">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6342619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6342622">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6342699">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6342747">//</span><br>
<span class="lineno"></span><span class="comment" id="6342750">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6342825">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6342853">func</span>&nbsp;<span class="ident" id="6342858">NewServerConn</span><span class="op" id="6342871">(</span><span class="ident" id="6342872">c</span>&nbsp;<span class="ident" id="6342874">net</span><span class="op" id="6342877">.</span><span class="ident" id="6342878">Conn</span><span class="op" id="6342882">,</span>&nbsp;<span class="ident" id="6342884">r</span>&nbsp;<span class="op" id="6342886">*</span><span class="ident" id="6342887">bufio</span><span class="op" id="6342892">.</span><span class="ident" id="6342893">Reader</span><span class="op" id="6342899">)</span>&nbsp;<span class="op" id="6342901">*</span><span class="ident" id="6342902">ServerConn</span>&nbsp;<span class="op" id="6342913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342916">if</span>&nbsp;<span class="ident" id="6342919">r</span>&nbsp;<span class="op" id="6342921">==</span>&nbsp;<span class="ident" id="6342924">nil</span>&nbsp;<span class="op" id="6342928">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342932">r</span>&nbsp;<span class="op" id="6342934">=</span>&nbsp;<span class="ident" id="6342936">bufio</span><span class="op" id="6342941">.</span><span class="ident" id="6342942">NewReader</span><span class="op" id="6342951">(</span><span class="ident" id="6342952">c</span><span class="op" id="6342953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342959">return</span>&nbsp;<span class="op" id="6342966">&amp;</span><span class="ident" id="6342967">ServerConn</span><span class="op" id="6342977">{</span><span class="ident" id="6342978">c</span><span class="op" id="6342979">:</span>&nbsp;<span class="ident" id="6342981">c</span><span class="op" id="6342982">,</span>&nbsp;<span class="ident" id="6342984">r</span><span class="op" id="6342985">:</span>&nbsp;<span class="ident" id="6342987">r</span><span class="op" id="6342988">,</span>&nbsp;<span class="ident" id="6342990">pipereq</span><span class="op" id="6342997">:</span>&nbsp;<span class="builtinfunc" id="6342999">make</span><span class="op" id="6343003">(</span><span class="keyword" id="6343004">map</span><span class="op" id="6343007">[</span><span class="op" id="6343008">*</span><span class="ident" id="6343009">http</span><span class="op" id="6343013">.</span><span class="ident" id="6343014">Request</span><span class="op" id="6343021">]</span><span class="builtintype" id="6343022">uint</span><span class="op" id="6343026">)</span><span class="op" id="6343027">}</span><br>
<span class="lineno"></span><span class="op" id="6343029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6343032">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6343112">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6343188">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6343265">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6343327">func</span>&nbsp;<span class="op" id="6343332">(</span><span class="ident" id="6343333">sc</span>&nbsp;<span class="op" id="6343336">*</span><span class="ident" id="6343337">ServerConn</span><span class="op" id="6343347">)</span>&nbsp;<span class="ident" id="6343349">Hijack</span><span class="op" id="6343355">(</span><span class="op" id="6343356">)</span>&nbsp;<span class="op" id="6343358">(</span><span class="ident" id="6343359">c</span>&nbsp;<span class="ident" id="6343361">net</span><span class="op" id="6343364">.</span><span class="ident" id="6343365">Conn</span><span class="op" id="6343369">,</span>&nbsp;<span class="ident" id="6343371">r</span>&nbsp;<span class="op" id="6343373">*</span><span class="ident" id="6343374">bufio</span><span class="op" id="6343379">.</span><span class="ident" id="6343380">Reader</span><span class="op" id="6343386">)</span>&nbsp;<span class="op" id="6343388">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343391">sc</span><span class="op" id="6343393">.</span><span class="ident" id="6343394">lk</span><span class="op" id="6343396">.</span><span class="ident" id="6343397">Lock</span><span class="op" id="6343401">(</span><span class="op" id="6343402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343405">defer</span>&nbsp;<span class="ident" id="6343411">sc</span><span class="op" id="6343413">.</span><span class="ident" id="6343414">lk</span><span class="op" id="6343416">.</span><span class="ident" id="6343417">Unlock</span><span class="op" id="6343423">(</span><span class="op" id="6343424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343427">c</span>&nbsp;<span class="op" id="6343429">=</span>&nbsp;<span class="ident" id="6343431">sc</span><span class="op" id="6343433">.</span><span class="ident" id="6343434">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343437">r</span>&nbsp;<span class="op" id="6343439">=</span>&nbsp;<span class="ident" id="6343441">sc</span><span class="op" id="6343443">.</span><span class="ident" id="6343444">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343447">sc</span><span class="op" id="6343449">.</span><span class="ident" id="6343450">c</span>&nbsp;<span class="op" id="6343452">=</span>&nbsp;<span class="ident" id="6343454">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343459">sc</span><span class="op" id="6343461">.</span><span class="ident" id="6343462">r</span>&nbsp;<span class="op" id="6343464">=</span>&nbsp;<span class="ident" id="6343466">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343471">return</span><br>
<span class="lineno"></span><span class="op" id="6343478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6343481">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6343550">func</span>&nbsp;<span class="op" id="6343555">(</span><span class="ident" id="6343556">sc</span>&nbsp;<span class="op" id="6343559">*</span><span class="ident" id="6343560">ServerConn</span><span class="op" id="6343570">)</span>&nbsp;<span class="ident" id="6343572">Close</span><span class="op" id="6343577">(</span><span class="op" id="6343578">)</span>&nbsp;<span class="builtintype" id="6343580">error</span>&nbsp;<span class="op" id="6343586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343589">c</span><span class="op" id="6343590">,</span>&nbsp;<span class="ident" id="6343592">_</span>&nbsp;<span class="op" id="6343594">:=</span>&nbsp;<span class="ident" id="6343597">sc</span><span class="op" id="6343599">.</span><span class="ident" id="6343600">Hijack</span><span class="op" id="6343606">(</span><span class="op" id="6343607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343610">if</span>&nbsp;<span class="ident" id="6343613">c</span>&nbsp;<span class="op" id="6343615">!=</span>&nbsp;<span class="ident" id="6343618">nil</span>&nbsp;<span class="op" id="6343622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343626">return</span>&nbsp;<span class="ident" id="6343633">c</span><span class="op" id="6343634">.</span><span class="ident" id="6343635">Close</span><span class="op" id="6343640">(</span><span class="op" id="6343641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343644">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343647">return</span>&nbsp;<span class="ident" id="6343654">nil</span><br>
<span class="lineno"></span><span class="op" id="6343658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6343661">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6343739">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6343818">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6343895">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6343920">func</span>&nbsp;<span class="op" id="6343925">(</span><span class="ident" id="6343926">sc</span>&nbsp;<span class="op" id="6343929">*</span><span class="ident" id="6343930">ServerConn</span><span class="op" id="6343940">)</span>&nbsp;<span class="ident" id="6343942">Read</span><span class="op" id="6343946">(</span><span class="op" id="6343947">)</span>&nbsp;<span class="op" id="6343949">(</span><span class="ident" id="6343950">req</span>&nbsp;<span class="op" id="6343954">*</span><span class="ident" id="6343955">http</span><span class="op" id="6343959">.</span><span class="ident" id="6343960">Request</span><span class="op" id="6343967">,</span>&nbsp;<span class="ident" id="6343969">err</span>&nbsp;<span class="builtintype" id="6343973">error</span><span class="op" id="6343978">)</span>&nbsp;<span class="op" id="6343980">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343984">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344033">id</span>&nbsp;<span class="op" id="6344036">:=</span>&nbsp;<span class="ident" id="6344039">sc</span><span class="op" id="6344041">.</span><span class="ident" id="6344042">pipe</span><span class="op" id="6344046">.</span><span class="ident" id="6344047">Next</span><span class="op" id="6344051">(</span><span class="op" id="6344052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344055">sc</span><span class="op" id="6344057">.</span><span class="ident" id="6344058">pipe</span><span class="op" id="6344062">.</span><span class="ident" id="6344063">StartRequest</span><span class="op" id="6344075">(</span><span class="ident" id="6344076">id</span><span class="op" id="6344078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344081">defer</span>&nbsp;<span class="keyword" id="6344087">func</span><span class="op" id="6344091">(</span><span class="op" id="6344092">)</span>&nbsp;<span class="op" id="6344094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344098">sc</span><span class="op" id="6344100">.</span><span class="ident" id="6344101">pipe</span><span class="op" id="6344105">.</span><span class="ident" id="6344106">EndRequest</span><span class="op" id="6344116">(</span><span class="ident" id="6344117">id</span><span class="op" id="6344119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344123">if</span>&nbsp;<span class="ident" id="6344126">req</span>&nbsp;<span class="op" id="6344130">==</span>&nbsp;<span class="ident" id="6344133">nil</span>&nbsp;<span class="op" id="6344137">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344142">sc</span><span class="op" id="6344144">.</span><span class="ident" id="6344145">pipe</span><span class="op" id="6344149">.</span><span class="ident" id="6344150">StartResponse</span><span class="op" id="6344163">(</span><span class="ident" id="6344164">id</span><span class="op" id="6344166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344171">sc</span><span class="op" id="6344173">.</span><span class="ident" id="6344174">pipe</span><span class="op" id="6344178">.</span><span class="ident" id="6344179">EndResponse</span><span class="op" id="6344190">(</span><span class="ident" id="6344191">id</span><span class="op" id="6344193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344197">}</span>&nbsp;<span class="keyword" id="6344199">else</span>&nbsp;<span class="op" id="6344204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344209">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344256">sc</span><span class="op" id="6344258">.</span><span class="ident" id="6344259">lk</span><span class="op" id="6344261">.</span><span class="ident" id="6344262">Lock</span><span class="op" id="6344266">(</span><span class="op" id="6344267">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344272">sc</span><span class="op" id="6344274">.</span><span class="ident" id="6344275">pipereq</span><span class="op" id="6344282">[</span><span class="ident" id="6344283">req</span><span class="op" id="6344286">]</span>&nbsp;<span class="op" id="6344288">=</span>&nbsp;<span class="ident" id="6344290">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344296">sc</span><span class="op" id="6344298">.</span><span class="ident" id="6344299">lk</span><span class="op" id="6344301">.</span><span class="ident" id="6344302">Unlock</span><span class="op" id="6344308">(</span><span class="op" id="6344309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344316">}</span><span class="op" id="6344317">(</span><span class="op" id="6344318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344322">sc</span><span class="op" id="6344324">.</span><span class="ident" id="6344325">lk</span><span class="op" id="6344327">.</span><span class="ident" id="6344328">Lock</span><span class="op" id="6344332">(</span><span class="op" id="6344333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344336">if</span>&nbsp;<span class="ident" id="6344339">sc</span><span class="op" id="6344341">.</span><span class="ident" id="6344342">we</span>&nbsp;<span class="op" id="6344345">!=</span>&nbsp;<span class="ident" id="6344348">nil</span>&nbsp;<span class="op" id="6344352">{</span>&nbsp;<span class="comment" id="6344354">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344409">defer</span>&nbsp;<span class="ident" id="6344415">sc</span><span class="op" id="6344417">.</span><span class="ident" id="6344418">lk</span><span class="op" id="6344420">.</span><span class="ident" id="6344421">Unlock</span><span class="op" id="6344427">(</span><span class="op" id="6344428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344432">return</span>&nbsp;<span class="ident" id="6344439">nil</span><span class="op" id="6344442">,</span>&nbsp;<span class="ident" id="6344444">sc</span><span class="op" id="6344446">.</span><span class="ident" id="6344447">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344451">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344454">if</span>&nbsp;<span class="ident" id="6344457">sc</span><span class="op" id="6344459">.</span><span class="ident" id="6344460">re</span>&nbsp;<span class="op" id="6344463">!=</span>&nbsp;<span class="ident" id="6344466">nil</span>&nbsp;<span class="op" id="6344470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344474">defer</span>&nbsp;<span class="ident" id="6344480">sc</span><span class="op" id="6344482">.</span><span class="ident" id="6344483">lk</span><span class="op" id="6344485">.</span><span class="ident" id="6344486">Unlock</span><span class="op" id="6344492">(</span><span class="op" id="6344493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344497">return</span>&nbsp;<span class="ident" id="6344504">nil</span><span class="op" id="6344507">,</span>&nbsp;<span class="ident" id="6344509">sc</span><span class="op" id="6344511">.</span><span class="ident" id="6344512">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344519">if</span>&nbsp;<span class="ident" id="6344522">sc</span><span class="op" id="6344524">.</span><span class="ident" id="6344525">r</span>&nbsp;<span class="op" id="6344527">==</span>&nbsp;<span class="ident" id="6344530">nil</span>&nbsp;<span class="op" id="6344534">{</span>&nbsp;<span class="comment" id="6344536">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344583">defer</span>&nbsp;<span class="ident" id="6344589">sc</span><span class="op" id="6344591">.</span><span class="ident" id="6344592">lk</span><span class="op" id="6344594">.</span><span class="ident" id="6344595">Unlock</span><span class="op" id="6344601">(</span><span class="op" id="6344602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344606">return</span>&nbsp;<span class="ident" id="6344613">nil</span><span class="op" id="6344616">,</span>&nbsp;<span class="ident" id="6344618">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344632">r</span>&nbsp;<span class="op" id="6344634">:=</span>&nbsp;<span class="ident" id="6344637">sc</span><span class="op" id="6344639">.</span><span class="ident" id="6344640">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344643">lastbody</span>&nbsp;<span class="op" id="6344652">:=</span>&nbsp;<span class="ident" id="6344655">sc</span><span class="op" id="6344657">.</span><span class="ident" id="6344658">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344668">sc</span><span class="op" id="6344670">.</span><span class="ident" id="6344671">lastbody</span>&nbsp;<span class="op" id="6344680">=</span>&nbsp;<span class="ident" id="6344682">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344687">sc</span><span class="op" id="6344689">.</span><span class="ident" id="6344690">lk</span><span class="op" id="6344692">.</span><span class="ident" id="6344693">Unlock</span><span class="op" id="6344699">(</span><span class="op" id="6344700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344704">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344780">if</span>&nbsp;<span class="ident" id="6344783">lastbody</span>&nbsp;<span class="op" id="6344792">!=</span>&nbsp;<span class="ident" id="6344795">nil</span>&nbsp;<span class="op" id="6344799">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344803">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344869">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6344927">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344942">err</span>&nbsp;<span class="op" id="6344946">=</span>&nbsp;<span class="ident" id="6344948">lastbody</span><span class="op" id="6344956">.</span><span class="ident" id="6344957">Close</span><span class="op" id="6344962">(</span><span class="op" id="6344963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344967">if</span>&nbsp;<span class="ident" id="6344970">err</span>&nbsp;<span class="op" id="6344974">!=</span>&nbsp;<span class="ident" id="6344977">nil</span>&nbsp;<span class="op" id="6344981">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344986">sc</span><span class="op" id="6344988">.</span><span class="ident" id="6344989">lk</span><span class="op" id="6344991">.</span><span class="ident" id="6344992">Lock</span><span class="op" id="6344996">(</span><span class="op" id="6344997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345002">defer</span>&nbsp;<span class="ident" id="6345008">sc</span><span class="op" id="6345010">.</span><span class="ident" id="6345011">lk</span><span class="op" id="6345013">.</span><span class="ident" id="6345014">Unlock</span><span class="op" id="6345020">(</span><span class="op" id="6345021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345026">sc</span><span class="op" id="6345028">.</span><span class="ident" id="6345029">re</span>&nbsp;<span class="op" id="6345032">=</span>&nbsp;<span class="ident" id="6345034">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345041">return</span>&nbsp;<span class="ident" id="6345048">nil</span><span class="op" id="6345051">,</span>&nbsp;<span class="ident" id="6345053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345059">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345066">req</span><span class="op" id="6345069">,</span>&nbsp;<span class="ident" id="6345071">err</span>&nbsp;<span class="op" id="6345075">=</span>&nbsp;<span class="ident" id="6345077">http</span><span class="op" id="6345081">.</span><span class="ident" id="6345082">ReadRequest</span><span class="op" id="6345093">(</span><span class="ident" id="6345094">r</span><span class="op" id="6345095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345098">sc</span><span class="op" id="6345100">.</span><span class="ident" id="6345101">lk</span><span class="op" id="6345103">.</span><span class="ident" id="6345104">Lock</span><span class="op" id="6345108">(</span><span class="op" id="6345109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345112">defer</span>&nbsp;<span class="ident" id="6345118">sc</span><span class="op" id="6345120">.</span><span class="ident" id="6345121">lk</span><span class="op" id="6345123">.</span><span class="ident" id="6345124">Unlock</span><span class="op" id="6345130">(</span><span class="op" id="6345131">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345134">if</span>&nbsp;<span class="ident" id="6345137">err</span>&nbsp;<span class="op" id="6345141">!=</span>&nbsp;<span class="ident" id="6345144">nil</span>&nbsp;<span class="op" id="6345148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345152">if</span>&nbsp;<span class="ident" id="6345155">err</span>&nbsp;<span class="op" id="6345159">==</span>&nbsp;<span class="ident" id="6345162">io</span><span class="op" id="6345164">.</span><span class="ident" id="6345165">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6345182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345187">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345242">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345300">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345329">sc</span><span class="op" id="6345331">.</span><span class="ident" id="6345332">re</span>&nbsp;<span class="op" id="6345335">=</span>&nbsp;<span class="ident" id="6345337">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345354">return</span>&nbsp;<span class="ident" id="6345361">nil</span><span class="op" id="6345364">,</span>&nbsp;<span class="ident" id="6345366">sc</span><span class="op" id="6345368">.</span><span class="ident" id="6345369">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345374">}</span>&nbsp;<span class="keyword" id="6345376">else</span>&nbsp;<span class="op" id="6345381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345386">sc</span><span class="op" id="6345388">.</span><span class="ident" id="6345389">re</span>&nbsp;<span class="op" id="6345392">=</span>&nbsp;<span class="ident" id="6345394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345401">return</span>&nbsp;<span class="ident" id="6345408">req</span><span class="op" id="6345411">,</span>&nbsp;<span class="ident" id="6345413">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345425">sc</span><span class="op" id="6345427">.</span><span class="ident" id="6345428">lastbody</span>&nbsp;<span class="op" id="6345437">=</span>&nbsp;<span class="ident" id="6345439">req</span><span class="op" id="6345442">.</span><span class="ident" id="6345443">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345449">sc</span><span class="op" id="6345451">.</span><span class="ident" id="6345452">nread</span><span class="op" id="6345457">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345461">if</span>&nbsp;<span class="ident" id="6345464">req</span><span class="op" id="6345467">.</span><span class="ident" id="6345468">Close</span>&nbsp;<span class="op" id="6345474">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345478">sc</span><span class="op" id="6345480">.</span><span class="ident" id="6345481">re</span>&nbsp;<span class="op" id="6345484">=</span>&nbsp;<span class="ident" id="6345486">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345502">return</span>&nbsp;<span class="ident" id="6345509">req</span><span class="op" id="6345512">,</span>&nbsp;<span class="ident" id="6345514">sc</span><span class="op" id="6345516">.</span><span class="ident" id="6345517">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345524">return</span>&nbsp;<span class="ident" id="6345531">req</span><span class="op" id="6345534">,</span>&nbsp;<span class="ident" id="6345536">err</span><br>
<span class="lineno"></span><span class="op" id="6345540">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6345543">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6345596">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6345642">func</span>&nbsp;<span class="op" id="6345647">(</span><span class="ident" id="6345648">sc</span>&nbsp;<span class="op" id="6345651">*</span><span class="ident" id="6345652">ServerConn</span><span class="op" id="6345662">)</span>&nbsp;<span class="ident" id="6345664">Pending</span><span class="op" id="6345671">(</span><span class="op" id="6345672">)</span>&nbsp;<span class="builtintype" id="6345674">int</span>&nbsp;<span class="op" id="6345678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345681">sc</span><span class="op" id="6345683">.</span><span class="ident" id="6345684">lk</span><span class="op" id="6345686">.</span><span class="ident" id="6345687">Lock</span><span class="op" id="6345691">(</span><span class="op" id="6345692">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345695">defer</span>&nbsp;<span class="ident" id="6345701">sc</span><span class="op" id="6345703">.</span><span class="ident" id="6345704">lk</span><span class="op" id="6345706">.</span><span class="ident" id="6345707">Unlock</span><span class="op" id="6345713">(</span><span class="op" id="6345714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345717">return</span>&nbsp;<span class="ident" id="6345724">sc</span><span class="op" id="6345726">.</span><span class="ident" id="6345727">nread</span>&nbsp;<span class="op" id="6345733">-</span>&nbsp;<span class="ident" id="6345735">sc</span><span class="op" id="6345737">.</span><span class="ident" id="6345738">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6345747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6345750">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6345835">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6345913">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6345989">func</span>&nbsp;<span class="op" id="6345994">(</span><span class="ident" id="6345995">sc</span>&nbsp;<span class="op" id="6345998">*</span><span class="ident" id="6345999">ServerConn</span><span class="op" id="6346009">)</span>&nbsp;<span class="ident" id="6346011">Write</span><span class="op" id="6346016">(</span><span class="ident" id="6346017">req</span>&nbsp;<span class="op" id="6346021">*</span><span class="ident" id="6346022">http</span><span class="op" id="6346026">.</span><span class="ident" id="6346027">Request</span><span class="op" id="6346034">,</span>&nbsp;<span class="ident" id="6346036">resp</span>&nbsp;<span class="op" id="6346041">*</span><span class="ident" id="6346042">http</span><span class="op" id="6346046">.</span><span class="ident" id="6346047">Response</span><span class="op" id="6346055">)</span>&nbsp;<span class="builtintype" id="6346057">error</span>&nbsp;<span class="op" id="6346063">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346067">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346126">sc</span><span class="op" id="6346128">.</span><span class="ident" id="6346129">lk</span><span class="op" id="6346131">.</span><span class="ident" id="6346132">Lock</span><span class="op" id="6346136">(</span><span class="op" id="6346137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346140">id</span><span class="op" id="6346142">,</span>&nbsp;<span class="ident" id="6346144">ok</span>&nbsp;<span class="op" id="6346147">:=</span>&nbsp;<span class="ident" id="6346150">sc</span><span class="op" id="6346152">.</span><span class="ident" id="6346153">pipereq</span><span class="op" id="6346160">[</span><span class="ident" id="6346161">req</span><span class="op" id="6346164">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6346167">delete</span><span class="op" id="6346173">(</span><span class="ident" id="6346174">sc</span><span class="op" id="6346176">.</span><span class="ident" id="6346177">pipereq</span><span class="op" id="6346184">,</span>&nbsp;<span class="ident" id="6346186">req</span><span class="op" id="6346189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346192">if</span>&nbsp;<span class="op" id="6346195">!</span><span class="ident" id="6346196">ok</span>&nbsp;<span class="op" id="6346199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346203">sc</span><span class="op" id="6346205">.</span><span class="ident" id="6346206">lk</span><span class="op" id="6346208">.</span><span class="ident" id="6346209">Unlock</span><span class="op" id="6346215">(</span><span class="op" id="6346216">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346220">return</span>&nbsp;<span class="ident" id="6346227">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346243">sc</span><span class="op" id="6346245">.</span><span class="ident" id="6346246">lk</span><span class="op" id="6346248">.</span><span class="ident" id="6346249">Unlock</span><span class="op" id="6346255">(</span><span class="op" id="6346256">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346260">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346286">sc</span><span class="op" id="6346288">.</span><span class="ident" id="6346289">pipe</span><span class="op" id="6346293">.</span><span class="ident" id="6346294">StartResponse</span><span class="op" id="6346307">(</span><span class="ident" id="6346308">id</span><span class="op" id="6346310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346313">defer</span>&nbsp;<span class="ident" id="6346319">sc</span><span class="op" id="6346321">.</span><span class="ident" id="6346322">pipe</span><span class="op" id="6346326">.</span><span class="ident" id="6346327">EndResponse</span><span class="op" id="6346338">(</span><span class="ident" id="6346339">id</span><span class="op" id="6346341">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346345">sc</span><span class="op" id="6346347">.</span><span class="ident" id="6346348">lk</span><span class="op" id="6346350">.</span><span class="ident" id="6346351">Lock</span><span class="op" id="6346355">(</span><span class="op" id="6346356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346359">if</span>&nbsp;<span class="ident" id="6346362">sc</span><span class="op" id="6346364">.</span><span class="ident" id="6346365">we</span>&nbsp;<span class="op" id="6346368">!=</span>&nbsp;<span class="ident" id="6346371">nil</span>&nbsp;<span class="op" id="6346375">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346379">defer</span>&nbsp;<span class="ident" id="6346385">sc</span><span class="op" id="6346387">.</span><span class="ident" id="6346388">lk</span><span class="op" id="6346390">.</span><span class="ident" id="6346391">Unlock</span><span class="op" id="6346397">(</span><span class="op" id="6346398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346402">return</span>&nbsp;<span class="ident" id="6346409">sc</span><span class="op" id="6346411">.</span><span class="ident" id="6346412">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346419">if</span>&nbsp;<span class="ident" id="6346422">sc</span><span class="op" id="6346424">.</span><span class="ident" id="6346425">c</span>&nbsp;<span class="op" id="6346427">==</span>&nbsp;<span class="ident" id="6346430">nil</span>&nbsp;<span class="op" id="6346434">{</span>&nbsp;<span class="comment" id="6346436">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346483">defer</span>&nbsp;<span class="ident" id="6346489">sc</span><span class="op" id="6346491">.</span><span class="ident" id="6346492">lk</span><span class="op" id="6346494">.</span><span class="ident" id="6346495">Unlock</span><span class="op" id="6346501">(</span><span class="op" id="6346502">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346506">return</span>&nbsp;<span class="ident" id="6346513">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346527">c</span>&nbsp;<span class="op" id="6346529">:=</span>&nbsp;<span class="ident" id="6346532">sc</span><span class="op" id="6346534">.</span><span class="ident" id="6346535">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346538">if</span>&nbsp;<span class="ident" id="6346541">sc</span><span class="op" id="6346543">.</span><span class="ident" id="6346544">nread</span>&nbsp;<span class="op" id="6346550">&lt;=</span>&nbsp;<span class="ident" id="6346553">sc</span><span class="op" id="6346555">.</span><span class="ident" id="6346556">nwritten</span>&nbsp;<span class="op" id="6346565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346569">defer</span>&nbsp;<span class="ident" id="6346575">sc</span><span class="op" id="6346577">.</span><span class="ident" id="6346578">lk</span><span class="op" id="6346580">.</span><span class="ident" id="6346581">Unlock</span><span class="op" id="6346587">(</span><span class="op" id="6346588">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346592">return</span>&nbsp;<span class="ident" id="6346599">errors</span><span class="op" id="6346605">.</span><span class="ident" id="6346606">New</span><span class="op" id="6346609">(</span><span class="string" id="6346610">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6346637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346643">if</span>&nbsp;<span class="ident" id="6346646">resp</span><span class="op" id="6346650">.</span><span class="ident" id="6346651">Close</span>&nbsp;<span class="op" id="6346657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346661">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346723">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346786">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346809">sc</span><span class="op" id="6346811">.</span><span class="ident" id="6346812">re</span>&nbsp;<span class="op" id="6346815">=</span>&nbsp;<span class="ident" id="6346817">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346835">sc</span><span class="op" id="6346837">.</span><span class="ident" id="6346838">lk</span><span class="op" id="6346840">.</span><span class="ident" id="6346841">Unlock</span><span class="op" id="6346847">(</span><span class="op" id="6346848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346852">err</span>&nbsp;<span class="op" id="6346856">:=</span>&nbsp;<span class="ident" id="6346859">resp</span><span class="op" id="6346863">.</span><span class="ident" id="6346864">Write</span><span class="op" id="6346869">(</span><span class="ident" id="6346870">c</span><span class="op" id="6346871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346874">sc</span><span class="op" id="6346876">.</span><span class="ident" id="6346877">lk</span><span class="op" id="6346879">.</span><span class="ident" id="6346880">Lock</span><span class="op" id="6346884">(</span><span class="op" id="6346885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346888">defer</span>&nbsp;<span class="ident" id="6346894">sc</span><span class="op" id="6346896">.</span><span class="ident" id="6346897">lk</span><span class="op" id="6346899">.</span><span class="ident" id="6346900">Unlock</span><span class="op" id="6346906">(</span><span class="op" id="6346907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346910">if</span>&nbsp;<span class="ident" id="6346913">err</span>&nbsp;<span class="op" id="6346917">!=</span>&nbsp;<span class="ident" id="6346920">nil</span>&nbsp;<span class="op" id="6346924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346928">sc</span><span class="op" id="6346930">.</span><span class="ident" id="6346931">we</span>&nbsp;<span class="op" id="6346934">=</span>&nbsp;<span class="ident" id="6346936">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346942">return</span>&nbsp;<span class="ident" id="6346949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346957">sc</span><span class="op" id="6346959">.</span><span class="ident" id="6346960">nwritten</span><span class="op" id="6346968">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346973">return</span>&nbsp;<span class="ident" id="6346980">nil</span><br>
<span class="lineno">220</span><span class="op" id="6346984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6346987">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6347057">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6347126">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6347181">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6347255">//</span><br>
<span class="lineno"></span><span class="comment" id="6347258">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6347326">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6347374">type</span>&nbsp;<span class="ident" id="6347379">ClientConn</span>&nbsp;<span class="keyword" id="6347390">struct</span>&nbsp;<span class="op" id="6347397">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347400">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347416">sync</span><span class="op" id="6347420">.</span><span class="ident" id="6347421">Mutex</span>&nbsp;<span class="comment" id="6347427">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347472">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347488">net</span><span class="op" id="6347491">.</span><span class="ident" id="6347492">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347498">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347514">*</span><span class="ident" id="6347515">bufio</span><span class="op" id="6347520">.</span><span class="ident" id="6347521">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347529">re</span><span class="op" id="6347531">,</span>&nbsp;<span class="ident" id="6347533">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6347545">error</span>&nbsp;<span class="comment" id="6347551">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347573">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347589">io</span><span class="op" id="6347591">.</span><span class="ident" id="6347592">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347604">nread</span><span class="op" id="6347609">,</span>&nbsp;<span class="ident" id="6347611">nwritten</span>&nbsp;<span class="builtintype" id="6347620">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347625">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347641">map</span><span class="op" id="6347644">[</span><span class="op" id="6347645">*</span><span class="ident" id="6347646">http</span><span class="op" id="6347650">.</span><span class="ident" id="6347651">Request</span><span class="op" id="6347658">]</span><span class="builtintype" id="6347659">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347666">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347675">textproto</span><span class="op" id="6347684">.</span><span class="ident" id="6347685">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347695">writeReq</span>&nbsp;<span class="keyword" id="6347704">func</span><span class="op" id="6347708">(</span><span class="op" id="6347709">*</span><span class="ident" id="6347710">http</span><span class="op" id="6347714">.</span><span class="ident" id="6347715">Request</span><span class="op" id="6347722">,</span>&nbsp;<span class="ident" id="6347724">io</span><span class="op" id="6347726">.</span><span class="ident" id="6347727">Writer</span><span class="op" id="6347733">)</span>&nbsp;<span class="builtintype" id="6347735">error</span><br>
<span class="lineno">240</span><span class="op" id="6347741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6347744">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6347822">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6347870">//</span><br>
<span class="lineno">245</span><span class="comment" id="6347873">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6347943">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6347981">func</span>&nbsp;<span class="ident" id="6347986">NewClientConn</span><span class="op" id="6347999">(</span><span class="ident" id="6348000">c</span>&nbsp;<span class="ident" id="6348002">net</span><span class="op" id="6348005">.</span><span class="ident" id="6348006">Conn</span><span class="op" id="6348010">,</span>&nbsp;<span class="ident" id="6348012">r</span>&nbsp;<span class="op" id="6348014">*</span><span class="ident" id="6348015">bufio</span><span class="op" id="6348020">.</span><span class="ident" id="6348021">Reader</span><span class="op" id="6348027">)</span>&nbsp;<span class="op" id="6348029">*</span><span class="ident" id="6348030">ClientConn</span>&nbsp;<span class="op" id="6348041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348044">if</span>&nbsp;<span class="ident" id="6348047">r</span>&nbsp;<span class="op" id="6348049">==</span>&nbsp;<span class="ident" id="6348052">nil</span>&nbsp;<span class="op" id="6348056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348060">r</span>&nbsp;<span class="op" id="6348062">=</span>&nbsp;<span class="ident" id="6348064">bufio</span><span class="op" id="6348069">.</span><span class="ident" id="6348070">NewReader</span><span class="op" id="6348079">(</span><span class="ident" id="6348080">c</span><span class="op" id="6348081">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348087">return</span>&nbsp;<span class="op" id="6348094">&amp;</span><span class="ident" id="6348095">ClientConn</span><span class="op" id="6348105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348109">c</span><span class="op" id="6348110">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348119">c</span><span class="op" id="6348120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348124">r</span><span class="op" id="6348125">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348134">r</span><span class="op" id="6348135">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348139">pipereq</span><span class="op" id="6348146">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6348149">make</span><span class="op" id="6348153">(</span><span class="keyword" id="6348154">map</span><span class="op" id="6348157">[</span><span class="op" id="6348158">*</span><span class="ident" id="6348159">http</span><span class="op" id="6348163">.</span><span class="ident" id="6348164">Request</span><span class="op" id="6348171">]</span><span class="builtintype" id="6348172">uint</span><span class="op" id="6348176">)</span><span class="op" id="6348177">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348181">writeReq</span><span class="op" id="6348189">:</span>&nbsp;<span class="op" id="6348191">(</span><span class="op" id="6348192">*</span><span class="ident" id="6348193">http</span><span class="op" id="6348197">.</span><span class="ident" id="6348198">Request</span><span class="op" id="6348205">)</span><span class="op" id="6348206">.</span><span class="ident" id="6348207">Write</span><span class="op" id="6348212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348215">}</span><br>
<span class="lineno"></span><span class="op" id="6348217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6348220">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6348287">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6348325">//</span><br>
<span class="lineno"></span><span class="comment" id="6348328">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6348389">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6348435">func</span>&nbsp;<span class="ident" id="6348440">NewProxyClientConn</span><span class="op" id="6348458">(</span><span class="ident" id="6348459">c</span>&nbsp;<span class="ident" id="6348461">net</span><span class="op" id="6348464">.</span><span class="ident" id="6348465">Conn</span><span class="op" id="6348469">,</span>&nbsp;<span class="ident" id="6348471">r</span>&nbsp;<span class="op" id="6348473">*</span><span class="ident" id="6348474">bufio</span><span class="op" id="6348479">.</span><span class="ident" id="6348480">Reader</span><span class="op" id="6348486">)</span>&nbsp;<span class="op" id="6348488">*</span><span class="ident" id="6348489">ClientConn</span>&nbsp;<span class="op" id="6348500">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348503">cc</span>&nbsp;<span class="op" id="6348506">:=</span>&nbsp;<span class="ident" id="6348509">NewClientConn</span><span class="op" id="6348522">(</span><span class="ident" id="6348523">c</span><span class="op" id="6348524">,</span>&nbsp;<span class="ident" id="6348526">r</span><span class="op" id="6348527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348530">cc</span><span class="op" id="6348532">.</span><span class="ident" id="6348533">writeReq</span>&nbsp;<span class="op" id="6348542">=</span>&nbsp;<span class="op" id="6348544">(</span><span class="op" id="6348545">*</span><span class="ident" id="6348546">http</span><span class="op" id="6348550">.</span><span class="ident" id="6348551">Request</span><span class="op" id="6348558">)</span><span class="op" id="6348559">.</span><span class="ident" id="6348560">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348572">return</span>&nbsp;<span class="ident" id="6348579">cc</span><br>
<span class="lineno"></span><span class="op" id="6348582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6348585">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6348665">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6348741">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6348815">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6348893">func</span>&nbsp;<span class="op" id="6348898">(</span><span class="ident" id="6348899">cc</span>&nbsp;<span class="op" id="6348902">*</span><span class="ident" id="6348903">ClientConn</span><span class="op" id="6348913">)</span>&nbsp;<span class="ident" id="6348915">Hijack</span><span class="op" id="6348921">(</span><span class="op" id="6348922">)</span>&nbsp;<span class="op" id="6348924">(</span><span class="ident" id="6348925">c</span>&nbsp;<span class="ident" id="6348927">net</span><span class="op" id="6348930">.</span><span class="ident" id="6348931">Conn</span><span class="op" id="6348935">,</span>&nbsp;<span class="ident" id="6348937">r</span>&nbsp;<span class="op" id="6348939">*</span><span class="ident" id="6348940">bufio</span><span class="op" id="6348945">.</span><span class="ident" id="6348946">Reader</span><span class="op" id="6348952">)</span>&nbsp;<span class="op" id="6348954">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348957">cc</span><span class="op" id="6348959">.</span><span class="ident" id="6348960">lk</span><span class="op" id="6348962">.</span><span class="ident" id="6348963">Lock</span><span class="op" id="6348967">(</span><span class="op" id="6348968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348971">defer</span>&nbsp;<span class="ident" id="6348977">cc</span><span class="op" id="6348979">.</span><span class="ident" id="6348980">lk</span><span class="op" id="6348982">.</span><span class="ident" id="6348983">Unlock</span><span class="op" id="6348989">(</span><span class="op" id="6348990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348993">c</span>&nbsp;<span class="op" id="6348995">=</span>&nbsp;<span class="ident" id="6348997">cc</span><span class="op" id="6348999">.</span><span class="ident" id="6349000">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349003">r</span>&nbsp;<span class="op" id="6349005">=</span>&nbsp;<span class="ident" id="6349007">cc</span><span class="op" id="6349009">.</span><span class="ident" id="6349010">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349013">cc</span><span class="op" id="6349015">.</span><span class="ident" id="6349016">c</span>&nbsp;<span class="op" id="6349018">=</span>&nbsp;<span class="ident" id="6349020">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349025">cc</span><span class="op" id="6349027">.</span><span class="ident" id="6349028">r</span>&nbsp;<span class="op" id="6349030">=</span>&nbsp;<span class="ident" id="6349032">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349037">return</span><br>
<span class="lineno"></span><span class="op" id="6349044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6349047">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6349116">func</span>&nbsp;<span class="op" id="6349121">(</span><span class="ident" id="6349122">cc</span>&nbsp;<span class="op" id="6349125">*</span><span class="ident" id="6349126">ClientConn</span><span class="op" id="6349136">)</span>&nbsp;<span class="ident" id="6349138">Close</span><span class="op" id="6349143">(</span><span class="op" id="6349144">)</span>&nbsp;<span class="builtintype" id="6349146">error</span>&nbsp;<span class="op" id="6349152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349155">c</span><span class="op" id="6349156">,</span>&nbsp;<span class="ident" id="6349158">_</span>&nbsp;<span class="op" id="6349160">:=</span>&nbsp;<span class="ident" id="6349163">cc</span><span class="op" id="6349165">.</span><span class="ident" id="6349166">Hijack</span><span class="op" id="6349172">(</span><span class="op" id="6349173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349176">if</span>&nbsp;<span class="ident" id="6349179">c</span>&nbsp;<span class="op" id="6349181">!=</span>&nbsp;<span class="ident" id="6349184">nil</span>&nbsp;<span class="op" id="6349188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349192">return</span>&nbsp;<span class="ident" id="6349199">c</span><span class="op" id="6349200">.</span><span class="ident" id="6349201">Close</span><span class="op" id="6349206">(</span><span class="op" id="6349207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349210">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349213">return</span>&nbsp;<span class="ident" id="6349220">nil</span><br>
<span class="lineno"></span><span class="op" id="6349224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6349227">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6349307">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6349384">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6349464">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6349539">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6349616">func</span>&nbsp;<span class="op" id="6349621">(</span><span class="ident" id="6349622">cc</span>&nbsp;<span class="op" id="6349625">*</span><span class="ident" id="6349626">ClientConn</span><span class="op" id="6349636">)</span>&nbsp;<span class="ident" id="6349638">Write</span><span class="op" id="6349643">(</span><span class="ident" id="6349644">req</span>&nbsp;<span class="op" id="6349648">*</span><span class="ident" id="6349649">http</span><span class="op" id="6349653">.</span><span class="ident" id="6349654">Request</span><span class="op" id="6349661">)</span>&nbsp;<span class="op" id="6349663">(</span><span class="ident" id="6349664">err</span>&nbsp;<span class="builtintype" id="6349668">error</span><span class="op" id="6349673">)</span>&nbsp;<span class="op" id="6349675">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349679">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349718">id</span>&nbsp;<span class="op" id="6349721">:=</span>&nbsp;<span class="ident" id="6349724">cc</span><span class="op" id="6349726">.</span><span class="ident" id="6349727">pipe</span><span class="op" id="6349731">.</span><span class="ident" id="6349732">Next</span><span class="op" id="6349736">(</span><span class="op" id="6349737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349740">cc</span><span class="op" id="6349742">.</span><span class="ident" id="6349743">pipe</span><span class="op" id="6349747">.</span><span class="ident" id="6349748">StartRequest</span><span class="op" id="6349760">(</span><span class="ident" id="6349761">id</span><span class="op" id="6349763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349766">defer</span>&nbsp;<span class="keyword" id="6349772">func</span><span class="op" id="6349776">(</span><span class="op" id="6349777">)</span>&nbsp;<span class="op" id="6349779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349783">cc</span><span class="op" id="6349785">.</span><span class="ident" id="6349786">pipe</span><span class="op" id="6349790">.</span><span class="ident" id="6349791">EndRequest</span><span class="op" id="6349801">(</span><span class="ident" id="6349802">id</span><span class="op" id="6349804">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349808">if</span>&nbsp;<span class="ident" id="6349811">err</span>&nbsp;<span class="op" id="6349815">!=</span>&nbsp;<span class="ident" id="6349818">nil</span>&nbsp;<span class="op" id="6349822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349827">cc</span><span class="op" id="6349829">.</span><span class="ident" id="6349830">pipe</span><span class="op" id="6349834">.</span><span class="ident" id="6349835">StartResponse</span><span class="op" id="6349848">(</span><span class="ident" id="6349849">id</span><span class="op" id="6349851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349856">cc</span><span class="op" id="6349858">.</span><span class="ident" id="6349859">pipe</span><span class="op" id="6349863">.</span><span class="ident" id="6349864">EndResponse</span><span class="op" id="6349875">(</span><span class="ident" id="6349876">id</span><span class="op" id="6349878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349882">}</span>&nbsp;<span class="keyword" id="6349884">else</span>&nbsp;<span class="op" id="6349889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6349894">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349941">cc</span><span class="op" id="6349943">.</span><span class="ident" id="6349944">lk</span><span class="op" id="6349946">.</span><span class="ident" id="6349947">Lock</span><span class="op" id="6349951">(</span><span class="op" id="6349952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349957">cc</span><span class="op" id="6349959">.</span><span class="ident" id="6349960">pipereq</span><span class="op" id="6349967">[</span><span class="ident" id="6349968">req</span><span class="op" id="6349971">]</span>&nbsp;<span class="op" id="6349973">=</span>&nbsp;<span class="ident" id="6349975">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349981">cc</span><span class="op" id="6349983">.</span><span class="ident" id="6349984">lk</span><span class="op" id="6349986">.</span><span class="ident" id="6349987">Unlock</span><span class="op" id="6349993">(</span><span class="op" id="6349994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350001">}</span><span class="op" id="6350002">(</span><span class="op" id="6350003">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350007">cc</span><span class="op" id="6350009">.</span><span class="ident" id="6350010">lk</span><span class="op" id="6350012">.</span><span class="ident" id="6350013">Lock</span><span class="op" id="6350017">(</span><span class="op" id="6350018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350021">if</span>&nbsp;<span class="ident" id="6350024">cc</span><span class="op" id="6350026">.</span><span class="ident" id="6350027">re</span>&nbsp;<span class="op" id="6350030">!=</span>&nbsp;<span class="ident" id="6350033">nil</span>&nbsp;<span class="op" id="6350037">{</span>&nbsp;<span class="comment" id="6350039">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350091">defer</span>&nbsp;<span class="ident" id="6350097">cc</span><span class="op" id="6350099">.</span><span class="ident" id="6350100">lk</span><span class="op" id="6350102">.</span><span class="ident" id="6350103">Unlock</span><span class="op" id="6350109">(</span><span class="op" id="6350110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350114">return</span>&nbsp;<span class="ident" id="6350121">cc</span><span class="op" id="6350123">.</span><span class="ident" id="6350124">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350131">if</span>&nbsp;<span class="ident" id="6350134">cc</span><span class="op" id="6350136">.</span><span class="ident" id="6350137">we</span>&nbsp;<span class="op" id="6350140">!=</span>&nbsp;<span class="ident" id="6350143">nil</span>&nbsp;<span class="op" id="6350147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350151">defer</span>&nbsp;<span class="ident" id="6350157">cc</span><span class="op" id="6350159">.</span><span class="ident" id="6350160">lk</span><span class="op" id="6350162">.</span><span class="ident" id="6350163">Unlock</span><span class="op" id="6350169">(</span><span class="op" id="6350170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350174">return</span>&nbsp;<span class="ident" id="6350181">cc</span><span class="op" id="6350183">.</span><span class="ident" id="6350184">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350188">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350191">if</span>&nbsp;<span class="ident" id="6350194">cc</span><span class="op" id="6350196">.</span><span class="ident" id="6350197">c</span>&nbsp;<span class="op" id="6350199">==</span>&nbsp;<span class="ident" id="6350202">nil</span>&nbsp;<span class="op" id="6350206">{</span>&nbsp;<span class="comment" id="6350208">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350255">defer</span>&nbsp;<span class="ident" id="6350261">cc</span><span class="op" id="6350263">.</span><span class="ident" id="6350264">lk</span><span class="op" id="6350266">.</span><span class="ident" id="6350267">Unlock</span><span class="op" id="6350273">(</span><span class="op" id="6350274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350278">return</span>&nbsp;<span class="ident" id="6350285">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350299">c</span>&nbsp;<span class="op" id="6350301">:=</span>&nbsp;<span class="ident" id="6350304">cc</span><span class="op" id="6350306">.</span><span class="ident" id="6350307">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350310">if</span>&nbsp;<span class="ident" id="6350313">req</span><span class="op" id="6350316">.</span><span class="ident" id="6350317">Close</span>&nbsp;<span class="op" id="6350323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350327">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350388">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350429">cc</span><span class="op" id="6350431">.</span><span class="ident" id="6350432">we</span>&nbsp;<span class="op" id="6350435">=</span>&nbsp;<span class="ident" id="6350437">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350452">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350455">cc</span><span class="op" id="6350457">.</span><span class="ident" id="6350458">lk</span><span class="op" id="6350460">.</span><span class="ident" id="6350461">Unlock</span><span class="op" id="6350467">(</span><span class="op" id="6350468">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350472">err</span>&nbsp;<span class="op" id="6350476">=</span>&nbsp;<span class="ident" id="6350478">cc</span><span class="op" id="6350480">.</span><span class="ident" id="6350481">writeReq</span><span class="op" id="6350489">(</span><span class="ident" id="6350490">req</span><span class="op" id="6350493">,</span>&nbsp;<span class="ident" id="6350495">c</span><span class="op" id="6350496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350499">cc</span><span class="op" id="6350501">.</span><span class="ident" id="6350502">lk</span><span class="op" id="6350504">.</span><span class="ident" id="6350505">Lock</span><span class="op" id="6350509">(</span><span class="op" id="6350510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350513">defer</span>&nbsp;<span class="ident" id="6350519">cc</span><span class="op" id="6350521">.</span><span class="ident" id="6350522">lk</span><span class="op" id="6350524">.</span><span class="ident" id="6350525">Unlock</span><span class="op" id="6350531">(</span><span class="op" id="6350532">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350535">if</span>&nbsp;<span class="ident" id="6350538">err</span>&nbsp;<span class="op" id="6350542">!=</span>&nbsp;<span class="ident" id="6350545">nil</span>&nbsp;<span class="op" id="6350549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350553">cc</span><span class="op" id="6350555">.</span><span class="ident" id="6350556">we</span>&nbsp;<span class="op" id="6350559">=</span>&nbsp;<span class="ident" id="6350561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350567">return</span>&nbsp;<span class="ident" id="6350574">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350582">cc</span><span class="op" id="6350584">.</span><span class="ident" id="6350585">nwritten</span><span class="op" id="6350593">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350598">return</span>&nbsp;<span class="ident" id="6350605">nil</span><br>
<span class="lineno"></span><span class="op" id="6350609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350612">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6350665">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6350707">func</span>&nbsp;<span class="op" id="6350712">(</span><span class="ident" id="6350713">cc</span>&nbsp;<span class="op" id="6350716">*</span><span class="ident" id="6350717">ClientConn</span><span class="op" id="6350727">)</span>&nbsp;<span class="ident" id="6350729">Pending</span><span class="op" id="6350736">(</span><span class="op" id="6350737">)</span>&nbsp;<span class="builtintype" id="6350739">int</span>&nbsp;<span class="op" id="6350743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350746">cc</span><span class="op" id="6350748">.</span><span class="ident" id="6350749">lk</span><span class="op" id="6350751">.</span><span class="ident" id="6350752">Lock</span><span class="op" id="6350756">(</span><span class="op" id="6350757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350760">defer</span>&nbsp;<span class="ident" id="6350766">cc</span><span class="op" id="6350768">.</span><span class="ident" id="6350769">lk</span><span class="op" id="6350771">.</span><span class="ident" id="6350772">Unlock</span><span class="op" id="6350778">(</span><span class="op" id="6350779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350782">return</span>&nbsp;<span class="ident" id="6350789">cc</span><span class="op" id="6350791">.</span><span class="ident" id="6350792">nwritten</span>&nbsp;<span class="op" id="6350801">-</span>&nbsp;<span class="ident" id="6350803">cc</span><span class="op" id="6350805">.</span><span class="ident" id="6350806">nread</span><br>
<span class="lineno">355</span><span class="op" id="6350812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6350815">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6350888">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6350960">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6351032">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6351087">func</span>&nbsp;<span class="op" id="6351092">(</span><span class="ident" id="6351093">cc</span>&nbsp;<span class="op" id="6351096">*</span><span class="ident" id="6351097">ClientConn</span><span class="op" id="6351107">)</span>&nbsp;<span class="ident" id="6351109">Read</span><span class="op" id="6351113">(</span><span class="ident" id="6351114">req</span>&nbsp;<span class="op" id="6351118">*</span><span class="ident" id="6351119">http</span><span class="op" id="6351123">.</span><span class="ident" id="6351124">Request</span><span class="op" id="6351131">)</span>&nbsp;<span class="op" id="6351133">(</span><span class="ident" id="6351134">resp</span>&nbsp;<span class="op" id="6351139">*</span><span class="ident" id="6351140">http</span><span class="op" id="6351144">.</span><span class="ident" id="6351145">Response</span><span class="op" id="6351153">,</span>&nbsp;<span class="ident" id="6351155">err</span>&nbsp;<span class="builtintype" id="6351159">error</span><span class="op" id="6351164">)</span>&nbsp;<span class="op" id="6351166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351169">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351228">cc</span><span class="op" id="6351230">.</span><span class="ident" id="6351231">lk</span><span class="op" id="6351233">.</span><span class="ident" id="6351234">Lock</span><span class="op" id="6351238">(</span><span class="op" id="6351239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351242">id</span><span class="op" id="6351244">,</span>&nbsp;<span class="ident" id="6351246">ok</span>&nbsp;<span class="op" id="6351249">:=</span>&nbsp;<span class="ident" id="6351252">cc</span><span class="op" id="6351254">.</span><span class="ident" id="6351255">pipereq</span><span class="op" id="6351262">[</span><span class="ident" id="6351263">req</span><span class="op" id="6351266">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6351269">delete</span><span class="op" id="6351275">(</span><span class="ident" id="6351276">cc</span><span class="op" id="6351278">.</span><span class="ident" id="6351279">pipereq</span><span class="op" id="6351286">,</span>&nbsp;<span class="ident" id="6351288">req</span><span class="op" id="6351291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351294">if</span>&nbsp;<span class="op" id="6351297">!</span><span class="ident" id="6351298">ok</span>&nbsp;<span class="op" id="6351301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351305">cc</span><span class="op" id="6351307">.</span><span class="ident" id="6351308">lk</span><span class="op" id="6351310">.</span><span class="ident" id="6351311">Unlock</span><span class="op" id="6351317">(</span><span class="op" id="6351318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351322">return</span>&nbsp;<span class="ident" id="6351329">nil</span><span class="op" id="6351332">,</span>&nbsp;<span class="ident" id="6351334">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351347">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351350">cc</span><span class="op" id="6351352">.</span><span class="ident" id="6351353">lk</span><span class="op" id="6351355">.</span><span class="ident" id="6351356">Unlock</span><span class="op" id="6351362">(</span><span class="op" id="6351363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351367">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351393">cc</span><span class="op" id="6351395">.</span><span class="ident" id="6351396">pipe</span><span class="op" id="6351400">.</span><span class="ident" id="6351401">StartResponse</span><span class="op" id="6351414">(</span><span class="ident" id="6351415">id</span><span class="op" id="6351417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351420">defer</span>&nbsp;<span class="ident" id="6351426">cc</span><span class="op" id="6351428">.</span><span class="ident" id="6351429">pipe</span><span class="op" id="6351433">.</span><span class="ident" id="6351434">EndResponse</span><span class="op" id="6351445">(</span><span class="ident" id="6351446">id</span><span class="op" id="6351448">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351452">cc</span><span class="op" id="6351454">.</span><span class="ident" id="6351455">lk</span><span class="op" id="6351457">.</span><span class="ident" id="6351458">Lock</span><span class="op" id="6351462">(</span><span class="op" id="6351463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351466">if</span>&nbsp;<span class="ident" id="6351469">cc</span><span class="op" id="6351471">.</span><span class="ident" id="6351472">re</span>&nbsp;<span class="op" id="6351475">!=</span>&nbsp;<span class="ident" id="6351478">nil</span>&nbsp;<span class="op" id="6351482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351486">defer</span>&nbsp;<span class="ident" id="6351492">cc</span><span class="op" id="6351494">.</span><span class="ident" id="6351495">lk</span><span class="op" id="6351497">.</span><span class="ident" id="6351498">Unlock</span><span class="op" id="6351504">(</span><span class="op" id="6351505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351509">return</span>&nbsp;<span class="ident" id="6351516">nil</span><span class="op" id="6351519">,</span>&nbsp;<span class="ident" id="6351521">cc</span><span class="op" id="6351523">.</span><span class="ident" id="6351524">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351531">if</span>&nbsp;<span class="ident" id="6351534">cc</span><span class="op" id="6351536">.</span><span class="ident" id="6351537">r</span>&nbsp;<span class="op" id="6351539">==</span>&nbsp;<span class="ident" id="6351542">nil</span>&nbsp;<span class="op" id="6351546">{</span>&nbsp;<span class="comment" id="6351548">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351595">defer</span>&nbsp;<span class="ident" id="6351601">cc</span><span class="op" id="6351603">.</span><span class="ident" id="6351604">lk</span><span class="op" id="6351606">.</span><span class="ident" id="6351607">Unlock</span><span class="op" id="6351613">(</span><span class="op" id="6351614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351618">return</span>&nbsp;<span class="ident" id="6351625">nil</span><span class="op" id="6351628">,</span>&nbsp;<span class="ident" id="6351630">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351641">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351644">r</span>&nbsp;<span class="op" id="6351646">:=</span>&nbsp;<span class="ident" id="6351649">cc</span><span class="op" id="6351651">.</span><span class="ident" id="6351652">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351655">lastbody</span>&nbsp;<span class="op" id="6351664">:=</span>&nbsp;<span class="ident" id="6351667">cc</span><span class="op" id="6351669">.</span><span class="ident" id="6351670">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351680">cc</span><span class="op" id="6351682">.</span><span class="ident" id="6351683">lastbody</span>&nbsp;<span class="op" id="6351692">=</span>&nbsp;<span class="ident" id="6351694">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351699">cc</span><span class="op" id="6351701">.</span><span class="ident" id="6351702">lk</span><span class="op" id="6351704">.</span><span class="ident" id="6351705">Unlock</span><span class="op" id="6351711">(</span><span class="op" id="6351712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351716">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351792">if</span>&nbsp;<span class="ident" id="6351795">lastbody</span>&nbsp;<span class="op" id="6351804">!=</span>&nbsp;<span class="ident" id="6351807">nil</span>&nbsp;<span class="op" id="6351811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351815">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351881">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351939">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351954">err</span>&nbsp;<span class="op" id="6351958">=</span>&nbsp;<span class="ident" id="6351960">lastbody</span><span class="op" id="6351968">.</span><span class="ident" id="6351969">Close</span><span class="op" id="6351974">(</span><span class="op" id="6351975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351979">if</span>&nbsp;<span class="ident" id="6351982">err</span>&nbsp;<span class="op" id="6351986">!=</span>&nbsp;<span class="ident" id="6351989">nil</span>&nbsp;<span class="op" id="6351993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351998">cc</span><span class="op" id="6352000">.</span><span class="ident" id="6352001">lk</span><span class="op" id="6352003">.</span><span class="ident" id="6352004">Lock</span><span class="op" id="6352008">(</span><span class="op" id="6352009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352014">defer</span>&nbsp;<span class="ident" id="6352020">cc</span><span class="op" id="6352022">.</span><span class="ident" id="6352023">lk</span><span class="op" id="6352025">.</span><span class="ident" id="6352026">Unlock</span><span class="op" id="6352032">(</span><span class="op" id="6352033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352038">cc</span><span class="op" id="6352040">.</span><span class="ident" id="6352041">re</span>&nbsp;<span class="op" id="6352044">=</span>&nbsp;<span class="ident" id="6352046">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352053">return</span>&nbsp;<span class="ident" id="6352060">nil</span><span class="op" id="6352063">,</span>&nbsp;<span class="ident" id="6352065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352078">resp</span><span class="op" id="6352082">,</span>&nbsp;<span class="ident" id="6352084">err</span>&nbsp;<span class="op" id="6352088">=</span>&nbsp;<span class="ident" id="6352090">http</span><span class="op" id="6352094">.</span><span class="ident" id="6352095">ReadResponse</span><span class="op" id="6352107">(</span><span class="ident" id="6352108">r</span><span class="op" id="6352109">,</span>&nbsp;<span class="ident" id="6352111">req</span><span class="op" id="6352114">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352117">cc</span><span class="op" id="6352119">.</span><span class="ident" id="6352120">lk</span><span class="op" id="6352122">.</span><span class="ident" id="6352123">Lock</span><span class="op" id="6352127">(</span><span class="op" id="6352128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352131">defer</span>&nbsp;<span class="ident" id="6352137">cc</span><span class="op" id="6352139">.</span><span class="ident" id="6352140">lk</span><span class="op" id="6352142">.</span><span class="ident" id="6352143">Unlock</span><span class="op" id="6352149">(</span><span class="op" id="6352150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352153">if</span>&nbsp;<span class="ident" id="6352156">err</span>&nbsp;<span class="op" id="6352160">!=</span>&nbsp;<span class="ident" id="6352163">nil</span>&nbsp;<span class="op" id="6352167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352171">cc</span><span class="op" id="6352173">.</span><span class="ident" id="6352174">re</span>&nbsp;<span class="op" id="6352177">=</span>&nbsp;<span class="ident" id="6352179">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352185">return</span>&nbsp;<span class="ident" id="6352192">resp</span><span class="op" id="6352196">,</span>&nbsp;<span class="ident" id="6352198">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352206">cc</span><span class="op" id="6352208">.</span><span class="ident" id="6352209">lastbody</span>&nbsp;<span class="op" id="6352218">=</span>&nbsp;<span class="ident" id="6352220">resp</span><span class="op" id="6352224">.</span><span class="ident" id="6352225">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352232">cc</span><span class="op" id="6352234">.</span><span class="ident" id="6352235">nread</span><span class="op" id="6352240">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352245">if</span>&nbsp;<span class="ident" id="6352248">resp</span><span class="op" id="6352252">.</span><span class="ident" id="6352253">Close</span>&nbsp;<span class="op" id="6352259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352263">cc</span><span class="op" id="6352265">.</span><span class="ident" id="6352266">re</span>&nbsp;<span class="op" id="6352269">=</span>&nbsp;<span class="ident" id="6352271">ErrPersistEOF</span>&nbsp;<span class="comment" id="6352285">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352319">return</span>&nbsp;<span class="ident" id="6352326">resp</span><span class="op" id="6352330">,</span>&nbsp;<span class="ident" id="6352332">cc</span><span class="op" id="6352334">.</span><span class="ident" id="6352335">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352342">return</span>&nbsp;<span class="ident" id="6352349">resp</span><span class="op" id="6352353">,</span>&nbsp;<span class="ident" id="6352355">err</span><br>
<span class="lineno">420</span><span class="op" id="6352359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352362">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6352434">func</span>&nbsp;<span class="op" id="6352439">(</span><span class="ident" id="6352440">cc</span>&nbsp;<span class="op" id="6352443">*</span><span class="ident" id="6352444">ClientConn</span><span class="op" id="6352454">)</span>&nbsp;<span class="ident" id="6352456">Do</span><span class="op" id="6352458">(</span><span class="ident" id="6352459">req</span>&nbsp;<span class="op" id="6352463">*</span><span class="ident" id="6352464">http</span><span class="op" id="6352468">.</span><span class="ident" id="6352469">Request</span><span class="op" id="6352476">)</span>&nbsp;<span class="op" id="6352478">(</span><span class="ident" id="6352479">resp</span>&nbsp;<span class="op" id="6352484">*</span><span class="ident" id="6352485">http</span><span class="op" id="6352489">.</span><span class="ident" id="6352490">Response</span><span class="op" id="6352498">,</span>&nbsp;<span class="ident" id="6352500">err</span>&nbsp;<span class="builtintype" id="6352504">error</span><span class="op" id="6352509">)</span>&nbsp;<span class="op" id="6352511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6352514">err</span>&nbsp;<span class="op" id="6352518">=</span>&nbsp;<span class="ident" id="6352520">cc</span><span class="op" id="6352522">.</span><span class="ident" id="6352523">Write</span><span class="op" id="6352528">(</span><span class="ident" id="6352529">req</span><span class="op" id="6352532">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352535">if</span>&nbsp;<span class="ident" id="6352538">err</span>&nbsp;<span class="op" id="6352542">!=</span>&nbsp;<span class="ident" id="6352545">nil</span>&nbsp;<span class="op" id="6352549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352553">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352564">return</span>&nbsp;<span class="ident" id="6352571">cc</span><span class="op" id="6352573">.</span><span class="ident" id="6352574">Read</span><span class="op" id="6352578">(</span><span class="ident" id="6352579">req</span><span class="op" id="6352582">)</span><br>
<span class="lineno"></span><span class="op" id="6352584">}</span>
</div>
</body>
</html>
