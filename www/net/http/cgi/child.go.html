<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5130202">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5130257">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5130311">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5130362">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5130422">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5130435">package</span>&nbsp;<span class="ident" id="5130443">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5130448">import</span>&nbsp;<span class="op" id="5130455">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130458">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130467">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130481">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130491">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130498">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130504">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130517">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130524">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130536">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130547">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130553">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130564">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5130574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5130577">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5130643">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5130705">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5130746">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5130806">func</span>&nbsp;<span class="ident" id="5130811">Request</span><span class="op" id="5130818">(</span><span class="op" id="5130819">)</span>&nbsp;<span class="op" id="5130821">(</span><span class="op" id="5130822">*</span><span class="ident" id="5130823">http</span><span class="op" id="5130827">.</span><span class="ident" id="5130828">Request</span><span class="op" id="5130835">,</span>&nbsp;<span class="builtintype" id="5130837">error</span><span class="op" id="5130842">)</span>&nbsp;<span class="op" id="5130844">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130847">r</span><span class="op" id="5130848">,</span>&nbsp;<span class="ident" id="5130850">err</span>&nbsp;<span class="op" id="5130854">:=</span>&nbsp;<span class="ident" id="5130857">RequestFromMap</span><span class="op" id="5130871">(</span><span class="ident" id="5130872">envMap</span><span class="op" id="5130878">(</span><span class="ident" id="5130879">os</span><span class="op" id="5130881">.</span><span class="ident" id="5130882">Environ</span><span class="op" id="5130889">(</span><span class="op" id="5130890">)</span><span class="op" id="5130891">)</span><span class="op" id="5130892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130895">if</span>&nbsp;<span class="ident" id="5130898">err</span>&nbsp;<span class="op" id="5130902">!=</span>&nbsp;<span class="ident" id="5130905">nil</span>&nbsp;<span class="op" id="5130909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130913">return</span>&nbsp;<span class="ident" id="5130920">nil</span><span class="op" id="5130923">,</span>&nbsp;<span class="ident" id="5130925">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5130930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130933">if</span>&nbsp;<span class="ident" id="5130936">r</span><span class="op" id="5130937">.</span><span class="ident" id="5130938">ContentLength</span>&nbsp;<span class="op" id="5130952">&gt;</span>&nbsp;<span class="num" id="5130954">0</span>&nbsp;<span class="op" id="5130956">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130960">r</span><span class="op" id="5130961">.</span><span class="ident" id="5130962">Body</span>&nbsp;<span class="op" id="5130967">=</span>&nbsp;<span class="ident" id="5130969">ioutil</span><span class="op" id="5130975">.</span><span class="ident" id="5130976">NopCloser</span><span class="op" id="5130985">(</span><span class="ident" id="5130986">io</span><span class="op" id="5130988">.</span><span class="ident" id="5130989">LimitReader</span><span class="op" id="5131000">(</span><span class="ident" id="5131001">os</span><span class="op" id="5131003">.</span><span class="ident" id="5131004">Stdin</span><span class="op" id="5131009">,</span>&nbsp;<span class="ident" id="5131011">r</span><span class="op" id="5131012">.</span><span class="ident" id="5131013">ContentLength</span><span class="op" id="5131026">)</span><span class="op" id="5131027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131033">return</span>&nbsp;<span class="ident" id="5131040">r</span><span class="op" id="5131041">,</span>&nbsp;<span class="ident" id="5131043">nil</span><br>
<span class="lineno"></span><span class="op" id="5131047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5131050">func</span>&nbsp;<span class="ident" id="5131055">envMap</span><span class="op" id="5131061">(</span><span class="ident" id="5131062">env</span>&nbsp;<span class="op" id="5131066">[</span><span class="op" id="5131067">]</span><span class="builtintype" id="5131068">string</span><span class="op" id="5131074">)</span>&nbsp;<span class="keyword" id="5131076">map</span><span class="op" id="5131079">[</span><span class="builtintype" id="5131080">string</span><span class="op" id="5131086">]</span><span class="builtintype" id="5131087">string</span>&nbsp;<span class="op" id="5131094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131097">m</span>&nbsp;<span class="op" id="5131099">:=</span>&nbsp;<span class="builtinfunc" id="5131102">make</span><span class="op" id="5131106">(</span><span class="keyword" id="5131107">map</span><span class="op" id="5131110">[</span><span class="builtintype" id="5131111">string</span><span class="op" id="5131117">]</span><span class="builtintype" id="5131118">string</span><span class="op" id="5131124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131127">for</span>&nbsp;<span class="ident" id="5131131">_</span><span class="op" id="5131132">,</span>&nbsp;<span class="ident" id="5131134">kv</span>&nbsp;<span class="op" id="5131137">:=</span>&nbsp;<span class="keyword" id="5131140">range</span>&nbsp;<span class="ident" id="5131146">env</span>&nbsp;<span class="op" id="5131150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131154">if</span>&nbsp;<span class="ident" id="5131157">idx</span>&nbsp;<span class="op" id="5131161">:=</span>&nbsp;<span class="ident" id="5131164">strings</span><span class="op" id="5131171">.</span><span class="ident" id="5131172">Index</span><span class="op" id="5131177">(</span><span class="ident" id="5131178">kv</span><span class="op" id="5131180">,</span>&nbsp;<span class="string" id="5131182">&#34;=&#34;</span><span class="op" id="5131185">)</span><span class="op" id="5131186">;</span>&nbsp;<span class="ident" id="5131188">idx</span>&nbsp;<span class="op" id="5131192">!=</span>&nbsp;<span class="op" id="5131195">-</span><span class="num" id="5131196">1</span>&nbsp;<span class="op" id="5131198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131203">m</span><span class="op" id="5131204">[</span><span class="ident" id="5131205">kv</span><span class="op" id="5131207">[</span><span class="op" id="5131208">:</span><span class="ident" id="5131209">idx</span><span class="op" id="5131212">]</span><span class="op" id="5131213">]</span>&nbsp;<span class="op" id="5131215">=</span>&nbsp;<span class="ident" id="5131217">kv</span><span class="op" id="5131219">[</span><span class="ident" id="5131220">idx</span><span class="op" id="5131223">+</span><span class="num" id="5131224">1</span><span class="op" id="5131225">:</span><span class="op" id="5131226">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131236">return</span>&nbsp;<span class="ident" id="5131243">m</span><br>
<span class="lineno"></span><span class="op" id="5131245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5131248">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5131310">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5131365">func</span>&nbsp;<span class="ident" id="5131370">RequestFromMap</span><span class="op" id="5131384">(</span><span class="ident" id="5131385">params</span>&nbsp;<span class="keyword" id="5131392">map</span><span class="op" id="5131395">[</span><span class="builtintype" id="5131396">string</span><span class="op" id="5131402">]</span><span class="builtintype" id="5131403">string</span><span class="op" id="5131409">)</span>&nbsp;<span class="op" id="5131411">(</span><span class="op" id="5131412">*</span><span class="ident" id="5131413">http</span><span class="op" id="5131417">.</span><span class="ident" id="5131418">Request</span><span class="op" id="5131425">,</span>&nbsp;<span class="builtintype" id="5131427">error</span><span class="op" id="5131432">)</span>&nbsp;<span class="op" id="5131434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131437">r</span>&nbsp;<span class="op" id="5131439">:=</span>&nbsp;<span class="builtinfunc" id="5131442">new</span><span class="op" id="5131445">(</span><span class="ident" id="5131446">http</span><span class="op" id="5131450">.</span><span class="ident" id="5131451">Request</span><span class="op" id="5131458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131461">r</span><span class="op" id="5131462">.</span><span class="ident" id="5131463">Method</span>&nbsp;<span class="op" id="5131470">=</span>&nbsp;<span class="ident" id="5131472">params</span><span class="op" id="5131478">[</span><span class="string" id="5131479">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5131495">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131498">if</span>&nbsp;<span class="ident" id="5131501">r</span><span class="op" id="5131502">.</span><span class="ident" id="5131503">Method</span>&nbsp;<span class="op" id="5131510">==</span>&nbsp;<span class="string" id="5131513">&#34;&#34;</span>&nbsp;<span class="op" id="5131516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131520">return</span>&nbsp;<span class="ident" id="5131527">nil</span><span class="op" id="5131530">,</span>&nbsp;<span class="ident" id="5131532">errors</span><span class="op" id="5131538">.</span><span class="ident" id="5131539">New</span><span class="op" id="5131542">(</span><span class="string" id="5131543">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5131582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131589">r</span><span class="op" id="5131590">.</span><span class="ident" id="5131591">Proto</span>&nbsp;<span class="op" id="5131597">=</span>&nbsp;<span class="ident" id="5131599">params</span><span class="op" id="5131605">[</span><span class="string" id="5131606">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5131623">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131626">var</span>&nbsp;<span class="ident" id="5131630">ok</span>&nbsp;<span class="builtintype" id="5131633">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131639">r</span><span class="op" id="5131640">.</span><span class="ident" id="5131641">ProtoMajor</span><span class="op" id="5131651">,</span>&nbsp;<span class="ident" id="5131653">r</span><span class="op" id="5131654">.</span><span class="ident" id="5131655">ProtoMinor</span><span class="op" id="5131665">,</span>&nbsp;<span class="ident" id="5131667">ok</span>&nbsp;<span class="op" id="5131670">=</span>&nbsp;<span class="ident" id="5131672">http</span><span class="op" id="5131676">.</span><span class="ident" id="5131677">ParseHTTPVersion</span><span class="op" id="5131693">(</span><span class="ident" id="5131694">r</span><span class="op" id="5131695">.</span><span class="ident" id="5131696">Proto</span><span class="op" id="5131701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131704">if</span>&nbsp;<span class="op" id="5131707">!</span><span class="ident" id="5131708">ok</span>&nbsp;<span class="op" id="5131711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131715">return</span>&nbsp;<span class="ident" id="5131722">nil</span><span class="op" id="5131725">,</span>&nbsp;<span class="ident" id="5131727">errors</span><span class="op" id="5131733">.</span><span class="ident" id="5131734">New</span><span class="op" id="5131737">(</span><span class="string" id="5131738">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5131776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131779">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131783">r</span><span class="op" id="5131784">.</span><span class="ident" id="5131785">Close</span>&nbsp;<span class="op" id="5131791">=</span>&nbsp;<span class="ident" id="5131793">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131799">r</span><span class="op" id="5131800">.</span><span class="ident" id="5131801">Trailer</span>&nbsp;<span class="op" id="5131809">=</span>&nbsp;<span class="ident" id="5131811">http</span><span class="op" id="5131815">.</span><span class="ident" id="5131816">Header</span><span class="op" id="5131822">{</span><span class="op" id="5131823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131826">r</span><span class="op" id="5131827">.</span><span class="ident" id="5131828">Header</span>&nbsp;<span class="op" id="5131835">=</span>&nbsp;<span class="ident" id="5131837">http</span><span class="op" id="5131841">.</span><span class="ident" id="5131842">Header</span><span class="op" id="5131848">{</span><span class="op" id="5131849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131853">r</span><span class="op" id="5131854">.</span><span class="ident" id="5131855">Host</span>&nbsp;<span class="op" id="5131860">=</span>&nbsp;<span class="ident" id="5131862">params</span><span class="op" id="5131868">[</span><span class="string" id="5131869">&#34;HTTP_HOST&#34;</span><span class="op" id="5131880">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131884">if</span>&nbsp;<span class="ident" id="5131887">lenstr</span>&nbsp;<span class="op" id="5131894">:=</span>&nbsp;<span class="ident" id="5131897">params</span><span class="op" id="5131903">[</span><span class="string" id="5131904">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5131920">]</span><span class="op" id="5131921">;</span>&nbsp;<span class="ident" id="5131923">lenstr</span>&nbsp;<span class="op" id="5131930">!=</span>&nbsp;<span class="string" id="5131933">&#34;&#34;</span>&nbsp;<span class="op" id="5131936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131940">clen</span><span class="op" id="5131944">,</span>&nbsp;<span class="ident" id="5131946">err</span>&nbsp;<span class="op" id="5131950">:=</span>&nbsp;<span class="ident" id="5131953">strconv</span><span class="op" id="5131960">.</span><span class="ident" id="5131961">ParseInt</span><span class="op" id="5131969">(</span><span class="ident" id="5131970">lenstr</span><span class="op" id="5131976">,</span>&nbsp;<span class="num" id="5131978">10</span><span class="op" id="5131980">,</span>&nbsp;<span class="num" id="5131982">64</span><span class="op" id="5131984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131988">if</span>&nbsp;<span class="ident" id="5131991">err</span>&nbsp;<span class="op" id="5131995">!=</span>&nbsp;<span class="ident" id="5131998">nil</span>&nbsp;<span class="op" id="5132002">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132007">return</span>&nbsp;<span class="ident" id="5132014">nil</span><span class="op" id="5132017">,</span>&nbsp;<span class="ident" id="5132019">errors</span><span class="op" id="5132025">.</span><span class="ident" id="5132026">New</span><span class="op" id="5132029">(</span><span class="string" id="5132030">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5132073">+</span>&nbsp;<span class="ident" id="5132075">lenstr</span><span class="op" id="5132081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132089">r</span><span class="op" id="5132090">.</span><span class="ident" id="5132091">ContentLength</span>&nbsp;<span class="op" id="5132105">=</span>&nbsp;<span class="ident" id="5132107">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132117">if</span>&nbsp;<span class="ident" id="5132120">ct</span>&nbsp;<span class="op" id="5132123">:=</span>&nbsp;<span class="ident" id="5132126">params</span><span class="op" id="5132132">[</span><span class="string" id="5132133">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5132147">]</span><span class="op" id="5132148">;</span>&nbsp;<span class="ident" id="5132150">ct</span>&nbsp;<span class="op" id="5132153">!=</span>&nbsp;<span class="string" id="5132156">&#34;&#34;</span>&nbsp;<span class="op" id="5132159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132163">r</span><span class="op" id="5132164">.</span><span class="ident" id="5132165">Header</span><span class="op" id="5132171">.</span><span class="ident" id="5132172">Set</span><span class="op" id="5132175">(</span><span class="string" id="5132176">&#34;Content-Type&#34;</span><span class="op" id="5132190">,</span>&nbsp;<span class="ident" id="5132192">ct</span><span class="op" id="5132194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132201">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132256">for</span>&nbsp;<span class="ident" id="5132260">k</span><span class="op" id="5132261">,</span>&nbsp;<span class="ident" id="5132263">v</span>&nbsp;<span class="op" id="5132265">:=</span>&nbsp;<span class="keyword" id="5132268">range</span>&nbsp;<span class="ident" id="5132274">params</span>&nbsp;<span class="op" id="5132281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132285">if</span>&nbsp;<span class="op" id="5132288">!</span><span class="ident" id="5132289">strings</span><span class="op" id="5132296">.</span><span class="ident" id="5132297">HasPrefix</span><span class="op" id="5132306">(</span><span class="ident" id="5132307">k</span><span class="op" id="5132308">,</span>&nbsp;<span class="string" id="5132310">&#34;HTTP_&#34;</span><span class="op" id="5132317">)</span>&nbsp;<span class="op" id="5132319">||</span>&nbsp;<span class="ident" id="5132322">k</span>&nbsp;<span class="op" id="5132324">==</span>&nbsp;<span class="string" id="5132327">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5132339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132344">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132359">r</span><span class="op" id="5132360">.</span><span class="ident" id="5132361">Header</span><span class="op" id="5132367">.</span><span class="ident" id="5132368">Add</span><span class="op" id="5132371">(</span><span class="ident" id="5132372">strings</span><span class="op" id="5132379">.</span><span class="ident" id="5132380">Replace</span><span class="op" id="5132387">(</span><span class="ident" id="5132388">k</span><span class="op" id="5132389">[</span><span class="num" id="5132390">5</span><span class="op" id="5132391">:</span><span class="op" id="5132392">]</span><span class="op" id="5132393">,</span>&nbsp;<span class="string" id="5132395">&#34;_&#34;</span><span class="op" id="5132398">,</span>&nbsp;<span class="string" id="5132400">&#34;-&#34;</span><span class="op" id="5132403">,</span>&nbsp;<span class="op" id="5132405">-</span><span class="num" id="5132406">1</span><span class="op" id="5132407">)</span><span class="op" id="5132408">,</span>&nbsp;<span class="ident" id="5132410">v</span><span class="op" id="5132411">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132418">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132476">uriStr</span>&nbsp;<span class="op" id="5132483">:=</span>&nbsp;<span class="ident" id="5132486">params</span><span class="op" id="5132492">[</span><span class="string" id="5132493">&#34;REQUEST_URI&#34;</span><span class="op" id="5132506">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132509">if</span>&nbsp;<span class="ident" id="5132512">uriStr</span>&nbsp;<span class="op" id="5132519">==</span>&nbsp;<span class="string" id="5132522">&#34;&#34;</span>&nbsp;<span class="op" id="5132525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132529">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132587">uriStr</span>&nbsp;<span class="op" id="5132594">=</span>&nbsp;<span class="ident" id="5132596">params</span><span class="op" id="5132602">[</span><span class="string" id="5132603">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5132616">]</span>&nbsp;<span class="op" id="5132618">+</span>&nbsp;<span class="ident" id="5132620">params</span><span class="op" id="5132626">[</span><span class="string" id="5132627">&#34;PATH_INFO&#34;</span><span class="op" id="5132638">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132642">s</span>&nbsp;<span class="op" id="5132644">:=</span>&nbsp;<span class="ident" id="5132647">params</span><span class="op" id="5132653">[</span><span class="string" id="5132654">&#34;QUERY_STRING&#34;</span><span class="op" id="5132668">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132672">if</span>&nbsp;<span class="ident" id="5132675">s</span>&nbsp;<span class="op" id="5132677">!=</span>&nbsp;<span class="string" id="5132680">&#34;&#34;</span>&nbsp;<span class="op" id="5132683">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132688">uriStr</span>&nbsp;<span class="op" id="5132695">+=</span>&nbsp;<span class="string" id="5132698">&#34;?&#34;</span>&nbsp;<span class="op" id="5132702">+</span>&nbsp;<span class="ident" id="5132704">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132715">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132768">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132835">if</span>&nbsp;<span class="ident" id="5132838">s</span>&nbsp;<span class="op" id="5132840">:=</span>&nbsp;<span class="ident" id="5132843">params</span><span class="op" id="5132849">[</span><span class="string" id="5132850">&#34;HTTPS&#34;</span><span class="op" id="5132857">]</span><span class="op" id="5132858">;</span>&nbsp;<span class="ident" id="5132860">s</span>&nbsp;<span class="op" id="5132862">==</span>&nbsp;<span class="string" id="5132865">&#34;on&#34;</span>&nbsp;<span class="op" id="5132870">||</span>&nbsp;<span class="ident" id="5132873">s</span>&nbsp;<span class="op" id="5132875">==</span>&nbsp;<span class="string" id="5132878">&#34;ON&#34;</span>&nbsp;<span class="op" id="5132883">||</span>&nbsp;<span class="ident" id="5132886">s</span>&nbsp;<span class="op" id="5132888">==</span>&nbsp;<span class="string" id="5132891">&#34;1&#34;</span>&nbsp;<span class="op" id="5132895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132899">r</span><span class="op" id="5132900">.</span><span class="ident" id="5132901">TLS</span>&nbsp;<span class="op" id="5132905">=</span>&nbsp;<span class="op" id="5132907">&amp;</span><span class="ident" id="5132908">tls</span><span class="op" id="5132911">.</span><span class="ident" id="5132912">ConnectionState</span><span class="op" id="5132927">{</span><span class="ident" id="5132928">HandshakeComplete</span><span class="op" id="5132945">:</span>&nbsp;<span class="ident" id="5132947">true</span><span class="op" id="5132951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132958">if</span>&nbsp;<span class="ident" id="5132961">r</span><span class="op" id="5132962">.</span><span class="ident" id="5132963">Host</span>&nbsp;<span class="op" id="5132968">!=</span>&nbsp;<span class="string" id="5132971">&#34;&#34;</span>&nbsp;<span class="op" id="5132974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132978">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133043">rawurl</span>&nbsp;<span class="op" id="5133050">:=</span>&nbsp;<span class="ident" id="5133053">r</span><span class="op" id="5133054">.</span><span class="ident" id="5133055">Host</span>&nbsp;<span class="op" id="5133060">+</span>&nbsp;<span class="ident" id="5133062">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133071">if</span>&nbsp;<span class="ident" id="5133074">r</span><span class="op" id="5133075">.</span><span class="ident" id="5133076">TLS</span>&nbsp;<span class="op" id="5133080">==</span>&nbsp;<span class="ident" id="5133083">nil</span>&nbsp;<span class="op" id="5133087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133092">rawurl</span>&nbsp;<span class="op" id="5133099">=</span>&nbsp;<span class="string" id="5133101">&#34;http://&#34;</span>&nbsp;<span class="op" id="5133111">+</span>&nbsp;<span class="ident" id="5133113">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133122">}</span>&nbsp;<span class="keyword" id="5133124">else</span>&nbsp;<span class="op" id="5133129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133134">rawurl</span>&nbsp;<span class="op" id="5133141">=</span>&nbsp;<span class="string" id="5133143">&#34;https://&#34;</span>&nbsp;<span class="op" id="5133154">+</span>&nbsp;<span class="ident" id="5133156">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133169">url</span><span class="op" id="5133172">,</span>&nbsp;<span class="ident" id="5133174">err</span>&nbsp;<span class="op" id="5133178">:=</span>&nbsp;<span class="ident" id="5133181">url</span><span class="op" id="5133184">.</span><span class="ident" id="5133185">Parse</span><span class="op" id="5133190">(</span><span class="ident" id="5133191">rawurl</span><span class="op" id="5133197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133201">if</span>&nbsp;<span class="ident" id="5133204">err</span>&nbsp;<span class="op" id="5133208">!=</span>&nbsp;<span class="ident" id="5133211">nil</span>&nbsp;<span class="op" id="5133215">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133220">return</span>&nbsp;<span class="ident" id="5133227">nil</span><span class="op" id="5133230">,</span>&nbsp;<span class="ident" id="5133232">errors</span><span class="op" id="5133238">.</span><span class="ident" id="5133239">New</span><span class="op" id="5133242">(</span><span class="string" id="5133243">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5133300">+</span>&nbsp;<span class="ident" id="5133302">rawurl</span><span class="op" id="5133308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133316">r</span><span class="op" id="5133317">.</span><span class="ident" id="5133318">URL</span>&nbsp;<span class="op" id="5133322">=</span>&nbsp;<span class="ident" id="5133324">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133332">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133393">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133413">if</span>&nbsp;<span class="ident" id="5133416">r</span><span class="op" id="5133417">.</span><span class="ident" id="5133418">URL</span>&nbsp;<span class="op" id="5133422">==</span>&nbsp;<span class="ident" id="5133425">nil</span>&nbsp;<span class="op" id="5133429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133433">url</span><span class="op" id="5133436">,</span>&nbsp;<span class="ident" id="5133438">err</span>&nbsp;<span class="op" id="5133442">:=</span>&nbsp;<span class="ident" id="5133445">url</span><span class="op" id="5133448">.</span><span class="ident" id="5133449">Parse</span><span class="op" id="5133454">(</span><span class="ident" id="5133455">uriStr</span><span class="op" id="5133461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133465">if</span>&nbsp;<span class="ident" id="5133468">err</span>&nbsp;<span class="op" id="5133472">!=</span>&nbsp;<span class="ident" id="5133475">nil</span>&nbsp;<span class="op" id="5133479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133484">return</span>&nbsp;<span class="ident" id="5133491">nil</span><span class="op" id="5133494">,</span>&nbsp;<span class="ident" id="5133496">errors</span><span class="op" id="5133502">.</span><span class="ident" id="5133503">New</span><span class="op" id="5133506">(</span><span class="string" id="5133507">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5133555">+</span>&nbsp;<span class="ident" id="5133557">uriStr</span><span class="op" id="5133563">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133571">r</span><span class="op" id="5133572">.</span><span class="ident" id="5133573">URL</span>&nbsp;<span class="op" id="5133577">=</span>&nbsp;<span class="ident" id="5133579">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5133584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133588">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133650">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5133714">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133735">r</span><span class="op" id="5133736">.</span><span class="ident" id="5133737">RemoteAddr</span>&nbsp;<span class="op" id="5133748">=</span>&nbsp;<span class="ident" id="5133750">net</span><span class="op" id="5133753">.</span><span class="ident" id="5133754">JoinHostPort</span><span class="op" id="5133766">(</span><span class="ident" id="5133767">params</span><span class="op" id="5133773">[</span><span class="string" id="5133774">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5133787">]</span><span class="op" id="5133788">,</span>&nbsp;<span class="string" id="5133790">&#34;0&#34;</span><span class="op" id="5133793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5133797">return</span>&nbsp;<span class="ident" id="5133804">r</span><span class="op" id="5133805">,</span>&nbsp;<span class="ident" id="5133807">nil</span><br>
<span class="lineno">140</span><span class="op" id="5133811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5133814">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5133881">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5133939">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5134003">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5134028">func</span>&nbsp;<span class="ident" id="5134033">Serve</span><span class="op" id="5134038">(</span><span class="ident" id="5134039">handler</span>&nbsp;<span class="ident" id="5134047">http</span><span class="op" id="5134051">.</span><span class="ident" id="5134052">Handler</span><span class="op" id="5134059">)</span>&nbsp;<span class="builtintype" id="5134061">error</span>&nbsp;<span class="op" id="5134067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134070">req</span><span class="op" id="5134073">,</span>&nbsp;<span class="ident" id="5134075">err</span>&nbsp;<span class="op" id="5134079">:=</span>&nbsp;<span class="ident" id="5134082">Request</span><span class="op" id="5134089">(</span><span class="op" id="5134090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134093">if</span>&nbsp;<span class="ident" id="5134096">err</span>&nbsp;<span class="op" id="5134100">!=</span>&nbsp;<span class="ident" id="5134103">nil</span>&nbsp;<span class="op" id="5134107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134111">return</span>&nbsp;<span class="ident" id="5134118">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134126">if</span>&nbsp;<span class="ident" id="5134129">handler</span>&nbsp;<span class="op" id="5134137">==</span>&nbsp;<span class="ident" id="5134140">nil</span>&nbsp;<span class="op" id="5134144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134148">handler</span>&nbsp;<span class="op" id="5134156">=</span>&nbsp;<span class="ident" id="5134158">http</span><span class="op" id="5134162">.</span><span class="ident" id="5134163">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134183">rw</span>&nbsp;<span class="op" id="5134186">:=</span>&nbsp;<span class="op" id="5134189">&amp;</span><span class="ident" id="5134190">response</span><span class="op" id="5134198">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134202">req</span><span class="op" id="5134205">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5134210">req</span><span class="op" id="5134213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134217">header</span><span class="op" id="5134223">:</span>&nbsp;<span class="builtinfunc" id="5134225">make</span><span class="op" id="5134229">(</span><span class="ident" id="5134230">http</span><span class="op" id="5134234">.</span><span class="ident" id="5134235">Header</span><span class="op" id="5134241">)</span><span class="op" id="5134242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134246">bufw</span><span class="op" id="5134250">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5134254">bufio</span><span class="op" id="5134259">.</span><span class="ident" id="5134260">NewWriter</span><span class="op" id="5134269">(</span><span class="ident" id="5134270">os</span><span class="op" id="5134272">.</span><span class="ident" id="5134273">Stdout</span><span class="op" id="5134279">)</span><span class="op" id="5134280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134286">handler</span><span class="op" id="5134293">.</span><span class="ident" id="5134294">ServeHTTP</span><span class="op" id="5134303">(</span><span class="ident" id="5134304">rw</span><span class="op" id="5134306">,</span>&nbsp;<span class="ident" id="5134308">req</span><span class="op" id="5134311">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134314">rw</span><span class="op" id="5134316">.</span><span class="ident" id="5134317">Write</span><span class="op" id="5134322">(</span><span class="ident" id="5134323">nil</span><span class="op" id="5134326">)</span>&nbsp;<span class="comment" id="5134328">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134361">if</span>&nbsp;<span class="ident" id="5134364">err</span>&nbsp;<span class="op" id="5134368">=</span>&nbsp;<span class="ident" id="5134370">rw</span><span class="op" id="5134372">.</span><span class="ident" id="5134373">bufw</span><span class="op" id="5134377">.</span><span class="ident" id="5134378">Flush</span><span class="op" id="5134383">(</span><span class="op" id="5134384">)</span><span class="op" id="5134385">;</span>&nbsp;<span class="ident" id="5134387">err</span>&nbsp;<span class="op" id="5134391">!=</span>&nbsp;<span class="ident" id="5134394">nil</span>&nbsp;<span class="op" id="5134398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134402">return</span>&nbsp;<span class="ident" id="5134409">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134417">return</span>&nbsp;<span class="ident" id="5134424">nil</span><br>
<span class="lineno">165</span><span class="op" id="5134428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134431">type</span>&nbsp;<span class="ident" id="5134436">response</span>&nbsp;<span class="keyword" id="5134445">struct</span>&nbsp;<span class="op" id="5134452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134455">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5134466">*</span><span class="ident" id="5134467">http</span><span class="op" id="5134471">.</span><span class="ident" id="5134472">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134481">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5134492">http</span><span class="op" id="5134496">.</span><span class="ident" id="5134497">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134505">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5134516">*</span><span class="ident" id="5134517">bufio</span><span class="op" id="5134522">.</span><span class="ident" id="5134523">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134531">headerSent</span>&nbsp;<span class="builtintype" id="5134542">bool</span><br>
<span class="lineno"></span><span class="op" id="5134547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134550">func</span>&nbsp;<span class="op" id="5134555">(</span><span class="ident" id="5134556">r</span>&nbsp;<span class="op" id="5134558">*</span><span class="ident" id="5134559">response</span><span class="op" id="5134567">)</span>&nbsp;<span class="ident" id="5134569">Flush</span><span class="op" id="5134574">(</span><span class="op" id="5134575">)</span>&nbsp;<span class="op" id="5134577">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134580">r</span><span class="op" id="5134581">.</span><span class="ident" id="5134582">bufw</span><span class="op" id="5134586">.</span><span class="ident" id="5134587">Flush</span><span class="op" id="5134592">(</span><span class="op" id="5134593">)</span><br>
<span class="lineno"></span><span class="op" id="5134595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134598">func</span>&nbsp;<span class="op" id="5134603">(</span><span class="ident" id="5134604">r</span>&nbsp;<span class="op" id="5134606">*</span><span class="ident" id="5134607">response</span><span class="op" id="5134615">)</span>&nbsp;<span class="ident" id="5134617">Header</span><span class="op" id="5134623">(</span><span class="op" id="5134624">)</span>&nbsp;<span class="ident" id="5134626">http</span><span class="op" id="5134630">.</span><span class="ident" id="5134631">Header</span>&nbsp;<span class="op" id="5134638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134641">return</span>&nbsp;<span class="ident" id="5134648">r</span><span class="op" id="5134649">.</span><span class="ident" id="5134650">header</span><br>
<span class="lineno">180</span><span class="op" id="5134657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134660">func</span>&nbsp;<span class="op" id="5134665">(</span><span class="ident" id="5134666">r</span>&nbsp;<span class="op" id="5134668">*</span><span class="ident" id="5134669">response</span><span class="op" id="5134677">)</span>&nbsp;<span class="ident" id="5134679">Write</span><span class="op" id="5134684">(</span><span class="ident" id="5134685">p</span>&nbsp;<span class="op" id="5134687">[</span><span class="op" id="5134688">]</span><span class="builtintype" id="5134689">byte</span><span class="op" id="5134693">)</span>&nbsp;<span class="op" id="5134695">(</span><span class="ident" id="5134696">n</span>&nbsp;<span class="builtintype" id="5134698">int</span><span class="op" id="5134701">,</span>&nbsp;<span class="ident" id="5134703">err</span>&nbsp;<span class="builtintype" id="5134707">error</span><span class="op" id="5134712">)</span>&nbsp;<span class="op" id="5134714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134717">if</span>&nbsp;<span class="op" id="5134720">!</span><span class="ident" id="5134721">r</span><span class="op" id="5134722">.</span><span class="ident" id="5134723">headerSent</span>&nbsp;<span class="op" id="5134734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134738">r</span><span class="op" id="5134739">.</span><span class="ident" id="5134740">WriteHeader</span><span class="op" id="5134751">(</span><span class="ident" id="5134752">http</span><span class="op" id="5134756">.</span><span class="ident" id="5134757">StatusOK</span><span class="op" id="5134765">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5134768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134771">return</span>&nbsp;<span class="ident" id="5134778">r</span><span class="op" id="5134779">.</span><span class="ident" id="5134780">bufw</span><span class="op" id="5134784">.</span><span class="ident" id="5134785">Write</span><span class="op" id="5134790">(</span><span class="ident" id="5134791">p</span><span class="op" id="5134792">)</span><br>
<span class="lineno"></span><span class="op" id="5134794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5134797">func</span>&nbsp;<span class="op" id="5134802">(</span><span class="ident" id="5134803">r</span>&nbsp;<span class="op" id="5134805">*</span><span class="ident" id="5134806">response</span><span class="op" id="5134814">)</span>&nbsp;<span class="ident" id="5134816">WriteHeader</span><span class="op" id="5134827">(</span><span class="ident" id="5134828">code</span>&nbsp;<span class="builtintype" id="5134833">int</span><span class="op" id="5134836">)</span>&nbsp;<span class="op" id="5134838">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5134841">if</span>&nbsp;<span class="ident" id="5134844">r</span><span class="op" id="5134845">.</span><span class="ident" id="5134846">headerSent</span>&nbsp;<span class="op" id="5134857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5134861">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5134927">fmt</span><span class="op" id="5134930">.</span><span class="ident" id="5134931">Fprintf</span><span class="op" id="5134938">(</span><span class="ident" id="5134939">os</span><span class="op" id="5134941">.</span><span class="ident" id="5134942">Stderr</span><span class="op" id="5134948">,</span>&nbsp;<span class="string" id="5134950">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5135005">,</span>&nbsp;<span class="ident" id="5135007">r</span><span class="op" id="5135008">.</span><span class="ident" id="5135009">req</span><span class="op" id="5135012">.</span><span class="ident" id="5135013">URL</span><span class="op" id="5135016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5135020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5135028">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135031">r</span><span class="op" id="5135032">.</span><span class="ident" id="5135033">headerSent</span>&nbsp;<span class="op" id="5135044">=</span>&nbsp;<span class="ident" id="5135046">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135052">fmt</span><span class="op" id="5135055">.</span><span class="ident" id="5135056">Fprintf</span><span class="op" id="5135063">(</span><span class="ident" id="5135064">r</span><span class="op" id="5135065">.</span><span class="ident" id="5135066">bufw</span><span class="op" id="5135070">,</span>&nbsp;<span class="string" id="5135072">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5135091">,</span>&nbsp;<span class="ident" id="5135093">code</span><span class="op" id="5135097">,</span>&nbsp;<span class="ident" id="5135099">http</span><span class="op" id="5135103">.</span><span class="ident" id="5135104">StatusText</span><span class="op" id="5135114">(</span><span class="ident" id="5135115">code</span><span class="op" id="5135119">)</span><span class="op" id="5135120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5135124">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5135155">if</span>&nbsp;<span class="ident" id="5135158">_</span><span class="op" id="5135159">,</span>&nbsp;<span class="ident" id="5135161">hasType</span>&nbsp;<span class="op" id="5135169">:=</span>&nbsp;<span class="ident" id="5135172">r</span><span class="op" id="5135173">.</span><span class="ident" id="5135174">header</span><span class="op" id="5135180">[</span><span class="string" id="5135181">&#34;Content-Type&#34;</span><span class="op" id="5135195">]</span><span class="op" id="5135196">;</span>&nbsp;<span class="op" id="5135198">!</span><span class="ident" id="5135199">hasType</span>&nbsp;<span class="op" id="5135207">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135211">r</span><span class="op" id="5135212">.</span><span class="ident" id="5135213">header</span><span class="op" id="5135219">.</span><span class="ident" id="5135220">Add</span><span class="op" id="5135223">(</span><span class="string" id="5135224">&#34;Content-Type&#34;</span><span class="op" id="5135238">,</span>&nbsp;<span class="string" id="5135240">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5135266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5135269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135273">r</span><span class="op" id="5135274">.</span><span class="ident" id="5135275">header</span><span class="op" id="5135281">.</span><span class="ident" id="5135282">Write</span><span class="op" id="5135287">(</span><span class="ident" id="5135288">r</span><span class="op" id="5135289">.</span><span class="ident" id="5135290">bufw</span><span class="op" id="5135294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135297">r</span><span class="op" id="5135298">.</span><span class="ident" id="5135299">bufw</span><span class="op" id="5135303">.</span><span class="ident" id="5135304">WriteString</span><span class="op" id="5135315">(</span><span class="string" id="5135316">&#34;\r\n&#34;</span><span class="op" id="5135322">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5135325">r</span><span class="op" id="5135326">.</span><span class="ident" id="5135327">bufw</span><span class="op" id="5135331">.</span><span class="ident" id="5135332">Flush</span><span class="op" id="5135337">(</span><span class="op" id="5135338">)</span><br>
<span class="lineno"></span><span class="op" id="5135340">}</span>
</div>
</body>
</html>
