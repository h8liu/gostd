<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1578450">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1578505">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1578559">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1578610">package</span>&nbsp;<span class="ident" id="1578618">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1578627">import</span>&nbsp;<span class="op" id="1578634">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1578637">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1578646">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1578649">const</span>&nbsp;<span class="op" id="1578655">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578658">debugMalloc</span>&nbsp;<span class="op" id="1578670">=</span>&nbsp;<span class="builtintype" id="1578672">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578680">flagNoScan</span>&nbsp;<span class="op" id="1578691">=</span>&nbsp;<span class="ident" id="1578693">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578706">flagNoZero</span>&nbsp;<span class="op" id="1578717">=</span>&nbsp;<span class="ident" id="1578719">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578733">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1578747">=</span>&nbsp;<span class="ident" id="1578749">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578760">tinySizeClass</span>&nbsp;<span class="op" id="1578774">=</span>&nbsp;<span class="ident" id="1578776">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578792">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1578806">=</span>&nbsp;<span class="ident" id="1578808">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578824">pageShift</span>&nbsp;<span class="op" id="1578834">=</span>&nbsp;<span class="ident" id="1578836">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578848">pageSize</span>&nbsp;&nbsp;<span class="op" id="1578858">=</span>&nbsp;<span class="ident" id="1578860">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578871">pageMask</span>&nbsp;&nbsp;<span class="op" id="1578881">=</span>&nbsp;<span class="ident" id="1578883">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578895">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1578911">=</span>&nbsp;<span class="ident" id="1578913">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578930">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1578946">=</span>&nbsp;<span class="ident" id="1578948">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578959">pointersPerByte</span>&nbsp;<span class="op" id="1578975">=</span>&nbsp;<span class="ident" id="1578977">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578995">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579011">=</span>&nbsp;<span class="ident" id="1579013">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579025">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579041">=</span>&nbsp;<span class="ident" id="1579043">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579054">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579070">=</span>&nbsp;<span class="ident" id="1579072">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579087">mSpanInUse</span>&nbsp;<span class="op" id="1579098">=</span>&nbsp;<span class="ident" id="1579100">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579114">concurrentSweep</span>&nbsp;<span class="op" id="1579130">=</span>&nbsp;<span class="ident" id="1579132">_ConcurrentSweep</span>&nbsp;<span class="op" id="1579149">!=</span>&nbsp;<span class="num" id="1579152">0</span><br>
<span class="lineno">35</span><span class="op" id="1579154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579157">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1579193">type</span>&nbsp;<span class="ident" id="1579198">pageID</span>&nbsp;<span class="builtintype" id="1579205">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1579214">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1579257">var</span>&nbsp;<span class="ident" id="1579261">zerobase</span>&nbsp;<span class="builtintype" id="1579270">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579279">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1579316">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1579382">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1579447">func</span>&nbsp;<span class="ident" id="1579452">mallocgc</span><span class="op" id="1579460">(</span><span class="ident" id="1579461">size</span>&nbsp;<span class="builtintype" id="1579466">uintptr</span><span class="op" id="1579473">,</span>&nbsp;<span class="ident" id="1579475">typ</span>&nbsp;<span class="op" id="1579479">*</span><span class="ident" id="1579480">_type</span><span class="op" id="1579485">,</span>&nbsp;<span class="ident" id="1579487">flags</span>&nbsp;<span class="builtintype" id="1579493">uint32</span><span class="op" id="1579499">)</span>&nbsp;<span class="ident" id="1579501">unsafe</span><span class="op" id="1579507">.</span><span class="ident" id="1579508">Pointer</span>&nbsp;<span class="op" id="1579516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579519">if</span>&nbsp;<span class="ident" id="1579522">size</span>&nbsp;<span class="op" id="1579527">==</span>&nbsp;<span class="num" id="1579530">0</span>&nbsp;<span class="op" id="1579532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579536">return</span>&nbsp;<span class="ident" id="1579543">unsafe</span><span class="op" id="1579549">.</span><span class="ident" id="1579550">Pointer</span><span class="op" id="1579557">(</span><span class="op" id="1579558">&amp;</span><span class="ident" id="1579559">zerobase</span><span class="op" id="1579567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579570">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579573">size0</span>&nbsp;<span class="op" id="1579579">:=</span>&nbsp;<span class="ident" id="1579582">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579589">if</span>&nbsp;<span class="ident" id="1579592">flags</span><span class="op" id="1579597">&amp;</span><span class="ident" id="1579598">flagNoScan</span>&nbsp;<span class="op" id="1579609">==</span>&nbsp;<span class="num" id="1579612">0</span>&nbsp;<span class="op" id="1579614">&amp;&amp;</span>&nbsp;<span class="ident" id="1579617">typ</span>&nbsp;<span class="op" id="1579621">==</span>&nbsp;<span class="ident" id="1579624">nil</span>&nbsp;<span class="op" id="1579628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579632">gothrow</span><span class="op" id="1579639">(</span><span class="string" id="1579640">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1579661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579664">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579668">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579737">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579811">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579867">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579943">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580007">if</span>&nbsp;<span class="ident" id="1580010">debugMalloc</span>&nbsp;<span class="op" id="1580022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580026">mp</span>&nbsp;<span class="op" id="1580029">:=</span>&nbsp;<span class="ident" id="1580032">acquirem</span><span class="op" id="1580040">(</span><span class="op" id="1580041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580045">if</span>&nbsp;<span class="ident" id="1580048">mp</span><span class="op" id="1580050">.</span><span class="ident" id="1580051">mallocing</span>&nbsp;<span class="op" id="1580061">!=</span>&nbsp;<span class="num" id="1580064">0</span>&nbsp;<span class="op" id="1580066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580071">gothrow</span><span class="op" id="1580078">(</span><span class="string" id="1580079">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1580096">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580104">mp</span><span class="op" id="1580106">.</span><span class="ident" id="1580107">mallocing</span>&nbsp;<span class="op" id="1580117">=</span>&nbsp;<span class="num" id="1580119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580123">if</span>&nbsp;<span class="ident" id="1580126">mp</span><span class="op" id="1580128">.</span><span class="ident" id="1580129">curg</span>&nbsp;<span class="op" id="1580134">!=</span>&nbsp;<span class="ident" id="1580137">nil</span>&nbsp;<span class="op" id="1580141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580146">mp</span><span class="op" id="1580148">.</span><span class="ident" id="1580149">curg</span><span class="op" id="1580153">.</span><span class="ident" id="1580154">stackguard0</span>&nbsp;<span class="op" id="1580166">=</span>&nbsp;<span class="op" id="1580168">^</span><span class="builtintype" id="1580169">uintptr</span><span class="op" id="1580176">(</span><span class="num" id="1580177">0xfff</span><span class="op" id="1580182">)</span>&nbsp;<span class="op" id="1580184">|</span>&nbsp;<span class="num" id="1580186">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580194">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580201">c</span>&nbsp;<span class="op" id="1580203">:=</span>&nbsp;<span class="ident" id="1580206">gomcache</span><span class="op" id="1580214">(</span><span class="op" id="1580215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580218">var</span>&nbsp;<span class="ident" id="1580222">s</span>&nbsp;<span class="op" id="1580224">*</span><span class="ident" id="1580225">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580232">var</span>&nbsp;<span class="ident" id="1580236">x</span>&nbsp;<span class="ident" id="1580238">unsafe</span><span class="op" id="1580244">.</span><span class="ident" id="1580245">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580254">if</span>&nbsp;<span class="ident" id="1580257">size</span>&nbsp;<span class="op" id="1580262">&lt;=</span>&nbsp;<span class="ident" id="1580265">maxSmallSize</span>&nbsp;<span class="op" id="1580278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580282">if</span>&nbsp;<span class="ident" id="1580285">flags</span><span class="op" id="1580290">&amp;</span><span class="ident" id="1580291">flagNoScan</span>&nbsp;<span class="op" id="1580302">!=</span>&nbsp;<span class="num" id="1580305">0</span>&nbsp;<span class="op" id="1580307">&amp;&amp;</span>&nbsp;<span class="ident" id="1580310">size</span>&nbsp;<span class="op" id="1580315">&lt;</span>&nbsp;<span class="ident" id="1580317">maxTinySize</span>&nbsp;<span class="op" id="1580329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580334">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580356">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580362">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580425">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580486">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580553">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580619">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580677">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580683">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580759">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580832">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580893">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580960">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580995">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581053">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581098">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581158">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581164">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581237">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581302">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581333">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581339">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581408">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581476">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581519">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581525">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581588">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581645">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581707">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581740">tinysize</span>&nbsp;<span class="op" id="1581749">:=</span>&nbsp;<span class="builtintype" id="1581752">uintptr</span><span class="op" id="1581759">(</span><span class="ident" id="1581760">c</span><span class="op" id="1581761">.</span><span class="ident" id="1581762">tinysize</span><span class="op" id="1581770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581775">if</span>&nbsp;<span class="ident" id="1581778">size</span>&nbsp;<span class="op" id="1581783">&lt;=</span>&nbsp;<span class="ident" id="1581786">tinysize</span>&nbsp;<span class="op" id="1581795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581801">tiny</span>&nbsp;<span class="op" id="1581806">:=</span>&nbsp;<span class="ident" id="1581809">unsafe</span><span class="op" id="1581815">.</span><span class="ident" id="1581816">Pointer</span><span class="op" id="1581823">(</span><span class="ident" id="1581824">c</span><span class="op" id="1581825">.</span><span class="ident" id="1581826">tiny</span><span class="op" id="1581830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581836">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581901">if</span>&nbsp;<span class="ident" id="1581904">size</span><span class="op" id="1581908">&amp;</span><span class="num" id="1581909">7</span>&nbsp;<span class="op" id="1581911">==</span>&nbsp;<span class="num" id="1581914">0</span>&nbsp;<span class="op" id="1581916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581923">tiny</span>&nbsp;<span class="op" id="1581928">=</span>&nbsp;<span class="ident" id="1581930">roundup</span><span class="op" id="1581937">(</span><span class="ident" id="1581938">tiny</span><span class="op" id="1581942">,</span>&nbsp;<span class="num" id="1581944">8</span><span class="op" id="1581945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581951">}</span>&nbsp;<span class="keyword" id="1581953">else</span>&nbsp;<span class="keyword" id="1581958">if</span>&nbsp;<span class="ident" id="1581961">size</span><span class="op" id="1581965">&amp;</span><span class="num" id="1581966">3</span>&nbsp;<span class="op" id="1581968">==</span>&nbsp;<span class="num" id="1581971">0</span>&nbsp;<span class="op" id="1581973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581980">tiny</span>&nbsp;<span class="op" id="1581985">=</span>&nbsp;<span class="ident" id="1581987">roundup</span><span class="op" id="1581994">(</span><span class="ident" id="1581995">tiny</span><span class="op" id="1581999">,</span>&nbsp;<span class="num" id="1582001">4</span><span class="op" id="1582002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582008">}</span>&nbsp;<span class="keyword" id="1582010">else</span>&nbsp;<span class="keyword" id="1582015">if</span>&nbsp;<span class="ident" id="1582018">size</span><span class="op" id="1582022">&amp;</span><span class="num" id="1582023">1</span>&nbsp;<span class="op" id="1582025">==</span>&nbsp;<span class="num" id="1582028">0</span>&nbsp;<span class="op" id="1582030">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582037">tiny</span>&nbsp;<span class="op" id="1582042">=</span>&nbsp;<span class="ident" id="1582044">roundup</span><span class="op" id="1582051">(</span><span class="ident" id="1582052">tiny</span><span class="op" id="1582056">,</span>&nbsp;<span class="num" id="1582058">2</span><span class="op" id="1582059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582071">size1</span>&nbsp;<span class="op" id="1582077">:=</span>&nbsp;<span class="ident" id="1582080">size</span>&nbsp;<span class="op" id="1582085">+</span>&nbsp;<span class="op" id="1582087">(</span><span class="builtintype" id="1582088">uintptr</span><span class="op" id="1582095">(</span><span class="ident" id="1582096">tiny</span><span class="op" id="1582100">)</span>&nbsp;<span class="op" id="1582102">-</span>&nbsp;<span class="builtintype" id="1582104">uintptr</span><span class="op" id="1582111">(</span><span class="ident" id="1582112">unsafe</span><span class="op" id="1582118">.</span><span class="ident" id="1582119">Pointer</span><span class="op" id="1582126">(</span><span class="ident" id="1582127">c</span><span class="op" id="1582128">.</span><span class="ident" id="1582129">tiny</span><span class="op" id="1582133">)</span><span class="op" id="1582134">)</span><span class="op" id="1582135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582141">if</span>&nbsp;<span class="ident" id="1582144">size1</span>&nbsp;<span class="op" id="1582150">&lt;=</span>&nbsp;<span class="ident" id="1582153">tinysize</span>&nbsp;<span class="op" id="1582162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582169">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582219">x</span>&nbsp;<span class="op" id="1582221">=</span>&nbsp;<span class="ident" id="1582223">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582233">c</span><span class="op" id="1582234">.</span><span class="ident" id="1582235">tiny</span>&nbsp;<span class="op" id="1582240">=</span>&nbsp;<span class="op" id="1582242">(</span><span class="op" id="1582243">*</span><span class="builtintype" id="1582244">byte</span><span class="op" id="1582248">)</span><span class="op" id="1582249">(</span><span class="ident" id="1582250">add</span><span class="op" id="1582253">(</span><span class="ident" id="1582254">x</span><span class="op" id="1582255">,</span>&nbsp;<span class="ident" id="1582257">size</span><span class="op" id="1582261">)</span><span class="op" id="1582262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582269">c</span><span class="op" id="1582270">.</span><span class="ident" id="1582271">tinysize</span>&nbsp;<span class="op" id="1582280">-=</span>&nbsp;<span class="builtintype" id="1582283">uintptr</span><span class="op" id="1582290">(</span><span class="ident" id="1582291">size1</span><span class="op" id="1582296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582303">c</span><span class="op" id="1582304">.</span><span class="ident" id="1582305">local_tinyallocs</span><span class="op" id="1582321">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582329">if</span>&nbsp;<span class="ident" id="1582332">debugMalloc</span>&nbsp;<span class="op" id="1582344">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582352">mp</span>&nbsp;<span class="op" id="1582355">:=</span>&nbsp;<span class="ident" id="1582358">acquirem</span><span class="op" id="1582366">(</span><span class="op" id="1582367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582375">if</span>&nbsp;<span class="ident" id="1582378">mp</span><span class="op" id="1582380">.</span><span class="ident" id="1582381">mallocing</span>&nbsp;<span class="op" id="1582391">==</span>&nbsp;<span class="num" id="1582394">0</span>&nbsp;<span class="op" id="1582396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582405">gothrow</span><span class="op" id="1582412">(</span><span class="string" id="1582413">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1582425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582441">mp</span><span class="op" id="1582443">.</span><span class="ident" id="1582444">mallocing</span>&nbsp;<span class="op" id="1582454">=</span>&nbsp;<span class="num" id="1582456">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582464">if</span>&nbsp;<span class="ident" id="1582467">mp</span><span class="op" id="1582469">.</span><span class="ident" id="1582470">curg</span>&nbsp;<span class="op" id="1582475">!=</span>&nbsp;<span class="ident" id="1582478">nil</span>&nbsp;<span class="op" id="1582482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582491">mp</span><span class="op" id="1582493">.</span><span class="ident" id="1582494">curg</span><span class="op" id="1582498">.</span><span class="ident" id="1582499">stackguard0</span>&nbsp;<span class="op" id="1582511">=</span>&nbsp;<span class="ident" id="1582513">mp</span><span class="op" id="1582515">.</span><span class="ident" id="1582516">curg</span><span class="op" id="1582520">.</span><span class="ident" id="1582521">stack</span><span class="op" id="1582526">.</span><span class="ident" id="1582527">lo</span>&nbsp;<span class="op" id="1582530">+</span>&nbsp;<span class="ident" id="1582532">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582558">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582615">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582671">releasem</span><span class="op" id="1582679">(</span><span class="ident" id="1582680">mp</span><span class="op" id="1582682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582690">releasem</span><span class="op" id="1582698">(</span><span class="ident" id="1582699">mp</span><span class="op" id="1582701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582715">return</span>&nbsp;<span class="ident" id="1582722">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582728">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582738">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582778">s</span>&nbsp;<span class="op" id="1582780">=</span>&nbsp;<span class="ident" id="1582782">c</span><span class="op" id="1582783">.</span><span class="ident" id="1582784">alloc</span><span class="op" id="1582789">[</span><span class="ident" id="1582790">tinySizeClass</span><span class="op" id="1582803">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582808">v</span>&nbsp;<span class="op" id="1582810">:=</span>&nbsp;<span class="ident" id="1582813">s</span><span class="op" id="1582814">.</span><span class="ident" id="1582815">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582827">if</span>&nbsp;<span class="ident" id="1582830">v</span>&nbsp;<span class="op" id="1582832">==</span>&nbsp;<span class="ident" id="1582835">nil</span>&nbsp;<span class="op" id="1582839">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582845">mp</span>&nbsp;<span class="op" id="1582848">:=</span>&nbsp;<span class="ident" id="1582851">acquirem</span><span class="op" id="1582859">(</span><span class="op" id="1582860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582866">mp</span><span class="op" id="1582868">.</span><span class="ident" id="1582869">scalararg</span><span class="op" id="1582878">[</span><span class="num" id="1582879">0</span><span class="op" id="1582880">]</span>&nbsp;<span class="op" id="1582882">=</span>&nbsp;<span class="ident" id="1582884">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582902">onM</span><span class="op" id="1582905">(</span><span class="ident" id="1582906">mcacheRefill_m</span><span class="op" id="1582920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582926">releasem</span><span class="op" id="1582934">(</span><span class="ident" id="1582935">mp</span><span class="op" id="1582937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582943">s</span>&nbsp;<span class="op" id="1582945">=</span>&nbsp;<span class="ident" id="1582947">c</span><span class="op" id="1582948">.</span><span class="ident" id="1582949">alloc</span><span class="op" id="1582954">[</span><span class="ident" id="1582955">tinySizeClass</span><span class="op" id="1582968">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582974">v</span>&nbsp;<span class="op" id="1582976">=</span>&nbsp;<span class="ident" id="1582978">s</span><span class="op" id="1582979">.</span><span class="ident" id="1582980">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582997">s</span><span class="op" id="1582998">.</span><span class="ident" id="1582999">freelist</span>&nbsp;<span class="op" id="1583008">=</span>&nbsp;<span class="ident" id="1583010">v</span><span class="op" id="1583011">.</span><span class="ident" id="1583012">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583020">s</span><span class="op" id="1583021">.</span><span class="ident" id="1583022">ref</span><span class="op" id="1583025">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583031">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583058">x</span>&nbsp;<span class="op" id="1583060">=</span>&nbsp;<span class="ident" id="1583062">unsafe</span><span class="op" id="1583068">.</span><span class="ident" id="1583069">Pointer</span><span class="op" id="1583076">(</span><span class="ident" id="1583077">v</span><span class="op" id="1583078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583083">(</span><span class="op" id="1583084">*</span><span class="op" id="1583085">[</span><span class="num" id="1583086">2</span><span class="op" id="1583087">]</span><span class="ident" id="1583088">uint64</span><span class="op" id="1583094">)</span><span class="op" id="1583095">(</span><span class="ident" id="1583096">x</span><span class="op" id="1583097">)</span><span class="op" id="1583098">[</span><span class="num" id="1583099">0</span><span class="op" id="1583100">]</span>&nbsp;<span class="op" id="1583102">=</span>&nbsp;<span class="num" id="1583104">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583109">(</span><span class="op" id="1583110">*</span><span class="op" id="1583111">[</span><span class="num" id="1583112">2</span><span class="op" id="1583113">]</span><span class="ident" id="1583114">uint64</span><span class="op" id="1583120">)</span><span class="op" id="1583121">(</span><span class="ident" id="1583122">x</span><span class="op" id="1583123">)</span><span class="op" id="1583124">[</span><span class="num" id="1583125">1</span><span class="op" id="1583126">]</span>&nbsp;<span class="op" id="1583128">=</span>&nbsp;<span class="num" id="1583130">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583135">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583208">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583255">if</span>&nbsp;<span class="ident" id="1583258">maxTinySize</span><span class="op" id="1583269">-</span><span class="ident" id="1583270">size</span>&nbsp;<span class="op" id="1583275">&gt;</span>&nbsp;<span class="ident" id="1583277">tinysize</span>&nbsp;<span class="op" id="1583286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583292">c</span><span class="op" id="1583293">.</span><span class="ident" id="1583294">tiny</span>&nbsp;<span class="op" id="1583299">=</span>&nbsp;<span class="op" id="1583301">(</span><span class="op" id="1583302">*</span><span class="builtintype" id="1583303">byte</span><span class="op" id="1583307">)</span><span class="op" id="1583308">(</span><span class="ident" id="1583309">add</span><span class="op" id="1583312">(</span><span class="ident" id="1583313">x</span><span class="op" id="1583314">,</span>&nbsp;<span class="ident" id="1583316">size</span><span class="op" id="1583320">)</span><span class="op" id="1583321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583327">c</span><span class="op" id="1583328">.</span><span class="ident" id="1583329">tinysize</span>&nbsp;<span class="op" id="1583338">=</span>&nbsp;<span class="builtintype" id="1583340">uintptr</span><span class="op" id="1583347">(</span><span class="ident" id="1583348">maxTinySize</span>&nbsp;<span class="op" id="1583360">-</span>&nbsp;<span class="ident" id="1583362">size</span><span class="op" id="1583366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583376">size</span>&nbsp;<span class="op" id="1583381">=</span>&nbsp;<span class="ident" id="1583383">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583397">}</span>&nbsp;<span class="keyword" id="1583399">else</span>&nbsp;<span class="op" id="1583404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583409">var</span>&nbsp;<span class="ident" id="1583413">sizeclass</span>&nbsp;<span class="builtintype" id="1583423">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583431">if</span>&nbsp;<span class="ident" id="1583434">size</span>&nbsp;<span class="op" id="1583439">&lt;=</span>&nbsp;<span class="num" id="1583442">1024</span><span class="op" id="1583446">-</span><span class="num" id="1583447">8</span>&nbsp;<span class="op" id="1583449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583455">sizeclass</span>&nbsp;<span class="op" id="1583465">=</span>&nbsp;<span class="ident" id="1583467">size_to_class8</span><span class="op" id="1583481">[</span><span class="op" id="1583482">(</span><span class="ident" id="1583483">size</span><span class="op" id="1583487">+</span><span class="num" id="1583488">7</span><span class="op" id="1583489">)</span><span class="op" id="1583490">&gt;&gt;</span><span class="num" id="1583492">3</span><span class="op" id="1583493">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583498">}</span>&nbsp;<span class="keyword" id="1583500">else</span>&nbsp;<span class="op" id="1583505">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583511">sizeclass</span>&nbsp;<span class="op" id="1583521">=</span>&nbsp;<span class="ident" id="1583523">size_to_class128</span><span class="op" id="1583539">[</span><span class="op" id="1583540">(</span><span class="ident" id="1583541">size</span><span class="op" id="1583545">-</span><span class="num" id="1583546">1024</span><span class="op" id="1583550">+</span><span class="num" id="1583551">127</span><span class="op" id="1583554">)</span><span class="op" id="1583555">&gt;&gt;</span><span class="num" id="1583557">7</span><span class="op" id="1583558">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583568">size</span>&nbsp;<span class="op" id="1583573">=</span>&nbsp;<span class="builtintype" id="1583575">uintptr</span><span class="op" id="1583582">(</span><span class="ident" id="1583583">class_to_size</span><span class="op" id="1583596">[</span><span class="ident" id="1583597">sizeclass</span><span class="op" id="1583606">]</span><span class="op" id="1583607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583612">s</span>&nbsp;<span class="op" id="1583614">=</span>&nbsp;<span class="ident" id="1583616">c</span><span class="op" id="1583617">.</span><span class="ident" id="1583618">alloc</span><span class="op" id="1583623">[</span><span class="ident" id="1583624">sizeclass</span><span class="op" id="1583633">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583638">v</span>&nbsp;<span class="op" id="1583640">:=</span>&nbsp;<span class="ident" id="1583643">s</span><span class="op" id="1583644">.</span><span class="ident" id="1583645">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583657">if</span>&nbsp;<span class="ident" id="1583660">v</span>&nbsp;<span class="op" id="1583662">==</span>&nbsp;<span class="ident" id="1583665">nil</span>&nbsp;<span class="op" id="1583669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583675">mp</span>&nbsp;<span class="op" id="1583678">:=</span>&nbsp;<span class="ident" id="1583681">acquirem</span><span class="op" id="1583689">(</span><span class="op" id="1583690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583696">mp</span><span class="op" id="1583698">.</span><span class="ident" id="1583699">scalararg</span><span class="op" id="1583708">[</span><span class="num" id="1583709">0</span><span class="op" id="1583710">]</span>&nbsp;<span class="op" id="1583712">=</span>&nbsp;<span class="builtintype" id="1583714">uintptr</span><span class="op" id="1583721">(</span><span class="ident" id="1583722">sizeclass</span><span class="op" id="1583731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583737">onM</span><span class="op" id="1583740">(</span><span class="ident" id="1583741">mcacheRefill_m</span><span class="op" id="1583755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583761">releasem</span><span class="op" id="1583769">(</span><span class="ident" id="1583770">mp</span><span class="op" id="1583772">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583778">s</span>&nbsp;<span class="op" id="1583780">=</span>&nbsp;<span class="ident" id="1583782">c</span><span class="op" id="1583783">.</span><span class="ident" id="1583784">alloc</span><span class="op" id="1583789">[</span><span class="ident" id="1583790">sizeclass</span><span class="op" id="1583799">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583805">v</span>&nbsp;<span class="op" id="1583807">=</span>&nbsp;<span class="ident" id="1583809">s</span><span class="op" id="1583810">.</span><span class="ident" id="1583811">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583828">s</span><span class="op" id="1583829">.</span><span class="ident" id="1583830">freelist</span>&nbsp;<span class="op" id="1583839">=</span>&nbsp;<span class="ident" id="1583841">v</span><span class="op" id="1583842">.</span><span class="ident" id="1583843">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583851">s</span><span class="op" id="1583852">.</span><span class="ident" id="1583853">ref</span><span class="op" id="1583856">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583862">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583882">x</span>&nbsp;<span class="op" id="1583884">=</span>&nbsp;<span class="ident" id="1583886">unsafe</span><span class="op" id="1583892">.</span><span class="ident" id="1583893">Pointer</span><span class="op" id="1583900">(</span><span class="ident" id="1583901">v</span><span class="op" id="1583902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583907">if</span>&nbsp;<span class="ident" id="1583910">flags</span><span class="op" id="1583915">&amp;</span><span class="ident" id="1583916">flagNoZero</span>&nbsp;<span class="op" id="1583927">==</span>&nbsp;<span class="num" id="1583930">0</span>&nbsp;<span class="op" id="1583932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583938">v</span><span class="op" id="1583939">.</span><span class="ident" id="1583940">next</span>&nbsp;<span class="op" id="1583945">=</span>&nbsp;<span class="ident" id="1583947">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583955">if</span>&nbsp;<span class="ident" id="1583958">size</span>&nbsp;<span class="op" id="1583963">&gt;</span>&nbsp;<span class="num" id="1583965">2</span><span class="op" id="1583966">*</span><span class="ident" id="1583967">ptrSize</span>&nbsp;<span class="op" id="1583975">&amp;&amp;</span>&nbsp;<span class="op" id="1583978">(</span><span class="op" id="1583979">(</span><span class="op" id="1583980">*</span><span class="op" id="1583981">[</span><span class="num" id="1583982">2</span><span class="op" id="1583983">]</span><span class="builtintype" id="1583984">uintptr</span><span class="op" id="1583991">)</span><span class="op" id="1583992">(</span><span class="ident" id="1583993">x</span><span class="op" id="1583994">)</span><span class="op" id="1583995">)</span><span class="op" id="1583996">[</span><span class="num" id="1583997">1</span><span class="op" id="1583998">]</span>&nbsp;<span class="op" id="1584000">!=</span>&nbsp;<span class="num" id="1584003">0</span>&nbsp;<span class="op" id="1584005">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584012">memclr</span><span class="op" id="1584018">(</span><span class="ident" id="1584019">unsafe</span><span class="op" id="1584025">.</span><span class="ident" id="1584026">Pointer</span><span class="op" id="1584033">(</span><span class="ident" id="1584034">v</span><span class="op" id="1584035">)</span><span class="op" id="1584036">,</span>&nbsp;<span class="ident" id="1584038">size</span><span class="op" id="1584042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584061">c</span><span class="op" id="1584062">.</span><span class="ident" id="1584063">local_cachealloc</span>&nbsp;<span class="op" id="1584080">+=</span>&nbsp;<span class="ident" id="1584083">intptr</span><span class="op" id="1584089">(</span><span class="ident" id="1584090">size</span><span class="op" id="1584094">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584097">}</span>&nbsp;<span class="keyword" id="1584099">else</span>&nbsp;<span class="op" id="1584104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584108">mp</span>&nbsp;<span class="op" id="1584111">:=</span>&nbsp;<span class="ident" id="1584114">acquirem</span><span class="op" id="1584122">(</span><span class="op" id="1584123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584127">mp</span><span class="op" id="1584129">.</span><span class="ident" id="1584130">scalararg</span><span class="op" id="1584139">[</span><span class="num" id="1584140">0</span><span class="op" id="1584141">]</span>&nbsp;<span class="op" id="1584143">=</span>&nbsp;<span class="builtintype" id="1584145">uintptr</span><span class="op" id="1584152">(</span><span class="ident" id="1584153">size</span><span class="op" id="1584157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584161">mp</span><span class="op" id="1584163">.</span><span class="ident" id="1584164">scalararg</span><span class="op" id="1584173">[</span><span class="num" id="1584174">1</span><span class="op" id="1584175">]</span>&nbsp;<span class="op" id="1584177">=</span>&nbsp;<span class="builtintype" id="1584179">uintptr</span><span class="op" id="1584186">(</span><span class="ident" id="1584187">flags</span><span class="op" id="1584192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584196">onM</span><span class="op" id="1584199">(</span><span class="ident" id="1584200">largeAlloc_m</span><span class="op" id="1584212">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584216">s</span>&nbsp;<span class="op" id="1584218">=</span>&nbsp;<span class="op" id="1584220">(</span><span class="op" id="1584221">*</span><span class="ident" id="1584222">mspan</span><span class="op" id="1584227">)</span><span class="op" id="1584228">(</span><span class="ident" id="1584229">mp</span><span class="op" id="1584231">.</span><span class="ident" id="1584232">ptrarg</span><span class="op" id="1584238">[</span><span class="num" id="1584239">0</span><span class="op" id="1584240">]</span><span class="op" id="1584241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584245">mp</span><span class="op" id="1584247">.</span><span class="ident" id="1584248">ptrarg</span><span class="op" id="1584254">[</span><span class="num" id="1584255">0</span><span class="op" id="1584256">]</span>&nbsp;<span class="op" id="1584258">=</span>&nbsp;<span class="ident" id="1584260">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584266">releasem</span><span class="op" id="1584274">(</span><span class="ident" id="1584275">mp</span><span class="op" id="1584277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584281">x</span>&nbsp;<span class="op" id="1584283">=</span>&nbsp;<span class="ident" id="1584285">unsafe</span><span class="op" id="1584291">.</span><span class="ident" id="1584292">Pointer</span><span class="op" id="1584299">(</span><span class="builtintype" id="1584300">uintptr</span><span class="op" id="1584307">(</span><span class="ident" id="1584308">s</span><span class="op" id="1584309">.</span><span class="ident" id="1584310">start</span>&nbsp;<span class="op" id="1584316">&lt;&lt;</span>&nbsp;<span class="ident" id="1584319">pageShift</span><span class="op" id="1584328">)</span><span class="op" id="1584329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584333">size</span>&nbsp;<span class="op" id="1584338">=</span>&nbsp;<span class="builtintype" id="1584340">uintptr</span><span class="op" id="1584347">(</span><span class="ident" id="1584348">s</span><span class="op" id="1584349">.</span><span class="ident" id="1584350">elemsize</span><span class="op" id="1584358">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584365">if</span>&nbsp;<span class="ident" id="1584368">flags</span><span class="op" id="1584373">&amp;</span><span class="ident" id="1584374">flagNoScan</span>&nbsp;<span class="op" id="1584385">!=</span>&nbsp;<span class="num" id="1584388">0</span>&nbsp;<span class="op" id="1584390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584394">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584437">goto</span>&nbsp;<span class="ident" id="1584442">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584454">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584527">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584597">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584672">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584747">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584792">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584850">if</span>&nbsp;<span class="ident" id="1584853">typ</span>&nbsp;<span class="op" id="1584857">==</span>&nbsp;<span class="ident" id="1584860">deferType</span>&nbsp;<span class="op" id="1584870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584874">size0</span>&nbsp;<span class="op" id="1584880">=</span>&nbsp;<span class="ident" id="1584882">unsafe</span><span class="op" id="1584888">.</span><span class="ident" id="1584889">Sizeof</span><span class="op" id="1584895">(</span><span class="ident" id="1584896">_defer</span><span class="op" id="1584902">{</span><span class="op" id="1584903">}</span><span class="op" id="1584904">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584911">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584975">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585019">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585023">arena_start</span>&nbsp;<span class="op" id="1585035">:=</span>&nbsp;<span class="builtintype" id="1585038">uintptr</span><span class="op" id="1585045">(</span><span class="ident" id="1585046">unsafe</span><span class="op" id="1585052">.</span><span class="ident" id="1585053">Pointer</span><span class="op" id="1585060">(</span><span class="ident" id="1585061">mheap_</span><span class="op" id="1585067">.</span><span class="ident" id="1585068">arena_start</span><span class="op" id="1585079">)</span><span class="op" id="1585080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585084">off</span>&nbsp;<span class="op" id="1585088">:=</span>&nbsp;<span class="op" id="1585091">(</span><span class="builtintype" id="1585092">uintptr</span><span class="op" id="1585099">(</span><span class="ident" id="1585100">x</span><span class="op" id="1585101">)</span>&nbsp;<span class="op" id="1585103">-</span>&nbsp;<span class="ident" id="1585105">arena_start</span><span class="op" id="1585116">)</span>&nbsp;<span class="op" id="1585118">/</span>&nbsp;<span class="ident" id="1585120">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585130">xbits</span>&nbsp;<span class="op" id="1585136">:=</span>&nbsp;<span class="op" id="1585139">(</span><span class="op" id="1585140">*</span><span class="builtintype" id="1585141">uint8</span><span class="op" id="1585146">)</span><span class="op" id="1585147">(</span><span class="ident" id="1585148">unsafe</span><span class="op" id="1585154">.</span><span class="ident" id="1585155">Pointer</span><span class="op" id="1585162">(</span><span class="ident" id="1585163">arena_start</span>&nbsp;<span class="op" id="1585175">-</span>&nbsp;<span class="ident" id="1585177">off</span><span class="op" id="1585180">/</span><span class="ident" id="1585181">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1585200">-</span>&nbsp;<span class="num" id="1585202">1</span><span class="op" id="1585203">)</span><span class="op" id="1585204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585208">shift</span>&nbsp;<span class="op" id="1585214">:=</span>&nbsp;<span class="op" id="1585217">(</span><span class="ident" id="1585218">off</span>&nbsp;<span class="op" id="1585222">%</span>&nbsp;<span class="ident" id="1585224">wordsPerBitmapByte</span><span class="op" id="1585242">)</span>&nbsp;<span class="op" id="1585244">*</span>&nbsp;<span class="ident" id="1585246">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585255">if</span>&nbsp;<span class="ident" id="1585258">debugMalloc</span>&nbsp;<span class="op" id="1585270">&amp;&amp;</span>&nbsp;<span class="op" id="1585273">(</span><span class="op" id="1585274">(</span><span class="op" id="1585275">*</span><span class="ident" id="1585276">xbits</span><span class="op" id="1585281">&gt;&gt;</span><span class="ident" id="1585283">shift</span><span class="op" id="1585288">)</span><span class="op" id="1585289">&amp;</span><span class="op" id="1585290">(</span><span class="ident" id="1585291">bitMask</span><span class="op" id="1585298">|</span><span class="ident" id="1585299">bitPtrMask</span><span class="op" id="1585309">)</span><span class="op" id="1585310">)</span>&nbsp;<span class="op" id="1585312">!=</span>&nbsp;<span class="ident" id="1585315">bitBoundary</span>&nbsp;<span class="op" id="1585327">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1585332">println</span><span class="op" id="1585339">(</span><span class="string" id="1585340">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1585357">,</span>&nbsp;<span class="op" id="1585359">(</span><span class="op" id="1585360">*</span><span class="ident" id="1585361">xbits</span><span class="op" id="1585366">&gt;&gt;</span><span class="ident" id="1585368">shift</span><span class="op" id="1585373">)</span><span class="op" id="1585374">&amp;</span><span class="op" id="1585375">(</span><span class="ident" id="1585376">bitMask</span><span class="op" id="1585383">|</span><span class="ident" id="1585384">bitPtrMask</span><span class="op" id="1585394">)</span><span class="op" id="1585395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585400">gothrow</span><span class="op" id="1585407">(</span><span class="string" id="1585408">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1585435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585444">var</span>&nbsp;<span class="ident" id="1585448">ti</span><span class="op" id="1585450">,</span>&nbsp;<span class="ident" id="1585452">te</span>&nbsp;<span class="builtintype" id="1585455">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585465">var</span>&nbsp;<span class="ident" id="1585469">ptrmask</span>&nbsp;<span class="op" id="1585477">*</span><span class="builtintype" id="1585478">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585486">if</span>&nbsp;<span class="ident" id="1585489">size</span>&nbsp;<span class="op" id="1585494">==</span>&nbsp;<span class="ident" id="1585497">ptrSize</span>&nbsp;<span class="op" id="1585505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585510">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585573">*</span><span class="ident" id="1585574">xbits</span>&nbsp;<span class="op" id="1585580">|=</span>&nbsp;<span class="op" id="1585583">(</span><span class="ident" id="1585584">bitsPointer</span>&nbsp;<span class="op" id="1585596">&lt;&lt;</span>&nbsp;<span class="num" id="1585599">2</span><span class="op" id="1585600">)</span>&nbsp;<span class="op" id="1585602">&lt;&lt;</span>&nbsp;<span class="ident" id="1585605">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585614">goto</span>&nbsp;<span class="ident" id="1585619">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585632">if</span>&nbsp;<span class="ident" id="1585635">typ</span><span class="op" id="1585638">.</span><span class="ident" id="1585639">kind</span><span class="op" id="1585643">&amp;</span><span class="ident" id="1585644">kindGCProg</span>&nbsp;<span class="op" id="1585655">!=</span>&nbsp;<span class="num" id="1585658">0</span>&nbsp;<span class="op" id="1585660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585665">nptr</span>&nbsp;<span class="op" id="1585670">:=</span>&nbsp;<span class="op" id="1585673">(</span><span class="builtintype" id="1585674">uintptr</span><span class="op" id="1585681">(</span><span class="ident" id="1585682">typ</span><span class="op" id="1585685">.</span><span class="ident" id="1585686">size</span><span class="op" id="1585690">)</span>&nbsp;<span class="op" id="1585692">+</span>&nbsp;<span class="ident" id="1585694">ptrSize</span>&nbsp;<span class="op" id="1585702">-</span>&nbsp;<span class="num" id="1585704">1</span><span class="op" id="1585705">)</span>&nbsp;<span class="op" id="1585707">/</span>&nbsp;<span class="ident" id="1585709">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585720">masksize</span>&nbsp;<span class="op" id="1585729">:=</span>&nbsp;<span class="ident" id="1585732">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585740">if</span>&nbsp;<span class="ident" id="1585743">masksize</span><span class="op" id="1585751">%</span><span class="num" id="1585752">2</span>&nbsp;<span class="op" id="1585754">!=</span>&nbsp;<span class="num" id="1585757">0</span>&nbsp;<span class="op" id="1585759">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585765">masksize</span>&nbsp;<span class="op" id="1585774">*=</span>&nbsp;<span class="num" id="1585777">2</span>&nbsp;<span class="comment" id="1585779">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585799">masksize</span>&nbsp;<span class="op" id="1585808">=</span>&nbsp;<span class="ident" id="1585810">masksize</span>&nbsp;<span class="op" id="1585819">*</span>&nbsp;<span class="ident" id="1585821">pointersPerByte</span>&nbsp;<span class="op" id="1585837">/</span>&nbsp;<span class="num" id="1585839">8</span>&nbsp;<span class="comment" id="1585841">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585863">masksize</span><span class="op" id="1585871">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1585905">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585940">if</span>&nbsp;<span class="ident" id="1585943">masksize</span>&nbsp;<span class="op" id="1585952">&gt;</span>&nbsp;<span class="ident" id="1585954">maxGCMask</span>&nbsp;<span class="op" id="1585964">&amp;&amp;</span>&nbsp;<span class="ident" id="1585967">typ</span><span class="op" id="1585970">.</span><span class="ident" id="1585971">gc</span><span class="op" id="1585973">[</span><span class="num" id="1585974">1</span><span class="op" id="1585975">]</span>&nbsp;<span class="op" id="1585977">!=</span>&nbsp;<span class="num" id="1585980">0</span>&nbsp;<span class="op" id="1585982">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585988">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586049">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586109">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586172">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586200">mp</span>&nbsp;<span class="op" id="1586203">:=</span>&nbsp;<span class="ident" id="1586206">acquirem</span><span class="op" id="1586214">(</span><span class="op" id="1586215">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586221">mp</span><span class="op" id="1586223">.</span><span class="ident" id="1586224">ptrarg</span><span class="op" id="1586230">[</span><span class="num" id="1586231">0</span><span class="op" id="1586232">]</span>&nbsp;<span class="op" id="1586234">=</span>&nbsp;<span class="ident" id="1586236">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586242">mp</span><span class="op" id="1586244">.</span><span class="ident" id="1586245">ptrarg</span><span class="op" id="1586251">[</span><span class="num" id="1586252">1</span><span class="op" id="1586253">]</span>&nbsp;<span class="op" id="1586255">=</span>&nbsp;<span class="ident" id="1586257">unsafe</span><span class="op" id="1586263">.</span><span class="ident" id="1586264">Pointer</span><span class="op" id="1586271">(</span><span class="ident" id="1586272">typ</span><span class="op" id="1586275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586281">mp</span><span class="op" id="1586283">.</span><span class="ident" id="1586284">scalararg</span><span class="op" id="1586293">[</span><span class="num" id="1586294">0</span><span class="op" id="1586295">]</span>&nbsp;<span class="op" id="1586297">=</span>&nbsp;<span class="builtintype" id="1586299">uintptr</span><span class="op" id="1586306">(</span><span class="ident" id="1586307">size</span><span class="op" id="1586311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586317">mp</span><span class="op" id="1586319">.</span><span class="ident" id="1586320">scalararg</span><span class="op" id="1586329">[</span><span class="num" id="1586330">1</span><span class="op" id="1586331">]</span>&nbsp;<span class="op" id="1586333">=</span>&nbsp;<span class="builtintype" id="1586335">uintptr</span><span class="op" id="1586342">(</span><span class="ident" id="1586343">size0</span><span class="op" id="1586348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586354">onM</span><span class="op" id="1586357">(</span><span class="ident" id="1586358">unrollgcproginplace_m</span><span class="op" id="1586379">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586385">releasem</span><span class="op" id="1586393">(</span><span class="ident" id="1586394">mp</span><span class="op" id="1586396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586402">goto</span>&nbsp;<span class="ident" id="1586407">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586422">ptrmask</span>&nbsp;<span class="op" id="1586430">=</span>&nbsp;<span class="op" id="1586432">(</span><span class="op" id="1586433">*</span><span class="builtintype" id="1586434">uint8</span><span class="op" id="1586439">)</span><span class="op" id="1586440">(</span><span class="ident" id="1586441">unsafe</span><span class="op" id="1586447">.</span><span class="ident" id="1586448">Pointer</span><span class="op" id="1586455">(</span><span class="builtintype" id="1586456">uintptr</span><span class="op" id="1586463">(</span><span class="ident" id="1586464">typ</span><span class="op" id="1586467">.</span><span class="ident" id="1586468">gc</span><span class="op" id="1586470">[</span><span class="num" id="1586471">0</span><span class="op" id="1586472">]</span><span class="op" id="1586473">)</span><span class="op" id="1586474">)</span><span class="op" id="1586475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586480">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586533">if</span>&nbsp;<span class="builtintype" id="1586536">uintptr</span><span class="op" id="1586543">(</span><span class="ident" id="1586544">atomicloadp</span><span class="op" id="1586555">(</span><span class="ident" id="1586556">unsafe</span><span class="op" id="1586562">.</span><span class="ident" id="1586563">Pointer</span><span class="op" id="1586570">(</span><span class="ident" id="1586571">ptrmask</span><span class="op" id="1586578">)</span><span class="op" id="1586579">)</span><span class="op" id="1586580">)</span><span class="op" id="1586581">&amp;</span><span class="num" id="1586582">0xff</span>&nbsp;<span class="op" id="1586587">==</span>&nbsp;<span class="num" id="1586590">0</span>&nbsp;<span class="op" id="1586592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586598">mp</span>&nbsp;<span class="op" id="1586601">:=</span>&nbsp;<span class="ident" id="1586604">acquirem</span><span class="op" id="1586612">(</span><span class="op" id="1586613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586619">mp</span><span class="op" id="1586621">.</span><span class="ident" id="1586622">ptrarg</span><span class="op" id="1586628">[</span><span class="num" id="1586629">0</span><span class="op" id="1586630">]</span>&nbsp;<span class="op" id="1586632">=</span>&nbsp;<span class="ident" id="1586634">unsafe</span><span class="op" id="1586640">.</span><span class="ident" id="1586641">Pointer</span><span class="op" id="1586648">(</span><span class="ident" id="1586649">typ</span><span class="op" id="1586652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586658">onM</span><span class="op" id="1586661">(</span><span class="ident" id="1586662">unrollgcprog_m</span><span class="op" id="1586676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586682">releasem</span><span class="op" id="1586690">(</span><span class="ident" id="1586691">mp</span><span class="op" id="1586693">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586703">ptrmask</span>&nbsp;<span class="op" id="1586711">=</span>&nbsp;<span class="op" id="1586713">(</span><span class="op" id="1586714">*</span><span class="builtintype" id="1586715">uint8</span><span class="op" id="1586720">)</span><span class="op" id="1586721">(</span><span class="ident" id="1586722">add</span><span class="op" id="1586725">(</span><span class="ident" id="1586726">unsafe</span><span class="op" id="1586732">.</span><span class="ident" id="1586733">Pointer</span><span class="op" id="1586740">(</span><span class="ident" id="1586741">ptrmask</span><span class="op" id="1586748">)</span><span class="op" id="1586749">,</span>&nbsp;<span class="num" id="1586751">1</span><span class="op" id="1586752">)</span><span class="op" id="1586753">)</span>&nbsp;<span class="comment" id="1586755">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586786">}</span>&nbsp;<span class="keyword" id="1586788">else</span>&nbsp;<span class="op" id="1586793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586798">ptrmask</span>&nbsp;<span class="op" id="1586806">=</span>&nbsp;<span class="op" id="1586808">(</span><span class="op" id="1586809">*</span><span class="builtintype" id="1586810">uint8</span><span class="op" id="1586815">)</span><span class="op" id="1586816">(</span><span class="ident" id="1586817">unsafe</span><span class="op" id="1586823">.</span><span class="ident" id="1586824">Pointer</span><span class="op" id="1586831">(</span><span class="ident" id="1586832">typ</span><span class="op" id="1586835">.</span><span class="ident" id="1586836">gc</span><span class="op" id="1586838">[</span><span class="num" id="1586839">0</span><span class="op" id="1586840">]</span><span class="op" id="1586841">)</span><span class="op" id="1586842">)</span>&nbsp;<span class="comment" id="1586844">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586874">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586878">if</span>&nbsp;<span class="ident" id="1586881">size</span>&nbsp;<span class="op" id="1586886">==</span>&nbsp;<span class="num" id="1586889">2</span><span class="op" id="1586890">*</span><span class="ident" id="1586891">ptrSize</span>&nbsp;<span class="op" id="1586899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586904">*</span><span class="ident" id="1586905">xbits</span>&nbsp;<span class="op" id="1586911">=</span>&nbsp;<span class="op" id="1586913">*</span><span class="ident" id="1586914">ptrmask</span>&nbsp;<span class="op" id="1586922">|</span>&nbsp;<span class="ident" id="1586924">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586939">goto</span>&nbsp;<span class="ident" id="1586944">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586957">te</span>&nbsp;<span class="op" id="1586960">=</span>&nbsp;<span class="builtintype" id="1586962">uintptr</span><span class="op" id="1586969">(</span><span class="ident" id="1586970">typ</span><span class="op" id="1586973">.</span><span class="ident" id="1586974">size</span><span class="op" id="1586978">)</span>&nbsp;<span class="op" id="1586980">/</span>&nbsp;<span class="ident" id="1586982">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586992">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587061">if</span>&nbsp;<span class="ident" id="1587064">te</span><span class="op" id="1587066">%</span><span class="num" id="1587067">2</span>&nbsp;<span class="op" id="1587069">==</span>&nbsp;<span class="num" id="1587072">0</span>&nbsp;<span class="op" id="1587074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587079">te</span>&nbsp;<span class="op" id="1587082">/=</span>&nbsp;<span class="num" id="1587085">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587093">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587136">for</span>&nbsp;<span class="ident" id="1587140">i</span>&nbsp;<span class="op" id="1587142">:=</span>&nbsp;<span class="builtintype" id="1587145">uintptr</span><span class="op" id="1587152">(</span><span class="num" id="1587153">0</span><span class="op" id="1587154">)</span><span class="op" id="1587155">;</span>&nbsp;<span class="ident" id="1587157">i</span>&nbsp;<span class="op" id="1587159">&lt;</span>&nbsp;<span class="ident" id="1587161">size0</span><span class="op" id="1587166">;</span>&nbsp;<span class="ident" id="1587168">i</span>&nbsp;<span class="op" id="1587170">+=</span>&nbsp;<span class="num" id="1587173">2</span>&nbsp;<span class="op" id="1587175">*</span>&nbsp;<span class="ident" id="1587177">ptrSize</span>&nbsp;<span class="op" id="1587185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587190">v</span>&nbsp;<span class="op" id="1587192">:=</span>&nbsp;<span class="op" id="1587195">*</span><span class="op" id="1587196">(</span><span class="op" id="1587197">*</span><span class="builtintype" id="1587198">uint8</span><span class="op" id="1587203">)</span><span class="op" id="1587204">(</span><span class="ident" id="1587205">add</span><span class="op" id="1587208">(</span><span class="ident" id="1587209">unsafe</span><span class="op" id="1587215">.</span><span class="ident" id="1587216">Pointer</span><span class="op" id="1587223">(</span><span class="ident" id="1587224">ptrmask</span><span class="op" id="1587231">)</span><span class="op" id="1587232">,</span>&nbsp;<span class="ident" id="1587234">ti</span><span class="op" id="1587236">)</span><span class="op" id="1587237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587242">ti</span><span class="op" id="1587244">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587250">if</span>&nbsp;<span class="ident" id="1587253">ti</span>&nbsp;<span class="op" id="1587256">==</span>&nbsp;<span class="ident" id="1587259">te</span>&nbsp;<span class="op" id="1587262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587268">ti</span>&nbsp;<span class="op" id="1587271">=</span>&nbsp;<span class="num" id="1587273">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587283">if</span>&nbsp;<span class="ident" id="1587286">i</span>&nbsp;<span class="op" id="1587288">==</span>&nbsp;<span class="num" id="1587291">0</span>&nbsp;<span class="op" id="1587293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587299">v</span>&nbsp;<span class="op" id="1587301">|=</span>&nbsp;<span class="ident" id="1587304">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587324">if</span>&nbsp;<span class="ident" id="1587327">i</span><span class="op" id="1587328">+</span><span class="ident" id="1587329">ptrSize</span>&nbsp;<span class="op" id="1587337">==</span>&nbsp;<span class="ident" id="1587340">size0</span>&nbsp;<span class="op" id="1587346">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587352">v</span>&nbsp;<span class="op" id="1587354">&amp;^=</span>&nbsp;<span class="builtintype" id="1587358">uint8</span><span class="op" id="1587363">(</span><span class="ident" id="1587364">bitPtrMask</span>&nbsp;<span class="op" id="1587375">&lt;&lt;</span>&nbsp;<span class="num" id="1587378">4</span><span class="op" id="1587379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587390">*</span><span class="ident" id="1587391">xbits</span>&nbsp;<span class="op" id="1587397">=</span>&nbsp;<span class="ident" id="1587399">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587404">xbits</span>&nbsp;<span class="op" id="1587410">=</span>&nbsp;<span class="op" id="1587412">(</span><span class="op" id="1587413">*</span><span class="builtintype" id="1587414">byte</span><span class="op" id="1587418">)</span><span class="op" id="1587419">(</span><span class="ident" id="1587420">add</span><span class="op" id="1587423">(</span><span class="ident" id="1587424">unsafe</span><span class="op" id="1587430">.</span><span class="ident" id="1587431">Pointer</span><span class="op" id="1587438">(</span><span class="ident" id="1587439">xbits</span><span class="op" id="1587444">)</span><span class="op" id="1587445">,</span>&nbsp;<span class="op" id="1587447">^</span><span class="builtintype" id="1587448">uintptr</span><span class="op" id="1587455">(</span><span class="num" id="1587456">0</span><span class="op" id="1587457">)</span><span class="op" id="1587458">)</span><span class="op" id="1587459">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587467">if</span>&nbsp;<span class="ident" id="1587470">size0</span><span class="op" id="1587475">%</span><span class="op" id="1587476">(</span><span class="num" id="1587477">2</span><span class="op" id="1587478">*</span><span class="ident" id="1587479">ptrSize</span><span class="op" id="1587486">)</span>&nbsp;<span class="op" id="1587488">==</span>&nbsp;<span class="num" id="1587491">0</span>&nbsp;<span class="op" id="1587493">&amp;&amp;</span>&nbsp;<span class="ident" id="1587496">size0</span>&nbsp;<span class="op" id="1587502">&lt;</span>&nbsp;<span class="ident" id="1587504">size</span>&nbsp;<span class="op" id="1587509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587514">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587572">*</span><span class="ident" id="1587573">xbits</span>&nbsp;<span class="op" id="1587579">=</span>&nbsp;<span class="ident" id="1587581">bitsDead</span>&nbsp;<span class="op" id="1587590">&lt;&lt;</span>&nbsp;<span class="num" id="1587593">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587597">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587600">}</span><br>
<span class="lineno"></span><span class="ident" id="1587602">marked</span><span class="op" id="1587608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587611">if</span>&nbsp;<span class="ident" id="1587614">raceenabled</span>&nbsp;<span class="op" id="1587626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587630">racemalloc</span><span class="op" id="1587640">(</span><span class="ident" id="1587641">x</span><span class="op" id="1587642">,</span>&nbsp;<span class="ident" id="1587644">size</span><span class="op" id="1587648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587651">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587655">if</span>&nbsp;<span class="ident" id="1587658">debugMalloc</span>&nbsp;<span class="op" id="1587670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587674">mp</span>&nbsp;<span class="op" id="1587677">:=</span>&nbsp;<span class="ident" id="1587680">acquirem</span><span class="op" id="1587688">(</span><span class="op" id="1587689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587693">if</span>&nbsp;<span class="ident" id="1587696">mp</span><span class="op" id="1587698">.</span><span class="ident" id="1587699">mallocing</span>&nbsp;<span class="op" id="1587709">==</span>&nbsp;<span class="num" id="1587712">0</span>&nbsp;<span class="op" id="1587714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587719">gothrow</span><span class="op" id="1587726">(</span><span class="string" id="1587727">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1587739">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587747">mp</span><span class="op" id="1587749">.</span><span class="ident" id="1587750">mallocing</span>&nbsp;<span class="op" id="1587760">=</span>&nbsp;<span class="num" id="1587762">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587766">if</span>&nbsp;<span class="ident" id="1587769">mp</span><span class="op" id="1587771">.</span><span class="ident" id="1587772">curg</span>&nbsp;<span class="op" id="1587777">!=</span>&nbsp;<span class="ident" id="1587780">nil</span>&nbsp;<span class="op" id="1587784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587789">mp</span><span class="op" id="1587791">.</span><span class="ident" id="1587792">curg</span><span class="op" id="1587796">.</span><span class="ident" id="1587797">stackguard0</span>&nbsp;<span class="op" id="1587809">=</span>&nbsp;<span class="ident" id="1587811">mp</span><span class="op" id="1587813">.</span><span class="ident" id="1587814">curg</span><span class="op" id="1587818">.</span><span class="ident" id="1587819">stack</span><span class="op" id="1587824">.</span><span class="ident" id="1587825">lo</span>&nbsp;<span class="op" id="1587828">+</span>&nbsp;<span class="ident" id="1587830">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587844">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587848">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1587901">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587953">releasem</span><span class="op" id="1587961">(</span><span class="ident" id="1587962">mp</span><span class="op" id="1587964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587968">releasem</span><span class="op" id="1587976">(</span><span class="ident" id="1587977">mp</span><span class="op" id="1587979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587982">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587986">if</span>&nbsp;<span class="ident" id="1587989">debug</span><span class="op" id="1587994">.</span><span class="ident" id="1587995">allocfreetrace</span>&nbsp;<span class="op" id="1588010">!=</span>&nbsp;<span class="num" id="1588013">0</span>&nbsp;<span class="op" id="1588015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588019">tracealloc</span><span class="op" id="1588029">(</span><span class="ident" id="1588030">x</span><span class="op" id="1588031">,</span>&nbsp;<span class="ident" id="1588033">size</span><span class="op" id="1588037">,</span>&nbsp;<span class="ident" id="1588039">typ</span><span class="op" id="1588042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588049">if</span>&nbsp;<span class="ident" id="1588052">rate</span>&nbsp;<span class="op" id="1588057">:=</span>&nbsp;<span class="ident" id="1588060">MemProfileRate</span><span class="op" id="1588074">;</span>&nbsp;<span class="ident" id="1588076">rate</span>&nbsp;<span class="op" id="1588081">&gt;</span>&nbsp;<span class="num" id="1588083">0</span>&nbsp;<span class="op" id="1588085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588089">if</span>&nbsp;<span class="ident" id="1588092">size</span>&nbsp;<span class="op" id="1588097">&lt;</span>&nbsp;<span class="builtintype" id="1588099">uintptr</span><span class="op" id="1588106">(</span><span class="ident" id="1588107">rate</span><span class="op" id="1588111">)</span>&nbsp;<span class="op" id="1588113">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1588116">int32</span><span class="op" id="1588121">(</span><span class="ident" id="1588122">size</span><span class="op" id="1588126">)</span>&nbsp;<span class="op" id="1588128">&lt;</span>&nbsp;<span class="ident" id="1588130">c</span><span class="op" id="1588131">.</span><span class="ident" id="1588132">next_sample</span>&nbsp;<span class="op" id="1588144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588149">c</span><span class="op" id="1588150">.</span><span class="ident" id="1588151">next_sample</span>&nbsp;<span class="op" id="1588163">-=</span>&nbsp;<span class="builtintype" id="1588166">int32</span><span class="op" id="1588171">(</span><span class="ident" id="1588172">size</span><span class="op" id="1588176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588180">}</span>&nbsp;<span class="keyword" id="1588182">else</span>&nbsp;<span class="op" id="1588187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588192">mp</span>&nbsp;<span class="op" id="1588195">:=</span>&nbsp;<span class="ident" id="1588198">acquirem</span><span class="op" id="1588206">(</span><span class="op" id="1588207">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588212">profilealloc</span><span class="op" id="1588224">(</span><span class="ident" id="1588225">mp</span><span class="op" id="1588227">,</span>&nbsp;<span class="ident" id="1588229">x</span><span class="op" id="1588230">,</span>&nbsp;<span class="ident" id="1588232">size</span><span class="op" id="1588236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588241">releasem</span><span class="op" id="1588249">(</span><span class="ident" id="1588250">mp</span><span class="op" id="1588252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588263">if</span>&nbsp;<span class="ident" id="1588266">memstats</span><span class="op" id="1588274">.</span><span class="ident" id="1588275">heap_alloc</span>&nbsp;<span class="op" id="1588286">&gt;=</span>&nbsp;<span class="ident" id="1588289">memstats</span><span class="op" id="1588297">.</span><span class="ident" id="1588298">next_gc</span>&nbsp;<span class="op" id="1588306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588310">gogc</span><span class="op" id="1588314">(</span><span class="num" id="1588315">0</span><span class="op" id="1588316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588323">return</span>&nbsp;<span class="ident" id="1588330">x</span><br>
<span class="lineno">345</span><span class="op" id="1588332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588335">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1588368">func</span>&nbsp;<span class="ident" id="1588373">newobject</span><span class="op" id="1588382">(</span><span class="ident" id="1588383">typ</span>&nbsp;<span class="op" id="1588387">*</span><span class="ident" id="1588388">_type</span><span class="op" id="1588393">)</span>&nbsp;<span class="ident" id="1588395">unsafe</span><span class="op" id="1588401">.</span><span class="ident" id="1588402">Pointer</span>&nbsp;<span class="op" id="1588410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588413">flags</span>&nbsp;<span class="op" id="1588419">:=</span>&nbsp;<span class="builtintype" id="1588422">uint32</span><span class="op" id="1588428">(</span><span class="num" id="1588429">0</span><span class="op" id="1588430">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588433">if</span>&nbsp;<span class="ident" id="1588436">typ</span><span class="op" id="1588439">.</span><span class="ident" id="1588440">kind</span><span class="op" id="1588444">&amp;</span><span class="ident" id="1588445">kindNoPointers</span>&nbsp;<span class="op" id="1588460">!=</span>&nbsp;<span class="num" id="1588463">0</span>&nbsp;<span class="op" id="1588465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588469">flags</span>&nbsp;<span class="op" id="1588475">|=</span>&nbsp;<span class="ident" id="1588478">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588493">return</span>&nbsp;<span class="ident" id="1588500">mallocgc</span><span class="op" id="1588508">(</span><span class="builtintype" id="1588509">uintptr</span><span class="op" id="1588516">(</span><span class="ident" id="1588517">typ</span><span class="op" id="1588520">.</span><span class="ident" id="1588521">size</span><span class="op" id="1588525">)</span><span class="op" id="1588526">,</span>&nbsp;<span class="ident" id="1588528">typ</span><span class="op" id="1588531">,</span>&nbsp;<span class="ident" id="1588533">flags</span><span class="op" id="1588538">)</span><br>
<span class="lineno"></span><span class="op" id="1588540">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1588543">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1588588">func</span>&nbsp;<span class="ident" id="1588593">newarray</span><span class="op" id="1588601">(</span><span class="ident" id="1588602">typ</span>&nbsp;<span class="op" id="1588606">*</span><span class="ident" id="1588607">_type</span><span class="op" id="1588612">,</span>&nbsp;<span class="ident" id="1588614">n</span>&nbsp;<span class="builtintype" id="1588616">uintptr</span><span class="op" id="1588623">)</span>&nbsp;<span class="ident" id="1588625">unsafe</span><span class="op" id="1588631">.</span><span class="ident" id="1588632">Pointer</span>&nbsp;<span class="op" id="1588640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588643">flags</span>&nbsp;<span class="op" id="1588649">:=</span>&nbsp;<span class="builtintype" id="1588652">uint32</span><span class="op" id="1588658">(</span><span class="num" id="1588659">0</span><span class="op" id="1588660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588663">if</span>&nbsp;<span class="ident" id="1588666">typ</span><span class="op" id="1588669">.</span><span class="ident" id="1588670">kind</span><span class="op" id="1588674">&amp;</span><span class="ident" id="1588675">kindNoPointers</span>&nbsp;<span class="op" id="1588690">!=</span>&nbsp;<span class="num" id="1588693">0</span>&nbsp;<span class="op" id="1588695">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588699">flags</span>&nbsp;<span class="op" id="1588705">|=</span>&nbsp;<span class="ident" id="1588708">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588723">if</span>&nbsp;<span class="builtintype" id="1588726">int</span><span class="op" id="1588729">(</span><span class="ident" id="1588730">n</span><span class="op" id="1588731">)</span>&nbsp;<span class="op" id="1588733">&lt;</span>&nbsp;<span class="num" id="1588735">0</span>&nbsp;<span class="op" id="1588737">||</span>&nbsp;<span class="op" id="1588740">(</span><span class="ident" id="1588741">typ</span><span class="op" id="1588744">.</span><span class="ident" id="1588745">size</span>&nbsp;<span class="op" id="1588750">&gt;</span>&nbsp;<span class="num" id="1588752">0</span>&nbsp;<span class="op" id="1588754">&amp;&amp;</span>&nbsp;<span class="ident" id="1588757">n</span>&nbsp;<span class="op" id="1588759">&gt;</span>&nbsp;<span class="ident" id="1588761">maxmem</span><span class="op" id="1588767">/</span><span class="builtintype" id="1588768">uintptr</span><span class="op" id="1588775">(</span><span class="ident" id="1588776">typ</span><span class="op" id="1588779">.</span><span class="ident" id="1588780">size</span><span class="op" id="1588784">)</span><span class="op" id="1588785">)</span>&nbsp;<span class="op" id="1588787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1588791">panic</span><span class="op" id="1588796">(</span><span class="string" id="1588797">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1588836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588839">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588842">return</span>&nbsp;<span class="ident" id="1588849">mallocgc</span><span class="op" id="1588857">(</span><span class="builtintype" id="1588858">uintptr</span><span class="op" id="1588865">(</span><span class="ident" id="1588866">typ</span><span class="op" id="1588869">.</span><span class="ident" id="1588870">size</span><span class="op" id="1588874">)</span><span class="op" id="1588875">*</span><span class="ident" id="1588876">n</span><span class="op" id="1588877">,</span>&nbsp;<span class="ident" id="1588879">typ</span><span class="op" id="1588882">,</span>&nbsp;<span class="ident" id="1588884">flags</span><span class="op" id="1588889">)</span><br>
<span class="lineno"></span><span class="op" id="1588891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588894">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1588950">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1588965">func</span>&nbsp;<span class="ident" id="1588970">rawmem</span><span class="op" id="1588976">(</span><span class="ident" id="1588977">size</span>&nbsp;<span class="builtintype" id="1588982">uintptr</span><span class="op" id="1588989">)</span>&nbsp;<span class="ident" id="1588991">unsafe</span><span class="op" id="1588997">.</span><span class="ident" id="1588998">Pointer</span>&nbsp;<span class="op" id="1589006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589009">return</span>&nbsp;<span class="ident" id="1589016">mallocgc</span><span class="op" id="1589024">(</span><span class="ident" id="1589025">size</span><span class="op" id="1589029">,</span>&nbsp;<span class="ident" id="1589031">nil</span><span class="op" id="1589034">,</span>&nbsp;<span class="ident" id="1589036">flagNoScan</span><span class="op" id="1589046">|</span><span class="ident" id="1589047">flagNoZero</span><span class="op" id="1589057">)</span><br>
<span class="lineno"></span><span class="op" id="1589059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1589062">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1589098">func</span>&nbsp;<span class="ident" id="1589103">goroundupsize</span><span class="op" id="1589116">(</span><span class="ident" id="1589117">size</span>&nbsp;<span class="builtintype" id="1589122">uintptr</span><span class="op" id="1589129">)</span>&nbsp;<span class="builtintype" id="1589131">uintptr</span>&nbsp;<span class="op" id="1589139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589142">if</span>&nbsp;<span class="ident" id="1589145">size</span>&nbsp;<span class="op" id="1589150">&lt;</span>&nbsp;<span class="ident" id="1589152">maxSmallSize</span>&nbsp;<span class="op" id="1589165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589169">if</span>&nbsp;<span class="ident" id="1589172">size</span>&nbsp;<span class="op" id="1589177">&lt;=</span>&nbsp;<span class="num" id="1589180">1024</span><span class="op" id="1589184">-</span><span class="num" id="1589185">8</span>&nbsp;<span class="op" id="1589187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589192">return</span>&nbsp;<span class="builtintype" id="1589199">uintptr</span><span class="op" id="1589206">(</span><span class="ident" id="1589207">class_to_size</span><span class="op" id="1589220">[</span><span class="ident" id="1589221">size_to_class8</span><span class="op" id="1589235">[</span><span class="op" id="1589236">(</span><span class="ident" id="1589237">size</span><span class="op" id="1589241">+</span><span class="num" id="1589242">7</span><span class="op" id="1589243">)</span><span class="op" id="1589244">&gt;&gt;</span><span class="num" id="1589246">3</span><span class="op" id="1589247">]</span><span class="op" id="1589248">]</span><span class="op" id="1589249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589253">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589257">return</span>&nbsp;<span class="builtintype" id="1589264">uintptr</span><span class="op" id="1589271">(</span><span class="ident" id="1589272">class_to_size</span><span class="op" id="1589285">[</span><span class="ident" id="1589286">size_to_class128</span><span class="op" id="1589302">[</span><span class="op" id="1589303">(</span><span class="ident" id="1589304">size</span><span class="op" id="1589308">-</span><span class="num" id="1589309">1024</span><span class="op" id="1589313">+</span><span class="num" id="1589314">127</span><span class="op" id="1589317">)</span><span class="op" id="1589318">&gt;&gt;</span><span class="num" id="1589320">7</span><span class="op" id="1589321">]</span><span class="op" id="1589322">]</span><span class="op" id="1589323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589329">if</span>&nbsp;<span class="ident" id="1589332">size</span><span class="op" id="1589336">+</span><span class="ident" id="1589337">pageSize</span>&nbsp;<span class="op" id="1589346">&lt;</span>&nbsp;<span class="ident" id="1589348">size</span>&nbsp;<span class="op" id="1589353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589357">return</span>&nbsp;<span class="ident" id="1589364">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589370">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589373">return</span>&nbsp;<span class="op" id="1589380">(</span><span class="ident" id="1589381">size</span>&nbsp;<span class="op" id="1589386">+</span>&nbsp;<span class="ident" id="1589388">pageSize</span>&nbsp;<span class="op" id="1589397">-</span>&nbsp;<span class="num" id="1589399">1</span><span class="op" id="1589400">)</span>&nbsp;<span class="op" id="1589402">&amp;^</span>&nbsp;<span class="ident" id="1589405">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1589414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1589417">func</span>&nbsp;<span class="ident" id="1589422">profilealloc</span><span class="op" id="1589434">(</span><span class="ident" id="1589435">mp</span>&nbsp;<span class="op" id="1589438">*</span><span class="ident" id="1589439">m</span><span class="op" id="1589440">,</span>&nbsp;<span class="ident" id="1589442">x</span>&nbsp;<span class="ident" id="1589444">unsafe</span><span class="op" id="1589450">.</span><span class="ident" id="1589451">Pointer</span><span class="op" id="1589458">,</span>&nbsp;<span class="ident" id="1589460">size</span>&nbsp;<span class="builtintype" id="1589465">uintptr</span><span class="op" id="1589472">)</span>&nbsp;<span class="op" id="1589474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589477">c</span>&nbsp;<span class="op" id="1589479">:=</span>&nbsp;<span class="ident" id="1589482">mp</span><span class="op" id="1589484">.</span><span class="ident" id="1589485">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589493">rate</span>&nbsp;<span class="op" id="1589498">:=</span>&nbsp;<span class="ident" id="1589501">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589517">if</span>&nbsp;<span class="ident" id="1589520">size</span>&nbsp;<span class="op" id="1589525">&lt;</span>&nbsp;<span class="builtintype" id="1589527">uintptr</span><span class="op" id="1589534">(</span><span class="ident" id="1589535">rate</span><span class="op" id="1589539">)</span>&nbsp;<span class="op" id="1589541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589545">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589573">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589623">if</span>&nbsp;<span class="ident" id="1589626">rate</span>&nbsp;<span class="op" id="1589631">&gt;</span>&nbsp;<span class="num" id="1589633">0x3fffffff</span>&nbsp;<span class="op" id="1589644">{</span>&nbsp;<span class="comment" id="1589646">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589677">rate</span>&nbsp;<span class="op" id="1589682">=</span>&nbsp;<span class="num" id="1589684">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589701">next</span>&nbsp;<span class="op" id="1589706">:=</span>&nbsp;<span class="builtintype" id="1589709">int32</span><span class="op" id="1589714">(</span><span class="ident" id="1589715">fastrand1</span><span class="op" id="1589724">(</span><span class="op" id="1589725">)</span><span class="op" id="1589726">)</span>&nbsp;<span class="op" id="1589728">%</span>&nbsp;<span class="op" id="1589730">(</span><span class="num" id="1589731">2</span>&nbsp;<span class="op" id="1589733">*</span>&nbsp;<span class="builtintype" id="1589735">int32</span><span class="op" id="1589740">(</span><span class="ident" id="1589741">rate</span><span class="op" id="1589745">)</span><span class="op" id="1589746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589750">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589807">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1589870">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589946">next</span>&nbsp;<span class="op" id="1589951">-=</span>&nbsp;<span class="op" id="1589954">(</span><span class="builtintype" id="1589955">int32</span><span class="op" id="1589960">(</span><span class="ident" id="1589961">size</span><span class="op" id="1589965">)</span>&nbsp;<span class="op" id="1589967">-</span>&nbsp;<span class="ident" id="1589969">c</span><span class="op" id="1589970">.</span><span class="ident" id="1589971">next_sample</span><span class="op" id="1589982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589986">if</span>&nbsp;<span class="ident" id="1589989">next</span>&nbsp;<span class="op" id="1589994">&lt;</span>&nbsp;<span class="num" id="1589996">0</span>&nbsp;<span class="op" id="1589998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590003">next</span>&nbsp;<span class="op" id="1590008">=</span>&nbsp;<span class="num" id="1590010">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590014">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590018">c</span><span class="op" id="1590019">.</span><span class="ident" id="1590020">next_sample</span>&nbsp;<span class="op" id="1590032">=</span>&nbsp;<span class="ident" id="1590034">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590044">mProf_Malloc</span><span class="op" id="1590056">(</span><span class="ident" id="1590057">x</span><span class="op" id="1590058">,</span>&nbsp;<span class="ident" id="1590060">size</span><span class="op" id="1590064">)</span><br>
<span class="lineno"></span><span class="op" id="1590066">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1590069">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1590123">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1590160">func</span>&nbsp;<span class="ident" id="1590165">gogc</span><span class="op" id="1590169">(</span><span class="ident" id="1590170">force</span>&nbsp;<span class="builtintype" id="1590176">int32</span><span class="op" id="1590181">)</span>&nbsp;<span class="op" id="1590183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590186">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590261">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590341">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590413">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590489">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590517">mp</span>&nbsp;<span class="op" id="1590520">:=</span>&nbsp;<span class="ident" id="1590523">acquirem</span><span class="op" id="1590531">(</span><span class="op" id="1590532">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590535">if</span>&nbsp;<span class="ident" id="1590538">gp</span>&nbsp;<span class="op" id="1590541">:=</span>&nbsp;<span class="ident" id="1590544">getg</span><span class="op" id="1590548">(</span><span class="op" id="1590549">)</span><span class="op" id="1590550">;</span>&nbsp;<span class="ident" id="1590552">gp</span>&nbsp;<span class="op" id="1590555">==</span>&nbsp;<span class="ident" id="1590558">mp</span><span class="op" id="1590560">.</span><span class="ident" id="1590561">g0</span>&nbsp;<span class="op" id="1590564">||</span>&nbsp;<span class="ident" id="1590567">mp</span><span class="op" id="1590569">.</span><span class="ident" id="1590570">locks</span>&nbsp;<span class="op" id="1590576">&gt;</span>&nbsp;<span class="num" id="1590578">1</span>&nbsp;<span class="op" id="1590580">||</span>&nbsp;<span class="op" id="1590583">!</span><span class="ident" id="1590584">memstats</span><span class="op" id="1590592">.</span><span class="ident" id="1590593">enablegc</span>&nbsp;<span class="op" id="1590602">||</span>&nbsp;<span class="ident" id="1590605">panicking</span>&nbsp;<span class="op" id="1590615">!=</span>&nbsp;<span class="num" id="1590618">0</span>&nbsp;<span class="op" id="1590620">||</span>&nbsp;<span class="ident" id="1590623">gcpercent</span>&nbsp;<span class="op" id="1590633">&lt;</span>&nbsp;<span class="num" id="1590635">0</span>&nbsp;<span class="op" id="1590637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590641">releasem</span><span class="op" id="1590649">(</span><span class="ident" id="1590650">mp</span><span class="op" id="1590652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590656">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590667">releasem</span><span class="op" id="1590675">(</span><span class="ident" id="1590676">mp</span><span class="op" id="1590678">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590681">mp</span>&nbsp;<span class="op" id="1590684">=</span>&nbsp;<span class="ident" id="1590686">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590692">semacquire</span><span class="op" id="1590702">(</span><span class="op" id="1590703">&amp;</span><span class="ident" id="1590704">worldsema</span><span class="op" id="1590713">,</span>&nbsp;<span class="builtintype" id="1590715">false</span><span class="op" id="1590720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590724">if</span>&nbsp;<span class="ident" id="1590727">force</span>&nbsp;<span class="op" id="1590733">==</span>&nbsp;<span class="num" id="1590736">0</span>&nbsp;<span class="op" id="1590738">&amp;&amp;</span>&nbsp;<span class="ident" id="1590741">memstats</span><span class="op" id="1590749">.</span><span class="ident" id="1590750">heap_alloc</span>&nbsp;<span class="op" id="1590761">&lt;</span>&nbsp;<span class="ident" id="1590763">memstats</span><span class="op" id="1590771">.</span><span class="ident" id="1590772">next_gc</span>&nbsp;<span class="op" id="1590780">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590784">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590835">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590877">semrelease</span><span class="op" id="1590887">(</span><span class="op" id="1590888">&amp;</span><span class="ident" id="1590889">worldsema</span><span class="op" id="1590898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590902">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590910">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1590914">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590959">startTime</span>&nbsp;<span class="op" id="1590969">:=</span>&nbsp;<span class="ident" id="1590972">nanotime</span><span class="op" id="1590980">(</span><span class="op" id="1590981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590984">mp</span>&nbsp;<span class="op" id="1590987">=</span>&nbsp;<span class="ident" id="1590989">acquirem</span><span class="op" id="1590997">(</span><span class="op" id="1590998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591001">mp</span><span class="op" id="1591003">.</span><span class="ident" id="1591004">gcing</span>&nbsp;<span class="op" id="1591010">=</span>&nbsp;<span class="num" id="1591012">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591015">releasem</span><span class="op" id="1591023">(</span><span class="ident" id="1591024">mp</span><span class="op" id="1591026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591029">onM</span><span class="op" id="1591032">(</span><span class="ident" id="1591033">stoptheworld</span><span class="op" id="1591045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591048">if</span>&nbsp;<span class="ident" id="1591051">mp</span>&nbsp;<span class="op" id="1591054">!=</span>&nbsp;<span class="ident" id="1591057">acquirem</span><span class="op" id="1591065">(</span><span class="op" id="1591066">)</span>&nbsp;<span class="op" id="1591068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591072">gothrow</span><span class="op" id="1591079">(</span><span class="string" id="1591080">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1591099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591102">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591106">clearpools</span><span class="op" id="1591116">(</span><span class="op" id="1591117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591121">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591181">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591241">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591301">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591358">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591411">n</span>&nbsp;<span class="op" id="1591413">:=</span>&nbsp;<span class="num" id="1591416">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591419">if</span>&nbsp;<span class="ident" id="1591422">debug</span><span class="op" id="1591427">.</span><span class="ident" id="1591428">gctrace</span>&nbsp;<span class="op" id="1591436">&gt;</span>&nbsp;<span class="num" id="1591438">1</span>&nbsp;<span class="op" id="1591440">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591444">n</span>&nbsp;<span class="op" id="1591446">=</span>&nbsp;<span class="num" id="1591448">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591454">for</span>&nbsp;<span class="ident" id="1591458">i</span>&nbsp;<span class="op" id="1591460">:=</span>&nbsp;<span class="num" id="1591463">0</span><span class="op" id="1591464">;</span>&nbsp;<span class="ident" id="1591466">i</span>&nbsp;<span class="op" id="1591468">&lt;</span>&nbsp;<span class="ident" id="1591470">n</span><span class="op" id="1591471">;</span>&nbsp;<span class="ident" id="1591473">i</span><span class="op" id="1591474">++</span>&nbsp;<span class="op" id="1591477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591481">if</span>&nbsp;<span class="ident" id="1591484">i</span>&nbsp;<span class="op" id="1591486">&gt;</span>&nbsp;<span class="num" id="1591488">0</span>&nbsp;<span class="op" id="1591490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591495">startTime</span>&nbsp;<span class="op" id="1591505">=</span>&nbsp;<span class="ident" id="1591507">nanotime</span><span class="op" id="1591515">(</span><span class="op" id="1591516">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591524">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591569">mp</span><span class="op" id="1591571">.</span><span class="ident" id="1591572">scalararg</span><span class="op" id="1591581">[</span><span class="num" id="1591582">0</span><span class="op" id="1591583">]</span>&nbsp;<span class="op" id="1591585">=</span>&nbsp;<span class="builtintype" id="1591587">uintptr</span><span class="op" id="1591594">(</span><span class="builtintype" id="1591595">uint32</span><span class="op" id="1591601">(</span><span class="ident" id="1591602">startTime</span><span class="op" id="1591611">)</span><span class="op" id="1591612">)</span>&nbsp;<span class="comment" id="1591614">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591631">mp</span><span class="op" id="1591633">.</span><span class="ident" id="1591634">scalararg</span><span class="op" id="1591643">[</span><span class="num" id="1591644">1</span><span class="op" id="1591645">]</span>&nbsp;<span class="op" id="1591647">=</span>&nbsp;<span class="builtintype" id="1591649">uintptr</span><span class="op" id="1591656">(</span><span class="ident" id="1591657">startTime</span>&nbsp;<span class="op" id="1591667">&gt;&gt;</span>&nbsp;<span class="num" id="1591670">32</span><span class="op" id="1591672">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1591676">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591694">if</span>&nbsp;<span class="ident" id="1591697">force</span>&nbsp;<span class="op" id="1591703">&gt;=</span>&nbsp;<span class="num" id="1591706">2</span>&nbsp;<span class="op" id="1591708">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591713">mp</span><span class="op" id="1591715">.</span><span class="ident" id="1591716">scalararg</span><span class="op" id="1591725">[</span><span class="num" id="1591726">2</span><span class="op" id="1591727">]</span>&nbsp;<span class="op" id="1591729">=</span>&nbsp;<span class="num" id="1591731">1</span>&nbsp;<span class="comment" id="1591733">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591749">}</span>&nbsp;<span class="keyword" id="1591751">else</span>&nbsp;<span class="op" id="1591756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591761">mp</span><span class="op" id="1591763">.</span><span class="ident" id="1591764">scalararg</span><span class="op" id="1591773">[</span><span class="num" id="1591774">2</span><span class="op" id="1591775">]</span>&nbsp;<span class="op" id="1591777">=</span>&nbsp;<span class="num" id="1591779">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591787">onM</span><span class="op" id="1591790">(</span><span class="ident" id="1591791">gc_m</span><span class="op" id="1591795">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591802">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591815">mp</span><span class="op" id="1591817">.</span><span class="ident" id="1591818">gcing</span>&nbsp;<span class="op" id="1591824">=</span>&nbsp;<span class="num" id="1591826">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591829">semrelease</span><span class="op" id="1591839">(</span><span class="op" id="1591840">&amp;</span><span class="ident" id="1591841">worldsema</span><span class="op" id="1591850">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591853">onM</span><span class="op" id="1591856">(</span><span class="ident" id="1591857">starttheworld</span><span class="op" id="1591870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591873">releasem</span><span class="op" id="1591881">(</span><span class="ident" id="1591882">mp</span><span class="op" id="1591884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591887">mp</span>&nbsp;<span class="op" id="1591890">=</span>&nbsp;<span class="ident" id="1591892">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591898">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591959">if</span>&nbsp;<span class="op" id="1591962">!</span><span class="ident" id="1591963">concurrentSweep</span>&nbsp;<span class="op" id="1591979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1591983">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592040">Gosched</span><span class="op" id="1592047">(</span><span class="op" id="1592048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592051">}</span><br>
<span class="lineno"></span><span class="op" id="1592053">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1592056">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1592089">func</span>&nbsp;<span class="ident" id="1592094">GC</span><span class="op" id="1592096">(</span><span class="op" id="1592097">)</span>&nbsp;<span class="op" id="1592099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592102">gogc</span><span class="op" id="1592106">(</span><span class="num" id="1592107">2</span><span class="op" id="1592108">)</span><br>
<span class="lineno"></span><span class="op" id="1592110">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1592113">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1592132">var</span>&nbsp;<span class="ident" id="1592136">noptrdata</span>&nbsp;<span class="keyword" id="1592146">struct</span><span class="op" id="1592152">{</span><span class="op" id="1592153">}</span><br>
<span class="lineno"></span><span class="keyword" id="1592155">var</span>&nbsp;<span class="ident" id="1592159">enoptrdata</span>&nbsp;<span class="keyword" id="1592170">struct</span><span class="op" id="1592176">{</span><span class="op" id="1592177">}</span><br>
<span class="lineno"></span><span class="keyword" id="1592179">var</span>&nbsp;<span class="ident" id="1592183">noptrbss</span>&nbsp;<span class="keyword" id="1592192">struct</span><span class="op" id="1592198">{</span><span class="op" id="1592199">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1592201">var</span>&nbsp;<span class="ident" id="1592205">enoptrbss</span>&nbsp;<span class="keyword" id="1592215">struct</span><span class="op" id="1592221">{</span><span class="op" id="1592222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1592225">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1592284">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1592341">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1592409">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1592477">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1592545">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1592610">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1592652">//</span><br>
<span class="lineno">505</span><span class="comment" id="1592655">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1592719">//</span><br>
<span class="lineno"></span><span class="comment" id="1592722">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1592784">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1592848">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1592914">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1592990">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1593057">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1593069">//</span><br>
<span class="lineno"></span><span class="comment" id="1593072">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1593143">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1593213">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1593274">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1593339">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1593408">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1593471">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1593501">//</span><br>
<span class="lineno"></span><span class="comment" id="1593504">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1593576">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1593602">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1593676">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1593748">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1593808">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1593877">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1593948">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1594011">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1594082">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1594156">//</span><br>
<span class="lineno"></span><span class="comment" id="1594159">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1594230">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1594245">//</span><br>
<span class="lineno"></span><span class="comment" id="1594248">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1594320">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1594388">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1594429">//</span><br>
<span class="lineno">540</span><span class="comment" id="1594432">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1594503">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1594575">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1594595">func</span>&nbsp;<span class="ident" id="1594600">SetFinalizer</span><span class="op" id="1594612">(</span><span class="ident" id="1594613">obj</span>&nbsp;<span class="keyword" id="1594617">interface</span><span class="op" id="1594626">{</span><span class="op" id="1594627">}</span><span class="op" id="1594628">,</span>&nbsp;<span class="ident" id="1594630">finalizer</span>&nbsp;<span class="keyword" id="1594640">interface</span><span class="op" id="1594649">{</span><span class="op" id="1594650">}</span><span class="op" id="1594651">)</span>&nbsp;<span class="op" id="1594653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594656">e</span>&nbsp;<span class="op" id="1594658">:=</span>&nbsp;<span class="op" id="1594661">(</span><span class="op" id="1594662">*</span><span class="ident" id="1594663">eface</span><span class="op" id="1594668">)</span><span class="op" id="1594669">(</span><span class="ident" id="1594670">unsafe</span><span class="op" id="1594676">.</span><span class="ident" id="1594677">Pointer</span><span class="op" id="1594684">(</span><span class="op" id="1594685">&amp;</span><span class="ident" id="1594686">obj</span><span class="op" id="1594689">)</span><span class="op" id="1594690">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594693">etyp</span>&nbsp;<span class="op" id="1594698">:=</span>&nbsp;<span class="ident" id="1594701">e</span><span class="op" id="1594702">.</span><span class="ident" id="1594703">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594710">if</span>&nbsp;<span class="ident" id="1594713">etyp</span>&nbsp;<span class="op" id="1594718">==</span>&nbsp;<span class="ident" id="1594721">nil</span>&nbsp;<span class="op" id="1594725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594729">gothrow</span><span class="op" id="1594736">(</span><span class="string" id="1594737">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1594782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594788">if</span>&nbsp;<span class="ident" id="1594791">etyp</span><span class="op" id="1594795">.</span><span class="ident" id="1594796">kind</span><span class="op" id="1594800">&amp;</span><span class="ident" id="1594801">kindMask</span>&nbsp;<span class="op" id="1594810">!=</span>&nbsp;<span class="ident" id="1594813">kindPtr</span>&nbsp;<span class="op" id="1594821">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594825">gothrow</span><span class="op" id="1594832">(</span><span class="string" id="1594833">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1594876">+</span>&nbsp;<span class="op" id="1594878">*</span><span class="ident" id="1594879">etyp</span><span class="op" id="1594883">.</span><span class="ident" id="1594884">_string</span>&nbsp;<span class="op" id="1594892">+</span>&nbsp;<span class="string" id="1594894">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1594909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1594912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594915">ot</span>&nbsp;<span class="op" id="1594918">:=</span>&nbsp;<span class="op" id="1594921">(</span><span class="op" id="1594922">*</span><span class="ident" id="1594923">ptrtype</span><span class="op" id="1594930">)</span><span class="op" id="1594931">(</span><span class="ident" id="1594932">unsafe</span><span class="op" id="1594938">.</span><span class="ident" id="1594939">Pointer</span><span class="op" id="1594946">(</span><span class="ident" id="1594947">etyp</span><span class="op" id="1594951">)</span><span class="op" id="1594952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1594955">if</span>&nbsp;<span class="ident" id="1594958">ot</span><span class="op" id="1594960">.</span><span class="ident" id="1594961">elem</span>&nbsp;<span class="op" id="1594966">==</span>&nbsp;<span class="ident" id="1594969">nil</span>&nbsp;<span class="op" id="1594973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594977">gothrow</span><span class="op" id="1594984">(</span><span class="string" id="1594985">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1595001">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595008">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595039">_</span><span class="op" id="1595040">,</span>&nbsp;<span class="ident" id="1595042">base</span><span class="op" id="1595046">,</span>&nbsp;<span class="ident" id="1595048">_</span>&nbsp;<span class="op" id="1595050">:=</span>&nbsp;<span class="ident" id="1595053">findObject</span><span class="op" id="1595063">(</span><span class="ident" id="1595064">e</span><span class="op" id="1595065">.</span><span class="ident" id="1595066">data</span><span class="op" id="1595070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595074">if</span>&nbsp;<span class="ident" id="1595077">base</span>&nbsp;<span class="op" id="1595082">==</span>&nbsp;<span class="ident" id="1595085">nil</span>&nbsp;<span class="op" id="1595089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595093">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595125">if</span>&nbsp;<span class="ident" id="1595128">e</span><span class="op" id="1595129">.</span><span class="ident" id="1595130">data</span>&nbsp;<span class="op" id="1595135">==</span>&nbsp;<span class="ident" id="1595138">unsafe</span><span class="op" id="1595144">.</span><span class="ident" id="1595145">Pointer</span><span class="op" id="1595152">(</span><span class="op" id="1595153">&amp;</span><span class="ident" id="1595154">zerobase</span><span class="op" id="1595162">)</span>&nbsp;<span class="op" id="1595164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595169">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595178">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595183">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595235">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595260">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595279">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595316">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595323">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595387">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595451">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595481">if</span>&nbsp;<span class="builtintype" id="1595484">uintptr</span><span class="op" id="1595491">(</span><span class="ident" id="1595492">unsafe</span><span class="op" id="1595498">.</span><span class="ident" id="1595499">Pointer</span><span class="op" id="1595506">(</span><span class="op" id="1595507">&amp;</span><span class="ident" id="1595508">noptrdata</span><span class="op" id="1595517">)</span><span class="op" id="1595518">)</span>&nbsp;<span class="op" id="1595520">&lt;=</span>&nbsp;<span class="builtintype" id="1595523">uintptr</span><span class="op" id="1595530">(</span><span class="ident" id="1595531">e</span><span class="op" id="1595532">.</span><span class="ident" id="1595533">data</span><span class="op" id="1595537">)</span>&nbsp;<span class="op" id="1595539">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1595542">uintptr</span><span class="op" id="1595549">(</span><span class="ident" id="1595550">e</span><span class="op" id="1595551">.</span><span class="ident" id="1595552">data</span><span class="op" id="1595556">)</span>&nbsp;<span class="op" id="1595558">&lt;</span>&nbsp;<span class="builtintype" id="1595560">uintptr</span><span class="op" id="1595567">(</span><span class="ident" id="1595568">unsafe</span><span class="op" id="1595574">.</span><span class="ident" id="1595575">Pointer</span><span class="op" id="1595582">(</span><span class="op" id="1595583">&amp;</span><span class="ident" id="1595584">enoptrdata</span><span class="op" id="1595594">)</span><span class="op" id="1595595">)</span>&nbsp;<span class="op" id="1595597">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1595603">uintptr</span><span class="op" id="1595610">(</span><span class="ident" id="1595611">unsafe</span><span class="op" id="1595617">.</span><span class="ident" id="1595618">Pointer</span><span class="op" id="1595625">(</span><span class="op" id="1595626">&amp;</span><span class="ident" id="1595627">data</span><span class="op" id="1595631">)</span><span class="op" id="1595632">)</span>&nbsp;<span class="op" id="1595634">&lt;=</span>&nbsp;<span class="builtintype" id="1595637">uintptr</span><span class="op" id="1595644">(</span><span class="ident" id="1595645">e</span><span class="op" id="1595646">.</span><span class="ident" id="1595647">data</span><span class="op" id="1595651">)</span>&nbsp;<span class="op" id="1595653">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1595656">uintptr</span><span class="op" id="1595663">(</span><span class="ident" id="1595664">e</span><span class="op" id="1595665">.</span><span class="ident" id="1595666">data</span><span class="op" id="1595670">)</span>&nbsp;<span class="op" id="1595672">&lt;</span>&nbsp;<span class="builtintype" id="1595674">uintptr</span><span class="op" id="1595681">(</span><span class="ident" id="1595682">unsafe</span><span class="op" id="1595688">.</span><span class="ident" id="1595689">Pointer</span><span class="op" id="1595696">(</span><span class="op" id="1595697">&amp;</span><span class="ident" id="1595698">edata</span><span class="op" id="1595703">)</span><span class="op" id="1595704">)</span>&nbsp;<span class="op" id="1595706">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1595712">uintptr</span><span class="op" id="1595719">(</span><span class="ident" id="1595720">unsafe</span><span class="op" id="1595726">.</span><span class="ident" id="1595727">Pointer</span><span class="op" id="1595734">(</span><span class="op" id="1595735">&amp;</span><span class="ident" id="1595736">bss</span><span class="op" id="1595739">)</span><span class="op" id="1595740">)</span>&nbsp;<span class="op" id="1595742">&lt;=</span>&nbsp;<span class="builtintype" id="1595745">uintptr</span><span class="op" id="1595752">(</span><span class="ident" id="1595753">e</span><span class="op" id="1595754">.</span><span class="ident" id="1595755">data</span><span class="op" id="1595759">)</span>&nbsp;<span class="op" id="1595761">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1595764">uintptr</span><span class="op" id="1595771">(</span><span class="ident" id="1595772">e</span><span class="op" id="1595773">.</span><span class="ident" id="1595774">data</span><span class="op" id="1595778">)</span>&nbsp;<span class="op" id="1595780">&lt;</span>&nbsp;<span class="builtintype" id="1595782">uintptr</span><span class="op" id="1595789">(</span><span class="ident" id="1595790">unsafe</span><span class="op" id="1595796">.</span><span class="ident" id="1595797">Pointer</span><span class="op" id="1595804">(</span><span class="op" id="1595805">&amp;</span><span class="ident" id="1595806">ebss</span><span class="op" id="1595810">)</span><span class="op" id="1595811">)</span>&nbsp;<span class="op" id="1595813">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1595819">uintptr</span><span class="op" id="1595826">(</span><span class="ident" id="1595827">unsafe</span><span class="op" id="1595833">.</span><span class="ident" id="1595834">Pointer</span><span class="op" id="1595841">(</span><span class="op" id="1595842">&amp;</span><span class="ident" id="1595843">noptrbss</span><span class="op" id="1595851">)</span><span class="op" id="1595852">)</span>&nbsp;<span class="op" id="1595854">&lt;=</span>&nbsp;<span class="builtintype" id="1595857">uintptr</span><span class="op" id="1595864">(</span><span class="ident" id="1595865">e</span><span class="op" id="1595866">.</span><span class="ident" id="1595867">data</span><span class="op" id="1595871">)</span>&nbsp;<span class="op" id="1595873">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1595876">uintptr</span><span class="op" id="1595883">(</span><span class="ident" id="1595884">e</span><span class="op" id="1595885">.</span><span class="ident" id="1595886">data</span><span class="op" id="1595890">)</span>&nbsp;<span class="op" id="1595892">&lt;</span>&nbsp;<span class="builtintype" id="1595894">uintptr</span><span class="op" id="1595901">(</span><span class="ident" id="1595902">unsafe</span><span class="op" id="1595908">.</span><span class="ident" id="1595909">Pointer</span><span class="op" id="1595916">(</span><span class="op" id="1595917">&amp;</span><span class="ident" id="1595918">enoptrbss</span><span class="op" id="1595927">)</span><span class="op" id="1595928">)</span>&nbsp;<span class="op" id="1595930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1595935">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1595944">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595948">gothrow</span><span class="op" id="1595955">(</span><span class="string" id="1595956">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1596010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596017">if</span>&nbsp;<span class="ident" id="1596020">e</span><span class="op" id="1596021">.</span><span class="ident" id="1596022">data</span>&nbsp;<span class="op" id="1596027">!=</span>&nbsp;<span class="ident" id="1596030">base</span>&nbsp;<span class="op" id="1596035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596039">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596117">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596196">if</span>&nbsp;<span class="ident" id="1596199">ot</span><span class="op" id="1596201">.</span><span class="ident" id="1596202">elem</span>&nbsp;<span class="op" id="1596207">==</span>&nbsp;<span class="ident" id="1596210">nil</span>&nbsp;<span class="op" id="1596214">||</span>&nbsp;<span class="ident" id="1596217">ot</span><span class="op" id="1596219">.</span><span class="ident" id="1596220">elem</span><span class="op" id="1596224">.</span><span class="ident" id="1596225">kind</span><span class="op" id="1596229">&amp;</span><span class="ident" id="1596230">kindNoPointers</span>&nbsp;<span class="op" id="1596245">==</span>&nbsp;<span class="num" id="1596248">0</span>&nbsp;<span class="op" id="1596250">||</span>&nbsp;<span class="ident" id="1596253">ot</span><span class="op" id="1596255">.</span><span class="ident" id="1596256">elem</span><span class="op" id="1596260">.</span><span class="ident" id="1596261">size</span>&nbsp;<span class="op" id="1596266">&gt;=</span>&nbsp;<span class="ident" id="1596269">maxTinySize</span>&nbsp;<span class="op" id="1596281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596286">gothrow</span><span class="op" id="1596293">(</span><span class="string" id="1596294">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1596361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596368">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596372">f</span>&nbsp;<span class="op" id="1596374">:=</span>&nbsp;<span class="op" id="1596377">(</span><span class="op" id="1596378">*</span><span class="ident" id="1596379">eface</span><span class="op" id="1596384">)</span><span class="op" id="1596385">(</span><span class="ident" id="1596386">unsafe</span><span class="op" id="1596392">.</span><span class="ident" id="1596393">Pointer</span><span class="op" id="1596400">(</span><span class="op" id="1596401">&amp;</span><span class="ident" id="1596402">finalizer</span><span class="op" id="1596411">)</span><span class="op" id="1596412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596415">ftyp</span>&nbsp;<span class="op" id="1596420">:=</span>&nbsp;<span class="ident" id="1596423">f</span><span class="op" id="1596424">.</span><span class="ident" id="1596425">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596432">if</span>&nbsp;<span class="ident" id="1596435">ftyp</span>&nbsp;<span class="op" id="1596440">==</span>&nbsp;<span class="ident" id="1596443">nil</span>&nbsp;<span class="op" id="1596447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596451">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596495">mp</span>&nbsp;<span class="op" id="1596498">:=</span>&nbsp;<span class="ident" id="1596501">acquirem</span><span class="op" id="1596509">(</span><span class="op" id="1596510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596514">mp</span><span class="op" id="1596516">.</span><span class="ident" id="1596517">ptrarg</span><span class="op" id="1596523">[</span><span class="num" id="1596524">0</span><span class="op" id="1596525">]</span>&nbsp;<span class="op" id="1596527">=</span>&nbsp;<span class="ident" id="1596529">e</span><span class="op" id="1596530">.</span><span class="ident" id="1596531">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596538">onM</span><span class="op" id="1596541">(</span><span class="ident" id="1596542">removeFinalizer_m</span><span class="op" id="1596559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596563">releasem</span><span class="op" id="1596571">(</span><span class="ident" id="1596572">mp</span><span class="op" id="1596574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596578">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596590">if</span>&nbsp;<span class="ident" id="1596593">ftyp</span><span class="op" id="1596597">.</span><span class="ident" id="1596598">kind</span><span class="op" id="1596602">&amp;</span><span class="ident" id="1596603">kindMask</span>&nbsp;<span class="op" id="1596612">!=</span>&nbsp;<span class="ident" id="1596615">kindFunc</span>&nbsp;<span class="op" id="1596624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596628">gothrow</span><span class="op" id="1596635">(</span><span class="string" id="1596636">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1596680">+</span>&nbsp;<span class="op" id="1596682">*</span><span class="ident" id="1596683">ftyp</span><span class="op" id="1596687">.</span><span class="ident" id="1596688">_string</span>&nbsp;<span class="op" id="1596696">+</span>&nbsp;<span class="string" id="1596698">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1596716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596719">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596722">ft</span>&nbsp;<span class="op" id="1596725">:=</span>&nbsp;<span class="op" id="1596728">(</span><span class="op" id="1596729">*</span><span class="ident" id="1596730">functype</span><span class="op" id="1596738">)</span><span class="op" id="1596739">(</span><span class="ident" id="1596740">unsafe</span><span class="op" id="1596746">.</span><span class="ident" id="1596747">Pointer</span><span class="op" id="1596754">(</span><span class="ident" id="1596755">ftyp</span><span class="op" id="1596759">)</span><span class="op" id="1596760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596763">ins</span>&nbsp;<span class="op" id="1596767">:=</span>&nbsp;<span class="op" id="1596770">*</span><span class="op" id="1596771">(</span><span class="op" id="1596772">*</span><span class="op" id="1596773">[</span><span class="op" id="1596774">]</span><span class="op" id="1596775">*</span><span class="ident" id="1596776">_type</span><span class="op" id="1596781">)</span><span class="op" id="1596782">(</span><span class="ident" id="1596783">unsafe</span><span class="op" id="1596789">.</span><span class="ident" id="1596790">Pointer</span><span class="op" id="1596797">(</span><span class="op" id="1596798">&amp;</span><span class="ident" id="1596799">ft</span><span class="op" id="1596801">.</span><span class="ident" id="1596802">in</span><span class="op" id="1596804">)</span><span class="op" id="1596805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596808">if</span>&nbsp;<span class="ident" id="1596811">ft</span><span class="op" id="1596813">.</span><span class="ident" id="1596814">dotdotdot</span>&nbsp;<span class="op" id="1596824">||</span>&nbsp;<span class="builtinfunc" id="1596827">len</span><span class="op" id="1596830">(</span><span class="ident" id="1596831">ins</span><span class="op" id="1596834">)</span>&nbsp;<span class="op" id="1596836">!=</span>&nbsp;<span class="num" id="1596839">1</span>&nbsp;<span class="op" id="1596841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596845">gothrow</span><span class="op" id="1596852">(</span><span class="string" id="1596853">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1596890">+</span>&nbsp;<span class="op" id="1596892">*</span><span class="ident" id="1596893">etyp</span><span class="op" id="1596897">.</span><span class="ident" id="1596898">_string</span>&nbsp;<span class="op" id="1596906">+</span>&nbsp;<span class="string" id="1596908">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1596925">+</span>&nbsp;<span class="op" id="1596927">*</span><span class="ident" id="1596928">ftyp</span><span class="op" id="1596932">.</span><span class="ident" id="1596933">_string</span><span class="op" id="1596940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596943">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596946">fint</span>&nbsp;<span class="op" id="1596951">:=</span>&nbsp;<span class="ident" id="1596954">ins</span><span class="op" id="1596957">[</span><span class="num" id="1596958">0</span><span class="op" id="1596959">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596962">switch</span>&nbsp;<span class="op" id="1596969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596972">case</span>&nbsp;<span class="ident" id="1596977">fint</span>&nbsp;<span class="op" id="1596982">==</span>&nbsp;<span class="ident" id="1596985">etyp</span><span class="op" id="1596989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596993">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597013">goto</span>&nbsp;<span class="ident" id="1597018">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597025">case</span>&nbsp;<span class="ident" id="1597030">fint</span><span class="op" id="1597034">.</span><span class="ident" id="1597035">kind</span><span class="op" id="1597039">&amp;</span><span class="ident" id="1597040">kindMask</span>&nbsp;<span class="op" id="1597049">==</span>&nbsp;<span class="ident" id="1597052">kindPtr</span><span class="op" id="1597059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597063">if</span>&nbsp;<span class="op" id="1597066">(</span><span class="ident" id="1597067">fint</span><span class="op" id="1597071">.</span><span class="ident" id="1597072">x</span>&nbsp;<span class="op" id="1597074">==</span>&nbsp;<span class="ident" id="1597077">nil</span>&nbsp;<span class="op" id="1597081">||</span>&nbsp;<span class="ident" id="1597084">fint</span><span class="op" id="1597088">.</span><span class="ident" id="1597089">x</span><span class="op" id="1597090">.</span><span class="ident" id="1597091">name</span>&nbsp;<span class="op" id="1597096">==</span>&nbsp;<span class="ident" id="1597099">nil</span>&nbsp;<span class="op" id="1597103">||</span>&nbsp;<span class="ident" id="1597106">etyp</span><span class="op" id="1597110">.</span><span class="ident" id="1597111">x</span>&nbsp;<span class="op" id="1597113">==</span>&nbsp;<span class="ident" id="1597116">nil</span>&nbsp;<span class="op" id="1597120">||</span>&nbsp;<span class="ident" id="1597123">etyp</span><span class="op" id="1597127">.</span><span class="ident" id="1597128">x</span><span class="op" id="1597129">.</span><span class="ident" id="1597130">name</span>&nbsp;<span class="op" id="1597135">==</span>&nbsp;<span class="ident" id="1597138">nil</span><span class="op" id="1597141">)</span>&nbsp;<span class="op" id="1597143">&amp;&amp;</span>&nbsp;<span class="op" id="1597146">(</span><span class="op" id="1597147">*</span><span class="ident" id="1597148">ptrtype</span><span class="op" id="1597155">)</span><span class="op" id="1597156">(</span><span class="ident" id="1597157">unsafe</span><span class="op" id="1597163">.</span><span class="ident" id="1597164">Pointer</span><span class="op" id="1597171">(</span><span class="ident" id="1597172">fint</span><span class="op" id="1597176">)</span><span class="op" id="1597177">)</span><span class="op" id="1597178">.</span><span class="ident" id="1597179">elem</span>&nbsp;<span class="op" id="1597184">==</span>&nbsp;<span class="ident" id="1597187">ot</span><span class="op" id="1597189">.</span><span class="ident" id="1597190">elem</span>&nbsp;<span class="op" id="1597195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597200">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597245">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597318">goto</span>&nbsp;<span class="ident" id="1597323">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597334">case</span>&nbsp;<span class="ident" id="1597339">fint</span><span class="op" id="1597343">.</span><span class="ident" id="1597344">kind</span><span class="op" id="1597348">&amp;</span><span class="ident" id="1597349">kindMask</span>&nbsp;<span class="op" id="1597358">==</span>&nbsp;<span class="ident" id="1597361">kindInterface</span><span class="op" id="1597374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597378">ityp</span>&nbsp;<span class="op" id="1597383">:=</span>&nbsp;<span class="op" id="1597386">(</span><span class="op" id="1597387">*</span><span class="ident" id="1597388">interfacetype</span><span class="op" id="1597401">)</span><span class="op" id="1597402">(</span><span class="ident" id="1597403">unsafe</span><span class="op" id="1597409">.</span><span class="ident" id="1597410">Pointer</span><span class="op" id="1597417">(</span><span class="ident" id="1597418">fint</span><span class="op" id="1597422">)</span><span class="op" id="1597423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597427">if</span>&nbsp;<span class="builtinfunc" id="1597430">len</span><span class="op" id="1597433">(</span><span class="ident" id="1597434">ityp</span><span class="op" id="1597438">.</span><span class="ident" id="1597439">mhdr</span><span class="op" id="1597443">)</span>&nbsp;<span class="op" id="1597445">==</span>&nbsp;<span class="num" id="1597448">0</span>&nbsp;<span class="op" id="1597450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597455">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597492">goto</span>&nbsp;<span class="ident" id="1597497">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597509">if</span>&nbsp;<span class="ident" id="1597512">_</span><span class="op" id="1597513">,</span>&nbsp;<span class="ident" id="1597515">ok</span>&nbsp;<span class="op" id="1597518">:=</span>&nbsp;<span class="ident" id="1597521">assertE2I2</span><span class="op" id="1597531">(</span><span class="ident" id="1597532">ityp</span><span class="op" id="1597536">,</span>&nbsp;<span class="ident" id="1597538">obj</span><span class="op" id="1597541">)</span><span class="op" id="1597542">;</span>&nbsp;<span class="ident" id="1597544">ok</span>&nbsp;<span class="op" id="1597547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597552">goto</span>&nbsp;<span class="ident" id="1597557">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597565">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597571">gothrow</span><span class="op" id="1597578">(</span><span class="string" id="1597579">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1597616">+</span>&nbsp;<span class="op" id="1597618">*</span><span class="ident" id="1597619">etyp</span><span class="op" id="1597623">.</span><span class="ident" id="1597624">_string</span>&nbsp;<span class="op" id="1597632">+</span>&nbsp;<span class="string" id="1597634">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1597651">+</span>&nbsp;<span class="op" id="1597653">*</span><span class="ident" id="1597654">ftyp</span><span class="op" id="1597658">.</span><span class="ident" id="1597659">_string</span><span class="op" id="1597666">)</span><br>
<span class="lineno"></span><span class="ident" id="1597668">okarg</span><span class="op" id="1597673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597676">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597722">nret</span>&nbsp;<span class="op" id="1597727">:=</span>&nbsp;<span class="builtintype" id="1597730">uintptr</span><span class="op" id="1597737">(</span><span class="num" id="1597738">0</span><span class="op" id="1597739">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597742">for</span>&nbsp;<span class="ident" id="1597746">_</span><span class="op" id="1597747">,</span>&nbsp;<span class="ident" id="1597749">t</span>&nbsp;<span class="op" id="1597751">:=</span>&nbsp;<span class="keyword" id="1597754">range</span>&nbsp;<span class="op" id="1597760">*</span><span class="op" id="1597761">(</span><span class="op" id="1597762">*</span><span class="op" id="1597763">[</span><span class="op" id="1597764">]</span><span class="op" id="1597765">*</span><span class="ident" id="1597766">_type</span><span class="op" id="1597771">)</span><span class="op" id="1597772">(</span><span class="ident" id="1597773">unsafe</span><span class="op" id="1597779">.</span><span class="ident" id="1597780">Pointer</span><span class="op" id="1597787">(</span><span class="op" id="1597788">&amp;</span><span class="ident" id="1597789">ft</span><span class="op" id="1597791">.</span><span class="ident" id="1597792">out</span><span class="op" id="1597795">)</span><span class="op" id="1597796">)</span>&nbsp;<span class="op" id="1597798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597802">nret</span>&nbsp;<span class="op" id="1597807">=</span>&nbsp;<span class="ident" id="1597809">round</span><span class="op" id="1597814">(</span><span class="ident" id="1597815">nret</span><span class="op" id="1597819">,</span>&nbsp;<span class="builtintype" id="1597821">uintptr</span><span class="op" id="1597828">(</span><span class="ident" id="1597829">t</span><span class="op" id="1597830">.</span><span class="ident" id="1597831">align</span><span class="op" id="1597836">)</span><span class="op" id="1597837">)</span>&nbsp;<span class="op" id="1597839">+</span>&nbsp;<span class="builtintype" id="1597841">uintptr</span><span class="op" id="1597848">(</span><span class="ident" id="1597849">t</span><span class="op" id="1597850">.</span><span class="ident" id="1597851">size</span><span class="op" id="1597855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597861">nret</span>&nbsp;<span class="op" id="1597866">=</span>&nbsp;<span class="ident" id="1597868">round</span><span class="op" id="1597873">(</span><span class="ident" id="1597874">nret</span><span class="op" id="1597878">,</span>&nbsp;<span class="ident" id="1597880">ptrSize</span><span class="op" id="1597887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597891">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597935">createfing</span><span class="op" id="1597945">(</span><span class="op" id="1597946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597950">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597996">mp</span>&nbsp;<span class="op" id="1597999">:=</span>&nbsp;<span class="ident" id="1598002">acquirem</span><span class="op" id="1598010">(</span><span class="op" id="1598011">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598014">mp</span><span class="op" id="1598016">.</span><span class="ident" id="1598017">ptrarg</span><span class="op" id="1598023">[</span><span class="num" id="1598024">0</span><span class="op" id="1598025">]</span>&nbsp;<span class="op" id="1598027">=</span>&nbsp;<span class="ident" id="1598029">f</span><span class="op" id="1598030">.</span><span class="ident" id="1598031">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598037">mp</span><span class="op" id="1598039">.</span><span class="ident" id="1598040">ptrarg</span><span class="op" id="1598046">[</span><span class="num" id="1598047">1</span><span class="op" id="1598048">]</span>&nbsp;<span class="op" id="1598050">=</span>&nbsp;<span class="ident" id="1598052">e</span><span class="op" id="1598053">.</span><span class="ident" id="1598054">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598060">mp</span><span class="op" id="1598062">.</span><span class="ident" id="1598063">scalararg</span><span class="op" id="1598072">[</span><span class="num" id="1598073">0</span><span class="op" id="1598074">]</span>&nbsp;<span class="op" id="1598076">=</span>&nbsp;<span class="ident" id="1598078">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598084">mp</span><span class="op" id="1598086">.</span><span class="ident" id="1598087">ptrarg</span><span class="op" id="1598093">[</span><span class="num" id="1598094">2</span><span class="op" id="1598095">]</span>&nbsp;<span class="op" id="1598097">=</span>&nbsp;<span class="ident" id="1598099">unsafe</span><span class="op" id="1598105">.</span><span class="ident" id="1598106">Pointer</span><span class="op" id="1598113">(</span><span class="ident" id="1598114">fint</span><span class="op" id="1598118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598121">mp</span><span class="op" id="1598123">.</span><span class="ident" id="1598124">ptrarg</span><span class="op" id="1598130">[</span><span class="num" id="1598131">3</span><span class="op" id="1598132">]</span>&nbsp;<span class="op" id="1598134">=</span>&nbsp;<span class="ident" id="1598136">unsafe</span><span class="op" id="1598142">.</span><span class="ident" id="1598143">Pointer</span><span class="op" id="1598150">(</span><span class="ident" id="1598151">ot</span><span class="op" id="1598153">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598156">onM</span><span class="op" id="1598159">(</span><span class="ident" id="1598160">setFinalizer_m</span><span class="op" id="1598174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598177">if</span>&nbsp;<span class="ident" id="1598180">mp</span><span class="op" id="1598182">.</span><span class="ident" id="1598183">scalararg</span><span class="op" id="1598192">[</span><span class="num" id="1598193">0</span><span class="op" id="1598194">]</span>&nbsp;<span class="op" id="1598196">!=</span>&nbsp;<span class="num" id="1598199">1</span>&nbsp;<span class="op" id="1598201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598205">gothrow</span><span class="op" id="1598212">(</span><span class="string" id="1598213">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1598258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598264">releasem</span><span class="op" id="1598272">(</span><span class="ident" id="1598273">mp</span><span class="op" id="1598275">)</span><br>
<span class="lineno">655</span><span class="op" id="1598277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1598280">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1598339">func</span>&nbsp;<span class="ident" id="1598344">round</span><span class="op" id="1598349">(</span><span class="ident" id="1598350">n</span><span class="op" id="1598351">,</span>&nbsp;<span class="ident" id="1598353">a</span>&nbsp;<span class="builtintype" id="1598355">uintptr</span><span class="op" id="1598362">)</span>&nbsp;<span class="builtintype" id="1598364">uintptr</span>&nbsp;<span class="op" id="1598372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598375">return</span>&nbsp;<span class="op" id="1598382">(</span><span class="ident" id="1598383">n</span>&nbsp;<span class="op" id="1598385">+</span>&nbsp;<span class="ident" id="1598387">a</span>&nbsp;<span class="op" id="1598389">-</span>&nbsp;<span class="num" id="1598391">1</span><span class="op" id="1598392">)</span>&nbsp;<span class="op" id="1598394">&amp;^</span>&nbsp;<span class="op" id="1598397">(</span><span class="ident" id="1598398">a</span>&nbsp;<span class="op" id="1598400">-</span>&nbsp;<span class="num" id="1598402">1</span><span class="op" id="1598403">)</span><br>
<span class="lineno">660</span><span class="op" id="1598405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1598408">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1598478">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1598549">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1598588">func</span>&nbsp;<span class="ident" id="1598593">findObject</span><span class="op" id="1598603">(</span><span class="ident" id="1598604">v</span>&nbsp;<span class="ident" id="1598606">unsafe</span><span class="op" id="1598612">.</span><span class="ident" id="1598613">Pointer</span><span class="op" id="1598620">)</span>&nbsp;<span class="op" id="1598622">(</span><span class="ident" id="1598623">s</span>&nbsp;<span class="op" id="1598625">*</span><span class="ident" id="1598626">mspan</span><span class="op" id="1598631">,</span>&nbsp;<span class="ident" id="1598633">x</span>&nbsp;<span class="ident" id="1598635">unsafe</span><span class="op" id="1598641">.</span><span class="ident" id="1598642">Pointer</span><span class="op" id="1598649">,</span>&nbsp;<span class="ident" id="1598651">n</span>&nbsp;<span class="builtintype" id="1598653">uintptr</span><span class="op" id="1598660">)</span>&nbsp;<span class="op" id="1598662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598665">c</span>&nbsp;<span class="op" id="1598667">:=</span>&nbsp;<span class="ident" id="1598670">gomcache</span><span class="op" id="1598678">(</span><span class="op" id="1598679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598682">c</span><span class="op" id="1598683">.</span><span class="ident" id="1598684">local_nlookup</span><span class="op" id="1598697">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598701">if</span>&nbsp;<span class="ident" id="1598704">ptrSize</span>&nbsp;<span class="op" id="1598712">==</span>&nbsp;<span class="num" id="1598715">4</span>&nbsp;<span class="op" id="1598717">&amp;&amp;</span>&nbsp;<span class="ident" id="1598720">c</span><span class="op" id="1598721">.</span><span class="ident" id="1598722">local_nlookup</span>&nbsp;<span class="op" id="1598736">&gt;=</span>&nbsp;<span class="num" id="1598739">1</span><span class="op" id="1598740">&lt;&lt;</span><span class="num" id="1598742">30</span>&nbsp;<span class="op" id="1598745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598749">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598792">lock</span><span class="op" id="1598796">(</span><span class="op" id="1598797">&amp;</span><span class="ident" id="1598798">mheap_</span><span class="op" id="1598804">.</span><span class="ident" id="1598805">lock</span><span class="op" id="1598809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598813">purgecachedstats</span><span class="op" id="1598829">(</span><span class="ident" id="1598830">c</span><span class="op" id="1598831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598835">unlock</span><span class="op" id="1598841">(</span><span class="op" id="1598842">&amp;</span><span class="ident" id="1598843">mheap_</span><span class="op" id="1598849">.</span><span class="ident" id="1598850">lock</span><span class="op" id="1598854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598861">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598875">arena_start</span>&nbsp;<span class="op" id="1598887">:=</span>&nbsp;<span class="builtintype" id="1598890">uintptr</span><span class="op" id="1598897">(</span><span class="ident" id="1598898">unsafe</span><span class="op" id="1598904">.</span><span class="ident" id="1598905">Pointer</span><span class="op" id="1598912">(</span><span class="ident" id="1598913">mheap_</span><span class="op" id="1598919">.</span><span class="ident" id="1598920">arena_start</span><span class="op" id="1598931">)</span><span class="op" id="1598932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598935">arena_used</span>&nbsp;<span class="op" id="1598946">:=</span>&nbsp;<span class="builtintype" id="1598949">uintptr</span><span class="op" id="1598956">(</span><span class="ident" id="1598957">unsafe</span><span class="op" id="1598963">.</span><span class="ident" id="1598964">Pointer</span><span class="op" id="1598971">(</span><span class="ident" id="1598972">mheap_</span><span class="op" id="1598978">.</span><span class="ident" id="1598979">arena_used</span><span class="op" id="1598989">)</span><span class="op" id="1598990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598993">if</span>&nbsp;<span class="builtintype" id="1598996">uintptr</span><span class="op" id="1599003">(</span><span class="ident" id="1599004">v</span><span class="op" id="1599005">)</span>&nbsp;<span class="op" id="1599007">&lt;</span>&nbsp;<span class="ident" id="1599009">arena_start</span>&nbsp;<span class="op" id="1599021">||</span>&nbsp;<span class="builtintype" id="1599024">uintptr</span><span class="op" id="1599031">(</span><span class="ident" id="1599032">v</span><span class="op" id="1599033">)</span>&nbsp;<span class="op" id="1599035">&gt;=</span>&nbsp;<span class="ident" id="1599038">arena_used</span>&nbsp;<span class="op" id="1599049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599053">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599064">p</span>&nbsp;<span class="op" id="1599066">:=</span>&nbsp;<span class="builtintype" id="1599069">uintptr</span><span class="op" id="1599076">(</span><span class="ident" id="1599077">v</span><span class="op" id="1599078">)</span>&nbsp;<span class="op" id="1599080">&gt;&gt;</span>&nbsp;<span class="ident" id="1599083">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599094">q</span>&nbsp;<span class="op" id="1599096">:=</span>&nbsp;<span class="ident" id="1599099">p</span>&nbsp;<span class="op" id="1599101">-</span>&nbsp;<span class="ident" id="1599103">arena_start</span><span class="op" id="1599114">&gt;&gt;</span><span class="ident" id="1599116">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599127">s</span>&nbsp;<span class="op" id="1599129">=</span>&nbsp;<span class="op" id="1599131">*</span><span class="op" id="1599132">(</span><span class="op" id="1599133">*</span><span class="op" id="1599134">*</span><span class="ident" id="1599135">mspan</span><span class="op" id="1599140">)</span><span class="op" id="1599141">(</span><span class="ident" id="1599142">add</span><span class="op" id="1599145">(</span><span class="ident" id="1599146">unsafe</span><span class="op" id="1599152">.</span><span class="ident" id="1599153">Pointer</span><span class="op" id="1599160">(</span><span class="ident" id="1599161">mheap_</span><span class="op" id="1599167">.</span><span class="ident" id="1599168">spans</span><span class="op" id="1599173">)</span><span class="op" id="1599174">,</span>&nbsp;<span class="ident" id="1599176">q</span><span class="op" id="1599177">*</span><span class="ident" id="1599178">ptrSize</span><span class="op" id="1599185">)</span><span class="op" id="1599186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599189">if</span>&nbsp;<span class="ident" id="1599192">s</span>&nbsp;<span class="op" id="1599194">==</span>&nbsp;<span class="ident" id="1599197">nil</span>&nbsp;<span class="op" id="1599201">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599205">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599216">x</span>&nbsp;<span class="op" id="1599218">=</span>&nbsp;<span class="ident" id="1599220">unsafe</span><span class="op" id="1599226">.</span><span class="ident" id="1599227">Pointer</span><span class="op" id="1599234">(</span><span class="builtintype" id="1599235">uintptr</span><span class="op" id="1599242">(</span><span class="ident" id="1599243">s</span><span class="op" id="1599244">.</span><span class="ident" id="1599245">start</span><span class="op" id="1599250">)</span>&nbsp;<span class="op" id="1599252">&lt;&lt;</span>&nbsp;<span class="ident" id="1599255">pageShift</span><span class="op" id="1599264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599268">if</span>&nbsp;<span class="builtintype" id="1599271">uintptr</span><span class="op" id="1599278">(</span><span class="ident" id="1599279">v</span><span class="op" id="1599280">)</span>&nbsp;<span class="op" id="1599282">&lt;</span>&nbsp;<span class="builtintype" id="1599284">uintptr</span><span class="op" id="1599291">(</span><span class="ident" id="1599292">x</span><span class="op" id="1599293">)</span>&nbsp;<span class="op" id="1599295">||</span>&nbsp;<span class="builtintype" id="1599298">uintptr</span><span class="op" id="1599305">(</span><span class="ident" id="1599306">v</span><span class="op" id="1599307">)</span>&nbsp;<span class="op" id="1599309">&gt;=</span>&nbsp;<span class="builtintype" id="1599312">uintptr</span><span class="op" id="1599319">(</span><span class="ident" id="1599320">unsafe</span><span class="op" id="1599326">.</span><span class="ident" id="1599327">Pointer</span><span class="op" id="1599334">(</span><span class="ident" id="1599335">s</span><span class="op" id="1599336">.</span><span class="ident" id="1599337">limit</span><span class="op" id="1599342">)</span><span class="op" id="1599343">)</span>&nbsp;<span class="op" id="1599345">||</span>&nbsp;<span class="ident" id="1599348">s</span><span class="op" id="1599349">.</span><span class="ident" id="1599350">state</span>&nbsp;<span class="op" id="1599356">!=</span>&nbsp;<span class="ident" id="1599359">mSpanInUse</span>&nbsp;<span class="op" id="1599370">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599374">s</span>&nbsp;<span class="op" id="1599376">=</span>&nbsp;<span class="ident" id="1599378">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599384">x</span>&nbsp;<span class="op" id="1599386">=</span>&nbsp;<span class="ident" id="1599388">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599394">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599406">n</span>&nbsp;<span class="op" id="1599408">=</span>&nbsp;<span class="builtintype" id="1599410">uintptr</span><span class="op" id="1599417">(</span><span class="ident" id="1599418">s</span><span class="op" id="1599419">.</span><span class="ident" id="1599420">elemsize</span><span class="op" id="1599428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599431">if</span>&nbsp;<span class="ident" id="1599434">s</span><span class="op" id="1599435">.</span><span class="ident" id="1599436">sizeclass</span>&nbsp;<span class="op" id="1599446">!=</span>&nbsp;<span class="num" id="1599449">0</span>&nbsp;<span class="op" id="1599451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599455">x</span>&nbsp;<span class="op" id="1599457">=</span>&nbsp;<span class="ident" id="1599459">add</span><span class="op" id="1599462">(</span><span class="ident" id="1599463">x</span><span class="op" id="1599464">,</span>&nbsp;<span class="op" id="1599466">(</span><span class="builtintype" id="1599467">uintptr</span><span class="op" id="1599474">(</span><span class="ident" id="1599475">v</span><span class="op" id="1599476">)</span><span class="op" id="1599477">-</span><span class="builtintype" id="1599478">uintptr</span><span class="op" id="1599485">(</span><span class="ident" id="1599486">x</span><span class="op" id="1599487">)</span><span class="op" id="1599488">)</span><span class="op" id="1599489">/</span><span class="ident" id="1599490">n</span><span class="op" id="1599491">*</span><span class="ident" id="1599492">n</span><span class="op" id="1599493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599499">return</span><br>
<span class="lineno">700</span><span class="op" id="1599506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599509">var</span>&nbsp;<span class="ident" id="1599513">fingCreate</span>&nbsp;<span class="builtintype" id="1599524">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599532">func</span>&nbsp;<span class="ident" id="1599537">createfing</span><span class="op" id="1599547">(</span><span class="op" id="1599548">)</span>&nbsp;<span class="op" id="1599550">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1599553">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599600">if</span>&nbsp;<span class="ident" id="1599603">fingCreate</span>&nbsp;<span class="op" id="1599614">==</span>&nbsp;<span class="num" id="1599617">0</span>&nbsp;<span class="op" id="1599619">&amp;&amp;</span>&nbsp;<span class="ident" id="1599622">cas</span><span class="op" id="1599625">(</span><span class="op" id="1599626">&amp;</span><span class="ident" id="1599627">fingCreate</span><span class="op" id="1599637">,</span>&nbsp;<span class="num" id="1599639">0</span><span class="op" id="1599640">,</span>&nbsp;<span class="num" id="1599642">1</span><span class="op" id="1599643">)</span>&nbsp;<span class="op" id="1599645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599649">go</span>&nbsp;<span class="ident" id="1599652">runfinq</span><span class="op" id="1599659">(</span><span class="op" id="1599660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599663">}</span><br>
<span class="lineno"></span><span class="op" id="1599665">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1599668">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1599725">func</span>&nbsp;<span class="ident" id="1599730">runfinq</span><span class="op" id="1599737">(</span><span class="op" id="1599738">)</span>&nbsp;<span class="op" id="1599740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599743">var</span>&nbsp;<span class="op" id="1599747">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599751">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599760">unsafe</span><span class="op" id="1599766">.</span><span class="ident" id="1599767">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599777">framecap</span>&nbsp;<span class="builtintype" id="1599786">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599799">for</span>&nbsp;<span class="op" id="1599803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599807">lock</span><span class="op" id="1599811">(</span><span class="op" id="1599812">&amp;</span><span class="ident" id="1599813">finlock</span><span class="op" id="1599820">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599824">fb</span>&nbsp;<span class="op" id="1599827">:=</span>&nbsp;<span class="ident" id="1599830">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599837">finq</span>&nbsp;<span class="op" id="1599842">=</span>&nbsp;<span class="ident" id="1599844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599850">if</span>&nbsp;<span class="ident" id="1599853">fb</span>&nbsp;<span class="op" id="1599856">==</span>&nbsp;<span class="ident" id="1599859">nil</span>&nbsp;<span class="op" id="1599863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599868">gp</span>&nbsp;<span class="op" id="1599871">:=</span>&nbsp;<span class="ident" id="1599874">getg</span><span class="op" id="1599878">(</span><span class="op" id="1599879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599884">fing</span>&nbsp;<span class="op" id="1599889">=</span>&nbsp;<span class="ident" id="1599891">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599897">fingwait</span>&nbsp;<span class="op" id="1599906">=</span>&nbsp;<span class="builtintype" id="1599908">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599916">gp</span><span class="op" id="1599918">.</span><span class="ident" id="1599919">issystem</span>&nbsp;<span class="op" id="1599928">=</span>&nbsp;<span class="builtintype" id="1599930">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599938">goparkunlock</span><span class="op" id="1599950">(</span><span class="op" id="1599951">&amp;</span><span class="ident" id="1599952">finlock</span><span class="op" id="1599959">,</span>&nbsp;<span class="string" id="1599961">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1599977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599982">gp</span><span class="op" id="1599984">.</span><span class="ident" id="1599985">issystem</span>&nbsp;<span class="op" id="1599994">=</span>&nbsp;<span class="builtintype" id="1599996">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600005">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600020">unlock</span><span class="op" id="1600026">(</span><span class="op" id="1600027">&amp;</span><span class="ident" id="1600028">finlock</span><span class="op" id="1600035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600039">if</span>&nbsp;<span class="ident" id="1600042">raceenabled</span>&nbsp;<span class="op" id="1600054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600059">racefingo</span><span class="op" id="1600068">(</span><span class="op" id="1600069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600073">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600077">for</span>&nbsp;<span class="ident" id="1600081">fb</span>&nbsp;<span class="op" id="1600084">!=</span>&nbsp;<span class="ident" id="1600087">nil</span>&nbsp;<span class="op" id="1600091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600096">for</span>&nbsp;<span class="ident" id="1600100">i</span>&nbsp;<span class="op" id="1600102">:=</span>&nbsp;<span class="builtintype" id="1600105">int32</span><span class="op" id="1600110">(</span><span class="num" id="1600111">0</span><span class="op" id="1600112">)</span><span class="op" id="1600113">;</span>&nbsp;<span class="ident" id="1600115">i</span>&nbsp;<span class="op" id="1600117">&lt;</span>&nbsp;<span class="ident" id="1600119">fb</span><span class="op" id="1600121">.</span><span class="ident" id="1600122">cnt</span><span class="op" id="1600125">;</span>&nbsp;<span class="ident" id="1600127">i</span><span class="op" id="1600128">++</span>&nbsp;<span class="op" id="1600131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600137">f</span>&nbsp;<span class="op" id="1600139">:=</span>&nbsp;<span class="op" id="1600142">(</span><span class="op" id="1600143">*</span><span class="ident" id="1600144">finalizer</span><span class="op" id="1600153">)</span><span class="op" id="1600154">(</span><span class="ident" id="1600155">add</span><span class="op" id="1600158">(</span><span class="ident" id="1600159">unsafe</span><span class="op" id="1600165">.</span><span class="ident" id="1600166">Pointer</span><span class="op" id="1600173">(</span><span class="op" id="1600174">&amp;</span><span class="ident" id="1600175">fb</span><span class="op" id="1600177">.</span><span class="ident" id="1600178">fin</span><span class="op" id="1600181">)</span><span class="op" id="1600182">,</span>&nbsp;<span class="builtintype" id="1600184">uintptr</span><span class="op" id="1600191">(</span><span class="ident" id="1600192">i</span><span class="op" id="1600193">)</span><span class="op" id="1600194">*</span><span class="ident" id="1600195">unsafe</span><span class="op" id="1600201">.</span><span class="ident" id="1600202">Sizeof</span><span class="op" id="1600208">(</span><span class="ident" id="1600209">finalizer</span><span class="op" id="1600218">{</span><span class="op" id="1600219">}</span><span class="op" id="1600220">)</span><span class="op" id="1600221">)</span><span class="op" id="1600222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600229">framesz</span>&nbsp;<span class="op" id="1600237">:=</span>&nbsp;<span class="ident" id="1600240">unsafe</span><span class="op" id="1600246">.</span><span class="ident" id="1600247">Sizeof</span><span class="op" id="1600253">(</span><span class="op" id="1600254">(</span><span class="keyword" id="1600255">interface</span><span class="op" id="1600264">{</span><span class="op" id="1600265">}</span><span class="op" id="1600266">)</span><span class="op" id="1600267">(</span><span class="ident" id="1600268">nil</span><span class="op" id="1600271">)</span><span class="op" id="1600272">)</span>&nbsp;<span class="op" id="1600274">+</span>&nbsp;<span class="builtintype" id="1600276">uintptr</span><span class="op" id="1600283">(</span><span class="ident" id="1600284">f</span><span class="op" id="1600285">.</span><span class="ident" id="1600286">nret</span><span class="op" id="1600290">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600296">if</span>&nbsp;<span class="ident" id="1600299">framecap</span>&nbsp;<span class="op" id="1600308">&lt;</span>&nbsp;<span class="ident" id="1600310">framesz</span>&nbsp;<span class="op" id="1600318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600325">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600389">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600447">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600491">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600543">frame</span>&nbsp;<span class="op" id="1600549">=</span>&nbsp;<span class="ident" id="1600551">mallocgc</span><span class="op" id="1600559">(</span><span class="ident" id="1600560">framesz</span><span class="op" id="1600567">,</span>&nbsp;<span class="ident" id="1600569">nil</span><span class="op" id="1600572">,</span>&nbsp;<span class="ident" id="1600574">flagNoScan</span><span class="op" id="1600584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600591">framecap</span>&nbsp;<span class="op" id="1600600">=</span>&nbsp;<span class="ident" id="1600602">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600621">if</span>&nbsp;<span class="ident" id="1600624">f</span><span class="op" id="1600625">.</span><span class="ident" id="1600626">fint</span>&nbsp;<span class="op" id="1600631">==</span>&nbsp;<span class="ident" id="1600634">nil</span>&nbsp;<span class="op" id="1600638">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600645">gothrow</span><span class="op" id="1600652">(</span><span class="string" id="1600653">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1600678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600690">switch</span>&nbsp;<span class="ident" id="1600697">f</span><span class="op" id="1600698">.</span><span class="ident" id="1600699">fint</span><span class="op" id="1600703">.</span><span class="ident" id="1600704">kind</span>&nbsp;<span class="op" id="1600709">&amp;</span>&nbsp;<span class="ident" id="1600711">kindMask</span>&nbsp;<span class="op" id="1600720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600726">case</span>&nbsp;<span class="ident" id="1600731">kindPtr</span><span class="op" id="1600738">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600745">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600775">*</span><span class="op" id="1600776">(</span><span class="op" id="1600777">*</span><span class="ident" id="1600778">unsafe</span><span class="op" id="1600784">.</span><span class="ident" id="1600785">Pointer</span><span class="op" id="1600792">)</span><span class="op" id="1600793">(</span><span class="ident" id="1600794">frame</span><span class="op" id="1600799">)</span>&nbsp;<span class="op" id="1600801">=</span>&nbsp;<span class="ident" id="1600803">f</span><span class="op" id="1600804">.</span><span class="ident" id="1600805">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600813">case</span>&nbsp;<span class="ident" id="1600818">kindInterface</span><span class="op" id="1600831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600838">ityp</span>&nbsp;<span class="op" id="1600843">:=</span>&nbsp;<span class="op" id="1600846">(</span><span class="op" id="1600847">*</span><span class="ident" id="1600848">interfacetype</span><span class="op" id="1600861">)</span><span class="op" id="1600862">(</span><span class="ident" id="1600863">unsafe</span><span class="op" id="1600869">.</span><span class="ident" id="1600870">Pointer</span><span class="op" id="1600877">(</span><span class="ident" id="1600878">f</span><span class="op" id="1600879">.</span><span class="ident" id="1600880">fint</span><span class="op" id="1600884">)</span><span class="op" id="1600885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1600892">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600928">(</span><span class="op" id="1600929">*</span><span class="ident" id="1600930">eface</span><span class="op" id="1600935">)</span><span class="op" id="1600936">(</span><span class="ident" id="1600937">frame</span><span class="op" id="1600942">)</span><span class="op" id="1600943">.</span><span class="ident" id="1600944">_type</span>&nbsp;<span class="op" id="1600950">=</span>&nbsp;<span class="op" id="1600952">&amp;</span><span class="ident" id="1600953">f</span><span class="op" id="1600954">.</span><span class="ident" id="1600955">ot</span><span class="op" id="1600957">.</span><span class="ident" id="1600958">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600967">(</span><span class="op" id="1600968">*</span><span class="ident" id="1600969">eface</span><span class="op" id="1600974">)</span><span class="op" id="1600975">(</span><span class="ident" id="1600976">frame</span><span class="op" id="1600981">)</span><span class="op" id="1600982">.</span><span class="ident" id="1600983">data</span>&nbsp;<span class="op" id="1600988">=</span>&nbsp;<span class="ident" id="1600990">f</span><span class="op" id="1600991">.</span><span class="ident" id="1600992">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601001">if</span>&nbsp;<span class="builtinfunc" id="1601004">len</span><span class="op" id="1601007">(</span><span class="ident" id="1601008">ityp</span><span class="op" id="1601012">.</span><span class="ident" id="1601013">mhdr</span><span class="op" id="1601017">)</span>&nbsp;<span class="op" id="1601019">!=</span>&nbsp;<span class="num" id="1601022">0</span>&nbsp;<span class="op" id="1601024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601032">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601075">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601154">*</span><span class="op" id="1601155">(</span><span class="op" id="1601156">*</span><span class="ident" id="1601157">fInterface</span><span class="op" id="1601167">)</span><span class="op" id="1601168">(</span><span class="ident" id="1601169">frame</span><span class="op" id="1601174">)</span>&nbsp;<span class="op" id="1601176">=</span>&nbsp;<span class="ident" id="1601178">assertE2I</span><span class="op" id="1601187">(</span><span class="ident" id="1601188">ityp</span><span class="op" id="1601192">,</span>&nbsp;<span class="op" id="1601194">*</span><span class="op" id="1601195">(</span><span class="op" id="1601196">*</span><span class="keyword" id="1601197">interface</span><span class="op" id="1601206">{</span><span class="op" id="1601207">}</span><span class="op" id="1601208">)</span><span class="op" id="1601209">(</span><span class="ident" id="1601210">frame</span><span class="op" id="1601215">)</span><span class="op" id="1601216">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601229">default</span><span class="op" id="1601236">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601243">gothrow</span><span class="op" id="1601250">(</span><span class="string" id="1601251">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1601272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601284">reflectcall</span><span class="op" id="1601295">(</span><span class="ident" id="1601296">unsafe</span><span class="op" id="1601302">.</span><span class="ident" id="1601303">Pointer</span><span class="op" id="1601310">(</span><span class="ident" id="1601311">f</span><span class="op" id="1601312">.</span><span class="ident" id="1601313">fn</span><span class="op" id="1601315">)</span><span class="op" id="1601316">,</span>&nbsp;<span class="ident" id="1601318">frame</span><span class="op" id="1601323">,</span>&nbsp;<span class="builtintype" id="1601325">uint32</span><span class="op" id="1601331">(</span><span class="ident" id="1601332">framesz</span><span class="op" id="1601339">)</span><span class="op" id="1601340">,</span>&nbsp;<span class="builtintype" id="1601342">uint32</span><span class="op" id="1601348">(</span><span class="ident" id="1601349">framesz</span><span class="op" id="1601356">)</span><span class="op" id="1601357">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601364">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601423">f</span><span class="op" id="1601424">.</span><span class="ident" id="1601425">fn</span>&nbsp;<span class="op" id="1601428">=</span>&nbsp;<span class="ident" id="1601430">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601438">f</span><span class="op" id="1601439">.</span><span class="ident" id="1601440">arg</span>&nbsp;<span class="op" id="1601444">=</span>&nbsp;<span class="ident" id="1601446">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601454">f</span><span class="op" id="1601455">.</span><span class="ident" id="1601456">ot</span>&nbsp;<span class="op" id="1601459">=</span>&nbsp;<span class="ident" id="1601461">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601473">fb</span><span class="op" id="1601475">.</span><span class="ident" id="1601476">cnt</span>&nbsp;<span class="op" id="1601480">=</span>&nbsp;<span class="num" id="1601482">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601487">next</span>&nbsp;<span class="op" id="1601492">:=</span>&nbsp;<span class="ident" id="1601495">fb</span><span class="op" id="1601497">.</span><span class="ident" id="1601498">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601506">lock</span><span class="op" id="1601510">(</span><span class="op" id="1601511">&amp;</span><span class="ident" id="1601512">finlock</span><span class="op" id="1601519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601524">fb</span><span class="op" id="1601526">.</span><span class="ident" id="1601527">next</span>&nbsp;<span class="op" id="1601532">=</span>&nbsp;<span class="ident" id="1601534">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601542">finc</span>&nbsp;<span class="op" id="1601547">=</span>&nbsp;<span class="ident" id="1601549">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601555">unlock</span><span class="op" id="1601561">(</span><span class="op" id="1601562">&amp;</span><span class="ident" id="1601563">finlock</span><span class="op" id="1601570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601575">fb</span>&nbsp;<span class="op" id="1601578">=</span>&nbsp;<span class="ident" id="1601580">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601590">}</span><br>
<span class="lineno">785</span><span class="op" id="1601592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1601595">var</span>&nbsp;<span class="ident" id="1601599">persistent</span>&nbsp;<span class="keyword" id="1601610">struct</span>&nbsp;<span class="op" id="1601617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601620">lock</span>&nbsp;<span class="ident" id="1601625">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601632">pos</span>&nbsp;&nbsp;<span class="ident" id="1601637">unsafe</span><span class="op" id="1601643">.</span><span class="ident" id="1601644">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601653">end</span>&nbsp;&nbsp;<span class="ident" id="1601658">unsafe</span><span class="op" id="1601664">.</span><span class="ident" id="1601665">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1601673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1601676">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1601735">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1601777">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1601850">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1601902">func</span>&nbsp;<span class="ident" id="1601907">persistentalloc</span><span class="op" id="1601922">(</span><span class="ident" id="1601923">size</span><span class="op" id="1601927">,</span>&nbsp;<span class="ident" id="1601929">align</span>&nbsp;<span class="builtintype" id="1601935">uintptr</span><span class="op" id="1601942">,</span>&nbsp;<span class="ident" id="1601944">stat</span>&nbsp;<span class="op" id="1601949">*</span><span class="ident" id="1601950">uint64</span><span class="op" id="1601956">)</span>&nbsp;<span class="ident" id="1601958">unsafe</span><span class="op" id="1601964">.</span><span class="ident" id="1601965">Pointer</span>&nbsp;<span class="op" id="1601973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601976">const</span>&nbsp;<span class="op" id="1601982">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601986">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601995">=</span>&nbsp;<span class="num" id="1601997">256</span>&nbsp;<span class="op" id="1602001">&lt;&lt;</span>&nbsp;<span class="num" id="1602004">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602009">maxBlock</span>&nbsp;<span class="op" id="1602018">=</span>&nbsp;<span class="num" id="1602020">64</span>&nbsp;<span class="op" id="1602023">&lt;&lt;</span>&nbsp;<span class="num" id="1602026">10</span>&nbsp;<span class="comment" id="1602029">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602078">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602082">if</span>&nbsp;<span class="ident" id="1602085">align</span>&nbsp;<span class="op" id="1602091">!=</span>&nbsp;<span class="num" id="1602094">0</span>&nbsp;<span class="op" id="1602096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602100">if</span>&nbsp;<span class="ident" id="1602103">align</span><span class="op" id="1602108">&amp;</span><span class="op" id="1602109">(</span><span class="ident" id="1602110">align</span><span class="op" id="1602115">-</span><span class="num" id="1602116">1</span><span class="op" id="1602117">)</span>&nbsp;<span class="op" id="1602119">!=</span>&nbsp;<span class="num" id="1602122">0</span>&nbsp;<span class="op" id="1602124">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602129">gothrow</span><span class="op" id="1602136">(</span><span class="string" id="1602137">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1602181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602189">if</span>&nbsp;<span class="ident" id="1602192">align</span>&nbsp;<span class="op" id="1602198">&gt;</span>&nbsp;<span class="ident" id="1602200">_PageSize</span>&nbsp;<span class="op" id="1602210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602215">gothrow</span><span class="op" id="1602222">(</span><span class="string" id="1602223">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1602260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602264">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602267">}</span>&nbsp;<span class="keyword" id="1602269">else</span>&nbsp;<span class="op" id="1602274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602278">align</span>&nbsp;<span class="op" id="1602284">=</span>&nbsp;<span class="num" id="1602286">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602293">if</span>&nbsp;<span class="ident" id="1602296">size</span>&nbsp;<span class="op" id="1602301">&gt;=</span>&nbsp;<span class="ident" id="1602304">maxBlock</span>&nbsp;<span class="op" id="1602313">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602317">return</span>&nbsp;<span class="ident" id="1602324">sysAlloc</span><span class="op" id="1602332">(</span><span class="ident" id="1602333">size</span><span class="op" id="1602337">,</span>&nbsp;<span class="ident" id="1602339">stat</span><span class="op" id="1602343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602350">lock</span><span class="op" id="1602354">(</span><span class="op" id="1602355">&amp;</span><span class="ident" id="1602356">persistent</span><span class="op" id="1602366">.</span><span class="ident" id="1602367">lock</span><span class="op" id="1602371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602374">persistent</span><span class="op" id="1602384">.</span><span class="ident" id="1602385">pos</span>&nbsp;<span class="op" id="1602389">=</span>&nbsp;<span class="ident" id="1602391">roundup</span><span class="op" id="1602398">(</span><span class="ident" id="1602399">persistent</span><span class="op" id="1602409">.</span><span class="ident" id="1602410">pos</span><span class="op" id="1602413">,</span>&nbsp;<span class="ident" id="1602415">align</span><span class="op" id="1602420">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602423">if</span>&nbsp;<span class="builtintype" id="1602426">uintptr</span><span class="op" id="1602433">(</span><span class="ident" id="1602434">persistent</span><span class="op" id="1602444">.</span><span class="ident" id="1602445">pos</span><span class="op" id="1602448">)</span><span class="op" id="1602449">+</span><span class="ident" id="1602450">size</span>&nbsp;<span class="op" id="1602455">&gt;</span>&nbsp;<span class="builtintype" id="1602457">uintptr</span><span class="op" id="1602464">(</span><span class="ident" id="1602465">persistent</span><span class="op" id="1602475">.</span><span class="ident" id="1602476">end</span><span class="op" id="1602479">)</span>&nbsp;<span class="op" id="1602481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602485">persistent</span><span class="op" id="1602495">.</span><span class="ident" id="1602496">pos</span>&nbsp;<span class="op" id="1602500">=</span>&nbsp;<span class="ident" id="1602502">sysAlloc</span><span class="op" id="1602510">(</span><span class="ident" id="1602511">chunk</span><span class="op" id="1602516">,</span>&nbsp;<span class="op" id="1602518">&amp;</span><span class="ident" id="1602519">memstats</span><span class="op" id="1602527">.</span><span class="ident" id="1602528">other_sys</span><span class="op" id="1602537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602541">if</span>&nbsp;<span class="ident" id="1602544">persistent</span><span class="op" id="1602554">.</span><span class="ident" id="1602555">pos</span>&nbsp;<span class="op" id="1602559">==</span>&nbsp;<span class="ident" id="1602562">nil</span>&nbsp;<span class="op" id="1602566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602571">unlock</span><span class="op" id="1602577">(</span><span class="op" id="1602578">&amp;</span><span class="ident" id="1602579">persistent</span><span class="op" id="1602589">.</span><span class="ident" id="1602590">lock</span><span class="op" id="1602594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602599">gothrow</span><span class="op" id="1602606">(</span><span class="string" id="1602607">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1602640">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602648">persistent</span><span class="op" id="1602658">.</span><span class="ident" id="1602659">end</span>&nbsp;<span class="op" id="1602663">=</span>&nbsp;<span class="ident" id="1602665">add</span><span class="op" id="1602668">(</span><span class="ident" id="1602669">persistent</span><span class="op" id="1602679">.</span><span class="ident" id="1602680">pos</span><span class="op" id="1602683">,</span>&nbsp;<span class="ident" id="1602685">chunk</span><span class="op" id="1602690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602696">p</span>&nbsp;<span class="op" id="1602698">:=</span>&nbsp;<span class="ident" id="1602701">persistent</span><span class="op" id="1602711">.</span><span class="ident" id="1602712">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602717">persistent</span><span class="op" id="1602727">.</span><span class="ident" id="1602728">pos</span>&nbsp;<span class="op" id="1602732">=</span>&nbsp;<span class="ident" id="1602734">add</span><span class="op" id="1602737">(</span><span class="ident" id="1602738">persistent</span><span class="op" id="1602748">.</span><span class="ident" id="1602749">pos</span><span class="op" id="1602752">,</span>&nbsp;<span class="ident" id="1602754">size</span><span class="op" id="1602758">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602761">unlock</span><span class="op" id="1602767">(</span><span class="op" id="1602768">&amp;</span><span class="ident" id="1602769">persistent</span><span class="op" id="1602779">.</span><span class="ident" id="1602780">lock</span><span class="op" id="1602784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602788">if</span>&nbsp;<span class="ident" id="1602791">stat</span>&nbsp;<span class="op" id="1602796">!=</span>&nbsp;<span class="op" id="1602799">&amp;</span><span class="ident" id="1602800">memstats</span><span class="op" id="1602808">.</span><span class="ident" id="1602809">other_sys</span>&nbsp;<span class="op" id="1602819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602823">xadd64</span><span class="op" id="1602829">(</span><span class="ident" id="1602830">stat</span><span class="op" id="1602834">,</span>&nbsp;<span class="ident" id="1602836">int64</span><span class="op" id="1602841">(</span><span class="ident" id="1602842">size</span><span class="op" id="1602846">)</span><span class="op" id="1602847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602851">xadd64</span><span class="op" id="1602857">(</span><span class="op" id="1602858">&amp;</span><span class="ident" id="1602859">memstats</span><span class="op" id="1602867">.</span><span class="ident" id="1602868">other_sys</span><span class="op" id="1602877">,</span>&nbsp;<span class="op" id="1602879">-</span><span class="ident" id="1602880">int64</span><span class="op" id="1602885">(</span><span class="ident" id="1602886">size</span><span class="op" id="1602890">)</span><span class="op" id="1602891">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602897">return</span>&nbsp;<span class="ident" id="1602904">p</span><br>
<span class="lineno"></span><span class="op" id="1602906">}</span>
</div>
</body>
</html>
