<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html" class="current">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3124720">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3124775">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3124829">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3124880">package</span>&nbsp;<span class="ident" id="3124888">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3124896">import</span>&nbsp;<span class="op" id="3124903">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3124906">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3124923">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3124932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124935">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3125011">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3125020">type</span>&nbsp;<span class="ident" id="3125025">AEAD</span>&nbsp;<span class="keyword" id="3125030">interface</span>&nbsp;<span class="op" id="3125040">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125043">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125115">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125129">NonceSize</span><span class="op" id="3125138">(</span><span class="op" id="3125139">)</span>&nbsp;<span class="builtintype" id="3125141">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125147">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125216">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125246">Overhead</span><span class="op" id="3125254">(</span><span class="op" id="3125255">)</span>&nbsp;<span class="builtintype" id="3125257">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125263">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125328">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125401">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125472">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125499">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125503">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125562">Seal</span><span class="op" id="3125566">(</span><span class="ident" id="3125567">dst</span><span class="op" id="3125570">,</span>&nbsp;<span class="ident" id="3125572">nonce</span><span class="op" id="3125577">,</span>&nbsp;<span class="ident" id="3125579">plaintext</span><span class="op" id="3125588">,</span>&nbsp;<span class="ident" id="3125590">data</span>&nbsp;<span class="op" id="3125595">[</span><span class="op" id="3125596">]</span><span class="builtintype" id="3125597">byte</span><span class="op" id="3125601">)</span>&nbsp;<span class="op" id="3125603">[</span><span class="op" id="3125604">]</span><span class="builtintype" id="3125605">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125612">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125678">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125750">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125821">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125887">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125913">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125917">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125977">Open</span><span class="op" id="3125981">(</span><span class="ident" id="3125982">dst</span><span class="op" id="3125985">,</span>&nbsp;<span class="ident" id="3125987">nonce</span><span class="op" id="3125992">,</span>&nbsp;<span class="ident" id="3125994">ciphertext</span><span class="op" id="3126004">,</span>&nbsp;<span class="ident" id="3126006">data</span>&nbsp;<span class="op" id="3126011">[</span><span class="op" id="3126012">]</span><span class="builtintype" id="3126013">byte</span><span class="op" id="3126017">)</span>&nbsp;<span class="op" id="3126019">(</span><span class="op" id="3126020">[</span><span class="op" id="3126021">]</span><span class="builtintype" id="3126022">byte</span><span class="op" id="3126026">,</span>&nbsp;<span class="builtintype" id="3126028">error</span><span class="op" id="3126033">)</span><br>
<span class="lineno"></span><span class="op" id="3126035">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3126038">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3126121">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3126199">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3126237">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3126298">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3126359">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3126424">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3126488">type</span>&nbsp;<span class="ident" id="3126493">gcmFieldElement</span>&nbsp;<span class="keyword" id="3126509">struct</span>&nbsp;<span class="op" id="3126516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126519">low</span><span class="op" id="3126522">,</span>&nbsp;<span class="ident" id="3126524">high</span>&nbsp;<span class="ident" id="3126529">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3126536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3126539">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3126604">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3126699">type</span>&nbsp;<span class="ident" id="3126704">gcm</span>&nbsp;<span class="keyword" id="3126708">struct</span>&nbsp;<span class="op" id="3126715">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126718">cipher</span>&nbsp;<span class="ident" id="3126725">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3126732">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3126798">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3126855">productTable</span>&nbsp;<span class="op" id="3126868">[</span><span class="num" id="3126869">16</span><span class="op" id="3126871">]</span><span class="ident" id="3126872">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3126888">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3126891">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3126973">func</span>&nbsp;<span class="ident" id="3126978">NewGCM</span><span class="op" id="3126984">(</span><span class="ident" id="3126985">cipher</span>&nbsp;<span class="ident" id="3126992">Block</span><span class="op" id="3126997">)</span>&nbsp;<span class="op" id="3126999">(</span><span class="ident" id="3127000">AEAD</span><span class="op" id="3127004">,</span>&nbsp;<span class="builtintype" id="3127006">error</span><span class="op" id="3127011">)</span>&nbsp;<span class="op" id="3127013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127016">if</span>&nbsp;<span class="ident" id="3127019">cipher</span><span class="op" id="3127025">.</span><span class="ident" id="3127026">BlockSize</span><span class="op" id="3127035">(</span><span class="op" id="3127036">)</span>&nbsp;<span class="op" id="3127038">!=</span>&nbsp;<span class="ident" id="3127041">gcmBlockSize</span>&nbsp;<span class="op" id="3127054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127058">return</span>&nbsp;<span class="builtintype" id="3127065">nil</span><span class="op" id="3127068">,</span>&nbsp;<span class="ident" id="3127070">errors</span><span class="op" id="3127076">.</span><span class="ident" id="3127077">New</span><span class="op" id="3127080">(</span><span class="string" id="3127081">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3127127">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127134">var</span>&nbsp;<span class="ident" id="3127138">key</span>&nbsp;<span class="op" id="3127142">[</span><span class="ident" id="3127143">gcmBlockSize</span><span class="op" id="3127155">]</span><span class="builtintype" id="3127156">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127162">cipher</span><span class="op" id="3127168">.</span><span class="ident" id="3127169">Encrypt</span><span class="op" id="3127176">(</span><span class="ident" id="3127177">key</span><span class="op" id="3127180">[</span><span class="op" id="3127181">:</span><span class="op" id="3127182">]</span><span class="op" id="3127183">,</span>&nbsp;<span class="ident" id="3127185">key</span><span class="op" id="3127188">[</span><span class="op" id="3127189">:</span><span class="op" id="3127190">]</span><span class="op" id="3127191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127195">g</span>&nbsp;<span class="op" id="3127197">:=</span>&nbsp;<span class="op" id="3127200">&amp;</span><span class="ident" id="3127201">gcm</span><span class="op" id="3127204">{</span><span class="ident" id="3127205">cipher</span><span class="op" id="3127211">:</span>&nbsp;<span class="ident" id="3127213">cipher</span><span class="op" id="3127219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127223">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127292">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127357">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127426">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3127496">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127566">x</span>&nbsp;<span class="op" id="3127568">:=</span>&nbsp;<span class="ident" id="3127571">gcmFieldElement</span><span class="op" id="3127586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127590">getUint64</span><span class="op" id="3127599">(</span><span class="ident" id="3127600">key</span><span class="op" id="3127603">[</span><span class="op" id="3127604">:</span><span class="num" id="3127605">8</span><span class="op" id="3127606">]</span><span class="op" id="3127607">)</span><span class="op" id="3127608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127612">getUint64</span><span class="op" id="3127621">(</span><span class="ident" id="3127622">key</span><span class="op" id="3127625">[</span><span class="num" id="3127626">8</span><span class="op" id="3127627">:</span><span class="op" id="3127628">]</span><span class="op" id="3127629">)</span><span class="op" id="3127630">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127636">g</span><span class="op" id="3127637">.</span><span class="ident" id="3127638">productTable</span><span class="op" id="3127650">[</span><span class="ident" id="3127651">reverseBits</span><span class="op" id="3127662">(</span><span class="num" id="3127663">1</span><span class="op" id="3127664">)</span><span class="op" id="3127665">]</span>&nbsp;<span class="op" id="3127667">=</span>&nbsp;<span class="ident" id="3127669">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127673">for</span>&nbsp;<span class="ident" id="3127677">i</span>&nbsp;<span class="op" id="3127679">:=</span>&nbsp;<span class="num" id="3127682">2</span><span class="op" id="3127683">;</span>&nbsp;<span class="ident" id="3127685">i</span>&nbsp;<span class="op" id="3127687">&lt;</span>&nbsp;<span class="num" id="3127689">16</span><span class="op" id="3127691">;</span>&nbsp;<span class="ident" id="3127693">i</span>&nbsp;<span class="op" id="3127695">+=</span>&nbsp;<span class="num" id="3127698">2</span>&nbsp;<span class="op" id="3127700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127704">g</span><span class="op" id="3127705">.</span><span class="ident" id="3127706">productTable</span><span class="op" id="3127718">[</span><span class="ident" id="3127719">reverseBits</span><span class="op" id="3127730">(</span><span class="ident" id="3127731">i</span><span class="op" id="3127732">)</span><span class="op" id="3127733">]</span>&nbsp;<span class="op" id="3127735">=</span>&nbsp;<span class="ident" id="3127737">gcmDouble</span><span class="op" id="3127746">(</span><span class="op" id="3127747">&amp;</span><span class="ident" id="3127748">g</span><span class="op" id="3127749">.</span><span class="ident" id="3127750">productTable</span><span class="op" id="3127762">[</span><span class="ident" id="3127763">reverseBits</span><span class="op" id="3127774">(</span><span class="ident" id="3127775">i</span><span class="op" id="3127776">/</span><span class="num" id="3127777">2</span><span class="op" id="3127778">)</span><span class="op" id="3127779">]</span><span class="op" id="3127780">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127784">g</span><span class="op" id="3127785">.</span><span class="ident" id="3127786">productTable</span><span class="op" id="3127798">[</span><span class="ident" id="3127799">reverseBits</span><span class="op" id="3127810">(</span><span class="ident" id="3127811">i</span><span class="op" id="3127812">+</span><span class="num" id="3127813">1</span><span class="op" id="3127814">)</span><span class="op" id="3127815">]</span>&nbsp;<span class="op" id="3127817">=</span>&nbsp;<span class="ident" id="3127819">gcmAdd</span><span class="op" id="3127825">(</span><span class="op" id="3127826">&amp;</span><span class="ident" id="3127827">g</span><span class="op" id="3127828">.</span><span class="ident" id="3127829">productTable</span><span class="op" id="3127841">[</span><span class="ident" id="3127842">reverseBits</span><span class="op" id="3127853">(</span><span class="ident" id="3127854">i</span><span class="op" id="3127855">)</span><span class="op" id="3127856">]</span><span class="op" id="3127857">,</span>&nbsp;<span class="op" id="3127859">&amp;</span><span class="ident" id="3127860">x</span><span class="op" id="3127861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127868">return</span>&nbsp;<span class="ident" id="3127875">g</span><span class="op" id="3127876">,</span>&nbsp;<span class="builtintype" id="3127878">nil</span><br>
<span class="lineno"></span><span class="op" id="3127882">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3127885">const</span>&nbsp;<span class="op" id="3127891">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127894">gcmBlockSize</span>&nbsp;<span class="op" id="3127907">=</span>&nbsp;<span class="num" id="3127909">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127913">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3127926">=</span>&nbsp;<span class="num" id="3127928">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3127932">gcmNonceSize</span>&nbsp;<span class="op" id="3127945">=</span>&nbsp;<span class="num" id="3127947">12</span><br>
<span class="lineno">95</span><span class="op" id="3127950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3127953">func</span>&nbsp;<span class="op" id="3127958">(</span><span class="op" id="3127959">*</span><span class="ident" id="3127960">gcm</span><span class="op" id="3127963">)</span>&nbsp;<span class="ident" id="3127965">NonceSize</span><span class="op" id="3127974">(</span><span class="op" id="3127975">)</span>&nbsp;<span class="builtintype" id="3127977">int</span>&nbsp;<span class="op" id="3127981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127984">return</span>&nbsp;<span class="ident" id="3127991">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3128004">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3128007">func</span>&nbsp;<span class="op" id="3128012">(</span><span class="op" id="3128013">*</span><span class="ident" id="3128014">gcm</span><span class="op" id="3128017">)</span>&nbsp;<span class="ident" id="3128019">Overhead</span><span class="op" id="3128027">(</span><span class="op" id="3128028">)</span>&nbsp;<span class="builtintype" id="3128030">int</span>&nbsp;<span class="op" id="3128034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128037">return</span>&nbsp;<span class="ident" id="3128044">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3128055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3128058">func</span>&nbsp;<span class="op" id="3128063">(</span><span class="ident" id="3128064">g</span>&nbsp;<span class="op" id="3128066">*</span><span class="ident" id="3128067">gcm</span><span class="op" id="3128070">)</span>&nbsp;<span class="ident" id="3128072">Seal</span><span class="op" id="3128076">(</span><span class="ident" id="3128077">dst</span><span class="op" id="3128080">,</span>&nbsp;<span class="ident" id="3128082">nonce</span><span class="op" id="3128087">,</span>&nbsp;<span class="ident" id="3128089">plaintext</span><span class="op" id="3128098">,</span>&nbsp;<span class="ident" id="3128100">data</span>&nbsp;<span class="op" id="3128105">[</span><span class="op" id="3128106">]</span><span class="builtintype" id="3128107">byte</span><span class="op" id="3128111">)</span>&nbsp;<span class="op" id="3128113">[</span><span class="op" id="3128114">]</span><span class="builtintype" id="3128115">byte</span>&nbsp;<span class="op" id="3128120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128123">if</span>&nbsp;<span class="builtinfunc" id="3128126">len</span><span class="op" id="3128129">(</span><span class="ident" id="3128130">nonce</span><span class="op" id="3128135">)</span>&nbsp;<span class="op" id="3128137">!=</span>&nbsp;<span class="ident" id="3128140">gcmNonceSize</span>&nbsp;<span class="op" id="3128153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3128157">panic</span><span class="op" id="3128162">(</span><span class="string" id="3128163">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3128208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128215">ret</span><span class="op" id="3128218">,</span>&nbsp;<span class="ident" id="3128220">out</span>&nbsp;<span class="op" id="3128224">:=</span>&nbsp;<span class="ident" id="3128227">sliceForAppend</span><span class="op" id="3128241">(</span><span class="ident" id="3128242">dst</span><span class="op" id="3128245">,</span>&nbsp;<span class="builtinfunc" id="3128247">len</span><span class="op" id="3128250">(</span><span class="ident" id="3128251">plaintext</span><span class="op" id="3128260">)</span><span class="op" id="3128261">+</span><span class="ident" id="3128262">gcmTagSize</span><span class="op" id="3128272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128276">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128307">var</span>&nbsp;<span class="ident" id="3128311">counter</span><span class="op" id="3128318">,</span>&nbsp;<span class="ident" id="3128320">tagMask</span>&nbsp;<span class="op" id="3128328">[</span><span class="ident" id="3128329">gcmBlockSize</span><span class="op" id="3128341">]</span><span class="builtintype" id="3128342">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3128348">copy</span><span class="op" id="3128352">(</span><span class="ident" id="3128353">counter</span><span class="op" id="3128360">[</span><span class="op" id="3128361">:</span><span class="op" id="3128362">]</span><span class="op" id="3128363">,</span>&nbsp;<span class="ident" id="3128365">nonce</span><span class="op" id="3128370">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128373">counter</span><span class="op" id="3128380">[</span><span class="ident" id="3128381">gcmBlockSize</span><span class="op" id="3128393">-</span><span class="num" id="3128394">1</span><span class="op" id="3128395">]</span>&nbsp;<span class="op" id="3128397">=</span>&nbsp;<span class="num" id="3128399">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128403">g</span><span class="op" id="3128404">.</span><span class="ident" id="3128405">cipher</span><span class="op" id="3128411">.</span><span class="ident" id="3128412">Encrypt</span><span class="op" id="3128419">(</span><span class="ident" id="3128420">tagMask</span><span class="op" id="3128427">[</span><span class="op" id="3128428">:</span><span class="op" id="3128429">]</span><span class="op" id="3128430">,</span>&nbsp;<span class="ident" id="3128432">counter</span><span class="op" id="3128439">[</span><span class="op" id="3128440">:</span><span class="op" id="3128441">]</span><span class="op" id="3128442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128445">gcmInc32</span><span class="op" id="3128453">(</span><span class="op" id="3128454">&amp;</span><span class="ident" id="3128455">counter</span><span class="op" id="3128462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128466">g</span><span class="op" id="3128467">.</span><span class="ident" id="3128468">counterCrypt</span><span class="op" id="3128480">(</span><span class="ident" id="3128481">out</span><span class="op" id="3128484">,</span>&nbsp;<span class="ident" id="3128486">plaintext</span><span class="op" id="3128495">,</span>&nbsp;<span class="op" id="3128497">&amp;</span><span class="ident" id="3128498">counter</span><span class="op" id="3128505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128508">g</span><span class="op" id="3128509">.</span><span class="ident" id="3128510">auth</span><span class="op" id="3128514">(</span><span class="ident" id="3128515">out</span><span class="op" id="3128518">[</span><span class="builtinfunc" id="3128519">len</span><span class="op" id="3128522">(</span><span class="ident" id="3128523">plaintext</span><span class="op" id="3128532">)</span><span class="op" id="3128533">:</span><span class="op" id="3128534">]</span><span class="op" id="3128535">,</span>&nbsp;<span class="ident" id="3128537">out</span><span class="op" id="3128540">[</span><span class="op" id="3128541">:</span><span class="builtinfunc" id="3128542">len</span><span class="op" id="3128545">(</span><span class="ident" id="3128546">plaintext</span><span class="op" id="3128555">)</span><span class="op" id="3128556">]</span><span class="op" id="3128557">,</span>&nbsp;<span class="ident" id="3128559">data</span><span class="op" id="3128563">,</span>&nbsp;<span class="op" id="3128565">&amp;</span><span class="ident" id="3128566">tagMask</span><span class="op" id="3128573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128577">return</span>&nbsp;<span class="ident" id="3128584">ret</span><br>
<span class="lineno"></span><span class="op" id="3128588">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3128591">var</span>&nbsp;<span class="ident" id="3128595">errOpen</span>&nbsp;<span class="op" id="3128603">=</span>&nbsp;<span class="ident" id="3128605">errors</span><span class="op" id="3128611">.</span><span class="ident" id="3128612">New</span><span class="op" id="3128615">(</span><span class="string" id="3128616">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3128655">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3128658">func</span>&nbsp;<span class="op" id="3128663">(</span><span class="ident" id="3128664">g</span>&nbsp;<span class="op" id="3128666">*</span><span class="ident" id="3128667">gcm</span><span class="op" id="3128670">)</span>&nbsp;<span class="ident" id="3128672">Open</span><span class="op" id="3128676">(</span><span class="ident" id="3128677">dst</span><span class="op" id="3128680">,</span>&nbsp;<span class="ident" id="3128682">nonce</span><span class="op" id="3128687">,</span>&nbsp;<span class="ident" id="3128689">ciphertext</span><span class="op" id="3128699">,</span>&nbsp;<span class="ident" id="3128701">data</span>&nbsp;<span class="op" id="3128706">[</span><span class="op" id="3128707">]</span><span class="builtintype" id="3128708">byte</span><span class="op" id="3128712">)</span>&nbsp;<span class="op" id="3128714">(</span><span class="op" id="3128715">[</span><span class="op" id="3128716">]</span><span class="builtintype" id="3128717">byte</span><span class="op" id="3128721">,</span>&nbsp;<span class="builtintype" id="3128723">error</span><span class="op" id="3128728">)</span>&nbsp;<span class="op" id="3128730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128733">if</span>&nbsp;<span class="builtinfunc" id="3128736">len</span><span class="op" id="3128739">(</span><span class="ident" id="3128740">nonce</span><span class="op" id="3128745">)</span>&nbsp;<span class="op" id="3128747">!=</span>&nbsp;<span class="ident" id="3128750">gcmNonceSize</span>&nbsp;<span class="op" id="3128763">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3128767">panic</span><span class="op" id="3128772">(</span><span class="string" id="3128773">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3128818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128825">if</span>&nbsp;<span class="builtinfunc" id="3128828">len</span><span class="op" id="3128831">(</span><span class="ident" id="3128832">ciphertext</span><span class="op" id="3128842">)</span>&nbsp;<span class="op" id="3128844">&lt;</span>&nbsp;<span class="ident" id="3128846">gcmTagSize</span>&nbsp;<span class="op" id="3128857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128861">return</span>&nbsp;<span class="builtintype" id="3128868">nil</span><span class="op" id="3128871">,</span>&nbsp;<span class="ident" id="3128873">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128885">tag</span>&nbsp;<span class="op" id="3128889">:=</span>&nbsp;<span class="ident" id="3128892">ciphertext</span><span class="op" id="3128902">[</span><span class="builtinfunc" id="3128903">len</span><span class="op" id="3128906">(</span><span class="ident" id="3128907">ciphertext</span><span class="op" id="3128917">)</span><span class="op" id="3128918">-</span><span class="ident" id="3128919">gcmTagSize</span><span class="op" id="3128929">:</span><span class="op" id="3128930">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128933">ciphertext</span>&nbsp;<span class="op" id="3128944">=</span>&nbsp;<span class="ident" id="3128946">ciphertext</span><span class="op" id="3128956">[</span><span class="op" id="3128957">:</span><span class="builtinfunc" id="3128958">len</span><span class="op" id="3128961">(</span><span class="ident" id="3128962">ciphertext</span><span class="op" id="3128972">)</span><span class="op" id="3128973">-</span><span class="ident" id="3128974">gcmTagSize</span><span class="op" id="3128984">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128988">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129019">var</span>&nbsp;<span class="ident" id="3129023">counter</span><span class="op" id="3129030">,</span>&nbsp;<span class="ident" id="3129032">tagMask</span>&nbsp;<span class="op" id="3129040">[</span><span class="ident" id="3129041">gcmBlockSize</span><span class="op" id="3129053">]</span><span class="builtintype" id="3129054">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3129060">copy</span><span class="op" id="3129064">(</span><span class="ident" id="3129065">counter</span><span class="op" id="3129072">[</span><span class="op" id="3129073">:</span><span class="op" id="3129074">]</span><span class="op" id="3129075">,</span>&nbsp;<span class="ident" id="3129077">nonce</span><span class="op" id="3129082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129085">counter</span><span class="op" id="3129092">[</span><span class="ident" id="3129093">gcmBlockSize</span><span class="op" id="3129105">-</span><span class="num" id="3129106">1</span><span class="op" id="3129107">]</span>&nbsp;<span class="op" id="3129109">=</span>&nbsp;<span class="num" id="3129111">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129115">g</span><span class="op" id="3129116">.</span><span class="ident" id="3129117">cipher</span><span class="op" id="3129123">.</span><span class="ident" id="3129124">Encrypt</span><span class="op" id="3129131">(</span><span class="ident" id="3129132">tagMask</span><span class="op" id="3129139">[</span><span class="op" id="3129140">:</span><span class="op" id="3129141">]</span><span class="op" id="3129142">,</span>&nbsp;<span class="ident" id="3129144">counter</span><span class="op" id="3129151">[</span><span class="op" id="3129152">:</span><span class="op" id="3129153">]</span><span class="op" id="3129154">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129157">gcmInc32</span><span class="op" id="3129165">(</span><span class="op" id="3129166">&amp;</span><span class="ident" id="3129167">counter</span><span class="op" id="3129174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129178">var</span>&nbsp;<span class="ident" id="3129182">expectedTag</span>&nbsp;<span class="op" id="3129194">[</span><span class="ident" id="3129195">gcmTagSize</span><span class="op" id="3129205">]</span><span class="builtintype" id="3129206">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129212">g</span><span class="op" id="3129213">.</span><span class="ident" id="3129214">auth</span><span class="op" id="3129218">(</span><span class="ident" id="3129219">expectedTag</span><span class="op" id="3129230">[</span><span class="op" id="3129231">:</span><span class="op" id="3129232">]</span><span class="op" id="3129233">,</span>&nbsp;<span class="ident" id="3129235">ciphertext</span><span class="op" id="3129245">,</span>&nbsp;<span class="ident" id="3129247">data</span><span class="op" id="3129251">,</span>&nbsp;<span class="op" id="3129253">&amp;</span><span class="ident" id="3129254">tagMask</span><span class="op" id="3129261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129265">if</span>&nbsp;<span class="ident" id="3129268">subtle</span><span class="op" id="3129274">.</span><span class="ident" id="3129275">ConstantTimeCompare</span><span class="op" id="3129294">(</span><span class="ident" id="3129295">expectedTag</span><span class="op" id="3129306">[</span><span class="op" id="3129307">:</span><span class="op" id="3129308">]</span><span class="op" id="3129309">,</span>&nbsp;<span class="ident" id="3129311">tag</span><span class="op" id="3129314">)</span>&nbsp;<span class="op" id="3129316">!=</span>&nbsp;<span class="num" id="3129319">1</span>&nbsp;<span class="op" id="3129321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129325">return</span>&nbsp;<span class="builtintype" id="3129332">nil</span><span class="op" id="3129335">,</span>&nbsp;<span class="ident" id="3129337">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129350">ret</span><span class="op" id="3129353">,</span>&nbsp;<span class="ident" id="3129355">out</span>&nbsp;<span class="op" id="3129359">:=</span>&nbsp;<span class="ident" id="3129362">sliceForAppend</span><span class="op" id="3129376">(</span><span class="ident" id="3129377">dst</span><span class="op" id="3129380">,</span>&nbsp;<span class="builtinfunc" id="3129382">len</span><span class="op" id="3129385">(</span><span class="ident" id="3129386">ciphertext</span><span class="op" id="3129396">)</span><span class="op" id="3129397">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129400">g</span><span class="op" id="3129401">.</span><span class="ident" id="3129402">counterCrypt</span><span class="op" id="3129414">(</span><span class="ident" id="3129415">out</span><span class="op" id="3129418">,</span>&nbsp;<span class="ident" id="3129420">ciphertext</span><span class="op" id="3129430">,</span>&nbsp;<span class="op" id="3129432">&amp;</span><span class="ident" id="3129433">counter</span><span class="op" id="3129440">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129444">return</span>&nbsp;<span class="ident" id="3129451">ret</span><span class="op" id="3129454">,</span>&nbsp;<span class="builtintype" id="3129456">nil</span><br>
<span class="lineno"></span><span class="op" id="3129460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3129463">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3129531">func</span>&nbsp;<span class="ident" id="3129536">reverseBits</span><span class="op" id="3129547">(</span><span class="ident" id="3129548">i</span>&nbsp;<span class="builtintype" id="3129550">int</span><span class="op" id="3129553">)</span>&nbsp;<span class="builtintype" id="3129555">int</span>&nbsp;<span class="op" id="3129559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129562">i</span>&nbsp;<span class="op" id="3129564">=</span>&nbsp;<span class="op" id="3129566">(</span><span class="op" id="3129567">(</span><span class="ident" id="3129568">i</span>&nbsp;<span class="op" id="3129570">&lt;&lt;</span>&nbsp;<span class="num" id="3129573">2</span><span class="op" id="3129574">)</span>&nbsp;<span class="op" id="3129576">&amp;</span>&nbsp;<span class="num" id="3129578">0xc</span><span class="op" id="3129581">)</span>&nbsp;<span class="op" id="3129583">|</span>&nbsp;<span class="op" id="3129585">(</span><span class="op" id="3129586">(</span><span class="ident" id="3129587">i</span>&nbsp;<span class="op" id="3129589">&gt;&gt;</span>&nbsp;<span class="num" id="3129592">2</span><span class="op" id="3129593">)</span>&nbsp;<span class="op" id="3129595">&amp;</span>&nbsp;<span class="num" id="3129597">0x3</span><span class="op" id="3129600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129603">i</span>&nbsp;<span class="op" id="3129605">=</span>&nbsp;<span class="op" id="3129607">(</span><span class="op" id="3129608">(</span><span class="ident" id="3129609">i</span>&nbsp;<span class="op" id="3129611">&lt;&lt;</span>&nbsp;<span class="num" id="3129614">1</span><span class="op" id="3129615">)</span>&nbsp;<span class="op" id="3129617">&amp;</span>&nbsp;<span class="num" id="3129619">0xa</span><span class="op" id="3129622">)</span>&nbsp;<span class="op" id="3129624">|</span>&nbsp;<span class="op" id="3129626">(</span><span class="op" id="3129627">(</span><span class="ident" id="3129628">i</span>&nbsp;<span class="op" id="3129630">&gt;&gt;</span>&nbsp;<span class="num" id="3129633">1</span><span class="op" id="3129634">)</span>&nbsp;<span class="op" id="3129636">&amp;</span>&nbsp;<span class="num" id="3129638">0x5</span><span class="op" id="3129641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129644">return</span>&nbsp;<span class="ident" id="3129651">i</span><br>
<span class="lineno">165</span><span class="op" id="3129653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129656">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3129721">func</span>&nbsp;<span class="ident" id="3129726">gcmAdd</span><span class="op" id="3129732">(</span><span class="ident" id="3129733">x</span><span class="op" id="3129734">,</span>&nbsp;<span class="ident" id="3129736">y</span>&nbsp;<span class="op" id="3129738">*</span><span class="ident" id="3129739">gcmFieldElement</span><span class="op" id="3129754">)</span>&nbsp;<span class="ident" id="3129756">gcmFieldElement</span>&nbsp;<span class="op" id="3129772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3129775">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129829">return</span>&nbsp;<span class="ident" id="3129836">gcmFieldElement</span><span class="op" id="3129851">{</span><span class="ident" id="3129852">x</span><span class="op" id="3129853">.</span><span class="ident" id="3129854">low</span>&nbsp;<span class="op" id="3129858">^</span>&nbsp;<span class="ident" id="3129860">y</span><span class="op" id="3129861">.</span><span class="ident" id="3129862">low</span><span class="op" id="3129865">,</span>&nbsp;<span class="ident" id="3129867">x</span><span class="op" id="3129868">.</span><span class="ident" id="3129869">high</span>&nbsp;<span class="op" id="3129874">^</span>&nbsp;<span class="ident" id="3129876">y</span><span class="op" id="3129877">.</span><span class="ident" id="3129878">high</span><span class="op" id="3129882">}</span><br>
<span class="lineno"></span><span class="op" id="3129884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129887">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3129959">func</span>&nbsp;<span class="ident" id="3129964">gcmDouble</span><span class="op" id="3129973">(</span><span class="ident" id="3129974">x</span>&nbsp;<span class="op" id="3129976">*</span><span class="ident" id="3129977">gcmFieldElement</span><span class="op" id="3129992">)</span>&nbsp;<span class="op" id="3129994">(</span><span class="ident" id="3129995">double</span>&nbsp;<span class="ident" id="3130002">gcmFieldElement</span><span class="op" id="3130017">)</span>&nbsp;<span class="op" id="3130019">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130022">msbSet</span>&nbsp;<span class="op" id="3130029">:=</span>&nbsp;<span class="ident" id="3130032">x</span><span class="op" id="3130033">.</span><span class="ident" id="3130034">high</span><span class="op" id="3130038">&amp;</span><span class="num" id="3130039">1</span>&nbsp;<span class="op" id="3130041">==</span>&nbsp;<span class="num" id="3130044">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130048">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130117">double</span><span class="op" id="3130123">.</span><span class="ident" id="3130124">high</span>&nbsp;<span class="op" id="3130129">=</span>&nbsp;<span class="ident" id="3130131">x</span><span class="op" id="3130132">.</span><span class="ident" id="3130133">high</span>&nbsp;<span class="op" id="3130138">&gt;&gt;</span>&nbsp;<span class="num" id="3130141">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130144">double</span><span class="op" id="3130150">.</span><span class="ident" id="3130151">high</span>&nbsp;<span class="op" id="3130156">|=</span>&nbsp;<span class="ident" id="3130159">x</span><span class="op" id="3130160">.</span><span class="ident" id="3130161">low</span>&nbsp;<span class="op" id="3130165">&lt;&lt;</span>&nbsp;<span class="num" id="3130168">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130172">double</span><span class="op" id="3130178">.</span><span class="ident" id="3130179">low</span>&nbsp;<span class="op" id="3130183">=</span>&nbsp;<span class="ident" id="3130185">x</span><span class="op" id="3130186">.</span><span class="ident" id="3130187">low</span>&nbsp;<span class="op" id="3130191">&gt;&gt;</span>&nbsp;<span class="num" id="3130194">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130198">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130263">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130331">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130395">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130468">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130539">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3130610">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130619">if</span>&nbsp;<span class="ident" id="3130622">msbSet</span>&nbsp;<span class="op" id="3130629">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3130633">double</span><span class="op" id="3130639">.</span><span class="ident" id="3130640">low</span>&nbsp;<span class="op" id="3130644">^=</span>&nbsp;<span class="num" id="3130647">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3130667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130671">return</span><br>
<span class="lineno"></span><span class="op" id="3130678">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3130681">var</span>&nbsp;<span class="ident" id="3130685">gcmReductionTable</span>&nbsp;<span class="op" id="3130703">=</span>&nbsp;<span class="op" id="3130705">[</span><span class="op" id="3130706">]</span><span class="builtintype" id="3130707">uint16</span><span class="op" id="3130713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3130716">0x0000</span><span class="op" id="3130722">,</span>&nbsp;<span class="num" id="3130724">0x1c20</span><span class="op" id="3130730">,</span>&nbsp;<span class="num" id="3130732">0x3840</span><span class="op" id="3130738">,</span>&nbsp;<span class="num" id="3130740">0x2460</span><span class="op" id="3130746">,</span>&nbsp;<span class="num" id="3130748">0x7080</span><span class="op" id="3130754">,</span>&nbsp;<span class="num" id="3130756">0x6ca0</span><span class="op" id="3130762">,</span>&nbsp;<span class="num" id="3130764">0x48c0</span><span class="op" id="3130770">,</span>&nbsp;<span class="num" id="3130772">0x54e0</span><span class="op" id="3130778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3130781">0xe100</span><span class="op" id="3130787">,</span>&nbsp;<span class="num" id="3130789">0xfd20</span><span class="op" id="3130795">,</span>&nbsp;<span class="num" id="3130797">0xd940</span><span class="op" id="3130803">,</span>&nbsp;<span class="num" id="3130805">0xc560</span><span class="op" id="3130811">,</span>&nbsp;<span class="num" id="3130813">0x9180</span><span class="op" id="3130819">,</span>&nbsp;<span class="num" id="3130821">0x8da0</span><span class="op" id="3130827">,</span>&nbsp;<span class="num" id="3130829">0xa9c0</span><span class="op" id="3130835">,</span>&nbsp;<span class="num" id="3130837">0xb5e0</span><span class="op" id="3130843">,</span><br>
<span class="lineno"></span><span class="op" id="3130845">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3130848">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3130915">func</span>&nbsp;<span class="op" id="3130920">(</span><span class="ident" id="3130921">g</span>&nbsp;<span class="op" id="3130923">*</span><span class="ident" id="3130924">gcm</span><span class="op" id="3130927">)</span>&nbsp;<span class="ident" id="3130929">mul</span><span class="op" id="3130932">(</span><span class="ident" id="3130933">y</span>&nbsp;<span class="op" id="3130935">*</span><span class="ident" id="3130936">gcmFieldElement</span><span class="op" id="3130951">)</span>&nbsp;<span class="op" id="3130953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130956">var</span>&nbsp;<span class="ident" id="3130960">z</span>&nbsp;<span class="ident" id="3130962">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3130980">for</span>&nbsp;<span class="ident" id="3130984">i</span>&nbsp;<span class="op" id="3130986">:=</span>&nbsp;<span class="num" id="3130989">0</span><span class="op" id="3130990">;</span>&nbsp;<span class="ident" id="3130992">i</span>&nbsp;<span class="op" id="3130994">&lt;</span>&nbsp;<span class="num" id="3130996">2</span><span class="op" id="3130997">;</span>&nbsp;<span class="ident" id="3130999">i</span><span class="op" id="3131000">++</span>&nbsp;<span class="op" id="3131003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131007">word</span>&nbsp;<span class="op" id="3131012">:=</span>&nbsp;<span class="ident" id="3131015">y</span><span class="op" id="3131016">.</span><span class="ident" id="3131017">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3131024">if</span>&nbsp;<span class="ident" id="3131027">i</span>&nbsp;<span class="op" id="3131029">==</span>&nbsp;<span class="num" id="3131032">1</span>&nbsp;<span class="op" id="3131034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131039">word</span>&nbsp;<span class="op" id="3131044">=</span>&nbsp;<span class="ident" id="3131046">y</span><span class="op" id="3131047">.</span><span class="ident" id="3131048">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131054">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131059">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131122">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3131166">for</span>&nbsp;<span class="ident" id="3131170">j</span>&nbsp;<span class="op" id="3131172">:=</span>&nbsp;<span class="num" id="3131175">0</span><span class="op" id="3131176">;</span>&nbsp;<span class="ident" id="3131178">j</span>&nbsp;<span class="op" id="3131180">&lt;</span>&nbsp;<span class="num" id="3131182">64</span><span class="op" id="3131184">;</span>&nbsp;<span class="ident" id="3131186">j</span>&nbsp;<span class="op" id="3131188">+=</span>&nbsp;<span class="num" id="3131191">4</span>&nbsp;<span class="op" id="3131193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131198">msw</span>&nbsp;<span class="op" id="3131202">:=</span>&nbsp;<span class="ident" id="3131205">z</span><span class="op" id="3131206">.</span><span class="ident" id="3131207">high</span>&nbsp;<span class="op" id="3131212">&amp;</span>&nbsp;<span class="num" id="3131214">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131221">z</span><span class="op" id="3131222">.</span><span class="ident" id="3131223">high</span>&nbsp;<span class="op" id="3131228">&gt;&gt;=</span>&nbsp;<span class="num" id="3131232">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131237">z</span><span class="op" id="3131238">.</span><span class="ident" id="3131239">high</span>&nbsp;<span class="op" id="3131244">|=</span>&nbsp;<span class="ident" id="3131247">z</span><span class="op" id="3131248">.</span><span class="ident" id="3131249">low</span>&nbsp;<span class="op" id="3131253">&lt;&lt;</span>&nbsp;<span class="num" id="3131256">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131262">z</span><span class="op" id="3131263">.</span><span class="ident" id="3131264">low</span>&nbsp;<span class="op" id="3131268">&gt;&gt;=</span>&nbsp;<span class="num" id="3131272">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131277">z</span><span class="op" id="3131278">.</span><span class="ident" id="3131279">low</span>&nbsp;<span class="op" id="3131283">^=</span>&nbsp;<span class="ident" id="3131286">uint64</span><span class="op" id="3131292">(</span><span class="ident" id="3131293">gcmReductionTable</span><span class="op" id="3131310">[</span><span class="ident" id="3131311">msw</span><span class="op" id="3131314">]</span><span class="op" id="3131315">)</span>&nbsp;<span class="op" id="3131317">&lt;&lt;</span>&nbsp;<span class="num" id="3131320">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131327">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131371">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3131422">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131439">t</span>&nbsp;<span class="op" id="3131441">:=</span>&nbsp;<span class="op" id="3131444">&amp;</span><span class="ident" id="3131445">g</span><span class="op" id="3131446">.</span><span class="ident" id="3131447">productTable</span><span class="op" id="3131459">[</span><span class="ident" id="3131460">word</span><span class="op" id="3131464">&amp;</span><span class="num" id="3131465">0xf</span><span class="op" id="3131468">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131474">z</span><span class="op" id="3131475">.</span><span class="ident" id="3131476">low</span>&nbsp;<span class="op" id="3131480">^=</span>&nbsp;<span class="ident" id="3131483">t</span><span class="op" id="3131484">.</span><span class="ident" id="3131485">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131492">z</span><span class="op" id="3131493">.</span><span class="ident" id="3131494">high</span>&nbsp;<span class="op" id="3131499">^=</span>&nbsp;<span class="ident" id="3131502">t</span><span class="op" id="3131503">.</span><span class="ident" id="3131504">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131512">word</span>&nbsp;<span class="op" id="3131517">&gt;&gt;=</span>&nbsp;<span class="num" id="3131521">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131528">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131532">*</span><span class="ident" id="3131533">y</span>&nbsp;<span class="op" id="3131535">=</span>&nbsp;<span class="ident" id="3131537">z</span><br>
<span class="lineno"></span><span class="op" id="3131539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3131542">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3131617">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3131693">func</span>&nbsp;<span class="op" id="3131698">(</span><span class="ident" id="3131699">g</span>&nbsp;<span class="op" id="3131701">*</span><span class="ident" id="3131702">gcm</span><span class="op" id="3131705">)</span>&nbsp;<span class="ident" id="3131707">updateBlocks</span><span class="op" id="3131719">(</span><span class="ident" id="3131720">y</span>&nbsp;<span class="op" id="3131722">*</span><span class="ident" id="3131723">gcmFieldElement</span><span class="op" id="3131738">,</span>&nbsp;<span class="ident" id="3131740">blocks</span>&nbsp;<span class="op" id="3131747">[</span><span class="op" id="3131748">]</span><span class="builtintype" id="3131749">byte</span><span class="op" id="3131753">)</span>&nbsp;<span class="op" id="3131755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3131758">for</span>&nbsp;<span class="builtinfunc" id="3131762">len</span><span class="op" id="3131765">(</span><span class="ident" id="3131766">blocks</span><span class="op" id="3131772">)</span>&nbsp;<span class="op" id="3131774">&gt;</span>&nbsp;<span class="num" id="3131776">0</span>&nbsp;<span class="op" id="3131778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131782">y</span><span class="op" id="3131783">.</span><span class="ident" id="3131784">low</span>&nbsp;<span class="op" id="3131788">^=</span>&nbsp;<span class="ident" id="3131791">getUint64</span><span class="op" id="3131800">(</span><span class="ident" id="3131801">blocks</span><span class="op" id="3131807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131811">y</span><span class="op" id="3131812">.</span><span class="ident" id="3131813">high</span>&nbsp;<span class="op" id="3131818">^=</span>&nbsp;<span class="ident" id="3131821">getUint64</span><span class="op" id="3131830">(</span><span class="ident" id="3131831">blocks</span><span class="op" id="3131837">[</span><span class="num" id="3131838">8</span><span class="op" id="3131839">:</span><span class="op" id="3131840">]</span><span class="op" id="3131841">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131845">g</span><span class="op" id="3131846">.</span><span class="ident" id="3131847">mul</span><span class="op" id="3131850">(</span><span class="ident" id="3131851">y</span><span class="op" id="3131852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3131856">blocks</span>&nbsp;<span class="op" id="3131863">=</span>&nbsp;<span class="ident" id="3131865">blocks</span><span class="op" id="3131871">[</span><span class="ident" id="3131872">gcmBlockSize</span><span class="op" id="3131884">:</span><span class="op" id="3131885">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3131888">}</span><br>
<span class="lineno"></span><span class="op" id="3131890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3131893">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3131968">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3132042">func</span>&nbsp;<span class="op" id="3132047">(</span><span class="ident" id="3132048">g</span>&nbsp;<span class="op" id="3132050">*</span><span class="ident" id="3132051">gcm</span><span class="op" id="3132054">)</span>&nbsp;<span class="ident" id="3132056">update</span><span class="op" id="3132062">(</span><span class="ident" id="3132063">y</span>&nbsp;<span class="op" id="3132065">*</span><span class="ident" id="3132066">gcmFieldElement</span><span class="op" id="3132081">,</span>&nbsp;<span class="ident" id="3132083">data</span>&nbsp;<span class="op" id="3132088">[</span><span class="op" id="3132089">]</span><span class="builtintype" id="3132090">byte</span><span class="op" id="3132094">)</span>&nbsp;<span class="op" id="3132096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132099">fullBlocks</span>&nbsp;<span class="op" id="3132110">:=</span>&nbsp;<span class="op" id="3132113">(</span><span class="builtinfunc" id="3132114">len</span><span class="op" id="3132117">(</span><span class="ident" id="3132118">data</span><span class="op" id="3132122">)</span>&nbsp;<span class="op" id="3132124">&gt;&gt;</span>&nbsp;<span class="num" id="3132127">4</span><span class="op" id="3132128">)</span>&nbsp;<span class="op" id="3132130">&lt;&lt;</span>&nbsp;<span class="num" id="3132133">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132136">g</span><span class="op" id="3132137">.</span><span class="ident" id="3132138">updateBlocks</span><span class="op" id="3132150">(</span><span class="ident" id="3132151">y</span><span class="op" id="3132152">,</span>&nbsp;<span class="ident" id="3132154">data</span><span class="op" id="3132158">[</span><span class="op" id="3132159">:</span><span class="ident" id="3132160">fullBlocks</span><span class="op" id="3132170">]</span><span class="op" id="3132171">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132175">if</span>&nbsp;<span class="builtinfunc" id="3132178">len</span><span class="op" id="3132181">(</span><span class="ident" id="3132182">data</span><span class="op" id="3132186">)</span>&nbsp;<span class="op" id="3132188">!=</span>&nbsp;<span class="ident" id="3132191">fullBlocks</span>&nbsp;<span class="op" id="3132202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132206">var</span>&nbsp;<span class="ident" id="3132210">partialBlock</span>&nbsp;<span class="op" id="3132223">[</span><span class="ident" id="3132224">gcmBlockSize</span><span class="op" id="3132236">]</span><span class="builtintype" id="3132237">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3132244">copy</span><span class="op" id="3132248">(</span><span class="ident" id="3132249">partialBlock</span><span class="op" id="3132261">[</span><span class="op" id="3132262">:</span><span class="op" id="3132263">]</span><span class="op" id="3132264">,</span>&nbsp;<span class="ident" id="3132266">data</span><span class="op" id="3132270">[</span><span class="ident" id="3132271">fullBlocks</span><span class="op" id="3132281">:</span><span class="op" id="3132282">]</span><span class="op" id="3132283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132287">g</span><span class="op" id="3132288">.</span><span class="ident" id="3132289">updateBlocks</span><span class="op" id="3132301">(</span><span class="ident" id="3132302">y</span><span class="op" id="3132303">,</span>&nbsp;<span class="ident" id="3132305">partialBlock</span><span class="op" id="3132317">[</span><span class="op" id="3132318">:</span><span class="op" id="3132319">]</span><span class="op" id="3132320">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3132323">}</span><br>
<span class="lineno"></span><span class="op" id="3132325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132328">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3132406">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3132428">func</span>&nbsp;<span class="ident" id="3132433">gcmInc32</span><span class="op" id="3132441">(</span><span class="ident" id="3132442">counterBlock</span>&nbsp;<span class="op" id="3132455">*</span><span class="op" id="3132456">[</span><span class="num" id="3132457">16</span><span class="op" id="3132459">]</span><span class="builtintype" id="3132460">byte</span><span class="op" id="3132464">)</span>&nbsp;<span class="op" id="3132466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132469">for</span>&nbsp;<span class="ident" id="3132473">i</span>&nbsp;<span class="op" id="3132475">:=</span>&nbsp;<span class="ident" id="3132478">gcmBlockSize</span>&nbsp;<span class="op" id="3132491">-</span>&nbsp;<span class="num" id="3132493">1</span><span class="op" id="3132494">;</span>&nbsp;<span class="ident" id="3132496">i</span>&nbsp;<span class="op" id="3132498">&gt;=</span>&nbsp;<span class="ident" id="3132501">gcmBlockSize</span><span class="op" id="3132513">-</span><span class="num" id="3132514">4</span><span class="op" id="3132515">;</span>&nbsp;<span class="ident" id="3132517">i</span><span class="op" id="3132518">--</span>&nbsp;<span class="op" id="3132521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3132525">counterBlock</span><span class="op" id="3132537">[</span><span class="ident" id="3132538">i</span><span class="op" id="3132539">]</span><span class="op" id="3132540">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132545">if</span>&nbsp;<span class="ident" id="3132548">counterBlock</span><span class="op" id="3132560">[</span><span class="ident" id="3132561">i</span><span class="op" id="3132562">]</span>&nbsp;<span class="op" id="3132564">!=</span>&nbsp;<span class="num" id="3132567">0</span>&nbsp;<span class="op" id="3132569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132574">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3132582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3132585">}</span><br>
<span class="lineno"></span><span class="op" id="3132587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132590">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3132668">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3132748">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3132827">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3132902">func</span>&nbsp;<span class="ident" id="3132907">sliceForAppend</span><span class="op" id="3132921">(</span><span class="ident" id="3132922">in</span>&nbsp;<span class="op" id="3132925">[</span><span class="op" id="3132926">]</span><span class="builtintype" id="3132927">byte</span><span class="op" id="3132931">,</span>&nbsp;<span class="ident" id="3132933">n</span>&nbsp;<span class="builtintype" id="3132935">int</span><span class="op" id="3132938">)</span>&nbsp;<span class="op" id="3132940">(</span><span class="ident" id="3132941">head</span><span class="op" id="3132945">,</span>&nbsp;<span class="ident" id="3132947">tail</span>&nbsp;<span class="op" id="3132952">[</span><span class="op" id="3132953">]</span><span class="builtintype" id="3132954">byte</span><span class="op" id="3132958">)</span>&nbsp;<span class="op" id="3132960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3132963">if</span>&nbsp;<span class="ident" id="3132966">total</span>&nbsp;<span class="op" id="3132972">:=</span>&nbsp;<span class="builtinfunc" id="3132975">len</span><span class="op" id="3132978">(</span><span class="ident" id="3132979">in</span><span class="op" id="3132981">)</span>&nbsp;<span class="op" id="3132983">+</span>&nbsp;<span class="ident" id="3132985">n</span><span class="op" id="3132986">;</span>&nbsp;<span class="builtinfunc" id="3132988">cap</span><span class="op" id="3132991">(</span><span class="ident" id="3132992">in</span><span class="op" id="3132994">)</span>&nbsp;<span class="op" id="3132996">&gt;=</span>&nbsp;<span class="ident" id="3132999">total</span>&nbsp;<span class="op" id="3133005">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133009">head</span>&nbsp;<span class="op" id="3133014">=</span>&nbsp;<span class="ident" id="3133016">in</span><span class="op" id="3133018">[</span><span class="op" id="3133019">:</span><span class="ident" id="3133020">total</span><span class="op" id="3133025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133028">}</span>&nbsp;<span class="keyword" id="3133030">else</span>&nbsp;<span class="op" id="3133035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133039">head</span>&nbsp;<span class="op" id="3133044">=</span>&nbsp;<span class="builtinfunc" id="3133046">make</span><span class="op" id="3133050">(</span><span class="op" id="3133051">[</span><span class="op" id="3133052">]</span><span class="builtintype" id="3133053">byte</span><span class="op" id="3133057">,</span>&nbsp;<span class="ident" id="3133059">total</span><span class="op" id="3133064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3133068">copy</span><span class="op" id="3133072">(</span><span class="ident" id="3133073">head</span><span class="op" id="3133077">,</span>&nbsp;<span class="ident" id="3133079">in</span><span class="op" id="3133081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133084">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133087">tail</span>&nbsp;<span class="op" id="3133092">=</span>&nbsp;<span class="ident" id="3133094">head</span><span class="op" id="3133098">[</span><span class="builtinfunc" id="3133099">len</span><span class="op" id="3133102">(</span><span class="ident" id="3133103">in</span><span class="op" id="3133105">)</span><span class="op" id="3133106">:</span><span class="op" id="3133107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133110">return</span><br>
<span class="lineno"></span><span class="op" id="3133117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133120">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3133185">func</span>&nbsp;<span class="op" id="3133190">(</span><span class="ident" id="3133191">g</span>&nbsp;<span class="op" id="3133193">*</span><span class="ident" id="3133194">gcm</span><span class="op" id="3133197">)</span>&nbsp;<span class="ident" id="3133199">counterCrypt</span><span class="op" id="3133211">(</span><span class="ident" id="3133212">out</span><span class="op" id="3133215">,</span>&nbsp;<span class="ident" id="3133217">in</span>&nbsp;<span class="op" id="3133220">[</span><span class="op" id="3133221">]</span><span class="builtintype" id="3133222">byte</span><span class="op" id="3133226">,</span>&nbsp;<span class="ident" id="3133228">counter</span>&nbsp;<span class="op" id="3133236">*</span><span class="op" id="3133237">[</span><span class="ident" id="3133238">gcmBlockSize</span><span class="op" id="3133250">]</span><span class="builtintype" id="3133251">byte</span><span class="op" id="3133255">)</span>&nbsp;<span class="op" id="3133257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133260">var</span>&nbsp;<span class="ident" id="3133264">mask</span>&nbsp;<span class="op" id="3133269">[</span><span class="ident" id="3133270">gcmBlockSize</span><span class="op" id="3133282">]</span><span class="builtintype" id="3133283">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133290">for</span>&nbsp;<span class="builtinfunc" id="3133294">len</span><span class="op" id="3133297">(</span><span class="ident" id="3133298">in</span><span class="op" id="3133300">)</span>&nbsp;<span class="op" id="3133302">&gt;=</span>&nbsp;<span class="ident" id="3133305">gcmBlockSize</span>&nbsp;<span class="op" id="3133318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133322">g</span><span class="op" id="3133323">.</span><span class="ident" id="3133324">cipher</span><span class="op" id="3133330">.</span><span class="ident" id="3133331">Encrypt</span><span class="op" id="3133338">(</span><span class="ident" id="3133339">mask</span><span class="op" id="3133343">[</span><span class="op" id="3133344">:</span><span class="op" id="3133345">]</span><span class="op" id="3133346">,</span>&nbsp;<span class="ident" id="3133348">counter</span><span class="op" id="3133355">[</span><span class="op" id="3133356">:</span><span class="op" id="3133357">]</span><span class="op" id="3133358">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133362">gcmInc32</span><span class="op" id="3133370">(</span><span class="ident" id="3133371">counter</span><span class="op" id="3133378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133383">xorWords</span><span class="op" id="3133391">(</span><span class="ident" id="3133392">out</span><span class="op" id="3133395">,</span>&nbsp;<span class="ident" id="3133397">in</span><span class="op" id="3133399">,</span>&nbsp;<span class="ident" id="3133401">mask</span><span class="op" id="3133405">[</span><span class="op" id="3133406">:</span><span class="op" id="3133407">]</span><span class="op" id="3133408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133412">out</span>&nbsp;<span class="op" id="3133416">=</span>&nbsp;<span class="ident" id="3133418">out</span><span class="op" id="3133421">[</span><span class="ident" id="3133422">gcmBlockSize</span><span class="op" id="3133434">:</span><span class="op" id="3133435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133439">in</span>&nbsp;<span class="op" id="3133442">=</span>&nbsp;<span class="ident" id="3133444">in</span><span class="op" id="3133446">[</span><span class="ident" id="3133447">gcmBlockSize</span><span class="op" id="3133459">:</span><span class="op" id="3133460">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133467">if</span>&nbsp;<span class="builtinfunc" id="3133470">len</span><span class="op" id="3133473">(</span><span class="ident" id="3133474">in</span><span class="op" id="3133476">)</span>&nbsp;<span class="op" id="3133478">&gt;</span>&nbsp;<span class="num" id="3133480">0</span>&nbsp;<span class="op" id="3133482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133486">g</span><span class="op" id="3133487">.</span><span class="ident" id="3133488">cipher</span><span class="op" id="3133494">.</span><span class="ident" id="3133495">Encrypt</span><span class="op" id="3133502">(</span><span class="ident" id="3133503">mask</span><span class="op" id="3133507">[</span><span class="op" id="3133508">:</span><span class="op" id="3133509">]</span><span class="op" id="3133510">,</span>&nbsp;<span class="ident" id="3133512">counter</span><span class="op" id="3133519">[</span><span class="op" id="3133520">:</span><span class="op" id="3133521">]</span><span class="op" id="3133522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133526">gcmInc32</span><span class="op" id="3133534">(</span><span class="ident" id="3133535">counter</span><span class="op" id="3133542">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133546">xorBytes</span><span class="op" id="3133554">(</span><span class="ident" id="3133555">out</span><span class="op" id="3133558">,</span>&nbsp;<span class="ident" id="3133560">in</span><span class="op" id="3133562">,</span>&nbsp;<span class="ident" id="3133564">mask</span><span class="op" id="3133568">[</span><span class="op" id="3133569">:</span><span class="op" id="3133570">]</span><span class="op" id="3133571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3133574">}</span><br>
<span class="lineno"></span><span class="op" id="3133576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133579">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3133655">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3133696">func</span>&nbsp;<span class="op" id="3133701">(</span><span class="ident" id="3133702">g</span>&nbsp;<span class="op" id="3133704">*</span><span class="ident" id="3133705">gcm</span><span class="op" id="3133708">)</span>&nbsp;<span class="ident" id="3133710">auth</span><span class="op" id="3133714">(</span><span class="ident" id="3133715">out</span><span class="op" id="3133718">,</span>&nbsp;<span class="ident" id="3133720">ciphertext</span><span class="op" id="3133730">,</span>&nbsp;<span class="ident" id="3133732">additionalData</span>&nbsp;<span class="op" id="3133747">[</span><span class="op" id="3133748">]</span><span class="builtintype" id="3133749">byte</span><span class="op" id="3133753">,</span>&nbsp;<span class="ident" id="3133755">tagMask</span>&nbsp;<span class="op" id="3133763">*</span><span class="op" id="3133764">[</span><span class="ident" id="3133765">gcmTagSize</span><span class="op" id="3133775">]</span><span class="builtintype" id="3133776">byte</span><span class="op" id="3133780">)</span>&nbsp;<span class="op" id="3133782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3133785">var</span>&nbsp;<span class="ident" id="3133789">y</span>&nbsp;<span class="ident" id="3133791">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133808">g</span><span class="op" id="3133809">.</span><span class="ident" id="3133810">update</span><span class="op" id="3133816">(</span><span class="op" id="3133817">&amp;</span><span class="ident" id="3133818">y</span><span class="op" id="3133819">,</span>&nbsp;<span class="ident" id="3133821">additionalData</span><span class="op" id="3133835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133838">g</span><span class="op" id="3133839">.</span><span class="ident" id="3133840">update</span><span class="op" id="3133846">(</span><span class="op" id="3133847">&amp;</span><span class="ident" id="3133848">y</span><span class="op" id="3133849">,</span>&nbsp;<span class="ident" id="3133851">ciphertext</span><span class="op" id="3133861">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133865">y</span><span class="op" id="3133866">.</span><span class="ident" id="3133867">low</span>&nbsp;<span class="op" id="3133871">^=</span>&nbsp;<span class="ident" id="3133874">uint64</span><span class="op" id="3133880">(</span><span class="builtinfunc" id="3133881">len</span><span class="op" id="3133884">(</span><span class="ident" id="3133885">additionalData</span><span class="op" id="3133899">)</span><span class="op" id="3133900">)</span>&nbsp;<span class="op" id="3133902">*</span>&nbsp;<span class="num" id="3133904">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133907">y</span><span class="op" id="3133908">.</span><span class="ident" id="3133909">high</span>&nbsp;<span class="op" id="3133914">^=</span>&nbsp;<span class="ident" id="3133917">uint64</span><span class="op" id="3133923">(</span><span class="builtinfunc" id="3133924">len</span><span class="op" id="3133927">(</span><span class="ident" id="3133928">ciphertext</span><span class="op" id="3133938">)</span><span class="op" id="3133939">)</span>&nbsp;<span class="op" id="3133941">*</span>&nbsp;<span class="num" id="3133943">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133947">g</span><span class="op" id="3133948">.</span><span class="ident" id="3133949">mul</span><span class="op" id="3133952">(</span><span class="op" id="3133953">&amp;</span><span class="ident" id="3133954">y</span><span class="op" id="3133955">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133959">putUint64</span><span class="op" id="3133968">(</span><span class="ident" id="3133969">out</span><span class="op" id="3133972">,</span>&nbsp;<span class="ident" id="3133974">y</span><span class="op" id="3133975">.</span><span class="ident" id="3133976">low</span><span class="op" id="3133979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3133982">putUint64</span><span class="op" id="3133991">(</span><span class="ident" id="3133992">out</span><span class="op" id="3133995">[</span><span class="num" id="3133996">8</span><span class="op" id="3133997">:</span><span class="op" id="3133998">]</span><span class="op" id="3133999">,</span>&nbsp;<span class="ident" id="3134001">y</span><span class="op" id="3134002">.</span><span class="ident" id="3134003">high</span><span class="op" id="3134007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134011">xorWords</span><span class="op" id="3134019">(</span><span class="ident" id="3134020">out</span><span class="op" id="3134023">,</span>&nbsp;<span class="ident" id="3134025">out</span><span class="op" id="3134028">,</span>&nbsp;<span class="ident" id="3134030">tagMask</span><span class="op" id="3134037">[</span><span class="op" id="3134038">:</span><span class="op" id="3134039">]</span><span class="op" id="3134040">)</span><br>
<span class="lineno">320</span><span class="op" id="3134042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134045">func</span>&nbsp;<span class="ident" id="3134050">getUint64</span><span class="op" id="3134059">(</span><span class="ident" id="3134060">data</span>&nbsp;<span class="op" id="3134065">[</span><span class="op" id="3134066">]</span><span class="builtintype" id="3134067">byte</span><span class="op" id="3134071">)</span>&nbsp;<span class="ident" id="3134073">uint64</span>&nbsp;<span class="op" id="3134080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134083">r</span>&nbsp;<span class="op" id="3134085">:=</span>&nbsp;<span class="ident" id="3134088">uint64</span><span class="op" id="3134094">(</span><span class="ident" id="3134095">data</span><span class="op" id="3134099">[</span><span class="num" id="3134100">0</span><span class="op" id="3134101">]</span><span class="op" id="3134102">)</span><span class="op" id="3134103">&lt;&lt;</span><span class="num" id="3134105">56</span>&nbsp;<span class="op" id="3134108">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134112">uint64</span><span class="op" id="3134118">(</span><span class="ident" id="3134119">data</span><span class="op" id="3134123">[</span><span class="num" id="3134124">1</span><span class="op" id="3134125">]</span><span class="op" id="3134126">)</span><span class="op" id="3134127">&lt;&lt;</span><span class="num" id="3134129">48</span>&nbsp;<span class="op" id="3134132">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134136">uint64</span><span class="op" id="3134142">(</span><span class="ident" id="3134143">data</span><span class="op" id="3134147">[</span><span class="num" id="3134148">2</span><span class="op" id="3134149">]</span><span class="op" id="3134150">)</span><span class="op" id="3134151">&lt;&lt;</span><span class="num" id="3134153">40</span>&nbsp;<span class="op" id="3134156">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134160">uint64</span><span class="op" id="3134166">(</span><span class="ident" id="3134167">data</span><span class="op" id="3134171">[</span><span class="num" id="3134172">3</span><span class="op" id="3134173">]</span><span class="op" id="3134174">)</span><span class="op" id="3134175">&lt;&lt;</span><span class="num" id="3134177">32</span>&nbsp;<span class="op" id="3134180">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134184">uint64</span><span class="op" id="3134190">(</span><span class="ident" id="3134191">data</span><span class="op" id="3134195">[</span><span class="num" id="3134196">4</span><span class="op" id="3134197">]</span><span class="op" id="3134198">)</span><span class="op" id="3134199">&lt;&lt;</span><span class="num" id="3134201">24</span>&nbsp;<span class="op" id="3134204">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134208">uint64</span><span class="op" id="3134214">(</span><span class="ident" id="3134215">data</span><span class="op" id="3134219">[</span><span class="num" id="3134220">5</span><span class="op" id="3134221">]</span><span class="op" id="3134222">)</span><span class="op" id="3134223">&lt;&lt;</span><span class="num" id="3134225">16</span>&nbsp;<span class="op" id="3134228">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134232">uint64</span><span class="op" id="3134238">(</span><span class="ident" id="3134239">data</span><span class="op" id="3134243">[</span><span class="num" id="3134244">6</span><span class="op" id="3134245">]</span><span class="op" id="3134246">)</span><span class="op" id="3134247">&lt;&lt;</span><span class="num" id="3134249">8</span>&nbsp;<span class="op" id="3134251">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134255">uint64</span><span class="op" id="3134261">(</span><span class="ident" id="3134262">data</span><span class="op" id="3134266">[</span><span class="num" id="3134267">7</span><span class="op" id="3134268">]</span><span class="op" id="3134269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3134272">return</span>&nbsp;<span class="ident" id="3134279">r</span><br>
<span class="lineno"></span><span class="op" id="3134281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3134284">func</span>&nbsp;<span class="ident" id="3134289">putUint64</span><span class="op" id="3134298">(</span><span class="ident" id="3134299">out</span>&nbsp;<span class="op" id="3134303">[</span><span class="op" id="3134304">]</span><span class="builtintype" id="3134305">byte</span><span class="op" id="3134309">,</span>&nbsp;<span class="ident" id="3134311">v</span>&nbsp;<span class="ident" id="3134313">uint64</span><span class="op" id="3134319">)</span>&nbsp;<span class="op" id="3134321">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134324">out</span><span class="op" id="3134327">[</span><span class="num" id="3134328">0</span><span class="op" id="3134329">]</span>&nbsp;<span class="op" id="3134331">=</span>&nbsp;<span class="builtintype" id="3134333">byte</span><span class="op" id="3134337">(</span><span class="ident" id="3134338">v</span>&nbsp;<span class="op" id="3134340">&gt;&gt;</span>&nbsp;<span class="num" id="3134343">56</span><span class="op" id="3134345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134348">out</span><span class="op" id="3134351">[</span><span class="num" id="3134352">1</span><span class="op" id="3134353">]</span>&nbsp;<span class="op" id="3134355">=</span>&nbsp;<span class="builtintype" id="3134357">byte</span><span class="op" id="3134361">(</span><span class="ident" id="3134362">v</span>&nbsp;<span class="op" id="3134364">&gt;&gt;</span>&nbsp;<span class="num" id="3134367">48</span><span class="op" id="3134369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134372">out</span><span class="op" id="3134375">[</span><span class="num" id="3134376">2</span><span class="op" id="3134377">]</span>&nbsp;<span class="op" id="3134379">=</span>&nbsp;<span class="builtintype" id="3134381">byte</span><span class="op" id="3134385">(</span><span class="ident" id="3134386">v</span>&nbsp;<span class="op" id="3134388">&gt;&gt;</span>&nbsp;<span class="num" id="3134391">40</span><span class="op" id="3134393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134396">out</span><span class="op" id="3134399">[</span><span class="num" id="3134400">3</span><span class="op" id="3134401">]</span>&nbsp;<span class="op" id="3134403">=</span>&nbsp;<span class="builtintype" id="3134405">byte</span><span class="op" id="3134409">(</span><span class="ident" id="3134410">v</span>&nbsp;<span class="op" id="3134412">&gt;&gt;</span>&nbsp;<span class="num" id="3134415">32</span><span class="op" id="3134417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134420">out</span><span class="op" id="3134423">[</span><span class="num" id="3134424">4</span><span class="op" id="3134425">]</span>&nbsp;<span class="op" id="3134427">=</span>&nbsp;<span class="builtintype" id="3134429">byte</span><span class="op" id="3134433">(</span><span class="ident" id="3134434">v</span>&nbsp;<span class="op" id="3134436">&gt;&gt;</span>&nbsp;<span class="num" id="3134439">24</span><span class="op" id="3134441">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134444">out</span><span class="op" id="3134447">[</span><span class="num" id="3134448">5</span><span class="op" id="3134449">]</span>&nbsp;<span class="op" id="3134451">=</span>&nbsp;<span class="builtintype" id="3134453">byte</span><span class="op" id="3134457">(</span><span class="ident" id="3134458">v</span>&nbsp;<span class="op" id="3134460">&gt;&gt;</span>&nbsp;<span class="num" id="3134463">16</span><span class="op" id="3134465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134468">out</span><span class="op" id="3134471">[</span><span class="num" id="3134472">6</span><span class="op" id="3134473">]</span>&nbsp;<span class="op" id="3134475">=</span>&nbsp;<span class="builtintype" id="3134477">byte</span><span class="op" id="3134481">(</span><span class="ident" id="3134482">v</span>&nbsp;<span class="op" id="3134484">&gt;&gt;</span>&nbsp;<span class="num" id="3134487">8</span><span class="op" id="3134488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3134491">out</span><span class="op" id="3134494">[</span><span class="num" id="3134495">7</span><span class="op" id="3134496">]</span>&nbsp;<span class="op" id="3134498">=</span>&nbsp;<span class="builtintype" id="3134500">byte</span><span class="op" id="3134504">(</span><span class="ident" id="3134505">v</span><span class="op" id="3134506">)</span><br>
<span class="lineno"></span><span class="op" id="3134508">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
