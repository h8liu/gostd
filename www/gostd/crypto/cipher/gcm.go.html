<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html" class="current">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3584393">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3584448">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3584502">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3584553">package</span>&nbsp;<span class="ident" id="3584561">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3584569">import</span>&nbsp;<span class="op" id="3584576">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3584579">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3584596">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3584605">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3584608">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3584684">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3584693">type</span>&nbsp;<span class="ident" id="3584698">AEAD</span>&nbsp;<span class="keyword" id="3584703">interface</span>&nbsp;<span class="op" id="3584713">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584716">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584788">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584802">NonceSize</span><span class="op" id="3584811">(</span><span class="op" id="3584812">)</span>&nbsp;<span class="builtintype" id="3584814">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584820">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584889">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3584919">Overhead</span><span class="op" id="3584927">(</span><span class="op" id="3584928">)</span>&nbsp;<span class="builtintype" id="3584930">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3584936">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585001">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585074">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585145">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585172">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585176">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585235">Seal</span><span class="op" id="3585239">(</span><span class="ident" id="3585240">dst</span><span class="op" id="3585243">,</span>&nbsp;<span class="ident" id="3585245">nonce</span><span class="op" id="3585250">,</span>&nbsp;<span class="ident" id="3585252">plaintext</span><span class="op" id="3585261">,</span>&nbsp;<span class="ident" id="3585263">data</span>&nbsp;<span class="op" id="3585268">[</span><span class="op" id="3585269">]</span><span class="builtintype" id="3585270">byte</span><span class="op" id="3585274">)</span>&nbsp;<span class="op" id="3585276">[</span><span class="op" id="3585277">]</span><span class="builtintype" id="3585278">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585285">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585351">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585423">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585494">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585560">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585586">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3585590">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3585650">Open</span><span class="op" id="3585654">(</span><span class="ident" id="3585655">dst</span><span class="op" id="3585658">,</span>&nbsp;<span class="ident" id="3585660">nonce</span><span class="op" id="3585665">,</span>&nbsp;<span class="ident" id="3585667">ciphertext</span><span class="op" id="3585677">,</span>&nbsp;<span class="ident" id="3585679">data</span>&nbsp;<span class="op" id="3585684">[</span><span class="op" id="3585685">]</span><span class="builtintype" id="3585686">byte</span><span class="op" id="3585690">)</span>&nbsp;<span class="op" id="3585692">(</span><span class="op" id="3585693">[</span><span class="op" id="3585694">]</span><span class="builtintype" id="3585695">byte</span><span class="op" id="3585699">,</span>&nbsp;<span class="builtintype" id="3585701">error</span><span class="op" id="3585706">)</span><br>
<span class="lineno"></span><span class="op" id="3585708">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3585711">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3585794">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3585872">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3585910">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3585971">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3586032">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3586097">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3586161">type</span>&nbsp;<span class="ident" id="3586166">gcmFieldElement</span>&nbsp;<span class="keyword" id="3586182">struct</span>&nbsp;<span class="op" id="3586189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586192">low</span><span class="op" id="3586195">,</span>&nbsp;<span class="ident" id="3586197">high</span>&nbsp;<span class="ident" id="3586202">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3586209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586212">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3586277">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3586372">type</span>&nbsp;<span class="ident" id="3586377">gcm</span>&nbsp;<span class="keyword" id="3586381">struct</span>&nbsp;<span class="op" id="3586388">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586391">cipher</span>&nbsp;<span class="ident" id="3586398">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586405">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586471">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586528">productTable</span>&nbsp;<span class="op" id="3586541">[</span><span class="num" id="3586542">16</span><span class="op" id="3586544">]</span><span class="ident" id="3586545">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3586561">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3586564">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3586646">func</span>&nbsp;<span class="ident" id="3586651">NewGCM</span><span class="op" id="3586657">(</span><span class="ident" id="3586658">cipher</span>&nbsp;<span class="ident" id="3586665">Block</span><span class="op" id="3586670">)</span>&nbsp;<span class="op" id="3586672">(</span><span class="ident" id="3586673">AEAD</span><span class="op" id="3586677">,</span>&nbsp;<span class="builtintype" id="3586679">error</span><span class="op" id="3586684">)</span>&nbsp;<span class="op" id="3586686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586689">if</span>&nbsp;<span class="ident" id="3586692">cipher</span><span class="op" id="3586698">.</span><span class="ident" id="3586699">BlockSize</span><span class="op" id="3586708">(</span><span class="op" id="3586709">)</span>&nbsp;<span class="op" id="3586711">!=</span>&nbsp;<span class="ident" id="3586714">gcmBlockSize</span>&nbsp;<span class="op" id="3586727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586731">return</span>&nbsp;<span class="builtintype" id="3586738">nil</span><span class="op" id="3586741">,</span>&nbsp;<span class="ident" id="3586743">errors</span><span class="op" id="3586749">.</span><span class="ident" id="3586750">New</span><span class="op" id="3586753">(</span><span class="string" id="3586754">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3586800">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3586807">var</span>&nbsp;<span class="ident" id="3586811">key</span>&nbsp;<span class="op" id="3586815">[</span><span class="ident" id="3586816">gcmBlockSize</span><span class="op" id="3586828">]</span><span class="builtintype" id="3586829">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586835">cipher</span><span class="op" id="3586841">.</span><span class="ident" id="3586842">Encrypt</span><span class="op" id="3586849">(</span><span class="ident" id="3586850">key</span><span class="op" id="3586853">[</span><span class="op" id="3586854">:</span><span class="op" id="3586855">]</span><span class="op" id="3586856">,</span>&nbsp;<span class="ident" id="3586858">key</span><span class="op" id="3586861">[</span><span class="op" id="3586862">:</span><span class="op" id="3586863">]</span><span class="op" id="3586864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3586868">g</span>&nbsp;<span class="op" id="3586870">:=</span>&nbsp;<span class="op" id="3586873">&amp;</span><span class="ident" id="3586874">gcm</span><span class="op" id="3586877">{</span><span class="ident" id="3586878">cipher</span><span class="op" id="3586884">:</span>&nbsp;<span class="ident" id="3586886">cipher</span><span class="op" id="3586892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586896">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3586965">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587030">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587099">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587169">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587239">x</span>&nbsp;<span class="op" id="3587241">:=</span>&nbsp;<span class="ident" id="3587244">gcmFieldElement</span><span class="op" id="3587259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587263">getUint64</span><span class="op" id="3587272">(</span><span class="ident" id="3587273">key</span><span class="op" id="3587276">[</span><span class="op" id="3587277">:</span><span class="num" id="3587278">8</span><span class="op" id="3587279">]</span><span class="op" id="3587280">)</span><span class="op" id="3587281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587285">getUint64</span><span class="op" id="3587294">(</span><span class="ident" id="3587295">key</span><span class="op" id="3587298">[</span><span class="num" id="3587299">8</span><span class="op" id="3587300">:</span><span class="op" id="3587301">]</span><span class="op" id="3587302">)</span><span class="op" id="3587303">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587309">g</span><span class="op" id="3587310">.</span><span class="ident" id="3587311">productTable</span><span class="op" id="3587323">[</span><span class="ident" id="3587324">reverseBits</span><span class="op" id="3587335">(</span><span class="num" id="3587336">1</span><span class="op" id="3587337">)</span><span class="op" id="3587338">]</span>&nbsp;<span class="op" id="3587340">=</span>&nbsp;<span class="ident" id="3587342">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587346">for</span>&nbsp;<span class="ident" id="3587350">i</span>&nbsp;<span class="op" id="3587352">:=</span>&nbsp;<span class="num" id="3587355">2</span><span class="op" id="3587356">;</span>&nbsp;<span class="ident" id="3587358">i</span>&nbsp;<span class="op" id="3587360">&lt;</span>&nbsp;<span class="num" id="3587362">16</span><span class="op" id="3587364">;</span>&nbsp;<span class="ident" id="3587366">i</span>&nbsp;<span class="op" id="3587368">+=</span>&nbsp;<span class="num" id="3587371">2</span>&nbsp;<span class="op" id="3587373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587377">g</span><span class="op" id="3587378">.</span><span class="ident" id="3587379">productTable</span><span class="op" id="3587391">[</span><span class="ident" id="3587392">reverseBits</span><span class="op" id="3587403">(</span><span class="ident" id="3587404">i</span><span class="op" id="3587405">)</span><span class="op" id="3587406">]</span>&nbsp;<span class="op" id="3587408">=</span>&nbsp;<span class="ident" id="3587410">gcmDouble</span><span class="op" id="3587419">(</span><span class="op" id="3587420">&amp;</span><span class="ident" id="3587421">g</span><span class="op" id="3587422">.</span><span class="ident" id="3587423">productTable</span><span class="op" id="3587435">[</span><span class="ident" id="3587436">reverseBits</span><span class="op" id="3587447">(</span><span class="ident" id="3587448">i</span><span class="op" id="3587449">/</span><span class="num" id="3587450">2</span><span class="op" id="3587451">)</span><span class="op" id="3587452">]</span><span class="op" id="3587453">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587457">g</span><span class="op" id="3587458">.</span><span class="ident" id="3587459">productTable</span><span class="op" id="3587471">[</span><span class="ident" id="3587472">reverseBits</span><span class="op" id="3587483">(</span><span class="ident" id="3587484">i</span><span class="op" id="3587485">+</span><span class="num" id="3587486">1</span><span class="op" id="3587487">)</span><span class="op" id="3587488">]</span>&nbsp;<span class="op" id="3587490">=</span>&nbsp;<span class="ident" id="3587492">gcmAdd</span><span class="op" id="3587498">(</span><span class="op" id="3587499">&amp;</span><span class="ident" id="3587500">g</span><span class="op" id="3587501">.</span><span class="ident" id="3587502">productTable</span><span class="op" id="3587514">[</span><span class="ident" id="3587515">reverseBits</span><span class="op" id="3587526">(</span><span class="ident" id="3587527">i</span><span class="op" id="3587528">)</span><span class="op" id="3587529">]</span><span class="op" id="3587530">,</span>&nbsp;<span class="op" id="3587532">&amp;</span><span class="ident" id="3587533">x</span><span class="op" id="3587534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587541">return</span>&nbsp;<span class="ident" id="3587548">g</span><span class="op" id="3587549">,</span>&nbsp;<span class="builtintype" id="3587551">nil</span><br>
<span class="lineno"></span><span class="op" id="3587555">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3587558">const</span>&nbsp;<span class="op" id="3587564">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587567">gcmBlockSize</span>&nbsp;<span class="op" id="3587580">=</span>&nbsp;<span class="num" id="3587582">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587586">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3587599">=</span>&nbsp;<span class="num" id="3587601">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587605">gcmNonceSize</span>&nbsp;<span class="op" id="3587618">=</span>&nbsp;<span class="num" id="3587620">12</span><br>
<span class="lineno">95</span><span class="op" id="3587623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3587626">func</span>&nbsp;<span class="op" id="3587631">(</span><span class="op" id="3587632">*</span><span class="ident" id="3587633">gcm</span><span class="op" id="3587636">)</span>&nbsp;<span class="ident" id="3587638">NonceSize</span><span class="op" id="3587647">(</span><span class="op" id="3587648">)</span>&nbsp;<span class="builtintype" id="3587650">int</span>&nbsp;<span class="op" id="3587654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587657">return</span>&nbsp;<span class="ident" id="3587664">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3587677">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3587680">func</span>&nbsp;<span class="op" id="3587685">(</span><span class="op" id="3587686">*</span><span class="ident" id="3587687">gcm</span><span class="op" id="3587690">)</span>&nbsp;<span class="ident" id="3587692">Overhead</span><span class="op" id="3587700">(</span><span class="op" id="3587701">)</span>&nbsp;<span class="builtintype" id="3587703">int</span>&nbsp;<span class="op" id="3587707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587710">return</span>&nbsp;<span class="ident" id="3587717">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3587728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3587731">func</span>&nbsp;<span class="op" id="3587736">(</span><span class="ident" id="3587737">g</span>&nbsp;<span class="op" id="3587739">*</span><span class="ident" id="3587740">gcm</span><span class="op" id="3587743">)</span>&nbsp;<span class="ident" id="3587745">Seal</span><span class="op" id="3587749">(</span><span class="ident" id="3587750">dst</span><span class="op" id="3587753">,</span>&nbsp;<span class="ident" id="3587755">nonce</span><span class="op" id="3587760">,</span>&nbsp;<span class="ident" id="3587762">plaintext</span><span class="op" id="3587771">,</span>&nbsp;<span class="ident" id="3587773">data</span>&nbsp;<span class="op" id="3587778">[</span><span class="op" id="3587779">]</span><span class="builtintype" id="3587780">byte</span><span class="op" id="3587784">)</span>&nbsp;<span class="op" id="3587786">[</span><span class="op" id="3587787">]</span><span class="builtintype" id="3587788">byte</span>&nbsp;<span class="op" id="3587793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587796">if</span>&nbsp;<span class="builtinfunc" id="3587799">len</span><span class="op" id="3587802">(</span><span class="ident" id="3587803">nonce</span><span class="op" id="3587808">)</span>&nbsp;<span class="op" id="3587810">!=</span>&nbsp;<span class="ident" id="3587813">gcmNonceSize</span>&nbsp;<span class="op" id="3587826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3587830">panic</span><span class="op" id="3587835">(</span><span class="string" id="3587836">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3587881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3587884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3587888">ret</span><span class="op" id="3587891">,</span>&nbsp;<span class="ident" id="3587893">out</span>&nbsp;<span class="op" id="3587897">:=</span>&nbsp;<span class="ident" id="3587900">sliceForAppend</span><span class="op" id="3587914">(</span><span class="ident" id="3587915">dst</span><span class="op" id="3587918">,</span>&nbsp;<span class="builtinfunc" id="3587920">len</span><span class="op" id="3587923">(</span><span class="ident" id="3587924">plaintext</span><span class="op" id="3587933">)</span><span class="op" id="3587934">+</span><span class="ident" id="3587935">gcmTagSize</span><span class="op" id="3587945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3587949">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3587980">var</span>&nbsp;<span class="ident" id="3587984">counter</span><span class="op" id="3587991">,</span>&nbsp;<span class="ident" id="3587993">tagMask</span>&nbsp;<span class="op" id="3588001">[</span><span class="ident" id="3588002">gcmBlockSize</span><span class="op" id="3588014">]</span><span class="builtintype" id="3588015">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3588021">copy</span><span class="op" id="3588025">(</span><span class="ident" id="3588026">counter</span><span class="op" id="3588033">[</span><span class="op" id="3588034">:</span><span class="op" id="3588035">]</span><span class="op" id="3588036">,</span>&nbsp;<span class="ident" id="3588038">nonce</span><span class="op" id="3588043">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588046">counter</span><span class="op" id="3588053">[</span><span class="ident" id="3588054">gcmBlockSize</span><span class="op" id="3588066">-</span><span class="num" id="3588067">1</span><span class="op" id="3588068">]</span>&nbsp;<span class="op" id="3588070">=</span>&nbsp;<span class="num" id="3588072">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588076">g</span><span class="op" id="3588077">.</span><span class="ident" id="3588078">cipher</span><span class="op" id="3588084">.</span><span class="ident" id="3588085">Encrypt</span><span class="op" id="3588092">(</span><span class="ident" id="3588093">tagMask</span><span class="op" id="3588100">[</span><span class="op" id="3588101">:</span><span class="op" id="3588102">]</span><span class="op" id="3588103">,</span>&nbsp;<span class="ident" id="3588105">counter</span><span class="op" id="3588112">[</span><span class="op" id="3588113">:</span><span class="op" id="3588114">]</span><span class="op" id="3588115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588118">gcmInc32</span><span class="op" id="3588126">(</span><span class="op" id="3588127">&amp;</span><span class="ident" id="3588128">counter</span><span class="op" id="3588135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588139">g</span><span class="op" id="3588140">.</span><span class="ident" id="3588141">counterCrypt</span><span class="op" id="3588153">(</span><span class="ident" id="3588154">out</span><span class="op" id="3588157">,</span>&nbsp;<span class="ident" id="3588159">plaintext</span><span class="op" id="3588168">,</span>&nbsp;<span class="op" id="3588170">&amp;</span><span class="ident" id="3588171">counter</span><span class="op" id="3588178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588181">g</span><span class="op" id="3588182">.</span><span class="ident" id="3588183">auth</span><span class="op" id="3588187">(</span><span class="ident" id="3588188">out</span><span class="op" id="3588191">[</span><span class="builtinfunc" id="3588192">len</span><span class="op" id="3588195">(</span><span class="ident" id="3588196">plaintext</span><span class="op" id="3588205">)</span><span class="op" id="3588206">:</span><span class="op" id="3588207">]</span><span class="op" id="3588208">,</span>&nbsp;<span class="ident" id="3588210">out</span><span class="op" id="3588213">[</span><span class="op" id="3588214">:</span><span class="builtinfunc" id="3588215">len</span><span class="op" id="3588218">(</span><span class="ident" id="3588219">plaintext</span><span class="op" id="3588228">)</span><span class="op" id="3588229">]</span><span class="op" id="3588230">,</span>&nbsp;<span class="ident" id="3588232">data</span><span class="op" id="3588236">,</span>&nbsp;<span class="op" id="3588238">&amp;</span><span class="ident" id="3588239">tagMask</span><span class="op" id="3588246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588250">return</span>&nbsp;<span class="ident" id="3588257">ret</span><br>
<span class="lineno"></span><span class="op" id="3588261">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3588264">var</span>&nbsp;<span class="ident" id="3588268">errOpen</span>&nbsp;<span class="op" id="3588276">=</span>&nbsp;<span class="ident" id="3588278">errors</span><span class="op" id="3588284">.</span><span class="ident" id="3588285">New</span><span class="op" id="3588288">(</span><span class="string" id="3588289">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3588328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3588331">func</span>&nbsp;<span class="op" id="3588336">(</span><span class="ident" id="3588337">g</span>&nbsp;<span class="op" id="3588339">*</span><span class="ident" id="3588340">gcm</span><span class="op" id="3588343">)</span>&nbsp;<span class="ident" id="3588345">Open</span><span class="op" id="3588349">(</span><span class="ident" id="3588350">dst</span><span class="op" id="3588353">,</span>&nbsp;<span class="ident" id="3588355">nonce</span><span class="op" id="3588360">,</span>&nbsp;<span class="ident" id="3588362">ciphertext</span><span class="op" id="3588372">,</span>&nbsp;<span class="ident" id="3588374">data</span>&nbsp;<span class="op" id="3588379">[</span><span class="op" id="3588380">]</span><span class="builtintype" id="3588381">byte</span><span class="op" id="3588385">)</span>&nbsp;<span class="op" id="3588387">(</span><span class="op" id="3588388">[</span><span class="op" id="3588389">]</span><span class="builtintype" id="3588390">byte</span><span class="op" id="3588394">,</span>&nbsp;<span class="builtintype" id="3588396">error</span><span class="op" id="3588401">)</span>&nbsp;<span class="op" id="3588403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588406">if</span>&nbsp;<span class="builtinfunc" id="3588409">len</span><span class="op" id="3588412">(</span><span class="ident" id="3588413">nonce</span><span class="op" id="3588418">)</span>&nbsp;<span class="op" id="3588420">!=</span>&nbsp;<span class="ident" id="3588423">gcmNonceSize</span>&nbsp;<span class="op" id="3588436">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3588440">panic</span><span class="op" id="3588445">(</span><span class="string" id="3588446">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3588491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588498">if</span>&nbsp;<span class="builtinfunc" id="3588501">len</span><span class="op" id="3588504">(</span><span class="ident" id="3588505">ciphertext</span><span class="op" id="3588515">)</span>&nbsp;<span class="op" id="3588517">&lt;</span>&nbsp;<span class="ident" id="3588519">gcmTagSize</span>&nbsp;<span class="op" id="3588530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588534">return</span>&nbsp;<span class="builtintype" id="3588541">nil</span><span class="op" id="3588544">,</span>&nbsp;<span class="ident" id="3588546">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3588555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588558">tag</span>&nbsp;<span class="op" id="3588562">:=</span>&nbsp;<span class="ident" id="3588565">ciphertext</span><span class="op" id="3588575">[</span><span class="builtinfunc" id="3588576">len</span><span class="op" id="3588579">(</span><span class="ident" id="3588580">ciphertext</span><span class="op" id="3588590">)</span><span class="op" id="3588591">-</span><span class="ident" id="3588592">gcmTagSize</span><span class="op" id="3588602">:</span><span class="op" id="3588603">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588606">ciphertext</span>&nbsp;<span class="op" id="3588617">=</span>&nbsp;<span class="ident" id="3588619">ciphertext</span><span class="op" id="3588629">[</span><span class="op" id="3588630">:</span><span class="builtinfunc" id="3588631">len</span><span class="op" id="3588634">(</span><span class="ident" id="3588635">ciphertext</span><span class="op" id="3588645">)</span><span class="op" id="3588646">-</span><span class="ident" id="3588647">gcmTagSize</span><span class="op" id="3588657">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3588661">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588692">var</span>&nbsp;<span class="ident" id="3588696">counter</span><span class="op" id="3588703">,</span>&nbsp;<span class="ident" id="3588705">tagMask</span>&nbsp;<span class="op" id="3588713">[</span><span class="ident" id="3588714">gcmBlockSize</span><span class="op" id="3588726">]</span><span class="builtintype" id="3588727">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3588733">copy</span><span class="op" id="3588737">(</span><span class="ident" id="3588738">counter</span><span class="op" id="3588745">[</span><span class="op" id="3588746">:</span><span class="op" id="3588747">]</span><span class="op" id="3588748">,</span>&nbsp;<span class="ident" id="3588750">nonce</span><span class="op" id="3588755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588758">counter</span><span class="op" id="3588765">[</span><span class="ident" id="3588766">gcmBlockSize</span><span class="op" id="3588778">-</span><span class="num" id="3588779">1</span><span class="op" id="3588780">]</span>&nbsp;<span class="op" id="3588782">=</span>&nbsp;<span class="num" id="3588784">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588788">g</span><span class="op" id="3588789">.</span><span class="ident" id="3588790">cipher</span><span class="op" id="3588796">.</span><span class="ident" id="3588797">Encrypt</span><span class="op" id="3588804">(</span><span class="ident" id="3588805">tagMask</span><span class="op" id="3588812">[</span><span class="op" id="3588813">:</span><span class="op" id="3588814">]</span><span class="op" id="3588815">,</span>&nbsp;<span class="ident" id="3588817">counter</span><span class="op" id="3588824">[</span><span class="op" id="3588825">:</span><span class="op" id="3588826">]</span><span class="op" id="3588827">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588830">gcmInc32</span><span class="op" id="3588838">(</span><span class="op" id="3588839">&amp;</span><span class="ident" id="3588840">counter</span><span class="op" id="3588847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588851">var</span>&nbsp;<span class="ident" id="3588855">expectedTag</span>&nbsp;<span class="op" id="3588867">[</span><span class="ident" id="3588868">gcmTagSize</span><span class="op" id="3588878">]</span><span class="builtintype" id="3588879">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588885">g</span><span class="op" id="3588886">.</span><span class="ident" id="3588887">auth</span><span class="op" id="3588891">(</span><span class="ident" id="3588892">expectedTag</span><span class="op" id="3588903">[</span><span class="op" id="3588904">:</span><span class="op" id="3588905">]</span><span class="op" id="3588906">,</span>&nbsp;<span class="ident" id="3588908">ciphertext</span><span class="op" id="3588918">,</span>&nbsp;<span class="ident" id="3588920">data</span><span class="op" id="3588924">,</span>&nbsp;<span class="op" id="3588926">&amp;</span><span class="ident" id="3588927">tagMask</span><span class="op" id="3588934">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588938">if</span>&nbsp;<span class="ident" id="3588941">subtle</span><span class="op" id="3588947">.</span><span class="ident" id="3588948">ConstantTimeCompare</span><span class="op" id="3588967">(</span><span class="ident" id="3588968">expectedTag</span><span class="op" id="3588979">[</span><span class="op" id="3588980">:</span><span class="op" id="3588981">]</span><span class="op" id="3588982">,</span>&nbsp;<span class="ident" id="3588984">tag</span><span class="op" id="3588987">)</span>&nbsp;<span class="op" id="3588989">!=</span>&nbsp;<span class="num" id="3588992">1</span>&nbsp;<span class="op" id="3588994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3588998">return</span>&nbsp;<span class="builtintype" id="3589005">nil</span><span class="op" id="3589008">,</span>&nbsp;<span class="ident" id="3589010">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589023">ret</span><span class="op" id="3589026">,</span>&nbsp;<span class="ident" id="3589028">out</span>&nbsp;<span class="op" id="3589032">:=</span>&nbsp;<span class="ident" id="3589035">sliceForAppend</span><span class="op" id="3589049">(</span><span class="ident" id="3589050">dst</span><span class="op" id="3589053">,</span>&nbsp;<span class="builtinfunc" id="3589055">len</span><span class="op" id="3589058">(</span><span class="ident" id="3589059">ciphertext</span><span class="op" id="3589069">)</span><span class="op" id="3589070">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589073">g</span><span class="op" id="3589074">.</span><span class="ident" id="3589075">counterCrypt</span><span class="op" id="3589087">(</span><span class="ident" id="3589088">out</span><span class="op" id="3589091">,</span>&nbsp;<span class="ident" id="3589093">ciphertext</span><span class="op" id="3589103">,</span>&nbsp;<span class="op" id="3589105">&amp;</span><span class="ident" id="3589106">counter</span><span class="op" id="3589113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589117">return</span>&nbsp;<span class="ident" id="3589124">ret</span><span class="op" id="3589127">,</span>&nbsp;<span class="builtintype" id="3589129">nil</span><br>
<span class="lineno"></span><span class="op" id="3589133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3589136">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3589204">func</span>&nbsp;<span class="ident" id="3589209">reverseBits</span><span class="op" id="3589220">(</span><span class="ident" id="3589221">i</span>&nbsp;<span class="builtintype" id="3589223">int</span><span class="op" id="3589226">)</span>&nbsp;<span class="builtintype" id="3589228">int</span>&nbsp;<span class="op" id="3589232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589235">i</span>&nbsp;<span class="op" id="3589237">=</span>&nbsp;<span class="op" id="3589239">(</span><span class="op" id="3589240">(</span><span class="ident" id="3589241">i</span>&nbsp;<span class="op" id="3589243">&lt;&lt;</span>&nbsp;<span class="num" id="3589246">2</span><span class="op" id="3589247">)</span>&nbsp;<span class="op" id="3589249">&amp;</span>&nbsp;<span class="num" id="3589251">0xc</span><span class="op" id="3589254">)</span>&nbsp;<span class="op" id="3589256">|</span>&nbsp;<span class="op" id="3589258">(</span><span class="op" id="3589259">(</span><span class="ident" id="3589260">i</span>&nbsp;<span class="op" id="3589262">&gt;&gt;</span>&nbsp;<span class="num" id="3589265">2</span><span class="op" id="3589266">)</span>&nbsp;<span class="op" id="3589268">&amp;</span>&nbsp;<span class="num" id="3589270">0x3</span><span class="op" id="3589273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589276">i</span>&nbsp;<span class="op" id="3589278">=</span>&nbsp;<span class="op" id="3589280">(</span><span class="op" id="3589281">(</span><span class="ident" id="3589282">i</span>&nbsp;<span class="op" id="3589284">&lt;&lt;</span>&nbsp;<span class="num" id="3589287">1</span><span class="op" id="3589288">)</span>&nbsp;<span class="op" id="3589290">&amp;</span>&nbsp;<span class="num" id="3589292">0xa</span><span class="op" id="3589295">)</span>&nbsp;<span class="op" id="3589297">|</span>&nbsp;<span class="op" id="3589299">(</span><span class="op" id="3589300">(</span><span class="ident" id="3589301">i</span>&nbsp;<span class="op" id="3589303">&gt;&gt;</span>&nbsp;<span class="num" id="3589306">1</span><span class="op" id="3589307">)</span>&nbsp;<span class="op" id="3589309">&amp;</span>&nbsp;<span class="num" id="3589311">0x5</span><span class="op" id="3589314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589317">return</span>&nbsp;<span class="ident" id="3589324">i</span><br>
<span class="lineno">165</span><span class="op" id="3589326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3589329">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3589394">func</span>&nbsp;<span class="ident" id="3589399">gcmAdd</span><span class="op" id="3589405">(</span><span class="ident" id="3589406">x</span><span class="op" id="3589407">,</span>&nbsp;<span class="ident" id="3589409">y</span>&nbsp;<span class="op" id="3589411">*</span><span class="ident" id="3589412">gcmFieldElement</span><span class="op" id="3589427">)</span>&nbsp;<span class="ident" id="3589429">gcmFieldElement</span>&nbsp;<span class="op" id="3589445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589448">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3589502">return</span>&nbsp;<span class="ident" id="3589509">gcmFieldElement</span><span class="op" id="3589524">{</span><span class="ident" id="3589525">x</span><span class="op" id="3589526">.</span><span class="ident" id="3589527">low</span>&nbsp;<span class="op" id="3589531">^</span>&nbsp;<span class="ident" id="3589533">y</span><span class="op" id="3589534">.</span><span class="ident" id="3589535">low</span><span class="op" id="3589538">,</span>&nbsp;<span class="ident" id="3589540">x</span><span class="op" id="3589541">.</span><span class="ident" id="3589542">high</span>&nbsp;<span class="op" id="3589547">^</span>&nbsp;<span class="ident" id="3589549">y</span><span class="op" id="3589550">.</span><span class="ident" id="3589551">high</span><span class="op" id="3589555">}</span><br>
<span class="lineno"></span><span class="op" id="3589557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3589560">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3589632">func</span>&nbsp;<span class="ident" id="3589637">gcmDouble</span><span class="op" id="3589646">(</span><span class="ident" id="3589647">x</span>&nbsp;<span class="op" id="3589649">*</span><span class="ident" id="3589650">gcmFieldElement</span><span class="op" id="3589665">)</span>&nbsp;<span class="op" id="3589667">(</span><span class="ident" id="3589668">double</span>&nbsp;<span class="ident" id="3589675">gcmFieldElement</span><span class="op" id="3589690">)</span>&nbsp;<span class="op" id="3589692">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589695">msbSet</span>&nbsp;<span class="op" id="3589702">:=</span>&nbsp;<span class="ident" id="3589705">x</span><span class="op" id="3589706">.</span><span class="ident" id="3589707">high</span><span class="op" id="3589711">&amp;</span><span class="num" id="3589712">1</span>&nbsp;<span class="op" id="3589714">==</span>&nbsp;<span class="num" id="3589717">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589721">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589790">double</span><span class="op" id="3589796">.</span><span class="ident" id="3589797">high</span>&nbsp;<span class="op" id="3589802">=</span>&nbsp;<span class="ident" id="3589804">x</span><span class="op" id="3589805">.</span><span class="ident" id="3589806">high</span>&nbsp;<span class="op" id="3589811">&gt;&gt;</span>&nbsp;<span class="num" id="3589814">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589817">double</span><span class="op" id="3589823">.</span><span class="ident" id="3589824">high</span>&nbsp;<span class="op" id="3589829">|=</span>&nbsp;<span class="ident" id="3589832">x</span><span class="op" id="3589833">.</span><span class="ident" id="3589834">low</span>&nbsp;<span class="op" id="3589838">&lt;&lt;</span>&nbsp;<span class="num" id="3589841">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3589845">double</span><span class="op" id="3589851">.</span><span class="ident" id="3589852">low</span>&nbsp;<span class="op" id="3589856">=</span>&nbsp;<span class="ident" id="3589858">x</span><span class="op" id="3589859">.</span><span class="ident" id="3589860">low</span>&nbsp;<span class="op" id="3589864">&gt;&gt;</span>&nbsp;<span class="num" id="3589867">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589871">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3589936">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590004">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590068">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590141">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590212">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590283">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590292">if</span>&nbsp;<span class="ident" id="3590295">msbSet</span>&nbsp;<span class="op" id="3590302">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590306">double</span><span class="op" id="3590312">.</span><span class="ident" id="3590313">low</span>&nbsp;<span class="op" id="3590317">^=</span>&nbsp;<span class="num" id="3590320">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590344">return</span><br>
<span class="lineno"></span><span class="op" id="3590351">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3590354">var</span>&nbsp;<span class="ident" id="3590358">gcmReductionTable</span>&nbsp;<span class="op" id="3590376">=</span>&nbsp;<span class="op" id="3590378">[</span><span class="op" id="3590379">]</span><span class="builtintype" id="3590380">uint16</span><span class="op" id="3590386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3590389">0x0000</span><span class="op" id="3590395">,</span>&nbsp;<span class="num" id="3590397">0x1c20</span><span class="op" id="3590403">,</span>&nbsp;<span class="num" id="3590405">0x3840</span><span class="op" id="3590411">,</span>&nbsp;<span class="num" id="3590413">0x2460</span><span class="op" id="3590419">,</span>&nbsp;<span class="num" id="3590421">0x7080</span><span class="op" id="3590427">,</span>&nbsp;<span class="num" id="3590429">0x6ca0</span><span class="op" id="3590435">,</span>&nbsp;<span class="num" id="3590437">0x48c0</span><span class="op" id="3590443">,</span>&nbsp;<span class="num" id="3590445">0x54e0</span><span class="op" id="3590451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3590454">0xe100</span><span class="op" id="3590460">,</span>&nbsp;<span class="num" id="3590462">0xfd20</span><span class="op" id="3590468">,</span>&nbsp;<span class="num" id="3590470">0xd940</span><span class="op" id="3590476">,</span>&nbsp;<span class="num" id="3590478">0xc560</span><span class="op" id="3590484">,</span>&nbsp;<span class="num" id="3590486">0x9180</span><span class="op" id="3590492">,</span>&nbsp;<span class="num" id="3590494">0x8da0</span><span class="op" id="3590500">,</span>&nbsp;<span class="num" id="3590502">0xa9c0</span><span class="op" id="3590508">,</span>&nbsp;<span class="num" id="3590510">0xb5e0</span><span class="op" id="3590516">,</span><br>
<span class="lineno"></span><span class="op" id="3590518">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3590521">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3590588">func</span>&nbsp;<span class="op" id="3590593">(</span><span class="ident" id="3590594">g</span>&nbsp;<span class="op" id="3590596">*</span><span class="ident" id="3590597">gcm</span><span class="op" id="3590600">)</span>&nbsp;<span class="ident" id="3590602">mul</span><span class="op" id="3590605">(</span><span class="ident" id="3590606">y</span>&nbsp;<span class="op" id="3590608">*</span><span class="ident" id="3590609">gcmFieldElement</span><span class="op" id="3590624">)</span>&nbsp;<span class="op" id="3590626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590629">var</span>&nbsp;<span class="ident" id="3590633">z</span>&nbsp;<span class="ident" id="3590635">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590653">for</span>&nbsp;<span class="ident" id="3590657">i</span>&nbsp;<span class="op" id="3590659">:=</span>&nbsp;<span class="num" id="3590662">0</span><span class="op" id="3590663">;</span>&nbsp;<span class="ident" id="3590665">i</span>&nbsp;<span class="op" id="3590667">&lt;</span>&nbsp;<span class="num" id="3590669">2</span><span class="op" id="3590670">;</span>&nbsp;<span class="ident" id="3590672">i</span><span class="op" id="3590673">++</span>&nbsp;<span class="op" id="3590676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590680">word</span>&nbsp;<span class="op" id="3590685">:=</span>&nbsp;<span class="ident" id="3590688">y</span><span class="op" id="3590689">.</span><span class="ident" id="3590690">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590697">if</span>&nbsp;<span class="ident" id="3590700">i</span>&nbsp;<span class="op" id="3590702">==</span>&nbsp;<span class="num" id="3590705">1</span>&nbsp;<span class="op" id="3590707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590712">word</span>&nbsp;<span class="op" id="3590717">=</span>&nbsp;<span class="ident" id="3590719">y</span><span class="op" id="3590720">.</span><span class="ident" id="3590721">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590727">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590732">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3590795">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3590839">for</span>&nbsp;<span class="ident" id="3590843">j</span>&nbsp;<span class="op" id="3590845">:=</span>&nbsp;<span class="num" id="3590848">0</span><span class="op" id="3590849">;</span>&nbsp;<span class="ident" id="3590851">j</span>&nbsp;<span class="op" id="3590853">&lt;</span>&nbsp;<span class="num" id="3590855">64</span><span class="op" id="3590857">;</span>&nbsp;<span class="ident" id="3590859">j</span>&nbsp;<span class="op" id="3590861">+=</span>&nbsp;<span class="num" id="3590864">4</span>&nbsp;<span class="op" id="3590866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590871">msw</span>&nbsp;<span class="op" id="3590875">:=</span>&nbsp;<span class="ident" id="3590878">z</span><span class="op" id="3590879">.</span><span class="ident" id="3590880">high</span>&nbsp;<span class="op" id="3590885">&amp;</span>&nbsp;<span class="num" id="3590887">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590894">z</span><span class="op" id="3590895">.</span><span class="ident" id="3590896">high</span>&nbsp;<span class="op" id="3590901">&gt;&gt;=</span>&nbsp;<span class="num" id="3590905">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590910">z</span><span class="op" id="3590911">.</span><span class="ident" id="3590912">high</span>&nbsp;<span class="op" id="3590917">|=</span>&nbsp;<span class="ident" id="3590920">z</span><span class="op" id="3590921">.</span><span class="ident" id="3590922">low</span>&nbsp;<span class="op" id="3590926">&lt;&lt;</span>&nbsp;<span class="num" id="3590929">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590935">z</span><span class="op" id="3590936">.</span><span class="ident" id="3590937">low</span>&nbsp;<span class="op" id="3590941">&gt;&gt;=</span>&nbsp;<span class="num" id="3590945">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3590950">z</span><span class="op" id="3590951">.</span><span class="ident" id="3590952">low</span>&nbsp;<span class="op" id="3590956">^=</span>&nbsp;<span class="ident" id="3590959">uint64</span><span class="op" id="3590965">(</span><span class="ident" id="3590966">gcmReductionTable</span><span class="op" id="3590983">[</span><span class="ident" id="3590984">msw</span><span class="op" id="3590987">]</span><span class="op" id="3590988">)</span>&nbsp;<span class="op" id="3590990">&lt;&lt;</span>&nbsp;<span class="num" id="3590993">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591000">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591044">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3591095">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591112">t</span>&nbsp;<span class="op" id="3591114">:=</span>&nbsp;<span class="op" id="3591117">&amp;</span><span class="ident" id="3591118">g</span><span class="op" id="3591119">.</span><span class="ident" id="3591120">productTable</span><span class="op" id="3591132">[</span><span class="ident" id="3591133">word</span><span class="op" id="3591137">&amp;</span><span class="num" id="3591138">0xf</span><span class="op" id="3591141">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591147">z</span><span class="op" id="3591148">.</span><span class="ident" id="3591149">low</span>&nbsp;<span class="op" id="3591153">^=</span>&nbsp;<span class="ident" id="3591156">t</span><span class="op" id="3591157">.</span><span class="ident" id="3591158">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591165">z</span><span class="op" id="3591166">.</span><span class="ident" id="3591167">high</span>&nbsp;<span class="op" id="3591172">^=</span>&nbsp;<span class="ident" id="3591175">t</span><span class="op" id="3591176">.</span><span class="ident" id="3591177">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591185">word</span>&nbsp;<span class="op" id="3591190">&gt;&gt;=</span>&nbsp;<span class="num" id="3591194">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591201">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591205">*</span><span class="ident" id="3591206">y</span>&nbsp;<span class="op" id="3591208">=</span>&nbsp;<span class="ident" id="3591210">z</span><br>
<span class="lineno"></span><span class="op" id="3591212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3591215">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3591290">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3591366">func</span>&nbsp;<span class="op" id="3591371">(</span><span class="ident" id="3591372">g</span>&nbsp;<span class="op" id="3591374">*</span><span class="ident" id="3591375">gcm</span><span class="op" id="3591378">)</span>&nbsp;<span class="ident" id="3591380">updateBlocks</span><span class="op" id="3591392">(</span><span class="ident" id="3591393">y</span>&nbsp;<span class="op" id="3591395">*</span><span class="ident" id="3591396">gcmFieldElement</span><span class="op" id="3591411">,</span>&nbsp;<span class="ident" id="3591413">blocks</span>&nbsp;<span class="op" id="3591420">[</span><span class="op" id="3591421">]</span><span class="builtintype" id="3591422">byte</span><span class="op" id="3591426">)</span>&nbsp;<span class="op" id="3591428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591431">for</span>&nbsp;<span class="builtinfunc" id="3591435">len</span><span class="op" id="3591438">(</span><span class="ident" id="3591439">blocks</span><span class="op" id="3591445">)</span>&nbsp;<span class="op" id="3591447">&gt;</span>&nbsp;<span class="num" id="3591449">0</span>&nbsp;<span class="op" id="3591451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591455">y</span><span class="op" id="3591456">.</span><span class="ident" id="3591457">low</span>&nbsp;<span class="op" id="3591461">^=</span>&nbsp;<span class="ident" id="3591464">getUint64</span><span class="op" id="3591473">(</span><span class="ident" id="3591474">blocks</span><span class="op" id="3591480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591484">y</span><span class="op" id="3591485">.</span><span class="ident" id="3591486">high</span>&nbsp;<span class="op" id="3591491">^=</span>&nbsp;<span class="ident" id="3591494">getUint64</span><span class="op" id="3591503">(</span><span class="ident" id="3591504">blocks</span><span class="op" id="3591510">[</span><span class="num" id="3591511">8</span><span class="op" id="3591512">:</span><span class="op" id="3591513">]</span><span class="op" id="3591514">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591518">g</span><span class="op" id="3591519">.</span><span class="ident" id="3591520">mul</span><span class="op" id="3591523">(</span><span class="ident" id="3591524">y</span><span class="op" id="3591525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591529">blocks</span>&nbsp;<span class="op" id="3591536">=</span>&nbsp;<span class="ident" id="3591538">blocks</span><span class="op" id="3591544">[</span><span class="ident" id="3591545">gcmBlockSize</span><span class="op" id="3591557">:</span><span class="op" id="3591558">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591561">}</span><br>
<span class="lineno"></span><span class="op" id="3591563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3591566">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3591641">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3591715">func</span>&nbsp;<span class="op" id="3591720">(</span><span class="ident" id="3591721">g</span>&nbsp;<span class="op" id="3591723">*</span><span class="ident" id="3591724">gcm</span><span class="op" id="3591727">)</span>&nbsp;<span class="ident" id="3591729">update</span><span class="op" id="3591735">(</span><span class="ident" id="3591736">y</span>&nbsp;<span class="op" id="3591738">*</span><span class="ident" id="3591739">gcmFieldElement</span><span class="op" id="3591754">,</span>&nbsp;<span class="ident" id="3591756">data</span>&nbsp;<span class="op" id="3591761">[</span><span class="op" id="3591762">]</span><span class="builtintype" id="3591763">byte</span><span class="op" id="3591767">)</span>&nbsp;<span class="op" id="3591769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591772">fullBlocks</span>&nbsp;<span class="op" id="3591783">:=</span>&nbsp;<span class="op" id="3591786">(</span><span class="builtinfunc" id="3591787">len</span><span class="op" id="3591790">(</span><span class="ident" id="3591791">data</span><span class="op" id="3591795">)</span>&nbsp;<span class="op" id="3591797">&gt;&gt;</span>&nbsp;<span class="num" id="3591800">4</span><span class="op" id="3591801">)</span>&nbsp;<span class="op" id="3591803">&lt;&lt;</span>&nbsp;<span class="num" id="3591806">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591809">g</span><span class="op" id="3591810">.</span><span class="ident" id="3591811">updateBlocks</span><span class="op" id="3591823">(</span><span class="ident" id="3591824">y</span><span class="op" id="3591825">,</span>&nbsp;<span class="ident" id="3591827">data</span><span class="op" id="3591831">[</span><span class="op" id="3591832">:</span><span class="ident" id="3591833">fullBlocks</span><span class="op" id="3591843">]</span><span class="op" id="3591844">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591848">if</span>&nbsp;<span class="builtinfunc" id="3591851">len</span><span class="op" id="3591854">(</span><span class="ident" id="3591855">data</span><span class="op" id="3591859">)</span>&nbsp;<span class="op" id="3591861">!=</span>&nbsp;<span class="ident" id="3591864">fullBlocks</span>&nbsp;<span class="op" id="3591875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3591879">var</span>&nbsp;<span class="ident" id="3591883">partialBlock</span>&nbsp;<span class="op" id="3591896">[</span><span class="ident" id="3591897">gcmBlockSize</span><span class="op" id="3591909">]</span><span class="builtintype" id="3591910">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3591917">copy</span><span class="op" id="3591921">(</span><span class="ident" id="3591922">partialBlock</span><span class="op" id="3591934">[</span><span class="op" id="3591935">:</span><span class="op" id="3591936">]</span><span class="op" id="3591937">,</span>&nbsp;<span class="ident" id="3591939">data</span><span class="op" id="3591943">[</span><span class="ident" id="3591944">fullBlocks</span><span class="op" id="3591954">:</span><span class="op" id="3591955">]</span><span class="op" id="3591956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3591960">g</span><span class="op" id="3591961">.</span><span class="ident" id="3591962">updateBlocks</span><span class="op" id="3591974">(</span><span class="ident" id="3591975">y</span><span class="op" id="3591976">,</span>&nbsp;<span class="ident" id="3591978">partialBlock</span><span class="op" id="3591990">[</span><span class="op" id="3591991">:</span><span class="op" id="3591992">]</span><span class="op" id="3591993">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3591996">}</span><br>
<span class="lineno"></span><span class="op" id="3591998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592001">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3592079">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3592101">func</span>&nbsp;<span class="ident" id="3592106">gcmInc32</span><span class="op" id="3592114">(</span><span class="ident" id="3592115">counterBlock</span>&nbsp;<span class="op" id="3592128">*</span><span class="op" id="3592129">[</span><span class="num" id="3592130">16</span><span class="op" id="3592132">]</span><span class="builtintype" id="3592133">byte</span><span class="op" id="3592137">)</span>&nbsp;<span class="op" id="3592139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592142">for</span>&nbsp;<span class="ident" id="3592146">i</span>&nbsp;<span class="op" id="3592148">:=</span>&nbsp;<span class="ident" id="3592151">gcmBlockSize</span>&nbsp;<span class="op" id="3592164">-</span>&nbsp;<span class="num" id="3592166">1</span><span class="op" id="3592167">;</span>&nbsp;<span class="ident" id="3592169">i</span>&nbsp;<span class="op" id="3592171">&gt;=</span>&nbsp;<span class="ident" id="3592174">gcmBlockSize</span><span class="op" id="3592186">-</span><span class="num" id="3592187">4</span><span class="op" id="3592188">;</span>&nbsp;<span class="ident" id="3592190">i</span><span class="op" id="3592191">--</span>&nbsp;<span class="op" id="3592194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592198">counterBlock</span><span class="op" id="3592210">[</span><span class="ident" id="3592211">i</span><span class="op" id="3592212">]</span><span class="op" id="3592213">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592218">if</span>&nbsp;<span class="ident" id="3592221">counterBlock</span><span class="op" id="3592233">[</span><span class="ident" id="3592234">i</span><span class="op" id="3592235">]</span>&nbsp;<span class="op" id="3592237">!=</span>&nbsp;<span class="num" id="3592240">0</span>&nbsp;<span class="op" id="3592242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592247">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592258">}</span><br>
<span class="lineno"></span><span class="op" id="3592260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592263">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3592341">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3592421">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3592500">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3592575">func</span>&nbsp;<span class="ident" id="3592580">sliceForAppend</span><span class="op" id="3592594">(</span><span class="ident" id="3592595">in</span>&nbsp;<span class="op" id="3592598">[</span><span class="op" id="3592599">]</span><span class="builtintype" id="3592600">byte</span><span class="op" id="3592604">,</span>&nbsp;<span class="ident" id="3592606">n</span>&nbsp;<span class="builtintype" id="3592608">int</span><span class="op" id="3592611">)</span>&nbsp;<span class="op" id="3592613">(</span><span class="ident" id="3592614">head</span><span class="op" id="3592618">,</span>&nbsp;<span class="ident" id="3592620">tail</span>&nbsp;<span class="op" id="3592625">[</span><span class="op" id="3592626">]</span><span class="builtintype" id="3592627">byte</span><span class="op" id="3592631">)</span>&nbsp;<span class="op" id="3592633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592636">if</span>&nbsp;<span class="ident" id="3592639">total</span>&nbsp;<span class="op" id="3592645">:=</span>&nbsp;<span class="builtinfunc" id="3592648">len</span><span class="op" id="3592651">(</span><span class="ident" id="3592652">in</span><span class="op" id="3592654">)</span>&nbsp;<span class="op" id="3592656">+</span>&nbsp;<span class="ident" id="3592658">n</span><span class="op" id="3592659">;</span>&nbsp;<span class="builtinfunc" id="3592661">cap</span><span class="op" id="3592664">(</span><span class="ident" id="3592665">in</span><span class="op" id="3592667">)</span>&nbsp;<span class="op" id="3592669">&gt;=</span>&nbsp;<span class="ident" id="3592672">total</span>&nbsp;<span class="op" id="3592678">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592682">head</span>&nbsp;<span class="op" id="3592687">=</span>&nbsp;<span class="ident" id="3592689">in</span><span class="op" id="3592691">[</span><span class="op" id="3592692">:</span><span class="ident" id="3592693">total</span><span class="op" id="3592698">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592701">}</span>&nbsp;<span class="keyword" id="3592703">else</span>&nbsp;<span class="op" id="3592708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592712">head</span>&nbsp;<span class="op" id="3592717">=</span>&nbsp;<span class="builtinfunc" id="3592719">make</span><span class="op" id="3592723">(</span><span class="op" id="3592724">[</span><span class="op" id="3592725">]</span><span class="builtintype" id="3592726">byte</span><span class="op" id="3592730">,</span>&nbsp;<span class="ident" id="3592732">total</span><span class="op" id="3592737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3592741">copy</span><span class="op" id="3592745">(</span><span class="ident" id="3592746">head</span><span class="op" id="3592750">,</span>&nbsp;<span class="ident" id="3592752">in</span><span class="op" id="3592754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3592757">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592760">tail</span>&nbsp;<span class="op" id="3592765">=</span>&nbsp;<span class="ident" id="3592767">head</span><span class="op" id="3592771">[</span><span class="builtinfunc" id="3592772">len</span><span class="op" id="3592775">(</span><span class="ident" id="3592776">in</span><span class="op" id="3592778">)</span><span class="op" id="3592779">:</span><span class="op" id="3592780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592783">return</span><br>
<span class="lineno"></span><span class="op" id="3592790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592793">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3592858">func</span>&nbsp;<span class="op" id="3592863">(</span><span class="ident" id="3592864">g</span>&nbsp;<span class="op" id="3592866">*</span><span class="ident" id="3592867">gcm</span><span class="op" id="3592870">)</span>&nbsp;<span class="ident" id="3592872">counterCrypt</span><span class="op" id="3592884">(</span><span class="ident" id="3592885">out</span><span class="op" id="3592888">,</span>&nbsp;<span class="ident" id="3592890">in</span>&nbsp;<span class="op" id="3592893">[</span><span class="op" id="3592894">]</span><span class="builtintype" id="3592895">byte</span><span class="op" id="3592899">,</span>&nbsp;<span class="ident" id="3592901">counter</span>&nbsp;<span class="op" id="3592909">*</span><span class="op" id="3592910">[</span><span class="ident" id="3592911">gcmBlockSize</span><span class="op" id="3592923">]</span><span class="builtintype" id="3592924">byte</span><span class="op" id="3592928">)</span>&nbsp;<span class="op" id="3592930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592933">var</span>&nbsp;<span class="ident" id="3592937">mask</span>&nbsp;<span class="op" id="3592942">[</span><span class="ident" id="3592943">gcmBlockSize</span><span class="op" id="3592955">]</span><span class="builtintype" id="3592956">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3592963">for</span>&nbsp;<span class="builtinfunc" id="3592967">len</span><span class="op" id="3592970">(</span><span class="ident" id="3592971">in</span><span class="op" id="3592973">)</span>&nbsp;<span class="op" id="3592975">&gt;=</span>&nbsp;<span class="ident" id="3592978">gcmBlockSize</span>&nbsp;<span class="op" id="3592991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3592995">g</span><span class="op" id="3592996">.</span><span class="ident" id="3592997">cipher</span><span class="op" id="3593003">.</span><span class="ident" id="3593004">Encrypt</span><span class="op" id="3593011">(</span><span class="ident" id="3593012">mask</span><span class="op" id="3593016">[</span><span class="op" id="3593017">:</span><span class="op" id="3593018">]</span><span class="op" id="3593019">,</span>&nbsp;<span class="ident" id="3593021">counter</span><span class="op" id="3593028">[</span><span class="op" id="3593029">:</span><span class="op" id="3593030">]</span><span class="op" id="3593031">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593035">gcmInc32</span><span class="op" id="3593043">(</span><span class="ident" id="3593044">counter</span><span class="op" id="3593051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593056">xorWords</span><span class="op" id="3593064">(</span><span class="ident" id="3593065">out</span><span class="op" id="3593068">,</span>&nbsp;<span class="ident" id="3593070">in</span><span class="op" id="3593072">,</span>&nbsp;<span class="ident" id="3593074">mask</span><span class="op" id="3593078">[</span><span class="op" id="3593079">:</span><span class="op" id="3593080">]</span><span class="op" id="3593081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593085">out</span>&nbsp;<span class="op" id="3593089">=</span>&nbsp;<span class="ident" id="3593091">out</span><span class="op" id="3593094">[</span><span class="ident" id="3593095">gcmBlockSize</span><span class="op" id="3593107">:</span><span class="op" id="3593108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593112">in</span>&nbsp;<span class="op" id="3593115">=</span>&nbsp;<span class="ident" id="3593117">in</span><span class="op" id="3593119">[</span><span class="ident" id="3593120">gcmBlockSize</span><span class="op" id="3593132">:</span><span class="op" id="3593133">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593140">if</span>&nbsp;<span class="builtinfunc" id="3593143">len</span><span class="op" id="3593146">(</span><span class="ident" id="3593147">in</span><span class="op" id="3593149">)</span>&nbsp;<span class="op" id="3593151">&gt;</span>&nbsp;<span class="num" id="3593153">0</span>&nbsp;<span class="op" id="3593155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593159">g</span><span class="op" id="3593160">.</span><span class="ident" id="3593161">cipher</span><span class="op" id="3593167">.</span><span class="ident" id="3593168">Encrypt</span><span class="op" id="3593175">(</span><span class="ident" id="3593176">mask</span><span class="op" id="3593180">[</span><span class="op" id="3593181">:</span><span class="op" id="3593182">]</span><span class="op" id="3593183">,</span>&nbsp;<span class="ident" id="3593185">counter</span><span class="op" id="3593192">[</span><span class="op" id="3593193">:</span><span class="op" id="3593194">]</span><span class="op" id="3593195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593199">gcmInc32</span><span class="op" id="3593207">(</span><span class="ident" id="3593208">counter</span><span class="op" id="3593215">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593219">xorBytes</span><span class="op" id="3593227">(</span><span class="ident" id="3593228">out</span><span class="op" id="3593231">,</span>&nbsp;<span class="ident" id="3593233">in</span><span class="op" id="3593235">,</span>&nbsp;<span class="ident" id="3593237">mask</span><span class="op" id="3593241">[</span><span class="op" id="3593242">:</span><span class="op" id="3593243">]</span><span class="op" id="3593244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3593247">}</span><br>
<span class="lineno"></span><span class="op" id="3593249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3593252">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3593328">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3593369">func</span>&nbsp;<span class="op" id="3593374">(</span><span class="ident" id="3593375">g</span>&nbsp;<span class="op" id="3593377">*</span><span class="ident" id="3593378">gcm</span><span class="op" id="3593381">)</span>&nbsp;<span class="ident" id="3593383">auth</span><span class="op" id="3593387">(</span><span class="ident" id="3593388">out</span><span class="op" id="3593391">,</span>&nbsp;<span class="ident" id="3593393">ciphertext</span><span class="op" id="3593403">,</span>&nbsp;<span class="ident" id="3593405">additionalData</span>&nbsp;<span class="op" id="3593420">[</span><span class="op" id="3593421">]</span><span class="builtintype" id="3593422">byte</span><span class="op" id="3593426">,</span>&nbsp;<span class="ident" id="3593428">tagMask</span>&nbsp;<span class="op" id="3593436">*</span><span class="op" id="3593437">[</span><span class="ident" id="3593438">gcmTagSize</span><span class="op" id="3593448">]</span><span class="builtintype" id="3593449">byte</span><span class="op" id="3593453">)</span>&nbsp;<span class="op" id="3593455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593458">var</span>&nbsp;<span class="ident" id="3593462">y</span>&nbsp;<span class="ident" id="3593464">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593481">g</span><span class="op" id="3593482">.</span><span class="ident" id="3593483">update</span><span class="op" id="3593489">(</span><span class="op" id="3593490">&amp;</span><span class="ident" id="3593491">y</span><span class="op" id="3593492">,</span>&nbsp;<span class="ident" id="3593494">additionalData</span><span class="op" id="3593508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593511">g</span><span class="op" id="3593512">.</span><span class="ident" id="3593513">update</span><span class="op" id="3593519">(</span><span class="op" id="3593520">&amp;</span><span class="ident" id="3593521">y</span><span class="op" id="3593522">,</span>&nbsp;<span class="ident" id="3593524">ciphertext</span><span class="op" id="3593534">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593538">y</span><span class="op" id="3593539">.</span><span class="ident" id="3593540">low</span>&nbsp;<span class="op" id="3593544">^=</span>&nbsp;<span class="ident" id="3593547">uint64</span><span class="op" id="3593553">(</span><span class="builtinfunc" id="3593554">len</span><span class="op" id="3593557">(</span><span class="ident" id="3593558">additionalData</span><span class="op" id="3593572">)</span><span class="op" id="3593573">)</span>&nbsp;<span class="op" id="3593575">*</span>&nbsp;<span class="num" id="3593577">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593580">y</span><span class="op" id="3593581">.</span><span class="ident" id="3593582">high</span>&nbsp;<span class="op" id="3593587">^=</span>&nbsp;<span class="ident" id="3593590">uint64</span><span class="op" id="3593596">(</span><span class="builtinfunc" id="3593597">len</span><span class="op" id="3593600">(</span><span class="ident" id="3593601">ciphertext</span><span class="op" id="3593611">)</span><span class="op" id="3593612">)</span>&nbsp;<span class="op" id="3593614">*</span>&nbsp;<span class="num" id="3593616">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593620">g</span><span class="op" id="3593621">.</span><span class="ident" id="3593622">mul</span><span class="op" id="3593625">(</span><span class="op" id="3593626">&amp;</span><span class="ident" id="3593627">y</span><span class="op" id="3593628">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593632">putUint64</span><span class="op" id="3593641">(</span><span class="ident" id="3593642">out</span><span class="op" id="3593645">,</span>&nbsp;<span class="ident" id="3593647">y</span><span class="op" id="3593648">.</span><span class="ident" id="3593649">low</span><span class="op" id="3593652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593655">putUint64</span><span class="op" id="3593664">(</span><span class="ident" id="3593665">out</span><span class="op" id="3593668">[</span><span class="num" id="3593669">8</span><span class="op" id="3593670">:</span><span class="op" id="3593671">]</span><span class="op" id="3593672">,</span>&nbsp;<span class="ident" id="3593674">y</span><span class="op" id="3593675">.</span><span class="ident" id="3593676">high</span><span class="op" id="3593680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593684">xorWords</span><span class="op" id="3593692">(</span><span class="ident" id="3593693">out</span><span class="op" id="3593696">,</span>&nbsp;<span class="ident" id="3593698">out</span><span class="op" id="3593701">,</span>&nbsp;<span class="ident" id="3593703">tagMask</span><span class="op" id="3593710">[</span><span class="op" id="3593711">:</span><span class="op" id="3593712">]</span><span class="op" id="3593713">)</span><br>
<span class="lineno">320</span><span class="op" id="3593715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3593718">func</span>&nbsp;<span class="ident" id="3593723">getUint64</span><span class="op" id="3593732">(</span><span class="ident" id="3593733">data</span>&nbsp;<span class="op" id="3593738">[</span><span class="op" id="3593739">]</span><span class="builtintype" id="3593740">byte</span><span class="op" id="3593744">)</span>&nbsp;<span class="ident" id="3593746">uint64</span>&nbsp;<span class="op" id="3593753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593756">r</span>&nbsp;<span class="op" id="3593758">:=</span>&nbsp;<span class="ident" id="3593761">uint64</span><span class="op" id="3593767">(</span><span class="ident" id="3593768">data</span><span class="op" id="3593772">[</span><span class="num" id="3593773">0</span><span class="op" id="3593774">]</span><span class="op" id="3593775">)</span><span class="op" id="3593776">&lt;&lt;</span><span class="num" id="3593778">56</span>&nbsp;<span class="op" id="3593781">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593785">uint64</span><span class="op" id="3593791">(</span><span class="ident" id="3593792">data</span><span class="op" id="3593796">[</span><span class="num" id="3593797">1</span><span class="op" id="3593798">]</span><span class="op" id="3593799">)</span><span class="op" id="3593800">&lt;&lt;</span><span class="num" id="3593802">48</span>&nbsp;<span class="op" id="3593805">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593809">uint64</span><span class="op" id="3593815">(</span><span class="ident" id="3593816">data</span><span class="op" id="3593820">[</span><span class="num" id="3593821">2</span><span class="op" id="3593822">]</span><span class="op" id="3593823">)</span><span class="op" id="3593824">&lt;&lt;</span><span class="num" id="3593826">40</span>&nbsp;<span class="op" id="3593829">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593833">uint64</span><span class="op" id="3593839">(</span><span class="ident" id="3593840">data</span><span class="op" id="3593844">[</span><span class="num" id="3593845">3</span><span class="op" id="3593846">]</span><span class="op" id="3593847">)</span><span class="op" id="3593848">&lt;&lt;</span><span class="num" id="3593850">32</span>&nbsp;<span class="op" id="3593853">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593857">uint64</span><span class="op" id="3593863">(</span><span class="ident" id="3593864">data</span><span class="op" id="3593868">[</span><span class="num" id="3593869">4</span><span class="op" id="3593870">]</span><span class="op" id="3593871">)</span><span class="op" id="3593872">&lt;&lt;</span><span class="num" id="3593874">24</span>&nbsp;<span class="op" id="3593877">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593881">uint64</span><span class="op" id="3593887">(</span><span class="ident" id="3593888">data</span><span class="op" id="3593892">[</span><span class="num" id="3593893">5</span><span class="op" id="3593894">]</span><span class="op" id="3593895">)</span><span class="op" id="3593896">&lt;&lt;</span><span class="num" id="3593898">16</span>&nbsp;<span class="op" id="3593901">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593905">uint64</span><span class="op" id="3593911">(</span><span class="ident" id="3593912">data</span><span class="op" id="3593916">[</span><span class="num" id="3593917">6</span><span class="op" id="3593918">]</span><span class="op" id="3593919">)</span><span class="op" id="3593920">&lt;&lt;</span><span class="num" id="3593922">8</span>&nbsp;<span class="op" id="3593924">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593928">uint64</span><span class="op" id="3593934">(</span><span class="ident" id="3593935">data</span><span class="op" id="3593939">[</span><span class="num" id="3593940">7</span><span class="op" id="3593941">]</span><span class="op" id="3593942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3593945">return</span>&nbsp;<span class="ident" id="3593952">r</span><br>
<span class="lineno"></span><span class="op" id="3593954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3593957">func</span>&nbsp;<span class="ident" id="3593962">putUint64</span><span class="op" id="3593971">(</span><span class="ident" id="3593972">out</span>&nbsp;<span class="op" id="3593976">[</span><span class="op" id="3593977">]</span><span class="builtintype" id="3593978">byte</span><span class="op" id="3593982">,</span>&nbsp;<span class="ident" id="3593984">v</span>&nbsp;<span class="ident" id="3593986">uint64</span><span class="op" id="3593992">)</span>&nbsp;<span class="op" id="3593994">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3593997">out</span><span class="op" id="3594000">[</span><span class="num" id="3594001">0</span><span class="op" id="3594002">]</span>&nbsp;<span class="op" id="3594004">=</span>&nbsp;<span class="builtintype" id="3594006">byte</span><span class="op" id="3594010">(</span><span class="ident" id="3594011">v</span>&nbsp;<span class="op" id="3594013">&gt;&gt;</span>&nbsp;<span class="num" id="3594016">56</span><span class="op" id="3594018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594021">out</span><span class="op" id="3594024">[</span><span class="num" id="3594025">1</span><span class="op" id="3594026">]</span>&nbsp;<span class="op" id="3594028">=</span>&nbsp;<span class="builtintype" id="3594030">byte</span><span class="op" id="3594034">(</span><span class="ident" id="3594035">v</span>&nbsp;<span class="op" id="3594037">&gt;&gt;</span>&nbsp;<span class="num" id="3594040">48</span><span class="op" id="3594042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594045">out</span><span class="op" id="3594048">[</span><span class="num" id="3594049">2</span><span class="op" id="3594050">]</span>&nbsp;<span class="op" id="3594052">=</span>&nbsp;<span class="builtintype" id="3594054">byte</span><span class="op" id="3594058">(</span><span class="ident" id="3594059">v</span>&nbsp;<span class="op" id="3594061">&gt;&gt;</span>&nbsp;<span class="num" id="3594064">40</span><span class="op" id="3594066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594069">out</span><span class="op" id="3594072">[</span><span class="num" id="3594073">3</span><span class="op" id="3594074">]</span>&nbsp;<span class="op" id="3594076">=</span>&nbsp;<span class="builtintype" id="3594078">byte</span><span class="op" id="3594082">(</span><span class="ident" id="3594083">v</span>&nbsp;<span class="op" id="3594085">&gt;&gt;</span>&nbsp;<span class="num" id="3594088">32</span><span class="op" id="3594090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594093">out</span><span class="op" id="3594096">[</span><span class="num" id="3594097">4</span><span class="op" id="3594098">]</span>&nbsp;<span class="op" id="3594100">=</span>&nbsp;<span class="builtintype" id="3594102">byte</span><span class="op" id="3594106">(</span><span class="ident" id="3594107">v</span>&nbsp;<span class="op" id="3594109">&gt;&gt;</span>&nbsp;<span class="num" id="3594112">24</span><span class="op" id="3594114">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594117">out</span><span class="op" id="3594120">[</span><span class="num" id="3594121">5</span><span class="op" id="3594122">]</span>&nbsp;<span class="op" id="3594124">=</span>&nbsp;<span class="builtintype" id="3594126">byte</span><span class="op" id="3594130">(</span><span class="ident" id="3594131">v</span>&nbsp;<span class="op" id="3594133">&gt;&gt;</span>&nbsp;<span class="num" id="3594136">16</span><span class="op" id="3594138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594141">out</span><span class="op" id="3594144">[</span><span class="num" id="3594145">6</span><span class="op" id="3594146">]</span>&nbsp;<span class="op" id="3594148">=</span>&nbsp;<span class="builtintype" id="3594150">byte</span><span class="op" id="3594154">(</span><span class="ident" id="3594155">v</span>&nbsp;<span class="op" id="3594157">&gt;&gt;</span>&nbsp;<span class="num" id="3594160">8</span><span class="op" id="3594161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3594164">out</span><span class="op" id="3594167">[</span><span class="num" id="3594168">7</span><span class="op" id="3594169">]</span>&nbsp;<span class="op" id="3594171">=</span>&nbsp;<span class="builtintype" id="3594173">byte</span><span class="op" id="3594177">(</span><span class="ident" id="3594178">v</span><span class="op" id="3594179">)</span><br>
<span class="lineno"></span><span class="op" id="3594181">}</span>
</div>
</body>
</html>
