<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3480282">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3480337">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3480391">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3480442">package</span>&nbsp;<span class="ident" id="3480450">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3480458">import</span>&nbsp;<span class="op" id="3480465">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3480468">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3480485">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3480494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480497">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3480573">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3480582">type</span>&nbsp;<span class="ident" id="3480587">AEAD</span>&nbsp;<span class="keyword" id="3480592">interface</span>&nbsp;<span class="op" id="3480602">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480605">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480677">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480691">NonceSize</span><span class="op" id="3480700">(</span><span class="op" id="3480701">)</span>&nbsp;<span class="builtintype" id="3480703">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480709">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480778">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480808">Overhead</span><span class="op" id="3480816">(</span><span class="op" id="3480817">)</span>&nbsp;<span class="builtintype" id="3480819">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480825">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480890">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480963">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481034">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481061">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481065">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481124">Seal</span><span class="op" id="3481128">(</span><span class="ident" id="3481129">dst</span><span class="op" id="3481132">,</span>&nbsp;<span class="ident" id="3481134">nonce</span><span class="op" id="3481139">,</span>&nbsp;<span class="ident" id="3481141">plaintext</span><span class="op" id="3481150">,</span>&nbsp;<span class="ident" id="3481152">data</span>&nbsp;<span class="op" id="3481157">[</span><span class="op" id="3481158">]</span><span class="builtintype" id="3481159">byte</span><span class="op" id="3481163">)</span>&nbsp;<span class="op" id="3481165">[</span><span class="op" id="3481166">]</span><span class="builtintype" id="3481167">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481174">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481240">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481312">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481383">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481449">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481475">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481479">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481539">Open</span><span class="op" id="3481543">(</span><span class="ident" id="3481544">dst</span><span class="op" id="3481547">,</span>&nbsp;<span class="ident" id="3481549">nonce</span><span class="op" id="3481554">,</span>&nbsp;<span class="ident" id="3481556">ciphertext</span><span class="op" id="3481566">,</span>&nbsp;<span class="ident" id="3481568">data</span>&nbsp;<span class="op" id="3481573">[</span><span class="op" id="3481574">]</span><span class="builtintype" id="3481575">byte</span><span class="op" id="3481579">)</span>&nbsp;<span class="op" id="3481581">(</span><span class="op" id="3481582">[</span><span class="op" id="3481583">]</span><span class="builtintype" id="3481584">byte</span><span class="op" id="3481588">,</span>&nbsp;<span class="builtintype" id="3481590">error</span><span class="op" id="3481595">)</span><br>
<span class="lineno"></span><span class="op" id="3481597">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3481600">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3481683">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3481761">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3481799">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3481860">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3481921">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3481986">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3482050">type</span>&nbsp;<span class="ident" id="3482055">gcmFieldElement</span>&nbsp;<span class="keyword" id="3482071">struct</span>&nbsp;<span class="op" id="3482078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482081">low</span><span class="op" id="3482084">,</span>&nbsp;<span class="ident" id="3482086">high</span>&nbsp;<span class="ident" id="3482091">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3482098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3482101">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3482166">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3482261">type</span>&nbsp;<span class="ident" id="3482266">gcm</span>&nbsp;<span class="keyword" id="3482270">struct</span>&nbsp;<span class="op" id="3482277">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482280">cipher</span>&nbsp;<span class="ident" id="3482287">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482294">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482360">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482417">productTable</span>&nbsp;<span class="op" id="3482430">[</span><span class="num" id="3482431">16</span><span class="op" id="3482433">]</span><span class="ident" id="3482434">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3482450">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3482453">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3482535">func</span>&nbsp;<span class="ident" id="3482540">NewGCM</span><span class="op" id="3482546">(</span><span class="ident" id="3482547">cipher</span>&nbsp;<span class="ident" id="3482554">Block</span><span class="op" id="3482559">)</span>&nbsp;<span class="op" id="3482561">(</span><span class="ident" id="3482562">AEAD</span><span class="op" id="3482566">,</span>&nbsp;<span class="builtintype" id="3482568">error</span><span class="op" id="3482573">)</span>&nbsp;<span class="op" id="3482575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482578">if</span>&nbsp;<span class="ident" id="3482581">cipher</span><span class="op" id="3482587">.</span><span class="ident" id="3482588">BlockSize</span><span class="op" id="3482597">(</span><span class="op" id="3482598">)</span>&nbsp;<span class="op" id="3482600">!=</span>&nbsp;<span class="ident" id="3482603">gcmBlockSize</span>&nbsp;<span class="op" id="3482616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482620">return</span>&nbsp;<span class="ident" id="3482627">nil</span><span class="op" id="3482630">,</span>&nbsp;<span class="ident" id="3482632">errors</span><span class="op" id="3482638">.</span><span class="ident" id="3482639">New</span><span class="op" id="3482642">(</span><span class="string" id="3482643">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3482689">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3482692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3482696">var</span>&nbsp;<span class="ident" id="3482700">key</span>&nbsp;<span class="op" id="3482704">[</span><span class="ident" id="3482705">gcmBlockSize</span><span class="op" id="3482717">]</span><span class="builtintype" id="3482718">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482724">cipher</span><span class="op" id="3482730">.</span><span class="ident" id="3482731">Encrypt</span><span class="op" id="3482738">(</span><span class="ident" id="3482739">key</span><span class="op" id="3482742">[</span><span class="op" id="3482743">:</span><span class="op" id="3482744">]</span><span class="op" id="3482745">,</span>&nbsp;<span class="ident" id="3482747">key</span><span class="op" id="3482750">[</span><span class="op" id="3482751">:</span><span class="op" id="3482752">]</span><span class="op" id="3482753">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482757">g</span>&nbsp;<span class="op" id="3482759">:=</span>&nbsp;<span class="op" id="3482762">&amp;</span><span class="ident" id="3482763">gcm</span><span class="op" id="3482766">{</span><span class="ident" id="3482767">cipher</span><span class="op" id="3482773">:</span>&nbsp;<span class="ident" id="3482775">cipher</span><span class="op" id="3482781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482785">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482854">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482919">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482988">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483058">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483128">x</span>&nbsp;<span class="op" id="3483130">:=</span>&nbsp;<span class="ident" id="3483133">gcmFieldElement</span><span class="op" id="3483148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483152">getUint64</span><span class="op" id="3483161">(</span><span class="ident" id="3483162">key</span><span class="op" id="3483165">[</span><span class="op" id="3483166">:</span><span class="num" id="3483167">8</span><span class="op" id="3483168">]</span><span class="op" id="3483169">)</span><span class="op" id="3483170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483174">getUint64</span><span class="op" id="3483183">(</span><span class="ident" id="3483184">key</span><span class="op" id="3483187">[</span><span class="num" id="3483188">8</span><span class="op" id="3483189">:</span><span class="op" id="3483190">]</span><span class="op" id="3483191">)</span><span class="op" id="3483192">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483198">g</span><span class="op" id="3483199">.</span><span class="ident" id="3483200">productTable</span><span class="op" id="3483212">[</span><span class="ident" id="3483213">reverseBits</span><span class="op" id="3483224">(</span><span class="num" id="3483225">1</span><span class="op" id="3483226">)</span><span class="op" id="3483227">]</span>&nbsp;<span class="op" id="3483229">=</span>&nbsp;<span class="ident" id="3483231">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483235">for</span>&nbsp;<span class="ident" id="3483239">i</span>&nbsp;<span class="op" id="3483241">:=</span>&nbsp;<span class="num" id="3483244">2</span><span class="op" id="3483245">;</span>&nbsp;<span class="ident" id="3483247">i</span>&nbsp;<span class="op" id="3483249">&lt;</span>&nbsp;<span class="num" id="3483251">16</span><span class="op" id="3483253">;</span>&nbsp;<span class="ident" id="3483255">i</span>&nbsp;<span class="op" id="3483257">+=</span>&nbsp;<span class="num" id="3483260">2</span>&nbsp;<span class="op" id="3483262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483266">g</span><span class="op" id="3483267">.</span><span class="ident" id="3483268">productTable</span><span class="op" id="3483280">[</span><span class="ident" id="3483281">reverseBits</span><span class="op" id="3483292">(</span><span class="ident" id="3483293">i</span><span class="op" id="3483294">)</span><span class="op" id="3483295">]</span>&nbsp;<span class="op" id="3483297">=</span>&nbsp;<span class="ident" id="3483299">gcmDouble</span><span class="op" id="3483308">(</span><span class="op" id="3483309">&amp;</span><span class="ident" id="3483310">g</span><span class="op" id="3483311">.</span><span class="ident" id="3483312">productTable</span><span class="op" id="3483324">[</span><span class="ident" id="3483325">reverseBits</span><span class="op" id="3483336">(</span><span class="ident" id="3483337">i</span><span class="op" id="3483338">/</span><span class="num" id="3483339">2</span><span class="op" id="3483340">)</span><span class="op" id="3483341">]</span><span class="op" id="3483342">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483346">g</span><span class="op" id="3483347">.</span><span class="ident" id="3483348">productTable</span><span class="op" id="3483360">[</span><span class="ident" id="3483361">reverseBits</span><span class="op" id="3483372">(</span><span class="ident" id="3483373">i</span><span class="op" id="3483374">+</span><span class="num" id="3483375">1</span><span class="op" id="3483376">)</span><span class="op" id="3483377">]</span>&nbsp;<span class="op" id="3483379">=</span>&nbsp;<span class="ident" id="3483381">gcmAdd</span><span class="op" id="3483387">(</span><span class="op" id="3483388">&amp;</span><span class="ident" id="3483389">g</span><span class="op" id="3483390">.</span><span class="ident" id="3483391">productTable</span><span class="op" id="3483403">[</span><span class="ident" id="3483404">reverseBits</span><span class="op" id="3483415">(</span><span class="ident" id="3483416">i</span><span class="op" id="3483417">)</span><span class="op" id="3483418">]</span><span class="op" id="3483419">,</span>&nbsp;<span class="op" id="3483421">&amp;</span><span class="ident" id="3483422">x</span><span class="op" id="3483423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483430">return</span>&nbsp;<span class="ident" id="3483437">g</span><span class="op" id="3483438">,</span>&nbsp;<span class="ident" id="3483440">nil</span><br>
<span class="lineno"></span><span class="op" id="3483444">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3483447">const</span>&nbsp;<span class="op" id="3483453">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483456">gcmBlockSize</span>&nbsp;<span class="op" id="3483469">=</span>&nbsp;<span class="num" id="3483471">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483475">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3483488">=</span>&nbsp;<span class="num" id="3483490">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483494">gcmNonceSize</span>&nbsp;<span class="op" id="3483507">=</span>&nbsp;<span class="num" id="3483509">12</span><br>
<span class="lineno">95</span><span class="op" id="3483512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3483515">func</span>&nbsp;<span class="op" id="3483520">(</span><span class="op" id="3483521">*</span><span class="ident" id="3483522">gcm</span><span class="op" id="3483525">)</span>&nbsp;<span class="ident" id="3483527">NonceSize</span><span class="op" id="3483536">(</span><span class="op" id="3483537">)</span>&nbsp;<span class="builtintype" id="3483539">int</span>&nbsp;<span class="op" id="3483543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483546">return</span>&nbsp;<span class="ident" id="3483553">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3483566">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3483569">func</span>&nbsp;<span class="op" id="3483574">(</span><span class="op" id="3483575">*</span><span class="ident" id="3483576">gcm</span><span class="op" id="3483579">)</span>&nbsp;<span class="ident" id="3483581">Overhead</span><span class="op" id="3483589">(</span><span class="op" id="3483590">)</span>&nbsp;<span class="builtintype" id="3483592">int</span>&nbsp;<span class="op" id="3483596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483599">return</span>&nbsp;<span class="ident" id="3483606">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3483617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3483620">func</span>&nbsp;<span class="op" id="3483625">(</span><span class="ident" id="3483626">g</span>&nbsp;<span class="op" id="3483628">*</span><span class="ident" id="3483629">gcm</span><span class="op" id="3483632">)</span>&nbsp;<span class="ident" id="3483634">Seal</span><span class="op" id="3483638">(</span><span class="ident" id="3483639">dst</span><span class="op" id="3483642">,</span>&nbsp;<span class="ident" id="3483644">nonce</span><span class="op" id="3483649">,</span>&nbsp;<span class="ident" id="3483651">plaintext</span><span class="op" id="3483660">,</span>&nbsp;<span class="ident" id="3483662">data</span>&nbsp;<span class="op" id="3483667">[</span><span class="op" id="3483668">]</span><span class="builtintype" id="3483669">byte</span><span class="op" id="3483673">)</span>&nbsp;<span class="op" id="3483675">[</span><span class="op" id="3483676">]</span><span class="builtintype" id="3483677">byte</span>&nbsp;<span class="op" id="3483682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483685">if</span>&nbsp;<span class="builtinfunc" id="3483688">len</span><span class="op" id="3483691">(</span><span class="ident" id="3483692">nonce</span><span class="op" id="3483697">)</span>&nbsp;<span class="op" id="3483699">!=</span>&nbsp;<span class="ident" id="3483702">gcmNonceSize</span>&nbsp;<span class="op" id="3483715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3483719">panic</span><span class="op" id="3483724">(</span><span class="string" id="3483725">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3483770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3483773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483777">ret</span><span class="op" id="3483780">,</span>&nbsp;<span class="ident" id="3483782">out</span>&nbsp;<span class="op" id="3483786">:=</span>&nbsp;<span class="ident" id="3483789">sliceForAppend</span><span class="op" id="3483803">(</span><span class="ident" id="3483804">dst</span><span class="op" id="3483807">,</span>&nbsp;<span class="builtinfunc" id="3483809">len</span><span class="op" id="3483812">(</span><span class="ident" id="3483813">plaintext</span><span class="op" id="3483822">)</span><span class="op" id="3483823">+</span><span class="ident" id="3483824">gcmTagSize</span><span class="op" id="3483834">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483838">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3483869">var</span>&nbsp;<span class="ident" id="3483873">counter</span><span class="op" id="3483880">,</span>&nbsp;<span class="ident" id="3483882">tagMask</span>&nbsp;<span class="op" id="3483890">[</span><span class="ident" id="3483891">gcmBlockSize</span><span class="op" id="3483903">]</span><span class="builtintype" id="3483904">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3483910">copy</span><span class="op" id="3483914">(</span><span class="ident" id="3483915">counter</span><span class="op" id="3483922">[</span><span class="op" id="3483923">:</span><span class="op" id="3483924">]</span><span class="op" id="3483925">,</span>&nbsp;<span class="ident" id="3483927">nonce</span><span class="op" id="3483932">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483935">counter</span><span class="op" id="3483942">[</span><span class="ident" id="3483943">gcmBlockSize</span><span class="op" id="3483955">-</span><span class="num" id="3483956">1</span><span class="op" id="3483957">]</span>&nbsp;<span class="op" id="3483959">=</span>&nbsp;<span class="num" id="3483961">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483965">g</span><span class="op" id="3483966">.</span><span class="ident" id="3483967">cipher</span><span class="op" id="3483973">.</span><span class="ident" id="3483974">Encrypt</span><span class="op" id="3483981">(</span><span class="ident" id="3483982">tagMask</span><span class="op" id="3483989">[</span><span class="op" id="3483990">:</span><span class="op" id="3483991">]</span><span class="op" id="3483992">,</span>&nbsp;<span class="ident" id="3483994">counter</span><span class="op" id="3484001">[</span><span class="op" id="3484002">:</span><span class="op" id="3484003">]</span><span class="op" id="3484004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484007">gcmInc32</span><span class="op" id="3484015">(</span><span class="op" id="3484016">&amp;</span><span class="ident" id="3484017">counter</span><span class="op" id="3484024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484028">g</span><span class="op" id="3484029">.</span><span class="ident" id="3484030">counterCrypt</span><span class="op" id="3484042">(</span><span class="ident" id="3484043">out</span><span class="op" id="3484046">,</span>&nbsp;<span class="ident" id="3484048">plaintext</span><span class="op" id="3484057">,</span>&nbsp;<span class="op" id="3484059">&amp;</span><span class="ident" id="3484060">counter</span><span class="op" id="3484067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484070">g</span><span class="op" id="3484071">.</span><span class="ident" id="3484072">auth</span><span class="op" id="3484076">(</span><span class="ident" id="3484077">out</span><span class="op" id="3484080">[</span><span class="builtinfunc" id="3484081">len</span><span class="op" id="3484084">(</span><span class="ident" id="3484085">plaintext</span><span class="op" id="3484094">)</span><span class="op" id="3484095">:</span><span class="op" id="3484096">]</span><span class="op" id="3484097">,</span>&nbsp;<span class="ident" id="3484099">out</span><span class="op" id="3484102">[</span><span class="op" id="3484103">:</span><span class="builtinfunc" id="3484104">len</span><span class="op" id="3484107">(</span><span class="ident" id="3484108">plaintext</span><span class="op" id="3484117">)</span><span class="op" id="3484118">]</span><span class="op" id="3484119">,</span>&nbsp;<span class="ident" id="3484121">data</span><span class="op" id="3484125">,</span>&nbsp;<span class="op" id="3484127">&amp;</span><span class="ident" id="3484128">tagMask</span><span class="op" id="3484135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484139">return</span>&nbsp;<span class="ident" id="3484146">ret</span><br>
<span class="lineno"></span><span class="op" id="3484150">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3484153">var</span>&nbsp;<span class="ident" id="3484157">errOpen</span>&nbsp;<span class="op" id="3484165">=</span>&nbsp;<span class="ident" id="3484167">errors</span><span class="op" id="3484173">.</span><span class="ident" id="3484174">New</span><span class="op" id="3484177">(</span><span class="string" id="3484178">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3484217">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484220">func</span>&nbsp;<span class="op" id="3484225">(</span><span class="ident" id="3484226">g</span>&nbsp;<span class="op" id="3484228">*</span><span class="ident" id="3484229">gcm</span><span class="op" id="3484232">)</span>&nbsp;<span class="ident" id="3484234">Open</span><span class="op" id="3484238">(</span><span class="ident" id="3484239">dst</span><span class="op" id="3484242">,</span>&nbsp;<span class="ident" id="3484244">nonce</span><span class="op" id="3484249">,</span>&nbsp;<span class="ident" id="3484251">ciphertext</span><span class="op" id="3484261">,</span>&nbsp;<span class="ident" id="3484263">data</span>&nbsp;<span class="op" id="3484268">[</span><span class="op" id="3484269">]</span><span class="builtintype" id="3484270">byte</span><span class="op" id="3484274">)</span>&nbsp;<span class="op" id="3484276">(</span><span class="op" id="3484277">[</span><span class="op" id="3484278">]</span><span class="builtintype" id="3484279">byte</span><span class="op" id="3484283">,</span>&nbsp;<span class="builtintype" id="3484285">error</span><span class="op" id="3484290">)</span>&nbsp;<span class="op" id="3484292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484295">if</span>&nbsp;<span class="builtinfunc" id="3484298">len</span><span class="op" id="3484301">(</span><span class="ident" id="3484302">nonce</span><span class="op" id="3484307">)</span>&nbsp;<span class="op" id="3484309">!=</span>&nbsp;<span class="ident" id="3484312">gcmNonceSize</span>&nbsp;<span class="op" id="3484325">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3484329">panic</span><span class="op" id="3484334">(</span><span class="string" id="3484335">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3484380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484387">if</span>&nbsp;<span class="builtinfunc" id="3484390">len</span><span class="op" id="3484393">(</span><span class="ident" id="3484394">ciphertext</span><span class="op" id="3484404">)</span>&nbsp;<span class="op" id="3484406">&lt;</span>&nbsp;<span class="ident" id="3484408">gcmTagSize</span>&nbsp;<span class="op" id="3484419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484423">return</span>&nbsp;<span class="ident" id="3484430">nil</span><span class="op" id="3484433">,</span>&nbsp;<span class="ident" id="3484435">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484447">tag</span>&nbsp;<span class="op" id="3484451">:=</span>&nbsp;<span class="ident" id="3484454">ciphertext</span><span class="op" id="3484464">[</span><span class="builtinfunc" id="3484465">len</span><span class="op" id="3484468">(</span><span class="ident" id="3484469">ciphertext</span><span class="op" id="3484479">)</span><span class="op" id="3484480">-</span><span class="ident" id="3484481">gcmTagSize</span><span class="op" id="3484491">:</span><span class="op" id="3484492">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484495">ciphertext</span>&nbsp;<span class="op" id="3484506">=</span>&nbsp;<span class="ident" id="3484508">ciphertext</span><span class="op" id="3484518">[</span><span class="op" id="3484519">:</span><span class="builtinfunc" id="3484520">len</span><span class="op" id="3484523">(</span><span class="ident" id="3484524">ciphertext</span><span class="op" id="3484534">)</span><span class="op" id="3484535">-</span><span class="ident" id="3484536">gcmTagSize</span><span class="op" id="3484546">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484550">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484581">var</span>&nbsp;<span class="ident" id="3484585">counter</span><span class="op" id="3484592">,</span>&nbsp;<span class="ident" id="3484594">tagMask</span>&nbsp;<span class="op" id="3484602">[</span><span class="ident" id="3484603">gcmBlockSize</span><span class="op" id="3484615">]</span><span class="builtintype" id="3484616">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3484622">copy</span><span class="op" id="3484626">(</span><span class="ident" id="3484627">counter</span><span class="op" id="3484634">[</span><span class="op" id="3484635">:</span><span class="op" id="3484636">]</span><span class="op" id="3484637">,</span>&nbsp;<span class="ident" id="3484639">nonce</span><span class="op" id="3484644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484647">counter</span><span class="op" id="3484654">[</span><span class="ident" id="3484655">gcmBlockSize</span><span class="op" id="3484667">-</span><span class="num" id="3484668">1</span><span class="op" id="3484669">]</span>&nbsp;<span class="op" id="3484671">=</span>&nbsp;<span class="num" id="3484673">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484677">g</span><span class="op" id="3484678">.</span><span class="ident" id="3484679">cipher</span><span class="op" id="3484685">.</span><span class="ident" id="3484686">Encrypt</span><span class="op" id="3484693">(</span><span class="ident" id="3484694">tagMask</span><span class="op" id="3484701">[</span><span class="op" id="3484702">:</span><span class="op" id="3484703">]</span><span class="op" id="3484704">,</span>&nbsp;<span class="ident" id="3484706">counter</span><span class="op" id="3484713">[</span><span class="op" id="3484714">:</span><span class="op" id="3484715">]</span><span class="op" id="3484716">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484719">gcmInc32</span><span class="op" id="3484727">(</span><span class="op" id="3484728">&amp;</span><span class="ident" id="3484729">counter</span><span class="op" id="3484736">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484740">var</span>&nbsp;<span class="ident" id="3484744">expectedTag</span>&nbsp;<span class="op" id="3484756">[</span><span class="ident" id="3484757">gcmTagSize</span><span class="op" id="3484767">]</span><span class="builtintype" id="3484768">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484774">g</span><span class="op" id="3484775">.</span><span class="ident" id="3484776">auth</span><span class="op" id="3484780">(</span><span class="ident" id="3484781">expectedTag</span><span class="op" id="3484792">[</span><span class="op" id="3484793">:</span><span class="op" id="3484794">]</span><span class="op" id="3484795">,</span>&nbsp;<span class="ident" id="3484797">ciphertext</span><span class="op" id="3484807">,</span>&nbsp;<span class="ident" id="3484809">data</span><span class="op" id="3484813">,</span>&nbsp;<span class="op" id="3484815">&amp;</span><span class="ident" id="3484816">tagMask</span><span class="op" id="3484823">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484827">if</span>&nbsp;<span class="ident" id="3484830">subtle</span><span class="op" id="3484836">.</span><span class="ident" id="3484837">ConstantTimeCompare</span><span class="op" id="3484856">(</span><span class="ident" id="3484857">expectedTag</span><span class="op" id="3484868">[</span><span class="op" id="3484869">:</span><span class="op" id="3484870">]</span><span class="op" id="3484871">,</span>&nbsp;<span class="ident" id="3484873">tag</span><span class="op" id="3484876">)</span>&nbsp;<span class="op" id="3484878">!=</span>&nbsp;<span class="num" id="3484881">1</span>&nbsp;<span class="op" id="3484883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484887">return</span>&nbsp;<span class="ident" id="3484894">nil</span><span class="op" id="3484897">,</span>&nbsp;<span class="ident" id="3484899">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484912">ret</span><span class="op" id="3484915">,</span>&nbsp;<span class="ident" id="3484917">out</span>&nbsp;<span class="op" id="3484921">:=</span>&nbsp;<span class="ident" id="3484924">sliceForAppend</span><span class="op" id="3484938">(</span><span class="ident" id="3484939">dst</span><span class="op" id="3484942">,</span>&nbsp;<span class="builtinfunc" id="3484944">len</span><span class="op" id="3484947">(</span><span class="ident" id="3484948">ciphertext</span><span class="op" id="3484958">)</span><span class="op" id="3484959">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484962">g</span><span class="op" id="3484963">.</span><span class="ident" id="3484964">counterCrypt</span><span class="op" id="3484976">(</span><span class="ident" id="3484977">out</span><span class="op" id="3484980">,</span>&nbsp;<span class="ident" id="3484982">ciphertext</span><span class="op" id="3484992">,</span>&nbsp;<span class="op" id="3484994">&amp;</span><span class="ident" id="3484995">counter</span><span class="op" id="3485002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485006">return</span>&nbsp;<span class="ident" id="3485013">ret</span><span class="op" id="3485016">,</span>&nbsp;<span class="ident" id="3485018">nil</span><br>
<span class="lineno"></span><span class="op" id="3485022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3485025">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3485093">func</span>&nbsp;<span class="ident" id="3485098">reverseBits</span><span class="op" id="3485109">(</span><span class="ident" id="3485110">i</span>&nbsp;<span class="builtintype" id="3485112">int</span><span class="op" id="3485115">)</span>&nbsp;<span class="builtintype" id="3485117">int</span>&nbsp;<span class="op" id="3485121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485124">i</span>&nbsp;<span class="op" id="3485126">=</span>&nbsp;<span class="op" id="3485128">(</span><span class="op" id="3485129">(</span><span class="ident" id="3485130">i</span>&nbsp;<span class="op" id="3485132">&lt;&lt;</span>&nbsp;<span class="num" id="3485135">2</span><span class="op" id="3485136">)</span>&nbsp;<span class="op" id="3485138">&amp;</span>&nbsp;<span class="num" id="3485140">0xc</span><span class="op" id="3485143">)</span>&nbsp;<span class="op" id="3485145">|</span>&nbsp;<span class="op" id="3485147">(</span><span class="op" id="3485148">(</span><span class="ident" id="3485149">i</span>&nbsp;<span class="op" id="3485151">&gt;&gt;</span>&nbsp;<span class="num" id="3485154">2</span><span class="op" id="3485155">)</span>&nbsp;<span class="op" id="3485157">&amp;</span>&nbsp;<span class="num" id="3485159">0x3</span><span class="op" id="3485162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485165">i</span>&nbsp;<span class="op" id="3485167">=</span>&nbsp;<span class="op" id="3485169">(</span><span class="op" id="3485170">(</span><span class="ident" id="3485171">i</span>&nbsp;<span class="op" id="3485173">&lt;&lt;</span>&nbsp;<span class="num" id="3485176">1</span><span class="op" id="3485177">)</span>&nbsp;<span class="op" id="3485179">&amp;</span>&nbsp;<span class="num" id="3485181">0xa</span><span class="op" id="3485184">)</span>&nbsp;<span class="op" id="3485186">|</span>&nbsp;<span class="op" id="3485188">(</span><span class="op" id="3485189">(</span><span class="ident" id="3485190">i</span>&nbsp;<span class="op" id="3485192">&gt;&gt;</span>&nbsp;<span class="num" id="3485195">1</span><span class="op" id="3485196">)</span>&nbsp;<span class="op" id="3485198">&amp;</span>&nbsp;<span class="num" id="3485200">0x5</span><span class="op" id="3485203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485206">return</span>&nbsp;<span class="ident" id="3485213">i</span><br>
<span class="lineno">165</span><span class="op" id="3485215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485218">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3485283">func</span>&nbsp;<span class="ident" id="3485288">gcmAdd</span><span class="op" id="3485294">(</span><span class="ident" id="3485295">x</span><span class="op" id="3485296">,</span>&nbsp;<span class="ident" id="3485298">y</span>&nbsp;<span class="op" id="3485300">*</span><span class="ident" id="3485301">gcmFieldElement</span><span class="op" id="3485316">)</span>&nbsp;<span class="ident" id="3485318">gcmFieldElement</span>&nbsp;<span class="op" id="3485334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485337">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485391">return</span>&nbsp;<span class="ident" id="3485398">gcmFieldElement</span><span class="op" id="3485413">{</span><span class="ident" id="3485414">x</span><span class="op" id="3485415">.</span><span class="ident" id="3485416">low</span>&nbsp;<span class="op" id="3485420">^</span>&nbsp;<span class="ident" id="3485422">y</span><span class="op" id="3485423">.</span><span class="ident" id="3485424">low</span><span class="op" id="3485427">,</span>&nbsp;<span class="ident" id="3485429">x</span><span class="op" id="3485430">.</span><span class="ident" id="3485431">high</span>&nbsp;<span class="op" id="3485436">^</span>&nbsp;<span class="ident" id="3485438">y</span><span class="op" id="3485439">.</span><span class="ident" id="3485440">high</span><span class="op" id="3485444">}</span><br>
<span class="lineno"></span><span class="op" id="3485446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3485449">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3485521">func</span>&nbsp;<span class="ident" id="3485526">gcmDouble</span><span class="op" id="3485535">(</span><span class="ident" id="3485536">x</span>&nbsp;<span class="op" id="3485538">*</span><span class="ident" id="3485539">gcmFieldElement</span><span class="op" id="3485554">)</span>&nbsp;<span class="op" id="3485556">(</span><span class="ident" id="3485557">double</span>&nbsp;<span class="ident" id="3485564">gcmFieldElement</span><span class="op" id="3485579">)</span>&nbsp;<span class="op" id="3485581">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485584">msbSet</span>&nbsp;<span class="op" id="3485591">:=</span>&nbsp;<span class="ident" id="3485594">x</span><span class="op" id="3485595">.</span><span class="ident" id="3485596">high</span><span class="op" id="3485600">&amp;</span><span class="num" id="3485601">1</span>&nbsp;<span class="op" id="3485603">==</span>&nbsp;<span class="num" id="3485606">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485610">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485679">double</span><span class="op" id="3485685">.</span><span class="ident" id="3485686">high</span>&nbsp;<span class="op" id="3485691">=</span>&nbsp;<span class="ident" id="3485693">x</span><span class="op" id="3485694">.</span><span class="ident" id="3485695">high</span>&nbsp;<span class="op" id="3485700">&gt;&gt;</span>&nbsp;<span class="num" id="3485703">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485706">double</span><span class="op" id="3485712">.</span><span class="ident" id="3485713">high</span>&nbsp;<span class="op" id="3485718">|=</span>&nbsp;<span class="ident" id="3485721">x</span><span class="op" id="3485722">.</span><span class="ident" id="3485723">low</span>&nbsp;<span class="op" id="3485727">&lt;&lt;</span>&nbsp;<span class="num" id="3485730">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485734">double</span><span class="op" id="3485740">.</span><span class="ident" id="3485741">low</span>&nbsp;<span class="op" id="3485745">=</span>&nbsp;<span class="ident" id="3485747">x</span><span class="op" id="3485748">.</span><span class="ident" id="3485749">low</span>&nbsp;<span class="op" id="3485753">&gt;&gt;</span>&nbsp;<span class="num" id="3485756">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485760">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485825">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485893">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3485957">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486030">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486101">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486172">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486181">if</span>&nbsp;<span class="ident" id="3486184">msbSet</span>&nbsp;<span class="op" id="3486191">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486195">double</span><span class="op" id="3486201">.</span><span class="ident" id="3486202">low</span>&nbsp;<span class="op" id="3486206">^=</span>&nbsp;<span class="num" id="3486209">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486233">return</span><br>
<span class="lineno"></span><span class="op" id="3486240">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3486243">var</span>&nbsp;<span class="ident" id="3486247">gcmReductionTable</span>&nbsp;<span class="op" id="3486265">=</span>&nbsp;<span class="op" id="3486267">[</span><span class="op" id="3486268">]</span><span class="builtintype" id="3486269">uint16</span><span class="op" id="3486275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3486278">0x0000</span><span class="op" id="3486284">,</span>&nbsp;<span class="num" id="3486286">0x1c20</span><span class="op" id="3486292">,</span>&nbsp;<span class="num" id="3486294">0x3840</span><span class="op" id="3486300">,</span>&nbsp;<span class="num" id="3486302">0x2460</span><span class="op" id="3486308">,</span>&nbsp;<span class="num" id="3486310">0x7080</span><span class="op" id="3486316">,</span>&nbsp;<span class="num" id="3486318">0x6ca0</span><span class="op" id="3486324">,</span>&nbsp;<span class="num" id="3486326">0x48c0</span><span class="op" id="3486332">,</span>&nbsp;<span class="num" id="3486334">0x54e0</span><span class="op" id="3486340">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3486343">0xe100</span><span class="op" id="3486349">,</span>&nbsp;<span class="num" id="3486351">0xfd20</span><span class="op" id="3486357">,</span>&nbsp;<span class="num" id="3486359">0xd940</span><span class="op" id="3486365">,</span>&nbsp;<span class="num" id="3486367">0xc560</span><span class="op" id="3486373">,</span>&nbsp;<span class="num" id="3486375">0x9180</span><span class="op" id="3486381">,</span>&nbsp;<span class="num" id="3486383">0x8da0</span><span class="op" id="3486389">,</span>&nbsp;<span class="num" id="3486391">0xa9c0</span><span class="op" id="3486397">,</span>&nbsp;<span class="num" id="3486399">0xb5e0</span><span class="op" id="3486405">,</span><br>
<span class="lineno"></span><span class="op" id="3486407">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3486410">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3486477">func</span>&nbsp;<span class="op" id="3486482">(</span><span class="ident" id="3486483">g</span>&nbsp;<span class="op" id="3486485">*</span><span class="ident" id="3486486">gcm</span><span class="op" id="3486489">)</span>&nbsp;<span class="ident" id="3486491">mul</span><span class="op" id="3486494">(</span><span class="ident" id="3486495">y</span>&nbsp;<span class="op" id="3486497">*</span><span class="ident" id="3486498">gcmFieldElement</span><span class="op" id="3486513">)</span>&nbsp;<span class="op" id="3486515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486518">var</span>&nbsp;<span class="ident" id="3486522">z</span>&nbsp;<span class="ident" id="3486524">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486542">for</span>&nbsp;<span class="ident" id="3486546">i</span>&nbsp;<span class="op" id="3486548">:=</span>&nbsp;<span class="num" id="3486551">0</span><span class="op" id="3486552">;</span>&nbsp;<span class="ident" id="3486554">i</span>&nbsp;<span class="op" id="3486556">&lt;</span>&nbsp;<span class="num" id="3486558">2</span><span class="op" id="3486559">;</span>&nbsp;<span class="ident" id="3486561">i</span><span class="op" id="3486562">++</span>&nbsp;<span class="op" id="3486565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486569">word</span>&nbsp;<span class="op" id="3486574">:=</span>&nbsp;<span class="ident" id="3486577">y</span><span class="op" id="3486578">.</span><span class="ident" id="3486579">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486586">if</span>&nbsp;<span class="ident" id="3486589">i</span>&nbsp;<span class="op" id="3486591">==</span>&nbsp;<span class="num" id="3486594">1</span>&nbsp;<span class="op" id="3486596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486601">word</span>&nbsp;<span class="op" id="3486606">=</span>&nbsp;<span class="ident" id="3486608">y</span><span class="op" id="3486609">.</span><span class="ident" id="3486610">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486616">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486621">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486684">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486728">for</span>&nbsp;<span class="ident" id="3486732">j</span>&nbsp;<span class="op" id="3486734">:=</span>&nbsp;<span class="num" id="3486737">0</span><span class="op" id="3486738">;</span>&nbsp;<span class="ident" id="3486740">j</span>&nbsp;<span class="op" id="3486742">&lt;</span>&nbsp;<span class="num" id="3486744">64</span><span class="op" id="3486746">;</span>&nbsp;<span class="ident" id="3486748">j</span>&nbsp;<span class="op" id="3486750">+=</span>&nbsp;<span class="num" id="3486753">4</span>&nbsp;<span class="op" id="3486755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486760">msw</span>&nbsp;<span class="op" id="3486764">:=</span>&nbsp;<span class="ident" id="3486767">z</span><span class="op" id="3486768">.</span><span class="ident" id="3486769">high</span>&nbsp;<span class="op" id="3486774">&amp;</span>&nbsp;<span class="num" id="3486776">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486783">z</span><span class="op" id="3486784">.</span><span class="ident" id="3486785">high</span>&nbsp;<span class="op" id="3486790">&gt;&gt;=</span>&nbsp;<span class="num" id="3486794">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486799">z</span><span class="op" id="3486800">.</span><span class="ident" id="3486801">high</span>&nbsp;<span class="op" id="3486806">|=</span>&nbsp;<span class="ident" id="3486809">z</span><span class="op" id="3486810">.</span><span class="ident" id="3486811">low</span>&nbsp;<span class="op" id="3486815">&lt;&lt;</span>&nbsp;<span class="num" id="3486818">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486824">z</span><span class="op" id="3486825">.</span><span class="ident" id="3486826">low</span>&nbsp;<span class="op" id="3486830">&gt;&gt;=</span>&nbsp;<span class="num" id="3486834">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486839">z</span><span class="op" id="3486840">.</span><span class="ident" id="3486841">low</span>&nbsp;<span class="op" id="3486845">^=</span>&nbsp;<span class="ident" id="3486848">uint64</span><span class="op" id="3486854">(</span><span class="ident" id="3486855">gcmReductionTable</span><span class="op" id="3486872">[</span><span class="ident" id="3486873">msw</span><span class="op" id="3486876">]</span><span class="op" id="3486877">)</span>&nbsp;<span class="op" id="3486879">&lt;&lt;</span>&nbsp;<span class="num" id="3486882">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486889">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486933">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3486984">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487001">t</span>&nbsp;<span class="op" id="3487003">:=</span>&nbsp;<span class="op" id="3487006">&amp;</span><span class="ident" id="3487007">g</span><span class="op" id="3487008">.</span><span class="ident" id="3487009">productTable</span><span class="op" id="3487021">[</span><span class="ident" id="3487022">word</span><span class="op" id="3487026">&amp;</span><span class="num" id="3487027">0xf</span><span class="op" id="3487030">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487036">z</span><span class="op" id="3487037">.</span><span class="ident" id="3487038">low</span>&nbsp;<span class="op" id="3487042">^=</span>&nbsp;<span class="ident" id="3487045">t</span><span class="op" id="3487046">.</span><span class="ident" id="3487047">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487054">z</span><span class="op" id="3487055">.</span><span class="ident" id="3487056">high</span>&nbsp;<span class="op" id="3487061">^=</span>&nbsp;<span class="ident" id="3487064">t</span><span class="op" id="3487065">.</span><span class="ident" id="3487066">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487074">word</span>&nbsp;<span class="op" id="3487079">&gt;&gt;=</span>&nbsp;<span class="num" id="3487083">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487090">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487094">*</span><span class="ident" id="3487095">y</span>&nbsp;<span class="op" id="3487097">=</span>&nbsp;<span class="ident" id="3487099">z</span><br>
<span class="lineno"></span><span class="op" id="3487101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3487104">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3487179">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3487255">func</span>&nbsp;<span class="op" id="3487260">(</span><span class="ident" id="3487261">g</span>&nbsp;<span class="op" id="3487263">*</span><span class="ident" id="3487264">gcm</span><span class="op" id="3487267">)</span>&nbsp;<span class="ident" id="3487269">updateBlocks</span><span class="op" id="3487281">(</span><span class="ident" id="3487282">y</span>&nbsp;<span class="op" id="3487284">*</span><span class="ident" id="3487285">gcmFieldElement</span><span class="op" id="3487300">,</span>&nbsp;<span class="ident" id="3487302">blocks</span>&nbsp;<span class="op" id="3487309">[</span><span class="op" id="3487310">]</span><span class="builtintype" id="3487311">byte</span><span class="op" id="3487315">)</span>&nbsp;<span class="op" id="3487317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487320">for</span>&nbsp;<span class="builtinfunc" id="3487324">len</span><span class="op" id="3487327">(</span><span class="ident" id="3487328">blocks</span><span class="op" id="3487334">)</span>&nbsp;<span class="op" id="3487336">&gt;</span>&nbsp;<span class="num" id="3487338">0</span>&nbsp;<span class="op" id="3487340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487344">y</span><span class="op" id="3487345">.</span><span class="ident" id="3487346">low</span>&nbsp;<span class="op" id="3487350">^=</span>&nbsp;<span class="ident" id="3487353">getUint64</span><span class="op" id="3487362">(</span><span class="ident" id="3487363">blocks</span><span class="op" id="3487369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487373">y</span><span class="op" id="3487374">.</span><span class="ident" id="3487375">high</span>&nbsp;<span class="op" id="3487380">^=</span>&nbsp;<span class="ident" id="3487383">getUint64</span><span class="op" id="3487392">(</span><span class="ident" id="3487393">blocks</span><span class="op" id="3487399">[</span><span class="num" id="3487400">8</span><span class="op" id="3487401">:</span><span class="op" id="3487402">]</span><span class="op" id="3487403">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487407">g</span><span class="op" id="3487408">.</span><span class="ident" id="3487409">mul</span><span class="op" id="3487412">(</span><span class="ident" id="3487413">y</span><span class="op" id="3487414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487418">blocks</span>&nbsp;<span class="op" id="3487425">=</span>&nbsp;<span class="ident" id="3487427">blocks</span><span class="op" id="3487433">[</span><span class="ident" id="3487434">gcmBlockSize</span><span class="op" id="3487446">:</span><span class="op" id="3487447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487450">}</span><br>
<span class="lineno"></span><span class="op" id="3487452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3487455">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3487530">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3487604">func</span>&nbsp;<span class="op" id="3487609">(</span><span class="ident" id="3487610">g</span>&nbsp;<span class="op" id="3487612">*</span><span class="ident" id="3487613">gcm</span><span class="op" id="3487616">)</span>&nbsp;<span class="ident" id="3487618">update</span><span class="op" id="3487624">(</span><span class="ident" id="3487625">y</span>&nbsp;<span class="op" id="3487627">*</span><span class="ident" id="3487628">gcmFieldElement</span><span class="op" id="3487643">,</span>&nbsp;<span class="ident" id="3487645">data</span>&nbsp;<span class="op" id="3487650">[</span><span class="op" id="3487651">]</span><span class="builtintype" id="3487652">byte</span><span class="op" id="3487656">)</span>&nbsp;<span class="op" id="3487658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487661">fullBlocks</span>&nbsp;<span class="op" id="3487672">:=</span>&nbsp;<span class="op" id="3487675">(</span><span class="builtinfunc" id="3487676">len</span><span class="op" id="3487679">(</span><span class="ident" id="3487680">data</span><span class="op" id="3487684">)</span>&nbsp;<span class="op" id="3487686">&gt;&gt;</span>&nbsp;<span class="num" id="3487689">4</span><span class="op" id="3487690">)</span>&nbsp;<span class="op" id="3487692">&lt;&lt;</span>&nbsp;<span class="num" id="3487695">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487698">g</span><span class="op" id="3487699">.</span><span class="ident" id="3487700">updateBlocks</span><span class="op" id="3487712">(</span><span class="ident" id="3487713">y</span><span class="op" id="3487714">,</span>&nbsp;<span class="ident" id="3487716">data</span><span class="op" id="3487720">[</span><span class="op" id="3487721">:</span><span class="ident" id="3487722">fullBlocks</span><span class="op" id="3487732">]</span><span class="op" id="3487733">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487737">if</span>&nbsp;<span class="builtinfunc" id="3487740">len</span><span class="op" id="3487743">(</span><span class="ident" id="3487744">data</span><span class="op" id="3487748">)</span>&nbsp;<span class="op" id="3487750">!=</span>&nbsp;<span class="ident" id="3487753">fullBlocks</span>&nbsp;<span class="op" id="3487764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487768">var</span>&nbsp;<span class="ident" id="3487772">partialBlock</span>&nbsp;<span class="op" id="3487785">[</span><span class="ident" id="3487786">gcmBlockSize</span><span class="op" id="3487798">]</span><span class="builtintype" id="3487799">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3487806">copy</span><span class="op" id="3487810">(</span><span class="ident" id="3487811">partialBlock</span><span class="op" id="3487823">[</span><span class="op" id="3487824">:</span><span class="op" id="3487825">]</span><span class="op" id="3487826">,</span>&nbsp;<span class="ident" id="3487828">data</span><span class="op" id="3487832">[</span><span class="ident" id="3487833">fullBlocks</span><span class="op" id="3487843">:</span><span class="op" id="3487844">]</span><span class="op" id="3487845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487849">g</span><span class="op" id="3487850">.</span><span class="ident" id="3487851">updateBlocks</span><span class="op" id="3487863">(</span><span class="ident" id="3487864">y</span><span class="op" id="3487865">,</span>&nbsp;<span class="ident" id="3487867">partialBlock</span><span class="op" id="3487879">[</span><span class="op" id="3487880">:</span><span class="op" id="3487881">]</span><span class="op" id="3487882">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3487885">}</span><br>
<span class="lineno"></span><span class="op" id="3487887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3487890">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3487968">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3487990">func</span>&nbsp;<span class="ident" id="3487995">gcmInc32</span><span class="op" id="3488003">(</span><span class="ident" id="3488004">counterBlock</span>&nbsp;<span class="op" id="3488017">*</span><span class="op" id="3488018">[</span><span class="num" id="3488019">16</span><span class="op" id="3488021">]</span><span class="builtintype" id="3488022">byte</span><span class="op" id="3488026">)</span>&nbsp;<span class="op" id="3488028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488031">for</span>&nbsp;<span class="ident" id="3488035">i</span>&nbsp;<span class="op" id="3488037">:=</span>&nbsp;<span class="ident" id="3488040">gcmBlockSize</span>&nbsp;<span class="op" id="3488053">-</span>&nbsp;<span class="num" id="3488055">1</span><span class="op" id="3488056">;</span>&nbsp;<span class="ident" id="3488058">i</span>&nbsp;<span class="op" id="3488060">&gt;=</span>&nbsp;<span class="ident" id="3488063">gcmBlockSize</span><span class="op" id="3488075">-</span><span class="num" id="3488076">4</span><span class="op" id="3488077">;</span>&nbsp;<span class="ident" id="3488079">i</span><span class="op" id="3488080">--</span>&nbsp;<span class="op" id="3488083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488087">counterBlock</span><span class="op" id="3488099">[</span><span class="ident" id="3488100">i</span><span class="op" id="3488101">]</span><span class="op" id="3488102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488107">if</span>&nbsp;<span class="ident" id="3488110">counterBlock</span><span class="op" id="3488122">[</span><span class="ident" id="3488123">i</span><span class="op" id="3488124">]</span>&nbsp;<span class="op" id="3488126">!=</span>&nbsp;<span class="num" id="3488129">0</span>&nbsp;<span class="op" id="3488131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488136">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488147">}</span><br>
<span class="lineno"></span><span class="op" id="3488149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3488152">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3488230">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3488310">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3488389">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3488464">func</span>&nbsp;<span class="ident" id="3488469">sliceForAppend</span><span class="op" id="3488483">(</span><span class="ident" id="3488484">in</span>&nbsp;<span class="op" id="3488487">[</span><span class="op" id="3488488">]</span><span class="builtintype" id="3488489">byte</span><span class="op" id="3488493">,</span>&nbsp;<span class="ident" id="3488495">n</span>&nbsp;<span class="builtintype" id="3488497">int</span><span class="op" id="3488500">)</span>&nbsp;<span class="op" id="3488502">(</span><span class="ident" id="3488503">head</span><span class="op" id="3488507">,</span>&nbsp;<span class="ident" id="3488509">tail</span>&nbsp;<span class="op" id="3488514">[</span><span class="op" id="3488515">]</span><span class="builtintype" id="3488516">byte</span><span class="op" id="3488520">)</span>&nbsp;<span class="op" id="3488522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488525">if</span>&nbsp;<span class="ident" id="3488528">total</span>&nbsp;<span class="op" id="3488534">:=</span>&nbsp;<span class="builtinfunc" id="3488537">len</span><span class="op" id="3488540">(</span><span class="ident" id="3488541">in</span><span class="op" id="3488543">)</span>&nbsp;<span class="op" id="3488545">+</span>&nbsp;<span class="ident" id="3488547">n</span><span class="op" id="3488548">;</span>&nbsp;<span class="builtinfunc" id="3488550">cap</span><span class="op" id="3488553">(</span><span class="ident" id="3488554">in</span><span class="op" id="3488556">)</span>&nbsp;<span class="op" id="3488558">&gt;=</span>&nbsp;<span class="ident" id="3488561">total</span>&nbsp;<span class="op" id="3488567">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488571">head</span>&nbsp;<span class="op" id="3488576">=</span>&nbsp;<span class="ident" id="3488578">in</span><span class="op" id="3488580">[</span><span class="op" id="3488581">:</span><span class="ident" id="3488582">total</span><span class="op" id="3488587">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488590">}</span>&nbsp;<span class="keyword" id="3488592">else</span>&nbsp;<span class="op" id="3488597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488601">head</span>&nbsp;<span class="op" id="3488606">=</span>&nbsp;<span class="builtinfunc" id="3488608">make</span><span class="op" id="3488612">(</span><span class="op" id="3488613">[</span><span class="op" id="3488614">]</span><span class="builtintype" id="3488615">byte</span><span class="op" id="3488619">,</span>&nbsp;<span class="ident" id="3488621">total</span><span class="op" id="3488626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3488630">copy</span><span class="op" id="3488634">(</span><span class="ident" id="3488635">head</span><span class="op" id="3488639">,</span>&nbsp;<span class="ident" id="3488641">in</span><span class="op" id="3488643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3488646">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488649">tail</span>&nbsp;<span class="op" id="3488654">=</span>&nbsp;<span class="ident" id="3488656">head</span><span class="op" id="3488660">[</span><span class="builtinfunc" id="3488661">len</span><span class="op" id="3488664">(</span><span class="ident" id="3488665">in</span><span class="op" id="3488667">)</span><span class="op" id="3488668">:</span><span class="op" id="3488669">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488672">return</span><br>
<span class="lineno"></span><span class="op" id="3488679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3488682">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3488747">func</span>&nbsp;<span class="op" id="3488752">(</span><span class="ident" id="3488753">g</span>&nbsp;<span class="op" id="3488755">*</span><span class="ident" id="3488756">gcm</span><span class="op" id="3488759">)</span>&nbsp;<span class="ident" id="3488761">counterCrypt</span><span class="op" id="3488773">(</span><span class="ident" id="3488774">out</span><span class="op" id="3488777">,</span>&nbsp;<span class="ident" id="3488779">in</span>&nbsp;<span class="op" id="3488782">[</span><span class="op" id="3488783">]</span><span class="builtintype" id="3488784">byte</span><span class="op" id="3488788">,</span>&nbsp;<span class="ident" id="3488790">counter</span>&nbsp;<span class="op" id="3488798">*</span><span class="op" id="3488799">[</span><span class="ident" id="3488800">gcmBlockSize</span><span class="op" id="3488812">]</span><span class="builtintype" id="3488813">byte</span><span class="op" id="3488817">)</span>&nbsp;<span class="op" id="3488819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488822">var</span>&nbsp;<span class="ident" id="3488826">mask</span>&nbsp;<span class="op" id="3488831">[</span><span class="ident" id="3488832">gcmBlockSize</span><span class="op" id="3488844">]</span><span class="builtintype" id="3488845">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488852">for</span>&nbsp;<span class="builtinfunc" id="3488856">len</span><span class="op" id="3488859">(</span><span class="ident" id="3488860">in</span><span class="op" id="3488862">)</span>&nbsp;<span class="op" id="3488864">&gt;=</span>&nbsp;<span class="ident" id="3488867">gcmBlockSize</span>&nbsp;<span class="op" id="3488880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488884">g</span><span class="op" id="3488885">.</span><span class="ident" id="3488886">cipher</span><span class="op" id="3488892">.</span><span class="ident" id="3488893">Encrypt</span><span class="op" id="3488900">(</span><span class="ident" id="3488901">mask</span><span class="op" id="3488905">[</span><span class="op" id="3488906">:</span><span class="op" id="3488907">]</span><span class="op" id="3488908">,</span>&nbsp;<span class="ident" id="3488910">counter</span><span class="op" id="3488917">[</span><span class="op" id="3488918">:</span><span class="op" id="3488919">]</span><span class="op" id="3488920">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488924">gcmInc32</span><span class="op" id="3488932">(</span><span class="ident" id="3488933">counter</span><span class="op" id="3488940">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488945">xorWords</span><span class="op" id="3488953">(</span><span class="ident" id="3488954">out</span><span class="op" id="3488957">,</span>&nbsp;<span class="ident" id="3488959">in</span><span class="op" id="3488961">,</span>&nbsp;<span class="ident" id="3488963">mask</span><span class="op" id="3488967">[</span><span class="op" id="3488968">:</span><span class="op" id="3488969">]</span><span class="op" id="3488970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488974">out</span>&nbsp;<span class="op" id="3488978">=</span>&nbsp;<span class="ident" id="3488980">out</span><span class="op" id="3488983">[</span><span class="ident" id="3488984">gcmBlockSize</span><span class="op" id="3488996">:</span><span class="op" id="3488997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489001">in</span>&nbsp;<span class="op" id="3489004">=</span>&nbsp;<span class="ident" id="3489006">in</span><span class="op" id="3489008">[</span><span class="ident" id="3489009">gcmBlockSize</span><span class="op" id="3489021">:</span><span class="op" id="3489022">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489029">if</span>&nbsp;<span class="builtinfunc" id="3489032">len</span><span class="op" id="3489035">(</span><span class="ident" id="3489036">in</span><span class="op" id="3489038">)</span>&nbsp;<span class="op" id="3489040">&gt;</span>&nbsp;<span class="num" id="3489042">0</span>&nbsp;<span class="op" id="3489044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489048">g</span><span class="op" id="3489049">.</span><span class="ident" id="3489050">cipher</span><span class="op" id="3489056">.</span><span class="ident" id="3489057">Encrypt</span><span class="op" id="3489064">(</span><span class="ident" id="3489065">mask</span><span class="op" id="3489069">[</span><span class="op" id="3489070">:</span><span class="op" id="3489071">]</span><span class="op" id="3489072">,</span>&nbsp;<span class="ident" id="3489074">counter</span><span class="op" id="3489081">[</span><span class="op" id="3489082">:</span><span class="op" id="3489083">]</span><span class="op" id="3489084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489088">gcmInc32</span><span class="op" id="3489096">(</span><span class="ident" id="3489097">counter</span><span class="op" id="3489104">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489108">xorBytes</span><span class="op" id="3489116">(</span><span class="ident" id="3489117">out</span><span class="op" id="3489120">,</span>&nbsp;<span class="ident" id="3489122">in</span><span class="op" id="3489124">,</span>&nbsp;<span class="ident" id="3489126">mask</span><span class="op" id="3489130">[</span><span class="op" id="3489131">:</span><span class="op" id="3489132">]</span><span class="op" id="3489133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489136">}</span><br>
<span class="lineno"></span><span class="op" id="3489138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3489141">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3489217">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3489258">func</span>&nbsp;<span class="op" id="3489263">(</span><span class="ident" id="3489264">g</span>&nbsp;<span class="op" id="3489266">*</span><span class="ident" id="3489267">gcm</span><span class="op" id="3489270">)</span>&nbsp;<span class="ident" id="3489272">auth</span><span class="op" id="3489276">(</span><span class="ident" id="3489277">out</span><span class="op" id="3489280">,</span>&nbsp;<span class="ident" id="3489282">ciphertext</span><span class="op" id="3489292">,</span>&nbsp;<span class="ident" id="3489294">additionalData</span>&nbsp;<span class="op" id="3489309">[</span><span class="op" id="3489310">]</span><span class="builtintype" id="3489311">byte</span><span class="op" id="3489315">,</span>&nbsp;<span class="ident" id="3489317">tagMask</span>&nbsp;<span class="op" id="3489325">*</span><span class="op" id="3489326">[</span><span class="ident" id="3489327">gcmTagSize</span><span class="op" id="3489337">]</span><span class="builtintype" id="3489338">byte</span><span class="op" id="3489342">)</span>&nbsp;<span class="op" id="3489344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489347">var</span>&nbsp;<span class="ident" id="3489351">y</span>&nbsp;<span class="ident" id="3489353">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489370">g</span><span class="op" id="3489371">.</span><span class="ident" id="3489372">update</span><span class="op" id="3489378">(</span><span class="op" id="3489379">&amp;</span><span class="ident" id="3489380">y</span><span class="op" id="3489381">,</span>&nbsp;<span class="ident" id="3489383">additionalData</span><span class="op" id="3489397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489400">g</span><span class="op" id="3489401">.</span><span class="ident" id="3489402">update</span><span class="op" id="3489408">(</span><span class="op" id="3489409">&amp;</span><span class="ident" id="3489410">y</span><span class="op" id="3489411">,</span>&nbsp;<span class="ident" id="3489413">ciphertext</span><span class="op" id="3489423">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489427">y</span><span class="op" id="3489428">.</span><span class="ident" id="3489429">low</span>&nbsp;<span class="op" id="3489433">^=</span>&nbsp;<span class="ident" id="3489436">uint64</span><span class="op" id="3489442">(</span><span class="builtinfunc" id="3489443">len</span><span class="op" id="3489446">(</span><span class="ident" id="3489447">additionalData</span><span class="op" id="3489461">)</span><span class="op" id="3489462">)</span>&nbsp;<span class="op" id="3489464">*</span>&nbsp;<span class="num" id="3489466">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489469">y</span><span class="op" id="3489470">.</span><span class="ident" id="3489471">high</span>&nbsp;<span class="op" id="3489476">^=</span>&nbsp;<span class="ident" id="3489479">uint64</span><span class="op" id="3489485">(</span><span class="builtinfunc" id="3489486">len</span><span class="op" id="3489489">(</span><span class="ident" id="3489490">ciphertext</span><span class="op" id="3489500">)</span><span class="op" id="3489501">)</span>&nbsp;<span class="op" id="3489503">*</span>&nbsp;<span class="num" id="3489505">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489509">g</span><span class="op" id="3489510">.</span><span class="ident" id="3489511">mul</span><span class="op" id="3489514">(</span><span class="op" id="3489515">&amp;</span><span class="ident" id="3489516">y</span><span class="op" id="3489517">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489521">putUint64</span><span class="op" id="3489530">(</span><span class="ident" id="3489531">out</span><span class="op" id="3489534">,</span>&nbsp;<span class="ident" id="3489536">y</span><span class="op" id="3489537">.</span><span class="ident" id="3489538">low</span><span class="op" id="3489541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489544">putUint64</span><span class="op" id="3489553">(</span><span class="ident" id="3489554">out</span><span class="op" id="3489557">[</span><span class="num" id="3489558">8</span><span class="op" id="3489559">:</span><span class="op" id="3489560">]</span><span class="op" id="3489561">,</span>&nbsp;<span class="ident" id="3489563">y</span><span class="op" id="3489564">.</span><span class="ident" id="3489565">high</span><span class="op" id="3489569">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489573">xorWords</span><span class="op" id="3489581">(</span><span class="ident" id="3489582">out</span><span class="op" id="3489585">,</span>&nbsp;<span class="ident" id="3489587">out</span><span class="op" id="3489590">,</span>&nbsp;<span class="ident" id="3489592">tagMask</span><span class="op" id="3489599">[</span><span class="op" id="3489600">:</span><span class="op" id="3489601">]</span><span class="op" id="3489602">)</span><br>
<span class="lineno">320</span><span class="op" id="3489604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3489607">func</span>&nbsp;<span class="ident" id="3489612">getUint64</span><span class="op" id="3489621">(</span><span class="ident" id="3489622">data</span>&nbsp;<span class="op" id="3489627">[</span><span class="op" id="3489628">]</span><span class="builtintype" id="3489629">byte</span><span class="op" id="3489633">)</span>&nbsp;<span class="ident" id="3489635">uint64</span>&nbsp;<span class="op" id="3489642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489645">r</span>&nbsp;<span class="op" id="3489647">:=</span>&nbsp;<span class="ident" id="3489650">uint64</span><span class="op" id="3489656">(</span><span class="ident" id="3489657">data</span><span class="op" id="3489661">[</span><span class="num" id="3489662">0</span><span class="op" id="3489663">]</span><span class="op" id="3489664">)</span><span class="op" id="3489665">&lt;&lt;</span><span class="num" id="3489667">56</span>&nbsp;<span class="op" id="3489670">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489674">uint64</span><span class="op" id="3489680">(</span><span class="ident" id="3489681">data</span><span class="op" id="3489685">[</span><span class="num" id="3489686">1</span><span class="op" id="3489687">]</span><span class="op" id="3489688">)</span><span class="op" id="3489689">&lt;&lt;</span><span class="num" id="3489691">48</span>&nbsp;<span class="op" id="3489694">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489698">uint64</span><span class="op" id="3489704">(</span><span class="ident" id="3489705">data</span><span class="op" id="3489709">[</span><span class="num" id="3489710">2</span><span class="op" id="3489711">]</span><span class="op" id="3489712">)</span><span class="op" id="3489713">&lt;&lt;</span><span class="num" id="3489715">40</span>&nbsp;<span class="op" id="3489718">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489722">uint64</span><span class="op" id="3489728">(</span><span class="ident" id="3489729">data</span><span class="op" id="3489733">[</span><span class="num" id="3489734">3</span><span class="op" id="3489735">]</span><span class="op" id="3489736">)</span><span class="op" id="3489737">&lt;&lt;</span><span class="num" id="3489739">32</span>&nbsp;<span class="op" id="3489742">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489746">uint64</span><span class="op" id="3489752">(</span><span class="ident" id="3489753">data</span><span class="op" id="3489757">[</span><span class="num" id="3489758">4</span><span class="op" id="3489759">]</span><span class="op" id="3489760">)</span><span class="op" id="3489761">&lt;&lt;</span><span class="num" id="3489763">24</span>&nbsp;<span class="op" id="3489766">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489770">uint64</span><span class="op" id="3489776">(</span><span class="ident" id="3489777">data</span><span class="op" id="3489781">[</span><span class="num" id="3489782">5</span><span class="op" id="3489783">]</span><span class="op" id="3489784">)</span><span class="op" id="3489785">&lt;&lt;</span><span class="num" id="3489787">16</span>&nbsp;<span class="op" id="3489790">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489794">uint64</span><span class="op" id="3489800">(</span><span class="ident" id="3489801">data</span><span class="op" id="3489805">[</span><span class="num" id="3489806">6</span><span class="op" id="3489807">]</span><span class="op" id="3489808">)</span><span class="op" id="3489809">&lt;&lt;</span><span class="num" id="3489811">8</span>&nbsp;<span class="op" id="3489813">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489817">uint64</span><span class="op" id="3489823">(</span><span class="ident" id="3489824">data</span><span class="op" id="3489828">[</span><span class="num" id="3489829">7</span><span class="op" id="3489830">]</span><span class="op" id="3489831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489834">return</span>&nbsp;<span class="ident" id="3489841">r</span><br>
<span class="lineno"></span><span class="op" id="3489843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3489846">func</span>&nbsp;<span class="ident" id="3489851">putUint64</span><span class="op" id="3489860">(</span><span class="ident" id="3489861">out</span>&nbsp;<span class="op" id="3489865">[</span><span class="op" id="3489866">]</span><span class="builtintype" id="3489867">byte</span><span class="op" id="3489871">,</span>&nbsp;<span class="ident" id="3489873">v</span>&nbsp;<span class="ident" id="3489875">uint64</span><span class="op" id="3489881">)</span>&nbsp;<span class="op" id="3489883">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489886">out</span><span class="op" id="3489889">[</span><span class="num" id="3489890">0</span><span class="op" id="3489891">]</span>&nbsp;<span class="op" id="3489893">=</span>&nbsp;<span class="builtintype" id="3489895">byte</span><span class="op" id="3489899">(</span><span class="ident" id="3489900">v</span>&nbsp;<span class="op" id="3489902">&gt;&gt;</span>&nbsp;<span class="num" id="3489905">56</span><span class="op" id="3489907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489910">out</span><span class="op" id="3489913">[</span><span class="num" id="3489914">1</span><span class="op" id="3489915">]</span>&nbsp;<span class="op" id="3489917">=</span>&nbsp;<span class="builtintype" id="3489919">byte</span><span class="op" id="3489923">(</span><span class="ident" id="3489924">v</span>&nbsp;<span class="op" id="3489926">&gt;&gt;</span>&nbsp;<span class="num" id="3489929">48</span><span class="op" id="3489931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489934">out</span><span class="op" id="3489937">[</span><span class="num" id="3489938">2</span><span class="op" id="3489939">]</span>&nbsp;<span class="op" id="3489941">=</span>&nbsp;<span class="builtintype" id="3489943">byte</span><span class="op" id="3489947">(</span><span class="ident" id="3489948">v</span>&nbsp;<span class="op" id="3489950">&gt;&gt;</span>&nbsp;<span class="num" id="3489953">40</span><span class="op" id="3489955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489958">out</span><span class="op" id="3489961">[</span><span class="num" id="3489962">3</span><span class="op" id="3489963">]</span>&nbsp;<span class="op" id="3489965">=</span>&nbsp;<span class="builtintype" id="3489967">byte</span><span class="op" id="3489971">(</span><span class="ident" id="3489972">v</span>&nbsp;<span class="op" id="3489974">&gt;&gt;</span>&nbsp;<span class="num" id="3489977">32</span><span class="op" id="3489979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489982">out</span><span class="op" id="3489985">[</span><span class="num" id="3489986">4</span><span class="op" id="3489987">]</span>&nbsp;<span class="op" id="3489989">=</span>&nbsp;<span class="builtintype" id="3489991">byte</span><span class="op" id="3489995">(</span><span class="ident" id="3489996">v</span>&nbsp;<span class="op" id="3489998">&gt;&gt;</span>&nbsp;<span class="num" id="3490001">24</span><span class="op" id="3490003">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490006">out</span><span class="op" id="3490009">[</span><span class="num" id="3490010">5</span><span class="op" id="3490011">]</span>&nbsp;<span class="op" id="3490013">=</span>&nbsp;<span class="builtintype" id="3490015">byte</span><span class="op" id="3490019">(</span><span class="ident" id="3490020">v</span>&nbsp;<span class="op" id="3490022">&gt;&gt;</span>&nbsp;<span class="num" id="3490025">16</span><span class="op" id="3490027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490030">out</span><span class="op" id="3490033">[</span><span class="num" id="3490034">6</span><span class="op" id="3490035">]</span>&nbsp;<span class="op" id="3490037">=</span>&nbsp;<span class="builtintype" id="3490039">byte</span><span class="op" id="3490043">(</span><span class="ident" id="3490044">v</span>&nbsp;<span class="op" id="3490046">&gt;&gt;</span>&nbsp;<span class="num" id="3490049">8</span><span class="op" id="3490050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490053">out</span><span class="op" id="3490056">[</span><span class="num" id="3490057">7</span><span class="op" id="3490058">]</span>&nbsp;<span class="op" id="3490060">=</span>&nbsp;<span class="builtintype" id="3490062">byte</span><span class="op" id="3490066">(</span><span class="ident" id="3490067">v</span><span class="op" id="3490068">)</span><br>
<span class="lineno"></span><span class="op" id="3490070">}</span>
</div>
</body>
</html>
