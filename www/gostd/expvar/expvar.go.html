<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5636490">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5636545">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5636599">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5636650">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5636728">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5636804">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5636835">//</span><br>
<span class="lineno"></span><span class="comment" id="5636838">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5636904">//</span><br>
<span class="lineno"></span><span class="comment" id="5636907">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5636977">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5637001">//</span><br>
<span class="lineno"></span><span class="comment" id="5637004">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5637025">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5637055">//</span><br>
<span class="lineno"></span><span class="comment" id="5637058">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5637123">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5637191">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5637241">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5637262">//</span><br>
<span class="lineno"></span><span class="keyword" id="5637265">package</span>&nbsp;<span class="ident" id="5637273">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637281">import</span>&nbsp;<span class="op" id="5637288">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637291">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637300">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637317">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637324">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637331">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637343">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637349">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637360">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637368">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5637379">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5637386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5637389">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5637444">type</span>&nbsp;<span class="ident" id="5637449">Var</span>&nbsp;<span class="keyword" id="5637453">interface</span>&nbsp;<span class="op" id="5637463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637466">String</span><span class="op" id="5637472">(</span><span class="op" id="5637473">)</span>&nbsp;<span class="builtintype" id="5637475">string</span><br>
<span class="lineno">40</span><span class="op" id="5637482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5637485">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5637555">type</span>&nbsp;<span class="ident" id="5637560">Int</span>&nbsp;<span class="keyword" id="5637564">struct</span>&nbsp;<span class="op" id="5637571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637574">mu</span>&nbsp;<span class="ident" id="5637577">sync</span><span class="op" id="5637581">.</span><span class="ident" id="5637582">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637591">i</span>&nbsp;&nbsp;<span class="ident" id="5637594">int64</span><br>
<span class="lineno"></span><span class="op" id="5637600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637603">func</span>&nbsp;<span class="op" id="5637608">(</span><span class="ident" id="5637609">v</span>&nbsp;<span class="op" id="5637611">*</span><span class="ident" id="5637612">Int</span><span class="op" id="5637615">)</span>&nbsp;<span class="ident" id="5637617">String</span><span class="op" id="5637623">(</span><span class="op" id="5637624">)</span>&nbsp;<span class="builtintype" id="5637626">string</span>&nbsp;<span class="op" id="5637633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637636">v</span><span class="op" id="5637637">.</span><span class="ident" id="5637638">mu</span><span class="op" id="5637640">.</span><span class="ident" id="5637641">RLock</span><span class="op" id="5637646">(</span><span class="op" id="5637647">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637650">defer</span>&nbsp;<span class="ident" id="5637656">v</span><span class="op" id="5637657">.</span><span class="ident" id="5637658">mu</span><span class="op" id="5637660">.</span><span class="ident" id="5637661">RUnlock</span><span class="op" id="5637668">(</span><span class="op" id="5637669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637672">return</span>&nbsp;<span class="ident" id="5637679">strconv</span><span class="op" id="5637686">.</span><span class="ident" id="5637687">FormatInt</span><span class="op" id="5637696">(</span><span class="ident" id="5637697">v</span><span class="op" id="5637698">.</span><span class="ident" id="5637699">i</span><span class="op" id="5637700">,</span>&nbsp;<span class="num" id="5637702">10</span><span class="op" id="5637704">)</span><br>
<span class="lineno"></span><span class="op" id="5637706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637709">func</span>&nbsp;<span class="op" id="5637714">(</span><span class="ident" id="5637715">v</span>&nbsp;<span class="op" id="5637717">*</span><span class="ident" id="5637718">Int</span><span class="op" id="5637721">)</span>&nbsp;<span class="ident" id="5637723">Add</span><span class="op" id="5637726">(</span><span class="ident" id="5637727">delta</span>&nbsp;<span class="ident" id="5637733">int64</span><span class="op" id="5637738">)</span>&nbsp;<span class="op" id="5637740">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637743">v</span><span class="op" id="5637744">.</span><span class="ident" id="5637745">mu</span><span class="op" id="5637747">.</span><span class="ident" id="5637748">Lock</span><span class="op" id="5637752">(</span><span class="op" id="5637753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637756">defer</span>&nbsp;<span class="ident" id="5637762">v</span><span class="op" id="5637763">.</span><span class="ident" id="5637764">mu</span><span class="op" id="5637766">.</span><span class="ident" id="5637767">Unlock</span><span class="op" id="5637773">(</span><span class="op" id="5637774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637777">v</span><span class="op" id="5637778">.</span><span class="ident" id="5637779">i</span>&nbsp;<span class="op" id="5637781">+=</span>&nbsp;<span class="ident" id="5637784">delta</span><br>
<span class="lineno"></span><span class="op" id="5637790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5637793">func</span>&nbsp;<span class="op" id="5637798">(</span><span class="ident" id="5637799">v</span>&nbsp;<span class="op" id="5637801">*</span><span class="ident" id="5637802">Int</span><span class="op" id="5637805">)</span>&nbsp;<span class="ident" id="5637807">Set</span><span class="op" id="5637810">(</span><span class="ident" id="5637811">value</span>&nbsp;<span class="ident" id="5637817">int64</span><span class="op" id="5637822">)</span>&nbsp;<span class="op" id="5637824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637827">v</span><span class="op" id="5637828">.</span><span class="ident" id="5637829">mu</span><span class="op" id="5637831">.</span><span class="ident" id="5637832">Lock</span><span class="op" id="5637836">(</span><span class="op" id="5637837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637840">defer</span>&nbsp;<span class="ident" id="5637846">v</span><span class="op" id="5637847">.</span><span class="ident" id="5637848">mu</span><span class="op" id="5637850">.</span><span class="ident" id="5637851">Unlock</span><span class="op" id="5637857">(</span><span class="op" id="5637858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637861">v</span><span class="op" id="5637862">.</span><span class="ident" id="5637863">i</span>&nbsp;<span class="op" id="5637865">=</span>&nbsp;<span class="ident" id="5637867">value</span><br>
<span class="lineno"></span><span class="op" id="5637873">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5637876">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5637946">type</span>&nbsp;<span class="ident" id="5637951">Float</span>&nbsp;<span class="keyword" id="5637957">struct</span>&nbsp;<span class="op" id="5637964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637967">mu</span>&nbsp;<span class="ident" id="5637970">sync</span><span class="op" id="5637974">.</span><span class="ident" id="5637975">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637984">f</span>&nbsp;&nbsp;<span class="builtintype" id="5637987">float64</span><br>
<span class="lineno">70</span><span class="op" id="5637995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637998">func</span>&nbsp;<span class="op" id="5638003">(</span><span class="ident" id="5638004">v</span>&nbsp;<span class="op" id="5638006">*</span><span class="ident" id="5638007">Float</span><span class="op" id="5638012">)</span>&nbsp;<span class="ident" id="5638014">String</span><span class="op" id="5638020">(</span><span class="op" id="5638021">)</span>&nbsp;<span class="builtintype" id="5638023">string</span>&nbsp;<span class="op" id="5638030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638033">v</span><span class="op" id="5638034">.</span><span class="ident" id="5638035">mu</span><span class="op" id="5638037">.</span><span class="ident" id="5638038">RLock</span><span class="op" id="5638043">(</span><span class="op" id="5638044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638047">defer</span>&nbsp;<span class="ident" id="5638053">v</span><span class="op" id="5638054">.</span><span class="ident" id="5638055">mu</span><span class="op" id="5638057">.</span><span class="ident" id="5638058">RUnlock</span><span class="op" id="5638065">(</span><span class="op" id="5638066">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638069">return</span>&nbsp;<span class="ident" id="5638076">strconv</span><span class="op" id="5638083">.</span><span class="ident" id="5638084">FormatFloat</span><span class="op" id="5638095">(</span><span class="ident" id="5638096">v</span><span class="op" id="5638097">.</span><span class="ident" id="5638098">f</span><span class="op" id="5638099">,</span>&nbsp;<span class="string" id="5638101">&#39;g&#39;</span><span class="op" id="5638104">,</span>&nbsp;<span class="op" id="5638106">-</span><span class="num" id="5638107">1</span><span class="op" id="5638108">,</span>&nbsp;<span class="num" id="5638110">64</span><span class="op" id="5638112">)</span><br>
<span class="lineno"></span><span class="op" id="5638114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5638117">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5638141">func</span>&nbsp;<span class="op" id="5638146">(</span><span class="ident" id="5638147">v</span>&nbsp;<span class="op" id="5638149">*</span><span class="ident" id="5638150">Float</span><span class="op" id="5638155">)</span>&nbsp;<span class="ident" id="5638157">Add</span><span class="op" id="5638160">(</span><span class="ident" id="5638161">delta</span>&nbsp;<span class="builtintype" id="5638167">float64</span><span class="op" id="5638174">)</span>&nbsp;<span class="op" id="5638176">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638179">v</span><span class="op" id="5638180">.</span><span class="ident" id="5638181">mu</span><span class="op" id="5638183">.</span><span class="ident" id="5638184">Lock</span><span class="op" id="5638188">(</span><span class="op" id="5638189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638192">defer</span>&nbsp;<span class="ident" id="5638198">v</span><span class="op" id="5638199">.</span><span class="ident" id="5638200">mu</span><span class="op" id="5638202">.</span><span class="ident" id="5638203">Unlock</span><span class="op" id="5638209">(</span><span class="op" id="5638210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638213">v</span><span class="op" id="5638214">.</span><span class="ident" id="5638215">f</span>&nbsp;<span class="op" id="5638217">+=</span>&nbsp;<span class="ident" id="5638220">delta</span><br>
<span class="lineno"></span><span class="op" id="5638226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5638229">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5638253">func</span>&nbsp;<span class="op" id="5638258">(</span><span class="ident" id="5638259">v</span>&nbsp;<span class="op" id="5638261">*</span><span class="ident" id="5638262">Float</span><span class="op" id="5638267">)</span>&nbsp;<span class="ident" id="5638269">Set</span><span class="op" id="5638272">(</span><span class="ident" id="5638273">value</span>&nbsp;<span class="builtintype" id="5638279">float64</span><span class="op" id="5638286">)</span>&nbsp;<span class="op" id="5638288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638291">v</span><span class="op" id="5638292">.</span><span class="ident" id="5638293">mu</span><span class="op" id="5638295">.</span><span class="ident" id="5638296">Lock</span><span class="op" id="5638300">(</span><span class="op" id="5638301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638304">defer</span>&nbsp;<span class="ident" id="5638310">v</span><span class="op" id="5638311">.</span><span class="ident" id="5638312">mu</span><span class="op" id="5638314">.</span><span class="ident" id="5638315">Unlock</span><span class="op" id="5638321">(</span><span class="op" id="5638322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638325">v</span><span class="op" id="5638326">.</span><span class="ident" id="5638327">f</span>&nbsp;<span class="op" id="5638329">=</span>&nbsp;<span class="ident" id="5638331">value</span><br>
<span class="lineno">90</span><span class="op" id="5638337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5638340">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5638413">type</span>&nbsp;<span class="ident" id="5638418">Map</span>&nbsp;<span class="keyword" id="5638422">struct</span>&nbsp;<span class="op" id="5638429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638432">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5638437">sync</span><span class="op" id="5638441">.</span><span class="ident" id="5638442">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638451">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638456">map</span><span class="op" id="5638459">[</span><span class="builtintype" id="5638460">string</span><span class="op" id="5638466">]</span><span class="ident" id="5638467">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638472">keys</span>&nbsp;<span class="op" id="5638477">[</span><span class="op" id="5638478">]</span><span class="builtintype" id="5638479">string</span>&nbsp;<span class="comment" id="5638486">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5638496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5638499">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5638547">type</span>&nbsp;<span class="ident" id="5638552">KeyValue</span>&nbsp;<span class="keyword" id="5638561">struct</span>&nbsp;<span class="op" id="5638568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638571">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5638577">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638585">Value</span>&nbsp;<span class="ident" id="5638591">Var</span><br>
<span class="lineno"></span><span class="op" id="5638595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5638598">func</span>&nbsp;<span class="op" id="5638603">(</span><span class="ident" id="5638604">v</span>&nbsp;<span class="op" id="5638606">*</span><span class="ident" id="5638607">Map</span><span class="op" id="5638610">)</span>&nbsp;<span class="ident" id="5638612">String</span><span class="op" id="5638618">(</span><span class="op" id="5638619">)</span>&nbsp;<span class="builtintype" id="5638621">string</span>&nbsp;<span class="op" id="5638628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638631">v</span><span class="op" id="5638632">.</span><span class="ident" id="5638633">mu</span><span class="op" id="5638635">.</span><span class="ident" id="5638636">RLock</span><span class="op" id="5638641">(</span><span class="op" id="5638642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638645">defer</span>&nbsp;<span class="ident" id="5638651">v</span><span class="op" id="5638652">.</span><span class="ident" id="5638653">mu</span><span class="op" id="5638655">.</span><span class="ident" id="5638656">RUnlock</span><span class="op" id="5638663">(</span><span class="op" id="5638664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638667">var</span>&nbsp;<span class="ident" id="5638671">b</span>&nbsp;<span class="ident" id="5638673">bytes</span><span class="op" id="5638678">.</span><span class="ident" id="5638679">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638687">fmt</span><span class="op" id="5638690">.</span><span class="ident" id="5638691">Fprintf</span><span class="op" id="5638698">(</span><span class="op" id="5638699">&amp;</span><span class="ident" id="5638700">b</span><span class="op" id="5638701">,</span>&nbsp;<span class="string" id="5638703">&#34;{&#34;</span><span class="op" id="5638706">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638709">first</span>&nbsp;<span class="op" id="5638715">:=</span>&nbsp;<span class="builtintype" id="5638718">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638724">v</span><span class="op" id="5638725">.</span><span class="ident" id="5638726">doLocked</span><span class="op" id="5638734">(</span><span class="keyword" id="5638735">func</span><span class="op" id="5638739">(</span><span class="ident" id="5638740">kv</span>&nbsp;<span class="ident" id="5638743">KeyValue</span><span class="op" id="5638751">)</span>&nbsp;<span class="op" id="5638753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638757">if</span>&nbsp;<span class="op" id="5638760">!</span><span class="ident" id="5638761">first</span>&nbsp;<span class="op" id="5638767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638772">fmt</span><span class="op" id="5638775">.</span><span class="ident" id="5638776">Fprintf</span><span class="op" id="5638783">(</span><span class="op" id="5638784">&amp;</span><span class="ident" id="5638785">b</span><span class="op" id="5638786">,</span>&nbsp;<span class="string" id="5638788">&#34;,&nbsp;&#34;</span><span class="op" id="5638792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638796">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638800">fmt</span><span class="op" id="5638803">.</span><span class="ident" id="5638804">Fprintf</span><span class="op" id="5638811">(</span><span class="op" id="5638812">&amp;</span><span class="ident" id="5638813">b</span><span class="op" id="5638814">,</span>&nbsp;<span class="string" id="5638816">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5638824">,</span>&nbsp;<span class="ident" id="5638826">kv</span><span class="op" id="5638828">.</span><span class="ident" id="5638829">Key</span><span class="op" id="5638832">,</span>&nbsp;<span class="ident" id="5638834">kv</span><span class="op" id="5638836">.</span><span class="ident" id="5638837">Value</span><span class="op" id="5638842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638846">first</span>&nbsp;<span class="op" id="5638852">=</span>&nbsp;<span class="builtintype" id="5638854">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638861">}</span><span class="op" id="5638862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638865">fmt</span><span class="op" id="5638868">.</span><span class="ident" id="5638869">Fprintf</span><span class="op" id="5638876">(</span><span class="op" id="5638877">&amp;</span><span class="ident" id="5638878">b</span><span class="op" id="5638879">,</span>&nbsp;<span class="string" id="5638881">&#34;}&#34;</span><span class="op" id="5638884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638887">return</span>&nbsp;<span class="ident" id="5638894">b</span><span class="op" id="5638895">.</span><span class="ident" id="5638896">String</span><span class="op" id="5638902">(</span><span class="op" id="5638903">)</span><br>
<span class="lineno">120</span><span class="op" id="5638905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5638908">func</span>&nbsp;<span class="op" id="5638913">(</span><span class="ident" id="5638914">v</span>&nbsp;<span class="op" id="5638916">*</span><span class="ident" id="5638917">Map</span><span class="op" id="5638920">)</span>&nbsp;<span class="ident" id="5638922">Init</span><span class="op" id="5638926">(</span><span class="op" id="5638927">)</span>&nbsp;<span class="op" id="5638929">*</span><span class="ident" id="5638930">Map</span>&nbsp;<span class="op" id="5638934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638937">v</span><span class="op" id="5638938">.</span><span class="ident" id="5638939">m</span>&nbsp;<span class="op" id="5638941">=</span>&nbsp;<span class="builtinfunc" id="5638943">make</span><span class="op" id="5638947">(</span><span class="keyword" id="5638948">map</span><span class="op" id="5638951">[</span><span class="builtintype" id="5638952">string</span><span class="op" id="5638958">]</span><span class="ident" id="5638959">Var</span><span class="op" id="5638962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638965">return</span>&nbsp;<span class="ident" id="5638972">v</span><br>
<span class="lineno">125</span><span class="op" id="5638974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5638977">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5639034">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5639068">func</span>&nbsp;<span class="op" id="5639073">(</span><span class="ident" id="5639074">v</span>&nbsp;<span class="op" id="5639076">*</span><span class="ident" id="5639077">Map</span><span class="op" id="5639080">)</span>&nbsp;<span class="ident" id="5639082">updateKeys</span><span class="op" id="5639092">(</span><span class="op" id="5639093">)</span>&nbsp;<span class="op" id="5639095">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639098">if</span>&nbsp;<span class="builtinfunc" id="5639101">len</span><span class="op" id="5639104">(</span><span class="ident" id="5639105">v</span><span class="op" id="5639106">.</span><span class="ident" id="5639107">m</span><span class="op" id="5639108">)</span>&nbsp;<span class="op" id="5639110">==</span>&nbsp;<span class="builtinfunc" id="5639113">len</span><span class="op" id="5639116">(</span><span class="ident" id="5639117">v</span><span class="op" id="5639118">.</span><span class="ident" id="5639119">keys</span><span class="op" id="5639123">)</span>&nbsp;<span class="op" id="5639125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5639129">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639146">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639157">v</span><span class="op" id="5639158">.</span><span class="ident" id="5639159">keys</span>&nbsp;<span class="op" id="5639164">=</span>&nbsp;<span class="ident" id="5639166">v</span><span class="op" id="5639167">.</span><span class="ident" id="5639168">keys</span><span class="op" id="5639172">[</span><span class="op" id="5639173">:</span><span class="num" id="5639174">0</span><span class="op" id="5639175">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639178">for</span>&nbsp;<span class="ident" id="5639182">k</span>&nbsp;<span class="op" id="5639184">:=</span>&nbsp;<span class="keyword" id="5639187">range</span>&nbsp;<span class="ident" id="5639193">v</span><span class="op" id="5639194">.</span><span class="ident" id="5639195">m</span>&nbsp;<span class="op" id="5639197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639201">v</span><span class="op" id="5639202">.</span><span class="ident" id="5639203">keys</span>&nbsp;<span class="op" id="5639208">=</span>&nbsp;<span class="builtinfunc" id="5639210">append</span><span class="op" id="5639216">(</span><span class="ident" id="5639217">v</span><span class="op" id="5639218">.</span><span class="ident" id="5639219">keys</span><span class="op" id="5639223">,</span>&nbsp;<span class="ident" id="5639225">k</span><span class="op" id="5639226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639232">sort</span><span class="op" id="5639236">.</span><span class="ident" id="5639237">Strings</span><span class="op" id="5639244">(</span><span class="ident" id="5639245">v</span><span class="op" id="5639246">.</span><span class="ident" id="5639247">keys</span><span class="op" id="5639251">)</span><br>
<span class="lineno"></span><span class="op" id="5639253">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5639256">func</span>&nbsp;<span class="op" id="5639261">(</span><span class="ident" id="5639262">v</span>&nbsp;<span class="op" id="5639264">*</span><span class="ident" id="5639265">Map</span><span class="op" id="5639268">)</span>&nbsp;<span class="ident" id="5639270">Get</span><span class="op" id="5639273">(</span><span class="ident" id="5639274">key</span>&nbsp;<span class="builtintype" id="5639278">string</span><span class="op" id="5639284">)</span>&nbsp;<span class="ident" id="5639286">Var</span>&nbsp;<span class="op" id="5639290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639293">v</span><span class="op" id="5639294">.</span><span class="ident" id="5639295">mu</span><span class="op" id="5639297">.</span><span class="ident" id="5639298">RLock</span><span class="op" id="5639303">(</span><span class="op" id="5639304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639307">defer</span>&nbsp;<span class="ident" id="5639313">v</span><span class="op" id="5639314">.</span><span class="ident" id="5639315">mu</span><span class="op" id="5639317">.</span><span class="ident" id="5639318">RUnlock</span><span class="op" id="5639325">(</span><span class="op" id="5639326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639329">return</span>&nbsp;<span class="ident" id="5639336">v</span><span class="op" id="5639337">.</span><span class="ident" id="5639338">m</span><span class="op" id="5639339">[</span><span class="ident" id="5639340">key</span><span class="op" id="5639343">]</span><br>
<span class="lineno">145</span><span class="op" id="5639345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5639348">func</span>&nbsp;<span class="op" id="5639353">(</span><span class="ident" id="5639354">v</span>&nbsp;<span class="op" id="5639356">*</span><span class="ident" id="5639357">Map</span><span class="op" id="5639360">)</span>&nbsp;<span class="ident" id="5639362">Set</span><span class="op" id="5639365">(</span><span class="ident" id="5639366">key</span>&nbsp;<span class="builtintype" id="5639370">string</span><span class="op" id="5639376">,</span>&nbsp;<span class="ident" id="5639378">av</span>&nbsp;<span class="ident" id="5639381">Var</span><span class="op" id="5639384">)</span>&nbsp;<span class="op" id="5639386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639389">v</span><span class="op" id="5639390">.</span><span class="ident" id="5639391">mu</span><span class="op" id="5639393">.</span><span class="ident" id="5639394">Lock</span><span class="op" id="5639398">(</span><span class="op" id="5639399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639402">defer</span>&nbsp;<span class="ident" id="5639408">v</span><span class="op" id="5639409">.</span><span class="ident" id="5639410">mu</span><span class="op" id="5639412">.</span><span class="ident" id="5639413">Unlock</span><span class="op" id="5639419">(</span><span class="op" id="5639420">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639423">v</span><span class="op" id="5639424">.</span><span class="ident" id="5639425">m</span><span class="op" id="5639426">[</span><span class="ident" id="5639427">key</span><span class="op" id="5639430">]</span>&nbsp;<span class="op" id="5639432">=</span>&nbsp;<span class="ident" id="5639434">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639438">v</span><span class="op" id="5639439">.</span><span class="ident" id="5639440">updateKeys</span><span class="op" id="5639450">(</span><span class="op" id="5639451">)</span><br>
<span class="lineno"></span><span class="op" id="5639453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5639456">func</span>&nbsp;<span class="op" id="5639461">(</span><span class="ident" id="5639462">v</span>&nbsp;<span class="op" id="5639464">*</span><span class="ident" id="5639465">Map</span><span class="op" id="5639468">)</span>&nbsp;<span class="ident" id="5639470">Add</span><span class="op" id="5639473">(</span><span class="ident" id="5639474">key</span>&nbsp;<span class="builtintype" id="5639478">string</span><span class="op" id="5639484">,</span>&nbsp;<span class="ident" id="5639486">delta</span>&nbsp;<span class="ident" id="5639492">int64</span><span class="op" id="5639497">)</span>&nbsp;<span class="op" id="5639499">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639502">v</span><span class="op" id="5639503">.</span><span class="ident" id="5639504">mu</span><span class="op" id="5639506">.</span><span class="ident" id="5639507">RLock</span><span class="op" id="5639512">(</span><span class="op" id="5639513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639516">av</span><span class="op" id="5639518">,</span>&nbsp;<span class="ident" id="5639520">ok</span>&nbsp;<span class="op" id="5639523">:=</span>&nbsp;<span class="ident" id="5639526">v</span><span class="op" id="5639527">.</span><span class="ident" id="5639528">m</span><span class="op" id="5639529">[</span><span class="ident" id="5639530">key</span><span class="op" id="5639533">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639536">v</span><span class="op" id="5639537">.</span><span class="ident" id="5639538">mu</span><span class="op" id="5639540">.</span><span class="ident" id="5639541">RUnlock</span><span class="op" id="5639548">(</span><span class="op" id="5639549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639552">if</span>&nbsp;<span class="op" id="5639555">!</span><span class="ident" id="5639556">ok</span>&nbsp;<span class="op" id="5639559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5639563">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639601">v</span><span class="op" id="5639602">.</span><span class="ident" id="5639603">mu</span><span class="op" id="5639605">.</span><span class="ident" id="5639606">Lock</span><span class="op" id="5639610">(</span><span class="op" id="5639611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639615">av</span><span class="op" id="5639617">,</span>&nbsp;<span class="ident" id="5639619">ok</span>&nbsp;<span class="op" id="5639622">=</span>&nbsp;<span class="ident" id="5639624">v</span><span class="op" id="5639625">.</span><span class="ident" id="5639626">m</span><span class="op" id="5639627">[</span><span class="ident" id="5639628">key</span><span class="op" id="5639631">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639635">if</span>&nbsp;<span class="op" id="5639638">!</span><span class="ident" id="5639639">ok</span>&nbsp;<span class="op" id="5639642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639647">av</span>&nbsp;<span class="op" id="5639650">=</span>&nbsp;<span class="builtinfunc" id="5639652">new</span><span class="op" id="5639655">(</span><span class="ident" id="5639656">Int</span><span class="op" id="5639659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639664">v</span><span class="op" id="5639665">.</span><span class="ident" id="5639666">m</span><span class="op" id="5639667">[</span><span class="ident" id="5639668">key</span><span class="op" id="5639671">]</span>&nbsp;<span class="op" id="5639673">=</span>&nbsp;<span class="ident" id="5639675">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639681">v</span><span class="op" id="5639682">.</span><span class="ident" id="5639683">updateKeys</span><span class="op" id="5639693">(</span><span class="op" id="5639694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639702">v</span><span class="op" id="5639703">.</span><span class="ident" id="5639704">mu</span><span class="op" id="5639706">.</span><span class="ident" id="5639707">Unlock</span><span class="op" id="5639713">(</span><span class="op" id="5639714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5639721">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639755">if</span>&nbsp;<span class="ident" id="5639758">iv</span><span class="op" id="5639760">,</span>&nbsp;<span class="ident" id="5639762">ok</span>&nbsp;<span class="op" id="5639765">:=</span>&nbsp;<span class="ident" id="5639768">av</span><span class="op" id="5639770">.</span><span class="op" id="5639771">(</span><span class="op" id="5639772">*</span><span class="ident" id="5639773">Int</span><span class="op" id="5639776">)</span><span class="op" id="5639777">;</span>&nbsp;<span class="ident" id="5639779">ok</span>&nbsp;<span class="op" id="5639782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639786">iv</span><span class="op" id="5639788">.</span><span class="ident" id="5639789">Add</span><span class="op" id="5639792">(</span><span class="ident" id="5639793">delta</span><span class="op" id="5639798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639801">}</span><br>
<span class="lineno"></span><span class="op" id="5639803">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5639806">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5639881">func</span>&nbsp;<span class="op" id="5639886">(</span><span class="ident" id="5639887">v</span>&nbsp;<span class="op" id="5639889">*</span><span class="ident" id="5639890">Map</span><span class="op" id="5639893">)</span>&nbsp;<span class="ident" id="5639895">AddFloat</span><span class="op" id="5639903">(</span><span class="ident" id="5639904">key</span>&nbsp;<span class="builtintype" id="5639908">string</span><span class="op" id="5639914">,</span>&nbsp;<span class="ident" id="5639916">delta</span>&nbsp;<span class="builtintype" id="5639922">float64</span><span class="op" id="5639929">)</span>&nbsp;<span class="op" id="5639931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639934">v</span><span class="op" id="5639935">.</span><span class="ident" id="5639936">mu</span><span class="op" id="5639938">.</span><span class="ident" id="5639939">RLock</span><span class="op" id="5639944">(</span><span class="op" id="5639945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639948">av</span><span class="op" id="5639950">,</span>&nbsp;<span class="ident" id="5639952">ok</span>&nbsp;<span class="op" id="5639955">:=</span>&nbsp;<span class="ident" id="5639958">v</span><span class="op" id="5639959">.</span><span class="ident" id="5639960">m</span><span class="op" id="5639961">[</span><span class="ident" id="5639962">key</span><span class="op" id="5639965">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639968">v</span><span class="op" id="5639969">.</span><span class="ident" id="5639970">mu</span><span class="op" id="5639972">.</span><span class="ident" id="5639973">RUnlock</span><span class="op" id="5639980">(</span><span class="op" id="5639981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639984">if</span>&nbsp;<span class="op" id="5639987">!</span><span class="ident" id="5639988">ok</span>&nbsp;<span class="op" id="5639991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5639995">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640033">v</span><span class="op" id="5640034">.</span><span class="ident" id="5640035">mu</span><span class="op" id="5640037">.</span><span class="ident" id="5640038">Lock</span><span class="op" id="5640042">(</span><span class="op" id="5640043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640047">av</span><span class="op" id="5640049">,</span>&nbsp;<span class="ident" id="5640051">ok</span>&nbsp;<span class="op" id="5640054">=</span>&nbsp;<span class="ident" id="5640056">v</span><span class="op" id="5640057">.</span><span class="ident" id="5640058">m</span><span class="op" id="5640059">[</span><span class="ident" id="5640060">key</span><span class="op" id="5640063">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640067">if</span>&nbsp;<span class="op" id="5640070">!</span><span class="ident" id="5640071">ok</span>&nbsp;<span class="op" id="5640074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640079">av</span>&nbsp;<span class="op" id="5640082">=</span>&nbsp;<span class="builtinfunc" id="5640084">new</span><span class="op" id="5640087">(</span><span class="ident" id="5640088">Float</span><span class="op" id="5640093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640098">v</span><span class="op" id="5640099">.</span><span class="ident" id="5640100">m</span><span class="op" id="5640101">[</span><span class="ident" id="5640102">key</span><span class="op" id="5640105">]</span>&nbsp;<span class="op" id="5640107">=</span>&nbsp;<span class="ident" id="5640109">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640115">v</span><span class="op" id="5640116">.</span><span class="ident" id="5640117">updateKeys</span><span class="op" id="5640127">(</span><span class="op" id="5640128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5640132">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640136">v</span><span class="op" id="5640137">.</span><span class="ident" id="5640138">mu</span><span class="op" id="5640140">.</span><span class="ident" id="5640141">Unlock</span><span class="op" id="5640147">(</span><span class="op" id="5640148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5640151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5640155">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640191">if</span>&nbsp;<span class="ident" id="5640194">iv</span><span class="op" id="5640196">,</span>&nbsp;<span class="ident" id="5640198">ok</span>&nbsp;<span class="op" id="5640201">:=</span>&nbsp;<span class="ident" id="5640204">av</span><span class="op" id="5640206">.</span><span class="op" id="5640207">(</span><span class="op" id="5640208">*</span><span class="ident" id="5640209">Float</span><span class="op" id="5640214">)</span><span class="op" id="5640215">;</span>&nbsp;<span class="ident" id="5640217">ok</span>&nbsp;<span class="op" id="5640220">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640224">iv</span><span class="op" id="5640226">.</span><span class="ident" id="5640227">Add</span><span class="op" id="5640230">(</span><span class="ident" id="5640231">delta</span><span class="op" id="5640236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5640239">}</span><br>
<span class="lineno"></span><span class="op" id="5640241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5640244">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5640285">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5640328">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5640381">func</span>&nbsp;<span class="op" id="5640386">(</span><span class="ident" id="5640387">v</span>&nbsp;<span class="op" id="5640389">*</span><span class="ident" id="5640390">Map</span><span class="op" id="5640393">)</span>&nbsp;<span class="ident" id="5640395">Do</span><span class="op" id="5640397">(</span><span class="ident" id="5640398">f</span>&nbsp;<span class="keyword" id="5640400">func</span><span class="op" id="5640404">(</span><span class="ident" id="5640405">KeyValue</span><span class="op" id="5640413">)</span><span class="op" id="5640414">)</span>&nbsp;<span class="op" id="5640416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640419">v</span><span class="op" id="5640420">.</span><span class="ident" id="5640421">mu</span><span class="op" id="5640423">.</span><span class="ident" id="5640424">RLock</span><span class="op" id="5640429">(</span><span class="op" id="5640430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640433">defer</span>&nbsp;<span class="ident" id="5640439">v</span><span class="op" id="5640440">.</span><span class="ident" id="5640441">mu</span><span class="op" id="5640443">.</span><span class="ident" id="5640444">RUnlock</span><span class="op" id="5640451">(</span><span class="op" id="5640452">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640455">v</span><span class="op" id="5640456">.</span><span class="ident" id="5640457">doLocked</span><span class="op" id="5640465">(</span><span class="ident" id="5640466">f</span><span class="op" id="5640467">)</span><br>
<span class="lineno"></span><span class="op" id="5640469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5640472">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5640519">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5640551">func</span>&nbsp;<span class="op" id="5640556">(</span><span class="ident" id="5640557">v</span>&nbsp;<span class="op" id="5640559">*</span><span class="ident" id="5640560">Map</span><span class="op" id="5640563">)</span>&nbsp;<span class="ident" id="5640565">doLocked</span><span class="op" id="5640573">(</span><span class="ident" id="5640574">f</span>&nbsp;<span class="keyword" id="5640576">func</span><span class="op" id="5640580">(</span><span class="ident" id="5640581">KeyValue</span><span class="op" id="5640589">)</span><span class="op" id="5640590">)</span>&nbsp;<span class="op" id="5640592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640595">for</span>&nbsp;<span class="ident" id="5640599">_</span><span class="op" id="5640600">,</span>&nbsp;<span class="ident" id="5640602">k</span>&nbsp;<span class="op" id="5640604">:=</span>&nbsp;<span class="keyword" id="5640607">range</span>&nbsp;<span class="ident" id="5640613">v</span><span class="op" id="5640614">.</span><span class="ident" id="5640615">keys</span>&nbsp;<span class="op" id="5640620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640624">f</span><span class="op" id="5640625">(</span><span class="ident" id="5640626">KeyValue</span><span class="op" id="5640634">{</span><span class="ident" id="5640635">k</span><span class="op" id="5640636">,</span>&nbsp;<span class="ident" id="5640638">v</span><span class="op" id="5640639">.</span><span class="ident" id="5640640">m</span><span class="op" id="5640641">[</span><span class="ident" id="5640642">k</span><span class="op" id="5640643">]</span><span class="op" id="5640644">}</span><span class="op" id="5640645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5640648">}</span><br>
<span class="lineno"></span><span class="op" id="5640650">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5640653">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5640718">type</span>&nbsp;<span class="ident" id="5640723">String</span>&nbsp;<span class="keyword" id="5640730">struct</span>&nbsp;<span class="op" id="5640737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640740">mu</span>&nbsp;<span class="ident" id="5640743">sync</span><span class="op" id="5640747">.</span><span class="ident" id="5640748">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640757">s</span>&nbsp;&nbsp;<span class="builtintype" id="5640760">string</span><br>
<span class="lineno">220</span><span class="op" id="5640767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5640770">func</span>&nbsp;<span class="op" id="5640775">(</span><span class="ident" id="5640776">v</span>&nbsp;<span class="op" id="5640778">*</span><span class="ident" id="5640779">String</span><span class="op" id="5640785">)</span>&nbsp;<span class="ident" id="5640787">String</span><span class="op" id="5640793">(</span><span class="op" id="5640794">)</span>&nbsp;<span class="builtintype" id="5640796">string</span>&nbsp;<span class="op" id="5640803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640806">v</span><span class="op" id="5640807">.</span><span class="ident" id="5640808">mu</span><span class="op" id="5640810">.</span><span class="ident" id="5640811">RLock</span><span class="op" id="5640816">(</span><span class="op" id="5640817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640820">defer</span>&nbsp;<span class="ident" id="5640826">v</span><span class="op" id="5640827">.</span><span class="ident" id="5640828">mu</span><span class="op" id="5640830">.</span><span class="ident" id="5640831">RUnlock</span><span class="op" id="5640838">(</span><span class="op" id="5640839">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640842">return</span>&nbsp;<span class="ident" id="5640849">strconv</span><span class="op" id="5640856">.</span><span class="ident" id="5640857">Quote</span><span class="op" id="5640862">(</span><span class="ident" id="5640863">v</span><span class="op" id="5640864">.</span><span class="ident" id="5640865">s</span><span class="op" id="5640866">)</span><br>
<span class="lineno"></span><span class="op" id="5640868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5640871">func</span>&nbsp;<span class="op" id="5640876">(</span><span class="ident" id="5640877">v</span>&nbsp;<span class="op" id="5640879">*</span><span class="ident" id="5640880">String</span><span class="op" id="5640886">)</span>&nbsp;<span class="ident" id="5640888">Set</span><span class="op" id="5640891">(</span><span class="ident" id="5640892">value</span>&nbsp;<span class="builtintype" id="5640898">string</span><span class="op" id="5640904">)</span>&nbsp;<span class="op" id="5640906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640909">v</span><span class="op" id="5640910">.</span><span class="ident" id="5640911">mu</span><span class="op" id="5640913">.</span><span class="ident" id="5640914">Lock</span><span class="op" id="5640918">(</span><span class="op" id="5640919">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5640922">defer</span>&nbsp;<span class="ident" id="5640928">v</span><span class="op" id="5640929">.</span><span class="ident" id="5640930">mu</span><span class="op" id="5640932">.</span><span class="ident" id="5640933">Unlock</span><span class="op" id="5640939">(</span><span class="op" id="5640940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5640943">v</span><span class="op" id="5640944">.</span><span class="ident" id="5640945">s</span>&nbsp;<span class="op" id="5640947">=</span>&nbsp;<span class="ident" id="5640949">value</span><br>
<span class="lineno"></span><span class="op" id="5640955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5640958">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5641005">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5641054">type</span>&nbsp;<span class="ident" id="5641059">Func</span>&nbsp;<span class="keyword" id="5641064">func</span><span class="op" id="5641068">(</span><span class="op" id="5641069">)</span>&nbsp;<span class="keyword" id="5641071">interface</span><span class="op" id="5641080">{</span><span class="op" id="5641081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5641084">func</span>&nbsp;<span class="op" id="5641089">(</span><span class="ident" id="5641090">f</span>&nbsp;<span class="ident" id="5641092">Func</span><span class="op" id="5641096">)</span>&nbsp;<span class="ident" id="5641098">String</span><span class="op" id="5641104">(</span><span class="op" id="5641105">)</span>&nbsp;<span class="builtintype" id="5641107">string</span>&nbsp;<span class="op" id="5641114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641117">v</span><span class="op" id="5641118">,</span>&nbsp;<span class="ident" id="5641120">_</span>&nbsp;<span class="op" id="5641122">:=</span>&nbsp;<span class="ident" id="5641125">json</span><span class="op" id="5641129">.</span><span class="ident" id="5641130">Marshal</span><span class="op" id="5641137">(</span><span class="ident" id="5641138">f</span><span class="op" id="5641139">(</span><span class="op" id="5641140">)</span><span class="op" id="5641141">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641144">return</span>&nbsp;<span class="builtintype" id="5641151">string</span><span class="op" id="5641157">(</span><span class="ident" id="5641158">v</span><span class="op" id="5641159">)</span><br>
<span class="lineno"></span><span class="op" id="5641161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5641164">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5641192">var</span>&nbsp;<span class="op" id="5641196">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641199">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5641207">sync</span><span class="op" id="5641211">.</span><span class="ident" id="5641212">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641221">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641229">=</span>&nbsp;<span class="builtinfunc" id="5641231">make</span><span class="op" id="5641235">(</span><span class="keyword" id="5641236">map</span><span class="op" id="5641239">[</span><span class="builtintype" id="5641240">string</span><span class="op" id="5641246">]</span><span class="ident" id="5641247">Var</span><span class="op" id="5641250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641253">varKeys</span>&nbsp;<span class="op" id="5641261">[</span><span class="op" id="5641262">]</span><span class="builtintype" id="5641263">string</span>&nbsp;<span class="comment" id="5641270">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5641280">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5641283">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5641359">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5641435">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5641475">func</span>&nbsp;<span class="ident" id="5641480">Publish</span><span class="op" id="5641487">(</span><span class="ident" id="5641488">name</span>&nbsp;<span class="builtintype" id="5641493">string</span><span class="op" id="5641499">,</span>&nbsp;<span class="ident" id="5641501">v</span>&nbsp;<span class="ident" id="5641503">Var</span><span class="op" id="5641506">)</span>&nbsp;<span class="op" id="5641508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641511">mutex</span><span class="op" id="5641516">.</span><span class="ident" id="5641517">Lock</span><span class="op" id="5641521">(</span><span class="op" id="5641522">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641525">defer</span>&nbsp;<span class="ident" id="5641531">mutex</span><span class="op" id="5641536">.</span><span class="ident" id="5641537">Unlock</span><span class="op" id="5641543">(</span><span class="op" id="5641544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641547">if</span>&nbsp;<span class="ident" id="5641550">_</span><span class="op" id="5641551">,</span>&nbsp;<span class="ident" id="5641553">existing</span>&nbsp;<span class="op" id="5641562">:=</span>&nbsp;<span class="ident" id="5641565">vars</span><span class="op" id="5641569">[</span><span class="ident" id="5641570">name</span><span class="op" id="5641574">]</span><span class="op" id="5641575">;</span>&nbsp;<span class="ident" id="5641577">existing</span>&nbsp;<span class="op" id="5641586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641590">log</span><span class="op" id="5641593">.</span><span class="ident" id="5641594">Panicln</span><span class="op" id="5641601">(</span><span class="string" id="5641602">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5641631">,</span>&nbsp;<span class="ident" id="5641633">name</span><span class="op" id="5641637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5641640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641643">vars</span><span class="op" id="5641647">[</span><span class="ident" id="5641648">name</span><span class="op" id="5641652">]</span>&nbsp;<span class="op" id="5641654">=</span>&nbsp;<span class="ident" id="5641656">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641659">varKeys</span>&nbsp;<span class="op" id="5641667">=</span>&nbsp;<span class="builtinfunc" id="5641669">append</span><span class="op" id="5641675">(</span><span class="ident" id="5641676">varKeys</span><span class="op" id="5641683">,</span>&nbsp;<span class="ident" id="5641685">name</span><span class="op" id="5641689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641692">sort</span><span class="op" id="5641696">.</span><span class="ident" id="5641697">Strings</span><span class="op" id="5641704">(</span><span class="ident" id="5641705">varKeys</span><span class="op" id="5641712">)</span><br>
<span class="lineno"></span><span class="op" id="5641714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5641717">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5641761">func</span>&nbsp;<span class="ident" id="5641766">Get</span><span class="op" id="5641769">(</span><span class="ident" id="5641770">name</span>&nbsp;<span class="builtintype" id="5641775">string</span><span class="op" id="5641781">)</span>&nbsp;<span class="ident" id="5641783">Var</span>&nbsp;<span class="op" id="5641787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641790">mutex</span><span class="op" id="5641795">.</span><span class="ident" id="5641796">RLock</span><span class="op" id="5641801">(</span><span class="op" id="5641802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641805">defer</span>&nbsp;<span class="ident" id="5641811">mutex</span><span class="op" id="5641816">.</span><span class="ident" id="5641817">RUnlock</span><span class="op" id="5641824">(</span><span class="op" id="5641825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641828">return</span>&nbsp;<span class="ident" id="5641835">vars</span><span class="op" id="5641839">[</span><span class="ident" id="5641840">name</span><span class="op" id="5641844">]</span><br>
<span class="lineno"></span><span class="op" id="5641846">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5641849">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5641912">func</span>&nbsp;<span class="ident" id="5641917">NewInt</span><span class="op" id="5641923">(</span><span class="ident" id="5641924">name</span>&nbsp;<span class="builtintype" id="5641929">string</span><span class="op" id="5641935">)</span>&nbsp;<span class="op" id="5641937">*</span><span class="ident" id="5641938">Int</span>&nbsp;<span class="op" id="5641942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641945">v</span>&nbsp;<span class="op" id="5641947">:=</span>&nbsp;<span class="builtinfunc" id="5641950">new</span><span class="op" id="5641953">(</span><span class="ident" id="5641954">Int</span><span class="op" id="5641957">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5641960">Publish</span><span class="op" id="5641967">(</span><span class="ident" id="5641968">name</span><span class="op" id="5641972">,</span>&nbsp;<span class="ident" id="5641974">v</span><span class="op" id="5641975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5641978">return</span>&nbsp;<span class="ident" id="5641985">v</span><br>
<span class="lineno"></span><span class="op" id="5641987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5641990">func</span>&nbsp;<span class="ident" id="5641995">NewFloat</span><span class="op" id="5642003">(</span><span class="ident" id="5642004">name</span>&nbsp;<span class="builtintype" id="5642009">string</span><span class="op" id="5642015">)</span>&nbsp;<span class="op" id="5642017">*</span><span class="ident" id="5642018">Float</span>&nbsp;<span class="op" id="5642024">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642027">v</span>&nbsp;<span class="op" id="5642029">:=</span>&nbsp;<span class="builtinfunc" id="5642032">new</span><span class="op" id="5642035">(</span><span class="ident" id="5642036">Float</span><span class="op" id="5642041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642044">Publish</span><span class="op" id="5642051">(</span><span class="ident" id="5642052">name</span><span class="op" id="5642056">,</span>&nbsp;<span class="ident" id="5642058">v</span><span class="op" id="5642059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642062">return</span>&nbsp;<span class="ident" id="5642069">v</span><br>
<span class="lineno"></span><span class="op" id="5642071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5642074">func</span>&nbsp;<span class="ident" id="5642079">NewMap</span><span class="op" id="5642085">(</span><span class="ident" id="5642086">name</span>&nbsp;<span class="builtintype" id="5642091">string</span><span class="op" id="5642097">)</span>&nbsp;<span class="op" id="5642099">*</span><span class="ident" id="5642100">Map</span>&nbsp;<span class="op" id="5642104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642107">v</span>&nbsp;<span class="op" id="5642109">:=</span>&nbsp;<span class="builtinfunc" id="5642112">new</span><span class="op" id="5642115">(</span><span class="ident" id="5642116">Map</span><span class="op" id="5642119">)</span><span class="op" id="5642120">.</span><span class="ident" id="5642121">Init</span><span class="op" id="5642125">(</span><span class="op" id="5642126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642129">Publish</span><span class="op" id="5642136">(</span><span class="ident" id="5642137">name</span><span class="op" id="5642141">,</span>&nbsp;<span class="ident" id="5642143">v</span><span class="op" id="5642144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642147">return</span>&nbsp;<span class="ident" id="5642154">v</span><br>
<span class="lineno"></span><span class="op" id="5642156">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5642159">func</span>&nbsp;<span class="ident" id="5642164">NewString</span><span class="op" id="5642173">(</span><span class="ident" id="5642174">name</span>&nbsp;<span class="builtintype" id="5642179">string</span><span class="op" id="5642185">)</span>&nbsp;<span class="op" id="5642187">*</span><span class="ident" id="5642188">String</span>&nbsp;<span class="op" id="5642195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642198">v</span>&nbsp;<span class="op" id="5642200">:=</span>&nbsp;<span class="builtinfunc" id="5642203">new</span><span class="op" id="5642206">(</span><span class="ident" id="5642207">String</span><span class="op" id="5642213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642216">Publish</span><span class="op" id="5642223">(</span><span class="ident" id="5642224">name</span><span class="op" id="5642228">,</span>&nbsp;<span class="ident" id="5642230">v</span><span class="op" id="5642231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642234">return</span>&nbsp;<span class="ident" id="5642241">v</span><br>
<span class="lineno">295</span><span class="op" id="5642243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5642246">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5642288">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5642347">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5642400">func</span>&nbsp;<span class="ident" id="5642405">Do</span><span class="op" id="5642407">(</span><span class="ident" id="5642408">f</span>&nbsp;<span class="keyword" id="5642410">func</span><span class="op" id="5642414">(</span><span class="ident" id="5642415">KeyValue</span><span class="op" id="5642423">)</span><span class="op" id="5642424">)</span>&nbsp;<span class="op" id="5642426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642429">mutex</span><span class="op" id="5642434">.</span><span class="ident" id="5642435">RLock</span><span class="op" id="5642440">(</span><span class="op" id="5642441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642444">defer</span>&nbsp;<span class="ident" id="5642450">mutex</span><span class="op" id="5642455">.</span><span class="ident" id="5642456">RUnlock</span><span class="op" id="5642463">(</span><span class="op" id="5642464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642467">for</span>&nbsp;<span class="ident" id="5642471">_</span><span class="op" id="5642472">,</span>&nbsp;<span class="ident" id="5642474">k</span>&nbsp;<span class="op" id="5642476">:=</span>&nbsp;<span class="keyword" id="5642479">range</span>&nbsp;<span class="ident" id="5642485">varKeys</span>&nbsp;<span class="op" id="5642493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642497">f</span><span class="op" id="5642498">(</span><span class="ident" id="5642499">KeyValue</span><span class="op" id="5642507">{</span><span class="ident" id="5642508">k</span><span class="op" id="5642509">,</span>&nbsp;<span class="ident" id="5642511">vars</span><span class="op" id="5642515">[</span><span class="ident" id="5642516">k</span><span class="op" id="5642517">]</span><span class="op" id="5642518">}</span><span class="op" id="5642519">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642522">}</span><br>
<span class="lineno"></span><span class="op" id="5642524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5642527">func</span>&nbsp;<span class="ident" id="5642532">expvarHandler</span><span class="op" id="5642545">(</span><span class="ident" id="5642546">w</span>&nbsp;<span class="ident" id="5642548">http</span><span class="op" id="5642552">.</span><span class="ident" id="5642553">ResponseWriter</span><span class="op" id="5642567">,</span>&nbsp;<span class="ident" id="5642569">r</span>&nbsp;<span class="op" id="5642571">*</span><span class="ident" id="5642572">http</span><span class="op" id="5642576">.</span><span class="ident" id="5642577">Request</span><span class="op" id="5642584">)</span>&nbsp;<span class="op" id="5642586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642589">w</span><span class="op" id="5642590">.</span><span class="ident" id="5642591">Header</span><span class="op" id="5642597">(</span><span class="op" id="5642598">)</span><span class="op" id="5642599">.</span><span class="ident" id="5642600">Set</span><span class="op" id="5642603">(</span><span class="string" id="5642604">&#34;Content-Type&#34;</span><span class="op" id="5642618">,</span>&nbsp;<span class="string" id="5642620">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5642653">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642656">fmt</span><span class="op" id="5642659">.</span><span class="ident" id="5642660">Fprintf</span><span class="op" id="5642667">(</span><span class="ident" id="5642668">w</span><span class="op" id="5642669">,</span>&nbsp;<span class="string" id="5642671">&#34;{\n&#34;</span><span class="op" id="5642676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642679">first</span>&nbsp;<span class="op" id="5642685">:=</span>&nbsp;<span class="builtintype" id="5642688">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642694">Do</span><span class="op" id="5642696">(</span><span class="keyword" id="5642697">func</span><span class="op" id="5642701">(</span><span class="ident" id="5642702">kv</span>&nbsp;<span class="ident" id="5642705">KeyValue</span><span class="op" id="5642713">)</span>&nbsp;<span class="op" id="5642715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642719">if</span>&nbsp;<span class="op" id="5642722">!</span><span class="ident" id="5642723">first</span>&nbsp;<span class="op" id="5642729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642734">fmt</span><span class="op" id="5642737">.</span><span class="ident" id="5642738">Fprintf</span><span class="op" id="5642745">(</span><span class="ident" id="5642746">w</span><span class="op" id="5642747">,</span>&nbsp;<span class="string" id="5642749">&#34;,\n&#34;</span><span class="op" id="5642754">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642762">first</span>&nbsp;<span class="op" id="5642768">=</span>&nbsp;<span class="builtintype" id="5642770">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642778">fmt</span><span class="op" id="5642781">.</span><span class="ident" id="5642782">Fprintf</span><span class="op" id="5642789">(</span><span class="ident" id="5642790">w</span><span class="op" id="5642791">,</span>&nbsp;<span class="string" id="5642793">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5642801">,</span>&nbsp;<span class="ident" id="5642803">kv</span><span class="op" id="5642805">.</span><span class="ident" id="5642806">Key</span><span class="op" id="5642809">,</span>&nbsp;<span class="ident" id="5642811">kv</span><span class="op" id="5642813">.</span><span class="ident" id="5642814">Value</span><span class="op" id="5642819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5642822">}</span><span class="op" id="5642823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642826">fmt</span><span class="op" id="5642829">.</span><span class="ident" id="5642830">Fprintf</span><span class="op" id="5642837">(</span><span class="ident" id="5642838">w</span><span class="op" id="5642839">,</span>&nbsp;<span class="string" id="5642841">&#34;\n}\n&#34;</span><span class="op" id="5642848">)</span><br>
<span class="lineno">320</span><span class="op" id="5642850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5642853">func</span>&nbsp;<span class="ident" id="5642858">cmdline</span><span class="op" id="5642865">(</span><span class="op" id="5642866">)</span>&nbsp;<span class="keyword" id="5642868">interface</span><span class="op" id="5642877">{</span><span class="op" id="5642878">}</span>&nbsp;<span class="op" id="5642880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642883">return</span>&nbsp;<span class="ident" id="5642890">os</span><span class="op" id="5642892">.</span><span class="ident" id="5642893">Args</span><br>
<span class="lineno"></span><span class="op" id="5642898">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5642901">func</span>&nbsp;<span class="ident" id="5642906">memstats</span><span class="op" id="5642914">(</span><span class="op" id="5642915">)</span>&nbsp;<span class="keyword" id="5642917">interface</span><span class="op" id="5642926">{</span><span class="op" id="5642927">}</span>&nbsp;<span class="op" id="5642929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642932">stats</span>&nbsp;<span class="op" id="5642938">:=</span>&nbsp;<span class="builtinfunc" id="5642941">new</span><span class="op" id="5642944">(</span><span class="ident" id="5642945">runtime</span><span class="op" id="5642952">.</span><span class="ident" id="5642953">MemStats</span><span class="op" id="5642961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5642964">runtime</span><span class="op" id="5642971">.</span><span class="ident" id="5642972">ReadMemStats</span><span class="op" id="5642984">(</span><span class="ident" id="5642985">stats</span><span class="op" id="5642990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5642993">return</span>&nbsp;<span class="op" id="5643000">*</span><span class="ident" id="5643001">stats</span><br>
<span class="lineno">330</span><span class="op" id="5643007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5643010">func</span>&nbsp;<span class="ident" id="5643015">init</span><span class="op" id="5643019">(</span><span class="op" id="5643020">)</span>&nbsp;<span class="op" id="5643022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643025">http</span><span class="op" id="5643029">.</span><span class="ident" id="5643030">HandleFunc</span><span class="op" id="5643040">(</span><span class="string" id="5643041">&#34;/debug/vars&#34;</span><span class="op" id="5643054">,</span>&nbsp;<span class="ident" id="5643056">expvarHandler</span><span class="op" id="5643069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643072">Publish</span><span class="op" id="5643079">(</span><span class="string" id="5643080">&#34;cmdline&#34;</span><span class="op" id="5643089">,</span>&nbsp;<span class="ident" id="5643091">Func</span><span class="op" id="5643095">(</span><span class="ident" id="5643096">cmdline</span><span class="op" id="5643103">)</span><span class="op" id="5643104">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5643107">Publish</span><span class="op" id="5643114">(</span><span class="string" id="5643115">&#34;memstats&#34;</span><span class="op" id="5643125">,</span>&nbsp;<span class="ident" id="5643127">Func</span><span class="op" id="5643131">(</span><span class="ident" id="5643132">memstats</span><span class="op" id="5643140">)</span><span class="op" id="5643141">)</span><br>
<span class="lineno"></span><span class="op" id="5643143">}</span>
</div>
</body>
</html>
