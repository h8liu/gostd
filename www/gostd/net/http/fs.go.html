<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4759954">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4760009">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4760063">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4760114">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4760151">package</span>&nbsp;<span class="ident" id="4760159">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4760165">import</span>&nbsp;<span class="op" id="4760172">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760175">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760185">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760192">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760198">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760206">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760224">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760241">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760252">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760258">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760266">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760283">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760294">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4760305">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4760312">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4760315">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4760391">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="4760419">//</span><br>
<span class="lineno"></span><span class="comment" id="4760422">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4760500">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="4760580">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="4760635">//</span><br>
<span class="lineno"></span><span class="comment" id="4760638">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4760673">type</span>&nbsp;<span class="ident" id="4760678">Dir</span>&nbsp;<span class="builtintype" id="4760682">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4760690">func</span>&nbsp;<span class="op" id="4760695">(</span><span class="ident" id="4760696">d</span>&nbsp;<span class="ident" id="4760698">Dir</span><span class="op" id="4760701">)</span>&nbsp;<span class="ident" id="4760703">Open</span><span class="op" id="4760707">(</span><span class="ident" id="4760708">name</span>&nbsp;<span class="builtintype" id="4760713">string</span><span class="op" id="4760719">)</span>&nbsp;<span class="op" id="4760721">(</span><span class="ident" id="4760722">File</span><span class="op" id="4760726">,</span>&nbsp;<span class="builtintype" id="4760728">error</span><span class="op" id="4760733">)</span>&nbsp;<span class="op" id="4760735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4760738">if</span>&nbsp;<span class="ident" id="4760741">filepath</span><span class="op" id="4760749">.</span><span class="ident" id="4760750">Separator</span>&nbsp;<span class="op" id="4760760">!=</span>&nbsp;<span class="string" id="4760763">&#39;/&#39;</span>&nbsp;<span class="op" id="4760767">&amp;&amp;</span>&nbsp;<span class="ident" id="4760770">strings</span><span class="op" id="4760777">.</span><span class="ident" id="4760778">IndexRune</span><span class="op" id="4760787">(</span><span class="ident" id="4760788">name</span><span class="op" id="4760792">,</span>&nbsp;<span class="ident" id="4760794">filepath</span><span class="op" id="4760802">.</span><span class="ident" id="4760803">Separator</span><span class="op" id="4760812">)</span>&nbsp;<span class="op" id="4760814">&gt;=</span>&nbsp;<span class="num" id="4760817">0</span>&nbsp;<span class="op" id="4760819">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4760824">strings</span><span class="op" id="4760831">.</span><span class="ident" id="4760832">Contains</span><span class="op" id="4760840">(</span><span class="ident" id="4760841">name</span><span class="op" id="4760845">,</span>&nbsp;<span class="string" id="4760847">&#34;\x00&#34;</span><span class="op" id="4760853">)</span>&nbsp;<span class="op" id="4760855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4760859">return</span>&nbsp;<span class="ident" id="4760866">nil</span><span class="op" id="4760869">,</span>&nbsp;<span class="ident" id="4760871">errors</span><span class="op" id="4760877">.</span><span class="ident" id="4760878">New</span><span class="op" id="4760881">(</span><span class="string" id="4760882">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="4760920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4760923">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4760926">dir</span>&nbsp;<span class="op" id="4760930">:=</span>&nbsp;<span class="builtintype" id="4760933">string</span><span class="op" id="4760939">(</span><span class="ident" id="4760940">d</span><span class="op" id="4760941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4760944">if</span>&nbsp;<span class="ident" id="4760947">dir</span>&nbsp;<span class="op" id="4760951">==</span>&nbsp;<span class="string" id="4760954">&#34;&#34;</span>&nbsp;<span class="op" id="4760957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4760961">dir</span>&nbsp;<span class="op" id="4760965">=</span>&nbsp;<span class="string" id="4760967">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4760972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4760975">f</span><span class="op" id="4760976">,</span>&nbsp;<span class="ident" id="4760978">err</span>&nbsp;<span class="op" id="4760982">:=</span>&nbsp;<span class="ident" id="4760985">os</span><span class="op" id="4760987">.</span><span class="ident" id="4760988">Open</span><span class="op" id="4760992">(</span><span class="ident" id="4760993">filepath</span><span class="op" id="4761001">.</span><span class="ident" id="4761002">Join</span><span class="op" id="4761006">(</span><span class="ident" id="4761007">dir</span><span class="op" id="4761010">,</span>&nbsp;<span class="ident" id="4761012">filepath</span><span class="op" id="4761020">.</span><span class="ident" id="4761021">FromSlash</span><span class="op" id="4761030">(</span><span class="ident" id="4761031">path</span><span class="op" id="4761035">.</span><span class="ident" id="4761036">Clean</span><span class="op" id="4761041">(</span><span class="string" id="4761042">&#34;/&#34;</span><span class="op" id="4761045">+</span><span class="ident" id="4761046">name</span><span class="op" id="4761050">)</span><span class="op" id="4761051">)</span><span class="op" id="4761052">)</span><span class="op" id="4761053">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761056">if</span>&nbsp;<span class="ident" id="4761059">err</span>&nbsp;<span class="op" id="4761063">!=</span>&nbsp;<span class="ident" id="4761066">nil</span>&nbsp;<span class="op" id="4761070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761074">return</span>&nbsp;<span class="ident" id="4761081">nil</span><span class="op" id="4761084">,</span>&nbsp;<span class="ident" id="4761086">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4761091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761094">return</span>&nbsp;<span class="ident" id="4761101">f</span><span class="op" id="4761102">,</span>&nbsp;<span class="ident" id="4761104">nil</span><br>
<span class="lineno"></span><span class="op" id="4761108">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4761111">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4761177">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="4761245">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="4761308">type</span>&nbsp;<span class="ident" id="4761313">FileSystem</span>&nbsp;<span class="keyword" id="4761324">interface</span>&nbsp;<span class="op" id="4761334">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761337">Open</span><span class="op" id="4761341">(</span><span class="ident" id="4761342">name</span>&nbsp;<span class="builtintype" id="4761347">string</span><span class="op" id="4761353">)</span>&nbsp;<span class="op" id="4761355">(</span><span class="ident" id="4761356">File</span><span class="op" id="4761360">,</span>&nbsp;<span class="builtintype" id="4761362">error</span><span class="op" id="4761367">)</span><br>
<span class="lineno"></span><span class="op" id="4761369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4761372">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4761435">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="4761479">//</span><br>
<span class="lineno"></span><span class="comment" id="4761482">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="4761545">type</span>&nbsp;<span class="ident" id="4761550">File</span>&nbsp;<span class="keyword" id="4761555">interface</span>&nbsp;<span class="op" id="4761565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761568">io</span><span class="op" id="4761570">.</span><span class="ident" id="4761571">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761579">io</span><span class="op" id="4761581">.</span><span class="ident" id="4761582">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761590">Readdir</span><span class="op" id="4761597">(</span><span class="ident" id="4761598">count</span>&nbsp;<span class="builtintype" id="4761604">int</span><span class="op" id="4761607">)</span>&nbsp;<span class="op" id="4761609">(</span><span class="op" id="4761610">[</span><span class="op" id="4761611">]</span><span class="ident" id="4761612">os</span><span class="op" id="4761614">.</span><span class="ident" id="4761615">FileInfo</span><span class="op" id="4761623">,</span>&nbsp;<span class="builtintype" id="4761625">error</span><span class="op" id="4761630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761633">Seek</span><span class="op" id="4761637">(</span><span class="ident" id="4761638">offset</span>&nbsp;<span class="ident" id="4761645">int64</span><span class="op" id="4761650">,</span>&nbsp;<span class="ident" id="4761652">whence</span>&nbsp;<span class="builtintype" id="4761659">int</span><span class="op" id="4761662">)</span>&nbsp;<span class="op" id="4761664">(</span><span class="ident" id="4761665">int64</span><span class="op" id="4761670">,</span>&nbsp;<span class="builtintype" id="4761672">error</span><span class="op" id="4761677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761680">Stat</span><span class="op" id="4761684">(</span><span class="op" id="4761685">)</span>&nbsp;<span class="op" id="4761687">(</span><span class="ident" id="4761688">os</span><span class="op" id="4761690">.</span><span class="ident" id="4761691">FileInfo</span><span class="op" id="4761699">,</span>&nbsp;<span class="builtintype" id="4761701">error</span><span class="op" id="4761706">)</span><br>
<span class="lineno"></span><span class="op" id="4761708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4761711">func</span>&nbsp;<span class="ident" id="4761716">dirList</span><span class="op" id="4761723">(</span><span class="ident" id="4761724">w</span>&nbsp;<span class="ident" id="4761726">ResponseWriter</span><span class="op" id="4761740">,</span>&nbsp;<span class="ident" id="4761742">f</span>&nbsp;<span class="ident" id="4761744">File</span><span class="op" id="4761748">)</span>&nbsp;<span class="op" id="4761750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761753">w</span><span class="op" id="4761754">.</span><span class="ident" id="4761755">Header</span><span class="op" id="4761761">(</span><span class="op" id="4761762">)</span><span class="op" id="4761763">.</span><span class="ident" id="4761764">Set</span><span class="op" id="4761767">(</span><span class="string" id="4761768">&#34;Content-Type&#34;</span><span class="op" id="4761782">,</span>&nbsp;<span class="string" id="4761784">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="4761810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761813">fmt</span><span class="op" id="4761816">.</span><span class="ident" id="4761817">Fprintf</span><span class="op" id="4761824">(</span><span class="ident" id="4761825">w</span><span class="op" id="4761826">,</span>&nbsp;<span class="string" id="4761828">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="4761837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761840">for</span>&nbsp;<span class="op" id="4761844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761848">dirs</span><span class="op" id="4761852">,</span>&nbsp;<span class="ident" id="4761854">err</span>&nbsp;<span class="op" id="4761858">:=</span>&nbsp;<span class="ident" id="4761861">f</span><span class="op" id="4761862">.</span><span class="ident" id="4761863">Readdir</span><span class="op" id="4761870">(</span><span class="num" id="4761871">100</span><span class="op" id="4761874">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761878">if</span>&nbsp;<span class="ident" id="4761881">err</span>&nbsp;<span class="op" id="4761885">!=</span>&nbsp;<span class="ident" id="4761888">nil</span>&nbsp;<span class="op" id="4761892">||</span>&nbsp;<span class="builtinfunc" id="4761895">len</span><span class="op" id="4761898">(</span><span class="ident" id="4761899">dirs</span><span class="op" id="4761903">)</span>&nbsp;<span class="op" id="4761905">==</span>&nbsp;<span class="num" id="4761908">0</span>&nbsp;<span class="op" id="4761910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761915">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4761923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761927">for</span>&nbsp;<span class="ident" id="4761931">_</span><span class="op" id="4761932">,</span>&nbsp;<span class="ident" id="4761934">d</span>&nbsp;<span class="op" id="4761936">:=</span>&nbsp;<span class="keyword" id="4761939">range</span>&nbsp;<span class="ident" id="4761945">dirs</span>&nbsp;<span class="op" id="4761950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761955">name</span>&nbsp;<span class="op" id="4761960">:=</span>&nbsp;<span class="ident" id="4761963">d</span><span class="op" id="4761964">.</span><span class="ident" id="4761965">Name</span><span class="op" id="4761969">(</span><span class="op" id="4761970">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4761975">if</span>&nbsp;<span class="ident" id="4761978">d</span><span class="op" id="4761979">.</span><span class="ident" id="4761980">IsDir</span><span class="op" id="4761985">(</span><span class="op" id="4761986">)</span>&nbsp;<span class="op" id="4761988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4761994">name</span>&nbsp;<span class="op" id="4761999">+=</span>&nbsp;<span class="string" id="4762002">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4762009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4762014">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4762081">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4762147">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4762173">url</span>&nbsp;<span class="op" id="4762177">:=</span>&nbsp;<span class="ident" id="4762180">url</span><span class="op" id="4762183">.</span><span class="ident" id="4762184">URL</span><span class="op" id="4762187">{</span><span class="ident" id="4762188">Path</span><span class="op" id="4762192">:</span>&nbsp;<span class="ident" id="4762194">name</span><span class="op" id="4762198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4762203">fmt</span><span class="op" id="4762206">.</span><span class="ident" id="4762207">Fprintf</span><span class="op" id="4762214">(</span><span class="ident" id="4762215">w</span><span class="op" id="4762216">,</span>&nbsp;<span class="string" id="4762218">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="4762243">,</span>&nbsp;<span class="ident" id="4762245">url</span><span class="op" id="4762248">.</span><span class="ident" id="4762249">String</span><span class="op" id="4762255">(</span><span class="op" id="4762256">)</span><span class="op" id="4762257">,</span>&nbsp;<span class="ident" id="4762259">htmlReplacer</span><span class="op" id="4762271">.</span><span class="ident" id="4762272">Replace</span><span class="op" id="4762279">(</span><span class="ident" id="4762280">name</span><span class="op" id="4762284">)</span><span class="op" id="4762285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4762289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4762292">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4762295">fmt</span><span class="op" id="4762298">.</span><span class="ident" id="4762299">Fprintf</span><span class="op" id="4762306">(</span><span class="ident" id="4762307">w</span><span class="op" id="4762308">,</span>&nbsp;<span class="string" id="4762310">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="4762320">)</span><br>
<span class="lineno"></span><span class="op" id="4762322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4762325">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4762389">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="4762460">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4762531">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="4762570">//</span><br>
<span class="lineno"></span><span class="comment" id="4762573">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="4762639">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="4762705">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4762776">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="4762816">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4762886">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4762917">//</span><br>
<span class="lineno">105</span><span class="comment" id="4762920">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4762986">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4763055">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="4763120">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="4763168">//</span><br>
<span class="lineno">110</span><span class="comment" id="4763171">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="4763229">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="4763288">//</span><br>
<span class="lineno"></span><span class="comment" id="4763291">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4763357">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="4763410">//</span><br>
<span class="lineno"></span><span class="comment" id="4763413">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4763475">func</span>&nbsp;<span class="ident" id="4763480">ServeContent</span><span class="op" id="4763492">(</span><span class="ident" id="4763493">w</span>&nbsp;<span class="ident" id="4763495">ResponseWriter</span><span class="op" id="4763509">,</span>&nbsp;<span class="ident" id="4763511">req</span>&nbsp;<span class="op" id="4763515">*</span><span class="ident" id="4763516">Request</span><span class="op" id="4763523">,</span>&nbsp;<span class="ident" id="4763525">name</span>&nbsp;<span class="builtintype" id="4763530">string</span><span class="op" id="4763536">,</span>&nbsp;<span class="ident" id="4763538">modtime</span>&nbsp;<span class="ident" id="4763546">time</span><span class="op" id="4763550">.</span><span class="ident" id="4763551">Time</span><span class="op" id="4763555">,</span>&nbsp;<span class="ident" id="4763557">content</span>&nbsp;<span class="ident" id="4763565">io</span><span class="op" id="4763567">.</span><span class="ident" id="4763568">ReadSeeker</span><span class="op" id="4763578">)</span>&nbsp;<span class="op" id="4763580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4763583">sizeFunc</span>&nbsp;<span class="op" id="4763592">:=</span>&nbsp;<span class="keyword" id="4763595">func</span><span class="op" id="4763599">(</span><span class="op" id="4763600">)</span>&nbsp;<span class="op" id="4763602">(</span><span class="ident" id="4763603">int64</span><span class="op" id="4763608">,</span>&nbsp;<span class="builtintype" id="4763610">error</span><span class="op" id="4763615">)</span>&nbsp;<span class="op" id="4763617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4763621">size</span><span class="op" id="4763625">,</span>&nbsp;<span class="ident" id="4763627">err</span>&nbsp;<span class="op" id="4763631">:=</span>&nbsp;<span class="ident" id="4763634">content</span><span class="op" id="4763641">.</span><span class="ident" id="4763642">Seek</span><span class="op" id="4763646">(</span><span class="num" id="4763647">0</span><span class="op" id="4763648">,</span>&nbsp;<span class="ident" id="4763650">os</span><span class="op" id="4763652">.</span><span class="ident" id="4763653">SEEK_END</span><span class="op" id="4763661">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4763665">if</span>&nbsp;<span class="ident" id="4763668">err</span>&nbsp;<span class="op" id="4763672">!=</span>&nbsp;<span class="ident" id="4763675">nil</span>&nbsp;<span class="op" id="4763679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4763684">return</span>&nbsp;<span class="num" id="4763691">0</span><span class="op" id="4763692">,</span>&nbsp;<span class="ident" id="4763694">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4763706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4763710">_</span><span class="op" id="4763711">,</span>&nbsp;<span class="ident" id="4763713">err</span>&nbsp;<span class="op" id="4763717">=</span>&nbsp;<span class="ident" id="4763719">content</span><span class="op" id="4763726">.</span><span class="ident" id="4763727">Seek</span><span class="op" id="4763731">(</span><span class="num" id="4763732">0</span><span class="op" id="4763733">,</span>&nbsp;<span class="ident" id="4763735">os</span><span class="op" id="4763737">.</span><span class="ident" id="4763738">SEEK_SET</span><span class="op" id="4763746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4763750">if</span>&nbsp;<span class="ident" id="4763753">err</span>&nbsp;<span class="op" id="4763757">!=</span>&nbsp;<span class="ident" id="4763760">nil</span>&nbsp;<span class="op" id="4763764">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4763769">return</span>&nbsp;<span class="num" id="4763776">0</span><span class="op" id="4763777">,</span>&nbsp;<span class="ident" id="4763779">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4763791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4763795">return</span>&nbsp;<span class="ident" id="4763802">size</span><span class="op" id="4763806">,</span>&nbsp;<span class="ident" id="4763808">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4763813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4763816">serveContent</span><span class="op" id="4763828">(</span><span class="ident" id="4763829">w</span><span class="op" id="4763830">,</span>&nbsp;<span class="ident" id="4763832">req</span><span class="op" id="4763835">,</span>&nbsp;<span class="ident" id="4763837">name</span><span class="op" id="4763841">,</span>&nbsp;<span class="ident" id="4763843">modtime</span><span class="op" id="4763850">,</span>&nbsp;<span class="ident" id="4763852">sizeFunc</span><span class="op" id="4763860">,</span>&nbsp;<span class="ident" id="4763862">content</span><span class="op" id="4763869">)</span><br>
<span class="lineno">130</span><span class="op" id="4763871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4763874">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4763943">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4764010">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="4764078">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="4764088">var</span>&nbsp;<span class="ident" id="4764092">errSeeker</span>&nbsp;<span class="op" id="4764102">=</span>&nbsp;<span class="ident" id="4764104">errors</span><span class="op" id="4764110">.</span><span class="ident" id="4764111">New</span><span class="op" id="4764114">(</span><span class="string" id="4764115">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4764134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4764137">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="4764217">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="4764261">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4764317">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4764406">func</span>&nbsp;<span class="ident" id="4764411">serveContent</span><span class="op" id="4764423">(</span><span class="ident" id="4764424">w</span>&nbsp;<span class="ident" id="4764426">ResponseWriter</span><span class="op" id="4764440">,</span>&nbsp;<span class="ident" id="4764442">r</span>&nbsp;<span class="op" id="4764444">*</span><span class="ident" id="4764445">Request</span><span class="op" id="4764452">,</span>&nbsp;<span class="ident" id="4764454">name</span>&nbsp;<span class="builtintype" id="4764459">string</span><span class="op" id="4764465">,</span>&nbsp;<span class="ident" id="4764467">modtime</span>&nbsp;<span class="ident" id="4764475">time</span><span class="op" id="4764479">.</span><span class="ident" id="4764480">Time</span><span class="op" id="4764484">,</span>&nbsp;<span class="ident" id="4764486">sizeFunc</span>&nbsp;<span class="keyword" id="4764495">func</span><span class="op" id="4764499">(</span><span class="op" id="4764500">)</span>&nbsp;<span class="op" id="4764502">(</span><span class="ident" id="4764503">int64</span><span class="op" id="4764508">,</span>&nbsp;<span class="builtintype" id="4764510">error</span><span class="op" id="4764515">)</span><span class="op" id="4764516">,</span>&nbsp;<span class="ident" id="4764518">content</span>&nbsp;<span class="ident" id="4764526">io</span><span class="op" id="4764528">.</span><span class="ident" id="4764529">ReadSeeker</span><span class="op" id="4764539">)</span>&nbsp;<span class="op" id="4764541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764544">if</span>&nbsp;<span class="ident" id="4764547">checkLastModified</span><span class="op" id="4764564">(</span><span class="ident" id="4764565">w</span><span class="op" id="4764566">,</span>&nbsp;<span class="ident" id="4764568">r</span><span class="op" id="4764569">,</span>&nbsp;<span class="ident" id="4764571">modtime</span><span class="op" id="4764578">)</span>&nbsp;<span class="op" id="4764580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764584">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4764592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4764595">rangeReq</span><span class="op" id="4764603">,</span>&nbsp;<span class="ident" id="4764605">done</span>&nbsp;<span class="op" id="4764610">:=</span>&nbsp;<span class="ident" id="4764613">checkETag</span><span class="op" id="4764622">(</span><span class="ident" id="4764623">w</span><span class="op" id="4764624">,</span>&nbsp;<span class="ident" id="4764626">r</span><span class="op" id="4764627">,</span>&nbsp;<span class="ident" id="4764629">modtime</span><span class="op" id="4764636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764639">if</span>&nbsp;<span class="ident" id="4764642">done</span>&nbsp;<span class="op" id="4764647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764651">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4764659">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4764663">code</span>&nbsp;<span class="op" id="4764668">:=</span>&nbsp;<span class="ident" id="4764671">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4764682">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4764754">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4764822">ctypes</span><span class="op" id="4764828">,</span>&nbsp;<span class="ident" id="4764830">haveType</span>&nbsp;<span class="op" id="4764839">:=</span>&nbsp;<span class="ident" id="4764842">w</span><span class="op" id="4764843">.</span><span class="ident" id="4764844">Header</span><span class="op" id="4764850">(</span><span class="op" id="4764851">)</span><span class="op" id="4764852">[</span><span class="string" id="4764853">&#34;Content-Type&#34;</span><span class="op" id="4764867">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764870">var</span>&nbsp;<span class="ident" id="4764874">ctype</span>&nbsp;<span class="builtintype" id="4764880">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764888">if</span>&nbsp;<span class="op" id="4764891">!</span><span class="ident" id="4764892">haveType</span>&nbsp;<span class="op" id="4764901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4764905">ctype</span>&nbsp;<span class="op" id="4764911">=</span>&nbsp;<span class="ident" id="4764913">mime</span><span class="op" id="4764917">.</span><span class="ident" id="4764918">TypeByExtension</span><span class="op" id="4764933">(</span><span class="ident" id="4764934">filepath</span><span class="op" id="4764942">.</span><span class="ident" id="4764943">Ext</span><span class="op" id="4764946">(</span><span class="ident" id="4764947">name</span><span class="op" id="4764951">)</span><span class="op" id="4764952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4764956">if</span>&nbsp;<span class="ident" id="4764959">ctype</span>&nbsp;<span class="op" id="4764965">==</span>&nbsp;<span class="string" id="4764968">&#34;&#34;</span>&nbsp;<span class="op" id="4764971">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4764976">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765035">var</span>&nbsp;<span class="ident" id="4765039">buf</span>&nbsp;<span class="op" id="4765043">[</span><span class="ident" id="4765044">sniffLen</span><span class="op" id="4765052">]</span><span class="builtintype" id="4765053">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765061">n</span><span class="op" id="4765062">,</span>&nbsp;<span class="ident" id="4765064">_</span>&nbsp;<span class="op" id="4765066">:=</span>&nbsp;<span class="ident" id="4765069">io</span><span class="op" id="4765071">.</span><span class="ident" id="4765072">ReadFull</span><span class="op" id="4765080">(</span><span class="ident" id="4765081">content</span><span class="op" id="4765088">,</span>&nbsp;<span class="ident" id="4765090">buf</span><span class="op" id="4765093">[</span><span class="op" id="4765094">:</span><span class="op" id="4765095">]</span><span class="op" id="4765096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765101">ctype</span>&nbsp;<span class="op" id="4765107">=</span>&nbsp;<span class="ident" id="4765109">DetectContentType</span><span class="op" id="4765126">(</span><span class="ident" id="4765127">buf</span><span class="op" id="4765130">[</span><span class="op" id="4765131">:</span><span class="ident" id="4765132">n</span><span class="op" id="4765133">]</span><span class="op" id="4765134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765139">_</span><span class="op" id="4765140">,</span>&nbsp;<span class="ident" id="4765142">err</span>&nbsp;<span class="op" id="4765146">:=</span>&nbsp;<span class="ident" id="4765149">content</span><span class="op" id="4765156">.</span><span class="ident" id="4765157">Seek</span><span class="op" id="4765161">(</span><span class="num" id="4765162">0</span><span class="op" id="4765163">,</span>&nbsp;<span class="ident" id="4765165">os</span><span class="op" id="4765167">.</span><span class="ident" id="4765168">SEEK_SET</span><span class="op" id="4765176">)</span>&nbsp;<span class="comment" id="4765178">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765212">if</span>&nbsp;<span class="ident" id="4765215">err</span>&nbsp;<span class="op" id="4765219">!=</span>&nbsp;<span class="ident" id="4765222">nil</span>&nbsp;<span class="op" id="4765226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765232">Error</span><span class="op" id="4765237">(</span><span class="ident" id="4765238">w</span><span class="op" id="4765239">,</span>&nbsp;<span class="string" id="4765241">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4765260">,</span>&nbsp;<span class="ident" id="4765262">StatusInternalServerError</span><span class="op" id="4765287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765293">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765307">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765311">w</span><span class="op" id="4765312">.</span><span class="ident" id="4765313">Header</span><span class="op" id="4765319">(</span><span class="op" id="4765320">)</span><span class="op" id="4765321">.</span><span class="ident" id="4765322">Set</span><span class="op" id="4765325">(</span><span class="string" id="4765326">&#34;Content-Type&#34;</span><span class="op" id="4765340">,</span>&nbsp;<span class="ident" id="4765342">ctype</span><span class="op" id="4765347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765350">}</span>&nbsp;<span class="keyword" id="4765352">else</span>&nbsp;<span class="keyword" id="4765357">if</span>&nbsp;<span class="builtinfunc" id="4765360">len</span><span class="op" id="4765363">(</span><span class="ident" id="4765364">ctypes</span><span class="op" id="4765370">)</span>&nbsp;<span class="op" id="4765372">&gt;</span>&nbsp;<span class="num" id="4765374">0</span>&nbsp;<span class="op" id="4765376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765380">ctype</span>&nbsp;<span class="op" id="4765386">=</span>&nbsp;<span class="ident" id="4765388">ctypes</span><span class="op" id="4765394">[</span><span class="num" id="4765395">0</span><span class="op" id="4765396">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765403">size</span><span class="op" id="4765407">,</span>&nbsp;<span class="ident" id="4765409">err</span>&nbsp;<span class="op" id="4765413">:=</span>&nbsp;<span class="ident" id="4765416">sizeFunc</span><span class="op" id="4765424">(</span><span class="op" id="4765425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765428">if</span>&nbsp;<span class="ident" id="4765431">err</span>&nbsp;<span class="op" id="4765435">!=</span>&nbsp;<span class="ident" id="4765438">nil</span>&nbsp;<span class="op" id="4765442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765446">Error</span><span class="op" id="4765451">(</span><span class="ident" id="4765452">w</span><span class="op" id="4765453">,</span>&nbsp;<span class="ident" id="4765455">err</span><span class="op" id="4765458">.</span><span class="ident" id="4765459">Error</span><span class="op" id="4765464">(</span><span class="op" id="4765465">)</span><span class="op" id="4765466">,</span>&nbsp;<span class="ident" id="4765468">StatusInternalServerError</span><span class="op" id="4765493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765497">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765505">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4765509">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765542">sendSize</span>&nbsp;<span class="op" id="4765551">:=</span>&nbsp;<span class="ident" id="4765554">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765560">var</span>&nbsp;<span class="ident" id="4765564">sendContent</span>&nbsp;<span class="ident" id="4765576">io</span><span class="op" id="4765578">.</span><span class="ident" id="4765579">Reader</span>&nbsp;<span class="op" id="4765586">=</span>&nbsp;<span class="ident" id="4765588">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765597">if</span>&nbsp;<span class="ident" id="4765600">size</span>&nbsp;<span class="op" id="4765605">&gt;=</span>&nbsp;<span class="num" id="4765608">0</span>&nbsp;<span class="op" id="4765610">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765614">ranges</span><span class="op" id="4765620">,</span>&nbsp;<span class="ident" id="4765622">err</span>&nbsp;<span class="op" id="4765626">:=</span>&nbsp;<span class="ident" id="4765629">parseRange</span><span class="op" id="4765639">(</span><span class="ident" id="4765640">rangeReq</span><span class="op" id="4765648">,</span>&nbsp;<span class="ident" id="4765650">size</span><span class="op" id="4765654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765658">if</span>&nbsp;<span class="ident" id="4765661">err</span>&nbsp;<span class="op" id="4765665">!=</span>&nbsp;<span class="ident" id="4765668">nil</span>&nbsp;<span class="op" id="4765672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765677">Error</span><span class="op" id="4765682">(</span><span class="ident" id="4765683">w</span><span class="op" id="4765684">,</span>&nbsp;<span class="ident" id="4765686">err</span><span class="op" id="4765689">.</span><span class="ident" id="4765690">Error</span><span class="op" id="4765695">(</span><span class="op" id="4765696">)</span><span class="op" id="4765697">,</span>&nbsp;<span class="ident" id="4765699">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4765733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765738">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765747">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765751">if</span>&nbsp;<span class="ident" id="4765754">sumRangesSize</span><span class="op" id="4765767">(</span><span class="ident" id="4765768">ranges</span><span class="op" id="4765774">)</span>&nbsp;<span class="op" id="4765776">&gt;</span>&nbsp;<span class="ident" id="4765778">size</span>&nbsp;<span class="op" id="4765783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4765788">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4765838">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4765883">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4765933">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4765979">ranges</span>&nbsp;<span class="op" id="4765986">=</span>&nbsp;<span class="ident" id="4765988">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4765994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4765998">switch</span>&nbsp;<span class="op" id="4766005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766009">case</span>&nbsp;<span class="builtinfunc" id="4766014">len</span><span class="op" id="4766017">(</span><span class="ident" id="4766018">ranges</span><span class="op" id="4766024">)</span>&nbsp;<span class="op" id="4766026">==</span>&nbsp;<span class="num" id="4766029">1</span><span class="op" id="4766030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766035">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766066">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766127">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766183">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766239">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766294">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766347">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766403">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766431">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766441">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4766499">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766557">ra</span>&nbsp;<span class="op" id="4766560">:=</span>&nbsp;<span class="ident" id="4766563">ranges</span><span class="op" id="4766569">[</span><span class="num" id="4766570">0</span><span class="op" id="4766571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766576">if</span>&nbsp;<span class="ident" id="4766579">_</span><span class="op" id="4766580">,</span>&nbsp;<span class="ident" id="4766582">err</span>&nbsp;<span class="op" id="4766586">:=</span>&nbsp;<span class="ident" id="4766589">content</span><span class="op" id="4766596">.</span><span class="ident" id="4766597">Seek</span><span class="op" id="4766601">(</span><span class="ident" id="4766602">ra</span><span class="op" id="4766604">.</span><span class="ident" id="4766605">start</span><span class="op" id="4766610">,</span>&nbsp;<span class="ident" id="4766612">os</span><span class="op" id="4766614">.</span><span class="ident" id="4766615">SEEK_SET</span><span class="op" id="4766623">)</span><span class="op" id="4766624">;</span>&nbsp;<span class="ident" id="4766626">err</span>&nbsp;<span class="op" id="4766630">!=</span>&nbsp;<span class="ident" id="4766633">nil</span>&nbsp;<span class="op" id="4766637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766643">Error</span><span class="op" id="4766648">(</span><span class="ident" id="4766649">w</span><span class="op" id="4766650">,</span>&nbsp;<span class="ident" id="4766652">err</span><span class="op" id="4766655">.</span><span class="ident" id="4766656">Error</span><span class="op" id="4766661">(</span><span class="op" id="4766662">)</span><span class="op" id="4766663">,</span>&nbsp;<span class="ident" id="4766665">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4766699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766705">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4766715">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766720">sendSize</span>&nbsp;<span class="op" id="4766729">=</span>&nbsp;<span class="ident" id="4766731">ra</span><span class="op" id="4766733">.</span><span class="ident" id="4766734">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766744">code</span>&nbsp;<span class="op" id="4766749">=</span>&nbsp;<span class="ident" id="4766751">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766775">w</span><span class="op" id="4766776">.</span><span class="ident" id="4766777">Header</span><span class="op" id="4766783">(</span><span class="op" id="4766784">)</span><span class="op" id="4766785">.</span><span class="ident" id="4766786">Set</span><span class="op" id="4766789">(</span><span class="string" id="4766790">&#34;Content-Range&#34;</span><span class="op" id="4766805">,</span>&nbsp;<span class="ident" id="4766807">ra</span><span class="op" id="4766809">.</span><span class="ident" id="4766810">contentRange</span><span class="op" id="4766822">(</span><span class="ident" id="4766823">size</span><span class="op" id="4766827">)</span><span class="op" id="4766828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4766832">case</span>&nbsp;<span class="builtinfunc" id="4766837">len</span><span class="op" id="4766840">(</span><span class="ident" id="4766841">ranges</span><span class="op" id="4766847">)</span>&nbsp;<span class="op" id="4766849">&gt;</span>&nbsp;<span class="num" id="4766851">1</span><span class="op" id="4766852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766857">sendSize</span>&nbsp;<span class="op" id="4766866">=</span>&nbsp;<span class="ident" id="4766868">rangesMIMESize</span><span class="op" id="4766882">(</span><span class="ident" id="4766883">ranges</span><span class="op" id="4766889">,</span>&nbsp;<span class="ident" id="4766891">ctype</span><span class="op" id="4766896">,</span>&nbsp;<span class="ident" id="4766898">size</span><span class="op" id="4766902">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766907">code</span>&nbsp;<span class="op" id="4766912">=</span>&nbsp;<span class="ident" id="4766914">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766939">pr</span><span class="op" id="4766941">,</span>&nbsp;<span class="ident" id="4766943">pw</span>&nbsp;<span class="op" id="4766946">:=</span>&nbsp;<span class="ident" id="4766949">io</span><span class="op" id="4766951">.</span><span class="ident" id="4766952">Pipe</span><span class="op" id="4766956">(</span><span class="op" id="4766957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766962">mw</span>&nbsp;<span class="op" id="4766965">:=</span>&nbsp;<span class="ident" id="4766968">multipart</span><span class="op" id="4766977">.</span><span class="ident" id="4766978">NewWriter</span><span class="op" id="4766987">(</span><span class="ident" id="4766988">pw</span><span class="op" id="4766990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4766995">w</span><span class="op" id="4766996">.</span><span class="ident" id="4766997">Header</span><span class="op" id="4767003">(</span><span class="op" id="4767004">)</span><span class="op" id="4767005">.</span><span class="ident" id="4767006">Set</span><span class="op" id="4767009">(</span><span class="string" id="4767010">&#34;Content-Type&#34;</span><span class="op" id="4767024">,</span>&nbsp;<span class="string" id="4767026">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="4767059">+</span><span class="ident" id="4767060">mw</span><span class="op" id="4767062">.</span><span class="ident" id="4767063">Boundary</span><span class="op" id="4767071">(</span><span class="op" id="4767072">)</span><span class="op" id="4767073">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767078">sendContent</span>&nbsp;<span class="op" id="4767090">=</span>&nbsp;<span class="ident" id="4767092">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767098">defer</span>&nbsp;<span class="ident" id="4767104">pr</span><span class="op" id="4767106">.</span><span class="ident" id="4767107">Close</span><span class="op" id="4767112">(</span><span class="op" id="4767113">)</span>&nbsp;<span class="comment" id="4767115">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767187">go</span>&nbsp;<span class="keyword" id="4767190">func</span><span class="op" id="4767194">(</span><span class="op" id="4767195">)</span>&nbsp;<span class="op" id="4767197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767203">for</span>&nbsp;<span class="ident" id="4767207">_</span><span class="op" id="4767208">,</span>&nbsp;<span class="ident" id="4767210">ra</span>&nbsp;<span class="op" id="4767213">:=</span>&nbsp;<span class="keyword" id="4767216">range</span>&nbsp;<span class="ident" id="4767222">ranges</span>&nbsp;<span class="op" id="4767229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767236">part</span><span class="op" id="4767240">,</span>&nbsp;<span class="ident" id="4767242">err</span>&nbsp;<span class="op" id="4767246">:=</span>&nbsp;<span class="ident" id="4767249">mw</span><span class="op" id="4767251">.</span><span class="ident" id="4767252">CreatePart</span><span class="op" id="4767262">(</span><span class="ident" id="4767263">ra</span><span class="op" id="4767265">.</span><span class="ident" id="4767266">mimeHeader</span><span class="op" id="4767276">(</span><span class="ident" id="4767277">ctype</span><span class="op" id="4767282">,</span>&nbsp;<span class="ident" id="4767284">size</span><span class="op" id="4767288">)</span><span class="op" id="4767289">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767296">if</span>&nbsp;<span class="ident" id="4767299">err</span>&nbsp;<span class="op" id="4767303">!=</span>&nbsp;<span class="ident" id="4767306">nil</span>&nbsp;<span class="op" id="4767310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767318">pw</span><span class="op" id="4767320">.</span><span class="ident" id="4767321">CloseWithError</span><span class="op" id="4767335">(</span><span class="ident" id="4767336">err</span><span class="op" id="4767339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767347">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767366">if</span>&nbsp;<span class="ident" id="4767369">_</span><span class="op" id="4767370">,</span>&nbsp;<span class="ident" id="4767372">err</span>&nbsp;<span class="op" id="4767376">:=</span>&nbsp;<span class="ident" id="4767379">content</span><span class="op" id="4767386">.</span><span class="ident" id="4767387">Seek</span><span class="op" id="4767391">(</span><span class="ident" id="4767392">ra</span><span class="op" id="4767394">.</span><span class="ident" id="4767395">start</span><span class="op" id="4767400">,</span>&nbsp;<span class="ident" id="4767402">os</span><span class="op" id="4767404">.</span><span class="ident" id="4767405">SEEK_SET</span><span class="op" id="4767413">)</span><span class="op" id="4767414">;</span>&nbsp;<span class="ident" id="4767416">err</span>&nbsp;<span class="op" id="4767420">!=</span>&nbsp;<span class="ident" id="4767423">nil</span>&nbsp;<span class="op" id="4767427">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767435">pw</span><span class="op" id="4767437">.</span><span class="ident" id="4767438">CloseWithError</span><span class="op" id="4767452">(</span><span class="ident" id="4767453">err</span><span class="op" id="4767456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767464">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767483">if</span>&nbsp;<span class="ident" id="4767486">_</span><span class="op" id="4767487">,</span>&nbsp;<span class="ident" id="4767489">err</span>&nbsp;<span class="op" id="4767493">:=</span>&nbsp;<span class="ident" id="4767496">io</span><span class="op" id="4767498">.</span><span class="ident" id="4767499">CopyN</span><span class="op" id="4767504">(</span><span class="ident" id="4767505">part</span><span class="op" id="4767509">,</span>&nbsp;<span class="ident" id="4767511">content</span><span class="op" id="4767518">,</span>&nbsp;<span class="ident" id="4767520">ra</span><span class="op" id="4767522">.</span><span class="ident" id="4767523">length</span><span class="op" id="4767529">)</span><span class="op" id="4767530">;</span>&nbsp;<span class="ident" id="4767532">err</span>&nbsp;<span class="op" id="4767536">!=</span>&nbsp;<span class="ident" id="4767539">nil</span>&nbsp;<span class="op" id="4767543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767551">pw</span><span class="op" id="4767553">.</span><span class="ident" id="4767554">CloseWithError</span><span class="op" id="4767568">(</span><span class="ident" id="4767569">err</span><span class="op" id="4767572">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767580">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767604">mw</span><span class="op" id="4767606">.</span><span class="ident" id="4767607">Close</span><span class="op" id="4767612">(</span><span class="op" id="4767613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767619">pw</span><span class="op" id="4767621">.</span><span class="ident" id="4767622">Close</span><span class="op" id="4767627">(</span><span class="op" id="4767628">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767633">}</span><span class="op" id="4767634">(</span><span class="op" id="4767635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767644">w</span><span class="op" id="4767645">.</span><span class="ident" id="4767646">Header</span><span class="op" id="4767652">(</span><span class="op" id="4767653">)</span><span class="op" id="4767654">.</span><span class="ident" id="4767655">Set</span><span class="op" id="4767658">(</span><span class="string" id="4767659">&#34;Accept-Ranges&#34;</span><span class="op" id="4767674">,</span>&nbsp;<span class="string" id="4767676">&#34;bytes&#34;</span><span class="op" id="4767683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767687">if</span>&nbsp;<span class="ident" id="4767690">w</span><span class="op" id="4767691">.</span><span class="ident" id="4767692">Header</span><span class="op" id="4767698">(</span><span class="op" id="4767699">)</span><span class="op" id="4767700">.</span><span class="ident" id="4767701">Get</span><span class="op" id="4767704">(</span><span class="string" id="4767705">&#34;Content-Encoding&#34;</span><span class="op" id="4767723">)</span>&nbsp;<span class="op" id="4767725">==</span>&nbsp;<span class="string" id="4767728">&#34;&#34;</span>&nbsp;<span class="op" id="4767731">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767736">w</span><span class="op" id="4767737">.</span><span class="ident" id="4767738">Header</span><span class="op" id="4767744">(</span><span class="op" id="4767745">)</span><span class="op" id="4767746">.</span><span class="ident" id="4767747">Set</span><span class="op" id="4767750">(</span><span class="string" id="4767751">&#34;Content-Length&#34;</span><span class="op" id="4767767">,</span>&nbsp;<span class="ident" id="4767769">strconv</span><span class="op" id="4767776">.</span><span class="ident" id="4767777">FormatInt</span><span class="op" id="4767786">(</span><span class="ident" id="4767787">sendSize</span><span class="op" id="4767795">,</span>&nbsp;<span class="num" id="4767797">10</span><span class="op" id="4767799">)</span><span class="op" id="4767800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767811">w</span><span class="op" id="4767812">.</span><span class="ident" id="4767813">WriteHeader</span><span class="op" id="4767824">(</span><span class="ident" id="4767825">code</span><span class="op" id="4767829">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4767833">if</span>&nbsp;<span class="ident" id="4767836">r</span><span class="op" id="4767837">.</span><span class="ident" id="4767838">Method</span>&nbsp;<span class="op" id="4767845">!=</span>&nbsp;<span class="string" id="4767848">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4767855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4767859">io</span><span class="op" id="4767861">.</span><span class="ident" id="4767862">CopyN</span><span class="op" id="4767867">(</span><span class="ident" id="4767868">w</span><span class="op" id="4767869">,</span>&nbsp;<span class="ident" id="4767871">sendContent</span><span class="op" id="4767882">,</span>&nbsp;<span class="ident" id="4767884">sendSize</span><span class="op" id="4767892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4767895">}</span><br>
<span class="lineno"></span><span class="op" id="4767897">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4767900">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="4767979">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="4768036">func</span>&nbsp;<span class="ident" id="4768041">checkLastModified</span><span class="op" id="4768058">(</span><span class="ident" id="4768059">w</span>&nbsp;<span class="ident" id="4768061">ResponseWriter</span><span class="op" id="4768075">,</span>&nbsp;<span class="ident" id="4768077">r</span>&nbsp;<span class="op" id="4768079">*</span><span class="ident" id="4768080">Request</span><span class="op" id="4768087">,</span>&nbsp;<span class="ident" id="4768089">modtime</span>&nbsp;<span class="ident" id="4768097">time</span><span class="op" id="4768101">.</span><span class="ident" id="4768102">Time</span><span class="op" id="4768106">)</span>&nbsp;<span class="builtintype" id="4768108">bool</span>&nbsp;<span class="op" id="4768113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768116">if</span>&nbsp;<span class="ident" id="4768119">modtime</span><span class="op" id="4768126">.</span><span class="ident" id="4768127">IsZero</span><span class="op" id="4768133">(</span><span class="op" id="4768134">)</span>&nbsp;<span class="op" id="4768136">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768140">return</span>&nbsp;<span class="builtintype" id="4768147">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4768154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4768158">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4768222">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768290">if</span>&nbsp;<span class="ident" id="4768293">t</span><span class="op" id="4768294">,</span>&nbsp;<span class="ident" id="4768296">err</span>&nbsp;<span class="op" id="4768300">:=</span>&nbsp;<span class="ident" id="4768303">time</span><span class="op" id="4768307">.</span><span class="ident" id="4768308">Parse</span><span class="op" id="4768313">(</span><span class="ident" id="4768314">TimeFormat</span><span class="op" id="4768324">,</span>&nbsp;<span class="ident" id="4768326">r</span><span class="op" id="4768327">.</span><span class="ident" id="4768328">Header</span><span class="op" id="4768334">.</span><span class="ident" id="4768335">Get</span><span class="op" id="4768338">(</span><span class="string" id="4768339">&#34;If-Modified-Since&#34;</span><span class="op" id="4768358">)</span><span class="op" id="4768359">)</span><span class="op" id="4768360">;</span>&nbsp;<span class="ident" id="4768362">err</span>&nbsp;<span class="op" id="4768366">==</span>&nbsp;<span class="ident" id="4768369">nil</span>&nbsp;<span class="op" id="4768373">&amp;&amp;</span>&nbsp;<span class="ident" id="4768376">modtime</span><span class="op" id="4768383">.</span><span class="ident" id="4768384">Before</span><span class="op" id="4768390">(</span><span class="ident" id="4768391">t</span><span class="op" id="4768392">.</span><span class="ident" id="4768393">Add</span><span class="op" id="4768396">(</span><span class="num" id="4768397">1</span><span class="op" id="4768398">*</span><span class="ident" id="4768399">time</span><span class="op" id="4768403">.</span><span class="ident" id="4768404">Second</span><span class="op" id="4768410">)</span><span class="op" id="4768411">)</span>&nbsp;<span class="op" id="4768413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768417">h</span>&nbsp;<span class="op" id="4768419">:=</span>&nbsp;<span class="ident" id="4768422">w</span><span class="op" id="4768423">.</span><span class="ident" id="4768424">Header</span><span class="op" id="4768430">(</span><span class="op" id="4768431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4768435">delete</span><span class="op" id="4768441">(</span><span class="ident" id="4768442">h</span><span class="op" id="4768443">,</span>&nbsp;<span class="string" id="4768445">&#34;Content-Type&#34;</span><span class="op" id="4768459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4768463">delete</span><span class="op" id="4768469">(</span><span class="ident" id="4768470">h</span><span class="op" id="4768471">,</span>&nbsp;<span class="string" id="4768473">&#34;Content-Length&#34;</span><span class="op" id="4768489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768493">w</span><span class="op" id="4768494">.</span><span class="ident" id="4768495">WriteHeader</span><span class="op" id="4768506">(</span><span class="ident" id="4768507">StatusNotModified</span><span class="op" id="4768524">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768528">return</span>&nbsp;<span class="builtintype" id="4768535">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4768541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4768544">w</span><span class="op" id="4768545">.</span><span class="ident" id="4768546">Header</span><span class="op" id="4768552">(</span><span class="op" id="4768553">)</span><span class="op" id="4768554">.</span><span class="ident" id="4768555">Set</span><span class="op" id="4768558">(</span><span class="string" id="4768559">&#34;Last-Modified&#34;</span><span class="op" id="4768574">,</span>&nbsp;<span class="ident" id="4768576">modtime</span><span class="op" id="4768583">.</span><span class="ident" id="4768584">UTC</span><span class="op" id="4768587">(</span><span class="op" id="4768588">)</span><span class="op" id="4768589">.</span><span class="ident" id="4768590">Format</span><span class="op" id="4768596">(</span><span class="ident" id="4768597">TimeFormat</span><span class="op" id="4768607">)</span><span class="op" id="4768608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4768611">return</span>&nbsp;<span class="builtintype" id="4768618">false</span><br>
<span class="lineno"></span><span class="op" id="4768624">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4768627">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="4768686">//</span><br>
<span class="lineno"></span><span class="comment" id="4768689">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4768749">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="4768818">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="4768876">//</span><br>
<span class="lineno"></span><span class="comment" id="4768879">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4768950">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="4768998">func</span>&nbsp;<span class="ident" id="4769003">checkETag</span><span class="op" id="4769012">(</span><span class="ident" id="4769013">w</span>&nbsp;<span class="ident" id="4769015">ResponseWriter</span><span class="op" id="4769029">,</span>&nbsp;<span class="ident" id="4769031">r</span>&nbsp;<span class="op" id="4769033">*</span><span class="ident" id="4769034">Request</span><span class="op" id="4769041">,</span>&nbsp;<span class="ident" id="4769043">modtime</span>&nbsp;<span class="ident" id="4769051">time</span><span class="op" id="4769055">.</span><span class="ident" id="4769056">Time</span><span class="op" id="4769060">)</span>&nbsp;<span class="op" id="4769062">(</span><span class="ident" id="4769063">rangeReq</span>&nbsp;<span class="builtintype" id="4769072">string</span><span class="op" id="4769078">,</span>&nbsp;<span class="ident" id="4769080">done</span>&nbsp;<span class="builtintype" id="4769085">bool</span><span class="op" id="4769089">)</span>&nbsp;<span class="op" id="4769091">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769094">etag</span>&nbsp;<span class="op" id="4769099">:=</span>&nbsp;<span class="ident" id="4769102">w</span><span class="op" id="4769103">.</span><span class="ident" id="4769104">Header</span><span class="op" id="4769110">(</span><span class="op" id="4769111">)</span><span class="op" id="4769112">.</span><span class="ident" id="4769113">get</span><span class="op" id="4769116">(</span><span class="string" id="4769117">&#34;Etag&#34;</span><span class="op" id="4769123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769126">rangeReq</span>&nbsp;<span class="op" id="4769135">=</span>&nbsp;<span class="ident" id="4769137">r</span><span class="op" id="4769138">.</span><span class="ident" id="4769139">Header</span><span class="op" id="4769145">.</span><span class="ident" id="4769146">get</span><span class="op" id="4769149">(</span><span class="string" id="4769150">&#34;Range&#34;</span><span class="op" id="4769157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769161">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769230">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769260">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769343">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769362">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769397">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769460">if</span>&nbsp;<span class="ident" id="4769463">ir</span>&nbsp;<span class="op" id="4769466">:=</span>&nbsp;<span class="ident" id="4769469">r</span><span class="op" id="4769470">.</span><span class="ident" id="4769471">Header</span><span class="op" id="4769477">.</span><span class="ident" id="4769478">get</span><span class="op" id="4769481">(</span><span class="string" id="4769482">&#34;If-Range&#34;</span><span class="op" id="4769492">)</span><span class="op" id="4769493">;</span>&nbsp;<span class="ident" id="4769495">ir</span>&nbsp;<span class="op" id="4769498">!=</span>&nbsp;<span class="string" id="4769501">&#34;&#34;</span>&nbsp;<span class="op" id="4769504">&amp;&amp;</span>&nbsp;<span class="ident" id="4769507">ir</span>&nbsp;<span class="op" id="4769510">!=</span>&nbsp;<span class="ident" id="4769513">etag</span>&nbsp;<span class="op" id="4769518">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769522">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769594">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769644">timeMatches</span>&nbsp;<span class="op" id="4769656">:=</span>&nbsp;<span class="builtintype" id="4769659">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769667">if</span>&nbsp;<span class="op" id="4769670">!</span><span class="ident" id="4769671">modtime</span><span class="op" id="4769678">.</span><span class="ident" id="4769679">IsZero</span><span class="op" id="4769685">(</span><span class="op" id="4769686">)</span>&nbsp;<span class="op" id="4769688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769693">if</span>&nbsp;<span class="ident" id="4769696">t</span><span class="op" id="4769697">,</span>&nbsp;<span class="ident" id="4769699">err</span>&nbsp;<span class="op" id="4769703">:=</span>&nbsp;<span class="ident" id="4769706">ParseTime</span><span class="op" id="4769715">(</span><span class="ident" id="4769716">ir</span><span class="op" id="4769718">)</span><span class="op" id="4769719">;</span>&nbsp;<span class="ident" id="4769721">err</span>&nbsp;<span class="op" id="4769725">==</span>&nbsp;<span class="ident" id="4769728">nil</span>&nbsp;<span class="op" id="4769732">&amp;&amp;</span>&nbsp;<span class="ident" id="4769735">t</span><span class="op" id="4769736">.</span><span class="ident" id="4769737">Unix</span><span class="op" id="4769741">(</span><span class="op" id="4769742">)</span>&nbsp;<span class="op" id="4769744">==</span>&nbsp;<span class="ident" id="4769747">modtime</span><span class="op" id="4769754">.</span><span class="ident" id="4769755">Unix</span><span class="op" id="4769759">(</span><span class="op" id="4769760">)</span>&nbsp;<span class="op" id="4769762">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769768">timeMatches</span>&nbsp;<span class="op" id="4769780">=</span>&nbsp;<span class="builtintype" id="4769782">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769798">if</span>&nbsp;<span class="op" id="4769801">!</span><span class="ident" id="4769802">timeMatches</span>&nbsp;<span class="op" id="4769814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4769819">rangeReq</span>&nbsp;<span class="op" id="4769828">=</span>&nbsp;<span class="string" id="4769830">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769842">if</span>&nbsp;<span class="ident" id="4769845">inm</span>&nbsp;<span class="op" id="4769849">:=</span>&nbsp;<span class="ident" id="4769852">r</span><span class="op" id="4769853">.</span><span class="ident" id="4769854">Header</span><span class="op" id="4769860">.</span><span class="ident" id="4769861">get</span><span class="op" id="4769864">(</span><span class="string" id="4769865">&#34;If-None-Match&#34;</span><span class="op" id="4769880">)</span><span class="op" id="4769881">;</span>&nbsp;<span class="ident" id="4769883">inm</span>&nbsp;<span class="op" id="4769887">!=</span>&nbsp;<span class="string" id="4769890">&#34;&#34;</span>&nbsp;<span class="op" id="4769893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769897">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769918">if</span>&nbsp;<span class="ident" id="4769921">etag</span>&nbsp;<span class="op" id="4769926">==</span>&nbsp;<span class="string" id="4769929">&#34;&#34;</span>&nbsp;<span class="op" id="4769932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4769937">return</span>&nbsp;<span class="ident" id="4769944">rangeReq</span><span class="op" id="4769952">,</span>&nbsp;<span class="builtintype" id="4769954">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4769962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4769967">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770029">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770082">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770142">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770202">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770257">if</span>&nbsp;<span class="ident" id="4770260">r</span><span class="op" id="4770261">.</span><span class="ident" id="4770262">Method</span>&nbsp;<span class="op" id="4770269">!=</span>&nbsp;<span class="string" id="4770272">&#34;GET&#34;</span>&nbsp;<span class="op" id="4770278">&amp;&amp;</span>&nbsp;<span class="ident" id="4770281">r</span><span class="op" id="4770282">.</span><span class="ident" id="4770283">Method</span>&nbsp;<span class="op" id="4770290">!=</span>&nbsp;<span class="string" id="4770293">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4770300">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770305">return</span>&nbsp;<span class="ident" id="4770312">rangeReq</span><span class="op" id="4770320">,</span>&nbsp;<span class="builtintype" id="4770322">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770335">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770401">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770468">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770496">if</span>&nbsp;<span class="ident" id="4770499">inm</span>&nbsp;<span class="op" id="4770503">==</span>&nbsp;<span class="ident" id="4770506">etag</span>&nbsp;<span class="op" id="4770511">||</span>&nbsp;<span class="ident" id="4770514">inm</span>&nbsp;<span class="op" id="4770518">==</span>&nbsp;<span class="string" id="4770521">&#34;*&#34;</span>&nbsp;<span class="op" id="4770525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770530">h</span>&nbsp;<span class="op" id="4770532">:=</span>&nbsp;<span class="ident" id="4770535">w</span><span class="op" id="4770536">.</span><span class="ident" id="4770537">Header</span><span class="op" id="4770543">(</span><span class="op" id="4770544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4770549">delete</span><span class="op" id="4770555">(</span><span class="ident" id="4770556">h</span><span class="op" id="4770557">,</span>&nbsp;<span class="string" id="4770559">&#34;Content-Type&#34;</span><span class="op" id="4770573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4770578">delete</span><span class="op" id="4770584">(</span><span class="ident" id="4770585">h</span><span class="op" id="4770586">,</span>&nbsp;<span class="string" id="4770588">&#34;Content-Length&#34;</span><span class="op" id="4770604">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4770609">w</span><span class="op" id="4770610">.</span><span class="ident" id="4770611">WriteHeader</span><span class="op" id="4770622">(</span><span class="ident" id="4770623">StatusNotModified</span><span class="op" id="4770640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770645">return</span>&nbsp;<span class="string" id="4770652">&#34;&#34;</span><span class="op" id="4770654">,</span>&nbsp;<span class="builtintype" id="4770656">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4770666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770669">return</span>&nbsp;<span class="ident" id="4770676">rangeReq</span><span class="op" id="4770684">,</span>&nbsp;<span class="builtintype" id="4770686">false</span><br>
<span class="lineno">340</span><span class="op" id="4770692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4770695">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="4770745">func</span>&nbsp;<span class="ident" id="4770750">serveFile</span><span class="op" id="4770759">(</span><span class="ident" id="4770760">w</span>&nbsp;<span class="ident" id="4770762">ResponseWriter</span><span class="op" id="4770776">,</span>&nbsp;<span class="ident" id="4770778">r</span>&nbsp;<span class="op" id="4770780">*</span><span class="ident" id="4770781">Request</span><span class="op" id="4770788">,</span>&nbsp;<span class="ident" id="4770790">fs</span>&nbsp;<span class="ident" id="4770793">FileSystem</span><span class="op" id="4770803">,</span>&nbsp;<span class="ident" id="4770805">name</span>&nbsp;<span class="builtintype" id="4770810">string</span><span class="op" id="4770816">,</span>&nbsp;<span class="ident" id="4770818">redirect</span>&nbsp;<span class="builtintype" id="4770827">bool</span><span class="op" id="4770831">)</span>&nbsp;<span class="op" id="4770833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4770836">const</span>&nbsp;<span class="ident" id="4770842">indexPage</span>&nbsp;<span class="op" id="4770852">=</span>&nbsp;<span class="string" id="4770854">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770870">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770906">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4770974">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771029">if</span>&nbsp;<span class="ident" id="4771032">strings</span><span class="op" id="4771039">.</span><span class="ident" id="4771040">HasSuffix</span><span class="op" id="4771049">(</span><span class="ident" id="4771050">r</span><span class="op" id="4771051">.</span><span class="ident" id="4771052">URL</span><span class="op" id="4771055">.</span><span class="ident" id="4771056">Path</span><span class="op" id="4771060">,</span>&nbsp;<span class="ident" id="4771062">indexPage</span><span class="op" id="4771071">)</span>&nbsp;<span class="op" id="4771073">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771077">localRedirect</span><span class="op" id="4771090">(</span><span class="ident" id="4771091">w</span><span class="op" id="4771092">,</span>&nbsp;<span class="ident" id="4771094">r</span><span class="op" id="4771095">,</span>&nbsp;<span class="string" id="4771097">&#34;./&#34;</span><span class="op" id="4771101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771105">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771117">f</span><span class="op" id="4771118">,</span>&nbsp;<span class="ident" id="4771120">err</span>&nbsp;<span class="op" id="4771124">:=</span>&nbsp;<span class="ident" id="4771127">fs</span><span class="op" id="4771129">.</span><span class="ident" id="4771130">Open</span><span class="op" id="4771134">(</span><span class="ident" id="4771135">name</span><span class="op" id="4771139">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771142">if</span>&nbsp;<span class="ident" id="4771145">err</span>&nbsp;<span class="op" id="4771149">!=</span>&nbsp;<span class="ident" id="4771152">nil</span>&nbsp;<span class="op" id="4771156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771160">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771191">NotFound</span><span class="op" id="4771199">(</span><span class="ident" id="4771200">w</span><span class="op" id="4771201">,</span>&nbsp;<span class="ident" id="4771203">r</span><span class="op" id="4771204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771208">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771216">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771219">defer</span>&nbsp;<span class="ident" id="4771225">f</span><span class="op" id="4771226">.</span><span class="ident" id="4771227">Close</span><span class="op" id="4771232">(</span><span class="op" id="4771233">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771237">d</span><span class="op" id="4771238">,</span>&nbsp;<span class="ident" id="4771240">err1</span>&nbsp;<span class="op" id="4771245">:=</span>&nbsp;<span class="ident" id="4771248">f</span><span class="op" id="4771249">.</span><span class="ident" id="4771250">Stat</span><span class="op" id="4771254">(</span><span class="op" id="4771255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771258">if</span>&nbsp;<span class="ident" id="4771261">err1</span>&nbsp;<span class="op" id="4771266">!=</span>&nbsp;<span class="ident" id="4771269">nil</span>&nbsp;<span class="op" id="4771273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771277">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771308">NotFound</span><span class="op" id="4771316">(</span><span class="ident" id="4771317">w</span><span class="op" id="4771318">,</span>&nbsp;<span class="ident" id="4771320">r</span><span class="op" id="4771321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771325">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771337">if</span>&nbsp;<span class="ident" id="4771340">redirect</span>&nbsp;<span class="op" id="4771349">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771353">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771412">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771449">url</span>&nbsp;<span class="op" id="4771453">:=</span>&nbsp;<span class="ident" id="4771456">r</span><span class="op" id="4771457">.</span><span class="ident" id="4771458">URL</span><span class="op" id="4771461">.</span><span class="ident" id="4771462">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771469">if</span>&nbsp;<span class="ident" id="4771472">d</span><span class="op" id="4771473">.</span><span class="ident" id="4771474">IsDir</span><span class="op" id="4771479">(</span><span class="op" id="4771480">)</span>&nbsp;<span class="op" id="4771482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771487">if</span>&nbsp;<span class="ident" id="4771490">url</span><span class="op" id="4771493">[</span><span class="builtinfunc" id="4771494">len</span><span class="op" id="4771497">(</span><span class="ident" id="4771498">url</span><span class="op" id="4771501">)</span><span class="op" id="4771502">-</span><span class="num" id="4771503">1</span><span class="op" id="4771504">]</span>&nbsp;<span class="op" id="4771506">!=</span>&nbsp;<span class="string" id="4771509">&#39;/&#39;</span>&nbsp;<span class="op" id="4771513">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771519">localRedirect</span><span class="op" id="4771532">(</span><span class="ident" id="4771533">w</span><span class="op" id="4771534">,</span>&nbsp;<span class="ident" id="4771536">r</span><span class="op" id="4771537">,</span>&nbsp;<span class="ident" id="4771539">path</span><span class="op" id="4771543">.</span><span class="ident" id="4771544">Base</span><span class="op" id="4771548">(</span><span class="ident" id="4771549">url</span><span class="op" id="4771552">)</span><span class="op" id="4771553">+</span><span class="string" id="4771554">&#34;/&#34;</span><span class="op" id="4771557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771563">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771577">}</span>&nbsp;<span class="keyword" id="4771579">else</span>&nbsp;<span class="op" id="4771584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771589">if</span>&nbsp;<span class="ident" id="4771592">url</span><span class="op" id="4771595">[</span><span class="builtinfunc" id="4771596">len</span><span class="op" id="4771599">(</span><span class="ident" id="4771600">url</span><span class="op" id="4771603">)</span><span class="op" id="4771604">-</span><span class="num" id="4771605">1</span><span class="op" id="4771606">]</span>&nbsp;<span class="op" id="4771608">==</span>&nbsp;<span class="string" id="4771611">&#39;/&#39;</span>&nbsp;<span class="op" id="4771615">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771621">localRedirect</span><span class="op" id="4771634">(</span><span class="ident" id="4771635">w</span><span class="op" id="4771636">,</span>&nbsp;<span class="ident" id="4771638">r</span><span class="op" id="4771639">,</span>&nbsp;<span class="string" id="4771641">&#34;../&#34;</span><span class="op" id="4771646">+</span><span class="ident" id="4771647">path</span><span class="op" id="4771651">.</span><span class="ident" id="4771652">Base</span><span class="op" id="4771656">(</span><span class="ident" id="4771657">url</span><span class="op" id="4771660">)</span><span class="op" id="4771661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771667">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771684">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771688">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771745">if</span>&nbsp;<span class="ident" id="4771748">d</span><span class="op" id="4771749">.</span><span class="ident" id="4771750">IsDir</span><span class="op" id="4771755">(</span><span class="op" id="4771756">)</span>&nbsp;<span class="op" id="4771758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771762">index</span>&nbsp;<span class="op" id="4771768">:=</span>&nbsp;<span class="ident" id="4771771">strings</span><span class="op" id="4771778">.</span><span class="ident" id="4771779">TrimSuffix</span><span class="op" id="4771789">(</span><span class="ident" id="4771790">name</span><span class="op" id="4771794">,</span>&nbsp;<span class="string" id="4771796">&#34;/&#34;</span><span class="op" id="4771799">)</span>&nbsp;<span class="op" id="4771801">+</span>&nbsp;<span class="ident" id="4771803">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771815">ff</span><span class="op" id="4771817">,</span>&nbsp;<span class="ident" id="4771819">err</span>&nbsp;<span class="op" id="4771823">:=</span>&nbsp;<span class="ident" id="4771826">fs</span><span class="op" id="4771828">.</span><span class="ident" id="4771829">Open</span><span class="op" id="4771833">(</span><span class="ident" id="4771834">index</span><span class="op" id="4771839">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771843">if</span>&nbsp;<span class="ident" id="4771846">err</span>&nbsp;<span class="op" id="4771850">==</span>&nbsp;<span class="ident" id="4771853">nil</span>&nbsp;<span class="op" id="4771857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771862">defer</span>&nbsp;<span class="ident" id="4771868">ff</span><span class="op" id="4771870">.</span><span class="ident" id="4771871">Close</span><span class="op" id="4771876">(</span><span class="op" id="4771877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771882">dd</span><span class="op" id="4771884">,</span>&nbsp;<span class="ident" id="4771886">err</span>&nbsp;<span class="op" id="4771890">:=</span>&nbsp;<span class="ident" id="4771893">ff</span><span class="op" id="4771895">.</span><span class="ident" id="4771896">Stat</span><span class="op" id="4771900">(</span><span class="op" id="4771901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4771906">if</span>&nbsp;<span class="ident" id="4771909">err</span>&nbsp;<span class="op" id="4771913">==</span>&nbsp;<span class="ident" id="4771916">nil</span>&nbsp;<span class="op" id="4771920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771926">name</span>&nbsp;<span class="op" id="4771931">=</span>&nbsp;<span class="ident" id="4771933">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771943">d</span>&nbsp;<span class="op" id="4771945">=</span>&nbsp;<span class="ident" id="4771947">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4771954">f</span>&nbsp;<span class="op" id="4771956">=</span>&nbsp;<span class="ident" id="4771958">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4771971">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4771975">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772034">if</span>&nbsp;<span class="ident" id="4772037">d</span><span class="op" id="4772038">.</span><span class="ident" id="4772039">IsDir</span><span class="op" id="4772044">(</span><span class="op" id="4772045">)</span>&nbsp;<span class="op" id="4772047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772051">if</span>&nbsp;<span class="ident" id="4772054">checkLastModified</span><span class="op" id="4772071">(</span><span class="ident" id="4772072">w</span><span class="op" id="4772073">,</span>&nbsp;<span class="ident" id="4772075">r</span><span class="op" id="4772076">,</span>&nbsp;<span class="ident" id="4772078">d</span><span class="op" id="4772079">.</span><span class="ident" id="4772080">ModTime</span><span class="op" id="4772087">(</span><span class="op" id="4772088">)</span><span class="op" id="4772089">)</span>&nbsp;<span class="op" id="4772091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772096">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772109">dirList</span><span class="op" id="4772116">(</span><span class="ident" id="4772117">w</span><span class="op" id="4772118">,</span>&nbsp;<span class="ident" id="4772120">f</span><span class="op" id="4772121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4772137">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772183">sizeFunc</span>&nbsp;<span class="op" id="4772192">:=</span>&nbsp;<span class="keyword" id="4772195">func</span><span class="op" id="4772199">(</span><span class="op" id="4772200">)</span>&nbsp;<span class="op" id="4772202">(</span><span class="ident" id="4772203">int64</span><span class="op" id="4772208">,</span>&nbsp;<span class="builtintype" id="4772210">error</span><span class="op" id="4772215">)</span>&nbsp;<span class="op" id="4772217">{</span>&nbsp;<span class="keyword" id="4772219">return</span>&nbsp;<span class="ident" id="4772226">d</span><span class="op" id="4772227">.</span><span class="ident" id="4772228">Size</span><span class="op" id="4772232">(</span><span class="op" id="4772233">)</span><span class="op" id="4772234">,</span>&nbsp;<span class="ident" id="4772236">nil</span>&nbsp;<span class="op" id="4772240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772243">serveContent</span><span class="op" id="4772255">(</span><span class="ident" id="4772256">w</span><span class="op" id="4772257">,</span>&nbsp;<span class="ident" id="4772259">r</span><span class="op" id="4772260">,</span>&nbsp;<span class="ident" id="4772262">d</span><span class="op" id="4772263">.</span><span class="ident" id="4772264">Name</span><span class="op" id="4772268">(</span><span class="op" id="4772269">)</span><span class="op" id="4772270">,</span>&nbsp;<span class="ident" id="4772272">d</span><span class="op" id="4772273">.</span><span class="ident" id="4772274">ModTime</span><span class="op" id="4772281">(</span><span class="op" id="4772282">)</span><span class="op" id="4772283">,</span>&nbsp;<span class="ident" id="4772285">sizeFunc</span><span class="op" id="4772293">,</span>&nbsp;<span class="ident" id="4772295">f</span><span class="op" id="4772296">)</span><br>
<span class="lineno"></span><span class="op" id="4772298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4772301">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4772354">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="4772430">func</span>&nbsp;<span class="ident" id="4772435">localRedirect</span><span class="op" id="4772448">(</span><span class="ident" id="4772449">w</span>&nbsp;<span class="ident" id="4772451">ResponseWriter</span><span class="op" id="4772465">,</span>&nbsp;<span class="ident" id="4772467">r</span>&nbsp;<span class="op" id="4772469">*</span><span class="ident" id="4772470">Request</span><span class="op" id="4772477">,</span>&nbsp;<span class="ident" id="4772479">newPath</span>&nbsp;<span class="builtintype" id="4772487">string</span><span class="op" id="4772493">)</span>&nbsp;<span class="op" id="4772495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4772498">if</span>&nbsp;<span class="ident" id="4772501">q</span>&nbsp;<span class="op" id="4772503">:=</span>&nbsp;<span class="ident" id="4772506">r</span><span class="op" id="4772507">.</span><span class="ident" id="4772508">URL</span><span class="op" id="4772511">.</span><span class="ident" id="4772512">RawQuery</span><span class="op" id="4772520">;</span>&nbsp;<span class="ident" id="4772522">q</span>&nbsp;<span class="op" id="4772524">!=</span>&nbsp;<span class="string" id="4772527">&#34;&#34;</span>&nbsp;<span class="op" id="4772530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772534">newPath</span>&nbsp;<span class="op" id="4772542">+=</span>&nbsp;<span class="string" id="4772545">&#34;?&#34;</span>&nbsp;<span class="op" id="4772549">+</span>&nbsp;<span class="ident" id="4772551">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4772554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772557">w</span><span class="op" id="4772558">.</span><span class="ident" id="4772559">Header</span><span class="op" id="4772565">(</span><span class="op" id="4772566">)</span><span class="op" id="4772567">.</span><span class="ident" id="4772568">Set</span><span class="op" id="4772571">(</span><span class="string" id="4772572">&#34;Location&#34;</span><span class="op" id="4772582">,</span>&nbsp;<span class="ident" id="4772584">newPath</span><span class="op" id="4772591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772594">w</span><span class="op" id="4772595">.</span><span class="ident" id="4772596">WriteHeader</span><span class="op" id="4772607">(</span><span class="ident" id="4772608">StatusMovedPermanently</span><span class="op" id="4772630">)</span><br>
<span class="lineno"></span><span class="op" id="4772632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="4772635">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="4772721">func</span>&nbsp;<span class="ident" id="4772726">ServeFile</span><span class="op" id="4772735">(</span><span class="ident" id="4772736">w</span>&nbsp;<span class="ident" id="4772738">ResponseWriter</span><span class="op" id="4772752">,</span>&nbsp;<span class="ident" id="4772754">r</span>&nbsp;<span class="op" id="4772756">*</span><span class="ident" id="4772757">Request</span><span class="op" id="4772764">,</span>&nbsp;<span class="ident" id="4772766">name</span>&nbsp;<span class="builtintype" id="4772771">string</span><span class="op" id="4772777">)</span>&nbsp;<span class="op" id="4772779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772782">dir</span><span class="op" id="4772785">,</span>&nbsp;<span class="ident" id="4772787">file</span>&nbsp;<span class="op" id="4772792">:=</span>&nbsp;<span class="ident" id="4772795">filepath</span><span class="op" id="4772803">.</span><span class="ident" id="4772804">Split</span><span class="op" id="4772809">(</span><span class="ident" id="4772810">name</span><span class="op" id="4772814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772817">serveFile</span><span class="op" id="4772826">(</span><span class="ident" id="4772827">w</span><span class="op" id="4772828">,</span>&nbsp;<span class="ident" id="4772830">r</span><span class="op" id="4772831">,</span>&nbsp;<span class="ident" id="4772833">Dir</span><span class="op" id="4772836">(</span><span class="ident" id="4772837">dir</span><span class="op" id="4772840">)</span><span class="op" id="4772841">,</span>&nbsp;<span class="ident" id="4772843">file</span><span class="op" id="4772847">,</span>&nbsp;<span class="builtintype" id="4772849">false</span><span class="op" id="4772854">)</span><br>
<span class="lineno"></span><span class="op" id="4772856">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4772859">type</span>&nbsp;<span class="ident" id="4772864">fileHandler</span>&nbsp;<span class="keyword" id="4772876">struct</span>&nbsp;<span class="op" id="4772883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4772886">root</span>&nbsp;<span class="ident" id="4772891">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="4772902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="4772905">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4772963">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="4773019">//</span><br>
<span class="lineno"></span><span class="comment" id="4773022">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="4773083">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="4773100">//</span><br>
<span class="lineno"></span><span class="comment" id="4773103">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="4773162">func</span>&nbsp;<span class="ident" id="4773167">FileServer</span><span class="op" id="4773177">(</span><span class="ident" id="4773178">root</span>&nbsp;<span class="ident" id="4773183">FileSystem</span><span class="op" id="4773193">)</span>&nbsp;<span class="ident" id="4773195">Handler</span>&nbsp;<span class="op" id="4773203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773206">return</span>&nbsp;<span class="op" id="4773213">&amp;</span><span class="ident" id="4773214">fileHandler</span><span class="op" id="4773225">{</span><span class="ident" id="4773226">root</span><span class="op" id="4773230">}</span><br>
<span class="lineno"></span><span class="op" id="4773232">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="4773235">func</span>&nbsp;<span class="op" id="4773240">(</span><span class="ident" id="4773241">f</span>&nbsp;<span class="op" id="4773243">*</span><span class="ident" id="4773244">fileHandler</span><span class="op" id="4773255">)</span>&nbsp;<span class="ident" id="4773257">ServeHTTP</span><span class="op" id="4773266">(</span><span class="ident" id="4773267">w</span>&nbsp;<span class="ident" id="4773269">ResponseWriter</span><span class="op" id="4773283">,</span>&nbsp;<span class="ident" id="4773285">r</span>&nbsp;<span class="op" id="4773287">*</span><span class="ident" id="4773288">Request</span><span class="op" id="4773295">)</span>&nbsp;<span class="op" id="4773297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773300">upath</span>&nbsp;<span class="op" id="4773306">:=</span>&nbsp;<span class="ident" id="4773309">r</span><span class="op" id="4773310">.</span><span class="ident" id="4773311">URL</span><span class="op" id="4773314">.</span><span class="ident" id="4773315">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773321">if</span>&nbsp;<span class="op" id="4773324">!</span><span class="ident" id="4773325">strings</span><span class="op" id="4773332">.</span><span class="ident" id="4773333">HasPrefix</span><span class="op" id="4773342">(</span><span class="ident" id="4773343">upath</span><span class="op" id="4773348">,</span>&nbsp;<span class="string" id="4773350">&#34;/&#34;</span><span class="op" id="4773353">)</span>&nbsp;<span class="op" id="4773355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773359">upath</span>&nbsp;<span class="op" id="4773365">=</span>&nbsp;<span class="string" id="4773367">&#34;/&#34;</span>&nbsp;<span class="op" id="4773371">+</span>&nbsp;<span class="ident" id="4773373">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773381">r</span><span class="op" id="4773382">.</span><span class="ident" id="4773383">URL</span><span class="op" id="4773386">.</span><span class="ident" id="4773387">Path</span>&nbsp;<span class="op" id="4773392">=</span>&nbsp;<span class="ident" id="4773394">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773404">serveFile</span><span class="op" id="4773413">(</span><span class="ident" id="4773414">w</span><span class="op" id="4773415">,</span>&nbsp;<span class="ident" id="4773417">r</span><span class="op" id="4773418">,</span>&nbsp;<span class="ident" id="4773420">f</span><span class="op" id="4773421">.</span><span class="ident" id="4773422">root</span><span class="op" id="4773426">,</span>&nbsp;<span class="ident" id="4773428">path</span><span class="op" id="4773432">.</span><span class="ident" id="4773433">Clean</span><span class="op" id="4773438">(</span><span class="ident" id="4773439">upath</span><span class="op" id="4773444">)</span><span class="op" id="4773445">,</span>&nbsp;<span class="builtintype" id="4773447">true</span><span class="op" id="4773451">)</span><br>
<span class="lineno"></span><span class="op" id="4773453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="4773456">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4773520">type</span>&nbsp;<span class="ident" id="4773525">httpRange</span>&nbsp;<span class="keyword" id="4773535">struct</span>&nbsp;<span class="op" id="4773542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4773545">start</span><span class="op" id="4773550">,</span>&nbsp;<span class="ident" id="4773552">length</span>&nbsp;<span class="ident" id="4773559">int64</span><br>
<span class="lineno"></span><span class="op" id="4773565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="4773568">func</span>&nbsp;<span class="op" id="4773573">(</span><span class="ident" id="4773574">r</span>&nbsp;<span class="ident" id="4773576">httpRange</span><span class="op" id="4773585">)</span>&nbsp;<span class="ident" id="4773587">contentRange</span><span class="op" id="4773599">(</span><span class="ident" id="4773600">size</span>&nbsp;<span class="ident" id="4773605">int64</span><span class="op" id="4773610">)</span>&nbsp;<span class="builtintype" id="4773612">string</span>&nbsp;<span class="op" id="4773619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773622">return</span>&nbsp;<span class="ident" id="4773629">fmt</span><span class="op" id="4773632">.</span><span class="ident" id="4773633">Sprintf</span><span class="op" id="4773640">(</span><span class="string" id="4773641">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="4773657">,</span>&nbsp;<span class="ident" id="4773659">r</span><span class="op" id="4773660">.</span><span class="ident" id="4773661">start</span><span class="op" id="4773666">,</span>&nbsp;<span class="ident" id="4773668">r</span><span class="op" id="4773669">.</span><span class="ident" id="4773670">start</span><span class="op" id="4773675">+</span><span class="ident" id="4773676">r</span><span class="op" id="4773677">.</span><span class="ident" id="4773678">length</span><span class="op" id="4773684">-</span><span class="num" id="4773685">1</span><span class="op" id="4773686">,</span>&nbsp;<span class="ident" id="4773688">size</span><span class="op" id="4773692">)</span><br>
<span class="lineno"></span><span class="op" id="4773694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4773697">func</span>&nbsp;<span class="op" id="4773702">(</span><span class="ident" id="4773703">r</span>&nbsp;<span class="ident" id="4773705">httpRange</span><span class="op" id="4773714">)</span>&nbsp;<span class="ident" id="4773716">mimeHeader</span><span class="op" id="4773726">(</span><span class="ident" id="4773727">contentType</span>&nbsp;<span class="builtintype" id="4773739">string</span><span class="op" id="4773745">,</span>&nbsp;<span class="ident" id="4773747">size</span>&nbsp;<span class="ident" id="4773752">int64</span><span class="op" id="4773757">)</span>&nbsp;<span class="ident" id="4773759">textproto</span><span class="op" id="4773768">.</span><span class="ident" id="4773769">MIMEHeader</span>&nbsp;<span class="op" id="4773780">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4773783">return</span>&nbsp;<span class="ident" id="4773790">textproto</span><span class="op" id="4773799">.</span><span class="ident" id="4773800">MIMEHeader</span><span class="op" id="4773810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4773814">&#34;Content-Range&#34;</span><span class="op" id="4773829">:</span>&nbsp;<span class="op" id="4773831">{</span><span class="ident" id="4773832">r</span><span class="op" id="4773833">.</span><span class="ident" id="4773834">contentRange</span><span class="op" id="4773846">(</span><span class="ident" id="4773847">size</span><span class="op" id="4773851">)</span><span class="op" id="4773852">}</span><span class="op" id="4773853">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4773857">&#34;Content-Type&#34;</span><span class="op" id="4773871">:</span>&nbsp;&nbsp;<span class="op" id="4773874">{</span><span class="ident" id="4773875">contentType</span><span class="op" id="4773886">}</span><span class="op" id="4773887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4773890">}</span><br>
<span class="lineno"></span><span class="op" id="4773892">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="4773895">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="4773955">func</span>&nbsp;<span class="ident" id="4773960">parseRange</span><span class="op" id="4773970">(</span><span class="ident" id="4773971">s</span>&nbsp;<span class="builtintype" id="4773973">string</span><span class="op" id="4773979">,</span>&nbsp;<span class="ident" id="4773981">size</span>&nbsp;<span class="ident" id="4773986">int64</span><span class="op" id="4773991">)</span>&nbsp;<span class="op" id="4773993">(</span><span class="op" id="4773994">[</span><span class="op" id="4773995">]</span><span class="ident" id="4773996">httpRange</span><span class="op" id="4774005">,</span>&nbsp;<span class="builtintype" id="4774007">error</span><span class="op" id="4774012">)</span>&nbsp;<span class="op" id="4774014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774017">if</span>&nbsp;<span class="ident" id="4774020">s</span>&nbsp;<span class="op" id="4774022">==</span>&nbsp;<span class="string" id="4774025">&#34;&#34;</span>&nbsp;<span class="op" id="4774028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774032">return</span>&nbsp;<span class="ident" id="4774039">nil</span><span class="op" id="4774042">,</span>&nbsp;<span class="ident" id="4774044">nil</span>&nbsp;<span class="comment" id="4774048">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774074">const</span>&nbsp;<span class="ident" id="4774080">b</span>&nbsp;<span class="op" id="4774082">=</span>&nbsp;<span class="string" id="4774084">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774094">if</span>&nbsp;<span class="op" id="4774097">!</span><span class="ident" id="4774098">strings</span><span class="op" id="4774105">.</span><span class="ident" id="4774106">HasPrefix</span><span class="op" id="4774115">(</span><span class="ident" id="4774116">s</span><span class="op" id="4774117">,</span>&nbsp;<span class="ident" id="4774119">b</span><span class="op" id="4774120">)</span>&nbsp;<span class="op" id="4774122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774126">return</span>&nbsp;<span class="ident" id="4774133">nil</span><span class="op" id="4774136">,</span>&nbsp;<span class="ident" id="4774138">errors</span><span class="op" id="4774144">.</span><span class="ident" id="4774145">New</span><span class="op" id="4774148">(</span><span class="string" id="4774149">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4774164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774167">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774170">var</span>&nbsp;<span class="ident" id="4774174">ranges</span>&nbsp;<span class="op" id="4774181">[</span><span class="op" id="4774182">]</span><span class="ident" id="4774183">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774194">for</span>&nbsp;<span class="ident" id="4774198">_</span><span class="op" id="4774199">,</span>&nbsp;<span class="ident" id="4774201">ra</span>&nbsp;<span class="op" id="4774204">:=</span>&nbsp;<span class="keyword" id="4774207">range</span>&nbsp;<span class="ident" id="4774213">strings</span><span class="op" id="4774220">.</span><span class="ident" id="4774221">Split</span><span class="op" id="4774226">(</span><span class="ident" id="4774227">s</span><span class="op" id="4774228">[</span><span class="builtinfunc" id="4774229">len</span><span class="op" id="4774232">(</span><span class="ident" id="4774233">b</span><span class="op" id="4774234">)</span><span class="op" id="4774235">:</span><span class="op" id="4774236">]</span><span class="op" id="4774237">,</span>&nbsp;<span class="string" id="4774239">&#34;,&#34;</span><span class="op" id="4774242">)</span>&nbsp;<span class="op" id="4774244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774248">ra</span>&nbsp;<span class="op" id="4774251">=</span>&nbsp;<span class="ident" id="4774253">strings</span><span class="op" id="4774260">.</span><span class="ident" id="4774261">TrimSpace</span><span class="op" id="4774270">(</span><span class="ident" id="4774271">ra</span><span class="op" id="4774273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774277">if</span>&nbsp;<span class="ident" id="4774280">ra</span>&nbsp;<span class="op" id="4774283">==</span>&nbsp;<span class="string" id="4774286">&#34;&#34;</span>&nbsp;<span class="op" id="4774289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774294">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774309">i</span>&nbsp;<span class="op" id="4774311">:=</span>&nbsp;<span class="ident" id="4774314">strings</span><span class="op" id="4774321">.</span><span class="ident" id="4774322">Index</span><span class="op" id="4774327">(</span><span class="ident" id="4774328">ra</span><span class="op" id="4774330">,</span>&nbsp;<span class="string" id="4774332">&#34;-&#34;</span><span class="op" id="4774335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774339">if</span>&nbsp;<span class="ident" id="4774342">i</span>&nbsp;<span class="op" id="4774344">&lt;</span>&nbsp;<span class="num" id="4774346">0</span>&nbsp;<span class="op" id="4774348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774353">return</span>&nbsp;<span class="ident" id="4774360">nil</span><span class="op" id="4774363">,</span>&nbsp;<span class="ident" id="4774365">errors</span><span class="op" id="4774371">.</span><span class="ident" id="4774372">New</span><span class="op" id="4774375">(</span><span class="string" id="4774376">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4774391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774395">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774399">start</span><span class="op" id="4774404">,</span>&nbsp;<span class="ident" id="4774406">end</span>&nbsp;<span class="op" id="4774410">:=</span>&nbsp;<span class="ident" id="4774413">strings</span><span class="op" id="4774420">.</span><span class="ident" id="4774421">TrimSpace</span><span class="op" id="4774430">(</span><span class="ident" id="4774431">ra</span><span class="op" id="4774433">[</span><span class="op" id="4774434">:</span><span class="ident" id="4774435">i</span><span class="op" id="4774436">]</span><span class="op" id="4774437">)</span><span class="op" id="4774438">,</span>&nbsp;<span class="ident" id="4774440">strings</span><span class="op" id="4774447">.</span><span class="ident" id="4774448">TrimSpace</span><span class="op" id="4774457">(</span><span class="ident" id="4774458">ra</span><span class="op" id="4774460">[</span><span class="ident" id="4774461">i</span><span class="op" id="4774462">+</span><span class="num" id="4774463">1</span><span class="op" id="4774464">:</span><span class="op" id="4774465">]</span><span class="op" id="4774466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774470">var</span>&nbsp;<span class="ident" id="4774474">r</span>&nbsp;<span class="ident" id="4774476">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774488">if</span>&nbsp;<span class="ident" id="4774491">start</span>&nbsp;<span class="op" id="4774497">==</span>&nbsp;<span class="string" id="4774500">&#34;&#34;</span>&nbsp;<span class="op" id="4774503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774508">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774558">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774609">i</span><span class="op" id="4774610">,</span>&nbsp;<span class="ident" id="4774612">err</span>&nbsp;<span class="op" id="4774616">:=</span>&nbsp;<span class="ident" id="4774619">strconv</span><span class="op" id="4774626">.</span><span class="ident" id="4774627">ParseInt</span><span class="op" id="4774635">(</span><span class="ident" id="4774636">end</span><span class="op" id="4774639">,</span>&nbsp;<span class="num" id="4774641">10</span><span class="op" id="4774643">,</span>&nbsp;<span class="num" id="4774645">64</span><span class="op" id="4774647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774652">if</span>&nbsp;<span class="ident" id="4774655">err</span>&nbsp;<span class="op" id="4774659">!=</span>&nbsp;<span class="ident" id="4774662">nil</span>&nbsp;<span class="op" id="4774666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774672">return</span>&nbsp;<span class="ident" id="4774679">nil</span><span class="op" id="4774682">,</span>&nbsp;<span class="ident" id="4774684">errors</span><span class="op" id="4774690">.</span><span class="ident" id="4774691">New</span><span class="op" id="4774694">(</span><span class="string" id="4774695">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4774710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774720">if</span>&nbsp;<span class="ident" id="4774723">i</span>&nbsp;<span class="op" id="4774725">&gt;</span>&nbsp;<span class="ident" id="4774727">size</span>&nbsp;<span class="op" id="4774732">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774738">i</span>&nbsp;<span class="op" id="4774740">=</span>&nbsp;<span class="ident" id="4774742">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774755">r</span><span class="op" id="4774756">.</span><span class="ident" id="4774757">start</span>&nbsp;<span class="op" id="4774763">=</span>&nbsp;<span class="ident" id="4774765">size</span>&nbsp;<span class="op" id="4774770">-</span>&nbsp;<span class="ident" id="4774772">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774777">r</span><span class="op" id="4774778">.</span><span class="ident" id="4774779">length</span>&nbsp;<span class="op" id="4774786">=</span>&nbsp;<span class="ident" id="4774788">size</span>&nbsp;<span class="op" id="4774793">-</span>&nbsp;<span class="ident" id="4774795">r</span><span class="op" id="4774796">.</span><span class="ident" id="4774797">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774805">}</span>&nbsp;<span class="keyword" id="4774807">else</span>&nbsp;<span class="op" id="4774812">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774817">i</span><span class="op" id="4774818">,</span>&nbsp;<span class="ident" id="4774820">err</span>&nbsp;<span class="op" id="4774824">:=</span>&nbsp;<span class="ident" id="4774827">strconv</span><span class="op" id="4774834">.</span><span class="ident" id="4774835">ParseInt</span><span class="op" id="4774843">(</span><span class="ident" id="4774844">start</span><span class="op" id="4774849">,</span>&nbsp;<span class="num" id="4774851">10</span><span class="op" id="4774853">,</span>&nbsp;<span class="num" id="4774855">64</span><span class="op" id="4774857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774862">if</span>&nbsp;<span class="ident" id="4774865">err</span>&nbsp;<span class="op" id="4774869">!=</span>&nbsp;<span class="ident" id="4774872">nil</span>&nbsp;<span class="op" id="4774876">||</span>&nbsp;<span class="ident" id="4774879">i</span>&nbsp;<span class="op" id="4774881">&gt;</span>&nbsp;<span class="ident" id="4774883">size</span>&nbsp;<span class="op" id="4774888">||</span>&nbsp;<span class="ident" id="4774891">i</span>&nbsp;<span class="op" id="4774893">&lt;</span>&nbsp;<span class="num" id="4774895">0</span>&nbsp;<span class="op" id="4774897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774903">return</span>&nbsp;<span class="ident" id="4774910">nil</span><span class="op" id="4774913">,</span>&nbsp;<span class="ident" id="4774915">errors</span><span class="op" id="4774921">.</span><span class="ident" id="4774922">New</span><span class="op" id="4774925">(</span><span class="string" id="4774926">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4774941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4774946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4774951">r</span><span class="op" id="4774952">.</span><span class="ident" id="4774953">start</span>&nbsp;<span class="op" id="4774959">=</span>&nbsp;<span class="ident" id="4774961">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4774966">if</span>&nbsp;<span class="ident" id="4774969">end</span>&nbsp;<span class="op" id="4774973">==</span>&nbsp;<span class="string" id="4774976">&#34;&#34;</span>&nbsp;<span class="op" id="4774979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4774985">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775050">r</span><span class="op" id="4775051">.</span><span class="ident" id="4775052">length</span>&nbsp;<span class="op" id="4775059">=</span>&nbsp;<span class="ident" id="4775061">size</span>&nbsp;<span class="op" id="4775066">-</span>&nbsp;<span class="ident" id="4775068">r</span><span class="op" id="4775069">.</span><span class="ident" id="4775070">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775079">}</span>&nbsp;<span class="keyword" id="4775081">else</span>&nbsp;<span class="op" id="4775086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775092">i</span><span class="op" id="4775093">,</span>&nbsp;<span class="ident" id="4775095">err</span>&nbsp;<span class="op" id="4775099">:=</span>&nbsp;<span class="ident" id="4775102">strconv</span><span class="op" id="4775109">.</span><span class="ident" id="4775110">ParseInt</span><span class="op" id="4775118">(</span><span class="ident" id="4775119">end</span><span class="op" id="4775122">,</span>&nbsp;<span class="num" id="4775124">10</span><span class="op" id="4775126">,</span>&nbsp;<span class="num" id="4775128">64</span><span class="op" id="4775130">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775136">if</span>&nbsp;<span class="ident" id="4775139">err</span>&nbsp;<span class="op" id="4775143">!=</span>&nbsp;<span class="ident" id="4775146">nil</span>&nbsp;<span class="op" id="4775150">||</span>&nbsp;<span class="ident" id="4775153">r</span><span class="op" id="4775154">.</span><span class="ident" id="4775155">start</span>&nbsp;<span class="op" id="4775161">&gt;</span>&nbsp;<span class="ident" id="4775163">i</span>&nbsp;<span class="op" id="4775165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775172">return</span>&nbsp;<span class="ident" id="4775179">nil</span><span class="op" id="4775182">,</span>&nbsp;<span class="ident" id="4775184">errors</span><span class="op" id="4775190">.</span><span class="ident" id="4775191">New</span><span class="op" id="4775194">(</span><span class="string" id="4775195">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4775210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775222">if</span>&nbsp;<span class="ident" id="4775225">i</span>&nbsp;<span class="op" id="4775227">&gt;=</span>&nbsp;<span class="ident" id="4775230">size</span>&nbsp;<span class="op" id="4775235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775242">i</span>&nbsp;<span class="op" id="4775244">=</span>&nbsp;<span class="ident" id="4775246">size</span>&nbsp;<span class="op" id="4775251">-</span>&nbsp;<span class="num" id="4775253">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775265">r</span><span class="op" id="4775266">.</span><span class="ident" id="4775267">length</span>&nbsp;<span class="op" id="4775274">=</span>&nbsp;<span class="ident" id="4775276">i</span>&nbsp;<span class="op" id="4775278">-</span>&nbsp;<span class="ident" id="4775280">r</span><span class="op" id="4775281">.</span><span class="ident" id="4775282">start</span>&nbsp;<span class="op" id="4775288">+</span>&nbsp;<span class="num" id="4775290">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775303">ranges</span>&nbsp;<span class="op" id="4775310">=</span>&nbsp;<span class="builtinfunc" id="4775312">append</span><span class="op" id="4775318">(</span><span class="ident" id="4775319">ranges</span><span class="op" id="4775325">,</span>&nbsp;<span class="ident" id="4775327">r</span><span class="op" id="4775328">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775334">return</span>&nbsp;<span class="ident" id="4775341">ranges</span><span class="op" id="4775347">,</span>&nbsp;<span class="ident" id="4775349">nil</span><br>
<span class="lineno"></span><span class="op" id="4775353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4775356">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="4775421">type</span>&nbsp;<span class="ident" id="4775426">countingWriter</span>&nbsp;<span class="ident" id="4775441">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775448">func</span>&nbsp;<span class="op" id="4775453">(</span><span class="ident" id="4775454">w</span>&nbsp;<span class="op" id="4775456">*</span><span class="ident" id="4775457">countingWriter</span><span class="op" id="4775471">)</span>&nbsp;<span class="ident" id="4775473">Write</span><span class="op" id="4775478">(</span><span class="ident" id="4775479">p</span>&nbsp;<span class="op" id="4775481">[</span><span class="op" id="4775482">]</span><span class="builtintype" id="4775483">byte</span><span class="op" id="4775487">)</span>&nbsp;<span class="op" id="4775489">(</span><span class="ident" id="4775490">n</span>&nbsp;<span class="builtintype" id="4775492">int</span><span class="op" id="4775495">,</span>&nbsp;<span class="ident" id="4775497">err</span>&nbsp;<span class="builtintype" id="4775501">error</span><span class="op" id="4775506">)</span>&nbsp;<span class="op" id="4775508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775511">*</span><span class="ident" id="4775512">w</span>&nbsp;<span class="op" id="4775514">+=</span>&nbsp;<span class="ident" id="4775517">countingWriter</span><span class="op" id="4775531">(</span><span class="builtinfunc" id="4775532">len</span><span class="op" id="4775535">(</span><span class="ident" id="4775536">p</span><span class="op" id="4775537">)</span><span class="op" id="4775538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775541">return</span>&nbsp;<span class="builtinfunc" id="4775548">len</span><span class="op" id="4775551">(</span><span class="ident" id="4775552">p</span><span class="op" id="4775553">)</span><span class="op" id="4775554">,</span>&nbsp;<span class="ident" id="4775556">nil</span><br>
<span class="lineno">535</span><span class="op" id="4775560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4775563">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4775632">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4775676">func</span>&nbsp;<span class="ident" id="4775681">rangesMIMESize</span><span class="op" id="4775695">(</span><span class="ident" id="4775696">ranges</span>&nbsp;<span class="op" id="4775703">[</span><span class="op" id="4775704">]</span><span class="ident" id="4775705">httpRange</span><span class="op" id="4775714">,</span>&nbsp;<span class="ident" id="4775716">contentType</span>&nbsp;<span class="builtintype" id="4775728">string</span><span class="op" id="4775734">,</span>&nbsp;<span class="ident" id="4775736">contentSize</span>&nbsp;<span class="ident" id="4775748">int64</span><span class="op" id="4775753">)</span>&nbsp;<span class="op" id="4775755">(</span><span class="ident" id="4775756">encSize</span>&nbsp;<span class="ident" id="4775764">int64</span><span class="op" id="4775769">)</span>&nbsp;<span class="op" id="4775771">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775774">var</span>&nbsp;<span class="ident" id="4775778">w</span>&nbsp;<span class="ident" id="4775780">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775796">mw</span>&nbsp;<span class="op" id="4775799">:=</span>&nbsp;<span class="ident" id="4775802">multipart</span><span class="op" id="4775811">.</span><span class="ident" id="4775812">NewWriter</span><span class="op" id="4775821">(</span><span class="op" id="4775822">&amp;</span><span class="ident" id="4775823">w</span><span class="op" id="4775824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775827">for</span>&nbsp;<span class="ident" id="4775831">_</span><span class="op" id="4775832">,</span>&nbsp;<span class="ident" id="4775834">ra</span>&nbsp;<span class="op" id="4775837">:=</span>&nbsp;<span class="keyword" id="4775840">range</span>&nbsp;<span class="ident" id="4775846">ranges</span>&nbsp;<span class="op" id="4775853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775857">mw</span><span class="op" id="4775859">.</span><span class="ident" id="4775860">CreatePart</span><span class="op" id="4775870">(</span><span class="ident" id="4775871">ra</span><span class="op" id="4775873">.</span><span class="ident" id="4775874">mimeHeader</span><span class="op" id="4775884">(</span><span class="ident" id="4775885">contentType</span><span class="op" id="4775896">,</span>&nbsp;<span class="ident" id="4775898">contentSize</span><span class="op" id="4775909">)</span><span class="op" id="4775910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775914">encSize</span>&nbsp;<span class="op" id="4775922">+=</span>&nbsp;<span class="ident" id="4775925">ra</span><span class="op" id="4775927">.</span><span class="ident" id="4775928">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4775936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775939">mw</span><span class="op" id="4775941">.</span><span class="ident" id="4775942">Close</span><span class="op" id="4775947">(</span><span class="op" id="4775948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4775951">encSize</span>&nbsp;<span class="op" id="4775959">+=</span>&nbsp;<span class="ident" id="4775962">int64</span><span class="op" id="4775967">(</span><span class="ident" id="4775968">w</span><span class="op" id="4775969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4775972">return</span><br>
<span class="lineno"></span><span class="op" id="4775979">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="4775982">func</span>&nbsp;<span class="ident" id="4775987">sumRangesSize</span><span class="op" id="4776000">(</span><span class="ident" id="4776001">ranges</span>&nbsp;<span class="op" id="4776008">[</span><span class="op" id="4776009">]</span><span class="ident" id="4776010">httpRange</span><span class="op" id="4776019">)</span>&nbsp;<span class="op" id="4776021">(</span><span class="ident" id="4776022">size</span>&nbsp;<span class="ident" id="4776027">int64</span><span class="op" id="4776032">)</span>&nbsp;<span class="op" id="4776034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776037">for</span>&nbsp;<span class="ident" id="4776041">_</span><span class="op" id="4776042">,</span>&nbsp;<span class="ident" id="4776044">ra</span>&nbsp;<span class="op" id="4776047">:=</span>&nbsp;<span class="keyword" id="4776050">range</span>&nbsp;<span class="ident" id="4776056">ranges</span>&nbsp;<span class="op" id="4776063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4776067">size</span>&nbsp;<span class="op" id="4776072">+=</span>&nbsp;<span class="ident" id="4776075">ra</span><span class="op" id="4776077">.</span><span class="ident" id="4776078">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4776086">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4776089">return</span><br>
<span class="lineno"></span><span class="op" id="4776096">}</span>
</div>
</body>
</html>
