<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2955361">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2955416">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2955470">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2955521">package</span>&nbsp;<span class="ident" id="2955529">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2955538">import</span>&nbsp;<span class="string" id="2955545">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2955551">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2955609">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2955666">type</span>&nbsp;<span class="ident" id="2955671">Replacer</span>&nbsp;<span class="keyword" id="2955680">struct</span>&nbsp;<span class="op" id="2955687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2955690">r</span>&nbsp;<span class="ident" id="2955692">replacer</span><br>
<span class="lineno"></span><span class="op" id="2955701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2955704">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2955782">type</span>&nbsp;<span class="ident" id="2955787">replacer</span>&nbsp;<span class="keyword" id="2955796">interface</span>&nbsp;<span class="op" id="2955806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2955809">Replace</span><span class="op" id="2955816">(</span><span class="ident" id="2955817">s</span>&nbsp;<span class="builtintype" id="2955819">string</span><span class="op" id="2955825">)</span>&nbsp;<span class="builtintype" id="2955827">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2955835">WriteString</span><span class="op" id="2955846">(</span><span class="ident" id="2955847">w</span>&nbsp;<span class="ident" id="2955849">io</span><span class="op" id="2955851">.</span><span class="ident" id="2955852">Writer</span><span class="op" id="2955858">,</span>&nbsp;<span class="ident" id="2955860">s</span>&nbsp;<span class="builtintype" id="2955862">string</span><span class="op" id="2955868">)</span>&nbsp;<span class="op" id="2955870">(</span><span class="ident" id="2955871">n</span>&nbsp;<span class="builtintype" id="2955873">int</span><span class="op" id="2955876">,</span>&nbsp;<span class="ident" id="2955878">err</span>&nbsp;<span class="builtintype" id="2955882">error</span><span class="op" id="2955887">)</span><br>
<span class="lineno"></span><span class="op" id="2955889">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2955892">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2955968">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2956037">func</span>&nbsp;<span class="ident" id="2956042">NewReplacer</span><span class="op" id="2956053">(</span><span class="ident" id="2956054">oldnew</span>&nbsp;<span class="op" id="2956061">...</span><span class="builtintype" id="2956064">string</span><span class="op" id="2956070">)</span>&nbsp;<span class="op" id="2956072">*</span><span class="ident" id="2956073">Replacer</span>&nbsp;<span class="op" id="2956082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956085">if</span>&nbsp;<span class="builtinfunc" id="2956088">len</span><span class="op" id="2956091">(</span><span class="ident" id="2956092">oldnew</span><span class="op" id="2956098">)</span><span class="op" id="2956099">%</span><span class="num" id="2956100">2</span>&nbsp;<span class="op" id="2956102">==</span>&nbsp;<span class="num" id="2956105">1</span>&nbsp;<span class="op" id="2956107">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2956111">panic</span><span class="op" id="2956116">(</span><span class="string" id="2956117">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2956158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956165">if</span>&nbsp;<span class="builtinfunc" id="2956168">len</span><span class="op" id="2956171">(</span><span class="ident" id="2956172">oldnew</span><span class="op" id="2956178">)</span>&nbsp;<span class="op" id="2956180">==</span>&nbsp;<span class="num" id="2956183">2</span>&nbsp;<span class="op" id="2956185">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2956188">len</span><span class="op" id="2956191">(</span><span class="ident" id="2956192">oldnew</span><span class="op" id="2956198">[</span><span class="num" id="2956199">0</span><span class="op" id="2956200">]</span><span class="op" id="2956201">)</span>&nbsp;<span class="op" id="2956203">&gt;</span>&nbsp;<span class="num" id="2956205">1</span>&nbsp;<span class="op" id="2956207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956211">return</span>&nbsp;<span class="op" id="2956218">&amp;</span><span class="ident" id="2956219">Replacer</span><span class="op" id="2956227">{</span><span class="ident" id="2956228">r</span><span class="op" id="2956229">:</span>&nbsp;<span class="ident" id="2956231">makeSingleStringReplacer</span><span class="op" id="2956255">(</span><span class="ident" id="2956256">oldnew</span><span class="op" id="2956262">[</span><span class="num" id="2956263">0</span><span class="op" id="2956264">]</span><span class="op" id="2956265">,</span>&nbsp;<span class="ident" id="2956267">oldnew</span><span class="op" id="2956273">[</span><span class="num" id="2956274">1</span><span class="op" id="2956275">]</span><span class="op" id="2956276">)</span><span class="op" id="2956277">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956284">allNewBytes</span>&nbsp;<span class="op" id="2956296">:=</span>&nbsp;<span class="builtintype" id="2956299">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956305">for</span>&nbsp;<span class="ident" id="2956309">i</span>&nbsp;<span class="op" id="2956311">:=</span>&nbsp;<span class="num" id="2956314">0</span><span class="op" id="2956315">;</span>&nbsp;<span class="ident" id="2956317">i</span>&nbsp;<span class="op" id="2956319">&lt;</span>&nbsp;<span class="builtinfunc" id="2956321">len</span><span class="op" id="2956324">(</span><span class="ident" id="2956325">oldnew</span><span class="op" id="2956331">)</span><span class="op" id="2956332">;</span>&nbsp;<span class="ident" id="2956334">i</span>&nbsp;<span class="op" id="2956336">+=</span>&nbsp;<span class="num" id="2956339">2</span>&nbsp;<span class="op" id="2956341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956345">if</span>&nbsp;<span class="builtinfunc" id="2956348">len</span><span class="op" id="2956351">(</span><span class="ident" id="2956352">oldnew</span><span class="op" id="2956358">[</span><span class="ident" id="2956359">i</span><span class="op" id="2956360">]</span><span class="op" id="2956361">)</span>&nbsp;<span class="op" id="2956363">!=</span>&nbsp;<span class="num" id="2956366">1</span>&nbsp;<span class="op" id="2956368">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956373">return</span>&nbsp;<span class="op" id="2956380">&amp;</span><span class="ident" id="2956381">Replacer</span><span class="op" id="2956389">{</span><span class="ident" id="2956390">r</span><span class="op" id="2956391">:</span>&nbsp;<span class="ident" id="2956393">makeGenericReplacer</span><span class="op" id="2956412">(</span><span class="ident" id="2956413">oldnew</span><span class="op" id="2956419">)</span><span class="op" id="2956420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956428">if</span>&nbsp;<span class="builtinfunc" id="2956431">len</span><span class="op" id="2956434">(</span><span class="ident" id="2956435">oldnew</span><span class="op" id="2956441">[</span><span class="ident" id="2956442">i</span><span class="op" id="2956443">+</span><span class="num" id="2956444">1</span><span class="op" id="2956445">]</span><span class="op" id="2956446">)</span>&nbsp;<span class="op" id="2956448">!=</span>&nbsp;<span class="num" id="2956451">1</span>&nbsp;<span class="op" id="2956453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956458">allNewBytes</span>&nbsp;<span class="op" id="2956470">=</span>&nbsp;<span class="builtintype" id="2956472">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956480">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956487">if</span>&nbsp;<span class="ident" id="2956490">allNewBytes</span>&nbsp;<span class="op" id="2956502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956506">r</span>&nbsp;<span class="op" id="2956508">:=</span>&nbsp;<span class="ident" id="2956511">byteReplacer</span><span class="op" id="2956523">{</span><span class="op" id="2956524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956528">for</span>&nbsp;<span class="ident" id="2956532">i</span>&nbsp;<span class="op" id="2956534">:=</span>&nbsp;<span class="keyword" id="2956537">range</span>&nbsp;<span class="ident" id="2956543">r</span>&nbsp;<span class="op" id="2956545">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956550">r</span><span class="op" id="2956551">[</span><span class="ident" id="2956552">i</span><span class="op" id="2956553">]</span>&nbsp;<span class="op" id="2956555">=</span>&nbsp;<span class="builtintype" id="2956557">byte</span><span class="op" id="2956561">(</span><span class="ident" id="2956562">i</span><span class="op" id="2956563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2956571">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2956630">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956677">for</span>&nbsp;<span class="ident" id="2956681">i</span>&nbsp;<span class="op" id="2956683">:=</span>&nbsp;<span class="builtinfunc" id="2956686">len</span><span class="op" id="2956689">(</span><span class="ident" id="2956690">oldnew</span><span class="op" id="2956696">)</span>&nbsp;<span class="op" id="2956698">-</span>&nbsp;<span class="num" id="2956700">2</span><span class="op" id="2956701">;</span>&nbsp;<span class="ident" id="2956703">i</span>&nbsp;<span class="op" id="2956705">&gt;=</span>&nbsp;<span class="num" id="2956708">0</span><span class="op" id="2956709">;</span>&nbsp;<span class="ident" id="2956711">i</span>&nbsp;<span class="op" id="2956713">-=</span>&nbsp;<span class="num" id="2956716">2</span>&nbsp;<span class="op" id="2956718">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956723">o</span>&nbsp;<span class="op" id="2956725">:=</span>&nbsp;<span class="ident" id="2956728">oldnew</span><span class="op" id="2956734">[</span><span class="ident" id="2956735">i</span><span class="op" id="2956736">]</span><span class="op" id="2956737">[</span><span class="num" id="2956738">0</span><span class="op" id="2956739">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956744">n</span>&nbsp;<span class="op" id="2956746">:=</span>&nbsp;<span class="ident" id="2956749">oldnew</span><span class="op" id="2956755">[</span><span class="ident" id="2956756">i</span><span class="op" id="2956757">+</span><span class="num" id="2956758">1</span><span class="op" id="2956759">]</span><span class="op" id="2956760">[</span><span class="num" id="2956761">0</span><span class="op" id="2956762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956767">r</span><span class="op" id="2956768">[</span><span class="ident" id="2956769">o</span><span class="op" id="2956770">]</span>&nbsp;<span class="op" id="2956772">=</span>&nbsp;<span class="ident" id="2956774">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956782">return</span>&nbsp;<span class="op" id="2956789">&amp;</span><span class="ident" id="2956790">Replacer</span><span class="op" id="2956798">{</span><span class="ident" id="2956799">r</span><span class="op" id="2956800">:</span>&nbsp;<span class="op" id="2956802">&amp;</span><span class="ident" id="2956803">r</span><span class="op" id="2956804">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2956807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956811">r</span>&nbsp;<span class="op" id="2956813">:=</span>&nbsp;<span class="ident" id="2956816">byteStringReplacer</span><span class="op" id="2956834">{</span><span class="op" id="2956835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2956838">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2956896">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2956942">for</span>&nbsp;<span class="ident" id="2956946">i</span>&nbsp;<span class="op" id="2956948">:=</span>&nbsp;<span class="builtinfunc" id="2956951">len</span><span class="op" id="2956954">(</span><span class="ident" id="2956955">oldnew</span><span class="op" id="2956961">)</span>&nbsp;<span class="op" id="2956963">-</span>&nbsp;<span class="num" id="2956965">2</span><span class="op" id="2956966">;</span>&nbsp;<span class="ident" id="2956968">i</span>&nbsp;<span class="op" id="2956970">&gt;=</span>&nbsp;<span class="num" id="2956973">0</span><span class="op" id="2956974">;</span>&nbsp;<span class="ident" id="2956976">i</span>&nbsp;<span class="op" id="2956978">-=</span>&nbsp;<span class="num" id="2956981">2</span>&nbsp;<span class="op" id="2956983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2956987">o</span>&nbsp;<span class="op" id="2956989">:=</span>&nbsp;<span class="ident" id="2956992">oldnew</span><span class="op" id="2956998">[</span><span class="ident" id="2956999">i</span><span class="op" id="2957000">]</span><span class="op" id="2957001">[</span><span class="num" id="2957002">0</span><span class="op" id="2957003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2957007">n</span>&nbsp;<span class="op" id="2957009">:=</span>&nbsp;<span class="ident" id="2957012">oldnew</span><span class="op" id="2957018">[</span><span class="ident" id="2957019">i</span><span class="op" id="2957020">+</span><span class="num" id="2957021">1</span><span class="op" id="2957022">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2957026">r</span><span class="op" id="2957027">[</span><span class="ident" id="2957028">o</span><span class="op" id="2957029">]</span>&nbsp;<span class="op" id="2957031">=</span>&nbsp;<span class="op" id="2957033">[</span><span class="op" id="2957034">]</span><span class="builtintype" id="2957035">byte</span><span class="op" id="2957039">(</span><span class="ident" id="2957040">n</span><span class="op" id="2957041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2957044">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2957047">return</span>&nbsp;<span class="op" id="2957054">&amp;</span><span class="ident" id="2957055">Replacer</span><span class="op" id="2957063">{</span><span class="ident" id="2957064">r</span><span class="op" id="2957065">:</span>&nbsp;<span class="op" id="2957067">&amp;</span><span class="ident" id="2957068">r</span><span class="op" id="2957069">}</span><br>
<span class="lineno"></span><span class="op" id="2957071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2957074">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2957138">func</span>&nbsp;<span class="op" id="2957143">(</span><span class="ident" id="2957144">r</span>&nbsp;<span class="op" id="2957146">*</span><span class="ident" id="2957147">Replacer</span><span class="op" id="2957155">)</span>&nbsp;<span class="ident" id="2957157">Replace</span><span class="op" id="2957164">(</span><span class="ident" id="2957165">s</span>&nbsp;<span class="builtintype" id="2957167">string</span><span class="op" id="2957173">)</span>&nbsp;<span class="builtintype" id="2957175">string</span>&nbsp;<span class="op" id="2957182">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2957185">return</span>&nbsp;<span class="ident" id="2957192">r</span><span class="op" id="2957193">.</span><span class="ident" id="2957194">r</span><span class="op" id="2957195">.</span><span class="ident" id="2957196">Replace</span><span class="op" id="2957203">(</span><span class="ident" id="2957204">s</span><span class="op" id="2957205">)</span><br>
<span class="lineno"></span><span class="op" id="2957207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2957210">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2957272">func</span>&nbsp;<span class="op" id="2957277">(</span><span class="ident" id="2957278">r</span>&nbsp;<span class="op" id="2957280">*</span><span class="ident" id="2957281">Replacer</span><span class="op" id="2957289">)</span>&nbsp;<span class="ident" id="2957291">WriteString</span><span class="op" id="2957302">(</span><span class="ident" id="2957303">w</span>&nbsp;<span class="ident" id="2957305">io</span><span class="op" id="2957307">.</span><span class="ident" id="2957308">Writer</span><span class="op" id="2957314">,</span>&nbsp;<span class="ident" id="2957316">s</span>&nbsp;<span class="builtintype" id="2957318">string</span><span class="op" id="2957324">)</span>&nbsp;<span class="op" id="2957326">(</span><span class="ident" id="2957327">n</span>&nbsp;<span class="builtintype" id="2957329">int</span><span class="op" id="2957332">,</span>&nbsp;<span class="ident" id="2957334">err</span>&nbsp;<span class="builtintype" id="2957338">error</span><span class="op" id="2957343">)</span>&nbsp;<span class="op" id="2957345">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2957348">return</span>&nbsp;<span class="ident" id="2957355">r</span><span class="op" id="2957356">.</span><span class="ident" id="2957357">r</span><span class="op" id="2957358">.</span><span class="ident" id="2957359">WriteString</span><span class="op" id="2957370">(</span><span class="ident" id="2957371">w</span><span class="op" id="2957372">,</span>&nbsp;<span class="ident" id="2957374">s</span><span class="op" id="2957375">)</span><br>
<span class="lineno"></span><span class="op" id="2957377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2957380">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2957457">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2957535">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2957583">//</span><br>
<span class="lineno"></span><span class="comment" id="2957586">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2957596">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2957607">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2957619">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2957631">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2957642">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2957656">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2957667">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2957679">//</span><br>
<span class="lineno"></span><span class="comment" id="2957682">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2957760">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2957838">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2957912">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2957963">type</span>&nbsp;<span class="ident" id="2957968">trieNode</span>&nbsp;<span class="keyword" id="2957977">struct</span>&nbsp;<span class="op" id="2957984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2957987">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958060">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2958097">value</span>&nbsp;<span class="builtintype" id="2958103">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958111">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958186">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958261">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958334">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958407">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2958439">priority</span>&nbsp;<span class="builtintype" id="2958448">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958454">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958510">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958574">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958642">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958700">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958704">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958776">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958834">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958908">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2958985">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959060">prefix</span>&nbsp;<span class="builtintype" id="2959067">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959075">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2959082">*</span><span class="ident" id="2959083">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959094">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959165">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959239">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959313">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959387">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959452">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959527">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959549">table</span>&nbsp;<span class="op" id="2959555">[</span><span class="op" id="2959556">]</span><span class="op" id="2959557">*</span><span class="ident" id="2959558">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2959567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2959570">func</span>&nbsp;<span class="op" id="2959575">(</span><span class="ident" id="2959576">t</span>&nbsp;<span class="op" id="2959578">*</span><span class="ident" id="2959579">trieNode</span><span class="op" id="2959587">)</span>&nbsp;<span class="ident" id="2959589">add</span><span class="op" id="2959592">(</span><span class="ident" id="2959593">key</span><span class="op" id="2959596">,</span>&nbsp;<span class="ident" id="2959598">val</span>&nbsp;<span class="builtintype" id="2959602">string</span><span class="op" id="2959608">,</span>&nbsp;<span class="ident" id="2959610">priority</span>&nbsp;<span class="builtintype" id="2959619">int</span><span class="op" id="2959622">,</span>&nbsp;<span class="ident" id="2959624">r</span>&nbsp;<span class="op" id="2959626">*</span><span class="ident" id="2959627">genericReplacer</span><span class="op" id="2959642">)</span>&nbsp;<span class="op" id="2959644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959647">if</span>&nbsp;<span class="ident" id="2959650">key</span>&nbsp;<span class="op" id="2959654">==</span>&nbsp;<span class="string" id="2959657">&#34;&#34;</span>&nbsp;<span class="op" id="2959660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959664">if</span>&nbsp;<span class="ident" id="2959667">t</span><span class="op" id="2959668">.</span><span class="ident" id="2959669">priority</span>&nbsp;<span class="op" id="2959678">==</span>&nbsp;<span class="num" id="2959681">0</span>&nbsp;<span class="op" id="2959683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959688">t</span><span class="op" id="2959689">.</span><span class="ident" id="2959690">value</span>&nbsp;<span class="op" id="2959696">=</span>&nbsp;<span class="ident" id="2959698">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959705">t</span><span class="op" id="2959706">.</span><span class="ident" id="2959707">priority</span>&nbsp;<span class="op" id="2959716">=</span>&nbsp;<span class="ident" id="2959718">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2959729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959733">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2959741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959745">if</span>&nbsp;<span class="ident" id="2959748">t</span><span class="op" id="2959749">.</span><span class="ident" id="2959750">prefix</span>&nbsp;<span class="op" id="2959757">!=</span>&nbsp;<span class="string" id="2959760">&#34;&#34;</span>&nbsp;<span class="op" id="2959763">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2959767">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959819">var</span>&nbsp;<span class="ident" id="2959823">n</span>&nbsp;<span class="builtintype" id="2959825">int</span>&nbsp;<span class="comment" id="2959829">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959870">for</span>&nbsp;<span class="op" id="2959874">;</span>&nbsp;<span class="ident" id="2959876">n</span>&nbsp;<span class="op" id="2959878">&lt;</span>&nbsp;<span class="builtinfunc" id="2959880">len</span><span class="op" id="2959883">(</span><span class="ident" id="2959884">t</span><span class="op" id="2959885">.</span><span class="ident" id="2959886">prefix</span><span class="op" id="2959892">)</span>&nbsp;<span class="op" id="2959894">&amp;&amp;</span>&nbsp;<span class="ident" id="2959897">n</span>&nbsp;<span class="op" id="2959899">&lt;</span>&nbsp;<span class="builtinfunc" id="2959901">len</span><span class="op" id="2959904">(</span><span class="ident" id="2959905">key</span><span class="op" id="2959908">)</span><span class="op" id="2959909">;</span>&nbsp;<span class="ident" id="2959911">n</span><span class="op" id="2959912">++</span>&nbsp;<span class="op" id="2959915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959920">if</span>&nbsp;<span class="ident" id="2959923">t</span><span class="op" id="2959924">.</span><span class="ident" id="2959925">prefix</span><span class="op" id="2959931">[</span><span class="ident" id="2959932">n</span><span class="op" id="2959933">]</span>&nbsp;<span class="op" id="2959935">!=</span>&nbsp;<span class="ident" id="2959938">key</span><span class="op" id="2959941">[</span><span class="ident" id="2959942">n</span><span class="op" id="2959943">]</span>&nbsp;<span class="op" id="2959945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959951">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2959960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2959964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2959968">if</span>&nbsp;<span class="ident" id="2959971">n</span>&nbsp;<span class="op" id="2959973">==</span>&nbsp;<span class="builtinfunc" id="2959976">len</span><span class="op" id="2959979">(</span><span class="ident" id="2959980">t</span><span class="op" id="2959981">.</span><span class="ident" id="2959982">prefix</span><span class="op" id="2959988">)</span>&nbsp;<span class="op" id="2959990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2959995">t</span><span class="op" id="2959996">.</span><span class="ident" id="2959997">next</span><span class="op" id="2960001">.</span><span class="ident" id="2960002">add</span><span class="op" id="2960005">(</span><span class="ident" id="2960006">key</span><span class="op" id="2960009">[</span><span class="ident" id="2960010">n</span><span class="op" id="2960011">:</span><span class="op" id="2960012">]</span><span class="op" id="2960013">,</span>&nbsp;<span class="ident" id="2960015">val</span><span class="op" id="2960018">,</span>&nbsp;<span class="ident" id="2960020">priority</span><span class="op" id="2960028">,</span>&nbsp;<span class="ident" id="2960030">r</span><span class="op" id="2960031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960035">}</span>&nbsp;<span class="keyword" id="2960037">else</span>&nbsp;<span class="keyword" id="2960042">if</span>&nbsp;<span class="ident" id="2960045">n</span>&nbsp;<span class="op" id="2960047">==</span>&nbsp;<span class="num" id="2960050">0</span>&nbsp;<span class="op" id="2960052">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2960057">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2960125">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2960190">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960236">var</span>&nbsp;<span class="ident" id="2960240">prefixNode</span>&nbsp;<span class="op" id="2960251">*</span><span class="ident" id="2960252">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960264">if</span>&nbsp;<span class="builtinfunc" id="2960267">len</span><span class="op" id="2960270">(</span><span class="ident" id="2960271">t</span><span class="op" id="2960272">.</span><span class="ident" id="2960273">prefix</span><span class="op" id="2960279">)</span>&nbsp;<span class="op" id="2960281">==</span>&nbsp;<span class="num" id="2960284">1</span>&nbsp;<span class="op" id="2960286">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960292">prefixNode</span>&nbsp;<span class="op" id="2960303">=</span>&nbsp;<span class="ident" id="2960305">t</span><span class="op" id="2960306">.</span><span class="ident" id="2960307">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960315">}</span>&nbsp;<span class="keyword" id="2960317">else</span>&nbsp;<span class="op" id="2960322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960328">prefixNode</span>&nbsp;<span class="op" id="2960339">=</span>&nbsp;<span class="op" id="2960341">&amp;</span><span class="ident" id="2960342">trieNode</span><span class="op" id="2960350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960357">prefix</span><span class="op" id="2960363">:</span>&nbsp;<span class="ident" id="2960365">t</span><span class="op" id="2960366">.</span><span class="ident" id="2960367">prefix</span><span class="op" id="2960373">[</span><span class="num" id="2960374">1</span><span class="op" id="2960375">:</span><span class="op" id="2960376">]</span><span class="op" id="2960377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960384">next</span><span class="op" id="2960388">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2960392">t</span><span class="op" id="2960393">.</span><span class="ident" id="2960394">next</span><span class="op" id="2960398">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960414">keyNode</span>&nbsp;<span class="op" id="2960422">:=</span>&nbsp;<span class="builtinfunc" id="2960425">new</span><span class="op" id="2960428">(</span><span class="ident" id="2960429">trieNode</span><span class="op" id="2960437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960442">t</span><span class="op" id="2960443">.</span><span class="ident" id="2960444">table</span>&nbsp;<span class="op" id="2960450">=</span>&nbsp;<span class="builtinfunc" id="2960452">make</span><span class="op" id="2960456">(</span><span class="op" id="2960457">[</span><span class="op" id="2960458">]</span><span class="op" id="2960459">*</span><span class="ident" id="2960460">trieNode</span><span class="op" id="2960468">,</span>&nbsp;<span class="ident" id="2960470">r</span><span class="op" id="2960471">.</span><span class="ident" id="2960472">tableSize</span><span class="op" id="2960481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960486">t</span><span class="op" id="2960487">.</span><span class="ident" id="2960488">table</span><span class="op" id="2960493">[</span><span class="ident" id="2960494">r</span><span class="op" id="2960495">.</span><span class="ident" id="2960496">mapping</span><span class="op" id="2960503">[</span><span class="ident" id="2960504">t</span><span class="op" id="2960505">.</span><span class="ident" id="2960506">prefix</span><span class="op" id="2960512">[</span><span class="num" id="2960513">0</span><span class="op" id="2960514">]</span><span class="op" id="2960515">]</span><span class="op" id="2960516">]</span>&nbsp;<span class="op" id="2960518">=</span>&nbsp;<span class="ident" id="2960520">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960534">t</span><span class="op" id="2960535">.</span><span class="ident" id="2960536">table</span><span class="op" id="2960541">[</span><span class="ident" id="2960542">r</span><span class="op" id="2960543">.</span><span class="ident" id="2960544">mapping</span><span class="op" id="2960551">[</span><span class="ident" id="2960552">key</span><span class="op" id="2960555">[</span><span class="num" id="2960556">0</span><span class="op" id="2960557">]</span><span class="op" id="2960558">]</span><span class="op" id="2960559">]</span>&nbsp;<span class="op" id="2960561">=</span>&nbsp;<span class="ident" id="2960563">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960574">t</span><span class="op" id="2960575">.</span><span class="ident" id="2960576">prefix</span>&nbsp;<span class="op" id="2960583">=</span>&nbsp;<span class="string" id="2960585">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960591">t</span><span class="op" id="2960592">.</span><span class="ident" id="2960593">next</span>&nbsp;<span class="op" id="2960598">=</span>&nbsp;<span class="ident" id="2960600">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960607">keyNode</span><span class="op" id="2960614">.</span><span class="ident" id="2960615">add</span><span class="op" id="2960618">(</span><span class="ident" id="2960619">key</span><span class="op" id="2960622">[</span><span class="num" id="2960623">1</span><span class="op" id="2960624">:</span><span class="op" id="2960625">]</span><span class="op" id="2960626">,</span>&nbsp;<span class="ident" id="2960628">val</span><span class="op" id="2960631">,</span>&nbsp;<span class="ident" id="2960633">priority</span><span class="op" id="2960641">,</span>&nbsp;<span class="ident" id="2960643">r</span><span class="op" id="2960644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960648">}</span>&nbsp;<span class="keyword" id="2960650">else</span>&nbsp;<span class="op" id="2960655">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2960660">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960722">next</span>&nbsp;<span class="op" id="2960727">:=</span>&nbsp;<span class="op" id="2960730">&amp;</span><span class="ident" id="2960731">trieNode</span><span class="op" id="2960739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960745">prefix</span><span class="op" id="2960751">:</span>&nbsp;<span class="ident" id="2960753">t</span><span class="op" id="2960754">.</span><span class="ident" id="2960755">prefix</span><span class="op" id="2960761">[</span><span class="ident" id="2960762">n</span><span class="op" id="2960763">:</span><span class="op" id="2960764">]</span><span class="op" id="2960765">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960771">next</span><span class="op" id="2960775">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2960779">t</span><span class="op" id="2960780">.</span><span class="ident" id="2960781">next</span><span class="op" id="2960785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960790">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960795">t</span><span class="op" id="2960796">.</span><span class="ident" id="2960797">prefix</span>&nbsp;<span class="op" id="2960804">=</span>&nbsp;<span class="ident" id="2960806">t</span><span class="op" id="2960807">.</span><span class="ident" id="2960808">prefix</span><span class="op" id="2960814">[</span><span class="op" id="2960815">:</span><span class="ident" id="2960816">n</span><span class="op" id="2960817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960822">t</span><span class="op" id="2960823">.</span><span class="ident" id="2960824">next</span>&nbsp;<span class="op" id="2960829">=</span>&nbsp;<span class="ident" id="2960831">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960839">next</span><span class="op" id="2960843">.</span><span class="ident" id="2960844">add</span><span class="op" id="2960847">(</span><span class="ident" id="2960848">key</span><span class="op" id="2960851">[</span><span class="ident" id="2960852">n</span><span class="op" id="2960853">:</span><span class="op" id="2960854">]</span><span class="op" id="2960855">,</span>&nbsp;<span class="ident" id="2960857">val</span><span class="op" id="2960860">,</span>&nbsp;<span class="ident" id="2960862">priority</span><span class="op" id="2960870">,</span>&nbsp;<span class="ident" id="2960872">r</span><span class="op" id="2960873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2960880">}</span>&nbsp;<span class="keyword" id="2960882">else</span>&nbsp;<span class="keyword" id="2960887">if</span>&nbsp;<span class="ident" id="2960890">t</span><span class="op" id="2960891">.</span><span class="ident" id="2960892">table</span>&nbsp;<span class="op" id="2960898">!=</span>&nbsp;<span class="ident" id="2960901">nil</span>&nbsp;<span class="op" id="2960905">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2960909">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960942">m</span>&nbsp;<span class="op" id="2960944">:=</span>&nbsp;<span class="ident" id="2960947">r</span><span class="op" id="2960948">.</span><span class="ident" id="2960949">mapping</span><span class="op" id="2960956">[</span><span class="ident" id="2960957">key</span><span class="op" id="2960960">[</span><span class="num" id="2960961">0</span><span class="op" id="2960962">]</span><span class="op" id="2960963">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2960967">if</span>&nbsp;<span class="ident" id="2960970">t</span><span class="op" id="2960971">.</span><span class="ident" id="2960972">table</span><span class="op" id="2960977">[</span><span class="ident" id="2960978">m</span><span class="op" id="2960979">]</span>&nbsp;<span class="op" id="2960981">==</span>&nbsp;<span class="ident" id="2960984">nil</span>&nbsp;<span class="op" id="2960988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2960993">t</span><span class="op" id="2960994">.</span><span class="ident" id="2960995">table</span><span class="op" id="2961000">[</span><span class="ident" id="2961001">m</span><span class="op" id="2961002">]</span>&nbsp;<span class="op" id="2961004">=</span>&nbsp;<span class="builtinfunc" id="2961006">new</span><span class="op" id="2961009">(</span><span class="ident" id="2961010">trieNode</span><span class="op" id="2961018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961022">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961026">t</span><span class="op" id="2961027">.</span><span class="ident" id="2961028">table</span><span class="op" id="2961033">[</span><span class="ident" id="2961034">m</span><span class="op" id="2961035">]</span><span class="op" id="2961036">.</span><span class="ident" id="2961037">add</span><span class="op" id="2961040">(</span><span class="ident" id="2961041">key</span><span class="op" id="2961044">[</span><span class="num" id="2961045">1</span><span class="op" id="2961046">:</span><span class="op" id="2961047">]</span><span class="op" id="2961048">,</span>&nbsp;<span class="ident" id="2961050">val</span><span class="op" id="2961053">,</span>&nbsp;<span class="ident" id="2961055">priority</span><span class="op" id="2961063">,</span>&nbsp;<span class="ident" id="2961065">r</span><span class="op" id="2961066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961069">}</span>&nbsp;<span class="keyword" id="2961071">else</span>&nbsp;<span class="op" id="2961076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961080">t</span><span class="op" id="2961081">.</span><span class="ident" id="2961082">prefix</span>&nbsp;<span class="op" id="2961089">=</span>&nbsp;<span class="ident" id="2961091">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961097">t</span><span class="op" id="2961098">.</span><span class="ident" id="2961099">next</span>&nbsp;<span class="op" id="2961104">=</span>&nbsp;<span class="builtinfunc" id="2961106">new</span><span class="op" id="2961109">(</span><span class="ident" id="2961110">trieNode</span><span class="op" id="2961118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961122">t</span><span class="op" id="2961123">.</span><span class="ident" id="2961124">next</span><span class="op" id="2961128">.</span><span class="ident" id="2961129">add</span><span class="op" id="2961132">(</span><span class="string" id="2961133">&#34;&#34;</span><span class="op" id="2961135">,</span>&nbsp;<span class="ident" id="2961137">val</span><span class="op" id="2961140">,</span>&nbsp;<span class="ident" id="2961142">priority</span><span class="op" id="2961150">,</span>&nbsp;<span class="ident" id="2961152">r</span><span class="op" id="2961153">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961156">}</span><br>
<span class="lineno"></span><span class="op" id="2961158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2961161">func</span>&nbsp;<span class="op" id="2961166">(</span><span class="ident" id="2961167">r</span>&nbsp;<span class="op" id="2961169">*</span><span class="ident" id="2961170">genericReplacer</span><span class="op" id="2961185">)</span>&nbsp;<span class="ident" id="2961187">lookup</span><span class="op" id="2961193">(</span><span class="ident" id="2961194">s</span>&nbsp;<span class="builtintype" id="2961196">string</span><span class="op" id="2961202">,</span>&nbsp;<span class="ident" id="2961204">ignoreRoot</span>&nbsp;<span class="builtintype" id="2961215">bool</span><span class="op" id="2961219">)</span>&nbsp;<span class="op" id="2961221">(</span><span class="ident" id="2961222">val</span>&nbsp;<span class="builtintype" id="2961226">string</span><span class="op" id="2961232">,</span>&nbsp;<span class="ident" id="2961234">keylen</span>&nbsp;<span class="builtintype" id="2961241">int</span><span class="op" id="2961244">,</span>&nbsp;<span class="ident" id="2961246">found</span>&nbsp;<span class="builtintype" id="2961252">bool</span><span class="op" id="2961256">)</span>&nbsp;<span class="op" id="2961258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961261">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2961334">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961360">bestPriority</span>&nbsp;<span class="op" id="2961373">:=</span>&nbsp;<span class="num" id="2961376">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961379">node</span>&nbsp;<span class="op" id="2961384">:=</span>&nbsp;<span class="op" id="2961387">&amp;</span><span class="ident" id="2961388">r</span><span class="op" id="2961389">.</span><span class="ident" id="2961390">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961396">n</span>&nbsp;<span class="op" id="2961398">:=</span>&nbsp;<span class="num" id="2961401">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961404">for</span>&nbsp;<span class="ident" id="2961408">node</span>&nbsp;<span class="op" id="2961413">!=</span>&nbsp;<span class="ident" id="2961416">nil</span>&nbsp;<span class="op" id="2961420">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961424">if</span>&nbsp;<span class="ident" id="2961427">node</span><span class="op" id="2961431">.</span><span class="ident" id="2961432">priority</span>&nbsp;<span class="op" id="2961441">&gt;</span>&nbsp;<span class="ident" id="2961443">bestPriority</span>&nbsp;<span class="op" id="2961456">&amp;&amp;</span>&nbsp;<span class="op" id="2961459">!</span><span class="op" id="2961460">(</span><span class="ident" id="2961461">ignoreRoot</span>&nbsp;<span class="op" id="2961472">&amp;&amp;</span>&nbsp;<span class="ident" id="2961475">node</span>&nbsp;<span class="op" id="2961480">==</span>&nbsp;<span class="op" id="2961483">&amp;</span><span class="ident" id="2961484">r</span><span class="op" id="2961485">.</span><span class="ident" id="2961486">root</span><span class="op" id="2961490">)</span>&nbsp;<span class="op" id="2961492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961497">bestPriority</span>&nbsp;<span class="op" id="2961510">=</span>&nbsp;<span class="ident" id="2961512">node</span><span class="op" id="2961516">.</span><span class="ident" id="2961517">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961529">val</span>&nbsp;<span class="op" id="2961533">=</span>&nbsp;<span class="ident" id="2961535">node</span><span class="op" id="2961539">.</span><span class="ident" id="2961540">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961549">keylen</span>&nbsp;<span class="op" id="2961556">=</span>&nbsp;<span class="ident" id="2961558">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961563">found</span>&nbsp;<span class="op" id="2961569">=</span>&nbsp;<span class="builtintype" id="2961571">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961583">if</span>&nbsp;<span class="ident" id="2961586">s</span>&nbsp;<span class="op" id="2961588">==</span>&nbsp;<span class="string" id="2961591">&#34;&#34;</span>&nbsp;<span class="op" id="2961594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961599">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961607">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961611">if</span>&nbsp;<span class="ident" id="2961614">node</span><span class="op" id="2961618">.</span><span class="ident" id="2961619">table</span>&nbsp;<span class="op" id="2961625">!=</span>&nbsp;<span class="ident" id="2961628">nil</span>&nbsp;<span class="op" id="2961632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961637">index</span>&nbsp;<span class="op" id="2961643">:=</span>&nbsp;<span class="ident" id="2961646">r</span><span class="op" id="2961647">.</span><span class="ident" id="2961648">mapping</span><span class="op" id="2961655">[</span><span class="ident" id="2961656">s</span><span class="op" id="2961657">[</span><span class="num" id="2961658">0</span><span class="op" id="2961659">]</span><span class="op" id="2961660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961665">if</span>&nbsp;<span class="builtintype" id="2961668">int</span><span class="op" id="2961671">(</span><span class="ident" id="2961672">index</span><span class="op" id="2961677">)</span>&nbsp;<span class="op" id="2961679">==</span>&nbsp;<span class="ident" id="2961682">r</span><span class="op" id="2961683">.</span><span class="ident" id="2961684">tableSize</span>&nbsp;<span class="op" id="2961694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961709">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961714">node</span>&nbsp;<span class="op" id="2961719">=</span>&nbsp;<span class="ident" id="2961721">node</span><span class="op" id="2961725">.</span><span class="ident" id="2961726">table</span><span class="op" id="2961731">[</span><span class="ident" id="2961732">index</span><span class="op" id="2961737">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961742">s</span>&nbsp;<span class="op" id="2961744">=</span>&nbsp;<span class="ident" id="2961746">s</span><span class="op" id="2961747">[</span><span class="num" id="2961748">1</span><span class="op" id="2961749">:</span><span class="op" id="2961750">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961755">n</span><span class="op" id="2961756">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961761">}</span>&nbsp;<span class="keyword" id="2961763">else</span>&nbsp;<span class="keyword" id="2961768">if</span>&nbsp;<span class="ident" id="2961771">node</span><span class="op" id="2961775">.</span><span class="ident" id="2961776">prefix</span>&nbsp;<span class="op" id="2961783">!=</span>&nbsp;<span class="string" id="2961786">&#34;&#34;</span>&nbsp;<span class="op" id="2961789">&amp;&amp;</span>&nbsp;<span class="ident" id="2961792">HasPrefix</span><span class="op" id="2961801">(</span><span class="ident" id="2961802">s</span><span class="op" id="2961803">,</span>&nbsp;<span class="ident" id="2961805">node</span><span class="op" id="2961809">.</span><span class="ident" id="2961810">prefix</span><span class="op" id="2961816">)</span>&nbsp;<span class="op" id="2961818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961823">n</span>&nbsp;<span class="op" id="2961825">+=</span>&nbsp;<span class="builtinfunc" id="2961828">len</span><span class="op" id="2961831">(</span><span class="ident" id="2961832">node</span><span class="op" id="2961836">.</span><span class="ident" id="2961837">prefix</span><span class="op" id="2961843">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961848">s</span>&nbsp;<span class="op" id="2961850">=</span>&nbsp;<span class="ident" id="2961852">s</span><span class="op" id="2961853">[</span><span class="builtinfunc" id="2961854">len</span><span class="op" id="2961857">(</span><span class="ident" id="2961858">node</span><span class="op" id="2961862">.</span><span class="ident" id="2961863">prefix</span><span class="op" id="2961869">)</span><span class="op" id="2961870">:</span><span class="op" id="2961871">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2961876">node</span>&nbsp;<span class="op" id="2961881">=</span>&nbsp;<span class="ident" id="2961883">node</span><span class="op" id="2961887">.</span><span class="ident" id="2961888">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961895">}</span>&nbsp;<span class="keyword" id="2961897">else</span>&nbsp;<span class="op" id="2961902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961907">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961915">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2961918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2961921">return</span><br>
<span class="lineno"></span><span class="op" id="2961928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2961931">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2961982">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2962042">type</span>&nbsp;<span class="ident" id="2962047">genericReplacer</span>&nbsp;<span class="keyword" id="2962063">struct</span>&nbsp;<span class="op" id="2962070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962073">root</span>&nbsp;<span class="ident" id="2962078">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2962088">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2962162">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962187">tableSize</span>&nbsp;<span class="builtintype" id="2962197">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2962202">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962271">mapping</span>&nbsp;<span class="op" id="2962279">[</span><span class="num" id="2962280">256</span><span class="op" id="2962283">]</span><span class="builtintype" id="2962284">byte</span><br>
<span class="lineno"></span><span class="op" id="2962289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2962292">func</span>&nbsp;<span class="ident" id="2962297">makeGenericReplacer</span><span class="op" id="2962316">(</span><span class="ident" id="2962317">oldnew</span>&nbsp;<span class="op" id="2962324">[</span><span class="op" id="2962325">]</span><span class="builtintype" id="2962326">string</span><span class="op" id="2962332">)</span>&nbsp;<span class="op" id="2962334">*</span><span class="ident" id="2962335">genericReplacer</span>&nbsp;<span class="op" id="2962351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962354">r</span>&nbsp;<span class="op" id="2962356">:=</span>&nbsp;<span class="builtinfunc" id="2962359">new</span><span class="op" id="2962362">(</span><span class="ident" id="2962363">genericReplacer</span><span class="op" id="2962378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2962381">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962438">for</span>&nbsp;<span class="ident" id="2962442">i</span>&nbsp;<span class="op" id="2962444">:=</span>&nbsp;<span class="num" id="2962447">0</span><span class="op" id="2962448">;</span>&nbsp;<span class="ident" id="2962450">i</span>&nbsp;<span class="op" id="2962452">&lt;</span>&nbsp;<span class="builtinfunc" id="2962454">len</span><span class="op" id="2962457">(</span><span class="ident" id="2962458">oldnew</span><span class="op" id="2962464">)</span><span class="op" id="2962465">;</span>&nbsp;<span class="ident" id="2962467">i</span>&nbsp;<span class="op" id="2962469">+=</span>&nbsp;<span class="num" id="2962472">2</span>&nbsp;<span class="op" id="2962474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962478">key</span>&nbsp;<span class="op" id="2962482">:=</span>&nbsp;<span class="ident" id="2962485">oldnew</span><span class="op" id="2962491">[</span><span class="ident" id="2962492">i</span><span class="op" id="2962493">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962497">for</span>&nbsp;<span class="ident" id="2962501">j</span>&nbsp;<span class="op" id="2962503">:=</span>&nbsp;<span class="num" id="2962506">0</span><span class="op" id="2962507">;</span>&nbsp;<span class="ident" id="2962509">j</span>&nbsp;<span class="op" id="2962511">&lt;</span>&nbsp;<span class="builtinfunc" id="2962513">len</span><span class="op" id="2962516">(</span><span class="ident" id="2962517">key</span><span class="op" id="2962520">)</span><span class="op" id="2962521">;</span>&nbsp;<span class="ident" id="2962523">j</span><span class="op" id="2962524">++</span>&nbsp;<span class="op" id="2962527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962532">r</span><span class="op" id="2962533">.</span><span class="ident" id="2962534">mapping</span><span class="op" id="2962541">[</span><span class="ident" id="2962542">key</span><span class="op" id="2962545">[</span><span class="ident" id="2962546">j</span><span class="op" id="2962547">]</span><span class="op" id="2962548">]</span>&nbsp;<span class="op" id="2962550">=</span>&nbsp;<span class="num" id="2962552">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962563">for</span>&nbsp;<span class="ident" id="2962567">_</span><span class="op" id="2962568">,</span>&nbsp;<span class="ident" id="2962570">b</span>&nbsp;<span class="op" id="2962572">:=</span>&nbsp;<span class="keyword" id="2962575">range</span>&nbsp;<span class="ident" id="2962581">r</span><span class="op" id="2962582">.</span><span class="ident" id="2962583">mapping</span>&nbsp;<span class="op" id="2962591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962595">r</span><span class="op" id="2962596">.</span><span class="ident" id="2962597">tableSize</span>&nbsp;<span class="op" id="2962607">+=</span>&nbsp;<span class="builtintype" id="2962610">int</span><span class="op" id="2962613">(</span><span class="ident" id="2962614">b</span><span class="op" id="2962615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962622">var</span>&nbsp;<span class="ident" id="2962626">index</span>&nbsp;<span class="builtintype" id="2962632">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962638">for</span>&nbsp;<span class="ident" id="2962642">i</span><span class="op" id="2962643">,</span>&nbsp;<span class="ident" id="2962645">b</span>&nbsp;<span class="op" id="2962647">:=</span>&nbsp;<span class="keyword" id="2962650">range</span>&nbsp;<span class="ident" id="2962656">r</span><span class="op" id="2962657">.</span><span class="ident" id="2962658">mapping</span>&nbsp;<span class="op" id="2962666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962670">if</span>&nbsp;<span class="ident" id="2962673">b</span>&nbsp;<span class="op" id="2962675">==</span>&nbsp;<span class="num" id="2962678">0</span>&nbsp;<span class="op" id="2962680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962685">r</span><span class="op" id="2962686">.</span><span class="ident" id="2962687">mapping</span><span class="op" id="2962694">[</span><span class="ident" id="2962695">i</span><span class="op" id="2962696">]</span>&nbsp;<span class="op" id="2962698">=</span>&nbsp;<span class="builtintype" id="2962700">byte</span><span class="op" id="2962704">(</span><span class="ident" id="2962705">r</span><span class="op" id="2962706">.</span><span class="ident" id="2962707">tableSize</span><span class="op" id="2962716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962720">}</span>&nbsp;<span class="keyword" id="2962722">else</span>&nbsp;<span class="op" id="2962727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962732">r</span><span class="op" id="2962733">.</span><span class="ident" id="2962734">mapping</span><span class="op" id="2962741">[</span><span class="ident" id="2962742">i</span><span class="op" id="2962743">]</span>&nbsp;<span class="op" id="2962745">=</span>&nbsp;<span class="ident" id="2962747">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962756">index</span><span class="op" id="2962761">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2962772">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962832">r</span><span class="op" id="2962833">.</span><span class="ident" id="2962834">root</span><span class="op" id="2962838">.</span><span class="ident" id="2962839">table</span>&nbsp;<span class="op" id="2962845">=</span>&nbsp;<span class="builtinfunc" id="2962847">make</span><span class="op" id="2962851">(</span><span class="op" id="2962852">[</span><span class="op" id="2962853">]</span><span class="op" id="2962854">*</span><span class="ident" id="2962855">trieNode</span><span class="op" id="2962863">,</span>&nbsp;<span class="ident" id="2962865">r</span><span class="op" id="2962866">.</span><span class="ident" id="2962867">tableSize</span><span class="op" id="2962876">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962880">for</span>&nbsp;<span class="ident" id="2962884">i</span>&nbsp;<span class="op" id="2962886">:=</span>&nbsp;<span class="num" id="2962889">0</span><span class="op" id="2962890">;</span>&nbsp;<span class="ident" id="2962892">i</span>&nbsp;<span class="op" id="2962894">&lt;</span>&nbsp;<span class="builtinfunc" id="2962896">len</span><span class="op" id="2962899">(</span><span class="ident" id="2962900">oldnew</span><span class="op" id="2962906">)</span><span class="op" id="2962907">;</span>&nbsp;<span class="ident" id="2962909">i</span>&nbsp;<span class="op" id="2962911">+=</span>&nbsp;<span class="num" id="2962914">2</span>&nbsp;<span class="op" id="2962916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2962920">r</span><span class="op" id="2962921">.</span><span class="ident" id="2962922">root</span><span class="op" id="2962926">.</span><span class="ident" id="2962927">add</span><span class="op" id="2962930">(</span><span class="ident" id="2962931">oldnew</span><span class="op" id="2962937">[</span><span class="ident" id="2962938">i</span><span class="op" id="2962939">]</span><span class="op" id="2962940">,</span>&nbsp;<span class="ident" id="2962942">oldnew</span><span class="op" id="2962948">[</span><span class="ident" id="2962949">i</span><span class="op" id="2962950">+</span><span class="num" id="2962951">1</span><span class="op" id="2962952">]</span><span class="op" id="2962953">,</span>&nbsp;<span class="builtinfunc" id="2962955">len</span><span class="op" id="2962958">(</span><span class="ident" id="2962959">oldnew</span><span class="op" id="2962965">)</span><span class="op" id="2962966">-</span><span class="ident" id="2962967">i</span><span class="op" id="2962968">,</span>&nbsp;<span class="ident" id="2962970">r</span><span class="op" id="2962971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2962974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2962977">return</span>&nbsp;<span class="ident" id="2962984">r</span><br>
<span class="lineno">270</span><span class="op" id="2962986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2962989">type</span>&nbsp;<span class="ident" id="2962994">appendSliceWriter</span>&nbsp;<span class="op" id="2963012">[</span><span class="op" id="2963013">]</span><span class="builtintype" id="2963014">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2963020">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2963072">func</span>&nbsp;<span class="op" id="2963077">(</span><span class="ident" id="2963078">w</span>&nbsp;<span class="op" id="2963080">*</span><span class="ident" id="2963081">appendSliceWriter</span><span class="op" id="2963098">)</span>&nbsp;<span class="ident" id="2963100">Write</span><span class="op" id="2963105">(</span><span class="ident" id="2963106">p</span>&nbsp;<span class="op" id="2963108">[</span><span class="op" id="2963109">]</span><span class="builtintype" id="2963110">byte</span><span class="op" id="2963114">)</span>&nbsp;<span class="op" id="2963116">(</span><span class="builtintype" id="2963117">int</span><span class="op" id="2963120">,</span>&nbsp;<span class="builtintype" id="2963122">error</span><span class="op" id="2963127">)</span>&nbsp;<span class="op" id="2963129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963132">*</span><span class="ident" id="2963133">w</span>&nbsp;<span class="op" id="2963135">=</span>&nbsp;<span class="builtinfunc" id="2963137">append</span><span class="op" id="2963143">(</span><span class="op" id="2963144">*</span><span class="ident" id="2963145">w</span><span class="op" id="2963146">,</span>&nbsp;<span class="ident" id="2963148">p</span><span class="op" id="2963149">...</span><span class="op" id="2963152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963155">return</span>&nbsp;<span class="builtinfunc" id="2963162">len</span><span class="op" id="2963165">(</span><span class="ident" id="2963166">p</span><span class="op" id="2963167">)</span><span class="op" id="2963168">,</span>&nbsp;<span class="ident" id="2963170">nil</span><br>
<span class="lineno"></span><span class="op" id="2963174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2963177">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2963257">func</span>&nbsp;<span class="op" id="2963262">(</span><span class="ident" id="2963263">w</span>&nbsp;<span class="op" id="2963265">*</span><span class="ident" id="2963266">appendSliceWriter</span><span class="op" id="2963283">)</span>&nbsp;<span class="ident" id="2963285">WriteString</span><span class="op" id="2963296">(</span><span class="ident" id="2963297">s</span>&nbsp;<span class="builtintype" id="2963299">string</span><span class="op" id="2963305">)</span>&nbsp;<span class="op" id="2963307">(</span><span class="builtintype" id="2963308">int</span><span class="op" id="2963311">,</span>&nbsp;<span class="builtintype" id="2963313">error</span><span class="op" id="2963318">)</span>&nbsp;<span class="op" id="2963320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963323">*</span><span class="ident" id="2963324">w</span>&nbsp;<span class="op" id="2963326">=</span>&nbsp;<span class="builtinfunc" id="2963328">append</span><span class="op" id="2963334">(</span><span class="op" id="2963335">*</span><span class="ident" id="2963336">w</span><span class="op" id="2963337">,</span>&nbsp;<span class="ident" id="2963339">s</span><span class="op" id="2963340">...</span><span class="op" id="2963343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963346">return</span>&nbsp;<span class="builtinfunc" id="2963353">len</span><span class="op" id="2963356">(</span><span class="ident" id="2963357">s</span><span class="op" id="2963358">)</span><span class="op" id="2963359">,</span>&nbsp;<span class="ident" id="2963361">nil</span><br>
<span class="lineno"></span><span class="op" id="2963365">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2963368">type</span>&nbsp;<span class="ident" id="2963373">stringWriterIface</span>&nbsp;<span class="keyword" id="2963391">interface</span>&nbsp;<span class="op" id="2963401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963404">WriteString</span><span class="op" id="2963415">(</span><span class="builtintype" id="2963416">string</span><span class="op" id="2963422">)</span>&nbsp;<span class="op" id="2963424">(</span><span class="builtintype" id="2963425">int</span><span class="op" id="2963428">,</span>&nbsp;<span class="builtintype" id="2963430">error</span><span class="op" id="2963435">)</span><br>
<span class="lineno"></span><span class="op" id="2963437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2963440">type</span>&nbsp;<span class="ident" id="2963445">stringWriter</span>&nbsp;<span class="keyword" id="2963458">struct</span>&nbsp;<span class="op" id="2963465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963468">w</span>&nbsp;<span class="ident" id="2963470">io</span><span class="op" id="2963472">.</span><span class="ident" id="2963473">Writer</span><br>
<span class="lineno"></span><span class="op" id="2963480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2963483">func</span>&nbsp;<span class="op" id="2963488">(</span><span class="ident" id="2963489">w</span>&nbsp;<span class="ident" id="2963491">stringWriter</span><span class="op" id="2963503">)</span>&nbsp;<span class="ident" id="2963505">WriteString</span><span class="op" id="2963516">(</span><span class="ident" id="2963517">s</span>&nbsp;<span class="builtintype" id="2963519">string</span><span class="op" id="2963525">)</span>&nbsp;<span class="op" id="2963527">(</span><span class="builtintype" id="2963528">int</span><span class="op" id="2963531">,</span>&nbsp;<span class="builtintype" id="2963533">error</span><span class="op" id="2963538">)</span>&nbsp;<span class="op" id="2963540">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963543">return</span>&nbsp;<span class="ident" id="2963550">w</span><span class="op" id="2963551">.</span><span class="ident" id="2963552">w</span><span class="op" id="2963553">.</span><span class="ident" id="2963554">Write</span><span class="op" id="2963559">(</span><span class="op" id="2963560">[</span><span class="op" id="2963561">]</span><span class="builtintype" id="2963562">byte</span><span class="op" id="2963566">(</span><span class="ident" id="2963567">s</span><span class="op" id="2963568">)</span><span class="op" id="2963569">)</span><br>
<span class="lineno"></span><span class="op" id="2963571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2963574">func</span>&nbsp;<span class="ident" id="2963579">getStringWriter</span><span class="op" id="2963594">(</span><span class="ident" id="2963595">w</span>&nbsp;<span class="ident" id="2963597">io</span><span class="op" id="2963599">.</span><span class="ident" id="2963600">Writer</span><span class="op" id="2963606">)</span>&nbsp;<span class="ident" id="2963608">stringWriterIface</span>&nbsp;<span class="op" id="2963626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963629">sw</span><span class="op" id="2963631">,</span>&nbsp;<span class="ident" id="2963633">ok</span>&nbsp;<span class="op" id="2963636">:=</span>&nbsp;<span class="ident" id="2963639">w</span><span class="op" id="2963640">.</span><span class="op" id="2963641">(</span><span class="ident" id="2963642">stringWriterIface</span><span class="op" id="2963659">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963662">if</span>&nbsp;<span class="op" id="2963665">!</span><span class="ident" id="2963666">ok</span>&nbsp;<span class="op" id="2963669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963673">sw</span>&nbsp;<span class="op" id="2963676">=</span>&nbsp;<span class="ident" id="2963678">stringWriter</span><span class="op" id="2963690">{</span><span class="ident" id="2963691">w</span><span class="op" id="2963692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2963695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963698">return</span>&nbsp;<span class="ident" id="2963705">sw</span><br>
<span class="lineno"></span><span class="op" id="2963708">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2963711">func</span>&nbsp;<span class="op" id="2963716">(</span><span class="ident" id="2963717">r</span>&nbsp;<span class="op" id="2963719">*</span><span class="ident" id="2963720">genericReplacer</span><span class="op" id="2963735">)</span>&nbsp;<span class="ident" id="2963737">Replace</span><span class="op" id="2963744">(</span><span class="ident" id="2963745">s</span>&nbsp;<span class="builtintype" id="2963747">string</span><span class="op" id="2963753">)</span>&nbsp;<span class="builtintype" id="2963755">string</span>&nbsp;<span class="op" id="2963762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963765">buf</span>&nbsp;<span class="op" id="2963769">:=</span>&nbsp;<span class="builtinfunc" id="2963772">make</span><span class="op" id="2963776">(</span><span class="ident" id="2963777">appendSliceWriter</span><span class="op" id="2963794">,</span>&nbsp;<span class="num" id="2963796">0</span><span class="op" id="2963797">,</span>&nbsp;<span class="builtinfunc" id="2963799">len</span><span class="op" id="2963802">(</span><span class="ident" id="2963803">s</span><span class="op" id="2963804">)</span><span class="op" id="2963805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963808">r</span><span class="op" id="2963809">.</span><span class="ident" id="2963810">WriteString</span><span class="op" id="2963821">(</span><span class="op" id="2963822">&amp;</span><span class="ident" id="2963823">buf</span><span class="op" id="2963826">,</span>&nbsp;<span class="ident" id="2963828">s</span><span class="op" id="2963829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963832">return</span>&nbsp;<span class="builtintype" id="2963839">string</span><span class="op" id="2963845">(</span><span class="ident" id="2963846">buf</span><span class="op" id="2963849">)</span><br>
<span class="lineno">310</span><span class="op" id="2963851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2963854">func</span>&nbsp;<span class="op" id="2963859">(</span><span class="ident" id="2963860">r</span>&nbsp;<span class="op" id="2963862">*</span><span class="ident" id="2963863">genericReplacer</span><span class="op" id="2963878">)</span>&nbsp;<span class="ident" id="2963880">WriteString</span><span class="op" id="2963891">(</span><span class="ident" id="2963892">w</span>&nbsp;<span class="ident" id="2963894">io</span><span class="op" id="2963896">.</span><span class="ident" id="2963897">Writer</span><span class="op" id="2963903">,</span>&nbsp;<span class="ident" id="2963905">s</span>&nbsp;<span class="builtintype" id="2963907">string</span><span class="op" id="2963913">)</span>&nbsp;<span class="op" id="2963915">(</span><span class="ident" id="2963916">n</span>&nbsp;<span class="builtintype" id="2963918">int</span><span class="op" id="2963921">,</span>&nbsp;<span class="ident" id="2963923">err</span>&nbsp;<span class="builtintype" id="2963927">error</span><span class="op" id="2963932">)</span>&nbsp;<span class="op" id="2963934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2963937">sw</span>&nbsp;<span class="op" id="2963940">:=</span>&nbsp;<span class="ident" id="2963943">getStringWriter</span><span class="op" id="2963958">(</span><span class="ident" id="2963959">w</span><span class="op" id="2963960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963963">var</span>&nbsp;<span class="ident" id="2963967">last</span><span class="op" id="2963971">,</span>&nbsp;<span class="ident" id="2963973">wn</span>&nbsp;<span class="builtintype" id="2963976">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2963981">var</span>&nbsp;<span class="ident" id="2963985">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2964000">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964006">for</span>&nbsp;<span class="ident" id="2964010">i</span>&nbsp;<span class="op" id="2964012">:=</span>&nbsp;<span class="num" id="2964015">0</span><span class="op" id="2964016">;</span>&nbsp;<span class="ident" id="2964018">i</span>&nbsp;<span class="op" id="2964020">&lt;=</span>&nbsp;<span class="builtinfunc" id="2964023">len</span><span class="op" id="2964026">(</span><span class="ident" id="2964027">s</span><span class="op" id="2964028">)</span><span class="op" id="2964029">;</span>&nbsp;<span class="op" id="2964031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2964035">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964088">if</span>&nbsp;<span class="ident" id="2964091">i</span>&nbsp;<span class="op" id="2964093">!=</span>&nbsp;<span class="builtinfunc" id="2964096">len</span><span class="op" id="2964099">(</span><span class="ident" id="2964100">s</span><span class="op" id="2964101">)</span>&nbsp;<span class="op" id="2964103">&amp;&amp;</span>&nbsp;<span class="ident" id="2964106">r</span><span class="op" id="2964107">.</span><span class="ident" id="2964108">root</span><span class="op" id="2964112">.</span><span class="ident" id="2964113">priority</span>&nbsp;<span class="op" id="2964122">==</span>&nbsp;<span class="num" id="2964125">0</span>&nbsp;<span class="op" id="2964127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964132">index</span>&nbsp;<span class="op" id="2964138">:=</span>&nbsp;<span class="builtintype" id="2964141">int</span><span class="op" id="2964144">(</span><span class="ident" id="2964145">r</span><span class="op" id="2964146">.</span><span class="ident" id="2964147">mapping</span><span class="op" id="2964154">[</span><span class="ident" id="2964155">s</span><span class="op" id="2964156">[</span><span class="ident" id="2964157">i</span><span class="op" id="2964158">]</span><span class="op" id="2964159">]</span><span class="op" id="2964160">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964165">if</span>&nbsp;<span class="ident" id="2964168">index</span>&nbsp;<span class="op" id="2964174">==</span>&nbsp;<span class="ident" id="2964177">r</span><span class="op" id="2964178">.</span><span class="ident" id="2964179">tableSize</span>&nbsp;<span class="op" id="2964189">||</span>&nbsp;<span class="ident" id="2964192">r</span><span class="op" id="2964193">.</span><span class="ident" id="2964194">root</span><span class="op" id="2964198">.</span><span class="ident" id="2964199">table</span><span class="op" id="2964204">[</span><span class="ident" id="2964205">index</span><span class="op" id="2964210">]</span>&nbsp;<span class="op" id="2964212">==</span>&nbsp;<span class="ident" id="2964215">nil</span>&nbsp;<span class="op" id="2964219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964225">i</span><span class="op" id="2964226">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964233">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964249">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2964254">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964327">val</span><span class="op" id="2964330">,</span>&nbsp;<span class="ident" id="2964332">keylen</span><span class="op" id="2964338">,</span>&nbsp;<span class="ident" id="2964340">match</span>&nbsp;<span class="op" id="2964346">:=</span>&nbsp;<span class="ident" id="2964349">r</span><span class="op" id="2964350">.</span><span class="ident" id="2964351">lookup</span><span class="op" id="2964357">(</span><span class="ident" id="2964358">s</span><span class="op" id="2964359">[</span><span class="ident" id="2964360">i</span><span class="op" id="2964361">:</span><span class="op" id="2964362">]</span><span class="op" id="2964363">,</span>&nbsp;<span class="ident" id="2964365">prevMatchEmpty</span><span class="op" id="2964379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964383">prevMatchEmpty</span>&nbsp;<span class="op" id="2964398">=</span>&nbsp;<span class="ident" id="2964400">match</span>&nbsp;<span class="op" id="2964406">&amp;&amp;</span>&nbsp;<span class="ident" id="2964409">keylen</span>&nbsp;<span class="op" id="2964416">==</span>&nbsp;<span class="num" id="2964419">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964423">if</span>&nbsp;<span class="ident" id="2964426">match</span>&nbsp;<span class="op" id="2964432">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964437">wn</span><span class="op" id="2964439">,</span>&nbsp;<span class="ident" id="2964441">err</span>&nbsp;<span class="op" id="2964445">=</span>&nbsp;<span class="ident" id="2964447">sw</span><span class="op" id="2964449">.</span><span class="ident" id="2964450">WriteString</span><span class="op" id="2964461">(</span><span class="ident" id="2964462">s</span><span class="op" id="2964463">[</span><span class="ident" id="2964464">last</span><span class="op" id="2964468">:</span><span class="ident" id="2964469">i</span><span class="op" id="2964470">]</span><span class="op" id="2964471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964476">n</span>&nbsp;<span class="op" id="2964478">+=</span>&nbsp;<span class="ident" id="2964481">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964487">if</span>&nbsp;<span class="ident" id="2964490">err</span>&nbsp;<span class="op" id="2964494">!=</span>&nbsp;<span class="ident" id="2964497">nil</span>&nbsp;<span class="op" id="2964501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964507">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964517">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964522">wn</span><span class="op" id="2964524">,</span>&nbsp;<span class="ident" id="2964526">err</span>&nbsp;<span class="op" id="2964530">=</span>&nbsp;<span class="ident" id="2964532">sw</span><span class="op" id="2964534">.</span><span class="ident" id="2964535">WriteString</span><span class="op" id="2964546">(</span><span class="ident" id="2964547">val</span><span class="op" id="2964550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964555">n</span>&nbsp;<span class="op" id="2964557">+=</span>&nbsp;<span class="ident" id="2964560">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964566">if</span>&nbsp;<span class="ident" id="2964569">err</span>&nbsp;<span class="op" id="2964573">!=</span>&nbsp;<span class="ident" id="2964576">nil</span>&nbsp;<span class="op" id="2964580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964586">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964596">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964601">i</span>&nbsp;<span class="op" id="2964603">+=</span>&nbsp;<span class="ident" id="2964606">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964616">last</span>&nbsp;<span class="op" id="2964621">=</span>&nbsp;<span class="ident" id="2964623">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964643">i</span><span class="op" id="2964644">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964651">if</span>&nbsp;<span class="ident" id="2964654">last</span>&nbsp;<span class="op" id="2964659">!=</span>&nbsp;<span class="builtinfunc" id="2964662">len</span><span class="op" id="2964665">(</span><span class="ident" id="2964666">s</span><span class="op" id="2964667">)</span>&nbsp;<span class="op" id="2964669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964673">wn</span><span class="op" id="2964675">,</span>&nbsp;<span class="ident" id="2964677">err</span>&nbsp;<span class="op" id="2964681">=</span>&nbsp;<span class="ident" id="2964683">sw</span><span class="op" id="2964685">.</span><span class="ident" id="2964686">WriteString</span><span class="op" id="2964697">(</span><span class="ident" id="2964698">s</span><span class="op" id="2964699">[</span><span class="ident" id="2964700">last</span><span class="op" id="2964704">:</span><span class="op" id="2964705">]</span><span class="op" id="2964706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964710">n</span>&nbsp;<span class="op" id="2964712">+=</span>&nbsp;<span class="ident" id="2964715">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2964719">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2964722">return</span><br>
<span class="lineno"></span><span class="op" id="2964729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2964732">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2964809">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2964876">type</span>&nbsp;<span class="ident" id="2964881">singleStringReplacer</span>&nbsp;<span class="keyword" id="2964902">struct</span>&nbsp;<span class="op" id="2964909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2964912">finder</span>&nbsp;<span class="op" id="2964919">*</span><span class="ident" id="2964920">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2964934">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965006">value</span>&nbsp;<span class="builtintype" id="2965012">string</span><br>
<span class="lineno"></span><span class="op" id="2965019">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2965022">func</span>&nbsp;<span class="ident" id="2965027">makeSingleStringReplacer</span><span class="op" id="2965051">(</span><span class="ident" id="2965052">pattern</span>&nbsp;<span class="builtintype" id="2965060">string</span><span class="op" id="2965066">,</span>&nbsp;<span class="ident" id="2965068">value</span>&nbsp;<span class="builtintype" id="2965074">string</span><span class="op" id="2965080">)</span>&nbsp;<span class="op" id="2965082">*</span><span class="ident" id="2965083">singleStringReplacer</span>&nbsp;<span class="op" id="2965104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965107">return</span>&nbsp;<span class="op" id="2965114">&amp;</span><span class="ident" id="2965115">singleStringReplacer</span><span class="op" id="2965135">{</span><span class="ident" id="2965136">finder</span><span class="op" id="2965142">:</span>&nbsp;<span class="ident" id="2965144">makeStringFinder</span><span class="op" id="2965160">(</span><span class="ident" id="2965161">pattern</span><span class="op" id="2965168">)</span><span class="op" id="2965169">,</span>&nbsp;<span class="ident" id="2965171">value</span><span class="op" id="2965176">:</span>&nbsp;<span class="ident" id="2965178">value</span><span class="op" id="2965183">}</span><br>
<span class="lineno"></span><span class="op" id="2965185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2965188">func</span>&nbsp;<span class="op" id="2965193">(</span><span class="ident" id="2965194">r</span>&nbsp;<span class="op" id="2965196">*</span><span class="ident" id="2965197">singleStringReplacer</span><span class="op" id="2965217">)</span>&nbsp;<span class="ident" id="2965219">Replace</span><span class="op" id="2965226">(</span><span class="ident" id="2965227">s</span>&nbsp;<span class="builtintype" id="2965229">string</span><span class="op" id="2965235">)</span>&nbsp;<span class="builtintype" id="2965237">string</span>&nbsp;<span class="op" id="2965244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965247">var</span>&nbsp;<span class="ident" id="2965251">buf</span>&nbsp;<span class="op" id="2965255">[</span><span class="op" id="2965256">]</span><span class="builtintype" id="2965257">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965263">i</span><span class="op" id="2965264">,</span>&nbsp;<span class="ident" id="2965266">matched</span>&nbsp;<span class="op" id="2965274">:=</span>&nbsp;<span class="num" id="2965277">0</span><span class="op" id="2965278">,</span>&nbsp;<span class="builtintype" id="2965280">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965287">for</span>&nbsp;<span class="op" id="2965291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965295">match</span>&nbsp;<span class="op" id="2965301">:=</span>&nbsp;<span class="ident" id="2965304">r</span><span class="op" id="2965305">.</span><span class="ident" id="2965306">finder</span><span class="op" id="2965312">.</span><span class="ident" id="2965313">next</span><span class="op" id="2965317">(</span><span class="ident" id="2965318">s</span><span class="op" id="2965319">[</span><span class="ident" id="2965320">i</span><span class="op" id="2965321">:</span><span class="op" id="2965322">]</span><span class="op" id="2965323">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965327">if</span>&nbsp;<span class="ident" id="2965330">match</span>&nbsp;<span class="op" id="2965336">==</span>&nbsp;<span class="op" id="2965339">-</span><span class="num" id="2965340">1</span>&nbsp;<span class="op" id="2965342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965347">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965359">matched</span>&nbsp;<span class="op" id="2965367">=</span>&nbsp;<span class="builtintype" id="2965369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965376">buf</span>&nbsp;<span class="op" id="2965380">=</span>&nbsp;<span class="builtinfunc" id="2965382">append</span><span class="op" id="2965388">(</span><span class="ident" id="2965389">buf</span><span class="op" id="2965392">,</span>&nbsp;<span class="ident" id="2965394">s</span><span class="op" id="2965395">[</span><span class="ident" id="2965396">i</span><span class="op" id="2965397">:</span><span class="ident" id="2965398">i</span><span class="op" id="2965399">+</span><span class="ident" id="2965400">match</span><span class="op" id="2965405">]</span><span class="op" id="2965406">...</span><span class="op" id="2965409">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965413">buf</span>&nbsp;<span class="op" id="2965417">=</span>&nbsp;<span class="builtinfunc" id="2965419">append</span><span class="op" id="2965425">(</span><span class="ident" id="2965426">buf</span><span class="op" id="2965429">,</span>&nbsp;<span class="ident" id="2965431">r</span><span class="op" id="2965432">.</span><span class="ident" id="2965433">value</span><span class="op" id="2965438">...</span><span class="op" id="2965441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965445">i</span>&nbsp;<span class="op" id="2965447">+=</span>&nbsp;<span class="ident" id="2965450">match</span>&nbsp;<span class="op" id="2965456">+</span>&nbsp;<span class="builtinfunc" id="2965458">len</span><span class="op" id="2965461">(</span><span class="ident" id="2965462">r</span><span class="op" id="2965463">.</span><span class="ident" id="2965464">finder</span><span class="op" id="2965470">.</span><span class="ident" id="2965471">pattern</span><span class="op" id="2965478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965484">if</span>&nbsp;<span class="op" id="2965487">!</span><span class="ident" id="2965488">matched</span>&nbsp;<span class="op" id="2965496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965500">return</span>&nbsp;<span class="ident" id="2965507">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965513">buf</span>&nbsp;<span class="op" id="2965517">=</span>&nbsp;<span class="builtinfunc" id="2965519">append</span><span class="op" id="2965525">(</span><span class="ident" id="2965526">buf</span><span class="op" id="2965529">,</span>&nbsp;<span class="ident" id="2965531">s</span><span class="op" id="2965532">[</span><span class="ident" id="2965533">i</span><span class="op" id="2965534">:</span><span class="op" id="2965535">]</span><span class="op" id="2965536">...</span><span class="op" id="2965539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965542">return</span>&nbsp;<span class="builtintype" id="2965549">string</span><span class="op" id="2965555">(</span><span class="ident" id="2965556">buf</span><span class="op" id="2965559">)</span><br>
<span class="lineno"></span><span class="op" id="2965561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2965564">func</span>&nbsp;<span class="op" id="2965569">(</span><span class="ident" id="2965570">r</span>&nbsp;<span class="op" id="2965572">*</span><span class="ident" id="2965573">singleStringReplacer</span><span class="op" id="2965593">)</span>&nbsp;<span class="ident" id="2965595">WriteString</span><span class="op" id="2965606">(</span><span class="ident" id="2965607">w</span>&nbsp;<span class="ident" id="2965609">io</span><span class="op" id="2965611">.</span><span class="ident" id="2965612">Writer</span><span class="op" id="2965618">,</span>&nbsp;<span class="ident" id="2965620">s</span>&nbsp;<span class="builtintype" id="2965622">string</span><span class="op" id="2965628">)</span>&nbsp;<span class="op" id="2965630">(</span><span class="ident" id="2965631">n</span>&nbsp;<span class="builtintype" id="2965633">int</span><span class="op" id="2965636">,</span>&nbsp;<span class="ident" id="2965638">err</span>&nbsp;<span class="builtintype" id="2965642">error</span><span class="op" id="2965647">)</span>&nbsp;<span class="op" id="2965649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965652">sw</span>&nbsp;<span class="op" id="2965655">:=</span>&nbsp;<span class="ident" id="2965658">getStringWriter</span><span class="op" id="2965673">(</span><span class="ident" id="2965674">w</span><span class="op" id="2965675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965678">var</span>&nbsp;<span class="ident" id="2965682">i</span><span class="op" id="2965683">,</span>&nbsp;<span class="ident" id="2965685">wn</span>&nbsp;<span class="builtintype" id="2965688">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965693">for</span>&nbsp;<span class="op" id="2965697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965701">match</span>&nbsp;<span class="op" id="2965707">:=</span>&nbsp;<span class="ident" id="2965710">r</span><span class="op" id="2965711">.</span><span class="ident" id="2965712">finder</span><span class="op" id="2965718">.</span><span class="ident" id="2965719">next</span><span class="op" id="2965723">(</span><span class="ident" id="2965724">s</span><span class="op" id="2965725">[</span><span class="ident" id="2965726">i</span><span class="op" id="2965727">:</span><span class="op" id="2965728">]</span><span class="op" id="2965729">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965733">if</span>&nbsp;<span class="ident" id="2965736">match</span>&nbsp;<span class="op" id="2965742">==</span>&nbsp;<span class="op" id="2965745">-</span><span class="num" id="2965746">1</span>&nbsp;<span class="op" id="2965748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965753">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965765">wn</span><span class="op" id="2965767">,</span>&nbsp;<span class="ident" id="2965769">err</span>&nbsp;<span class="op" id="2965773">=</span>&nbsp;<span class="ident" id="2965775">sw</span><span class="op" id="2965777">.</span><span class="ident" id="2965778">WriteString</span><span class="op" id="2965789">(</span><span class="ident" id="2965790">s</span><span class="op" id="2965791">[</span><span class="ident" id="2965792">i</span>&nbsp;<span class="op" id="2965794">:</span>&nbsp;<span class="ident" id="2965796">i</span><span class="op" id="2965797">+</span><span class="ident" id="2965798">match</span><span class="op" id="2965803">]</span><span class="op" id="2965804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965808">n</span>&nbsp;<span class="op" id="2965810">+=</span>&nbsp;<span class="ident" id="2965813">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965818">if</span>&nbsp;<span class="ident" id="2965821">err</span>&nbsp;<span class="op" id="2965825">!=</span>&nbsp;<span class="ident" id="2965828">nil</span>&nbsp;<span class="op" id="2965832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965837">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965850">wn</span><span class="op" id="2965852">,</span>&nbsp;<span class="ident" id="2965854">err</span>&nbsp;<span class="op" id="2965858">=</span>&nbsp;<span class="ident" id="2965860">sw</span><span class="op" id="2965862">.</span><span class="ident" id="2965863">WriteString</span><span class="op" id="2965874">(</span><span class="ident" id="2965875">r</span><span class="op" id="2965876">.</span><span class="ident" id="2965877">value</span><span class="op" id="2965882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965886">n</span>&nbsp;<span class="op" id="2965888">+=</span>&nbsp;<span class="ident" id="2965891">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965896">if</span>&nbsp;<span class="ident" id="2965899">err</span>&nbsp;<span class="op" id="2965903">!=</span>&nbsp;<span class="ident" id="2965906">nil</span>&nbsp;<span class="op" id="2965910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2965915">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965928">i</span>&nbsp;<span class="op" id="2965930">+=</span>&nbsp;<span class="ident" id="2965933">match</span>&nbsp;<span class="op" id="2965939">+</span>&nbsp;<span class="builtinfunc" id="2965941">len</span><span class="op" id="2965944">(</span><span class="ident" id="2965945">r</span><span class="op" id="2965946">.</span><span class="ident" id="2965947">finder</span><span class="op" id="2965953">.</span><span class="ident" id="2965954">pattern</span><span class="op" id="2965961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2965964">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2965967">wn</span><span class="op" id="2965969">,</span>&nbsp;<span class="ident" id="2965971">err</span>&nbsp;<span class="op" id="2965975">=</span>&nbsp;<span class="ident" id="2965977">sw</span><span class="op" id="2965979">.</span><span class="ident" id="2965980">WriteString</span><span class="op" id="2965991">(</span><span class="ident" id="2965992">s</span><span class="op" id="2965993">[</span><span class="ident" id="2965994">i</span><span class="op" id="2965995">:</span><span class="op" id="2965996">]</span><span class="op" id="2965997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966000">n</span>&nbsp;<span class="op" id="2966002">+=</span>&nbsp;<span class="ident" id="2966005">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966009">return</span><br>
<span class="lineno"></span><span class="op" id="2966016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2966019">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2966088">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2966132">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2966193">type</span>&nbsp;<span class="ident" id="2966198">byteReplacer</span>&nbsp;<span class="op" id="2966211">[</span><span class="num" id="2966212">256</span><span class="op" id="2966215">]</span><span class="builtintype" id="2966216">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2966222">func</span>&nbsp;<span class="op" id="2966227">(</span><span class="ident" id="2966228">r</span>&nbsp;<span class="op" id="2966230">*</span><span class="ident" id="2966231">byteReplacer</span><span class="op" id="2966243">)</span>&nbsp;<span class="ident" id="2966245">Replace</span><span class="op" id="2966252">(</span><span class="ident" id="2966253">s</span>&nbsp;<span class="builtintype" id="2966255">string</span><span class="op" id="2966261">)</span>&nbsp;<span class="builtintype" id="2966263">string</span>&nbsp;<span class="op" id="2966270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966273">var</span>&nbsp;<span class="ident" id="2966277">buf</span>&nbsp;<span class="op" id="2966281">[</span><span class="op" id="2966282">]</span><span class="builtintype" id="2966283">byte</span>&nbsp;<span class="comment" id="2966288">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966309">for</span>&nbsp;<span class="ident" id="2966313">i</span>&nbsp;<span class="op" id="2966315">:=</span>&nbsp;<span class="num" id="2966318">0</span><span class="op" id="2966319">;</span>&nbsp;<span class="ident" id="2966321">i</span>&nbsp;<span class="op" id="2966323">&lt;</span>&nbsp;<span class="builtinfunc" id="2966325">len</span><span class="op" id="2966328">(</span><span class="ident" id="2966329">s</span><span class="op" id="2966330">)</span><span class="op" id="2966331">;</span>&nbsp;<span class="ident" id="2966333">i</span><span class="op" id="2966334">++</span>&nbsp;<span class="op" id="2966337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966341">b</span>&nbsp;<span class="op" id="2966343">:=</span>&nbsp;<span class="ident" id="2966346">s</span><span class="op" id="2966347">[</span><span class="ident" id="2966348">i</span><span class="op" id="2966349">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966353">if</span>&nbsp;<span class="ident" id="2966356">r</span><span class="op" id="2966357">[</span><span class="ident" id="2966358">b</span><span class="op" id="2966359">]</span>&nbsp;<span class="op" id="2966361">!=</span>&nbsp;<span class="ident" id="2966364">b</span>&nbsp;<span class="op" id="2966366">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966371">if</span>&nbsp;<span class="ident" id="2966374">buf</span>&nbsp;<span class="op" id="2966378">==</span>&nbsp;<span class="ident" id="2966381">nil</span>&nbsp;<span class="op" id="2966385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966391">buf</span>&nbsp;<span class="op" id="2966395">=</span>&nbsp;<span class="op" id="2966397">[</span><span class="op" id="2966398">]</span><span class="builtintype" id="2966399">byte</span><span class="op" id="2966403">(</span><span class="ident" id="2966404">s</span><span class="op" id="2966405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966415">buf</span><span class="op" id="2966418">[</span><span class="ident" id="2966419">i</span><span class="op" id="2966420">]</span>&nbsp;<span class="op" id="2966422">=</span>&nbsp;<span class="ident" id="2966424">r</span><span class="op" id="2966425">[</span><span class="ident" id="2966426">b</span><span class="op" id="2966427">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966431">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966437">if</span>&nbsp;<span class="ident" id="2966440">buf</span>&nbsp;<span class="op" id="2966444">==</span>&nbsp;<span class="ident" id="2966447">nil</span>&nbsp;<span class="op" id="2966451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966455">return</span>&nbsp;<span class="ident" id="2966462">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966468">return</span>&nbsp;<span class="builtintype" id="2966475">string</span><span class="op" id="2966481">(</span><span class="ident" id="2966482">buf</span><span class="op" id="2966485">)</span><br>
<span class="lineno">430</span><span class="op" id="2966487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2966490">func</span>&nbsp;<span class="op" id="2966495">(</span><span class="ident" id="2966496">r</span>&nbsp;<span class="op" id="2966498">*</span><span class="ident" id="2966499">byteReplacer</span><span class="op" id="2966511">)</span>&nbsp;<span class="ident" id="2966513">WriteString</span><span class="op" id="2966524">(</span><span class="ident" id="2966525">w</span>&nbsp;<span class="ident" id="2966527">io</span><span class="op" id="2966529">.</span><span class="ident" id="2966530">Writer</span><span class="op" id="2966536">,</span>&nbsp;<span class="ident" id="2966538">s</span>&nbsp;<span class="builtintype" id="2966540">string</span><span class="op" id="2966546">)</span>&nbsp;<span class="op" id="2966548">(</span><span class="ident" id="2966549">n</span>&nbsp;<span class="builtintype" id="2966551">int</span><span class="op" id="2966554">,</span>&nbsp;<span class="ident" id="2966556">err</span>&nbsp;<span class="builtintype" id="2966560">error</span><span class="op" id="2966565">)</span>&nbsp;<span class="op" id="2966567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2966570">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966648">bufsize</span>&nbsp;<span class="op" id="2966656">:=</span>&nbsp;<span class="num" id="2966659">32</span>&nbsp;<span class="op" id="2966662">&lt;&lt;</span>&nbsp;<span class="num" id="2966665">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966669">if</span>&nbsp;<span class="builtinfunc" id="2966672">len</span><span class="op" id="2966675">(</span><span class="ident" id="2966676">s</span><span class="op" id="2966677">)</span>&nbsp;<span class="op" id="2966679">&lt;</span>&nbsp;<span class="ident" id="2966681">bufsize</span>&nbsp;<span class="op" id="2966689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966693">bufsize</span>&nbsp;<span class="op" id="2966701">=</span>&nbsp;<span class="builtinfunc" id="2966703">len</span><span class="op" id="2966706">(</span><span class="ident" id="2966707">s</span><span class="op" id="2966708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966714">buf</span>&nbsp;<span class="op" id="2966718">:=</span>&nbsp;<span class="builtinfunc" id="2966721">make</span><span class="op" id="2966725">(</span><span class="op" id="2966726">[</span><span class="op" id="2966727">]</span><span class="builtintype" id="2966728">byte</span><span class="op" id="2966732">,</span>&nbsp;<span class="ident" id="2966734">bufsize</span><span class="op" id="2966741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966745">for</span>&nbsp;<span class="builtinfunc" id="2966749">len</span><span class="op" id="2966752">(</span><span class="ident" id="2966753">s</span><span class="op" id="2966754">)</span>&nbsp;<span class="op" id="2966756">&gt;</span>&nbsp;<span class="num" id="2966758">0</span>&nbsp;<span class="op" id="2966760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966764">ncopy</span>&nbsp;<span class="op" id="2966770">:=</span>&nbsp;<span class="builtinfunc" id="2966773">copy</span><span class="op" id="2966777">(</span><span class="ident" id="2966778">buf</span><span class="op" id="2966781">,</span>&nbsp;<span class="ident" id="2966783">s</span><span class="op" id="2966784">[</span><span class="op" id="2966785">:</span><span class="op" id="2966786">]</span><span class="op" id="2966787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966791">s</span>&nbsp;<span class="op" id="2966793">=</span>&nbsp;<span class="ident" id="2966795">s</span><span class="op" id="2966796">[</span><span class="ident" id="2966797">ncopy</span><span class="op" id="2966802">:</span><span class="op" id="2966803">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966807">for</span>&nbsp;<span class="ident" id="2966811">i</span><span class="op" id="2966812">,</span>&nbsp;<span class="ident" id="2966814">b</span>&nbsp;<span class="op" id="2966816">:=</span>&nbsp;<span class="keyword" id="2966819">range</span>&nbsp;<span class="ident" id="2966825">buf</span><span class="op" id="2966828">[</span><span class="op" id="2966829">:</span><span class="ident" id="2966830">ncopy</span><span class="op" id="2966835">]</span>&nbsp;<span class="op" id="2966837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966842">buf</span><span class="op" id="2966845">[</span><span class="ident" id="2966846">i</span><span class="op" id="2966847">]</span>&nbsp;<span class="op" id="2966849">=</span>&nbsp;<span class="ident" id="2966851">r</span><span class="op" id="2966852">[</span><span class="ident" id="2966853">b</span><span class="op" id="2966854">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966862">wn</span><span class="op" id="2966864">,</span>&nbsp;<span class="ident" id="2966866">err</span>&nbsp;<span class="op" id="2966870">:=</span>&nbsp;<span class="ident" id="2966873">w</span><span class="op" id="2966874">.</span><span class="ident" id="2966875">Write</span><span class="op" id="2966880">(</span><span class="ident" id="2966881">buf</span><span class="op" id="2966884">[</span><span class="op" id="2966885">:</span><span class="ident" id="2966886">ncopy</span><span class="op" id="2966891">]</span><span class="op" id="2966892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2966896">n</span>&nbsp;<span class="op" id="2966898">+=</span>&nbsp;<span class="ident" id="2966901">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966906">if</span>&nbsp;<span class="ident" id="2966909">err</span>&nbsp;<span class="op" id="2966913">!=</span>&nbsp;<span class="ident" id="2966916">nil</span>&nbsp;<span class="op" id="2966920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966925">return</span>&nbsp;<span class="ident" id="2966932">n</span><span class="op" id="2966933">,</span>&nbsp;<span class="ident" id="2966935">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2966944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2966947">return</span>&nbsp;<span class="ident" id="2966954">n</span><span class="op" id="2966955">,</span>&nbsp;<span class="ident" id="2966957">nil</span><br>
<span class="lineno"></span><span class="op" id="2966961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2966964">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2967033">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2967107">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2967174">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2967238">type</span>&nbsp;<span class="ident" id="2967243">byteStringReplacer</span>&nbsp;<span class="op" id="2967262">[</span><span class="num" id="2967263">256</span><span class="op" id="2967266">]</span><span class="op" id="2967267">[</span><span class="op" id="2967268">]</span><span class="builtintype" id="2967269">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2967275">func</span>&nbsp;<span class="op" id="2967280">(</span><span class="ident" id="2967281">r</span>&nbsp;<span class="op" id="2967283">*</span><span class="ident" id="2967284">byteStringReplacer</span><span class="op" id="2967302">)</span>&nbsp;<span class="ident" id="2967304">Replace</span><span class="op" id="2967311">(</span><span class="ident" id="2967312">s</span>&nbsp;<span class="builtintype" id="2967314">string</span><span class="op" id="2967320">)</span>&nbsp;<span class="builtintype" id="2967322">string</span>&nbsp;<span class="op" id="2967329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967332">newSize</span>&nbsp;<span class="op" id="2967340">:=</span>&nbsp;<span class="builtinfunc" id="2967343">len</span><span class="op" id="2967346">(</span><span class="ident" id="2967347">s</span><span class="op" id="2967348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967351">anyChanges</span>&nbsp;<span class="op" id="2967362">:=</span>&nbsp;<span class="builtintype" id="2967365">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967372">for</span>&nbsp;<span class="ident" id="2967376">i</span>&nbsp;<span class="op" id="2967378">:=</span>&nbsp;<span class="num" id="2967381">0</span><span class="op" id="2967382">;</span>&nbsp;<span class="ident" id="2967384">i</span>&nbsp;<span class="op" id="2967386">&lt;</span>&nbsp;<span class="builtinfunc" id="2967388">len</span><span class="op" id="2967391">(</span><span class="ident" id="2967392">s</span><span class="op" id="2967393">)</span><span class="op" id="2967394">;</span>&nbsp;<span class="ident" id="2967396">i</span><span class="op" id="2967397">++</span>&nbsp;<span class="op" id="2967400">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967404">b</span>&nbsp;<span class="op" id="2967406">:=</span>&nbsp;<span class="ident" id="2967409">s</span><span class="op" id="2967410">[</span><span class="ident" id="2967411">i</span><span class="op" id="2967412">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967416">if</span>&nbsp;<span class="ident" id="2967419">r</span><span class="op" id="2967420">[</span><span class="ident" id="2967421">b</span><span class="op" id="2967422">]</span>&nbsp;<span class="op" id="2967424">!=</span>&nbsp;<span class="ident" id="2967427">nil</span>&nbsp;<span class="op" id="2967431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967436">anyChanges</span>&nbsp;<span class="op" id="2967447">=</span>&nbsp;<span class="builtintype" id="2967449">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2967457">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967527">newSize</span>&nbsp;<span class="op" id="2967535">+=</span>&nbsp;<span class="builtinfunc" id="2967538">len</span><span class="op" id="2967541">(</span><span class="ident" id="2967542">r</span><span class="op" id="2967543">[</span><span class="ident" id="2967544">b</span><span class="op" id="2967545">]</span><span class="op" id="2967546">)</span>&nbsp;<span class="op" id="2967548">-</span>&nbsp;<span class="num" id="2967550">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967560">if</span>&nbsp;<span class="op" id="2967563">!</span><span class="ident" id="2967564">anyChanges</span>&nbsp;<span class="op" id="2967575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967579">return</span>&nbsp;<span class="ident" id="2967586">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967589">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967592">buf</span>&nbsp;<span class="op" id="2967596">:=</span>&nbsp;<span class="builtinfunc" id="2967599">make</span><span class="op" id="2967603">(</span><span class="op" id="2967604">[</span><span class="op" id="2967605">]</span><span class="builtintype" id="2967606">byte</span><span class="op" id="2967610">,</span>&nbsp;<span class="ident" id="2967612">newSize</span><span class="op" id="2967619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967622">bi</span>&nbsp;<span class="op" id="2967625">:=</span>&nbsp;<span class="ident" id="2967628">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967633">for</span>&nbsp;<span class="ident" id="2967637">i</span>&nbsp;<span class="op" id="2967639">:=</span>&nbsp;<span class="num" id="2967642">0</span><span class="op" id="2967643">;</span>&nbsp;<span class="ident" id="2967645">i</span>&nbsp;<span class="op" id="2967647">&lt;</span>&nbsp;<span class="builtinfunc" id="2967649">len</span><span class="op" id="2967652">(</span><span class="ident" id="2967653">s</span><span class="op" id="2967654">)</span><span class="op" id="2967655">;</span>&nbsp;<span class="ident" id="2967657">i</span><span class="op" id="2967658">++</span>&nbsp;<span class="op" id="2967661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967665">b</span>&nbsp;<span class="op" id="2967667">:=</span>&nbsp;<span class="ident" id="2967670">s</span><span class="op" id="2967671">[</span><span class="ident" id="2967672">i</span><span class="op" id="2967673">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967677">if</span>&nbsp;<span class="ident" id="2967680">r</span><span class="op" id="2967681">[</span><span class="ident" id="2967682">b</span><span class="op" id="2967683">]</span>&nbsp;<span class="op" id="2967685">!=</span>&nbsp;<span class="ident" id="2967688">nil</span>&nbsp;<span class="op" id="2967692">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967697">n</span>&nbsp;<span class="op" id="2967699">:=</span>&nbsp;<span class="builtinfunc" id="2967702">copy</span><span class="op" id="2967706">(</span><span class="ident" id="2967707">bi</span><span class="op" id="2967709">,</span>&nbsp;<span class="ident" id="2967711">r</span><span class="op" id="2967712">[</span><span class="ident" id="2967713">b</span><span class="op" id="2967714">]</span><span class="op" id="2967715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967720">bi</span>&nbsp;<span class="op" id="2967723">=</span>&nbsp;<span class="ident" id="2967725">bi</span><span class="op" id="2967727">[</span><span class="ident" id="2967728">n</span><span class="op" id="2967729">:</span><span class="op" id="2967730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967734">}</span>&nbsp;<span class="keyword" id="2967736">else</span>&nbsp;<span class="op" id="2967741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967746">bi</span><span class="op" id="2967748">[</span><span class="num" id="2967749">0</span><span class="op" id="2967750">]</span>&nbsp;<span class="op" id="2967752">=</span>&nbsp;<span class="ident" id="2967754">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967759">bi</span>&nbsp;<span class="op" id="2967762">=</span>&nbsp;<span class="ident" id="2967764">bi</span><span class="op" id="2967766">[</span><span class="num" id="2967767">1</span><span class="op" id="2967768">:</span><span class="op" id="2967769">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967779">return</span>&nbsp;<span class="builtintype" id="2967786">string</span><span class="op" id="2967792">(</span><span class="ident" id="2967793">buf</span><span class="op" id="2967796">)</span><br>
<span class="lineno"></span><span class="op" id="2967798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2967801">func</span>&nbsp;<span class="op" id="2967806">(</span><span class="ident" id="2967807">r</span>&nbsp;<span class="op" id="2967809">*</span><span class="ident" id="2967810">byteStringReplacer</span><span class="op" id="2967828">)</span>&nbsp;<span class="ident" id="2967830">WriteString</span><span class="op" id="2967841">(</span><span class="ident" id="2967842">w</span>&nbsp;<span class="ident" id="2967844">io</span><span class="op" id="2967846">.</span><span class="ident" id="2967847">Writer</span><span class="op" id="2967853">,</span>&nbsp;<span class="ident" id="2967855">s</span>&nbsp;<span class="builtintype" id="2967857">string</span><span class="op" id="2967863">)</span>&nbsp;<span class="op" id="2967865">(</span><span class="ident" id="2967866">n</span>&nbsp;<span class="builtintype" id="2967868">int</span><span class="op" id="2967871">,</span>&nbsp;<span class="ident" id="2967873">err</span>&nbsp;<span class="builtintype" id="2967877">error</span><span class="op" id="2967882">)</span>&nbsp;<span class="op" id="2967884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967887">sw</span>&nbsp;<span class="op" id="2967890">:=</span>&nbsp;<span class="ident" id="2967893">getStringWriter</span><span class="op" id="2967908">(</span><span class="ident" id="2967909">w</span><span class="op" id="2967910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967913">last</span>&nbsp;<span class="op" id="2967918">:=</span>&nbsp;<span class="num" id="2967921">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967924">for</span>&nbsp;<span class="ident" id="2967928">i</span>&nbsp;<span class="op" id="2967930">:=</span>&nbsp;<span class="num" id="2967933">0</span><span class="op" id="2967934">;</span>&nbsp;<span class="ident" id="2967936">i</span>&nbsp;<span class="op" id="2967938">&lt;</span>&nbsp;<span class="builtinfunc" id="2967940">len</span><span class="op" id="2967943">(</span><span class="ident" id="2967944">s</span><span class="op" id="2967945">)</span><span class="op" id="2967946">;</span>&nbsp;<span class="ident" id="2967948">i</span><span class="op" id="2967949">++</span>&nbsp;<span class="op" id="2967952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2967956">b</span>&nbsp;<span class="op" id="2967958">:=</span>&nbsp;<span class="ident" id="2967961">s</span><span class="op" id="2967962">[</span><span class="ident" id="2967963">i</span><span class="op" id="2967964">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967968">if</span>&nbsp;<span class="ident" id="2967971">r</span><span class="op" id="2967972">[</span><span class="ident" id="2967973">b</span><span class="op" id="2967974">]</span>&nbsp;<span class="op" id="2967976">==</span>&nbsp;<span class="ident" id="2967979">nil</span>&nbsp;<span class="op" id="2967983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2967988">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2967999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968003">if</span>&nbsp;<span class="ident" id="2968006">last</span>&nbsp;<span class="op" id="2968011">!=</span>&nbsp;<span class="ident" id="2968014">i</span>&nbsp;<span class="op" id="2968016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968021">nw</span><span class="op" id="2968023">,</span>&nbsp;<span class="ident" id="2968025">err</span>&nbsp;<span class="op" id="2968029">:=</span>&nbsp;<span class="ident" id="2968032">sw</span><span class="op" id="2968034">.</span><span class="ident" id="2968035">WriteString</span><span class="op" id="2968046">(</span><span class="ident" id="2968047">s</span><span class="op" id="2968048">[</span><span class="ident" id="2968049">last</span><span class="op" id="2968053">:</span><span class="ident" id="2968054">i</span><span class="op" id="2968055">]</span><span class="op" id="2968056">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968061">n</span>&nbsp;<span class="op" id="2968063">+=</span>&nbsp;<span class="ident" id="2968066">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968072">if</span>&nbsp;<span class="ident" id="2968075">err</span>&nbsp;<span class="op" id="2968079">!=</span>&nbsp;<span class="ident" id="2968082">nil</span>&nbsp;<span class="op" id="2968086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968092">return</span>&nbsp;<span class="ident" id="2968099">n</span><span class="op" id="2968100">,</span>&nbsp;<span class="ident" id="2968102">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968113">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968117">last</span>&nbsp;<span class="op" id="2968122">=</span>&nbsp;<span class="ident" id="2968124">i</span>&nbsp;<span class="op" id="2968126">+</span>&nbsp;<span class="num" id="2968128">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968132">nw</span><span class="op" id="2968134">,</span>&nbsp;<span class="ident" id="2968136">err</span>&nbsp;<span class="op" id="2968140">:=</span>&nbsp;<span class="ident" id="2968143">w</span><span class="op" id="2968144">.</span><span class="ident" id="2968145">Write</span><span class="op" id="2968150">(</span><span class="ident" id="2968151">r</span><span class="op" id="2968152">[</span><span class="ident" id="2968153">b</span><span class="op" id="2968154">]</span><span class="op" id="2968155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968159">n</span>&nbsp;<span class="op" id="2968161">+=</span>&nbsp;<span class="ident" id="2968164">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968169">if</span>&nbsp;<span class="ident" id="2968172">err</span>&nbsp;<span class="op" id="2968176">!=</span>&nbsp;<span class="ident" id="2968179">nil</span>&nbsp;<span class="op" id="2968183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968188">return</span>&nbsp;<span class="ident" id="2968195">n</span><span class="op" id="2968196">,</span>&nbsp;<span class="ident" id="2968198">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968210">if</span>&nbsp;<span class="ident" id="2968213">last</span>&nbsp;<span class="op" id="2968218">!=</span>&nbsp;<span class="builtinfunc" id="2968221">len</span><span class="op" id="2968224">(</span><span class="ident" id="2968225">s</span><span class="op" id="2968226">)</span>&nbsp;<span class="op" id="2968228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968232">var</span>&nbsp;<span class="ident" id="2968236">nw</span>&nbsp;<span class="builtintype" id="2968239">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968245">nw</span><span class="op" id="2968247">,</span>&nbsp;<span class="ident" id="2968249">err</span>&nbsp;<span class="op" id="2968253">=</span>&nbsp;<span class="ident" id="2968255">sw</span><span class="op" id="2968257">.</span><span class="ident" id="2968258">WriteString</span><span class="op" id="2968269">(</span><span class="ident" id="2968270">s</span><span class="op" id="2968271">[</span><span class="ident" id="2968272">last</span><span class="op" id="2968276">:</span><span class="op" id="2968277">]</span><span class="op" id="2968278">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2968282">n</span>&nbsp;<span class="op" id="2968284">+=</span>&nbsp;<span class="ident" id="2968287">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2968291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2968294">return</span><br>
<span class="lineno"></span><span class="op" id="2968301">}</span>
</div>
</body>
</html>
