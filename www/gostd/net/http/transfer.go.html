<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3948398">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3948453">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3948507">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3948558">package</span>&nbsp;<span class="ident" id="3948566">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3948572">import</span>&nbsp;<span class="op" id="3948579">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948582">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948591">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948600">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948610">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948617">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948623">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948636">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948657">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948674">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948682">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948693">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3948704">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3948711">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3948714">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3948784">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3948820">var</span>&nbsp;<span class="ident" id="3948824">ErrLineTooLong</span>&nbsp;<span class="op" id="3948839">=</span>&nbsp;<span class="ident" id="3948841">internal</span><span class="op" id="3948849">.</span><span class="ident" id="3948850">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3948866">type</span>&nbsp;<span class="ident" id="3948871">errorReader</span>&nbsp;<span class="keyword" id="3948883">struct</span>&nbsp;<span class="op" id="3948890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3948893">err</span>&nbsp;<span class="builtintype" id="3948897">error</span><br>
<span class="lineno"></span><span class="op" id="3948903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3948906">func</span>&nbsp;<span class="op" id="3948911">(</span><span class="ident" id="3948912">r</span>&nbsp;<span class="op" id="3948914">*</span><span class="ident" id="3948915">errorReader</span><span class="op" id="3948926">)</span>&nbsp;<span class="ident" id="3948928">Read</span><span class="op" id="3948932">(</span><span class="ident" id="3948933">p</span>&nbsp;<span class="op" id="3948935">[</span><span class="op" id="3948936">]</span><span class="builtintype" id="3948937">byte</span><span class="op" id="3948941">)</span>&nbsp;<span class="op" id="3948943">(</span><span class="ident" id="3948944">n</span>&nbsp;<span class="builtintype" id="3948946">int</span><span class="op" id="3948949">,</span>&nbsp;<span class="ident" id="3948951">err</span>&nbsp;<span class="builtintype" id="3948955">error</span><span class="op" id="3948960">)</span>&nbsp;<span class="op" id="3948962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3948965">return</span>&nbsp;<span class="num" id="3948972">0</span><span class="op" id="3948973">,</span>&nbsp;<span class="ident" id="3948975">r</span><span class="op" id="3948976">.</span><span class="ident" id="3948977">err</span><br>
<span class="lineno"></span><span class="op" id="3948981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3948984">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3949062">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3949138">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3949205">type</span>&nbsp;<span class="ident" id="3949210">transferWriter</span>&nbsp;<span class="keyword" id="3949225">struct</span>&nbsp;<span class="op" id="3949232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949235">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3949252">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949260">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949277">io</span><span class="op" id="3949279">.</span><span class="ident" id="3949280">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949288">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949305">io</span><span class="op" id="3949307">.</span><span class="ident" id="3949308">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949316">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3949333">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949339">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949356">int64</span>&nbsp;<span class="comment" id="3949362">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949405">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3949422">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949428">TransferEncoding</span>&nbsp;<span class="op" id="3949445">[</span><span class="op" id="3949446">]</span><span class="builtintype" id="3949447">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949455">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3949472">Header</span><br>
<span class="lineno"></span><span class="op" id="3949479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3949482">func</span>&nbsp;<span class="ident" id="3949487">newTransferWriter</span><span class="op" id="3949504">(</span><span class="ident" id="3949505">r</span>&nbsp;<span class="keyword" id="3949507">interface</span><span class="op" id="3949516">{</span><span class="op" id="3949517">}</span><span class="op" id="3949518">)</span>&nbsp;<span class="op" id="3949520">(</span><span class="ident" id="3949521">t</span>&nbsp;<span class="op" id="3949523">*</span><span class="ident" id="3949524">transferWriter</span><span class="op" id="3949538">,</span>&nbsp;<span class="ident" id="3949540">err</span>&nbsp;<span class="builtintype" id="3949544">error</span><span class="op" id="3949549">)</span>&nbsp;<span class="op" id="3949551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949554">t</span>&nbsp;<span class="op" id="3949556">=</span>&nbsp;<span class="op" id="3949558">&amp;</span><span class="ident" id="3949559">transferWriter</span><span class="op" id="3949573">{</span><span class="op" id="3949574">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3949578">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949606">atLeastHTTP11</span>&nbsp;<span class="op" id="3949620">:=</span>&nbsp;<span class="builtintype" id="3949623">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949630">switch</span>&nbsp;<span class="ident" id="3949637">rr</span>&nbsp;<span class="op" id="3949640">:=</span>&nbsp;<span class="ident" id="3949643">r</span><span class="op" id="3949644">.</span><span class="op" id="3949645">(</span><span class="keyword" id="3949646">type</span><span class="op" id="3949650">)</span>&nbsp;<span class="op" id="3949652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949655">case</span>&nbsp;<span class="op" id="3949660">*</span><span class="ident" id="3949661">Request</span><span class="op" id="3949668">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949672">if</span>&nbsp;<span class="ident" id="3949675">rr</span><span class="op" id="3949677">.</span><span class="ident" id="3949678">ContentLength</span>&nbsp;<span class="op" id="3949692">!=</span>&nbsp;<span class="num" id="3949695">0</span>&nbsp;<span class="op" id="3949697">&amp;&amp;</span>&nbsp;<span class="ident" id="3949700">rr</span><span class="op" id="3949702">.</span><span class="ident" id="3949703">Body</span>&nbsp;<span class="op" id="3949708">==</span>&nbsp;<span class="ident" id="3949711">nil</span>&nbsp;<span class="op" id="3949715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3949720">return</span>&nbsp;<span class="ident" id="3949727">nil</span><span class="op" id="3949730">,</span>&nbsp;<span class="ident" id="3949732">fmt</span><span class="op" id="3949735">.</span><span class="ident" id="3949736">Errorf</span><span class="op" id="3949742">(</span><span class="string" id="3949743">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3949789">,</span>&nbsp;<span class="ident" id="3949791">rr</span><span class="op" id="3949793">.</span><span class="ident" id="3949794">ContentLength</span><span class="op" id="3949807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3949811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949815">t</span><span class="op" id="3949816">.</span><span class="ident" id="3949817">Method</span>&nbsp;<span class="op" id="3949824">=</span>&nbsp;<span class="ident" id="3949826">rr</span><span class="op" id="3949828">.</span><span class="ident" id="3949829">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949838">t</span><span class="op" id="3949839">.</span><span class="ident" id="3949840">Body</span>&nbsp;<span class="op" id="3949845">=</span>&nbsp;<span class="ident" id="3949847">rr</span><span class="op" id="3949849">.</span><span class="ident" id="3949850">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949857">t</span><span class="op" id="3949858">.</span><span class="ident" id="3949859">BodyCloser</span>&nbsp;<span class="op" id="3949870">=</span>&nbsp;<span class="ident" id="3949872">rr</span><span class="op" id="3949874">.</span><span class="ident" id="3949875">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949882">t</span><span class="op" id="3949883">.</span><span class="ident" id="3949884">ContentLength</span>&nbsp;<span class="op" id="3949898">=</span>&nbsp;<span class="ident" id="3949900">rr</span><span class="op" id="3949902">.</span><span class="ident" id="3949903">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949919">t</span><span class="op" id="3949920">.</span><span class="ident" id="3949921">Close</span>&nbsp;<span class="op" id="3949927">=</span>&nbsp;<span class="ident" id="3949929">rr</span><span class="op" id="3949931">.</span><span class="ident" id="3949932">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949940">t</span><span class="op" id="3949941">.</span><span class="ident" id="3949942">TransferEncoding</span>&nbsp;<span class="op" id="3949959">=</span>&nbsp;<span class="ident" id="3949961">rr</span><span class="op" id="3949963">.</span><span class="ident" id="3949964">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3949983">t</span><span class="op" id="3949984">.</span><span class="ident" id="3949985">Trailer</span>&nbsp;<span class="op" id="3949993">=</span>&nbsp;<span class="ident" id="3949995">rr</span><span class="op" id="3949997">.</span><span class="ident" id="3949998">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950008">atLeastHTTP11</span>&nbsp;<span class="op" id="3950022">=</span>&nbsp;<span class="ident" id="3950024">rr</span><span class="op" id="3950026">.</span><span class="ident" id="3950027">ProtoAtLeast</span><span class="op" id="3950039">(</span><span class="num" id="3950040">1</span><span class="op" id="3950041">,</span>&nbsp;<span class="num" id="3950043">1</span><span class="op" id="3950044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950048">if</span>&nbsp;<span class="ident" id="3950051">t</span><span class="op" id="3950052">.</span><span class="ident" id="3950053">Body</span>&nbsp;<span class="op" id="3950058">!=</span>&nbsp;<span class="ident" id="3950061">nil</span>&nbsp;<span class="op" id="3950065">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3950068">len</span><span class="op" id="3950071">(</span><span class="ident" id="3950072">t</span><span class="op" id="3950073">.</span><span class="ident" id="3950074">TransferEncoding</span><span class="op" id="3950090">)</span>&nbsp;<span class="op" id="3950092">==</span>&nbsp;<span class="num" id="3950095">0</span>&nbsp;<span class="op" id="3950097">&amp;&amp;</span>&nbsp;<span class="ident" id="3950100">atLeastHTTP11</span>&nbsp;<span class="op" id="3950114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950119">if</span>&nbsp;<span class="ident" id="3950122">t</span><span class="op" id="3950123">.</span><span class="ident" id="3950124">ContentLength</span>&nbsp;<span class="op" id="3950138">==</span>&nbsp;<span class="num" id="3950141">0</span>&nbsp;<span class="op" id="3950143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950149">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950205">var</span>&nbsp;<span class="ident" id="3950209">buf</span>&nbsp;<span class="op" id="3950213">[</span><span class="num" id="3950214">1</span><span class="op" id="3950215">]</span><span class="builtintype" id="3950216">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950225">n</span><span class="op" id="3950226">,</span>&nbsp;<span class="ident" id="3950228">rerr</span>&nbsp;<span class="op" id="3950233">:=</span>&nbsp;<span class="ident" id="3950236">io</span><span class="op" id="3950238">.</span><span class="ident" id="3950239">ReadFull</span><span class="op" id="3950247">(</span><span class="ident" id="3950248">t</span><span class="op" id="3950249">.</span><span class="ident" id="3950250">Body</span><span class="op" id="3950254">,</span>&nbsp;<span class="ident" id="3950256">buf</span><span class="op" id="3950259">[</span><span class="op" id="3950260">:</span><span class="op" id="3950261">]</span><span class="op" id="3950262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950268">if</span>&nbsp;<span class="ident" id="3950271">rerr</span>&nbsp;<span class="op" id="3950276">!=</span>&nbsp;<span class="ident" id="3950279">nil</span>&nbsp;<span class="op" id="3950283">&amp;&amp;</span>&nbsp;<span class="ident" id="3950286">rerr</span>&nbsp;<span class="op" id="3950291">!=</span>&nbsp;<span class="ident" id="3950294">io</span><span class="op" id="3950296">.</span><span class="ident" id="3950297">EOF</span>&nbsp;<span class="op" id="3950301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950308">t</span><span class="op" id="3950309">.</span><span class="ident" id="3950310">ContentLength</span>&nbsp;<span class="op" id="3950324">=</span>&nbsp;<span class="op" id="3950326">-</span><span class="num" id="3950327">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950334">t</span><span class="op" id="3950335">.</span><span class="ident" id="3950336">Body</span>&nbsp;<span class="op" id="3950341">=</span>&nbsp;<span class="op" id="3950343">&amp;</span><span class="ident" id="3950344">errorReader</span><span class="op" id="3950355">{</span><span class="ident" id="3950356">rerr</span><span class="op" id="3950360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950366">}</span>&nbsp;<span class="keyword" id="3950368">else</span>&nbsp;<span class="keyword" id="3950373">if</span>&nbsp;<span class="ident" id="3950376">n</span>&nbsp;<span class="op" id="3950378">==</span>&nbsp;<span class="num" id="3950381">1</span>&nbsp;<span class="op" id="3950383">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950390">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950453">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950502">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950563">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950586">t</span><span class="op" id="3950587">.</span><span class="ident" id="3950588">ContentLength</span>&nbsp;<span class="op" id="3950602">=</span>&nbsp;<span class="op" id="3950604">-</span><span class="num" id="3950605">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950612">t</span><span class="op" id="3950613">.</span><span class="ident" id="3950614">Body</span>&nbsp;<span class="op" id="3950619">=</span>&nbsp;<span class="ident" id="3950621">io</span><span class="op" id="3950623">.</span><span class="ident" id="3950624">MultiReader</span><span class="op" id="3950635">(</span><span class="ident" id="3950636">bytes</span><span class="op" id="3950641">.</span><span class="ident" id="3950642">NewReader</span><span class="op" id="3950651">(</span><span class="ident" id="3950652">buf</span><span class="op" id="3950655">[</span><span class="op" id="3950656">:</span><span class="op" id="3950657">]</span><span class="op" id="3950658">)</span><span class="op" id="3950659">,</span>&nbsp;<span class="ident" id="3950661">t</span><span class="op" id="3950662">.</span><span class="ident" id="3950663">Body</span><span class="op" id="3950667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950673">}</span>&nbsp;<span class="keyword" id="3950675">else</span>&nbsp;<span class="op" id="3950680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3950687">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950719">t</span><span class="op" id="3950720">.</span><span class="ident" id="3950721">Body</span>&nbsp;<span class="op" id="3950726">=</span>&nbsp;<span class="ident" id="3950728">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950737">t</span><span class="op" id="3950738">.</span><span class="ident" id="3950739">BodyCloser</span>&nbsp;<span class="op" id="3950750">=</span>&nbsp;<span class="ident" id="3950752">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950770">if</span>&nbsp;<span class="ident" id="3950773">t</span><span class="op" id="3950774">.</span><span class="ident" id="3950775">ContentLength</span>&nbsp;<span class="op" id="3950789">&lt;</span>&nbsp;<span class="num" id="3950791">0</span>&nbsp;<span class="op" id="3950793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950799">t</span><span class="op" id="3950800">.</span><span class="ident" id="3950801">TransferEncoding</span>&nbsp;<span class="op" id="3950818">=</span>&nbsp;<span class="op" id="3950820">[</span><span class="op" id="3950821">]</span><span class="builtintype" id="3950822">string</span><span class="op" id="3950828">{</span><span class="string" id="3950829">&#34;chunked&#34;</span><span class="op" id="3950838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950843">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950850">case</span>&nbsp;<span class="op" id="3950855">*</span><span class="ident" id="3950856">Response</span><span class="op" id="3950864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3950868">if</span>&nbsp;<span class="ident" id="3950871">rr</span><span class="op" id="3950873">.</span><span class="ident" id="3950874">Request</span>&nbsp;<span class="op" id="3950882">!=</span>&nbsp;<span class="ident" id="3950885">nil</span>&nbsp;<span class="op" id="3950889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950894">t</span><span class="op" id="3950895">.</span><span class="ident" id="3950896">Method</span>&nbsp;<span class="op" id="3950903">=</span>&nbsp;<span class="ident" id="3950905">rr</span><span class="op" id="3950907">.</span><span class="ident" id="3950908">Request</span><span class="op" id="3950915">.</span><span class="ident" id="3950916">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3950925">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950929">t</span><span class="op" id="3950930">.</span><span class="ident" id="3950931">Body</span>&nbsp;<span class="op" id="3950936">=</span>&nbsp;<span class="ident" id="3950938">rr</span><span class="op" id="3950940">.</span><span class="ident" id="3950941">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950948">t</span><span class="op" id="3950949">.</span><span class="ident" id="3950950">BodyCloser</span>&nbsp;<span class="op" id="3950961">=</span>&nbsp;<span class="ident" id="3950963">rr</span><span class="op" id="3950965">.</span><span class="ident" id="3950966">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3950973">t</span><span class="op" id="3950974">.</span><span class="ident" id="3950975">ContentLength</span>&nbsp;<span class="op" id="3950989">=</span>&nbsp;<span class="ident" id="3950991">rr</span><span class="op" id="3950993">.</span><span class="ident" id="3950994">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951010">t</span><span class="op" id="3951011">.</span><span class="ident" id="3951012">Close</span>&nbsp;<span class="op" id="3951018">=</span>&nbsp;<span class="ident" id="3951020">rr</span><span class="op" id="3951022">.</span><span class="ident" id="3951023">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951031">t</span><span class="op" id="3951032">.</span><span class="ident" id="3951033">TransferEncoding</span>&nbsp;<span class="op" id="3951050">=</span>&nbsp;<span class="ident" id="3951052">rr</span><span class="op" id="3951054">.</span><span class="ident" id="3951055">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951074">t</span><span class="op" id="3951075">.</span><span class="ident" id="3951076">Trailer</span>&nbsp;<span class="op" id="3951084">=</span>&nbsp;<span class="ident" id="3951086">rr</span><span class="op" id="3951088">.</span><span class="ident" id="3951089">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951099">atLeastHTTP11</span>&nbsp;<span class="op" id="3951113">=</span>&nbsp;<span class="ident" id="3951115">rr</span><span class="op" id="3951117">.</span><span class="ident" id="3951118">ProtoAtLeast</span><span class="op" id="3951130">(</span><span class="num" id="3951131">1</span><span class="op" id="3951132">,</span>&nbsp;<span class="num" id="3951134">1</span><span class="op" id="3951135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951139">t</span><span class="op" id="3951140">.</span><span class="ident" id="3951141">ResponseToHEAD</span>&nbsp;<span class="op" id="3951156">=</span>&nbsp;<span class="ident" id="3951158">noBodyExpected</span><span class="op" id="3951172">(</span><span class="ident" id="3951173">t</span><span class="op" id="3951174">.</span><span class="ident" id="3951175">Method</span><span class="op" id="3951181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3951188">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951237">if</span>&nbsp;<span class="ident" id="3951240">t</span><span class="op" id="3951241">.</span><span class="ident" id="3951242">ResponseToHEAD</span>&nbsp;<span class="op" id="3951257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951261">t</span><span class="op" id="3951262">.</span><span class="ident" id="3951263">Body</span>&nbsp;<span class="op" id="3951268">=</span>&nbsp;<span class="ident" id="3951270">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951276">if</span>&nbsp;<span class="ident" id="3951279">chunked</span><span class="op" id="3951286">(</span><span class="ident" id="3951287">t</span><span class="op" id="3951288">.</span><span class="ident" id="3951289">TransferEncoding</span><span class="op" id="3951305">)</span>&nbsp;<span class="op" id="3951307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951312">t</span><span class="op" id="3951313">.</span><span class="ident" id="3951314">ContentLength</span>&nbsp;<span class="op" id="3951328">=</span>&nbsp;<span class="op" id="3951330">-</span><span class="num" id="3951331">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951338">}</span>&nbsp;<span class="keyword" id="3951340">else</span>&nbsp;<span class="op" id="3951345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951349">if</span>&nbsp;<span class="op" id="3951352">!</span><span class="ident" id="3951353">atLeastHTTP11</span>&nbsp;<span class="op" id="3951367">||</span>&nbsp;<span class="ident" id="3951370">t</span><span class="op" id="3951371">.</span><span class="ident" id="3951372">Body</span>&nbsp;<span class="op" id="3951377">==</span>&nbsp;<span class="ident" id="3951380">nil</span>&nbsp;<span class="op" id="3951384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951389">t</span><span class="op" id="3951390">.</span><span class="ident" id="3951391">TransferEncoding</span>&nbsp;<span class="op" id="3951408">=</span>&nbsp;<span class="ident" id="3951410">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951416">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951420">if</span>&nbsp;<span class="ident" id="3951423">chunked</span><span class="op" id="3951430">(</span><span class="ident" id="3951431">t</span><span class="op" id="3951432">.</span><span class="ident" id="3951433">TransferEncoding</span><span class="op" id="3951449">)</span>&nbsp;<span class="op" id="3951451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951456">t</span><span class="op" id="3951457">.</span><span class="ident" id="3951458">ContentLength</span>&nbsp;<span class="op" id="3951472">=</span>&nbsp;<span class="op" id="3951474">-</span><span class="num" id="3951475">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951479">}</span>&nbsp;<span class="keyword" id="3951481">else</span>&nbsp;<span class="keyword" id="3951486">if</span>&nbsp;<span class="ident" id="3951489">t</span><span class="op" id="3951490">.</span><span class="ident" id="3951491">Body</span>&nbsp;<span class="op" id="3951496">==</span>&nbsp;<span class="ident" id="3951499">nil</span>&nbsp;<span class="op" id="3951503">{</span>&nbsp;<span class="comment" id="3951505">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951532">t</span><span class="op" id="3951533">.</span><span class="ident" id="3951534">ContentLength</span>&nbsp;<span class="op" id="3951548">=</span>&nbsp;<span class="num" id="3951550">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951554">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3951561">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951582">if</span>&nbsp;<span class="op" id="3951585">!</span><span class="ident" id="3951586">chunked</span><span class="op" id="3951593">(</span><span class="ident" id="3951594">t</span><span class="op" id="3951595">.</span><span class="ident" id="3951596">TransferEncoding</span><span class="op" id="3951612">)</span>&nbsp;<span class="op" id="3951614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3951618">t</span><span class="op" id="3951619">.</span><span class="ident" id="3951620">Trailer</span>&nbsp;<span class="op" id="3951628">=</span>&nbsp;<span class="ident" id="3951630">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951639">return</span>&nbsp;<span class="ident" id="3951646">t</span><span class="op" id="3951647">,</span>&nbsp;<span class="ident" id="3951649">nil</span><br>
<span class="lineno"></span><span class="op" id="3951653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3951656">func</span>&nbsp;<span class="ident" id="3951661">noBodyExpected</span><span class="op" id="3951675">(</span><span class="ident" id="3951676">requestMethod</span>&nbsp;<span class="builtintype" id="3951690">string</span><span class="op" id="3951696">)</span>&nbsp;<span class="builtintype" id="3951698">bool</span>&nbsp;<span class="op" id="3951703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951706">return</span>&nbsp;<span class="ident" id="3951713">requestMethod</span>&nbsp;<span class="op" id="3951727">==</span>&nbsp;<span class="string" id="3951730">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3951737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3951740">func</span>&nbsp;<span class="op" id="3951745">(</span><span class="ident" id="3951746">t</span>&nbsp;<span class="op" id="3951748">*</span><span class="ident" id="3951749">transferWriter</span><span class="op" id="3951763">)</span>&nbsp;<span class="ident" id="3951765">shouldSendContentLength</span><span class="op" id="3951788">(</span><span class="op" id="3951789">)</span>&nbsp;<span class="builtintype" id="3951791">bool</span>&nbsp;<span class="op" id="3951796">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951799">if</span>&nbsp;<span class="ident" id="3951802">chunked</span><span class="op" id="3951809">(</span><span class="ident" id="3951810">t</span><span class="op" id="3951811">.</span><span class="ident" id="3951812">TransferEncoding</span><span class="op" id="3951828">)</span>&nbsp;<span class="op" id="3951830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951834">return</span>&nbsp;<span class="builtintype" id="3951841">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951851">if</span>&nbsp;<span class="ident" id="3951854">t</span><span class="op" id="3951855">.</span><span class="ident" id="3951856">ContentLength</span>&nbsp;<span class="op" id="3951870">&gt;</span>&nbsp;<span class="num" id="3951872">0</span>&nbsp;<span class="op" id="3951874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951878">return</span>&nbsp;<span class="builtintype" id="3951885">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3951891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3951894">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3951953">if</span>&nbsp;<span class="ident" id="3951956">t</span><span class="op" id="3951957">.</span><span class="ident" id="3951958">Method</span>&nbsp;<span class="op" id="3951965">==</span>&nbsp;<span class="string" id="3951968">&#34;POST&#34;</span>&nbsp;<span class="op" id="3951975">||</span>&nbsp;<span class="ident" id="3951978">t</span><span class="op" id="3951979">.</span><span class="ident" id="3951980">Method</span>&nbsp;<span class="op" id="3951987">==</span>&nbsp;<span class="string" id="3951990">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3951996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952000">return</span>&nbsp;<span class="builtintype" id="3952007">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952013">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952016">if</span>&nbsp;<span class="ident" id="3952019">t</span><span class="op" id="3952020">.</span><span class="ident" id="3952021">ContentLength</span>&nbsp;<span class="op" id="3952035">==</span>&nbsp;<span class="num" id="3952038">0</span>&nbsp;<span class="op" id="3952040">&amp;&amp;</span>&nbsp;<span class="ident" id="3952043">isIdentity</span><span class="op" id="3952053">(</span><span class="ident" id="3952054">t</span><span class="op" id="3952055">.</span><span class="ident" id="3952056">TransferEncoding</span><span class="op" id="3952072">)</span>&nbsp;<span class="op" id="3952074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952078">return</span>&nbsp;<span class="builtintype" id="3952085">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952095">return</span>&nbsp;<span class="builtintype" id="3952102">false</span><br>
<span class="lineno">150</span><span class="op" id="3952108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3952111">func</span>&nbsp;<span class="op" id="3952116">(</span><span class="ident" id="3952117">t</span>&nbsp;<span class="op" id="3952119">*</span><span class="ident" id="3952120">transferWriter</span><span class="op" id="3952134">)</span>&nbsp;<span class="ident" id="3952136">WriteHeader</span><span class="op" id="3952147">(</span><span class="ident" id="3952148">w</span>&nbsp;<span class="ident" id="3952150">io</span><span class="op" id="3952152">.</span><span class="ident" id="3952153">Writer</span><span class="op" id="3952159">)</span>&nbsp;<span class="builtintype" id="3952161">error</span>&nbsp;<span class="op" id="3952167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952170">if</span>&nbsp;<span class="ident" id="3952173">t</span><span class="op" id="3952174">.</span><span class="ident" id="3952175">Close</span>&nbsp;<span class="op" id="3952181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952185">if</span>&nbsp;<span class="ident" id="3952188">_</span><span class="op" id="3952189">,</span>&nbsp;<span class="ident" id="3952191">err</span>&nbsp;<span class="op" id="3952195">:=</span>&nbsp;<span class="ident" id="3952198">io</span><span class="op" id="3952200">.</span><span class="ident" id="3952201">WriteString</span><span class="op" id="3952212">(</span><span class="ident" id="3952213">w</span><span class="op" id="3952214">,</span>&nbsp;<span class="string" id="3952216">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3952239">)</span><span class="op" id="3952240">;</span>&nbsp;<span class="ident" id="3952242">err</span>&nbsp;<span class="op" id="3952246">!=</span>&nbsp;<span class="ident" id="3952249">nil</span>&nbsp;<span class="op" id="3952253">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952258">return</span>&nbsp;<span class="ident" id="3952265">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3952278">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3952347">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3952412">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952434">if</span>&nbsp;<span class="ident" id="3952437">t</span><span class="op" id="3952438">.</span><span class="ident" id="3952439">shouldSendContentLength</span><span class="op" id="3952462">(</span><span class="op" id="3952463">)</span>&nbsp;<span class="op" id="3952465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952469">if</span>&nbsp;<span class="ident" id="3952472">_</span><span class="op" id="3952473">,</span>&nbsp;<span class="ident" id="3952475">err</span>&nbsp;<span class="op" id="3952479">:=</span>&nbsp;<span class="ident" id="3952482">io</span><span class="op" id="3952484">.</span><span class="ident" id="3952485">WriteString</span><span class="op" id="3952496">(</span><span class="ident" id="3952497">w</span><span class="op" id="3952498">,</span>&nbsp;<span class="string" id="3952500">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3952518">)</span><span class="op" id="3952519">;</span>&nbsp;<span class="ident" id="3952521">err</span>&nbsp;<span class="op" id="3952525">!=</span>&nbsp;<span class="ident" id="3952528">nil</span>&nbsp;<span class="op" id="3952532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952537">return</span>&nbsp;<span class="ident" id="3952544">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952554">if</span>&nbsp;<span class="ident" id="3952557">_</span><span class="op" id="3952558">,</span>&nbsp;<span class="ident" id="3952560">err</span>&nbsp;<span class="op" id="3952564">:=</span>&nbsp;<span class="ident" id="3952567">io</span><span class="op" id="3952569">.</span><span class="ident" id="3952570">WriteString</span><span class="op" id="3952581">(</span><span class="ident" id="3952582">w</span><span class="op" id="3952583">,</span>&nbsp;<span class="ident" id="3952585">strconv</span><span class="op" id="3952592">.</span><span class="ident" id="3952593">FormatInt</span><span class="op" id="3952602">(</span><span class="ident" id="3952603">t</span><span class="op" id="3952604">.</span><span class="ident" id="3952605">ContentLength</span><span class="op" id="3952618">,</span>&nbsp;<span class="num" id="3952620">10</span><span class="op" id="3952622">)</span><span class="op" id="3952623">+</span><span class="string" id="3952624">&#34;\r\n&#34;</span><span class="op" id="3952630">)</span><span class="op" id="3952631">;</span>&nbsp;<span class="ident" id="3952633">err</span>&nbsp;<span class="op" id="3952637">!=</span>&nbsp;<span class="ident" id="3952640">nil</span>&nbsp;<span class="op" id="3952644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952649">return</span>&nbsp;<span class="ident" id="3952656">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952665">}</span>&nbsp;<span class="keyword" id="3952667">else</span>&nbsp;<span class="keyword" id="3952672">if</span>&nbsp;<span class="ident" id="3952675">chunked</span><span class="op" id="3952682">(</span><span class="ident" id="3952683">t</span><span class="op" id="3952684">.</span><span class="ident" id="3952685">TransferEncoding</span><span class="op" id="3952701">)</span>&nbsp;<span class="op" id="3952703">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952707">if</span>&nbsp;<span class="ident" id="3952710">_</span><span class="op" id="3952711">,</span>&nbsp;<span class="ident" id="3952713">err</span>&nbsp;<span class="op" id="3952717">:=</span>&nbsp;<span class="ident" id="3952720">io</span><span class="op" id="3952722">.</span><span class="ident" id="3952723">WriteString</span><span class="op" id="3952734">(</span><span class="ident" id="3952735">w</span><span class="op" id="3952736">,</span>&nbsp;<span class="string" id="3952738">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3952770">)</span><span class="op" id="3952771">;</span>&nbsp;<span class="ident" id="3952773">err</span>&nbsp;<span class="op" id="3952777">!=</span>&nbsp;<span class="ident" id="3952780">nil</span>&nbsp;<span class="op" id="3952784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952789">return</span>&nbsp;<span class="ident" id="3952796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3952805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3952809">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952834">if</span>&nbsp;<span class="ident" id="3952837">t</span><span class="op" id="3952838">.</span><span class="ident" id="3952839">Trailer</span>&nbsp;<span class="op" id="3952847">!=</span>&nbsp;<span class="ident" id="3952850">nil</span>&nbsp;<span class="op" id="3952854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3952858">keys</span>&nbsp;<span class="op" id="3952863">:=</span>&nbsp;<span class="builtinfunc" id="3952866">make</span><span class="op" id="3952870">(</span><span class="op" id="3952871">[</span><span class="op" id="3952872">]</span><span class="builtintype" id="3952873">string</span><span class="op" id="3952879">,</span>&nbsp;<span class="num" id="3952881">0</span><span class="op" id="3952882">,</span>&nbsp;<span class="builtinfunc" id="3952884">len</span><span class="op" id="3952887">(</span><span class="ident" id="3952888">t</span><span class="op" id="3952889">.</span><span class="ident" id="3952890">Trailer</span><span class="op" id="3952897">)</span><span class="op" id="3952898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952902">for</span>&nbsp;<span class="ident" id="3952906">k</span>&nbsp;<span class="op" id="3952908">:=</span>&nbsp;<span class="keyword" id="3952911">range</span>&nbsp;<span class="ident" id="3952917">t</span><span class="op" id="3952918">.</span><span class="ident" id="3952919">Trailer</span>&nbsp;<span class="op" id="3952927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3952932">k</span>&nbsp;<span class="op" id="3952934">=</span>&nbsp;<span class="ident" id="3952936">CanonicalHeaderKey</span><span class="op" id="3952954">(</span><span class="ident" id="3952955">k</span><span class="op" id="3952956">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952961">switch</span>&nbsp;<span class="ident" id="3952968">k</span>&nbsp;<span class="op" id="3952970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3952975">case</span>&nbsp;<span class="string" id="3952980">&#34;Transfer-Encoding&#34;</span><span class="op" id="3952999">,</span>&nbsp;<span class="string" id="3953001">&#34;Trailer&#34;</span><span class="op" id="3953010">,</span>&nbsp;<span class="string" id="3953012">&#34;Content-Length&#34;</span><span class="op" id="3953028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953034">return</span>&nbsp;<span class="op" id="3953041">&amp;</span><span class="ident" id="3953042">badStringError</span><span class="op" id="3953056">{</span><span class="string" id="3953057">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3953078">,</span>&nbsp;<span class="ident" id="3953080">k</span><span class="op" id="3953081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953091">keys</span>&nbsp;<span class="op" id="3953096">=</span>&nbsp;<span class="builtinfunc" id="3953098">append</span><span class="op" id="3953104">(</span><span class="ident" id="3953105">keys</span><span class="op" id="3953109">,</span>&nbsp;<span class="ident" id="3953111">k</span><span class="op" id="3953112">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953120">if</span>&nbsp;<span class="builtinfunc" id="3953123">len</span><span class="op" id="3953126">(</span><span class="ident" id="3953127">keys</span><span class="op" id="3953131">)</span>&nbsp;<span class="op" id="3953133">&gt;</span>&nbsp;<span class="num" id="3953135">0</span>&nbsp;<span class="op" id="3953137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953142">sort</span><span class="op" id="3953146">.</span><span class="ident" id="3953147">Strings</span><span class="op" id="3953154">(</span><span class="ident" id="3953155">keys</span><span class="op" id="3953159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3953164">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3953237">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953266">if</span>&nbsp;<span class="ident" id="3953269">_</span><span class="op" id="3953270">,</span>&nbsp;<span class="ident" id="3953272">err</span>&nbsp;<span class="op" id="3953276">:=</span>&nbsp;<span class="ident" id="3953279">io</span><span class="op" id="3953281">.</span><span class="ident" id="3953282">WriteString</span><span class="op" id="3953293">(</span><span class="ident" id="3953294">w</span><span class="op" id="3953295">,</span>&nbsp;<span class="string" id="3953297">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3953308">+</span><span class="ident" id="3953309">strings</span><span class="op" id="3953316">.</span><span class="ident" id="3953317">Join</span><span class="op" id="3953321">(</span><span class="ident" id="3953322">keys</span><span class="op" id="3953326">,</span>&nbsp;<span class="string" id="3953328">&#34;,&#34;</span><span class="op" id="3953331">)</span><span class="op" id="3953332">+</span><span class="string" id="3953333">&#34;\r\n&#34;</span><span class="op" id="3953339">)</span><span class="op" id="3953340">;</span>&nbsp;<span class="ident" id="3953342">err</span>&nbsp;<span class="op" id="3953346">!=</span>&nbsp;<span class="ident" id="3953349">nil</span>&nbsp;<span class="op" id="3953353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953359">return</span>&nbsp;<span class="ident" id="3953366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953380">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953384">return</span>&nbsp;<span class="ident" id="3953391">nil</span><br>
<span class="lineno"></span><span class="op" id="3953395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3953398">func</span>&nbsp;<span class="op" id="3953403">(</span><span class="ident" id="3953404">t</span>&nbsp;<span class="op" id="3953406">*</span><span class="ident" id="3953407">transferWriter</span><span class="op" id="3953421">)</span>&nbsp;<span class="ident" id="3953423">WriteBody</span><span class="op" id="3953432">(</span><span class="ident" id="3953433">w</span>&nbsp;<span class="ident" id="3953435">io</span><span class="op" id="3953437">.</span><span class="ident" id="3953438">Writer</span><span class="op" id="3953444">)</span>&nbsp;<span class="builtintype" id="3953446">error</span>&nbsp;<span class="op" id="3953452">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953455">var</span>&nbsp;<span class="ident" id="3953459">err</span>&nbsp;<span class="builtintype" id="3953463">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953470">var</span>&nbsp;<span class="ident" id="3953474">ncopy</span>&nbsp;<span class="ident" id="3953480">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3953488">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953503">if</span>&nbsp;<span class="ident" id="3953506">t</span><span class="op" id="3953507">.</span><span class="ident" id="3953508">Body</span>&nbsp;<span class="op" id="3953513">!=</span>&nbsp;<span class="ident" id="3953516">nil</span>&nbsp;<span class="op" id="3953520">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953524">if</span>&nbsp;<span class="ident" id="3953527">chunked</span><span class="op" id="3953534">(</span><span class="ident" id="3953535">t</span><span class="op" id="3953536">.</span><span class="ident" id="3953537">TransferEncoding</span><span class="op" id="3953553">)</span>&nbsp;<span class="op" id="3953555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953560">cw</span>&nbsp;<span class="op" id="3953563">:=</span>&nbsp;<span class="ident" id="3953566">internal</span><span class="op" id="3953574">.</span><span class="ident" id="3953575">NewChunkedWriter</span><span class="op" id="3953591">(</span><span class="ident" id="3953592">w</span><span class="op" id="3953593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953598">_</span><span class="op" id="3953599">,</span>&nbsp;<span class="ident" id="3953601">err</span>&nbsp;<span class="op" id="3953605">=</span>&nbsp;<span class="ident" id="3953607">io</span><span class="op" id="3953609">.</span><span class="ident" id="3953610">Copy</span><span class="op" id="3953614">(</span><span class="ident" id="3953615">cw</span><span class="op" id="3953617">,</span>&nbsp;<span class="ident" id="3953619">t</span><span class="op" id="3953620">.</span><span class="ident" id="3953621">Body</span><span class="op" id="3953625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953630">if</span>&nbsp;<span class="ident" id="3953633">err</span>&nbsp;<span class="op" id="3953637">==</span>&nbsp;<span class="ident" id="3953640">nil</span>&nbsp;<span class="op" id="3953644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953650">err</span>&nbsp;<span class="op" id="3953654">=</span>&nbsp;<span class="ident" id="3953656">cw</span><span class="op" id="3953658">.</span><span class="ident" id="3953659">Close</span><span class="op" id="3953664">(</span><span class="op" id="3953665">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953674">}</span>&nbsp;<span class="keyword" id="3953676">else</span>&nbsp;<span class="keyword" id="3953681">if</span>&nbsp;<span class="ident" id="3953684">t</span><span class="op" id="3953685">.</span><span class="ident" id="3953686">ContentLength</span>&nbsp;<span class="op" id="3953700">==</span>&nbsp;<span class="op" id="3953703">-</span><span class="num" id="3953704">1</span>&nbsp;<span class="op" id="3953706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953711">ncopy</span><span class="op" id="3953716">,</span>&nbsp;<span class="ident" id="3953718">err</span>&nbsp;<span class="op" id="3953722">=</span>&nbsp;<span class="ident" id="3953724">io</span><span class="op" id="3953726">.</span><span class="ident" id="3953727">Copy</span><span class="op" id="3953731">(</span><span class="ident" id="3953732">w</span><span class="op" id="3953733">,</span>&nbsp;<span class="ident" id="3953735">t</span><span class="op" id="3953736">.</span><span class="ident" id="3953737">Body</span><span class="op" id="3953741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953745">}</span>&nbsp;<span class="keyword" id="3953747">else</span>&nbsp;<span class="op" id="3953752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953757">ncopy</span><span class="op" id="3953762">,</span>&nbsp;<span class="ident" id="3953764">err</span>&nbsp;<span class="op" id="3953768">=</span>&nbsp;<span class="ident" id="3953770">io</span><span class="op" id="3953772">.</span><span class="ident" id="3953773">Copy</span><span class="op" id="3953777">(</span><span class="ident" id="3953778">w</span><span class="op" id="3953779">,</span>&nbsp;<span class="ident" id="3953781">io</span><span class="op" id="3953783">.</span><span class="ident" id="3953784">LimitReader</span><span class="op" id="3953795">(</span><span class="ident" id="3953796">t</span><span class="op" id="3953797">.</span><span class="ident" id="3953798">Body</span><span class="op" id="3953802">,</span>&nbsp;<span class="ident" id="3953804">t</span><span class="op" id="3953805">.</span><span class="ident" id="3953806">ContentLength</span><span class="op" id="3953819">)</span><span class="op" id="3953820">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953825">if</span>&nbsp;<span class="ident" id="3953828">err</span>&nbsp;<span class="op" id="3953832">!=</span>&nbsp;<span class="ident" id="3953835">nil</span>&nbsp;<span class="op" id="3953839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953845">return</span>&nbsp;<span class="ident" id="3953852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953864">var</span>&nbsp;<span class="ident" id="3953868">nextra</span>&nbsp;<span class="ident" id="3953875">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953884">nextra</span><span class="op" id="3953890">,</span>&nbsp;<span class="ident" id="3953892">err</span>&nbsp;<span class="op" id="3953896">=</span>&nbsp;<span class="ident" id="3953898">io</span><span class="op" id="3953900">.</span><span class="ident" id="3953901">Copy</span><span class="op" id="3953905">(</span><span class="ident" id="3953906">ioutil</span><span class="op" id="3953912">.</span><span class="ident" id="3953913">Discard</span><span class="op" id="3953920">,</span>&nbsp;<span class="ident" id="3953922">t</span><span class="op" id="3953923">.</span><span class="ident" id="3953924">Body</span><span class="op" id="3953928">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3953933">ncopy</span>&nbsp;<span class="op" id="3953939">+=</span>&nbsp;<span class="ident" id="3953942">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953955">if</span>&nbsp;<span class="ident" id="3953958">err</span>&nbsp;<span class="op" id="3953962">!=</span>&nbsp;<span class="ident" id="3953965">nil</span>&nbsp;<span class="op" id="3953969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953974">return</span>&nbsp;<span class="ident" id="3953981">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3953987">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3953991">if</span>&nbsp;<span class="ident" id="3953994">err</span>&nbsp;<span class="op" id="3953998">=</span>&nbsp;<span class="ident" id="3954000">t</span><span class="op" id="3954001">.</span><span class="ident" id="3954002">BodyCloser</span><span class="op" id="3954012">.</span><span class="ident" id="3954013">Close</span><span class="op" id="3954018">(</span><span class="op" id="3954019">)</span><span class="op" id="3954020">;</span>&nbsp;<span class="ident" id="3954022">err</span>&nbsp;<span class="op" id="3954026">!=</span>&nbsp;<span class="ident" id="3954029">nil</span>&nbsp;<span class="op" id="3954033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954038">return</span>&nbsp;<span class="ident" id="3954045">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954058">if</span>&nbsp;<span class="op" id="3954061">!</span><span class="ident" id="3954062">t</span><span class="op" id="3954063">.</span><span class="ident" id="3954064">ResponseToHEAD</span>&nbsp;<span class="op" id="3954079">&amp;&amp;</span>&nbsp;<span class="ident" id="3954082">t</span><span class="op" id="3954083">.</span><span class="ident" id="3954084">ContentLength</span>&nbsp;<span class="op" id="3954098">!=</span>&nbsp;<span class="op" id="3954101">-</span><span class="num" id="3954102">1</span>&nbsp;<span class="op" id="3954104">&amp;&amp;</span>&nbsp;<span class="ident" id="3954107">t</span><span class="op" id="3954108">.</span><span class="ident" id="3954109">ContentLength</span>&nbsp;<span class="op" id="3954123">!=</span>&nbsp;<span class="ident" id="3954126">ncopy</span>&nbsp;<span class="op" id="3954132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954136">return</span>&nbsp;<span class="ident" id="3954143">fmt</span><span class="op" id="3954146">.</span><span class="ident" id="3954147">Errorf</span><span class="op" id="3954153">(</span><span class="string" id="3954154">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3954198">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954203">t</span><span class="op" id="3954204">.</span><span class="ident" id="3954205">ContentLength</span><span class="op" id="3954218">,</span>&nbsp;<span class="ident" id="3954220">ncopy</span><span class="op" id="3954225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3954232">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954281">if</span>&nbsp;<span class="ident" id="3954284">chunked</span><span class="op" id="3954291">(</span><span class="ident" id="3954292">t</span><span class="op" id="3954293">.</span><span class="ident" id="3954294">TransferEncoding</span><span class="op" id="3954310">)</span>&nbsp;<span class="op" id="3954312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3954316">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954342">if</span>&nbsp;<span class="ident" id="3954345">t</span><span class="op" id="3954346">.</span><span class="ident" id="3954347">Trailer</span>&nbsp;<span class="op" id="3954355">!=</span>&nbsp;<span class="ident" id="3954358">nil</span>&nbsp;<span class="op" id="3954362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954367">if</span>&nbsp;<span class="ident" id="3954370">err</span>&nbsp;<span class="op" id="3954374">:=</span>&nbsp;<span class="ident" id="3954377">t</span><span class="op" id="3954378">.</span><span class="ident" id="3954379">Trailer</span><span class="op" id="3954386">.</span><span class="ident" id="3954387">Write</span><span class="op" id="3954392">(</span><span class="ident" id="3954393">w</span><span class="op" id="3954394">)</span><span class="op" id="3954395">;</span>&nbsp;<span class="ident" id="3954397">err</span>&nbsp;<span class="op" id="3954401">!=</span>&nbsp;<span class="ident" id="3954404">nil</span>&nbsp;<span class="op" id="3954408">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954414">return</span>&nbsp;<span class="ident" id="3954421">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3954436">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954467">_</span><span class="op" id="3954468">,</span>&nbsp;<span class="ident" id="3954470">err</span>&nbsp;<span class="op" id="3954474">=</span>&nbsp;<span class="ident" id="3954476">io</span><span class="op" id="3954478">.</span><span class="ident" id="3954479">WriteString</span><span class="op" id="3954490">(</span><span class="ident" id="3954491">w</span><span class="op" id="3954492">,</span>&nbsp;<span class="string" id="3954494">&#34;\r\n&#34;</span><span class="op" id="3954500">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3954503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954506">return</span>&nbsp;<span class="ident" id="3954513">err</span><br>
<span class="lineno"></span><span class="op" id="3954517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3954520">type</span>&nbsp;<span class="ident" id="3954525">transferReader</span>&nbsp;<span class="keyword" id="3954540">struct</span>&nbsp;<span class="op" id="3954547">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3954550">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954560">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954574">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954582">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3954596">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954601">RequestMethod</span>&nbsp;<span class="builtintype" id="3954615">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954623">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3954637">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954642">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3954656">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3954661">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954672">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954689">io</span><span class="op" id="3954691">.</span><span class="ident" id="3954692">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954704">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954721">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954728">TransferEncoding</span>&nbsp;<span class="op" id="3954745">[</span><span class="op" id="3954746">]</span><span class="builtintype" id="3954747">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954755">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3954772">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3954778">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3954795">Header</span><br>
<span class="lineno"></span><span class="op" id="3954802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3954805">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3954874">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3954920">func</span>&nbsp;<span class="ident" id="3954925">bodyAllowedForStatus</span><span class="op" id="3954945">(</span><span class="ident" id="3954946">status</span>&nbsp;<span class="builtintype" id="3954953">int</span><span class="op" id="3954956">)</span>&nbsp;<span class="builtintype" id="3954958">bool</span>&nbsp;<span class="op" id="3954963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954966">switch</span>&nbsp;<span class="op" id="3954973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3954976">case</span>&nbsp;<span class="ident" id="3954981">status</span>&nbsp;<span class="op" id="3954988">&gt;=</span>&nbsp;<span class="num" id="3954991">100</span>&nbsp;<span class="op" id="3954995">&amp;&amp;</span>&nbsp;<span class="ident" id="3954998">status</span>&nbsp;<span class="op" id="3955005">&lt;=</span>&nbsp;<span class="num" id="3955008">199</span><span class="op" id="3955011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955015">return</span>&nbsp;<span class="builtintype" id="3955022">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955029">case</span>&nbsp;<span class="ident" id="3955034">status</span>&nbsp;<span class="op" id="3955041">==</span>&nbsp;<span class="num" id="3955044">204</span><span class="op" id="3955047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955051">return</span>&nbsp;<span class="builtintype" id="3955058">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955065">case</span>&nbsp;<span class="ident" id="3955070">status</span>&nbsp;<span class="op" id="3955077">==</span>&nbsp;<span class="num" id="3955080">304</span><span class="op" id="3955083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955087">return</span>&nbsp;<span class="builtintype" id="3955094">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3955101">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955104">return</span>&nbsp;<span class="builtintype" id="3955111">true</span><br>
<span class="lineno"></span><span class="op" id="3955116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3955119">var</span>&nbsp;<span class="op" id="3955123">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955126">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3955150">=</span>&nbsp;<span class="op" id="3955152">[</span><span class="op" id="3955153">]</span><span class="builtintype" id="3955154">string</span><span class="op" id="3955160">{</span><span class="string" id="3955161">&#34;Content-Type&#34;</span><span class="op" id="3955175">,</span>&nbsp;<span class="string" id="3955177">&#34;Content-Length&#34;</span><span class="op" id="3955193">,</span>&nbsp;<span class="string" id="3955195">&#34;Transfer-Encoding&#34;</span><span class="op" id="3955214">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955217">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3955241">=</span>&nbsp;<span class="op" id="3955243">[</span><span class="op" id="3955244">]</span><span class="builtintype" id="3955245">string</span><span class="op" id="3955251">{</span><span class="string" id="3955252">&#34;Content-Length&#34;</span><span class="op" id="3955268">,</span>&nbsp;<span class="string" id="3955270">&#34;Transfer-Encoding&#34;</span><span class="op" id="3955289">}</span><br>
<span class="lineno"></span><span class="op" id="3955291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3955294">func</span>&nbsp;<span class="ident" id="3955299">suppressedHeaders</span><span class="op" id="3955316">(</span><span class="ident" id="3955317">status</span>&nbsp;<span class="builtintype" id="3955324">int</span><span class="op" id="3955327">)</span>&nbsp;<span class="op" id="3955329">[</span><span class="op" id="3955330">]</span><span class="builtintype" id="3955331">string</span>&nbsp;<span class="op" id="3955338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955341">switch</span>&nbsp;<span class="op" id="3955348">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955351">case</span>&nbsp;<span class="ident" id="3955356">status</span>&nbsp;<span class="op" id="3955363">==</span>&nbsp;<span class="num" id="3955366">304</span><span class="op" id="3955369">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3955373">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955456">return</span>&nbsp;<span class="ident" id="3955463">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955485">case</span>&nbsp;<span class="op" id="3955490">!</span><span class="ident" id="3955491">bodyAllowedForStatus</span><span class="op" id="3955511">(</span><span class="ident" id="3955512">status</span><span class="op" id="3955518">)</span><span class="op" id="3955519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955523">return</span>&nbsp;<span class="ident" id="3955530">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3955555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955558">return</span>&nbsp;<span class="ident" id="3955565">nil</span><br>
<span class="lineno"></span><span class="op" id="3955569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3955572">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3955605">func</span>&nbsp;<span class="ident" id="3955610">readTransfer</span><span class="op" id="3955622">(</span><span class="ident" id="3955623">msg</span>&nbsp;<span class="keyword" id="3955627">interface</span><span class="op" id="3955636">{</span><span class="op" id="3955637">}</span><span class="op" id="3955638">,</span>&nbsp;<span class="ident" id="3955640">r</span>&nbsp;<span class="op" id="3955642">*</span><span class="ident" id="3955643">bufio</span><span class="op" id="3955648">.</span><span class="ident" id="3955649">Reader</span><span class="op" id="3955655">)</span>&nbsp;<span class="op" id="3955657">(</span><span class="ident" id="3955658">err</span>&nbsp;<span class="builtintype" id="3955662">error</span><span class="op" id="3955667">)</span>&nbsp;<span class="op" id="3955669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955672">t</span>&nbsp;<span class="op" id="3955674">:=</span>&nbsp;<span class="op" id="3955677">&amp;</span><span class="ident" id="3955678">transferReader</span><span class="op" id="3955692">{</span><span class="ident" id="3955693">RequestMethod</span><span class="op" id="3955706">:</span>&nbsp;<span class="string" id="3955708">&#34;GET&#34;</span><span class="op" id="3955713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3955717">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955733">isResponse</span>&nbsp;<span class="op" id="3955744">:=</span>&nbsp;<span class="builtintype" id="3955747">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955754">switch</span>&nbsp;<span class="ident" id="3955761">rr</span>&nbsp;<span class="op" id="3955764">:=</span>&nbsp;<span class="ident" id="3955767">msg</span><span class="op" id="3955770">.</span><span class="op" id="3955771">(</span><span class="keyword" id="3955772">type</span><span class="op" id="3955776">)</span>&nbsp;<span class="op" id="3955778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3955781">case</span>&nbsp;<span class="op" id="3955786">*</span><span class="ident" id="3955787">Response</span><span class="op" id="3955795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955799">t</span><span class="op" id="3955800">.</span><span class="ident" id="3955801">Header</span>&nbsp;<span class="op" id="3955808">=</span>&nbsp;<span class="ident" id="3955810">rr</span><span class="op" id="3955812">.</span><span class="ident" id="3955813">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955822">t</span><span class="op" id="3955823">.</span><span class="ident" id="3955824">StatusCode</span>&nbsp;<span class="op" id="3955835">=</span>&nbsp;<span class="ident" id="3955837">rr</span><span class="op" id="3955839">.</span><span class="ident" id="3955840">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955853">t</span><span class="op" id="3955854">.</span><span class="ident" id="3955855">ProtoMajor</span>&nbsp;<span class="op" id="3955866">=</span>&nbsp;<span class="ident" id="3955868">rr</span><span class="op" id="3955870">.</span><span class="ident" id="3955871">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955884">t</span><span class="op" id="3955885">.</span><span class="ident" id="3955886">ProtoMinor</span>&nbsp;<span class="op" id="3955897">=</span>&nbsp;<span class="ident" id="3955899">rr</span><span class="op" id="3955901">.</span><span class="ident" id="3955902">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955915">t</span><span class="op" id="3955916">.</span><span class="ident" id="3955917">Close</span>&nbsp;<span class="op" id="3955923">=</span>&nbsp;<span class="ident" id="3955925">shouldClose</span><span class="op" id="3955936">(</span><span class="ident" id="3955937">t</span><span class="op" id="3955938">.</span><span class="ident" id="3955939">ProtoMajor</span><span class="op" id="3955949">,</span>&nbsp;<span class="ident" id="3955951">t</span><span class="op" id="3955952">.</span><span class="ident" id="3955953">ProtoMinor</span><span class="op" id="3955963">,</span>&nbsp;<span class="ident" id="3955965">t</span><span class="op" id="3955966">.</span><span class="ident" id="3955967">Header</span><span class="op" id="3955973">,</span>&nbsp;<span class="builtintype" id="3955975">true</span><span class="op" id="3955979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3955983">isResponse</span>&nbsp;<span class="op" id="3955994">=</span>&nbsp;<span class="builtintype" id="3955996">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956003">if</span>&nbsp;<span class="ident" id="3956006">rr</span><span class="op" id="3956008">.</span><span class="ident" id="3956009">Request</span>&nbsp;<span class="op" id="3956017">!=</span>&nbsp;<span class="ident" id="3956020">nil</span>&nbsp;<span class="op" id="3956024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956029">t</span><span class="op" id="3956030">.</span><span class="ident" id="3956031">RequestMethod</span>&nbsp;<span class="op" id="3956045">=</span>&nbsp;<span class="ident" id="3956047">rr</span><span class="op" id="3956049">.</span><span class="ident" id="3956050">Request</span><span class="op" id="3956057">.</span><span class="ident" id="3956058">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956070">case</span>&nbsp;<span class="op" id="3956075">*</span><span class="ident" id="3956076">Request</span><span class="op" id="3956083">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956087">t</span><span class="op" id="3956088">.</span><span class="ident" id="3956089">Header</span>&nbsp;<span class="op" id="3956096">=</span>&nbsp;<span class="ident" id="3956098">rr</span><span class="op" id="3956100">.</span><span class="ident" id="3956101">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956110">t</span><span class="op" id="3956111">.</span><span class="ident" id="3956112">ProtoMajor</span>&nbsp;<span class="op" id="3956123">=</span>&nbsp;<span class="ident" id="3956125">rr</span><span class="op" id="3956127">.</span><span class="ident" id="3956128">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956141">t</span><span class="op" id="3956142">.</span><span class="ident" id="3956143">ProtoMinor</span>&nbsp;<span class="op" id="3956154">=</span>&nbsp;<span class="ident" id="3956156">rr</span><span class="op" id="3956158">.</span><span class="ident" id="3956159">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3956172">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3956236">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956300">t</span><span class="op" id="3956301">.</span><span class="ident" id="3956302">StatusCode</span>&nbsp;<span class="op" id="3956313">=</span>&nbsp;<span class="num" id="3956315">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956320">default</span><span class="op" id="3956327">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3956331">panic</span><span class="op" id="3956336">(</span><span class="string" id="3956337">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3956354">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3956361">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956385">if</span>&nbsp;<span class="ident" id="3956388">t</span><span class="op" id="3956389">.</span><span class="ident" id="3956390">ProtoMajor</span>&nbsp;<span class="op" id="3956401">==</span>&nbsp;<span class="num" id="3956404">0</span>&nbsp;<span class="op" id="3956406">&amp;&amp;</span>&nbsp;<span class="ident" id="3956409">t</span><span class="op" id="3956410">.</span><span class="ident" id="3956411">ProtoMinor</span>&nbsp;<span class="op" id="3956422">==</span>&nbsp;<span class="num" id="3956425">0</span>&nbsp;<span class="op" id="3956427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956431">t</span><span class="op" id="3956432">.</span><span class="ident" id="3956433">ProtoMajor</span><span class="op" id="3956443">,</span>&nbsp;<span class="ident" id="3956445">t</span><span class="op" id="3956446">.</span><span class="ident" id="3956447">ProtoMinor</span>&nbsp;<span class="op" id="3956458">=</span>&nbsp;<span class="num" id="3956460">1</span><span class="op" id="3956461">,</span>&nbsp;<span class="num" id="3956463">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3956470">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956508">t</span><span class="op" id="3956509">.</span><span class="ident" id="3956510">TransferEncoding</span><span class="op" id="3956526">,</span>&nbsp;<span class="ident" id="3956528">err</span>&nbsp;<span class="op" id="3956532">=</span>&nbsp;<span class="ident" id="3956534">fixTransferEncoding</span><span class="op" id="3956553">(</span><span class="ident" id="3956554">t</span><span class="op" id="3956555">.</span><span class="ident" id="3956556">RequestMethod</span><span class="op" id="3956569">,</span>&nbsp;<span class="ident" id="3956571">t</span><span class="op" id="3956572">.</span><span class="ident" id="3956573">Header</span><span class="op" id="3956579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956582">if</span>&nbsp;<span class="ident" id="3956585">err</span>&nbsp;<span class="op" id="3956589">!=</span>&nbsp;<span class="ident" id="3956592">nil</span>&nbsp;<span class="op" id="3956596">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956600">return</span>&nbsp;<span class="ident" id="3956607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956616">realLength</span><span class="op" id="3956626">,</span>&nbsp;<span class="ident" id="3956628">err</span>&nbsp;<span class="op" id="3956632">:=</span>&nbsp;<span class="ident" id="3956635">fixLength</span><span class="op" id="3956644">(</span><span class="ident" id="3956645">isResponse</span><span class="op" id="3956655">,</span>&nbsp;<span class="ident" id="3956657">t</span><span class="op" id="3956658">.</span><span class="ident" id="3956659">StatusCode</span><span class="op" id="3956669">,</span>&nbsp;<span class="ident" id="3956671">t</span><span class="op" id="3956672">.</span><span class="ident" id="3956673">RequestMethod</span><span class="op" id="3956686">,</span>&nbsp;<span class="ident" id="3956688">t</span><span class="op" id="3956689">.</span><span class="ident" id="3956690">Header</span><span class="op" id="3956696">,</span>&nbsp;<span class="ident" id="3956698">t</span><span class="op" id="3956699">.</span><span class="ident" id="3956700">TransferEncoding</span><span class="op" id="3956716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956719">if</span>&nbsp;<span class="ident" id="3956722">err</span>&nbsp;<span class="op" id="3956726">!=</span>&nbsp;<span class="ident" id="3956729">nil</span>&nbsp;<span class="op" id="3956733">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956737">return</span>&nbsp;<span class="ident" id="3956744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956752">if</span>&nbsp;<span class="ident" id="3956755">isResponse</span>&nbsp;<span class="op" id="3956766">&amp;&amp;</span>&nbsp;<span class="ident" id="3956769">t</span><span class="op" id="3956770">.</span><span class="ident" id="3956771">RequestMethod</span>&nbsp;<span class="op" id="3956785">==</span>&nbsp;<span class="string" id="3956788">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3956795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956799">if</span>&nbsp;<span class="ident" id="3956802">n</span><span class="op" id="3956803">,</span>&nbsp;<span class="ident" id="3956805">err</span>&nbsp;<span class="op" id="3956809">:=</span>&nbsp;<span class="ident" id="3956812">parseContentLength</span><span class="op" id="3956830">(</span><span class="ident" id="3956831">t</span><span class="op" id="3956832">.</span><span class="ident" id="3956833">Header</span><span class="op" id="3956839">.</span><span class="ident" id="3956840">get</span><span class="op" id="3956843">(</span><span class="string" id="3956844">&#34;Content-Length&#34;</span><span class="op" id="3956860">)</span><span class="op" id="3956861">)</span><span class="op" id="3956862">;</span>&nbsp;<span class="ident" id="3956864">err</span>&nbsp;<span class="op" id="3956868">!=</span>&nbsp;<span class="ident" id="3956871">nil</span>&nbsp;<span class="op" id="3956875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3956880">return</span>&nbsp;<span class="ident" id="3956887">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956893">}</span>&nbsp;<span class="keyword" id="3956895">else</span>&nbsp;<span class="op" id="3956900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956905">t</span><span class="op" id="3956906">.</span><span class="ident" id="3956907">ContentLength</span>&nbsp;<span class="op" id="3956921">=</span>&nbsp;<span class="ident" id="3956923">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956930">}</span>&nbsp;<span class="keyword" id="3956932">else</span>&nbsp;<span class="op" id="3956937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956941">t</span><span class="op" id="3956942">.</span><span class="ident" id="3956943">ContentLength</span>&nbsp;<span class="op" id="3956957">=</span>&nbsp;<span class="ident" id="3956959">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3956971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3956975">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3956987">t</span><span class="op" id="3956988">.</span><span class="ident" id="3956989">Trailer</span><span class="op" id="3956996">,</span>&nbsp;<span class="ident" id="3956998">err</span>&nbsp;<span class="op" id="3957002">=</span>&nbsp;<span class="ident" id="3957004">fixTrailer</span><span class="op" id="3957014">(</span><span class="ident" id="3957015">t</span><span class="op" id="3957016">.</span><span class="ident" id="3957017">Header</span><span class="op" id="3957023">,</span>&nbsp;<span class="ident" id="3957025">t</span><span class="op" id="3957026">.</span><span class="ident" id="3957027">TransferEncoding</span><span class="op" id="3957043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957046">if</span>&nbsp;<span class="ident" id="3957049">err</span>&nbsp;<span class="op" id="3957053">!=</span>&nbsp;<span class="ident" id="3957056">nil</span>&nbsp;<span class="op" id="3957060">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957064">return</span>&nbsp;<span class="ident" id="3957071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957080">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957158">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957229">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957259">switch</span>&nbsp;<span class="ident" id="3957266">msg</span><span class="op" id="3957269">.</span><span class="op" id="3957270">(</span><span class="keyword" id="3957271">type</span><span class="op" id="3957275">)</span>&nbsp;<span class="op" id="3957277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957280">case</span>&nbsp;<span class="op" id="3957285">*</span><span class="ident" id="3957286">Response</span><span class="op" id="3957294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957298">if</span>&nbsp;<span class="ident" id="3957301">realLength</span>&nbsp;<span class="op" id="3957312">==</span>&nbsp;<span class="op" id="3957315">-</span><span class="num" id="3957316">1</span>&nbsp;<span class="op" id="3957318">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957324">!</span><span class="ident" id="3957325">chunked</span><span class="op" id="3957332">(</span><span class="ident" id="3957333">t</span><span class="op" id="3957334">.</span><span class="ident" id="3957335">TransferEncoding</span><span class="op" id="3957351">)</span>&nbsp;<span class="op" id="3957353">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957359">bodyAllowedForStatus</span><span class="op" id="3957379">(</span><span class="ident" id="3957380">t</span><span class="op" id="3957381">.</span><span class="ident" id="3957382">StatusCode</span><span class="op" id="3957392">)</span>&nbsp;<span class="op" id="3957394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957399">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957421">t</span><span class="op" id="3957422">.</span><span class="ident" id="3957423">Close</span>&nbsp;<span class="op" id="3957429">=</span>&nbsp;<span class="builtintype" id="3957431">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957441">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957445">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957512">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957588">switch</span>&nbsp;<span class="op" id="3957595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957598">case</span>&nbsp;<span class="ident" id="3957603">chunked</span><span class="op" id="3957610">(</span><span class="ident" id="3957611">t</span><span class="op" id="3957612">.</span><span class="ident" id="3957613">TransferEncoding</span><span class="op" id="3957629">)</span><span class="op" id="3957630">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957634">if</span>&nbsp;<span class="ident" id="3957637">noBodyExpected</span><span class="op" id="3957651">(</span><span class="ident" id="3957652">t</span><span class="op" id="3957653">.</span><span class="ident" id="3957654">RequestMethod</span><span class="op" id="3957667">)</span>&nbsp;<span class="op" id="3957669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957674">t</span><span class="op" id="3957675">.</span><span class="ident" id="3957676">Body</span>&nbsp;<span class="op" id="3957681">=</span>&nbsp;<span class="ident" id="3957683">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957695">}</span>&nbsp;<span class="keyword" id="3957697">else</span>&nbsp;<span class="op" id="3957702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957707">t</span><span class="op" id="3957708">.</span><span class="ident" id="3957709">Body</span>&nbsp;<span class="op" id="3957714">=</span>&nbsp;<span class="op" id="3957716">&amp;</span><span class="ident" id="3957717">body</span><span class="op" id="3957721">{</span><span class="ident" id="3957722">src</span><span class="op" id="3957725">:</span>&nbsp;<span class="ident" id="3957727">internal</span><span class="op" id="3957735">.</span><span class="ident" id="3957736">NewChunkedReader</span><span class="op" id="3957752">(</span><span class="ident" id="3957753">r</span><span class="op" id="3957754">)</span><span class="op" id="3957755">,</span>&nbsp;<span class="ident" id="3957757">hdr</span><span class="op" id="3957760">:</span>&nbsp;<span class="ident" id="3957762">msg</span><span class="op" id="3957765">,</span>&nbsp;<span class="ident" id="3957767">r</span><span class="op" id="3957768">:</span>&nbsp;<span class="ident" id="3957770">r</span><span class="op" id="3957771">,</span>&nbsp;<span class="ident" id="3957773">closing</span><span class="op" id="3957780">:</span>&nbsp;<span class="ident" id="3957782">t</span><span class="op" id="3957783">.</span><span class="ident" id="3957784">Close</span><span class="op" id="3957789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3957793">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957796">case</span>&nbsp;<span class="ident" id="3957801">realLength</span>&nbsp;<span class="op" id="3957812">==</span>&nbsp;<span class="num" id="3957815">0</span><span class="op" id="3957816">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957820">t</span><span class="op" id="3957821">.</span><span class="ident" id="3957822">Body</span>&nbsp;<span class="op" id="3957827">=</span>&nbsp;<span class="ident" id="3957829">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957840">case</span>&nbsp;<span class="ident" id="3957845">realLength</span>&nbsp;<span class="op" id="3957856">&gt;</span>&nbsp;<span class="num" id="3957858">0</span><span class="op" id="3957859">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3957863">t</span><span class="op" id="3957864">.</span><span class="ident" id="3957865">Body</span>&nbsp;<span class="op" id="3957870">=</span>&nbsp;<span class="op" id="3957872">&amp;</span><span class="ident" id="3957873">body</span><span class="op" id="3957877">{</span><span class="ident" id="3957878">src</span><span class="op" id="3957881">:</span>&nbsp;<span class="ident" id="3957883">io</span><span class="op" id="3957885">.</span><span class="ident" id="3957886">LimitReader</span><span class="op" id="3957897">(</span><span class="ident" id="3957898">r</span><span class="op" id="3957899">,</span>&nbsp;<span class="ident" id="3957901">realLength</span><span class="op" id="3957911">)</span><span class="op" id="3957912">,</span>&nbsp;<span class="ident" id="3957914">closing</span><span class="op" id="3957921">:</span>&nbsp;<span class="ident" id="3957923">t</span><span class="op" id="3957924">.</span><span class="ident" id="3957925">Close</span><span class="op" id="3957930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3957933">default</span><span class="op" id="3957940">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3957944">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958011">if</span>&nbsp;<span class="ident" id="3958014">t</span><span class="op" id="3958015">.</span><span class="ident" id="3958016">Close</span>&nbsp;<span class="op" id="3958022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958027">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958065">t</span><span class="op" id="3958066">.</span><span class="ident" id="3958067">Body</span>&nbsp;<span class="op" id="3958072">=</span>&nbsp;<span class="op" id="3958074">&amp;</span><span class="ident" id="3958075">body</span><span class="op" id="3958079">{</span><span class="ident" id="3958080">src</span><span class="op" id="3958083">:</span>&nbsp;<span class="ident" id="3958085">r</span><span class="op" id="3958086">,</span>&nbsp;<span class="ident" id="3958088">closing</span><span class="op" id="3958095">:</span>&nbsp;<span class="ident" id="3958097">t</span><span class="op" id="3958098">.</span><span class="ident" id="3958099">Close</span><span class="op" id="3958104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3958108">}</span>&nbsp;<span class="keyword" id="3958110">else</span>&nbsp;<span class="op" id="3958115">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958120">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958164">t</span><span class="op" id="3958165">.</span><span class="ident" id="3958166">Body</span>&nbsp;<span class="op" id="3958171">=</span>&nbsp;<span class="ident" id="3958173">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3958185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3958188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3958192">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958209">switch</span>&nbsp;<span class="ident" id="3958216">rr</span>&nbsp;<span class="op" id="3958219">:=</span>&nbsp;<span class="ident" id="3958222">msg</span><span class="op" id="3958225">.</span><span class="op" id="3958226">(</span><span class="keyword" id="3958227">type</span><span class="op" id="3958231">)</span>&nbsp;<span class="op" id="3958233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958236">case</span>&nbsp;<span class="op" id="3958241">*</span><span class="ident" id="3958242">Request</span><span class="op" id="3958249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958253">rr</span><span class="op" id="3958255">.</span><span class="ident" id="3958256">Body</span>&nbsp;<span class="op" id="3958261">=</span>&nbsp;<span class="ident" id="3958263">t</span><span class="op" id="3958264">.</span><span class="ident" id="3958265">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958272">rr</span><span class="op" id="3958274">.</span><span class="ident" id="3958275">ContentLength</span>&nbsp;<span class="op" id="3958289">=</span>&nbsp;<span class="ident" id="3958291">t</span><span class="op" id="3958292">.</span><span class="ident" id="3958293">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958309">rr</span><span class="op" id="3958311">.</span><span class="ident" id="3958312">TransferEncoding</span>&nbsp;<span class="op" id="3958329">=</span>&nbsp;<span class="ident" id="3958331">t</span><span class="op" id="3958332">.</span><span class="ident" id="3958333">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958352">rr</span><span class="op" id="3958354">.</span><span class="ident" id="3958355">Close</span>&nbsp;<span class="op" id="3958361">=</span>&nbsp;<span class="ident" id="3958363">t</span><span class="op" id="3958364">.</span><span class="ident" id="3958365">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958373">rr</span><span class="op" id="3958375">.</span><span class="ident" id="3958376">Trailer</span>&nbsp;<span class="op" id="3958384">=</span>&nbsp;<span class="ident" id="3958386">t</span><span class="op" id="3958387">.</span><span class="ident" id="3958388">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958397">case</span>&nbsp;<span class="op" id="3958402">*</span><span class="ident" id="3958403">Response</span><span class="op" id="3958411">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958415">rr</span><span class="op" id="3958417">.</span><span class="ident" id="3958418">Body</span>&nbsp;<span class="op" id="3958423">=</span>&nbsp;<span class="ident" id="3958425">t</span><span class="op" id="3958426">.</span><span class="ident" id="3958427">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958434">rr</span><span class="op" id="3958436">.</span><span class="ident" id="3958437">ContentLength</span>&nbsp;<span class="op" id="3958451">=</span>&nbsp;<span class="ident" id="3958453">t</span><span class="op" id="3958454">.</span><span class="ident" id="3958455">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958471">rr</span><span class="op" id="3958473">.</span><span class="ident" id="3958474">TransferEncoding</span>&nbsp;<span class="op" id="3958491">=</span>&nbsp;<span class="ident" id="3958493">t</span><span class="op" id="3958494">.</span><span class="ident" id="3958495">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958514">rr</span><span class="op" id="3958516">.</span><span class="ident" id="3958517">Close</span>&nbsp;<span class="op" id="3958523">=</span>&nbsp;<span class="ident" id="3958525">t</span><span class="op" id="3958526">.</span><span class="ident" id="3958527">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958535">rr</span><span class="op" id="3958537">.</span><span class="ident" id="3958538">Trailer</span>&nbsp;<span class="op" id="3958546">=</span>&nbsp;<span class="ident" id="3958548">t</span><span class="op" id="3958549">.</span><span class="ident" id="3958550">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3958559">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3958563">return</span>&nbsp;<span class="ident" id="3958570">nil</span><br>
<span class="lineno"></span><span class="op" id="3958574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3958577">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3958634">func</span>&nbsp;<span class="ident" id="3958639">chunked</span><span class="op" id="3958646">(</span><span class="ident" id="3958647">te</span>&nbsp;<span class="op" id="3958650">[</span><span class="op" id="3958651">]</span><span class="builtintype" id="3958652">string</span><span class="op" id="3958658">)</span>&nbsp;<span class="builtintype" id="3958660">bool</span>&nbsp;<span class="op" id="3958665">{</span>&nbsp;<span class="keyword" id="3958667">return</span>&nbsp;<span class="builtinfunc" id="3958674">len</span><span class="op" id="3958677">(</span><span class="ident" id="3958678">te</span><span class="op" id="3958680">)</span>&nbsp;<span class="op" id="3958682">&gt;</span>&nbsp;<span class="num" id="3958684">0</span>&nbsp;<span class="op" id="3958686">&amp;&amp;</span>&nbsp;<span class="ident" id="3958689">te</span><span class="op" id="3958691">[</span><span class="num" id="3958692">0</span><span class="op" id="3958693">]</span>&nbsp;<span class="op" id="3958695">==</span>&nbsp;<span class="string" id="3958698">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3958708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3958711">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3958768">func</span>&nbsp;<span class="ident" id="3958773">isIdentity</span><span class="op" id="3958783">(</span><span class="ident" id="3958784">te</span>&nbsp;<span class="op" id="3958787">[</span><span class="op" id="3958788">]</span><span class="builtintype" id="3958789">string</span><span class="op" id="3958795">)</span>&nbsp;<span class="builtintype" id="3958797">bool</span>&nbsp;<span class="op" id="3958802">{</span>&nbsp;<span class="keyword" id="3958804">return</span>&nbsp;<span class="builtinfunc" id="3958811">len</span><span class="op" id="3958814">(</span><span class="ident" id="3958815">te</span><span class="op" id="3958817">)</span>&nbsp;<span class="op" id="3958819">==</span>&nbsp;<span class="num" id="3958822">1</span>&nbsp;<span class="op" id="3958824">&amp;&amp;</span>&nbsp;<span class="ident" id="3958827">te</span><span class="op" id="3958829">[</span><span class="num" id="3958830">0</span><span class="op" id="3958831">]</span>&nbsp;<span class="op" id="3958833">==</span>&nbsp;<span class="string" id="3958836">&#34;identity&#34;</span>&nbsp;<span class="op" id="3958847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3958850">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3958880">func</span>&nbsp;<span class="ident" id="3958885">fixTransferEncoding</span><span class="op" id="3958904">(</span><span class="ident" id="3958905">requestMethod</span>&nbsp;<span class="builtintype" id="3958919">string</span><span class="op" id="3958925">,</span>&nbsp;<span class="ident" id="3958927">header</span>&nbsp;<span class="ident" id="3958934">Header</span><span class="op" id="3958940">)</span>&nbsp;<span class="op" id="3958942">(</span><span class="op" id="3958943">[</span><span class="op" id="3958944">]</span><span class="builtintype" id="3958945">string</span><span class="op" id="3958951">,</span>&nbsp;<span class="builtintype" id="3958953">error</span><span class="op" id="3958958">)</span>&nbsp;<span class="op" id="3958960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3958963">raw</span><span class="op" id="3958966">,</span>&nbsp;<span class="ident" id="3958968">present</span>&nbsp;<span class="op" id="3958976">:=</span>&nbsp;<span class="ident" id="3958979">header</span><span class="op" id="3958985">[</span><span class="string" id="3958986">&#34;Transfer-Encoding&#34;</span><span class="op" id="3959005">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959008">if</span>&nbsp;<span class="op" id="3959011">!</span><span class="ident" id="3959012">present</span>&nbsp;<span class="op" id="3959020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959024">return</span>&nbsp;<span class="ident" id="3959031">nil</span><span class="op" id="3959034">,</span>&nbsp;<span class="ident" id="3959036">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3959045">delete</span><span class="op" id="3959051">(</span><span class="ident" id="3959052">header</span><span class="op" id="3959058">,</span>&nbsp;<span class="string" id="3959060">&#34;Transfer-Encoding&#34;</span><span class="op" id="3959079">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959083">encodings</span>&nbsp;<span class="op" id="3959093">:=</span>&nbsp;<span class="ident" id="3959096">strings</span><span class="op" id="3959103">.</span><span class="ident" id="3959104">Split</span><span class="op" id="3959109">(</span><span class="ident" id="3959110">raw</span><span class="op" id="3959113">[</span><span class="num" id="3959114">0</span><span class="op" id="3959115">]</span><span class="op" id="3959116">,</span>&nbsp;<span class="string" id="3959118">&#34;,&#34;</span><span class="op" id="3959121">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959124">te</span>&nbsp;<span class="op" id="3959127">:=</span>&nbsp;<span class="builtinfunc" id="3959130">make</span><span class="op" id="3959134">(</span><span class="op" id="3959135">[</span><span class="op" id="3959136">]</span><span class="builtintype" id="3959137">string</span><span class="op" id="3959143">,</span>&nbsp;<span class="num" id="3959145">0</span><span class="op" id="3959146">,</span>&nbsp;<span class="builtinfunc" id="3959148">len</span><span class="op" id="3959151">(</span><span class="ident" id="3959152">encodings</span><span class="op" id="3959161">)</span><span class="op" id="3959162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959165">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959228">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959290">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959349">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959394">for</span>&nbsp;<span class="ident" id="3959398">_</span><span class="op" id="3959399">,</span>&nbsp;<span class="ident" id="3959401">encoding</span>&nbsp;<span class="op" id="3959410">:=</span>&nbsp;<span class="keyword" id="3959413">range</span>&nbsp;<span class="ident" id="3959419">encodings</span>&nbsp;<span class="op" id="3959429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959433">encoding</span>&nbsp;<span class="op" id="3959442">=</span>&nbsp;<span class="ident" id="3959444">strings</span><span class="op" id="3959451">.</span><span class="ident" id="3959452">ToLower</span><span class="op" id="3959459">(</span><span class="ident" id="3959460">strings</span><span class="op" id="3959467">.</span><span class="ident" id="3959468">TrimSpace</span><span class="op" id="3959477">(</span><span class="ident" id="3959478">encoding</span><span class="op" id="3959486">)</span><span class="op" id="3959487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959491">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959532">if</span>&nbsp;<span class="ident" id="3959535">encoding</span>&nbsp;<span class="op" id="3959544">==</span>&nbsp;<span class="string" id="3959547">&#34;identity&#34;</span>&nbsp;<span class="op" id="3959558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959563">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959575">if</span>&nbsp;<span class="ident" id="3959578">encoding</span>&nbsp;<span class="op" id="3959587">!=</span>&nbsp;<span class="string" id="3959590">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3959600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959605">return</span>&nbsp;<span class="ident" id="3959612">nil</span><span class="op" id="3959615">,</span>&nbsp;<span class="op" id="3959617">&amp;</span><span class="ident" id="3959618">badStringError</span><span class="op" id="3959632">{</span><span class="string" id="3959633">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3959664">,</span>&nbsp;<span class="ident" id="3959666">encoding</span><span class="op" id="3959674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959682">te</span>&nbsp;<span class="op" id="3959685">=</span>&nbsp;<span class="ident" id="3959687">te</span><span class="op" id="3959689">[</span><span class="num" id="3959690">0</span>&nbsp;<span class="op" id="3959692">:</span>&nbsp;<span class="builtinfunc" id="3959694">len</span><span class="op" id="3959697">(</span><span class="ident" id="3959698">te</span><span class="op" id="3959700">)</span><span class="op" id="3959701">+</span><span class="num" id="3959702">1</span><span class="op" id="3959703">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3959707">te</span><span class="op" id="3959709">[</span><span class="builtinfunc" id="3959710">len</span><span class="op" id="3959713">(</span><span class="ident" id="3959714">te</span><span class="op" id="3959716">)</span><span class="op" id="3959717">-</span><span class="num" id="3959718">1</span><span class="op" id="3959719">]</span>&nbsp;<span class="op" id="3959721">=</span>&nbsp;<span class="ident" id="3959723">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959736">if</span>&nbsp;<span class="builtinfunc" id="3959739">len</span><span class="op" id="3959742">(</span><span class="ident" id="3959743">te</span><span class="op" id="3959745">)</span>&nbsp;<span class="op" id="3959747">&gt;</span>&nbsp;<span class="num" id="3959749">1</span>&nbsp;<span class="op" id="3959751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959755">return</span>&nbsp;<span class="ident" id="3959762">nil</span><span class="op" id="3959765">,</span>&nbsp;<span class="op" id="3959767">&amp;</span><span class="ident" id="3959768">badStringError</span><span class="op" id="3959782">{</span><span class="string" id="3959783">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3959812">,</span>&nbsp;<span class="ident" id="3959814">strings</span><span class="op" id="3959821">.</span><span class="ident" id="3959822">Join</span><span class="op" id="3959826">(</span><span class="ident" id="3959827">te</span><span class="op" id="3959829">,</span>&nbsp;<span class="string" id="3959831">&#34;,&#34;</span><span class="op" id="3959834">)</span><span class="op" id="3959835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3959838">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3959841">if</span>&nbsp;<span class="builtinfunc" id="3959844">len</span><span class="op" id="3959847">(</span><span class="ident" id="3959848">te</span><span class="op" id="3959850">)</span>&nbsp;<span class="op" id="3959852">&gt;</span>&nbsp;<span class="num" id="3959854">0</span>&nbsp;<span class="op" id="3959856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959860">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959918">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3959974">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3959989">delete</span><span class="op" id="3959995">(</span><span class="ident" id="3959996">header</span><span class="op" id="3960002">,</span>&nbsp;<span class="string" id="3960004">&#34;Content-Length&#34;</span><span class="op" id="3960020">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960024">return</span>&nbsp;<span class="ident" id="3960031">te</span><span class="op" id="3960033">,</span>&nbsp;<span class="ident" id="3960035">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960044">return</span>&nbsp;<span class="ident" id="3960051">nil</span><span class="op" id="3960054">,</span>&nbsp;<span class="ident" id="3960056">nil</span><br>
<span class="lineno"></span><span class="op" id="3960060">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3960063">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3960135">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3960206">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3960239">func</span>&nbsp;<span class="ident" id="3960244">fixLength</span><span class="op" id="3960253">(</span><span class="ident" id="3960254">isResponse</span>&nbsp;<span class="builtintype" id="3960265">bool</span><span class="op" id="3960269">,</span>&nbsp;<span class="ident" id="3960271">status</span>&nbsp;<span class="builtintype" id="3960278">int</span><span class="op" id="3960281">,</span>&nbsp;<span class="ident" id="3960283">requestMethod</span>&nbsp;<span class="builtintype" id="3960297">string</span><span class="op" id="3960303">,</span>&nbsp;<span class="ident" id="3960305">header</span>&nbsp;<span class="ident" id="3960312">Header</span><span class="op" id="3960318">,</span>&nbsp;<span class="ident" id="3960320">te</span>&nbsp;<span class="op" id="3960323">[</span><span class="op" id="3960324">]</span><span class="builtintype" id="3960325">string</span><span class="op" id="3960331">)</span>&nbsp;<span class="op" id="3960333">(</span><span class="ident" id="3960334">int64</span><span class="op" id="3960339">,</span>&nbsp;<span class="builtintype" id="3960341">error</span><span class="op" id="3960346">)</span>&nbsp;<span class="op" id="3960348">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960352">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960395">if</span>&nbsp;<span class="ident" id="3960398">noBodyExpected</span><span class="op" id="3960412">(</span><span class="ident" id="3960413">requestMethod</span><span class="op" id="3960426">)</span>&nbsp;<span class="op" id="3960428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960432">return</span>&nbsp;<span class="num" id="3960439">0</span><span class="op" id="3960440">,</span>&nbsp;<span class="ident" id="3960442">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960447">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960450">if</span>&nbsp;<span class="ident" id="3960453">status</span><span class="op" id="3960459">/</span><span class="num" id="3960460">100</span>&nbsp;<span class="op" id="3960464">==</span>&nbsp;<span class="num" id="3960467">1</span>&nbsp;<span class="op" id="3960469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960473">return</span>&nbsp;<span class="num" id="3960480">0</span><span class="op" id="3960481">,</span>&nbsp;<span class="ident" id="3960483">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960491">switch</span>&nbsp;<span class="ident" id="3960498">status</span>&nbsp;<span class="op" id="3960505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960508">case</span>&nbsp;<span class="num" id="3960513">204</span><span class="op" id="3960516">,</span>&nbsp;<span class="num" id="3960518">304</span><span class="op" id="3960521">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960525">return</span>&nbsp;<span class="num" id="3960532">0</span><span class="op" id="3960533">,</span>&nbsp;<span class="ident" id="3960535">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960544">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960581">if</span>&nbsp;<span class="ident" id="3960584">chunked</span><span class="op" id="3960591">(</span><span class="ident" id="3960592">te</span><span class="op" id="3960594">)</span>&nbsp;<span class="op" id="3960596">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960600">return</span>&nbsp;<span class="op" id="3960607">-</span><span class="num" id="3960608">1</span><span class="op" id="3960609">,</span>&nbsp;<span class="ident" id="3960611">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960620">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960654">cl</span>&nbsp;<span class="op" id="3960657">:=</span>&nbsp;<span class="ident" id="3960660">strings</span><span class="op" id="3960667">.</span><span class="ident" id="3960668">TrimSpace</span><span class="op" id="3960677">(</span><span class="ident" id="3960678">header</span><span class="op" id="3960684">.</span><span class="ident" id="3960685">get</span><span class="op" id="3960688">(</span><span class="string" id="3960689">&#34;Content-Length&#34;</span><span class="op" id="3960705">)</span><span class="op" id="3960706">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960709">if</span>&nbsp;<span class="ident" id="3960712">cl</span>&nbsp;<span class="op" id="3960715">!=</span>&nbsp;<span class="string" id="3960718">&#34;&#34;</span>&nbsp;<span class="op" id="3960721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960725">n</span><span class="op" id="3960726">,</span>&nbsp;<span class="ident" id="3960728">err</span>&nbsp;<span class="op" id="3960732">:=</span>&nbsp;<span class="ident" id="3960735">parseContentLength</span><span class="op" id="3960753">(</span><span class="ident" id="3960754">cl</span><span class="op" id="3960756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960760">if</span>&nbsp;<span class="ident" id="3960763">err</span>&nbsp;<span class="op" id="3960767">!=</span>&nbsp;<span class="ident" id="3960770">nil</span>&nbsp;<span class="op" id="3960774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960779">return</span>&nbsp;<span class="op" id="3960786">-</span><span class="num" id="3960787">1</span><span class="op" id="3960788">,</span>&nbsp;<span class="ident" id="3960790">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960796">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960800">return</span>&nbsp;<span class="ident" id="3960807">n</span><span class="op" id="3960808">,</span>&nbsp;<span class="ident" id="3960810">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960815">}</span>&nbsp;<span class="keyword" id="3960817">else</span>&nbsp;<span class="op" id="3960822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3960826">header</span><span class="op" id="3960832">.</span><span class="ident" id="3960833">Del</span><span class="op" id="3960836">(</span><span class="string" id="3960837">&#34;Content-Length&#34;</span><span class="op" id="3960853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3960856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3960860">if</span>&nbsp;<span class="op" id="3960863">!</span><span class="ident" id="3960864">isResponse</span>&nbsp;<span class="op" id="3960875">&amp;&amp;</span>&nbsp;<span class="ident" id="3960878">requestMethod</span>&nbsp;<span class="op" id="3960892">==</span>&nbsp;<span class="string" id="3960895">&#34;GET&#34;</span>&nbsp;<span class="op" id="3960901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960905">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3960959">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961013">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961068">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961106">return</span>&nbsp;<span class="num" id="3961113">0</span><span class="op" id="3961114">,</span>&nbsp;<span class="ident" id="3961116">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961125">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961201">return</span>&nbsp;<span class="op" id="3961208">-</span><span class="num" id="3961209">1</span><span class="op" id="3961210">,</span>&nbsp;<span class="ident" id="3961212">nil</span><br>
<span class="lineno">500</span><span class="op" id="3961216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3961219">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3961288">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3961321">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3961356">func</span>&nbsp;<span class="ident" id="3961361">shouldClose</span><span class="op" id="3961372">(</span><span class="ident" id="3961373">major</span><span class="op" id="3961378">,</span>&nbsp;<span class="ident" id="3961380">minor</span>&nbsp;<span class="builtintype" id="3961386">int</span><span class="op" id="3961389">,</span>&nbsp;<span class="ident" id="3961391">header</span>&nbsp;<span class="ident" id="3961398">Header</span><span class="op" id="3961404">,</span>&nbsp;<span class="ident" id="3961406">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3961424">bool</span><span class="op" id="3961428">)</span>&nbsp;<span class="builtintype" id="3961430">bool</span>&nbsp;<span class="op" id="3961435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961438">if</span>&nbsp;<span class="ident" id="3961441">major</span>&nbsp;<span class="op" id="3961447">&lt;</span>&nbsp;<span class="num" id="3961449">1</span>&nbsp;<span class="op" id="3961451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961455">return</span>&nbsp;<span class="builtintype" id="3961462">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961468">}</span>&nbsp;<span class="keyword" id="3961470">else</span>&nbsp;<span class="keyword" id="3961475">if</span>&nbsp;<span class="ident" id="3961478">major</span>&nbsp;<span class="op" id="3961484">==</span>&nbsp;<span class="num" id="3961487">1</span>&nbsp;<span class="op" id="3961489">&amp;&amp;</span>&nbsp;<span class="ident" id="3961492">minor</span>&nbsp;<span class="op" id="3961498">==</span>&nbsp;<span class="num" id="3961501">0</span>&nbsp;<span class="op" id="3961503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961507">if</span>&nbsp;<span class="op" id="3961510">!</span><span class="ident" id="3961511">strings</span><span class="op" id="3961518">.</span><span class="ident" id="3961519">Contains</span><span class="op" id="3961527">(</span><span class="ident" id="3961528">strings</span><span class="op" id="3961535">.</span><span class="ident" id="3961536">ToLower</span><span class="op" id="3961543">(</span><span class="ident" id="3961544">header</span><span class="op" id="3961550">.</span><span class="ident" id="3961551">get</span><span class="op" id="3961554">(</span><span class="string" id="3961555">&#34;Connection&#34;</span><span class="op" id="3961567">)</span><span class="op" id="3961568">)</span><span class="op" id="3961569">,</span>&nbsp;<span class="string" id="3961571">&#34;keep-alive&#34;</span><span class="op" id="3961583">)</span>&nbsp;<span class="op" id="3961585">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961590">return</span>&nbsp;<span class="builtintype" id="3961597">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961608">return</span>&nbsp;<span class="builtintype" id="3961615">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961622">}</span>&nbsp;<span class="keyword" id="3961624">else</span>&nbsp;<span class="op" id="3961629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961633">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3961698">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961725">if</span>&nbsp;<span class="ident" id="3961728">strings</span><span class="op" id="3961735">.</span><span class="ident" id="3961736">ToLower</span><span class="op" id="3961743">(</span><span class="ident" id="3961744">header</span><span class="op" id="3961750">.</span><span class="ident" id="3961751">get</span><span class="op" id="3961754">(</span><span class="string" id="3961755">&#34;Connection&#34;</span><span class="op" id="3961767">)</span><span class="op" id="3961768">)</span>&nbsp;<span class="op" id="3961770">==</span>&nbsp;<span class="string" id="3961773">&#34;close&#34;</span>&nbsp;<span class="op" id="3961781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961786">if</span>&nbsp;<span class="ident" id="3961789">removeCloseHeader</span>&nbsp;<span class="op" id="3961807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961813">header</span><span class="op" id="3961819">.</span><span class="ident" id="3961820">Del</span><span class="op" id="3961823">(</span><span class="string" id="3961824">&#34;Connection&#34;</span><span class="op" id="3961836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961841">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961846">return</span>&nbsp;<span class="builtintype" id="3961853">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3961863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3961866">return</span>&nbsp;<span class="builtintype" id="3961873">false</span><br>
<span class="lineno"></span><span class="op" id="3961879">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3961882">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3961910">func</span>&nbsp;<span class="ident" id="3961915">fixTrailer</span><span class="op" id="3961925">(</span><span class="ident" id="3961926">header</span>&nbsp;<span class="ident" id="3961933">Header</span><span class="op" id="3961939">,</span>&nbsp;<span class="ident" id="3961941">te</span>&nbsp;<span class="op" id="3961944">[</span><span class="op" id="3961945">]</span><span class="builtintype" id="3961946">string</span><span class="op" id="3961952">)</span>&nbsp;<span class="op" id="3961954">(</span><span class="ident" id="3961955">Header</span><span class="op" id="3961961">,</span>&nbsp;<span class="builtintype" id="3961963">error</span><span class="op" id="3961968">)</span>&nbsp;<span class="op" id="3961970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3961973">raw</span>&nbsp;<span class="op" id="3961977">:=</span>&nbsp;<span class="ident" id="3961980">header</span><span class="op" id="3961986">.</span><span class="ident" id="3961987">get</span><span class="op" id="3961990">(</span><span class="string" id="3961991">&#34;Trailer&#34;</span><span class="op" id="3962000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962003">if</span>&nbsp;<span class="ident" id="3962006">raw</span>&nbsp;<span class="op" id="3962010">==</span>&nbsp;<span class="string" id="3962013">&#34;&#34;</span>&nbsp;<span class="op" id="3962016">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962020">return</span>&nbsp;<span class="ident" id="3962027">nil</span><span class="op" id="3962030">,</span>&nbsp;<span class="ident" id="3962032">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962041">header</span><span class="op" id="3962047">.</span><span class="ident" id="3962048">Del</span><span class="op" id="3962051">(</span><span class="string" id="3962052">&#34;Trailer&#34;</span><span class="op" id="3962061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962064">trailer</span>&nbsp;<span class="op" id="3962072">:=</span>&nbsp;<span class="builtinfunc" id="3962075">make</span><span class="op" id="3962079">(</span><span class="ident" id="3962080">Header</span><span class="op" id="3962086">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962089">keys</span>&nbsp;<span class="op" id="3962094">:=</span>&nbsp;<span class="ident" id="3962097">strings</span><span class="op" id="3962104">.</span><span class="ident" id="3962105">Split</span><span class="op" id="3962110">(</span><span class="ident" id="3962111">raw</span><span class="op" id="3962114">,</span>&nbsp;<span class="string" id="3962116">&#34;,&#34;</span><span class="op" id="3962119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962122">for</span>&nbsp;<span class="ident" id="3962126">_</span><span class="op" id="3962127">,</span>&nbsp;<span class="ident" id="3962129">key</span>&nbsp;<span class="op" id="3962133">:=</span>&nbsp;<span class="keyword" id="3962136">range</span>&nbsp;<span class="ident" id="3962142">keys</span>&nbsp;<span class="op" id="3962147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962151">key</span>&nbsp;<span class="op" id="3962155">=</span>&nbsp;<span class="ident" id="3962157">CanonicalHeaderKey</span><span class="op" id="3962175">(</span><span class="ident" id="3962176">strings</span><span class="op" id="3962183">.</span><span class="ident" id="3962184">TrimSpace</span><span class="op" id="3962193">(</span><span class="ident" id="3962194">key</span><span class="op" id="3962197">)</span><span class="op" id="3962198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962202">switch</span>&nbsp;<span class="ident" id="3962209">key</span>&nbsp;<span class="op" id="3962213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962217">case</span>&nbsp;<span class="string" id="3962222">&#34;Transfer-Encoding&#34;</span><span class="op" id="3962241">,</span>&nbsp;<span class="string" id="3962243">&#34;Trailer&#34;</span><span class="op" id="3962252">,</span>&nbsp;<span class="string" id="3962254">&#34;Content-Length&#34;</span><span class="op" id="3962270">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962275">return</span>&nbsp;<span class="ident" id="3962282">nil</span><span class="op" id="3962285">,</span>&nbsp;<span class="op" id="3962287">&amp;</span><span class="ident" id="3962288">badStringError</span><span class="op" id="3962302">{</span><span class="string" id="3962303">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3962320">,</span>&nbsp;<span class="ident" id="3962322">key</span><span class="op" id="3962325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962333">trailer</span><span class="op" id="3962340">[</span><span class="ident" id="3962341">key</span><span class="op" id="3962344">]</span>&nbsp;<span class="op" id="3962346">=</span>&nbsp;<span class="ident" id="3962348">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962356">if</span>&nbsp;<span class="builtinfunc" id="3962359">len</span><span class="op" id="3962362">(</span><span class="ident" id="3962363">trailer</span><span class="op" id="3962370">)</span>&nbsp;<span class="op" id="3962372">==</span>&nbsp;<span class="num" id="3962375">0</span>&nbsp;<span class="op" id="3962377">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962381">return</span>&nbsp;<span class="ident" id="3962388">nil</span><span class="op" id="3962391">,</span>&nbsp;<span class="ident" id="3962393">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962401">if</span>&nbsp;<span class="op" id="3962404">!</span><span class="ident" id="3962405">chunked</span><span class="op" id="3962412">(</span><span class="ident" id="3962413">te</span><span class="op" id="3962415">)</span>&nbsp;<span class="op" id="3962417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3962421">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962450">return</span>&nbsp;<span class="ident" id="3962457">nil</span><span class="op" id="3962460">,</span>&nbsp;<span class="ident" id="3962462">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3962484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3962487">return</span>&nbsp;<span class="ident" id="3962494">trailer</span><span class="op" id="3962501">,</span>&nbsp;<span class="ident" id="3962503">nil</span><br>
<span class="lineno"></span><span class="op" id="3962507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3962510">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3962552">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3962603">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3962647">type</span>&nbsp;<span class="ident" id="3962652">body</span>&nbsp;<span class="keyword" id="3962657">struct</span>&nbsp;<span class="op" id="3962664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962667">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962675">io</span><span class="op" id="3962677">.</span><span class="ident" id="3962678">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962686">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3962694">interface</span><span class="op" id="3962703">{</span><span class="op" id="3962704">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3962708">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962767">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3962775">*</span><span class="ident" id="3962776">bufio</span><span class="op" id="3962781">.</span><span class="ident" id="3962782">Reader</span>&nbsp;<span class="comment" id="3962789">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962839">closing</span>&nbsp;<span class="builtintype" id="3962847">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3962861">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962917">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3962924">sync</span><span class="op" id="3962928">.</span><span class="ident" id="3962929">Mutex</span>&nbsp;<span class="comment" id="3962935">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3962982">closed</span>&nbsp;<span class="builtintype" id="3962989">bool</span><br>
<span class="lineno">565</span><span class="op" id="3962994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3962997">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3963069">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3963149">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3963213">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3963232">var</span>&nbsp;<span class="ident" id="3963236">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3963258">=</span>&nbsp;<span class="ident" id="3963260">errors</span><span class="op" id="3963266">.</span><span class="ident" id="3963267">New</span><span class="op" id="3963270">(</span><span class="string" id="3963271">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3963306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3963309">func</span>&nbsp;<span class="op" id="3963314">(</span><span class="ident" id="3963315">b</span>&nbsp;<span class="op" id="3963317">*</span><span class="ident" id="3963318">body</span><span class="op" id="3963322">)</span>&nbsp;<span class="ident" id="3963324">Read</span><span class="op" id="3963328">(</span><span class="ident" id="3963329">p</span>&nbsp;<span class="op" id="3963331">[</span><span class="op" id="3963332">]</span><span class="builtintype" id="3963333">byte</span><span class="op" id="3963337">)</span>&nbsp;<span class="op" id="3963339">(</span><span class="ident" id="3963340">n</span>&nbsp;<span class="builtintype" id="3963342">int</span><span class="op" id="3963345">,</span>&nbsp;<span class="ident" id="3963347">err</span>&nbsp;<span class="builtintype" id="3963351">error</span><span class="op" id="3963356">)</span>&nbsp;<span class="op" id="3963358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3963361">b</span><span class="op" id="3963362">.</span><span class="ident" id="3963363">mu</span><span class="op" id="3963365">.</span><span class="ident" id="3963366">Lock</span><span class="op" id="3963370">(</span><span class="op" id="3963371">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963374">defer</span>&nbsp;<span class="ident" id="3963380">b</span><span class="op" id="3963381">.</span><span class="ident" id="3963382">mu</span><span class="op" id="3963384">.</span><span class="ident" id="3963385">Unlock</span><span class="op" id="3963391">(</span><span class="op" id="3963392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963395">if</span>&nbsp;<span class="ident" id="3963398">b</span><span class="op" id="3963399">.</span><span class="ident" id="3963400">closed</span>&nbsp;<span class="op" id="3963407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963411">return</span>&nbsp;<span class="num" id="3963418">0</span><span class="op" id="3963419">,</span>&nbsp;<span class="ident" id="3963421">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963447">return</span>&nbsp;<span class="ident" id="3963454">b</span><span class="op" id="3963455">.</span><span class="ident" id="3963456">readLocked</span><span class="op" id="3963466">(</span><span class="ident" id="3963467">p</span><span class="op" id="3963468">)</span><br>
<span class="lineno">580</span><span class="op" id="3963470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3963473">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3963492">func</span>&nbsp;<span class="op" id="3963497">(</span><span class="ident" id="3963498">b</span>&nbsp;<span class="op" id="3963500">*</span><span class="ident" id="3963501">body</span><span class="op" id="3963505">)</span>&nbsp;<span class="ident" id="3963507">readLocked</span><span class="op" id="3963517">(</span><span class="ident" id="3963518">p</span>&nbsp;<span class="op" id="3963520">[</span><span class="op" id="3963521">]</span><span class="builtintype" id="3963522">byte</span><span class="op" id="3963526">)</span>&nbsp;<span class="op" id="3963528">(</span><span class="ident" id="3963529">n</span>&nbsp;<span class="builtintype" id="3963531">int</span><span class="op" id="3963534">,</span>&nbsp;<span class="ident" id="3963536">err</span>&nbsp;<span class="builtintype" id="3963540">error</span><span class="op" id="3963545">)</span>&nbsp;<span class="op" id="3963547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3963550">n</span><span class="op" id="3963551">,</span>&nbsp;<span class="ident" id="3963553">err</span>&nbsp;<span class="op" id="3963557">=</span>&nbsp;<span class="ident" id="3963559">b</span><span class="op" id="3963560">.</span><span class="ident" id="3963561">src</span><span class="op" id="3963564">.</span><span class="ident" id="3963565">Read</span><span class="op" id="3963569">(</span><span class="ident" id="3963570">p</span><span class="op" id="3963571">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963575">if</span>&nbsp;<span class="ident" id="3963578">err</span>&nbsp;<span class="op" id="3963582">==</span>&nbsp;<span class="ident" id="3963585">io</span><span class="op" id="3963587">.</span><span class="ident" id="3963588">EOF</span>&nbsp;<span class="op" id="3963592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963596">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963633">if</span>&nbsp;<span class="ident" id="3963636">b</span><span class="op" id="3963637">.</span><span class="ident" id="3963638">hdr</span>&nbsp;<span class="op" id="3963642">!=</span>&nbsp;<span class="ident" id="3963645">nil</span>&nbsp;<span class="op" id="3963649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963654">if</span>&nbsp;<span class="ident" id="3963657">e</span>&nbsp;<span class="op" id="3963659">:=</span>&nbsp;<span class="ident" id="3963662">b</span><span class="op" id="3963663">.</span><span class="ident" id="3963664">readTrailer</span><span class="op" id="3963675">(</span><span class="op" id="3963676">)</span><span class="op" id="3963677">;</span>&nbsp;<span class="ident" id="3963679">e</span>&nbsp;<span class="op" id="3963681">!=</span>&nbsp;<span class="ident" id="3963684">nil</span>&nbsp;<span class="op" id="3963688">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3963694">err</span>&nbsp;<span class="op" id="3963698">=</span>&nbsp;<span class="ident" id="3963700">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3963710">b</span><span class="op" id="3963711">.</span><span class="ident" id="3963712">hdr</span>&nbsp;<span class="op" id="3963716">=</span>&nbsp;<span class="ident" id="3963718">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963724">}</span>&nbsp;<span class="keyword" id="3963726">else</span>&nbsp;<span class="op" id="3963731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963736">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963813">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3963872">if</span>&nbsp;<span class="ident" id="3963875">lr</span><span class="op" id="3963877">,</span>&nbsp;<span class="ident" id="3963879">ok</span>&nbsp;<span class="op" id="3963882">:=</span>&nbsp;<span class="ident" id="3963885">b</span><span class="op" id="3963886">.</span><span class="ident" id="3963887">src</span><span class="op" id="3963890">.</span><span class="op" id="3963891">(</span><span class="op" id="3963892">*</span><span class="ident" id="3963893">io</span><span class="op" id="3963895">.</span><span class="ident" id="3963896">LimitedReader</span><span class="op" id="3963909">)</span><span class="op" id="3963910">;</span>&nbsp;<span class="ident" id="3963912">ok</span>&nbsp;<span class="op" id="3963915">&amp;&amp;</span>&nbsp;<span class="ident" id="3963918">lr</span><span class="op" id="3963920">.</span><span class="ident" id="3963921">N</span>&nbsp;<span class="op" id="3963923">&gt;</span>&nbsp;<span class="num" id="3963925">0</span>&nbsp;<span class="op" id="3963927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3963933">err</span>&nbsp;<span class="op" id="3963937">=</span>&nbsp;<span class="ident" id="3963939">io</span><span class="op" id="3963941">.</span><span class="ident" id="3963942">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963966">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3963969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3963973">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964035">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964098">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964158">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964219">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964264">if</span>&nbsp;<span class="ident" id="3964267">err</span>&nbsp;<span class="op" id="3964271">==</span>&nbsp;<span class="ident" id="3964274">nil</span>&nbsp;<span class="op" id="3964278">&amp;&amp;</span>&nbsp;<span class="ident" id="3964281">n</span>&nbsp;<span class="op" id="3964283">&gt;</span>&nbsp;<span class="num" id="3964285">0</span>&nbsp;<span class="op" id="3964287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964291">if</span>&nbsp;<span class="ident" id="3964294">lr</span><span class="op" id="3964296">,</span>&nbsp;<span class="ident" id="3964298">ok</span>&nbsp;<span class="op" id="3964301">:=</span>&nbsp;<span class="ident" id="3964304">b</span><span class="op" id="3964305">.</span><span class="ident" id="3964306">src</span><span class="op" id="3964309">.</span><span class="op" id="3964310">(</span><span class="op" id="3964311">*</span><span class="ident" id="3964312">io</span><span class="op" id="3964314">.</span><span class="ident" id="3964315">LimitedReader</span><span class="op" id="3964328">)</span><span class="op" id="3964329">;</span>&nbsp;<span class="ident" id="3964331">ok</span>&nbsp;<span class="op" id="3964334">&amp;&amp;</span>&nbsp;<span class="ident" id="3964337">lr</span><span class="op" id="3964339">.</span><span class="ident" id="3964340">N</span>&nbsp;<span class="op" id="3964342">==</span>&nbsp;<span class="num" id="3964345">0</span>&nbsp;<span class="op" id="3964347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964352">err</span>&nbsp;<span class="op" id="3964356">=</span>&nbsp;<span class="ident" id="3964358">io</span><span class="op" id="3964360">.</span><span class="ident" id="3964361">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964374">return</span>&nbsp;<span class="ident" id="3964381">n</span><span class="op" id="3964382">,</span>&nbsp;<span class="ident" id="3964384">err</span><br>
<span class="lineno"></span><span class="op" id="3964388">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3964391">var</span>&nbsp;<span class="op" id="3964395">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964398">singleCRLF</span>&nbsp;<span class="op" id="3964409">=</span>&nbsp;<span class="op" id="3964411">[</span><span class="op" id="3964412">]</span><span class="builtintype" id="3964413">byte</span><span class="op" id="3964417">(</span><span class="string" id="3964418">&#34;\r\n&#34;</span><span class="op" id="3964424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964427">doubleCRLF</span>&nbsp;<span class="op" id="3964438">=</span>&nbsp;<span class="op" id="3964440">[</span><span class="op" id="3964441">]</span><span class="builtintype" id="3964442">byte</span><span class="op" id="3964446">(</span><span class="string" id="3964447">&#34;\r\n\r\n&#34;</span><span class="op" id="3964457">)</span><br>
<span class="lineno"></span><span class="op" id="3964459">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3964462">func</span>&nbsp;<span class="ident" id="3964467">seeUpcomingDoubleCRLF</span><span class="op" id="3964488">(</span><span class="ident" id="3964489">r</span>&nbsp;<span class="op" id="3964491">*</span><span class="ident" id="3964492">bufio</span><span class="op" id="3964497">.</span><span class="ident" id="3964498">Reader</span><span class="op" id="3964504">)</span>&nbsp;<span class="builtintype" id="3964506">bool</span>&nbsp;<span class="op" id="3964511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964514">for</span>&nbsp;<span class="ident" id="3964518">peekSize</span>&nbsp;<span class="op" id="3964527">:=</span>&nbsp;<span class="num" id="3964530">4</span><span class="op" id="3964531">;</span>&nbsp;<span class="op" id="3964533">;</span>&nbsp;<span class="ident" id="3964535">peekSize</span><span class="op" id="3964543">++</span>&nbsp;<span class="op" id="3964546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964550">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964599">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964651">buf</span><span class="op" id="3964654">,</span>&nbsp;<span class="ident" id="3964656">err</span>&nbsp;<span class="op" id="3964660">:=</span>&nbsp;<span class="ident" id="3964663">r</span><span class="op" id="3964664">.</span><span class="ident" id="3964665">Peek</span><span class="op" id="3964669">(</span><span class="ident" id="3964670">peekSize</span><span class="op" id="3964678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964682">if</span>&nbsp;<span class="ident" id="3964685">bytes</span><span class="op" id="3964690">.</span><span class="ident" id="3964691">HasSuffix</span><span class="op" id="3964700">(</span><span class="ident" id="3964701">buf</span><span class="op" id="3964704">,</span>&nbsp;<span class="ident" id="3964706">doubleCRLF</span><span class="op" id="3964716">)</span>&nbsp;<span class="op" id="3964718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964723">return</span>&nbsp;<span class="builtintype" id="3964730">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964741">if</span>&nbsp;<span class="ident" id="3964744">err</span>&nbsp;<span class="op" id="3964748">!=</span>&nbsp;<span class="ident" id="3964751">nil</span>&nbsp;<span class="op" id="3964755">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964760">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3964771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964774">return</span>&nbsp;<span class="builtintype" id="3964781">false</span><br>
<span class="lineno"></span><span class="op" id="3964787">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3964790">var</span>&nbsp;<span class="ident" id="3964794">errTrailerEOF</span>&nbsp;<span class="op" id="3964808">=</span>&nbsp;<span class="ident" id="3964810">errors</span><span class="op" id="3964816">.</span><span class="ident" id="3964817">New</span><span class="op" id="3964820">(</span><span class="string" id="3964821">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3964859">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3964862">func</span>&nbsp;<span class="op" id="3964867">(</span><span class="ident" id="3964868">b</span>&nbsp;<span class="op" id="3964870">*</span><span class="ident" id="3964871">body</span><span class="op" id="3964875">)</span>&nbsp;<span class="ident" id="3964877">readTrailer</span><span class="op" id="3964888">(</span><span class="op" id="3964889">)</span>&nbsp;<span class="builtintype" id="3964891">error</span>&nbsp;<span class="op" id="3964897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3964900">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3964949">buf</span><span class="op" id="3964952">,</span>&nbsp;<span class="ident" id="3964954">err</span>&nbsp;<span class="op" id="3964958">:=</span>&nbsp;<span class="ident" id="3964961">b</span><span class="op" id="3964962">.</span><span class="ident" id="3964963">r</span><span class="op" id="3964964">.</span><span class="ident" id="3964965">Peek</span><span class="op" id="3964969">(</span><span class="num" id="3964970">2</span><span class="op" id="3964971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3964974">if</span>&nbsp;<span class="ident" id="3964977">bytes</span><span class="op" id="3964982">.</span><span class="ident" id="3964983">Equal</span><span class="op" id="3964988">(</span><span class="ident" id="3964989">buf</span><span class="op" id="3964992">,</span>&nbsp;<span class="ident" id="3964994">singleCRLF</span><span class="op" id="3965004">)</span>&nbsp;<span class="op" id="3965006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965010">b</span><span class="op" id="3965011">.</span><span class="ident" id="3965012">r</span><span class="op" id="3965013">.</span><span class="ident" id="3965014">ReadByte</span><span class="op" id="3965022">(</span><span class="op" id="3965023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965027">b</span><span class="op" id="3965028">.</span><span class="ident" id="3965029">r</span><span class="op" id="3965030">.</span><span class="ident" id="3965031">ReadByte</span><span class="op" id="3965039">(</span><span class="op" id="3965040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965044">return</span>&nbsp;<span class="ident" id="3965051">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965059">if</span>&nbsp;<span class="builtinfunc" id="3965062">len</span><span class="op" id="3965065">(</span><span class="ident" id="3965066">buf</span><span class="op" id="3965069">)</span>&nbsp;<span class="op" id="3965071">&lt;</span>&nbsp;<span class="num" id="3965073">2</span>&nbsp;<span class="op" id="3965075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965079">return</span>&nbsp;<span class="ident" id="3965086">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965104">if</span>&nbsp;<span class="ident" id="3965107">err</span>&nbsp;<span class="op" id="3965111">!=</span>&nbsp;<span class="ident" id="3965114">nil</span>&nbsp;<span class="op" id="3965118">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965122">return</span>&nbsp;<span class="ident" id="3965129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965138">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965202">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965262">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965326">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965388">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965452">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965516">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3965579">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965653">if</span>&nbsp;<span class="op" id="3965656">!</span><span class="ident" id="3965657">seeUpcomingDoubleCRLF</span><span class="op" id="3965678">(</span><span class="ident" id="3965679">b</span><span class="op" id="3965680">.</span><span class="ident" id="3965681">r</span><span class="op" id="3965682">)</span>&nbsp;<span class="op" id="3965684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965688">return</span>&nbsp;<span class="ident" id="3965695">errors</span><span class="op" id="3965701">.</span><span class="ident" id="3965702">New</span><span class="op" id="3965705">(</span><span class="string" id="3965706">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3965758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965765">hdr</span><span class="op" id="3965768">,</span>&nbsp;<span class="ident" id="3965770">err</span>&nbsp;<span class="op" id="3965774">:=</span>&nbsp;<span class="ident" id="3965777">textproto</span><span class="op" id="3965786">.</span><span class="ident" id="3965787">NewReader</span><span class="op" id="3965796">(</span><span class="ident" id="3965797">b</span><span class="op" id="3965798">.</span><span class="ident" id="3965799">r</span><span class="op" id="3965800">)</span><span class="op" id="3965801">.</span><span class="ident" id="3965802">ReadMIMEHeader</span><span class="op" id="3965816">(</span><span class="op" id="3965817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965820">if</span>&nbsp;<span class="ident" id="3965823">err</span>&nbsp;<span class="op" id="3965827">!=</span>&nbsp;<span class="ident" id="3965830">nil</span>&nbsp;<span class="op" id="3965834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965838">if</span>&nbsp;<span class="ident" id="3965841">err</span>&nbsp;<span class="op" id="3965845">==</span>&nbsp;<span class="ident" id="3965848">io</span><span class="op" id="3965850">.</span><span class="ident" id="3965851">EOF</span>&nbsp;<span class="op" id="3965855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965860">return</span>&nbsp;<span class="ident" id="3965867">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965883">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965887">return</span>&nbsp;<span class="ident" id="3965894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3965899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965902">switch</span>&nbsp;<span class="ident" id="3965909">rr</span>&nbsp;<span class="op" id="3965912">:=</span>&nbsp;<span class="ident" id="3965915">b</span><span class="op" id="3965916">.</span><span class="ident" id="3965917">hdr</span><span class="op" id="3965920">.</span><span class="op" id="3965921">(</span><span class="keyword" id="3965922">type</span><span class="op" id="3965926">)</span>&nbsp;<span class="op" id="3965928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965931">case</span>&nbsp;<span class="op" id="3965936">*</span><span class="ident" id="3965937">Request</span><span class="op" id="3965944">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3965948">mergeSetHeader</span><span class="op" id="3965962">(</span><span class="op" id="3965963">&amp;</span><span class="ident" id="3965964">rr</span><span class="op" id="3965966">.</span><span class="ident" id="3965967">Trailer</span><span class="op" id="3965974">,</span>&nbsp;<span class="ident" id="3965976">Header</span><span class="op" id="3965982">(</span><span class="ident" id="3965983">hdr</span><span class="op" id="3965986">)</span><span class="op" id="3965987">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3965990">case</span>&nbsp;<span class="op" id="3965995">*</span><span class="ident" id="3965996">Response</span><span class="op" id="3966004">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966008">mergeSetHeader</span><span class="op" id="3966022">(</span><span class="op" id="3966023">&amp;</span><span class="ident" id="3966024">rr</span><span class="op" id="3966026">.</span><span class="ident" id="3966027">Trailer</span><span class="op" id="3966034">,</span>&nbsp;<span class="ident" id="3966036">Header</span><span class="op" id="3966042">(</span><span class="ident" id="3966043">hdr</span><span class="op" id="3966046">)</span><span class="op" id="3966047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966053">return</span>&nbsp;<span class="ident" id="3966060">nil</span><br>
<span class="lineno"></span><span class="op" id="3966064">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3966067">func</span>&nbsp;<span class="ident" id="3966072">mergeSetHeader</span><span class="op" id="3966086">(</span><span class="ident" id="3966087">dst</span>&nbsp;<span class="op" id="3966091">*</span><span class="ident" id="3966092">Header</span><span class="op" id="3966098">,</span>&nbsp;<span class="ident" id="3966100">src</span>&nbsp;<span class="ident" id="3966104">Header</span><span class="op" id="3966110">)</span>&nbsp;<span class="op" id="3966112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966115">if</span>&nbsp;<span class="op" id="3966118">*</span><span class="ident" id="3966119">dst</span>&nbsp;<span class="op" id="3966123">==</span>&nbsp;<span class="ident" id="3966126">nil</span>&nbsp;<span class="op" id="3966130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966134">*</span><span class="ident" id="3966135">dst</span>&nbsp;<span class="op" id="3966139">=</span>&nbsp;<span class="ident" id="3966141">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966147">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966158">for</span>&nbsp;<span class="ident" id="3966162">k</span><span class="op" id="3966163">,</span>&nbsp;<span class="ident" id="3966165">vv</span>&nbsp;<span class="op" id="3966168">:=</span>&nbsp;<span class="keyword" id="3966171">range</span>&nbsp;<span class="ident" id="3966177">src</span>&nbsp;<span class="op" id="3966181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966185">(</span><span class="op" id="3966186">*</span><span class="ident" id="3966187">dst</span><span class="op" id="3966190">)</span><span class="op" id="3966191">[</span><span class="ident" id="3966192">k</span><span class="op" id="3966193">]</span>&nbsp;<span class="op" id="3966195">=</span>&nbsp;<span class="ident" id="3966197">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966201">}</span><br>
<span class="lineno"></span><span class="op" id="3966203">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3966206">func</span>&nbsp;<span class="op" id="3966211">(</span><span class="ident" id="3966212">b</span>&nbsp;<span class="op" id="3966214">*</span><span class="ident" id="3966215">body</span><span class="op" id="3966219">)</span>&nbsp;<span class="ident" id="3966221">Close</span><span class="op" id="3966226">(</span><span class="op" id="3966227">)</span>&nbsp;<span class="builtintype" id="3966229">error</span>&nbsp;<span class="op" id="3966235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966238">b</span><span class="op" id="3966239">.</span><span class="ident" id="3966240">mu</span><span class="op" id="3966242">.</span><span class="ident" id="3966243">Lock</span><span class="op" id="3966247">(</span><span class="op" id="3966248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966251">defer</span>&nbsp;<span class="ident" id="3966257">b</span><span class="op" id="3966258">.</span><span class="ident" id="3966259">mu</span><span class="op" id="3966261">.</span><span class="ident" id="3966262">Unlock</span><span class="op" id="3966268">(</span><span class="op" id="3966269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966272">if</span>&nbsp;<span class="ident" id="3966275">b</span><span class="op" id="3966276">.</span><span class="ident" id="3966277">closed</span>&nbsp;<span class="op" id="3966284">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966288">return</span>&nbsp;<span class="ident" id="3966295">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966303">var</span>&nbsp;<span class="ident" id="3966307">err</span>&nbsp;<span class="builtintype" id="3966311">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966318">switch</span>&nbsp;<span class="op" id="3966325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966328">case</span>&nbsp;<span class="ident" id="3966333">b</span><span class="op" id="3966334">.</span><span class="ident" id="3966335">hdr</span>&nbsp;<span class="op" id="3966339">==</span>&nbsp;<span class="ident" id="3966342">nil</span>&nbsp;<span class="op" id="3966346">&amp;&amp;</span>&nbsp;<span class="ident" id="3966349">b</span><span class="op" id="3966350">.</span><span class="ident" id="3966351">closing</span><span class="op" id="3966358">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966362">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966411">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966443">default</span><span class="op" id="3966450">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966454">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3966518">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966571">_</span><span class="op" id="3966572">,</span>&nbsp;<span class="ident" id="3966574">err</span>&nbsp;<span class="op" id="3966578">=</span>&nbsp;<span class="ident" id="3966580">io</span><span class="op" id="3966582">.</span><span class="ident" id="3966583">Copy</span><span class="op" id="3966587">(</span><span class="ident" id="3966588">ioutil</span><span class="op" id="3966594">.</span><span class="ident" id="3966595">Discard</span><span class="op" id="3966602">,</span>&nbsp;<span class="ident" id="3966604">bodyLocked</span><span class="op" id="3966614">{</span><span class="ident" id="3966615">b</span><span class="op" id="3966616">}</span><span class="op" id="3966617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966623">b</span><span class="op" id="3966624">.</span><span class="ident" id="3966625">closed</span>&nbsp;<span class="op" id="3966632">=</span>&nbsp;<span class="builtintype" id="3966634">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966640">return</span>&nbsp;<span class="ident" id="3966647">err</span><br>
<span class="lineno"></span><span class="op" id="3966651">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3966654">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3966722">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3966739">type</span>&nbsp;<span class="ident" id="3966744">bodyLocked</span>&nbsp;<span class="keyword" id="3966755">struct</span>&nbsp;<span class="op" id="3966762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3966765">b</span>&nbsp;<span class="op" id="3966767">*</span><span class="ident" id="3966768">body</span><br>
<span class="lineno">715</span><span class="op" id="3966773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3966776">func</span>&nbsp;<span class="op" id="3966781">(</span><span class="ident" id="3966782">bl</span>&nbsp;<span class="ident" id="3966785">bodyLocked</span><span class="op" id="3966795">)</span>&nbsp;<span class="ident" id="3966797">Read</span><span class="op" id="3966801">(</span><span class="ident" id="3966802">p</span>&nbsp;<span class="op" id="3966804">[</span><span class="op" id="3966805">]</span><span class="builtintype" id="3966806">byte</span><span class="op" id="3966810">)</span>&nbsp;<span class="op" id="3966812">(</span><span class="ident" id="3966813">n</span>&nbsp;<span class="builtintype" id="3966815">int</span><span class="op" id="3966818">,</span>&nbsp;<span class="ident" id="3966820">err</span>&nbsp;<span class="builtintype" id="3966824">error</span><span class="op" id="3966829">)</span>&nbsp;<span class="op" id="3966831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966834">if</span>&nbsp;<span class="ident" id="3966837">bl</span><span class="op" id="3966839">.</span><span class="ident" id="3966840">b</span><span class="op" id="3966841">.</span><span class="ident" id="3966842">closed</span>&nbsp;<span class="op" id="3966849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966853">return</span>&nbsp;<span class="num" id="3966860">0</span><span class="op" id="3966861">,</span>&nbsp;<span class="ident" id="3966863">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3966886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3966889">return</span>&nbsp;<span class="ident" id="3966896">bl</span><span class="op" id="3966898">.</span><span class="ident" id="3966899">b</span><span class="op" id="3966900">.</span><span class="ident" id="3966901">readLocked</span><span class="op" id="3966911">(</span><span class="ident" id="3966912">p</span><span class="op" id="3966913">)</span><br>
<span class="lineno"></span><span class="op" id="3966915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3966918">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3966991">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3967029">func</span>&nbsp;<span class="ident" id="3967034">parseContentLength</span><span class="op" id="3967052">(</span><span class="ident" id="3967053">cl</span>&nbsp;<span class="builtintype" id="3967056">string</span><span class="op" id="3967062">)</span>&nbsp;<span class="op" id="3967064">(</span><span class="ident" id="3967065">int64</span><span class="op" id="3967070">,</span>&nbsp;<span class="builtintype" id="3967072">error</span><span class="op" id="3967077">)</span>&nbsp;<span class="op" id="3967079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967082">cl</span>&nbsp;<span class="op" id="3967085">=</span>&nbsp;<span class="ident" id="3967087">strings</span><span class="op" id="3967094">.</span><span class="ident" id="3967095">TrimSpace</span><span class="op" id="3967104">(</span><span class="ident" id="3967105">cl</span><span class="op" id="3967107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967110">if</span>&nbsp;<span class="ident" id="3967113">cl</span>&nbsp;<span class="op" id="3967116">==</span>&nbsp;<span class="string" id="3967119">&#34;&#34;</span>&nbsp;<span class="op" id="3967122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967126">return</span>&nbsp;<span class="op" id="3967133">-</span><span class="num" id="3967134">1</span><span class="op" id="3967135">,</span>&nbsp;<span class="ident" id="3967137">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3967145">n</span><span class="op" id="3967146">,</span>&nbsp;<span class="ident" id="3967148">err</span>&nbsp;<span class="op" id="3967152">:=</span>&nbsp;<span class="ident" id="3967155">strconv</span><span class="op" id="3967162">.</span><span class="ident" id="3967163">ParseInt</span><span class="op" id="3967171">(</span><span class="ident" id="3967172">cl</span><span class="op" id="3967174">,</span>&nbsp;<span class="num" id="3967176">10</span><span class="op" id="3967178">,</span>&nbsp;<span class="num" id="3967180">64</span><span class="op" id="3967182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967185">if</span>&nbsp;<span class="ident" id="3967188">err</span>&nbsp;<span class="op" id="3967192">!=</span>&nbsp;<span class="ident" id="3967195">nil</span>&nbsp;<span class="op" id="3967199">||</span>&nbsp;<span class="ident" id="3967202">n</span>&nbsp;<span class="op" id="3967204">&lt;</span>&nbsp;<span class="num" id="3967206">0</span>&nbsp;<span class="op" id="3967208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967212">return</span>&nbsp;<span class="num" id="3967219">0</span><span class="op" id="3967220">,</span>&nbsp;<span class="op" id="3967222">&amp;</span><span class="ident" id="3967223">badStringError</span><span class="op" id="3967237">{</span><span class="string" id="3967238">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3967258">,</span>&nbsp;<span class="ident" id="3967260">cl</span><span class="op" id="3967262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3967265">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3967268">return</span>&nbsp;<span class="ident" id="3967275">n</span><span class="op" id="3967276">,</span>&nbsp;<span class="ident" id="3967278">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3967283">}</span>
</div>
</body>
</html>
