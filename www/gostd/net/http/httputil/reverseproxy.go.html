<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4994272">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4994327">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4994381">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4994432">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4994463">package</span>&nbsp;<span class="ident" id="4994471">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4994481">import</span>&nbsp;<span class="op" id="4994488">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994491">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994497">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994504">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994511">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994523">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994534">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994545">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4994553">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4994560">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4994563">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4994636">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="4994662">var</span>&nbsp;<span class="ident" id="4994666">onExitFlushLoop</span>&nbsp;<span class="keyword" id="4994682">func</span><span class="op" id="4994686">(</span><span class="op" id="4994687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994690">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="4994760">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4994825">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4994836">type</span>&nbsp;<span class="ident" id="4994841">ReverseProxy</span>&nbsp;<span class="keyword" id="4994854">struct</span>&nbsp;<span class="op" id="4994861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4994864">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4994911">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4994957">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995006">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995050">Director</span>&nbsp;<span class="keyword" id="4995059">func</span><span class="op" id="4995063">(</span><span class="op" id="4995064">*</span><span class="ident" id="4995065">http</span><span class="op" id="4995069">.</span><span class="ident" id="4995070">Request</span><span class="op" id="4995077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995081">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995131">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995174">Transport</span>&nbsp;<span class="ident" id="4995184">http</span><span class="op" id="4995188">.</span><span class="ident" id="4995189">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995204">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995251">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995296">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995315">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995358">FlushInterval</span>&nbsp;<span class="ident" id="4995372">time</span><span class="op" id="4995376">.</span><span class="ident" id="4995377">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995388">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995441">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995494">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4995554">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995575">ErrorLog</span>&nbsp;<span class="op" id="4995584">*</span><span class="ident" id="4995585">log</span><span class="op" id="4995588">.</span><span class="ident" id="4995589">Logger</span><br>
<span class="lineno"></span><span class="op" id="4995596">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4995599">func</span>&nbsp;<span class="ident" id="4995604">singleJoiningSlash</span><span class="op" id="4995622">(</span><span class="ident" id="4995623">a</span><span class="op" id="4995624">,</span>&nbsp;<span class="ident" id="4995626">b</span>&nbsp;<span class="builtintype" id="4995628">string</span><span class="op" id="4995634">)</span>&nbsp;<span class="builtintype" id="4995636">string</span>&nbsp;<span class="op" id="4995643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995646">aslash</span>&nbsp;<span class="op" id="4995653">:=</span>&nbsp;<span class="ident" id="4995656">strings</span><span class="op" id="4995663">.</span><span class="ident" id="4995664">HasSuffix</span><span class="op" id="4995673">(</span><span class="ident" id="4995674">a</span><span class="op" id="4995675">,</span>&nbsp;<span class="string" id="4995677">&#34;/&#34;</span><span class="op" id="4995680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4995683">bslash</span>&nbsp;<span class="op" id="4995690">:=</span>&nbsp;<span class="ident" id="4995693">strings</span><span class="op" id="4995700">.</span><span class="ident" id="4995701">HasPrefix</span><span class="op" id="4995710">(</span><span class="ident" id="4995711">b</span><span class="op" id="4995712">,</span>&nbsp;<span class="string" id="4995714">&#34;/&#34;</span><span class="op" id="4995717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995720">switch</span>&nbsp;<span class="op" id="4995727">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995730">case</span>&nbsp;<span class="ident" id="4995735">aslash</span>&nbsp;<span class="op" id="4995742">&amp;&amp;</span>&nbsp;<span class="ident" id="4995745">bslash</span><span class="op" id="4995751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995755">return</span>&nbsp;<span class="ident" id="4995762">a</span>&nbsp;<span class="op" id="4995764">+</span>&nbsp;<span class="ident" id="4995766">b</span><span class="op" id="4995767">[</span><span class="num" id="4995768">1</span><span class="op" id="4995769">:</span><span class="op" id="4995770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995773">case</span>&nbsp;<span class="op" id="4995778">!</span><span class="ident" id="4995779">aslash</span>&nbsp;<span class="op" id="4995786">&amp;&amp;</span>&nbsp;<span class="op" id="4995789">!</span><span class="ident" id="4995790">bslash</span><span class="op" id="4995796">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995800">return</span>&nbsp;<span class="ident" id="4995807">a</span>&nbsp;<span class="op" id="4995809">+</span>&nbsp;<span class="string" id="4995811">&#34;/&#34;</span>&nbsp;<span class="op" id="4995815">+</span>&nbsp;<span class="ident" id="4995817">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4995820">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4995823">return</span>&nbsp;<span class="ident" id="4995830">a</span>&nbsp;<span class="op" id="4995832">+</span>&nbsp;<span class="ident" id="4995834">b</span><br>
<span class="lineno"></span><span class="op" id="4995836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4995839">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="4995909">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="4995979">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="4996048">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="4996093">func</span>&nbsp;<span class="ident" id="4996098">NewSingleHostReverseProxy</span><span class="op" id="4996123">(</span><span class="ident" id="4996124">target</span>&nbsp;<span class="op" id="4996131">*</span><span class="ident" id="4996132">url</span><span class="op" id="4996135">.</span><span class="ident" id="4996136">URL</span><span class="op" id="4996139">)</span>&nbsp;<span class="op" id="4996141">*</span><span class="ident" id="4996142">ReverseProxy</span>&nbsp;<span class="op" id="4996155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996158">targetQuery</span>&nbsp;<span class="op" id="4996170">:=</span>&nbsp;<span class="ident" id="4996173">target</span><span class="op" id="4996179">.</span><span class="ident" id="4996180">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996190">director</span>&nbsp;<span class="op" id="4996199">:=</span>&nbsp;<span class="keyword" id="4996202">func</span><span class="op" id="4996206">(</span><span class="ident" id="4996207">req</span>&nbsp;<span class="op" id="4996211">*</span><span class="ident" id="4996212">http</span><span class="op" id="4996216">.</span><span class="ident" id="4996217">Request</span><span class="op" id="4996224">)</span>&nbsp;<span class="op" id="4996226">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996230">req</span><span class="op" id="4996233">.</span><span class="ident" id="4996234">URL</span><span class="op" id="4996237">.</span><span class="ident" id="4996238">Scheme</span>&nbsp;<span class="op" id="4996245">=</span>&nbsp;<span class="ident" id="4996247">target</span><span class="op" id="4996253">.</span><span class="ident" id="4996254">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996263">req</span><span class="op" id="4996266">.</span><span class="ident" id="4996267">URL</span><span class="op" id="4996270">.</span><span class="ident" id="4996271">Host</span>&nbsp;<span class="op" id="4996276">=</span>&nbsp;<span class="ident" id="4996278">target</span><span class="op" id="4996284">.</span><span class="ident" id="4996285">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996292">req</span><span class="op" id="4996295">.</span><span class="ident" id="4996296">URL</span><span class="op" id="4996299">.</span><span class="ident" id="4996300">Path</span>&nbsp;<span class="op" id="4996305">=</span>&nbsp;<span class="ident" id="4996307">singleJoiningSlash</span><span class="op" id="4996325">(</span><span class="ident" id="4996326">target</span><span class="op" id="4996332">.</span><span class="ident" id="4996333">Path</span><span class="op" id="4996337">,</span>&nbsp;<span class="ident" id="4996339">req</span><span class="op" id="4996342">.</span><span class="ident" id="4996343">URL</span><span class="op" id="4996346">.</span><span class="ident" id="4996347">Path</span><span class="op" id="4996351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4996355">if</span>&nbsp;<span class="ident" id="4996358">targetQuery</span>&nbsp;<span class="op" id="4996370">==</span>&nbsp;<span class="string" id="4996373">&#34;&#34;</span>&nbsp;<span class="op" id="4996376">||</span>&nbsp;<span class="ident" id="4996379">req</span><span class="op" id="4996382">.</span><span class="ident" id="4996383">URL</span><span class="op" id="4996386">.</span><span class="ident" id="4996387">RawQuery</span>&nbsp;<span class="op" id="4996396">==</span>&nbsp;<span class="string" id="4996399">&#34;&#34;</span>&nbsp;<span class="op" id="4996402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996407">req</span><span class="op" id="4996410">.</span><span class="ident" id="4996411">URL</span><span class="op" id="4996414">.</span><span class="ident" id="4996415">RawQuery</span>&nbsp;<span class="op" id="4996424">=</span>&nbsp;<span class="ident" id="4996426">targetQuery</span>&nbsp;<span class="op" id="4996438">+</span>&nbsp;<span class="ident" id="4996440">req</span><span class="op" id="4996443">.</span><span class="ident" id="4996444">URL</span><span class="op" id="4996447">.</span><span class="ident" id="4996448">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996459">}</span>&nbsp;<span class="keyword" id="4996461">else</span>&nbsp;<span class="op" id="4996466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996471">req</span><span class="op" id="4996474">.</span><span class="ident" id="4996475">URL</span><span class="op" id="4996478">.</span><span class="ident" id="4996479">RawQuery</span>&nbsp;<span class="op" id="4996488">=</span>&nbsp;<span class="ident" id="4996490">targetQuery</span>&nbsp;<span class="op" id="4996502">+</span>&nbsp;<span class="string" id="4996504">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="4996508">+</span>&nbsp;<span class="ident" id="4996510">req</span><span class="op" id="4996513">.</span><span class="ident" id="4996514">URL</span><span class="op" id="4996517">.</span><span class="ident" id="4996518">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4996535">return</span>&nbsp;<span class="op" id="4996542">&amp;</span><span class="ident" id="4996543">ReverseProxy</span><span class="op" id="4996555">{</span><span class="ident" id="4996556">Director</span><span class="op" id="4996564">:</span>&nbsp;<span class="ident" id="4996566">director</span><span class="op" id="4996574">}</span><br>
<span class="lineno">80</span><span class="op" id="4996576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4996579">func</span>&nbsp;<span class="ident" id="4996584">copyHeader</span><span class="op" id="4996594">(</span><span class="ident" id="4996595">dst</span><span class="op" id="4996598">,</span>&nbsp;<span class="ident" id="4996600">src</span>&nbsp;<span class="ident" id="4996604">http</span><span class="op" id="4996608">.</span><span class="ident" id="4996609">Header</span><span class="op" id="4996615">)</span>&nbsp;<span class="op" id="4996617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4996620">for</span>&nbsp;<span class="ident" id="4996624">k</span><span class="op" id="4996625">,</span>&nbsp;<span class="ident" id="4996627">vv</span>&nbsp;<span class="op" id="4996630">:=</span>&nbsp;<span class="keyword" id="4996633">range</span>&nbsp;<span class="ident" id="4996639">src</span>&nbsp;<span class="op" id="4996643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4996647">for</span>&nbsp;<span class="ident" id="4996651">_</span><span class="op" id="4996652">,</span>&nbsp;<span class="ident" id="4996654">v</span>&nbsp;<span class="op" id="4996656">:=</span>&nbsp;<span class="keyword" id="4996659">range</span>&nbsp;<span class="ident" id="4996665">vv</span>&nbsp;<span class="op" id="4996668">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4996673">dst</span><span class="op" id="4996676">.</span><span class="ident" id="4996677">Add</span><span class="op" id="4996680">(</span><span class="ident" id="4996681">k</span><span class="op" id="4996682">,</span>&nbsp;<span class="ident" id="4996684">v</span><span class="op" id="4996685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4996692">}</span><br>
<span class="lineno"></span><span class="op" id="4996694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4996697">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="4996764">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="4996822">var</span>&nbsp;<span class="ident" id="4996826">hopHeaders</span>&nbsp;<span class="op" id="4996837">=</span>&nbsp;<span class="op" id="4996839">[</span><span class="op" id="4996840">]</span><span class="builtintype" id="4996841">string</span><span class="op" id="4996847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996850">&#34;Connection&#34;</span><span class="op" id="4996862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996865">&#34;Keep-Alive&#34;</span><span class="op" id="4996877">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996880">&#34;Proxy-Authenticate&#34;</span><span class="op" id="4996900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996903">&#34;Proxy-Authorization&#34;</span><span class="op" id="4996924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996927">&#34;Te&#34;</span><span class="op" id="4996931">,</span>&nbsp;<span class="comment" id="4996933">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996967">&#34;Trailers&#34;</span><span class="op" id="4996977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4996980">&#34;Transfer-Encoding&#34;</span><span class="op" id="4996999">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4997002">&#34;Upgrade&#34;</span><span class="op" id="4997011">,</span><br>
<span class="lineno"></span><span class="op" id="4997013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4997016">func</span>&nbsp;<span class="op" id="4997021">(</span><span class="ident" id="4997022">p</span>&nbsp;<span class="op" id="4997024">*</span><span class="ident" id="4997025">ReverseProxy</span><span class="op" id="4997037">)</span>&nbsp;<span class="ident" id="4997039">ServeHTTP</span><span class="op" id="4997048">(</span><span class="ident" id="4997049">rw</span>&nbsp;<span class="ident" id="4997052">http</span><span class="op" id="4997056">.</span><span class="ident" id="4997057">ResponseWriter</span><span class="op" id="4997071">,</span>&nbsp;<span class="ident" id="4997073">req</span>&nbsp;<span class="op" id="4997077">*</span><span class="ident" id="4997078">http</span><span class="op" id="4997082">.</span><span class="ident" id="4997083">Request</span><span class="op" id="4997090">)</span>&nbsp;<span class="op" id="4997092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997095">transport</span>&nbsp;<span class="op" id="4997105">:=</span>&nbsp;<span class="ident" id="4997108">p</span><span class="op" id="4997109">.</span><span class="ident" id="4997110">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4997121">if</span>&nbsp;<span class="ident" id="4997124">transport</span>&nbsp;<span class="op" id="4997134">==</span>&nbsp;<span class="builtintype" id="4997137">nil</span>&nbsp;<span class="op" id="4997141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997145">transport</span>&nbsp;<span class="op" id="4997155">=</span>&nbsp;<span class="ident" id="4997157">http</span><span class="op" id="4997161">.</span><span class="ident" id="4997162">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997184">outreq</span>&nbsp;<span class="op" id="4997191">:=</span>&nbsp;<span class="builtinfunc" id="4997194">new</span><span class="op" id="4997197">(</span><span class="ident" id="4997198">http</span><span class="op" id="4997202">.</span><span class="ident" id="4997203">Request</span><span class="op" id="4997210">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997213">*</span><span class="ident" id="4997214">outreq</span>&nbsp;<span class="op" id="4997221">=</span>&nbsp;<span class="op" id="4997223">*</span><span class="ident" id="4997224">req</span>&nbsp;<span class="comment" id="4997228">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997275">p</span><span class="op" id="4997276">.</span><span class="ident" id="4997277">Director</span><span class="op" id="4997285">(</span><span class="ident" id="4997286">outreq</span><span class="op" id="4997292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997295">outreq</span><span class="op" id="4997301">.</span><span class="ident" id="4997302">Proto</span>&nbsp;<span class="op" id="4997308">=</span>&nbsp;<span class="string" id="4997310">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997322">outreq</span><span class="op" id="4997328">.</span><span class="ident" id="4997329">ProtoMajor</span>&nbsp;<span class="op" id="4997340">=</span>&nbsp;<span class="num" id="4997342">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997345">outreq</span><span class="op" id="4997351">.</span><span class="ident" id="4997352">ProtoMinor</span>&nbsp;<span class="op" id="4997363">=</span>&nbsp;<span class="num" id="4997365">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997368">outreq</span><span class="op" id="4997374">.</span><span class="ident" id="4997375">Close</span>&nbsp;<span class="op" id="4997381">=</span>&nbsp;<span class="builtintype" id="4997383">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4997391">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4997449">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4997508">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4997572">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4997631">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997682">copiedHeaders</span>&nbsp;<span class="op" id="4997696">:=</span>&nbsp;<span class="builtintype" id="4997699">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4997706">for</span>&nbsp;<span class="ident" id="4997710">_</span><span class="op" id="4997711">,</span>&nbsp;<span class="ident" id="4997713">h</span>&nbsp;<span class="op" id="4997715">:=</span>&nbsp;<span class="keyword" id="4997718">range</span>&nbsp;<span class="ident" id="4997724">hopHeaders</span>&nbsp;<span class="op" id="4997735">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4997739">if</span>&nbsp;<span class="ident" id="4997742">outreq</span><span class="op" id="4997748">.</span><span class="ident" id="4997749">Header</span><span class="op" id="4997755">.</span><span class="ident" id="4997756">Get</span><span class="op" id="4997759">(</span><span class="ident" id="4997760">h</span><span class="op" id="4997761">)</span>&nbsp;<span class="op" id="4997763">!=</span>&nbsp;<span class="string" id="4997766">&#34;&#34;</span>&nbsp;<span class="op" id="4997769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4997774">if</span>&nbsp;<span class="op" id="4997777">!</span><span class="ident" id="4997778">copiedHeaders</span>&nbsp;<span class="op" id="4997792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997798">outreq</span><span class="op" id="4997804">.</span><span class="ident" id="4997805">Header</span>&nbsp;<span class="op" id="4997812">=</span>&nbsp;<span class="builtinfunc" id="4997814">make</span><span class="op" id="4997818">(</span><span class="ident" id="4997819">http</span><span class="op" id="4997823">.</span><span class="ident" id="4997824">Header</span><span class="op" id="4997830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997836">copyHeader</span><span class="op" id="4997846">(</span><span class="ident" id="4997847">outreq</span><span class="op" id="4997853">.</span><span class="ident" id="4997854">Header</span><span class="op" id="4997860">,</span>&nbsp;<span class="ident" id="4997862">req</span><span class="op" id="4997865">.</span><span class="ident" id="4997866">Header</span><span class="op" id="4997872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997878">copiedHeaders</span>&nbsp;<span class="op" id="4997892">=</span>&nbsp;<span class="builtintype" id="4997894">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4997907">outreq</span><span class="op" id="4997913">.</span><span class="ident" id="4997914">Header</span><span class="op" id="4997920">.</span><span class="ident" id="4997921">Del</span><span class="op" id="4997924">(</span><span class="ident" id="4997925">h</span><span class="op" id="4997926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4997933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4997937">if</span>&nbsp;<span class="ident" id="4997940">clientIP</span><span class="op" id="4997948">,</span>&nbsp;<span class="ident" id="4997950">_</span><span class="op" id="4997951">,</span>&nbsp;<span class="ident" id="4997953">err</span>&nbsp;<span class="op" id="4997957">:=</span>&nbsp;<span class="ident" id="4997960">net</span><span class="op" id="4997963">.</span><span class="ident" id="4997964">SplitHostPort</span><span class="op" id="4997977">(</span><span class="ident" id="4997978">req</span><span class="op" id="4997981">.</span><span class="ident" id="4997982">RemoteAddr</span><span class="op" id="4997992">)</span><span class="op" id="4997993">;</span>&nbsp;<span class="ident" id="4997995">err</span>&nbsp;<span class="op" id="4997999">==</span>&nbsp;<span class="builtintype" id="4998002">nil</span>&nbsp;<span class="op" id="4998006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4998010">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4998057">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4998107">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998163">if</span>&nbsp;<span class="ident" id="4998166">prior</span><span class="op" id="4998171">,</span>&nbsp;<span class="ident" id="4998173">ok</span>&nbsp;<span class="op" id="4998176">:=</span>&nbsp;<span class="ident" id="4998179">outreq</span><span class="op" id="4998185">.</span><span class="ident" id="4998186">Header</span><span class="op" id="4998192">[</span><span class="string" id="4998193">&#34;X-Forwarded-For&#34;</span><span class="op" id="4998210">]</span><span class="op" id="4998211">;</span>&nbsp;<span class="ident" id="4998213">ok</span>&nbsp;<span class="op" id="4998216">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998221">clientIP</span>&nbsp;<span class="op" id="4998230">=</span>&nbsp;<span class="ident" id="4998232">strings</span><span class="op" id="4998239">.</span><span class="ident" id="4998240">Join</span><span class="op" id="4998244">(</span><span class="ident" id="4998245">prior</span><span class="op" id="4998250">,</span>&nbsp;<span class="string" id="4998252">&#34;,&nbsp;&#34;</span><span class="op" id="4998256">)</span>&nbsp;<span class="op" id="4998258">+</span>&nbsp;<span class="string" id="4998260">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="4998265">+</span>&nbsp;<span class="ident" id="4998267">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998282">outreq</span><span class="op" id="4998288">.</span><span class="ident" id="4998289">Header</span><span class="op" id="4998295">.</span><span class="ident" id="4998296">Set</span><span class="op" id="4998299">(</span><span class="string" id="4998300">&#34;X-Forwarded-For&#34;</span><span class="op" id="4998317">,</span>&nbsp;<span class="ident" id="4998319">clientIP</span><span class="op" id="4998327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998334">res</span><span class="op" id="4998337">,</span>&nbsp;<span class="ident" id="4998339">err</span>&nbsp;<span class="op" id="4998343">:=</span>&nbsp;<span class="ident" id="4998346">transport</span><span class="op" id="4998355">.</span><span class="ident" id="4998356">RoundTrip</span><span class="op" id="4998365">(</span><span class="ident" id="4998366">outreq</span><span class="op" id="4998372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998375">if</span>&nbsp;<span class="ident" id="4998378">err</span>&nbsp;<span class="op" id="4998382">!=</span>&nbsp;<span class="builtintype" id="4998385">nil</span>&nbsp;<span class="op" id="4998389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998393">p</span><span class="op" id="4998394">.</span><span class="ident" id="4998395">logf</span><span class="op" id="4998399">(</span><span class="string" id="4998400">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="4998423">,</span>&nbsp;<span class="ident" id="4998425">err</span><span class="op" id="4998428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998432">rw</span><span class="op" id="4998434">.</span><span class="ident" id="4998435">WriteHeader</span><span class="op" id="4998446">(</span><span class="ident" id="4998447">http</span><span class="op" id="4998451">.</span><span class="ident" id="4998452">StatusInternalServerError</span><span class="op" id="4998477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998481">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998492">defer</span>&nbsp;<span class="ident" id="4998498">res</span><span class="op" id="4998501">.</span><span class="ident" id="4998502">Body</span><span class="op" id="4998506">.</span><span class="ident" id="4998507">Close</span><span class="op" id="4998512">(</span><span class="op" id="4998513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998517">for</span>&nbsp;<span class="ident" id="4998521">_</span><span class="op" id="4998522">,</span>&nbsp;<span class="ident" id="4998524">h</span>&nbsp;<span class="op" id="4998526">:=</span>&nbsp;<span class="keyword" id="4998529">range</span>&nbsp;<span class="ident" id="4998535">hopHeaders</span>&nbsp;<span class="op" id="4998546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998550">res</span><span class="op" id="4998553">.</span><span class="ident" id="4998554">Header</span><span class="op" id="4998560">.</span><span class="ident" id="4998561">Del</span><span class="op" id="4998564">(</span><span class="ident" id="4998565">h</span><span class="op" id="4998566">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998573">copyHeader</span><span class="op" id="4998583">(</span><span class="ident" id="4998584">rw</span><span class="op" id="4998586">.</span><span class="ident" id="4998587">Header</span><span class="op" id="4998593">(</span><span class="op" id="4998594">)</span><span class="op" id="4998595">,</span>&nbsp;<span class="ident" id="4998597">res</span><span class="op" id="4998600">.</span><span class="ident" id="4998601">Header</span><span class="op" id="4998607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998611">rw</span><span class="op" id="4998613">.</span><span class="ident" id="4998614">WriteHeader</span><span class="op" id="4998625">(</span><span class="ident" id="4998626">res</span><span class="op" id="4998629">.</span><span class="ident" id="4998630">StatusCode</span><span class="op" id="4998640">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998643">p</span><span class="op" id="4998644">.</span><span class="ident" id="4998645">copyResponse</span><span class="op" id="4998657">(</span><span class="ident" id="4998658">rw</span><span class="op" id="4998660">,</span>&nbsp;<span class="ident" id="4998662">res</span><span class="op" id="4998665">.</span><span class="ident" id="4998666">Body</span><span class="op" id="4998670">)</span><br>
<span class="lineno"></span><span class="op" id="4998672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4998675">func</span>&nbsp;<span class="op" id="4998680">(</span><span class="ident" id="4998681">p</span>&nbsp;<span class="op" id="4998683">*</span><span class="ident" id="4998684">ReverseProxy</span><span class="op" id="4998696">)</span>&nbsp;<span class="ident" id="4998698">copyResponse</span><span class="op" id="4998710">(</span><span class="ident" id="4998711">dst</span>&nbsp;<span class="ident" id="4998715">io</span><span class="op" id="4998717">.</span><span class="ident" id="4998718">Writer</span><span class="op" id="4998724">,</span>&nbsp;<span class="ident" id="4998726">src</span>&nbsp;<span class="ident" id="4998730">io</span><span class="op" id="4998732">.</span><span class="ident" id="4998733">Reader</span><span class="op" id="4998739">)</span>&nbsp;<span class="op" id="4998741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998744">if</span>&nbsp;<span class="ident" id="4998747">p</span><span class="op" id="4998748">.</span><span class="ident" id="4998749">FlushInterval</span>&nbsp;<span class="op" id="4998763">!=</span>&nbsp;<span class="num" id="4998766">0</span>&nbsp;<span class="op" id="4998768">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998772">if</span>&nbsp;<span class="ident" id="4998775">wf</span><span class="op" id="4998777">,</span>&nbsp;<span class="ident" id="4998779">ok</span>&nbsp;<span class="op" id="4998782">:=</span>&nbsp;<span class="ident" id="4998785">dst</span><span class="op" id="4998788">.</span><span class="op" id="4998789">(</span><span class="ident" id="4998790">writeFlusher</span><span class="op" id="4998802">)</span><span class="op" id="4998803">;</span>&nbsp;<span class="ident" id="4998805">ok</span>&nbsp;<span class="op" id="4998808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998813">mlw</span>&nbsp;<span class="op" id="4998817">:=</span>&nbsp;<span class="op" id="4998820">&amp;</span><span class="ident" id="4998821">maxLatencyWriter</span><span class="op" id="4998837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998843">dst</span><span class="op" id="4998846">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998852">wf</span><span class="op" id="4998854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998860">latency</span><span class="op" id="4998867">:</span>&nbsp;<span class="ident" id="4998869">p</span><span class="op" id="4998870">.</span><span class="ident" id="4998871">FlushInterval</span><span class="op" id="4998884">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998890">done</span><span class="op" id="4998894">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4998899">make</span><span class="op" id="4998903">(</span><span class="keyword" id="4998904">chan</span>&nbsp;<span class="builtintype" id="4998909">bool</span><span class="op" id="4998913">)</span><span class="op" id="4998914">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998924">go</span>&nbsp;<span class="ident" id="4998927">mlw</span><span class="op" id="4998930">.</span><span class="ident" id="4998931">flushLoop</span><span class="op" id="4998940">(</span><span class="op" id="4998941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998946">defer</span>&nbsp;<span class="ident" id="4998952">mlw</span><span class="op" id="4998955">.</span><span class="ident" id="4998956">stop</span><span class="op" id="4998960">(</span><span class="op" id="4998961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998966">dst</span>&nbsp;<span class="op" id="4998970">=</span>&nbsp;<span class="ident" id="4998972">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998978">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998985">io</span><span class="op" id="4998987">.</span><span class="ident" id="4998988">Copy</span><span class="op" id="4998992">(</span><span class="ident" id="4998993">dst</span><span class="op" id="4998996">,</span>&nbsp;<span class="ident" id="4998998">src</span><span class="op" id="4999001">)</span><br>
<span class="lineno"></span><span class="op" id="4999003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="4999006">func</span>&nbsp;<span class="op" id="4999011">(</span><span class="ident" id="4999012">p</span>&nbsp;<span class="op" id="4999014">*</span><span class="ident" id="4999015">ReverseProxy</span><span class="op" id="4999027">)</span>&nbsp;<span class="ident" id="4999029">logf</span><span class="op" id="4999033">(</span><span class="ident" id="4999034">format</span>&nbsp;<span class="builtintype" id="4999041">string</span><span class="op" id="4999047">,</span>&nbsp;<span class="ident" id="4999049">args</span>&nbsp;<span class="op" id="4999054">...</span><span class="keyword" id="4999057">interface</span><span class="op" id="4999066">{</span><span class="op" id="4999067">}</span><span class="op" id="4999068">)</span>&nbsp;<span class="op" id="4999070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999073">if</span>&nbsp;<span class="ident" id="4999076">p</span><span class="op" id="4999077">.</span><span class="ident" id="4999078">ErrorLog</span>&nbsp;<span class="op" id="4999087">!=</span>&nbsp;<span class="builtintype" id="4999090">nil</span>&nbsp;<span class="op" id="4999094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999098">p</span><span class="op" id="4999099">.</span><span class="ident" id="4999100">ErrorLog</span><span class="op" id="4999108">.</span><span class="ident" id="4999109">Printf</span><span class="op" id="4999115">(</span><span class="ident" id="4999116">format</span><span class="op" id="4999122">,</span>&nbsp;<span class="ident" id="4999124">args</span><span class="op" id="4999128">...</span><span class="op" id="4999131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4999134">}</span>&nbsp;<span class="keyword" id="4999136">else</span>&nbsp;<span class="op" id="4999141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999145">log</span><span class="op" id="4999148">.</span><span class="ident" id="4999149">Printf</span><span class="op" id="4999155">(</span><span class="ident" id="4999156">format</span><span class="op" id="4999162">,</span>&nbsp;<span class="ident" id="4999164">args</span><span class="op" id="4999168">...</span><span class="op" id="4999171">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4999174">}</span><br>
<span class="lineno"></span><span class="op" id="4999176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4999179">type</span>&nbsp;<span class="ident" id="4999184">writeFlusher</span>&nbsp;<span class="keyword" id="4999197">interface</span>&nbsp;<span class="op" id="4999207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999210">io</span><span class="op" id="4999212">.</span><span class="ident" id="4999213">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999221">http</span><span class="op" id="4999225">.</span><span class="ident" id="4999226">Flusher</span><br>
<span class="lineno"></span><span class="op" id="4999234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4999237">type</span>&nbsp;<span class="ident" id="4999242">maxLatencyWriter</span>&nbsp;<span class="keyword" id="4999259">struct</span>&nbsp;<span class="op" id="4999266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999269">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999277">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999291">latency</span>&nbsp;<span class="ident" id="4999299">time</span><span class="op" id="4999303">.</span><span class="ident" id="4999304">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999315">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4999320">sync</span><span class="op" id="4999324">.</span><span class="ident" id="4999325">Mutex</span>&nbsp;<span class="comment" id="4999331">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999358">done</span>&nbsp;<span class="keyword" id="4999363">chan</span>&nbsp;<span class="builtintype" id="4999368">bool</span><br>
<span class="lineno"></span><span class="op" id="4999373">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4999376">func</span>&nbsp;<span class="op" id="4999381">(</span><span class="ident" id="4999382">m</span>&nbsp;<span class="op" id="4999384">*</span><span class="ident" id="4999385">maxLatencyWriter</span><span class="op" id="4999401">)</span>&nbsp;<span class="ident" id="4999403">Write</span><span class="op" id="4999408">(</span><span class="ident" id="4999409">p</span>&nbsp;<span class="op" id="4999411">[</span><span class="op" id="4999412">]</span><span class="builtintype" id="4999413">byte</span><span class="op" id="4999417">)</span>&nbsp;<span class="op" id="4999419">(</span><span class="builtintype" id="4999420">int</span><span class="op" id="4999423">,</span>&nbsp;<span class="builtintype" id="4999425">error</span><span class="op" id="4999430">)</span>&nbsp;<span class="op" id="4999432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999435">m</span><span class="op" id="4999436">.</span><span class="ident" id="4999437">lk</span><span class="op" id="4999439">.</span><span class="ident" id="4999440">Lock</span><span class="op" id="4999444">(</span><span class="op" id="4999445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999448">defer</span>&nbsp;<span class="ident" id="4999454">m</span><span class="op" id="4999455">.</span><span class="ident" id="4999456">lk</span><span class="op" id="4999458">.</span><span class="ident" id="4999459">Unlock</span><span class="op" id="4999465">(</span><span class="op" id="4999466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999469">return</span>&nbsp;<span class="ident" id="4999476">m</span><span class="op" id="4999477">.</span><span class="ident" id="4999478">dst</span><span class="op" id="4999481">.</span><span class="ident" id="4999482">Write</span><span class="op" id="4999487">(</span><span class="ident" id="4999488">p</span><span class="op" id="4999489">)</span><br>
<span class="lineno">205</span><span class="op" id="4999491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4999494">func</span>&nbsp;<span class="op" id="4999499">(</span><span class="ident" id="4999500">m</span>&nbsp;<span class="op" id="4999502">*</span><span class="ident" id="4999503">maxLatencyWriter</span><span class="op" id="4999519">)</span>&nbsp;<span class="ident" id="4999521">flushLoop</span><span class="op" id="4999530">(</span><span class="op" id="4999531">)</span>&nbsp;<span class="op" id="4999533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999536">t</span>&nbsp;<span class="op" id="4999538">:=</span>&nbsp;<span class="ident" id="4999541">time</span><span class="op" id="4999545">.</span><span class="ident" id="4999546">NewTicker</span><span class="op" id="4999555">(</span><span class="ident" id="4999556">m</span><span class="op" id="4999557">.</span><span class="ident" id="4999558">latency</span><span class="op" id="4999565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999568">defer</span>&nbsp;<span class="ident" id="4999574">t</span><span class="op" id="4999575">.</span><span class="ident" id="4999576">Stop</span><span class="op" id="4999580">(</span><span class="op" id="4999581">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999584">for</span>&nbsp;<span class="op" id="4999588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999592">select</span>&nbsp;<span class="op" id="4999599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999603">case</span>&nbsp;<span class="op" id="4999608">&lt;-</span><span class="ident" id="4999610">m</span><span class="op" id="4999611">.</span><span class="ident" id="4999612">done</span><span class="op" id="4999616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999621">if</span>&nbsp;<span class="ident" id="4999624">onExitFlushLoop</span>&nbsp;<span class="op" id="4999640">!=</span>&nbsp;<span class="builtintype" id="4999643">nil</span>&nbsp;<span class="op" id="4999647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999653">onExitFlushLoop</span><span class="op" id="4999668">(</span><span class="op" id="4999669">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4999674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999679">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4999688">case</span>&nbsp;<span class="op" id="4999693">&lt;-</span><span class="ident" id="4999695">t</span><span class="op" id="4999696">.</span><span class="ident" id="4999697">C</span><span class="op" id="4999698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999703">m</span><span class="op" id="4999704">.</span><span class="ident" id="4999705">lk</span><span class="op" id="4999707">.</span><span class="ident" id="4999708">Lock</span><span class="op" id="4999712">(</span><span class="op" id="4999713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999718">m</span><span class="op" id="4999719">.</span><span class="ident" id="4999720">dst</span><span class="op" id="4999723">.</span><span class="ident" id="4999724">Flush</span><span class="op" id="4999729">(</span><span class="op" id="4999730">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4999735">m</span><span class="op" id="4999736">.</span><span class="ident" id="4999737">lk</span><span class="op" id="4999739">.</span><span class="ident" id="4999740">Unlock</span><span class="op" id="4999746">(</span><span class="op" id="4999747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4999751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4999754">}</span><br>
<span class="lineno"></span><span class="op" id="4999756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="4999759">func</span>&nbsp;<span class="op" id="4999764">(</span><span class="ident" id="4999765">m</span>&nbsp;<span class="op" id="4999767">*</span><span class="ident" id="4999768">maxLatencyWriter</span><span class="op" id="4999784">)</span>&nbsp;<span class="ident" id="4999786">stop</span><span class="op" id="4999790">(</span><span class="op" id="4999791">)</span>&nbsp;<span class="op" id="4999793">{</span>&nbsp;<span class="ident" id="4999795">m</span><span class="op" id="4999796">.</span><span class="ident" id="4999797">done</span>&nbsp;<span class="op" id="4999802">&lt;-</span>&nbsp;<span class="builtintype" id="4999805">true</span>&nbsp;<span class="op" id="4999810">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
