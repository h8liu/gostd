<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html" class="current">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8537207">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8537263">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8537317">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8537368">package</span>&nbsp;<span class="ident" id="8537376">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8537383">import</span>&nbsp;<span class="op" id="8537390">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8537393">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8537404">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8537415">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8537422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8537425">func</span>&nbsp;<span class="ident" id="8537430">TestReadGCStats</span><span class="op" id="8537445">(</span><span class="ident" id="8537446">t</span>&nbsp;<span class="op" id="8537448">*</span><span class="ident" id="8537449">testing</span><span class="op" id="8537456">.</span><span class="ident" id="8537457">T</span><span class="op" id="8537458">)</span>&nbsp;<span class="op" id="8537460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8537463">defer</span>&nbsp;<span class="ident" id="8537469">SetGCPercent</span><span class="op" id="8537481">(</span><span class="ident" id="8537482">SetGCPercent</span><span class="op" id="8537494">(</span><span class="op" id="8537495">-</span><span class="num" id="8537496">1</span><span class="op" id="8537497">)</span><span class="op" id="8537498">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8537502">var</span>&nbsp;<span class="ident" id="8537506">stats</span>&nbsp;<span class="ident" id="8537512">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8537521">var</span>&nbsp;<span class="ident" id="8537525">mstats</span>&nbsp;<span class="ident" id="8537532">runtime</span><span class="op" id="8537539">.</span><span class="ident" id="8537540">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8537550">var</span>&nbsp;<span class="ident" id="8537554">min</span><span class="op" id="8537557">,</span>&nbsp;<span class="ident" id="8537559">max</span>&nbsp;<span class="ident" id="8537563">time</span><span class="op" id="8537567">.</span><span class="ident" id="8537568">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8537579">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8537635">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537703">stats</span><span class="op" id="8537708">.</span><span class="ident" id="8537709">PauseQuantiles</span>&nbsp;<span class="op" id="8537724">=</span>&nbsp;<span class="builtinfunc" id="8537726">make</span><span class="op" id="8537730">(</span><span class="op" id="8537731">[</span><span class="op" id="8537732">]</span><span class="ident" id="8537733">time</span><span class="op" id="8537737">.</span><span class="ident" id="8537738">Duration</span><span class="op" id="8537746">,</span>&nbsp;<span class="num" id="8537748">10</span><span class="op" id="8537750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537753">ReadGCStats</span><span class="op" id="8537764">(</span><span class="op" id="8537765">&amp;</span><span class="ident" id="8537766">stats</span><span class="op" id="8537771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537774">runtime</span><span class="op" id="8537781">.</span><span class="ident" id="8537782">GC</span><span class="op" id="8537784">(</span><span class="op" id="8537785">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8537789">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537855">ReadGCStats</span><span class="op" id="8537866">(</span><span class="op" id="8537867">&amp;</span><span class="ident" id="8537868">stats</span><span class="op" id="8537873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537876">runtime</span><span class="op" id="8537883">.</span><span class="ident" id="8537884">ReadMemStats</span><span class="op" id="8537896">(</span><span class="op" id="8537897">&amp;</span><span class="ident" id="8537898">mstats</span><span class="op" id="8537904">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8537908">if</span>&nbsp;<span class="ident" id="8537911">stats</span><span class="op" id="8537916">.</span><span class="ident" id="8537917">NumGC</span>&nbsp;<span class="op" id="8537923">!=</span>&nbsp;<span class="ident" id="8537926">int64</span><span class="op" id="8537931">(</span><span class="ident" id="8537932">mstats</span><span class="op" id="8537938">.</span><span class="ident" id="8537939">NumGC</span><span class="op" id="8537944">)</span>&nbsp;<span class="op" id="8537946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8537950">t</span><span class="op" id="8537951">.</span><span class="ident" id="8537952">Errorf</span><span class="op" id="8537958">(</span><span class="string" id="8537959">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8538000">,</span>&nbsp;<span class="ident" id="8538002">stats</span><span class="op" id="8538007">.</span><span class="ident" id="8538008">NumGC</span><span class="op" id="8538013">,</span>&nbsp;<span class="ident" id="8538015">mstats</span><span class="op" id="8538021">.</span><span class="ident" id="8538022">NumGC</span><span class="op" id="8538027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538033">if</span>&nbsp;<span class="ident" id="8538036">stats</span><span class="op" id="8538041">.</span><span class="ident" id="8538042">PauseTotal</span>&nbsp;<span class="op" id="8538053">!=</span>&nbsp;<span class="ident" id="8538056">time</span><span class="op" id="8538060">.</span><span class="ident" id="8538061">Duration</span><span class="op" id="8538069">(</span><span class="ident" id="8538070">mstats</span><span class="op" id="8538076">.</span><span class="ident" id="8538077">PauseTotalNs</span><span class="op" id="8538089">)</span>&nbsp;<span class="op" id="8538091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538095">t</span><span class="op" id="8538096">.</span><span class="ident" id="8538097">Errorf</span><span class="op" id="8538103">(</span><span class="string" id="8538104">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8538157">,</span>&nbsp;<span class="ident" id="8538159">stats</span><span class="op" id="8538164">.</span><span class="ident" id="8538165">PauseTotal</span><span class="op" id="8538175">,</span>&nbsp;<span class="ident" id="8538177">mstats</span><span class="op" id="8538183">.</span><span class="ident" id="8538184">PauseTotalNs</span><span class="op" id="8538196">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538202">if</span>&nbsp;<span class="ident" id="8538205">stats</span><span class="op" id="8538210">.</span><span class="ident" id="8538211">LastGC</span><span class="op" id="8538217">.</span><span class="ident" id="8538218">UnixNano</span><span class="op" id="8538226">(</span><span class="op" id="8538227">)</span>&nbsp;<span class="op" id="8538229">!=</span>&nbsp;<span class="ident" id="8538232">int64</span><span class="op" id="8538237">(</span><span class="ident" id="8538238">mstats</span><span class="op" id="8538244">.</span><span class="ident" id="8538245">LastGC</span><span class="op" id="8538251">)</span>&nbsp;<span class="op" id="8538253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538257">t</span><span class="op" id="8538258">.</span><span class="ident" id="8538259">Errorf</span><span class="op" id="8538265">(</span><span class="string" id="8538266">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8538318">,</span>&nbsp;<span class="ident" id="8538320">stats</span><span class="op" id="8538325">.</span><span class="ident" id="8538326">LastGC</span><span class="op" id="8538332">.</span><span class="ident" id="8538333">UnixNano</span><span class="op" id="8538341">(</span><span class="op" id="8538342">)</span><span class="op" id="8538343">,</span>&nbsp;<span class="ident" id="8538345">mstats</span><span class="op" id="8538351">.</span><span class="ident" id="8538352">LastGC</span><span class="op" id="8538358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538364">n</span>&nbsp;<span class="op" id="8538366">:=</span>&nbsp;<span class="builtintype" id="8538369">int</span><span class="op" id="8538372">(</span><span class="ident" id="8538373">mstats</span><span class="op" id="8538379">.</span><span class="ident" id="8538380">NumGC</span><span class="op" id="8538385">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538388">if</span>&nbsp;<span class="ident" id="8538391">n</span>&nbsp;<span class="op" id="8538393">&gt;</span>&nbsp;<span class="builtinfunc" id="8538395">len</span><span class="op" id="8538398">(</span><span class="ident" id="8538399">mstats</span><span class="op" id="8538405">.</span><span class="ident" id="8538406">PauseNs</span><span class="op" id="8538413">)</span>&nbsp;<span class="op" id="8538415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538419">n</span>&nbsp;<span class="op" id="8538421">=</span>&nbsp;<span class="builtinfunc" id="8538423">len</span><span class="op" id="8538426">(</span><span class="ident" id="8538427">mstats</span><span class="op" id="8538433">.</span><span class="ident" id="8538434">PauseNs</span><span class="op" id="8538441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538447">if</span>&nbsp;<span class="builtinfunc" id="8538450">len</span><span class="op" id="8538453">(</span><span class="ident" id="8538454">stats</span><span class="op" id="8538459">.</span><span class="ident" id="8538460">Pause</span><span class="op" id="8538465">)</span>&nbsp;<span class="op" id="8538467">!=</span>&nbsp;<span class="ident" id="8538470">n</span>&nbsp;<span class="op" id="8538472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538476">t</span><span class="op" id="8538477">.</span><span class="ident" id="8538478">Errorf</span><span class="op" id="8538484">(</span><span class="string" id="8538485">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8538517">,</span>&nbsp;<span class="builtinfunc" id="8538519">len</span><span class="op" id="8538522">(</span><span class="ident" id="8538523">stats</span><span class="op" id="8538528">.</span><span class="ident" id="8538529">Pause</span><span class="op" id="8538534">)</span><span class="op" id="8538535">,</span>&nbsp;<span class="ident" id="8538537">n</span><span class="op" id="8538538">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538541">}</span>&nbsp;<span class="keyword" id="8538543">else</span>&nbsp;<span class="op" id="8538548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538552">off</span>&nbsp;<span class="op" id="8538556">:=</span>&nbsp;<span class="op" id="8538559">(</span><span class="builtintype" id="8538560">int</span><span class="op" id="8538563">(</span><span class="ident" id="8538564">mstats</span><span class="op" id="8538570">.</span><span class="ident" id="8538571">NumGC</span><span class="op" id="8538576">)</span>&nbsp;<span class="op" id="8538578">+</span>&nbsp;<span class="builtinfunc" id="8538580">len</span><span class="op" id="8538583">(</span><span class="ident" id="8538584">mstats</span><span class="op" id="8538590">.</span><span class="ident" id="8538591">PauseNs</span><span class="op" id="8538598">)</span>&nbsp;<span class="op" id="8538600">-</span>&nbsp;<span class="num" id="8538602">1</span><span class="op" id="8538603">)</span>&nbsp;<span class="op" id="8538605">%</span>&nbsp;<span class="builtinfunc" id="8538607">len</span><span class="op" id="8538610">(</span><span class="ident" id="8538611">mstats</span><span class="op" id="8538617">.</span><span class="ident" id="8538618">PauseNs</span><span class="op" id="8538625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538629">for</span>&nbsp;<span class="ident" id="8538633">i</span>&nbsp;<span class="op" id="8538635">:=</span>&nbsp;<span class="num" id="8538638">0</span><span class="op" id="8538639">;</span>&nbsp;<span class="ident" id="8538641">i</span>&nbsp;<span class="op" id="8538643">&lt;</span>&nbsp;<span class="ident" id="8538645">n</span><span class="op" id="8538646">;</span>&nbsp;<span class="ident" id="8538648">i</span><span class="op" id="8538649">++</span>&nbsp;<span class="op" id="8538652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538657">dt</span>&nbsp;<span class="op" id="8538660">:=</span>&nbsp;<span class="ident" id="8538663">stats</span><span class="op" id="8538668">.</span><span class="ident" id="8538669">Pause</span><span class="op" id="8538674">[</span><span class="ident" id="8538675">i</span><span class="op" id="8538676">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538681">if</span>&nbsp;<span class="ident" id="8538684">dt</span>&nbsp;<span class="op" id="8538687">!=</span>&nbsp;<span class="ident" id="8538690">time</span><span class="op" id="8538694">.</span><span class="ident" id="8538695">Duration</span><span class="op" id="8538703">(</span><span class="ident" id="8538704">mstats</span><span class="op" id="8538710">.</span><span class="ident" id="8538711">PauseNs</span><span class="op" id="8538718">[</span><span class="ident" id="8538719">off</span><span class="op" id="8538722">]</span><span class="op" id="8538723">)</span>&nbsp;<span class="op" id="8538725">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538731">t</span><span class="op" id="8538732">.</span><span class="ident" id="8538733">Errorf</span><span class="op" id="8538739">(</span><span class="string" id="8538740">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8538771">,</span>&nbsp;<span class="ident" id="8538773">i</span><span class="op" id="8538774">,</span>&nbsp;<span class="ident" id="8538776">dt</span><span class="op" id="8538778">,</span>&nbsp;<span class="ident" id="8538780">mstats</span><span class="op" id="8538786">.</span><span class="ident" id="8538787">PauseNs</span><span class="op" id="8538794">[</span><span class="ident" id="8538795">off</span><span class="op" id="8538798">]</span><span class="op" id="8538799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538809">if</span>&nbsp;<span class="ident" id="8538812">max</span>&nbsp;<span class="op" id="8538816">&lt;</span>&nbsp;<span class="ident" id="8538818">dt</span>&nbsp;<span class="op" id="8538821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538827">max</span>&nbsp;<span class="op" id="8538831">=</span>&nbsp;<span class="ident" id="8538833">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538839">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538844">if</span>&nbsp;<span class="ident" id="8538847">min</span>&nbsp;<span class="op" id="8538851">&gt;</span>&nbsp;<span class="ident" id="8538853">dt</span>&nbsp;<span class="op" id="8538856">||</span>&nbsp;<span class="ident" id="8538859">i</span>&nbsp;<span class="op" id="8538861">==</span>&nbsp;<span class="num" id="8538864">0</span>&nbsp;<span class="op" id="8538866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538872">min</span>&nbsp;<span class="op" id="8538876">=</span>&nbsp;<span class="ident" id="8538878">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538889">off</span>&nbsp;<span class="op" id="8538893">=</span>&nbsp;<span class="op" id="8538895">(</span><span class="ident" id="8538896">off</span>&nbsp;<span class="op" id="8538900">+</span>&nbsp;<span class="builtinfunc" id="8538902">len</span><span class="op" id="8538905">(</span><span class="ident" id="8538906">mstats</span><span class="op" id="8538912">.</span><span class="ident" id="8538913">PauseNs</span><span class="op" id="8538920">)</span>&nbsp;<span class="op" id="8538922">-</span>&nbsp;<span class="num" id="8538924">1</span><span class="op" id="8538925">)</span>&nbsp;<span class="op" id="8538927">%</span>&nbsp;<span class="builtinfunc" id="8538929">len</span><span class="op" id="8538932">(</span><span class="ident" id="8538933">mstats</span><span class="op" id="8538939">.</span><span class="ident" id="8538940">PauseNs</span><span class="op" id="8538947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538951">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8538954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538958">q</span>&nbsp;<span class="op" id="8538960">:=</span>&nbsp;<span class="ident" id="8538963">stats</span><span class="op" id="8538968">.</span><span class="ident" id="8538969">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8538985">nq</span>&nbsp;<span class="op" id="8538988">:=</span>&nbsp;<span class="builtinfunc" id="8538991">len</span><span class="op" id="8538994">(</span><span class="ident" id="8538995">q</span><span class="op" id="8538996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8538999">if</span>&nbsp;<span class="ident" id="8539002">q</span><span class="op" id="8539003">[</span><span class="num" id="8539004">0</span><span class="op" id="8539005">]</span>&nbsp;<span class="op" id="8539007">!=</span>&nbsp;<span class="ident" id="8539010">min</span>&nbsp;<span class="op" id="8539014">||</span>&nbsp;<span class="ident" id="8539017">q</span><span class="op" id="8539018">[</span><span class="ident" id="8539019">nq</span><span class="op" id="8539021">-</span><span class="num" id="8539022">1</span><span class="op" id="8539023">]</span>&nbsp;<span class="op" id="8539025">!=</span>&nbsp;<span class="ident" id="8539028">max</span>&nbsp;<span class="op" id="8539032">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539036">t</span><span class="op" id="8539037">.</span><span class="ident" id="8539038">Errorf</span><span class="op" id="8539044">(</span><span class="string" id="8539045">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="8539103">,</span>&nbsp;<span class="ident" id="8539105">q</span><span class="op" id="8539106">[</span><span class="num" id="8539107">0</span><span class="op" id="8539108">]</span><span class="op" id="8539109">,</span>&nbsp;<span class="ident" id="8539111">q</span><span class="op" id="8539112">[</span><span class="ident" id="8539113">nq</span><span class="op" id="8539115">-</span><span class="num" id="8539116">1</span><span class="op" id="8539117">]</span><span class="op" id="8539118">,</span>&nbsp;<span class="ident" id="8539120">min</span><span class="op" id="8539123">,</span>&nbsp;<span class="ident" id="8539125">max</span><span class="op" id="8539128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539135">for</span>&nbsp;<span class="ident" id="8539139">i</span>&nbsp;<span class="op" id="8539141">:=</span>&nbsp;<span class="num" id="8539144">0</span><span class="op" id="8539145">;</span>&nbsp;<span class="ident" id="8539147">i</span>&nbsp;<span class="op" id="8539149">&lt;</span>&nbsp;<span class="ident" id="8539151">nq</span><span class="op" id="8539153">-</span><span class="num" id="8539154">1</span><span class="op" id="8539155">;</span>&nbsp;<span class="ident" id="8539157">i</span><span class="op" id="8539158">++</span>&nbsp;<span class="op" id="8539161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539165">if</span>&nbsp;<span class="ident" id="8539168">q</span><span class="op" id="8539169">[</span><span class="ident" id="8539170">i</span><span class="op" id="8539171">]</span>&nbsp;<span class="op" id="8539173">&gt;</span>&nbsp;<span class="ident" id="8539175">q</span><span class="op" id="8539176">[</span><span class="ident" id="8539177">i</span><span class="op" id="8539178">+</span><span class="num" id="8539179">1</span><span class="op" id="8539180">]</span>&nbsp;<span class="op" id="8539182">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539187">t</span><span class="op" id="8539188">.</span><span class="ident" id="8539189">Errorf</span><span class="op" id="8539195">(</span><span class="string" id="8539196">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="8539255">,</span>&nbsp;<span class="ident" id="8539257">i</span><span class="op" id="8539258">,</span>&nbsp;<span class="ident" id="8539260">q</span><span class="op" id="8539261">[</span><span class="ident" id="8539262">i</span><span class="op" id="8539263">]</span><span class="op" id="8539264">,</span>&nbsp;<span class="ident" id="8539266">i</span><span class="op" id="8539267">+</span><span class="num" id="8539268">1</span><span class="op" id="8539269">,</span>&nbsp;<span class="ident" id="8539271">q</span><span class="op" id="8539272">[</span><span class="ident" id="8539273">i</span><span class="op" id="8539274">+</span><span class="num" id="8539275">1</span><span class="op" id="8539276">]</span><span class="op" id="8539277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8539288">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539328">if</span>&nbsp;<span class="builtinfunc" id="8539331">len</span><span class="op" id="8539334">(</span><span class="ident" id="8539335">stats</span><span class="op" id="8539340">.</span><span class="ident" id="8539341">PauseEnd</span><span class="op" id="8539349">)</span>&nbsp;<span class="op" id="8539351">!=</span>&nbsp;<span class="ident" id="8539354">n</span>&nbsp;<span class="op" id="8539356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539360">t</span><span class="op" id="8539361">.</span><span class="ident" id="8539362">Fatalf</span><span class="op" id="8539368">(</span><span class="string" id="8539369">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8539404">,</span>&nbsp;<span class="builtinfunc" id="8539406">len</span><span class="op" id="8539409">(</span><span class="ident" id="8539410">stats</span><span class="op" id="8539415">.</span><span class="ident" id="8539416">PauseEnd</span><span class="op" id="8539424">)</span><span class="op" id="8539425">,</span>&nbsp;<span class="ident" id="8539427">n</span><span class="op" id="8539428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539434">off</span>&nbsp;<span class="op" id="8539438">:=</span>&nbsp;<span class="op" id="8539441">(</span><span class="builtintype" id="8539442">int</span><span class="op" id="8539445">(</span><span class="ident" id="8539446">mstats</span><span class="op" id="8539452">.</span><span class="ident" id="8539453">NumGC</span><span class="op" id="8539458">)</span>&nbsp;<span class="op" id="8539460">+</span>&nbsp;<span class="builtinfunc" id="8539462">len</span><span class="op" id="8539465">(</span><span class="ident" id="8539466">mstats</span><span class="op" id="8539472">.</span><span class="ident" id="8539473">PauseEnd</span><span class="op" id="8539481">)</span>&nbsp;<span class="op" id="8539483">-</span>&nbsp;<span class="num" id="8539485">1</span><span class="op" id="8539486">)</span>&nbsp;<span class="op" id="8539488">%</span>&nbsp;<span class="builtinfunc" id="8539490">len</span><span class="op" id="8539493">(</span><span class="ident" id="8539494">mstats</span><span class="op" id="8539500">.</span><span class="ident" id="8539501">PauseEnd</span><span class="op" id="8539509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539512">for</span>&nbsp;<span class="ident" id="8539516">i</span>&nbsp;<span class="op" id="8539518">:=</span>&nbsp;<span class="num" id="8539521">0</span><span class="op" id="8539522">;</span>&nbsp;<span class="ident" id="8539524">i</span>&nbsp;<span class="op" id="8539526">&lt;</span>&nbsp;<span class="ident" id="8539528">n</span><span class="op" id="8539529">;</span>&nbsp;<span class="ident" id="8539531">i</span><span class="op" id="8539532">++</span>&nbsp;<span class="op" id="8539535">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539539">dt</span>&nbsp;<span class="op" id="8539542">:=</span>&nbsp;<span class="ident" id="8539545">stats</span><span class="op" id="8539550">.</span><span class="ident" id="8539551">PauseEnd</span><span class="op" id="8539559">[</span><span class="ident" id="8539560">i</span><span class="op" id="8539561">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539565">if</span>&nbsp;<span class="ident" id="8539568">dt</span><span class="op" id="8539570">.</span><span class="ident" id="8539571">UnixNano</span><span class="op" id="8539579">(</span><span class="op" id="8539580">)</span>&nbsp;<span class="op" id="8539582">!=</span>&nbsp;<span class="ident" id="8539585">int64</span><span class="op" id="8539590">(</span><span class="ident" id="8539591">mstats</span><span class="op" id="8539597">.</span><span class="ident" id="8539598">PauseEnd</span><span class="op" id="8539606">[</span><span class="ident" id="8539607">off</span><span class="op" id="8539610">]</span><span class="op" id="8539611">)</span>&nbsp;<span class="op" id="8539613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539618">t</span><span class="op" id="8539619">.</span><span class="ident" id="8539620">Errorf</span><span class="op" id="8539626">(</span><span class="string" id="8539627">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8539661">,</span>&nbsp;<span class="ident" id="8539663">i</span><span class="op" id="8539664">,</span>&nbsp;<span class="ident" id="8539666">dt</span><span class="op" id="8539668">,</span>&nbsp;<span class="ident" id="8539670">mstats</span><span class="op" id="8539676">.</span><span class="ident" id="8539677">PauseEnd</span><span class="op" id="8539685">[</span><span class="ident" id="8539686">off</span><span class="op" id="8539689">]</span><span class="op" id="8539690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539698">off</span>&nbsp;<span class="op" id="8539702">=</span>&nbsp;<span class="op" id="8539704">(</span><span class="ident" id="8539705">off</span>&nbsp;<span class="op" id="8539709">+</span>&nbsp;<span class="builtinfunc" id="8539711">len</span><span class="op" id="8539714">(</span><span class="ident" id="8539715">mstats</span><span class="op" id="8539721">.</span><span class="ident" id="8539722">PauseEnd</span><span class="op" id="8539730">)</span>&nbsp;<span class="op" id="8539732">-</span>&nbsp;<span class="num" id="8539734">1</span><span class="op" id="8539735">)</span>&nbsp;<span class="op" id="8539737">%</span>&nbsp;<span class="builtinfunc" id="8539739">len</span><span class="op" id="8539742">(</span><span class="ident" id="8539743">mstats</span><span class="op" id="8539749">.</span><span class="ident" id="8539750">PauseEnd</span><span class="op" id="8539758">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539761">}</span><br>
<span class="lineno"></span><span class="op" id="8539763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8539766">var</span>&nbsp;<span class="ident" id="8539770">big</span>&nbsp;<span class="op" id="8539774">=</span>&nbsp;<span class="builtinfunc" id="8539776">make</span><span class="op" id="8539780">(</span><span class="op" id="8539781">[</span><span class="op" id="8539782">]</span><span class="builtintype" id="8539783">byte</span><span class="op" id="8539787">,</span>&nbsp;<span class="num" id="8539789">1</span><span class="op" id="8539790">&lt;&lt;</span><span class="num" id="8539792">20</span><span class="op" id="8539794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="8539797">func</span>&nbsp;<span class="ident" id="8539802">TestFreeOSMemory</span><span class="op" id="8539818">(</span><span class="ident" id="8539819">t</span>&nbsp;<span class="op" id="8539821">*</span><span class="ident" id="8539822">testing</span><span class="op" id="8539829">.</span><span class="ident" id="8539830">T</span><span class="op" id="8539831">)</span>&nbsp;<span class="op" id="8539833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539836">var</span>&nbsp;<span class="ident" id="8539840">ms1</span><span class="op" id="8539843">,</span>&nbsp;<span class="ident" id="8539845">ms2</span>&nbsp;<span class="ident" id="8539849">runtime</span><span class="op" id="8539856">.</span><span class="ident" id="8539857">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8539868">if</span>&nbsp;<span class="ident" id="8539871">big</span>&nbsp;<span class="op" id="8539875">==</span>&nbsp;<span class="ident" id="8539878">nil</span>&nbsp;<span class="op" id="8539882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539886">t</span><span class="op" id="8539887">.</span><span class="ident" id="8539888">Skip</span><span class="op" id="8539892">(</span><span class="string" id="8539893">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="8539939">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8539942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539945">big</span>&nbsp;<span class="op" id="8539949">=</span>&nbsp;<span class="ident" id="8539951">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539956">runtime</span><span class="op" id="8539963">.</span><span class="ident" id="8539964">GC</span><span class="op" id="8539966">(</span><span class="op" id="8539967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539970">runtime</span><span class="op" id="8539977">.</span><span class="ident" id="8539978">ReadMemStats</span><span class="op" id="8539990">(</span><span class="op" id="8539991">&amp;</span><span class="ident" id="8539992">ms1</span><span class="op" id="8539995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8539998">FreeOSMemory</span><span class="op" id="8540010">(</span><span class="op" id="8540011">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8540014">runtime</span><span class="op" id="8540021">.</span><span class="ident" id="8540022">ReadMemStats</span><span class="op" id="8540034">(</span><span class="op" id="8540035">&amp;</span><span class="ident" id="8540036">ms2</span><span class="op" id="8540039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8540042">if</span>&nbsp;<span class="ident" id="8540045">ms1</span><span class="op" id="8540048">.</span><span class="ident" id="8540049">HeapReleased</span>&nbsp;<span class="op" id="8540062">&gt;=</span>&nbsp;<span class="ident" id="8540065">ms2</span><span class="op" id="8540068">.</span><span class="ident" id="8540069">HeapReleased</span>&nbsp;<span class="op" id="8540082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8540086">t</span><span class="op" id="8540087">.</span><span class="ident" id="8540088">Errorf</span><span class="op" id="8540094">(</span><span class="string" id="8540095">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="8540149">,</span>&nbsp;<span class="ident" id="8540151">ms1</span><span class="op" id="8540154">.</span><span class="ident" id="8540155">HeapReleased</span><span class="op" id="8540167">,</span>&nbsp;<span class="ident" id="8540169">ms2</span><span class="op" id="8540172">.</span><span class="ident" id="8540173">HeapReleased</span><span class="op" id="8540185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8540188">}</span><br>
<span class="lineno"></span><span class="op" id="8540190">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="8540193">func</span>&nbsp;<span class="ident" id="8540198">TestSetGCPercent</span><span class="op" id="8540214">(</span><span class="ident" id="8540215">t</span>&nbsp;<span class="op" id="8540217">*</span><span class="ident" id="8540218">testing</span><span class="op" id="8540225">.</span><span class="ident" id="8540226">T</span><span class="op" id="8540227">)</span>&nbsp;<span class="op" id="8540229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8540232">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8540296">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8540360">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8540389">old</span>&nbsp;<span class="op" id="8540393">:=</span>&nbsp;<span class="ident" id="8540396">SetGCPercent</span><span class="op" id="8540408">(</span><span class="num" id="8540409">123</span><span class="op" id="8540412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8540415">new</span>&nbsp;<span class="op" id="8540419">:=</span>&nbsp;<span class="ident" id="8540422">SetGCPercent</span><span class="op" id="8540434">(</span><span class="ident" id="8540435">old</span><span class="op" id="8540438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8540441">if</span>&nbsp;<span class="builtinfunc" id="8540444">new</span>&nbsp;<span class="op" id="8540448">!=</span>&nbsp;<span class="num" id="8540451">123</span>&nbsp;<span class="op" id="8540455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8540459">t</span><span class="op" id="8540460">.</span><span class="ident" id="8540461">Errorf</span><span class="op" id="8540467">(</span><span class="string" id="8540468">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="8540519">,</span>&nbsp;<span class="builtinfunc" id="8540521">new</span><span class="op" id="8540524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8540527">}</span><br>
<span class="lineno">115</span><span class="op" id="8540529">}</span>
</div>
</body>
</html>
