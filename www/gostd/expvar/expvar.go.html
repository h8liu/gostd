<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5340586">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5340641">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5340695">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5340746">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5340824">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5340900">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5340931">//</span><br>
<span class="lineno"></span><span class="comment" id="5340934">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5341000">//</span><br>
<span class="lineno"></span><span class="comment" id="5341003">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5341073">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5341097">//</span><br>
<span class="lineno"></span><span class="comment" id="5341100">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5341121">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5341151">//</span><br>
<span class="lineno"></span><span class="comment" id="5341154">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5341219">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5341287">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5341337">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5341358">//</span><br>
<span class="lineno"></span><span class="keyword" id="5341361">package</span>&nbsp;<span class="ident" id="5341369">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5341377">import</span>&nbsp;<span class="op" id="5341384">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341387">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341396">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341413">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341420">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341427">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341439">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341445">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341456">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341464">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5341475">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5341482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5341485">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5341540">type</span>&nbsp;<span class="ident" id="5341545">Var</span>&nbsp;<span class="keyword" id="5341549">interface</span>&nbsp;<span class="op" id="5341559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341562">String</span><span class="op" id="5341568">(</span><span class="op" id="5341569">)</span>&nbsp;<span class="builtintype" id="5341571">string</span><br>
<span class="lineno">40</span><span class="op" id="5341578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5341581">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5341651">type</span>&nbsp;<span class="ident" id="5341656">Int</span>&nbsp;<span class="keyword" id="5341660">struct</span>&nbsp;<span class="op" id="5341667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341670">mu</span>&nbsp;<span class="ident" id="5341673">sync</span><span class="op" id="5341677">.</span><span class="ident" id="5341678">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341687">i</span>&nbsp;&nbsp;<span class="ident" id="5341690">int64</span><br>
<span class="lineno"></span><span class="op" id="5341696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5341699">func</span>&nbsp;<span class="op" id="5341704">(</span><span class="ident" id="5341705">v</span>&nbsp;<span class="op" id="5341707">*</span><span class="ident" id="5341708">Int</span><span class="op" id="5341711">)</span>&nbsp;<span class="ident" id="5341713">String</span><span class="op" id="5341719">(</span><span class="op" id="5341720">)</span>&nbsp;<span class="builtintype" id="5341722">string</span>&nbsp;<span class="op" id="5341729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341732">v</span><span class="op" id="5341733">.</span><span class="ident" id="5341734">mu</span><span class="op" id="5341736">.</span><span class="ident" id="5341737">RLock</span><span class="op" id="5341742">(</span><span class="op" id="5341743">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5341746">defer</span>&nbsp;<span class="ident" id="5341752">v</span><span class="op" id="5341753">.</span><span class="ident" id="5341754">mu</span><span class="op" id="5341756">.</span><span class="ident" id="5341757">RUnlock</span><span class="op" id="5341764">(</span><span class="op" id="5341765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5341768">return</span>&nbsp;<span class="ident" id="5341775">strconv</span><span class="op" id="5341782">.</span><span class="ident" id="5341783">FormatInt</span><span class="op" id="5341792">(</span><span class="ident" id="5341793">v</span><span class="op" id="5341794">.</span><span class="ident" id="5341795">i</span><span class="op" id="5341796">,</span>&nbsp;<span class="num" id="5341798">10</span><span class="op" id="5341800">)</span><br>
<span class="lineno"></span><span class="op" id="5341802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5341805">func</span>&nbsp;<span class="op" id="5341810">(</span><span class="ident" id="5341811">v</span>&nbsp;<span class="op" id="5341813">*</span><span class="ident" id="5341814">Int</span><span class="op" id="5341817">)</span>&nbsp;<span class="ident" id="5341819">Add</span><span class="op" id="5341822">(</span><span class="ident" id="5341823">delta</span>&nbsp;<span class="ident" id="5341829">int64</span><span class="op" id="5341834">)</span>&nbsp;<span class="op" id="5341836">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341839">v</span><span class="op" id="5341840">.</span><span class="ident" id="5341841">mu</span><span class="op" id="5341843">.</span><span class="ident" id="5341844">Lock</span><span class="op" id="5341848">(</span><span class="op" id="5341849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5341852">defer</span>&nbsp;<span class="ident" id="5341858">v</span><span class="op" id="5341859">.</span><span class="ident" id="5341860">mu</span><span class="op" id="5341862">.</span><span class="ident" id="5341863">Unlock</span><span class="op" id="5341869">(</span><span class="op" id="5341870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341873">v</span><span class="op" id="5341874">.</span><span class="ident" id="5341875">i</span>&nbsp;<span class="op" id="5341877">+=</span>&nbsp;<span class="ident" id="5341880">delta</span><br>
<span class="lineno"></span><span class="op" id="5341886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5341889">func</span>&nbsp;<span class="op" id="5341894">(</span><span class="ident" id="5341895">v</span>&nbsp;<span class="op" id="5341897">*</span><span class="ident" id="5341898">Int</span><span class="op" id="5341901">)</span>&nbsp;<span class="ident" id="5341903">Set</span><span class="op" id="5341906">(</span><span class="ident" id="5341907">value</span>&nbsp;<span class="ident" id="5341913">int64</span><span class="op" id="5341918">)</span>&nbsp;<span class="op" id="5341920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341923">v</span><span class="op" id="5341924">.</span><span class="ident" id="5341925">mu</span><span class="op" id="5341927">.</span><span class="ident" id="5341928">Lock</span><span class="op" id="5341932">(</span><span class="op" id="5341933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5341936">defer</span>&nbsp;<span class="ident" id="5341942">v</span><span class="op" id="5341943">.</span><span class="ident" id="5341944">mu</span><span class="op" id="5341946">.</span><span class="ident" id="5341947">Unlock</span><span class="op" id="5341953">(</span><span class="op" id="5341954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5341957">v</span><span class="op" id="5341958">.</span><span class="ident" id="5341959">i</span>&nbsp;<span class="op" id="5341961">=</span>&nbsp;<span class="ident" id="5341963">value</span><br>
<span class="lineno"></span><span class="op" id="5341969">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5341972">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5342042">type</span>&nbsp;<span class="ident" id="5342047">Float</span>&nbsp;<span class="keyword" id="5342053">struct</span>&nbsp;<span class="op" id="5342060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342063">mu</span>&nbsp;<span class="ident" id="5342066">sync</span><span class="op" id="5342070">.</span><span class="ident" id="5342071">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342080">f</span>&nbsp;&nbsp;<span class="builtintype" id="5342083">float64</span><br>
<span class="lineno">70</span><span class="op" id="5342091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5342094">func</span>&nbsp;<span class="op" id="5342099">(</span><span class="ident" id="5342100">v</span>&nbsp;<span class="op" id="5342102">*</span><span class="ident" id="5342103">Float</span><span class="op" id="5342108">)</span>&nbsp;<span class="ident" id="5342110">String</span><span class="op" id="5342116">(</span><span class="op" id="5342117">)</span>&nbsp;<span class="builtintype" id="5342119">string</span>&nbsp;<span class="op" id="5342126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342129">v</span><span class="op" id="5342130">.</span><span class="ident" id="5342131">mu</span><span class="op" id="5342133">.</span><span class="ident" id="5342134">RLock</span><span class="op" id="5342139">(</span><span class="op" id="5342140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342143">defer</span>&nbsp;<span class="ident" id="5342149">v</span><span class="op" id="5342150">.</span><span class="ident" id="5342151">mu</span><span class="op" id="5342153">.</span><span class="ident" id="5342154">RUnlock</span><span class="op" id="5342161">(</span><span class="op" id="5342162">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342165">return</span>&nbsp;<span class="ident" id="5342172">strconv</span><span class="op" id="5342179">.</span><span class="ident" id="5342180">FormatFloat</span><span class="op" id="5342191">(</span><span class="ident" id="5342192">v</span><span class="op" id="5342193">.</span><span class="ident" id="5342194">f</span><span class="op" id="5342195">,</span>&nbsp;<span class="string" id="5342197">&#39;g&#39;</span><span class="op" id="5342200">,</span>&nbsp;<span class="op" id="5342202">-</span><span class="num" id="5342203">1</span><span class="op" id="5342204">,</span>&nbsp;<span class="num" id="5342206">64</span><span class="op" id="5342208">)</span><br>
<span class="lineno"></span><span class="op" id="5342210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5342213">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5342237">func</span>&nbsp;<span class="op" id="5342242">(</span><span class="ident" id="5342243">v</span>&nbsp;<span class="op" id="5342245">*</span><span class="ident" id="5342246">Float</span><span class="op" id="5342251">)</span>&nbsp;<span class="ident" id="5342253">Add</span><span class="op" id="5342256">(</span><span class="ident" id="5342257">delta</span>&nbsp;<span class="builtintype" id="5342263">float64</span><span class="op" id="5342270">)</span>&nbsp;<span class="op" id="5342272">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342275">v</span><span class="op" id="5342276">.</span><span class="ident" id="5342277">mu</span><span class="op" id="5342279">.</span><span class="ident" id="5342280">Lock</span><span class="op" id="5342284">(</span><span class="op" id="5342285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342288">defer</span>&nbsp;<span class="ident" id="5342294">v</span><span class="op" id="5342295">.</span><span class="ident" id="5342296">mu</span><span class="op" id="5342298">.</span><span class="ident" id="5342299">Unlock</span><span class="op" id="5342305">(</span><span class="op" id="5342306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342309">v</span><span class="op" id="5342310">.</span><span class="ident" id="5342311">f</span>&nbsp;<span class="op" id="5342313">+=</span>&nbsp;<span class="ident" id="5342316">delta</span><br>
<span class="lineno"></span><span class="op" id="5342322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5342325">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5342349">func</span>&nbsp;<span class="op" id="5342354">(</span><span class="ident" id="5342355">v</span>&nbsp;<span class="op" id="5342357">*</span><span class="ident" id="5342358">Float</span><span class="op" id="5342363">)</span>&nbsp;<span class="ident" id="5342365">Set</span><span class="op" id="5342368">(</span><span class="ident" id="5342369">value</span>&nbsp;<span class="builtintype" id="5342375">float64</span><span class="op" id="5342382">)</span>&nbsp;<span class="op" id="5342384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342387">v</span><span class="op" id="5342388">.</span><span class="ident" id="5342389">mu</span><span class="op" id="5342391">.</span><span class="ident" id="5342392">Lock</span><span class="op" id="5342396">(</span><span class="op" id="5342397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342400">defer</span>&nbsp;<span class="ident" id="5342406">v</span><span class="op" id="5342407">.</span><span class="ident" id="5342408">mu</span><span class="op" id="5342410">.</span><span class="ident" id="5342411">Unlock</span><span class="op" id="5342417">(</span><span class="op" id="5342418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342421">v</span><span class="op" id="5342422">.</span><span class="ident" id="5342423">f</span>&nbsp;<span class="op" id="5342425">=</span>&nbsp;<span class="ident" id="5342427">value</span><br>
<span class="lineno">90</span><span class="op" id="5342433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5342436">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5342509">type</span>&nbsp;<span class="ident" id="5342514">Map</span>&nbsp;<span class="keyword" id="5342518">struct</span>&nbsp;<span class="op" id="5342525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342528">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5342533">sync</span><span class="op" id="5342537">.</span><span class="ident" id="5342538">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342547">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5342552">map</span><span class="op" id="5342555">[</span><span class="builtintype" id="5342556">string</span><span class="op" id="5342562">]</span><span class="ident" id="5342563">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342568">keys</span>&nbsp;<span class="op" id="5342573">[</span><span class="op" id="5342574">]</span><span class="builtintype" id="5342575">string</span>&nbsp;<span class="comment" id="5342582">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5342592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5342595">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5342643">type</span>&nbsp;<span class="ident" id="5342648">KeyValue</span>&nbsp;<span class="keyword" id="5342657">struct</span>&nbsp;<span class="op" id="5342664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342667">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5342673">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342681">Value</span>&nbsp;<span class="ident" id="5342687">Var</span><br>
<span class="lineno"></span><span class="op" id="5342691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5342694">func</span>&nbsp;<span class="op" id="5342699">(</span><span class="ident" id="5342700">v</span>&nbsp;<span class="op" id="5342702">*</span><span class="ident" id="5342703">Map</span><span class="op" id="5342706">)</span>&nbsp;<span class="ident" id="5342708">String</span><span class="op" id="5342714">(</span><span class="op" id="5342715">)</span>&nbsp;<span class="builtintype" id="5342717">string</span>&nbsp;<span class="op" id="5342724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342727">v</span><span class="op" id="5342728">.</span><span class="ident" id="5342729">mu</span><span class="op" id="5342731">.</span><span class="ident" id="5342732">RLock</span><span class="op" id="5342737">(</span><span class="op" id="5342738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342741">defer</span>&nbsp;<span class="ident" id="5342747">v</span><span class="op" id="5342748">.</span><span class="ident" id="5342749">mu</span><span class="op" id="5342751">.</span><span class="ident" id="5342752">RUnlock</span><span class="op" id="5342759">(</span><span class="op" id="5342760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342763">var</span>&nbsp;<span class="ident" id="5342767">b</span>&nbsp;<span class="ident" id="5342769">bytes</span><span class="op" id="5342774">.</span><span class="ident" id="5342775">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342783">fmt</span><span class="op" id="5342786">.</span><span class="ident" id="5342787">Fprintf</span><span class="op" id="5342794">(</span><span class="op" id="5342795">&amp;</span><span class="ident" id="5342796">b</span><span class="op" id="5342797">,</span>&nbsp;<span class="string" id="5342799">&#34;{&#34;</span><span class="op" id="5342802">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342805">first</span>&nbsp;<span class="op" id="5342811">:=</span>&nbsp;<span class="builtintype" id="5342814">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342820">v</span><span class="op" id="5342821">.</span><span class="ident" id="5342822">doLocked</span><span class="op" id="5342830">(</span><span class="keyword" id="5342831">func</span><span class="op" id="5342835">(</span><span class="ident" id="5342836">kv</span>&nbsp;<span class="ident" id="5342839">KeyValue</span><span class="op" id="5342847">)</span>&nbsp;<span class="op" id="5342849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342853">if</span>&nbsp;<span class="op" id="5342856">!</span><span class="ident" id="5342857">first</span>&nbsp;<span class="op" id="5342863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342868">fmt</span><span class="op" id="5342871">.</span><span class="ident" id="5342872">Fprintf</span><span class="op" id="5342879">(</span><span class="op" id="5342880">&amp;</span><span class="ident" id="5342881">b</span><span class="op" id="5342882">,</span>&nbsp;<span class="string" id="5342884">&#34;,&nbsp;&#34;</span><span class="op" id="5342888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5342892">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342896">fmt</span><span class="op" id="5342899">.</span><span class="ident" id="5342900">Fprintf</span><span class="op" id="5342907">(</span><span class="op" id="5342908">&amp;</span><span class="ident" id="5342909">b</span><span class="op" id="5342910">,</span>&nbsp;<span class="string" id="5342912">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5342920">,</span>&nbsp;<span class="ident" id="5342922">kv</span><span class="op" id="5342924">.</span><span class="ident" id="5342925">Key</span><span class="op" id="5342928">,</span>&nbsp;<span class="ident" id="5342930">kv</span><span class="op" id="5342932">.</span><span class="ident" id="5342933">Value</span><span class="op" id="5342938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342942">first</span>&nbsp;<span class="op" id="5342948">=</span>&nbsp;<span class="builtintype" id="5342950">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5342957">}</span><span class="op" id="5342958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5342961">fmt</span><span class="op" id="5342964">.</span><span class="ident" id="5342965">Fprintf</span><span class="op" id="5342972">(</span><span class="op" id="5342973">&amp;</span><span class="ident" id="5342974">b</span><span class="op" id="5342975">,</span>&nbsp;<span class="string" id="5342977">&#34;}&#34;</span><span class="op" id="5342980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5342983">return</span>&nbsp;<span class="ident" id="5342990">b</span><span class="op" id="5342991">.</span><span class="ident" id="5342992">String</span><span class="op" id="5342998">(</span><span class="op" id="5342999">)</span><br>
<span class="lineno">120</span><span class="op" id="5343001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5343004">func</span>&nbsp;<span class="op" id="5343009">(</span><span class="ident" id="5343010">v</span>&nbsp;<span class="op" id="5343012">*</span><span class="ident" id="5343013">Map</span><span class="op" id="5343016">)</span>&nbsp;<span class="ident" id="5343018">Init</span><span class="op" id="5343022">(</span><span class="op" id="5343023">)</span>&nbsp;<span class="op" id="5343025">*</span><span class="ident" id="5343026">Map</span>&nbsp;<span class="op" id="5343030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343033">v</span><span class="op" id="5343034">.</span><span class="ident" id="5343035">m</span>&nbsp;<span class="op" id="5343037">=</span>&nbsp;<span class="builtinfunc" id="5343039">make</span><span class="op" id="5343043">(</span><span class="keyword" id="5343044">map</span><span class="op" id="5343047">[</span><span class="builtintype" id="5343048">string</span><span class="op" id="5343054">]</span><span class="ident" id="5343055">Var</span><span class="op" id="5343058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343061">return</span>&nbsp;<span class="ident" id="5343068">v</span><br>
<span class="lineno">125</span><span class="op" id="5343070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5343073">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5343130">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5343164">func</span>&nbsp;<span class="op" id="5343169">(</span><span class="ident" id="5343170">v</span>&nbsp;<span class="op" id="5343172">*</span><span class="ident" id="5343173">Map</span><span class="op" id="5343176">)</span>&nbsp;<span class="ident" id="5343178">updateKeys</span><span class="op" id="5343188">(</span><span class="op" id="5343189">)</span>&nbsp;<span class="op" id="5343191">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343194">if</span>&nbsp;<span class="builtinfunc" id="5343197">len</span><span class="op" id="5343200">(</span><span class="ident" id="5343201">v</span><span class="op" id="5343202">.</span><span class="ident" id="5343203">m</span><span class="op" id="5343204">)</span>&nbsp;<span class="op" id="5343206">==</span>&nbsp;<span class="builtinfunc" id="5343209">len</span><span class="op" id="5343212">(</span><span class="ident" id="5343213">v</span><span class="op" id="5343214">.</span><span class="ident" id="5343215">keys</span><span class="op" id="5343219">)</span>&nbsp;<span class="op" id="5343221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5343225">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5343250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343253">v</span><span class="op" id="5343254">.</span><span class="ident" id="5343255">keys</span>&nbsp;<span class="op" id="5343260">=</span>&nbsp;<span class="ident" id="5343262">v</span><span class="op" id="5343263">.</span><span class="ident" id="5343264">keys</span><span class="op" id="5343268">[</span><span class="op" id="5343269">:</span><span class="num" id="5343270">0</span><span class="op" id="5343271">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343274">for</span>&nbsp;<span class="ident" id="5343278">k</span>&nbsp;<span class="op" id="5343280">:=</span>&nbsp;<span class="keyword" id="5343283">range</span>&nbsp;<span class="ident" id="5343289">v</span><span class="op" id="5343290">.</span><span class="ident" id="5343291">m</span>&nbsp;<span class="op" id="5343293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343297">v</span><span class="op" id="5343298">.</span><span class="ident" id="5343299">keys</span>&nbsp;<span class="op" id="5343304">=</span>&nbsp;<span class="builtinfunc" id="5343306">append</span><span class="op" id="5343312">(</span><span class="ident" id="5343313">v</span><span class="op" id="5343314">.</span><span class="ident" id="5343315">keys</span><span class="op" id="5343319">,</span>&nbsp;<span class="ident" id="5343321">k</span><span class="op" id="5343322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5343325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343328">sort</span><span class="op" id="5343332">.</span><span class="ident" id="5343333">Strings</span><span class="op" id="5343340">(</span><span class="ident" id="5343341">v</span><span class="op" id="5343342">.</span><span class="ident" id="5343343">keys</span><span class="op" id="5343347">)</span><br>
<span class="lineno"></span><span class="op" id="5343349">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5343352">func</span>&nbsp;<span class="op" id="5343357">(</span><span class="ident" id="5343358">v</span>&nbsp;<span class="op" id="5343360">*</span><span class="ident" id="5343361">Map</span><span class="op" id="5343364">)</span>&nbsp;<span class="ident" id="5343366">Get</span><span class="op" id="5343369">(</span><span class="ident" id="5343370">key</span>&nbsp;<span class="builtintype" id="5343374">string</span><span class="op" id="5343380">)</span>&nbsp;<span class="ident" id="5343382">Var</span>&nbsp;<span class="op" id="5343386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343389">v</span><span class="op" id="5343390">.</span><span class="ident" id="5343391">mu</span><span class="op" id="5343393">.</span><span class="ident" id="5343394">RLock</span><span class="op" id="5343399">(</span><span class="op" id="5343400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343403">defer</span>&nbsp;<span class="ident" id="5343409">v</span><span class="op" id="5343410">.</span><span class="ident" id="5343411">mu</span><span class="op" id="5343413">.</span><span class="ident" id="5343414">RUnlock</span><span class="op" id="5343421">(</span><span class="op" id="5343422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343425">return</span>&nbsp;<span class="ident" id="5343432">v</span><span class="op" id="5343433">.</span><span class="ident" id="5343434">m</span><span class="op" id="5343435">[</span><span class="ident" id="5343436">key</span><span class="op" id="5343439">]</span><br>
<span class="lineno">145</span><span class="op" id="5343441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5343444">func</span>&nbsp;<span class="op" id="5343449">(</span><span class="ident" id="5343450">v</span>&nbsp;<span class="op" id="5343452">*</span><span class="ident" id="5343453">Map</span><span class="op" id="5343456">)</span>&nbsp;<span class="ident" id="5343458">Set</span><span class="op" id="5343461">(</span><span class="ident" id="5343462">key</span>&nbsp;<span class="builtintype" id="5343466">string</span><span class="op" id="5343472">,</span>&nbsp;<span class="ident" id="5343474">av</span>&nbsp;<span class="ident" id="5343477">Var</span><span class="op" id="5343480">)</span>&nbsp;<span class="op" id="5343482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343485">v</span><span class="op" id="5343486">.</span><span class="ident" id="5343487">mu</span><span class="op" id="5343489">.</span><span class="ident" id="5343490">Lock</span><span class="op" id="5343494">(</span><span class="op" id="5343495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343498">defer</span>&nbsp;<span class="ident" id="5343504">v</span><span class="op" id="5343505">.</span><span class="ident" id="5343506">mu</span><span class="op" id="5343508">.</span><span class="ident" id="5343509">Unlock</span><span class="op" id="5343515">(</span><span class="op" id="5343516">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343519">v</span><span class="op" id="5343520">.</span><span class="ident" id="5343521">m</span><span class="op" id="5343522">[</span><span class="ident" id="5343523">key</span><span class="op" id="5343526">]</span>&nbsp;<span class="op" id="5343528">=</span>&nbsp;<span class="ident" id="5343530">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343534">v</span><span class="op" id="5343535">.</span><span class="ident" id="5343536">updateKeys</span><span class="op" id="5343546">(</span><span class="op" id="5343547">)</span><br>
<span class="lineno"></span><span class="op" id="5343549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5343552">func</span>&nbsp;<span class="op" id="5343557">(</span><span class="ident" id="5343558">v</span>&nbsp;<span class="op" id="5343560">*</span><span class="ident" id="5343561">Map</span><span class="op" id="5343564">)</span>&nbsp;<span class="ident" id="5343566">Add</span><span class="op" id="5343569">(</span><span class="ident" id="5343570">key</span>&nbsp;<span class="builtintype" id="5343574">string</span><span class="op" id="5343580">,</span>&nbsp;<span class="ident" id="5343582">delta</span>&nbsp;<span class="ident" id="5343588">int64</span><span class="op" id="5343593">)</span>&nbsp;<span class="op" id="5343595">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343598">v</span><span class="op" id="5343599">.</span><span class="ident" id="5343600">mu</span><span class="op" id="5343602">.</span><span class="ident" id="5343603">RLock</span><span class="op" id="5343608">(</span><span class="op" id="5343609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343612">av</span><span class="op" id="5343614">,</span>&nbsp;<span class="ident" id="5343616">ok</span>&nbsp;<span class="op" id="5343619">:=</span>&nbsp;<span class="ident" id="5343622">v</span><span class="op" id="5343623">.</span><span class="ident" id="5343624">m</span><span class="op" id="5343625">[</span><span class="ident" id="5343626">key</span><span class="op" id="5343629">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343632">v</span><span class="op" id="5343633">.</span><span class="ident" id="5343634">mu</span><span class="op" id="5343636">.</span><span class="ident" id="5343637">RUnlock</span><span class="op" id="5343644">(</span><span class="op" id="5343645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343648">if</span>&nbsp;<span class="op" id="5343651">!</span><span class="ident" id="5343652">ok</span>&nbsp;<span class="op" id="5343655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5343659">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343697">v</span><span class="op" id="5343698">.</span><span class="ident" id="5343699">mu</span><span class="op" id="5343701">.</span><span class="ident" id="5343702">Lock</span><span class="op" id="5343706">(</span><span class="op" id="5343707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343711">av</span><span class="op" id="5343713">,</span>&nbsp;<span class="ident" id="5343715">ok</span>&nbsp;<span class="op" id="5343718">=</span>&nbsp;<span class="ident" id="5343720">v</span><span class="op" id="5343721">.</span><span class="ident" id="5343722">m</span><span class="op" id="5343723">[</span><span class="ident" id="5343724">key</span><span class="op" id="5343727">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343731">if</span>&nbsp;<span class="op" id="5343734">!</span><span class="ident" id="5343735">ok</span>&nbsp;<span class="op" id="5343738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343743">av</span>&nbsp;<span class="op" id="5343746">=</span>&nbsp;<span class="builtinfunc" id="5343748">new</span><span class="op" id="5343751">(</span><span class="ident" id="5343752">Int</span><span class="op" id="5343755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343760">v</span><span class="op" id="5343761">.</span><span class="ident" id="5343762">m</span><span class="op" id="5343763">[</span><span class="ident" id="5343764">key</span><span class="op" id="5343767">]</span>&nbsp;<span class="op" id="5343769">=</span>&nbsp;<span class="ident" id="5343771">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343777">v</span><span class="op" id="5343778">.</span><span class="ident" id="5343779">updateKeys</span><span class="op" id="5343789">(</span><span class="op" id="5343790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5343794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343798">v</span><span class="op" id="5343799">.</span><span class="ident" id="5343800">mu</span><span class="op" id="5343802">.</span><span class="ident" id="5343803">Unlock</span><span class="op" id="5343809">(</span><span class="op" id="5343810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5343813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5343817">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5343851">if</span>&nbsp;<span class="ident" id="5343854">iv</span><span class="op" id="5343856">,</span>&nbsp;<span class="ident" id="5343858">ok</span>&nbsp;<span class="op" id="5343861">:=</span>&nbsp;<span class="ident" id="5343864">av</span><span class="op" id="5343866">.</span><span class="op" id="5343867">(</span><span class="op" id="5343868">*</span><span class="ident" id="5343869">Int</span><span class="op" id="5343872">)</span><span class="op" id="5343873">;</span>&nbsp;<span class="ident" id="5343875">ok</span>&nbsp;<span class="op" id="5343878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5343882">iv</span><span class="op" id="5343884">.</span><span class="ident" id="5343885">Add</span><span class="op" id="5343888">(</span><span class="ident" id="5343889">delta</span><span class="op" id="5343894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5343897">}</span><br>
<span class="lineno"></span><span class="op" id="5343899">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5343902">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5343977">func</span>&nbsp;<span class="op" id="5343982">(</span><span class="ident" id="5343983">v</span>&nbsp;<span class="op" id="5343985">*</span><span class="ident" id="5343986">Map</span><span class="op" id="5343989">)</span>&nbsp;<span class="ident" id="5343991">AddFloat</span><span class="op" id="5343999">(</span><span class="ident" id="5344000">key</span>&nbsp;<span class="builtintype" id="5344004">string</span><span class="op" id="5344010">,</span>&nbsp;<span class="ident" id="5344012">delta</span>&nbsp;<span class="builtintype" id="5344018">float64</span><span class="op" id="5344025">)</span>&nbsp;<span class="op" id="5344027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344030">v</span><span class="op" id="5344031">.</span><span class="ident" id="5344032">mu</span><span class="op" id="5344034">.</span><span class="ident" id="5344035">RLock</span><span class="op" id="5344040">(</span><span class="op" id="5344041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344044">av</span><span class="op" id="5344046">,</span>&nbsp;<span class="ident" id="5344048">ok</span>&nbsp;<span class="op" id="5344051">:=</span>&nbsp;<span class="ident" id="5344054">v</span><span class="op" id="5344055">.</span><span class="ident" id="5344056">m</span><span class="op" id="5344057">[</span><span class="ident" id="5344058">key</span><span class="op" id="5344061">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344064">v</span><span class="op" id="5344065">.</span><span class="ident" id="5344066">mu</span><span class="op" id="5344068">.</span><span class="ident" id="5344069">RUnlock</span><span class="op" id="5344076">(</span><span class="op" id="5344077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344080">if</span>&nbsp;<span class="op" id="5344083">!</span><span class="ident" id="5344084">ok</span>&nbsp;<span class="op" id="5344087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5344091">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344129">v</span><span class="op" id="5344130">.</span><span class="ident" id="5344131">mu</span><span class="op" id="5344133">.</span><span class="ident" id="5344134">Lock</span><span class="op" id="5344138">(</span><span class="op" id="5344139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344143">av</span><span class="op" id="5344145">,</span>&nbsp;<span class="ident" id="5344147">ok</span>&nbsp;<span class="op" id="5344150">=</span>&nbsp;<span class="ident" id="5344152">v</span><span class="op" id="5344153">.</span><span class="ident" id="5344154">m</span><span class="op" id="5344155">[</span><span class="ident" id="5344156">key</span><span class="op" id="5344159">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344163">if</span>&nbsp;<span class="op" id="5344166">!</span><span class="ident" id="5344167">ok</span>&nbsp;<span class="op" id="5344170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344175">av</span>&nbsp;<span class="op" id="5344178">=</span>&nbsp;<span class="builtinfunc" id="5344180">new</span><span class="op" id="5344183">(</span><span class="ident" id="5344184">Float</span><span class="op" id="5344189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344194">v</span><span class="op" id="5344195">.</span><span class="ident" id="5344196">m</span><span class="op" id="5344197">[</span><span class="ident" id="5344198">key</span><span class="op" id="5344201">]</span>&nbsp;<span class="op" id="5344203">=</span>&nbsp;<span class="ident" id="5344205">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344211">v</span><span class="op" id="5344212">.</span><span class="ident" id="5344213">updateKeys</span><span class="op" id="5344223">(</span><span class="op" id="5344224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5344228">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344232">v</span><span class="op" id="5344233">.</span><span class="ident" id="5344234">mu</span><span class="op" id="5344236">.</span><span class="ident" id="5344237">Unlock</span><span class="op" id="5344243">(</span><span class="op" id="5344244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5344247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5344251">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344287">if</span>&nbsp;<span class="ident" id="5344290">iv</span><span class="op" id="5344292">,</span>&nbsp;<span class="ident" id="5344294">ok</span>&nbsp;<span class="op" id="5344297">:=</span>&nbsp;<span class="ident" id="5344300">av</span><span class="op" id="5344302">.</span><span class="op" id="5344303">(</span><span class="op" id="5344304">*</span><span class="ident" id="5344305">Float</span><span class="op" id="5344310">)</span><span class="op" id="5344311">;</span>&nbsp;<span class="ident" id="5344313">ok</span>&nbsp;<span class="op" id="5344316">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344320">iv</span><span class="op" id="5344322">.</span><span class="ident" id="5344323">Add</span><span class="op" id="5344326">(</span><span class="ident" id="5344327">delta</span><span class="op" id="5344332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5344335">}</span><br>
<span class="lineno"></span><span class="op" id="5344337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5344340">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5344381">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5344424">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5344477">func</span>&nbsp;<span class="op" id="5344482">(</span><span class="ident" id="5344483">v</span>&nbsp;<span class="op" id="5344485">*</span><span class="ident" id="5344486">Map</span><span class="op" id="5344489">)</span>&nbsp;<span class="ident" id="5344491">Do</span><span class="op" id="5344493">(</span><span class="ident" id="5344494">f</span>&nbsp;<span class="keyword" id="5344496">func</span><span class="op" id="5344500">(</span><span class="ident" id="5344501">KeyValue</span><span class="op" id="5344509">)</span><span class="op" id="5344510">)</span>&nbsp;<span class="op" id="5344512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344515">v</span><span class="op" id="5344516">.</span><span class="ident" id="5344517">mu</span><span class="op" id="5344519">.</span><span class="ident" id="5344520">RLock</span><span class="op" id="5344525">(</span><span class="op" id="5344526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344529">defer</span>&nbsp;<span class="ident" id="5344535">v</span><span class="op" id="5344536">.</span><span class="ident" id="5344537">mu</span><span class="op" id="5344539">.</span><span class="ident" id="5344540">RUnlock</span><span class="op" id="5344547">(</span><span class="op" id="5344548">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344551">v</span><span class="op" id="5344552">.</span><span class="ident" id="5344553">doLocked</span><span class="op" id="5344561">(</span><span class="ident" id="5344562">f</span><span class="op" id="5344563">)</span><br>
<span class="lineno"></span><span class="op" id="5344565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5344568">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5344615">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5344647">func</span>&nbsp;<span class="op" id="5344652">(</span><span class="ident" id="5344653">v</span>&nbsp;<span class="op" id="5344655">*</span><span class="ident" id="5344656">Map</span><span class="op" id="5344659">)</span>&nbsp;<span class="ident" id="5344661">doLocked</span><span class="op" id="5344669">(</span><span class="ident" id="5344670">f</span>&nbsp;<span class="keyword" id="5344672">func</span><span class="op" id="5344676">(</span><span class="ident" id="5344677">KeyValue</span><span class="op" id="5344685">)</span><span class="op" id="5344686">)</span>&nbsp;<span class="op" id="5344688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344691">for</span>&nbsp;<span class="ident" id="5344695">_</span><span class="op" id="5344696">,</span>&nbsp;<span class="ident" id="5344698">k</span>&nbsp;<span class="op" id="5344700">:=</span>&nbsp;<span class="keyword" id="5344703">range</span>&nbsp;<span class="ident" id="5344709">v</span><span class="op" id="5344710">.</span><span class="ident" id="5344711">keys</span>&nbsp;<span class="op" id="5344716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344720">f</span><span class="op" id="5344721">(</span><span class="ident" id="5344722">KeyValue</span><span class="op" id="5344730">{</span><span class="ident" id="5344731">k</span><span class="op" id="5344732">,</span>&nbsp;<span class="ident" id="5344734">v</span><span class="op" id="5344735">.</span><span class="ident" id="5344736">m</span><span class="op" id="5344737">[</span><span class="ident" id="5344738">k</span><span class="op" id="5344739">]</span><span class="op" id="5344740">}</span><span class="op" id="5344741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5344744">}</span><br>
<span class="lineno"></span><span class="op" id="5344746">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5344749">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5344814">type</span>&nbsp;<span class="ident" id="5344819">String</span>&nbsp;<span class="keyword" id="5344826">struct</span>&nbsp;<span class="op" id="5344833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344836">mu</span>&nbsp;<span class="ident" id="5344839">sync</span><span class="op" id="5344843">.</span><span class="ident" id="5344844">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344853">s</span>&nbsp;&nbsp;<span class="builtintype" id="5344856">string</span><br>
<span class="lineno">220</span><span class="op" id="5344863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5344866">func</span>&nbsp;<span class="op" id="5344871">(</span><span class="ident" id="5344872">v</span>&nbsp;<span class="op" id="5344874">*</span><span class="ident" id="5344875">String</span><span class="op" id="5344881">)</span>&nbsp;<span class="ident" id="5344883">String</span><span class="op" id="5344889">(</span><span class="op" id="5344890">)</span>&nbsp;<span class="builtintype" id="5344892">string</span>&nbsp;<span class="op" id="5344899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5344902">v</span><span class="op" id="5344903">.</span><span class="ident" id="5344904">mu</span><span class="op" id="5344906">.</span><span class="ident" id="5344907">RLock</span><span class="op" id="5344912">(</span><span class="op" id="5344913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344916">defer</span>&nbsp;<span class="ident" id="5344922">v</span><span class="op" id="5344923">.</span><span class="ident" id="5344924">mu</span><span class="op" id="5344926">.</span><span class="ident" id="5344927">RUnlock</span><span class="op" id="5344934">(</span><span class="op" id="5344935">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5344938">return</span>&nbsp;<span class="ident" id="5344945">strconv</span><span class="op" id="5344952">.</span><span class="ident" id="5344953">Quote</span><span class="op" id="5344958">(</span><span class="ident" id="5344959">v</span><span class="op" id="5344960">.</span><span class="ident" id="5344961">s</span><span class="op" id="5344962">)</span><br>
<span class="lineno"></span><span class="op" id="5344964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5344967">func</span>&nbsp;<span class="op" id="5344972">(</span><span class="ident" id="5344973">v</span>&nbsp;<span class="op" id="5344975">*</span><span class="ident" id="5344976">String</span><span class="op" id="5344982">)</span>&nbsp;<span class="ident" id="5344984">Set</span><span class="op" id="5344987">(</span><span class="ident" id="5344988">value</span>&nbsp;<span class="builtintype" id="5344994">string</span><span class="op" id="5345000">)</span>&nbsp;<span class="op" id="5345002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345005">v</span><span class="op" id="5345006">.</span><span class="ident" id="5345007">mu</span><span class="op" id="5345009">.</span><span class="ident" id="5345010">Lock</span><span class="op" id="5345014">(</span><span class="op" id="5345015">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345018">defer</span>&nbsp;<span class="ident" id="5345024">v</span><span class="op" id="5345025">.</span><span class="ident" id="5345026">mu</span><span class="op" id="5345028">.</span><span class="ident" id="5345029">Unlock</span><span class="op" id="5345035">(</span><span class="op" id="5345036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345039">v</span><span class="op" id="5345040">.</span><span class="ident" id="5345041">s</span>&nbsp;<span class="op" id="5345043">=</span>&nbsp;<span class="ident" id="5345045">value</span><br>
<span class="lineno"></span><span class="op" id="5345051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5345054">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5345101">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5345150">type</span>&nbsp;<span class="ident" id="5345155">Func</span>&nbsp;<span class="keyword" id="5345160">func</span><span class="op" id="5345164">(</span><span class="op" id="5345165">)</span>&nbsp;<span class="keyword" id="5345167">interface</span><span class="op" id="5345176">{</span><span class="op" id="5345177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5345180">func</span>&nbsp;<span class="op" id="5345185">(</span><span class="ident" id="5345186">f</span>&nbsp;<span class="ident" id="5345188">Func</span><span class="op" id="5345192">)</span>&nbsp;<span class="ident" id="5345194">String</span><span class="op" id="5345200">(</span><span class="op" id="5345201">)</span>&nbsp;<span class="builtintype" id="5345203">string</span>&nbsp;<span class="op" id="5345210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345213">v</span><span class="op" id="5345214">,</span>&nbsp;<span class="ident" id="5345216">_</span>&nbsp;<span class="op" id="5345218">:=</span>&nbsp;<span class="ident" id="5345221">json</span><span class="op" id="5345225">.</span><span class="ident" id="5345226">Marshal</span><span class="op" id="5345233">(</span><span class="ident" id="5345234">f</span><span class="op" id="5345235">(</span><span class="op" id="5345236">)</span><span class="op" id="5345237">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345240">return</span>&nbsp;<span class="builtintype" id="5345247">string</span><span class="op" id="5345253">(</span><span class="ident" id="5345254">v</span><span class="op" id="5345255">)</span><br>
<span class="lineno"></span><span class="op" id="5345257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5345260">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5345288">var</span>&nbsp;<span class="op" id="5345292">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345295">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5345303">sync</span><span class="op" id="5345307">.</span><span class="ident" id="5345308">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345317">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5345325">=</span>&nbsp;<span class="builtinfunc" id="5345327">make</span><span class="op" id="5345331">(</span><span class="keyword" id="5345332">map</span><span class="op" id="5345335">[</span><span class="builtintype" id="5345336">string</span><span class="op" id="5345342">]</span><span class="ident" id="5345343">Var</span><span class="op" id="5345346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345349">varKeys</span>&nbsp;<span class="op" id="5345357">[</span><span class="op" id="5345358">]</span><span class="builtintype" id="5345359">string</span>&nbsp;<span class="comment" id="5345366">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5345376">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5345379">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5345455">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5345531">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5345571">func</span>&nbsp;<span class="ident" id="5345576">Publish</span><span class="op" id="5345583">(</span><span class="ident" id="5345584">name</span>&nbsp;<span class="builtintype" id="5345589">string</span><span class="op" id="5345595">,</span>&nbsp;<span class="ident" id="5345597">v</span>&nbsp;<span class="ident" id="5345599">Var</span><span class="op" id="5345602">)</span>&nbsp;<span class="op" id="5345604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345607">mutex</span><span class="op" id="5345612">.</span><span class="ident" id="5345613">Lock</span><span class="op" id="5345617">(</span><span class="op" id="5345618">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345621">defer</span>&nbsp;<span class="ident" id="5345627">mutex</span><span class="op" id="5345632">.</span><span class="ident" id="5345633">Unlock</span><span class="op" id="5345639">(</span><span class="op" id="5345640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345643">if</span>&nbsp;<span class="ident" id="5345646">_</span><span class="op" id="5345647">,</span>&nbsp;<span class="ident" id="5345649">existing</span>&nbsp;<span class="op" id="5345658">:=</span>&nbsp;<span class="ident" id="5345661">vars</span><span class="op" id="5345665">[</span><span class="ident" id="5345666">name</span><span class="op" id="5345670">]</span><span class="op" id="5345671">;</span>&nbsp;<span class="ident" id="5345673">existing</span>&nbsp;<span class="op" id="5345682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345686">log</span><span class="op" id="5345689">.</span><span class="ident" id="5345690">Panicln</span><span class="op" id="5345697">(</span><span class="string" id="5345698">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5345727">,</span>&nbsp;<span class="ident" id="5345729">name</span><span class="op" id="5345733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5345736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345739">vars</span><span class="op" id="5345743">[</span><span class="ident" id="5345744">name</span><span class="op" id="5345748">]</span>&nbsp;<span class="op" id="5345750">=</span>&nbsp;<span class="ident" id="5345752">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345755">varKeys</span>&nbsp;<span class="op" id="5345763">=</span>&nbsp;<span class="builtinfunc" id="5345765">append</span><span class="op" id="5345771">(</span><span class="ident" id="5345772">varKeys</span><span class="op" id="5345779">,</span>&nbsp;<span class="ident" id="5345781">name</span><span class="op" id="5345785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345788">sort</span><span class="op" id="5345792">.</span><span class="ident" id="5345793">Strings</span><span class="op" id="5345800">(</span><span class="ident" id="5345801">varKeys</span><span class="op" id="5345808">)</span><br>
<span class="lineno"></span><span class="op" id="5345810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5345813">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5345857">func</span>&nbsp;<span class="ident" id="5345862">Get</span><span class="op" id="5345865">(</span><span class="ident" id="5345866">name</span>&nbsp;<span class="builtintype" id="5345871">string</span><span class="op" id="5345877">)</span>&nbsp;<span class="ident" id="5345879">Var</span>&nbsp;<span class="op" id="5345883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5345886">mutex</span><span class="op" id="5345891">.</span><span class="ident" id="5345892">RLock</span><span class="op" id="5345897">(</span><span class="op" id="5345898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345901">defer</span>&nbsp;<span class="ident" id="5345907">mutex</span><span class="op" id="5345912">.</span><span class="ident" id="5345913">RUnlock</span><span class="op" id="5345920">(</span><span class="op" id="5345921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5345924">return</span>&nbsp;<span class="ident" id="5345931">vars</span><span class="op" id="5345935">[</span><span class="ident" id="5345936">name</span><span class="op" id="5345940">]</span><br>
<span class="lineno"></span><span class="op" id="5345942">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5345945">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346008">func</span>&nbsp;<span class="ident" id="5346013">NewInt</span><span class="op" id="5346019">(</span><span class="ident" id="5346020">name</span>&nbsp;<span class="builtintype" id="5346025">string</span><span class="op" id="5346031">)</span>&nbsp;<span class="op" id="5346033">*</span><span class="ident" id="5346034">Int</span>&nbsp;<span class="op" id="5346038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346041">v</span>&nbsp;<span class="op" id="5346043">:=</span>&nbsp;<span class="builtinfunc" id="5346046">new</span><span class="op" id="5346049">(</span><span class="ident" id="5346050">Int</span><span class="op" id="5346053">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346056">Publish</span><span class="op" id="5346063">(</span><span class="ident" id="5346064">name</span><span class="op" id="5346068">,</span>&nbsp;<span class="ident" id="5346070">v</span><span class="op" id="5346071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346074">return</span>&nbsp;<span class="ident" id="5346081">v</span><br>
<span class="lineno"></span><span class="op" id="5346083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346086">func</span>&nbsp;<span class="ident" id="5346091">NewFloat</span><span class="op" id="5346099">(</span><span class="ident" id="5346100">name</span>&nbsp;<span class="builtintype" id="5346105">string</span><span class="op" id="5346111">)</span>&nbsp;<span class="op" id="5346113">*</span><span class="ident" id="5346114">Float</span>&nbsp;<span class="op" id="5346120">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346123">v</span>&nbsp;<span class="op" id="5346125">:=</span>&nbsp;<span class="builtinfunc" id="5346128">new</span><span class="op" id="5346131">(</span><span class="ident" id="5346132">Float</span><span class="op" id="5346137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346140">Publish</span><span class="op" id="5346147">(</span><span class="ident" id="5346148">name</span><span class="op" id="5346152">,</span>&nbsp;<span class="ident" id="5346154">v</span><span class="op" id="5346155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346158">return</span>&nbsp;<span class="ident" id="5346165">v</span><br>
<span class="lineno"></span><span class="op" id="5346167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5346170">func</span>&nbsp;<span class="ident" id="5346175">NewMap</span><span class="op" id="5346181">(</span><span class="ident" id="5346182">name</span>&nbsp;<span class="builtintype" id="5346187">string</span><span class="op" id="5346193">)</span>&nbsp;<span class="op" id="5346195">*</span><span class="ident" id="5346196">Map</span>&nbsp;<span class="op" id="5346200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346203">v</span>&nbsp;<span class="op" id="5346205">:=</span>&nbsp;<span class="builtinfunc" id="5346208">new</span><span class="op" id="5346211">(</span><span class="ident" id="5346212">Map</span><span class="op" id="5346215">)</span><span class="op" id="5346216">.</span><span class="ident" id="5346217">Init</span><span class="op" id="5346221">(</span><span class="op" id="5346222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346225">Publish</span><span class="op" id="5346232">(</span><span class="ident" id="5346233">name</span><span class="op" id="5346237">,</span>&nbsp;<span class="ident" id="5346239">v</span><span class="op" id="5346240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346243">return</span>&nbsp;<span class="ident" id="5346250">v</span><br>
<span class="lineno"></span><span class="op" id="5346252">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5346255">func</span>&nbsp;<span class="ident" id="5346260">NewString</span><span class="op" id="5346269">(</span><span class="ident" id="5346270">name</span>&nbsp;<span class="builtintype" id="5346275">string</span><span class="op" id="5346281">)</span>&nbsp;<span class="op" id="5346283">*</span><span class="ident" id="5346284">String</span>&nbsp;<span class="op" id="5346291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346294">v</span>&nbsp;<span class="op" id="5346296">:=</span>&nbsp;<span class="builtinfunc" id="5346299">new</span><span class="op" id="5346302">(</span><span class="ident" id="5346303">String</span><span class="op" id="5346309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346312">Publish</span><span class="op" id="5346319">(</span><span class="ident" id="5346320">name</span><span class="op" id="5346324">,</span>&nbsp;<span class="ident" id="5346326">v</span><span class="op" id="5346327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346330">return</span>&nbsp;<span class="ident" id="5346337">v</span><br>
<span class="lineno">295</span><span class="op" id="5346339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5346342">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5346384">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5346443">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5346496">func</span>&nbsp;<span class="ident" id="5346501">Do</span><span class="op" id="5346503">(</span><span class="ident" id="5346504">f</span>&nbsp;<span class="keyword" id="5346506">func</span><span class="op" id="5346510">(</span><span class="ident" id="5346511">KeyValue</span><span class="op" id="5346519">)</span><span class="op" id="5346520">)</span>&nbsp;<span class="op" id="5346522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346525">mutex</span><span class="op" id="5346530">.</span><span class="ident" id="5346531">RLock</span><span class="op" id="5346536">(</span><span class="op" id="5346537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346540">defer</span>&nbsp;<span class="ident" id="5346546">mutex</span><span class="op" id="5346551">.</span><span class="ident" id="5346552">RUnlock</span><span class="op" id="5346559">(</span><span class="op" id="5346560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346563">for</span>&nbsp;<span class="ident" id="5346567">_</span><span class="op" id="5346568">,</span>&nbsp;<span class="ident" id="5346570">k</span>&nbsp;<span class="op" id="5346572">:=</span>&nbsp;<span class="keyword" id="5346575">range</span>&nbsp;<span class="ident" id="5346581">varKeys</span>&nbsp;<span class="op" id="5346589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346593">f</span><span class="op" id="5346594">(</span><span class="ident" id="5346595">KeyValue</span><span class="op" id="5346603">{</span><span class="ident" id="5346604">k</span><span class="op" id="5346605">,</span>&nbsp;<span class="ident" id="5346607">vars</span><span class="op" id="5346611">[</span><span class="ident" id="5346612">k</span><span class="op" id="5346613">]</span><span class="op" id="5346614">}</span><span class="op" id="5346615">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5346618">}</span><br>
<span class="lineno"></span><span class="op" id="5346620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346623">func</span>&nbsp;<span class="ident" id="5346628">expvarHandler</span><span class="op" id="5346641">(</span><span class="ident" id="5346642">w</span>&nbsp;<span class="ident" id="5346644">http</span><span class="op" id="5346648">.</span><span class="ident" id="5346649">ResponseWriter</span><span class="op" id="5346663">,</span>&nbsp;<span class="ident" id="5346665">r</span>&nbsp;<span class="op" id="5346667">*</span><span class="ident" id="5346668">http</span><span class="op" id="5346672">.</span><span class="ident" id="5346673">Request</span><span class="op" id="5346680">)</span>&nbsp;<span class="op" id="5346682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346685">w</span><span class="op" id="5346686">.</span><span class="ident" id="5346687">Header</span><span class="op" id="5346693">(</span><span class="op" id="5346694">)</span><span class="op" id="5346695">.</span><span class="ident" id="5346696">Set</span><span class="op" id="5346699">(</span><span class="string" id="5346700">&#34;Content-Type&#34;</span><span class="op" id="5346714">,</span>&nbsp;<span class="string" id="5346716">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5346749">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346752">fmt</span><span class="op" id="5346755">.</span><span class="ident" id="5346756">Fprintf</span><span class="op" id="5346763">(</span><span class="ident" id="5346764">w</span><span class="op" id="5346765">,</span>&nbsp;<span class="string" id="5346767">&#34;{\n&#34;</span><span class="op" id="5346772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346775">first</span>&nbsp;<span class="op" id="5346781">:=</span>&nbsp;<span class="builtintype" id="5346784">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346790">Do</span><span class="op" id="5346792">(</span><span class="keyword" id="5346793">func</span><span class="op" id="5346797">(</span><span class="ident" id="5346798">kv</span>&nbsp;<span class="ident" id="5346801">KeyValue</span><span class="op" id="5346809">)</span>&nbsp;<span class="op" id="5346811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346815">if</span>&nbsp;<span class="op" id="5346818">!</span><span class="ident" id="5346819">first</span>&nbsp;<span class="op" id="5346825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346830">fmt</span><span class="op" id="5346833">.</span><span class="ident" id="5346834">Fprintf</span><span class="op" id="5346841">(</span><span class="ident" id="5346842">w</span><span class="op" id="5346843">,</span>&nbsp;<span class="string" id="5346845">&#34;,\n&#34;</span><span class="op" id="5346850">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5346854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346858">first</span>&nbsp;<span class="op" id="5346864">=</span>&nbsp;<span class="builtintype" id="5346866">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346874">fmt</span><span class="op" id="5346877">.</span><span class="ident" id="5346878">Fprintf</span><span class="op" id="5346885">(</span><span class="ident" id="5346886">w</span><span class="op" id="5346887">,</span>&nbsp;<span class="string" id="5346889">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5346897">,</span>&nbsp;<span class="ident" id="5346899">kv</span><span class="op" id="5346901">.</span><span class="ident" id="5346902">Key</span><span class="op" id="5346905">,</span>&nbsp;<span class="ident" id="5346907">kv</span><span class="op" id="5346909">.</span><span class="ident" id="5346910">Value</span><span class="op" id="5346915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5346918">}</span><span class="op" id="5346919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5346922">fmt</span><span class="op" id="5346925">.</span><span class="ident" id="5346926">Fprintf</span><span class="op" id="5346933">(</span><span class="ident" id="5346934">w</span><span class="op" id="5346935">,</span>&nbsp;<span class="string" id="5346937">&#34;\n}\n&#34;</span><span class="op" id="5346944">)</span><br>
<span class="lineno">320</span><span class="op" id="5346946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5346949">func</span>&nbsp;<span class="ident" id="5346954">cmdline</span><span class="op" id="5346961">(</span><span class="op" id="5346962">)</span>&nbsp;<span class="keyword" id="5346964">interface</span><span class="op" id="5346973">{</span><span class="op" id="5346974">}</span>&nbsp;<span class="op" id="5346976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5346979">return</span>&nbsp;<span class="ident" id="5346986">os</span><span class="op" id="5346988">.</span><span class="ident" id="5346989">Args</span><br>
<span class="lineno"></span><span class="op" id="5346994">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5346997">func</span>&nbsp;<span class="ident" id="5347002">memstats</span><span class="op" id="5347010">(</span><span class="op" id="5347011">)</span>&nbsp;<span class="keyword" id="5347013">interface</span><span class="op" id="5347022">{</span><span class="op" id="5347023">}</span>&nbsp;<span class="op" id="5347025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347028">stats</span>&nbsp;<span class="op" id="5347034">:=</span>&nbsp;<span class="builtinfunc" id="5347037">new</span><span class="op" id="5347040">(</span><span class="ident" id="5347041">runtime</span><span class="op" id="5347048">.</span><span class="ident" id="5347049">MemStats</span><span class="op" id="5347057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347060">runtime</span><span class="op" id="5347067">.</span><span class="ident" id="5347068">ReadMemStats</span><span class="op" id="5347080">(</span><span class="ident" id="5347081">stats</span><span class="op" id="5347086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5347089">return</span>&nbsp;<span class="op" id="5347096">*</span><span class="ident" id="5347097">stats</span><br>
<span class="lineno">330</span><span class="op" id="5347103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5347106">func</span>&nbsp;<span class="ident" id="5347111">init</span><span class="op" id="5347115">(</span><span class="op" id="5347116">)</span>&nbsp;<span class="op" id="5347118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347121">http</span><span class="op" id="5347125">.</span><span class="ident" id="5347126">HandleFunc</span><span class="op" id="5347136">(</span><span class="string" id="5347137">&#34;/debug/vars&#34;</span><span class="op" id="5347150">,</span>&nbsp;<span class="ident" id="5347152">expvarHandler</span><span class="op" id="5347165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347168">Publish</span><span class="op" id="5347175">(</span><span class="string" id="5347176">&#34;cmdline&#34;</span><span class="op" id="5347185">,</span>&nbsp;<span class="ident" id="5347187">Func</span><span class="op" id="5347191">(</span><span class="ident" id="5347192">cmdline</span><span class="op" id="5347199">)</span><span class="op" id="5347200">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5347203">Publish</span><span class="op" id="5347210">(</span><span class="string" id="5347211">&#34;memstats&#34;</span><span class="op" id="5347221">,</span>&nbsp;<span class="ident" id="5347223">Func</span><span class="op" id="5347227">(</span><span class="ident" id="5347228">memstats</span><span class="op" id="5347236">)</span><span class="op" id="5347237">)</span><br>
<span class="lineno"></span><span class="op" id="5347239">}</span>
</div>
</body>
</html>
