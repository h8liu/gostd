<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="3562919">package</span>&nbsp;<span class="ident" id="3562927">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3562934">//&nbsp;Inst&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;executing&nbsp;one&nbsp;single&nbsp;instruction</span><br>
<span class="lineno"></span><span class="keyword" id="3562995">type</span>&nbsp;<span class="ident" id="3563000">inst</span>&nbsp;<span class="keyword" id="3563005">interface</span>&nbsp;<span class="op" id="3563015">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563018">I</span><span class="op" id="3563019">(</span><span class="ident" id="3563020">cpu</span>&nbsp;<span class="op" id="3563024">*</span><span class="ident" id="3563025">cpu</span><span class="op" id="3563028">,</span>&nbsp;<span class="ident" id="3563030">in</span>&nbsp;<span class="builtintype" id="3563033">uint32</span><span class="op" id="3563039">)</span>&nbsp;<span class="op" id="3563041">*</span><span class="ident" id="3563042">Excep</span><br>
<span class="lineno"></span><span class="op" id="3563048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3563051">//&nbsp;CPU&nbsp;defines&nbsp;the&nbsp;structure&nbsp;of&nbsp;a&nbsp;processing&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="3563102">type</span>&nbsp;<span class="ident" id="3563107">cpu</span>&nbsp;<span class="keyword" id="3563111">struct</span>&nbsp;<span class="op" id="3563118">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563121">regs</span>&nbsp;<span class="op" id="3563126">[</span><span class="op" id="3563127">]</span><span class="builtintype" id="3563128">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563136">ring</span>&nbsp;<span class="builtintype" id="3563141">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563148">phyMem</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3563158">*</span><span class="ident" id="3563159">phyMemory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563170">virtMem</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3563180">*</span><span class="ident" id="3563181">virtMemory</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563193">interrupt</span>&nbsp;<span class="op" id="3563203">*</span><span class="ident" id="3563204">interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563216">inst</span>&nbsp;&nbsp;<span class="ident" id="3563222">inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563228">index</span>&nbsp;<span class="builtintype" id="3563234">byte</span><br>
<span class="lineno"></span><span class="op" id="3563239">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3563242">//&nbsp;InitPC&nbsp;points&nbsp;the&nbsp;default&nbsp;starting&nbsp;value&nbsp;of&nbsp;the&nbsp;program&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="3563310">const</span>&nbsp;<span class="ident" id="3563316">InitPC</span>&nbsp;<span class="op" id="3563323">=</span>&nbsp;<span class="num" id="3563325">0x8000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3563333">//&nbsp;NewCPU&nbsp;creates&nbsp;a&nbsp;CPU&nbsp;with&nbsp;memroy&nbsp;and&nbsp;instruction&nbsp;binding</span><br>
<span class="lineno">25</span><span class="keyword" id="3563393">func</span>&nbsp;<span class="ident" id="3563398">newCPU</span><span class="op" id="3563404">(</span><span class="ident" id="3563405">mem</span>&nbsp;<span class="op" id="3563409">*</span><span class="ident" id="3563410">phyMemory</span><span class="op" id="3563419">,</span>&nbsp;<span class="ident" id="3563421">i</span>&nbsp;<span class="ident" id="3563423">inst</span><span class="op" id="3563427">,</span>&nbsp;<span class="ident" id="3563429">index</span>&nbsp;<span class="builtintype" id="3563435">byte</span><span class="op" id="3563439">)</span>&nbsp;<span class="op" id="3563441">*</span><span class="ident" id="3563442">cpu</span>&nbsp;<span class="op" id="3563446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3563449">if</span>&nbsp;<span class="ident" id="3563452">index</span>&nbsp;<span class="op" id="3563458">&gt;=</span>&nbsp;<span class="num" id="3563461">32</span>&nbsp;<span class="op" id="3563464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3563468">panic</span><span class="op" id="3563473">(</span><span class="string" id="3563474">&#34;too&nbsp;many&nbsp;cores&#34;</span><span class="op" id="3563490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3563493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563497">ret</span>&nbsp;<span class="op" id="3563501">:=</span>&nbsp;<span class="builtinfunc" id="3563504">new</span><span class="op" id="3563507">(</span><span class="ident" id="3563508">cpu</span><span class="op" id="3563511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563514">ret</span><span class="op" id="3563517">.</span><span class="ident" id="3563518">regs</span>&nbsp;<span class="op" id="3563523">=</span>&nbsp;<span class="ident" id="3563525">makeRegs</span><span class="op" id="3563533">(</span><span class="op" id="3563534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563537">ret</span><span class="op" id="3563540">.</span><span class="ident" id="3563541">phyMem</span>&nbsp;<span class="op" id="3563548">=</span>&nbsp;<span class="ident" id="3563550">mem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563555">ret</span><span class="op" id="3563558">.</span><span class="ident" id="3563559">virtMem</span>&nbsp;<span class="op" id="3563567">=</span>&nbsp;<span class="ident" id="3563569">newVirtMemory</span><span class="op" id="3563582">(</span><span class="ident" id="3563583">ret</span><span class="op" id="3563586">.</span><span class="ident" id="3563587">phyMem</span><span class="op" id="3563593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563596">ret</span><span class="op" id="3563599">.</span><span class="ident" id="3563600">index</span>&nbsp;<span class="op" id="3563606">=</span>&nbsp;<span class="ident" id="3563608">index</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563616">intPage</span>&nbsp;<span class="op" id="3563624">:=</span>&nbsp;<span class="ident" id="3563627">ret</span><span class="op" id="3563630">.</span><span class="ident" id="3563631">phyMem</span><span class="op" id="3563637">.</span><span class="ident" id="3563638">Page</span><span class="op" id="3563642">(</span><span class="ident" id="3563643">pageInterrupt</span><span class="op" id="3563656">)</span>&nbsp;<span class="comment" id="3563658">//&nbsp;page&nbsp;1&nbsp;is&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3563691">if</span>&nbsp;<span class="ident" id="3563694">intPage</span>&nbsp;<span class="op" id="3563702">==</span>&nbsp;<span class="ident" id="3563705">nil</span>&nbsp;<span class="op" id="3563709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3563713">panic</span><span class="op" id="3563718">(</span><span class="string" id="3563719">&#34;memory&nbsp;too&nbsp;small&#34;</span><span class="op" id="3563737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3563740">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563743">ret</span><span class="op" id="3563746">.</span><span class="ident" id="3563747">interrupt</span>&nbsp;<span class="op" id="3563757">=</span>&nbsp;<span class="ident" id="3563759">newInterrupt</span><span class="op" id="3563771">(</span><span class="ident" id="3563772">intPage</span><span class="op" id="3563779">,</span>&nbsp;<span class="ident" id="3563781">index</span><span class="op" id="3563786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563789">ret</span><span class="op" id="3563792">.</span><span class="ident" id="3563793">inst</span>&nbsp;<span class="op" id="3563798">=</span>&nbsp;<span class="ident" id="3563800">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3563804">ret</span><span class="op" id="3563807">.</span><span class="ident" id="3563808">regs</span><span class="op" id="3563812">[</span><span class="ident" id="3563813">PC</span><span class="op" id="3563815">]</span>&nbsp;<span class="op" id="3563817">=</span>&nbsp;<span class="ident" id="3563819">InitPC</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3563828">return</span>&nbsp;<span class="ident" id="3563835">ret</span><br>
<span class="lineno"></span><span class="op" id="3563839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3563842">//&nbsp;UserMode&nbsp;returns&nbsp;trun&nbsp;when&nbsp;the&nbsp;CPU&nbsp;is&nbsp;in&nbsp;user&nbsp;mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3563897">func</span>&nbsp;<span class="op" id="3563902">(</span><span class="ident" id="3563903">c</span>&nbsp;<span class="op" id="3563905">*</span><span class="ident" id="3563906">cpu</span><span class="op" id="3563909">)</span>&nbsp;<span class="ident" id="3563911">UserMode</span><span class="op" id="3563919">(</span><span class="op" id="3563920">)</span>&nbsp;<span class="builtintype" id="3563922">bool</span>&nbsp;<span class="op" id="3563927">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3563930">return</span>&nbsp;<span class="ident" id="3563937">c</span><span class="op" id="3563938">.</span><span class="ident" id="3563939">ring</span>&nbsp;<span class="op" id="3563944">&gt;</span>&nbsp;<span class="num" id="3563946">0</span><br>
<span class="lineno"></span><span class="op" id="3563948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3563951">//&nbsp;Reset&nbsp;resets&nbsp;the&nbsp;CPU&#39;s&nbsp;internal&nbsp;states,&nbsp;i.e.,&nbsp;registers,</span><br>
<span class="lineno"></span><span class="comment" id="3564011">//&nbsp;the&nbsp;page&nbsp;table,&nbsp;and&nbsp;disables&nbsp;interrupt</span><br>
<span class="lineno">55</span><span class="keyword" id="3564053">func</span>&nbsp;<span class="op" id="3564058">(</span><span class="ident" id="3564059">c</span>&nbsp;<span class="op" id="3564061">*</span><span class="ident" id="3564062">cpu</span><span class="op" id="3564065">)</span>&nbsp;<span class="ident" id="3564067">Reset</span><span class="op" id="3564072">(</span><span class="op" id="3564073">)</span>&nbsp;<span class="op" id="3564075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564078">for</span>&nbsp;<span class="ident" id="3564082">i</span>&nbsp;<span class="op" id="3564084">:=</span>&nbsp;<span class="num" id="3564087">0</span><span class="op" id="3564088">;</span>&nbsp;<span class="ident" id="3564090">i</span>&nbsp;<span class="op" id="3564092">&lt;</span>&nbsp;<span class="ident" id="3564094">Nreg</span><span class="op" id="3564098">;</span>&nbsp;<span class="ident" id="3564100">i</span><span class="op" id="3564101">++</span>&nbsp;<span class="op" id="3564104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564108">c</span><span class="op" id="3564109">.</span><span class="ident" id="3564110">regs</span><span class="op" id="3564114">[</span><span class="ident" id="3564115">i</span><span class="op" id="3564116">]</span>&nbsp;<span class="op" id="3564118">=</span>&nbsp;<span class="num" id="3564120">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3564123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564126">c</span><span class="op" id="3564127">.</span><span class="ident" id="3564128">regs</span><span class="op" id="3564132">[</span><span class="ident" id="3564133">PC</span><span class="op" id="3564135">]</span>&nbsp;<span class="op" id="3564137">=</span>&nbsp;<span class="ident" id="3564139">InitPC</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564147">c</span><span class="op" id="3564148">.</span><span class="ident" id="3564149">virtMem</span><span class="op" id="3564156">.</span><span class="ident" id="3564157">SetTable</span><span class="op" id="3564165">(</span><span class="num" id="3564166">0</span><span class="op" id="3564167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564170">c</span><span class="op" id="3564171">.</span><span class="ident" id="3564172">ring</span>&nbsp;<span class="op" id="3564177">=</span>&nbsp;<span class="num" id="3564179">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564182">c</span><span class="op" id="3564183">.</span><span class="ident" id="3564184">interrupt</span><span class="op" id="3564193">.</span><span class="ident" id="3564194">Disable</span><span class="op" id="3564201">(</span><span class="op" id="3564202">)</span><br>
<span class="lineno"></span><span class="op" id="3564204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3564207">func</span>&nbsp;<span class="op" id="3564212">(</span><span class="ident" id="3564213">c</span>&nbsp;<span class="op" id="3564215">*</span><span class="ident" id="3564216">cpu</span><span class="op" id="3564219">)</span>&nbsp;<span class="ident" id="3564221">tick</span><span class="op" id="3564225">(</span><span class="op" id="3564226">)</span>&nbsp;<span class="op" id="3564228">*</span><span class="ident" id="3564229">Excep</span>&nbsp;<span class="op" id="3564235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564238">pc</span>&nbsp;<span class="op" id="3564241">:=</span>&nbsp;<span class="ident" id="3564244">c</span><span class="op" id="3564245">.</span><span class="ident" id="3564246">regs</span><span class="op" id="3564250">[</span><span class="ident" id="3564251">PC</span><span class="op" id="3564253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564256">inst</span><span class="op" id="3564260">,</span>&nbsp;<span class="ident" id="3564262">e</span>&nbsp;<span class="op" id="3564264">:=</span>&nbsp;<span class="ident" id="3564267">c</span><span class="op" id="3564268">.</span><span class="ident" id="3564269">readWord</span><span class="op" id="3564277">(</span><span class="ident" id="3564278">pc</span><span class="op" id="3564280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564283">if</span>&nbsp;<span class="ident" id="3564286">e</span>&nbsp;<span class="op" id="3564288">!=</span>&nbsp;<span class="ident" id="3564291">nil</span>&nbsp;<span class="op" id="3564295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564299">return</span>&nbsp;<span class="ident" id="3564306">e</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3564309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564313">c</span><span class="op" id="3564314">.</span><span class="ident" id="3564315">regs</span><span class="op" id="3564319">[</span><span class="ident" id="3564320">PC</span><span class="op" id="3564322">]</span>&nbsp;<span class="op" id="3564324">=</span>&nbsp;<span class="ident" id="3564326">pc</span>&nbsp;<span class="op" id="3564329">+</span>&nbsp;<span class="num" id="3564331">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564334">if</span>&nbsp;<span class="ident" id="3564337">c</span><span class="op" id="3564338">.</span><span class="ident" id="3564339">inst</span>&nbsp;<span class="op" id="3564344">!=</span>&nbsp;<span class="ident" id="3564347">nil</span>&nbsp;<span class="op" id="3564351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564355">e</span>&nbsp;<span class="op" id="3564357">=</span>&nbsp;<span class="ident" id="3564359">c</span><span class="op" id="3564360">.</span><span class="ident" id="3564361">inst</span><span class="op" id="3564365">.</span><span class="ident" id="3564366">I</span><span class="op" id="3564367">(</span><span class="ident" id="3564368">c</span><span class="op" id="3564369">,</span>&nbsp;<span class="ident" id="3564371">inst</span><span class="op" id="3564375">)</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564380">if</span>&nbsp;<span class="ident" id="3564383">e</span>&nbsp;<span class="op" id="3564385">!=</span>&nbsp;<span class="ident" id="3564388">nil</span>&nbsp;<span class="op" id="3564392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564397">c</span><span class="op" id="3564398">.</span><span class="ident" id="3564399">regs</span><span class="op" id="3564403">[</span><span class="ident" id="3564404">PC</span><span class="op" id="3564406">]</span>&nbsp;<span class="op" id="3564408">=</span>&nbsp;<span class="ident" id="3564410">pc</span>&nbsp;<span class="comment" id="3564413">//&nbsp;restore&nbsp;saved&nbsp;original&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564445">return</span>&nbsp;<span class="ident" id="3564452">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3564456">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3564459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564463">return</span>&nbsp;<span class="ident" id="3564470">nil</span><br>
<span class="lineno"></span><span class="op" id="3564474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3564477">const</span>&nbsp;<span class="op" id="3564483">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564486">intFrameSP</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3564499">=</span>&nbsp;<span class="num" id="3564501">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564504">intFrameRET</span>&nbsp;&nbsp;<span class="op" id="3564517">=</span>&nbsp;<span class="num" id="3564519">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564522">intFrameArg</span>&nbsp;&nbsp;<span class="op" id="3564535">=</span>&nbsp;<span class="num" id="3564537">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564540">intFrameCode</span>&nbsp;<span class="op" id="3564553">=</span>&nbsp;<span class="num" id="3564555">12</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564559">intFrameRing</span>&nbsp;<span class="op" id="3564572">=</span>&nbsp;<span class="num" id="3564574">13</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564579">intFrameSize</span>&nbsp;<span class="op" id="3564592">=</span>&nbsp;<span class="num" id="3564594">16</span><br>
<span class="lineno"></span><span class="op" id="3564597">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3564600">//&nbsp;Interrupt&nbsp;issues&nbsp;an&nbsp;interrupt&nbsp;to&nbsp;the&nbsp;core</span><br>
<span class="lineno"></span><span class="keyword" id="3564645">func</span>&nbsp;<span class="op" id="3564650">(</span><span class="ident" id="3564651">c</span>&nbsp;<span class="op" id="3564653">*</span><span class="ident" id="3564654">cpu</span><span class="op" id="3564657">)</span>&nbsp;<span class="ident" id="3564659">Interrupt</span><span class="op" id="3564668">(</span><span class="ident" id="3564669">code</span>&nbsp;<span class="builtintype" id="3564674">byte</span><span class="op" id="3564678">)</span>&nbsp;<span class="op" id="3564680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3564683">c</span><span class="op" id="3564684">.</span><span class="ident" id="3564685">interrupt</span><span class="op" id="3564694">.</span><span class="ident" id="3564695">Issue</span><span class="op" id="3564700">(</span><span class="ident" id="3564701">code</span><span class="op" id="3564705">)</span><br>
<span class="lineno"></span><span class="op" id="3564707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3564710">func</span>&nbsp;<span class="op" id="3564715">(</span><span class="ident" id="3564716">c</span>&nbsp;<span class="op" id="3564718">*</span><span class="ident" id="3564719">cpu</span><span class="op" id="3564722">)</span>&nbsp;<span class="ident" id="3564724">readWord</span><span class="op" id="3564732">(</span><span class="ident" id="3564733">addr</span>&nbsp;<span class="builtintype" id="3564738">uint32</span><span class="op" id="3564744">)</span>&nbsp;<span class="op" id="3564746">(</span><span class="builtintype" id="3564747">uint32</span><span class="op" id="3564753">,</span>&nbsp;<span class="op" id="3564755">*</span><span class="ident" id="3564756">Excep</span><span class="op" id="3564761">)</span>&nbsp;<span class="op" id="3564763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564766">return</span>&nbsp;<span class="ident" id="3564773">c</span><span class="op" id="3564774">.</span><span class="ident" id="3564775">virtMem</span><span class="op" id="3564782">.</span><span class="ident" id="3564783">ReadWord</span><span class="op" id="3564791">(</span><span class="ident" id="3564792">addr</span><span class="op" id="3564796">,</span>&nbsp;<span class="ident" id="3564798">c</span><span class="op" id="3564799">.</span><span class="ident" id="3564800">ring</span><span class="op" id="3564804">)</span><br>
<span class="lineno"></span><span class="op" id="3564806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564809">func</span>&nbsp;<span class="op" id="3564814">(</span><span class="ident" id="3564815">c</span>&nbsp;<span class="op" id="3564817">*</span><span class="ident" id="3564818">cpu</span><span class="op" id="3564821">)</span>&nbsp;<span class="ident" id="3564823">readByte</span><span class="op" id="3564831">(</span><span class="ident" id="3564832">addr</span>&nbsp;<span class="builtintype" id="3564837">uint32</span><span class="op" id="3564843">)</span>&nbsp;<span class="op" id="3564845">(</span><span class="builtintype" id="3564846">uint8</span><span class="op" id="3564851">,</span>&nbsp;<span class="op" id="3564853">*</span><span class="ident" id="3564854">Excep</span><span class="op" id="3564859">)</span>&nbsp;<span class="op" id="3564861">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564864">return</span>&nbsp;<span class="ident" id="3564871">c</span><span class="op" id="3564872">.</span><span class="ident" id="3564873">virtMem</span><span class="op" id="3564880">.</span><span class="ident" id="3564881">ReadByte</span><span class="op" id="3564889">(</span><span class="ident" id="3564890">addr</span><span class="op" id="3564894">,</span>&nbsp;<span class="ident" id="3564896">c</span><span class="op" id="3564897">.</span><span class="ident" id="3564898">ring</span><span class="op" id="3564902">)</span><br>
<span class="lineno"></span><span class="op" id="3564904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3564907">func</span>&nbsp;<span class="op" id="3564912">(</span><span class="ident" id="3564913">c</span>&nbsp;<span class="op" id="3564915">*</span><span class="ident" id="3564916">cpu</span><span class="op" id="3564919">)</span>&nbsp;<span class="ident" id="3564921">writeWord</span><span class="op" id="3564930">(</span><span class="ident" id="3564931">addr</span>&nbsp;<span class="builtintype" id="3564936">uint32</span><span class="op" id="3564942">,</span>&nbsp;<span class="ident" id="3564944">v</span>&nbsp;<span class="builtintype" id="3564946">uint32</span><span class="op" id="3564952">)</span>&nbsp;<span class="op" id="3564954">*</span><span class="ident" id="3564955">Excep</span>&nbsp;<span class="op" id="3564961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3564964">return</span>&nbsp;<span class="ident" id="3564971">c</span><span class="op" id="3564972">.</span><span class="ident" id="3564973">virtMem</span><span class="op" id="3564980">.</span><span class="ident" id="3564981">WriteWord</span><span class="op" id="3564990">(</span><span class="ident" id="3564991">addr</span><span class="op" id="3564995">,</span>&nbsp;<span class="ident" id="3564997">c</span><span class="op" id="3564998">.</span><span class="ident" id="3564999">ring</span><span class="op" id="3565003">,</span>&nbsp;<span class="ident" id="3565005">v</span><span class="op" id="3565006">)</span><br>
<span class="lineno">110</span><span class="op" id="3565008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3565011">func</span>&nbsp;<span class="op" id="3565016">(</span><span class="ident" id="3565017">c</span>&nbsp;<span class="op" id="3565019">*</span><span class="ident" id="3565020">cpu</span><span class="op" id="3565023">)</span>&nbsp;<span class="ident" id="3565025">writeByte</span><span class="op" id="3565034">(</span><span class="ident" id="3565035">addr</span>&nbsp;<span class="builtintype" id="3565040">uint32</span><span class="op" id="3565046">,</span>&nbsp;<span class="ident" id="3565048">v</span>&nbsp;<span class="builtintype" id="3565050">uint8</span><span class="op" id="3565055">)</span>&nbsp;<span class="op" id="3565057">*</span><span class="ident" id="3565058">Excep</span>&nbsp;<span class="op" id="3565064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565067">return</span>&nbsp;<span class="ident" id="3565074">c</span><span class="op" id="3565075">.</span><span class="ident" id="3565076">virtMem</span><span class="op" id="3565083">.</span><span class="ident" id="3565084">WriteByte</span><span class="op" id="3565093">(</span><span class="ident" id="3565094">addr</span><span class="op" id="3565098">,</span>&nbsp;<span class="ident" id="3565100">c</span><span class="op" id="3565101">.</span><span class="ident" id="3565102">ring</span><span class="op" id="3565106">,</span>&nbsp;<span class="ident" id="3565108">v</span><span class="op" id="3565109">)</span><br>
<span class="lineno"></span><span class="op" id="3565111">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="3565114">//&nbsp;Ienter&nbsp;enters&nbsp;a&nbsp;interrupt&nbsp;routine.</span><br>
<span class="lineno"></span><span class="keyword" id="3565152">func</span>&nbsp;<span class="op" id="3565157">(</span><span class="ident" id="3565158">c</span>&nbsp;<span class="op" id="3565160">*</span><span class="ident" id="3565161">cpu</span><span class="op" id="3565164">)</span>&nbsp;<span class="ident" id="3565166">Ienter</span><span class="op" id="3565172">(</span><span class="ident" id="3565173">code</span>&nbsp;<span class="builtintype" id="3565178">byte</span><span class="op" id="3565182">,</span>&nbsp;<span class="ident" id="3565184">arg</span>&nbsp;<span class="builtintype" id="3565188">uint32</span><span class="op" id="3565194">)</span>&nbsp;<span class="op" id="3565196">*</span><span class="ident" id="3565197">Excep</span>&nbsp;<span class="op" id="3565203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565206">ksp</span>&nbsp;<span class="op" id="3565210">:=</span>&nbsp;<span class="ident" id="3565213">c</span><span class="op" id="3565214">.</span><span class="ident" id="3565215">interrupt</span><span class="op" id="3565224">.</span><span class="ident" id="3565225">kernelSP</span><span class="op" id="3565233">(</span><span class="op" id="3565234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565237">base</span>&nbsp;<span class="op" id="3565242">:=</span>&nbsp;<span class="ident" id="3565245">ksp</span>&nbsp;<span class="op" id="3565249">-</span>&nbsp;<span class="ident" id="3565251">intFrameSize</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565266">writeWord</span>&nbsp;<span class="op" id="3565276">:=</span>&nbsp;<span class="keyword" id="3565279">func</span><span class="op" id="3565283">(</span><span class="ident" id="3565284">off</span>&nbsp;<span class="builtintype" id="3565288">uint32</span><span class="op" id="3565294">,</span>&nbsp;<span class="ident" id="3565296">v</span>&nbsp;<span class="builtintype" id="3565298">uint32</span><span class="op" id="3565304">)</span>&nbsp;<span class="op" id="3565306">*</span><span class="ident" id="3565307">Excep</span>&nbsp;<span class="op" id="3565313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565317">return</span>&nbsp;<span class="ident" id="3565324">c</span><span class="op" id="3565325">.</span><span class="ident" id="3565326">virtMem</span><span class="op" id="3565333">.</span><span class="ident" id="3565334">WriteWord</span><span class="op" id="3565343">(</span><span class="ident" id="3565344">base</span><span class="op" id="3565348">+</span><span class="ident" id="3565349">off</span><span class="op" id="3565352">,</span>&nbsp;<span class="num" id="3565354">0</span><span class="op" id="3565355">,</span>&nbsp;<span class="ident" id="3565357">v</span><span class="op" id="3565358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565364">writeByte</span>&nbsp;<span class="op" id="3565374">:=</span>&nbsp;<span class="keyword" id="3565377">func</span><span class="op" id="3565381">(</span><span class="ident" id="3565382">off</span>&nbsp;<span class="builtintype" id="3565386">uint32</span><span class="op" id="3565392">,</span>&nbsp;<span class="ident" id="3565394">b</span>&nbsp;<span class="builtintype" id="3565396">uint8</span><span class="op" id="3565401">)</span>&nbsp;<span class="op" id="3565403">*</span><span class="ident" id="3565404">Excep</span>&nbsp;<span class="op" id="3565410">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565414">return</span>&nbsp;<span class="ident" id="3565421">c</span><span class="op" id="3565422">.</span><span class="ident" id="3565423">virtMem</span><span class="op" id="3565430">.</span><span class="ident" id="3565431">WriteByte</span><span class="op" id="3565440">(</span><span class="ident" id="3565441">base</span><span class="op" id="3565445">+</span><span class="ident" id="3565446">off</span><span class="op" id="3565449">,</span>&nbsp;<span class="num" id="3565451">0</span><span class="op" id="3565452">,</span>&nbsp;<span class="ident" id="3565454">b</span><span class="op" id="3565455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565461">if</span>&nbsp;<span class="ident" id="3565464">e</span>&nbsp;<span class="op" id="3565466">:=</span>&nbsp;<span class="ident" id="3565469">writeWord</span><span class="op" id="3565478">(</span><span class="ident" id="3565479">intFrameSP</span><span class="op" id="3565489">,</span>&nbsp;<span class="ident" id="3565491">c</span><span class="op" id="3565492">.</span><span class="ident" id="3565493">regs</span><span class="op" id="3565497">[</span><span class="ident" id="3565498">SP</span><span class="op" id="3565500">]</span><span class="op" id="3565501">)</span><span class="op" id="3565502">;</span>&nbsp;<span class="ident" id="3565504">e</span>&nbsp;<span class="op" id="3565506">!=</span>&nbsp;<span class="ident" id="3565509">nil</span>&nbsp;<span class="op" id="3565513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565517">return</span>&nbsp;<span class="ident" id="3565524">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565527">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565530">if</span>&nbsp;<span class="ident" id="3565533">e</span>&nbsp;<span class="op" id="3565535">:=</span>&nbsp;<span class="ident" id="3565538">writeWord</span><span class="op" id="3565547">(</span><span class="ident" id="3565548">intFrameRET</span><span class="op" id="3565559">,</span>&nbsp;<span class="ident" id="3565561">c</span><span class="op" id="3565562">.</span><span class="ident" id="3565563">regs</span><span class="op" id="3565567">[</span><span class="ident" id="3565568">RET</span><span class="op" id="3565571">]</span><span class="op" id="3565572">)</span><span class="op" id="3565573">;</span>&nbsp;<span class="ident" id="3565575">e</span>&nbsp;<span class="op" id="3565577">!=</span>&nbsp;<span class="ident" id="3565580">nil</span>&nbsp;<span class="op" id="3565584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565588">return</span>&nbsp;<span class="ident" id="3565595">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565601">if</span>&nbsp;<span class="ident" id="3565604">e</span>&nbsp;<span class="op" id="3565606">:=</span>&nbsp;<span class="ident" id="3565609">writeWord</span><span class="op" id="3565618">(</span><span class="ident" id="3565619">intFrameArg</span><span class="op" id="3565630">,</span>&nbsp;<span class="ident" id="3565632">arg</span><span class="op" id="3565635">)</span><span class="op" id="3565636">;</span>&nbsp;<span class="ident" id="3565638">e</span>&nbsp;<span class="op" id="3565640">!=</span>&nbsp;<span class="ident" id="3565643">nil</span>&nbsp;<span class="op" id="3565647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565651">return</span>&nbsp;<span class="ident" id="3565658">e</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565664">if</span>&nbsp;<span class="ident" id="3565667">e</span>&nbsp;<span class="op" id="3565669">:=</span>&nbsp;<span class="ident" id="3565672">writeByte</span><span class="op" id="3565681">(</span><span class="ident" id="3565682">intFrameCode</span><span class="op" id="3565694">,</span>&nbsp;<span class="ident" id="3565696">code</span><span class="op" id="3565700">)</span><span class="op" id="3565701">;</span>&nbsp;<span class="ident" id="3565703">e</span>&nbsp;<span class="op" id="3565705">!=</span>&nbsp;<span class="ident" id="3565708">nil</span>&nbsp;<span class="op" id="3565712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565716">return</span>&nbsp;<span class="ident" id="3565723">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565729">if</span>&nbsp;<span class="ident" id="3565732">e</span>&nbsp;<span class="op" id="3565734">:=</span>&nbsp;<span class="ident" id="3565737">writeByte</span><span class="op" id="3565746">(</span><span class="ident" id="3565747">intFrameRing</span><span class="op" id="3565759">,</span>&nbsp;<span class="ident" id="3565761">c</span><span class="op" id="3565762">.</span><span class="ident" id="3565763">ring</span><span class="op" id="3565767">)</span><span class="op" id="3565768">;</span>&nbsp;<span class="ident" id="3565770">e</span>&nbsp;<span class="op" id="3565772">!=</span>&nbsp;<span class="ident" id="3565775">nil</span>&nbsp;<span class="op" id="3565779">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565783">return</span>&nbsp;<span class="ident" id="3565790">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3565793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565797">c</span><span class="op" id="3565798">.</span><span class="ident" id="3565799">interrupt</span><span class="op" id="3565808">.</span><span class="ident" id="3565809">Disable</span><span class="op" id="3565816">(</span><span class="op" id="3565817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565820">c</span><span class="op" id="3565821">.</span><span class="ident" id="3565822">regs</span><span class="op" id="3565826">[</span><span class="ident" id="3565827">SP</span><span class="op" id="3565829">]</span>&nbsp;<span class="op" id="3565831">=</span>&nbsp;<span class="ident" id="3565833">ksp</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565838">c</span><span class="op" id="3565839">.</span><span class="ident" id="3565840">regs</span><span class="op" id="3565844">[</span><span class="ident" id="3565845">RET</span><span class="op" id="3565848">]</span>&nbsp;<span class="op" id="3565850">=</span>&nbsp;<span class="ident" id="3565852">c</span><span class="op" id="3565853">.</span><span class="ident" id="3565854">regs</span><span class="op" id="3565858">[</span><span class="ident" id="3565859">PC</span><span class="op" id="3565861">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565864">c</span><span class="op" id="3565865">.</span><span class="ident" id="3565866">regs</span><span class="op" id="3565870">[</span><span class="ident" id="3565871">PC</span><span class="op" id="3565873">]</span>&nbsp;<span class="op" id="3565875">=</span>&nbsp;<span class="ident" id="3565877">c</span><span class="op" id="3565878">.</span><span class="ident" id="3565879">interrupt</span><span class="op" id="3565888">.</span><span class="ident" id="3565889">handlerPC</span><span class="op" id="3565898">(</span><span class="op" id="3565899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3565902">c</span><span class="op" id="3565903">.</span><span class="ident" id="3565904">ring</span>&nbsp;<span class="op" id="3565909">=</span>&nbsp;<span class="num" id="3565911">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3565915">return</span>&nbsp;<span class="ident" id="3565922">nil</span><br>
<span class="lineno">150</span><span class="op" id="3565926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3565929">//&nbsp;Syscall&nbsp;jumps&nbsp;to&nbsp;the&nbsp;system&nbsp;call&nbsp;handler&nbsp;and&nbsp;switches&nbsp;to&nbsp;ring&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3565997">func</span>&nbsp;<span class="op" id="3566002">(</span><span class="ident" id="3566003">c</span>&nbsp;<span class="op" id="3566005">*</span><span class="ident" id="3566006">cpu</span><span class="op" id="3566009">)</span>&nbsp;<span class="ident" id="3566011">Syscall</span><span class="op" id="3566018">(</span><span class="op" id="3566019">)</span>&nbsp;<span class="op" id="3566021">*</span><span class="ident" id="3566022">Excep</span>&nbsp;<span class="op" id="3566028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566031">c</span><span class="op" id="3566032">.</span><span class="ident" id="3566033">regs</span><span class="op" id="3566037">[</span><span class="ident" id="3566038">PC</span><span class="op" id="3566040">]</span>&nbsp;<span class="op" id="3566042">=</span>&nbsp;<span class="ident" id="3566044">c</span><span class="op" id="3566045">.</span><span class="ident" id="3566046">interrupt</span><span class="op" id="3566055">.</span><span class="ident" id="3566056">syscallPC</span><span class="op" id="3566065">(</span><span class="op" id="3566066">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566069">c</span><span class="op" id="3566070">.</span><span class="ident" id="3566071">ring</span>&nbsp;<span class="op" id="3566076">=</span>&nbsp;<span class="num" id="3566078">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566081">return</span>&nbsp;<span class="ident" id="3566088">nil</span><br>
<span class="lineno"></span><span class="op" id="3566092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3566095">//&nbsp;Iret&nbsp;restores&nbsp;from&nbsp;an&nbsp;interrupt.</span><br>
<span class="lineno">160</span><span class="comment" id="3566131">//&nbsp;It&nbsp;restores&nbsp;the&nbsp;SP,&nbsp;RET,&nbsp;PC&nbsp;registers,&nbsp;restores&nbsp;the&nbsp;ring&nbsp;level,</span><br>
<span class="lineno"></span><span class="comment" id="3566198">//&nbsp;clears&nbsp;the&nbsp;served&nbsp;interrupt&nbsp;bit&nbsp;and&nbsp;enables&nbsp;interrupt&nbsp;again.</span><br>
<span class="lineno"></span><span class="keyword" id="3566262">func</span>&nbsp;<span class="op" id="3566267">(</span><span class="ident" id="3566268">c</span>&nbsp;<span class="op" id="3566270">*</span><span class="ident" id="3566271">cpu</span><span class="op" id="3566274">)</span>&nbsp;<span class="ident" id="3566276">Iret</span><span class="op" id="3566280">(</span><span class="op" id="3566281">)</span>&nbsp;<span class="op" id="3566283">*</span><span class="ident" id="3566284">Excep</span>&nbsp;<span class="op" id="3566290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566293">if</span>&nbsp;<span class="ident" id="3566296">c</span><span class="op" id="3566297">.</span><span class="ident" id="3566298">ring</span>&nbsp;<span class="op" id="3566303">!=</span>&nbsp;<span class="num" id="3566306">0</span>&nbsp;<span class="op" id="3566308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3566312">panic</span><span class="op" id="3566317">(</span><span class="string" id="3566318">&#34;iret&nbsp;in&nbsp;userland&#34;</span><span class="op" id="3566336">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3566339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566343">ksp</span>&nbsp;<span class="op" id="3566347">:=</span>&nbsp;<span class="ident" id="3566350">c</span><span class="op" id="3566351">.</span><span class="ident" id="3566352">interrupt</span><span class="op" id="3566361">.</span><span class="ident" id="3566362">kernelSP</span><span class="op" id="3566370">(</span><span class="op" id="3566371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566374">base</span>&nbsp;<span class="op" id="3566379">:=</span>&nbsp;<span class="ident" id="3566382">ksp</span>&nbsp;<span class="op" id="3566386">-</span>&nbsp;<span class="ident" id="3566388">intFrameSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566402">sp</span><span class="op" id="3566404">,</span>&nbsp;<span class="ident" id="3566406">e</span>&nbsp;<span class="op" id="3566408">:=</span>&nbsp;<span class="ident" id="3566411">c</span><span class="op" id="3566412">.</span><span class="ident" id="3566413">readWord</span><span class="op" id="3566421">(</span><span class="ident" id="3566422">base</span>&nbsp;<span class="op" id="3566427">+</span>&nbsp;<span class="ident" id="3566429">intFrameSP</span><span class="op" id="3566439">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566442">if</span>&nbsp;<span class="ident" id="3566445">e</span>&nbsp;<span class="op" id="3566447">!=</span>&nbsp;<span class="ident" id="3566450">nil</span>&nbsp;<span class="op" id="3566454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566458">return</span>&nbsp;<span class="ident" id="3566465">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3566468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566471">ret</span><span class="op" id="3566474">,</span>&nbsp;<span class="ident" id="3566476">e</span>&nbsp;<span class="op" id="3566478">:=</span>&nbsp;<span class="ident" id="3566481">c</span><span class="op" id="3566482">.</span><span class="ident" id="3566483">readWord</span><span class="op" id="3566491">(</span><span class="ident" id="3566492">base</span>&nbsp;<span class="op" id="3566497">+</span>&nbsp;<span class="ident" id="3566499">intFrameRET</span><span class="op" id="3566510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566513">if</span>&nbsp;<span class="ident" id="3566516">e</span>&nbsp;<span class="op" id="3566518">!=</span>&nbsp;<span class="ident" id="3566521">nil</span>&nbsp;<span class="op" id="3566525">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566529">return</span>&nbsp;<span class="ident" id="3566536">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3566539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566542">code</span><span class="op" id="3566546">,</span>&nbsp;<span class="ident" id="3566548">e</span>&nbsp;<span class="op" id="3566550">:=</span>&nbsp;<span class="ident" id="3566553">c</span><span class="op" id="3566554">.</span><span class="ident" id="3566555">readByte</span><span class="op" id="3566563">(</span><span class="ident" id="3566564">base</span>&nbsp;<span class="op" id="3566569">+</span>&nbsp;<span class="ident" id="3566571">intFrameCode</span><span class="op" id="3566583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566586">if</span>&nbsp;<span class="ident" id="3566589">e</span>&nbsp;<span class="op" id="3566591">!=</span>&nbsp;<span class="ident" id="3566594">nil</span>&nbsp;<span class="op" id="3566598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566602">return</span>&nbsp;<span class="ident" id="3566609">e</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3566612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566615">ring</span><span class="op" id="3566619">,</span>&nbsp;<span class="ident" id="3566621">e</span>&nbsp;<span class="op" id="3566623">:=</span>&nbsp;<span class="ident" id="3566626">c</span><span class="op" id="3566627">.</span><span class="ident" id="3566628">readByte</span><span class="op" id="3566636">(</span><span class="ident" id="3566637">base</span>&nbsp;<span class="op" id="3566642">+</span>&nbsp;<span class="ident" id="3566644">intFrameRing</span><span class="op" id="3566656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566659">if</span>&nbsp;<span class="ident" id="3566662">e</span>&nbsp;<span class="op" id="3566664">!=</span>&nbsp;<span class="ident" id="3566667">nil</span>&nbsp;<span class="op" id="3566671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566675">return</span>&nbsp;<span class="ident" id="3566682">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3566685">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566689">c</span><span class="op" id="3566690">.</span><span class="ident" id="3566691">regs</span><span class="op" id="3566695">[</span><span class="ident" id="3566696">PC</span><span class="op" id="3566698">]</span>&nbsp;<span class="op" id="3566700">=</span>&nbsp;<span class="ident" id="3566702">c</span><span class="op" id="3566703">.</span><span class="ident" id="3566704">regs</span><span class="op" id="3566708">[</span><span class="ident" id="3566709">RET</span><span class="op" id="3566712">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566715">c</span><span class="op" id="3566716">.</span><span class="ident" id="3566717">regs</span><span class="op" id="3566721">[</span><span class="ident" id="3566722">RET</span><span class="op" id="3566725">]</span>&nbsp;<span class="op" id="3566727">=</span>&nbsp;<span class="ident" id="3566729">ret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566734">c</span><span class="op" id="3566735">.</span><span class="ident" id="3566736">regs</span><span class="op" id="3566740">[</span><span class="ident" id="3566741">SP</span><span class="op" id="3566743">]</span>&nbsp;<span class="op" id="3566745">=</span>&nbsp;<span class="ident" id="3566747">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566751">c</span><span class="op" id="3566752">.</span><span class="ident" id="3566753">ring</span>&nbsp;<span class="op" id="3566758">=</span>&nbsp;<span class="ident" id="3566760">ring</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566766">c</span><span class="op" id="3566767">.</span><span class="ident" id="3566768">interrupt</span><span class="op" id="3566777">.</span><span class="ident" id="3566778">Clear</span><span class="op" id="3566783">(</span><span class="ident" id="3566784">code</span><span class="op" id="3566788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566791">c</span><span class="op" id="3566792">.</span><span class="ident" id="3566793">interrupt</span><span class="op" id="3566802">.</span><span class="ident" id="3566803">Enable</span><span class="op" id="3566809">(</span><span class="op" id="3566810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3566814">return</span>&nbsp;<span class="ident" id="3566821">nil</span><br>
<span class="lineno"></span><span class="op" id="3566825">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment" id="3566828">//&nbsp;Tick&nbsp;executes&nbsp;one&nbsp;instruction,&nbsp;and&nbsp;increases&nbsp;the&nbsp;program&nbsp;counter</span><br>
<span class="lineno"></span><span class="comment" id="3566896">//&nbsp;by&nbsp;4&nbsp;by&nbsp;default.&nbsp;If&nbsp;an&nbsp;exception&nbsp;is&nbsp;met,&nbsp;it&nbsp;will&nbsp;handle&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3566959">func</span>&nbsp;<span class="op" id="3566964">(</span><span class="ident" id="3566965">c</span>&nbsp;<span class="op" id="3566967">*</span><span class="ident" id="3566968">cpu</span><span class="op" id="3566971">)</span>&nbsp;<span class="ident" id="3566973">Tick</span><span class="op" id="3566977">(</span><span class="op" id="3566978">)</span>&nbsp;<span class="op" id="3566980">*</span><span class="ident" id="3566981">Excep</span>&nbsp;<span class="op" id="3566987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3566990">poll</span><span class="op" id="3566994">,</span>&nbsp;<span class="ident" id="3566996">code</span>&nbsp;<span class="op" id="3567001">:=</span>&nbsp;<span class="ident" id="3567004">c</span><span class="op" id="3567005">.</span><span class="ident" id="3567006">interrupt</span><span class="op" id="3567015">.</span><span class="ident" id="3567016">Poll</span><span class="op" id="3567020">(</span><span class="op" id="3567021">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567024">if</span>&nbsp;<span class="ident" id="3567027">poll</span>&nbsp;<span class="op" id="3567032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567036">return</span>&nbsp;<span class="ident" id="3567043">c</span><span class="op" id="3567044">.</span><span class="ident" id="3567045">Ienter</span><span class="op" id="3567051">(</span><span class="ident" id="3567052">code</span><span class="op" id="3567056">,</span>&nbsp;<span class="num" id="3567058">0</span><span class="op" id="3567059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3567066">//&nbsp;no&nbsp;interrupt&nbsp;to&nbsp;dispatch,&nbsp;let&#39;s&nbsp;proceed</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567110">e</span>&nbsp;<span class="op" id="3567112">:=</span>&nbsp;<span class="ident" id="3567115">c</span><span class="op" id="3567116">.</span><span class="ident" id="3567117">tick</span><span class="op" id="3567121">(</span><span class="op" id="3567122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567125">if</span>&nbsp;<span class="ident" id="3567128">e</span>&nbsp;<span class="op" id="3567130">!=</span>&nbsp;<span class="ident" id="3567133">nil</span>&nbsp;<span class="op" id="3567137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3567141">//&nbsp;proceed&nbsp;attempt&nbsp;failed,&nbsp;handle&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567187">c</span><span class="op" id="3567188">.</span><span class="ident" id="3567189">interrupt</span><span class="op" id="3567198">.</span><span class="ident" id="3567199">Issue</span><span class="op" id="3567204">(</span><span class="ident" id="3567205">e</span><span class="op" id="3567206">.</span><span class="ident" id="3567207">Code</span><span class="op" id="3567211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3567215">poll</span><span class="op" id="3567219">,</span>&nbsp;<span class="ident" id="3567221">code</span>&nbsp;<span class="op" id="3567226">:=</span>&nbsp;<span class="ident" id="3567229">c</span><span class="op" id="3567230">.</span><span class="ident" id="3567231">interrupt</span><span class="op" id="3567240">.</span><span class="ident" id="3567241">Poll</span><span class="op" id="3567245">(</span><span class="op" id="3567246">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567250">if</span>&nbsp;<span class="ident" id="3567253">poll</span>&nbsp;<span class="op" id="3567258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567263">if</span>&nbsp;<span class="ident" id="3567266">code</span>&nbsp;<span class="op" id="3567271">!=</span>&nbsp;<span class="ident" id="3567274">e</span><span class="op" id="3567275">.</span><span class="ident" id="3567276">Code</span>&nbsp;<span class="op" id="3567281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3567287">panic</span><span class="op" id="3567292">(</span><span class="string" id="3567293">&#34;interrupt&nbsp;code&nbsp;is&nbsp;different&#34;</span><span class="op" id="3567322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567332">return</span>&nbsp;<span class="ident" id="3567339">c</span><span class="op" id="3567340">.</span><span class="ident" id="3567341">Ienter</span><span class="op" id="3567347">(</span><span class="ident" id="3567348">code</span><span class="op" id="3567352">,</span>&nbsp;<span class="ident" id="3567354">e</span><span class="op" id="3567355">.</span><span class="ident" id="3567356">Arg</span><span class="op" id="3567359">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3567366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3567370">return</span>&nbsp;<span class="ident" id="3567377">e</span><br>
<span class="lineno"></span><span class="op" id="3567379">}</span>
</div>
</body>
</html>
