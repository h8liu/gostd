<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2510974">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2511029">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2511083">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2511134">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2511199">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2511226">package</span>&nbsp;<span class="ident" id="2511234">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2511243">import</span>&nbsp;<span class="op" id="2511250">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2511253">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2511264">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2511272">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2511281">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2511284">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2511350">//</span><br>
<span class="lineno"></span><span class="comment" id="2511353">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2511418">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2511479">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2511543">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2511599">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2511663">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2511725">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2511792">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2511856">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2511901">//</span><br>
<span class="lineno"></span><span class="comment" id="2511904">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2511972">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2512043">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2512112">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2512145">//</span><br>
<span class="lineno"></span><span class="comment" id="2512148">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2512212">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2512278">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2512344">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2512381">//</span><br>
<span class="lineno"></span><span class="comment" id="2512384">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2512445">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2512518">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2512586">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2512652">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2512721">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2512786">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2512828">//</span><br>
<span class="lineno"></span><span class="comment" id="2512831">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2512895">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2512962">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2513025">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2513078">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2513145">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2513173">//</span><br>
<span class="lineno"></span><span class="comment" id="2513176">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2513226">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2513276">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2513337">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2513383">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2513446">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2513492">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2513542">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2513599">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2513666">var</span>&nbsp;<span class="ident" id="2513670">ForkLock</span>&nbsp;<span class="ident" id="2513679">sync</span><span class="op" id="2513683">.</span><span class="ident" id="2513684">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2513693">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2513759">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2513825">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2513851">func</span>&nbsp;<span class="ident" id="2513856">StringSlicePtr</span><span class="op" id="2513870">(</span><span class="ident" id="2513871">ss</span>&nbsp;<span class="op" id="2513874">[</span><span class="op" id="2513875">]</span><span class="builtintype" id="2513876">string</span><span class="op" id="2513882">)</span>&nbsp;<span class="op" id="2513884">[</span><span class="op" id="2513885">]</span><span class="op" id="2513886">*</span><span class="builtintype" id="2513887">byte</span>&nbsp;<span class="op" id="2513892">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513895">bb</span>&nbsp;<span class="op" id="2513898">:=</span>&nbsp;<span class="builtinfunc" id="2513901">make</span><span class="op" id="2513905">(</span><span class="op" id="2513906">[</span><span class="op" id="2513907">]</span><span class="op" id="2513908">*</span><span class="builtintype" id="2513909">byte</span><span class="op" id="2513913">,</span>&nbsp;<span class="builtinfunc" id="2513915">len</span><span class="op" id="2513918">(</span><span class="ident" id="2513919">ss</span><span class="op" id="2513921">)</span><span class="op" id="2513922">+</span><span class="num" id="2513923">1</span><span class="op" id="2513924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2513927">for</span>&nbsp;<span class="ident" id="2513931">i</span>&nbsp;<span class="op" id="2513933">:=</span>&nbsp;<span class="num" id="2513936">0</span><span class="op" id="2513937">;</span>&nbsp;<span class="ident" id="2513939">i</span>&nbsp;<span class="op" id="2513941">&lt;</span>&nbsp;<span class="builtinfunc" id="2513943">len</span><span class="op" id="2513946">(</span><span class="ident" id="2513947">ss</span><span class="op" id="2513949">)</span><span class="op" id="2513950">;</span>&nbsp;<span class="ident" id="2513952">i</span><span class="op" id="2513953">++</span>&nbsp;<span class="op" id="2513956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513960">bb</span><span class="op" id="2513962">[</span><span class="ident" id="2513963">i</span><span class="op" id="2513964">]</span>&nbsp;<span class="op" id="2513966">=</span>&nbsp;<span class="ident" id="2513968">StringBytePtr</span><span class="op" id="2513981">(</span><span class="ident" id="2513982">ss</span><span class="op" id="2513984">[</span><span class="ident" id="2513985">i</span><span class="op" id="2513986">]</span><span class="op" id="2513987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2513990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2513993">bb</span><span class="op" id="2513995">[</span><span class="builtinfunc" id="2513996">len</span><span class="op" id="2513999">(</span><span class="ident" id="2514000">ss</span><span class="op" id="2514002">)</span><span class="op" id="2514003">]</span>&nbsp;<span class="op" id="2514005">=</span>&nbsp;<span class="ident" id="2514007">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514012">return</span>&nbsp;<span class="ident" id="2514019">bb</span><br>
<span class="lineno"></span><span class="op" id="2514022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2514025">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2514090">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2514156">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2514197">func</span>&nbsp;<span class="ident" id="2514202">SlicePtrFromStrings</span><span class="op" id="2514221">(</span><span class="ident" id="2514222">ss</span>&nbsp;<span class="op" id="2514225">[</span><span class="op" id="2514226">]</span><span class="builtintype" id="2514227">string</span><span class="op" id="2514233">)</span>&nbsp;<span class="op" id="2514235">(</span><span class="op" id="2514236">[</span><span class="op" id="2514237">]</span><span class="op" id="2514238">*</span><span class="builtintype" id="2514239">byte</span><span class="op" id="2514243">,</span>&nbsp;<span class="builtintype" id="2514245">error</span><span class="op" id="2514250">)</span>&nbsp;<span class="op" id="2514252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514255">var</span>&nbsp;<span class="ident" id="2514259">err</span>&nbsp;<span class="builtintype" id="2514263">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514270">bb</span>&nbsp;<span class="op" id="2514273">:=</span>&nbsp;<span class="builtinfunc" id="2514276">make</span><span class="op" id="2514280">(</span><span class="op" id="2514281">[</span><span class="op" id="2514282">]</span><span class="op" id="2514283">*</span><span class="builtintype" id="2514284">byte</span><span class="op" id="2514288">,</span>&nbsp;<span class="builtinfunc" id="2514290">len</span><span class="op" id="2514293">(</span><span class="ident" id="2514294">ss</span><span class="op" id="2514296">)</span><span class="op" id="2514297">+</span><span class="num" id="2514298">1</span><span class="op" id="2514299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514302">for</span>&nbsp;<span class="ident" id="2514306">i</span>&nbsp;<span class="op" id="2514308">:=</span>&nbsp;<span class="num" id="2514311">0</span><span class="op" id="2514312">;</span>&nbsp;<span class="ident" id="2514314">i</span>&nbsp;<span class="op" id="2514316">&lt;</span>&nbsp;<span class="builtinfunc" id="2514318">len</span><span class="op" id="2514321">(</span><span class="ident" id="2514322">ss</span><span class="op" id="2514324">)</span><span class="op" id="2514325">;</span>&nbsp;<span class="ident" id="2514327">i</span><span class="op" id="2514328">++</span>&nbsp;<span class="op" id="2514331">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514335">bb</span><span class="op" id="2514337">[</span><span class="ident" id="2514338">i</span><span class="op" id="2514339">]</span><span class="op" id="2514340">,</span>&nbsp;<span class="ident" id="2514342">err</span>&nbsp;<span class="op" id="2514346">=</span>&nbsp;<span class="ident" id="2514348">BytePtrFromString</span><span class="op" id="2514365">(</span><span class="ident" id="2514366">ss</span><span class="op" id="2514368">[</span><span class="ident" id="2514369">i</span><span class="op" id="2514370">]</span><span class="op" id="2514371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514375">if</span>&nbsp;<span class="ident" id="2514378">err</span>&nbsp;<span class="op" id="2514382">!=</span>&nbsp;<span class="ident" id="2514385">nil</span>&nbsp;<span class="op" id="2514389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514394">return</span>&nbsp;<span class="ident" id="2514401">nil</span><span class="op" id="2514404">,</span>&nbsp;<span class="ident" id="2514406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514415">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514418">bb</span><span class="op" id="2514420">[</span><span class="builtinfunc" id="2514421">len</span><span class="op" id="2514424">(</span><span class="ident" id="2514425">ss</span><span class="op" id="2514427">)</span><span class="op" id="2514428">]</span>&nbsp;<span class="op" id="2514430">=</span>&nbsp;<span class="ident" id="2514432">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514437">return</span>&nbsp;<span class="ident" id="2514444">bb</span><span class="op" id="2514446">,</span>&nbsp;<span class="ident" id="2514448">nil</span><br>
<span class="lineno"></span><span class="op" id="2514452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2514455">func</span>&nbsp;<span class="ident" id="2514460">CloseOnExec</span><span class="op" id="2514471">(</span><span class="ident" id="2514472">fd</span>&nbsp;<span class="builtintype" id="2514475">int</span><span class="op" id="2514478">)</span>&nbsp;<span class="op" id="2514480">{</span>&nbsp;<span class="ident" id="2514482">fcntl</span><span class="op" id="2514487">(</span><span class="ident" id="2514488">fd</span><span class="op" id="2514490">,</span>&nbsp;<span class="ident" id="2514492">F_SETFD</span><span class="op" id="2514499">,</span>&nbsp;<span class="ident" id="2514501">FD_CLOEXEC</span><span class="op" id="2514511">)</span>&nbsp;<span class="op" id="2514513">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2514516">func</span>&nbsp;<span class="ident" id="2514521">SetNonblock</span><span class="op" id="2514532">(</span><span class="ident" id="2514533">fd</span>&nbsp;<span class="builtintype" id="2514536">int</span><span class="op" id="2514539">,</span>&nbsp;<span class="ident" id="2514541">nonblocking</span>&nbsp;<span class="builtintype" id="2514553">bool</span><span class="op" id="2514557">)</span>&nbsp;<span class="op" id="2514559">(</span><span class="ident" id="2514560">err</span>&nbsp;<span class="builtintype" id="2514564">error</span><span class="op" id="2514569">)</span>&nbsp;<span class="op" id="2514571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514574">flag</span><span class="op" id="2514578">,</span>&nbsp;<span class="ident" id="2514580">err</span>&nbsp;<span class="op" id="2514584">:=</span>&nbsp;<span class="ident" id="2514587">fcntl</span><span class="op" id="2514592">(</span><span class="ident" id="2514593">fd</span><span class="op" id="2514595">,</span>&nbsp;<span class="ident" id="2514597">F_GETFL</span><span class="op" id="2514604">,</span>&nbsp;<span class="num" id="2514606">0</span><span class="op" id="2514607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514610">if</span>&nbsp;<span class="ident" id="2514613">err</span>&nbsp;<span class="op" id="2514617">!=</span>&nbsp;<span class="ident" id="2514620">nil</span>&nbsp;<span class="op" id="2514624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514628">return</span>&nbsp;<span class="ident" id="2514635">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514643">if</span>&nbsp;<span class="ident" id="2514646">nonblocking</span>&nbsp;<span class="op" id="2514658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514662">flag</span>&nbsp;<span class="op" id="2514667">|=</span>&nbsp;<span class="ident" id="2514670">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514682">}</span>&nbsp;<span class="keyword" id="2514684">else</span>&nbsp;<span class="op" id="2514689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514693">flag</span>&nbsp;<span class="op" id="2514698">&amp;=</span>&nbsp;<span class="op" id="2514701">^</span><span class="ident" id="2514702">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2514714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514717">_</span><span class="op" id="2514718">,</span>&nbsp;<span class="ident" id="2514720">err</span>&nbsp;<span class="op" id="2514724">=</span>&nbsp;<span class="ident" id="2514726">fcntl</span><span class="op" id="2514731">(</span><span class="ident" id="2514732">fd</span><span class="op" id="2514734">,</span>&nbsp;<span class="ident" id="2514736">F_SETFL</span><span class="op" id="2514743">,</span>&nbsp;<span class="ident" id="2514745">flag</span><span class="op" id="2514749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2514752">return</span>&nbsp;<span class="ident" id="2514759">err</span><br>
<span class="lineno"></span><span class="op" id="2514763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2514766">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2514826">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2514873">type</span>&nbsp;<span class="ident" id="2514878">Credential</span>&nbsp;<span class="keyword" id="2514889">struct</span>&nbsp;<span class="op" id="2514896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514899">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2514906">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2514915">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514928">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2514935">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2514944">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2514958">Groups</span>&nbsp;<span class="op" id="2514965">[</span><span class="op" id="2514966">]</span><span class="builtintype" id="2514967">uint32</span>&nbsp;<span class="comment" id="2514974">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2515002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2515005">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2515080">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2515100">type</span>&nbsp;<span class="ident" id="2515105">ProcAttr</span>&nbsp;<span class="keyword" id="2515114">struct</span>&nbsp;<span class="op" id="2515121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515124">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515130">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515140">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515171">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2515177">[</span><span class="op" id="2515178">]</span><span class="builtintype" id="2515179">string</span>&nbsp;&nbsp;<span class="comment" id="2515187">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515204">Files</span>&nbsp;<span class="op" id="2515210">[</span><span class="op" id="2515211">]</span><span class="builtintype" id="2515212">uintptr</span>&nbsp;<span class="comment" id="2515220">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515242">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2515248">*</span><span class="ident" id="2515249">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2515261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2515264">var</span>&nbsp;<span class="ident" id="2515268">zeroProcAttr</span>&nbsp;<span class="ident" id="2515281">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2515290">var</span>&nbsp;<span class="ident" id="2515294">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2515310">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2515323">func</span>&nbsp;<span class="ident" id="2515328">forkExec</span><span class="op" id="2515336">(</span><span class="ident" id="2515337">argv0</span>&nbsp;<span class="builtintype" id="2515343">string</span><span class="op" id="2515349">,</span>&nbsp;<span class="ident" id="2515351">argv</span>&nbsp;<span class="op" id="2515356">[</span><span class="op" id="2515357">]</span><span class="builtintype" id="2515358">string</span><span class="op" id="2515364">,</span>&nbsp;<span class="ident" id="2515366">attr</span>&nbsp;<span class="op" id="2515371">*</span><span class="ident" id="2515372">ProcAttr</span><span class="op" id="2515380">)</span>&nbsp;<span class="op" id="2515382">(</span><span class="ident" id="2515383">pid</span>&nbsp;<span class="builtintype" id="2515387">int</span><span class="op" id="2515390">,</span>&nbsp;<span class="ident" id="2515392">err</span>&nbsp;<span class="builtintype" id="2515396">error</span><span class="op" id="2515401">)</span>&nbsp;<span class="op" id="2515403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515406">var</span>&nbsp;<span class="ident" id="2515410">p</span>&nbsp;<span class="op" id="2515412">[</span><span class="num" id="2515413">2</span><span class="op" id="2515414">]</span><span class="builtintype" id="2515415">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515420">var</span>&nbsp;<span class="ident" id="2515424">n</span>&nbsp;<span class="builtintype" id="2515426">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515431">var</span>&nbsp;<span class="ident" id="2515435">err1</span>&nbsp;<span class="ident" id="2515440">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515447">var</span>&nbsp;<span class="ident" id="2515451">wstatus</span>&nbsp;<span class="ident" id="2515459">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515472">if</span>&nbsp;<span class="ident" id="2515475">attr</span>&nbsp;<span class="op" id="2515480">==</span>&nbsp;<span class="ident" id="2515483">nil</span>&nbsp;<span class="op" id="2515487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515491">attr</span>&nbsp;<span class="op" id="2515496">=</span>&nbsp;<span class="op" id="2515498">&amp;</span><span class="ident" id="2515499">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515516">sys</span>&nbsp;<span class="op" id="2515520">:=</span>&nbsp;<span class="ident" id="2515523">attr</span><span class="op" id="2515527">.</span><span class="ident" id="2515528">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515533">if</span>&nbsp;<span class="ident" id="2515536">sys</span>&nbsp;<span class="op" id="2515540">==</span>&nbsp;<span class="ident" id="2515543">nil</span>&nbsp;<span class="op" id="2515547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515551">sys</span>&nbsp;<span class="op" id="2515555">=</span>&nbsp;<span class="op" id="2515557">&amp;</span><span class="ident" id="2515558">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515579">p</span><span class="op" id="2515580">[</span><span class="num" id="2515581">0</span><span class="op" id="2515582">]</span>&nbsp;<span class="op" id="2515584">=</span>&nbsp;<span class="op" id="2515586">-</span><span class="num" id="2515587">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515590">p</span><span class="op" id="2515591">[</span><span class="num" id="2515592">1</span><span class="op" id="2515593">]</span>&nbsp;<span class="op" id="2515595">=</span>&nbsp;<span class="op" id="2515597">-</span><span class="num" id="2515598">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2515602">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515630">argv0p</span><span class="op" id="2515636">,</span>&nbsp;<span class="ident" id="2515638">err</span>&nbsp;<span class="op" id="2515642">:=</span>&nbsp;<span class="ident" id="2515645">BytePtrFromString</span><span class="op" id="2515662">(</span><span class="ident" id="2515663">argv0</span><span class="op" id="2515668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515671">if</span>&nbsp;<span class="ident" id="2515674">err</span>&nbsp;<span class="op" id="2515678">!=</span>&nbsp;<span class="ident" id="2515681">nil</span>&nbsp;<span class="op" id="2515685">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515689">return</span>&nbsp;<span class="num" id="2515696">0</span><span class="op" id="2515697">,</span>&nbsp;<span class="ident" id="2515699">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515707">argvp</span><span class="op" id="2515712">,</span>&nbsp;<span class="ident" id="2515714">err</span>&nbsp;<span class="op" id="2515718">:=</span>&nbsp;<span class="ident" id="2515721">SlicePtrFromStrings</span><span class="op" id="2515740">(</span><span class="ident" id="2515741">argv</span><span class="op" id="2515745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515748">if</span>&nbsp;<span class="ident" id="2515751">err</span>&nbsp;<span class="op" id="2515755">!=</span>&nbsp;<span class="ident" id="2515758">nil</span>&nbsp;<span class="op" id="2515762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515766">return</span>&nbsp;<span class="num" id="2515773">0</span><span class="op" id="2515774">,</span>&nbsp;<span class="ident" id="2515776">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515784">envvp</span><span class="op" id="2515789">,</span>&nbsp;<span class="ident" id="2515791">err</span>&nbsp;<span class="op" id="2515795">:=</span>&nbsp;<span class="ident" id="2515798">SlicePtrFromStrings</span><span class="op" id="2515817">(</span><span class="ident" id="2515818">attr</span><span class="op" id="2515822">.</span><span class="ident" id="2515823">Env</span><span class="op" id="2515826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515829">if</span>&nbsp;<span class="ident" id="2515832">err</span>&nbsp;<span class="op" id="2515836">!=</span>&nbsp;<span class="ident" id="2515839">nil</span>&nbsp;<span class="op" id="2515843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515847">return</span>&nbsp;<span class="num" id="2515854">0</span><span class="op" id="2515855">,</span>&nbsp;<span class="ident" id="2515857">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515862">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515866">if</span>&nbsp;<span class="op" id="2515869">(</span><span class="ident" id="2515870">runtime</span><span class="op" id="2515877">.</span><span class="ident" id="2515878">GOOS</span>&nbsp;<span class="op" id="2515883">==</span>&nbsp;<span class="string" id="2515886">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2515896">||</span>&nbsp;<span class="ident" id="2515899">runtime</span><span class="op" id="2515906">.</span><span class="ident" id="2515907">GOOS</span>&nbsp;<span class="op" id="2515912">==</span>&nbsp;<span class="string" id="2515915">&#34;dragonfly&#34;</span><span class="op" id="2515926">)</span>&nbsp;<span class="op" id="2515928">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2515931">len</span><span class="op" id="2515934">(</span><span class="ident" id="2515935">argv</span><span class="op" id="2515939">[</span><span class="num" id="2515940">0</span><span class="op" id="2515941">]</span><span class="op" id="2515942">)</span>&nbsp;<span class="op" id="2515944">&gt;</span>&nbsp;<span class="builtinfunc" id="2515946">len</span><span class="op" id="2515949">(</span><span class="ident" id="2515950">argv0</span><span class="op" id="2515955">)</span>&nbsp;<span class="op" id="2515957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2515961">argvp</span><span class="op" id="2515966">[</span><span class="num" id="2515967">0</span><span class="op" id="2515968">]</span>&nbsp;<span class="op" id="2515970">=</span>&nbsp;<span class="ident" id="2515972">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2515980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2515984">var</span>&nbsp;<span class="ident" id="2515988">chroot</span>&nbsp;<span class="op" id="2515995">*</span><span class="builtintype" id="2515996">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516002">if</span>&nbsp;<span class="ident" id="2516005">sys</span><span class="op" id="2516008">.</span><span class="ident" id="2516009">Chroot</span>&nbsp;<span class="op" id="2516016">!=</span>&nbsp;<span class="string" id="2516019">&#34;&#34;</span>&nbsp;<span class="op" id="2516022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516026">chroot</span><span class="op" id="2516032">,</span>&nbsp;<span class="ident" id="2516034">err</span>&nbsp;<span class="op" id="2516038">=</span>&nbsp;<span class="ident" id="2516040">BytePtrFromString</span><span class="op" id="2516057">(</span><span class="ident" id="2516058">sys</span><span class="op" id="2516061">.</span><span class="ident" id="2516062">Chroot</span><span class="op" id="2516068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516072">if</span>&nbsp;<span class="ident" id="2516075">err</span>&nbsp;<span class="op" id="2516079">!=</span>&nbsp;<span class="ident" id="2516082">nil</span>&nbsp;<span class="op" id="2516086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516091">return</span>&nbsp;<span class="num" id="2516098">0</span><span class="op" id="2516099">,</span>&nbsp;<span class="ident" id="2516101">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516113">var</span>&nbsp;<span class="ident" id="2516117">dir</span>&nbsp;<span class="op" id="2516121">*</span><span class="builtintype" id="2516122">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516128">if</span>&nbsp;<span class="ident" id="2516131">attr</span><span class="op" id="2516135">.</span><span class="ident" id="2516136">Dir</span>&nbsp;<span class="op" id="2516140">!=</span>&nbsp;<span class="string" id="2516143">&#34;&#34;</span>&nbsp;<span class="op" id="2516146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516150">dir</span><span class="op" id="2516153">,</span>&nbsp;<span class="ident" id="2516155">err</span>&nbsp;<span class="op" id="2516159">=</span>&nbsp;<span class="ident" id="2516161">BytePtrFromString</span><span class="op" id="2516178">(</span><span class="ident" id="2516179">attr</span><span class="op" id="2516183">.</span><span class="ident" id="2516184">Dir</span><span class="op" id="2516187">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516191">if</span>&nbsp;<span class="ident" id="2516194">err</span>&nbsp;<span class="op" id="2516198">!=</span>&nbsp;<span class="ident" id="2516201">nil</span>&nbsp;<span class="op" id="2516205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516210">return</span>&nbsp;<span class="num" id="2516217">0</span><span class="op" id="2516218">,</span>&nbsp;<span class="ident" id="2516220">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516233">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516284">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516334">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516354">ForkLock</span><span class="op" id="2516362">.</span><span class="ident" id="2516363">Lock</span><span class="op" id="2516367">(</span><span class="op" id="2516368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516372">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516418">if</span>&nbsp;<span class="ident" id="2516421">err</span>&nbsp;<span class="op" id="2516425">=</span>&nbsp;<span class="ident" id="2516427">forkExecPipe</span><span class="op" id="2516439">(</span><span class="ident" id="2516440">p</span><span class="op" id="2516441">[</span><span class="op" id="2516442">:</span><span class="op" id="2516443">]</span><span class="op" id="2516444">)</span><span class="op" id="2516445">;</span>&nbsp;<span class="ident" id="2516447">err</span>&nbsp;<span class="op" id="2516451">!=</span>&nbsp;<span class="ident" id="2516454">nil</span>&nbsp;<span class="op" id="2516458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516462">goto</span>&nbsp;<span class="builtintype" id="2516467">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516478">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516498">pid</span><span class="op" id="2516501">,</span>&nbsp;<span class="ident" id="2516503">err1</span>&nbsp;<span class="op" id="2516508">=</span>&nbsp;<span class="ident" id="2516510">forkAndExecInChild</span><span class="op" id="2516528">(</span><span class="ident" id="2516529">argv0p</span><span class="op" id="2516535">,</span>&nbsp;<span class="ident" id="2516537">argvp</span><span class="op" id="2516542">,</span>&nbsp;<span class="ident" id="2516544">envvp</span><span class="op" id="2516549">,</span>&nbsp;<span class="ident" id="2516551">chroot</span><span class="op" id="2516557">,</span>&nbsp;<span class="ident" id="2516559">dir</span><span class="op" id="2516562">,</span>&nbsp;<span class="ident" id="2516564">attr</span><span class="op" id="2516568">,</span>&nbsp;<span class="ident" id="2516570">sys</span><span class="op" id="2516573">,</span>&nbsp;<span class="ident" id="2516575">p</span><span class="op" id="2516576">[</span><span class="num" id="2516577">1</span><span class="op" id="2516578">]</span><span class="op" id="2516579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516582">if</span>&nbsp;<span class="ident" id="2516585">err1</span>&nbsp;<span class="op" id="2516590">!=</span>&nbsp;<span class="num" id="2516593">0</span>&nbsp;<span class="op" id="2516595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516599">err</span>&nbsp;<span class="op" id="2516603">=</span>&nbsp;<span class="ident" id="2516605">Errno</span><span class="op" id="2516610">(</span><span class="ident" id="2516611">err1</span><span class="op" id="2516615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516619">goto</span>&nbsp;<span class="builtintype" id="2516624">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516634">ForkLock</span><span class="op" id="2516642">.</span><span class="ident" id="2516643">Unlock</span><span class="op" id="2516649">(</span><span class="op" id="2516650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516654">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516693">Close</span><span class="op" id="2516698">(</span><span class="ident" id="2516699">p</span><span class="op" id="2516700">[</span><span class="num" id="2516701">1</span><span class="op" id="2516702">]</span><span class="op" id="2516703">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516706">n</span><span class="op" id="2516707">,</span>&nbsp;<span class="ident" id="2516709">err</span>&nbsp;<span class="op" id="2516713">=</span>&nbsp;<span class="ident" id="2516715">readlen</span><span class="op" id="2516722">(</span><span class="ident" id="2516723">p</span><span class="op" id="2516724">[</span><span class="num" id="2516725">0</span><span class="op" id="2516726">]</span><span class="op" id="2516727">,</span>&nbsp;<span class="op" id="2516729">(</span><span class="op" id="2516730">*</span><span class="builtintype" id="2516731">byte</span><span class="op" id="2516735">)</span><span class="op" id="2516736">(</span><span class="ident" id="2516737">unsafe</span><span class="op" id="2516743">.</span><span class="ident" id="2516744">Pointer</span><span class="op" id="2516751">(</span><span class="op" id="2516752">&amp;</span><span class="ident" id="2516753">err1</span><span class="op" id="2516757">)</span><span class="op" id="2516758">)</span><span class="op" id="2516759">,</span>&nbsp;<span class="builtintype" id="2516761">int</span><span class="op" id="2516764">(</span><span class="ident" id="2516765">unsafe</span><span class="op" id="2516771">.</span><span class="ident" id="2516772">Sizeof</span><span class="op" id="2516778">(</span><span class="ident" id="2516779">err1</span><span class="op" id="2516783">)</span><span class="op" id="2516784">)</span><span class="op" id="2516785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516788">Close</span><span class="op" id="2516793">(</span><span class="ident" id="2516794">p</span><span class="op" id="2516795">[</span><span class="num" id="2516796">0</span><span class="op" id="2516797">]</span><span class="op" id="2516798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516801">if</span>&nbsp;<span class="ident" id="2516804">err</span>&nbsp;<span class="op" id="2516808">!=</span>&nbsp;<span class="ident" id="2516811">nil</span>&nbsp;<span class="op" id="2516815">||</span>&nbsp;<span class="ident" id="2516818">n</span>&nbsp;<span class="op" id="2516820">!=</span>&nbsp;<span class="num" id="2516823">0</span>&nbsp;<span class="op" id="2516825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516829">if</span>&nbsp;<span class="ident" id="2516832">n</span>&nbsp;<span class="op" id="2516834">==</span>&nbsp;<span class="builtintype" id="2516837">int</span><span class="op" id="2516840">(</span><span class="ident" id="2516841">unsafe</span><span class="op" id="2516847">.</span><span class="ident" id="2516848">Sizeof</span><span class="op" id="2516854">(</span><span class="ident" id="2516855">err1</span><span class="op" id="2516859">)</span><span class="op" id="2516860">)</span>&nbsp;<span class="op" id="2516862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516867">err</span>&nbsp;<span class="op" id="2516871">=</span>&nbsp;<span class="ident" id="2516873">Errno</span><span class="op" id="2516878">(</span><span class="ident" id="2516879">err1</span><span class="op" id="2516883">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2516891">if</span>&nbsp;<span class="ident" id="2516894">err</span>&nbsp;<span class="op" id="2516898">==</span>&nbsp;<span class="ident" id="2516901">nil</span>&nbsp;<span class="op" id="2516905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2516910">err</span>&nbsp;<span class="op" id="2516914">=</span>&nbsp;<span class="ident" id="2516916">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2516924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516929">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2516982">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517017">_</span><span class="op" id="2517018">,</span>&nbsp;<span class="ident" id="2517020">err1</span>&nbsp;<span class="op" id="2517025">:=</span>&nbsp;<span class="ident" id="2517028">Wait4</span><span class="op" id="2517033">(</span><span class="ident" id="2517034">pid</span><span class="op" id="2517037">,</span>&nbsp;<span class="op" id="2517039">&amp;</span><span class="ident" id="2517040">wstatus</span><span class="op" id="2517047">,</span>&nbsp;<span class="num" id="2517049">0</span><span class="op" id="2517050">,</span>&nbsp;<span class="ident" id="2517052">nil</span><span class="op" id="2517055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517059">for</span>&nbsp;<span class="ident" id="2517063">err1</span>&nbsp;<span class="op" id="2517068">==</span>&nbsp;<span class="ident" id="2517071">EINTR</span>&nbsp;<span class="op" id="2517077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517082">_</span><span class="op" id="2517083">,</span>&nbsp;<span class="ident" id="2517085">err1</span>&nbsp;<span class="op" id="2517090">=</span>&nbsp;<span class="ident" id="2517092">Wait4</span><span class="op" id="2517097">(</span><span class="ident" id="2517098">pid</span><span class="op" id="2517101">,</span>&nbsp;<span class="op" id="2517103">&amp;</span><span class="ident" id="2517104">wstatus</span><span class="op" id="2517111">,</span>&nbsp;<span class="num" id="2517113">0</span><span class="op" id="2517114">,</span>&nbsp;<span class="ident" id="2517116">nil</span><span class="op" id="2517119">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517127">return</span>&nbsp;<span class="num" id="2517134">0</span><span class="op" id="2517135">,</span>&nbsp;<span class="ident" id="2517137">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2517146">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517207">return</span>&nbsp;<span class="ident" id="2517214">pid</span><span class="op" id="2517217">,</span>&nbsp;<span class="ident" id="2517219">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2517224">error</span><span class="op" id="2517229">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517232">if</span>&nbsp;<span class="ident" id="2517235">p</span><span class="op" id="2517236">[</span><span class="num" id="2517237">0</span><span class="op" id="2517238">]</span>&nbsp;<span class="op" id="2517240">&gt;=</span>&nbsp;<span class="num" id="2517243">0</span>&nbsp;<span class="op" id="2517245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517249">Close</span><span class="op" id="2517254">(</span><span class="ident" id="2517255">p</span><span class="op" id="2517256">[</span><span class="num" id="2517257">0</span><span class="op" id="2517258">]</span><span class="op" id="2517259">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517263">Close</span><span class="op" id="2517268">(</span><span class="ident" id="2517269">p</span><span class="op" id="2517270">[</span><span class="num" id="2517271">1</span><span class="op" id="2517272">]</span><span class="op" id="2517273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517279">ForkLock</span><span class="op" id="2517287">.</span><span class="ident" id="2517288">Unlock</span><span class="op" id="2517294">(</span><span class="op" id="2517295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517298">return</span>&nbsp;<span class="num" id="2517305">0</span><span class="op" id="2517306">,</span>&nbsp;<span class="ident" id="2517308">err</span><br>
<span class="lineno"></span><span class="op" id="2517312">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2517315">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2517375">func</span>&nbsp;<span class="ident" id="2517380">ForkExec</span><span class="op" id="2517388">(</span><span class="ident" id="2517389">argv0</span>&nbsp;<span class="builtintype" id="2517395">string</span><span class="op" id="2517401">,</span>&nbsp;<span class="ident" id="2517403">argv</span>&nbsp;<span class="op" id="2517408">[</span><span class="op" id="2517409">]</span><span class="builtintype" id="2517410">string</span><span class="op" id="2517416">,</span>&nbsp;<span class="ident" id="2517418">attr</span>&nbsp;<span class="op" id="2517423">*</span><span class="ident" id="2517424">ProcAttr</span><span class="op" id="2517432">)</span>&nbsp;<span class="op" id="2517434">(</span><span class="ident" id="2517435">pid</span>&nbsp;<span class="builtintype" id="2517439">int</span><span class="op" id="2517442">,</span>&nbsp;<span class="ident" id="2517444">err</span>&nbsp;<span class="builtintype" id="2517448">error</span><span class="op" id="2517453">)</span>&nbsp;<span class="op" id="2517455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517458">return</span>&nbsp;<span class="ident" id="2517465">forkExec</span><span class="op" id="2517473">(</span><span class="ident" id="2517474">argv0</span><span class="op" id="2517479">,</span>&nbsp;<span class="ident" id="2517481">argv</span><span class="op" id="2517485">,</span>&nbsp;<span class="ident" id="2517487">attr</span><span class="op" id="2517491">)</span><br>
<span class="lineno"></span><span class="op" id="2517493">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2517496">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2517543">func</span>&nbsp;<span class="ident" id="2517548">StartProcess</span><span class="op" id="2517560">(</span><span class="ident" id="2517561">argv0</span>&nbsp;<span class="builtintype" id="2517567">string</span><span class="op" id="2517573">,</span>&nbsp;<span class="ident" id="2517575">argv</span>&nbsp;<span class="op" id="2517580">[</span><span class="op" id="2517581">]</span><span class="builtintype" id="2517582">string</span><span class="op" id="2517588">,</span>&nbsp;<span class="ident" id="2517590">attr</span>&nbsp;<span class="op" id="2517595">*</span><span class="ident" id="2517596">ProcAttr</span><span class="op" id="2517604">)</span>&nbsp;<span class="op" id="2517606">(</span><span class="ident" id="2517607">pid</span>&nbsp;<span class="builtintype" id="2517611">int</span><span class="op" id="2517614">,</span>&nbsp;<span class="ident" id="2517616">handle</span>&nbsp;<span class="builtintype" id="2517623">uintptr</span><span class="op" id="2517630">,</span>&nbsp;<span class="ident" id="2517632">err</span>&nbsp;<span class="builtintype" id="2517636">error</span><span class="op" id="2517641">)</span>&nbsp;<span class="op" id="2517643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517646">pid</span><span class="op" id="2517649">,</span>&nbsp;<span class="ident" id="2517651">err</span>&nbsp;<span class="op" id="2517655">=</span>&nbsp;<span class="ident" id="2517657">forkExec</span><span class="op" id="2517665">(</span><span class="ident" id="2517666">argv0</span><span class="op" id="2517671">,</span>&nbsp;<span class="ident" id="2517673">argv</span><span class="op" id="2517677">,</span>&nbsp;<span class="ident" id="2517679">attr</span><span class="op" id="2517683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517686">return</span>&nbsp;<span class="ident" id="2517693">pid</span><span class="op" id="2517696">,</span>&nbsp;<span class="num" id="2517698">0</span><span class="op" id="2517699">,</span>&nbsp;<span class="ident" id="2517701">err</span><br>
<span class="lineno">240</span><span class="op" id="2517705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2517708">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2517726">func</span>&nbsp;<span class="ident" id="2517731">Exec</span><span class="op" id="2517735">(</span><span class="ident" id="2517736">argv0</span>&nbsp;<span class="builtintype" id="2517742">string</span><span class="op" id="2517748">,</span>&nbsp;<span class="ident" id="2517750">argv</span>&nbsp;<span class="op" id="2517755">[</span><span class="op" id="2517756">]</span><span class="builtintype" id="2517757">string</span><span class="op" id="2517763">,</span>&nbsp;<span class="ident" id="2517765">envv</span>&nbsp;<span class="op" id="2517770">[</span><span class="op" id="2517771">]</span><span class="builtintype" id="2517772">string</span><span class="op" id="2517778">)</span>&nbsp;<span class="op" id="2517780">(</span><span class="ident" id="2517781">err</span>&nbsp;<span class="builtintype" id="2517785">error</span><span class="op" id="2517790">)</span>&nbsp;<span class="op" id="2517792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517795">argv0p</span><span class="op" id="2517801">,</span>&nbsp;<span class="ident" id="2517803">err</span>&nbsp;<span class="op" id="2517807">:=</span>&nbsp;<span class="ident" id="2517810">BytePtrFromString</span><span class="op" id="2517827">(</span><span class="ident" id="2517828">argv0</span><span class="op" id="2517833">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517836">if</span>&nbsp;<span class="ident" id="2517839">err</span>&nbsp;<span class="op" id="2517843">!=</span>&nbsp;<span class="ident" id="2517846">nil</span>&nbsp;<span class="op" id="2517850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517854">return</span>&nbsp;<span class="ident" id="2517861">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517869">argvp</span><span class="op" id="2517874">,</span>&nbsp;<span class="ident" id="2517876">err</span>&nbsp;<span class="op" id="2517880">:=</span>&nbsp;<span class="ident" id="2517883">SlicePtrFromStrings</span><span class="op" id="2517902">(</span><span class="ident" id="2517903">argv</span><span class="op" id="2517907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517910">if</span>&nbsp;<span class="ident" id="2517913">err</span>&nbsp;<span class="op" id="2517917">!=</span>&nbsp;<span class="ident" id="2517920">nil</span>&nbsp;<span class="op" id="2517924">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517928">return</span>&nbsp;<span class="ident" id="2517935">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2517940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2517943">envvp</span><span class="op" id="2517948">,</span>&nbsp;<span class="ident" id="2517950">err</span>&nbsp;<span class="op" id="2517954">:=</span>&nbsp;<span class="ident" id="2517957">SlicePtrFromStrings</span><span class="op" id="2517976">(</span><span class="ident" id="2517977">envv</span><span class="op" id="2517981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2517984">if</span>&nbsp;<span class="ident" id="2517987">err</span>&nbsp;<span class="op" id="2517991">!=</span>&nbsp;<span class="ident" id="2517994">nil</span>&nbsp;<span class="op" id="2517998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518002">return</span>&nbsp;<span class="ident" id="2518009">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2518014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2518017">_</span><span class="op" id="2518018">,</span>&nbsp;<span class="ident" id="2518020">_</span><span class="op" id="2518021">,</span>&nbsp;<span class="ident" id="2518023">err1</span>&nbsp;<span class="op" id="2518028">:=</span>&nbsp;<span class="ident" id="2518031">RawSyscall</span><span class="op" id="2518041">(</span><span class="ident" id="2518042">SYS_EXECVE</span><span class="op" id="2518052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518056">uintptr</span><span class="op" id="2518063">(</span><span class="ident" id="2518064">unsafe</span><span class="op" id="2518070">.</span><span class="ident" id="2518071">Pointer</span><span class="op" id="2518078">(</span><span class="ident" id="2518079">argv0p</span><span class="op" id="2518085">)</span><span class="op" id="2518086">)</span><span class="op" id="2518087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518091">uintptr</span><span class="op" id="2518098">(</span><span class="ident" id="2518099">unsafe</span><span class="op" id="2518105">.</span><span class="ident" id="2518106">Pointer</span><span class="op" id="2518113">(</span><span class="op" id="2518114">&amp;</span><span class="ident" id="2518115">argvp</span><span class="op" id="2518120">[</span><span class="num" id="2518121">0</span><span class="op" id="2518122">]</span><span class="op" id="2518123">)</span><span class="op" id="2518124">)</span><span class="op" id="2518125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2518129">uintptr</span><span class="op" id="2518136">(</span><span class="ident" id="2518137">unsafe</span><span class="op" id="2518143">.</span><span class="ident" id="2518144">Pointer</span><span class="op" id="2518151">(</span><span class="op" id="2518152">&amp;</span><span class="ident" id="2518153">envvp</span><span class="op" id="2518158">[</span><span class="num" id="2518159">0</span><span class="op" id="2518160">]</span><span class="op" id="2518161">)</span><span class="op" id="2518162">)</span><span class="op" id="2518163">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2518166">return</span>&nbsp;<span class="ident" id="2518173">Errno</span><span class="op" id="2518178">(</span><span class="ident" id="2518179">err1</span><span class="op" id="2518183">)</span><br>
<span class="lineno"></span><span class="op" id="2518185">}</span>
</div>
</body>
</html>
