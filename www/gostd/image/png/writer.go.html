<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5233088">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5233143">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5233197">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5233248">package</span>&nbsp;<span class="ident" id="5233256">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233261">import</span>&nbsp;<span class="op" id="5233268">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233271">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233280">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233297">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233311">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233320">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233335">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5233341">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5233351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5233354">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5233397">type</span>&nbsp;<span class="ident" id="5233402">Encoder</span>&nbsp;<span class="keyword" id="5233410">struct</span>&nbsp;<span class="op" id="5233417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233420">CompressionLevel</span>&nbsp;<span class="ident" id="5233437">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5233454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233457">type</span>&nbsp;<span class="ident" id="5233462">encoder</span>&nbsp;<span class="keyword" id="5233470">struct</span>&nbsp;<span class="op" id="5233477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233480">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5233487">*</span><span class="ident" id="5233488">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233497">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233504">io</span><span class="op" id="5233506">.</span><span class="ident" id="5233507">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233515">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233522">image</span><span class="op" id="5233527">.</span><span class="ident" id="5233528">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233535">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5233542">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233547">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5233554">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233561">header</span>&nbsp;<span class="op" id="5233568">[</span><span class="num" id="5233569">8</span><span class="op" id="5233570">]</span><span class="builtintype" id="5233571">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233577">footer</span>&nbsp;<span class="op" id="5233584">[</span><span class="num" id="5233585">4</span><span class="op" id="5233586">]</span><span class="builtintype" id="5233587">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233593">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5233600">[</span><span class="num" id="5233601">4</span>&nbsp;<span class="op" id="5233603">*</span>&nbsp;<span class="num" id="5233605">256</span><span class="op" id="5233608">]</span><span class="builtintype" id="5233609">byte</span><br>
<span class="lineno"></span><span class="op" id="5233614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5233617">type</span>&nbsp;<span class="ident" id="5233622">CompressionLevel</span>&nbsp;<span class="builtintype" id="5233639">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5233644">const</span>&nbsp;<span class="op" id="5233650">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233653">DefaultCompression</span>&nbsp;<span class="ident" id="5233672">CompressionLevel</span>&nbsp;<span class="op" id="5233689">=</span>&nbsp;<span class="num" id="5233691">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233694">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233713">CompressionLevel</span>&nbsp;<span class="op" id="5233730">=</span>&nbsp;<span class="op" id="5233732">-</span><span class="num" id="5233733">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233736">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233755">CompressionLevel</span>&nbsp;<span class="op" id="5233772">=</span>&nbsp;<span class="op" id="5233774">-</span><span class="num" id="5233775">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233778">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5233797">CompressionLevel</span>&nbsp;<span class="op" id="5233814">=</span>&nbsp;<span class="op" id="5233816">-</span><span class="num" id="5233817">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5233821">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5233894">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5233954">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5233957">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5233972">func</span>&nbsp;<span class="ident" id="5233977">writeUint32</span><span class="op" id="5233988">(</span><span class="ident" id="5233989">b</span>&nbsp;<span class="op" id="5233991">[</span><span class="op" id="5233992">]</span><span class="builtintype" id="5233993">uint8</span><span class="op" id="5233998">,</span>&nbsp;<span class="ident" id="5234000">u</span>&nbsp;<span class="builtintype" id="5234002">uint32</span><span class="op" id="5234008">)</span>&nbsp;<span class="op" id="5234010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234013">b</span><span class="op" id="5234014">[</span><span class="num" id="5234015">0</span><span class="op" id="5234016">]</span>&nbsp;<span class="op" id="5234018">=</span>&nbsp;<span class="builtintype" id="5234020">uint8</span><span class="op" id="5234025">(</span><span class="ident" id="5234026">u</span>&nbsp;<span class="op" id="5234028">&gt;&gt;</span>&nbsp;<span class="num" id="5234031">24</span><span class="op" id="5234033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234036">b</span><span class="op" id="5234037">[</span><span class="num" id="5234038">1</span><span class="op" id="5234039">]</span>&nbsp;<span class="op" id="5234041">=</span>&nbsp;<span class="builtintype" id="5234043">uint8</span><span class="op" id="5234048">(</span><span class="ident" id="5234049">u</span>&nbsp;<span class="op" id="5234051">&gt;&gt;</span>&nbsp;<span class="num" id="5234054">16</span><span class="op" id="5234056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234059">b</span><span class="op" id="5234060">[</span><span class="num" id="5234061">2</span><span class="op" id="5234062">]</span>&nbsp;<span class="op" id="5234064">=</span>&nbsp;<span class="builtintype" id="5234066">uint8</span><span class="op" id="5234071">(</span><span class="ident" id="5234072">u</span>&nbsp;<span class="op" id="5234074">&gt;&gt;</span>&nbsp;<span class="num" id="5234077">8</span><span class="op" id="5234078">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234081">b</span><span class="op" id="5234082">[</span><span class="num" id="5234083">3</span><span class="op" id="5234084">]</span>&nbsp;<span class="op" id="5234086">=</span>&nbsp;<span class="builtintype" id="5234088">uint8</span><span class="op" id="5234093">(</span><span class="ident" id="5234094">u</span>&nbsp;<span class="op" id="5234096">&gt;&gt;</span>&nbsp;<span class="num" id="5234099">0</span><span class="op" id="5234100">)</span><br>
<span class="lineno"></span><span class="op" id="5234102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5234105">type</span>&nbsp;<span class="ident" id="5234110">opaquer</span>&nbsp;<span class="keyword" id="5234118">interface</span>&nbsp;<span class="op" id="5234128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234131">Opaque</span><span class="op" id="5234137">(</span><span class="op" id="5234138">)</span>&nbsp;<span class="builtintype" id="5234140">bool</span><br>
<span class="lineno">55</span><span class="op" id="5234145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5234148">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5234201">func</span>&nbsp;<span class="ident" id="5234206">opaque</span><span class="op" id="5234212">(</span><span class="ident" id="5234213">m</span>&nbsp;<span class="ident" id="5234215">image</span><span class="op" id="5234220">.</span><span class="ident" id="5234221">Image</span><span class="op" id="5234226">)</span>&nbsp;<span class="builtintype" id="5234228">bool</span>&nbsp;<span class="op" id="5234233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234236">if</span>&nbsp;<span class="ident" id="5234239">o</span><span class="op" id="5234240">,</span>&nbsp;<span class="ident" id="5234242">ok</span>&nbsp;<span class="op" id="5234245">:=</span>&nbsp;<span class="ident" id="5234248">m</span><span class="op" id="5234249">.</span><span class="op" id="5234250">(</span><span class="ident" id="5234251">opaquer</span><span class="op" id="5234258">)</span><span class="op" id="5234259">;</span>&nbsp;<span class="ident" id="5234261">ok</span>&nbsp;<span class="op" id="5234264">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234268">return</span>&nbsp;<span class="ident" id="5234275">o</span><span class="op" id="5234276">.</span><span class="ident" id="5234277">Opaque</span><span class="op" id="5234283">(</span><span class="op" id="5234284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234290">b</span>&nbsp;<span class="op" id="5234292">:=</span>&nbsp;<span class="ident" id="5234295">m</span><span class="op" id="5234296">.</span><span class="ident" id="5234297">Bounds</span><span class="op" id="5234303">(</span><span class="op" id="5234304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234307">for</span>&nbsp;<span class="ident" id="5234311">y</span>&nbsp;<span class="op" id="5234313">:=</span>&nbsp;<span class="ident" id="5234316">b</span><span class="op" id="5234317">.</span><span class="ident" id="5234318">Min</span><span class="op" id="5234321">.</span><span class="ident" id="5234322">Y</span><span class="op" id="5234323">;</span>&nbsp;<span class="ident" id="5234325">y</span>&nbsp;<span class="op" id="5234327">&lt;</span>&nbsp;<span class="ident" id="5234329">b</span><span class="op" id="5234330">.</span><span class="ident" id="5234331">Max</span><span class="op" id="5234334">.</span><span class="ident" id="5234335">Y</span><span class="op" id="5234336">;</span>&nbsp;<span class="ident" id="5234338">y</span><span class="op" id="5234339">++</span>&nbsp;<span class="op" id="5234342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234346">for</span>&nbsp;<span class="ident" id="5234350">x</span>&nbsp;<span class="op" id="5234352">:=</span>&nbsp;<span class="ident" id="5234355">b</span><span class="op" id="5234356">.</span><span class="ident" id="5234357">Min</span><span class="op" id="5234360">.</span><span class="ident" id="5234361">X</span><span class="op" id="5234362">;</span>&nbsp;<span class="ident" id="5234364">x</span>&nbsp;<span class="op" id="5234366">&lt;</span>&nbsp;<span class="ident" id="5234368">b</span><span class="op" id="5234369">.</span><span class="ident" id="5234370">Max</span><span class="op" id="5234373">.</span><span class="ident" id="5234374">X</span><span class="op" id="5234375">;</span>&nbsp;<span class="ident" id="5234377">x</span><span class="op" id="5234378">++</span>&nbsp;<span class="op" id="5234381">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234386">_</span><span class="op" id="5234387">,</span>&nbsp;<span class="ident" id="5234389">_</span><span class="op" id="5234390">,</span>&nbsp;<span class="ident" id="5234392">_</span><span class="op" id="5234393">,</span>&nbsp;<span class="ident" id="5234395">a</span>&nbsp;<span class="op" id="5234397">:=</span>&nbsp;<span class="ident" id="5234400">m</span><span class="op" id="5234401">.</span><span class="ident" id="5234402">At</span><span class="op" id="5234404">(</span><span class="ident" id="5234405">x</span><span class="op" id="5234406">,</span>&nbsp;<span class="ident" id="5234408">y</span><span class="op" id="5234409">)</span><span class="op" id="5234410">.</span><span class="ident" id="5234411">RGBA</span><span class="op" id="5234415">(</span><span class="op" id="5234416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234421">if</span>&nbsp;<span class="ident" id="5234424">a</span>&nbsp;<span class="op" id="5234426">!=</span>&nbsp;<span class="num" id="5234429">0xffff</span>&nbsp;<span class="op" id="5234436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234442">return</span>&nbsp;<span class="builtintype" id="5234449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234462">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234468">return</span>&nbsp;<span class="builtintype" id="5234475">true</span><br>
<span class="lineno"></span><span class="op" id="5234480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5234483">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5234545">func</span>&nbsp;<span class="ident" id="5234550">abs8</span><span class="op" id="5234554">(</span><span class="ident" id="5234555">d</span>&nbsp;<span class="builtintype" id="5234557">uint8</span><span class="op" id="5234562">)</span>&nbsp;<span class="builtintype" id="5234564">int</span>&nbsp;<span class="op" id="5234568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234571">if</span>&nbsp;<span class="ident" id="5234574">d</span>&nbsp;<span class="op" id="5234576">&lt;</span>&nbsp;<span class="num" id="5234578">128</span>&nbsp;<span class="op" id="5234582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234586">return</span>&nbsp;<span class="builtintype" id="5234593">int</span><span class="op" id="5234596">(</span><span class="ident" id="5234597">d</span><span class="op" id="5234598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234604">return</span>&nbsp;<span class="num" id="5234611">256</span>&nbsp;<span class="op" id="5234615">-</span>&nbsp;<span class="builtintype" id="5234617">int</span><span class="op" id="5234620">(</span><span class="ident" id="5234621">d</span><span class="op" id="5234622">)</span><br>
<span class="lineno">80</span><span class="op" id="5234624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5234627">func</span>&nbsp;<span class="op" id="5234632">(</span><span class="ident" id="5234633">e</span>&nbsp;<span class="op" id="5234635">*</span><span class="ident" id="5234636">encoder</span><span class="op" id="5234643">)</span>&nbsp;<span class="ident" id="5234645">writeChunk</span><span class="op" id="5234655">(</span><span class="ident" id="5234656">b</span>&nbsp;<span class="op" id="5234658">[</span><span class="op" id="5234659">]</span><span class="builtintype" id="5234660">byte</span><span class="op" id="5234664">,</span>&nbsp;<span class="ident" id="5234666">name</span>&nbsp;<span class="builtintype" id="5234671">string</span><span class="op" id="5234677">)</span>&nbsp;<span class="op" id="5234679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234682">if</span>&nbsp;<span class="ident" id="5234685">e</span><span class="op" id="5234686">.</span><span class="ident" id="5234687">err</span>&nbsp;<span class="op" id="5234691">!=</span>&nbsp;<span class="builtintype" id="5234694">nil</span>&nbsp;<span class="op" id="5234698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234702">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234713">n</span>&nbsp;<span class="op" id="5234715">:=</span>&nbsp;<span class="builtintype" id="5234718">uint32</span><span class="op" id="5234724">(</span><span class="builtinfunc" id="5234725">len</span><span class="op" id="5234728">(</span><span class="ident" id="5234729">b</span><span class="op" id="5234730">)</span><span class="op" id="5234731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234734">if</span>&nbsp;<span class="builtintype" id="5234737">int</span><span class="op" id="5234740">(</span><span class="ident" id="5234741">n</span><span class="op" id="5234742">)</span>&nbsp;<span class="op" id="5234744">!=</span>&nbsp;<span class="builtinfunc" id="5234747">len</span><span class="op" id="5234750">(</span><span class="ident" id="5234751">b</span><span class="op" id="5234752">)</span>&nbsp;<span class="op" id="5234754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234758">e</span><span class="op" id="5234759">.</span><span class="ident" id="5234760">err</span>&nbsp;<span class="op" id="5234764">=</span>&nbsp;<span class="ident" id="5234766">UnsupportedError</span><span class="op" id="5234782">(</span><span class="ident" id="5234783">name</span>&nbsp;<span class="op" id="5234788">+</span>&nbsp;<span class="string" id="5234790">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5234814">+</span>&nbsp;<span class="ident" id="5234816">strconv</span><span class="op" id="5234823">.</span><span class="ident" id="5234824">Itoa</span><span class="op" id="5234828">(</span><span class="builtinfunc" id="5234829">len</span><span class="op" id="5234832">(</span><span class="ident" id="5234833">b</span><span class="op" id="5234834">)</span><span class="op" id="5234835">)</span><span class="op" id="5234836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5234840">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5234848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234851">writeUint32</span><span class="op" id="5234862">(</span><span class="ident" id="5234863">e</span><span class="op" id="5234864">.</span><span class="ident" id="5234865">header</span><span class="op" id="5234871">[</span><span class="op" id="5234872">:</span><span class="num" id="5234873">4</span><span class="op" id="5234874">]</span><span class="op" id="5234875">,</span>&nbsp;<span class="ident" id="5234877">n</span><span class="op" id="5234878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234881">e</span><span class="op" id="5234882">.</span><span class="ident" id="5234883">header</span><span class="op" id="5234889">[</span><span class="num" id="5234890">4</span><span class="op" id="5234891">]</span>&nbsp;<span class="op" id="5234893">=</span>&nbsp;<span class="ident" id="5234895">name</span><span class="op" id="5234899">[</span><span class="num" id="5234900">0</span><span class="op" id="5234901">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234904">e</span><span class="op" id="5234905">.</span><span class="ident" id="5234906">header</span><span class="op" id="5234912">[</span><span class="num" id="5234913">5</span><span class="op" id="5234914">]</span>&nbsp;<span class="op" id="5234916">=</span>&nbsp;<span class="ident" id="5234918">name</span><span class="op" id="5234922">[</span><span class="num" id="5234923">1</span><span class="op" id="5234924">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234927">e</span><span class="op" id="5234928">.</span><span class="ident" id="5234929">header</span><span class="op" id="5234935">[</span><span class="num" id="5234936">6</span><span class="op" id="5234937">]</span>&nbsp;<span class="op" id="5234939">=</span>&nbsp;<span class="ident" id="5234941">name</span><span class="op" id="5234945">[</span><span class="num" id="5234946">2</span><span class="op" id="5234947">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234950">e</span><span class="op" id="5234951">.</span><span class="ident" id="5234952">header</span><span class="op" id="5234958">[</span><span class="num" id="5234959">7</span><span class="op" id="5234960">]</span>&nbsp;<span class="op" id="5234962">=</span>&nbsp;<span class="ident" id="5234964">name</span><span class="op" id="5234968">[</span><span class="num" id="5234969">3</span><span class="op" id="5234970">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234973">crc</span>&nbsp;<span class="op" id="5234977">:=</span>&nbsp;<span class="ident" id="5234980">crc32</span><span class="op" id="5234985">.</span><span class="ident" id="5234986">NewIEEE</span><span class="op" id="5234993">(</span><span class="op" id="5234994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5234997">crc</span><span class="op" id="5235000">.</span><span class="ident" id="5235001">Write</span><span class="op" id="5235006">(</span><span class="ident" id="5235007">e</span><span class="op" id="5235008">.</span><span class="ident" id="5235009">header</span><span class="op" id="5235015">[</span><span class="num" id="5235016">4</span><span class="op" id="5235017">:</span><span class="num" id="5235018">8</span><span class="op" id="5235019">]</span><span class="op" id="5235020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235023">crc</span><span class="op" id="5235026">.</span><span class="ident" id="5235027">Write</span><span class="op" id="5235032">(</span><span class="ident" id="5235033">b</span><span class="op" id="5235034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235037">writeUint32</span><span class="op" id="5235048">(</span><span class="ident" id="5235049">e</span><span class="op" id="5235050">.</span><span class="ident" id="5235051">footer</span><span class="op" id="5235057">[</span><span class="op" id="5235058">:</span><span class="num" id="5235059">4</span><span class="op" id="5235060">]</span><span class="op" id="5235061">,</span>&nbsp;<span class="ident" id="5235063">crc</span><span class="op" id="5235066">.</span><span class="ident" id="5235067">Sum32</span><span class="op" id="5235072">(</span><span class="op" id="5235073">)</span><span class="op" id="5235074">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235078">_</span><span class="op" id="5235079">,</span>&nbsp;<span class="ident" id="5235081">e</span><span class="op" id="5235082">.</span><span class="ident" id="5235083">err</span>&nbsp;<span class="op" id="5235087">=</span>&nbsp;<span class="ident" id="5235089">e</span><span class="op" id="5235090">.</span><span class="ident" id="5235091">w</span><span class="op" id="5235092">.</span><span class="ident" id="5235093">Write</span><span class="op" id="5235098">(</span><span class="ident" id="5235099">e</span><span class="op" id="5235100">.</span><span class="ident" id="5235101">header</span><span class="op" id="5235107">[</span><span class="op" id="5235108">:</span><span class="num" id="5235109">8</span><span class="op" id="5235110">]</span><span class="op" id="5235111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235114">if</span>&nbsp;<span class="ident" id="5235117">e</span><span class="op" id="5235118">.</span><span class="ident" id="5235119">err</span>&nbsp;<span class="op" id="5235123">!=</span>&nbsp;<span class="builtintype" id="5235126">nil</span>&nbsp;<span class="op" id="5235130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235134">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235142">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235145">_</span><span class="op" id="5235146">,</span>&nbsp;<span class="ident" id="5235148">e</span><span class="op" id="5235149">.</span><span class="ident" id="5235150">err</span>&nbsp;<span class="op" id="5235154">=</span>&nbsp;<span class="ident" id="5235156">e</span><span class="op" id="5235157">.</span><span class="ident" id="5235158">w</span><span class="op" id="5235159">.</span><span class="ident" id="5235160">Write</span><span class="op" id="5235165">(</span><span class="ident" id="5235166">b</span><span class="op" id="5235167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235170">if</span>&nbsp;<span class="ident" id="5235173">e</span><span class="op" id="5235174">.</span><span class="ident" id="5235175">err</span>&nbsp;<span class="op" id="5235179">!=</span>&nbsp;<span class="builtintype" id="5235182">nil</span>&nbsp;<span class="op" id="5235186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235190">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235201">_</span><span class="op" id="5235202">,</span>&nbsp;<span class="ident" id="5235204">e</span><span class="op" id="5235205">.</span><span class="ident" id="5235206">err</span>&nbsp;<span class="op" id="5235210">=</span>&nbsp;<span class="ident" id="5235212">e</span><span class="op" id="5235213">.</span><span class="ident" id="5235214">w</span><span class="op" id="5235215">.</span><span class="ident" id="5235216">Write</span><span class="op" id="5235221">(</span><span class="ident" id="5235222">e</span><span class="op" id="5235223">.</span><span class="ident" id="5235224">footer</span><span class="op" id="5235230">[</span><span class="op" id="5235231">:</span><span class="num" id="5235232">4</span><span class="op" id="5235233">]</span><span class="op" id="5235234">)</span><br>
<span class="lineno">110</span><span class="op" id="5235236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5235239">func</span>&nbsp;<span class="op" id="5235244">(</span><span class="ident" id="5235245">e</span>&nbsp;<span class="op" id="5235247">*</span><span class="ident" id="5235248">encoder</span><span class="op" id="5235255">)</span>&nbsp;<span class="ident" id="5235257">writeIHDR</span><span class="op" id="5235266">(</span><span class="op" id="5235267">)</span>&nbsp;<span class="op" id="5235269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235272">b</span>&nbsp;<span class="op" id="5235274">:=</span>&nbsp;<span class="ident" id="5235277">e</span><span class="op" id="5235278">.</span><span class="ident" id="5235279">m</span><span class="op" id="5235280">.</span><span class="ident" id="5235281">Bounds</span><span class="op" id="5235287">(</span><span class="op" id="5235288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235291">writeUint32</span><span class="op" id="5235302">(</span><span class="ident" id="5235303">e</span><span class="op" id="5235304">.</span><span class="ident" id="5235305">tmp</span><span class="op" id="5235308">[</span><span class="num" id="5235309">0</span><span class="op" id="5235310">:</span><span class="num" id="5235311">4</span><span class="op" id="5235312">]</span><span class="op" id="5235313">,</span>&nbsp;<span class="builtintype" id="5235315">uint32</span><span class="op" id="5235321">(</span><span class="ident" id="5235322">b</span><span class="op" id="5235323">.</span><span class="ident" id="5235324">Dx</span><span class="op" id="5235326">(</span><span class="op" id="5235327">)</span><span class="op" id="5235328">)</span><span class="op" id="5235329">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235332">writeUint32</span><span class="op" id="5235343">(</span><span class="ident" id="5235344">e</span><span class="op" id="5235345">.</span><span class="ident" id="5235346">tmp</span><span class="op" id="5235349">[</span><span class="num" id="5235350">4</span><span class="op" id="5235351">:</span><span class="num" id="5235352">8</span><span class="op" id="5235353">]</span><span class="op" id="5235354">,</span>&nbsp;<span class="builtintype" id="5235356">uint32</span><span class="op" id="5235362">(</span><span class="ident" id="5235363">b</span><span class="op" id="5235364">.</span><span class="ident" id="5235365">Dy</span><span class="op" id="5235367">(</span><span class="op" id="5235368">)</span><span class="op" id="5235369">)</span><span class="op" id="5235370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5235373">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235407">switch</span>&nbsp;<span class="ident" id="5235414">e</span><span class="op" id="5235415">.</span><span class="ident" id="5235416">cb</span>&nbsp;<span class="op" id="5235419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235422">case</span>&nbsp;<span class="ident" id="5235427">cbG8</span><span class="op" id="5235431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235435">e</span><span class="op" id="5235436">.</span><span class="ident" id="5235437">tmp</span><span class="op" id="5235440">[</span><span class="num" id="5235441">8</span><span class="op" id="5235442">]</span>&nbsp;<span class="op" id="5235444">=</span>&nbsp;<span class="num" id="5235446">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235450">e</span><span class="op" id="5235451">.</span><span class="ident" id="5235452">tmp</span><span class="op" id="5235455">[</span><span class="num" id="5235456">9</span><span class="op" id="5235457">]</span>&nbsp;<span class="op" id="5235459">=</span>&nbsp;<span class="ident" id="5235461">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235474">case</span>&nbsp;<span class="ident" id="5235479">cbTC8</span><span class="op" id="5235484">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235488">e</span><span class="op" id="5235489">.</span><span class="ident" id="5235490">tmp</span><span class="op" id="5235493">[</span><span class="num" id="5235494">8</span><span class="op" id="5235495">]</span>&nbsp;<span class="op" id="5235497">=</span>&nbsp;<span class="num" id="5235499">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235503">e</span><span class="op" id="5235504">.</span><span class="ident" id="5235505">tmp</span><span class="op" id="5235508">[</span><span class="num" id="5235509">9</span><span class="op" id="5235510">]</span>&nbsp;<span class="op" id="5235512">=</span>&nbsp;<span class="ident" id="5235514">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235527">case</span>&nbsp;<span class="ident" id="5235532">cbP8</span><span class="op" id="5235536">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235540">e</span><span class="op" id="5235541">.</span><span class="ident" id="5235542">tmp</span><span class="op" id="5235545">[</span><span class="num" id="5235546">8</span><span class="op" id="5235547">]</span>&nbsp;<span class="op" id="5235549">=</span>&nbsp;<span class="num" id="5235551">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235555">e</span><span class="op" id="5235556">.</span><span class="ident" id="5235557">tmp</span><span class="op" id="5235560">[</span><span class="num" id="5235561">9</span><span class="op" id="5235562">]</span>&nbsp;<span class="op" id="5235564">=</span>&nbsp;<span class="ident" id="5235566">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235578">case</span>&nbsp;<span class="ident" id="5235583">cbTCA8</span><span class="op" id="5235589">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235593">e</span><span class="op" id="5235594">.</span><span class="ident" id="5235595">tmp</span><span class="op" id="5235598">[</span><span class="num" id="5235599">8</span><span class="op" id="5235600">]</span>&nbsp;<span class="op" id="5235602">=</span>&nbsp;<span class="num" id="5235604">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235608">e</span><span class="op" id="5235609">.</span><span class="ident" id="5235610">tmp</span><span class="op" id="5235613">[</span><span class="num" id="5235614">9</span><span class="op" id="5235615">]</span>&nbsp;<span class="op" id="5235617">=</span>&nbsp;<span class="ident" id="5235619">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235637">case</span>&nbsp;<span class="ident" id="5235642">cbG16</span><span class="op" id="5235647">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235651">e</span><span class="op" id="5235652">.</span><span class="ident" id="5235653">tmp</span><span class="op" id="5235656">[</span><span class="num" id="5235657">8</span><span class="op" id="5235658">]</span>&nbsp;<span class="op" id="5235660">=</span>&nbsp;<span class="num" id="5235662">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235667">e</span><span class="op" id="5235668">.</span><span class="ident" id="5235669">tmp</span><span class="op" id="5235672">[</span><span class="num" id="5235673">9</span><span class="op" id="5235674">]</span>&nbsp;<span class="op" id="5235676">=</span>&nbsp;<span class="ident" id="5235678">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235691">case</span>&nbsp;<span class="ident" id="5235696">cbTC16</span><span class="op" id="5235702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235706">e</span><span class="op" id="5235707">.</span><span class="ident" id="5235708">tmp</span><span class="op" id="5235711">[</span><span class="num" id="5235712">8</span><span class="op" id="5235713">]</span>&nbsp;<span class="op" id="5235715">=</span>&nbsp;<span class="num" id="5235717">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235722">e</span><span class="op" id="5235723">.</span><span class="ident" id="5235724">tmp</span><span class="op" id="5235727">[</span><span class="num" id="5235728">9</span><span class="op" id="5235729">]</span>&nbsp;<span class="op" id="5235731">=</span>&nbsp;<span class="ident" id="5235733">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5235746">case</span>&nbsp;<span class="ident" id="5235751">cbTCA16</span><span class="op" id="5235758">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235762">e</span><span class="op" id="5235763">.</span><span class="ident" id="5235764">tmp</span><span class="op" id="5235767">[</span><span class="num" id="5235768">8</span><span class="op" id="5235769">]</span>&nbsp;<span class="op" id="5235771">=</span>&nbsp;<span class="num" id="5235773">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235778">e</span><span class="op" id="5235779">.</span><span class="ident" id="5235780">tmp</span><span class="op" id="5235783">[</span><span class="num" id="5235784">9</span><span class="op" id="5235785">]</span>&nbsp;<span class="op" id="5235787">=</span>&nbsp;<span class="ident" id="5235789">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5235807">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235810">e</span><span class="op" id="5235811">.</span><span class="ident" id="5235812">tmp</span><span class="op" id="5235815">[</span><span class="num" id="5235816">10</span><span class="op" id="5235818">]</span>&nbsp;<span class="op" id="5235820">=</span>&nbsp;<span class="num" id="5235822">0</span>&nbsp;<span class="comment" id="5235824">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235855">e</span><span class="op" id="5235856">.</span><span class="ident" id="5235857">tmp</span><span class="op" id="5235860">[</span><span class="num" id="5235861">11</span><span class="op" id="5235863">]</span>&nbsp;<span class="op" id="5235865">=</span>&nbsp;<span class="num" id="5235867">0</span>&nbsp;<span class="comment" id="5235869">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235895">e</span><span class="op" id="5235896">.</span><span class="ident" id="5235897">tmp</span><span class="op" id="5235900">[</span><span class="num" id="5235901">12</span><span class="op" id="5235903">]</span>&nbsp;<span class="op" id="5235905">=</span>&nbsp;<span class="num" id="5235907">0</span>&nbsp;<span class="comment" id="5235909">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5235928">e</span><span class="op" id="5235929">.</span><span class="ident" id="5235930">writeChunk</span><span class="op" id="5235940">(</span><span class="ident" id="5235941">e</span><span class="op" id="5235942">.</span><span class="ident" id="5235943">tmp</span><span class="op" id="5235946">[</span><span class="op" id="5235947">:</span><span class="num" id="5235948">13</span><span class="op" id="5235950">]</span><span class="op" id="5235951">,</span>&nbsp;<span class="string" id="5235953">&#34;IHDR&#34;</span><span class="op" id="5235959">)</span><br>
<span class="lineno"></span><span class="op" id="5235961">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5235964">func</span>&nbsp;<span class="op" id="5235969">(</span><span class="ident" id="5235970">e</span>&nbsp;<span class="op" id="5235972">*</span><span class="ident" id="5235973">encoder</span><span class="op" id="5235980">)</span>&nbsp;<span class="ident" id="5235982">writePLTEAndTRNS</span><span class="op" id="5235998">(</span><span class="ident" id="5235999">p</span>&nbsp;<span class="ident" id="5236001">color</span><span class="op" id="5236006">.</span><span class="ident" id="5236007">Palette</span><span class="op" id="5236014">)</span>&nbsp;<span class="op" id="5236016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236019">if</span>&nbsp;<span class="builtinfunc" id="5236022">len</span><span class="op" id="5236025">(</span><span class="ident" id="5236026">p</span><span class="op" id="5236027">)</span>&nbsp;<span class="op" id="5236029">&lt;</span>&nbsp;<span class="num" id="5236031">1</span>&nbsp;<span class="op" id="5236033">||</span>&nbsp;<span class="builtinfunc" id="5236036">len</span><span class="op" id="5236039">(</span><span class="ident" id="5236040">p</span><span class="op" id="5236041">)</span>&nbsp;<span class="op" id="5236043">&gt;</span>&nbsp;<span class="num" id="5236045">256</span>&nbsp;<span class="op" id="5236049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236053">e</span><span class="op" id="5236054">.</span><span class="ident" id="5236055">err</span>&nbsp;<span class="op" id="5236059">=</span>&nbsp;<span class="ident" id="5236061">FormatError</span><span class="op" id="5236072">(</span><span class="string" id="5236073">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5236096">+</span>&nbsp;<span class="ident" id="5236098">strconv</span><span class="op" id="5236105">.</span><span class="ident" id="5236106">Itoa</span><span class="op" id="5236110">(</span><span class="builtinfunc" id="5236111">len</span><span class="op" id="5236114">(</span><span class="ident" id="5236115">p</span><span class="op" id="5236116">)</span><span class="op" id="5236117">)</span><span class="op" id="5236118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236122">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5236130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236133">last</span>&nbsp;<span class="op" id="5236138">:=</span>&nbsp;<span class="op" id="5236141">-</span><span class="num" id="5236142">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236145">for</span>&nbsp;<span class="ident" id="5236149">i</span><span class="op" id="5236150">,</span>&nbsp;<span class="ident" id="5236152">c</span>&nbsp;<span class="op" id="5236154">:=</span>&nbsp;<span class="keyword" id="5236157">range</span>&nbsp;<span class="ident" id="5236163">p</span>&nbsp;<span class="op" id="5236165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236169">c1</span>&nbsp;<span class="op" id="5236172">:=</span>&nbsp;<span class="ident" id="5236175">color</span><span class="op" id="5236180">.</span><span class="ident" id="5236181">NRGBAModel</span><span class="op" id="5236191">.</span><span class="ident" id="5236192">Convert</span><span class="op" id="5236199">(</span><span class="ident" id="5236200">c</span><span class="op" id="5236201">)</span><span class="op" id="5236202">.</span><span class="op" id="5236203">(</span><span class="ident" id="5236204">color</span><span class="op" id="5236209">.</span><span class="ident" id="5236210">NRGBA</span><span class="op" id="5236215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236219">e</span><span class="op" id="5236220">.</span><span class="ident" id="5236221">tmp</span><span class="op" id="5236224">[</span><span class="num" id="5236225">3</span><span class="op" id="5236226">*</span><span class="ident" id="5236227">i</span><span class="op" id="5236228">+</span><span class="num" id="5236229">0</span><span class="op" id="5236230">]</span>&nbsp;<span class="op" id="5236232">=</span>&nbsp;<span class="ident" id="5236234">c1</span><span class="op" id="5236236">.</span><span class="ident" id="5236237">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236241">e</span><span class="op" id="5236242">.</span><span class="ident" id="5236243">tmp</span><span class="op" id="5236246">[</span><span class="num" id="5236247">3</span><span class="op" id="5236248">*</span><span class="ident" id="5236249">i</span><span class="op" id="5236250">+</span><span class="num" id="5236251">1</span><span class="op" id="5236252">]</span>&nbsp;<span class="op" id="5236254">=</span>&nbsp;<span class="ident" id="5236256">c1</span><span class="op" id="5236258">.</span><span class="ident" id="5236259">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236263">e</span><span class="op" id="5236264">.</span><span class="ident" id="5236265">tmp</span><span class="op" id="5236268">[</span><span class="num" id="5236269">3</span><span class="op" id="5236270">*</span><span class="ident" id="5236271">i</span><span class="op" id="5236272">+</span><span class="num" id="5236273">2</span><span class="op" id="5236274">]</span>&nbsp;<span class="op" id="5236276">=</span>&nbsp;<span class="ident" id="5236278">c1</span><span class="op" id="5236280">.</span><span class="ident" id="5236281">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236285">if</span>&nbsp;<span class="ident" id="5236288">c1</span><span class="op" id="5236290">.</span><span class="ident" id="5236291">A</span>&nbsp;<span class="op" id="5236293">!=</span>&nbsp;<span class="num" id="5236296">0xff</span>&nbsp;<span class="op" id="5236301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236306">last</span>&nbsp;<span class="op" id="5236311">=</span>&nbsp;<span class="ident" id="5236313">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5236317">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236321">e</span><span class="op" id="5236322">.</span><span class="ident" id="5236323">tmp</span><span class="op" id="5236326">[</span><span class="num" id="5236327">3</span><span class="op" id="5236328">*</span><span class="num" id="5236329">256</span><span class="op" id="5236332">+</span><span class="ident" id="5236333">i</span><span class="op" id="5236334">]</span>&nbsp;<span class="op" id="5236336">=</span>&nbsp;<span class="ident" id="5236338">c1</span><span class="op" id="5236340">.</span><span class="ident" id="5236341">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5236344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236347">e</span><span class="op" id="5236348">.</span><span class="ident" id="5236349">writeChunk</span><span class="op" id="5236359">(</span><span class="ident" id="5236360">e</span><span class="op" id="5236361">.</span><span class="ident" id="5236362">tmp</span><span class="op" id="5236365">[</span><span class="op" id="5236366">:</span><span class="num" id="5236367">3</span><span class="op" id="5236368">*</span><span class="builtinfunc" id="5236369">len</span><span class="op" id="5236372">(</span><span class="ident" id="5236373">p</span><span class="op" id="5236374">)</span><span class="op" id="5236375">]</span><span class="op" id="5236376">,</span>&nbsp;<span class="string" id="5236378">&#34;PLTE&#34;</span><span class="op" id="5236384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236387">if</span>&nbsp;<span class="ident" id="5236390">last</span>&nbsp;<span class="op" id="5236395">!=</span>&nbsp;<span class="op" id="5236398">-</span><span class="num" id="5236399">1</span>&nbsp;<span class="op" id="5236401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236405">e</span><span class="op" id="5236406">.</span><span class="ident" id="5236407">writeChunk</span><span class="op" id="5236417">(</span><span class="ident" id="5236418">e</span><span class="op" id="5236419">.</span><span class="ident" id="5236420">tmp</span><span class="op" id="5236423">[</span><span class="num" id="5236424">3</span><span class="op" id="5236425">*</span><span class="num" id="5236426">256</span><span class="op" id="5236429">:</span><span class="num" id="5236430">3</span><span class="op" id="5236431">*</span><span class="num" id="5236432">256</span><span class="op" id="5236435">+</span><span class="num" id="5236436">1</span><span class="op" id="5236437">+</span><span class="ident" id="5236438">last</span><span class="op" id="5236442">]</span><span class="op" id="5236443">,</span>&nbsp;<span class="string" id="5236445">&#34;tRNS&#34;</span><span class="op" id="5236451">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5236454">}</span><br>
<span class="lineno"></span><span class="op" id="5236456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5236459">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5236539">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5236620">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5236694">//</span><br>
<span class="lineno"></span><span class="comment" id="5236697">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5236768">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5236826">func</span>&nbsp;<span class="op" id="5236831">(</span><span class="ident" id="5236832">e</span>&nbsp;<span class="op" id="5236834">*</span><span class="ident" id="5236835">encoder</span><span class="op" id="5236842">)</span>&nbsp;<span class="ident" id="5236844">Write</span><span class="op" id="5236849">(</span><span class="ident" id="5236850">b</span>&nbsp;<span class="op" id="5236852">[</span><span class="op" id="5236853">]</span><span class="builtintype" id="5236854">byte</span><span class="op" id="5236858">)</span>&nbsp;<span class="op" id="5236860">(</span><span class="builtintype" id="5236861">int</span><span class="op" id="5236864">,</span>&nbsp;<span class="builtintype" id="5236866">error</span><span class="op" id="5236871">)</span>&nbsp;<span class="op" id="5236873">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5236876">e</span><span class="op" id="5236877">.</span><span class="ident" id="5236878">writeChunk</span><span class="op" id="5236888">(</span><span class="ident" id="5236889">b</span><span class="op" id="5236890">,</span>&nbsp;<span class="string" id="5236892">&#34;IDAT&#34;</span><span class="op" id="5236898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236901">if</span>&nbsp;<span class="ident" id="5236904">e</span><span class="op" id="5236905">.</span><span class="ident" id="5236906">err</span>&nbsp;<span class="op" id="5236910">!=</span>&nbsp;<span class="builtintype" id="5236913">nil</span>&nbsp;<span class="op" id="5236917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236921">return</span>&nbsp;<span class="num" id="5236928">0</span><span class="op" id="5236929">,</span>&nbsp;<span class="ident" id="5236931">e</span><span class="op" id="5236932">.</span><span class="ident" id="5236933">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5236938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5236941">return</span>&nbsp;<span class="builtinfunc" id="5236948">len</span><span class="op" id="5236951">(</span><span class="ident" id="5236952">b</span><span class="op" id="5236953">)</span><span class="op" id="5236954">,</span>&nbsp;<span class="builtintype" id="5236956">nil</span><br>
<span class="lineno">180</span><span class="op" id="5236960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5236963">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5237038">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5237136">func</span>&nbsp;<span class="ident" id="5237141">filter</span><span class="op" id="5237147">(</span><span class="ident" id="5237148">cr</span>&nbsp;<span class="op" id="5237151">*</span><span class="op" id="5237152">[</span><span class="ident" id="5237153">nFilter</span><span class="op" id="5237160">]</span><span class="op" id="5237161">[</span><span class="op" id="5237162">]</span><span class="builtintype" id="5237163">byte</span><span class="op" id="5237167">,</span>&nbsp;<span class="ident" id="5237169">pr</span>&nbsp;<span class="op" id="5237172">[</span><span class="op" id="5237173">]</span><span class="builtintype" id="5237174">byte</span><span class="op" id="5237178">,</span>&nbsp;<span class="ident" id="5237180">bpp</span>&nbsp;<span class="builtintype" id="5237184">int</span><span class="op" id="5237187">)</span>&nbsp;<span class="builtintype" id="5237189">int</span>&nbsp;<span class="op" id="5237193">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237196">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237295">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237391">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237486">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237560">cdat0</span>&nbsp;<span class="op" id="5237566">:=</span>&nbsp;<span class="ident" id="5237569">cr</span><span class="op" id="5237571">[</span><span class="num" id="5237572">0</span><span class="op" id="5237573">]</span><span class="op" id="5237574">[</span><span class="num" id="5237575">1</span><span class="op" id="5237576">:</span><span class="op" id="5237577">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237580">cdat1</span>&nbsp;<span class="op" id="5237586">:=</span>&nbsp;<span class="ident" id="5237589">cr</span><span class="op" id="5237591">[</span><span class="num" id="5237592">1</span><span class="op" id="5237593">]</span><span class="op" id="5237594">[</span><span class="num" id="5237595">1</span><span class="op" id="5237596">:</span><span class="op" id="5237597">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237600">cdat2</span>&nbsp;<span class="op" id="5237606">:=</span>&nbsp;<span class="ident" id="5237609">cr</span><span class="op" id="5237611">[</span><span class="num" id="5237612">2</span><span class="op" id="5237613">]</span><span class="op" id="5237614">[</span><span class="num" id="5237615">1</span><span class="op" id="5237616">:</span><span class="op" id="5237617">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237620">cdat3</span>&nbsp;<span class="op" id="5237626">:=</span>&nbsp;<span class="ident" id="5237629">cr</span><span class="op" id="5237631">[</span><span class="num" id="5237632">3</span><span class="op" id="5237633">]</span><span class="op" id="5237634">[</span><span class="num" id="5237635">1</span><span class="op" id="5237636">:</span><span class="op" id="5237637">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237640">cdat4</span>&nbsp;<span class="op" id="5237646">:=</span>&nbsp;<span class="ident" id="5237649">cr</span><span class="op" id="5237651">[</span><span class="num" id="5237652">4</span><span class="op" id="5237653">]</span><span class="op" id="5237654">[</span><span class="num" id="5237655">1</span><span class="op" id="5237656">:</span><span class="op" id="5237657">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237660">pdat</span>&nbsp;<span class="op" id="5237665">:=</span>&nbsp;<span class="ident" id="5237668">pr</span><span class="op" id="5237670">[</span><span class="num" id="5237671">1</span><span class="op" id="5237672">:</span><span class="op" id="5237673">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237676">n</span>&nbsp;<span class="op" id="5237678">:=</span>&nbsp;<span class="builtinfunc" id="5237681">len</span><span class="op" id="5237684">(</span><span class="ident" id="5237685">cdat0</span><span class="op" id="5237690">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237694">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237713">sum</span>&nbsp;<span class="op" id="5237717">:=</span>&nbsp;<span class="num" id="5237720">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5237723">for</span>&nbsp;<span class="ident" id="5237727">i</span>&nbsp;<span class="op" id="5237729">:=</span>&nbsp;<span class="num" id="5237732">0</span><span class="op" id="5237733">;</span>&nbsp;<span class="ident" id="5237735">i</span>&nbsp;<span class="op" id="5237737">&lt;</span>&nbsp;<span class="ident" id="5237739">n</span><span class="op" id="5237740">;</span>&nbsp;<span class="ident" id="5237742">i</span><span class="op" id="5237743">++</span>&nbsp;<span class="op" id="5237746">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237750">cdat2</span><span class="op" id="5237755">[</span><span class="ident" id="5237756">i</span><span class="op" id="5237757">]</span>&nbsp;<span class="op" id="5237759">=</span>&nbsp;<span class="ident" id="5237761">cdat0</span><span class="op" id="5237766">[</span><span class="ident" id="5237767">i</span><span class="op" id="5237768">]</span>&nbsp;<span class="op" id="5237770">-</span>&nbsp;<span class="ident" id="5237772">pdat</span><span class="op" id="5237776">[</span><span class="ident" id="5237777">i</span><span class="op" id="5237778">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237782">sum</span>&nbsp;<span class="op" id="5237786">+=</span>&nbsp;<span class="ident" id="5237789">abs8</span><span class="op" id="5237793">(</span><span class="ident" id="5237794">cdat2</span><span class="op" id="5237799">[</span><span class="ident" id="5237800">i</span><span class="op" id="5237801">]</span><span class="op" id="5237802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5237805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237808">best</span>&nbsp;<span class="op" id="5237813">:=</span>&nbsp;<span class="ident" id="5237816">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237821">filter</span>&nbsp;<span class="op" id="5237828">:=</span>&nbsp;<span class="ident" id="5237831">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5237838">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237860">sum</span>&nbsp;<span class="op" id="5237864">=</span>&nbsp;<span class="num" id="5237866">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5237869">for</span>&nbsp;<span class="ident" id="5237873">i</span>&nbsp;<span class="op" id="5237875">:=</span>&nbsp;<span class="num" id="5237878">0</span><span class="op" id="5237879">;</span>&nbsp;<span class="ident" id="5237881">i</span>&nbsp;<span class="op" id="5237883">&lt;</span>&nbsp;<span class="ident" id="5237885">bpp</span><span class="op" id="5237888">;</span>&nbsp;<span class="ident" id="5237890">i</span><span class="op" id="5237891">++</span>&nbsp;<span class="op" id="5237894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237898">cdat4</span><span class="op" id="5237903">[</span><span class="ident" id="5237904">i</span><span class="op" id="5237905">]</span>&nbsp;<span class="op" id="5237907">=</span>&nbsp;<span class="ident" id="5237909">cdat0</span><span class="op" id="5237914">[</span><span class="ident" id="5237915">i</span><span class="op" id="5237916">]</span>&nbsp;<span class="op" id="5237918">-</span>&nbsp;<span class="ident" id="5237920">pdat</span><span class="op" id="5237924">[</span><span class="ident" id="5237925">i</span><span class="op" id="5237926">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237930">sum</span>&nbsp;<span class="op" id="5237934">+=</span>&nbsp;<span class="ident" id="5237937">abs8</span><span class="op" id="5237941">(</span><span class="ident" id="5237942">cdat4</span><span class="op" id="5237947">[</span><span class="ident" id="5237948">i</span><span class="op" id="5237949">]</span><span class="op" id="5237950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5237953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5237956">for</span>&nbsp;<span class="ident" id="5237960">i</span>&nbsp;<span class="op" id="5237962">:=</span>&nbsp;<span class="ident" id="5237965">bpp</span><span class="op" id="5237968">;</span>&nbsp;<span class="ident" id="5237970">i</span>&nbsp;<span class="op" id="5237972">&lt;</span>&nbsp;<span class="ident" id="5237974">n</span><span class="op" id="5237975">;</span>&nbsp;<span class="ident" id="5237977">i</span><span class="op" id="5237978">++</span>&nbsp;<span class="op" id="5237981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5237985">cdat4</span><span class="op" id="5237990">[</span><span class="ident" id="5237991">i</span><span class="op" id="5237992">]</span>&nbsp;<span class="op" id="5237994">=</span>&nbsp;<span class="ident" id="5237996">cdat0</span><span class="op" id="5238001">[</span><span class="ident" id="5238002">i</span><span class="op" id="5238003">]</span>&nbsp;<span class="op" id="5238005">-</span>&nbsp;<span class="ident" id="5238007">paeth</span><span class="op" id="5238012">(</span><span class="ident" id="5238013">cdat0</span><span class="op" id="5238018">[</span><span class="ident" id="5238019">i</span><span class="op" id="5238020">-</span><span class="ident" id="5238021">bpp</span><span class="op" id="5238024">]</span><span class="op" id="5238025">,</span>&nbsp;<span class="ident" id="5238027">pdat</span><span class="op" id="5238031">[</span><span class="ident" id="5238032">i</span><span class="op" id="5238033">]</span><span class="op" id="5238034">,</span>&nbsp;<span class="ident" id="5238036">pdat</span><span class="op" id="5238040">[</span><span class="ident" id="5238041">i</span><span class="op" id="5238042">-</span><span class="ident" id="5238043">bpp</span><span class="op" id="5238046">]</span><span class="op" id="5238047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238051">sum</span>&nbsp;<span class="op" id="5238055">+=</span>&nbsp;<span class="ident" id="5238058">abs8</span><span class="op" id="5238062">(</span><span class="ident" id="5238063">cdat4</span><span class="op" id="5238068">[</span><span class="ident" id="5238069">i</span><span class="op" id="5238070">]</span><span class="op" id="5238071">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238075">if</span>&nbsp;<span class="ident" id="5238078">sum</span>&nbsp;<span class="op" id="5238082">&gt;=</span>&nbsp;<span class="ident" id="5238085">best</span>&nbsp;<span class="op" id="5238090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238095">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238109">if</span>&nbsp;<span class="ident" id="5238112">sum</span>&nbsp;<span class="op" id="5238116">&lt;</span>&nbsp;<span class="ident" id="5238118">best</span>&nbsp;<span class="op" id="5238123">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238127">best</span>&nbsp;<span class="op" id="5238132">=</span>&nbsp;<span class="ident" id="5238134">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238140">filter</span>&nbsp;<span class="op" id="5238147">=</span>&nbsp;<span class="ident" id="5238149">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5238162">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238183">sum</span>&nbsp;<span class="op" id="5238187">=</span>&nbsp;<span class="num" id="5238189">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238192">for</span>&nbsp;<span class="ident" id="5238196">i</span>&nbsp;<span class="op" id="5238198">:=</span>&nbsp;<span class="num" id="5238201">0</span><span class="op" id="5238202">;</span>&nbsp;<span class="ident" id="5238204">i</span>&nbsp;<span class="op" id="5238206">&lt;</span>&nbsp;<span class="ident" id="5238208">n</span><span class="op" id="5238209">;</span>&nbsp;<span class="ident" id="5238211">i</span><span class="op" id="5238212">++</span>&nbsp;<span class="op" id="5238215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238219">sum</span>&nbsp;<span class="op" id="5238223">+=</span>&nbsp;<span class="ident" id="5238226">abs8</span><span class="op" id="5238230">(</span><span class="ident" id="5238231">cdat0</span><span class="op" id="5238236">[</span><span class="ident" id="5238237">i</span><span class="op" id="5238238">]</span><span class="op" id="5238239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238243">if</span>&nbsp;<span class="ident" id="5238246">sum</span>&nbsp;<span class="op" id="5238250">&gt;=</span>&nbsp;<span class="ident" id="5238253">best</span>&nbsp;<span class="op" id="5238258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238263">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238277">if</span>&nbsp;<span class="ident" id="5238280">sum</span>&nbsp;<span class="op" id="5238284">&lt;</span>&nbsp;<span class="ident" id="5238286">best</span>&nbsp;<span class="op" id="5238291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238295">best</span>&nbsp;<span class="op" id="5238300">=</span>&nbsp;<span class="ident" id="5238302">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238308">filter</span>&nbsp;<span class="op" id="5238315">=</span>&nbsp;<span class="ident" id="5238317">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5238329">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238349">sum</span>&nbsp;<span class="op" id="5238353">=</span>&nbsp;<span class="num" id="5238355">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238358">for</span>&nbsp;<span class="ident" id="5238362">i</span>&nbsp;<span class="op" id="5238364">:=</span>&nbsp;<span class="num" id="5238367">0</span><span class="op" id="5238368">;</span>&nbsp;<span class="ident" id="5238370">i</span>&nbsp;<span class="op" id="5238372">&lt;</span>&nbsp;<span class="ident" id="5238374">bpp</span><span class="op" id="5238377">;</span>&nbsp;<span class="ident" id="5238379">i</span><span class="op" id="5238380">++</span>&nbsp;<span class="op" id="5238383">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238387">cdat1</span><span class="op" id="5238392">[</span><span class="ident" id="5238393">i</span><span class="op" id="5238394">]</span>&nbsp;<span class="op" id="5238396">=</span>&nbsp;<span class="ident" id="5238398">cdat0</span><span class="op" id="5238403">[</span><span class="ident" id="5238404">i</span><span class="op" id="5238405">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238409">sum</span>&nbsp;<span class="op" id="5238413">+=</span>&nbsp;<span class="ident" id="5238416">abs8</span><span class="op" id="5238420">(</span><span class="ident" id="5238421">cdat1</span><span class="op" id="5238426">[</span><span class="ident" id="5238427">i</span><span class="op" id="5238428">]</span><span class="op" id="5238429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238435">for</span>&nbsp;<span class="ident" id="5238439">i</span>&nbsp;<span class="op" id="5238441">:=</span>&nbsp;<span class="ident" id="5238444">bpp</span><span class="op" id="5238447">;</span>&nbsp;<span class="ident" id="5238449">i</span>&nbsp;<span class="op" id="5238451">&lt;</span>&nbsp;<span class="ident" id="5238453">n</span><span class="op" id="5238454">;</span>&nbsp;<span class="ident" id="5238456">i</span><span class="op" id="5238457">++</span>&nbsp;<span class="op" id="5238460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238464">cdat1</span><span class="op" id="5238469">[</span><span class="ident" id="5238470">i</span><span class="op" id="5238471">]</span>&nbsp;<span class="op" id="5238473">=</span>&nbsp;<span class="ident" id="5238475">cdat0</span><span class="op" id="5238480">[</span><span class="ident" id="5238481">i</span><span class="op" id="5238482">]</span>&nbsp;<span class="op" id="5238484">-</span>&nbsp;<span class="ident" id="5238486">cdat0</span><span class="op" id="5238491">[</span><span class="ident" id="5238492">i</span><span class="op" id="5238493">-</span><span class="ident" id="5238494">bpp</span><span class="op" id="5238497">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238501">sum</span>&nbsp;<span class="op" id="5238505">+=</span>&nbsp;<span class="ident" id="5238508">abs8</span><span class="op" id="5238512">(</span><span class="ident" id="5238513">cdat1</span><span class="op" id="5238518">[</span><span class="ident" id="5238519">i</span><span class="op" id="5238520">]</span><span class="op" id="5238521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238525">if</span>&nbsp;<span class="ident" id="5238528">sum</span>&nbsp;<span class="op" id="5238532">&gt;=</span>&nbsp;<span class="ident" id="5238535">best</span>&nbsp;<span class="op" id="5238540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238545">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238556">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238559">if</span>&nbsp;<span class="ident" id="5238562">sum</span>&nbsp;<span class="op" id="5238566">&lt;</span>&nbsp;<span class="ident" id="5238568">best</span>&nbsp;<span class="op" id="5238573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238577">best</span>&nbsp;<span class="op" id="5238582">=</span>&nbsp;<span class="ident" id="5238584">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238590">filter</span>&nbsp;<span class="op" id="5238597">=</span>&nbsp;<span class="ident" id="5238599">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5238610">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238634">sum</span>&nbsp;<span class="op" id="5238638">=</span>&nbsp;<span class="num" id="5238640">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238643">for</span>&nbsp;<span class="ident" id="5238647">i</span>&nbsp;<span class="op" id="5238649">:=</span>&nbsp;<span class="num" id="5238652">0</span><span class="op" id="5238653">;</span>&nbsp;<span class="ident" id="5238655">i</span>&nbsp;<span class="op" id="5238657">&lt;</span>&nbsp;<span class="ident" id="5238659">bpp</span><span class="op" id="5238662">;</span>&nbsp;<span class="ident" id="5238664">i</span><span class="op" id="5238665">++</span>&nbsp;<span class="op" id="5238668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238672">cdat3</span><span class="op" id="5238677">[</span><span class="ident" id="5238678">i</span><span class="op" id="5238679">]</span>&nbsp;<span class="op" id="5238681">=</span>&nbsp;<span class="ident" id="5238683">cdat0</span><span class="op" id="5238688">[</span><span class="ident" id="5238689">i</span><span class="op" id="5238690">]</span>&nbsp;<span class="op" id="5238692">-</span>&nbsp;<span class="ident" id="5238694">pdat</span><span class="op" id="5238698">[</span><span class="ident" id="5238699">i</span><span class="op" id="5238700">]</span><span class="op" id="5238701">/</span><span class="num" id="5238702">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238706">sum</span>&nbsp;<span class="op" id="5238710">+=</span>&nbsp;<span class="ident" id="5238713">abs8</span><span class="op" id="5238717">(</span><span class="ident" id="5238718">cdat3</span><span class="op" id="5238723">[</span><span class="ident" id="5238724">i</span><span class="op" id="5238725">]</span><span class="op" id="5238726">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238732">for</span>&nbsp;<span class="ident" id="5238736">i</span>&nbsp;<span class="op" id="5238738">:=</span>&nbsp;<span class="ident" id="5238741">bpp</span><span class="op" id="5238744">;</span>&nbsp;<span class="ident" id="5238746">i</span>&nbsp;<span class="op" id="5238748">&lt;</span>&nbsp;<span class="ident" id="5238750">n</span><span class="op" id="5238751">;</span>&nbsp;<span class="ident" id="5238753">i</span><span class="op" id="5238754">++</span>&nbsp;<span class="op" id="5238757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238761">cdat3</span><span class="op" id="5238766">[</span><span class="ident" id="5238767">i</span><span class="op" id="5238768">]</span>&nbsp;<span class="op" id="5238770">=</span>&nbsp;<span class="ident" id="5238772">cdat0</span><span class="op" id="5238777">[</span><span class="ident" id="5238778">i</span><span class="op" id="5238779">]</span>&nbsp;<span class="op" id="5238781">-</span>&nbsp;<span class="builtintype" id="5238783">uint8</span><span class="op" id="5238788">(</span><span class="op" id="5238789">(</span><span class="builtintype" id="5238790">int</span><span class="op" id="5238793">(</span><span class="ident" id="5238794">cdat0</span><span class="op" id="5238799">[</span><span class="ident" id="5238800">i</span><span class="op" id="5238801">-</span><span class="ident" id="5238802">bpp</span><span class="op" id="5238805">]</span><span class="op" id="5238806">)</span><span class="op" id="5238807">+</span><span class="builtintype" id="5238808">int</span><span class="op" id="5238811">(</span><span class="ident" id="5238812">pdat</span><span class="op" id="5238816">[</span><span class="ident" id="5238817">i</span><span class="op" id="5238818">]</span><span class="op" id="5238819">)</span><span class="op" id="5238820">)</span><span class="op" id="5238821">/</span><span class="num" id="5238822">2</span><span class="op" id="5238823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238827">sum</span>&nbsp;<span class="op" id="5238831">+=</span>&nbsp;<span class="ident" id="5238834">abs8</span><span class="op" id="5238838">(</span><span class="ident" id="5238839">cdat3</span><span class="op" id="5238844">[</span><span class="ident" id="5238845">i</span><span class="op" id="5238846">]</span><span class="op" id="5238847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238851">if</span>&nbsp;<span class="ident" id="5238854">sum</span>&nbsp;<span class="op" id="5238858">&gt;=</span>&nbsp;<span class="ident" id="5238861">best</span>&nbsp;<span class="op" id="5238866">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238871">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238885">if</span>&nbsp;<span class="ident" id="5238888">sum</span>&nbsp;<span class="op" id="5238892">&lt;</span>&nbsp;<span class="ident" id="5238894">best</span>&nbsp;<span class="op" id="5238899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238903">best</span>&nbsp;<span class="op" id="5238908">=</span>&nbsp;<span class="ident" id="5238910">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5238916">filter</span>&nbsp;<span class="op" id="5238923">=</span>&nbsp;<span class="ident" id="5238925">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5238936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5238940">return</span>&nbsp;<span class="ident" id="5238947">filter</span><br>
<span class="lineno"></span><span class="op" id="5238954">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5238957">func</span>&nbsp;<span class="ident" id="5238962">writeImage</span><span class="op" id="5238972">(</span><span class="ident" id="5238973">w</span>&nbsp;<span class="ident" id="5238975">io</span><span class="op" id="5238977">.</span><span class="ident" id="5238978">Writer</span><span class="op" id="5238984">,</span>&nbsp;<span class="ident" id="5238986">m</span>&nbsp;<span class="ident" id="5238988">image</span><span class="op" id="5238993">.</span><span class="ident" id="5238994">Image</span><span class="op" id="5238999">,</span>&nbsp;<span class="ident" id="5239001">cb</span>&nbsp;<span class="builtintype" id="5239004">int</span><span class="op" id="5239007">,</span>&nbsp;<span class="ident" id="5239009">level</span>&nbsp;<span class="builtintype" id="5239015">int</span><span class="op" id="5239018">)</span>&nbsp;<span class="builtintype" id="5239020">error</span>&nbsp;<span class="op" id="5239026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239029">zw</span><span class="op" id="5239031">,</span>&nbsp;<span class="ident" id="5239033">err</span>&nbsp;<span class="op" id="5239037">:=</span>&nbsp;<span class="ident" id="5239040">zlib</span><span class="op" id="5239044">.</span><span class="ident" id="5239045">NewWriterLevel</span><span class="op" id="5239059">(</span><span class="ident" id="5239060">w</span><span class="op" id="5239061">,</span>&nbsp;<span class="ident" id="5239063">level</span><span class="op" id="5239068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239071">if</span>&nbsp;<span class="ident" id="5239074">err</span>&nbsp;<span class="op" id="5239078">!=</span>&nbsp;<span class="builtintype" id="5239081">nil</span>&nbsp;<span class="op" id="5239085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239089">return</span>&nbsp;<span class="ident" id="5239096">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5239101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239104">defer</span>&nbsp;<span class="ident" id="5239110">zw</span><span class="op" id="5239112">.</span><span class="ident" id="5239113">Close</span><span class="op" id="5239118">(</span><span class="op" id="5239119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239123">bpp</span>&nbsp;<span class="op" id="5239127">:=</span>&nbsp;<span class="num" id="5239130">0</span>&nbsp;<span class="comment" id="5239132">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239154">switch</span>&nbsp;<span class="ident" id="5239161">cb</span>&nbsp;<span class="op" id="5239164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239167">case</span>&nbsp;<span class="ident" id="5239172">cbG8</span><span class="op" id="5239176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239180">bpp</span>&nbsp;<span class="op" id="5239184">=</span>&nbsp;<span class="num" id="5239186">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239189">case</span>&nbsp;<span class="ident" id="5239194">cbTC8</span><span class="op" id="5239199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239203">bpp</span>&nbsp;<span class="op" id="5239207">=</span>&nbsp;<span class="num" id="5239209">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239212">case</span>&nbsp;<span class="ident" id="5239217">cbP8</span><span class="op" id="5239221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239225">bpp</span>&nbsp;<span class="op" id="5239229">=</span>&nbsp;<span class="num" id="5239231">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239234">case</span>&nbsp;<span class="ident" id="5239239">cbTCA8</span><span class="op" id="5239245">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239249">bpp</span>&nbsp;<span class="op" id="5239253">=</span>&nbsp;<span class="num" id="5239255">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239258">case</span>&nbsp;<span class="ident" id="5239263">cbTC16</span><span class="op" id="5239269">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239273">bpp</span>&nbsp;<span class="op" id="5239277">=</span>&nbsp;<span class="num" id="5239279">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239282">case</span>&nbsp;<span class="ident" id="5239287">cbTCA16</span><span class="op" id="5239294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239298">bpp</span>&nbsp;<span class="op" id="5239302">=</span>&nbsp;<span class="num" id="5239304">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239307">case</span>&nbsp;<span class="ident" id="5239312">cbG16</span><span class="op" id="5239317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239321">bpp</span>&nbsp;<span class="op" id="5239325">=</span>&nbsp;<span class="num" id="5239327">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5239330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5239333">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5239398">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5239474">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5239561">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5239648">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239713">b</span>&nbsp;<span class="op" id="5239715">:=</span>&nbsp;<span class="ident" id="5239718">m</span><span class="op" id="5239719">.</span><span class="ident" id="5239720">Bounds</span><span class="op" id="5239726">(</span><span class="op" id="5239727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239730">var</span>&nbsp;<span class="ident" id="5239734">cr</span>&nbsp;<span class="op" id="5239737">[</span><span class="ident" id="5239738">nFilter</span><span class="op" id="5239745">]</span><span class="op" id="5239746">[</span><span class="op" id="5239747">]</span><span class="builtintype" id="5239748">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239755">for</span>&nbsp;<span class="ident" id="5239759">i</span>&nbsp;<span class="op" id="5239761">:=</span>&nbsp;<span class="keyword" id="5239764">range</span>&nbsp;<span class="ident" id="5239770">cr</span>&nbsp;<span class="op" id="5239773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239777">cr</span><span class="op" id="5239779">[</span><span class="ident" id="5239780">i</span><span class="op" id="5239781">]</span>&nbsp;<span class="op" id="5239783">=</span>&nbsp;<span class="builtinfunc" id="5239785">make</span><span class="op" id="5239789">(</span><span class="op" id="5239790">[</span><span class="op" id="5239791">]</span><span class="builtintype" id="5239792">uint8</span><span class="op" id="5239797">,</span>&nbsp;<span class="num" id="5239799">1</span><span class="op" id="5239800">+</span><span class="ident" id="5239801">bpp</span><span class="op" id="5239804">*</span><span class="ident" id="5239805">b</span><span class="op" id="5239806">.</span><span class="ident" id="5239807">Dx</span><span class="op" id="5239809">(</span><span class="op" id="5239810">)</span><span class="op" id="5239811">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239815">cr</span><span class="op" id="5239817">[</span><span class="ident" id="5239818">i</span><span class="op" id="5239819">]</span><span class="op" id="5239820">[</span><span class="num" id="5239821">0</span><span class="op" id="5239822">]</span>&nbsp;<span class="op" id="5239824">=</span>&nbsp;<span class="builtintype" id="5239826">uint8</span><span class="op" id="5239831">(</span><span class="ident" id="5239832">i</span><span class="op" id="5239833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5239836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239839">pr</span>&nbsp;<span class="op" id="5239842">:=</span>&nbsp;<span class="builtinfunc" id="5239845">make</span><span class="op" id="5239849">(</span><span class="op" id="5239850">[</span><span class="op" id="5239851">]</span><span class="builtintype" id="5239852">uint8</span><span class="op" id="5239857">,</span>&nbsp;<span class="num" id="5239859">1</span><span class="op" id="5239860">+</span><span class="ident" id="5239861">bpp</span><span class="op" id="5239864">*</span><span class="ident" id="5239865">b</span><span class="op" id="5239866">.</span><span class="ident" id="5239867">Dx</span><span class="op" id="5239869">(</span><span class="op" id="5239870">)</span><span class="op" id="5239871">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239875">gray</span><span class="op" id="5239879">,</span>&nbsp;<span class="ident" id="5239881">_</span>&nbsp;<span class="op" id="5239883">:=</span>&nbsp;<span class="ident" id="5239886">m</span><span class="op" id="5239887">.</span><span class="op" id="5239888">(</span><span class="op" id="5239889">*</span><span class="ident" id="5239890">image</span><span class="op" id="5239895">.</span><span class="ident" id="5239896">Gray</span><span class="op" id="5239900">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239903">rgba</span><span class="op" id="5239907">,</span>&nbsp;<span class="ident" id="5239909">_</span>&nbsp;<span class="op" id="5239911">:=</span>&nbsp;<span class="ident" id="5239914">m</span><span class="op" id="5239915">.</span><span class="op" id="5239916">(</span><span class="op" id="5239917">*</span><span class="ident" id="5239918">image</span><span class="op" id="5239923">.</span><span class="ident" id="5239924">RGBA</span><span class="op" id="5239928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239931">paletted</span><span class="op" id="5239939">,</span>&nbsp;<span class="ident" id="5239941">_</span>&nbsp;<span class="op" id="5239943">:=</span>&nbsp;<span class="ident" id="5239946">m</span><span class="op" id="5239947">.</span><span class="op" id="5239948">(</span><span class="op" id="5239949">*</span><span class="ident" id="5239950">image</span><span class="op" id="5239955">.</span><span class="ident" id="5239956">Paletted</span><span class="op" id="5239964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5239967">nrgba</span><span class="op" id="5239972">,</span>&nbsp;<span class="ident" id="5239974">_</span>&nbsp;<span class="op" id="5239976">:=</span>&nbsp;<span class="ident" id="5239979">m</span><span class="op" id="5239980">.</span><span class="op" id="5239981">(</span><span class="op" id="5239982">*</span><span class="ident" id="5239983">image</span><span class="op" id="5239988">.</span><span class="ident" id="5239989">NRGBA</span><span class="op" id="5239994">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5239998">for</span>&nbsp;<span class="ident" id="5240002">y</span>&nbsp;<span class="op" id="5240004">:=</span>&nbsp;<span class="ident" id="5240007">b</span><span class="op" id="5240008">.</span><span class="ident" id="5240009">Min</span><span class="op" id="5240012">.</span><span class="ident" id="5240013">Y</span><span class="op" id="5240014">;</span>&nbsp;<span class="ident" id="5240016">y</span>&nbsp;<span class="op" id="5240018">&lt;</span>&nbsp;<span class="ident" id="5240020">b</span><span class="op" id="5240021">.</span><span class="ident" id="5240022">Max</span><span class="op" id="5240025">.</span><span class="ident" id="5240026">Y</span><span class="op" id="5240027">;</span>&nbsp;<span class="ident" id="5240029">y</span><span class="op" id="5240030">++</span>&nbsp;<span class="op" id="5240033">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5240037">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240072">i</span>&nbsp;<span class="op" id="5240074">:=</span>&nbsp;<span class="num" id="5240077">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240081">switch</span>&nbsp;<span class="ident" id="5240088">cb</span>&nbsp;<span class="op" id="5240091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240095">case</span>&nbsp;<span class="ident" id="5240100">cbG8</span><span class="op" id="5240104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240109">if</span>&nbsp;<span class="ident" id="5240112">gray</span>&nbsp;<span class="op" id="5240117">!=</span>&nbsp;<span class="builtintype" id="5240120">nil</span>&nbsp;<span class="op" id="5240124">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240130">offset</span>&nbsp;<span class="op" id="5240137">:=</span>&nbsp;<span class="op" id="5240140">(</span><span class="ident" id="5240141">y</span>&nbsp;<span class="op" id="5240143">-</span>&nbsp;<span class="ident" id="5240145">b</span><span class="op" id="5240146">.</span><span class="ident" id="5240147">Min</span><span class="op" id="5240150">.</span><span class="ident" id="5240151">Y</span><span class="op" id="5240152">)</span>&nbsp;<span class="op" id="5240154">*</span>&nbsp;<span class="ident" id="5240156">gray</span><span class="op" id="5240160">.</span><span class="ident" id="5240161">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5240172">copy</span><span class="op" id="5240176">(</span><span class="ident" id="5240177">cr</span><span class="op" id="5240179">[</span><span class="num" id="5240180">0</span><span class="op" id="5240181">]</span><span class="op" id="5240182">[</span><span class="num" id="5240183">1</span><span class="op" id="5240184">:</span><span class="op" id="5240185">]</span><span class="op" id="5240186">,</span>&nbsp;<span class="ident" id="5240188">gray</span><span class="op" id="5240192">.</span><span class="ident" id="5240193">Pix</span><span class="op" id="5240196">[</span><span class="ident" id="5240197">offset</span><span class="op" id="5240203">:</span><span class="ident" id="5240204">offset</span><span class="op" id="5240210">+</span><span class="ident" id="5240211">b</span><span class="op" id="5240212">.</span><span class="ident" id="5240213">Dx</span><span class="op" id="5240215">(</span><span class="op" id="5240216">)</span><span class="op" id="5240217">]</span><span class="op" id="5240218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240223">}</span>&nbsp;<span class="keyword" id="5240225">else</span>&nbsp;<span class="op" id="5240230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240236">for</span>&nbsp;<span class="ident" id="5240240">x</span>&nbsp;<span class="op" id="5240242">:=</span>&nbsp;<span class="ident" id="5240245">b</span><span class="op" id="5240246">.</span><span class="ident" id="5240247">Min</span><span class="op" id="5240250">.</span><span class="ident" id="5240251">X</span><span class="op" id="5240252">;</span>&nbsp;<span class="ident" id="5240254">x</span>&nbsp;<span class="op" id="5240256">&lt;</span>&nbsp;<span class="ident" id="5240258">b</span><span class="op" id="5240259">.</span><span class="ident" id="5240260">Max</span><span class="op" id="5240263">.</span><span class="ident" id="5240264">X</span><span class="op" id="5240265">;</span>&nbsp;<span class="ident" id="5240267">x</span><span class="op" id="5240268">++</span>&nbsp;<span class="op" id="5240271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240278">c</span>&nbsp;<span class="op" id="5240280">:=</span>&nbsp;<span class="ident" id="5240283">color</span><span class="op" id="5240288">.</span><span class="ident" id="5240289">GrayModel</span><span class="op" id="5240298">.</span><span class="ident" id="5240299">Convert</span><span class="op" id="5240306">(</span><span class="ident" id="5240307">m</span><span class="op" id="5240308">.</span><span class="ident" id="5240309">At</span><span class="op" id="5240311">(</span><span class="ident" id="5240312">x</span><span class="op" id="5240313">,</span>&nbsp;<span class="ident" id="5240315">y</span><span class="op" id="5240316">)</span><span class="op" id="5240317">)</span><span class="op" id="5240318">.</span><span class="op" id="5240319">(</span><span class="ident" id="5240320">color</span><span class="op" id="5240325">.</span><span class="ident" id="5240326">Gray</span><span class="op" id="5240330">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240337">cr</span><span class="op" id="5240339">[</span><span class="num" id="5240340">0</span><span class="op" id="5240341">]</span><span class="op" id="5240342">[</span><span class="ident" id="5240343">i</span><span class="op" id="5240344">]</span>&nbsp;<span class="op" id="5240346">=</span>&nbsp;<span class="ident" id="5240348">c</span><span class="op" id="5240349">.</span><span class="ident" id="5240350">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240357">i</span><span class="op" id="5240358">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240374">case</span>&nbsp;<span class="ident" id="5240379">cbTC8</span><span class="op" id="5240384">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5240389">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240461">cr0</span>&nbsp;<span class="op" id="5240465">:=</span>&nbsp;<span class="ident" id="5240468">cr</span><span class="op" id="5240470">[</span><span class="num" id="5240471">0</span><span class="op" id="5240472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240477">stride</span><span class="op" id="5240483">,</span>&nbsp;<span class="ident" id="5240485">pix</span>&nbsp;<span class="op" id="5240489">:=</span>&nbsp;<span class="num" id="5240492">0</span><span class="op" id="5240493">,</span>&nbsp;<span class="op" id="5240495">[</span><span class="op" id="5240496">]</span><span class="builtintype" id="5240497">byte</span><span class="op" id="5240501">(</span><span class="builtintype" id="5240502">nil</span><span class="op" id="5240505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240510">if</span>&nbsp;<span class="ident" id="5240513">rgba</span>&nbsp;<span class="op" id="5240518">!=</span>&nbsp;<span class="builtintype" id="5240521">nil</span>&nbsp;<span class="op" id="5240525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240531">stride</span><span class="op" id="5240537">,</span>&nbsp;<span class="ident" id="5240539">pix</span>&nbsp;<span class="op" id="5240543">=</span>&nbsp;<span class="ident" id="5240545">rgba</span><span class="op" id="5240549">.</span><span class="ident" id="5240550">Stride</span><span class="op" id="5240556">,</span>&nbsp;<span class="ident" id="5240558">rgba</span><span class="op" id="5240562">.</span><span class="ident" id="5240563">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240570">}</span>&nbsp;<span class="keyword" id="5240572">else</span>&nbsp;<span class="keyword" id="5240577">if</span>&nbsp;<span class="ident" id="5240580">nrgba</span>&nbsp;<span class="op" id="5240586">!=</span>&nbsp;<span class="builtintype" id="5240589">nil</span>&nbsp;<span class="op" id="5240593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240599">stride</span><span class="op" id="5240605">,</span>&nbsp;<span class="ident" id="5240607">pix</span>&nbsp;<span class="op" id="5240611">=</span>&nbsp;<span class="ident" id="5240613">nrgba</span><span class="op" id="5240618">.</span><span class="ident" id="5240619">Stride</span><span class="op" id="5240625">,</span>&nbsp;<span class="ident" id="5240627">nrgba</span><span class="op" id="5240632">.</span><span class="ident" id="5240633">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240645">if</span>&nbsp;<span class="ident" id="5240648">stride</span>&nbsp;<span class="op" id="5240655">!=</span>&nbsp;<span class="num" id="5240658">0</span>&nbsp;<span class="op" id="5240660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240666">j0</span>&nbsp;<span class="op" id="5240669">:=</span>&nbsp;<span class="op" id="5240672">(</span><span class="ident" id="5240673">y</span>&nbsp;<span class="op" id="5240675">-</span>&nbsp;<span class="ident" id="5240677">b</span><span class="op" id="5240678">.</span><span class="ident" id="5240679">Min</span><span class="op" id="5240682">.</span><span class="ident" id="5240683">Y</span><span class="op" id="5240684">)</span>&nbsp;<span class="op" id="5240686">*</span>&nbsp;<span class="ident" id="5240688">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240699">j1</span>&nbsp;<span class="op" id="5240702">:=</span>&nbsp;<span class="ident" id="5240705">j0</span>&nbsp;<span class="op" id="5240708">+</span>&nbsp;<span class="ident" id="5240710">b</span><span class="op" id="5240711">.</span><span class="ident" id="5240712">Dx</span><span class="op" id="5240714">(</span><span class="op" id="5240715">)</span><span class="op" id="5240716">*</span><span class="num" id="5240717">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240723">for</span>&nbsp;<span class="ident" id="5240727">j</span>&nbsp;<span class="op" id="5240729">:=</span>&nbsp;<span class="ident" id="5240732">j0</span><span class="op" id="5240734">;</span>&nbsp;<span class="ident" id="5240736">j</span>&nbsp;<span class="op" id="5240738">&lt;</span>&nbsp;<span class="ident" id="5240740">j1</span><span class="op" id="5240742">;</span>&nbsp;<span class="ident" id="5240744">j</span>&nbsp;<span class="op" id="5240746">+=</span>&nbsp;<span class="num" id="5240749">4</span>&nbsp;<span class="op" id="5240751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240758">cr0</span><span class="op" id="5240761">[</span><span class="ident" id="5240762">i</span><span class="op" id="5240763">+</span><span class="num" id="5240764">0</span><span class="op" id="5240765">]</span>&nbsp;<span class="op" id="5240767">=</span>&nbsp;<span class="ident" id="5240769">pix</span><span class="op" id="5240772">[</span><span class="ident" id="5240773">j</span><span class="op" id="5240774">+</span><span class="num" id="5240775">0</span><span class="op" id="5240776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240783">cr0</span><span class="op" id="5240786">[</span><span class="ident" id="5240787">i</span><span class="op" id="5240788">+</span><span class="num" id="5240789">1</span><span class="op" id="5240790">]</span>&nbsp;<span class="op" id="5240792">=</span>&nbsp;<span class="ident" id="5240794">pix</span><span class="op" id="5240797">[</span><span class="ident" id="5240798">j</span><span class="op" id="5240799">+</span><span class="num" id="5240800">1</span><span class="op" id="5240801">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240808">cr0</span><span class="op" id="5240811">[</span><span class="ident" id="5240812">i</span><span class="op" id="5240813">+</span><span class="num" id="5240814">2</span><span class="op" id="5240815">]</span>&nbsp;<span class="op" id="5240817">=</span>&nbsp;<span class="ident" id="5240819">pix</span><span class="op" id="5240822">[</span><span class="ident" id="5240823">j</span><span class="op" id="5240824">+</span><span class="num" id="5240825">2</span><span class="op" id="5240826">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240833">i</span>&nbsp;<span class="op" id="5240835">+=</span>&nbsp;<span class="num" id="5240838">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5240849">}</span>&nbsp;<span class="keyword" id="5240851">else</span>&nbsp;<span class="op" id="5240856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5240862">for</span>&nbsp;<span class="ident" id="5240866">x</span>&nbsp;<span class="op" id="5240868">:=</span>&nbsp;<span class="ident" id="5240871">b</span><span class="op" id="5240872">.</span><span class="ident" id="5240873">Min</span><span class="op" id="5240876">.</span><span class="ident" id="5240877">X</span><span class="op" id="5240878">;</span>&nbsp;<span class="ident" id="5240880">x</span>&nbsp;<span class="op" id="5240882">&lt;</span>&nbsp;<span class="ident" id="5240884">b</span><span class="op" id="5240885">.</span><span class="ident" id="5240886">Max</span><span class="op" id="5240889">.</span><span class="ident" id="5240890">X</span><span class="op" id="5240891">;</span>&nbsp;<span class="ident" id="5240893">x</span><span class="op" id="5240894">++</span>&nbsp;<span class="op" id="5240897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240904">r</span><span class="op" id="5240905">,</span>&nbsp;<span class="ident" id="5240907">g</span><span class="op" id="5240908">,</span>&nbsp;<span class="ident" id="5240910">b</span><span class="op" id="5240911">,</span>&nbsp;<span class="ident" id="5240913">_</span>&nbsp;<span class="op" id="5240915">:=</span>&nbsp;<span class="ident" id="5240918">m</span><span class="op" id="5240919">.</span><span class="ident" id="5240920">At</span><span class="op" id="5240922">(</span><span class="ident" id="5240923">x</span><span class="op" id="5240924">,</span>&nbsp;<span class="ident" id="5240926">y</span><span class="op" id="5240927">)</span><span class="op" id="5240928">.</span><span class="ident" id="5240929">RGBA</span><span class="op" id="5240933">(</span><span class="op" id="5240934">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240941">cr0</span><span class="op" id="5240944">[</span><span class="ident" id="5240945">i</span><span class="op" id="5240946">+</span><span class="num" id="5240947">0</span><span class="op" id="5240948">]</span>&nbsp;<span class="op" id="5240950">=</span>&nbsp;<span class="builtintype" id="5240952">uint8</span><span class="op" id="5240957">(</span><span class="ident" id="5240958">r</span>&nbsp;<span class="op" id="5240960">&gt;&gt;</span>&nbsp;<span class="num" id="5240963">8</span><span class="op" id="5240964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5240971">cr0</span><span class="op" id="5240974">[</span><span class="ident" id="5240975">i</span><span class="op" id="5240976">+</span><span class="num" id="5240977">1</span><span class="op" id="5240978">]</span>&nbsp;<span class="op" id="5240980">=</span>&nbsp;<span class="builtintype" id="5240982">uint8</span><span class="op" id="5240987">(</span><span class="ident" id="5240988">g</span>&nbsp;<span class="op" id="5240990">&gt;&gt;</span>&nbsp;<span class="num" id="5240993">8</span><span class="op" id="5240994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241001">cr0</span><span class="op" id="5241004">[</span><span class="ident" id="5241005">i</span><span class="op" id="5241006">+</span><span class="num" id="5241007">2</span><span class="op" id="5241008">]</span>&nbsp;<span class="op" id="5241010">=</span>&nbsp;<span class="builtintype" id="5241012">uint8</span><span class="op" id="5241017">(</span><span class="ident" id="5241018">b</span>&nbsp;<span class="op" id="5241020">&gt;&gt;</span>&nbsp;<span class="num" id="5241023">8</span><span class="op" id="5241024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241031">i</span>&nbsp;<span class="op" id="5241033">+=</span>&nbsp;<span class="num" id="5241036">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241042">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241051">case</span>&nbsp;<span class="ident" id="5241056">cbP8</span><span class="op" id="5241060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241065">if</span>&nbsp;<span class="ident" id="5241068">paletted</span>&nbsp;<span class="op" id="5241077">!=</span>&nbsp;<span class="builtintype" id="5241080">nil</span>&nbsp;<span class="op" id="5241084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241090">offset</span>&nbsp;<span class="op" id="5241097">:=</span>&nbsp;<span class="op" id="5241100">(</span><span class="ident" id="5241101">y</span>&nbsp;<span class="op" id="5241103">-</span>&nbsp;<span class="ident" id="5241105">b</span><span class="op" id="5241106">.</span><span class="ident" id="5241107">Min</span><span class="op" id="5241110">.</span><span class="ident" id="5241111">Y</span><span class="op" id="5241112">)</span>&nbsp;<span class="op" id="5241114">*</span>&nbsp;<span class="ident" id="5241116">paletted</span><span class="op" id="5241124">.</span><span class="ident" id="5241125">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5241136">copy</span><span class="op" id="5241140">(</span><span class="ident" id="5241141">cr</span><span class="op" id="5241143">[</span><span class="num" id="5241144">0</span><span class="op" id="5241145">]</span><span class="op" id="5241146">[</span><span class="num" id="5241147">1</span><span class="op" id="5241148">:</span><span class="op" id="5241149">]</span><span class="op" id="5241150">,</span>&nbsp;<span class="ident" id="5241152">paletted</span><span class="op" id="5241160">.</span><span class="ident" id="5241161">Pix</span><span class="op" id="5241164">[</span><span class="ident" id="5241165">offset</span><span class="op" id="5241171">:</span><span class="ident" id="5241172">offset</span><span class="op" id="5241178">+</span><span class="ident" id="5241179">b</span><span class="op" id="5241180">.</span><span class="ident" id="5241181">Dx</span><span class="op" id="5241183">(</span><span class="op" id="5241184">)</span><span class="op" id="5241185">]</span><span class="op" id="5241186">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241191">}</span>&nbsp;<span class="keyword" id="5241193">else</span>&nbsp;<span class="op" id="5241198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241204">pi</span>&nbsp;<span class="op" id="5241207">:=</span>&nbsp;<span class="ident" id="5241210">m</span><span class="op" id="5241211">.</span><span class="op" id="5241212">(</span><span class="ident" id="5241213">image</span><span class="op" id="5241218">.</span><span class="ident" id="5241219">PalettedImage</span><span class="op" id="5241232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241238">for</span>&nbsp;<span class="ident" id="5241242">x</span>&nbsp;<span class="op" id="5241244">:=</span>&nbsp;<span class="ident" id="5241247">b</span><span class="op" id="5241248">.</span><span class="ident" id="5241249">Min</span><span class="op" id="5241252">.</span><span class="ident" id="5241253">X</span><span class="op" id="5241254">;</span>&nbsp;<span class="ident" id="5241256">x</span>&nbsp;<span class="op" id="5241258">&lt;</span>&nbsp;<span class="ident" id="5241260">b</span><span class="op" id="5241261">.</span><span class="ident" id="5241262">Max</span><span class="op" id="5241265">.</span><span class="ident" id="5241266">X</span><span class="op" id="5241267">;</span>&nbsp;<span class="ident" id="5241269">x</span><span class="op" id="5241270">++</span>&nbsp;<span class="op" id="5241273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241280">cr</span><span class="op" id="5241282">[</span><span class="num" id="5241283">0</span><span class="op" id="5241284">]</span><span class="op" id="5241285">[</span><span class="ident" id="5241286">i</span><span class="op" id="5241287">]</span>&nbsp;<span class="op" id="5241289">=</span>&nbsp;<span class="ident" id="5241291">pi</span><span class="op" id="5241293">.</span><span class="ident" id="5241294">ColorIndexAt</span><span class="op" id="5241306">(</span><span class="ident" id="5241307">x</span><span class="op" id="5241308">,</span>&nbsp;<span class="ident" id="5241310">y</span><span class="op" id="5241311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241318">i</span>&nbsp;<span class="op" id="5241320">+=</span>&nbsp;<span class="num" id="5241323">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241338">case</span>&nbsp;<span class="ident" id="5241343">cbTCA8</span><span class="op" id="5241349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241354">if</span>&nbsp;<span class="ident" id="5241357">nrgba</span>&nbsp;<span class="op" id="5241363">!=</span>&nbsp;<span class="builtintype" id="5241366">nil</span>&nbsp;<span class="op" id="5241370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241376">offset</span>&nbsp;<span class="op" id="5241383">:=</span>&nbsp;<span class="op" id="5241386">(</span><span class="ident" id="5241387">y</span>&nbsp;<span class="op" id="5241389">-</span>&nbsp;<span class="ident" id="5241391">b</span><span class="op" id="5241392">.</span><span class="ident" id="5241393">Min</span><span class="op" id="5241396">.</span><span class="ident" id="5241397">Y</span><span class="op" id="5241398">)</span>&nbsp;<span class="op" id="5241400">*</span>&nbsp;<span class="ident" id="5241402">nrgba</span><span class="op" id="5241407">.</span><span class="ident" id="5241408">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5241419">copy</span><span class="op" id="5241423">(</span><span class="ident" id="5241424">cr</span><span class="op" id="5241426">[</span><span class="num" id="5241427">0</span><span class="op" id="5241428">]</span><span class="op" id="5241429">[</span><span class="num" id="5241430">1</span><span class="op" id="5241431">:</span><span class="op" id="5241432">]</span><span class="op" id="5241433">,</span>&nbsp;<span class="ident" id="5241435">nrgba</span><span class="op" id="5241440">.</span><span class="ident" id="5241441">Pix</span><span class="op" id="5241444">[</span><span class="ident" id="5241445">offset</span><span class="op" id="5241451">:</span><span class="ident" id="5241452">offset</span><span class="op" id="5241458">+</span><span class="ident" id="5241459">b</span><span class="op" id="5241460">.</span><span class="ident" id="5241461">Dx</span><span class="op" id="5241463">(</span><span class="op" id="5241464">)</span><span class="op" id="5241465">*</span><span class="num" id="5241466">4</span><span class="op" id="5241467">]</span><span class="op" id="5241468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241473">}</span>&nbsp;<span class="keyword" id="5241475">else</span>&nbsp;<span class="op" id="5241480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5241486">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241583">for</span>&nbsp;<span class="ident" id="5241587">x</span>&nbsp;<span class="op" id="5241589">:=</span>&nbsp;<span class="ident" id="5241592">b</span><span class="op" id="5241593">.</span><span class="ident" id="5241594">Min</span><span class="op" id="5241597">.</span><span class="ident" id="5241598">X</span><span class="op" id="5241599">;</span>&nbsp;<span class="ident" id="5241601">x</span>&nbsp;<span class="op" id="5241603">&lt;</span>&nbsp;<span class="ident" id="5241605">b</span><span class="op" id="5241606">.</span><span class="ident" id="5241607">Max</span><span class="op" id="5241610">.</span><span class="ident" id="5241611">X</span><span class="op" id="5241612">;</span>&nbsp;<span class="ident" id="5241614">x</span><span class="op" id="5241615">++</span>&nbsp;<span class="op" id="5241618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241625">c</span>&nbsp;<span class="op" id="5241627">:=</span>&nbsp;<span class="ident" id="5241630">color</span><span class="op" id="5241635">.</span><span class="ident" id="5241636">NRGBAModel</span><span class="op" id="5241646">.</span><span class="ident" id="5241647">Convert</span><span class="op" id="5241654">(</span><span class="ident" id="5241655">m</span><span class="op" id="5241656">.</span><span class="ident" id="5241657">At</span><span class="op" id="5241659">(</span><span class="ident" id="5241660">x</span><span class="op" id="5241661">,</span>&nbsp;<span class="ident" id="5241663">y</span><span class="op" id="5241664">)</span><span class="op" id="5241665">)</span><span class="op" id="5241666">.</span><span class="op" id="5241667">(</span><span class="ident" id="5241668">color</span><span class="op" id="5241673">.</span><span class="ident" id="5241674">NRGBA</span><span class="op" id="5241679">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241686">cr</span><span class="op" id="5241688">[</span><span class="num" id="5241689">0</span><span class="op" id="5241690">]</span><span class="op" id="5241691">[</span><span class="ident" id="5241692">i</span><span class="op" id="5241693">+</span><span class="num" id="5241694">0</span><span class="op" id="5241695">]</span>&nbsp;<span class="op" id="5241697">=</span>&nbsp;<span class="ident" id="5241699">c</span><span class="op" id="5241700">.</span><span class="ident" id="5241701">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241708">cr</span><span class="op" id="5241710">[</span><span class="num" id="5241711">0</span><span class="op" id="5241712">]</span><span class="op" id="5241713">[</span><span class="ident" id="5241714">i</span><span class="op" id="5241715">+</span><span class="num" id="5241716">1</span><span class="op" id="5241717">]</span>&nbsp;<span class="op" id="5241719">=</span>&nbsp;<span class="ident" id="5241721">c</span><span class="op" id="5241722">.</span><span class="ident" id="5241723">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241730">cr</span><span class="op" id="5241732">[</span><span class="num" id="5241733">0</span><span class="op" id="5241734">]</span><span class="op" id="5241735">[</span><span class="ident" id="5241736">i</span><span class="op" id="5241737">+</span><span class="num" id="5241738">2</span><span class="op" id="5241739">]</span>&nbsp;<span class="op" id="5241741">=</span>&nbsp;<span class="ident" id="5241743">c</span><span class="op" id="5241744">.</span><span class="ident" id="5241745">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241752">cr</span><span class="op" id="5241754">[</span><span class="num" id="5241755">0</span><span class="op" id="5241756">]</span><span class="op" id="5241757">[</span><span class="ident" id="5241758">i</span><span class="op" id="5241759">+</span><span class="num" id="5241760">3</span><span class="op" id="5241761">]</span>&nbsp;<span class="op" id="5241763">=</span>&nbsp;<span class="ident" id="5241765">c</span><span class="op" id="5241766">.</span><span class="ident" id="5241767">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241774">i</span>&nbsp;<span class="op" id="5241776">+=</span>&nbsp;<span class="num" id="5241779">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241794">case</span>&nbsp;<span class="ident" id="5241799">cbG16</span><span class="op" id="5241804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241809">for</span>&nbsp;<span class="ident" id="5241813">x</span>&nbsp;<span class="op" id="5241815">:=</span>&nbsp;<span class="ident" id="5241818">b</span><span class="op" id="5241819">.</span><span class="ident" id="5241820">Min</span><span class="op" id="5241823">.</span><span class="ident" id="5241824">X</span><span class="op" id="5241825">;</span>&nbsp;<span class="ident" id="5241827">x</span>&nbsp;<span class="op" id="5241829">&lt;</span>&nbsp;<span class="ident" id="5241831">b</span><span class="op" id="5241832">.</span><span class="ident" id="5241833">Max</span><span class="op" id="5241836">.</span><span class="ident" id="5241837">X</span><span class="op" id="5241838">;</span>&nbsp;<span class="ident" id="5241840">x</span><span class="op" id="5241841">++</span>&nbsp;<span class="op" id="5241844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241850">c</span>&nbsp;<span class="op" id="5241852">:=</span>&nbsp;<span class="ident" id="5241855">color</span><span class="op" id="5241860">.</span><span class="ident" id="5241861">Gray16Model</span><span class="op" id="5241872">.</span><span class="ident" id="5241873">Convert</span><span class="op" id="5241880">(</span><span class="ident" id="5241881">m</span><span class="op" id="5241882">.</span><span class="ident" id="5241883">At</span><span class="op" id="5241885">(</span><span class="ident" id="5241886">x</span><span class="op" id="5241887">,</span>&nbsp;<span class="ident" id="5241889">y</span><span class="op" id="5241890">)</span><span class="op" id="5241891">)</span><span class="op" id="5241892">.</span><span class="op" id="5241893">(</span><span class="ident" id="5241894">color</span><span class="op" id="5241899">.</span><span class="ident" id="5241900">Gray16</span><span class="op" id="5241906">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241912">cr</span><span class="op" id="5241914">[</span><span class="num" id="5241915">0</span><span class="op" id="5241916">]</span><span class="op" id="5241917">[</span><span class="ident" id="5241918">i</span><span class="op" id="5241919">+</span><span class="num" id="5241920">0</span><span class="op" id="5241921">]</span>&nbsp;<span class="op" id="5241923">=</span>&nbsp;<span class="builtintype" id="5241925">uint8</span><span class="op" id="5241930">(</span><span class="ident" id="5241931">c</span><span class="op" id="5241932">.</span><span class="ident" id="5241933">Y</span>&nbsp;<span class="op" id="5241935">&gt;&gt;</span>&nbsp;<span class="num" id="5241938">8</span><span class="op" id="5241939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241945">cr</span><span class="op" id="5241947">[</span><span class="num" id="5241948">0</span><span class="op" id="5241949">]</span><span class="op" id="5241950">[</span><span class="ident" id="5241951">i</span><span class="op" id="5241952">+</span><span class="num" id="5241953">1</span><span class="op" id="5241954">]</span>&nbsp;<span class="op" id="5241956">=</span>&nbsp;<span class="builtintype" id="5241958">uint8</span><span class="op" id="5241963">(</span><span class="ident" id="5241964">c</span><span class="op" id="5241965">.</span><span class="ident" id="5241966">Y</span><span class="op" id="5241967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5241973">i</span>&nbsp;<span class="op" id="5241975">+=</span>&nbsp;<span class="num" id="5241978">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5241983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5241987">case</span>&nbsp;<span class="ident" id="5241992">cbTC16</span><span class="op" id="5241998">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5242003">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5242075">for</span>&nbsp;<span class="ident" id="5242079">x</span>&nbsp;<span class="op" id="5242081">:=</span>&nbsp;<span class="ident" id="5242084">b</span><span class="op" id="5242085">.</span><span class="ident" id="5242086">Min</span><span class="op" id="5242089">.</span><span class="ident" id="5242090">X</span><span class="op" id="5242091">;</span>&nbsp;<span class="ident" id="5242093">x</span>&nbsp;<span class="op" id="5242095">&lt;</span>&nbsp;<span class="ident" id="5242097">b</span><span class="op" id="5242098">.</span><span class="ident" id="5242099">Max</span><span class="op" id="5242102">.</span><span class="ident" id="5242103">X</span><span class="op" id="5242104">;</span>&nbsp;<span class="ident" id="5242106">x</span><span class="op" id="5242107">++</span>&nbsp;<span class="op" id="5242110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242116">r</span><span class="op" id="5242117">,</span>&nbsp;<span class="ident" id="5242119">g</span><span class="op" id="5242120">,</span>&nbsp;<span class="ident" id="5242122">b</span><span class="op" id="5242123">,</span>&nbsp;<span class="ident" id="5242125">_</span>&nbsp;<span class="op" id="5242127">:=</span>&nbsp;<span class="ident" id="5242130">m</span><span class="op" id="5242131">.</span><span class="ident" id="5242132">At</span><span class="op" id="5242134">(</span><span class="ident" id="5242135">x</span><span class="op" id="5242136">,</span>&nbsp;<span class="ident" id="5242138">y</span><span class="op" id="5242139">)</span><span class="op" id="5242140">.</span><span class="ident" id="5242141">RGBA</span><span class="op" id="5242145">(</span><span class="op" id="5242146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242152">cr</span><span class="op" id="5242154">[</span><span class="num" id="5242155">0</span><span class="op" id="5242156">]</span><span class="op" id="5242157">[</span><span class="ident" id="5242158">i</span><span class="op" id="5242159">+</span><span class="num" id="5242160">0</span><span class="op" id="5242161">]</span>&nbsp;<span class="op" id="5242163">=</span>&nbsp;<span class="builtintype" id="5242165">uint8</span><span class="op" id="5242170">(</span><span class="ident" id="5242171">r</span>&nbsp;<span class="op" id="5242173">&gt;&gt;</span>&nbsp;<span class="num" id="5242176">8</span><span class="op" id="5242177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242183">cr</span><span class="op" id="5242185">[</span><span class="num" id="5242186">0</span><span class="op" id="5242187">]</span><span class="op" id="5242188">[</span><span class="ident" id="5242189">i</span><span class="op" id="5242190">+</span><span class="num" id="5242191">1</span><span class="op" id="5242192">]</span>&nbsp;<span class="op" id="5242194">=</span>&nbsp;<span class="builtintype" id="5242196">uint8</span><span class="op" id="5242201">(</span><span class="ident" id="5242202">r</span><span class="op" id="5242203">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242209">cr</span><span class="op" id="5242211">[</span><span class="num" id="5242212">0</span><span class="op" id="5242213">]</span><span class="op" id="5242214">[</span><span class="ident" id="5242215">i</span><span class="op" id="5242216">+</span><span class="num" id="5242217">2</span><span class="op" id="5242218">]</span>&nbsp;<span class="op" id="5242220">=</span>&nbsp;<span class="builtintype" id="5242222">uint8</span><span class="op" id="5242227">(</span><span class="ident" id="5242228">g</span>&nbsp;<span class="op" id="5242230">&gt;&gt;</span>&nbsp;<span class="num" id="5242233">8</span><span class="op" id="5242234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242240">cr</span><span class="op" id="5242242">[</span><span class="num" id="5242243">0</span><span class="op" id="5242244">]</span><span class="op" id="5242245">[</span><span class="ident" id="5242246">i</span><span class="op" id="5242247">+</span><span class="num" id="5242248">3</span><span class="op" id="5242249">]</span>&nbsp;<span class="op" id="5242251">=</span>&nbsp;<span class="builtintype" id="5242253">uint8</span><span class="op" id="5242258">(</span><span class="ident" id="5242259">g</span><span class="op" id="5242260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242266">cr</span><span class="op" id="5242268">[</span><span class="num" id="5242269">0</span><span class="op" id="5242270">]</span><span class="op" id="5242271">[</span><span class="ident" id="5242272">i</span><span class="op" id="5242273">+</span><span class="num" id="5242274">4</span><span class="op" id="5242275">]</span>&nbsp;<span class="op" id="5242277">=</span>&nbsp;<span class="builtintype" id="5242279">uint8</span><span class="op" id="5242284">(</span><span class="ident" id="5242285">b</span>&nbsp;<span class="op" id="5242287">&gt;&gt;</span>&nbsp;<span class="num" id="5242290">8</span><span class="op" id="5242291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242297">cr</span><span class="op" id="5242299">[</span><span class="num" id="5242300">0</span><span class="op" id="5242301">]</span><span class="op" id="5242302">[</span><span class="ident" id="5242303">i</span><span class="op" id="5242304">+</span><span class="num" id="5242305">5</span><span class="op" id="5242306">]</span>&nbsp;<span class="op" id="5242308">=</span>&nbsp;<span class="builtintype" id="5242310">uint8</span><span class="op" id="5242315">(</span><span class="ident" id="5242316">b</span><span class="op" id="5242317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242323">i</span>&nbsp;<span class="op" id="5242325">+=</span>&nbsp;<span class="num" id="5242328">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5242337">case</span>&nbsp;<span class="ident" id="5242342">cbTCA16</span><span class="op" id="5242349">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5242354">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5242450">for</span>&nbsp;<span class="ident" id="5242454">x</span>&nbsp;<span class="op" id="5242456">:=</span>&nbsp;<span class="ident" id="5242459">b</span><span class="op" id="5242460">.</span><span class="ident" id="5242461">Min</span><span class="op" id="5242464">.</span><span class="ident" id="5242465">X</span><span class="op" id="5242466">;</span>&nbsp;<span class="ident" id="5242468">x</span>&nbsp;<span class="op" id="5242470">&lt;</span>&nbsp;<span class="ident" id="5242472">b</span><span class="op" id="5242473">.</span><span class="ident" id="5242474">Max</span><span class="op" id="5242477">.</span><span class="ident" id="5242478">X</span><span class="op" id="5242479">;</span>&nbsp;<span class="ident" id="5242481">x</span><span class="op" id="5242482">++</span>&nbsp;<span class="op" id="5242485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242491">c</span>&nbsp;<span class="op" id="5242493">:=</span>&nbsp;<span class="ident" id="5242496">color</span><span class="op" id="5242501">.</span><span class="ident" id="5242502">NRGBA64Model</span><span class="op" id="5242514">.</span><span class="ident" id="5242515">Convert</span><span class="op" id="5242522">(</span><span class="ident" id="5242523">m</span><span class="op" id="5242524">.</span><span class="ident" id="5242525">At</span><span class="op" id="5242527">(</span><span class="ident" id="5242528">x</span><span class="op" id="5242529">,</span>&nbsp;<span class="ident" id="5242531">y</span><span class="op" id="5242532">)</span><span class="op" id="5242533">)</span><span class="op" id="5242534">.</span><span class="op" id="5242535">(</span><span class="ident" id="5242536">color</span><span class="op" id="5242541">.</span><span class="ident" id="5242542">NRGBA64</span><span class="op" id="5242549">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242555">cr</span><span class="op" id="5242557">[</span><span class="num" id="5242558">0</span><span class="op" id="5242559">]</span><span class="op" id="5242560">[</span><span class="ident" id="5242561">i</span><span class="op" id="5242562">+</span><span class="num" id="5242563">0</span><span class="op" id="5242564">]</span>&nbsp;<span class="op" id="5242566">=</span>&nbsp;<span class="builtintype" id="5242568">uint8</span><span class="op" id="5242573">(</span><span class="ident" id="5242574">c</span><span class="op" id="5242575">.</span><span class="ident" id="5242576">R</span>&nbsp;<span class="op" id="5242578">&gt;&gt;</span>&nbsp;<span class="num" id="5242581">8</span><span class="op" id="5242582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242588">cr</span><span class="op" id="5242590">[</span><span class="num" id="5242591">0</span><span class="op" id="5242592">]</span><span class="op" id="5242593">[</span><span class="ident" id="5242594">i</span><span class="op" id="5242595">+</span><span class="num" id="5242596">1</span><span class="op" id="5242597">]</span>&nbsp;<span class="op" id="5242599">=</span>&nbsp;<span class="builtintype" id="5242601">uint8</span><span class="op" id="5242606">(</span><span class="ident" id="5242607">c</span><span class="op" id="5242608">.</span><span class="ident" id="5242609">R</span><span class="op" id="5242610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242616">cr</span><span class="op" id="5242618">[</span><span class="num" id="5242619">0</span><span class="op" id="5242620">]</span><span class="op" id="5242621">[</span><span class="ident" id="5242622">i</span><span class="op" id="5242623">+</span><span class="num" id="5242624">2</span><span class="op" id="5242625">]</span>&nbsp;<span class="op" id="5242627">=</span>&nbsp;<span class="builtintype" id="5242629">uint8</span><span class="op" id="5242634">(</span><span class="ident" id="5242635">c</span><span class="op" id="5242636">.</span><span class="ident" id="5242637">G</span>&nbsp;<span class="op" id="5242639">&gt;&gt;</span>&nbsp;<span class="num" id="5242642">8</span><span class="op" id="5242643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242649">cr</span><span class="op" id="5242651">[</span><span class="num" id="5242652">0</span><span class="op" id="5242653">]</span><span class="op" id="5242654">[</span><span class="ident" id="5242655">i</span><span class="op" id="5242656">+</span><span class="num" id="5242657">3</span><span class="op" id="5242658">]</span>&nbsp;<span class="op" id="5242660">=</span>&nbsp;<span class="builtintype" id="5242662">uint8</span><span class="op" id="5242667">(</span><span class="ident" id="5242668">c</span><span class="op" id="5242669">.</span><span class="ident" id="5242670">G</span><span class="op" id="5242671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242677">cr</span><span class="op" id="5242679">[</span><span class="num" id="5242680">0</span><span class="op" id="5242681">]</span><span class="op" id="5242682">[</span><span class="ident" id="5242683">i</span><span class="op" id="5242684">+</span><span class="num" id="5242685">4</span><span class="op" id="5242686">]</span>&nbsp;<span class="op" id="5242688">=</span>&nbsp;<span class="builtintype" id="5242690">uint8</span><span class="op" id="5242695">(</span><span class="ident" id="5242696">c</span><span class="op" id="5242697">.</span><span class="ident" id="5242698">B</span>&nbsp;<span class="op" id="5242700">&gt;&gt;</span>&nbsp;<span class="num" id="5242703">8</span><span class="op" id="5242704">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242710">cr</span><span class="op" id="5242712">[</span><span class="num" id="5242713">0</span><span class="op" id="5242714">]</span><span class="op" id="5242715">[</span><span class="ident" id="5242716">i</span><span class="op" id="5242717">+</span><span class="num" id="5242718">5</span><span class="op" id="5242719">]</span>&nbsp;<span class="op" id="5242721">=</span>&nbsp;<span class="builtintype" id="5242723">uint8</span><span class="op" id="5242728">(</span><span class="ident" id="5242729">c</span><span class="op" id="5242730">.</span><span class="ident" id="5242731">B</span><span class="op" id="5242732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242738">cr</span><span class="op" id="5242740">[</span><span class="num" id="5242741">0</span><span class="op" id="5242742">]</span><span class="op" id="5242743">[</span><span class="ident" id="5242744">i</span><span class="op" id="5242745">+</span><span class="num" id="5242746">6</span><span class="op" id="5242747">]</span>&nbsp;<span class="op" id="5242749">=</span>&nbsp;<span class="builtintype" id="5242751">uint8</span><span class="op" id="5242756">(</span><span class="ident" id="5242757">c</span><span class="op" id="5242758">.</span><span class="ident" id="5242759">A</span>&nbsp;<span class="op" id="5242761">&gt;&gt;</span>&nbsp;<span class="num" id="5242764">8</span><span class="op" id="5242765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242771">cr</span><span class="op" id="5242773">[</span><span class="num" id="5242774">0</span><span class="op" id="5242775">]</span><span class="op" id="5242776">[</span><span class="ident" id="5242777">i</span><span class="op" id="5242778">+</span><span class="num" id="5242779">7</span><span class="op" id="5242780">]</span>&nbsp;<span class="op" id="5242782">=</span>&nbsp;<span class="builtintype" id="5242784">uint8</span><span class="op" id="5242789">(</span><span class="ident" id="5242790">c</span><span class="op" id="5242791">.</span><span class="ident" id="5242792">A</span><span class="op" id="5242793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242799">i</span>&nbsp;<span class="op" id="5242801">+=</span>&nbsp;<span class="num" id="5242804">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242809">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5242818">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242841">f</span>&nbsp;<span class="op" id="5242843">:=</span>&nbsp;<span class="ident" id="5242846">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5242855">if</span>&nbsp;<span class="ident" id="5242858">level</span>&nbsp;<span class="op" id="5242864">!=</span>&nbsp;<span class="ident" id="5242867">zlib</span><span class="op" id="5242871">.</span><span class="ident" id="5242872">NoCompression</span>&nbsp;<span class="op" id="5242886">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5242891">f</span>&nbsp;<span class="op" id="5242893">=</span>&nbsp;<span class="ident" id="5242895">filter</span><span class="op" id="5242901">(</span><span class="op" id="5242902">&amp;</span><span class="ident" id="5242903">cr</span><span class="op" id="5242905">,</span>&nbsp;<span class="ident" id="5242907">pr</span><span class="op" id="5242909">,</span>&nbsp;<span class="ident" id="5242911">bpp</span><span class="op" id="5242914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5242918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5242923">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5242956">if</span>&nbsp;<span class="ident" id="5242959">_</span><span class="op" id="5242960">,</span>&nbsp;<span class="ident" id="5242962">err</span>&nbsp;<span class="op" id="5242966">:=</span>&nbsp;<span class="ident" id="5242969">zw</span><span class="op" id="5242971">.</span><span class="ident" id="5242972">Write</span><span class="op" id="5242977">(</span><span class="ident" id="5242978">cr</span><span class="op" id="5242980">[</span><span class="ident" id="5242981">f</span><span class="op" id="5242982">]</span><span class="op" id="5242983">)</span><span class="op" id="5242984">;</span>&nbsp;<span class="ident" id="5242986">err</span>&nbsp;<span class="op" id="5242990">!=</span>&nbsp;<span class="builtintype" id="5242993">nil</span>&nbsp;<span class="op" id="5242997">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243002">return</span>&nbsp;<span class="ident" id="5243009">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5243020">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5243076">pr</span><span class="op" id="5243078">,</span>&nbsp;<span class="ident" id="5243080">cr</span><span class="op" id="5243082">[</span><span class="num" id="5243083">0</span><span class="op" id="5243084">]</span>&nbsp;<span class="op" id="5243086">=</span>&nbsp;<span class="ident" id="5243088">cr</span><span class="op" id="5243090">[</span><span class="num" id="5243091">0</span><span class="op" id="5243092">]</span><span class="op" id="5243093">,</span>&nbsp;<span class="ident" id="5243095">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243102">return</span>&nbsp;<span class="builtintype" id="5243109">nil</span><br>
<span class="lineno"></span><span class="op" id="5243113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243116">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5243175">func</span>&nbsp;<span class="op" id="5243180">(</span><span class="ident" id="5243181">e</span>&nbsp;<span class="op" id="5243183">*</span><span class="ident" id="5243184">encoder</span><span class="op" id="5243191">)</span>&nbsp;<span class="ident" id="5243193">writeIDATs</span><span class="op" id="5243203">(</span><span class="op" id="5243204">)</span>&nbsp;<span class="op" id="5243206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243209">if</span>&nbsp;<span class="ident" id="5243212">e</span><span class="op" id="5243213">.</span><span class="ident" id="5243214">err</span>&nbsp;<span class="op" id="5243218">!=</span>&nbsp;<span class="builtintype" id="5243221">nil</span>&nbsp;<span class="op" id="5243225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243229">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243240">var</span>&nbsp;<span class="ident" id="5243244">bw</span>&nbsp;<span class="op" id="5243247">*</span><span class="ident" id="5243248">bufio</span><span class="op" id="5243253">.</span><span class="ident" id="5243254">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5243262">bw</span>&nbsp;<span class="op" id="5243265">=</span>&nbsp;<span class="ident" id="5243267">bufio</span><span class="op" id="5243272">.</span><span class="ident" id="5243273">NewWriterSize</span><span class="op" id="5243286">(</span><span class="ident" id="5243287">e</span><span class="op" id="5243288">,</span>&nbsp;<span class="num" id="5243290">1</span><span class="op" id="5243291">&lt;&lt;</span><span class="num" id="5243293">15</span><span class="op" id="5243295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5243298">e</span><span class="op" id="5243299">.</span><span class="ident" id="5243300">err</span>&nbsp;<span class="op" id="5243304">=</span>&nbsp;<span class="ident" id="5243306">writeImage</span><span class="op" id="5243316">(</span><span class="ident" id="5243317">bw</span><span class="op" id="5243319">,</span>&nbsp;<span class="ident" id="5243321">e</span><span class="op" id="5243322">.</span><span class="ident" id="5243323">m</span><span class="op" id="5243324">,</span>&nbsp;<span class="ident" id="5243326">e</span><span class="op" id="5243327">.</span><span class="ident" id="5243328">cb</span><span class="op" id="5243330">,</span>&nbsp;<span class="ident" id="5243332">levelToZlib</span><span class="op" id="5243343">(</span><span class="ident" id="5243344">e</span><span class="op" id="5243345">.</span><span class="ident" id="5243346">enc</span><span class="op" id="5243349">.</span><span class="ident" id="5243350">CompressionLevel</span><span class="op" id="5243366">)</span><span class="op" id="5243367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243370">if</span>&nbsp;<span class="ident" id="5243373">e</span><span class="op" id="5243374">.</span><span class="ident" id="5243375">err</span>&nbsp;<span class="op" id="5243379">!=</span>&nbsp;<span class="builtintype" id="5243382">nil</span>&nbsp;<span class="op" id="5243386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243390">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243398">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5243401">e</span><span class="op" id="5243402">.</span><span class="ident" id="5243403">err</span>&nbsp;<span class="op" id="5243407">=</span>&nbsp;<span class="ident" id="5243409">bw</span><span class="op" id="5243411">.</span><span class="ident" id="5243412">Flush</span><span class="op" id="5243417">(</span><span class="op" id="5243418">)</span><br>
<span class="lineno"></span><span class="op" id="5243420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243423">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5243486">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5243549">func</span>&nbsp;<span class="ident" id="5243554">levelToZlib</span><span class="op" id="5243565">(</span><span class="ident" id="5243566">l</span>&nbsp;<span class="ident" id="5243568">CompressionLevel</span><span class="op" id="5243584">)</span>&nbsp;<span class="builtintype" id="5243586">int</span>&nbsp;<span class="op" id="5243590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243593">switch</span>&nbsp;<span class="ident" id="5243600">l</span>&nbsp;<span class="op" id="5243602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243605">case</span>&nbsp;<span class="ident" id="5243610">DefaultCompression</span><span class="op" id="5243628">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243632">return</span>&nbsp;<span class="ident" id="5243639">zlib</span><span class="op" id="5243643">.</span><span class="ident" id="5243644">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243664">case</span>&nbsp;<span class="ident" id="5243669">NoCompression</span><span class="op" id="5243682">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243686">return</span>&nbsp;<span class="ident" id="5243693">zlib</span><span class="op" id="5243697">.</span><span class="ident" id="5243698">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243713">case</span>&nbsp;<span class="ident" id="5243718">BestSpeed</span><span class="op" id="5243727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243731">return</span>&nbsp;<span class="ident" id="5243738">zlib</span><span class="op" id="5243742">.</span><span class="ident" id="5243743">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243754">case</span>&nbsp;<span class="ident" id="5243759">BestCompression</span><span class="op" id="5243774">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243778">return</span>&nbsp;<span class="ident" id="5243785">zlib</span><span class="op" id="5243789">.</span><span class="ident" id="5243790">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243807">default</span><span class="op" id="5243814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5243818">return</span>&nbsp;<span class="ident" id="5243825">zlib</span><span class="op" id="5243829">.</span><span class="ident" id="5243830">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5243850">}</span><br>
<span class="lineno"></span><span class="op" id="5243852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5243855">func</span>&nbsp;<span class="op" id="5243860">(</span><span class="ident" id="5243861">e</span>&nbsp;<span class="op" id="5243863">*</span><span class="ident" id="5243864">encoder</span><span class="op" id="5243871">)</span>&nbsp;<span class="ident" id="5243873">writeIEND</span><span class="op" id="5243882">(</span><span class="op" id="5243883">)</span>&nbsp;<span class="op" id="5243885">{</span>&nbsp;<span class="ident" id="5243887">e</span><span class="op" id="5243888">.</span><span class="ident" id="5243889">writeChunk</span><span class="op" id="5243899">(</span><span class="builtintype" id="5243900">nil</span><span class="op" id="5243903">,</span>&nbsp;<span class="string" id="5243905">&#34;IEND&#34;</span><span class="op" id="5243911">)</span>&nbsp;<span class="op" id="5243913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5243916">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5243982">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5244056">func</span>&nbsp;<span class="ident" id="5244061">Encode</span><span class="op" id="5244067">(</span><span class="ident" id="5244068">w</span>&nbsp;<span class="ident" id="5244070">io</span><span class="op" id="5244072">.</span><span class="ident" id="5244073">Writer</span><span class="op" id="5244079">,</span>&nbsp;<span class="ident" id="5244081">m</span>&nbsp;<span class="ident" id="5244083">image</span><span class="op" id="5244088">.</span><span class="ident" id="5244089">Image</span><span class="op" id="5244094">)</span>&nbsp;<span class="builtintype" id="5244096">error</span>&nbsp;<span class="op" id="5244102">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244105">var</span>&nbsp;<span class="ident" id="5244109">e</span>&nbsp;<span class="ident" id="5244111">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244120">return</span>&nbsp;<span class="ident" id="5244127">e</span><span class="op" id="5244128">.</span><span class="ident" id="5244129">Encode</span><span class="op" id="5244135">(</span><span class="ident" id="5244136">w</span><span class="op" id="5244137">,</span>&nbsp;<span class="ident" id="5244139">m</span><span class="op" id="5244140">)</span><br>
<span class="lineno"></span><span class="op" id="5244142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5244145">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5244194">func</span>&nbsp;<span class="op" id="5244199">(</span><span class="ident" id="5244200">enc</span>&nbsp;<span class="op" id="5244204">*</span><span class="ident" id="5244205">Encoder</span><span class="op" id="5244212">)</span>&nbsp;<span class="ident" id="5244214">Encode</span><span class="op" id="5244220">(</span><span class="ident" id="5244221">w</span>&nbsp;<span class="ident" id="5244223">io</span><span class="op" id="5244225">.</span><span class="ident" id="5244226">Writer</span><span class="op" id="5244232">,</span>&nbsp;<span class="ident" id="5244234">m</span>&nbsp;<span class="ident" id="5244236">image</span><span class="op" id="5244241">.</span><span class="ident" id="5244242">Image</span><span class="op" id="5244247">)</span>&nbsp;<span class="builtintype" id="5244249">error</span>&nbsp;<span class="op" id="5244255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5244258">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5244335">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5244415">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244434">mw</span><span class="op" id="5244436">,</span>&nbsp;<span class="ident" id="5244438">mh</span>&nbsp;<span class="op" id="5244441">:=</span>&nbsp;<span class="builtintype" id="5244444">int64</span><span class="op" id="5244449">(</span><span class="ident" id="5244450">m</span><span class="op" id="5244451">.</span><span class="ident" id="5244452">Bounds</span><span class="op" id="5244458">(</span><span class="op" id="5244459">)</span><span class="op" id="5244460">.</span><span class="ident" id="5244461">Dx</span><span class="op" id="5244463">(</span><span class="op" id="5244464">)</span><span class="op" id="5244465">)</span><span class="op" id="5244466">,</span>&nbsp;<span class="builtintype" id="5244468">int64</span><span class="op" id="5244473">(</span><span class="ident" id="5244474">m</span><span class="op" id="5244475">.</span><span class="ident" id="5244476">Bounds</span><span class="op" id="5244482">(</span><span class="op" id="5244483">)</span><span class="op" id="5244484">.</span><span class="ident" id="5244485">Dy</span><span class="op" id="5244487">(</span><span class="op" id="5244488">)</span><span class="op" id="5244489">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244492">if</span>&nbsp;<span class="ident" id="5244495">mw</span>&nbsp;<span class="op" id="5244498">&lt;=</span>&nbsp;<span class="num" id="5244501">0</span>&nbsp;<span class="op" id="5244503">||</span>&nbsp;<span class="ident" id="5244506">mh</span>&nbsp;<span class="op" id="5244509">&lt;=</span>&nbsp;<span class="num" id="5244512">0</span>&nbsp;<span class="op" id="5244514">||</span>&nbsp;<span class="ident" id="5244517">mw</span>&nbsp;<span class="op" id="5244520">&gt;=</span>&nbsp;<span class="num" id="5244523">1</span><span class="op" id="5244524">&lt;&lt;</span><span class="num" id="5244526">32</span>&nbsp;<span class="op" id="5244529">||</span>&nbsp;<span class="ident" id="5244532">mh</span>&nbsp;<span class="op" id="5244535">&gt;=</span>&nbsp;<span class="num" id="5244538">1</span><span class="op" id="5244539">&lt;&lt;</span><span class="num" id="5244541">32</span>&nbsp;<span class="op" id="5244544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244548">return</span>&nbsp;<span class="ident" id="5244555">FormatError</span><span class="op" id="5244566">(</span><span class="string" id="5244567">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5244590">+</span>&nbsp;<span class="ident" id="5244592">strconv</span><span class="op" id="5244599">.</span><span class="ident" id="5244600">FormatInt</span><span class="op" id="5244609">(</span><span class="ident" id="5244610">mw</span><span class="op" id="5244612">,</span>&nbsp;<span class="num" id="5244614">10</span><span class="op" id="5244616">)</span>&nbsp;<span class="op" id="5244618">+</span>&nbsp;<span class="string" id="5244620">&#34;x&#34;</span>&nbsp;<span class="op" id="5244624">+</span>&nbsp;<span class="ident" id="5244626">strconv</span><span class="op" id="5244633">.</span><span class="ident" id="5244634">FormatInt</span><span class="op" id="5244643">(</span><span class="ident" id="5244644">mh</span><span class="op" id="5244646">,</span>&nbsp;<span class="num" id="5244648">10</span><span class="op" id="5244650">)</span><span class="op" id="5244651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5244654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244658">var</span>&nbsp;<span class="ident" id="5244662">e</span>&nbsp;<span class="ident" id="5244664">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244673">e</span><span class="op" id="5244674">.</span><span class="ident" id="5244675">enc</span>&nbsp;<span class="op" id="5244679">=</span>&nbsp;<span class="ident" id="5244681">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244686">e</span><span class="op" id="5244687">.</span><span class="ident" id="5244688">w</span>&nbsp;<span class="op" id="5244690">=</span>&nbsp;<span class="ident" id="5244692">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244695">e</span><span class="op" id="5244696">.</span><span class="ident" id="5244697">m</span>&nbsp;<span class="op" id="5244699">=</span>&nbsp;<span class="ident" id="5244701">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244705">var</span>&nbsp;<span class="ident" id="5244709">pal</span>&nbsp;<span class="ident" id="5244713">color</span><span class="op" id="5244718">.</span><span class="ident" id="5244719">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5244728">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244789">if</span>&nbsp;<span class="ident" id="5244792">_</span><span class="op" id="5244793">,</span>&nbsp;<span class="ident" id="5244795">ok</span>&nbsp;<span class="op" id="5244798">:=</span>&nbsp;<span class="ident" id="5244801">m</span><span class="op" id="5244802">.</span><span class="op" id="5244803">(</span><span class="ident" id="5244804">image</span><span class="op" id="5244809">.</span><span class="ident" id="5244810">PalettedImage</span><span class="op" id="5244823">)</span><span class="op" id="5244824">;</span>&nbsp;<span class="ident" id="5244826">ok</span>&nbsp;<span class="op" id="5244829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244833">pal</span><span class="op" id="5244836">,</span>&nbsp;<span class="ident" id="5244838">_</span>&nbsp;<span class="op" id="5244840">=</span>&nbsp;<span class="ident" id="5244842">m</span><span class="op" id="5244843">.</span><span class="ident" id="5244844">ColorModel</span><span class="op" id="5244854">(</span><span class="op" id="5244855">)</span><span class="op" id="5244856">.</span><span class="op" id="5244857">(</span><span class="ident" id="5244858">color</span><span class="op" id="5244863">.</span><span class="ident" id="5244864">Palette</span><span class="op" id="5244871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5244874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244877">if</span>&nbsp;<span class="ident" id="5244880">pal</span>&nbsp;<span class="op" id="5244884">!=</span>&nbsp;<span class="builtintype" id="5244887">nil</span>&nbsp;<span class="op" id="5244891">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244895">e</span><span class="op" id="5244896">.</span><span class="ident" id="5244897">cb</span>&nbsp;<span class="op" id="5244900">=</span>&nbsp;<span class="ident" id="5244902">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5244908">}</span>&nbsp;<span class="keyword" id="5244910">else</span>&nbsp;<span class="op" id="5244915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244919">switch</span>&nbsp;<span class="ident" id="5244926">m</span><span class="op" id="5244927">.</span><span class="ident" id="5244928">ColorModel</span><span class="op" id="5244938">(</span><span class="op" id="5244939">)</span>&nbsp;<span class="op" id="5244941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244945">case</span>&nbsp;<span class="ident" id="5244950">color</span><span class="op" id="5244955">.</span><span class="ident" id="5244956">GrayModel</span><span class="op" id="5244965">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5244970">e</span><span class="op" id="5244971">.</span><span class="ident" id="5244972">cb</span>&nbsp;<span class="op" id="5244975">=</span>&nbsp;<span class="ident" id="5244977">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5244984">case</span>&nbsp;<span class="ident" id="5244989">color</span><span class="op" id="5244994">.</span><span class="ident" id="5244995">Gray16Model</span><span class="op" id="5245006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245011">e</span><span class="op" id="5245012">.</span><span class="ident" id="5245013">cb</span>&nbsp;<span class="op" id="5245016">=</span>&nbsp;<span class="ident" id="5245018">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245026">case</span>&nbsp;<span class="ident" id="5245031">color</span><span class="op" id="5245036">.</span><span class="ident" id="5245037">RGBAModel</span><span class="op" id="5245046">,</span>&nbsp;<span class="ident" id="5245048">color</span><span class="op" id="5245053">.</span><span class="ident" id="5245054">NRGBAModel</span><span class="op" id="5245064">,</span>&nbsp;<span class="ident" id="5245066">color</span><span class="op" id="5245071">.</span><span class="ident" id="5245072">AlphaModel</span><span class="op" id="5245082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245087">if</span>&nbsp;<span class="ident" id="5245090">opaque</span><span class="op" id="5245096">(</span><span class="ident" id="5245097">m</span><span class="op" id="5245098">)</span>&nbsp;<span class="op" id="5245100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245106">e</span><span class="op" id="5245107">.</span><span class="ident" id="5245108">cb</span>&nbsp;<span class="op" id="5245111">=</span>&nbsp;<span class="ident" id="5245113">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245122">}</span>&nbsp;<span class="keyword" id="5245124">else</span>&nbsp;<span class="op" id="5245129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245135">e</span><span class="op" id="5245136">.</span><span class="ident" id="5245137">cb</span>&nbsp;<span class="op" id="5245140">=</span>&nbsp;<span class="ident" id="5245142">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245156">default</span><span class="op" id="5245163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245168">if</span>&nbsp;<span class="ident" id="5245171">opaque</span><span class="op" id="5245177">(</span><span class="ident" id="5245178">m</span><span class="op" id="5245179">)</span>&nbsp;<span class="op" id="5245181">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245187">e</span><span class="op" id="5245188">.</span><span class="ident" id="5245189">cb</span>&nbsp;<span class="op" id="5245192">=</span>&nbsp;<span class="ident" id="5245194">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245204">}</span>&nbsp;<span class="keyword" id="5245206">else</span>&nbsp;<span class="op" id="5245211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245217">e</span><span class="op" id="5245218">.</span><span class="ident" id="5245219">cb</span>&nbsp;<span class="op" id="5245222">=</span>&nbsp;<span class="ident" id="5245224">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245239">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245246">_</span><span class="op" id="5245247">,</span>&nbsp;<span class="ident" id="5245249">e</span><span class="op" id="5245250">.</span><span class="ident" id="5245251">err</span>&nbsp;<span class="op" id="5245255">=</span>&nbsp;<span class="ident" id="5245257">io</span><span class="op" id="5245259">.</span><span class="ident" id="5245260">WriteString</span><span class="op" id="5245271">(</span><span class="ident" id="5245272">w</span><span class="op" id="5245273">,</span>&nbsp;<span class="ident" id="5245275">pngHeader</span><span class="op" id="5245284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245287">e</span><span class="op" id="5245288">.</span><span class="ident" id="5245289">writeIHDR</span><span class="op" id="5245298">(</span><span class="op" id="5245299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245302">if</span>&nbsp;<span class="ident" id="5245305">pal</span>&nbsp;<span class="op" id="5245309">!=</span>&nbsp;<span class="builtintype" id="5245312">nil</span>&nbsp;<span class="op" id="5245316">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245320">e</span><span class="op" id="5245321">.</span><span class="ident" id="5245322">writePLTEAndTRNS</span><span class="op" id="5245338">(</span><span class="ident" id="5245339">pal</span><span class="op" id="5245342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5245345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245348">e</span><span class="op" id="5245349">.</span><span class="ident" id="5245350">writeIDATs</span><span class="op" id="5245360">(</span><span class="op" id="5245361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5245364">e</span><span class="op" id="5245365">.</span><span class="ident" id="5245366">writeIEND</span><span class="op" id="5245375">(</span><span class="op" id="5245376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5245379">return</span>&nbsp;<span class="ident" id="5245386">e</span><span class="op" id="5245387">.</span><span class="ident" id="5245388">err</span><br>
<span class="lineno">530</span><span class="op" id="5245392">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
