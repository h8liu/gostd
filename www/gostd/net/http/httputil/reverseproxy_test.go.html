<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7738691">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7738746">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7738800">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7738851">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7738876">package</span>&nbsp;<span class="ident" id="7738884">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7738894">import</span>&nbsp;<span class="op" id="7738901">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738904">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738917">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738929">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738950">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738961">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738972">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7738983">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7738990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7738993">const</span>&nbsp;<span class="ident" id="7738999">fakeHopHeader</span>&nbsp;<span class="op" id="7739013">=</span>&nbsp;<span class="string" id="7739015">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7739045">func</span>&nbsp;<span class="ident" id="7739050">init</span><span class="op" id="7739054">(</span><span class="op" id="7739055">)</span>&nbsp;<span class="op" id="7739057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739060">hopHeaders</span>&nbsp;<span class="op" id="7739071">=</span>&nbsp;<span class="builtinfunc" id="7739073">append</span><span class="op" id="7739079">(</span><span class="ident" id="7739080">hopHeaders</span><span class="op" id="7739090">,</span>&nbsp;<span class="ident" id="7739092">fakeHopHeader</span><span class="op" id="7739105">)</span><br>
<span class="lineno"></span><span class="op" id="7739107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7739110">func</span>&nbsp;<span class="ident" id="7739115">TestReverseProxy</span><span class="op" id="7739131">(</span><span class="ident" id="7739132">t</span>&nbsp;<span class="op" id="7739134">*</span><span class="ident" id="7739135">testing</span><span class="op" id="7739142">.</span><span class="ident" id="7739143">T</span><span class="op" id="7739144">)</span>&nbsp;<span class="op" id="7739146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739149">const</span>&nbsp;<span class="ident" id="7739155">backendResponse</span>&nbsp;<span class="op" id="7739171">=</span>&nbsp;<span class="string" id="7739173">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739193">const</span>&nbsp;<span class="ident" id="7739199">backendStatus</span>&nbsp;<span class="op" id="7739213">=</span>&nbsp;<span class="num" id="7739215">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739220">backend</span>&nbsp;<span class="op" id="7739228">:=</span>&nbsp;<span class="ident" id="7739231">httptest</span><span class="op" id="7739239">.</span><span class="ident" id="7739240">NewServer</span><span class="op" id="7739249">(</span><span class="ident" id="7739250">http</span><span class="op" id="7739254">.</span><span class="ident" id="7739255">HandlerFunc</span><span class="op" id="7739266">(</span><span class="keyword" id="7739267">func</span><span class="op" id="7739271">(</span><span class="ident" id="7739272">w</span>&nbsp;<span class="ident" id="7739274">http</span><span class="op" id="7739278">.</span><span class="ident" id="7739279">ResponseWriter</span><span class="op" id="7739293">,</span>&nbsp;<span class="ident" id="7739295">r</span>&nbsp;<span class="op" id="7739297">*</span><span class="ident" id="7739298">http</span><span class="op" id="7739302">.</span><span class="ident" id="7739303">Request</span><span class="op" id="7739310">)</span>&nbsp;<span class="op" id="7739312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739316">if</span>&nbsp;<span class="builtinfunc" id="7739319">len</span><span class="op" id="7739322">(</span><span class="ident" id="7739323">r</span><span class="op" id="7739324">.</span><span class="ident" id="7739325">TransferEncoding</span><span class="op" id="7739341">)</span>&nbsp;<span class="op" id="7739343">&gt;</span>&nbsp;<span class="num" id="7739345">0</span>&nbsp;<span class="op" id="7739347">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739352">t</span><span class="op" id="7739353">.</span><span class="ident" id="7739354">Errorf</span><span class="op" id="7739360">(</span><span class="string" id="7739361">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="7739406">,</span>&nbsp;<span class="ident" id="7739408">r</span><span class="op" id="7739409">.</span><span class="ident" id="7739410">TransferEncoding</span><span class="op" id="7739426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739434">if</span>&nbsp;<span class="ident" id="7739437">r</span><span class="op" id="7739438">.</span><span class="ident" id="7739439">Header</span><span class="op" id="7739445">.</span><span class="ident" id="7739446">Get</span><span class="op" id="7739449">(</span><span class="string" id="7739450">&#34;X-Forwarded-For&#34;</span><span class="op" id="7739467">)</span>&nbsp;<span class="op" id="7739469">==</span>&nbsp;<span class="string" id="7739472">&#34;&#34;</span>&nbsp;<span class="op" id="7739475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739480">t</span><span class="op" id="7739481">.</span><span class="ident" id="7739482">Errorf</span><span class="op" id="7739488">(</span><span class="string" id="7739489">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7739524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739528">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739532">if</span>&nbsp;<span class="ident" id="7739535">c</span>&nbsp;<span class="op" id="7739537">:=</span>&nbsp;<span class="ident" id="7739540">r</span><span class="op" id="7739541">.</span><span class="ident" id="7739542">Header</span><span class="op" id="7739548">.</span><span class="ident" id="7739549">Get</span><span class="op" id="7739552">(</span><span class="string" id="7739553">&#34;Connection&#34;</span><span class="op" id="7739565">)</span><span class="op" id="7739566">;</span>&nbsp;<span class="ident" id="7739568">c</span>&nbsp;<span class="op" id="7739570">!=</span>&nbsp;<span class="string" id="7739573">&#34;&#34;</span>&nbsp;<span class="op" id="7739576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739581">t</span><span class="op" id="7739582">.</span><span class="ident" id="7739583">Errorf</span><span class="op" id="7739589">(</span><span class="string" id="7739590">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7739630">,</span>&nbsp;<span class="ident" id="7739632">c</span><span class="op" id="7739633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739641">if</span>&nbsp;<span class="ident" id="7739644">c</span>&nbsp;<span class="op" id="7739646">:=</span>&nbsp;<span class="ident" id="7739649">r</span><span class="op" id="7739650">.</span><span class="ident" id="7739651">Header</span><span class="op" id="7739657">.</span><span class="ident" id="7739658">Get</span><span class="op" id="7739661">(</span><span class="string" id="7739662">&#34;Upgrade&#34;</span><span class="op" id="7739671">)</span><span class="op" id="7739672">;</span>&nbsp;<span class="ident" id="7739674">c</span>&nbsp;<span class="op" id="7739676">!=</span>&nbsp;<span class="string" id="7739679">&#34;&#34;</span>&nbsp;<span class="op" id="7739682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739687">t</span><span class="op" id="7739688">.</span><span class="ident" id="7739689">Errorf</span><span class="op" id="7739695">(</span><span class="string" id="7739696">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7739733">,</span>&nbsp;<span class="ident" id="7739735">c</span><span class="op" id="7739736">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7739744">if</span>&nbsp;<span class="ident" id="7739747">g</span><span class="op" id="7739748">,</span>&nbsp;<span class="ident" id="7739750">e</span>&nbsp;<span class="op" id="7739752">:=</span>&nbsp;<span class="ident" id="7739755">r</span><span class="op" id="7739756">.</span><span class="ident" id="7739757">Host</span><span class="op" id="7739761">,</span>&nbsp;<span class="string" id="7739763">&#34;some-name&#34;</span><span class="op" id="7739774">;</span>&nbsp;<span class="ident" id="7739776">g</span>&nbsp;<span class="op" id="7739778">!=</span>&nbsp;<span class="ident" id="7739781">e</span>&nbsp;<span class="op" id="7739783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739788">t</span><span class="op" id="7739789">.</span><span class="ident" id="7739790">Errorf</span><span class="op" id="7739796">(</span><span class="string" id="7739797">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7739834">,</span>&nbsp;<span class="ident" id="7739836">g</span><span class="op" id="7739837">,</span>&nbsp;<span class="ident" id="7739839">e</span><span class="op" id="7739840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7739844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739848">w</span><span class="op" id="7739849">.</span><span class="ident" id="7739850">Header</span><span class="op" id="7739856">(</span><span class="op" id="7739857">)</span><span class="op" id="7739858">.</span><span class="ident" id="7739859">Set</span><span class="op" id="7739862">(</span><span class="string" id="7739863">&#34;X-Foo&#34;</span><span class="op" id="7739870">,</span>&nbsp;<span class="string" id="7739872">&#34;bar&#34;</span><span class="op" id="7739877">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739881">w</span><span class="op" id="7739882">.</span><span class="ident" id="7739883">Header</span><span class="op" id="7739889">(</span><span class="op" id="7739890">)</span><span class="op" id="7739891">.</span><span class="ident" id="7739892">Set</span><span class="op" id="7739895">(</span><span class="string" id="7739896">&#34;Upgrade&#34;</span><span class="op" id="7739905">,</span>&nbsp;<span class="string" id="7739907">&#34;foo&#34;</span><span class="op" id="7739912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739916">w</span><span class="op" id="7739917">.</span><span class="ident" id="7739918">Header</span><span class="op" id="7739924">(</span><span class="op" id="7739925">)</span><span class="op" id="7739926">.</span><span class="ident" id="7739927">Set</span><span class="op" id="7739930">(</span><span class="ident" id="7739931">fakeHopHeader</span><span class="op" id="7739944">,</span>&nbsp;<span class="string" id="7739946">&#34;foo&#34;</span><span class="op" id="7739951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739955">w</span><span class="op" id="7739956">.</span><span class="ident" id="7739957">Header</span><span class="op" id="7739963">(</span><span class="op" id="7739964">)</span><span class="op" id="7739965">.</span><span class="ident" id="7739966">Add</span><span class="op" id="7739969">(</span><span class="string" id="7739970">&#34;X-Multi-Value&#34;</span><span class="op" id="7739985">,</span>&nbsp;<span class="string" id="7739987">&#34;foo&#34;</span><span class="op" id="7739992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7739996">w</span><span class="op" id="7739997">.</span><span class="ident" id="7739998">Header</span><span class="op" id="7740004">(</span><span class="op" id="7740005">)</span><span class="op" id="7740006">.</span><span class="ident" id="7740007">Add</span><span class="op" id="7740010">(</span><span class="string" id="7740011">&#34;X-Multi-Value&#34;</span><span class="op" id="7740026">,</span>&nbsp;<span class="string" id="7740028">&#34;bar&#34;</span><span class="op" id="7740033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740037">http</span><span class="op" id="7740041">.</span><span class="ident" id="7740042">SetCookie</span><span class="op" id="7740051">(</span><span class="ident" id="7740052">w</span><span class="op" id="7740053">,</span>&nbsp;<span class="op" id="7740055">&amp;</span><span class="ident" id="7740056">http</span><span class="op" id="7740060">.</span><span class="ident" id="7740061">Cookie</span><span class="op" id="7740067">{</span><span class="ident" id="7740068">Name</span><span class="op" id="7740072">:</span>&nbsp;<span class="string" id="7740074">&#34;flavor&#34;</span><span class="op" id="7740082">,</span>&nbsp;<span class="ident" id="7740084">Value</span><span class="op" id="7740089">:</span>&nbsp;<span class="string" id="7740091">&#34;chocolateChip&#34;</span><span class="op" id="7740106">}</span><span class="op" id="7740107">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740111">w</span><span class="op" id="7740112">.</span><span class="ident" id="7740113">WriteHeader</span><span class="op" id="7740124">(</span><span class="ident" id="7740125">backendStatus</span><span class="op" id="7740138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740142">w</span><span class="op" id="7740143">.</span><span class="ident" id="7740144">Write</span><span class="op" id="7740149">(</span><span class="op" id="7740150">[</span><span class="op" id="7740151">]</span><span class="builtintype" id="7740152">byte</span><span class="op" id="7740156">(</span><span class="ident" id="7740157">backendResponse</span><span class="op" id="7740172">)</span><span class="op" id="7740173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740176">}</span><span class="op" id="7740177">)</span><span class="op" id="7740178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740181">defer</span>&nbsp;<span class="ident" id="7740187">backend</span><span class="op" id="7740194">.</span><span class="ident" id="7740195">Close</span><span class="op" id="7740200">(</span><span class="op" id="7740201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740204">backendURL</span><span class="op" id="7740214">,</span>&nbsp;<span class="ident" id="7740216">err</span>&nbsp;<span class="op" id="7740220">:=</span>&nbsp;<span class="ident" id="7740223">url</span><span class="op" id="7740226">.</span><span class="ident" id="7740227">Parse</span><span class="op" id="7740232">(</span><span class="ident" id="7740233">backend</span><span class="op" id="7740240">.</span><span class="ident" id="7740241">URL</span><span class="op" id="7740244">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740247">if</span>&nbsp;<span class="ident" id="7740250">err</span>&nbsp;<span class="op" id="7740254">!=</span>&nbsp;<span class="ident" id="7740257">nil</span>&nbsp;<span class="op" id="7740261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740265">t</span><span class="op" id="7740266">.</span><span class="ident" id="7740267">Fatal</span><span class="op" id="7740272">(</span><span class="ident" id="7740273">err</span><span class="op" id="7740276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740282">proxyHandler</span>&nbsp;<span class="op" id="7740295">:=</span>&nbsp;<span class="ident" id="7740298">NewSingleHostReverseProxy</span><span class="op" id="7740323">(</span><span class="ident" id="7740324">backendURL</span><span class="op" id="7740334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740337">frontend</span>&nbsp;<span class="op" id="7740346">:=</span>&nbsp;<span class="ident" id="7740349">httptest</span><span class="op" id="7740357">.</span><span class="ident" id="7740358">NewServer</span><span class="op" id="7740367">(</span><span class="ident" id="7740368">proxyHandler</span><span class="op" id="7740380">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740383">defer</span>&nbsp;<span class="ident" id="7740389">frontend</span><span class="op" id="7740397">.</span><span class="ident" id="7740398">Close</span><span class="op" id="7740403">(</span><span class="op" id="7740404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740408">getReq</span><span class="op" id="7740414">,</span>&nbsp;<span class="ident" id="7740416">_</span>&nbsp;<span class="op" id="7740418">:=</span>&nbsp;<span class="ident" id="7740421">http</span><span class="op" id="7740425">.</span><span class="ident" id="7740426">NewRequest</span><span class="op" id="7740436">(</span><span class="string" id="7740437">&#34;GET&#34;</span><span class="op" id="7740442">,</span>&nbsp;<span class="ident" id="7740444">frontend</span><span class="op" id="7740452">.</span><span class="ident" id="7740453">URL</span><span class="op" id="7740456">,</span>&nbsp;<span class="ident" id="7740458">nil</span><span class="op" id="7740461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740464">getReq</span><span class="op" id="7740470">.</span><span class="ident" id="7740471">Host</span>&nbsp;<span class="op" id="7740476">=</span>&nbsp;<span class="string" id="7740478">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740491">getReq</span><span class="op" id="7740497">.</span><span class="ident" id="7740498">Header</span><span class="op" id="7740504">.</span><span class="ident" id="7740505">Set</span><span class="op" id="7740508">(</span><span class="string" id="7740509">&#34;Connection&#34;</span><span class="op" id="7740521">,</span>&nbsp;<span class="string" id="7740523">&#34;close&#34;</span><span class="op" id="7740530">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740533">getReq</span><span class="op" id="7740539">.</span><span class="ident" id="7740540">Header</span><span class="op" id="7740546">.</span><span class="ident" id="7740547">Set</span><span class="op" id="7740550">(</span><span class="string" id="7740551">&#34;Upgrade&#34;</span><span class="op" id="7740560">,</span>&nbsp;<span class="string" id="7740562">&#34;foo&#34;</span><span class="op" id="7740567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740570">getReq</span><span class="op" id="7740576">.</span><span class="ident" id="7740577">Close</span>&nbsp;<span class="op" id="7740583">=</span>&nbsp;<span class="builtintype" id="7740585">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740591">res</span><span class="op" id="7740594">,</span>&nbsp;<span class="ident" id="7740596">err</span>&nbsp;<span class="op" id="7740600">:=</span>&nbsp;<span class="ident" id="7740603">http</span><span class="op" id="7740607">.</span><span class="ident" id="7740608">DefaultClient</span><span class="op" id="7740621">.</span><span class="ident" id="7740622">Do</span><span class="op" id="7740624">(</span><span class="ident" id="7740625">getReq</span><span class="op" id="7740631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740634">if</span>&nbsp;<span class="ident" id="7740637">err</span>&nbsp;<span class="op" id="7740641">!=</span>&nbsp;<span class="ident" id="7740644">nil</span>&nbsp;<span class="op" id="7740648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740652">t</span><span class="op" id="7740653">.</span><span class="ident" id="7740654">Fatalf</span><span class="op" id="7740660">(</span><span class="string" id="7740661">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7740670">,</span>&nbsp;<span class="ident" id="7740672">err</span><span class="op" id="7740675">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740681">if</span>&nbsp;<span class="ident" id="7740684">g</span><span class="op" id="7740685">,</span>&nbsp;<span class="ident" id="7740687">e</span>&nbsp;<span class="op" id="7740689">:=</span>&nbsp;<span class="ident" id="7740692">res</span><span class="op" id="7740695">.</span><span class="ident" id="7740696">StatusCode</span><span class="op" id="7740706">,</span>&nbsp;<span class="ident" id="7740708">backendStatus</span><span class="op" id="7740721">;</span>&nbsp;<span class="ident" id="7740723">g</span>&nbsp;<span class="op" id="7740725">!=</span>&nbsp;<span class="ident" id="7740728">e</span>&nbsp;<span class="op" id="7740730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740734">t</span><span class="op" id="7740735">.</span><span class="ident" id="7740736">Errorf</span><span class="op" id="7740742">(</span><span class="string" id="7740743">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7740779">,</span>&nbsp;<span class="ident" id="7740781">g</span><span class="op" id="7740782">,</span>&nbsp;<span class="ident" id="7740784">e</span><span class="op" id="7740785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740791">if</span>&nbsp;<span class="ident" id="7740794">g</span><span class="op" id="7740795">,</span>&nbsp;<span class="ident" id="7740797">e</span>&nbsp;<span class="op" id="7740799">:=</span>&nbsp;<span class="ident" id="7740802">res</span><span class="op" id="7740805">.</span><span class="ident" id="7740806">Header</span><span class="op" id="7740812">.</span><span class="ident" id="7740813">Get</span><span class="op" id="7740816">(</span><span class="string" id="7740817">&#34;X-Foo&#34;</span><span class="op" id="7740824">)</span><span class="op" id="7740825">,</span>&nbsp;<span class="string" id="7740827">&#34;bar&#34;</span><span class="op" id="7740832">;</span>&nbsp;<span class="ident" id="7740834">g</span>&nbsp;<span class="op" id="7740836">!=</span>&nbsp;<span class="ident" id="7740839">e</span>&nbsp;<span class="op" id="7740841">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740845">t</span><span class="op" id="7740846">.</span><span class="ident" id="7740847">Errorf</span><span class="op" id="7740853">(</span><span class="string" id="7740854">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7740881">,</span>&nbsp;<span class="ident" id="7740883">g</span><span class="op" id="7740884">,</span>&nbsp;<span class="ident" id="7740886">e</span><span class="op" id="7740887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7740893">if</span>&nbsp;<span class="ident" id="7740896">c</span>&nbsp;<span class="op" id="7740898">:=</span>&nbsp;<span class="ident" id="7740901">res</span><span class="op" id="7740904">.</span><span class="ident" id="7740905">Header</span><span class="op" id="7740911">.</span><span class="ident" id="7740912">Get</span><span class="op" id="7740915">(</span><span class="ident" id="7740916">fakeHopHeader</span><span class="op" id="7740929">)</span><span class="op" id="7740930">;</span>&nbsp;<span class="ident" id="7740932">c</span>&nbsp;<span class="op" id="7740934">!=</span>&nbsp;<span class="string" id="7740937">&#34;&#34;</span>&nbsp;<span class="op" id="7740940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7740944">t</span><span class="op" id="7740945">.</span><span class="ident" id="7740946">Errorf</span><span class="op" id="7740952">(</span><span class="string" id="7740953">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="7740977">,</span>&nbsp;<span class="ident" id="7740979">fakeHopHeader</span><span class="op" id="7740992">,</span>&nbsp;<span class="ident" id="7740994">c</span><span class="op" id="7740995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7740998">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741001">if</span>&nbsp;<span class="ident" id="7741004">g</span><span class="op" id="7741005">,</span>&nbsp;<span class="ident" id="7741007">e</span>&nbsp;<span class="op" id="7741009">:=</span>&nbsp;<span class="builtinfunc" id="7741012">len</span><span class="op" id="7741015">(</span><span class="ident" id="7741016">res</span><span class="op" id="7741019">.</span><span class="ident" id="7741020">Header</span><span class="op" id="7741026">[</span><span class="string" id="7741027">&#34;X-Multi-Value&#34;</span><span class="op" id="7741042">]</span><span class="op" id="7741043">)</span><span class="op" id="7741044">,</span>&nbsp;<span class="num" id="7741046">2</span><span class="op" id="7741047">;</span>&nbsp;<span class="ident" id="7741049">g</span>&nbsp;<span class="op" id="7741051">!=</span>&nbsp;<span class="ident" id="7741054">e</span>&nbsp;<span class="op" id="7741056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741060">t</span><span class="op" id="7741061">.</span><span class="ident" id="7741062">Errorf</span><span class="op" id="7741068">(</span><span class="string" id="7741069">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7741118">,</span>&nbsp;<span class="ident" id="7741120">g</span><span class="op" id="7741121">,</span>&nbsp;<span class="ident" id="7741123">e</span><span class="op" id="7741124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741130">if</span>&nbsp;<span class="ident" id="7741133">g</span><span class="op" id="7741134">,</span>&nbsp;<span class="ident" id="7741136">e</span>&nbsp;<span class="op" id="7741138">:=</span>&nbsp;<span class="builtinfunc" id="7741141">len</span><span class="op" id="7741144">(</span><span class="ident" id="7741145">res</span><span class="op" id="7741148">.</span><span class="ident" id="7741149">Header</span><span class="op" id="7741155">[</span><span class="string" id="7741156">&#34;Set-Cookie&#34;</span><span class="op" id="7741168">]</span><span class="op" id="7741169">)</span><span class="op" id="7741170">,</span>&nbsp;<span class="num" id="7741172">1</span><span class="op" id="7741173">;</span>&nbsp;<span class="ident" id="7741175">g</span>&nbsp;<span class="op" id="7741177">!=</span>&nbsp;<span class="ident" id="7741180">e</span>&nbsp;<span class="op" id="7741182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741186">t</span><span class="op" id="7741187">.</span><span class="ident" id="7741188">Fatalf</span><span class="op" id="7741194">(</span><span class="string" id="7741195">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7741223">,</span>&nbsp;<span class="ident" id="7741225">g</span><span class="op" id="7741226">,</span>&nbsp;<span class="ident" id="7741228">e</span><span class="op" id="7741229">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741235">if</span>&nbsp;<span class="ident" id="7741238">cookie</span>&nbsp;<span class="op" id="7741245">:=</span>&nbsp;<span class="ident" id="7741248">res</span><span class="op" id="7741251">.</span><span class="ident" id="7741252">Cookies</span><span class="op" id="7741259">(</span><span class="op" id="7741260">)</span><span class="op" id="7741261">[</span><span class="num" id="7741262">0</span><span class="op" id="7741263">]</span><span class="op" id="7741264">;</span>&nbsp;<span class="ident" id="7741266">cookie</span><span class="op" id="7741272">.</span><span class="ident" id="7741273">Name</span>&nbsp;<span class="op" id="7741278">!=</span>&nbsp;<span class="string" id="7741281">&#34;flavor&#34;</span>&nbsp;<span class="op" id="7741290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741294">t</span><span class="op" id="7741295">.</span><span class="ident" id="7741296">Errorf</span><span class="op" id="7741302">(</span><span class="string" id="7741303">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="7741325">,</span>&nbsp;<span class="ident" id="7741327">cookie</span><span class="op" id="7741333">.</span><span class="ident" id="7741334">Name</span><span class="op" id="7741338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741344">bodyBytes</span><span class="op" id="7741353">,</span>&nbsp;<span class="ident" id="7741355">_</span>&nbsp;<span class="op" id="7741357">:=</span>&nbsp;<span class="ident" id="7741360">ioutil</span><span class="op" id="7741366">.</span><span class="ident" id="7741367">ReadAll</span><span class="op" id="7741374">(</span><span class="ident" id="7741375">res</span><span class="op" id="7741378">.</span><span class="ident" id="7741379">Body</span><span class="op" id="7741383">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741386">if</span>&nbsp;<span class="ident" id="7741389">g</span><span class="op" id="7741390">,</span>&nbsp;<span class="ident" id="7741392">e</span>&nbsp;<span class="op" id="7741394">:=</span>&nbsp;<span class="builtintype" id="7741397">string</span><span class="op" id="7741403">(</span><span class="ident" id="7741404">bodyBytes</span><span class="op" id="7741413">)</span><span class="op" id="7741414">,</span>&nbsp;<span class="ident" id="7741416">backendResponse</span><span class="op" id="7741431">;</span>&nbsp;<span class="ident" id="7741433">g</span>&nbsp;<span class="op" id="7741435">!=</span>&nbsp;<span class="ident" id="7741438">e</span>&nbsp;<span class="op" id="7741440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741444">t</span><span class="op" id="7741445">.</span><span class="ident" id="7741446">Errorf</span><span class="op" id="7741452">(</span><span class="string" id="7741453">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7741479">,</span>&nbsp;<span class="ident" id="7741481">g</span><span class="op" id="7741482">,</span>&nbsp;<span class="ident" id="7741484">e</span><span class="op" id="7741485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741488">}</span><br>
<span class="lineno"></span><span class="op" id="7741490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7741493">func</span>&nbsp;<span class="ident" id="7741498">TestXForwardedFor</span><span class="op" id="7741515">(</span><span class="ident" id="7741516">t</span>&nbsp;<span class="op" id="7741518">*</span><span class="ident" id="7741519">testing</span><span class="op" id="7741526">.</span><span class="ident" id="7741527">T</span><span class="op" id="7741528">)</span>&nbsp;<span class="op" id="7741530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741533">const</span>&nbsp;<span class="ident" id="7741539">prevForwardedFor</span>&nbsp;<span class="op" id="7741556">=</span>&nbsp;<span class="string" id="7741558">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741571">const</span>&nbsp;<span class="ident" id="7741577">backendResponse</span>&nbsp;<span class="op" id="7741593">=</span>&nbsp;<span class="string" id="7741595">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741615">const</span>&nbsp;<span class="ident" id="7741621">backendStatus</span>&nbsp;<span class="op" id="7741635">=</span>&nbsp;<span class="num" id="7741637">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741642">backend</span>&nbsp;<span class="op" id="7741650">:=</span>&nbsp;<span class="ident" id="7741653">httptest</span><span class="op" id="7741661">.</span><span class="ident" id="7741662">NewServer</span><span class="op" id="7741671">(</span><span class="ident" id="7741672">http</span><span class="op" id="7741676">.</span><span class="ident" id="7741677">HandlerFunc</span><span class="op" id="7741688">(</span><span class="keyword" id="7741689">func</span><span class="op" id="7741693">(</span><span class="ident" id="7741694">w</span>&nbsp;<span class="ident" id="7741696">http</span><span class="op" id="7741700">.</span><span class="ident" id="7741701">ResponseWriter</span><span class="op" id="7741715">,</span>&nbsp;<span class="ident" id="7741717">r</span>&nbsp;<span class="op" id="7741719">*</span><span class="ident" id="7741720">http</span><span class="op" id="7741724">.</span><span class="ident" id="7741725">Request</span><span class="op" id="7741732">)</span>&nbsp;<span class="op" id="7741734">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741738">if</span>&nbsp;<span class="ident" id="7741741">r</span><span class="op" id="7741742">.</span><span class="ident" id="7741743">Header</span><span class="op" id="7741749">.</span><span class="ident" id="7741750">Get</span><span class="op" id="7741753">(</span><span class="string" id="7741754">&#34;X-Forwarded-For&#34;</span><span class="op" id="7741771">)</span>&nbsp;<span class="op" id="7741773">==</span>&nbsp;<span class="string" id="7741776">&#34;&#34;</span>&nbsp;<span class="op" id="7741779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741784">t</span><span class="op" id="7741785">.</span><span class="ident" id="7741786">Errorf</span><span class="op" id="7741792">(</span><span class="string" id="7741793">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="7741828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7741836">if</span>&nbsp;<span class="op" id="7741839">!</span><span class="ident" id="7741840">strings</span><span class="op" id="7741847">.</span><span class="ident" id="7741848">Contains</span><span class="op" id="7741856">(</span><span class="ident" id="7741857">r</span><span class="op" id="7741858">.</span><span class="ident" id="7741859">Header</span><span class="op" id="7741865">.</span><span class="ident" id="7741866">Get</span><span class="op" id="7741869">(</span><span class="string" id="7741870">&#34;X-Forwarded-For&#34;</span><span class="op" id="7741887">)</span><span class="op" id="7741888">,</span>&nbsp;<span class="ident" id="7741890">prevForwardedFor</span><span class="op" id="7741906">)</span>&nbsp;<span class="op" id="7741908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741913">t</span><span class="op" id="7741914">.</span><span class="ident" id="7741915">Errorf</span><span class="op" id="7741921">(</span><span class="string" id="7741922">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="7741965">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7741969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7741973">w</span><span class="op" id="7741974">.</span><span class="ident" id="7741975">WriteHeader</span><span class="op" id="7741986">(</span><span class="ident" id="7741987">backendStatus</span><span class="op" id="7742000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742004">w</span><span class="op" id="7742005">.</span><span class="ident" id="7742006">Write</span><span class="op" id="7742011">(</span><span class="op" id="7742012">[</span><span class="op" id="7742013">]</span><span class="builtintype" id="7742014">byte</span><span class="op" id="7742018">(</span><span class="ident" id="7742019">backendResponse</span><span class="op" id="7742034">)</span><span class="op" id="7742035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7742038">}</span><span class="op" id="7742039">)</span><span class="op" id="7742040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742043">defer</span>&nbsp;<span class="ident" id="7742049">backend</span><span class="op" id="7742056">.</span><span class="ident" id="7742057">Close</span><span class="op" id="7742062">(</span><span class="op" id="7742063">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742066">backendURL</span><span class="op" id="7742076">,</span>&nbsp;<span class="ident" id="7742078">err</span>&nbsp;<span class="op" id="7742082">:=</span>&nbsp;<span class="ident" id="7742085">url</span><span class="op" id="7742088">.</span><span class="ident" id="7742089">Parse</span><span class="op" id="7742094">(</span><span class="ident" id="7742095">backend</span><span class="op" id="7742102">.</span><span class="ident" id="7742103">URL</span><span class="op" id="7742106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742109">if</span>&nbsp;<span class="ident" id="7742112">err</span>&nbsp;<span class="op" id="7742116">!=</span>&nbsp;<span class="ident" id="7742119">nil</span>&nbsp;<span class="op" id="7742123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742127">t</span><span class="op" id="7742128">.</span><span class="ident" id="7742129">Fatal</span><span class="op" id="7742134">(</span><span class="ident" id="7742135">err</span><span class="op" id="7742138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7742141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742144">proxyHandler</span>&nbsp;<span class="op" id="7742157">:=</span>&nbsp;<span class="ident" id="7742160">NewSingleHostReverseProxy</span><span class="op" id="7742185">(</span><span class="ident" id="7742186">backendURL</span><span class="op" id="7742196">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742199">frontend</span>&nbsp;<span class="op" id="7742208">:=</span>&nbsp;<span class="ident" id="7742211">httptest</span><span class="op" id="7742219">.</span><span class="ident" id="7742220">NewServer</span><span class="op" id="7742229">(</span><span class="ident" id="7742230">proxyHandler</span><span class="op" id="7742242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742245">defer</span>&nbsp;<span class="ident" id="7742251">frontend</span><span class="op" id="7742259">.</span><span class="ident" id="7742260">Close</span><span class="op" id="7742265">(</span><span class="op" id="7742266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742270">getReq</span><span class="op" id="7742276">,</span>&nbsp;<span class="ident" id="7742278">_</span>&nbsp;<span class="op" id="7742280">:=</span>&nbsp;<span class="ident" id="7742283">http</span><span class="op" id="7742287">.</span><span class="ident" id="7742288">NewRequest</span><span class="op" id="7742298">(</span><span class="string" id="7742299">&#34;GET&#34;</span><span class="op" id="7742304">,</span>&nbsp;<span class="ident" id="7742306">frontend</span><span class="op" id="7742314">.</span><span class="ident" id="7742315">URL</span><span class="op" id="7742318">,</span>&nbsp;<span class="ident" id="7742320">nil</span><span class="op" id="7742323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742326">getReq</span><span class="op" id="7742332">.</span><span class="ident" id="7742333">Host</span>&nbsp;<span class="op" id="7742338">=</span>&nbsp;<span class="string" id="7742340">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742353">getReq</span><span class="op" id="7742359">.</span><span class="ident" id="7742360">Header</span><span class="op" id="7742366">.</span><span class="ident" id="7742367">Set</span><span class="op" id="7742370">(</span><span class="string" id="7742371">&#34;Connection&#34;</span><span class="op" id="7742383">,</span>&nbsp;<span class="string" id="7742385">&#34;close&#34;</span><span class="op" id="7742392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742395">getReq</span><span class="op" id="7742401">.</span><span class="ident" id="7742402">Header</span><span class="op" id="7742408">.</span><span class="ident" id="7742409">Set</span><span class="op" id="7742412">(</span><span class="string" id="7742413">&#34;X-Forwarded-For&#34;</span><span class="op" id="7742430">,</span>&nbsp;<span class="ident" id="7742432">prevForwardedFor</span><span class="op" id="7742448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742451">getReq</span><span class="op" id="7742457">.</span><span class="ident" id="7742458">Close</span>&nbsp;<span class="op" id="7742464">=</span>&nbsp;<span class="builtintype" id="7742466">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742472">res</span><span class="op" id="7742475">,</span>&nbsp;<span class="ident" id="7742477">err</span>&nbsp;<span class="op" id="7742481">:=</span>&nbsp;<span class="ident" id="7742484">http</span><span class="op" id="7742488">.</span><span class="ident" id="7742489">DefaultClient</span><span class="op" id="7742502">.</span><span class="ident" id="7742503">Do</span><span class="op" id="7742505">(</span><span class="ident" id="7742506">getReq</span><span class="op" id="7742512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742515">if</span>&nbsp;<span class="ident" id="7742518">err</span>&nbsp;<span class="op" id="7742522">!=</span>&nbsp;<span class="ident" id="7742525">nil</span>&nbsp;<span class="op" id="7742529">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742533">t</span><span class="op" id="7742534">.</span><span class="ident" id="7742535">Fatalf</span><span class="op" id="7742541">(</span><span class="string" id="7742542">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7742551">,</span>&nbsp;<span class="ident" id="7742553">err</span><span class="op" id="7742556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7742559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742562">if</span>&nbsp;<span class="ident" id="7742565">g</span><span class="op" id="7742566">,</span>&nbsp;<span class="ident" id="7742568">e</span>&nbsp;<span class="op" id="7742570">:=</span>&nbsp;<span class="ident" id="7742573">res</span><span class="op" id="7742576">.</span><span class="ident" id="7742577">StatusCode</span><span class="op" id="7742587">,</span>&nbsp;<span class="ident" id="7742589">backendStatus</span><span class="op" id="7742602">;</span>&nbsp;<span class="ident" id="7742604">g</span>&nbsp;<span class="op" id="7742606">!=</span>&nbsp;<span class="ident" id="7742609">e</span>&nbsp;<span class="op" id="7742611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742615">t</span><span class="op" id="7742616">.</span><span class="ident" id="7742617">Errorf</span><span class="op" id="7742623">(</span><span class="string" id="7742624">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="7742660">,</span>&nbsp;<span class="ident" id="7742662">g</span><span class="op" id="7742663">,</span>&nbsp;<span class="ident" id="7742665">e</span><span class="op" id="7742666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7742669">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742672">bodyBytes</span><span class="op" id="7742681">,</span>&nbsp;<span class="ident" id="7742683">_</span>&nbsp;<span class="op" id="7742685">:=</span>&nbsp;<span class="ident" id="7742688">ioutil</span><span class="op" id="7742694">.</span><span class="ident" id="7742695">ReadAll</span><span class="op" id="7742702">(</span><span class="ident" id="7742703">res</span><span class="op" id="7742706">.</span><span class="ident" id="7742707">Body</span><span class="op" id="7742711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7742714">if</span>&nbsp;<span class="ident" id="7742717">g</span><span class="op" id="7742718">,</span>&nbsp;<span class="ident" id="7742720">e</span>&nbsp;<span class="op" id="7742722">:=</span>&nbsp;<span class="builtintype" id="7742725">string</span><span class="op" id="7742731">(</span><span class="ident" id="7742732">bodyBytes</span><span class="op" id="7742741">)</span><span class="op" id="7742742">,</span>&nbsp;<span class="ident" id="7742744">backendResponse</span><span class="op" id="7742759">;</span>&nbsp;<span class="ident" id="7742761">g</span>&nbsp;<span class="op" id="7742763">!=</span>&nbsp;<span class="ident" id="7742766">e</span>&nbsp;<span class="op" id="7742768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742772">t</span><span class="op" id="7742773">.</span><span class="ident" id="7742774">Errorf</span><span class="op" id="7742780">(</span><span class="string" id="7742781">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7742807">,</span>&nbsp;<span class="ident" id="7742809">g</span><span class="op" id="7742810">,</span>&nbsp;<span class="ident" id="7742812">e</span><span class="op" id="7742813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7742816">}</span><br>
<span class="lineno"></span><span class="op" id="7742818">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="7742821">var</span>&nbsp;<span class="ident" id="7742825">proxyQueryTests</span>&nbsp;<span class="op" id="7742841">=</span>&nbsp;<span class="op" id="7742843">[</span><span class="op" id="7742844">]</span><span class="keyword" id="7742845">struct</span>&nbsp;<span class="op" id="7742852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742855">baseSuffix</span>&nbsp;<span class="builtintype" id="7742866">string</span>&nbsp;<span class="comment" id="7742873">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742906">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="7742917">string</span>&nbsp;<span class="comment" id="7742924">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7742968">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7742979">string</span>&nbsp;<span class="comment" id="7742986">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="7743047">}</span><span class="op" id="7743048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743051">{</span><span class="string" id="7743052">&#34;&#34;</span><span class="op" id="7743054">,</span>&nbsp;<span class="string" id="7743056">&#34;&#34;</span><span class="op" id="7743058">,</span>&nbsp;<span class="string" id="7743060">&#34;&#34;</span><span class="op" id="7743062">}</span><span class="op" id="7743063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743066">{</span><span class="string" id="7743067">&#34;?sta=tic&#34;</span><span class="op" id="7743077">,</span>&nbsp;<span class="string" id="7743079">&#34;?us=er&#34;</span><span class="op" id="7743087">,</span>&nbsp;<span class="string" id="7743089">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="7743104">}</span><span class="op" id="7743105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743108">{</span><span class="string" id="7743109">&#34;&#34;</span><span class="op" id="7743111">,</span>&nbsp;<span class="string" id="7743113">&#34;?us=er&#34;</span><span class="op" id="7743121">,</span>&nbsp;<span class="string" id="7743123">&#34;us=er&#34;</span><span class="op" id="7743130">}</span><span class="op" id="7743131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743134">{</span><span class="string" id="7743135">&#34;?sta=tic&#34;</span><span class="op" id="7743145">,</span>&nbsp;<span class="string" id="7743147">&#34;&#34;</span><span class="op" id="7743149">,</span>&nbsp;<span class="string" id="7743151">&#34;sta=tic&#34;</span><span class="op" id="7743160">}</span><span class="op" id="7743161">,</span><br>
<span class="lineno">145</span><span class="op" id="7743163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7743166">func</span>&nbsp;<span class="ident" id="7743171">TestReverseProxyQuery</span><span class="op" id="7743192">(</span><span class="ident" id="7743193">t</span>&nbsp;<span class="op" id="7743195">*</span><span class="ident" id="7743196">testing</span><span class="op" id="7743203">.</span><span class="ident" id="7743204">T</span><span class="op" id="7743205">)</span>&nbsp;<span class="op" id="7743207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743210">backend</span>&nbsp;<span class="op" id="7743218">:=</span>&nbsp;<span class="ident" id="7743221">httptest</span><span class="op" id="7743229">.</span><span class="ident" id="7743230">NewServer</span><span class="op" id="7743239">(</span><span class="ident" id="7743240">http</span><span class="op" id="7743244">.</span><span class="ident" id="7743245">HandlerFunc</span><span class="op" id="7743256">(</span><span class="keyword" id="7743257">func</span><span class="op" id="7743261">(</span><span class="ident" id="7743262">w</span>&nbsp;<span class="ident" id="7743264">http</span><span class="op" id="7743268">.</span><span class="ident" id="7743269">ResponseWriter</span><span class="op" id="7743283">,</span>&nbsp;<span class="ident" id="7743285">r</span>&nbsp;<span class="op" id="7743287">*</span><span class="ident" id="7743288">http</span><span class="op" id="7743292">.</span><span class="ident" id="7743293">Request</span><span class="op" id="7743300">)</span>&nbsp;<span class="op" id="7743302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743306">w</span><span class="op" id="7743307">.</span><span class="ident" id="7743308">Header</span><span class="op" id="7743314">(</span><span class="op" id="7743315">)</span><span class="op" id="7743316">.</span><span class="ident" id="7743317">Set</span><span class="op" id="7743320">(</span><span class="string" id="7743321">&#34;X-Got-Query&#34;</span><span class="op" id="7743334">,</span>&nbsp;<span class="ident" id="7743336">r</span><span class="op" id="7743337">.</span><span class="ident" id="7743338">URL</span><span class="op" id="7743341">.</span><span class="ident" id="7743342">RawQuery</span><span class="op" id="7743350">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743354">w</span><span class="op" id="7743355">.</span><span class="ident" id="7743356">Write</span><span class="op" id="7743361">(</span><span class="op" id="7743362">[</span><span class="op" id="7743363">]</span><span class="builtintype" id="7743364">byte</span><span class="op" id="7743368">(</span><span class="string" id="7743369">&#34;hi&#34;</span><span class="op" id="7743373">)</span><span class="op" id="7743374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743377">}</span><span class="op" id="7743378">)</span><span class="op" id="7743379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743382">defer</span>&nbsp;<span class="ident" id="7743388">backend</span><span class="op" id="7743395">.</span><span class="ident" id="7743396">Close</span><span class="op" id="7743401">(</span><span class="op" id="7743402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743406">for</span>&nbsp;<span class="ident" id="7743410">i</span><span class="op" id="7743411">,</span>&nbsp;<span class="ident" id="7743413">tt</span>&nbsp;<span class="op" id="7743416">:=</span>&nbsp;<span class="keyword" id="7743419">range</span>&nbsp;<span class="ident" id="7743425">proxyQueryTests</span>&nbsp;<span class="op" id="7743441">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743445">backendURL</span><span class="op" id="7743455">,</span>&nbsp;<span class="ident" id="7743457">err</span>&nbsp;<span class="op" id="7743461">:=</span>&nbsp;<span class="ident" id="7743464">url</span><span class="op" id="7743467">.</span><span class="ident" id="7743468">Parse</span><span class="op" id="7743473">(</span><span class="ident" id="7743474">backend</span><span class="op" id="7743481">.</span><span class="ident" id="7743482">URL</span>&nbsp;<span class="op" id="7743486">+</span>&nbsp;<span class="ident" id="7743488">tt</span><span class="op" id="7743490">.</span><span class="ident" id="7743491">baseSuffix</span><span class="op" id="7743501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743505">if</span>&nbsp;<span class="ident" id="7743508">err</span>&nbsp;<span class="op" id="7743512">!=</span>&nbsp;<span class="ident" id="7743515">nil</span>&nbsp;<span class="op" id="7743519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743524">t</span><span class="op" id="7743525">.</span><span class="ident" id="7743526">Fatal</span><span class="op" id="7743531">(</span><span class="ident" id="7743532">err</span><span class="op" id="7743535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743543">frontend</span>&nbsp;<span class="op" id="7743552">:=</span>&nbsp;<span class="ident" id="7743555">httptest</span><span class="op" id="7743563">.</span><span class="ident" id="7743564">NewServer</span><span class="op" id="7743573">(</span><span class="ident" id="7743574">NewSingleHostReverseProxy</span><span class="op" id="7743599">(</span><span class="ident" id="7743600">backendURL</span><span class="op" id="7743610">)</span><span class="op" id="7743611">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743615">req</span><span class="op" id="7743618">,</span>&nbsp;<span class="ident" id="7743620">_</span>&nbsp;<span class="op" id="7743622">:=</span>&nbsp;<span class="ident" id="7743625">http</span><span class="op" id="7743629">.</span><span class="ident" id="7743630">NewRequest</span><span class="op" id="7743640">(</span><span class="string" id="7743641">&#34;GET&#34;</span><span class="op" id="7743646">,</span>&nbsp;<span class="ident" id="7743648">frontend</span><span class="op" id="7743656">.</span><span class="ident" id="7743657">URL</span><span class="op" id="7743660">+</span><span class="ident" id="7743661">tt</span><span class="op" id="7743663">.</span><span class="ident" id="7743664">reqSuffix</span><span class="op" id="7743673">,</span>&nbsp;<span class="ident" id="7743675">nil</span><span class="op" id="7743678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743682">req</span><span class="op" id="7743685">.</span><span class="ident" id="7743686">Close</span>&nbsp;<span class="op" id="7743692">=</span>&nbsp;<span class="builtintype" id="7743694">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743701">res</span><span class="op" id="7743704">,</span>&nbsp;<span class="ident" id="7743706">err</span>&nbsp;<span class="op" id="7743710">:=</span>&nbsp;<span class="ident" id="7743713">http</span><span class="op" id="7743717">.</span><span class="ident" id="7743718">DefaultClient</span><span class="op" id="7743731">.</span><span class="ident" id="7743732">Do</span><span class="op" id="7743734">(</span><span class="ident" id="7743735">req</span><span class="op" id="7743738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743742">if</span>&nbsp;<span class="ident" id="7743745">err</span>&nbsp;<span class="op" id="7743749">!=</span>&nbsp;<span class="ident" id="7743752">nil</span>&nbsp;<span class="op" id="7743756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743761">t</span><span class="op" id="7743762">.</span><span class="ident" id="7743763">Fatalf</span><span class="op" id="7743769">(</span><span class="string" id="7743770">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="7743783">,</span>&nbsp;<span class="ident" id="7743785">i</span><span class="op" id="7743786">,</span>&nbsp;<span class="ident" id="7743788">err</span><span class="op" id="7743791">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7743799">if</span>&nbsp;<span class="ident" id="7743802">g</span><span class="op" id="7743803">,</span>&nbsp;<span class="ident" id="7743805">e</span>&nbsp;<span class="op" id="7743807">:=</span>&nbsp;<span class="ident" id="7743810">res</span><span class="op" id="7743813">.</span><span class="ident" id="7743814">Header</span><span class="op" id="7743820">.</span><span class="ident" id="7743821">Get</span><span class="op" id="7743824">(</span><span class="string" id="7743825">&#34;X-Got-Query&#34;</span><span class="op" id="7743838">)</span><span class="op" id="7743839">,</span>&nbsp;<span class="ident" id="7743841">tt</span><span class="op" id="7743843">.</span><span class="ident" id="7743844">want</span><span class="op" id="7743848">;</span>&nbsp;<span class="ident" id="7743850">g</span>&nbsp;<span class="op" id="7743852">!=</span>&nbsp;<span class="ident" id="7743855">e</span>&nbsp;<span class="op" id="7743857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743862">t</span><span class="op" id="7743863">.</span><span class="ident" id="7743864">Errorf</span><span class="op" id="7743870">(</span><span class="string" id="7743871">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7743902">,</span>&nbsp;<span class="ident" id="7743904">i</span><span class="op" id="7743905">,</span>&nbsp;<span class="ident" id="7743907">g</span><span class="op" id="7743908">,</span>&nbsp;<span class="ident" id="7743910">e</span><span class="op" id="7743911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743919">res</span><span class="op" id="7743922">.</span><span class="ident" id="7743923">Body</span><span class="op" id="7743927">.</span><span class="ident" id="7743928">Close</span><span class="op" id="7743933">(</span><span class="op" id="7743934">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7743938">frontend</span><span class="op" id="7743946">.</span><span class="ident" id="7743947">Close</span><span class="op" id="7743952">(</span><span class="op" id="7743953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7743956">}</span><br>
<span class="lineno"></span><span class="op" id="7743958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7743961">func</span>&nbsp;<span class="ident" id="7743966">TestReverseProxyFlushInterval</span><span class="op" id="7743995">(</span><span class="ident" id="7743996">t</span>&nbsp;<span class="op" id="7743998">*</span><span class="ident" id="7743999">testing</span><span class="op" id="7744006">.</span><span class="ident" id="7744007">T</span><span class="op" id="7744008">)</span>&nbsp;<span class="op" id="7744010">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744013">const</span>&nbsp;<span class="ident" id="7744019">expected</span>&nbsp;<span class="op" id="7744028">=</span>&nbsp;<span class="string" id="7744030">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744036">backend</span>&nbsp;<span class="op" id="7744044">:=</span>&nbsp;<span class="ident" id="7744047">httptest</span><span class="op" id="7744055">.</span><span class="ident" id="7744056">NewServer</span><span class="op" id="7744065">(</span><span class="ident" id="7744066">http</span><span class="op" id="7744070">.</span><span class="ident" id="7744071">HandlerFunc</span><span class="op" id="7744082">(</span><span class="keyword" id="7744083">func</span><span class="op" id="7744087">(</span><span class="ident" id="7744088">w</span>&nbsp;<span class="ident" id="7744090">http</span><span class="op" id="7744094">.</span><span class="ident" id="7744095">ResponseWriter</span><span class="op" id="7744109">,</span>&nbsp;<span class="ident" id="7744111">r</span>&nbsp;<span class="op" id="7744113">*</span><span class="ident" id="7744114">http</span><span class="op" id="7744118">.</span><span class="ident" id="7744119">Request</span><span class="op" id="7744126">)</span>&nbsp;<span class="op" id="7744128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744132">w</span><span class="op" id="7744133">.</span><span class="ident" id="7744134">Write</span><span class="op" id="7744139">(</span><span class="op" id="7744140">[</span><span class="op" id="7744141">]</span><span class="builtintype" id="7744142">byte</span><span class="op" id="7744146">(</span><span class="ident" id="7744147">expected</span><span class="op" id="7744155">)</span><span class="op" id="7744156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7744159">}</span><span class="op" id="7744160">)</span><span class="op" id="7744161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744164">defer</span>&nbsp;<span class="ident" id="7744170">backend</span><span class="op" id="7744177">.</span><span class="ident" id="7744178">Close</span><span class="op" id="7744183">(</span><span class="op" id="7744184">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744188">backendURL</span><span class="op" id="7744198">,</span>&nbsp;<span class="ident" id="7744200">err</span>&nbsp;<span class="op" id="7744204">:=</span>&nbsp;<span class="ident" id="7744207">url</span><span class="op" id="7744210">.</span><span class="ident" id="7744211">Parse</span><span class="op" id="7744216">(</span><span class="ident" id="7744217">backend</span><span class="op" id="7744224">.</span><span class="ident" id="7744225">URL</span><span class="op" id="7744228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744231">if</span>&nbsp;<span class="ident" id="7744234">err</span>&nbsp;<span class="op" id="7744238">!=</span>&nbsp;<span class="ident" id="7744241">nil</span>&nbsp;<span class="op" id="7744245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744249">t</span><span class="op" id="7744250">.</span><span class="ident" id="7744251">Fatal</span><span class="op" id="7744256">(</span><span class="ident" id="7744257">err</span><span class="op" id="7744260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7744263">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744267">proxyHandler</span>&nbsp;<span class="op" id="7744280">:=</span>&nbsp;<span class="ident" id="7744283">NewSingleHostReverseProxy</span><span class="op" id="7744308">(</span><span class="ident" id="7744309">backendURL</span><span class="op" id="7744319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744322">proxyHandler</span><span class="op" id="7744334">.</span><span class="ident" id="7744335">FlushInterval</span>&nbsp;<span class="op" id="7744349">=</span>&nbsp;<span class="ident" id="7744351">time</span><span class="op" id="7744355">.</span><span class="ident" id="7744356">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744370">done</span>&nbsp;<span class="op" id="7744375">:=</span>&nbsp;<span class="builtinfunc" id="7744378">make</span><span class="op" id="7744382">(</span><span class="keyword" id="7744383">chan</span>&nbsp;<span class="builtintype" id="7744388">bool</span><span class="op" id="7744392">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744395">onExitFlushLoop</span>&nbsp;<span class="op" id="7744411">=</span>&nbsp;<span class="keyword" id="7744413">func</span><span class="op" id="7744417">(</span><span class="op" id="7744418">)</span>&nbsp;<span class="op" id="7744420">{</span>&nbsp;<span class="ident" id="7744422">done</span>&nbsp;<span class="op" id="7744427">&lt;-</span>&nbsp;<span class="builtintype" id="7744430">true</span>&nbsp;<span class="op" id="7744435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744438">defer</span>&nbsp;<span class="keyword" id="7744444">func</span><span class="op" id="7744448">(</span><span class="op" id="7744449">)</span>&nbsp;<span class="op" id="7744451">{</span>&nbsp;<span class="ident" id="7744453">onExitFlushLoop</span>&nbsp;<span class="op" id="7744469">=</span>&nbsp;<span class="ident" id="7744471">nil</span>&nbsp;<span class="op" id="7744475">}</span><span class="op" id="7744476">(</span><span class="op" id="7744477">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744481">frontend</span>&nbsp;<span class="op" id="7744490">:=</span>&nbsp;<span class="ident" id="7744493">httptest</span><span class="op" id="7744501">.</span><span class="ident" id="7744502">NewServer</span><span class="op" id="7744511">(</span><span class="ident" id="7744512">proxyHandler</span><span class="op" id="7744524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744527">defer</span>&nbsp;<span class="ident" id="7744533">frontend</span><span class="op" id="7744541">.</span><span class="ident" id="7744542">Close</span><span class="op" id="7744547">(</span><span class="op" id="7744548">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744552">req</span><span class="op" id="7744555">,</span>&nbsp;<span class="ident" id="7744557">_</span>&nbsp;<span class="op" id="7744559">:=</span>&nbsp;<span class="ident" id="7744562">http</span><span class="op" id="7744566">.</span><span class="ident" id="7744567">NewRequest</span><span class="op" id="7744577">(</span><span class="string" id="7744578">&#34;GET&#34;</span><span class="op" id="7744583">,</span>&nbsp;<span class="ident" id="7744585">frontend</span><span class="op" id="7744593">.</span><span class="ident" id="7744594">URL</span><span class="op" id="7744597">,</span>&nbsp;<span class="ident" id="7744599">nil</span><span class="op" id="7744602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744605">req</span><span class="op" id="7744608">.</span><span class="ident" id="7744609">Close</span>&nbsp;<span class="op" id="7744615">=</span>&nbsp;<span class="builtintype" id="7744617">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744623">res</span><span class="op" id="7744626">,</span>&nbsp;<span class="ident" id="7744628">err</span>&nbsp;<span class="op" id="7744632">:=</span>&nbsp;<span class="ident" id="7744635">http</span><span class="op" id="7744639">.</span><span class="ident" id="7744640">DefaultClient</span><span class="op" id="7744653">.</span><span class="ident" id="7744654">Do</span><span class="op" id="7744656">(</span><span class="ident" id="7744657">req</span><span class="op" id="7744660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744663">if</span>&nbsp;<span class="ident" id="7744666">err</span>&nbsp;<span class="op" id="7744670">!=</span>&nbsp;<span class="ident" id="7744673">nil</span>&nbsp;<span class="op" id="7744677">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744681">t</span><span class="op" id="7744682">.</span><span class="ident" id="7744683">Fatalf</span><span class="op" id="7744689">(</span><span class="string" id="7744690">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="7744699">,</span>&nbsp;<span class="ident" id="7744701">err</span><span class="op" id="7744704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7744707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744710">defer</span>&nbsp;<span class="ident" id="7744716">res</span><span class="op" id="7744719">.</span><span class="ident" id="7744720">Body</span><span class="op" id="7744724">.</span><span class="ident" id="7744725">Close</span><span class="op" id="7744730">(</span><span class="op" id="7744731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744734">if</span>&nbsp;<span class="ident" id="7744737">bodyBytes</span><span class="op" id="7744746">,</span>&nbsp;<span class="ident" id="7744748">_</span>&nbsp;<span class="op" id="7744750">:=</span>&nbsp;<span class="ident" id="7744753">ioutil</span><span class="op" id="7744759">.</span><span class="ident" id="7744760">ReadAll</span><span class="op" id="7744767">(</span><span class="ident" id="7744768">res</span><span class="op" id="7744771">.</span><span class="ident" id="7744772">Body</span><span class="op" id="7744776">)</span><span class="op" id="7744777">;</span>&nbsp;<span class="builtintype" id="7744779">string</span><span class="op" id="7744785">(</span><span class="ident" id="7744786">bodyBytes</span><span class="op" id="7744795">)</span>&nbsp;<span class="op" id="7744797">!=</span>&nbsp;<span class="ident" id="7744800">expected</span>&nbsp;<span class="op" id="7744809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744813">t</span><span class="op" id="7744814">.</span><span class="ident" id="7744815">Errorf</span><span class="op" id="7744821">(</span><span class="string" id="7744822">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7744848">,</span>&nbsp;<span class="ident" id="7744850">bodyBytes</span><span class="op" id="7744859">,</span>&nbsp;<span class="ident" id="7744861">expected</span><span class="op" id="7744869">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7744872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744876">select</span>&nbsp;<span class="op" id="7744883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744886">case</span>&nbsp;<span class="op" id="7744891">&lt;-</span><span class="ident" id="7744893">done</span><span class="op" id="7744897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7744901">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7744908">case</span>&nbsp;<span class="op" id="7744913">&lt;-</span><span class="ident" id="7744915">time</span><span class="op" id="7744919">.</span><span class="ident" id="7744920">After</span><span class="op" id="7744925">(</span><span class="num" id="7744926">5</span>&nbsp;<span class="op" id="7744928">*</span>&nbsp;<span class="ident" id="7744930">time</span><span class="op" id="7744934">.</span><span class="ident" id="7744935">Second</span><span class="op" id="7744941">)</span><span class="op" id="7744942">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7744946">t</span><span class="op" id="7744947">.</span><span class="ident" id="7744948">Error</span><span class="op" id="7744953">(</span><span class="string" id="7744954">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="7744997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7745000">}</span><br>
<span class="lineno"></span><span class="op" id="7745002">}</span>
</div>
</body>
</html>
