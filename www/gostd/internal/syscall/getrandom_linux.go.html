<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>internal/syscall</h2>
<ul>
<li><a href="/gostd/internal/syscall/getrandom_linux.go.html" class="current">getrandom_linux.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3981722">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3981778">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3981832">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3981883">package</span>&nbsp;<span class="ident" id="3981891">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3981900">import</span>&nbsp;<span class="op" id="3981907">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3981910">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3981921">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3981936">stdsyscall</span>&nbsp;<span class="string" id="3981947">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3981958">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="3981967">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3981970">var</span>&nbsp;<span class="ident" id="3981974">randomTrap</span>&nbsp;<span class="op" id="3981985">=</span>&nbsp;<span class="keyword" id="3981987">map</span><span class="op" id="3981990">[</span><span class="builtintype" id="3981991">string</span><span class="op" id="3981997">]</span><span class="builtintype" id="3981998">uintptr</span><span class="op" id="3982005">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3982008">&#34;386&#34;</span><span class="op" id="3982013">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3982017">355</span><span class="op" id="3982020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3982023">&#34;amd64&#34;</span><span class="op" id="3982030">:</span>&nbsp;<span class="num" id="3982032">318</span><span class="op" id="3982035">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3982038">&#34;arm&#34;</span><span class="op" id="3982043">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3982047">384</span><span class="op" id="3982050">,</span><br>
<span class="lineno"></span><span class="op" id="3982052">}</span><span class="op" id="3982053">[</span><span class="ident" id="3982054">runtime</span><span class="op" id="3982061">.</span><span class="ident" id="3982062">GOARCH</span><span class="op" id="3982068">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="3982071">var</span>&nbsp;<span class="ident" id="3982075">randomUnsupported</span>&nbsp;<span class="builtintype" id="3982093">int32</span>&nbsp;<span class="comment" id="3982099">//&nbsp;atomic</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3982110">//&nbsp;GetRandomFlag&nbsp;is&nbsp;a&nbsp;flag&nbsp;supported&nbsp;by&nbsp;the&nbsp;getrandom&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="3982177">type</span>&nbsp;<span class="ident" id="3982182">GetRandomFlag</span>&nbsp;<span class="builtintype" id="3982196">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3982205">const</span>&nbsp;<span class="op" id="3982211">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3982214">//&nbsp;GRND_NONBLOCK&nbsp;means&nbsp;return&nbsp;EAGAIN&nbsp;rather&nbsp;than&nbsp;blocking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3982274">GRND_NONBLOCK</span>&nbsp;<span class="ident" id="3982288">GetRandomFlag</span>&nbsp;<span class="op" id="3982302">=</span>&nbsp;<span class="num" id="3982304">0x0001</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3982313">//&nbsp;GRND_RANDOM&nbsp;means&nbsp;use&nbsp;the&nbsp;/dev/random&nbsp;pool&nbsp;instead&nbsp;of&nbsp;/dev/urandom.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3982385">GRND_RANDOM</span>&nbsp;<span class="ident" id="3982397">GetRandomFlag</span>&nbsp;<span class="op" id="3982411">=</span>&nbsp;<span class="num" id="3982413">0x0002</span><br>
<span class="lineno"></span><span class="op" id="3982420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3982423">//&nbsp;GetRandom&nbsp;calls&nbsp;the&nbsp;Linux&nbsp;getrandom&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="3982475">//&nbsp;See&nbsp;https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=c6e9d6f38894798696f23c8084ca7edbf16ee895</span><br>
<span class="lineno">35</span><span class="keyword" id="3982598">func</span>&nbsp;<span class="ident" id="3982603">GetRandom</span><span class="op" id="3982612">(</span><span class="ident" id="3982613">p</span>&nbsp;<span class="op" id="3982615">[</span><span class="op" id="3982616">]</span><span class="builtintype" id="3982617">byte</span><span class="op" id="3982621">,</span>&nbsp;<span class="ident" id="3982623">flags</span>&nbsp;<span class="ident" id="3982629">GetRandomFlag</span><span class="op" id="3982642">)</span>&nbsp;<span class="op" id="3982644">(</span><span class="ident" id="3982645">n</span>&nbsp;<span class="builtintype" id="3982647">int</span><span class="op" id="3982650">,</span>&nbsp;<span class="ident" id="3982652">err</span>&nbsp;<span class="builtintype" id="3982656">error</span><span class="op" id="3982661">)</span>&nbsp;<span class="op" id="3982663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982666">if</span>&nbsp;<span class="ident" id="3982669">randomTrap</span>&nbsp;<span class="op" id="3982680">==</span>&nbsp;<span class="num" id="3982683">0</span>&nbsp;<span class="op" id="3982685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982689">return</span>&nbsp;<span class="num" id="3982696">0</span><span class="op" id="3982697">,</span>&nbsp;<span class="ident" id="3982699">stdsyscall</span><span class="op" id="3982709">.</span><span class="ident" id="3982710">ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982721">if</span>&nbsp;<span class="builtinfunc" id="3982724">len</span><span class="op" id="3982727">(</span><span class="ident" id="3982728">p</span><span class="op" id="3982729">)</span>&nbsp;<span class="op" id="3982731">==</span>&nbsp;<span class="num" id="3982734">0</span>&nbsp;<span class="op" id="3982736">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982740">return</span>&nbsp;<span class="num" id="3982747">0</span><span class="op" id="3982748">,</span>&nbsp;<span class="builtintype" id="3982750">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982758">if</span>&nbsp;<span class="ident" id="3982761">atomic</span><span class="op" id="3982767">.</span><span class="ident" id="3982768">LoadInt32</span><span class="op" id="3982777">(</span><span class="op" id="3982778">&amp;</span><span class="ident" id="3982779">randomUnsupported</span><span class="op" id="3982796">)</span>&nbsp;<span class="op" id="3982798">!=</span>&nbsp;<span class="num" id="3982801">0</span>&nbsp;<span class="op" id="3982803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982807">return</span>&nbsp;<span class="num" id="3982814">0</span><span class="op" id="3982815">,</span>&nbsp;<span class="ident" id="3982817">stdsyscall</span><span class="op" id="3982827">.</span><span class="ident" id="3982828">ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3982836">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3982839">r1</span><span class="op" id="3982841">,</span>&nbsp;<span class="ident" id="3982843">_</span><span class="op" id="3982844">,</span>&nbsp;<span class="ident" id="3982846">errno</span>&nbsp;<span class="op" id="3982852">:=</span>&nbsp;<span class="ident" id="3982855">stdsyscall</span><span class="op" id="3982865">.</span><span class="ident" id="3982866">Syscall</span><span class="op" id="3982873">(</span><span class="ident" id="3982874">randomTrap</span><span class="op" id="3982884">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3982888">uintptr</span><span class="op" id="3982895">(</span><span class="ident" id="3982896">unsafe</span><span class="op" id="3982902">.</span><span class="ident" id="3982903">Pointer</span><span class="op" id="3982910">(</span><span class="op" id="3982911">&amp;</span><span class="ident" id="3982912">p</span><span class="op" id="3982913">[</span><span class="num" id="3982914">0</span><span class="op" id="3982915">]</span><span class="op" id="3982916">)</span><span class="op" id="3982917">)</span><span class="op" id="3982918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3982922">uintptr</span><span class="op" id="3982929">(</span><span class="builtinfunc" id="3982930">len</span><span class="op" id="3982933">(</span><span class="ident" id="3982934">p</span><span class="op" id="3982935">)</span><span class="op" id="3982936">)</span><span class="op" id="3982937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3982941">uintptr</span><span class="op" id="3982948">(</span><span class="ident" id="3982949">flags</span><span class="op" id="3982954">)</span><span class="op" id="3982955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982958">if</span>&nbsp;<span class="ident" id="3982961">errno</span>&nbsp;<span class="op" id="3982967">!=</span>&nbsp;<span class="num" id="3982970">0</span>&nbsp;<span class="op" id="3982972">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3982976">if</span>&nbsp;<span class="ident" id="3982979">errno</span>&nbsp;<span class="op" id="3982985">==</span>&nbsp;<span class="ident" id="3982988">stdsyscall</span><span class="op" id="3982998">.</span><span class="ident" id="3982999">ENOSYS</span>&nbsp;<span class="op" id="3983006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3983011">atomic</span><span class="op" id="3983017">.</span><span class="ident" id="3983018">StoreInt32</span><span class="op" id="3983028">(</span><span class="op" id="3983029">&amp;</span><span class="ident" id="3983030">randomUnsupported</span><span class="op" id="3983047">,</span>&nbsp;<span class="num" id="3983049">1</span><span class="op" id="3983050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983058">return</span>&nbsp;<span class="num" id="3983065">0</span><span class="op" id="3983066">,</span>&nbsp;<span class="ident" id="3983068">errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983075">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3983078">return</span>&nbsp;<span class="builtintype" id="3983085">int</span><span class="op" id="3983088">(</span><span class="ident" id="3983089">r1</span><span class="op" id="3983091">)</span><span class="op" id="3983092">,</span>&nbsp;<span class="builtintype" id="3983094">nil</span><br>
<span class="lineno"></span><span class="op" id="3983098">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
