<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1952133">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1952188">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1952242">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1952293">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1952314">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1952371">package</span>&nbsp;<span class="ident" id="1952379">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1952388">import</span>&nbsp;<span class="op" id="1952395">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1952398">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1952407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1952410">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1952485">var</span>&nbsp;<span class="ident" id="1952489">proflock</span>&nbsp;<span class="ident" id="1952498">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1952505">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1952584">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1952658">const</span>&nbsp;<span class="op" id="1952664">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1952667">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952685">memProfile</span>&nbsp;<span class="ident" id="1952696">bucketType</span>&nbsp;<span class="op" id="1952707">=</span>&nbsp;<span class="num" id="1952709">1</span>&nbsp;<span class="op" id="1952711">+</span>&nbsp;<span class="ident" id="1952713">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952719">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1952734">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952764">buckHashSize</span>&nbsp;<span class="op" id="1952777">=</span>&nbsp;<span class="num" id="1952779">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1952788">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952831">maxStack</span>&nbsp;<span class="op" id="1952840">=</span>&nbsp;<span class="num" id="1952842">32</span><br>
<span class="lineno">30</span><span class="op" id="1952845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1952848">type</span>&nbsp;<span class="ident" id="1952853">bucketType</span>&nbsp;<span class="builtintype" id="1952864">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1952869">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1952925">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1952982">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1953042">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1953098">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1953144">//</span><br>
<span class="lineno">40</span><span class="comment" id="1953147">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1953188">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1953251">type</span>&nbsp;<span class="ident" id="1953256">bucket</span>&nbsp;<span class="keyword" id="1953263">struct</span>&nbsp;<span class="op" id="1953270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953273">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1953281">*</span><span class="ident" id="1953282">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953290">allnext</span>&nbsp;<span class="op" id="1953298">*</span><span class="ident" id="1953299">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953307">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1953315">bucketType</span>&nbsp;<span class="comment" id="1953326">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953355">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1953363">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953372">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1953380">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1953389">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1953397">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1953405">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1953408">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1953475">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1953506">type</span>&nbsp;<span class="ident" id="1953511">memRecord</span>&nbsp;<span class="keyword" id="1953521">struct</span>&nbsp;<span class="op" id="1953528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953531">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953594">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953662">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953690">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953753">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953821">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953881">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953885">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953928">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1953978">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1954020">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1954073">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954117">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954129">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954138">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954150">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954159">alloc_bytes</span>&nbsp;<span class="builtintype" id="1954171">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954180">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1954192">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1954202">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954250">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954267">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954276">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954293">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954302">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1954319">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954328">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1954345">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1954355">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954381">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954400">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954409">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1954428">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954437">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1954456">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954465">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1954484">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1954492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1954495">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1954566">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1954599">type</span>&nbsp;<span class="ident" id="1954604">blockRecord</span>&nbsp;<span class="keyword" id="1954616">struct</span>&nbsp;<span class="op" id="1954623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954626">count</span>&nbsp;&nbsp;<span class="ident" id="1954633">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954640">cycles</span>&nbsp;<span class="ident" id="1954647">int64</span><br>
<span class="lineno"></span><span class="op" id="1954653">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1954656">var</span>&nbsp;<span class="op" id="1954660">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954663">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1954673">*</span><span class="ident" id="1954674">bucket</span>&nbsp;<span class="comment" id="1954681">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954708">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1954718">*</span><span class="ident" id="1954719">bucket</span>&nbsp;<span class="comment" id="1954726">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954755">buckhash</span>&nbsp;&nbsp;<span class="op" id="1954765">*</span><span class="op" id="1954766">[</span><span class="num" id="1954767">179999</span><span class="op" id="1954773">]</span><span class="op" id="1954774">*</span><span class="ident" id="1954775">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954783">bucketmem</span>&nbsp;<span class="builtintype" id="1954793">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1954801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1954804">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1954885">func</span>&nbsp;<span class="ident" id="1954890">newBucket</span><span class="op" id="1954899">(</span><span class="ident" id="1954900">typ</span>&nbsp;<span class="ident" id="1954904">bucketType</span><span class="op" id="1954914">,</span>&nbsp;<span class="ident" id="1954916">nstk</span>&nbsp;<span class="builtintype" id="1954921">int</span><span class="op" id="1954924">)</span>&nbsp;<span class="op" id="1954926">*</span><span class="ident" id="1954927">bucket</span>&nbsp;<span class="op" id="1954934">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1954937">size</span>&nbsp;<span class="op" id="1954942">:=</span>&nbsp;<span class="ident" id="1954945">unsafe</span><span class="op" id="1954951">.</span><span class="ident" id="1954952">Sizeof</span><span class="op" id="1954958">(</span><span class="ident" id="1954959">bucket</span><span class="op" id="1954965">{</span><span class="op" id="1954966">}</span><span class="op" id="1954967">)</span>&nbsp;<span class="op" id="1954969">+</span>&nbsp;<span class="builtintype" id="1954971">uintptr</span><span class="op" id="1954978">(</span><span class="ident" id="1954979">nstk</span><span class="op" id="1954983">)</span><span class="op" id="1954984">*</span><span class="ident" id="1954985">unsafe</span><span class="op" id="1954991">.</span><span class="ident" id="1954992">Sizeof</span><span class="op" id="1954998">(</span><span class="builtintype" id="1954999">uintptr</span><span class="op" id="1955006">(</span><span class="num" id="1955007">0</span><span class="op" id="1955008">)</span><span class="op" id="1955009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955012">switch</span>&nbsp;<span class="ident" id="1955019">typ</span>&nbsp;<span class="op" id="1955023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955026">default</span><span class="op" id="1955033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955037">gothrow</span><span class="op" id="1955044">(</span><span class="string" id="1955045">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1955074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955077">case</span>&nbsp;<span class="ident" id="1955082">memProfile</span><span class="op" id="1955092">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955096">size</span>&nbsp;<span class="op" id="1955101">+=</span>&nbsp;<span class="ident" id="1955104">unsafe</span><span class="op" id="1955110">.</span><span class="ident" id="1955111">Sizeof</span><span class="op" id="1955117">(</span><span class="ident" id="1955118">memRecord</span><span class="op" id="1955127">{</span><span class="op" id="1955128">}</span><span class="op" id="1955129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955132">case</span>&nbsp;<span class="ident" id="1955137">blockProfile</span><span class="op" id="1955149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955153">size</span>&nbsp;<span class="op" id="1955158">+=</span>&nbsp;<span class="ident" id="1955161">unsafe</span><span class="op" id="1955167">.</span><span class="ident" id="1955168">Sizeof</span><span class="op" id="1955174">(</span><span class="ident" id="1955175">blockRecord</span><span class="op" id="1955186">{</span><span class="op" id="1955187">}</span><span class="op" id="1955188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1955191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955195">b</span>&nbsp;<span class="op" id="1955197">:=</span>&nbsp;<span class="op" id="1955200">(</span><span class="op" id="1955201">*</span><span class="ident" id="1955202">bucket</span><span class="op" id="1955208">)</span><span class="op" id="1955209">(</span><span class="ident" id="1955210">persistentalloc</span><span class="op" id="1955225">(</span><span class="ident" id="1955226">size</span><span class="op" id="1955230">,</span>&nbsp;<span class="num" id="1955232">0</span><span class="op" id="1955233">,</span>&nbsp;<span class="op" id="1955235">&amp;</span><span class="ident" id="1955236">memstats</span><span class="op" id="1955244">.</span><span class="ident" id="1955245">buckhash_sys</span><span class="op" id="1955257">)</span><span class="op" id="1955258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955261">bucketmem</span>&nbsp;<span class="op" id="1955271">+=</span>&nbsp;<span class="ident" id="1955274">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955280">b</span><span class="op" id="1955281">.</span><span class="ident" id="1955282">typ</span>&nbsp;<span class="op" id="1955286">=</span>&nbsp;<span class="ident" id="1955288">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955293">b</span><span class="op" id="1955294">.</span><span class="ident" id="1955295">nstk</span>&nbsp;<span class="op" id="1955300">=</span>&nbsp;<span class="builtintype" id="1955302">uintptr</span><span class="op" id="1955309">(</span><span class="ident" id="1955310">nstk</span><span class="op" id="1955314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955317">return</span>&nbsp;<span class="ident" id="1955324">b</span><br>
<span class="lineno">115</span><span class="op" id="1955326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1955329">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1955378">func</span>&nbsp;<span class="op" id="1955383">(</span><span class="ident" id="1955384">b</span>&nbsp;<span class="op" id="1955386">*</span><span class="ident" id="1955387">bucket</span><span class="op" id="1955393">)</span>&nbsp;<span class="ident" id="1955395">stk</span><span class="op" id="1955398">(</span><span class="op" id="1955399">)</span>&nbsp;<span class="op" id="1955401">[</span><span class="op" id="1955402">]</span><span class="builtintype" id="1955403">uintptr</span>&nbsp;<span class="op" id="1955411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955414">stk</span>&nbsp;<span class="op" id="1955418">:=</span>&nbsp;<span class="op" id="1955421">(</span><span class="op" id="1955422">*</span><span class="op" id="1955423">[</span><span class="ident" id="1955424">maxStack</span><span class="op" id="1955432">]</span><span class="builtintype" id="1955433">uintptr</span><span class="op" id="1955440">)</span><span class="op" id="1955441">(</span><span class="ident" id="1955442">add</span><span class="op" id="1955445">(</span><span class="ident" id="1955446">unsafe</span><span class="op" id="1955452">.</span><span class="ident" id="1955453">Pointer</span><span class="op" id="1955460">(</span><span class="ident" id="1955461">b</span><span class="op" id="1955462">)</span><span class="op" id="1955463">,</span>&nbsp;<span class="ident" id="1955465">unsafe</span><span class="op" id="1955471">.</span><span class="ident" id="1955472">Sizeof</span><span class="op" id="1955478">(</span><span class="op" id="1955479">*</span><span class="ident" id="1955480">b</span><span class="op" id="1955481">)</span><span class="op" id="1955482">)</span><span class="op" id="1955483">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955486">return</span>&nbsp;<span class="ident" id="1955493">stk</span><span class="op" id="1955496">[</span><span class="op" id="1955497">:</span><span class="ident" id="1955498">b</span><span class="op" id="1955499">.</span><span class="ident" id="1955500">nstk</span><span class="op" id="1955504">:</span><span class="ident" id="1955505">b</span><span class="op" id="1955506">.</span><span class="ident" id="1955507">nstk</span><span class="op" id="1955511">]</span><br>
<span class="lineno"></span><span class="op" id="1955513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1955516">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1955585">func</span>&nbsp;<span class="op" id="1955590">(</span><span class="ident" id="1955591">b</span>&nbsp;<span class="op" id="1955593">*</span><span class="ident" id="1955594">bucket</span><span class="op" id="1955600">)</span>&nbsp;<span class="ident" id="1955602">mp</span><span class="op" id="1955604">(</span><span class="op" id="1955605">)</span>&nbsp;<span class="op" id="1955607">*</span><span class="ident" id="1955608">memRecord</span>&nbsp;<span class="op" id="1955618">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955621">if</span>&nbsp;<span class="ident" id="1955624">b</span><span class="op" id="1955625">.</span><span class="ident" id="1955626">typ</span>&nbsp;<span class="op" id="1955630">!=</span>&nbsp;<span class="ident" id="1955633">memProfile</span>&nbsp;<span class="op" id="1955644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955648">gothrow</span><span class="op" id="1955655">(</span><span class="string" id="1955656">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1955678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1955681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955684">data</span>&nbsp;<span class="op" id="1955689">:=</span>&nbsp;<span class="ident" id="1955692">add</span><span class="op" id="1955695">(</span><span class="ident" id="1955696">unsafe</span><span class="op" id="1955702">.</span><span class="ident" id="1955703">Pointer</span><span class="op" id="1955710">(</span><span class="ident" id="1955711">b</span><span class="op" id="1955712">)</span><span class="op" id="1955713">,</span>&nbsp;<span class="ident" id="1955715">unsafe</span><span class="op" id="1955721">.</span><span class="ident" id="1955722">Sizeof</span><span class="op" id="1955728">(</span><span class="op" id="1955729">*</span><span class="ident" id="1955730">b</span><span class="op" id="1955731">)</span><span class="op" id="1955732">+</span><span class="ident" id="1955733">b</span><span class="op" id="1955734">.</span><span class="ident" id="1955735">nstk</span><span class="op" id="1955739">*</span><span class="ident" id="1955740">unsafe</span><span class="op" id="1955746">.</span><span class="ident" id="1955747">Sizeof</span><span class="op" id="1955753">(</span><span class="builtintype" id="1955754">uintptr</span><span class="op" id="1955761">(</span><span class="num" id="1955762">0</span><span class="op" id="1955763">)</span><span class="op" id="1955764">)</span><span class="op" id="1955765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955768">return</span>&nbsp;<span class="op" id="1955775">(</span><span class="op" id="1955776">*</span><span class="ident" id="1955777">memRecord</span><span class="op" id="1955786">)</span><span class="op" id="1955787">(</span><span class="ident" id="1955788">data</span><span class="op" id="1955792">)</span><br>
<span class="lineno">130</span><span class="op" id="1955794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1955797">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1955870">func</span>&nbsp;<span class="op" id="1955875">(</span><span class="ident" id="1955876">b</span>&nbsp;<span class="op" id="1955878">*</span><span class="ident" id="1955879">bucket</span><span class="op" id="1955885">)</span>&nbsp;<span class="ident" id="1955887">bp</span><span class="op" id="1955889">(</span><span class="op" id="1955890">)</span>&nbsp;<span class="op" id="1955892">*</span><span class="ident" id="1955893">blockRecord</span>&nbsp;<span class="op" id="1955905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1955908">if</span>&nbsp;<span class="ident" id="1955911">b</span><span class="op" id="1955912">.</span><span class="ident" id="1955913">typ</span>&nbsp;<span class="op" id="1955917">!=</span>&nbsp;<span class="ident" id="1955920">blockProfile</span>&nbsp;<span class="op" id="1955933">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955937">gothrow</span><span class="op" id="1955944">(</span><span class="string" id="1955945">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1955967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1955970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1955973">data</span>&nbsp;<span class="op" id="1955978">:=</span>&nbsp;<span class="ident" id="1955981">add</span><span class="op" id="1955984">(</span><span class="ident" id="1955985">unsafe</span><span class="op" id="1955991">.</span><span class="ident" id="1955992">Pointer</span><span class="op" id="1955999">(</span><span class="ident" id="1956000">b</span><span class="op" id="1956001">)</span><span class="op" id="1956002">,</span>&nbsp;<span class="ident" id="1956004">unsafe</span><span class="op" id="1956010">.</span><span class="ident" id="1956011">Sizeof</span><span class="op" id="1956017">(</span><span class="op" id="1956018">*</span><span class="ident" id="1956019">b</span><span class="op" id="1956020">)</span><span class="op" id="1956021">+</span><span class="ident" id="1956022">b</span><span class="op" id="1956023">.</span><span class="ident" id="1956024">nstk</span><span class="op" id="1956028">*</span><span class="ident" id="1956029">unsafe</span><span class="op" id="1956035">.</span><span class="ident" id="1956036">Sizeof</span><span class="op" id="1956042">(</span><span class="builtintype" id="1956043">uintptr</span><span class="op" id="1956050">(</span><span class="num" id="1956051">0</span><span class="op" id="1956052">)</span><span class="op" id="1956053">)</span><span class="op" id="1956054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956057">return</span>&nbsp;<span class="op" id="1956064">(</span><span class="op" id="1956065">*</span><span class="ident" id="1956066">blockRecord</span><span class="op" id="1956077">)</span><span class="op" id="1956078">(</span><span class="ident" id="1956079">data</span><span class="op" id="1956083">)</span><br>
<span class="lineno"></span><span class="op" id="1956085">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1956088">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1956159">func</span>&nbsp;<span class="ident" id="1956164">stkbucket</span><span class="op" id="1956173">(</span><span class="ident" id="1956174">typ</span>&nbsp;<span class="ident" id="1956178">bucketType</span><span class="op" id="1956188">,</span>&nbsp;<span class="ident" id="1956190">size</span>&nbsp;<span class="builtintype" id="1956195">uintptr</span><span class="op" id="1956202">,</span>&nbsp;<span class="ident" id="1956204">stk</span>&nbsp;<span class="op" id="1956208">[</span><span class="op" id="1956209">]</span><span class="builtintype" id="1956210">uintptr</span><span class="op" id="1956217">,</span>&nbsp;<span class="ident" id="1956219">alloc</span>&nbsp;<span class="builtintype" id="1956225">bool</span><span class="op" id="1956229">)</span>&nbsp;<span class="op" id="1956231">*</span><span class="ident" id="1956232">bucket</span>&nbsp;<span class="op" id="1956239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956242">if</span>&nbsp;<span class="ident" id="1956245">buckhash</span>&nbsp;<span class="op" id="1956254">==</span>&nbsp;<span class="ident" id="1956257">nil</span>&nbsp;<span class="op" id="1956261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956265">buckhash</span>&nbsp;<span class="op" id="1956274">=</span>&nbsp;<span class="op" id="1956276">(</span><span class="op" id="1956277">*</span><span class="op" id="1956278">[</span><span class="ident" id="1956279">buckHashSize</span><span class="op" id="1956291">]</span><span class="op" id="1956292">*</span><span class="ident" id="1956293">bucket</span><span class="op" id="1956299">)</span><span class="op" id="1956300">(</span><span class="ident" id="1956301">sysAlloc</span><span class="op" id="1956309">(</span><span class="ident" id="1956310">unsafe</span><span class="op" id="1956316">.</span><span class="ident" id="1956317">Sizeof</span><span class="op" id="1956323">(</span><span class="op" id="1956324">*</span><span class="ident" id="1956325">buckhash</span><span class="op" id="1956333">)</span><span class="op" id="1956334">,</span>&nbsp;<span class="op" id="1956336">&amp;</span><span class="ident" id="1956337">memstats</span><span class="op" id="1956345">.</span><span class="ident" id="1956346">buckhash_sys</span><span class="op" id="1956358">)</span><span class="op" id="1956359">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956363">if</span>&nbsp;<span class="ident" id="1956366">buckhash</span>&nbsp;<span class="op" id="1956375">==</span>&nbsp;<span class="ident" id="1956378">nil</span>&nbsp;<span class="op" id="1956382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956387">gothrow</span><span class="op" id="1956394">(</span><span class="string" id="1956395">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1956428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1956439">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956455">var</span>&nbsp;<span class="ident" id="1956459">h</span>&nbsp;<span class="builtintype" id="1956461">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956470">for</span>&nbsp;<span class="ident" id="1956474">_</span><span class="op" id="1956475">,</span>&nbsp;<span class="ident" id="1956477">pc</span>&nbsp;<span class="op" id="1956480">:=</span>&nbsp;<span class="keyword" id="1956483">range</span>&nbsp;<span class="ident" id="1956489">stk</span>&nbsp;<span class="op" id="1956493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956497">h</span>&nbsp;<span class="op" id="1956499">+=</span>&nbsp;<span class="ident" id="1956502">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956507">h</span>&nbsp;<span class="op" id="1956509">+=</span>&nbsp;<span class="ident" id="1956512">h</span>&nbsp;<span class="op" id="1956514">&lt;&lt;</span>&nbsp;<span class="num" id="1956517">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956522">h</span>&nbsp;<span class="op" id="1956524">^=</span>&nbsp;<span class="ident" id="1956527">h</span>&nbsp;<span class="op" id="1956529">&gt;&gt;</span>&nbsp;<span class="num" id="1956532">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1956538">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956555">h</span>&nbsp;<span class="op" id="1956557">+=</span>&nbsp;<span class="ident" id="1956560">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956566">h</span>&nbsp;<span class="op" id="1956568">+=</span>&nbsp;<span class="ident" id="1956571">h</span>&nbsp;<span class="op" id="1956573">&lt;&lt;</span>&nbsp;<span class="num" id="1956576">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956580">h</span>&nbsp;<span class="op" id="1956582">^=</span>&nbsp;<span class="ident" id="1956585">h</span>&nbsp;<span class="op" id="1956587">&gt;&gt;</span>&nbsp;<span class="num" id="1956590">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1956593">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956606">h</span>&nbsp;<span class="op" id="1956608">+=</span>&nbsp;<span class="ident" id="1956611">h</span>&nbsp;<span class="op" id="1956613">&lt;&lt;</span>&nbsp;<span class="num" id="1956616">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956619">h</span>&nbsp;<span class="op" id="1956621">^=</span>&nbsp;<span class="ident" id="1956624">h</span>&nbsp;<span class="op" id="1956626">&gt;&gt;</span>&nbsp;<span class="num" id="1956629">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956634">i</span>&nbsp;<span class="op" id="1956636">:=</span>&nbsp;<span class="builtintype" id="1956639">int</span><span class="op" id="1956642">(</span><span class="ident" id="1956643">h</span>&nbsp;<span class="op" id="1956645">%</span>&nbsp;<span class="ident" id="1956647">buckHashSize</span><span class="op" id="1956659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956662">for</span>&nbsp;<span class="ident" id="1956666">b</span>&nbsp;<span class="op" id="1956668">:=</span>&nbsp;<span class="ident" id="1956671">buckhash</span><span class="op" id="1956679">[</span><span class="ident" id="1956680">i</span><span class="op" id="1956681">]</span><span class="op" id="1956682">;</span>&nbsp;<span class="ident" id="1956684">b</span>&nbsp;<span class="op" id="1956686">!=</span>&nbsp;<span class="ident" id="1956689">nil</span><span class="op" id="1956692">;</span>&nbsp;<span class="ident" id="1956694">b</span>&nbsp;<span class="op" id="1956696">=</span>&nbsp;<span class="ident" id="1956698">b</span><span class="op" id="1956699">.</span><span class="ident" id="1956700">next</span>&nbsp;<span class="op" id="1956705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956709">if</span>&nbsp;<span class="ident" id="1956712">b</span><span class="op" id="1956713">.</span><span class="ident" id="1956714">typ</span>&nbsp;<span class="op" id="1956718">==</span>&nbsp;<span class="ident" id="1956721">typ</span>&nbsp;<span class="op" id="1956725">&amp;&amp;</span>&nbsp;<span class="ident" id="1956728">b</span><span class="op" id="1956729">.</span><span class="ident" id="1956730">hash</span>&nbsp;<span class="op" id="1956735">==</span>&nbsp;<span class="ident" id="1956738">h</span>&nbsp;<span class="op" id="1956740">&amp;&amp;</span>&nbsp;<span class="ident" id="1956743">b</span><span class="op" id="1956744">.</span><span class="ident" id="1956745">size</span>&nbsp;<span class="op" id="1956750">==</span>&nbsp;<span class="ident" id="1956753">size</span>&nbsp;<span class="op" id="1956758">&amp;&amp;</span>&nbsp;<span class="ident" id="1956761">eqslice</span><span class="op" id="1956768">(</span><span class="ident" id="1956769">b</span><span class="op" id="1956770">.</span><span class="ident" id="1956771">stk</span><span class="op" id="1956774">(</span><span class="op" id="1956775">)</span><span class="op" id="1956776">,</span>&nbsp;<span class="ident" id="1956778">stk</span><span class="op" id="1956781">)</span>&nbsp;<span class="op" id="1956783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956788">return</span>&nbsp;<span class="ident" id="1956795">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956799">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956806">if</span>&nbsp;<span class="op" id="1956809">!</span><span class="ident" id="1956810">alloc</span>&nbsp;<span class="op" id="1956816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956820">return</span>&nbsp;<span class="ident" id="1956827">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1956832">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1956836">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956859">b</span>&nbsp;<span class="op" id="1956861">:=</span>&nbsp;<span class="ident" id="1956864">newBucket</span><span class="op" id="1956873">(</span><span class="ident" id="1956874">typ</span><span class="op" id="1956877">,</span>&nbsp;<span class="builtinfunc" id="1956879">len</span><span class="op" id="1956882">(</span><span class="ident" id="1956883">stk</span><span class="op" id="1956886">)</span><span class="op" id="1956887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1956890">copy</span><span class="op" id="1956894">(</span><span class="ident" id="1956895">b</span><span class="op" id="1956896">.</span><span class="ident" id="1956897">stk</span><span class="op" id="1956900">(</span><span class="op" id="1956901">)</span><span class="op" id="1956902">,</span>&nbsp;<span class="ident" id="1956904">stk</span><span class="op" id="1956907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956910">b</span><span class="op" id="1956911">.</span><span class="ident" id="1956912">hash</span>&nbsp;<span class="op" id="1956917">=</span>&nbsp;<span class="ident" id="1956919">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956922">b</span><span class="op" id="1956923">.</span><span class="ident" id="1956924">size</span>&nbsp;<span class="op" id="1956929">=</span>&nbsp;<span class="ident" id="1956931">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956937">b</span><span class="op" id="1956938">.</span><span class="ident" id="1956939">next</span>&nbsp;<span class="op" id="1956944">=</span>&nbsp;<span class="ident" id="1956946">buckhash</span><span class="op" id="1956954">[</span><span class="ident" id="1956955">i</span><span class="op" id="1956956">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1956959">buckhash</span><span class="op" id="1956967">[</span><span class="ident" id="1956968">i</span><span class="op" id="1956969">]</span>&nbsp;<span class="op" id="1956971">=</span>&nbsp;<span class="ident" id="1956973">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1956976">if</span>&nbsp;<span class="ident" id="1956979">typ</span>&nbsp;<span class="op" id="1956983">==</span>&nbsp;<span class="ident" id="1956986">memProfile</span>&nbsp;<span class="op" id="1956997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957001">b</span><span class="op" id="1957002">.</span><span class="ident" id="1957003">allnext</span>&nbsp;<span class="op" id="1957011">=</span>&nbsp;<span class="ident" id="1957013">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957024">mbuckets</span>&nbsp;<span class="op" id="1957033">=</span>&nbsp;<span class="ident" id="1957035">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957038">}</span>&nbsp;<span class="keyword" id="1957040">else</span>&nbsp;<span class="op" id="1957045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957049">b</span><span class="op" id="1957050">.</span><span class="ident" id="1957051">allnext</span>&nbsp;<span class="op" id="1957059">=</span>&nbsp;<span class="ident" id="1957061">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957072">bbuckets</span>&nbsp;<span class="op" id="1957081">=</span>&nbsp;<span class="ident" id="1957083">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957086">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957089">return</span>&nbsp;<span class="ident" id="1957096">b</span><br>
<span class="lineno"></span><span class="op" id="1957098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1957101">func</span>&nbsp;<span class="ident" id="1957106">sysAlloc</span><span class="op" id="1957114">(</span><span class="ident" id="1957115">n</span>&nbsp;<span class="builtintype" id="1957117">uintptr</span><span class="op" id="1957124">,</span>&nbsp;<span class="ident" id="1957126">stat</span>&nbsp;<span class="op" id="1957131">*</span><span class="ident" id="1957132">uint64</span><span class="op" id="1957138">)</span>&nbsp;<span class="ident" id="1957140">unsafe</span><span class="op" id="1957146">.</span><span class="ident" id="1957147">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1957156">func</span>&nbsp;<span class="ident" id="1957161">eqslice</span><span class="op" id="1957168">(</span><span class="ident" id="1957169">x</span><span class="op" id="1957170">,</span>&nbsp;<span class="ident" id="1957172">y</span>&nbsp;<span class="op" id="1957174">[</span><span class="op" id="1957175">]</span><span class="builtintype" id="1957176">uintptr</span><span class="op" id="1957183">)</span>&nbsp;<span class="builtintype" id="1957185">bool</span>&nbsp;<span class="op" id="1957190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957193">if</span>&nbsp;<span class="builtinfunc" id="1957196">len</span><span class="op" id="1957199">(</span><span class="ident" id="1957200">x</span><span class="op" id="1957201">)</span>&nbsp;<span class="op" id="1957203">!=</span>&nbsp;<span class="builtinfunc" id="1957206">len</span><span class="op" id="1957209">(</span><span class="ident" id="1957210">y</span><span class="op" id="1957211">)</span>&nbsp;<span class="op" id="1957213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957217">return</span>&nbsp;<span class="builtintype" id="1957224">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957234">for</span>&nbsp;<span class="ident" id="1957238">i</span><span class="op" id="1957239">,</span>&nbsp;<span class="ident" id="1957241">xi</span>&nbsp;<span class="op" id="1957244">:=</span>&nbsp;<span class="keyword" id="1957247">range</span>&nbsp;<span class="ident" id="1957253">x</span>&nbsp;<span class="op" id="1957255">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957259">if</span>&nbsp;<span class="ident" id="1957262">xi</span>&nbsp;<span class="op" id="1957265">!=</span>&nbsp;<span class="ident" id="1957268">y</span><span class="op" id="1957269">[</span><span class="ident" id="1957270">i</span><span class="op" id="1957271">]</span>&nbsp;<span class="op" id="1957273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957278">return</span>&nbsp;<span class="builtintype" id="1957285">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957299">return</span>&nbsp;<span class="builtintype" id="1957306">true</span><br>
<span class="lineno">205</span><span class="op" id="1957311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1957314">func</span>&nbsp;<span class="ident" id="1957319">mprof_GC</span><span class="op" id="1957327">(</span><span class="op" id="1957328">)</span>&nbsp;<span class="op" id="1957330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1957333">for</span>&nbsp;<span class="ident" id="1957337">b</span>&nbsp;<span class="op" id="1957339">:=</span>&nbsp;<span class="ident" id="1957342">mbuckets</span><span class="op" id="1957350">;</span>&nbsp;<span class="ident" id="1957352">b</span>&nbsp;<span class="op" id="1957354">!=</span>&nbsp;<span class="ident" id="1957357">nil</span><span class="op" id="1957360">;</span>&nbsp;<span class="ident" id="1957362">b</span>&nbsp;<span class="op" id="1957364">=</span>&nbsp;<span class="ident" id="1957366">b</span><span class="op" id="1957367">.</span><span class="ident" id="1957368">allnext</span>&nbsp;<span class="op" id="1957376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957380">mp</span>&nbsp;<span class="op" id="1957383">:=</span>&nbsp;<span class="ident" id="1957386">b</span><span class="op" id="1957387">.</span><span class="ident" id="1957388">mp</span><span class="op" id="1957390">(</span><span class="op" id="1957391">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957395">mp</span><span class="op" id="1957397">.</span><span class="ident" id="1957398">allocs</span>&nbsp;<span class="op" id="1957405">+=</span>&nbsp;<span class="ident" id="1957408">mp</span><span class="op" id="1957410">.</span><span class="ident" id="1957411">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957425">mp</span><span class="op" id="1957427">.</span><span class="ident" id="1957428">frees</span>&nbsp;<span class="op" id="1957434">+=</span>&nbsp;<span class="ident" id="1957437">mp</span><span class="op" id="1957439">.</span><span class="ident" id="1957440">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957453">mp</span><span class="op" id="1957455">.</span><span class="ident" id="1957456">alloc_bytes</span>&nbsp;<span class="op" id="1957468">+=</span>&nbsp;<span class="ident" id="1957471">mp</span><span class="op" id="1957473">.</span><span class="ident" id="1957474">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957493">mp</span><span class="op" id="1957495">.</span><span class="ident" id="1957496">free_bytes</span>&nbsp;<span class="op" id="1957507">+=</span>&nbsp;<span class="ident" id="1957510">mp</span><span class="op" id="1957512">.</span><span class="ident" id="1957513">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957532">mp</span><span class="op" id="1957534">.</span><span class="ident" id="1957535">prev_allocs</span>&nbsp;<span class="op" id="1957547">=</span>&nbsp;<span class="ident" id="1957549">mp</span><span class="op" id="1957551">.</span><span class="ident" id="1957552">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957568">mp</span><span class="op" id="1957570">.</span><span class="ident" id="1957571">prev_frees</span>&nbsp;<span class="op" id="1957582">=</span>&nbsp;<span class="ident" id="1957584">mp</span><span class="op" id="1957586">.</span><span class="ident" id="1957587">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957602">mp</span><span class="op" id="1957604">.</span><span class="ident" id="1957605">prev_alloc_bytes</span>&nbsp;<span class="op" id="1957622">=</span>&nbsp;<span class="ident" id="1957624">mp</span><span class="op" id="1957626">.</span><span class="ident" id="1957627">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957648">mp</span><span class="op" id="1957650">.</span><span class="ident" id="1957651">prev_free_bytes</span>&nbsp;<span class="op" id="1957667">=</span>&nbsp;<span class="ident" id="1957669">mp</span><span class="op" id="1957671">.</span><span class="ident" id="1957672">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957693">mp</span><span class="op" id="1957695">.</span><span class="ident" id="1957696">recent_allocs</span>&nbsp;<span class="op" id="1957710">=</span>&nbsp;<span class="num" id="1957712">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957716">mp</span><span class="op" id="1957718">.</span><span class="ident" id="1957719">recent_frees</span>&nbsp;<span class="op" id="1957732">=</span>&nbsp;<span class="num" id="1957734">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957738">mp</span><span class="op" id="1957740">.</span><span class="ident" id="1957741">recent_alloc_bytes</span>&nbsp;<span class="op" id="1957760">=</span>&nbsp;<span class="num" id="1957762">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957766">mp</span><span class="op" id="1957768">.</span><span class="ident" id="1957769">recent_free_bytes</span>&nbsp;<span class="op" id="1957787">=</span>&nbsp;<span class="num" id="1957789">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1957792">}</span><br>
<span class="lineno">225</span><span class="op" id="1957794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1957797">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1957874">func</span>&nbsp;<span class="ident" id="1957879">mProf_GC</span><span class="op" id="1957887">(</span><span class="op" id="1957888">)</span>&nbsp;<span class="op" id="1957890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957893">lock</span><span class="op" id="1957897">(</span><span class="op" id="1957898">&amp;</span><span class="ident" id="1957899">proflock</span><span class="op" id="1957907">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957910">mprof_GC</span><span class="op" id="1957918">(</span><span class="op" id="1957919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1957922">unlock</span><span class="op" id="1957928">(</span><span class="op" id="1957929">&amp;</span><span class="ident" id="1957930">proflock</span><span class="op" id="1957938">)</span><br>
<span class="lineno"></span><span class="op" id="1957940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1957943">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1957991">func</span>&nbsp;<span class="ident" id="1957996">mProf_Malloc</span><span class="op" id="1958008">(</span><span class="ident" id="1958009">p</span>&nbsp;<span class="ident" id="1958011">unsafe</span><span class="op" id="1958017">.</span><span class="ident" id="1958018">Pointer</span><span class="op" id="1958025">,</span>&nbsp;<span class="ident" id="1958027">size</span>&nbsp;<span class="builtintype" id="1958032">uintptr</span><span class="op" id="1958039">)</span>&nbsp;<span class="op" id="1958041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1958044">var</span>&nbsp;<span class="ident" id="1958048">stk</span>&nbsp;<span class="op" id="1958052">[</span><span class="ident" id="1958053">maxStack</span><span class="op" id="1958061">]</span><span class="builtintype" id="1958062">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958071">nstk</span>&nbsp;<span class="op" id="1958076">:=</span>&nbsp;<span class="ident" id="1958079">callers</span><span class="op" id="1958086">(</span><span class="num" id="1958087">4</span><span class="op" id="1958088">,</span>&nbsp;<span class="op" id="1958090">&amp;</span><span class="ident" id="1958091">stk</span><span class="op" id="1958094">[</span><span class="num" id="1958095">0</span><span class="op" id="1958096">]</span><span class="op" id="1958097">,</span>&nbsp;<span class="builtinfunc" id="1958099">len</span><span class="op" id="1958102">(</span><span class="ident" id="1958103">stk</span><span class="op" id="1958106">)</span><span class="op" id="1958107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958110">lock</span><span class="op" id="1958114">(</span><span class="op" id="1958115">&amp;</span><span class="ident" id="1958116">proflock</span><span class="op" id="1958124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958127">b</span>&nbsp;<span class="op" id="1958129">:=</span>&nbsp;<span class="ident" id="1958132">stkbucket</span><span class="op" id="1958141">(</span><span class="ident" id="1958142">memProfile</span><span class="op" id="1958152">,</span>&nbsp;<span class="ident" id="1958154">size</span><span class="op" id="1958158">,</span>&nbsp;<span class="ident" id="1958160">stk</span><span class="op" id="1958163">[</span><span class="op" id="1958164">:</span><span class="ident" id="1958165">nstk</span><span class="op" id="1958169">]</span><span class="op" id="1958170">,</span>&nbsp;<span class="builtintype" id="1958172">true</span><span class="op" id="1958176">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958179">mp</span>&nbsp;<span class="op" id="1958182">:=</span>&nbsp;<span class="ident" id="1958185">b</span><span class="op" id="1958186">.</span><span class="ident" id="1958187">mp</span><span class="op" id="1958189">(</span><span class="op" id="1958190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958193">mp</span><span class="op" id="1958195">.</span><span class="ident" id="1958196">recent_allocs</span><span class="op" id="1958209">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958213">mp</span><span class="op" id="1958215">.</span><span class="ident" id="1958216">recent_alloc_bytes</span>&nbsp;<span class="op" id="1958235">+=</span>&nbsp;<span class="ident" id="1958238">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958244">unlock</span><span class="op" id="1958250">(</span><span class="op" id="1958251">&amp;</span><span class="ident" id="1958252">proflock</span><span class="op" id="1958260">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1958264">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1958352">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1958416">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1958480">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958521">setprofilebucket</span><span class="op" id="1958537">(</span><span class="ident" id="1958538">p</span><span class="op" id="1958539">,</span>&nbsp;<span class="ident" id="1958541">b</span><span class="op" id="1958542">)</span><br>
<span class="lineno">250</span><span class="op" id="1958544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1958547">func</span>&nbsp;<span class="ident" id="1958552">setprofilebucket_m</span><span class="op" id="1958570">(</span><span class="op" id="1958571">)</span>&nbsp;<span class="comment" id="1958573">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1958585">func</span>&nbsp;<span class="ident" id="1958590">setprofilebucket</span><span class="op" id="1958606">(</span><span class="ident" id="1958607">p</span>&nbsp;<span class="ident" id="1958609">unsafe</span><span class="op" id="1958615">.</span><span class="ident" id="1958616">Pointer</span><span class="op" id="1958623">,</span>&nbsp;<span class="ident" id="1958625">b</span>&nbsp;<span class="op" id="1958627">*</span><span class="ident" id="1958628">bucket</span><span class="op" id="1958634">)</span>&nbsp;<span class="op" id="1958636">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958639">g</span>&nbsp;<span class="op" id="1958641">:=</span>&nbsp;<span class="ident" id="1958644">getg</span><span class="op" id="1958648">(</span><span class="op" id="1958649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958652">g</span><span class="op" id="1958653">.</span><span class="ident" id="1958654">m</span><span class="op" id="1958655">.</span><span class="ident" id="1958656">ptrarg</span><span class="op" id="1958662">[</span><span class="num" id="1958663">0</span><span class="op" id="1958664">]</span>&nbsp;<span class="op" id="1958666">=</span>&nbsp;<span class="ident" id="1958668">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958671">g</span><span class="op" id="1958672">.</span><span class="ident" id="1958673">m</span><span class="op" id="1958674">.</span><span class="ident" id="1958675">ptrarg</span><span class="op" id="1958681">[</span><span class="num" id="1958682">1</span><span class="op" id="1958683">]</span>&nbsp;<span class="op" id="1958685">=</span>&nbsp;<span class="ident" id="1958687">unsafe</span><span class="op" id="1958693">.</span><span class="ident" id="1958694">Pointer</span><span class="op" id="1958701">(</span><span class="ident" id="1958702">b</span><span class="op" id="1958703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958706">onM</span><span class="op" id="1958709">(</span><span class="ident" id="1958710">setprofilebucket_m</span><span class="op" id="1958728">)</span><br>
<span class="lineno"></span><span class="op" id="1958730">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1958733">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1958774">func</span>&nbsp;<span class="ident" id="1958779">mProf_Free</span><span class="op" id="1958789">(</span><span class="ident" id="1958790">b</span>&nbsp;<span class="op" id="1958792">*</span><span class="ident" id="1958793">bucket</span><span class="op" id="1958799">,</span>&nbsp;<span class="ident" id="1958801">size</span>&nbsp;<span class="builtintype" id="1958806">uintptr</span><span class="op" id="1958813">,</span>&nbsp;<span class="ident" id="1958815">freed</span>&nbsp;<span class="builtintype" id="1958821">bool</span><span class="op" id="1958825">)</span>&nbsp;<span class="op" id="1958827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958830">lock</span><span class="op" id="1958834">(</span><span class="op" id="1958835">&amp;</span><span class="ident" id="1958836">proflock</span><span class="op" id="1958844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958847">mp</span>&nbsp;<span class="op" id="1958850">:=</span>&nbsp;<span class="ident" id="1958853">b</span><span class="op" id="1958854">.</span><span class="ident" id="1958855">mp</span><span class="op" id="1958857">(</span><span class="op" id="1958858">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1958861">if</span>&nbsp;<span class="ident" id="1958864">freed</span>&nbsp;<span class="op" id="1958870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958874">mp</span><span class="op" id="1958876">.</span><span class="ident" id="1958877">recent_frees</span><span class="op" id="1958889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958894">mp</span><span class="op" id="1958896">.</span><span class="ident" id="1958897">recent_free_bytes</span>&nbsp;<span class="op" id="1958915">+=</span>&nbsp;<span class="ident" id="1958918">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1958924">}</span>&nbsp;<span class="keyword" id="1958926">else</span>&nbsp;<span class="op" id="1958931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958935">mp</span><span class="op" id="1958937">.</span><span class="ident" id="1958938">prev_frees</span><span class="op" id="1958948">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958953">mp</span><span class="op" id="1958955">.</span><span class="ident" id="1958956">prev_free_bytes</span>&nbsp;<span class="op" id="1958972">+=</span>&nbsp;<span class="ident" id="1958975">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1958981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1958984">unlock</span><span class="op" id="1958990">(</span><span class="op" id="1958991">&amp;</span><span class="ident" id="1958992">proflock</span><span class="op" id="1959000">)</span><br>
<span class="lineno"></span><span class="op" id="1959002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1959005">var</span>&nbsp;<span class="ident" id="1959009">blockprofilerate</span>&nbsp;<span class="ident" id="1959026">uint64</span>&nbsp;<span class="comment" id="1959033">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1959050">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1959124">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1959199">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1959271">//</span><br>
<span class="lineno"></span><span class="comment" id="1959274">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1959340">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1959391">func</span>&nbsp;<span class="ident" id="1959396">SetBlockProfileRate</span><span class="op" id="1959415">(</span><span class="ident" id="1959416">rate</span>&nbsp;<span class="builtintype" id="1959421">int</span><span class="op" id="1959424">)</span>&nbsp;<span class="op" id="1959426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959429">var</span>&nbsp;<span class="ident" id="1959433">r</span>&nbsp;<span class="ident" id="1959435">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959442">if</span>&nbsp;<span class="ident" id="1959445">rate</span>&nbsp;<span class="op" id="1959450">&lt;=</span>&nbsp;<span class="num" id="1959453">0</span>&nbsp;<span class="op" id="1959455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959459">r</span>&nbsp;<span class="op" id="1959461">=</span>&nbsp;<span class="num" id="1959463">0</span>&nbsp;<span class="comment" id="1959465">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959487">}</span>&nbsp;<span class="keyword" id="1959489">else</span>&nbsp;<span class="keyword" id="1959494">if</span>&nbsp;<span class="ident" id="1959497">rate</span>&nbsp;<span class="op" id="1959502">==</span>&nbsp;<span class="num" id="1959505">1</span>&nbsp;<span class="op" id="1959507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959511">r</span>&nbsp;<span class="op" id="1959513">=</span>&nbsp;<span class="num" id="1959515">1</span>&nbsp;<span class="comment" id="1959517">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959540">}</span>&nbsp;<span class="keyword" id="1959542">else</span>&nbsp;<span class="op" id="1959547">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1959551">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959632">r</span>&nbsp;<span class="op" id="1959634">=</span>&nbsp;<span class="ident" id="1959636">int64</span><span class="op" id="1959641">(</span><span class="builtintype" id="1959642">float64</span><span class="op" id="1959649">(</span><span class="ident" id="1959650">rate</span><span class="op" id="1959654">)</span>&nbsp;<span class="op" id="1959656">*</span>&nbsp;<span class="builtintype" id="1959658">float64</span><span class="op" id="1959665">(</span><span class="ident" id="1959666">tickspersecond</span><span class="op" id="1959680">(</span><span class="op" id="1959681">)</span><span class="op" id="1959682">)</span>&nbsp;<span class="op" id="1959684">/</span>&nbsp;<span class="op" id="1959686">(</span><span class="num" id="1959687">1000</span>&nbsp;<span class="op" id="1959692">*</span>&nbsp;<span class="num" id="1959694">1000</span>&nbsp;<span class="op" id="1959699">*</span>&nbsp;<span class="num" id="1959701">1000</span><span class="op" id="1959705">)</span><span class="op" id="1959706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959710">if</span>&nbsp;<span class="ident" id="1959713">r</span>&nbsp;<span class="op" id="1959715">==</span>&nbsp;<span class="num" id="1959718">0</span>&nbsp;<span class="op" id="1959720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959725">r</span>&nbsp;<span class="op" id="1959727">=</span>&nbsp;<span class="num" id="1959729">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959733">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959740">atomicstore64</span><span class="op" id="1959753">(</span><span class="op" id="1959754">&amp;</span><span class="ident" id="1959755">blockprofilerate</span><span class="op" id="1959771">,</span>&nbsp;<span class="ident" id="1959773">uint64</span><span class="op" id="1959779">(</span><span class="ident" id="1959780">r</span><span class="op" id="1959781">)</span><span class="op" id="1959782">)</span><br>
<span class="lineno"></span><span class="op" id="1959784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1959787">func</span>&nbsp;<span class="ident" id="1959792">blockevent</span><span class="op" id="1959802">(</span><span class="ident" id="1959803">cycles</span>&nbsp;<span class="ident" id="1959810">int64</span><span class="op" id="1959815">,</span>&nbsp;<span class="ident" id="1959817">skip</span>&nbsp;<span class="builtintype" id="1959822">int</span><span class="op" id="1959825">)</span>&nbsp;<span class="op" id="1959827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959830">if</span>&nbsp;<span class="ident" id="1959833">cycles</span>&nbsp;<span class="op" id="1959840">&lt;=</span>&nbsp;<span class="num" id="1959843">0</span>&nbsp;<span class="op" id="1959845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959849">cycles</span>&nbsp;<span class="op" id="1959856">=</span>&nbsp;<span class="num" id="1959858">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959864">rate</span>&nbsp;<span class="op" id="1959869">:=</span>&nbsp;<span class="ident" id="1959872">int64</span><span class="op" id="1959877">(</span><span class="ident" id="1959878">atomicload64</span><span class="op" id="1959890">(</span><span class="op" id="1959891">&amp;</span><span class="ident" id="1959892">blockprofilerate</span><span class="op" id="1959908">)</span><span class="op" id="1959909">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959912">if</span>&nbsp;<span class="ident" id="1959915">rate</span>&nbsp;<span class="op" id="1959920">&lt;=</span>&nbsp;<span class="num" id="1959923">0</span>&nbsp;<span class="op" id="1959925">||</span>&nbsp;<span class="op" id="1959928">(</span><span class="ident" id="1959929">rate</span>&nbsp;<span class="op" id="1959934">&gt;</span>&nbsp;<span class="ident" id="1959936">cycles</span>&nbsp;<span class="op" id="1959943">&amp;&amp;</span>&nbsp;<span class="ident" id="1959946">int64</span><span class="op" id="1959951">(</span><span class="ident" id="1959952">fastrand1</span><span class="op" id="1959961">(</span><span class="op" id="1959962">)</span><span class="op" id="1959963">)</span><span class="op" id="1959964">%</span><span class="ident" id="1959965">rate</span>&nbsp;<span class="op" id="1959970">&gt;</span>&nbsp;<span class="ident" id="1959972">cycles</span><span class="op" id="1959978">)</span>&nbsp;<span class="op" id="1959980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1959984">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1959992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1959995">gp</span>&nbsp;<span class="op" id="1959998">:=</span>&nbsp;<span class="ident" id="1960001">getg</span><span class="op" id="1960005">(</span><span class="op" id="1960006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960009">var</span>&nbsp;<span class="ident" id="1960013">nstk</span>&nbsp;<span class="builtintype" id="1960018">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960023">var</span>&nbsp;<span class="ident" id="1960027">stk</span>&nbsp;<span class="op" id="1960031">[</span><span class="ident" id="1960032">maxStack</span><span class="op" id="1960040">]</span><span class="builtintype" id="1960041">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960050">if</span>&nbsp;<span class="ident" id="1960053">gp</span><span class="op" id="1960055">.</span><span class="ident" id="1960056">m</span><span class="op" id="1960057">.</span><span class="ident" id="1960058">curg</span>&nbsp;<span class="op" id="1960063">==</span>&nbsp;<span class="ident" id="1960066">nil</span>&nbsp;<span class="op" id="1960070">||</span>&nbsp;<span class="ident" id="1960073">gp</span><span class="op" id="1960075">.</span><span class="ident" id="1960076">m</span><span class="op" id="1960077">.</span><span class="ident" id="1960078">curg</span>&nbsp;<span class="op" id="1960083">==</span>&nbsp;<span class="ident" id="1960086">gp</span>&nbsp;<span class="op" id="1960089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960093">nstk</span>&nbsp;<span class="op" id="1960098">=</span>&nbsp;<span class="ident" id="1960100">callers</span><span class="op" id="1960107">(</span><span class="ident" id="1960108">skip</span><span class="op" id="1960112">,</span>&nbsp;<span class="op" id="1960114">&amp;</span><span class="ident" id="1960115">stk</span><span class="op" id="1960118">[</span><span class="num" id="1960119">0</span><span class="op" id="1960120">]</span><span class="op" id="1960121">,</span>&nbsp;<span class="builtinfunc" id="1960123">len</span><span class="op" id="1960126">(</span><span class="ident" id="1960127">stk</span><span class="op" id="1960130">)</span><span class="op" id="1960131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1960134">}</span>&nbsp;<span class="keyword" id="1960136">else</span>&nbsp;<span class="op" id="1960141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960145">nstk</span>&nbsp;<span class="op" id="1960150">=</span>&nbsp;<span class="ident" id="1960152">gcallers</span><span class="op" id="1960160">(</span><span class="ident" id="1960161">gp</span><span class="op" id="1960163">.</span><span class="ident" id="1960164">m</span><span class="op" id="1960165">.</span><span class="ident" id="1960166">curg</span><span class="op" id="1960170">,</span>&nbsp;<span class="ident" id="1960172">skip</span><span class="op" id="1960176">,</span>&nbsp;<span class="op" id="1960178">&amp;</span><span class="ident" id="1960179">stk</span><span class="op" id="1960182">[</span><span class="num" id="1960183">0</span><span class="op" id="1960184">]</span><span class="op" id="1960185">,</span>&nbsp;<span class="builtinfunc" id="1960187">len</span><span class="op" id="1960190">(</span><span class="ident" id="1960191">stk</span><span class="op" id="1960194">)</span><span class="op" id="1960195">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1960198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960201">lock</span><span class="op" id="1960205">(</span><span class="op" id="1960206">&amp;</span><span class="ident" id="1960207">proflock</span><span class="op" id="1960215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960218">b</span>&nbsp;<span class="op" id="1960220">:=</span>&nbsp;<span class="ident" id="1960223">stkbucket</span><span class="op" id="1960232">(</span><span class="ident" id="1960233">blockProfile</span><span class="op" id="1960245">,</span>&nbsp;<span class="num" id="1960247">0</span><span class="op" id="1960248">,</span>&nbsp;<span class="ident" id="1960250">stk</span><span class="op" id="1960253">[</span><span class="op" id="1960254">:</span><span class="ident" id="1960255">nstk</span><span class="op" id="1960259">]</span><span class="op" id="1960260">,</span>&nbsp;<span class="builtintype" id="1960262">true</span><span class="op" id="1960266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960269">b</span><span class="op" id="1960270">.</span><span class="ident" id="1960271">bp</span><span class="op" id="1960273">(</span><span class="op" id="1960274">)</span><span class="op" id="1960275">.</span><span class="ident" id="1960276">count</span><span class="op" id="1960281">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960285">b</span><span class="op" id="1960286">.</span><span class="ident" id="1960287">bp</span><span class="op" id="1960289">(</span><span class="op" id="1960290">)</span><span class="op" id="1960291">.</span><span class="ident" id="1960292">cycles</span>&nbsp;<span class="op" id="1960299">+=</span>&nbsp;<span class="ident" id="1960302">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960310">unlock</span><span class="op" id="1960316">(</span><span class="op" id="1960317">&amp;</span><span class="ident" id="1960318">proflock</span><span class="op" id="1960326">)</span><br>
<span class="lineno"></span><span class="op" id="1960328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1960331">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1960365">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1960418">type</span>&nbsp;<span class="ident" id="1960423">StackRecord</span>&nbsp;<span class="keyword" id="1960435">struct</span>&nbsp;<span class="op" id="1960442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1960445">Stack0</span>&nbsp;<span class="op" id="1960452">[</span><span class="num" id="1960453">32</span><span class="op" id="1960455">]</span><span class="builtintype" id="1960456">uintptr</span>&nbsp;<span class="comment" id="1960464">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1960518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1960521">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1960582">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1960607">func</span>&nbsp;<span class="op" id="1960612">(</span><span class="ident" id="1960613">r</span>&nbsp;<span class="op" id="1960615">*</span><span class="ident" id="1960616">StackRecord</span><span class="op" id="1960627">)</span>&nbsp;<span class="ident" id="1960629">Stack</span><span class="op" id="1960634">(</span><span class="op" id="1960635">)</span>&nbsp;<span class="op" id="1960637">[</span><span class="op" id="1960638">]</span><span class="builtintype" id="1960639">uintptr</span>&nbsp;<span class="op" id="1960647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960650">for</span>&nbsp;<span class="ident" id="1960654">i</span><span class="op" id="1960655">,</span>&nbsp;<span class="ident" id="1960657">v</span>&nbsp;<span class="op" id="1960659">:=</span>&nbsp;<span class="keyword" id="1960662">range</span>&nbsp;<span class="ident" id="1960668">r</span><span class="op" id="1960669">.</span><span class="ident" id="1960670">Stack0</span>&nbsp;<span class="op" id="1960677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960681">if</span>&nbsp;<span class="ident" id="1960684">v</span>&nbsp;<span class="op" id="1960686">==</span>&nbsp;<span class="num" id="1960689">0</span>&nbsp;<span class="op" id="1960691">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960696">return</span>&nbsp;<span class="ident" id="1960703">r</span><span class="op" id="1960704">.</span><span class="ident" id="1960705">Stack0</span><span class="op" id="1960711">[</span><span class="num" id="1960712">0</span><span class="op" id="1960713">:</span><span class="ident" id="1960714">i</span><span class="op" id="1960715">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1960719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1960722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1960725">return</span>&nbsp;<span class="ident" id="1960732">r</span><span class="op" id="1960733">.</span><span class="ident" id="1960734">Stack0</span><span class="op" id="1960740">[</span><span class="num" id="1960741">0</span><span class="op" id="1960742">:</span><span class="op" id="1960743">]</span><br>
<span class="lineno"></span><span class="op" id="1960745">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1960748">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1960810">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1960867">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1960912">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1960966">//</span><br>
<span class="lineno"></span><span class="comment" id="1960969">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1961046">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1961106">//</span><br>
<span class="lineno"></span><span class="comment" id="1961109">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1961171">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1961234">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1961295">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1961356">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1961414">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1961444">var</span>&nbsp;<span class="ident" id="1961448">MemProfileRate</span>&nbsp;<span class="builtintype" id="1961463">int</span>&nbsp;<span class="op" id="1961467">=</span>&nbsp;<span class="num" id="1961469">512</span>&nbsp;<span class="op" id="1961473">*</span>&nbsp;<span class="num" id="1961475">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1961481">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1961540">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1961588">type</span>&nbsp;<span class="ident" id="1961593">MemProfileRecord</span>&nbsp;<span class="keyword" id="1961610">struct</span>&nbsp;<span class="op" id="1961617">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1961620">AllocBytes</span><span class="op" id="1961630">,</span>&nbsp;<span class="ident" id="1961632">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1961646">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1961658">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1961695">AllocObjects</span><span class="op" id="1961707">,</span>&nbsp;<span class="ident" id="1961709">FreeObjects</span>&nbsp;<span class="ident" id="1961721">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1961733">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1961772">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1961798">[</span><span class="num" id="1961799">32</span><span class="op" id="1961801">]</span><span class="builtintype" id="1961802">uintptr</span>&nbsp;<span class="comment" id="1961810">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1961864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1961867">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1961942">func</span>&nbsp;<span class="op" id="1961947">(</span><span class="ident" id="1961948">r</span>&nbsp;<span class="op" id="1961950">*</span><span class="ident" id="1961951">MemProfileRecord</span><span class="op" id="1961967">)</span>&nbsp;<span class="ident" id="1961969">InUseBytes</span><span class="op" id="1961979">(</span><span class="op" id="1961980">)</span>&nbsp;<span class="ident" id="1961982">int64</span>&nbsp;<span class="op" id="1961988">{</span>&nbsp;<span class="keyword" id="1961990">return</span>&nbsp;<span class="ident" id="1961997">r</span><span class="op" id="1961998">.</span><span class="ident" id="1961999">AllocBytes</span>&nbsp;<span class="op" id="1962010">-</span>&nbsp;<span class="ident" id="1962012">r</span><span class="op" id="1962013">.</span><span class="ident" id="1962014">FreeBytes</span>&nbsp;<span class="op" id="1962024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1962027">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1962110">func</span>&nbsp;<span class="op" id="1962115">(</span><span class="ident" id="1962116">r</span>&nbsp;<span class="op" id="1962118">*</span><span class="ident" id="1962119">MemProfileRecord</span><span class="op" id="1962135">)</span>&nbsp;<span class="ident" id="1962137">InUseObjects</span><span class="op" id="1962149">(</span><span class="op" id="1962150">)</span>&nbsp;<span class="ident" id="1962152">int64</span>&nbsp;<span class="op" id="1962158">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1962161">return</span>&nbsp;<span class="ident" id="1962168">r</span><span class="op" id="1962169">.</span><span class="ident" id="1962170">AllocObjects</span>&nbsp;<span class="op" id="1962183">-</span>&nbsp;<span class="ident" id="1962185">r</span><span class="op" id="1962186">.</span><span class="ident" id="1962187">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1962199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1962202">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1962263">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1962288">func</span>&nbsp;<span class="op" id="1962293">(</span><span class="ident" id="1962294">r</span>&nbsp;<span class="op" id="1962296">*</span><span class="ident" id="1962297">MemProfileRecord</span><span class="op" id="1962313">)</span>&nbsp;<span class="ident" id="1962315">Stack</span><span class="op" id="1962320">(</span><span class="op" id="1962321">)</span>&nbsp;<span class="op" id="1962323">[</span><span class="op" id="1962324">]</span><span class="builtintype" id="1962325">uintptr</span>&nbsp;<span class="op" id="1962333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1962336">for</span>&nbsp;<span class="ident" id="1962340">i</span><span class="op" id="1962341">,</span>&nbsp;<span class="ident" id="1962343">v</span>&nbsp;<span class="op" id="1962345">:=</span>&nbsp;<span class="keyword" id="1962348">range</span>&nbsp;<span class="ident" id="1962354">r</span><span class="op" id="1962355">.</span><span class="ident" id="1962356">Stack0</span>&nbsp;<span class="op" id="1962363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1962367">if</span>&nbsp;<span class="ident" id="1962370">v</span>&nbsp;<span class="op" id="1962372">==</span>&nbsp;<span class="num" id="1962375">0</span>&nbsp;<span class="op" id="1962377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1962382">return</span>&nbsp;<span class="ident" id="1962389">r</span><span class="op" id="1962390">.</span><span class="ident" id="1962391">Stack0</span><span class="op" id="1962397">[</span><span class="num" id="1962398">0</span><span class="op" id="1962399">:</span><span class="ident" id="1962400">i</span><span class="op" id="1962401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1962405">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1962408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1962411">return</span>&nbsp;<span class="ident" id="1962418">r</span><span class="op" id="1962419">.</span><span class="ident" id="1962420">Stack0</span><span class="op" id="1962426">[</span><span class="num" id="1962427">0</span><span class="op" id="1962428">:</span><span class="op" id="1962429">]</span><br>
<span class="lineno"></span><span class="op" id="1962431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1962434">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1962512">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1962589">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1962658">//</span><br>
<span class="lineno"></span><span class="comment" id="1962661">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1962726">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1962785">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1962847">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1962885">//</span><br>
<span class="lineno"></span><span class="comment" id="1962888">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1962944">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1962999">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1963034">func</span>&nbsp;<span class="ident" id="1963039">MemProfile</span><span class="op" id="1963049">(</span><span class="ident" id="1963050">p</span>&nbsp;<span class="op" id="1963052">[</span><span class="op" id="1963053">]</span><span class="ident" id="1963054">MemProfileRecord</span><span class="op" id="1963070">,</span>&nbsp;<span class="ident" id="1963072">inuseZero</span>&nbsp;<span class="builtintype" id="1963082">bool</span><span class="op" id="1963086">)</span>&nbsp;<span class="op" id="1963088">(</span><span class="ident" id="1963089">n</span>&nbsp;<span class="builtintype" id="1963091">int</span><span class="op" id="1963094">,</span>&nbsp;<span class="ident" id="1963096">ok</span>&nbsp;<span class="builtintype" id="1963099">bool</span><span class="op" id="1963103">)</span>&nbsp;<span class="op" id="1963105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963108">lock</span><span class="op" id="1963112">(</span><span class="op" id="1963113">&amp;</span><span class="ident" id="1963114">proflock</span><span class="op" id="1963122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963125">clear</span>&nbsp;<span class="op" id="1963131">:=</span>&nbsp;<span class="builtintype" id="1963134">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963140">for</span>&nbsp;<span class="ident" id="1963144">b</span>&nbsp;<span class="op" id="1963146">:=</span>&nbsp;<span class="ident" id="1963149">mbuckets</span><span class="op" id="1963157">;</span>&nbsp;<span class="ident" id="1963159">b</span>&nbsp;<span class="op" id="1963161">!=</span>&nbsp;<span class="ident" id="1963164">nil</span><span class="op" id="1963167">;</span>&nbsp;<span class="ident" id="1963169">b</span>&nbsp;<span class="op" id="1963171">=</span>&nbsp;<span class="ident" id="1963173">b</span><span class="op" id="1963174">.</span><span class="ident" id="1963175">allnext</span>&nbsp;<span class="op" id="1963183">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963187">mp</span>&nbsp;<span class="op" id="1963190">:=</span>&nbsp;<span class="ident" id="1963193">b</span><span class="op" id="1963194">.</span><span class="ident" id="1963195">mp</span><span class="op" id="1963197">(</span><span class="op" id="1963198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963202">if</span>&nbsp;<span class="ident" id="1963205">inuseZero</span>&nbsp;<span class="op" id="1963215">||</span>&nbsp;<span class="ident" id="1963218">mp</span><span class="op" id="1963220">.</span><span class="ident" id="1963221">alloc_bytes</span>&nbsp;<span class="op" id="1963233">!=</span>&nbsp;<span class="ident" id="1963236">mp</span><span class="op" id="1963238">.</span><span class="ident" id="1963239">free_bytes</span>&nbsp;<span class="op" id="1963250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963255">n</span><span class="op" id="1963256">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963265">if</span>&nbsp;<span class="ident" id="1963268">mp</span><span class="op" id="1963270">.</span><span class="ident" id="1963271">allocs</span>&nbsp;<span class="op" id="1963278">!=</span>&nbsp;<span class="num" id="1963281">0</span>&nbsp;<span class="op" id="1963283">||</span>&nbsp;<span class="ident" id="1963286">mp</span><span class="op" id="1963288">.</span><span class="ident" id="1963289">frees</span>&nbsp;<span class="op" id="1963295">!=</span>&nbsp;<span class="num" id="1963298">0</span>&nbsp;<span class="op" id="1963300">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963305">clear</span>&nbsp;<span class="op" id="1963311">=</span>&nbsp;<span class="builtintype" id="1963313">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963327">if</span>&nbsp;<span class="ident" id="1963330">clear</span>&nbsp;<span class="op" id="1963336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1963340">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1963402">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1963462">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1963531">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963600">mprof_GC</span><span class="op" id="1963608">(</span><span class="op" id="1963609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963613">mprof_GC</span><span class="op" id="1963621">(</span><span class="op" id="1963622">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963626">n</span>&nbsp;<span class="op" id="1963628">=</span>&nbsp;<span class="num" id="1963630">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963634">for</span>&nbsp;<span class="ident" id="1963638">b</span>&nbsp;<span class="op" id="1963640">:=</span>&nbsp;<span class="ident" id="1963643">mbuckets</span><span class="op" id="1963651">;</span>&nbsp;<span class="ident" id="1963653">b</span>&nbsp;<span class="op" id="1963655">!=</span>&nbsp;<span class="ident" id="1963658">nil</span><span class="op" id="1963661">;</span>&nbsp;<span class="ident" id="1963663">b</span>&nbsp;<span class="op" id="1963665">=</span>&nbsp;<span class="ident" id="1963667">b</span><span class="op" id="1963668">.</span><span class="ident" id="1963669">allnext</span>&nbsp;<span class="op" id="1963677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963682">mp</span>&nbsp;<span class="op" id="1963685">:=</span>&nbsp;<span class="ident" id="1963688">b</span><span class="op" id="1963689">.</span><span class="ident" id="1963690">mp</span><span class="op" id="1963692">(</span><span class="op" id="1963693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963698">if</span>&nbsp;<span class="ident" id="1963701">inuseZero</span>&nbsp;<span class="op" id="1963711">||</span>&nbsp;<span class="ident" id="1963714">mp</span><span class="op" id="1963716">.</span><span class="ident" id="1963717">alloc_bytes</span>&nbsp;<span class="op" id="1963729">!=</span>&nbsp;<span class="ident" id="1963732">mp</span><span class="op" id="1963734">.</span><span class="ident" id="1963735">free_bytes</span>&nbsp;<span class="op" id="1963746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963752">n</span><span class="op" id="1963753">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963769">if</span>&nbsp;<span class="ident" id="1963772">n</span>&nbsp;<span class="op" id="1963774">&lt;=</span>&nbsp;<span class="builtinfunc" id="1963777">len</span><span class="op" id="1963780">(</span><span class="ident" id="1963781">p</span><span class="op" id="1963782">)</span>&nbsp;<span class="op" id="1963784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963788">ok</span>&nbsp;<span class="op" id="1963791">=</span>&nbsp;<span class="builtintype" id="1963793">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963800">idx</span>&nbsp;<span class="op" id="1963804">:=</span>&nbsp;<span class="num" id="1963807">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963811">for</span>&nbsp;<span class="ident" id="1963815">b</span>&nbsp;<span class="op" id="1963817">:=</span>&nbsp;<span class="ident" id="1963820">mbuckets</span><span class="op" id="1963828">;</span>&nbsp;<span class="ident" id="1963830">b</span>&nbsp;<span class="op" id="1963832">!=</span>&nbsp;<span class="ident" id="1963835">nil</span><span class="op" id="1963838">;</span>&nbsp;<span class="ident" id="1963840">b</span>&nbsp;<span class="op" id="1963842">=</span>&nbsp;<span class="ident" id="1963844">b</span><span class="op" id="1963845">.</span><span class="ident" id="1963846">allnext</span>&nbsp;<span class="op" id="1963854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963859">mp</span>&nbsp;<span class="op" id="1963862">:=</span>&nbsp;<span class="ident" id="1963865">b</span><span class="op" id="1963866">.</span><span class="ident" id="1963867">mp</span><span class="op" id="1963869">(</span><span class="op" id="1963870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963875">if</span>&nbsp;<span class="ident" id="1963878">inuseZero</span>&nbsp;<span class="op" id="1963888">||</span>&nbsp;<span class="ident" id="1963891">mp</span><span class="op" id="1963893">.</span><span class="ident" id="1963894">alloc_bytes</span>&nbsp;<span class="op" id="1963906">!=</span>&nbsp;<span class="ident" id="1963909">mp</span><span class="op" id="1963911">.</span><span class="ident" id="1963912">free_bytes</span>&nbsp;<span class="op" id="1963923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963929">record</span><span class="op" id="1963935">(</span><span class="op" id="1963936">&amp;</span><span class="ident" id="1963937">p</span><span class="op" id="1963938">[</span><span class="ident" id="1963939">idx</span><span class="op" id="1963942">]</span><span class="op" id="1963943">,</span>&nbsp;<span class="ident" id="1963945">b</span><span class="op" id="1963946">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963952">idx</span><span class="op" id="1963955">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1963968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1963971">unlock</span><span class="op" id="1963977">(</span><span class="op" id="1963978">&amp;</span><span class="ident" id="1963979">proflock</span><span class="op" id="1963987">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1963990">return</span><br>
<span class="lineno"></span><span class="op" id="1963997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1964000">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1964024">func</span>&nbsp;<span class="ident" id="1964029">record</span><span class="op" id="1964035">(</span><span class="ident" id="1964036">r</span>&nbsp;<span class="op" id="1964038">*</span><span class="ident" id="1964039">MemProfileRecord</span><span class="op" id="1964055">,</span>&nbsp;<span class="ident" id="1964057">b</span>&nbsp;<span class="op" id="1964059">*</span><span class="ident" id="1964060">bucket</span><span class="op" id="1964066">)</span>&nbsp;<span class="op" id="1964068">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964071">mp</span>&nbsp;<span class="op" id="1964074">:=</span>&nbsp;<span class="ident" id="1964077">b</span><span class="op" id="1964078">.</span><span class="ident" id="1964079">mp</span><span class="op" id="1964081">(</span><span class="op" id="1964082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964085">r</span><span class="op" id="1964086">.</span><span class="ident" id="1964087">AllocBytes</span>&nbsp;<span class="op" id="1964098">=</span>&nbsp;<span class="ident" id="1964100">int64</span><span class="op" id="1964105">(</span><span class="ident" id="1964106">mp</span><span class="op" id="1964108">.</span><span class="ident" id="1964109">alloc_bytes</span><span class="op" id="1964120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964123">r</span><span class="op" id="1964124">.</span><span class="ident" id="1964125">FreeBytes</span>&nbsp;<span class="op" id="1964135">=</span>&nbsp;<span class="ident" id="1964137">int64</span><span class="op" id="1964142">(</span><span class="ident" id="1964143">mp</span><span class="op" id="1964145">.</span><span class="ident" id="1964146">free_bytes</span><span class="op" id="1964156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964159">r</span><span class="op" id="1964160">.</span><span class="ident" id="1964161">AllocObjects</span>&nbsp;<span class="op" id="1964174">=</span>&nbsp;<span class="ident" id="1964176">int64</span><span class="op" id="1964181">(</span><span class="ident" id="1964182">mp</span><span class="op" id="1964184">.</span><span class="ident" id="1964185">allocs</span><span class="op" id="1964191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964194">r</span><span class="op" id="1964195">.</span><span class="ident" id="1964196">FreeObjects</span>&nbsp;<span class="op" id="1964208">=</span>&nbsp;<span class="ident" id="1964210">int64</span><span class="op" id="1964215">(</span><span class="ident" id="1964216">mp</span><span class="op" id="1964218">.</span><span class="ident" id="1964219">frees</span><span class="op" id="1964224">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1964227">copy</span><span class="op" id="1964231">(</span><span class="ident" id="1964232">r</span><span class="op" id="1964233">.</span><span class="ident" id="1964234">Stack0</span><span class="op" id="1964240">[</span><span class="op" id="1964241">:</span><span class="op" id="1964242">]</span><span class="op" id="1964243">,</span>&nbsp;<span class="ident" id="1964245">b</span><span class="op" id="1964246">.</span><span class="ident" id="1964247">stk</span><span class="op" id="1964250">(</span><span class="op" id="1964251">)</span><span class="op" id="1964252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1964255">for</span>&nbsp;<span class="ident" id="1964259">i</span>&nbsp;<span class="op" id="1964261">:=</span>&nbsp;<span class="builtintype" id="1964264">int</span><span class="op" id="1964267">(</span><span class="ident" id="1964268">b</span><span class="op" id="1964269">.</span><span class="ident" id="1964270">nstk</span><span class="op" id="1964274">)</span><span class="op" id="1964275">;</span>&nbsp;<span class="ident" id="1964277">i</span>&nbsp;<span class="op" id="1964279">&lt;</span>&nbsp;<span class="builtinfunc" id="1964281">len</span><span class="op" id="1964284">(</span><span class="ident" id="1964285">r</span><span class="op" id="1964286">.</span><span class="ident" id="1964287">Stack0</span><span class="op" id="1964293">)</span><span class="op" id="1964294">;</span>&nbsp;<span class="ident" id="1964296">i</span><span class="op" id="1964297">++</span>&nbsp;<span class="op" id="1964300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964304">r</span><span class="op" id="1964305">.</span><span class="ident" id="1964306">Stack0</span><span class="op" id="1964312">[</span><span class="ident" id="1964313">i</span><span class="op" id="1964314">]</span>&nbsp;<span class="op" id="1964316">=</span>&nbsp;<span class="num" id="1964318">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1964321">}</span><br>
<span class="lineno"></span><span class="op" id="1964323">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1964326">func</span>&nbsp;<span class="ident" id="1964331">iterate_memprof</span><span class="op" id="1964346">(</span><span class="ident" id="1964347">fn</span>&nbsp;<span class="keyword" id="1964350">func</span><span class="op" id="1964354">(</span><span class="op" id="1964355">*</span><span class="ident" id="1964356">bucket</span><span class="op" id="1964362">,</span>&nbsp;<span class="builtintype" id="1964364">uintptr</span><span class="op" id="1964371">,</span>&nbsp;<span class="op" id="1964373">*</span><span class="builtintype" id="1964374">uintptr</span><span class="op" id="1964381">,</span>&nbsp;<span class="builtintype" id="1964383">uintptr</span><span class="op" id="1964390">,</span>&nbsp;<span class="builtintype" id="1964392">uintptr</span><span class="op" id="1964399">,</span>&nbsp;<span class="builtintype" id="1964401">uintptr</span><span class="op" id="1964408">)</span><span class="op" id="1964409">)</span>&nbsp;<span class="op" id="1964411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964414">lock</span><span class="op" id="1964418">(</span><span class="op" id="1964419">&amp;</span><span class="ident" id="1964420">proflock</span><span class="op" id="1964428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1964431">for</span>&nbsp;<span class="ident" id="1964435">b</span>&nbsp;<span class="op" id="1964437">:=</span>&nbsp;<span class="ident" id="1964440">mbuckets</span><span class="op" id="1964448">;</span>&nbsp;<span class="ident" id="1964450">b</span>&nbsp;<span class="op" id="1964452">!=</span>&nbsp;<span class="ident" id="1964455">nil</span><span class="op" id="1964458">;</span>&nbsp;<span class="ident" id="1964460">b</span>&nbsp;<span class="op" id="1964462">=</span>&nbsp;<span class="ident" id="1964464">b</span><span class="op" id="1964465">.</span><span class="ident" id="1964466">allnext</span>&nbsp;<span class="op" id="1964474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964478">mp</span>&nbsp;<span class="op" id="1964481">:=</span>&nbsp;<span class="ident" id="1964484">b</span><span class="op" id="1964485">.</span><span class="ident" id="1964486">mp</span><span class="op" id="1964488">(</span><span class="op" id="1964489">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964493">fn</span><span class="op" id="1964495">(</span><span class="ident" id="1964496">b</span><span class="op" id="1964497">,</span>&nbsp;<span class="builtintype" id="1964499">uintptr</span><span class="op" id="1964506">(</span><span class="ident" id="1964507">b</span><span class="op" id="1964508">.</span><span class="ident" id="1964509">nstk</span><span class="op" id="1964513">)</span><span class="op" id="1964514">,</span>&nbsp;<span class="op" id="1964516">&amp;</span><span class="ident" id="1964517">b</span><span class="op" id="1964518">.</span><span class="ident" id="1964519">stk</span><span class="op" id="1964522">(</span><span class="op" id="1964523">)</span><span class="op" id="1964524">[</span><span class="num" id="1964525">0</span><span class="op" id="1964526">]</span><span class="op" id="1964527">,</span>&nbsp;<span class="ident" id="1964529">b</span><span class="op" id="1964530">.</span><span class="ident" id="1964531">size</span><span class="op" id="1964535">,</span>&nbsp;<span class="ident" id="1964537">mp</span><span class="op" id="1964539">.</span><span class="ident" id="1964540">allocs</span><span class="op" id="1964546">,</span>&nbsp;<span class="ident" id="1964548">mp</span><span class="op" id="1964550">.</span><span class="ident" id="1964551">frees</span><span class="op" id="1964556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1964559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964562">unlock</span><span class="op" id="1964568">(</span><span class="op" id="1964569">&amp;</span><span class="ident" id="1964570">proflock</span><span class="op" id="1964578">)</span><br>
<span class="lineno"></span><span class="op" id="1964580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1964583">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1964642">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1964690">type</span>&nbsp;<span class="ident" id="1964695">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1964714">struct</span>&nbsp;<span class="op" id="1964721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964724">Count</span>&nbsp;&nbsp;<span class="ident" id="1964731">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964738">Cycles</span>&nbsp;<span class="ident" id="1964745">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1964752">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1964764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1964767">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1964849">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1964928">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1964999">//</span><br>
<span class="lineno"></span><span class="comment" id="1965002">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1965058">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1965115">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1965152">func</span>&nbsp;<span class="ident" id="1965157">BlockProfile</span><span class="op" id="1965169">(</span><span class="ident" id="1965170">p</span>&nbsp;<span class="op" id="1965172">[</span><span class="op" id="1965173">]</span><span class="ident" id="1965174">BlockProfileRecord</span><span class="op" id="1965192">)</span>&nbsp;<span class="op" id="1965194">(</span><span class="ident" id="1965195">n</span>&nbsp;<span class="builtintype" id="1965197">int</span><span class="op" id="1965200">,</span>&nbsp;<span class="ident" id="1965202">ok</span>&nbsp;<span class="builtintype" id="1965205">bool</span><span class="op" id="1965209">)</span>&nbsp;<span class="op" id="1965211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965214">lock</span><span class="op" id="1965218">(</span><span class="op" id="1965219">&amp;</span><span class="ident" id="1965220">proflock</span><span class="op" id="1965228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1965231">for</span>&nbsp;<span class="ident" id="1965235">b</span>&nbsp;<span class="op" id="1965237">:=</span>&nbsp;<span class="ident" id="1965240">bbuckets</span><span class="op" id="1965248">;</span>&nbsp;<span class="ident" id="1965250">b</span>&nbsp;<span class="op" id="1965252">!=</span>&nbsp;<span class="ident" id="1965255">nil</span><span class="op" id="1965258">;</span>&nbsp;<span class="ident" id="1965260">b</span>&nbsp;<span class="op" id="1965262">=</span>&nbsp;<span class="ident" id="1965264">b</span><span class="op" id="1965265">.</span><span class="ident" id="1965266">allnext</span>&nbsp;<span class="op" id="1965274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965278">n</span><span class="op" id="1965279">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1965283">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1965286">if</span>&nbsp;<span class="ident" id="1965289">n</span>&nbsp;<span class="op" id="1965291">&lt;=</span>&nbsp;<span class="builtinfunc" id="1965294">len</span><span class="op" id="1965297">(</span><span class="ident" id="1965298">p</span><span class="op" id="1965299">)</span>&nbsp;<span class="op" id="1965301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965305">ok</span>&nbsp;<span class="op" id="1965308">=</span>&nbsp;<span class="builtintype" id="1965310">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1965317">for</span>&nbsp;<span class="ident" id="1965321">b</span>&nbsp;<span class="op" id="1965323">:=</span>&nbsp;<span class="ident" id="1965326">bbuckets</span><span class="op" id="1965334">;</span>&nbsp;<span class="ident" id="1965336">b</span>&nbsp;<span class="op" id="1965338">!=</span>&nbsp;<span class="ident" id="1965341">nil</span><span class="op" id="1965344">;</span>&nbsp;<span class="ident" id="1965346">b</span>&nbsp;<span class="op" id="1965348">=</span>&nbsp;<span class="ident" id="1965350">b</span><span class="op" id="1965351">.</span><span class="ident" id="1965352">allnext</span>&nbsp;<span class="op" id="1965360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965365">bp</span>&nbsp;<span class="op" id="1965368">:=</span>&nbsp;<span class="ident" id="1965371">b</span><span class="op" id="1965372">.</span><span class="ident" id="1965373">bp</span><span class="op" id="1965375">(</span><span class="op" id="1965376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965381">r</span>&nbsp;<span class="op" id="1965383">:=</span>&nbsp;<span class="op" id="1965386">&amp;</span><span class="ident" id="1965387">p</span><span class="op" id="1965388">[</span><span class="num" id="1965389">0</span><span class="op" id="1965390">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965395">r</span><span class="op" id="1965396">.</span><span class="ident" id="1965397">Count</span>&nbsp;<span class="op" id="1965403">=</span>&nbsp;<span class="ident" id="1965405">int64</span><span class="op" id="1965410">(</span><span class="ident" id="1965411">bp</span><span class="op" id="1965413">.</span><span class="ident" id="1965414">count</span><span class="op" id="1965419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965424">r</span><span class="op" id="1965425">.</span><span class="ident" id="1965426">Cycles</span>&nbsp;<span class="op" id="1965433">=</span>&nbsp;<span class="ident" id="1965435">int64</span><span class="op" id="1965440">(</span><span class="ident" id="1965441">bp</span><span class="op" id="1965443">.</span><span class="ident" id="1965444">cycles</span><span class="op" id="1965450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965455">i</span>&nbsp;<span class="op" id="1965457">:=</span>&nbsp;<span class="builtinfunc" id="1965460">copy</span><span class="op" id="1965464">(</span><span class="ident" id="1965465">r</span><span class="op" id="1965466">.</span><span class="ident" id="1965467">Stack0</span><span class="op" id="1965473">[</span><span class="op" id="1965474">:</span><span class="op" id="1965475">]</span><span class="op" id="1965476">,</span>&nbsp;<span class="ident" id="1965478">b</span><span class="op" id="1965479">.</span><span class="ident" id="1965480">stk</span><span class="op" id="1965483">(</span><span class="op" id="1965484">)</span><span class="op" id="1965485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1965490">for</span>&nbsp;<span class="op" id="1965494">;</span>&nbsp;<span class="ident" id="1965496">i</span>&nbsp;<span class="op" id="1965498">&lt;</span>&nbsp;<span class="builtinfunc" id="1965500">len</span><span class="op" id="1965503">(</span><span class="ident" id="1965504">r</span><span class="op" id="1965505">.</span><span class="ident" id="1965506">Stack0</span><span class="op" id="1965512">)</span><span class="op" id="1965513">;</span>&nbsp;<span class="ident" id="1965515">i</span><span class="op" id="1965516">++</span>&nbsp;<span class="op" id="1965519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965525">r</span><span class="op" id="1965526">.</span><span class="ident" id="1965527">Stack0</span><span class="op" id="1965533">[</span><span class="ident" id="1965534">i</span><span class="op" id="1965535">]</span>&nbsp;<span class="op" id="1965537">=</span>&nbsp;<span class="num" id="1965539">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1965544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965549">p</span>&nbsp;<span class="op" id="1965551">=</span>&nbsp;<span class="ident" id="1965553">p</span><span class="op" id="1965554">[</span><span class="num" id="1965555">1</span><span class="op" id="1965556">:</span><span class="op" id="1965557">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1965561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1965564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1965567">unlock</span><span class="op" id="1965573">(</span><span class="op" id="1965574">&amp;</span><span class="ident" id="1965575">proflock</span><span class="op" id="1965583">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1965586">return</span><br>
<span class="lineno"></span><span class="op" id="1965593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1965596">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1965684">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1965770">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1965848">//</span><br>
<span class="lineno"></span><span class="comment" id="1965851">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1965912">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1965956">func</span>&nbsp;<span class="ident" id="1965961">ThreadCreateProfile</span><span class="op" id="1965980">(</span><span class="ident" id="1965981">p</span>&nbsp;<span class="op" id="1965983">[</span><span class="op" id="1965984">]</span><span class="ident" id="1965985">StackRecord</span><span class="op" id="1965996">)</span>&nbsp;<span class="op" id="1965998">(</span><span class="ident" id="1965999">n</span>&nbsp;<span class="builtintype" id="1966001">int</span><span class="op" id="1966004">,</span>&nbsp;<span class="ident" id="1966006">ok</span>&nbsp;<span class="builtintype" id="1966009">bool</span><span class="op" id="1966013">)</span>&nbsp;<span class="op" id="1966015">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966018">first</span>&nbsp;<span class="op" id="1966024">:=</span>&nbsp;<span class="op" id="1966027">(</span><span class="op" id="1966028">*</span><span class="ident" id="1966029">m</span><span class="op" id="1966030">)</span><span class="op" id="1966031">(</span><span class="ident" id="1966032">atomicloadp</span><span class="op" id="1966043">(</span><span class="ident" id="1966044">unsafe</span><span class="op" id="1966050">.</span><span class="ident" id="1966051">Pointer</span><span class="op" id="1966058">(</span><span class="op" id="1966059">&amp;</span><span class="ident" id="1966060">allm</span><span class="op" id="1966064">)</span><span class="op" id="1966065">)</span><span class="op" id="1966066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966069">for</span>&nbsp;<span class="ident" id="1966073">mp</span>&nbsp;<span class="op" id="1966076">:=</span>&nbsp;<span class="ident" id="1966079">first</span><span class="op" id="1966084">;</span>&nbsp;<span class="ident" id="1966086">mp</span>&nbsp;<span class="op" id="1966089">!=</span>&nbsp;<span class="ident" id="1966092">nil</span><span class="op" id="1966095">;</span>&nbsp;<span class="ident" id="1966097">mp</span>&nbsp;<span class="op" id="1966100">=</span>&nbsp;<span class="ident" id="1966102">mp</span><span class="op" id="1966104">.</span><span class="ident" id="1966105">alllink</span>&nbsp;<span class="op" id="1966113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966117">n</span><span class="op" id="1966118">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1966122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966125">if</span>&nbsp;<span class="ident" id="1966128">n</span>&nbsp;<span class="op" id="1966130">&lt;=</span>&nbsp;<span class="builtinfunc" id="1966133">len</span><span class="op" id="1966136">(</span><span class="ident" id="1966137">p</span><span class="op" id="1966138">)</span>&nbsp;<span class="op" id="1966140">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966144">ok</span>&nbsp;<span class="op" id="1966147">=</span>&nbsp;<span class="builtintype" id="1966149">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966156">i</span>&nbsp;<span class="op" id="1966158">:=</span>&nbsp;<span class="num" id="1966161">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966165">for</span>&nbsp;<span class="ident" id="1966169">mp</span>&nbsp;<span class="op" id="1966172">:=</span>&nbsp;<span class="ident" id="1966175">first</span><span class="op" id="1966180">;</span>&nbsp;<span class="ident" id="1966182">mp</span>&nbsp;<span class="op" id="1966185">!=</span>&nbsp;<span class="ident" id="1966188">nil</span><span class="op" id="1966191">;</span>&nbsp;<span class="ident" id="1966193">mp</span>&nbsp;<span class="op" id="1966196">=</span>&nbsp;<span class="ident" id="1966198">mp</span><span class="op" id="1966200">.</span><span class="ident" id="1966201">alllink</span>&nbsp;<span class="op" id="1966209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966214">for</span>&nbsp;<span class="ident" id="1966218">s</span>&nbsp;<span class="op" id="1966220">:=</span>&nbsp;<span class="keyword" id="1966223">range</span>&nbsp;<span class="ident" id="1966229">mp</span><span class="op" id="1966231">.</span><span class="ident" id="1966232">createstack</span>&nbsp;<span class="op" id="1966244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966250">p</span><span class="op" id="1966251">[</span><span class="ident" id="1966252">i</span><span class="op" id="1966253">]</span><span class="op" id="1966254">.</span><span class="ident" id="1966255">Stack0</span><span class="op" id="1966261">[</span><span class="ident" id="1966262">s</span><span class="op" id="1966263">]</span>&nbsp;<span class="op" id="1966265">=</span>&nbsp;<span class="builtintype" id="1966267">uintptr</span><span class="op" id="1966274">(</span><span class="ident" id="1966275">mp</span><span class="op" id="1966277">.</span><span class="ident" id="1966278">createstack</span><span class="op" id="1966289">[</span><span class="ident" id="1966290">s</span><span class="op" id="1966291">]</span><span class="op" id="1966292">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1966297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966302">i</span><span class="op" id="1966303">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1966308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1966311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966314">return</span><br>
<span class="lineno">520</span><span class="op" id="1966321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1966324">var</span>&nbsp;<span class="ident" id="1966328">allgs</span>&nbsp;<span class="op" id="1966334">[</span><span class="op" id="1966335">]</span><span class="op" id="1966336">*</span><span class="ident" id="1966337">g</span>&nbsp;<span class="comment" id="1966339">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1966350">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1966442">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1966525">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1966600">//</span><br>
<span class="lineno"></span><span class="comment" id="1966603">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1966664">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1966705">func</span>&nbsp;<span class="ident" id="1966710">GoroutineProfile</span><span class="op" id="1966726">(</span><span class="ident" id="1966727">p</span>&nbsp;<span class="op" id="1966729">[</span><span class="op" id="1966730">]</span><span class="ident" id="1966731">StackRecord</span><span class="op" id="1966742">)</span>&nbsp;<span class="op" id="1966744">(</span><span class="ident" id="1966745">n</span>&nbsp;<span class="builtintype" id="1966747">int</span><span class="op" id="1966750">,</span>&nbsp;<span class="ident" id="1966752">ok</span>&nbsp;<span class="builtintype" id="1966755">bool</span><span class="op" id="1966759">)</span>&nbsp;<span class="op" id="1966761">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966765">n</span>&nbsp;<span class="op" id="1966767">=</span>&nbsp;<span class="ident" id="1966769">NumGoroutine</span><span class="op" id="1966781">(</span><span class="op" id="1966782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966785">if</span>&nbsp;<span class="ident" id="1966788">n</span>&nbsp;<span class="op" id="1966790">&lt;=</span>&nbsp;<span class="builtinfunc" id="1966793">len</span><span class="op" id="1966796">(</span><span class="ident" id="1966797">p</span><span class="op" id="1966798">)</span>&nbsp;<span class="op" id="1966800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966804">gp</span>&nbsp;<span class="op" id="1966807">:=</span>&nbsp;<span class="ident" id="1966810">getg</span><span class="op" id="1966814">(</span><span class="op" id="1966815">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966819">semacquire</span><span class="op" id="1966829">(</span><span class="op" id="1966830">&amp;</span><span class="ident" id="1966831">worldsema</span><span class="op" id="1966840">,</span>&nbsp;<span class="builtintype" id="1966842">false</span><span class="op" id="1966847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966851">gp</span><span class="op" id="1966853">.</span><span class="ident" id="1966854">m</span><span class="op" id="1966855">.</span><span class="ident" id="1966856">gcing</span>&nbsp;<span class="op" id="1966862">=</span>&nbsp;<span class="num" id="1966864">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966868">onM</span><span class="op" id="1966871">(</span><span class="ident" id="1966872">stoptheworld</span><span class="op" id="1966884">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966889">n</span>&nbsp;<span class="op" id="1966891">=</span>&nbsp;<span class="ident" id="1966893">NumGoroutine</span><span class="op" id="1966905">(</span><span class="op" id="1966906">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1966910">if</span>&nbsp;<span class="ident" id="1966913">n</span>&nbsp;<span class="op" id="1966915">&lt;=</span>&nbsp;<span class="builtinfunc" id="1966918">len</span><span class="op" id="1966921">(</span><span class="ident" id="1966922">p</span><span class="op" id="1966923">)</span>&nbsp;<span class="op" id="1966925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966930">ok</span>&nbsp;<span class="op" id="1966933">=</span>&nbsp;<span class="builtintype" id="1966935">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966943">r</span>&nbsp;<span class="op" id="1966945">:=</span>&nbsp;<span class="ident" id="1966948">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966953">sp</span>&nbsp;<span class="op" id="1966956">:=</span>&nbsp;<span class="ident" id="1966959">getcallersp</span><span class="op" id="1966970">(</span><span class="ident" id="1966971">unsafe</span><span class="op" id="1966977">.</span><span class="ident" id="1966978">Pointer</span><span class="op" id="1966985">(</span><span class="op" id="1966986">&amp;</span><span class="ident" id="1966987">p</span><span class="op" id="1966988">)</span><span class="op" id="1966989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1966994">pc</span>&nbsp;<span class="op" id="1966997">:=</span>&nbsp;<span class="ident" id="1967000">getcallerpc</span><span class="op" id="1967011">(</span><span class="ident" id="1967012">unsafe</span><span class="op" id="1967018">.</span><span class="ident" id="1967019">Pointer</span><span class="op" id="1967026">(</span><span class="op" id="1967027">&amp;</span><span class="ident" id="1967028">p</span><span class="op" id="1967029">)</span><span class="op" id="1967030">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967035">onM</span><span class="op" id="1967038">(</span><span class="keyword" id="1967039">func</span><span class="op" id="1967043">(</span><span class="op" id="1967044">)</span>&nbsp;<span class="op" id="1967046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967052">saveg</span><span class="op" id="1967057">(</span><span class="ident" id="1967058">pc</span><span class="op" id="1967060">,</span>&nbsp;<span class="ident" id="1967062">sp</span><span class="op" id="1967064">,</span>&nbsp;<span class="ident" id="1967066">gp</span><span class="op" id="1967068">,</span>&nbsp;<span class="op" id="1967070">&amp;</span><span class="ident" id="1967071">r</span><span class="op" id="1967072">[</span><span class="num" id="1967073">0</span><span class="op" id="1967074">]</span><span class="op" id="1967075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967080">}</span><span class="op" id="1967081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967086">r</span>&nbsp;<span class="op" id="1967088">=</span>&nbsp;<span class="ident" id="1967090">r</span><span class="op" id="1967091">[</span><span class="num" id="1967092">1</span><span class="op" id="1967093">:</span><span class="op" id="1967094">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967099">for</span>&nbsp;<span class="ident" id="1967103">_</span><span class="op" id="1967104">,</span>&nbsp;<span class="ident" id="1967106">gp1</span>&nbsp;<span class="op" id="1967110">:=</span>&nbsp;<span class="keyword" id="1967113">range</span>&nbsp;<span class="ident" id="1967119">allgs</span>&nbsp;<span class="op" id="1967125">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967131">if</span>&nbsp;<span class="ident" id="1967134">gp1</span>&nbsp;<span class="op" id="1967138">==</span>&nbsp;<span class="ident" id="1967141">gp</span>&nbsp;<span class="op" id="1967144">||</span>&nbsp;<span class="ident" id="1967147">readgstatus</span><span class="op" id="1967158">(</span><span class="ident" id="1967159">gp1</span><span class="op" id="1967162">)</span>&nbsp;<span class="op" id="1967164">==</span>&nbsp;<span class="ident" id="1967167">_Gdead</span>&nbsp;<span class="op" id="1967174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967181">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967200">saveg</span><span class="op" id="1967205">(</span><span class="op" id="1967206">^</span><span class="builtintype" id="1967207">uintptr</span><span class="op" id="1967214">(</span><span class="num" id="1967215">0</span><span class="op" id="1967216">)</span><span class="op" id="1967217">,</span>&nbsp;<span class="op" id="1967219">^</span><span class="builtintype" id="1967220">uintptr</span><span class="op" id="1967227">(</span><span class="num" id="1967228">0</span><span class="op" id="1967229">)</span><span class="op" id="1967230">,</span>&nbsp;<span class="ident" id="1967232">gp1</span><span class="op" id="1967235">,</span>&nbsp;<span class="op" id="1967237">&amp;</span><span class="ident" id="1967238">r</span><span class="op" id="1967239">[</span><span class="num" id="1967240">0</span><span class="op" id="1967241">]</span><span class="op" id="1967242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967248">r</span>&nbsp;<span class="op" id="1967250">=</span>&nbsp;<span class="ident" id="1967252">r</span><span class="op" id="1967253">[</span><span class="num" id="1967254">1</span><span class="op" id="1967255">:</span><span class="op" id="1967256">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967270">gp</span><span class="op" id="1967272">.</span><span class="ident" id="1967273">m</span><span class="op" id="1967274">.</span><span class="ident" id="1967275">gcing</span>&nbsp;<span class="op" id="1967281">=</span>&nbsp;<span class="num" id="1967283">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967287">semrelease</span><span class="op" id="1967297">(</span><span class="op" id="1967298">&amp;</span><span class="ident" id="1967299">worldsema</span><span class="op" id="1967308">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967312">onM</span><span class="op" id="1967315">(</span><span class="ident" id="1967316">starttheworld</span><span class="op" id="1967329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967336">return</span>&nbsp;<span class="ident" id="1967343">n</span><span class="op" id="1967344">,</span>&nbsp;<span class="ident" id="1967346">ok</span><br>
<span class="lineno"></span><span class="op" id="1967349">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1967352">func</span>&nbsp;<span class="ident" id="1967357">saveg</span><span class="op" id="1967362">(</span><span class="ident" id="1967363">pc</span><span class="op" id="1967365">,</span>&nbsp;<span class="ident" id="1967367">sp</span>&nbsp;<span class="builtintype" id="1967370">uintptr</span><span class="op" id="1967377">,</span>&nbsp;<span class="ident" id="1967379">gp</span>&nbsp;<span class="op" id="1967382">*</span><span class="ident" id="1967383">g</span><span class="op" id="1967384">,</span>&nbsp;<span class="ident" id="1967386">r</span>&nbsp;<span class="op" id="1967388">*</span><span class="ident" id="1967389">StackRecord</span><span class="op" id="1967400">)</span>&nbsp;<span class="op" id="1967402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967405">n</span>&nbsp;<span class="op" id="1967407">:=</span>&nbsp;<span class="ident" id="1967410">gentraceback</span><span class="op" id="1967422">(</span><span class="ident" id="1967423">pc</span><span class="op" id="1967425">,</span>&nbsp;<span class="ident" id="1967427">sp</span><span class="op" id="1967429">,</span>&nbsp;<span class="num" id="1967431">0</span><span class="op" id="1967432">,</span>&nbsp;<span class="ident" id="1967434">gp</span><span class="op" id="1967436">,</span>&nbsp;<span class="num" id="1967438">0</span><span class="op" id="1967439">,</span>&nbsp;<span class="op" id="1967441">&amp;</span><span class="ident" id="1967442">r</span><span class="op" id="1967443">.</span><span class="ident" id="1967444">Stack0</span><span class="op" id="1967450">[</span><span class="num" id="1967451">0</span><span class="op" id="1967452">]</span><span class="op" id="1967453">,</span>&nbsp;<span class="builtinfunc" id="1967455">len</span><span class="op" id="1967458">(</span><span class="ident" id="1967459">r</span><span class="op" id="1967460">.</span><span class="ident" id="1967461">Stack0</span><span class="op" id="1967467">)</span><span class="op" id="1967468">,</span>&nbsp;<span class="ident" id="1967470">nil</span><span class="op" id="1967473">,</span>&nbsp;<span class="ident" id="1967475">nil</span><span class="op" id="1967478">,</span>&nbsp;<span class="num" id="1967480">0</span><span class="op" id="1967481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967484">if</span>&nbsp;<span class="ident" id="1967487">n</span>&nbsp;<span class="op" id="1967489">&lt;</span>&nbsp;<span class="builtinfunc" id="1967491">len</span><span class="op" id="1967494">(</span><span class="ident" id="1967495">r</span><span class="op" id="1967496">.</span><span class="ident" id="1967497">Stack0</span><span class="op" id="1967503">)</span>&nbsp;<span class="op" id="1967505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967509">r</span><span class="op" id="1967510">.</span><span class="ident" id="1967511">Stack0</span><span class="op" id="1967517">[</span><span class="ident" id="1967518">n</span><span class="op" id="1967519">]</span>&nbsp;<span class="op" id="1967521">=</span>&nbsp;<span class="num" id="1967523">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967526">}</span><br>
<span class="lineno"></span><span class="op" id="1967528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1967531">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1967596">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1967647">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1967717">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1967772">func</span>&nbsp;<span class="ident" id="1967777">Stack</span><span class="op" id="1967782">(</span><span class="ident" id="1967783">buf</span>&nbsp;<span class="op" id="1967787">[</span><span class="op" id="1967788">]</span><span class="builtintype" id="1967789">byte</span><span class="op" id="1967793">,</span>&nbsp;<span class="ident" id="1967795">all</span>&nbsp;<span class="builtintype" id="1967799">bool</span><span class="op" id="1967803">)</span>&nbsp;<span class="builtintype" id="1967805">int</span>&nbsp;<span class="op" id="1967809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967812">mp</span>&nbsp;<span class="op" id="1967815">:=</span>&nbsp;<span class="ident" id="1967818">acquirem</span><span class="op" id="1967826">(</span><span class="op" id="1967827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967830">gp</span>&nbsp;<span class="op" id="1967833">:=</span>&nbsp;<span class="ident" id="1967836">mp</span><span class="op" id="1967838">.</span><span class="ident" id="1967839">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967845">if</span>&nbsp;<span class="ident" id="1967848">all</span>&nbsp;<span class="op" id="1967852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967856">semacquire</span><span class="op" id="1967866">(</span><span class="op" id="1967867">&amp;</span><span class="ident" id="1967868">worldsema</span><span class="op" id="1967877">,</span>&nbsp;<span class="builtintype" id="1967879">false</span><span class="op" id="1967884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967888">mp</span><span class="op" id="1967890">.</span><span class="ident" id="1967891">gcing</span>&nbsp;<span class="op" id="1967897">=</span>&nbsp;<span class="num" id="1967899">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967903">releasem</span><span class="op" id="1967911">(</span><span class="ident" id="1967912">mp</span><span class="op" id="1967914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967918">onM</span><span class="op" id="1967921">(</span><span class="ident" id="1967922">stoptheworld</span><span class="op" id="1967934">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1967938">if</span>&nbsp;<span class="ident" id="1967941">mp</span>&nbsp;<span class="op" id="1967944">!=</span>&nbsp;<span class="ident" id="1967947">acquirem</span><span class="op" id="1967955">(</span><span class="op" id="1967956">)</span>&nbsp;<span class="op" id="1967958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1967963">gothrow</span><span class="op" id="1967970">(</span><span class="string" id="1967971">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1967991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1967998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968002">n</span>&nbsp;<span class="op" id="1968004">:=</span>&nbsp;<span class="num" id="1968007">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968010">if</span>&nbsp;<span class="builtinfunc" id="1968013">len</span><span class="op" id="1968016">(</span><span class="ident" id="1968017">buf</span><span class="op" id="1968020">)</span>&nbsp;<span class="op" id="1968022">&gt;</span>&nbsp;<span class="num" id="1968024">0</span>&nbsp;<span class="op" id="1968026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968030">sp</span>&nbsp;<span class="op" id="1968033">:=</span>&nbsp;<span class="ident" id="1968036">getcallersp</span><span class="op" id="1968047">(</span><span class="ident" id="1968048">unsafe</span><span class="op" id="1968054">.</span><span class="ident" id="1968055">Pointer</span><span class="op" id="1968062">(</span><span class="op" id="1968063">&amp;</span><span class="ident" id="1968064">buf</span><span class="op" id="1968067">)</span><span class="op" id="1968068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968072">pc</span>&nbsp;<span class="op" id="1968075">:=</span>&nbsp;<span class="ident" id="1968078">getcallerpc</span><span class="op" id="1968089">(</span><span class="ident" id="1968090">unsafe</span><span class="op" id="1968096">.</span><span class="ident" id="1968097">Pointer</span><span class="op" id="1968104">(</span><span class="op" id="1968105">&amp;</span><span class="ident" id="1968106">buf</span><span class="op" id="1968109">)</span><span class="op" id="1968110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968114">onM</span><span class="op" id="1968117">(</span><span class="keyword" id="1968118">func</span><span class="op" id="1968122">(</span><span class="op" id="1968123">)</span>&nbsp;<span class="op" id="1968125">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968130">g0</span>&nbsp;<span class="op" id="1968133">:=</span>&nbsp;<span class="ident" id="1968136">getg</span><span class="op" id="1968140">(</span><span class="op" id="1968141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968146">g0</span><span class="op" id="1968148">.</span><span class="ident" id="1968149">writebuf</span>&nbsp;<span class="op" id="1968158">=</span>&nbsp;<span class="ident" id="1968160">buf</span><span class="op" id="1968163">[</span><span class="num" id="1968164">0</span><span class="op" id="1968165">:</span><span class="num" id="1968166">0</span><span class="op" id="1968167">:</span><span class="builtinfunc" id="1968168">len</span><span class="op" id="1968171">(</span><span class="ident" id="1968172">buf</span><span class="op" id="1968175">)</span><span class="op" id="1968176">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968181">goroutineheader</span><span class="op" id="1968196">(</span><span class="ident" id="1968197">gp</span><span class="op" id="1968199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968204">traceback</span><span class="op" id="1968213">(</span><span class="ident" id="1968214">pc</span><span class="op" id="1968216">,</span>&nbsp;<span class="ident" id="1968218">sp</span><span class="op" id="1968220">,</span>&nbsp;<span class="num" id="1968222">0</span><span class="op" id="1968223">,</span>&nbsp;<span class="ident" id="1968225">gp</span><span class="op" id="1968227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968232">if</span>&nbsp;<span class="ident" id="1968235">all</span>&nbsp;<span class="op" id="1968239">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968245">tracebackothers</span><span class="op" id="1968260">(</span><span class="ident" id="1968261">gp</span><span class="op" id="1968263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968273">n</span>&nbsp;<span class="op" id="1968275">=</span>&nbsp;<span class="builtinfunc" id="1968277">len</span><span class="op" id="1968280">(</span><span class="ident" id="1968281">g0</span><span class="op" id="1968283">.</span><span class="ident" id="1968284">writebuf</span><span class="op" id="1968292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968297">g0</span><span class="op" id="1968299">.</span><span class="ident" id="1968300">writebuf</span>&nbsp;<span class="op" id="1968309">=</span>&nbsp;<span class="ident" id="1968311">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968317">}</span><span class="op" id="1968318">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968325">if</span>&nbsp;<span class="ident" id="1968328">all</span>&nbsp;<span class="op" id="1968332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968336">mp</span><span class="op" id="1968338">.</span><span class="ident" id="1968339">gcing</span>&nbsp;<span class="op" id="1968345">=</span>&nbsp;<span class="num" id="1968347">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968351">semrelease</span><span class="op" id="1968361">(</span><span class="op" id="1968362">&amp;</span><span class="ident" id="1968363">worldsema</span><span class="op" id="1968372">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968376">onM</span><span class="op" id="1968379">(</span><span class="ident" id="1968380">starttheworld</span><span class="op" id="1968393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968399">releasem</span><span class="op" id="1968407">(</span><span class="ident" id="1968408">mp</span><span class="op" id="1968410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968413">return</span>&nbsp;<span class="ident" id="1968420">n</span><br>
<span class="lineno"></span><span class="op" id="1968422">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1968425">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1968455">var</span>&nbsp;<span class="ident" id="1968459">tracelock</span>&nbsp;<span class="ident" id="1968469">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1968476">func</span>&nbsp;<span class="ident" id="1968481">tracealloc</span><span class="op" id="1968491">(</span><span class="ident" id="1968492">p</span>&nbsp;<span class="ident" id="1968494">unsafe</span><span class="op" id="1968500">.</span><span class="ident" id="1968501">Pointer</span><span class="op" id="1968508">,</span>&nbsp;<span class="ident" id="1968510">size</span>&nbsp;<span class="builtintype" id="1968515">uintptr</span><span class="op" id="1968522">,</span>&nbsp;<span class="ident" id="1968524">typ</span>&nbsp;<span class="op" id="1968528">*</span><span class="ident" id="1968529">_type</span><span class="op" id="1968534">)</span>&nbsp;<span class="op" id="1968536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968539">lock</span><span class="op" id="1968543">(</span><span class="op" id="1968544">&amp;</span><span class="ident" id="1968545">tracelock</span><span class="op" id="1968554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968557">gp</span>&nbsp;<span class="op" id="1968560">:=</span>&nbsp;<span class="ident" id="1968563">getg</span><span class="op" id="1968567">(</span><span class="op" id="1968568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968571">gp</span><span class="op" id="1968573">.</span><span class="ident" id="1968574">m</span><span class="op" id="1968575">.</span><span class="ident" id="1968576">traceback</span>&nbsp;<span class="op" id="1968586">=</span>&nbsp;<span class="num" id="1968588">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968591">if</span>&nbsp;<span class="ident" id="1968594">typ</span>&nbsp;<span class="op" id="1968598">==</span>&nbsp;<span class="ident" id="1968601">nil</span>&nbsp;<span class="op" id="1968605">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1968609">print</span><span class="op" id="1968614">(</span><span class="string" id="1968615">&#34;tracealloc(&#34;</span><span class="op" id="1968628">,</span>&nbsp;<span class="ident" id="1968630">p</span><span class="op" id="1968631">,</span>&nbsp;<span class="string" id="1968633">&#34;,&nbsp;&#34;</span><span class="op" id="1968637">,</span>&nbsp;<span class="ident" id="1968639">hex</span><span class="op" id="1968642">(</span><span class="ident" id="1968643">size</span><span class="op" id="1968647">)</span><span class="op" id="1968648">,</span>&nbsp;<span class="string" id="1968650">&#34;)\n&#34;</span><span class="op" id="1968655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968658">}</span>&nbsp;<span class="keyword" id="1968660">else</span>&nbsp;<span class="op" id="1968665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1968669">print</span><span class="op" id="1968674">(</span><span class="string" id="1968675">&#34;tracealloc(&#34;</span><span class="op" id="1968688">,</span>&nbsp;<span class="ident" id="1968690">p</span><span class="op" id="1968691">,</span>&nbsp;<span class="string" id="1968693">&#34;,&nbsp;&#34;</span><span class="op" id="1968697">,</span>&nbsp;<span class="ident" id="1968699">hex</span><span class="op" id="1968702">(</span><span class="ident" id="1968703">size</span><span class="op" id="1968707">)</span><span class="op" id="1968708">,</span>&nbsp;<span class="string" id="1968710">&#34;,&nbsp;&#34;</span><span class="op" id="1968714">,</span>&nbsp;<span class="op" id="1968716">*</span><span class="ident" id="1968717">typ</span><span class="op" id="1968720">.</span><span class="ident" id="1968721">_string</span><span class="op" id="1968728">,</span>&nbsp;<span class="string" id="1968730">&#34;)\n&#34;</span><span class="op" id="1968735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1968741">if</span>&nbsp;<span class="ident" id="1968744">gp</span><span class="op" id="1968746">.</span><span class="ident" id="1968747">m</span><span class="op" id="1968748">.</span><span class="ident" id="1968749">curg</span>&nbsp;<span class="op" id="1968754">==</span>&nbsp;<span class="ident" id="1968757">nil</span>&nbsp;<span class="op" id="1968761">||</span>&nbsp;<span class="ident" id="1968764">gp</span>&nbsp;<span class="op" id="1968767">==</span>&nbsp;<span class="ident" id="1968770">gp</span><span class="op" id="1968772">.</span><span class="ident" id="1968773">m</span><span class="op" id="1968774">.</span><span class="ident" id="1968775">curg</span>&nbsp;<span class="op" id="1968780">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968784">goroutineheader</span><span class="op" id="1968799">(</span><span class="ident" id="1968800">gp</span><span class="op" id="1968802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968806">pc</span>&nbsp;<span class="op" id="1968809">:=</span>&nbsp;<span class="ident" id="1968812">getcallerpc</span><span class="op" id="1968823">(</span><span class="ident" id="1968824">unsafe</span><span class="op" id="1968830">.</span><span class="ident" id="1968831">Pointer</span><span class="op" id="1968838">(</span><span class="op" id="1968839">&amp;</span><span class="ident" id="1968840">p</span><span class="op" id="1968841">)</span><span class="op" id="1968842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968846">sp</span>&nbsp;<span class="op" id="1968849">:=</span>&nbsp;<span class="ident" id="1968852">getcallersp</span><span class="op" id="1968863">(</span><span class="ident" id="1968864">unsafe</span><span class="op" id="1968870">.</span><span class="ident" id="1968871">Pointer</span><span class="op" id="1968878">(</span><span class="op" id="1968879">&amp;</span><span class="ident" id="1968880">p</span><span class="op" id="1968881">)</span><span class="op" id="1968882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968886">onM</span><span class="op" id="1968889">(</span><span class="keyword" id="1968890">func</span><span class="op" id="1968894">(</span><span class="op" id="1968895">)</span>&nbsp;<span class="op" id="1968897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968902">traceback</span><span class="op" id="1968911">(</span><span class="ident" id="1968912">pc</span><span class="op" id="1968914">,</span>&nbsp;<span class="ident" id="1968916">sp</span><span class="op" id="1968918">,</span>&nbsp;<span class="num" id="1968920">0</span><span class="op" id="1968921">,</span>&nbsp;<span class="ident" id="1968923">gp</span><span class="op" id="1968925">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968929">}</span><span class="op" id="1968930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1968933">}</span>&nbsp;<span class="keyword" id="1968935">else</span>&nbsp;<span class="op" id="1968940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968944">goroutineheader</span><span class="op" id="1968959">(</span><span class="ident" id="1968960">gp</span><span class="op" id="1968962">.</span><span class="ident" id="1968963">m</span><span class="op" id="1968964">.</span><span class="ident" id="1968965">curg</span><span class="op" id="1968969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1968973">traceback</span><span class="op" id="1968982">(</span><span class="op" id="1968983">^</span><span class="builtintype" id="1968984">uintptr</span><span class="op" id="1968991">(</span><span class="num" id="1968992">0</span><span class="op" id="1968993">)</span><span class="op" id="1968994">,</span>&nbsp;<span class="op" id="1968996">^</span><span class="builtintype" id="1968997">uintptr</span><span class="op" id="1969004">(</span><span class="num" id="1969005">0</span><span class="op" id="1969006">)</span><span class="op" id="1969007">,</span>&nbsp;<span class="num" id="1969009">0</span><span class="op" id="1969010">,</span>&nbsp;<span class="ident" id="1969012">gp</span><span class="op" id="1969014">.</span><span class="ident" id="1969015">m</span><span class="op" id="1969016">.</span><span class="ident" id="1969017">curg</span><span class="op" id="1969021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1969024">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969027">print</span><span class="op" id="1969032">(</span><span class="string" id="1969033">&#34;\n&#34;</span><span class="op" id="1969037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969040">gp</span><span class="op" id="1969042">.</span><span class="ident" id="1969043">m</span><span class="op" id="1969044">.</span><span class="ident" id="1969045">traceback</span>&nbsp;<span class="op" id="1969055">=</span>&nbsp;<span class="num" id="1969057">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969060">unlock</span><span class="op" id="1969066">(</span><span class="op" id="1969067">&amp;</span><span class="ident" id="1969068">tracelock</span><span class="op" id="1969077">)</span><br>
<span class="lineno"></span><span class="op" id="1969079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1969082">func</span>&nbsp;<span class="ident" id="1969087">tracefree</span><span class="op" id="1969096">(</span><span class="ident" id="1969097">p</span>&nbsp;<span class="ident" id="1969099">unsafe</span><span class="op" id="1969105">.</span><span class="ident" id="1969106">Pointer</span><span class="op" id="1969113">,</span>&nbsp;<span class="ident" id="1969115">size</span>&nbsp;<span class="builtintype" id="1969120">uintptr</span><span class="op" id="1969127">)</span>&nbsp;<span class="op" id="1969129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969132">lock</span><span class="op" id="1969136">(</span><span class="op" id="1969137">&amp;</span><span class="ident" id="1969138">tracelock</span><span class="op" id="1969147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969150">gp</span>&nbsp;<span class="op" id="1969153">:=</span>&nbsp;<span class="ident" id="1969156">getg</span><span class="op" id="1969160">(</span><span class="op" id="1969161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969164">gp</span><span class="op" id="1969166">.</span><span class="ident" id="1969167">m</span><span class="op" id="1969168">.</span><span class="ident" id="1969169">traceback</span>&nbsp;<span class="op" id="1969179">=</span>&nbsp;<span class="num" id="1969181">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969184">print</span><span class="op" id="1969189">(</span><span class="string" id="1969190">&#34;tracefree(&#34;</span><span class="op" id="1969202">,</span>&nbsp;<span class="ident" id="1969204">p</span><span class="op" id="1969205">,</span>&nbsp;<span class="string" id="1969207">&#34;,&nbsp;&#34;</span><span class="op" id="1969211">,</span>&nbsp;<span class="ident" id="1969213">hex</span><span class="op" id="1969216">(</span><span class="ident" id="1969217">size</span><span class="op" id="1969221">)</span><span class="op" id="1969222">,</span>&nbsp;<span class="string" id="1969224">&#34;)\n&#34;</span><span class="op" id="1969229">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969232">goroutineheader</span><span class="op" id="1969247">(</span><span class="ident" id="1969248">gp</span><span class="op" id="1969250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969253">pc</span>&nbsp;<span class="op" id="1969256">:=</span>&nbsp;<span class="ident" id="1969259">getcallerpc</span><span class="op" id="1969270">(</span><span class="ident" id="1969271">unsafe</span><span class="op" id="1969277">.</span><span class="ident" id="1969278">Pointer</span><span class="op" id="1969285">(</span><span class="op" id="1969286">&amp;</span><span class="ident" id="1969287">p</span><span class="op" id="1969288">)</span><span class="op" id="1969289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969292">sp</span>&nbsp;<span class="op" id="1969295">:=</span>&nbsp;<span class="ident" id="1969298">getcallersp</span><span class="op" id="1969309">(</span><span class="ident" id="1969310">unsafe</span><span class="op" id="1969316">.</span><span class="ident" id="1969317">Pointer</span><span class="op" id="1969324">(</span><span class="op" id="1969325">&amp;</span><span class="ident" id="1969326">p</span><span class="op" id="1969327">)</span><span class="op" id="1969328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969331">onM</span><span class="op" id="1969334">(</span><span class="keyword" id="1969335">func</span><span class="op" id="1969339">(</span><span class="op" id="1969340">)</span>&nbsp;<span class="op" id="1969342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969346">traceback</span><span class="op" id="1969355">(</span><span class="ident" id="1969356">pc</span><span class="op" id="1969358">,</span>&nbsp;<span class="ident" id="1969360">sp</span><span class="op" id="1969362">,</span>&nbsp;<span class="num" id="1969364">0</span><span class="op" id="1969365">,</span>&nbsp;<span class="ident" id="1969367">gp</span><span class="op" id="1969369">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1969372">}</span><span class="op" id="1969373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969376">print</span><span class="op" id="1969381">(</span><span class="string" id="1969382">&#34;\n&#34;</span><span class="op" id="1969386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969389">gp</span><span class="op" id="1969391">.</span><span class="ident" id="1969392">m</span><span class="op" id="1969393">.</span><span class="ident" id="1969394">traceback</span>&nbsp;<span class="op" id="1969404">=</span>&nbsp;<span class="num" id="1969406">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969409">unlock</span><span class="op" id="1969415">(</span><span class="op" id="1969416">&amp;</span><span class="ident" id="1969417">tracelock</span><span class="op" id="1969426">)</span><br>
<span class="lineno"></span><span class="op" id="1969428">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1969431">func</span>&nbsp;<span class="ident" id="1969436">tracegc</span><span class="op" id="1969443">(</span><span class="op" id="1969444">)</span>&nbsp;<span class="op" id="1969446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969449">lock</span><span class="op" id="1969453">(</span><span class="op" id="1969454">&amp;</span><span class="ident" id="1969455">tracelock</span><span class="op" id="1969464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969467">gp</span>&nbsp;<span class="op" id="1969470">:=</span>&nbsp;<span class="ident" id="1969473">getg</span><span class="op" id="1969477">(</span><span class="op" id="1969478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969481">gp</span><span class="op" id="1969483">.</span><span class="ident" id="1969484">m</span><span class="op" id="1969485">.</span><span class="ident" id="1969486">traceback</span>&nbsp;<span class="op" id="1969496">=</span>&nbsp;<span class="num" id="1969498">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969501">print</span><span class="op" id="1969506">(</span><span class="string" id="1969507">&#34;tracegc()\n&#34;</span><span class="op" id="1969520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1969523">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969578">tracebackothers</span><span class="op" id="1969593">(</span><span class="ident" id="1969594">gp</span><span class="op" id="1969596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969599">print</span><span class="op" id="1969604">(</span><span class="string" id="1969605">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1969620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1969623">print</span><span class="op" id="1969628">(</span><span class="string" id="1969629">&#34;\n&#34;</span><span class="op" id="1969633">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969636">gp</span><span class="op" id="1969638">.</span><span class="ident" id="1969639">m</span><span class="op" id="1969640">.</span><span class="ident" id="1969641">traceback</span>&nbsp;<span class="op" id="1969651">=</span>&nbsp;<span class="num" id="1969653">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1969656">unlock</span><span class="op" id="1969662">(</span><span class="op" id="1969663">&amp;</span><span class="ident" id="1969664">tracelock</span><span class="op" id="1969673">)</span><br>
<span class="lineno"></span><span class="op" id="1969675">}</span>
</div>
</body>
</html>
