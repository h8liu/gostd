<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2993516">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2993571">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2993625">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2993676">package</span>&nbsp;<span class="ident" id="2993684">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2993689">import</span>&nbsp;<span class="string" id="2993696">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2993711">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="2993765">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="2993821">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="2993860">type</span>&nbsp;<span class="ident" id="2993865">fdMutex</span>&nbsp;<span class="keyword" id="2993873">struct</span>&nbsp;<span class="op" id="2993880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993883">state</span>&nbsp;<span class="ident" id="2993889">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993897">rsema</span>&nbsp;<span class="builtintype" id="2993903">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993911">wsema</span>&nbsp;<span class="builtintype" id="2993917">uint32</span><br>
<span class="lineno"></span><span class="op" id="2993924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2993927">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2993969">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="2994054">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2994091">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2994129">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="2994188">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="2994237">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="2994287">const</span>&nbsp;<span class="op" id="2994293">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994296">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="2994309">=</span>&nbsp;<span class="num" id="2994311">1</span>&nbsp;<span class="op" id="2994313">&lt;&lt;</span>&nbsp;<span class="num" id="2994316">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994319">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994332">=</span>&nbsp;<span class="num" id="2994334">1</span>&nbsp;<span class="op" id="2994336">&lt;&lt;</span>&nbsp;<span class="num" id="2994339">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994342">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994355">=</span>&nbsp;<span class="num" id="2994357">1</span>&nbsp;<span class="op" id="2994359">&lt;&lt;</span>&nbsp;<span class="num" id="2994362">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994365">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2994378">=</span>&nbsp;<span class="num" id="2994380">1</span>&nbsp;<span class="op" id="2994382">&lt;&lt;</span>&nbsp;<span class="num" id="2994385">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994388">mutexRefMask</span>&nbsp;<span class="op" id="2994401">=</span>&nbsp;<span class="op" id="2994403">(</span><span class="num" id="2994404">1</span><span class="op" id="2994405">&lt;&lt;</span><span class="num" id="2994407">20</span>&nbsp;<span class="op" id="2994410">-</span>&nbsp;<span class="num" id="2994412">1</span><span class="op" id="2994413">)</span>&nbsp;<span class="op" id="2994415">&lt;&lt;</span>&nbsp;<span class="num" id="2994418">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994421">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994434">=</span>&nbsp;<span class="num" id="2994436">1</span>&nbsp;<span class="op" id="2994438">&lt;&lt;</span>&nbsp;<span class="num" id="2994441">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994445">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994458">=</span>&nbsp;<span class="op" id="2994460">(</span><span class="num" id="2994461">1</span><span class="op" id="2994462">&lt;&lt;</span><span class="num" id="2994464">20</span>&nbsp;<span class="op" id="2994467">-</span>&nbsp;<span class="num" id="2994469">1</span><span class="op" id="2994470">)</span>&nbsp;<span class="op" id="2994472">&lt;&lt;</span>&nbsp;<span class="num" id="2994475">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994479">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994492">=</span>&nbsp;<span class="num" id="2994494">1</span>&nbsp;<span class="op" id="2994496">&lt;&lt;</span>&nbsp;<span class="num" id="2994499">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994503">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2994516">=</span>&nbsp;<span class="op" id="2994518">(</span><span class="num" id="2994519">1</span><span class="op" id="2994520">&lt;&lt;</span><span class="num" id="2994522">20</span>&nbsp;<span class="op" id="2994525">-</span>&nbsp;<span class="num" id="2994527">1</span><span class="op" id="2994528">)</span>&nbsp;<span class="op" id="2994530">&lt;&lt;</span>&nbsp;<span class="num" id="2994533">43</span><br>
<span class="lineno">35</span><span class="op" id="2994536">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2994539">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="2994595">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="2994654">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="2994735">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="2994812">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="2994885">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="2994935">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="2994986">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="2995030">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2995117">func</span>&nbsp;<span class="op" id="2995122">(</span><span class="ident" id="2995123">mu</span>&nbsp;<span class="op" id="2995126">*</span><span class="ident" id="2995127">fdMutex</span><span class="op" id="2995134">)</span>&nbsp;<span class="ident" id="2995136">Incref</span><span class="op" id="2995142">(</span><span class="op" id="2995143">)</span>&nbsp;<span class="builtintype" id="2995145">bool</span>&nbsp;<span class="op" id="2995150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995153">for</span>&nbsp;<span class="op" id="2995157">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995161">old</span>&nbsp;<span class="op" id="2995165">:=</span>&nbsp;<span class="ident" id="2995168">atomic</span><span class="op" id="2995174">.</span><span class="ident" id="2995175">LoadUint64</span><span class="op" id="2995185">(</span><span class="op" id="2995186">&amp;</span><span class="ident" id="2995187">mu</span><span class="op" id="2995189">.</span><span class="ident" id="2995190">state</span><span class="op" id="2995195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995199">if</span>&nbsp;<span class="ident" id="2995202">old</span><span class="op" id="2995205">&amp;</span><span class="ident" id="2995206">mutexClosed</span>&nbsp;<span class="op" id="2995218">!=</span>&nbsp;<span class="num" id="2995221">0</span>&nbsp;<span class="op" id="2995223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995228">return</span>&nbsp;<span class="builtintype" id="2995235">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2995247">new</span>&nbsp;<span class="op" id="2995251">:=</span>&nbsp;<span class="ident" id="2995254">old</span>&nbsp;<span class="op" id="2995258">+</span>&nbsp;<span class="ident" id="2995260">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995271">if</span>&nbsp;<span class="builtinfunc" id="2995274">new</span><span class="op" id="2995277">&amp;</span><span class="ident" id="2995278">mutexRefMask</span>&nbsp;<span class="op" id="2995291">==</span>&nbsp;<span class="num" id="2995294">0</span>&nbsp;<span class="op" id="2995296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2995301">panic</span><span class="op" id="2995306">(</span><span class="string" id="2995307">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2995334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995342">if</span>&nbsp;<span class="ident" id="2995345">atomic</span><span class="op" id="2995351">.</span><span class="ident" id="2995352">CompareAndSwapUint64</span><span class="op" id="2995372">(</span><span class="op" id="2995373">&amp;</span><span class="ident" id="2995374">mu</span><span class="op" id="2995376">.</span><span class="ident" id="2995377">state</span><span class="op" id="2995382">,</span>&nbsp;<span class="ident" id="2995384">old</span><span class="op" id="2995387">,</span>&nbsp;<span class="builtinfunc" id="2995389">new</span><span class="op" id="2995392">)</span>&nbsp;<span class="op" id="2995394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995399">return</span>&nbsp;<span class="builtintype" id="2995406">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995416">}</span><br>
<span class="lineno"></span><span class="op" id="2995418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2995421">func</span>&nbsp;<span class="op" id="2995426">(</span><span class="ident" id="2995427">mu</span>&nbsp;<span class="op" id="2995430">*</span><span class="ident" id="2995431">fdMutex</span><span class="op" id="2995438">)</span>&nbsp;<span class="ident" id="2995440">IncrefAndClose</span><span class="op" id="2995454">(</span><span class="op" id="2995455">)</span>&nbsp;<span class="builtintype" id="2995457">bool</span>&nbsp;<span class="op" id="2995462">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995465">for</span>&nbsp;<span class="op" id="2995469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995473">old</span>&nbsp;<span class="op" id="2995477">:=</span>&nbsp;<span class="ident" id="2995480">atomic</span><span class="op" id="2995486">.</span><span class="ident" id="2995487">LoadUint64</span><span class="op" id="2995497">(</span><span class="op" id="2995498">&amp;</span><span class="ident" id="2995499">mu</span><span class="op" id="2995501">.</span><span class="ident" id="2995502">state</span><span class="op" id="2995507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995511">if</span>&nbsp;<span class="ident" id="2995514">old</span><span class="op" id="2995517">&amp;</span><span class="ident" id="2995518">mutexClosed</span>&nbsp;<span class="op" id="2995530">!=</span>&nbsp;<span class="num" id="2995533">0</span>&nbsp;<span class="op" id="2995535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995540">return</span>&nbsp;<span class="builtintype" id="2995547">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995555">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2995559">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2995604">new</span>&nbsp;<span class="op" id="2995608">:=</span>&nbsp;<span class="op" id="2995611">(</span><span class="ident" id="2995612">old</span>&nbsp;<span class="op" id="2995616">|</span>&nbsp;<span class="ident" id="2995618">mutexClosed</span><span class="op" id="2995629">)</span>&nbsp;<span class="op" id="2995631">+</span>&nbsp;<span class="ident" id="2995633">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995644">if</span>&nbsp;<span class="builtinfunc" id="2995647">new</span><span class="op" id="2995650">&amp;</span><span class="ident" id="2995651">mutexRefMask</span>&nbsp;<span class="op" id="2995664">==</span>&nbsp;<span class="num" id="2995667">0</span>&nbsp;<span class="op" id="2995669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2995674">panic</span><span class="op" id="2995679">(</span><span class="string" id="2995680">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2995707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995711">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2995715">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2995755">new</span>&nbsp;<span class="op" id="2995759">&amp;^=</span>&nbsp;<span class="ident" id="2995763">mutexRMask</span>&nbsp;<span class="op" id="2995774">|</span>&nbsp;<span class="ident" id="2995776">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995789">if</span>&nbsp;<span class="ident" id="2995792">atomic</span><span class="op" id="2995798">.</span><span class="ident" id="2995799">CompareAndSwapUint64</span><span class="op" id="2995819">(</span><span class="op" id="2995820">&amp;</span><span class="ident" id="2995821">mu</span><span class="op" id="2995823">.</span><span class="ident" id="2995824">state</span><span class="op" id="2995829">,</span>&nbsp;<span class="ident" id="2995831">old</span><span class="op" id="2995834">,</span>&nbsp;<span class="builtinfunc" id="2995836">new</span><span class="op" id="2995839">)</span>&nbsp;<span class="op" id="2995841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2995846">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2995885">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995935">for</span>&nbsp;<span class="ident" id="2995939">old</span><span class="op" id="2995942">&amp;</span><span class="ident" id="2995943">mutexRMask</span>&nbsp;<span class="op" id="2995954">!=</span>&nbsp;<span class="num" id="2995957">0</span>&nbsp;<span class="op" id="2995959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995965">old</span>&nbsp;<span class="op" id="2995969">-=</span>&nbsp;<span class="ident" id="2995972">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995987">runtime_Semrelease</span><span class="op" id="2996005">(</span><span class="op" id="2996006">&amp;</span><span class="ident" id="2996007">mu</span><span class="op" id="2996009">.</span><span class="ident" id="2996010">rsema</span><span class="op" id="2996015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996025">for</span>&nbsp;<span class="ident" id="2996029">old</span><span class="op" id="2996032">&amp;</span><span class="ident" id="2996033">mutexWMask</span>&nbsp;<span class="op" id="2996044">!=</span>&nbsp;<span class="num" id="2996047">0</span>&nbsp;<span class="op" id="2996049">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996055">old</span>&nbsp;<span class="op" id="2996059">-=</span>&nbsp;<span class="ident" id="2996062">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996077">runtime_Semrelease</span><span class="op" id="2996095">(</span><span class="op" id="2996096">&amp;</span><span class="ident" id="2996097">mu</span><span class="op" id="2996099">.</span><span class="ident" id="2996100">wsema</span><span class="op" id="2996105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996115">return</span>&nbsp;<span class="builtintype" id="2996122">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996129">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996132">}</span><br>
<span class="lineno"></span><span class="op" id="2996134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2996137">func</span>&nbsp;<span class="op" id="2996142">(</span><span class="ident" id="2996143">mu</span>&nbsp;<span class="op" id="2996146">*</span><span class="ident" id="2996147">fdMutex</span><span class="op" id="2996154">)</span>&nbsp;<span class="ident" id="2996156">Decref</span><span class="op" id="2996162">(</span><span class="op" id="2996163">)</span>&nbsp;<span class="builtintype" id="2996165">bool</span>&nbsp;<span class="op" id="2996170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996173">for</span>&nbsp;<span class="op" id="2996177">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996181">old</span>&nbsp;<span class="op" id="2996185">:=</span>&nbsp;<span class="ident" id="2996188">atomic</span><span class="op" id="2996194">.</span><span class="ident" id="2996195">LoadUint64</span><span class="op" id="2996205">(</span><span class="op" id="2996206">&amp;</span><span class="ident" id="2996207">mu</span><span class="op" id="2996209">.</span><span class="ident" id="2996210">state</span><span class="op" id="2996215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996219">if</span>&nbsp;<span class="ident" id="2996222">old</span><span class="op" id="2996225">&amp;</span><span class="ident" id="2996226">mutexRefMask</span>&nbsp;<span class="op" id="2996239">==</span>&nbsp;<span class="num" id="2996242">0</span>&nbsp;<span class="op" id="2996244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2996249">panic</span><span class="op" id="2996254">(</span><span class="string" id="2996255">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2996282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2996290">new</span>&nbsp;<span class="op" id="2996294">:=</span>&nbsp;<span class="ident" id="2996297">old</span>&nbsp;<span class="op" id="2996301">-</span>&nbsp;<span class="ident" id="2996303">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996314">if</span>&nbsp;<span class="ident" id="2996317">atomic</span><span class="op" id="2996323">.</span><span class="ident" id="2996324">CompareAndSwapUint64</span><span class="op" id="2996344">(</span><span class="op" id="2996345">&amp;</span><span class="ident" id="2996346">mu</span><span class="op" id="2996348">.</span><span class="ident" id="2996349">state</span><span class="op" id="2996354">,</span>&nbsp;<span class="ident" id="2996356">old</span><span class="op" id="2996359">,</span>&nbsp;<span class="builtinfunc" id="2996361">new</span><span class="op" id="2996364">)</span>&nbsp;<span class="op" id="2996366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996371">return</span>&nbsp;<span class="builtinfunc" id="2996378">new</span><span class="op" id="2996381">&amp;</span><span class="op" id="2996382">(</span><span class="ident" id="2996383">mutexClosed</span><span class="op" id="2996394">|</span><span class="ident" id="2996395">mutexRefMask</span><span class="op" id="2996407">)</span>&nbsp;<span class="op" id="2996409">==</span>&nbsp;<span class="ident" id="2996412">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996429">}</span><br>
<span class="lineno"></span><span class="op" id="2996431">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="2996434">func</span>&nbsp;<span class="op" id="2996439">(</span><span class="ident" id="2996440">mu</span>&nbsp;<span class="op" id="2996443">*</span><span class="ident" id="2996444">fdMutex</span><span class="op" id="2996451">)</span>&nbsp;<span class="ident" id="2996453">RWLock</span><span class="op" id="2996459">(</span><span class="ident" id="2996460">read</span>&nbsp;<span class="builtintype" id="2996465">bool</span><span class="op" id="2996469">)</span>&nbsp;<span class="builtintype" id="2996471">bool</span>&nbsp;<span class="op" id="2996476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996479">var</span>&nbsp;<span class="ident" id="2996483">mutexBit</span><span class="op" id="2996491">,</span>&nbsp;<span class="ident" id="2996493">mutexWait</span><span class="op" id="2996502">,</span>&nbsp;<span class="ident" id="2996504">mutexMask</span>&nbsp;<span class="ident" id="2996514">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996522">var</span>&nbsp;<span class="ident" id="2996526">mutexSema</span>&nbsp;<span class="op" id="2996536">*</span><span class="builtintype" id="2996537">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996545">if</span>&nbsp;<span class="ident" id="2996548">read</span>&nbsp;<span class="op" id="2996553">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996557">mutexBit</span>&nbsp;<span class="op" id="2996566">=</span>&nbsp;<span class="ident" id="2996568">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996581">mutexWait</span>&nbsp;<span class="op" id="2996591">=</span>&nbsp;<span class="ident" id="2996593">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996606">mutexMask</span>&nbsp;<span class="op" id="2996616">=</span>&nbsp;<span class="ident" id="2996618">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996631">mutexSema</span>&nbsp;<span class="op" id="2996641">=</span>&nbsp;<span class="op" id="2996643">&amp;</span><span class="ident" id="2996644">mu</span><span class="op" id="2996646">.</span><span class="ident" id="2996647">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996654">}</span>&nbsp;<span class="keyword" id="2996656">else</span>&nbsp;<span class="op" id="2996661">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996665">mutexBit</span>&nbsp;<span class="op" id="2996674">=</span>&nbsp;<span class="ident" id="2996676">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996689">mutexWait</span>&nbsp;<span class="op" id="2996699">=</span>&nbsp;<span class="ident" id="2996701">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996714">mutexMask</span>&nbsp;<span class="op" id="2996724">=</span>&nbsp;<span class="ident" id="2996726">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996739">mutexSema</span>&nbsp;<span class="op" id="2996749">=</span>&nbsp;<span class="op" id="2996751">&amp;</span><span class="ident" id="2996752">mu</span><span class="op" id="2996754">.</span><span class="ident" id="2996755">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996762">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996765">for</span>&nbsp;<span class="op" id="2996769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2996773">old</span>&nbsp;<span class="op" id="2996777">:=</span>&nbsp;<span class="ident" id="2996780">atomic</span><span class="op" id="2996786">.</span><span class="ident" id="2996787">LoadUint64</span><span class="op" id="2996797">(</span><span class="op" id="2996798">&amp;</span><span class="ident" id="2996799">mu</span><span class="op" id="2996801">.</span><span class="ident" id="2996802">state</span><span class="op" id="2996807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996811">if</span>&nbsp;<span class="ident" id="2996814">old</span><span class="op" id="2996817">&amp;</span><span class="ident" id="2996818">mutexClosed</span>&nbsp;<span class="op" id="2996830">!=</span>&nbsp;<span class="num" id="2996833">0</span>&nbsp;<span class="op" id="2996835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996840">return</span>&nbsp;<span class="builtintype" id="2996847">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2996855">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996859">var</span>&nbsp;<span class="builtinfunc" id="2996863">new</span>&nbsp;<span class="ident" id="2996867">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996876">if</span>&nbsp;<span class="ident" id="2996879">old</span><span class="op" id="2996882">&amp;</span><span class="ident" id="2996883">mutexBit</span>&nbsp;<span class="op" id="2996892">==</span>&nbsp;<span class="num" id="2996895">0</span>&nbsp;<span class="op" id="2996897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2996902">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2996934">new</span>&nbsp;<span class="op" id="2996938">=</span>&nbsp;<span class="op" id="2996940">(</span><span class="ident" id="2996941">old</span>&nbsp;<span class="op" id="2996945">|</span>&nbsp;<span class="ident" id="2996947">mutexBit</span><span class="op" id="2996955">)</span>&nbsp;<span class="op" id="2996957">+</span>&nbsp;<span class="ident" id="2996959">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2996971">if</span>&nbsp;<span class="builtinfunc" id="2996974">new</span><span class="op" id="2996977">&amp;</span><span class="ident" id="2996978">mutexRefMask</span>&nbsp;<span class="op" id="2996991">==</span>&nbsp;<span class="num" id="2996994">0</span>&nbsp;<span class="op" id="2996996">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997002">panic</span><span class="op" id="2997007">(</span><span class="string" id="2997008">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2997035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997044">}</span>&nbsp;<span class="keyword" id="2997046">else</span>&nbsp;<span class="op" id="2997051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997056">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997077">new</span>&nbsp;<span class="op" id="2997081">=</span>&nbsp;<span class="ident" id="2997083">old</span>&nbsp;<span class="op" id="2997087">+</span>&nbsp;<span class="ident" id="2997089">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997102">if</span>&nbsp;<span class="builtinfunc" id="2997105">new</span><span class="op" id="2997108">&amp;</span><span class="ident" id="2997109">mutexMask</span>&nbsp;<span class="op" id="2997119">==</span>&nbsp;<span class="num" id="2997122">0</span>&nbsp;<span class="op" id="2997124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997130">panic</span><span class="op" id="2997135">(</span><span class="string" id="2997136">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2997163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997176">if</span>&nbsp;<span class="ident" id="2997179">atomic</span><span class="op" id="2997185">.</span><span class="ident" id="2997186">CompareAndSwapUint64</span><span class="op" id="2997206">(</span><span class="op" id="2997207">&amp;</span><span class="ident" id="2997208">mu</span><span class="op" id="2997210">.</span><span class="ident" id="2997211">state</span><span class="op" id="2997216">,</span>&nbsp;<span class="ident" id="2997218">old</span><span class="op" id="2997221">,</span>&nbsp;<span class="builtinfunc" id="2997223">new</span><span class="op" id="2997226">)</span>&nbsp;<span class="op" id="2997228">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997233">if</span>&nbsp;<span class="ident" id="2997236">old</span><span class="op" id="2997239">&amp;</span><span class="ident" id="2997240">mutexBit</span>&nbsp;<span class="op" id="2997249">==</span>&nbsp;<span class="num" id="2997252">0</span>&nbsp;<span class="op" id="2997254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997260">return</span>&nbsp;<span class="builtintype" id="2997267">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997280">runtime_Semacquire</span><span class="op" id="2997298">(</span><span class="ident" id="2997299">mutexSema</span><span class="op" id="2997308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997313">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997361">}</span><br>
<span class="lineno"></span><span class="op" id="2997363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2997366">func</span>&nbsp;<span class="op" id="2997371">(</span><span class="ident" id="2997372">mu</span>&nbsp;<span class="op" id="2997375">*</span><span class="ident" id="2997376">fdMutex</span><span class="op" id="2997383">)</span>&nbsp;<span class="ident" id="2997385">RWUnlock</span><span class="op" id="2997393">(</span><span class="ident" id="2997394">read</span>&nbsp;<span class="builtintype" id="2997399">bool</span><span class="op" id="2997403">)</span>&nbsp;<span class="builtintype" id="2997405">bool</span>&nbsp;<span class="op" id="2997410">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997413">var</span>&nbsp;<span class="ident" id="2997417">mutexBit</span><span class="op" id="2997425">,</span>&nbsp;<span class="ident" id="2997427">mutexWait</span><span class="op" id="2997436">,</span>&nbsp;<span class="ident" id="2997438">mutexMask</span>&nbsp;<span class="ident" id="2997448">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997456">var</span>&nbsp;<span class="ident" id="2997460">mutexSema</span>&nbsp;<span class="op" id="2997470">*</span><span class="builtintype" id="2997471">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997479">if</span>&nbsp;<span class="ident" id="2997482">read</span>&nbsp;<span class="op" id="2997487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997491">mutexBit</span>&nbsp;<span class="op" id="2997500">=</span>&nbsp;<span class="ident" id="2997502">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997515">mutexWait</span>&nbsp;<span class="op" id="2997525">=</span>&nbsp;<span class="ident" id="2997527">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997540">mutexMask</span>&nbsp;<span class="op" id="2997550">=</span>&nbsp;<span class="ident" id="2997552">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997565">mutexSema</span>&nbsp;<span class="op" id="2997575">=</span>&nbsp;<span class="op" id="2997577">&amp;</span><span class="ident" id="2997578">mu</span><span class="op" id="2997580">.</span><span class="ident" id="2997581">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997588">}</span>&nbsp;<span class="keyword" id="2997590">else</span>&nbsp;<span class="op" id="2997595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997599">mutexBit</span>&nbsp;<span class="op" id="2997608">=</span>&nbsp;<span class="ident" id="2997610">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997623">mutexWait</span>&nbsp;<span class="op" id="2997633">=</span>&nbsp;<span class="ident" id="2997635">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997648">mutexMask</span>&nbsp;<span class="op" id="2997658">=</span>&nbsp;<span class="ident" id="2997660">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997673">mutexSema</span>&nbsp;<span class="op" id="2997683">=</span>&nbsp;<span class="op" id="2997685">&amp;</span><span class="ident" id="2997686">mu</span><span class="op" id="2997688">.</span><span class="ident" id="2997689">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997699">for</span>&nbsp;<span class="op" id="2997703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2997707">old</span>&nbsp;<span class="op" id="2997711">:=</span>&nbsp;<span class="ident" id="2997714">atomic</span><span class="op" id="2997720">.</span><span class="ident" id="2997721">LoadUint64</span><span class="op" id="2997731">(</span><span class="op" id="2997732">&amp;</span><span class="ident" id="2997733">mu</span><span class="op" id="2997735">.</span><span class="ident" id="2997736">state</span><span class="op" id="2997741">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997745">if</span>&nbsp;<span class="ident" id="2997748">old</span><span class="op" id="2997751">&amp;</span><span class="ident" id="2997752">mutexBit</span>&nbsp;<span class="op" id="2997761">==</span>&nbsp;<span class="num" id="2997764">0</span>&nbsp;<span class="op" id="2997766">||</span>&nbsp;<span class="ident" id="2997769">old</span><span class="op" id="2997772">&amp;</span><span class="ident" id="2997773">mutexRefMask</span>&nbsp;<span class="op" id="2997786">==</span>&nbsp;<span class="num" id="2997789">0</span>&nbsp;<span class="op" id="2997791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997796">panic</span><span class="op" id="2997801">(</span><span class="string" id="2997802">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="2997829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2997837">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997901">new</span>&nbsp;<span class="op" id="2997905">:=</span>&nbsp;<span class="op" id="2997908">(</span><span class="ident" id="2997909">old</span>&nbsp;<span class="op" id="2997913">&amp;^</span>&nbsp;<span class="ident" id="2997916">mutexBit</span><span class="op" id="2997924">)</span>&nbsp;<span class="op" id="2997926">-</span>&nbsp;<span class="ident" id="2997928">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997939">if</span>&nbsp;<span class="ident" id="2997942">old</span><span class="op" id="2997945">&amp;</span><span class="ident" id="2997946">mutexMask</span>&nbsp;<span class="op" id="2997956">!=</span>&nbsp;<span class="num" id="2997959">0</span>&nbsp;<span class="op" id="2997961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2997966">new</span>&nbsp;<span class="op" id="2997970">-=</span>&nbsp;<span class="ident" id="2997973">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2997985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2997989">if</span>&nbsp;<span class="ident" id="2997992">atomic</span><span class="op" id="2997998">.</span><span class="ident" id="2997999">CompareAndSwapUint64</span><span class="op" id="2998019">(</span><span class="op" id="2998020">&amp;</span><span class="ident" id="2998021">mu</span><span class="op" id="2998023">.</span><span class="ident" id="2998024">state</span><span class="op" id="2998029">,</span>&nbsp;<span class="ident" id="2998031">old</span><span class="op" id="2998034">,</span>&nbsp;<span class="builtinfunc" id="2998036">new</span><span class="op" id="2998039">)</span>&nbsp;<span class="op" id="2998041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998046">if</span>&nbsp;<span class="ident" id="2998049">old</span><span class="op" id="2998052">&amp;</span><span class="ident" id="2998053">mutexMask</span>&nbsp;<span class="op" id="2998063">!=</span>&nbsp;<span class="num" id="2998066">0</span>&nbsp;<span class="op" id="2998068">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2998074">runtime_Semrelease</span><span class="op" id="2998092">(</span><span class="ident" id="2998093">mutexSema</span><span class="op" id="2998102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2998112">return</span>&nbsp;<span class="builtinfunc" id="2998119">new</span><span class="op" id="2998122">&amp;</span><span class="op" id="2998123">(</span><span class="ident" id="2998124">mutexClosed</span><span class="op" id="2998135">|</span><span class="ident" id="2998136">mutexRefMask</span><span class="op" id="2998148">)</span>&nbsp;<span class="op" id="2998150">==</span>&nbsp;<span class="ident" id="2998153">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2998170">}</span><br>
<span class="lineno">180</span><span class="op" id="2998172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2998175">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2998210">func</span>&nbsp;<span class="ident" id="2998215">runtime_Semacquire</span><span class="op" id="2998233">(</span><span class="ident" id="2998234">sema</span>&nbsp;<span class="op" id="2998239">*</span><span class="builtintype" id="2998240">uint32</span><span class="op" id="2998246">)</span><br>
<span class="lineno"></span><span class="keyword" id="2998248">func</span>&nbsp;<span class="ident" id="2998253">runtime_Semrelease</span><span class="op" id="2998271">(</span><span class="ident" id="2998272">sema</span>&nbsp;<span class="op" id="2998277">*</span><span class="builtintype" id="2998278">uint32</span><span class="op" id="2998284">)</span>
</div>
</body>
</html>
