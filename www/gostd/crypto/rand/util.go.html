<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html" class="current">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3531320">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3531376">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3531430">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3531481">package</span>&nbsp;<span class="ident" id="3531489">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3531495">import</span>&nbsp;<span class="op" id="3531502">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3531505">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3531515">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3531521">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3531532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531535">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3531610">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3531687">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3531766">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3531845">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3531869">var</span>&nbsp;<span class="ident" id="3531873">smallPrimes</span>&nbsp;<span class="op" id="3531885">=</span>&nbsp;<span class="op" id="3531887">[</span><span class="op" id="3531888">]</span><span class="builtintype" id="3531889">uint8</span><span class="op" id="3531894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="3531897">3</span><span class="op" id="3531898">,</span>&nbsp;<span class="num" id="3531900">5</span><span class="op" id="3531901">,</span>&nbsp;<span class="num" id="3531903">7</span><span class="op" id="3531904">,</span>&nbsp;<span class="num" id="3531906">11</span><span class="op" id="3531908">,</span>&nbsp;<span class="num" id="3531910">13</span><span class="op" id="3531912">,</span>&nbsp;<span class="num" id="3531914">17</span><span class="op" id="3531916">,</span>&nbsp;<span class="num" id="3531918">19</span><span class="op" id="3531920">,</span>&nbsp;<span class="num" id="3531922">23</span><span class="op" id="3531924">,</span>&nbsp;<span class="num" id="3531926">29</span><span class="op" id="3531928">,</span>&nbsp;<span class="num" id="3531930">31</span><span class="op" id="3531932">,</span>&nbsp;<span class="num" id="3531934">37</span><span class="op" id="3531936">,</span>&nbsp;<span class="num" id="3531938">41</span><span class="op" id="3531940">,</span>&nbsp;<span class="num" id="3531942">43</span><span class="op" id="3531944">,</span>&nbsp;<span class="num" id="3531946">47</span><span class="op" id="3531948">,</span>&nbsp;<span class="num" id="3531950">53</span><span class="op" id="3531952">,</span><br>
<span class="lineno">20</span><span class="op" id="3531954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531957">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3532037">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3532115">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3532185">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3532200">var</span>&nbsp;<span class="ident" id="3532204">smallPrimesProduct</span>&nbsp;<span class="op" id="3532223">=</span>&nbsp;<span class="builtinfunc" id="3532225">new</span><span class="op" id="3532228">(</span><span class="ident" id="3532229">big</span><span class="op" id="3532232">.</span><span class="ident" id="3532233">Int</span><span class="op" id="3532236">)</span><span class="op" id="3532237">.</span><span class="ident" id="3532238">SetUint64</span><span class="op" id="3532247">(</span><span class="num" id="3532248">16294579238595022365</span><span class="op" id="3532268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532271">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3532341">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3532367">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3532446">func</span>&nbsp;<span class="ident" id="3532451">Prime</span><span class="op" id="3532456">(</span><span class="ident" id="3532457">rand</span>&nbsp;<span class="ident" id="3532462">io</span><span class="op" id="3532464">.</span><span class="ident" id="3532465">Reader</span><span class="op" id="3532471">,</span>&nbsp;<span class="ident" id="3532473">bits</span>&nbsp;<span class="builtintype" id="3532478">int</span><span class="op" id="3532481">)</span>&nbsp;<span class="op" id="3532483">(</span><span class="ident" id="3532484">p</span>&nbsp;<span class="op" id="3532486">*</span><span class="ident" id="3532487">big</span><span class="op" id="3532490">.</span><span class="ident" id="3532491">Int</span><span class="op" id="3532494">,</span>&nbsp;<span class="ident" id="3532496">err</span>&nbsp;<span class="builtintype" id="3532500">error</span><span class="op" id="3532505">)</span>&nbsp;<span class="op" id="3532507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532510">if</span>&nbsp;<span class="ident" id="3532513">bits</span>&nbsp;<span class="op" id="3532518">&lt;</span>&nbsp;<span class="num" id="3532520">2</span>&nbsp;<span class="op" id="3532522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532526">err</span>&nbsp;<span class="op" id="3532530">=</span>&nbsp;<span class="ident" id="3532532">errors</span><span class="op" id="3532538">.</span><span class="ident" id="3532539">New</span><span class="op" id="3532542">(</span><span class="string" id="3532543">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3532591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532595">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3532603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532607">b</span>&nbsp;<span class="op" id="3532609">:=</span>&nbsp;<span class="builtintype" id="3532612">uint</span><span class="op" id="3532616">(</span><span class="ident" id="3532617">bits</span>&nbsp;<span class="op" id="3532622">%</span>&nbsp;<span class="num" id="3532624">8</span><span class="op" id="3532625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532628">if</span>&nbsp;<span class="ident" id="3532631">b</span>&nbsp;<span class="op" id="3532633">==</span>&nbsp;<span class="num" id="3532636">0</span>&nbsp;<span class="op" id="3532638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532642">b</span>&nbsp;<span class="op" id="3532644">=</span>&nbsp;<span class="num" id="3532646">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3532649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532653">bytes</span>&nbsp;<span class="op" id="3532659">:=</span>&nbsp;<span class="builtinfunc" id="3532662">make</span><span class="op" id="3532666">(</span><span class="op" id="3532667">[</span><span class="op" id="3532668">]</span><span class="builtintype" id="3532669">byte</span><span class="op" id="3532673">,</span>&nbsp;<span class="op" id="3532675">(</span><span class="ident" id="3532676">bits</span><span class="op" id="3532680">+</span><span class="num" id="3532681">7</span><span class="op" id="3532682">)</span><span class="op" id="3532683">/</span><span class="num" id="3532684">8</span><span class="op" id="3532685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532688">p</span>&nbsp;<span class="op" id="3532690">=</span>&nbsp;<span class="builtinfunc" id="3532692">new</span><span class="op" id="3532695">(</span><span class="ident" id="3532696">big</span><span class="op" id="3532699">.</span><span class="ident" id="3532700">Int</span><span class="op" id="3532703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532707">bigMod</span>&nbsp;<span class="op" id="3532714">:=</span>&nbsp;<span class="builtinfunc" id="3532717">new</span><span class="op" id="3532720">(</span><span class="ident" id="3532721">big</span><span class="op" id="3532724">.</span><span class="ident" id="3532725">Int</span><span class="op" id="3532728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532732">for</span>&nbsp;<span class="op" id="3532736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532740">_</span><span class="op" id="3532741">,</span>&nbsp;<span class="ident" id="3532743">err</span>&nbsp;<span class="op" id="3532747">=</span>&nbsp;<span class="ident" id="3532749">io</span><span class="op" id="3532751">.</span><span class="ident" id="3532752">ReadFull</span><span class="op" id="3532760">(</span><span class="ident" id="3532761">rand</span><span class="op" id="3532765">,</span>&nbsp;<span class="ident" id="3532767">bytes</span><span class="op" id="3532772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532776">if</span>&nbsp;<span class="ident" id="3532779">err</span>&nbsp;<span class="op" id="3532783">!=</span>&nbsp;<span class="builtintype" id="3532786">nil</span>&nbsp;<span class="op" id="3532790">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3532795">return</span>&nbsp;<span class="builtintype" id="3532802">nil</span><span class="op" id="3532805">,</span>&nbsp;<span class="ident" id="3532807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3532813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3532818">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3532899">bytes</span><span class="op" id="3532904">[</span><span class="num" id="3532905">0</span><span class="op" id="3532906">]</span>&nbsp;<span class="op" id="3532908">&amp;=</span>&nbsp;<span class="builtintype" id="3532911">uint8</span><span class="op" id="3532916">(</span><span class="builtintype" id="3532917">int</span><span class="op" id="3532920">(</span><span class="num" id="3532921">1</span><span class="op" id="3532922">&lt;&lt;</span><span class="ident" id="3532924">b</span><span class="op" id="3532925">)</span>&nbsp;<span class="op" id="3532927">-</span>&nbsp;<span class="num" id="3532929">1</span><span class="op" id="3532930">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3532934">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533013">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533074">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533140">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533182">if</span>&nbsp;<span class="ident" id="3533185">b</span>&nbsp;<span class="op" id="3533187">&gt;=</span>&nbsp;<span class="num" id="3533190">2</span>&nbsp;<span class="op" id="3533192">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533197">bytes</span><span class="op" id="3533202">[</span><span class="num" id="3533203">0</span><span class="op" id="3533204">]</span>&nbsp;<span class="op" id="3533206">|=</span>&nbsp;<span class="num" id="3533209">3</span>&nbsp;<span class="op" id="3533211">&lt;&lt;</span>&nbsp;<span class="op" id="3533214">(</span><span class="ident" id="3533215">b</span>&nbsp;<span class="op" id="3533217">-</span>&nbsp;<span class="num" id="3533219">2</span><span class="op" id="3533220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533224">}</span>&nbsp;<span class="keyword" id="3533226">else</span>&nbsp;<span class="op" id="3533231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533236">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533279">bytes</span><span class="op" id="3533284">[</span><span class="num" id="3533285">0</span><span class="op" id="3533286">]</span>&nbsp;<span class="op" id="3533288">|=</span>&nbsp;<span class="num" id="3533291">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533296">if</span>&nbsp;<span class="builtinfunc" id="3533299">len</span><span class="op" id="3533302">(</span><span class="ident" id="3533303">bytes</span><span class="op" id="3533308">)</span>&nbsp;<span class="op" id="3533310">&gt;</span>&nbsp;<span class="num" id="3533312">1</span>&nbsp;<span class="op" id="3533314">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533320">bytes</span><span class="op" id="3533325">[</span><span class="num" id="3533326">1</span><span class="op" id="3533327">]</span>&nbsp;<span class="op" id="3533329">|=</span>&nbsp;<span class="num" id="3533332">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3533344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533348">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533427">bytes</span><span class="op" id="3533432">[</span><span class="builtinfunc" id="3533433">len</span><span class="op" id="3533436">(</span><span class="ident" id="3533437">bytes</span><span class="op" id="3533442">)</span><span class="op" id="3533443">-</span><span class="num" id="3533444">1</span><span class="op" id="3533445">]</span>&nbsp;<span class="op" id="3533447">|=</span>&nbsp;<span class="num" id="3533450">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533455">p</span><span class="op" id="3533456">.</span><span class="ident" id="3533457">SetBytes</span><span class="op" id="3533465">(</span><span class="ident" id="3533466">bytes</span><span class="op" id="3533471">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533476">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533542">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533608">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3533674">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533738">bigMod</span><span class="op" id="3533744">.</span><span class="ident" id="3533745">Mod</span><span class="op" id="3533748">(</span><span class="ident" id="3533749">p</span><span class="op" id="3533750">,</span>&nbsp;<span class="ident" id="3533752">smallPrimesProduct</span><span class="op" id="3533770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533774">mod</span>&nbsp;<span class="op" id="3533778">:=</span>&nbsp;<span class="ident" id="3533781">bigMod</span><span class="op" id="3533787">.</span><span class="ident" id="3533788">Uint64</span><span class="op" id="3533794">(</span><span class="op" id="3533795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533799">NextDelta</span><span class="op" id="3533808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533812">for</span>&nbsp;<span class="ident" id="3533816">delta</span>&nbsp;<span class="op" id="3533822">:=</span>&nbsp;<span class="ident" id="3533825">uint64</span><span class="op" id="3533831">(</span><span class="num" id="3533832">0</span><span class="op" id="3533833">)</span><span class="op" id="3533834">;</span>&nbsp;<span class="ident" id="3533836">delta</span>&nbsp;<span class="op" id="3533842">&lt;</span>&nbsp;<span class="num" id="3533844">1</span><span class="op" id="3533845">&lt;&lt;</span><span class="num" id="3533847">20</span><span class="op" id="3533849">;</span>&nbsp;<span class="ident" id="3533851">delta</span>&nbsp;<span class="op" id="3533857">+=</span>&nbsp;<span class="num" id="3533860">2</span>&nbsp;<span class="op" id="3533862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3533867">m</span>&nbsp;<span class="op" id="3533869">:=</span>&nbsp;<span class="ident" id="3533872">mod</span>&nbsp;<span class="op" id="3533876">+</span>&nbsp;<span class="ident" id="3533878">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533887">for</span>&nbsp;<span class="ident" id="3533891">_</span><span class="op" id="3533892">,</span>&nbsp;<span class="ident" id="3533894">prime</span>&nbsp;<span class="op" id="3533900">:=</span>&nbsp;<span class="keyword" id="3533903">range</span>&nbsp;<span class="ident" id="3533909">smallPrimes</span>&nbsp;<span class="op" id="3533921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533927">if</span>&nbsp;<span class="ident" id="3533930">m</span><span class="op" id="3533931">%</span><span class="ident" id="3533932">uint64</span><span class="op" id="3533938">(</span><span class="ident" id="3533939">prime</span><span class="op" id="3533944">)</span>&nbsp;<span class="op" id="3533946">==</span>&nbsp;<span class="num" id="3533949">0</span>&nbsp;<span class="op" id="3533951">&amp;&amp;</span>&nbsp;<span class="op" id="3533954">(</span><span class="ident" id="3533955">bits</span>&nbsp;<span class="op" id="3533960">&gt;</span>&nbsp;<span class="num" id="3533962">6</span>&nbsp;<span class="op" id="3533964">||</span>&nbsp;<span class="ident" id="3533967">m</span>&nbsp;<span class="op" id="3533969">!=</span>&nbsp;<span class="ident" id="3533972">uint64</span><span class="op" id="3533978">(</span><span class="ident" id="3533979">prime</span><span class="op" id="3533984">)</span><span class="op" id="3533985">)</span>&nbsp;<span class="op" id="3533987">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3533994">continue</span>&nbsp;<span class="ident" id="3534003">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534028">if</span>&nbsp;<span class="ident" id="3534031">delta</span>&nbsp;<span class="op" id="3534037">&gt;</span>&nbsp;<span class="num" id="3534039">0</span>&nbsp;<span class="op" id="3534041">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534047">bigMod</span><span class="op" id="3534053">.</span><span class="ident" id="3534054">SetUint64</span><span class="op" id="3534063">(</span><span class="ident" id="3534064">delta</span><span class="op" id="3534069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534075">p</span><span class="op" id="3534076">.</span><span class="ident" id="3534077">Add</span><span class="op" id="3534080">(</span><span class="ident" id="3534081">p</span><span class="op" id="3534082">,</span>&nbsp;<span class="ident" id="3534084">bigMod</span><span class="op" id="3534090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534100">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534108">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534113">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534179">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534240">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534251">if</span>&nbsp;<span class="ident" id="3534254">p</span><span class="op" id="3534255">.</span><span class="ident" id="3534256">ProbablyPrime</span><span class="op" id="3534269">(</span><span class="num" id="3534270">20</span><span class="op" id="3534272">)</span>&nbsp;<span class="op" id="3534274">&amp;&amp;</span>&nbsp;<span class="ident" id="3534277">p</span><span class="op" id="3534278">.</span><span class="ident" id="3534279">BitLen</span><span class="op" id="3534285">(</span><span class="op" id="3534286">)</span>&nbsp;<span class="op" id="3534288">==</span>&nbsp;<span class="ident" id="3534291">bits</span>&nbsp;<span class="op" id="3534296">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534313">}</span><br>
<span class="lineno"></span><span class="op" id="3534315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3534318">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3534392">func</span>&nbsp;<span class="ident" id="3534397">Int</span><span class="op" id="3534400">(</span><span class="ident" id="3534401">rand</span>&nbsp;<span class="ident" id="3534406">io</span><span class="op" id="3534408">.</span><span class="ident" id="3534409">Reader</span><span class="op" id="3534415">,</span>&nbsp;<span class="ident" id="3534417">max</span>&nbsp;<span class="op" id="3534421">*</span><span class="ident" id="3534422">big</span><span class="op" id="3534425">.</span><span class="ident" id="3534426">Int</span><span class="op" id="3534429">)</span>&nbsp;<span class="op" id="3534431">(</span><span class="ident" id="3534432">n</span>&nbsp;<span class="op" id="3534434">*</span><span class="ident" id="3534435">big</span><span class="op" id="3534438">.</span><span class="ident" id="3534439">Int</span><span class="op" id="3534442">,</span>&nbsp;<span class="ident" id="3534444">err</span>&nbsp;<span class="builtintype" id="3534448">error</span><span class="op" id="3534453">)</span>&nbsp;<span class="op" id="3534455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534458">if</span>&nbsp;<span class="ident" id="3534461">max</span><span class="op" id="3534464">.</span><span class="ident" id="3534465">Sign</span><span class="op" id="3534469">(</span><span class="op" id="3534470">)</span>&nbsp;<span class="op" id="3534472">&lt;=</span>&nbsp;<span class="num" id="3534475">0</span>&nbsp;<span class="op" id="3534477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3534481">panic</span><span class="op" id="3534486">(</span><span class="string" id="3534487">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3534525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534528">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534531">k</span>&nbsp;<span class="op" id="3534533">:=</span>&nbsp;<span class="op" id="3534536">(</span><span class="ident" id="3534537">max</span><span class="op" id="3534540">.</span><span class="ident" id="3534541">BitLen</span><span class="op" id="3534547">(</span><span class="op" id="3534548">)</span>&nbsp;<span class="op" id="3534550">+</span>&nbsp;<span class="num" id="3534552">7</span><span class="op" id="3534553">)</span>&nbsp;<span class="op" id="3534555">/</span>&nbsp;<span class="num" id="3534557">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534561">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534626">b</span>&nbsp;<span class="op" id="3534628">:=</span>&nbsp;<span class="builtintype" id="3534631">uint</span><span class="op" id="3534635">(</span><span class="ident" id="3534636">max</span><span class="op" id="3534639">.</span><span class="ident" id="3534640">BitLen</span><span class="op" id="3534646">(</span><span class="op" id="3534647">)</span>&nbsp;<span class="op" id="3534649">%</span>&nbsp;<span class="num" id="3534651">8</span><span class="op" id="3534652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534655">if</span>&nbsp;<span class="ident" id="3534658">b</span>&nbsp;<span class="op" id="3534660">==</span>&nbsp;<span class="num" id="3534663">0</span>&nbsp;<span class="op" id="3534665">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534669">b</span>&nbsp;<span class="op" id="3534671">=</span>&nbsp;<span class="num" id="3534673">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534680">bytes</span>&nbsp;<span class="op" id="3534686">:=</span>&nbsp;<span class="builtinfunc" id="3534689">make</span><span class="op" id="3534693">(</span><span class="op" id="3534694">[</span><span class="op" id="3534695">]</span><span class="builtintype" id="3534696">byte</span><span class="op" id="3534700">,</span>&nbsp;<span class="ident" id="3534702">k</span><span class="op" id="3534703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534706">n</span>&nbsp;<span class="op" id="3534708">=</span>&nbsp;<span class="builtinfunc" id="3534710">new</span><span class="op" id="3534713">(</span><span class="ident" id="3534714">big</span><span class="op" id="3534717">.</span><span class="ident" id="3534718">Int</span><span class="op" id="3534721">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534725">for</span>&nbsp;<span class="op" id="3534729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534733">_</span><span class="op" id="3534734">,</span>&nbsp;<span class="ident" id="3534736">err</span>&nbsp;<span class="op" id="3534740">=</span>&nbsp;<span class="ident" id="3534742">io</span><span class="op" id="3534744">.</span><span class="ident" id="3534745">ReadFull</span><span class="op" id="3534753">(</span><span class="ident" id="3534754">rand</span><span class="op" id="3534758">,</span>&nbsp;<span class="ident" id="3534760">bytes</span><span class="op" id="3534765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534769">if</span>&nbsp;<span class="ident" id="3534772">err</span>&nbsp;<span class="op" id="3534776">!=</span>&nbsp;<span class="builtintype" id="3534779">nil</span>&nbsp;<span class="op" id="3534783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534788">return</span>&nbsp;<span class="builtintype" id="3534795">nil</span><span class="op" id="3534798">,</span>&nbsp;<span class="ident" id="3534800">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534811">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3534873">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534907">bytes</span><span class="op" id="3534912">[</span><span class="num" id="3534913">0</span><span class="op" id="3534914">]</span>&nbsp;<span class="op" id="3534916">&amp;=</span>&nbsp;<span class="builtintype" id="3534919">uint8</span><span class="op" id="3534924">(</span><span class="builtintype" id="3534925">int</span><span class="op" id="3534928">(</span><span class="num" id="3534929">1</span><span class="op" id="3534930">&lt;&lt;</span><span class="ident" id="3534932">b</span><span class="op" id="3534933">)</span>&nbsp;<span class="op" id="3534935">-</span>&nbsp;<span class="num" id="3534937">1</span><span class="op" id="3534938">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3534943">n</span><span class="op" id="3534944">.</span><span class="ident" id="3534945">SetBytes</span><span class="op" id="3534953">(</span><span class="ident" id="3534954">bytes</span><span class="op" id="3534959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534963">if</span>&nbsp;<span class="ident" id="3534966">n</span><span class="op" id="3534967">.</span><span class="ident" id="3534968">Cmp</span><span class="op" id="3534971">(</span><span class="ident" id="3534972">max</span><span class="op" id="3534975">)</span>&nbsp;<span class="op" id="3534977">&lt;</span>&nbsp;<span class="num" id="3534979">0</span>&nbsp;<span class="op" id="3534981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3534986">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534995">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3534998">}</span><br>
<span class="lineno"></span><span class="op" id="3535000">}</span>
</div>
</body>
</html>
