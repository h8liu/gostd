<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html" class="current">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1490221">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1490276">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1490330">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1490381">package</span>&nbsp;<span class="ident" id="1490389">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1490395">import</span>&nbsp;<span class="op" id="1490402">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490405">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490414">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490423">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490433">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490440">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490446">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490459">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490480">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490497">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490505">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490516">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1490527">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="1490534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1490537">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="1490607">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="1490643">var</span>&nbsp;<span class="ident" id="1490647">ErrLineTooLong</span>&nbsp;<span class="op" id="1490662">=</span>&nbsp;<span class="ident" id="1490664">internal</span><span class="op" id="1490672">.</span><span class="ident" id="1490673">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1490689">type</span>&nbsp;<span class="ident" id="1490694">errorReader</span>&nbsp;<span class="keyword" id="1490706">struct</span>&nbsp;<span class="op" id="1490713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490716">err</span>&nbsp;<span class="builtintype" id="1490720">error</span><br>
<span class="lineno"></span><span class="op" id="1490726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="1490729">func</span>&nbsp;<span class="op" id="1490734">(</span><span class="ident" id="1490735">r</span>&nbsp;<span class="op" id="1490737">*</span><span class="ident" id="1490738">errorReader</span><span class="op" id="1490749">)</span>&nbsp;<span class="ident" id="1490751">Read</span><span class="op" id="1490755">(</span><span class="ident" id="1490756">p</span>&nbsp;<span class="op" id="1490758">[</span><span class="op" id="1490759">]</span><span class="builtintype" id="1490760">byte</span><span class="op" id="1490764">)</span>&nbsp;<span class="op" id="1490766">(</span><span class="ident" id="1490767">n</span>&nbsp;<span class="builtintype" id="1490769">int</span><span class="op" id="1490772">,</span>&nbsp;<span class="ident" id="1490774">err</span>&nbsp;<span class="builtintype" id="1490778">error</span><span class="op" id="1490783">)</span>&nbsp;<span class="op" id="1490785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490788">return</span>&nbsp;<span class="num" id="1490795">0</span><span class="op" id="1490796">,</span>&nbsp;<span class="ident" id="1490798">r</span><span class="op" id="1490799">.</span><span class="ident" id="1490800">err</span><br>
<span class="lineno"></span><span class="op" id="1490804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1490807">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="1490885">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1490961">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="1491028">type</span>&nbsp;<span class="ident" id="1491033">transferWriter</span>&nbsp;<span class="keyword" id="1491048">struct</span>&nbsp;<span class="op" id="1491055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491058">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1491075">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491083">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491100">io</span><span class="op" id="1491102">.</span><span class="ident" id="1491103">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491111">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491128">io</span><span class="op" id="1491130">.</span><span class="ident" id="1491131">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491139">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1491156">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491162">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491179">int64</span>&nbsp;<span class="comment" id="1491185">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491228">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1491245">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491251">TransferEncoding</span>&nbsp;<span class="op" id="1491268">[</span><span class="op" id="1491269">]</span><span class="builtintype" id="1491270">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491278">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1491295">Header</span><br>
<span class="lineno"></span><span class="op" id="1491302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1491305">func</span>&nbsp;<span class="ident" id="1491310">newTransferWriter</span><span class="op" id="1491327">(</span><span class="ident" id="1491328">r</span>&nbsp;<span class="keyword" id="1491330">interface</span><span class="op" id="1491339">{</span><span class="op" id="1491340">}</span><span class="op" id="1491341">)</span>&nbsp;<span class="op" id="1491343">(</span><span class="ident" id="1491344">t</span>&nbsp;<span class="op" id="1491346">*</span><span class="ident" id="1491347">transferWriter</span><span class="op" id="1491361">,</span>&nbsp;<span class="ident" id="1491363">err</span>&nbsp;<span class="builtintype" id="1491367">error</span><span class="op" id="1491372">)</span>&nbsp;<span class="op" id="1491374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491377">t</span>&nbsp;<span class="op" id="1491379">=</span>&nbsp;<span class="op" id="1491381">&amp;</span><span class="ident" id="1491382">transferWriter</span><span class="op" id="1491396">{</span><span class="op" id="1491397">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491401">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491429">atLeastHTTP11</span>&nbsp;<span class="op" id="1491443">:=</span>&nbsp;<span class="builtintype" id="1491446">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491453">switch</span>&nbsp;<span class="ident" id="1491460">rr</span>&nbsp;<span class="op" id="1491463">:=</span>&nbsp;<span class="ident" id="1491466">r</span><span class="op" id="1491467">.</span><span class="op" id="1491468">(</span><span class="keyword" id="1491469">type</span><span class="op" id="1491473">)</span>&nbsp;<span class="op" id="1491475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491478">case</span>&nbsp;<span class="op" id="1491483">*</span><span class="ident" id="1491484">Request</span><span class="op" id="1491491">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491495">if</span>&nbsp;<span class="ident" id="1491498">rr</span><span class="op" id="1491500">.</span><span class="ident" id="1491501">ContentLength</span>&nbsp;<span class="op" id="1491515">!=</span>&nbsp;<span class="num" id="1491518">0</span>&nbsp;<span class="op" id="1491520">&amp;&amp;</span>&nbsp;<span class="ident" id="1491523">rr</span><span class="op" id="1491525">.</span><span class="ident" id="1491526">Body</span>&nbsp;<span class="op" id="1491531">==</span>&nbsp;<span class="ident" id="1491534">nil</span>&nbsp;<span class="op" id="1491538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491543">return</span>&nbsp;<span class="ident" id="1491550">nil</span><span class="op" id="1491553">,</span>&nbsp;<span class="ident" id="1491555">fmt</span><span class="op" id="1491558">.</span><span class="ident" id="1491559">Errorf</span><span class="op" id="1491565">(</span><span class="string" id="1491566">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="1491612">,</span>&nbsp;<span class="ident" id="1491614">rr</span><span class="op" id="1491616">.</span><span class="ident" id="1491617">ContentLength</span><span class="op" id="1491630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491638">t</span><span class="op" id="1491639">.</span><span class="ident" id="1491640">Method</span>&nbsp;<span class="op" id="1491647">=</span>&nbsp;<span class="ident" id="1491649">rr</span><span class="op" id="1491651">.</span><span class="ident" id="1491652">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491661">t</span><span class="op" id="1491662">.</span><span class="ident" id="1491663">Body</span>&nbsp;<span class="op" id="1491668">=</span>&nbsp;<span class="ident" id="1491670">rr</span><span class="op" id="1491672">.</span><span class="ident" id="1491673">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491680">t</span><span class="op" id="1491681">.</span><span class="ident" id="1491682">BodyCloser</span>&nbsp;<span class="op" id="1491693">=</span>&nbsp;<span class="ident" id="1491695">rr</span><span class="op" id="1491697">.</span><span class="ident" id="1491698">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491705">t</span><span class="op" id="1491706">.</span><span class="ident" id="1491707">ContentLength</span>&nbsp;<span class="op" id="1491721">=</span>&nbsp;<span class="ident" id="1491723">rr</span><span class="op" id="1491725">.</span><span class="ident" id="1491726">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491742">t</span><span class="op" id="1491743">.</span><span class="ident" id="1491744">Close</span>&nbsp;<span class="op" id="1491750">=</span>&nbsp;<span class="ident" id="1491752">rr</span><span class="op" id="1491754">.</span><span class="ident" id="1491755">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491763">t</span><span class="op" id="1491764">.</span><span class="ident" id="1491765">TransferEncoding</span>&nbsp;<span class="op" id="1491782">=</span>&nbsp;<span class="ident" id="1491784">rr</span><span class="op" id="1491786">.</span><span class="ident" id="1491787">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491806">t</span><span class="op" id="1491807">.</span><span class="ident" id="1491808">Trailer</span>&nbsp;<span class="op" id="1491816">=</span>&nbsp;<span class="ident" id="1491818">rr</span><span class="op" id="1491820">.</span><span class="ident" id="1491821">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491831">atLeastHTTP11</span>&nbsp;<span class="op" id="1491845">=</span>&nbsp;<span class="ident" id="1491847">rr</span><span class="op" id="1491849">.</span><span class="ident" id="1491850">ProtoAtLeast</span><span class="op" id="1491862">(</span><span class="num" id="1491863">1</span><span class="op" id="1491864">,</span>&nbsp;<span class="num" id="1491866">1</span><span class="op" id="1491867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491871">if</span>&nbsp;<span class="ident" id="1491874">t</span><span class="op" id="1491875">.</span><span class="ident" id="1491876">Body</span>&nbsp;<span class="op" id="1491881">!=</span>&nbsp;<span class="ident" id="1491884">nil</span>&nbsp;<span class="op" id="1491888">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="1491891">len</span><span class="op" id="1491894">(</span><span class="ident" id="1491895">t</span><span class="op" id="1491896">.</span><span class="ident" id="1491897">TransferEncoding</span><span class="op" id="1491913">)</span>&nbsp;<span class="op" id="1491915">==</span>&nbsp;<span class="num" id="1491918">0</span>&nbsp;<span class="op" id="1491920">&amp;&amp;</span>&nbsp;<span class="ident" id="1491923">atLeastHTTP11</span>&nbsp;<span class="op" id="1491937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491942">if</span>&nbsp;<span class="ident" id="1491945">t</span><span class="op" id="1491946">.</span><span class="ident" id="1491947">ContentLength</span>&nbsp;<span class="op" id="1491961">==</span>&nbsp;<span class="num" id="1491964">0</span>&nbsp;<span class="op" id="1491966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491972">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492028">var</span>&nbsp;<span class="ident" id="1492032">buf</span>&nbsp;<span class="op" id="1492036">[</span><span class="num" id="1492037">1</span><span class="op" id="1492038">]</span><span class="builtintype" id="1492039">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492048">n</span><span class="op" id="1492049">,</span>&nbsp;<span class="ident" id="1492051">rerr</span>&nbsp;<span class="op" id="1492056">:=</span>&nbsp;<span class="ident" id="1492059">io</span><span class="op" id="1492061">.</span><span class="ident" id="1492062">ReadFull</span><span class="op" id="1492070">(</span><span class="ident" id="1492071">t</span><span class="op" id="1492072">.</span><span class="ident" id="1492073">Body</span><span class="op" id="1492077">,</span>&nbsp;<span class="ident" id="1492079">buf</span><span class="op" id="1492082">[</span><span class="op" id="1492083">:</span><span class="op" id="1492084">]</span><span class="op" id="1492085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492091">if</span>&nbsp;<span class="ident" id="1492094">rerr</span>&nbsp;<span class="op" id="1492099">!=</span>&nbsp;<span class="ident" id="1492102">nil</span>&nbsp;<span class="op" id="1492106">&amp;&amp;</span>&nbsp;<span class="ident" id="1492109">rerr</span>&nbsp;<span class="op" id="1492114">!=</span>&nbsp;<span class="ident" id="1492117">io</span><span class="op" id="1492119">.</span><span class="ident" id="1492120">EOF</span>&nbsp;<span class="op" id="1492124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492131">t</span><span class="op" id="1492132">.</span><span class="ident" id="1492133">ContentLength</span>&nbsp;<span class="op" id="1492147">=</span>&nbsp;<span class="op" id="1492149">-</span><span class="num" id="1492150">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492157">t</span><span class="op" id="1492158">.</span><span class="ident" id="1492159">Body</span>&nbsp;<span class="op" id="1492164">=</span>&nbsp;<span class="op" id="1492166">&amp;</span><span class="ident" id="1492167">errorReader</span><span class="op" id="1492178">{</span><span class="ident" id="1492179">rerr</span><span class="op" id="1492183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492189">}</span>&nbsp;<span class="keyword" id="1492191">else</span>&nbsp;<span class="keyword" id="1492196">if</span>&nbsp;<span class="ident" id="1492199">n</span>&nbsp;<span class="op" id="1492201">==</span>&nbsp;<span class="num" id="1492204">1</span>&nbsp;<span class="op" id="1492206">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492213">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492276">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492325">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492386">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492409">t</span><span class="op" id="1492410">.</span><span class="ident" id="1492411">ContentLength</span>&nbsp;<span class="op" id="1492425">=</span>&nbsp;<span class="op" id="1492427">-</span><span class="num" id="1492428">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492435">t</span><span class="op" id="1492436">.</span><span class="ident" id="1492437">Body</span>&nbsp;<span class="op" id="1492442">=</span>&nbsp;<span class="ident" id="1492444">io</span><span class="op" id="1492446">.</span><span class="ident" id="1492447">MultiReader</span><span class="op" id="1492458">(</span><span class="ident" id="1492459">bytes</span><span class="op" id="1492464">.</span><span class="ident" id="1492465">NewReader</span><span class="op" id="1492474">(</span><span class="ident" id="1492475">buf</span><span class="op" id="1492478">[</span><span class="op" id="1492479">:</span><span class="op" id="1492480">]</span><span class="op" id="1492481">)</span><span class="op" id="1492482">,</span>&nbsp;<span class="ident" id="1492484">t</span><span class="op" id="1492485">.</span><span class="ident" id="1492486">Body</span><span class="op" id="1492490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492496">}</span>&nbsp;<span class="keyword" id="1492498">else</span>&nbsp;<span class="op" id="1492503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492510">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492542">t</span><span class="op" id="1492543">.</span><span class="ident" id="1492544">Body</span>&nbsp;<span class="op" id="1492549">=</span>&nbsp;<span class="ident" id="1492551">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492560">t</span><span class="op" id="1492561">.</span><span class="ident" id="1492562">BodyCloser</span>&nbsp;<span class="op" id="1492573">=</span>&nbsp;<span class="ident" id="1492575">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492593">if</span>&nbsp;<span class="ident" id="1492596">t</span><span class="op" id="1492597">.</span><span class="ident" id="1492598">ContentLength</span>&nbsp;<span class="op" id="1492612">&lt;</span>&nbsp;<span class="num" id="1492614">0</span>&nbsp;<span class="op" id="1492616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492622">t</span><span class="op" id="1492623">.</span><span class="ident" id="1492624">TransferEncoding</span>&nbsp;<span class="op" id="1492641">=</span>&nbsp;<span class="op" id="1492643">[</span><span class="op" id="1492644">]</span><span class="builtintype" id="1492645">string</span><span class="op" id="1492651">{</span><span class="string" id="1492652">&#34;chunked&#34;</span><span class="op" id="1492661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492666">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492673">case</span>&nbsp;<span class="op" id="1492678">*</span><span class="ident" id="1492679">Response</span><span class="op" id="1492687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492691">if</span>&nbsp;<span class="ident" id="1492694">rr</span><span class="op" id="1492696">.</span><span class="ident" id="1492697">Request</span>&nbsp;<span class="op" id="1492705">!=</span>&nbsp;<span class="ident" id="1492708">nil</span>&nbsp;<span class="op" id="1492712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492717">t</span><span class="op" id="1492718">.</span><span class="ident" id="1492719">Method</span>&nbsp;<span class="op" id="1492726">=</span>&nbsp;<span class="ident" id="1492728">rr</span><span class="op" id="1492730">.</span><span class="ident" id="1492731">Request</span><span class="op" id="1492738">.</span><span class="ident" id="1492739">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492748">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492752">t</span><span class="op" id="1492753">.</span><span class="ident" id="1492754">Body</span>&nbsp;<span class="op" id="1492759">=</span>&nbsp;<span class="ident" id="1492761">rr</span><span class="op" id="1492763">.</span><span class="ident" id="1492764">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492771">t</span><span class="op" id="1492772">.</span><span class="ident" id="1492773">BodyCloser</span>&nbsp;<span class="op" id="1492784">=</span>&nbsp;<span class="ident" id="1492786">rr</span><span class="op" id="1492788">.</span><span class="ident" id="1492789">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492796">t</span><span class="op" id="1492797">.</span><span class="ident" id="1492798">ContentLength</span>&nbsp;<span class="op" id="1492812">=</span>&nbsp;<span class="ident" id="1492814">rr</span><span class="op" id="1492816">.</span><span class="ident" id="1492817">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492833">t</span><span class="op" id="1492834">.</span><span class="ident" id="1492835">Close</span>&nbsp;<span class="op" id="1492841">=</span>&nbsp;<span class="ident" id="1492843">rr</span><span class="op" id="1492845">.</span><span class="ident" id="1492846">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492854">t</span><span class="op" id="1492855">.</span><span class="ident" id="1492856">TransferEncoding</span>&nbsp;<span class="op" id="1492873">=</span>&nbsp;<span class="ident" id="1492875">rr</span><span class="op" id="1492877">.</span><span class="ident" id="1492878">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492897">t</span><span class="op" id="1492898">.</span><span class="ident" id="1492899">Trailer</span>&nbsp;<span class="op" id="1492907">=</span>&nbsp;<span class="ident" id="1492909">rr</span><span class="op" id="1492911">.</span><span class="ident" id="1492912">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492922">atLeastHTTP11</span>&nbsp;<span class="op" id="1492936">=</span>&nbsp;<span class="ident" id="1492938">rr</span><span class="op" id="1492940">.</span><span class="ident" id="1492941">ProtoAtLeast</span><span class="op" id="1492953">(</span><span class="num" id="1492954">1</span><span class="op" id="1492955">,</span>&nbsp;<span class="num" id="1492957">1</span><span class="op" id="1492958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492962">t</span><span class="op" id="1492963">.</span><span class="ident" id="1492964">ResponseToHEAD</span>&nbsp;<span class="op" id="1492979">=</span>&nbsp;<span class="ident" id="1492981">noBodyExpected</span><span class="op" id="1492995">(</span><span class="ident" id="1492996">t</span><span class="op" id="1492997">.</span><span class="ident" id="1492998">Method</span><span class="op" id="1493004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493011">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493060">if</span>&nbsp;<span class="ident" id="1493063">t</span><span class="op" id="1493064">.</span><span class="ident" id="1493065">ResponseToHEAD</span>&nbsp;<span class="op" id="1493080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493084">t</span><span class="op" id="1493085">.</span><span class="ident" id="1493086">Body</span>&nbsp;<span class="op" id="1493091">=</span>&nbsp;<span class="ident" id="1493093">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493099">if</span>&nbsp;<span class="ident" id="1493102">chunked</span><span class="op" id="1493109">(</span><span class="ident" id="1493110">t</span><span class="op" id="1493111">.</span><span class="ident" id="1493112">TransferEncoding</span><span class="op" id="1493128">)</span>&nbsp;<span class="op" id="1493130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493135">t</span><span class="op" id="1493136">.</span><span class="ident" id="1493137">ContentLength</span>&nbsp;<span class="op" id="1493151">=</span>&nbsp;<span class="op" id="1493153">-</span><span class="num" id="1493154">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493161">}</span>&nbsp;<span class="keyword" id="1493163">else</span>&nbsp;<span class="op" id="1493168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493172">if</span>&nbsp;<span class="op" id="1493175">!</span><span class="ident" id="1493176">atLeastHTTP11</span>&nbsp;<span class="op" id="1493190">||</span>&nbsp;<span class="ident" id="1493193">t</span><span class="op" id="1493194">.</span><span class="ident" id="1493195">Body</span>&nbsp;<span class="op" id="1493200">==</span>&nbsp;<span class="ident" id="1493203">nil</span>&nbsp;<span class="op" id="1493207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493212">t</span><span class="op" id="1493213">.</span><span class="ident" id="1493214">TransferEncoding</span>&nbsp;<span class="op" id="1493231">=</span>&nbsp;<span class="ident" id="1493233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493239">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493243">if</span>&nbsp;<span class="ident" id="1493246">chunked</span><span class="op" id="1493253">(</span><span class="ident" id="1493254">t</span><span class="op" id="1493255">.</span><span class="ident" id="1493256">TransferEncoding</span><span class="op" id="1493272">)</span>&nbsp;<span class="op" id="1493274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493279">t</span><span class="op" id="1493280">.</span><span class="ident" id="1493281">ContentLength</span>&nbsp;<span class="op" id="1493295">=</span>&nbsp;<span class="op" id="1493297">-</span><span class="num" id="1493298">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493302">}</span>&nbsp;<span class="keyword" id="1493304">else</span>&nbsp;<span class="keyword" id="1493309">if</span>&nbsp;<span class="ident" id="1493312">t</span><span class="op" id="1493313">.</span><span class="ident" id="1493314">Body</span>&nbsp;<span class="op" id="1493319">==</span>&nbsp;<span class="ident" id="1493322">nil</span>&nbsp;<span class="op" id="1493326">{</span>&nbsp;<span class="comment" id="1493328">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493355">t</span><span class="op" id="1493356">.</span><span class="ident" id="1493357">ContentLength</span>&nbsp;<span class="op" id="1493371">=</span>&nbsp;<span class="num" id="1493373">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493377">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493384">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493405">if</span>&nbsp;<span class="op" id="1493408">!</span><span class="ident" id="1493409">chunked</span><span class="op" id="1493416">(</span><span class="ident" id="1493417">t</span><span class="op" id="1493418">.</span><span class="ident" id="1493419">TransferEncoding</span><span class="op" id="1493435">)</span>&nbsp;<span class="op" id="1493437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493441">t</span><span class="op" id="1493442">.</span><span class="ident" id="1493443">Trailer</span>&nbsp;<span class="op" id="1493451">=</span>&nbsp;<span class="ident" id="1493453">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493462">return</span>&nbsp;<span class="ident" id="1493469">t</span><span class="op" id="1493470">,</span>&nbsp;<span class="ident" id="1493472">nil</span><br>
<span class="lineno"></span><span class="op" id="1493476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="1493479">func</span>&nbsp;<span class="ident" id="1493484">noBodyExpected</span><span class="op" id="1493498">(</span><span class="ident" id="1493499">requestMethod</span>&nbsp;<span class="builtintype" id="1493513">string</span><span class="op" id="1493519">)</span>&nbsp;<span class="builtintype" id="1493521">bool</span>&nbsp;<span class="op" id="1493526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493529">return</span>&nbsp;<span class="ident" id="1493536">requestMethod</span>&nbsp;<span class="op" id="1493550">==</span>&nbsp;<span class="string" id="1493553">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="1493560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1493563">func</span>&nbsp;<span class="op" id="1493568">(</span><span class="ident" id="1493569">t</span>&nbsp;<span class="op" id="1493571">*</span><span class="ident" id="1493572">transferWriter</span><span class="op" id="1493586">)</span>&nbsp;<span class="ident" id="1493588">shouldSendContentLength</span><span class="op" id="1493611">(</span><span class="op" id="1493612">)</span>&nbsp;<span class="builtintype" id="1493614">bool</span>&nbsp;<span class="op" id="1493619">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493622">if</span>&nbsp;<span class="ident" id="1493625">chunked</span><span class="op" id="1493632">(</span><span class="ident" id="1493633">t</span><span class="op" id="1493634">.</span><span class="ident" id="1493635">TransferEncoding</span><span class="op" id="1493651">)</span>&nbsp;<span class="op" id="1493653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493657">return</span>&nbsp;<span class="builtintype" id="1493664">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493674">if</span>&nbsp;<span class="ident" id="1493677">t</span><span class="op" id="1493678">.</span><span class="ident" id="1493679">ContentLength</span>&nbsp;<span class="op" id="1493693">&gt;</span>&nbsp;<span class="num" id="1493695">0</span>&nbsp;<span class="op" id="1493697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493701">return</span>&nbsp;<span class="builtintype" id="1493708">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493717">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493776">if</span>&nbsp;<span class="ident" id="1493779">t</span><span class="op" id="1493780">.</span><span class="ident" id="1493781">Method</span>&nbsp;<span class="op" id="1493788">==</span>&nbsp;<span class="string" id="1493791">&#34;POST&#34;</span>&nbsp;<span class="op" id="1493798">||</span>&nbsp;<span class="ident" id="1493801">t</span><span class="op" id="1493802">.</span><span class="ident" id="1493803">Method</span>&nbsp;<span class="op" id="1493810">==</span>&nbsp;<span class="string" id="1493813">&#34;PUT&#34;</span>&nbsp;<span class="op" id="1493819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493823">return</span>&nbsp;<span class="builtintype" id="1493830">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493836">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493839">if</span>&nbsp;<span class="ident" id="1493842">t</span><span class="op" id="1493843">.</span><span class="ident" id="1493844">ContentLength</span>&nbsp;<span class="op" id="1493858">==</span>&nbsp;<span class="num" id="1493861">0</span>&nbsp;<span class="op" id="1493863">&amp;&amp;</span>&nbsp;<span class="ident" id="1493866">isIdentity</span><span class="op" id="1493876">(</span><span class="ident" id="1493877">t</span><span class="op" id="1493878">.</span><span class="ident" id="1493879">TransferEncoding</span><span class="op" id="1493895">)</span>&nbsp;<span class="op" id="1493897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493901">return</span>&nbsp;<span class="builtintype" id="1493908">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493918">return</span>&nbsp;<span class="builtintype" id="1493925">false</span><br>
<span class="lineno">150</span><span class="op" id="1493931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1493934">func</span>&nbsp;<span class="op" id="1493939">(</span><span class="ident" id="1493940">t</span>&nbsp;<span class="op" id="1493942">*</span><span class="ident" id="1493943">transferWriter</span><span class="op" id="1493957">)</span>&nbsp;<span class="ident" id="1493959">WriteHeader</span><span class="op" id="1493970">(</span><span class="ident" id="1493971">w</span>&nbsp;<span class="ident" id="1493973">io</span><span class="op" id="1493975">.</span><span class="ident" id="1493976">Writer</span><span class="op" id="1493982">)</span>&nbsp;<span class="builtintype" id="1493984">error</span>&nbsp;<span class="op" id="1493990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493993">if</span>&nbsp;<span class="ident" id="1493996">t</span><span class="op" id="1493997">.</span><span class="ident" id="1493998">Close</span>&nbsp;<span class="op" id="1494004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494008">if</span>&nbsp;<span class="ident" id="1494011">_</span><span class="op" id="1494012">,</span>&nbsp;<span class="ident" id="1494014">err</span>&nbsp;<span class="op" id="1494018">:=</span>&nbsp;<span class="ident" id="1494021">io</span><span class="op" id="1494023">.</span><span class="ident" id="1494024">WriteString</span><span class="op" id="1494035">(</span><span class="ident" id="1494036">w</span><span class="op" id="1494037">,</span>&nbsp;<span class="string" id="1494039">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="1494062">)</span><span class="op" id="1494063">;</span>&nbsp;<span class="ident" id="1494065">err</span>&nbsp;<span class="op" id="1494069">!=</span>&nbsp;<span class="ident" id="1494072">nil</span>&nbsp;<span class="op" id="1494076">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494081">return</span>&nbsp;<span class="ident" id="1494088">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494101">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494170">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494235">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494257">if</span>&nbsp;<span class="ident" id="1494260">t</span><span class="op" id="1494261">.</span><span class="ident" id="1494262">shouldSendContentLength</span><span class="op" id="1494285">(</span><span class="op" id="1494286">)</span>&nbsp;<span class="op" id="1494288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494292">if</span>&nbsp;<span class="ident" id="1494295">_</span><span class="op" id="1494296">,</span>&nbsp;<span class="ident" id="1494298">err</span>&nbsp;<span class="op" id="1494302">:=</span>&nbsp;<span class="ident" id="1494305">io</span><span class="op" id="1494307">.</span><span class="ident" id="1494308">WriteString</span><span class="op" id="1494319">(</span><span class="ident" id="1494320">w</span><span class="op" id="1494321">,</span>&nbsp;<span class="string" id="1494323">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="1494341">)</span><span class="op" id="1494342">;</span>&nbsp;<span class="ident" id="1494344">err</span>&nbsp;<span class="op" id="1494348">!=</span>&nbsp;<span class="ident" id="1494351">nil</span>&nbsp;<span class="op" id="1494355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494360">return</span>&nbsp;<span class="ident" id="1494367">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494377">if</span>&nbsp;<span class="ident" id="1494380">_</span><span class="op" id="1494381">,</span>&nbsp;<span class="ident" id="1494383">err</span>&nbsp;<span class="op" id="1494387">:=</span>&nbsp;<span class="ident" id="1494390">io</span><span class="op" id="1494392">.</span><span class="ident" id="1494393">WriteString</span><span class="op" id="1494404">(</span><span class="ident" id="1494405">w</span><span class="op" id="1494406">,</span>&nbsp;<span class="ident" id="1494408">strconv</span><span class="op" id="1494415">.</span><span class="ident" id="1494416">FormatInt</span><span class="op" id="1494425">(</span><span class="ident" id="1494426">t</span><span class="op" id="1494427">.</span><span class="ident" id="1494428">ContentLength</span><span class="op" id="1494441">,</span>&nbsp;<span class="num" id="1494443">10</span><span class="op" id="1494445">)</span><span class="op" id="1494446">+</span><span class="string" id="1494447">&#34;\r\n&#34;</span><span class="op" id="1494453">)</span><span class="op" id="1494454">;</span>&nbsp;<span class="ident" id="1494456">err</span>&nbsp;<span class="op" id="1494460">!=</span>&nbsp;<span class="ident" id="1494463">nil</span>&nbsp;<span class="op" id="1494467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494472">return</span>&nbsp;<span class="ident" id="1494479">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494488">}</span>&nbsp;<span class="keyword" id="1494490">else</span>&nbsp;<span class="keyword" id="1494495">if</span>&nbsp;<span class="ident" id="1494498">chunked</span><span class="op" id="1494505">(</span><span class="ident" id="1494506">t</span><span class="op" id="1494507">.</span><span class="ident" id="1494508">TransferEncoding</span><span class="op" id="1494524">)</span>&nbsp;<span class="op" id="1494526">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494530">if</span>&nbsp;<span class="ident" id="1494533">_</span><span class="op" id="1494534">,</span>&nbsp;<span class="ident" id="1494536">err</span>&nbsp;<span class="op" id="1494540">:=</span>&nbsp;<span class="ident" id="1494543">io</span><span class="op" id="1494545">.</span><span class="ident" id="1494546">WriteString</span><span class="op" id="1494557">(</span><span class="ident" id="1494558">w</span><span class="op" id="1494559">,</span>&nbsp;<span class="string" id="1494561">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="1494593">)</span><span class="op" id="1494594">;</span>&nbsp;<span class="ident" id="1494596">err</span>&nbsp;<span class="op" id="1494600">!=</span>&nbsp;<span class="ident" id="1494603">nil</span>&nbsp;<span class="op" id="1494607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494612">return</span>&nbsp;<span class="ident" id="1494619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494632">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494657">if</span>&nbsp;<span class="ident" id="1494660">t</span><span class="op" id="1494661">.</span><span class="ident" id="1494662">Trailer</span>&nbsp;<span class="op" id="1494670">!=</span>&nbsp;<span class="ident" id="1494673">nil</span>&nbsp;<span class="op" id="1494677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494681">keys</span>&nbsp;<span class="op" id="1494686">:=</span>&nbsp;<span class="builtinfunc" id="1494689">make</span><span class="op" id="1494693">(</span><span class="op" id="1494694">[</span><span class="op" id="1494695">]</span><span class="builtintype" id="1494696">string</span><span class="op" id="1494702">,</span>&nbsp;<span class="num" id="1494704">0</span><span class="op" id="1494705">,</span>&nbsp;<span class="builtinfunc" id="1494707">len</span><span class="op" id="1494710">(</span><span class="ident" id="1494711">t</span><span class="op" id="1494712">.</span><span class="ident" id="1494713">Trailer</span><span class="op" id="1494720">)</span><span class="op" id="1494721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494725">for</span>&nbsp;<span class="ident" id="1494729">k</span>&nbsp;<span class="op" id="1494731">:=</span>&nbsp;<span class="keyword" id="1494734">range</span>&nbsp;<span class="ident" id="1494740">t</span><span class="op" id="1494741">.</span><span class="ident" id="1494742">Trailer</span>&nbsp;<span class="op" id="1494750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494755">k</span>&nbsp;<span class="op" id="1494757">=</span>&nbsp;<span class="ident" id="1494759">CanonicalHeaderKey</span><span class="op" id="1494777">(</span><span class="ident" id="1494778">k</span><span class="op" id="1494779">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494784">switch</span>&nbsp;<span class="ident" id="1494791">k</span>&nbsp;<span class="op" id="1494793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494798">case</span>&nbsp;<span class="string" id="1494803">&#34;Transfer-Encoding&#34;</span><span class="op" id="1494822">,</span>&nbsp;<span class="string" id="1494824">&#34;Trailer&#34;</span><span class="op" id="1494833">,</span>&nbsp;<span class="string" id="1494835">&#34;Content-Length&#34;</span><span class="op" id="1494851">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494857">return</span>&nbsp;<span class="op" id="1494864">&amp;</span><span class="ident" id="1494865">badStringError</span><span class="op" id="1494879">{</span><span class="string" id="1494880">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="1494901">,</span>&nbsp;<span class="ident" id="1494903">k</span><span class="op" id="1494904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494914">keys</span>&nbsp;<span class="op" id="1494919">=</span>&nbsp;<span class="builtinfunc" id="1494921">append</span><span class="op" id="1494927">(</span><span class="ident" id="1494928">keys</span><span class="op" id="1494932">,</span>&nbsp;<span class="ident" id="1494934">k</span><span class="op" id="1494935">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494943">if</span>&nbsp;<span class="builtinfunc" id="1494946">len</span><span class="op" id="1494949">(</span><span class="ident" id="1494950">keys</span><span class="op" id="1494954">)</span>&nbsp;<span class="op" id="1494956">&gt;</span>&nbsp;<span class="num" id="1494958">0</span>&nbsp;<span class="op" id="1494960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494965">sort</span><span class="op" id="1494969">.</span><span class="ident" id="1494970">Strings</span><span class="op" id="1494977">(</span><span class="ident" id="1494978">keys</span><span class="op" id="1494982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494987">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495060">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495089">if</span>&nbsp;<span class="ident" id="1495092">_</span><span class="op" id="1495093">,</span>&nbsp;<span class="ident" id="1495095">err</span>&nbsp;<span class="op" id="1495099">:=</span>&nbsp;<span class="ident" id="1495102">io</span><span class="op" id="1495104">.</span><span class="ident" id="1495105">WriteString</span><span class="op" id="1495116">(</span><span class="ident" id="1495117">w</span><span class="op" id="1495118">,</span>&nbsp;<span class="string" id="1495120">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="1495131">+</span><span class="ident" id="1495132">strings</span><span class="op" id="1495139">.</span><span class="ident" id="1495140">Join</span><span class="op" id="1495144">(</span><span class="ident" id="1495145">keys</span><span class="op" id="1495149">,</span>&nbsp;<span class="string" id="1495151">&#34;,&#34;</span><span class="op" id="1495154">)</span><span class="op" id="1495155">+</span><span class="string" id="1495156">&#34;\r\n&#34;</span><span class="op" id="1495162">)</span><span class="op" id="1495163">;</span>&nbsp;<span class="ident" id="1495165">err</span>&nbsp;<span class="op" id="1495169">!=</span>&nbsp;<span class="ident" id="1495172">nil</span>&nbsp;<span class="op" id="1495176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495182">return</span>&nbsp;<span class="ident" id="1495189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495203">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495207">return</span>&nbsp;<span class="ident" id="1495214">nil</span><br>
<span class="lineno"></span><span class="op" id="1495218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1495221">func</span>&nbsp;<span class="op" id="1495226">(</span><span class="ident" id="1495227">t</span>&nbsp;<span class="op" id="1495229">*</span><span class="ident" id="1495230">transferWriter</span><span class="op" id="1495244">)</span>&nbsp;<span class="ident" id="1495246">WriteBody</span><span class="op" id="1495255">(</span><span class="ident" id="1495256">w</span>&nbsp;<span class="ident" id="1495258">io</span><span class="op" id="1495260">.</span><span class="ident" id="1495261">Writer</span><span class="op" id="1495267">)</span>&nbsp;<span class="builtintype" id="1495269">error</span>&nbsp;<span class="op" id="1495275">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495278">var</span>&nbsp;<span class="ident" id="1495282">err</span>&nbsp;<span class="builtintype" id="1495286">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495293">var</span>&nbsp;<span class="ident" id="1495297">ncopy</span>&nbsp;<span class="ident" id="1495303">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495311">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495326">if</span>&nbsp;<span class="ident" id="1495329">t</span><span class="op" id="1495330">.</span><span class="ident" id="1495331">Body</span>&nbsp;<span class="op" id="1495336">!=</span>&nbsp;<span class="ident" id="1495339">nil</span>&nbsp;<span class="op" id="1495343">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495347">if</span>&nbsp;<span class="ident" id="1495350">chunked</span><span class="op" id="1495357">(</span><span class="ident" id="1495358">t</span><span class="op" id="1495359">.</span><span class="ident" id="1495360">TransferEncoding</span><span class="op" id="1495376">)</span>&nbsp;<span class="op" id="1495378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495383">cw</span>&nbsp;<span class="op" id="1495386">:=</span>&nbsp;<span class="ident" id="1495389">internal</span><span class="op" id="1495397">.</span><span class="ident" id="1495398">NewChunkedWriter</span><span class="op" id="1495414">(</span><span class="ident" id="1495415">w</span><span class="op" id="1495416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495421">_</span><span class="op" id="1495422">,</span>&nbsp;<span class="ident" id="1495424">err</span>&nbsp;<span class="op" id="1495428">=</span>&nbsp;<span class="ident" id="1495430">io</span><span class="op" id="1495432">.</span><span class="ident" id="1495433">Copy</span><span class="op" id="1495437">(</span><span class="ident" id="1495438">cw</span><span class="op" id="1495440">,</span>&nbsp;<span class="ident" id="1495442">t</span><span class="op" id="1495443">.</span><span class="ident" id="1495444">Body</span><span class="op" id="1495448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495453">if</span>&nbsp;<span class="ident" id="1495456">err</span>&nbsp;<span class="op" id="1495460">==</span>&nbsp;<span class="ident" id="1495463">nil</span>&nbsp;<span class="op" id="1495467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495473">err</span>&nbsp;<span class="op" id="1495477">=</span>&nbsp;<span class="ident" id="1495479">cw</span><span class="op" id="1495481">.</span><span class="ident" id="1495482">Close</span><span class="op" id="1495487">(</span><span class="op" id="1495488">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495497">}</span>&nbsp;<span class="keyword" id="1495499">else</span>&nbsp;<span class="keyword" id="1495504">if</span>&nbsp;<span class="ident" id="1495507">t</span><span class="op" id="1495508">.</span><span class="ident" id="1495509">ContentLength</span>&nbsp;<span class="op" id="1495523">==</span>&nbsp;<span class="op" id="1495526">-</span><span class="num" id="1495527">1</span>&nbsp;<span class="op" id="1495529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495534">ncopy</span><span class="op" id="1495539">,</span>&nbsp;<span class="ident" id="1495541">err</span>&nbsp;<span class="op" id="1495545">=</span>&nbsp;<span class="ident" id="1495547">io</span><span class="op" id="1495549">.</span><span class="ident" id="1495550">Copy</span><span class="op" id="1495554">(</span><span class="ident" id="1495555">w</span><span class="op" id="1495556">,</span>&nbsp;<span class="ident" id="1495558">t</span><span class="op" id="1495559">.</span><span class="ident" id="1495560">Body</span><span class="op" id="1495564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495568">}</span>&nbsp;<span class="keyword" id="1495570">else</span>&nbsp;<span class="op" id="1495575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495580">ncopy</span><span class="op" id="1495585">,</span>&nbsp;<span class="ident" id="1495587">err</span>&nbsp;<span class="op" id="1495591">=</span>&nbsp;<span class="ident" id="1495593">io</span><span class="op" id="1495595">.</span><span class="ident" id="1495596">Copy</span><span class="op" id="1495600">(</span><span class="ident" id="1495601">w</span><span class="op" id="1495602">,</span>&nbsp;<span class="ident" id="1495604">io</span><span class="op" id="1495606">.</span><span class="ident" id="1495607">LimitReader</span><span class="op" id="1495618">(</span><span class="ident" id="1495619">t</span><span class="op" id="1495620">.</span><span class="ident" id="1495621">Body</span><span class="op" id="1495625">,</span>&nbsp;<span class="ident" id="1495627">t</span><span class="op" id="1495628">.</span><span class="ident" id="1495629">ContentLength</span><span class="op" id="1495642">)</span><span class="op" id="1495643">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495648">if</span>&nbsp;<span class="ident" id="1495651">err</span>&nbsp;<span class="op" id="1495655">!=</span>&nbsp;<span class="ident" id="1495658">nil</span>&nbsp;<span class="op" id="1495662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495668">return</span>&nbsp;<span class="ident" id="1495675">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495687">var</span>&nbsp;<span class="ident" id="1495691">nextra</span>&nbsp;<span class="ident" id="1495698">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495707">nextra</span><span class="op" id="1495713">,</span>&nbsp;<span class="ident" id="1495715">err</span>&nbsp;<span class="op" id="1495719">=</span>&nbsp;<span class="ident" id="1495721">io</span><span class="op" id="1495723">.</span><span class="ident" id="1495724">Copy</span><span class="op" id="1495728">(</span><span class="ident" id="1495729">ioutil</span><span class="op" id="1495735">.</span><span class="ident" id="1495736">Discard</span><span class="op" id="1495743">,</span>&nbsp;<span class="ident" id="1495745">t</span><span class="op" id="1495746">.</span><span class="ident" id="1495747">Body</span><span class="op" id="1495751">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495756">ncopy</span>&nbsp;<span class="op" id="1495762">+=</span>&nbsp;<span class="ident" id="1495765">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495778">if</span>&nbsp;<span class="ident" id="1495781">err</span>&nbsp;<span class="op" id="1495785">!=</span>&nbsp;<span class="ident" id="1495788">nil</span>&nbsp;<span class="op" id="1495792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495797">return</span>&nbsp;<span class="ident" id="1495804">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495810">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495814">if</span>&nbsp;<span class="ident" id="1495817">err</span>&nbsp;<span class="op" id="1495821">=</span>&nbsp;<span class="ident" id="1495823">t</span><span class="op" id="1495824">.</span><span class="ident" id="1495825">BodyCloser</span><span class="op" id="1495835">.</span><span class="ident" id="1495836">Close</span><span class="op" id="1495841">(</span><span class="op" id="1495842">)</span><span class="op" id="1495843">;</span>&nbsp;<span class="ident" id="1495845">err</span>&nbsp;<span class="op" id="1495849">!=</span>&nbsp;<span class="ident" id="1495852">nil</span>&nbsp;<span class="op" id="1495856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495861">return</span>&nbsp;<span class="ident" id="1495868">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495881">if</span>&nbsp;<span class="op" id="1495884">!</span><span class="ident" id="1495885">t</span><span class="op" id="1495886">.</span><span class="ident" id="1495887">ResponseToHEAD</span>&nbsp;<span class="op" id="1495902">&amp;&amp;</span>&nbsp;<span class="ident" id="1495905">t</span><span class="op" id="1495906">.</span><span class="ident" id="1495907">ContentLength</span>&nbsp;<span class="op" id="1495921">!=</span>&nbsp;<span class="op" id="1495924">-</span><span class="num" id="1495925">1</span>&nbsp;<span class="op" id="1495927">&amp;&amp;</span>&nbsp;<span class="ident" id="1495930">t</span><span class="op" id="1495931">.</span><span class="ident" id="1495932">ContentLength</span>&nbsp;<span class="op" id="1495946">!=</span>&nbsp;<span class="ident" id="1495949">ncopy</span>&nbsp;<span class="op" id="1495955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495959">return</span>&nbsp;<span class="ident" id="1495966">fmt</span><span class="op" id="1495969">.</span><span class="ident" id="1495970">Errorf</span><span class="op" id="1495976">(</span><span class="string" id="1495977">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="1496021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496026">t</span><span class="op" id="1496027">.</span><span class="ident" id="1496028">ContentLength</span><span class="op" id="1496041">,</span>&nbsp;<span class="ident" id="1496043">ncopy</span><span class="op" id="1496048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496055">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496104">if</span>&nbsp;<span class="ident" id="1496107">chunked</span><span class="op" id="1496114">(</span><span class="ident" id="1496115">t</span><span class="op" id="1496116">.</span><span class="ident" id="1496117">TransferEncoding</span><span class="op" id="1496133">)</span>&nbsp;<span class="op" id="1496135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496139">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496165">if</span>&nbsp;<span class="ident" id="1496168">t</span><span class="op" id="1496169">.</span><span class="ident" id="1496170">Trailer</span>&nbsp;<span class="op" id="1496178">!=</span>&nbsp;<span class="ident" id="1496181">nil</span>&nbsp;<span class="op" id="1496185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496190">if</span>&nbsp;<span class="ident" id="1496193">err</span>&nbsp;<span class="op" id="1496197">:=</span>&nbsp;<span class="ident" id="1496200">t</span><span class="op" id="1496201">.</span><span class="ident" id="1496202">Trailer</span><span class="op" id="1496209">.</span><span class="ident" id="1496210">Write</span><span class="op" id="1496215">(</span><span class="ident" id="1496216">w</span><span class="op" id="1496217">)</span><span class="op" id="1496218">;</span>&nbsp;<span class="ident" id="1496220">err</span>&nbsp;<span class="op" id="1496224">!=</span>&nbsp;<span class="ident" id="1496227">nil</span>&nbsp;<span class="op" id="1496231">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496237">return</span>&nbsp;<span class="ident" id="1496244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496259">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496290">_</span><span class="op" id="1496291">,</span>&nbsp;<span class="ident" id="1496293">err</span>&nbsp;<span class="op" id="1496297">=</span>&nbsp;<span class="ident" id="1496299">io</span><span class="op" id="1496301">.</span><span class="ident" id="1496302">WriteString</span><span class="op" id="1496313">(</span><span class="ident" id="1496314">w</span><span class="op" id="1496315">,</span>&nbsp;<span class="string" id="1496317">&#34;\r\n&#34;</span><span class="op" id="1496323">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496329">return</span>&nbsp;<span class="ident" id="1496336">err</span><br>
<span class="lineno"></span><span class="op" id="1496340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496343">type</span>&nbsp;<span class="ident" id="1496348">transferReader</span>&nbsp;<span class="keyword" id="1496363">struct</span>&nbsp;<span class="op" id="1496370">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496373">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496383">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496397">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496405">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496419">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496424">RequestMethod</span>&nbsp;<span class="builtintype" id="1496438">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496446">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496460">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496465">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496479">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496484">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496495">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496512">io</span><span class="op" id="1496514">.</span><span class="ident" id="1496515">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496527">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496544">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496551">TransferEncoding</span>&nbsp;<span class="op" id="1496568">[</span><span class="op" id="1496569">]</span><span class="builtintype" id="1496570">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496578">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1496595">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496601">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1496618">Header</span><br>
<span class="lineno"></span><span class="op" id="1496625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1496628">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="1496697">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="1496743">func</span>&nbsp;<span class="ident" id="1496748">bodyAllowedForStatus</span><span class="op" id="1496768">(</span><span class="ident" id="1496769">status</span>&nbsp;<span class="builtintype" id="1496776">int</span><span class="op" id="1496779">)</span>&nbsp;<span class="builtintype" id="1496781">bool</span>&nbsp;<span class="op" id="1496786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496789">switch</span>&nbsp;<span class="op" id="1496796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496799">case</span>&nbsp;<span class="ident" id="1496804">status</span>&nbsp;<span class="op" id="1496811">&gt;=</span>&nbsp;<span class="num" id="1496814">100</span>&nbsp;<span class="op" id="1496818">&amp;&amp;</span>&nbsp;<span class="ident" id="1496821">status</span>&nbsp;<span class="op" id="1496828">&lt;=</span>&nbsp;<span class="num" id="1496831">199</span><span class="op" id="1496834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496838">return</span>&nbsp;<span class="builtintype" id="1496845">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496852">case</span>&nbsp;<span class="ident" id="1496857">status</span>&nbsp;<span class="op" id="1496864">==</span>&nbsp;<span class="num" id="1496867">204</span><span class="op" id="1496870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496874">return</span>&nbsp;<span class="builtintype" id="1496881">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496888">case</span>&nbsp;<span class="ident" id="1496893">status</span>&nbsp;<span class="op" id="1496900">==</span>&nbsp;<span class="num" id="1496903">304</span><span class="op" id="1496906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496910">return</span>&nbsp;<span class="builtintype" id="1496917">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496924">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496927">return</span>&nbsp;<span class="builtintype" id="1496934">true</span><br>
<span class="lineno"></span><span class="op" id="1496939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496942">var</span>&nbsp;<span class="op" id="1496946">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496949">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1496973">=</span>&nbsp;<span class="op" id="1496975">[</span><span class="op" id="1496976">]</span><span class="builtintype" id="1496977">string</span><span class="op" id="1496983">{</span><span class="string" id="1496984">&#34;Content-Type&#34;</span><span class="op" id="1496998">,</span>&nbsp;<span class="string" id="1497000">&#34;Content-Length&#34;</span><span class="op" id="1497016">,</span>&nbsp;<span class="string" id="1497018">&#34;Transfer-Encoding&#34;</span><span class="op" id="1497037">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497040">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="1497064">=</span>&nbsp;<span class="op" id="1497066">[</span><span class="op" id="1497067">]</span><span class="builtintype" id="1497068">string</span><span class="op" id="1497074">{</span><span class="string" id="1497075">&#34;Content-Length&#34;</span><span class="op" id="1497091">,</span>&nbsp;<span class="string" id="1497093">&#34;Transfer-Encoding&#34;</span><span class="op" id="1497112">}</span><br>
<span class="lineno"></span><span class="op" id="1497114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1497117">func</span>&nbsp;<span class="ident" id="1497122">suppressedHeaders</span><span class="op" id="1497139">(</span><span class="ident" id="1497140">status</span>&nbsp;<span class="builtintype" id="1497147">int</span><span class="op" id="1497150">)</span>&nbsp;<span class="op" id="1497152">[</span><span class="op" id="1497153">]</span><span class="builtintype" id="1497154">string</span>&nbsp;<span class="op" id="1497161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497164">switch</span>&nbsp;<span class="op" id="1497171">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497174">case</span>&nbsp;<span class="ident" id="1497179">status</span>&nbsp;<span class="op" id="1497186">==</span>&nbsp;<span class="num" id="1497189">304</span><span class="op" id="1497192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497196">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497279">return</span>&nbsp;<span class="ident" id="1497286">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497308">case</span>&nbsp;<span class="op" id="1497313">!</span><span class="ident" id="1497314">bodyAllowedForStatus</span><span class="op" id="1497334">(</span><span class="ident" id="1497335">status</span><span class="op" id="1497341">)</span><span class="op" id="1497342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497346">return</span>&nbsp;<span class="ident" id="1497353">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497381">return</span>&nbsp;<span class="ident" id="1497388">nil</span><br>
<span class="lineno"></span><span class="op" id="1497392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1497395">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="1497428">func</span>&nbsp;<span class="ident" id="1497433">readTransfer</span><span class="op" id="1497445">(</span><span class="ident" id="1497446">msg</span>&nbsp;<span class="keyword" id="1497450">interface</span><span class="op" id="1497459">{</span><span class="op" id="1497460">}</span><span class="op" id="1497461">,</span>&nbsp;<span class="ident" id="1497463">r</span>&nbsp;<span class="op" id="1497465">*</span><span class="ident" id="1497466">bufio</span><span class="op" id="1497471">.</span><span class="ident" id="1497472">Reader</span><span class="op" id="1497478">)</span>&nbsp;<span class="op" id="1497480">(</span><span class="ident" id="1497481">err</span>&nbsp;<span class="builtintype" id="1497485">error</span><span class="op" id="1497490">)</span>&nbsp;<span class="op" id="1497492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497495">t</span>&nbsp;<span class="op" id="1497497">:=</span>&nbsp;<span class="op" id="1497500">&amp;</span><span class="ident" id="1497501">transferReader</span><span class="op" id="1497515">{</span><span class="ident" id="1497516">RequestMethod</span><span class="op" id="1497529">:</span>&nbsp;<span class="string" id="1497531">&#34;GET&#34;</span><span class="op" id="1497536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497540">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497556">isResponse</span>&nbsp;<span class="op" id="1497567">:=</span>&nbsp;<span class="builtintype" id="1497570">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497577">switch</span>&nbsp;<span class="ident" id="1497584">rr</span>&nbsp;<span class="op" id="1497587">:=</span>&nbsp;<span class="ident" id="1497590">msg</span><span class="op" id="1497593">.</span><span class="op" id="1497594">(</span><span class="keyword" id="1497595">type</span><span class="op" id="1497599">)</span>&nbsp;<span class="op" id="1497601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497604">case</span>&nbsp;<span class="op" id="1497609">*</span><span class="ident" id="1497610">Response</span><span class="op" id="1497618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497622">t</span><span class="op" id="1497623">.</span><span class="ident" id="1497624">Header</span>&nbsp;<span class="op" id="1497631">=</span>&nbsp;<span class="ident" id="1497633">rr</span><span class="op" id="1497635">.</span><span class="ident" id="1497636">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497645">t</span><span class="op" id="1497646">.</span><span class="ident" id="1497647">StatusCode</span>&nbsp;<span class="op" id="1497658">=</span>&nbsp;<span class="ident" id="1497660">rr</span><span class="op" id="1497662">.</span><span class="ident" id="1497663">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497676">t</span><span class="op" id="1497677">.</span><span class="ident" id="1497678">ProtoMajor</span>&nbsp;<span class="op" id="1497689">=</span>&nbsp;<span class="ident" id="1497691">rr</span><span class="op" id="1497693">.</span><span class="ident" id="1497694">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497707">t</span><span class="op" id="1497708">.</span><span class="ident" id="1497709">ProtoMinor</span>&nbsp;<span class="op" id="1497720">=</span>&nbsp;<span class="ident" id="1497722">rr</span><span class="op" id="1497724">.</span><span class="ident" id="1497725">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497738">t</span><span class="op" id="1497739">.</span><span class="ident" id="1497740">Close</span>&nbsp;<span class="op" id="1497746">=</span>&nbsp;<span class="ident" id="1497748">shouldClose</span><span class="op" id="1497759">(</span><span class="ident" id="1497760">t</span><span class="op" id="1497761">.</span><span class="ident" id="1497762">ProtoMajor</span><span class="op" id="1497772">,</span>&nbsp;<span class="ident" id="1497774">t</span><span class="op" id="1497775">.</span><span class="ident" id="1497776">ProtoMinor</span><span class="op" id="1497786">,</span>&nbsp;<span class="ident" id="1497788">t</span><span class="op" id="1497789">.</span><span class="ident" id="1497790">Header</span><span class="op" id="1497796">,</span>&nbsp;<span class="builtintype" id="1497798">true</span><span class="op" id="1497802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497806">isResponse</span>&nbsp;<span class="op" id="1497817">=</span>&nbsp;<span class="builtintype" id="1497819">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497826">if</span>&nbsp;<span class="ident" id="1497829">rr</span><span class="op" id="1497831">.</span><span class="ident" id="1497832">Request</span>&nbsp;<span class="op" id="1497840">!=</span>&nbsp;<span class="ident" id="1497843">nil</span>&nbsp;<span class="op" id="1497847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497852">t</span><span class="op" id="1497853">.</span><span class="ident" id="1497854">RequestMethod</span>&nbsp;<span class="op" id="1497868">=</span>&nbsp;<span class="ident" id="1497870">rr</span><span class="op" id="1497872">.</span><span class="ident" id="1497873">Request</span><span class="op" id="1497880">.</span><span class="ident" id="1497881">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497893">case</span>&nbsp;<span class="op" id="1497898">*</span><span class="ident" id="1497899">Request</span><span class="op" id="1497906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497910">t</span><span class="op" id="1497911">.</span><span class="ident" id="1497912">Header</span>&nbsp;<span class="op" id="1497919">=</span>&nbsp;<span class="ident" id="1497921">rr</span><span class="op" id="1497923">.</span><span class="ident" id="1497924">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497933">t</span><span class="op" id="1497934">.</span><span class="ident" id="1497935">ProtoMajor</span>&nbsp;<span class="op" id="1497946">=</span>&nbsp;<span class="ident" id="1497948">rr</span><span class="op" id="1497950">.</span><span class="ident" id="1497951">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497964">t</span><span class="op" id="1497965">.</span><span class="ident" id="1497966">ProtoMinor</span>&nbsp;<span class="op" id="1497977">=</span>&nbsp;<span class="ident" id="1497979">rr</span><span class="op" id="1497981">.</span><span class="ident" id="1497982">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497995">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498059">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498123">t</span><span class="op" id="1498124">.</span><span class="ident" id="1498125">StatusCode</span>&nbsp;<span class="op" id="1498136">=</span>&nbsp;<span class="num" id="1498138">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498143">default</span><span class="op" id="1498150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1498154">panic</span><span class="op" id="1498159">(</span><span class="string" id="1498160">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="1498177">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498184">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498208">if</span>&nbsp;<span class="ident" id="1498211">t</span><span class="op" id="1498212">.</span><span class="ident" id="1498213">ProtoMajor</span>&nbsp;<span class="op" id="1498224">==</span>&nbsp;<span class="num" id="1498227">0</span>&nbsp;<span class="op" id="1498229">&amp;&amp;</span>&nbsp;<span class="ident" id="1498232">t</span><span class="op" id="1498233">.</span><span class="ident" id="1498234">ProtoMinor</span>&nbsp;<span class="op" id="1498245">==</span>&nbsp;<span class="num" id="1498248">0</span>&nbsp;<span class="op" id="1498250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498254">t</span><span class="op" id="1498255">.</span><span class="ident" id="1498256">ProtoMajor</span><span class="op" id="1498266">,</span>&nbsp;<span class="ident" id="1498268">t</span><span class="op" id="1498269">.</span><span class="ident" id="1498270">ProtoMinor</span>&nbsp;<span class="op" id="1498281">=</span>&nbsp;<span class="num" id="1498283">1</span><span class="op" id="1498284">,</span>&nbsp;<span class="num" id="1498286">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498293">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498331">t</span><span class="op" id="1498332">.</span><span class="ident" id="1498333">TransferEncoding</span><span class="op" id="1498349">,</span>&nbsp;<span class="ident" id="1498351">err</span>&nbsp;<span class="op" id="1498355">=</span>&nbsp;<span class="ident" id="1498357">fixTransferEncoding</span><span class="op" id="1498376">(</span><span class="ident" id="1498377">t</span><span class="op" id="1498378">.</span><span class="ident" id="1498379">RequestMethod</span><span class="op" id="1498392">,</span>&nbsp;<span class="ident" id="1498394">t</span><span class="op" id="1498395">.</span><span class="ident" id="1498396">Header</span><span class="op" id="1498402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498405">if</span>&nbsp;<span class="ident" id="1498408">err</span>&nbsp;<span class="op" id="1498412">!=</span>&nbsp;<span class="ident" id="1498415">nil</span>&nbsp;<span class="op" id="1498419">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498423">return</span>&nbsp;<span class="ident" id="1498430">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498439">realLength</span><span class="op" id="1498449">,</span>&nbsp;<span class="ident" id="1498451">err</span>&nbsp;<span class="op" id="1498455">:=</span>&nbsp;<span class="ident" id="1498458">fixLength</span><span class="op" id="1498467">(</span><span class="ident" id="1498468">isResponse</span><span class="op" id="1498478">,</span>&nbsp;<span class="ident" id="1498480">t</span><span class="op" id="1498481">.</span><span class="ident" id="1498482">StatusCode</span><span class="op" id="1498492">,</span>&nbsp;<span class="ident" id="1498494">t</span><span class="op" id="1498495">.</span><span class="ident" id="1498496">RequestMethod</span><span class="op" id="1498509">,</span>&nbsp;<span class="ident" id="1498511">t</span><span class="op" id="1498512">.</span><span class="ident" id="1498513">Header</span><span class="op" id="1498519">,</span>&nbsp;<span class="ident" id="1498521">t</span><span class="op" id="1498522">.</span><span class="ident" id="1498523">TransferEncoding</span><span class="op" id="1498539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498542">if</span>&nbsp;<span class="ident" id="1498545">err</span>&nbsp;<span class="op" id="1498549">!=</span>&nbsp;<span class="ident" id="1498552">nil</span>&nbsp;<span class="op" id="1498556">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498560">return</span>&nbsp;<span class="ident" id="1498567">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498575">if</span>&nbsp;<span class="ident" id="1498578">isResponse</span>&nbsp;<span class="op" id="1498589">&amp;&amp;</span>&nbsp;<span class="ident" id="1498592">t</span><span class="op" id="1498593">.</span><span class="ident" id="1498594">RequestMethod</span>&nbsp;<span class="op" id="1498608">==</span>&nbsp;<span class="string" id="1498611">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1498618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498622">if</span>&nbsp;<span class="ident" id="1498625">n</span><span class="op" id="1498626">,</span>&nbsp;<span class="ident" id="1498628">err</span>&nbsp;<span class="op" id="1498632">:=</span>&nbsp;<span class="ident" id="1498635">parseContentLength</span><span class="op" id="1498653">(</span><span class="ident" id="1498654">t</span><span class="op" id="1498655">.</span><span class="ident" id="1498656">Header</span><span class="op" id="1498662">.</span><span class="ident" id="1498663">get</span><span class="op" id="1498666">(</span><span class="string" id="1498667">&#34;Content-Length&#34;</span><span class="op" id="1498683">)</span><span class="op" id="1498684">)</span><span class="op" id="1498685">;</span>&nbsp;<span class="ident" id="1498687">err</span>&nbsp;<span class="op" id="1498691">!=</span>&nbsp;<span class="ident" id="1498694">nil</span>&nbsp;<span class="op" id="1498698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498703">return</span>&nbsp;<span class="ident" id="1498710">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498716">}</span>&nbsp;<span class="keyword" id="1498718">else</span>&nbsp;<span class="op" id="1498723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498728">t</span><span class="op" id="1498729">.</span><span class="ident" id="1498730">ContentLength</span>&nbsp;<span class="op" id="1498744">=</span>&nbsp;<span class="ident" id="1498746">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498753">}</span>&nbsp;<span class="keyword" id="1498755">else</span>&nbsp;<span class="op" id="1498760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498764">t</span><span class="op" id="1498765">.</span><span class="ident" id="1498766">ContentLength</span>&nbsp;<span class="op" id="1498780">=</span>&nbsp;<span class="ident" id="1498782">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498798">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498810">t</span><span class="op" id="1498811">.</span><span class="ident" id="1498812">Trailer</span><span class="op" id="1498819">,</span>&nbsp;<span class="ident" id="1498821">err</span>&nbsp;<span class="op" id="1498825">=</span>&nbsp;<span class="ident" id="1498827">fixTrailer</span><span class="op" id="1498837">(</span><span class="ident" id="1498838">t</span><span class="op" id="1498839">.</span><span class="ident" id="1498840">Header</span><span class="op" id="1498846">,</span>&nbsp;<span class="ident" id="1498848">t</span><span class="op" id="1498849">.</span><span class="ident" id="1498850">TransferEncoding</span><span class="op" id="1498866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498869">if</span>&nbsp;<span class="ident" id="1498872">err</span>&nbsp;<span class="op" id="1498876">!=</span>&nbsp;<span class="ident" id="1498879">nil</span>&nbsp;<span class="op" id="1498883">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498887">return</span>&nbsp;<span class="ident" id="1498894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498903">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498981">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499052">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499082">switch</span>&nbsp;<span class="ident" id="1499089">msg</span><span class="op" id="1499092">.</span><span class="op" id="1499093">(</span><span class="keyword" id="1499094">type</span><span class="op" id="1499098">)</span>&nbsp;<span class="op" id="1499100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499103">case</span>&nbsp;<span class="op" id="1499108">*</span><span class="ident" id="1499109">Response</span><span class="op" id="1499117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499121">if</span>&nbsp;<span class="ident" id="1499124">realLength</span>&nbsp;<span class="op" id="1499135">==</span>&nbsp;<span class="op" id="1499138">-</span><span class="num" id="1499139">1</span>&nbsp;<span class="op" id="1499141">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499147">!</span><span class="ident" id="1499148">chunked</span><span class="op" id="1499155">(</span><span class="ident" id="1499156">t</span><span class="op" id="1499157">.</span><span class="ident" id="1499158">TransferEncoding</span><span class="op" id="1499174">)</span>&nbsp;<span class="op" id="1499176">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499182">bodyAllowedForStatus</span><span class="op" id="1499202">(</span><span class="ident" id="1499203">t</span><span class="op" id="1499204">.</span><span class="ident" id="1499205">StatusCode</span><span class="op" id="1499215">)</span>&nbsp;<span class="op" id="1499217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499222">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499244">t</span><span class="op" id="1499245">.</span><span class="ident" id="1499246">Close</span>&nbsp;<span class="op" id="1499252">=</span>&nbsp;<span class="builtintype" id="1499254">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499264">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499268">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499335">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499411">switch</span>&nbsp;<span class="op" id="1499418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499421">case</span>&nbsp;<span class="ident" id="1499426">chunked</span><span class="op" id="1499433">(</span><span class="ident" id="1499434">t</span><span class="op" id="1499435">.</span><span class="ident" id="1499436">TransferEncoding</span><span class="op" id="1499452">)</span><span class="op" id="1499453">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499457">if</span>&nbsp;<span class="ident" id="1499460">noBodyExpected</span><span class="op" id="1499474">(</span><span class="ident" id="1499475">t</span><span class="op" id="1499476">.</span><span class="ident" id="1499477">RequestMethod</span><span class="op" id="1499490">)</span>&nbsp;<span class="op" id="1499492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499497">t</span><span class="op" id="1499498">.</span><span class="ident" id="1499499">Body</span>&nbsp;<span class="op" id="1499504">=</span>&nbsp;<span class="ident" id="1499506">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499518">}</span>&nbsp;<span class="keyword" id="1499520">else</span>&nbsp;<span class="op" id="1499525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499530">t</span><span class="op" id="1499531">.</span><span class="ident" id="1499532">Body</span>&nbsp;<span class="op" id="1499537">=</span>&nbsp;<span class="op" id="1499539">&amp;</span><span class="ident" id="1499540">body</span><span class="op" id="1499544">{</span><span class="ident" id="1499545">src</span><span class="op" id="1499548">:</span>&nbsp;<span class="ident" id="1499550">internal</span><span class="op" id="1499558">.</span><span class="ident" id="1499559">NewChunkedReader</span><span class="op" id="1499575">(</span><span class="ident" id="1499576">r</span><span class="op" id="1499577">)</span><span class="op" id="1499578">,</span>&nbsp;<span class="ident" id="1499580">hdr</span><span class="op" id="1499583">:</span>&nbsp;<span class="ident" id="1499585">msg</span><span class="op" id="1499588">,</span>&nbsp;<span class="ident" id="1499590">r</span><span class="op" id="1499591">:</span>&nbsp;<span class="ident" id="1499593">r</span><span class="op" id="1499594">,</span>&nbsp;<span class="ident" id="1499596">closing</span><span class="op" id="1499603">:</span>&nbsp;<span class="ident" id="1499605">t</span><span class="op" id="1499606">.</span><span class="ident" id="1499607">Close</span><span class="op" id="1499612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499616">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499619">case</span>&nbsp;<span class="ident" id="1499624">realLength</span>&nbsp;<span class="op" id="1499635">==</span>&nbsp;<span class="num" id="1499638">0</span><span class="op" id="1499639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499643">t</span><span class="op" id="1499644">.</span><span class="ident" id="1499645">Body</span>&nbsp;<span class="op" id="1499650">=</span>&nbsp;<span class="ident" id="1499652">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499663">case</span>&nbsp;<span class="ident" id="1499668">realLength</span>&nbsp;<span class="op" id="1499679">&gt;</span>&nbsp;<span class="num" id="1499681">0</span><span class="op" id="1499682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499686">t</span><span class="op" id="1499687">.</span><span class="ident" id="1499688">Body</span>&nbsp;<span class="op" id="1499693">=</span>&nbsp;<span class="op" id="1499695">&amp;</span><span class="ident" id="1499696">body</span><span class="op" id="1499700">{</span><span class="ident" id="1499701">src</span><span class="op" id="1499704">:</span>&nbsp;<span class="ident" id="1499706">io</span><span class="op" id="1499708">.</span><span class="ident" id="1499709">LimitReader</span><span class="op" id="1499720">(</span><span class="ident" id="1499721">r</span><span class="op" id="1499722">,</span>&nbsp;<span class="ident" id="1499724">realLength</span><span class="op" id="1499734">)</span><span class="op" id="1499735">,</span>&nbsp;<span class="ident" id="1499737">closing</span><span class="op" id="1499744">:</span>&nbsp;<span class="ident" id="1499746">t</span><span class="op" id="1499747">.</span><span class="ident" id="1499748">Close</span><span class="op" id="1499753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499756">default</span><span class="op" id="1499763">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499767">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499834">if</span>&nbsp;<span class="ident" id="1499837">t</span><span class="op" id="1499838">.</span><span class="ident" id="1499839">Close</span>&nbsp;<span class="op" id="1499845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499850">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499888">t</span><span class="op" id="1499889">.</span><span class="ident" id="1499890">Body</span>&nbsp;<span class="op" id="1499895">=</span>&nbsp;<span class="op" id="1499897">&amp;</span><span class="ident" id="1499898">body</span><span class="op" id="1499902">{</span><span class="ident" id="1499903">src</span><span class="op" id="1499906">:</span>&nbsp;<span class="ident" id="1499908">r</span><span class="op" id="1499909">,</span>&nbsp;<span class="ident" id="1499911">closing</span><span class="op" id="1499918">:</span>&nbsp;<span class="ident" id="1499920">t</span><span class="op" id="1499921">.</span><span class="ident" id="1499922">Close</span><span class="op" id="1499927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499931">}</span>&nbsp;<span class="keyword" id="1499933">else</span>&nbsp;<span class="op" id="1499938">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499943">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499987">t</span><span class="op" id="1499988">.</span><span class="ident" id="1499989">Body</span>&nbsp;<span class="op" id="1499994">=</span>&nbsp;<span class="ident" id="1499996">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500015">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500032">switch</span>&nbsp;<span class="ident" id="1500039">rr</span>&nbsp;<span class="op" id="1500042">:=</span>&nbsp;<span class="ident" id="1500045">msg</span><span class="op" id="1500048">.</span><span class="op" id="1500049">(</span><span class="keyword" id="1500050">type</span><span class="op" id="1500054">)</span>&nbsp;<span class="op" id="1500056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500059">case</span>&nbsp;<span class="op" id="1500064">*</span><span class="ident" id="1500065">Request</span><span class="op" id="1500072">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500076">rr</span><span class="op" id="1500078">.</span><span class="ident" id="1500079">Body</span>&nbsp;<span class="op" id="1500084">=</span>&nbsp;<span class="ident" id="1500086">t</span><span class="op" id="1500087">.</span><span class="ident" id="1500088">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500095">rr</span><span class="op" id="1500097">.</span><span class="ident" id="1500098">ContentLength</span>&nbsp;<span class="op" id="1500112">=</span>&nbsp;<span class="ident" id="1500114">t</span><span class="op" id="1500115">.</span><span class="ident" id="1500116">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500132">rr</span><span class="op" id="1500134">.</span><span class="ident" id="1500135">TransferEncoding</span>&nbsp;<span class="op" id="1500152">=</span>&nbsp;<span class="ident" id="1500154">t</span><span class="op" id="1500155">.</span><span class="ident" id="1500156">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500175">rr</span><span class="op" id="1500177">.</span><span class="ident" id="1500178">Close</span>&nbsp;<span class="op" id="1500184">=</span>&nbsp;<span class="ident" id="1500186">t</span><span class="op" id="1500187">.</span><span class="ident" id="1500188">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500196">rr</span><span class="op" id="1500198">.</span><span class="ident" id="1500199">Trailer</span>&nbsp;<span class="op" id="1500207">=</span>&nbsp;<span class="ident" id="1500209">t</span><span class="op" id="1500210">.</span><span class="ident" id="1500211">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500220">case</span>&nbsp;<span class="op" id="1500225">*</span><span class="ident" id="1500226">Response</span><span class="op" id="1500234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500238">rr</span><span class="op" id="1500240">.</span><span class="ident" id="1500241">Body</span>&nbsp;<span class="op" id="1500246">=</span>&nbsp;<span class="ident" id="1500248">t</span><span class="op" id="1500249">.</span><span class="ident" id="1500250">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500257">rr</span><span class="op" id="1500259">.</span><span class="ident" id="1500260">ContentLength</span>&nbsp;<span class="op" id="1500274">=</span>&nbsp;<span class="ident" id="1500276">t</span><span class="op" id="1500277">.</span><span class="ident" id="1500278">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500294">rr</span><span class="op" id="1500296">.</span><span class="ident" id="1500297">TransferEncoding</span>&nbsp;<span class="op" id="1500314">=</span>&nbsp;<span class="ident" id="1500316">t</span><span class="op" id="1500317">.</span><span class="ident" id="1500318">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500337">rr</span><span class="op" id="1500339">.</span><span class="ident" id="1500340">Close</span>&nbsp;<span class="op" id="1500346">=</span>&nbsp;<span class="ident" id="1500348">t</span><span class="op" id="1500349">.</span><span class="ident" id="1500350">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500358">rr</span><span class="op" id="1500360">.</span><span class="ident" id="1500361">Trailer</span>&nbsp;<span class="op" id="1500369">=</span>&nbsp;<span class="ident" id="1500371">t</span><span class="op" id="1500372">.</span><span class="ident" id="1500373">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500382">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500386">return</span>&nbsp;<span class="ident" id="1500393">nil</span><br>
<span class="lineno"></span><span class="op" id="1500397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500400">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="1500457">func</span>&nbsp;<span class="ident" id="1500462">chunked</span><span class="op" id="1500469">(</span><span class="ident" id="1500470">te</span>&nbsp;<span class="op" id="1500473">[</span><span class="op" id="1500474">]</span><span class="builtintype" id="1500475">string</span><span class="op" id="1500481">)</span>&nbsp;<span class="builtintype" id="1500483">bool</span>&nbsp;<span class="op" id="1500488">{</span>&nbsp;<span class="keyword" id="1500490">return</span>&nbsp;<span class="builtinfunc" id="1500497">len</span><span class="op" id="1500500">(</span><span class="ident" id="1500501">te</span><span class="op" id="1500503">)</span>&nbsp;<span class="op" id="1500505">&gt;</span>&nbsp;<span class="num" id="1500507">0</span>&nbsp;<span class="op" id="1500509">&amp;&amp;</span>&nbsp;<span class="ident" id="1500512">te</span><span class="op" id="1500514">[</span><span class="num" id="1500515">0</span><span class="op" id="1500516">]</span>&nbsp;<span class="op" id="1500518">==</span>&nbsp;<span class="string" id="1500521">&#34;chunked&#34;</span>&nbsp;<span class="op" id="1500531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500534">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="1500591">func</span>&nbsp;<span class="ident" id="1500596">isIdentity</span><span class="op" id="1500606">(</span><span class="ident" id="1500607">te</span>&nbsp;<span class="op" id="1500610">[</span><span class="op" id="1500611">]</span><span class="builtintype" id="1500612">string</span><span class="op" id="1500618">)</span>&nbsp;<span class="builtintype" id="1500620">bool</span>&nbsp;<span class="op" id="1500625">{</span>&nbsp;<span class="keyword" id="1500627">return</span>&nbsp;<span class="builtinfunc" id="1500634">len</span><span class="op" id="1500637">(</span><span class="ident" id="1500638">te</span><span class="op" id="1500640">)</span>&nbsp;<span class="op" id="1500642">==</span>&nbsp;<span class="num" id="1500645">1</span>&nbsp;<span class="op" id="1500647">&amp;&amp;</span>&nbsp;<span class="ident" id="1500650">te</span><span class="op" id="1500652">[</span><span class="num" id="1500653">0</span><span class="op" id="1500654">]</span>&nbsp;<span class="op" id="1500656">==</span>&nbsp;<span class="string" id="1500659">&#34;identity&#34;</span>&nbsp;<span class="op" id="1500670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1500673">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="1500703">func</span>&nbsp;<span class="ident" id="1500708">fixTransferEncoding</span><span class="op" id="1500727">(</span><span class="ident" id="1500728">requestMethod</span>&nbsp;<span class="builtintype" id="1500742">string</span><span class="op" id="1500748">,</span>&nbsp;<span class="ident" id="1500750">header</span>&nbsp;<span class="ident" id="1500757">Header</span><span class="op" id="1500763">)</span>&nbsp;<span class="op" id="1500765">(</span><span class="op" id="1500766">[</span><span class="op" id="1500767">]</span><span class="builtintype" id="1500768">string</span><span class="op" id="1500774">,</span>&nbsp;<span class="builtintype" id="1500776">error</span><span class="op" id="1500781">)</span>&nbsp;<span class="op" id="1500783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500786">raw</span><span class="op" id="1500789">,</span>&nbsp;<span class="ident" id="1500791">present</span>&nbsp;<span class="op" id="1500799">:=</span>&nbsp;<span class="ident" id="1500802">header</span><span class="op" id="1500808">[</span><span class="string" id="1500809">&#34;Transfer-Encoding&#34;</span><span class="op" id="1500828">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500831">if</span>&nbsp;<span class="op" id="1500834">!</span><span class="ident" id="1500835">present</span>&nbsp;<span class="op" id="1500843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500847">return</span>&nbsp;<span class="ident" id="1500854">nil</span><span class="op" id="1500857">,</span>&nbsp;<span class="ident" id="1500859">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1500868">delete</span><span class="op" id="1500874">(</span><span class="ident" id="1500875">header</span><span class="op" id="1500881">,</span>&nbsp;<span class="string" id="1500883">&#34;Transfer-Encoding&#34;</span><span class="op" id="1500902">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500906">encodings</span>&nbsp;<span class="op" id="1500916">:=</span>&nbsp;<span class="ident" id="1500919">strings</span><span class="op" id="1500926">.</span><span class="ident" id="1500927">Split</span><span class="op" id="1500932">(</span><span class="ident" id="1500933">raw</span><span class="op" id="1500936">[</span><span class="num" id="1500937">0</span><span class="op" id="1500938">]</span><span class="op" id="1500939">,</span>&nbsp;<span class="string" id="1500941">&#34;,&#34;</span><span class="op" id="1500944">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500947">te</span>&nbsp;<span class="op" id="1500950">:=</span>&nbsp;<span class="builtinfunc" id="1500953">make</span><span class="op" id="1500957">(</span><span class="op" id="1500958">[</span><span class="op" id="1500959">]</span><span class="builtintype" id="1500960">string</span><span class="op" id="1500966">,</span>&nbsp;<span class="num" id="1500968">0</span><span class="op" id="1500969">,</span>&nbsp;<span class="builtinfunc" id="1500971">len</span><span class="op" id="1500974">(</span><span class="ident" id="1500975">encodings</span><span class="op" id="1500984">)</span><span class="op" id="1500985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500988">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501051">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501113">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501172">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501217">for</span>&nbsp;<span class="ident" id="1501221">_</span><span class="op" id="1501222">,</span>&nbsp;<span class="ident" id="1501224">encoding</span>&nbsp;<span class="op" id="1501233">:=</span>&nbsp;<span class="keyword" id="1501236">range</span>&nbsp;<span class="ident" id="1501242">encodings</span>&nbsp;<span class="op" id="1501252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501256">encoding</span>&nbsp;<span class="op" id="1501265">=</span>&nbsp;<span class="ident" id="1501267">strings</span><span class="op" id="1501274">.</span><span class="ident" id="1501275">ToLower</span><span class="op" id="1501282">(</span><span class="ident" id="1501283">strings</span><span class="op" id="1501290">.</span><span class="ident" id="1501291">TrimSpace</span><span class="op" id="1501300">(</span><span class="ident" id="1501301">encoding</span><span class="op" id="1501309">)</span><span class="op" id="1501310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501314">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501355">if</span>&nbsp;<span class="ident" id="1501358">encoding</span>&nbsp;<span class="op" id="1501367">==</span>&nbsp;<span class="string" id="1501370">&#34;identity&#34;</span>&nbsp;<span class="op" id="1501381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501386">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501398">if</span>&nbsp;<span class="ident" id="1501401">encoding</span>&nbsp;<span class="op" id="1501410">!=</span>&nbsp;<span class="string" id="1501413">&#34;chunked&#34;</span>&nbsp;<span class="op" id="1501423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501428">return</span>&nbsp;<span class="ident" id="1501435">nil</span><span class="op" id="1501438">,</span>&nbsp;<span class="op" id="1501440">&amp;</span><span class="ident" id="1501441">badStringError</span><span class="op" id="1501455">{</span><span class="string" id="1501456">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="1501487">,</span>&nbsp;<span class="ident" id="1501489">encoding</span><span class="op" id="1501497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501505">te</span>&nbsp;<span class="op" id="1501508">=</span>&nbsp;<span class="ident" id="1501510">te</span><span class="op" id="1501512">[</span><span class="num" id="1501513">0</span>&nbsp;<span class="op" id="1501515">:</span>&nbsp;<span class="builtinfunc" id="1501517">len</span><span class="op" id="1501520">(</span><span class="ident" id="1501521">te</span><span class="op" id="1501523">)</span><span class="op" id="1501524">+</span><span class="num" id="1501525">1</span><span class="op" id="1501526">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501530">te</span><span class="op" id="1501532">[</span><span class="builtinfunc" id="1501533">len</span><span class="op" id="1501536">(</span><span class="ident" id="1501537">te</span><span class="op" id="1501539">)</span><span class="op" id="1501540">-</span><span class="num" id="1501541">1</span><span class="op" id="1501542">]</span>&nbsp;<span class="op" id="1501544">=</span>&nbsp;<span class="ident" id="1501546">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501559">if</span>&nbsp;<span class="builtinfunc" id="1501562">len</span><span class="op" id="1501565">(</span><span class="ident" id="1501566">te</span><span class="op" id="1501568">)</span>&nbsp;<span class="op" id="1501570">&gt;</span>&nbsp;<span class="num" id="1501572">1</span>&nbsp;<span class="op" id="1501574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501578">return</span>&nbsp;<span class="ident" id="1501585">nil</span><span class="op" id="1501588">,</span>&nbsp;<span class="op" id="1501590">&amp;</span><span class="ident" id="1501591">badStringError</span><span class="op" id="1501605">{</span><span class="string" id="1501606">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="1501635">,</span>&nbsp;<span class="ident" id="1501637">strings</span><span class="op" id="1501644">.</span><span class="ident" id="1501645">Join</span><span class="op" id="1501649">(</span><span class="ident" id="1501650">te</span><span class="op" id="1501652">,</span>&nbsp;<span class="string" id="1501654">&#34;,&#34;</span><span class="op" id="1501657">)</span><span class="op" id="1501658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501661">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501664">if</span>&nbsp;<span class="builtinfunc" id="1501667">len</span><span class="op" id="1501670">(</span><span class="ident" id="1501671">te</span><span class="op" id="1501673">)</span>&nbsp;<span class="op" id="1501675">&gt;</span>&nbsp;<span class="num" id="1501677">0</span>&nbsp;<span class="op" id="1501679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501683">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501741">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501797">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1501812">delete</span><span class="op" id="1501818">(</span><span class="ident" id="1501819">header</span><span class="op" id="1501825">,</span>&nbsp;<span class="string" id="1501827">&#34;Content-Length&#34;</span><span class="op" id="1501843">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501847">return</span>&nbsp;<span class="ident" id="1501854">te</span><span class="op" id="1501856">,</span>&nbsp;<span class="ident" id="1501858">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1501863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501867">return</span>&nbsp;<span class="ident" id="1501874">nil</span><span class="op" id="1501877">,</span>&nbsp;<span class="ident" id="1501879">nil</span><br>
<span class="lineno"></span><span class="op" id="1501883">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="1501886">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="1501958">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1502029">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="1502062">func</span>&nbsp;<span class="ident" id="1502067">fixLength</span><span class="op" id="1502076">(</span><span class="ident" id="1502077">isResponse</span>&nbsp;<span class="builtintype" id="1502088">bool</span><span class="op" id="1502092">,</span>&nbsp;<span class="ident" id="1502094">status</span>&nbsp;<span class="builtintype" id="1502101">int</span><span class="op" id="1502104">,</span>&nbsp;<span class="ident" id="1502106">requestMethod</span>&nbsp;<span class="builtintype" id="1502120">string</span><span class="op" id="1502126">,</span>&nbsp;<span class="ident" id="1502128">header</span>&nbsp;<span class="ident" id="1502135">Header</span><span class="op" id="1502141">,</span>&nbsp;<span class="ident" id="1502143">te</span>&nbsp;<span class="op" id="1502146">[</span><span class="op" id="1502147">]</span><span class="builtintype" id="1502148">string</span><span class="op" id="1502154">)</span>&nbsp;<span class="op" id="1502156">(</span><span class="ident" id="1502157">int64</span><span class="op" id="1502162">,</span>&nbsp;<span class="builtintype" id="1502164">error</span><span class="op" id="1502169">)</span>&nbsp;<span class="op" id="1502171">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502175">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502218">if</span>&nbsp;<span class="ident" id="1502221">noBodyExpected</span><span class="op" id="1502235">(</span><span class="ident" id="1502236">requestMethod</span><span class="op" id="1502249">)</span>&nbsp;<span class="op" id="1502251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502255">return</span>&nbsp;<span class="num" id="1502262">0</span><span class="op" id="1502263">,</span>&nbsp;<span class="ident" id="1502265">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502270">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502273">if</span>&nbsp;<span class="ident" id="1502276">status</span><span class="op" id="1502282">/</span><span class="num" id="1502283">100</span>&nbsp;<span class="op" id="1502287">==</span>&nbsp;<span class="num" id="1502290">1</span>&nbsp;<span class="op" id="1502292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502296">return</span>&nbsp;<span class="num" id="1502303">0</span><span class="op" id="1502304">,</span>&nbsp;<span class="ident" id="1502306">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502314">switch</span>&nbsp;<span class="ident" id="1502321">status</span>&nbsp;<span class="op" id="1502328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502331">case</span>&nbsp;<span class="num" id="1502336">204</span><span class="op" id="1502339">,</span>&nbsp;<span class="num" id="1502341">304</span><span class="op" id="1502344">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502348">return</span>&nbsp;<span class="num" id="1502355">0</span><span class="op" id="1502356">,</span>&nbsp;<span class="ident" id="1502358">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502367">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502404">if</span>&nbsp;<span class="ident" id="1502407">chunked</span><span class="op" id="1502414">(</span><span class="ident" id="1502415">te</span><span class="op" id="1502417">)</span>&nbsp;<span class="op" id="1502419">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502423">return</span>&nbsp;<span class="op" id="1502430">-</span><span class="num" id="1502431">1</span><span class="op" id="1502432">,</span>&nbsp;<span class="ident" id="1502434">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502443">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502477">cl</span>&nbsp;<span class="op" id="1502480">:=</span>&nbsp;<span class="ident" id="1502483">strings</span><span class="op" id="1502490">.</span><span class="ident" id="1502491">TrimSpace</span><span class="op" id="1502500">(</span><span class="ident" id="1502501">header</span><span class="op" id="1502507">.</span><span class="ident" id="1502508">get</span><span class="op" id="1502511">(</span><span class="string" id="1502512">&#34;Content-Length&#34;</span><span class="op" id="1502528">)</span><span class="op" id="1502529">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502532">if</span>&nbsp;<span class="ident" id="1502535">cl</span>&nbsp;<span class="op" id="1502538">!=</span>&nbsp;<span class="string" id="1502541">&#34;&#34;</span>&nbsp;<span class="op" id="1502544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502548">n</span><span class="op" id="1502549">,</span>&nbsp;<span class="ident" id="1502551">err</span>&nbsp;<span class="op" id="1502555">:=</span>&nbsp;<span class="ident" id="1502558">parseContentLength</span><span class="op" id="1502576">(</span><span class="ident" id="1502577">cl</span><span class="op" id="1502579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502583">if</span>&nbsp;<span class="ident" id="1502586">err</span>&nbsp;<span class="op" id="1502590">!=</span>&nbsp;<span class="ident" id="1502593">nil</span>&nbsp;<span class="op" id="1502597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502602">return</span>&nbsp;<span class="op" id="1502609">-</span><span class="num" id="1502610">1</span><span class="op" id="1502611">,</span>&nbsp;<span class="ident" id="1502613">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502619">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502623">return</span>&nbsp;<span class="ident" id="1502630">n</span><span class="op" id="1502631">,</span>&nbsp;<span class="ident" id="1502633">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502638">}</span>&nbsp;<span class="keyword" id="1502640">else</span>&nbsp;<span class="op" id="1502645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502649">header</span><span class="op" id="1502655">.</span><span class="ident" id="1502656">Del</span><span class="op" id="1502659">(</span><span class="string" id="1502660">&#34;Content-Length&#34;</span><span class="op" id="1502676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502683">if</span>&nbsp;<span class="op" id="1502686">!</span><span class="ident" id="1502687">isResponse</span>&nbsp;<span class="op" id="1502698">&amp;&amp;</span>&nbsp;<span class="ident" id="1502701">requestMethod</span>&nbsp;<span class="op" id="1502715">==</span>&nbsp;<span class="string" id="1502718">&#34;GET&#34;</span>&nbsp;<span class="op" id="1502724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502728">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502782">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502836">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502891">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502929">return</span>&nbsp;<span class="num" id="1502936">0</span><span class="op" id="1502937">,</span>&nbsp;<span class="ident" id="1502939">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502948">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503024">return</span>&nbsp;<span class="op" id="1503031">-</span><span class="num" id="1503032">1</span><span class="op" id="1503033">,</span>&nbsp;<span class="ident" id="1503035">nil</span><br>
<span class="lineno">500</span><span class="op" id="1503039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1503042">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1503111">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="1503144">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="1503179">func</span>&nbsp;<span class="ident" id="1503184">shouldClose</span><span class="op" id="1503195">(</span><span class="ident" id="1503196">major</span><span class="op" id="1503201">,</span>&nbsp;<span class="ident" id="1503203">minor</span>&nbsp;<span class="builtintype" id="1503209">int</span><span class="op" id="1503212">,</span>&nbsp;<span class="ident" id="1503214">header</span>&nbsp;<span class="ident" id="1503221">Header</span><span class="op" id="1503227">,</span>&nbsp;<span class="ident" id="1503229">removeCloseHeader</span>&nbsp;<span class="builtintype" id="1503247">bool</span><span class="op" id="1503251">)</span>&nbsp;<span class="builtintype" id="1503253">bool</span>&nbsp;<span class="op" id="1503258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503261">if</span>&nbsp;<span class="ident" id="1503264">major</span>&nbsp;<span class="op" id="1503270">&lt;</span>&nbsp;<span class="num" id="1503272">1</span>&nbsp;<span class="op" id="1503274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503278">return</span>&nbsp;<span class="builtintype" id="1503285">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503291">}</span>&nbsp;<span class="keyword" id="1503293">else</span>&nbsp;<span class="keyword" id="1503298">if</span>&nbsp;<span class="ident" id="1503301">major</span>&nbsp;<span class="op" id="1503307">==</span>&nbsp;<span class="num" id="1503310">1</span>&nbsp;<span class="op" id="1503312">&amp;&amp;</span>&nbsp;<span class="ident" id="1503315">minor</span>&nbsp;<span class="op" id="1503321">==</span>&nbsp;<span class="num" id="1503324">0</span>&nbsp;<span class="op" id="1503326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503330">if</span>&nbsp;<span class="op" id="1503333">!</span><span class="ident" id="1503334">strings</span><span class="op" id="1503341">.</span><span class="ident" id="1503342">Contains</span><span class="op" id="1503350">(</span><span class="ident" id="1503351">strings</span><span class="op" id="1503358">.</span><span class="ident" id="1503359">ToLower</span><span class="op" id="1503366">(</span><span class="ident" id="1503367">header</span><span class="op" id="1503373">.</span><span class="ident" id="1503374">get</span><span class="op" id="1503377">(</span><span class="string" id="1503378">&#34;Connection&#34;</span><span class="op" id="1503390">)</span><span class="op" id="1503391">)</span><span class="op" id="1503392">,</span>&nbsp;<span class="string" id="1503394">&#34;keep-alive&#34;</span><span class="op" id="1503406">)</span>&nbsp;<span class="op" id="1503408">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503413">return</span>&nbsp;<span class="builtintype" id="1503420">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503431">return</span>&nbsp;<span class="builtintype" id="1503438">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503445">}</span>&nbsp;<span class="keyword" id="1503447">else</span>&nbsp;<span class="op" id="1503452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503456">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1503521">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503548">if</span>&nbsp;<span class="ident" id="1503551">strings</span><span class="op" id="1503558">.</span><span class="ident" id="1503559">ToLower</span><span class="op" id="1503566">(</span><span class="ident" id="1503567">header</span><span class="op" id="1503573">.</span><span class="ident" id="1503574">get</span><span class="op" id="1503577">(</span><span class="string" id="1503578">&#34;Connection&#34;</span><span class="op" id="1503590">)</span><span class="op" id="1503591">)</span>&nbsp;<span class="op" id="1503593">==</span>&nbsp;<span class="string" id="1503596">&#34;close&#34;</span>&nbsp;<span class="op" id="1503604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503609">if</span>&nbsp;<span class="ident" id="1503612">removeCloseHeader</span>&nbsp;<span class="op" id="1503630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503636">header</span><span class="op" id="1503642">.</span><span class="ident" id="1503643">Del</span><span class="op" id="1503646">(</span><span class="string" id="1503647">&#34;Connection&#34;</span><span class="op" id="1503659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503664">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503669">return</span>&nbsp;<span class="builtintype" id="1503676">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503689">return</span>&nbsp;<span class="builtintype" id="1503696">false</span><br>
<span class="lineno"></span><span class="op" id="1503702">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="1503705">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="1503733">func</span>&nbsp;<span class="ident" id="1503738">fixTrailer</span><span class="op" id="1503748">(</span><span class="ident" id="1503749">header</span>&nbsp;<span class="ident" id="1503756">Header</span><span class="op" id="1503762">,</span>&nbsp;<span class="ident" id="1503764">te</span>&nbsp;<span class="op" id="1503767">[</span><span class="op" id="1503768">]</span><span class="builtintype" id="1503769">string</span><span class="op" id="1503775">)</span>&nbsp;<span class="op" id="1503777">(</span><span class="ident" id="1503778">Header</span><span class="op" id="1503784">,</span>&nbsp;<span class="builtintype" id="1503786">error</span><span class="op" id="1503791">)</span>&nbsp;<span class="op" id="1503793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503796">raw</span>&nbsp;<span class="op" id="1503800">:=</span>&nbsp;<span class="ident" id="1503803">header</span><span class="op" id="1503809">.</span><span class="ident" id="1503810">get</span><span class="op" id="1503813">(</span><span class="string" id="1503814">&#34;Trailer&#34;</span><span class="op" id="1503823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503826">if</span>&nbsp;<span class="ident" id="1503829">raw</span>&nbsp;<span class="op" id="1503833">==</span>&nbsp;<span class="string" id="1503836">&#34;&#34;</span>&nbsp;<span class="op" id="1503839">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503843">return</span>&nbsp;<span class="ident" id="1503850">nil</span><span class="op" id="1503853">,</span>&nbsp;<span class="ident" id="1503855">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503864">header</span><span class="op" id="1503870">.</span><span class="ident" id="1503871">Del</span><span class="op" id="1503874">(</span><span class="string" id="1503875">&#34;Trailer&#34;</span><span class="op" id="1503884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503887">trailer</span>&nbsp;<span class="op" id="1503895">:=</span>&nbsp;<span class="builtinfunc" id="1503898">make</span><span class="op" id="1503902">(</span><span class="ident" id="1503903">Header</span><span class="op" id="1503909">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503912">keys</span>&nbsp;<span class="op" id="1503917">:=</span>&nbsp;<span class="ident" id="1503920">strings</span><span class="op" id="1503927">.</span><span class="ident" id="1503928">Split</span><span class="op" id="1503933">(</span><span class="ident" id="1503934">raw</span><span class="op" id="1503937">,</span>&nbsp;<span class="string" id="1503939">&#34;,&#34;</span><span class="op" id="1503942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1503945">for</span>&nbsp;<span class="ident" id="1503949">_</span><span class="op" id="1503950">,</span>&nbsp;<span class="ident" id="1503952">key</span>&nbsp;<span class="op" id="1503956">:=</span>&nbsp;<span class="keyword" id="1503959">range</span>&nbsp;<span class="ident" id="1503965">keys</span>&nbsp;<span class="op" id="1503970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503974">key</span>&nbsp;<span class="op" id="1503978">=</span>&nbsp;<span class="ident" id="1503980">CanonicalHeaderKey</span><span class="op" id="1503998">(</span><span class="ident" id="1503999">strings</span><span class="op" id="1504006">.</span><span class="ident" id="1504007">TrimSpace</span><span class="op" id="1504016">(</span><span class="ident" id="1504017">key</span><span class="op" id="1504020">)</span><span class="op" id="1504021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504025">switch</span>&nbsp;<span class="ident" id="1504032">key</span>&nbsp;<span class="op" id="1504036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504040">case</span>&nbsp;<span class="string" id="1504045">&#34;Transfer-Encoding&#34;</span><span class="op" id="1504064">,</span>&nbsp;<span class="string" id="1504066">&#34;Trailer&#34;</span><span class="op" id="1504075">,</span>&nbsp;<span class="string" id="1504077">&#34;Content-Length&#34;</span><span class="op" id="1504093">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504098">return</span>&nbsp;<span class="ident" id="1504105">nil</span><span class="op" id="1504108">,</span>&nbsp;<span class="op" id="1504110">&amp;</span><span class="ident" id="1504111">badStringError</span><span class="op" id="1504125">{</span><span class="string" id="1504126">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="1504143">,</span>&nbsp;<span class="ident" id="1504145">key</span><span class="op" id="1504148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504156">trailer</span><span class="op" id="1504163">[</span><span class="ident" id="1504164">key</span><span class="op" id="1504167">]</span>&nbsp;<span class="op" id="1504169">=</span>&nbsp;<span class="ident" id="1504171">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504179">if</span>&nbsp;<span class="builtinfunc" id="1504182">len</span><span class="op" id="1504185">(</span><span class="ident" id="1504186">trailer</span><span class="op" id="1504193">)</span>&nbsp;<span class="op" id="1504195">==</span>&nbsp;<span class="num" id="1504198">0</span>&nbsp;<span class="op" id="1504200">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504204">return</span>&nbsp;<span class="ident" id="1504211">nil</span><span class="op" id="1504214">,</span>&nbsp;<span class="ident" id="1504216">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504224">if</span>&nbsp;<span class="op" id="1504227">!</span><span class="ident" id="1504228">chunked</span><span class="op" id="1504235">(</span><span class="ident" id="1504236">te</span><span class="op" id="1504238">)</span>&nbsp;<span class="op" id="1504240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1504244">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504273">return</span>&nbsp;<span class="ident" id="1504280">nil</span><span class="op" id="1504283">,</span>&nbsp;<span class="ident" id="1504285">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1504307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1504310">return</span>&nbsp;<span class="ident" id="1504317">trailer</span><span class="op" id="1504324">,</span>&nbsp;<span class="ident" id="1504326">nil</span><br>
<span class="lineno"></span><span class="op" id="1504330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1504333">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="1504375">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="1504426">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="1504470">type</span>&nbsp;<span class="ident" id="1504475">body</span>&nbsp;<span class="keyword" id="1504480">struct</span>&nbsp;<span class="op" id="1504487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504490">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504498">io</span><span class="op" id="1504500">.</span><span class="ident" id="1504501">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504509">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504517">interface</span><span class="op" id="1504526">{</span><span class="op" id="1504527">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1504531">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504590">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504598">*</span><span class="ident" id="1504599">bufio</span><span class="op" id="1504604">.</span><span class="ident" id="1504605">Reader</span>&nbsp;<span class="comment" id="1504612">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504662">closing</span>&nbsp;<span class="builtintype" id="1504670">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504684">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504740">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504747">sync</span><span class="op" id="1504751">.</span><span class="ident" id="1504752">Mutex</span>&nbsp;<span class="comment" id="1504758">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1504805">closed</span>&nbsp;<span class="builtintype" id="1504812">bool</span><br>
<span class="lineno">565</span><span class="op" id="1504817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1504820">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="1504892">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1504972">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="1505036">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1505055">var</span>&nbsp;<span class="ident" id="1505059">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="1505081">=</span>&nbsp;<span class="ident" id="1505083">errors</span><span class="op" id="1505089">.</span><span class="ident" id="1505090">New</span><span class="op" id="1505093">(</span><span class="string" id="1505094">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="1505129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505132">func</span>&nbsp;<span class="op" id="1505137">(</span><span class="ident" id="1505138">b</span>&nbsp;<span class="op" id="1505140">*</span><span class="ident" id="1505141">body</span><span class="op" id="1505145">)</span>&nbsp;<span class="ident" id="1505147">Read</span><span class="op" id="1505151">(</span><span class="ident" id="1505152">p</span>&nbsp;<span class="op" id="1505154">[</span><span class="op" id="1505155">]</span><span class="builtintype" id="1505156">byte</span><span class="op" id="1505160">)</span>&nbsp;<span class="op" id="1505162">(</span><span class="ident" id="1505163">n</span>&nbsp;<span class="builtintype" id="1505165">int</span><span class="op" id="1505168">,</span>&nbsp;<span class="ident" id="1505170">err</span>&nbsp;<span class="builtintype" id="1505174">error</span><span class="op" id="1505179">)</span>&nbsp;<span class="op" id="1505181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505184">b</span><span class="op" id="1505185">.</span><span class="ident" id="1505186">mu</span><span class="op" id="1505188">.</span><span class="ident" id="1505189">Lock</span><span class="op" id="1505193">(</span><span class="op" id="1505194">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505197">defer</span>&nbsp;<span class="ident" id="1505203">b</span><span class="op" id="1505204">.</span><span class="ident" id="1505205">mu</span><span class="op" id="1505207">.</span><span class="ident" id="1505208">Unlock</span><span class="op" id="1505214">(</span><span class="op" id="1505215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505218">if</span>&nbsp;<span class="ident" id="1505221">b</span><span class="op" id="1505222">.</span><span class="ident" id="1505223">closed</span>&nbsp;<span class="op" id="1505230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505234">return</span>&nbsp;<span class="num" id="1505241">0</span><span class="op" id="1505242">,</span>&nbsp;<span class="ident" id="1505244">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505270">return</span>&nbsp;<span class="ident" id="1505277">b</span><span class="op" id="1505278">.</span><span class="ident" id="1505279">readLocked</span><span class="op" id="1505289">(</span><span class="ident" id="1505290">p</span><span class="op" id="1505291">)</span><br>
<span class="lineno">580</span><span class="op" id="1505293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1505296">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="1505315">func</span>&nbsp;<span class="op" id="1505320">(</span><span class="ident" id="1505321">b</span>&nbsp;<span class="op" id="1505323">*</span><span class="ident" id="1505324">body</span><span class="op" id="1505328">)</span>&nbsp;<span class="ident" id="1505330">readLocked</span><span class="op" id="1505340">(</span><span class="ident" id="1505341">p</span>&nbsp;<span class="op" id="1505343">[</span><span class="op" id="1505344">]</span><span class="builtintype" id="1505345">byte</span><span class="op" id="1505349">)</span>&nbsp;<span class="op" id="1505351">(</span><span class="ident" id="1505352">n</span>&nbsp;<span class="builtintype" id="1505354">int</span><span class="op" id="1505357">,</span>&nbsp;<span class="ident" id="1505359">err</span>&nbsp;<span class="builtintype" id="1505363">error</span><span class="op" id="1505368">)</span>&nbsp;<span class="op" id="1505370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505373">n</span><span class="op" id="1505374">,</span>&nbsp;<span class="ident" id="1505376">err</span>&nbsp;<span class="op" id="1505380">=</span>&nbsp;<span class="ident" id="1505382">b</span><span class="op" id="1505383">.</span><span class="ident" id="1505384">src</span><span class="op" id="1505387">.</span><span class="ident" id="1505388">Read</span><span class="op" id="1505392">(</span><span class="ident" id="1505393">p</span><span class="op" id="1505394">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505398">if</span>&nbsp;<span class="ident" id="1505401">err</span>&nbsp;<span class="op" id="1505405">==</span>&nbsp;<span class="ident" id="1505408">io</span><span class="op" id="1505410">.</span><span class="ident" id="1505411">EOF</span>&nbsp;<span class="op" id="1505415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505419">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505456">if</span>&nbsp;<span class="ident" id="1505459">b</span><span class="op" id="1505460">.</span><span class="ident" id="1505461">hdr</span>&nbsp;<span class="op" id="1505465">!=</span>&nbsp;<span class="ident" id="1505468">nil</span>&nbsp;<span class="op" id="1505472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505477">if</span>&nbsp;<span class="ident" id="1505480">e</span>&nbsp;<span class="op" id="1505482">:=</span>&nbsp;<span class="ident" id="1505485">b</span><span class="op" id="1505486">.</span><span class="ident" id="1505487">readTrailer</span><span class="op" id="1505498">(</span><span class="op" id="1505499">)</span><span class="op" id="1505500">;</span>&nbsp;<span class="ident" id="1505502">e</span>&nbsp;<span class="op" id="1505504">!=</span>&nbsp;<span class="ident" id="1505507">nil</span>&nbsp;<span class="op" id="1505511">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505517">err</span>&nbsp;<span class="op" id="1505521">=</span>&nbsp;<span class="ident" id="1505523">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505533">b</span><span class="op" id="1505534">.</span><span class="ident" id="1505535">hdr</span>&nbsp;<span class="op" id="1505539">=</span>&nbsp;<span class="ident" id="1505541">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505547">}</span>&nbsp;<span class="keyword" id="1505549">else</span>&nbsp;<span class="op" id="1505554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505559">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505636">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1505695">if</span>&nbsp;<span class="ident" id="1505698">lr</span><span class="op" id="1505700">,</span>&nbsp;<span class="ident" id="1505702">ok</span>&nbsp;<span class="op" id="1505705">:=</span>&nbsp;<span class="ident" id="1505708">b</span><span class="op" id="1505709">.</span><span class="ident" id="1505710">src</span><span class="op" id="1505713">.</span><span class="op" id="1505714">(</span><span class="op" id="1505715">*</span><span class="ident" id="1505716">io</span><span class="op" id="1505718">.</span><span class="ident" id="1505719">LimitedReader</span><span class="op" id="1505732">)</span><span class="op" id="1505733">;</span>&nbsp;<span class="ident" id="1505735">ok</span>&nbsp;<span class="op" id="1505738">&amp;&amp;</span>&nbsp;<span class="ident" id="1505741">lr</span><span class="op" id="1505743">.</span><span class="ident" id="1505744">N</span>&nbsp;<span class="op" id="1505746">&gt;</span>&nbsp;<span class="num" id="1505748">0</span>&nbsp;<span class="op" id="1505750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1505756">err</span>&nbsp;<span class="op" id="1505760">=</span>&nbsp;<span class="ident" id="1505762">io</span><span class="op" id="1505764">.</span><span class="ident" id="1505765">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505789">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1505792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505796">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505858">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505921">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1505981">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506042">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506087">if</span>&nbsp;<span class="ident" id="1506090">err</span>&nbsp;<span class="op" id="1506094">==</span>&nbsp;<span class="ident" id="1506097">nil</span>&nbsp;<span class="op" id="1506101">&amp;&amp;</span>&nbsp;<span class="ident" id="1506104">n</span>&nbsp;<span class="op" id="1506106">&gt;</span>&nbsp;<span class="num" id="1506108">0</span>&nbsp;<span class="op" id="1506110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506114">if</span>&nbsp;<span class="ident" id="1506117">lr</span><span class="op" id="1506119">,</span>&nbsp;<span class="ident" id="1506121">ok</span>&nbsp;<span class="op" id="1506124">:=</span>&nbsp;<span class="ident" id="1506127">b</span><span class="op" id="1506128">.</span><span class="ident" id="1506129">src</span><span class="op" id="1506132">.</span><span class="op" id="1506133">(</span><span class="op" id="1506134">*</span><span class="ident" id="1506135">io</span><span class="op" id="1506137">.</span><span class="ident" id="1506138">LimitedReader</span><span class="op" id="1506151">)</span><span class="op" id="1506152">;</span>&nbsp;<span class="ident" id="1506154">ok</span>&nbsp;<span class="op" id="1506157">&amp;&amp;</span>&nbsp;<span class="ident" id="1506160">lr</span><span class="op" id="1506162">.</span><span class="ident" id="1506163">N</span>&nbsp;<span class="op" id="1506165">==</span>&nbsp;<span class="num" id="1506168">0</span>&nbsp;<span class="op" id="1506170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506175">err</span>&nbsp;<span class="op" id="1506179">=</span>&nbsp;<span class="ident" id="1506181">io</span><span class="op" id="1506183">.</span><span class="ident" id="1506184">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506197">return</span>&nbsp;<span class="ident" id="1506204">n</span><span class="op" id="1506205">,</span>&nbsp;<span class="ident" id="1506207">err</span><br>
<span class="lineno"></span><span class="op" id="1506211">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="1506214">var</span>&nbsp;<span class="op" id="1506218">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506221">singleCRLF</span>&nbsp;<span class="op" id="1506232">=</span>&nbsp;<span class="op" id="1506234">[</span><span class="op" id="1506235">]</span><span class="builtintype" id="1506236">byte</span><span class="op" id="1506240">(</span><span class="string" id="1506241">&#34;\r\n&#34;</span><span class="op" id="1506247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506250">doubleCRLF</span>&nbsp;<span class="op" id="1506261">=</span>&nbsp;<span class="op" id="1506263">[</span><span class="op" id="1506264">]</span><span class="builtintype" id="1506265">byte</span><span class="op" id="1506269">(</span><span class="string" id="1506270">&#34;\r\n\r\n&#34;</span><span class="op" id="1506280">)</span><br>
<span class="lineno"></span><span class="op" id="1506282">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="1506285">func</span>&nbsp;<span class="ident" id="1506290">seeUpcomingDoubleCRLF</span><span class="op" id="1506311">(</span><span class="ident" id="1506312">r</span>&nbsp;<span class="op" id="1506314">*</span><span class="ident" id="1506315">bufio</span><span class="op" id="1506320">.</span><span class="ident" id="1506321">Reader</span><span class="op" id="1506327">)</span>&nbsp;<span class="builtintype" id="1506329">bool</span>&nbsp;<span class="op" id="1506334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506337">for</span>&nbsp;<span class="ident" id="1506341">peekSize</span>&nbsp;<span class="op" id="1506350">:=</span>&nbsp;<span class="num" id="1506353">4</span><span class="op" id="1506354">;</span>&nbsp;<span class="op" id="1506356">;</span>&nbsp;<span class="ident" id="1506358">peekSize</span><span class="op" id="1506366">++</span>&nbsp;<span class="op" id="1506369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506373">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506422">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506474">buf</span><span class="op" id="1506477">,</span>&nbsp;<span class="ident" id="1506479">err</span>&nbsp;<span class="op" id="1506483">:=</span>&nbsp;<span class="ident" id="1506486">r</span><span class="op" id="1506487">.</span><span class="ident" id="1506488">Peek</span><span class="op" id="1506492">(</span><span class="ident" id="1506493">peekSize</span><span class="op" id="1506501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506505">if</span>&nbsp;<span class="ident" id="1506508">bytes</span><span class="op" id="1506513">.</span><span class="ident" id="1506514">HasSuffix</span><span class="op" id="1506523">(</span><span class="ident" id="1506524">buf</span><span class="op" id="1506527">,</span>&nbsp;<span class="ident" id="1506529">doubleCRLF</span><span class="op" id="1506539">)</span>&nbsp;<span class="op" id="1506541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506546">return</span>&nbsp;<span class="builtintype" id="1506553">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506564">if</span>&nbsp;<span class="ident" id="1506567">err</span>&nbsp;<span class="op" id="1506571">!=</span>&nbsp;<span class="ident" id="1506574">nil</span>&nbsp;<span class="op" id="1506578">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506583">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506597">return</span>&nbsp;<span class="builtintype" id="1506604">false</span><br>
<span class="lineno"></span><span class="op" id="1506610">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="1506613">var</span>&nbsp;<span class="ident" id="1506617">errTrailerEOF</span>&nbsp;<span class="op" id="1506631">=</span>&nbsp;<span class="ident" id="1506633">errors</span><span class="op" id="1506639">.</span><span class="ident" id="1506640">New</span><span class="op" id="1506643">(</span><span class="string" id="1506644">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="1506682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1506685">func</span>&nbsp;<span class="op" id="1506690">(</span><span class="ident" id="1506691">b</span>&nbsp;<span class="op" id="1506693">*</span><span class="ident" id="1506694">body</span><span class="op" id="1506698">)</span>&nbsp;<span class="ident" id="1506700">readTrailer</span><span class="op" id="1506711">(</span><span class="op" id="1506712">)</span>&nbsp;<span class="builtintype" id="1506714">error</span>&nbsp;<span class="op" id="1506720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506723">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506772">buf</span><span class="op" id="1506775">,</span>&nbsp;<span class="ident" id="1506777">err</span>&nbsp;<span class="op" id="1506781">:=</span>&nbsp;<span class="ident" id="1506784">b</span><span class="op" id="1506785">.</span><span class="ident" id="1506786">r</span><span class="op" id="1506787">.</span><span class="ident" id="1506788">Peek</span><span class="op" id="1506792">(</span><span class="num" id="1506793">2</span><span class="op" id="1506794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506797">if</span>&nbsp;<span class="ident" id="1506800">bytes</span><span class="op" id="1506805">.</span><span class="ident" id="1506806">Equal</span><span class="op" id="1506811">(</span><span class="ident" id="1506812">buf</span><span class="op" id="1506815">,</span>&nbsp;<span class="ident" id="1506817">singleCRLF</span><span class="op" id="1506827">)</span>&nbsp;<span class="op" id="1506829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506833">b</span><span class="op" id="1506834">.</span><span class="ident" id="1506835">r</span><span class="op" id="1506836">.</span><span class="ident" id="1506837">ReadByte</span><span class="op" id="1506845">(</span><span class="op" id="1506846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506850">b</span><span class="op" id="1506851">.</span><span class="ident" id="1506852">r</span><span class="op" id="1506853">.</span><span class="ident" id="1506854">ReadByte</span><span class="op" id="1506862">(</span><span class="op" id="1506863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506867">return</span>&nbsp;<span class="ident" id="1506874">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506882">if</span>&nbsp;<span class="builtinfunc" id="1506885">len</span><span class="op" id="1506888">(</span><span class="ident" id="1506889">buf</span><span class="op" id="1506892">)</span>&nbsp;<span class="op" id="1506894">&lt;</span>&nbsp;<span class="num" id="1506896">2</span>&nbsp;<span class="op" id="1506898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506902">return</span>&nbsp;<span class="ident" id="1506909">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506927">if</span>&nbsp;<span class="ident" id="1506930">err</span>&nbsp;<span class="op" id="1506934">!=</span>&nbsp;<span class="ident" id="1506937">nil</span>&nbsp;<span class="op" id="1506941">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506945">return</span>&nbsp;<span class="ident" id="1506952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1506957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1506961">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507025">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507085">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507149">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507211">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507275">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507339">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507402">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507476">if</span>&nbsp;<span class="op" id="1507479">!</span><span class="ident" id="1507480">seeUpcomingDoubleCRLF</span><span class="op" id="1507501">(</span><span class="ident" id="1507502">b</span><span class="op" id="1507503">.</span><span class="ident" id="1507504">r</span><span class="op" id="1507505">)</span>&nbsp;<span class="op" id="1507507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507511">return</span>&nbsp;<span class="ident" id="1507518">errors</span><span class="op" id="1507524">.</span><span class="ident" id="1507525">New</span><span class="op" id="1507528">(</span><span class="string" id="1507529">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="1507581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507588">hdr</span><span class="op" id="1507591">,</span>&nbsp;<span class="ident" id="1507593">err</span>&nbsp;<span class="op" id="1507597">:=</span>&nbsp;<span class="ident" id="1507600">textproto</span><span class="op" id="1507609">.</span><span class="ident" id="1507610">NewReader</span><span class="op" id="1507619">(</span><span class="ident" id="1507620">b</span><span class="op" id="1507621">.</span><span class="ident" id="1507622">r</span><span class="op" id="1507623">)</span><span class="op" id="1507624">.</span><span class="ident" id="1507625">ReadMIMEHeader</span><span class="op" id="1507639">(</span><span class="op" id="1507640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507643">if</span>&nbsp;<span class="ident" id="1507646">err</span>&nbsp;<span class="op" id="1507650">!=</span>&nbsp;<span class="ident" id="1507653">nil</span>&nbsp;<span class="op" id="1507657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507661">if</span>&nbsp;<span class="ident" id="1507664">err</span>&nbsp;<span class="op" id="1507668">==</span>&nbsp;<span class="ident" id="1507671">io</span><span class="op" id="1507673">.</span><span class="ident" id="1507674">EOF</span>&nbsp;<span class="op" id="1507678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507683">return</span>&nbsp;<span class="ident" id="1507690">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507706">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507710">return</span>&nbsp;<span class="ident" id="1507717">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507725">switch</span>&nbsp;<span class="ident" id="1507732">rr</span>&nbsp;<span class="op" id="1507735">:=</span>&nbsp;<span class="ident" id="1507738">b</span><span class="op" id="1507739">.</span><span class="ident" id="1507740">hdr</span><span class="op" id="1507743">.</span><span class="op" id="1507744">(</span><span class="keyword" id="1507745">type</span><span class="op" id="1507749">)</span>&nbsp;<span class="op" id="1507751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507754">case</span>&nbsp;<span class="op" id="1507759">*</span><span class="ident" id="1507760">Request</span><span class="op" id="1507767">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507771">mergeSetHeader</span><span class="op" id="1507785">(</span><span class="op" id="1507786">&amp;</span><span class="ident" id="1507787">rr</span><span class="op" id="1507789">.</span><span class="ident" id="1507790">Trailer</span><span class="op" id="1507797">,</span>&nbsp;<span class="ident" id="1507799">Header</span><span class="op" id="1507805">(</span><span class="ident" id="1507806">hdr</span><span class="op" id="1507809">)</span><span class="op" id="1507810">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507813">case</span>&nbsp;<span class="op" id="1507818">*</span><span class="ident" id="1507819">Response</span><span class="op" id="1507827">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507831">mergeSetHeader</span><span class="op" id="1507845">(</span><span class="op" id="1507846">&amp;</span><span class="ident" id="1507847">rr</span><span class="op" id="1507849">.</span><span class="ident" id="1507850">Trailer</span><span class="op" id="1507857">,</span>&nbsp;<span class="ident" id="1507859">Header</span><span class="op" id="1507865">(</span><span class="ident" id="1507866">hdr</span><span class="op" id="1507869">)</span><span class="op" id="1507870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507876">return</span>&nbsp;<span class="ident" id="1507883">nil</span><br>
<span class="lineno"></span><span class="op" id="1507887">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="1507890">func</span>&nbsp;<span class="ident" id="1507895">mergeSetHeader</span><span class="op" id="1507909">(</span><span class="ident" id="1507910">dst</span>&nbsp;<span class="op" id="1507914">*</span><span class="ident" id="1507915">Header</span><span class="op" id="1507921">,</span>&nbsp;<span class="ident" id="1507923">src</span>&nbsp;<span class="ident" id="1507927">Header</span><span class="op" id="1507933">)</span>&nbsp;<span class="op" id="1507935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507938">if</span>&nbsp;<span class="op" id="1507941">*</span><span class="ident" id="1507942">dst</span>&nbsp;<span class="op" id="1507946">==</span>&nbsp;<span class="ident" id="1507949">nil</span>&nbsp;<span class="op" id="1507953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507957">*</span><span class="ident" id="1507958">dst</span>&nbsp;<span class="op" id="1507962">=</span>&nbsp;<span class="ident" id="1507964">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507970">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507981">for</span>&nbsp;<span class="ident" id="1507985">k</span><span class="op" id="1507986">,</span>&nbsp;<span class="ident" id="1507988">vv</span>&nbsp;<span class="op" id="1507991">:=</span>&nbsp;<span class="keyword" id="1507994">range</span>&nbsp;<span class="ident" id="1508000">src</span>&nbsp;<span class="op" id="1508004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508008">(</span><span class="op" id="1508009">*</span><span class="ident" id="1508010">dst</span><span class="op" id="1508013">)</span><span class="op" id="1508014">[</span><span class="ident" id="1508015">k</span><span class="op" id="1508016">]</span>&nbsp;<span class="op" id="1508018">=</span>&nbsp;<span class="ident" id="1508020">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508024">}</span><br>
<span class="lineno"></span><span class="op" id="1508026">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="1508029">func</span>&nbsp;<span class="op" id="1508034">(</span><span class="ident" id="1508035">b</span>&nbsp;<span class="op" id="1508037">*</span><span class="ident" id="1508038">body</span><span class="op" id="1508042">)</span>&nbsp;<span class="ident" id="1508044">Close</span><span class="op" id="1508049">(</span><span class="op" id="1508050">)</span>&nbsp;<span class="builtintype" id="1508052">error</span>&nbsp;<span class="op" id="1508058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508061">b</span><span class="op" id="1508062">.</span><span class="ident" id="1508063">mu</span><span class="op" id="1508065">.</span><span class="ident" id="1508066">Lock</span><span class="op" id="1508070">(</span><span class="op" id="1508071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508074">defer</span>&nbsp;<span class="ident" id="1508080">b</span><span class="op" id="1508081">.</span><span class="ident" id="1508082">mu</span><span class="op" id="1508084">.</span><span class="ident" id="1508085">Unlock</span><span class="op" id="1508091">(</span><span class="op" id="1508092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508095">if</span>&nbsp;<span class="ident" id="1508098">b</span><span class="op" id="1508099">.</span><span class="ident" id="1508100">closed</span>&nbsp;<span class="op" id="1508107">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508111">return</span>&nbsp;<span class="ident" id="1508118">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508126">var</span>&nbsp;<span class="ident" id="1508130">err</span>&nbsp;<span class="builtintype" id="1508134">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508141">switch</span>&nbsp;<span class="op" id="1508148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508151">case</span>&nbsp;<span class="ident" id="1508156">b</span><span class="op" id="1508157">.</span><span class="ident" id="1508158">hdr</span>&nbsp;<span class="op" id="1508162">==</span>&nbsp;<span class="ident" id="1508165">nil</span>&nbsp;<span class="op" id="1508169">&amp;&amp;</span>&nbsp;<span class="ident" id="1508172">b</span><span class="op" id="1508173">.</span><span class="ident" id="1508174">closing</span><span class="op" id="1508181">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508185">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508234">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508266">default</span><span class="op" id="1508273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508277">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508341">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508394">_</span><span class="op" id="1508395">,</span>&nbsp;<span class="ident" id="1508397">err</span>&nbsp;<span class="op" id="1508401">=</span>&nbsp;<span class="ident" id="1508403">io</span><span class="op" id="1508405">.</span><span class="ident" id="1508406">Copy</span><span class="op" id="1508410">(</span><span class="ident" id="1508411">ioutil</span><span class="op" id="1508417">.</span><span class="ident" id="1508418">Discard</span><span class="op" id="1508425">,</span>&nbsp;<span class="ident" id="1508427">bodyLocked</span><span class="op" id="1508437">{</span><span class="ident" id="1508438">b</span><span class="op" id="1508439">}</span><span class="op" id="1508440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508446">b</span><span class="op" id="1508447">.</span><span class="ident" id="1508448">closed</span>&nbsp;<span class="op" id="1508455">=</span>&nbsp;<span class="builtintype" id="1508457">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508463">return</span>&nbsp;<span class="ident" id="1508470">err</span><br>
<span class="lineno"></span><span class="op" id="1508474">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1508477">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1508545">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="1508562">type</span>&nbsp;<span class="ident" id="1508567">bodyLocked</span>&nbsp;<span class="keyword" id="1508578">struct</span>&nbsp;<span class="op" id="1508585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508588">b</span>&nbsp;<span class="op" id="1508590">*</span><span class="ident" id="1508591">body</span><br>
<span class="lineno">715</span><span class="op" id="1508596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508599">func</span>&nbsp;<span class="op" id="1508604">(</span><span class="ident" id="1508605">bl</span>&nbsp;<span class="ident" id="1508608">bodyLocked</span><span class="op" id="1508618">)</span>&nbsp;<span class="ident" id="1508620">Read</span><span class="op" id="1508624">(</span><span class="ident" id="1508625">p</span>&nbsp;<span class="op" id="1508627">[</span><span class="op" id="1508628">]</span><span class="builtintype" id="1508629">byte</span><span class="op" id="1508633">)</span>&nbsp;<span class="op" id="1508635">(</span><span class="ident" id="1508636">n</span>&nbsp;<span class="builtintype" id="1508638">int</span><span class="op" id="1508641">,</span>&nbsp;<span class="ident" id="1508643">err</span>&nbsp;<span class="builtintype" id="1508647">error</span><span class="op" id="1508652">)</span>&nbsp;<span class="op" id="1508654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508657">if</span>&nbsp;<span class="ident" id="1508660">bl</span><span class="op" id="1508662">.</span><span class="ident" id="1508663">b</span><span class="op" id="1508664">.</span><span class="ident" id="1508665">closed</span>&nbsp;<span class="op" id="1508672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508676">return</span>&nbsp;<span class="num" id="1508683">0</span><span class="op" id="1508684">,</span>&nbsp;<span class="ident" id="1508686">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508712">return</span>&nbsp;<span class="ident" id="1508719">bl</span><span class="op" id="1508721">.</span><span class="ident" id="1508722">b</span><span class="op" id="1508723">.</span><span class="ident" id="1508724">readLocked</span><span class="op" id="1508734">(</span><span class="ident" id="1508735">p</span><span class="op" id="1508736">)</span><br>
<span class="lineno"></span><span class="op" id="1508738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1508741">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="1508814">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1508852">func</span>&nbsp;<span class="ident" id="1508857">parseContentLength</span><span class="op" id="1508875">(</span><span class="ident" id="1508876">cl</span>&nbsp;<span class="builtintype" id="1508879">string</span><span class="op" id="1508885">)</span>&nbsp;<span class="op" id="1508887">(</span><span class="ident" id="1508888">int64</span><span class="op" id="1508893">,</span>&nbsp;<span class="builtintype" id="1508895">error</span><span class="op" id="1508900">)</span>&nbsp;<span class="op" id="1508902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508905">cl</span>&nbsp;<span class="op" id="1508908">=</span>&nbsp;<span class="ident" id="1508910">strings</span><span class="op" id="1508917">.</span><span class="ident" id="1508918">TrimSpace</span><span class="op" id="1508927">(</span><span class="ident" id="1508928">cl</span><span class="op" id="1508930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508933">if</span>&nbsp;<span class="ident" id="1508936">cl</span>&nbsp;<span class="op" id="1508939">==</span>&nbsp;<span class="string" id="1508942">&#34;&#34;</span>&nbsp;<span class="op" id="1508945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508949">return</span>&nbsp;<span class="op" id="1508956">-</span><span class="num" id="1508957">1</span><span class="op" id="1508958">,</span>&nbsp;<span class="ident" id="1508960">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508968">n</span><span class="op" id="1508969">,</span>&nbsp;<span class="ident" id="1508971">err</span>&nbsp;<span class="op" id="1508975">:=</span>&nbsp;<span class="ident" id="1508978">strconv</span><span class="op" id="1508985">.</span><span class="ident" id="1508986">ParseInt</span><span class="op" id="1508994">(</span><span class="ident" id="1508995">cl</span><span class="op" id="1508997">,</span>&nbsp;<span class="num" id="1508999">10</span><span class="op" id="1509001">,</span>&nbsp;<span class="num" id="1509003">64</span><span class="op" id="1509005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509008">if</span>&nbsp;<span class="ident" id="1509011">err</span>&nbsp;<span class="op" id="1509015">!=</span>&nbsp;<span class="ident" id="1509018">nil</span>&nbsp;<span class="op" id="1509022">||</span>&nbsp;<span class="ident" id="1509025">n</span>&nbsp;<span class="op" id="1509027">&lt;</span>&nbsp;<span class="num" id="1509029">0</span>&nbsp;<span class="op" id="1509031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509035">return</span>&nbsp;<span class="num" id="1509042">0</span><span class="op" id="1509043">,</span>&nbsp;<span class="op" id="1509045">&amp;</span><span class="ident" id="1509046">badStringError</span><span class="op" id="1509060">{</span><span class="string" id="1509061">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="1509081">,</span>&nbsp;<span class="ident" id="1509083">cl</span><span class="op" id="1509085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509088">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509091">return</span>&nbsp;<span class="ident" id="1509098">n</span><span class="op" id="1509099">,</span>&nbsp;<span class="ident" id="1509101">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="1509106">}</span>
</div>
</body>
</html>
