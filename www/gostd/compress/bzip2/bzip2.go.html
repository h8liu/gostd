<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5172078">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5172133">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5172187">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5172238">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5172287">package</span>&nbsp;<span class="ident" id="5172295">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5172302">import</span>&nbsp;<span class="string" id="5172309">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5172315">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5172394">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5172445">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5172501">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5172549">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5172617">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5172643">type</span>&nbsp;<span class="ident" id="5172648">StructuralError</span>&nbsp;<span class="builtintype" id="5172664">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5172672">func</span>&nbsp;<span class="op" id="5172677">(</span><span class="ident" id="5172678">s</span>&nbsp;<span class="ident" id="5172680">StructuralError</span><span class="op" id="5172695">)</span>&nbsp;<span class="ident" id="5172697">Error</span><span class="op" id="5172702">(</span><span class="op" id="5172703">)</span>&nbsp;<span class="builtintype" id="5172705">string</span>&nbsp;<span class="op" id="5172712">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172715">return</span>&nbsp;<span class="string" id="5172722">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5172745">+</span>&nbsp;<span class="builtintype" id="5172747">string</span><span class="op" id="5172753">(</span><span class="ident" id="5172754">s</span><span class="op" id="5172755">)</span><br>
<span class="lineno"></span><span class="op" id="5172757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172760">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5172808">type</span>&nbsp;<span class="ident" id="5172813">reader</span>&nbsp;<span class="keyword" id="5172820">struct</span>&nbsp;<span class="op" id="5172827">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172830">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172843">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172854">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172867">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172875">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172888">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172896">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5172909">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172917">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172930">bool</span>&nbsp;<span class="comment" id="5172935">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172980">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5172993">int</span>&nbsp;&nbsp;<span class="comment" id="5172998">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173039">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5173052">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173058">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173071">[</span><span class="op" id="5173072">]</span><span class="builtintype" id="5173073">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173081">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173126">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173139">[</span><span class="num" id="5173140">256</span><span class="op" id="5173143">]</span><span class="builtintype" id="5173144">uint</span>&nbsp;<span class="comment" id="5173149">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173188">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173201">[</span><span class="op" id="5173202">]</span><span class="builtintype" id="5173203">uint32</span>&nbsp;&nbsp;<span class="comment" id="5173211">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173305">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5173318">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173328">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173370">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173382">[</span><span class="op" id="5173383">]</span><span class="builtintype" id="5173384">uint32</span>&nbsp;<span class="comment" id="5173391">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173440">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5173452">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173461">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173499">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5173511">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173520">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173550">byteRepeats</span>&nbsp;<span class="builtintype" id="5173562">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173571">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173615">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5173627">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173636">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5173683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5173686">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5173758">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5173805">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5173867">func</span>&nbsp;<span class="ident" id="5173872">NewReader</span><span class="op" id="5173881">(</span><span class="ident" id="5173882">r</span>&nbsp;<span class="ident" id="5173884">io</span><span class="op" id="5173886">.</span><span class="ident" id="5173887">Reader</span><span class="op" id="5173893">)</span>&nbsp;<span class="ident" id="5173895">io</span><span class="op" id="5173897">.</span><span class="ident" id="5173898">Reader</span>&nbsp;<span class="op" id="5173905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173908">bz2</span>&nbsp;<span class="op" id="5173912">:=</span>&nbsp;<span class="builtinfunc" id="5173915">new</span><span class="op" id="5173918">(</span><span class="ident" id="5173919">reader</span><span class="op" id="5173925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173928">bz2</span><span class="op" id="5173931">.</span><span class="ident" id="5173932">br</span>&nbsp;<span class="op" id="5173935">=</span>&nbsp;<span class="ident" id="5173937">newBitReader</span><span class="op" id="5173949">(</span><span class="ident" id="5173950">r</span><span class="op" id="5173951">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173954">return</span>&nbsp;<span class="ident" id="5173961">bz2</span><br>
<span class="lineno"></span><span class="op" id="5173965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5173968">const</span>&nbsp;<span class="ident" id="5173974">bzip2FileMagic</span>&nbsp;<span class="op" id="5173989">=</span>&nbsp;<span class="num" id="5173991">0x425a</span>&nbsp;<span class="comment" id="5173998">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5174006">const</span>&nbsp;<span class="ident" id="5174012">bzip2BlockMagic</span>&nbsp;<span class="op" id="5174028">=</span>&nbsp;<span class="num" id="5174030">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5174045">const</span>&nbsp;<span class="ident" id="5174051">bzip2FinalMagic</span>&nbsp;<span class="op" id="5174067">=</span>&nbsp;<span class="num" id="5174069">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5174085">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5174119">func</span>&nbsp;<span class="op" id="5174124">(</span><span class="ident" id="5174125">bz2</span>&nbsp;<span class="op" id="5174129">*</span><span class="ident" id="5174130">reader</span><span class="op" id="5174136">)</span>&nbsp;<span class="ident" id="5174138">setup</span><span class="op" id="5174143">(</span><span class="ident" id="5174144">needMagic</span>&nbsp;<span class="builtintype" id="5174154">bool</span><span class="op" id="5174158">)</span>&nbsp;<span class="builtintype" id="5174160">error</span>&nbsp;<span class="op" id="5174166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174169">br</span>&nbsp;<span class="op" id="5174172">:=</span>&nbsp;<span class="op" id="5174175">&amp;</span><span class="ident" id="5174176">bz2</span><span class="op" id="5174179">.</span><span class="ident" id="5174180">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174185">if</span>&nbsp;<span class="ident" id="5174188">needMagic</span>&nbsp;<span class="op" id="5174198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174202">magic</span>&nbsp;<span class="op" id="5174208">:=</span>&nbsp;<span class="ident" id="5174211">br</span><span class="op" id="5174213">.</span><span class="ident" id="5174214">ReadBits</span><span class="op" id="5174222">(</span><span class="num" id="5174223">16</span><span class="op" id="5174225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174229">if</span>&nbsp;<span class="ident" id="5174232">magic</span>&nbsp;<span class="op" id="5174238">!=</span>&nbsp;<span class="ident" id="5174241">bzip2FileMagic</span>&nbsp;<span class="op" id="5174256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174261">return</span>&nbsp;<span class="ident" id="5174268">StructuralError</span><span class="op" id="5174283">(</span><span class="string" id="5174284">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5174301">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174312">t</span>&nbsp;<span class="op" id="5174314">:=</span>&nbsp;<span class="ident" id="5174317">br</span><span class="op" id="5174319">.</span><span class="ident" id="5174320">ReadBits</span><span class="op" id="5174328">(</span><span class="num" id="5174329">8</span><span class="op" id="5174330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174333">if</span>&nbsp;<span class="ident" id="5174336">t</span>&nbsp;<span class="op" id="5174338">!=</span>&nbsp;<span class="string" id="5174341">&#39;h&#39;</span>&nbsp;<span class="op" id="5174345">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174349">return</span>&nbsp;<span class="ident" id="5174356">StructuralError</span><span class="op" id="5174371">(</span><span class="string" id="5174372">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5174402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174409">level</span>&nbsp;<span class="op" id="5174415">:=</span>&nbsp;<span class="ident" id="5174418">br</span><span class="op" id="5174420">.</span><span class="ident" id="5174421">ReadBits</span><span class="op" id="5174429">(</span><span class="num" id="5174430">8</span><span class="op" id="5174431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174434">if</span>&nbsp;<span class="ident" id="5174437">level</span>&nbsp;<span class="op" id="5174443">&lt;</span>&nbsp;<span class="string" id="5174445">&#39;1&#39;</span>&nbsp;<span class="op" id="5174449">||</span>&nbsp;<span class="ident" id="5174452">level</span>&nbsp;<span class="op" id="5174458">&gt;</span>&nbsp;<span class="string" id="5174460">&#39;9&#39;</span>&nbsp;<span class="op" id="5174464">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174468">return</span>&nbsp;<span class="ident" id="5174475">StructuralError</span><span class="op" id="5174490">(</span><span class="string" id="5174491">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5174518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174525">bz2</span><span class="op" id="5174528">.</span><span class="ident" id="5174529">fileCRC</span>&nbsp;<span class="op" id="5174537">=</span>&nbsp;<span class="num" id="5174539">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174542">bz2</span><span class="op" id="5174545">.</span><span class="ident" id="5174546">blockSize</span>&nbsp;<span class="op" id="5174556">=</span>&nbsp;<span class="num" id="5174558">100</span>&nbsp;<span class="op" id="5174562">*</span>&nbsp;<span class="num" id="5174564">1024</span>&nbsp;<span class="op" id="5174569">*</span>&nbsp;<span class="op" id="5174571">(</span><span class="builtintype" id="5174572">int</span><span class="op" id="5174575">(</span><span class="ident" id="5174576">level</span><span class="op" id="5174581">)</span>&nbsp;<span class="op" id="5174583">-</span>&nbsp;<span class="string" id="5174585">&#39;0&#39;</span><span class="op" id="5174588">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174591">if</span>&nbsp;<span class="ident" id="5174594">bz2</span><span class="op" id="5174597">.</span><span class="ident" id="5174598">blockSize</span>&nbsp;<span class="op" id="5174608">&gt;</span>&nbsp;<span class="builtinfunc" id="5174610">len</span><span class="op" id="5174613">(</span><span class="ident" id="5174614">bz2</span><span class="op" id="5174617">.</span><span class="ident" id="5174618">tt</span><span class="op" id="5174620">)</span>&nbsp;<span class="op" id="5174622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174626">bz2</span><span class="op" id="5174629">.</span><span class="ident" id="5174630">tt</span>&nbsp;<span class="op" id="5174633">=</span>&nbsp;<span class="builtinfunc" id="5174635">make</span><span class="op" id="5174639">(</span><span class="op" id="5174640">[</span><span class="op" id="5174641">]</span><span class="builtintype" id="5174642">uint32</span><span class="op" id="5174648">,</span>&nbsp;<span class="ident" id="5174650">bz2</span><span class="op" id="5174653">.</span><span class="ident" id="5174654">blockSize</span><span class="op" id="5174663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174669">return</span>&nbsp;<span class="ident" id="5174676">nil</span><br>
<span class="lineno"></span><span class="op" id="5174680">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5174683">func</span>&nbsp;<span class="op" id="5174688">(</span><span class="ident" id="5174689">bz2</span>&nbsp;<span class="op" id="5174693">*</span><span class="ident" id="5174694">reader</span><span class="op" id="5174700">)</span>&nbsp;<span class="ident" id="5174702">Read</span><span class="op" id="5174706">(</span><span class="ident" id="5174707">buf</span>&nbsp;<span class="op" id="5174711">[</span><span class="op" id="5174712">]</span><span class="builtintype" id="5174713">byte</span><span class="op" id="5174717">)</span>&nbsp;<span class="op" id="5174719">(</span><span class="ident" id="5174720">n</span>&nbsp;<span class="builtintype" id="5174722">int</span><span class="op" id="5174725">,</span>&nbsp;<span class="ident" id="5174727">err</span>&nbsp;<span class="builtintype" id="5174731">error</span><span class="op" id="5174736">)</span>&nbsp;<span class="op" id="5174738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174741">if</span>&nbsp;<span class="ident" id="5174744">bz2</span><span class="op" id="5174747">.</span><span class="ident" id="5174748">eof</span>&nbsp;<span class="op" id="5174752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174756">return</span>&nbsp;<span class="num" id="5174763">0</span><span class="op" id="5174764">,</span>&nbsp;<span class="ident" id="5174766">io</span><span class="op" id="5174768">.</span><span class="ident" id="5174769">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174774">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174778">if</span>&nbsp;<span class="op" id="5174781">!</span><span class="ident" id="5174782">bz2</span><span class="op" id="5174785">.</span><span class="ident" id="5174786">setupDone</span>&nbsp;<span class="op" id="5174796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174800">err</span>&nbsp;<span class="op" id="5174804">=</span>&nbsp;<span class="ident" id="5174806">bz2</span><span class="op" id="5174809">.</span><span class="ident" id="5174810">setup</span><span class="op" id="5174815">(</span><span class="builtintype" id="5174816">true</span><span class="op" id="5174820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174824">brErr</span>&nbsp;<span class="op" id="5174830">:=</span>&nbsp;<span class="ident" id="5174833">bz2</span><span class="op" id="5174836">.</span><span class="ident" id="5174837">br</span><span class="op" id="5174839">.</span><span class="ident" id="5174840">Err</span><span class="op" id="5174843">(</span><span class="op" id="5174844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174848">if</span>&nbsp;<span class="ident" id="5174851">brErr</span>&nbsp;<span class="op" id="5174857">!=</span>&nbsp;<span class="ident" id="5174860">nil</span>&nbsp;<span class="op" id="5174864">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174869">err</span>&nbsp;<span class="op" id="5174873">=</span>&nbsp;<span class="ident" id="5174875">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174887">if</span>&nbsp;<span class="ident" id="5174890">err</span>&nbsp;<span class="op" id="5174894">!=</span>&nbsp;<span class="ident" id="5174897">nil</span>&nbsp;<span class="op" id="5174901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174906">return</span>&nbsp;<span class="num" id="5174913">0</span><span class="op" id="5174914">,</span>&nbsp;<span class="ident" id="5174916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174922">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174926">bz2</span><span class="op" id="5174929">.</span><span class="ident" id="5174930">setupDone</span>&nbsp;<span class="op" id="5174940">=</span>&nbsp;<span class="builtintype" id="5174942">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174952">n</span><span class="op" id="5174953">,</span>&nbsp;<span class="ident" id="5174955">err</span>&nbsp;<span class="op" id="5174959">=</span>&nbsp;<span class="ident" id="5174961">bz2</span><span class="op" id="5174964">.</span><span class="ident" id="5174965">read</span><span class="op" id="5174969">(</span><span class="ident" id="5174970">buf</span><span class="op" id="5174973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174976">brErr</span>&nbsp;<span class="op" id="5174982">:=</span>&nbsp;<span class="ident" id="5174985">bz2</span><span class="op" id="5174988">.</span><span class="ident" id="5174989">br</span><span class="op" id="5174991">.</span><span class="ident" id="5174992">Err</span><span class="op" id="5174995">(</span><span class="op" id="5174996">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174999">if</span>&nbsp;<span class="ident" id="5175002">brErr</span>&nbsp;<span class="op" id="5175008">!=</span>&nbsp;<span class="ident" id="5175011">nil</span>&nbsp;<span class="op" id="5175015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175019">err</span>&nbsp;<span class="op" id="5175023">=</span>&nbsp;<span class="ident" id="5175025">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175035">return</span><br>
<span class="lineno"></span><span class="op" id="5175042">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5175045">func</span>&nbsp;<span class="op" id="5175050">(</span><span class="ident" id="5175051">bz2</span>&nbsp;<span class="op" id="5175055">*</span><span class="ident" id="5175056">reader</span><span class="op" id="5175062">)</span>&nbsp;<span class="ident" id="5175064">readFromBlock</span><span class="op" id="5175077">(</span><span class="ident" id="5175078">buf</span>&nbsp;<span class="op" id="5175082">[</span><span class="op" id="5175083">]</span><span class="builtintype" id="5175084">byte</span><span class="op" id="5175088">)</span>&nbsp;<span class="builtintype" id="5175090">int</span>&nbsp;<span class="op" id="5175094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175097">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175168">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175233">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175301">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175370">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175440">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175485">n</span>&nbsp;<span class="op" id="5175487">:=</span>&nbsp;<span class="num" id="5175490">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175493">for</span>&nbsp;<span class="op" id="5175497">(</span><span class="ident" id="5175498">bz2</span><span class="op" id="5175501">.</span><span class="ident" id="5175502">repeats</span>&nbsp;<span class="op" id="5175510">&gt;</span>&nbsp;<span class="num" id="5175512">0</span>&nbsp;<span class="op" id="5175514">||</span>&nbsp;<span class="ident" id="5175517">bz2</span><span class="op" id="5175520">.</span><span class="ident" id="5175521">preRLEUsed</span>&nbsp;<span class="op" id="5175532">&lt;</span>&nbsp;<span class="builtinfunc" id="5175534">len</span><span class="op" id="5175537">(</span><span class="ident" id="5175538">bz2</span><span class="op" id="5175541">.</span><span class="ident" id="5175542">preRLE</span><span class="op" id="5175548">)</span><span class="op" id="5175549">)</span>&nbsp;<span class="op" id="5175551">&amp;&amp;</span>&nbsp;<span class="ident" id="5175554">n</span>&nbsp;<span class="op" id="5175556">&lt;</span>&nbsp;<span class="builtinfunc" id="5175558">len</span><span class="op" id="5175561">(</span><span class="ident" id="5175562">buf</span><span class="op" id="5175565">)</span>&nbsp;<span class="op" id="5175567">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175571">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175603">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175649">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175711">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175774">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175840">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5175901">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175915">if</span>&nbsp;<span class="ident" id="5175918">bz2</span><span class="op" id="5175921">.</span><span class="ident" id="5175922">repeats</span>&nbsp;<span class="op" id="5175930">&gt;</span>&nbsp;<span class="num" id="5175932">0</span>&nbsp;<span class="op" id="5175934">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175939">buf</span><span class="op" id="5175942">[</span><span class="ident" id="5175943">n</span><span class="op" id="5175944">]</span>&nbsp;<span class="op" id="5175946">=</span>&nbsp;<span class="builtintype" id="5175948">byte</span><span class="op" id="5175952">(</span><span class="ident" id="5175953">bz2</span><span class="op" id="5175956">.</span><span class="ident" id="5175957">lastByte</span><span class="op" id="5175965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175970">n</span><span class="op" id="5175971">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175977">bz2</span><span class="op" id="5175980">.</span><span class="ident" id="5175981">repeats</span><span class="op" id="5175988">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175994">if</span>&nbsp;<span class="ident" id="5175997">bz2</span><span class="op" id="5176000">.</span><span class="ident" id="5176001">repeats</span>&nbsp;<span class="op" id="5176009">==</span>&nbsp;<span class="num" id="5176012">0</span>&nbsp;<span class="op" id="5176014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176020">bz2</span><span class="op" id="5176023">.</span><span class="ident" id="5176024">lastByte</span>&nbsp;<span class="op" id="5176033">=</span>&nbsp;<span class="op" id="5176035">-</span><span class="num" id="5176036">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176046">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176062">bz2</span><span class="op" id="5176065">.</span><span class="ident" id="5176066">tPos</span>&nbsp;<span class="op" id="5176071">=</span>&nbsp;<span class="ident" id="5176073">bz2</span><span class="op" id="5176076">.</span><span class="ident" id="5176077">preRLE</span><span class="op" id="5176083">[</span><span class="ident" id="5176084">bz2</span><span class="op" id="5176087">.</span><span class="ident" id="5176088">tPos</span><span class="op" id="5176092">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176096">b</span>&nbsp;<span class="op" id="5176098">:=</span>&nbsp;<span class="builtintype" id="5176101">byte</span><span class="op" id="5176105">(</span><span class="ident" id="5176106">bz2</span><span class="op" id="5176109">.</span><span class="ident" id="5176110">tPos</span><span class="op" id="5176114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176118">bz2</span><span class="op" id="5176121">.</span><span class="ident" id="5176122">tPos</span>&nbsp;<span class="op" id="5176127">&gt;&gt;=</span>&nbsp;<span class="num" id="5176131">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176135">bz2</span><span class="op" id="5176138">.</span><span class="ident" id="5176139">preRLEUsed</span><span class="op" id="5176149">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176155">if</span>&nbsp;<span class="ident" id="5176158">bz2</span><span class="op" id="5176161">.</span><span class="ident" id="5176162">byteRepeats</span>&nbsp;<span class="op" id="5176174">==</span>&nbsp;<span class="num" id="5176177">3</span>&nbsp;<span class="op" id="5176179">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176184">bz2</span><span class="op" id="5176187">.</span><span class="ident" id="5176188">repeats</span>&nbsp;<span class="op" id="5176196">=</span>&nbsp;<span class="builtintype" id="5176198">uint</span><span class="op" id="5176202">(</span><span class="ident" id="5176203">b</span><span class="op" id="5176204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176209">bz2</span><span class="op" id="5176212">.</span><span class="ident" id="5176213">byteRepeats</span>&nbsp;<span class="op" id="5176225">=</span>&nbsp;<span class="num" id="5176227">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176232">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176248">if</span>&nbsp;<span class="ident" id="5176251">bz2</span><span class="op" id="5176254">.</span><span class="ident" id="5176255">lastByte</span>&nbsp;<span class="op" id="5176264">==</span>&nbsp;<span class="builtintype" id="5176267">int</span><span class="op" id="5176270">(</span><span class="ident" id="5176271">b</span><span class="op" id="5176272">)</span>&nbsp;<span class="op" id="5176274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176279">bz2</span><span class="op" id="5176282">.</span><span class="ident" id="5176283">byteRepeats</span><span class="op" id="5176294">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176299">}</span>&nbsp;<span class="keyword" id="5176301">else</span>&nbsp;<span class="op" id="5176306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176311">bz2</span><span class="op" id="5176314">.</span><span class="ident" id="5176315">byteRepeats</span>&nbsp;<span class="op" id="5176327">=</span>&nbsp;<span class="num" id="5176329">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176333">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176337">bz2</span><span class="op" id="5176340">.</span><span class="ident" id="5176341">lastByte</span>&nbsp;<span class="op" id="5176350">=</span>&nbsp;<span class="builtintype" id="5176352">int</span><span class="op" id="5176355">(</span><span class="ident" id="5176356">b</span><span class="op" id="5176357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176362">buf</span><span class="op" id="5176365">[</span><span class="ident" id="5176366">n</span><span class="op" id="5176367">]</span>&nbsp;<span class="op" id="5176369">=</span>&nbsp;<span class="ident" id="5176371">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176375">n</span><span class="op" id="5176376">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176380">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176384">return</span>&nbsp;<span class="ident" id="5176391">n</span><br>
<span class="lineno"></span><span class="op" id="5176393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5176396">func</span>&nbsp;<span class="op" id="5176401">(</span><span class="ident" id="5176402">bz2</span>&nbsp;<span class="op" id="5176406">*</span><span class="ident" id="5176407">reader</span><span class="op" id="5176413">)</span>&nbsp;<span class="ident" id="5176415">read</span><span class="op" id="5176419">(</span><span class="ident" id="5176420">buf</span>&nbsp;<span class="op" id="5176424">[</span><span class="op" id="5176425">]</span><span class="builtintype" id="5176426">byte</span><span class="op" id="5176430">)</span>&nbsp;<span class="op" id="5176432">(</span><span class="builtintype" id="5176433">int</span><span class="op" id="5176436">,</span>&nbsp;<span class="builtintype" id="5176438">error</span><span class="op" id="5176443">)</span>&nbsp;<span class="op" id="5176445">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176448">for</span>&nbsp;<span class="op" id="5176452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176456">n</span>&nbsp;<span class="op" id="5176458">:=</span>&nbsp;<span class="ident" id="5176461">bz2</span><span class="op" id="5176464">.</span><span class="ident" id="5176465">readFromBlock</span><span class="op" id="5176478">(</span><span class="ident" id="5176479">buf</span><span class="op" id="5176482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176486">if</span>&nbsp;<span class="ident" id="5176489">n</span>&nbsp;<span class="op" id="5176491">&gt;</span>&nbsp;<span class="num" id="5176493">0</span>&nbsp;<span class="op" id="5176495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176500">bz2</span><span class="op" id="5176503">.</span><span class="ident" id="5176504">blockCRC</span>&nbsp;<span class="op" id="5176513">=</span>&nbsp;<span class="ident" id="5176515">updateCRC</span><span class="op" id="5176524">(</span><span class="ident" id="5176525">bz2</span><span class="op" id="5176528">.</span><span class="ident" id="5176529">blockCRC</span><span class="op" id="5176537">,</span>&nbsp;<span class="ident" id="5176539">buf</span><span class="op" id="5176542">[</span><span class="op" id="5176543">:</span><span class="ident" id="5176544">n</span><span class="op" id="5176545">]</span><span class="op" id="5176546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176551">return</span>&nbsp;<span class="ident" id="5176558">n</span><span class="op" id="5176559">,</span>&nbsp;<span class="ident" id="5176561">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176572">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176602">if</span>&nbsp;<span class="ident" id="5176605">bz2</span><span class="op" id="5176608">.</span><span class="ident" id="5176609">blockCRC</span>&nbsp;<span class="op" id="5176618">!=</span>&nbsp;<span class="ident" id="5176621">bz2</span><span class="op" id="5176624">.</span><span class="ident" id="5176625">wantBlockCRC</span>&nbsp;<span class="op" id="5176638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176643">bz2</span><span class="op" id="5176646">.</span><span class="ident" id="5176647">br</span><span class="op" id="5176649">.</span><span class="ident" id="5176650">err</span>&nbsp;<span class="op" id="5176654">=</span>&nbsp;<span class="ident" id="5176656">StructuralError</span><span class="op" id="5176671">(</span><span class="string" id="5176672">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5176697">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176702">return</span>&nbsp;<span class="num" id="5176709">0</span><span class="op" id="5176710">,</span>&nbsp;<span class="ident" id="5176712">bz2</span><span class="op" id="5176715">.</span><span class="ident" id="5176716">br</span><span class="op" id="5176718">.</span><span class="ident" id="5176719">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176730">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176752">br</span>&nbsp;<span class="op" id="5176755">:=</span>&nbsp;<span class="op" id="5176758">&amp;</span><span class="ident" id="5176759">bz2</span><span class="op" id="5176762">.</span><span class="ident" id="5176763">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176768">switch</span>&nbsp;<span class="ident" id="5176775">br</span><span class="op" id="5176777">.</span><span class="ident" id="5176778">ReadBits64</span><span class="op" id="5176788">(</span><span class="num" id="5176789">48</span><span class="op" id="5176791">)</span>&nbsp;<span class="op" id="5176793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176797">default</span><span class="op" id="5176804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176809">return</span>&nbsp;<span class="num" id="5176816">0</span><span class="op" id="5176817">,</span>&nbsp;<span class="ident" id="5176819">StructuralError</span><span class="op" id="5176834">(</span><span class="string" id="5176835">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5176858">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176863">case</span>&nbsp;<span class="ident" id="5176868">bzip2BlockMagic</span><span class="op" id="5176883">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5176888">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176910">err</span>&nbsp;<span class="op" id="5176914">:=</span>&nbsp;<span class="ident" id="5176917">bz2</span><span class="op" id="5176920">.</span><span class="ident" id="5176921">readBlock</span><span class="op" id="5176930">(</span><span class="op" id="5176931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176936">if</span>&nbsp;<span class="ident" id="5176939">err</span>&nbsp;<span class="op" id="5176943">!=</span>&nbsp;<span class="ident" id="5176946">nil</span>&nbsp;<span class="op" id="5176950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176956">return</span>&nbsp;<span class="num" id="5176963">0</span><span class="op" id="5176964">,</span>&nbsp;<span class="ident" id="5176966">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176973">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176978">case</span>&nbsp;<span class="ident" id="5176983">bzip2FinalMagic</span><span class="op" id="5176998">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177003">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177032">wantFileCRC</span>&nbsp;<span class="op" id="5177044">:=</span>&nbsp;<span class="builtintype" id="5177047">uint32</span><span class="op" id="5177053">(</span><span class="ident" id="5177054">br</span><span class="op" id="5177056">.</span><span class="ident" id="5177057">ReadBits64</span><span class="op" id="5177067">(</span><span class="num" id="5177068">32</span><span class="op" id="5177070">)</span><span class="op" id="5177071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177076">if</span>&nbsp;<span class="ident" id="5177079">br</span><span class="op" id="5177081">.</span><span class="ident" id="5177082">err</span>&nbsp;<span class="op" id="5177086">!=</span>&nbsp;<span class="ident" id="5177089">nil</span>&nbsp;<span class="op" id="5177093">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177099">return</span>&nbsp;<span class="num" id="5177106">0</span><span class="op" id="5177107">,</span>&nbsp;<span class="ident" id="5177109">br</span><span class="op" id="5177111">.</span><span class="ident" id="5177112">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177124">if</span>&nbsp;<span class="ident" id="5177127">bz2</span><span class="op" id="5177130">.</span><span class="ident" id="5177131">fileCRC</span>&nbsp;<span class="op" id="5177139">!=</span>&nbsp;<span class="ident" id="5177142">wantFileCRC</span>&nbsp;<span class="op" id="5177154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177160">br</span><span class="op" id="5177162">.</span><span class="ident" id="5177163">err</span>&nbsp;<span class="op" id="5177167">=</span>&nbsp;<span class="ident" id="5177169">StructuralError</span><span class="op" id="5177184">(</span><span class="string" id="5177185">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5177209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177215">return</span>&nbsp;<span class="num" id="5177222">0</span><span class="op" id="5177223">,</span>&nbsp;<span class="ident" id="5177225">br</span><span class="op" id="5177227">.</span><span class="ident" id="5177228">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177241">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177276">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177324">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177354">if</span>&nbsp;<span class="ident" id="5177357">br</span><span class="op" id="5177359">.</span><span class="ident" id="5177360">bits</span><span class="op" id="5177364">%</span><span class="num" id="5177365">8</span>&nbsp;<span class="op" id="5177367">!=</span>&nbsp;<span class="num" id="5177370">0</span>&nbsp;<span class="op" id="5177372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177378">br</span><span class="op" id="5177380">.</span><span class="ident" id="5177381">ReadBits</span><span class="op" id="5177389">(</span><span class="ident" id="5177390">br</span><span class="op" id="5177392">.</span><span class="ident" id="5177393">bits</span>&nbsp;<span class="op" id="5177398">%</span>&nbsp;<span class="num" id="5177400">8</span><span class="op" id="5177401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177411">b</span><span class="op" id="5177412">,</span>&nbsp;<span class="ident" id="5177414">err</span>&nbsp;<span class="op" id="5177418">:=</span>&nbsp;<span class="ident" id="5177421">br</span><span class="op" id="5177423">.</span><span class="ident" id="5177424">r</span><span class="op" id="5177425">.</span><span class="ident" id="5177426">ReadByte</span><span class="op" id="5177434">(</span><span class="op" id="5177435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177440">if</span>&nbsp;<span class="ident" id="5177443">err</span>&nbsp;<span class="op" id="5177447">==</span>&nbsp;<span class="ident" id="5177450">io</span><span class="op" id="5177452">.</span><span class="ident" id="5177453">EOF</span>&nbsp;<span class="op" id="5177457">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177463">br</span><span class="op" id="5177465">.</span><span class="ident" id="5177466">err</span>&nbsp;<span class="op" id="5177470">=</span>&nbsp;<span class="ident" id="5177472">io</span><span class="op" id="5177474">.</span><span class="ident" id="5177475">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177483">bz2</span><span class="op" id="5177486">.</span><span class="ident" id="5177487">eof</span>&nbsp;<span class="op" id="5177491">=</span>&nbsp;<span class="builtintype" id="5177493">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177502">return</span>&nbsp;<span class="num" id="5177509">0</span><span class="op" id="5177510">,</span>&nbsp;<span class="ident" id="5177512">io</span><span class="op" id="5177514">.</span><span class="ident" id="5177515">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177527">if</span>&nbsp;<span class="ident" id="5177530">err</span>&nbsp;<span class="op" id="5177534">!=</span>&nbsp;<span class="ident" id="5177537">nil</span>&nbsp;<span class="op" id="5177541">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177547">br</span><span class="op" id="5177549">.</span><span class="ident" id="5177550">err</span>&nbsp;<span class="op" id="5177554">=</span>&nbsp;<span class="ident" id="5177556">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177564">return</span>&nbsp;<span class="num" id="5177571">0</span><span class="op" id="5177572">,</span>&nbsp;<span class="ident" id="5177574">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177586">z</span><span class="op" id="5177587">,</span>&nbsp;<span class="ident" id="5177589">err</span>&nbsp;<span class="op" id="5177593">:=</span>&nbsp;<span class="ident" id="5177596">br</span><span class="op" id="5177598">.</span><span class="ident" id="5177599">r</span><span class="op" id="5177600">.</span><span class="ident" id="5177601">ReadByte</span><span class="op" id="5177609">(</span><span class="op" id="5177610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177615">if</span>&nbsp;<span class="ident" id="5177618">err</span>&nbsp;<span class="op" id="5177622">!=</span>&nbsp;<span class="ident" id="5177625">nil</span>&nbsp;<span class="op" id="5177629">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177635">if</span>&nbsp;<span class="ident" id="5177638">err</span>&nbsp;<span class="op" id="5177642">==</span>&nbsp;<span class="ident" id="5177645">io</span><span class="op" id="5177647">.</span><span class="ident" id="5177648">EOF</span>&nbsp;<span class="op" id="5177652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177659">err</span>&nbsp;<span class="op" id="5177663">=</span>&nbsp;<span class="ident" id="5177665">io</span><span class="op" id="5177667">.</span><span class="ident" id="5177668">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177695">br</span><span class="op" id="5177697">.</span><span class="ident" id="5177698">err</span>&nbsp;<span class="op" id="5177702">=</span>&nbsp;<span class="ident" id="5177704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177712">return</span>&nbsp;<span class="num" id="5177719">0</span><span class="op" id="5177720">,</span>&nbsp;<span class="ident" id="5177722">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177734">if</span>&nbsp;<span class="ident" id="5177737">b</span>&nbsp;<span class="op" id="5177739">!=</span>&nbsp;<span class="string" id="5177742">&#39;B&#39;</span>&nbsp;<span class="op" id="5177746">||</span>&nbsp;<span class="ident" id="5177749">z</span>&nbsp;<span class="op" id="5177751">!=</span>&nbsp;<span class="string" id="5177754">&#39;Z&#39;</span>&nbsp;<span class="op" id="5177758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177764">return</span>&nbsp;<span class="num" id="5177771">0</span><span class="op" id="5177772">,</span>&nbsp;<span class="ident" id="5177774">StructuralError</span><span class="op" id="5177789">(</span><span class="string" id="5177790">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5177828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177838">if</span>&nbsp;<span class="ident" id="5177841">err</span>&nbsp;<span class="op" id="5177845">:=</span>&nbsp;<span class="ident" id="5177848">bz2</span><span class="op" id="5177851">.</span><span class="ident" id="5177852">setup</span><span class="op" id="5177857">(</span><span class="builtintype" id="5177858">false</span><span class="op" id="5177863">)</span><span class="op" id="5177864">;</span>&nbsp;<span class="ident" id="5177866">err</span>&nbsp;<span class="op" id="5177870">!=</span>&nbsp;<span class="ident" id="5177873">nil</span>&nbsp;<span class="op" id="5177877">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177883">return</span>&nbsp;<span class="num" id="5177890">0</span><span class="op" id="5177891">,</span>&nbsp;<span class="ident" id="5177893">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177907">}</span><br>
<span class="lineno"></span><span class="op" id="5177909">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5177912">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5177998">func</span>&nbsp;<span class="op" id="5178003">(</span><span class="ident" id="5178004">bz2</span>&nbsp;<span class="op" id="5178008">*</span><span class="ident" id="5178009">reader</span><span class="op" id="5178015">)</span>&nbsp;<span class="ident" id="5178017">readBlock</span><span class="op" id="5178026">(</span><span class="op" id="5178027">)</span>&nbsp;<span class="op" id="5178029">(</span><span class="ident" id="5178030">err</span>&nbsp;<span class="builtintype" id="5178034">error</span><span class="op" id="5178039">)</span>&nbsp;<span class="op" id="5178041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178044">br</span>&nbsp;<span class="op" id="5178047">:=</span>&nbsp;<span class="op" id="5178050">&amp;</span><span class="ident" id="5178051">bz2</span><span class="op" id="5178054">.</span><span class="ident" id="5178055">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178059">bz2</span><span class="op" id="5178062">.</span><span class="ident" id="5178063">wantBlockCRC</span>&nbsp;<span class="op" id="5178076">=</span>&nbsp;<span class="builtintype" id="5178078">uint32</span><span class="op" id="5178084">(</span><span class="ident" id="5178085">br</span><span class="op" id="5178087">.</span><span class="ident" id="5178088">ReadBits64</span><span class="op" id="5178098">(</span><span class="num" id="5178099">32</span><span class="op" id="5178101">)</span><span class="op" id="5178102">)</span>&nbsp;<span class="comment" id="5178104">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178171">bz2</span><span class="op" id="5178174">.</span><span class="ident" id="5178175">blockCRC</span>&nbsp;<span class="op" id="5178184">=</span>&nbsp;<span class="num" id="5178186">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178189">bz2</span><span class="op" id="5178192">.</span><span class="ident" id="5178193">fileCRC</span>&nbsp;<span class="op" id="5178201">=</span>&nbsp;<span class="op" id="5178203">(</span><span class="ident" id="5178204">bz2</span><span class="op" id="5178207">.</span><span class="ident" id="5178208">fileCRC</span><span class="op" id="5178215">&lt;&lt;</span><span class="num" id="5178217">1</span>&nbsp;<span class="op" id="5178219">|</span>&nbsp;<span class="ident" id="5178221">bz2</span><span class="op" id="5178224">.</span><span class="ident" id="5178225">fileCRC</span><span class="op" id="5178232">&gt;&gt;</span><span class="num" id="5178234">31</span><span class="op" id="5178236">)</span>&nbsp;<span class="op" id="5178238">^</span>&nbsp;<span class="ident" id="5178240">bz2</span><span class="op" id="5178243">.</span><span class="ident" id="5178244">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178258">randomized</span>&nbsp;<span class="op" id="5178269">:=</span>&nbsp;<span class="ident" id="5178272">br</span><span class="op" id="5178274">.</span><span class="ident" id="5178275">ReadBits</span><span class="op" id="5178283">(</span><span class="num" id="5178284">1</span><span class="op" id="5178285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178288">if</span>&nbsp;<span class="ident" id="5178291">randomized</span>&nbsp;<span class="op" id="5178302">!=</span>&nbsp;<span class="num" id="5178305">0</span>&nbsp;<span class="op" id="5178307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178311">return</span>&nbsp;<span class="ident" id="5178318">StructuralError</span><span class="op" id="5178333">(</span><span class="string" id="5178334">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5178363">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178369">origPtr</span>&nbsp;<span class="op" id="5178377">:=</span>&nbsp;<span class="builtintype" id="5178380">uint</span><span class="op" id="5178384">(</span><span class="ident" id="5178385">br</span><span class="op" id="5178387">.</span><span class="ident" id="5178388">ReadBits</span><span class="op" id="5178396">(</span><span class="num" id="5178397">24</span><span class="op" id="5178399">)</span><span class="op" id="5178400">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178404">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178476">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178540">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178569">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5178591">:=</span>&nbsp;<span class="ident" id="5178594">br</span><span class="op" id="5178596">.</span><span class="ident" id="5178597">ReadBits</span><span class="op" id="5178605">(</span><span class="num" id="5178606">16</span><span class="op" id="5178608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178611">symbolPresent</span>&nbsp;<span class="op" id="5178625">:=</span>&nbsp;<span class="builtinfunc" id="5178628">make</span><span class="op" id="5178632">(</span><span class="op" id="5178633">[</span><span class="op" id="5178634">]</span><span class="builtintype" id="5178635">bool</span><span class="op" id="5178639">,</span>&nbsp;<span class="num" id="5178641">256</span><span class="op" id="5178644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178647">numSymbols</span>&nbsp;<span class="op" id="5178658">:=</span>&nbsp;<span class="num" id="5178661">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178664">for</span>&nbsp;<span class="ident" id="5178668">symRange</span>&nbsp;<span class="op" id="5178677">:=</span>&nbsp;<span class="builtintype" id="5178680">uint</span><span class="op" id="5178684">(</span><span class="num" id="5178685">0</span><span class="op" id="5178686">)</span><span class="op" id="5178687">;</span>&nbsp;<span class="ident" id="5178689">symRange</span>&nbsp;<span class="op" id="5178698">&lt;</span>&nbsp;<span class="num" id="5178700">16</span><span class="op" id="5178702">;</span>&nbsp;<span class="ident" id="5178704">symRange</span><span class="op" id="5178712">++</span>&nbsp;<span class="op" id="5178715">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178719">if</span>&nbsp;<span class="ident" id="5178722">symbolRangeUsedBitmap</span><span class="op" id="5178743">&amp;</span><span class="op" id="5178744">(</span><span class="num" id="5178745">1</span><span class="op" id="5178746">&lt;&lt;</span><span class="op" id="5178748">(</span><span class="num" id="5178749">15</span><span class="op" id="5178751">-</span><span class="ident" id="5178752">symRange</span><span class="op" id="5178760">)</span><span class="op" id="5178761">)</span>&nbsp;<span class="op" id="5178763">!=</span>&nbsp;<span class="num" id="5178766">0</span>&nbsp;<span class="op" id="5178768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178773">bits</span>&nbsp;<span class="op" id="5178778">:=</span>&nbsp;<span class="ident" id="5178781">br</span><span class="op" id="5178783">.</span><span class="ident" id="5178784">ReadBits</span><span class="op" id="5178792">(</span><span class="num" id="5178793">16</span><span class="op" id="5178795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178800">for</span>&nbsp;<span class="ident" id="5178804">symbol</span>&nbsp;<span class="op" id="5178811">:=</span>&nbsp;<span class="builtintype" id="5178814">uint</span><span class="op" id="5178818">(</span><span class="num" id="5178819">0</span><span class="op" id="5178820">)</span><span class="op" id="5178821">;</span>&nbsp;<span class="ident" id="5178823">symbol</span>&nbsp;<span class="op" id="5178830">&lt;</span>&nbsp;<span class="num" id="5178832">16</span><span class="op" id="5178834">;</span>&nbsp;<span class="ident" id="5178836">symbol</span><span class="op" id="5178842">++</span>&nbsp;<span class="op" id="5178845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178851">if</span>&nbsp;<span class="ident" id="5178854">bits</span><span class="op" id="5178858">&amp;</span><span class="op" id="5178859">(</span><span class="num" id="5178860">1</span><span class="op" id="5178861">&lt;&lt;</span><span class="op" id="5178863">(</span><span class="num" id="5178864">15</span><span class="op" id="5178866">-</span><span class="ident" id="5178867">symbol</span><span class="op" id="5178873">)</span><span class="op" id="5178874">)</span>&nbsp;<span class="op" id="5178876">!=</span>&nbsp;<span class="num" id="5178879">0</span>&nbsp;<span class="op" id="5178881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178888">symbolPresent</span><span class="op" id="5178901">[</span><span class="num" id="5178902">16</span><span class="op" id="5178904">*</span><span class="ident" id="5178905">symRange</span><span class="op" id="5178913">+</span><span class="ident" id="5178914">symbol</span><span class="op" id="5178920">]</span>&nbsp;<span class="op" id="5178922">=</span>&nbsp;<span class="builtintype" id="5178924">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178934">numSymbols</span><span class="op" id="5178944">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178963">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178967">if</span>&nbsp;<span class="ident" id="5178970">numSymbols</span>&nbsp;<span class="op" id="5178981">==</span>&nbsp;<span class="num" id="5178984">0</span>&nbsp;<span class="op" id="5178986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178990">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179024">return</span>&nbsp;<span class="ident" id="5179031">StructuralError</span><span class="op" id="5179046">(</span><span class="string" id="5179047">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5179068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179071">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179075">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179137">numHuffmanTrees</span>&nbsp;<span class="op" id="5179153">:=</span>&nbsp;<span class="ident" id="5179156">br</span><span class="op" id="5179158">.</span><span class="ident" id="5179159">ReadBits</span><span class="op" id="5179167">(</span><span class="num" id="5179168">3</span><span class="op" id="5179169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179172">if</span>&nbsp;<span class="ident" id="5179175">numHuffmanTrees</span>&nbsp;<span class="op" id="5179191">&lt;</span>&nbsp;<span class="num" id="5179193">2</span>&nbsp;<span class="op" id="5179195">||</span>&nbsp;<span class="ident" id="5179198">numHuffmanTrees</span>&nbsp;<span class="op" id="5179214">&gt;</span>&nbsp;<span class="num" id="5179216">6</span>&nbsp;<span class="op" id="5179218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179222">return</span>&nbsp;<span class="ident" id="5179229">StructuralError</span><span class="op" id="5179244">(</span><span class="string" id="5179245">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5179278">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179285">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179355">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179427">numSelectors</span>&nbsp;<span class="op" id="5179440">:=</span>&nbsp;<span class="ident" id="5179443">br</span><span class="op" id="5179445">.</span><span class="ident" id="5179446">ReadBits</span><span class="op" id="5179454">(</span><span class="num" id="5179455">15</span><span class="op" id="5179457">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179460">treeIndexes</span>&nbsp;<span class="op" id="5179472">:=</span>&nbsp;<span class="builtinfunc" id="5179475">make</span><span class="op" id="5179479">(</span><span class="op" id="5179480">[</span><span class="op" id="5179481">]</span><span class="builtintype" id="5179482">uint8</span><span class="op" id="5179487">,</span>&nbsp;<span class="ident" id="5179489">numSelectors</span><span class="op" id="5179501">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179505">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179576">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179589">mtfTreeDecoder</span>&nbsp;<span class="op" id="5179604">:=</span>&nbsp;<span class="ident" id="5179607">newMTFDecoderWithRange</span><span class="op" id="5179629">(</span><span class="ident" id="5179630">numHuffmanTrees</span><span class="op" id="5179645">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179648">for</span>&nbsp;<span class="ident" id="5179652">i</span>&nbsp;<span class="op" id="5179654">:=</span>&nbsp;<span class="keyword" id="5179657">range</span>&nbsp;<span class="ident" id="5179663">treeIndexes</span>&nbsp;<span class="op" id="5179675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179679">c</span>&nbsp;<span class="op" id="5179681">:=</span>&nbsp;<span class="num" id="5179684">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179688">for</span>&nbsp;<span class="op" id="5179692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179697">inc</span>&nbsp;<span class="op" id="5179701">:=</span>&nbsp;<span class="ident" id="5179704">br</span><span class="op" id="5179706">.</span><span class="ident" id="5179707">ReadBits</span><span class="op" id="5179715">(</span><span class="num" id="5179716">1</span><span class="op" id="5179717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179722">if</span>&nbsp;<span class="ident" id="5179725">inc</span>&nbsp;<span class="op" id="5179729">==</span>&nbsp;<span class="num" id="5179732">0</span>&nbsp;<span class="op" id="5179734">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179740">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179754">c</span><span class="op" id="5179755">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179764">if</span>&nbsp;<span class="ident" id="5179767">c</span>&nbsp;<span class="op" id="5179769">&gt;=</span>&nbsp;<span class="ident" id="5179772">numHuffmanTrees</span>&nbsp;<span class="op" id="5179788">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179793">return</span>&nbsp;<span class="ident" id="5179800">StructuralError</span><span class="op" id="5179815">(</span><span class="string" id="5179816">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5179838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179846">treeIndexes</span><span class="op" id="5179857">[</span><span class="ident" id="5179858">i</span><span class="op" id="5179859">]</span>&nbsp;<span class="op" id="5179861">=</span>&nbsp;<span class="builtintype" id="5179863">uint8</span><span class="op" id="5179868">(</span><span class="ident" id="5179869">mtfTreeDecoder</span><span class="op" id="5179883">.</span><span class="ident" id="5179884">Decode</span><span class="op" id="5179890">(</span><span class="ident" id="5179891">c</span><span class="op" id="5179892">)</span><span class="op" id="5179893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179900">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179970">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180012">symbols</span>&nbsp;<span class="op" id="5180020">:=</span>&nbsp;<span class="builtinfunc" id="5180023">make</span><span class="op" id="5180027">(</span><span class="op" id="5180028">[</span><span class="op" id="5180029">]</span><span class="builtintype" id="5180030">byte</span><span class="op" id="5180034">,</span>&nbsp;<span class="ident" id="5180036">numSymbols</span><span class="op" id="5180046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180049">nextSymbol</span>&nbsp;<span class="op" id="5180060">:=</span>&nbsp;<span class="num" id="5180063">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180066">for</span>&nbsp;<span class="ident" id="5180070">i</span>&nbsp;<span class="op" id="5180072">:=</span>&nbsp;<span class="num" id="5180075">0</span><span class="op" id="5180076">;</span>&nbsp;<span class="ident" id="5180078">i</span>&nbsp;<span class="op" id="5180080">&lt;</span>&nbsp;<span class="num" id="5180082">256</span><span class="op" id="5180085">;</span>&nbsp;<span class="ident" id="5180087">i</span><span class="op" id="5180088">++</span>&nbsp;<span class="op" id="5180091">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180095">if</span>&nbsp;<span class="ident" id="5180098">symbolPresent</span><span class="op" id="5180111">[</span><span class="ident" id="5180112">i</span><span class="op" id="5180113">]</span>&nbsp;<span class="op" id="5180115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180120">symbols</span><span class="op" id="5180127">[</span><span class="ident" id="5180128">nextSymbol</span><span class="op" id="5180138">]</span>&nbsp;<span class="op" id="5180140">=</span>&nbsp;<span class="builtintype" id="5180142">byte</span><span class="op" id="5180146">(</span><span class="ident" id="5180147">i</span><span class="op" id="5180148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180153">nextSymbol</span><span class="op" id="5180163">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180171">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180174">mtf</span>&nbsp;<span class="op" id="5180178">:=</span>&nbsp;<span class="ident" id="5180181">newMTFDecoder</span><span class="op" id="5180194">(</span><span class="ident" id="5180195">symbols</span><span class="op" id="5180202">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180206">numSymbols</span>&nbsp;<span class="op" id="5180217">+=</span>&nbsp;<span class="num" id="5180220">2</span>&nbsp;<span class="comment" id="5180222">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180263">huffmanTrees</span>&nbsp;<span class="op" id="5180276">:=</span>&nbsp;<span class="builtinfunc" id="5180279">make</span><span class="op" id="5180283">(</span><span class="op" id="5180284">[</span><span class="op" id="5180285">]</span><span class="ident" id="5180286">huffmanTree</span><span class="op" id="5180297">,</span>&nbsp;<span class="ident" id="5180299">numHuffmanTrees</span><span class="op" id="5180314">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180318">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180378">lengths</span>&nbsp;<span class="op" id="5180386">:=</span>&nbsp;<span class="builtinfunc" id="5180389">make</span><span class="op" id="5180393">(</span><span class="op" id="5180394">[</span><span class="op" id="5180395">]</span><span class="builtintype" id="5180396">uint8</span><span class="op" id="5180401">,</span>&nbsp;<span class="ident" id="5180403">numSymbols</span><span class="op" id="5180413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180416">for</span>&nbsp;<span class="ident" id="5180420">i</span>&nbsp;<span class="op" id="5180422">:=</span>&nbsp;<span class="keyword" id="5180425">range</span>&nbsp;<span class="ident" id="5180431">huffmanTrees</span>&nbsp;<span class="op" id="5180444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180448">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180513">length</span>&nbsp;<span class="op" id="5180520">:=</span>&nbsp;<span class="ident" id="5180523">br</span><span class="op" id="5180525">.</span><span class="ident" id="5180526">ReadBits</span><span class="op" id="5180534">(</span><span class="num" id="5180535">5</span><span class="op" id="5180536">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180540">for</span>&nbsp;<span class="ident" id="5180544">j</span>&nbsp;<span class="op" id="5180546">:=</span>&nbsp;<span class="keyword" id="5180549">range</span>&nbsp;<span class="ident" id="5180555">lengths</span>&nbsp;<span class="op" id="5180563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180568">for</span>&nbsp;<span class="op" id="5180572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180578">if</span>&nbsp;<span class="op" id="5180581">!</span><span class="ident" id="5180582">br</span><span class="op" id="5180584">.</span><span class="ident" id="5180585">ReadBit</span><span class="op" id="5180592">(</span><span class="op" id="5180593">)</span>&nbsp;<span class="op" id="5180595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180602">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180612">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180618">if</span>&nbsp;<span class="ident" id="5180621">br</span><span class="op" id="5180623">.</span><span class="ident" id="5180624">ReadBit</span><span class="op" id="5180631">(</span><span class="op" id="5180632">)</span>&nbsp;<span class="op" id="5180634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180641">length</span><span class="op" id="5180647">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180654">}</span>&nbsp;<span class="keyword" id="5180656">else</span>&nbsp;<span class="op" id="5180661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180668">length</span><span class="op" id="5180674">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180681">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180691">if</span>&nbsp;<span class="ident" id="5180694">length</span>&nbsp;<span class="op" id="5180701">&lt;</span>&nbsp;<span class="num" id="5180703">0</span>&nbsp;<span class="op" id="5180705">||</span>&nbsp;<span class="ident" id="5180708">length</span>&nbsp;<span class="op" id="5180715">&gt;</span>&nbsp;<span class="num" id="5180717">20</span>&nbsp;<span class="op" id="5180720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180726">return</span>&nbsp;<span class="ident" id="5180733">StructuralError</span><span class="op" id="5180748">(</span><span class="string" id="5180749">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5180778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180788">lengths</span><span class="op" id="5180795">[</span><span class="ident" id="5180796">j</span><span class="op" id="5180797">]</span>&nbsp;<span class="op" id="5180799">=</span>&nbsp;<span class="builtintype" id="5180801">uint8</span><span class="op" id="5180806">(</span><span class="ident" id="5180807">length</span><span class="op" id="5180813">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180821">huffmanTrees</span><span class="op" id="5180833">[</span><span class="ident" id="5180834">i</span><span class="op" id="5180835">]</span><span class="op" id="5180836">,</span>&nbsp;<span class="ident" id="5180838">err</span>&nbsp;<span class="op" id="5180842">=</span>&nbsp;<span class="ident" id="5180844">newHuffmanTree</span><span class="op" id="5180858">(</span><span class="ident" id="5180859">lengths</span><span class="op" id="5180866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180870">if</span>&nbsp;<span class="ident" id="5180873">err</span>&nbsp;<span class="op" id="5180877">!=</span>&nbsp;<span class="ident" id="5180880">nil</span>&nbsp;<span class="op" id="5180884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180889">return</span>&nbsp;<span class="ident" id="5180896">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180902">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180909">selectorIndex</span>&nbsp;<span class="op" id="5180923">:=</span>&nbsp;<span class="num" id="5180926">1</span>&nbsp;<span class="comment" id="5180928">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180959">if</span>&nbsp;<span class="builtinfunc" id="5180962">len</span><span class="op" id="5180965">(</span><span class="ident" id="5180966">treeIndexes</span><span class="op" id="5180977">)</span>&nbsp;<span class="op" id="5180979">==</span>&nbsp;<span class="num" id="5180982">0</span>&nbsp;<span class="op" id="5180984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180988">return</span>&nbsp;<span class="ident" id="5180995">StructuralError</span><span class="op" id="5181010">(</span><span class="string" id="5181011">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5181036">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181042">if</span>&nbsp;<span class="builtintype" id="5181045">int</span><span class="op" id="5181048">(</span><span class="ident" id="5181049">treeIndexes</span><span class="op" id="5181060">[</span><span class="num" id="5181061">0</span><span class="op" id="5181062">]</span><span class="op" id="5181063">)</span>&nbsp;<span class="op" id="5181065">&gt;=</span>&nbsp;<span class="builtinfunc" id="5181068">len</span><span class="op" id="5181071">(</span><span class="ident" id="5181072">huffmanTrees</span><span class="op" id="5181084">)</span>&nbsp;<span class="op" id="5181086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181090">return</span>&nbsp;<span class="ident" id="5181097">StructuralError</span><span class="op" id="5181112">(</span><span class="string" id="5181113">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5181141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181147">currentHuffmanTree</span>&nbsp;<span class="op" id="5181166">:=</span>&nbsp;<span class="ident" id="5181169">huffmanTrees</span><span class="op" id="5181181">[</span><span class="ident" id="5181182">treeIndexes</span><span class="op" id="5181193">[</span><span class="num" id="5181194">0</span><span class="op" id="5181195">]</span><span class="op" id="5181196">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181199">bufIndex</span>&nbsp;<span class="op" id="5181208">:=</span>&nbsp;<span class="num" id="5181211">0</span>&nbsp;<span class="comment" id="5181213">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181253">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181325">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181392">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181462">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181475">repeat</span>&nbsp;<span class="op" id="5181482">:=</span>&nbsp;<span class="num" id="5181485">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181488">repeat_power</span>&nbsp;<span class="op" id="5181501">:=</span>&nbsp;<span class="num" id="5181504">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181508">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181582">for</span>&nbsp;<span class="ident" id="5181586">i</span>&nbsp;<span class="op" id="5181588">:=</span>&nbsp;<span class="keyword" id="5181591">range</span>&nbsp;<span class="ident" id="5181597">bz2</span><span class="op" id="5181600">.</span><span class="ident" id="5181601">c</span>&nbsp;<span class="op" id="5181603">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181607">bz2</span><span class="op" id="5181610">.</span><span class="ident" id="5181611">c</span><span class="op" id="5181612">[</span><span class="ident" id="5181613">i</span><span class="op" id="5181614">]</span>&nbsp;<span class="op" id="5181616">=</span>&nbsp;<span class="num" id="5181618">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181625">decoded</span>&nbsp;<span class="op" id="5181633">:=</span>&nbsp;<span class="num" id="5181636">0</span>&nbsp;<span class="comment" id="5181638">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181700">for</span>&nbsp;<span class="op" id="5181704">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181708">if</span>&nbsp;<span class="ident" id="5181711">decoded</span>&nbsp;<span class="op" id="5181719">==</span>&nbsp;<span class="num" id="5181722">50</span>&nbsp;<span class="op" id="5181725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181730">if</span>&nbsp;<span class="ident" id="5181733">selectorIndex</span>&nbsp;<span class="op" id="5181747">&gt;=</span>&nbsp;<span class="ident" id="5181750">numSelectors</span>&nbsp;<span class="op" id="5181763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181769">return</span>&nbsp;<span class="ident" id="5181776">StructuralError</span><span class="op" id="5181791">(</span><span class="string" id="5181792">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5181845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181855">if</span>&nbsp;<span class="builtintype" id="5181858">int</span><span class="op" id="5181861">(</span><span class="ident" id="5181862">treeIndexes</span><span class="op" id="5181873">[</span><span class="ident" id="5181874">selectorIndex</span><span class="op" id="5181887">]</span><span class="op" id="5181888">)</span>&nbsp;<span class="op" id="5181890">&gt;=</span>&nbsp;<span class="builtinfunc" id="5181893">len</span><span class="op" id="5181896">(</span><span class="ident" id="5181897">huffmanTrees</span><span class="op" id="5181909">)</span>&nbsp;<span class="op" id="5181911">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181917">return</span>&nbsp;<span class="ident" id="5181924">StructuralError</span><span class="op" id="5181939">(</span><span class="string" id="5181940">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5181968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181978">currentHuffmanTree</span>&nbsp;<span class="op" id="5181997">=</span>&nbsp;<span class="ident" id="5181999">huffmanTrees</span><span class="op" id="5182011">[</span><span class="ident" id="5182012">treeIndexes</span><span class="op" id="5182023">[</span><span class="ident" id="5182024">selectorIndex</span><span class="op" id="5182037">]</span><span class="op" id="5182038">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182043">selectorIndex</span><span class="op" id="5182056">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182062">decoded</span>&nbsp;<span class="op" id="5182070">=</span>&nbsp;<span class="num" id="5182072">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182081">v</span>&nbsp;<span class="op" id="5182083">:=</span>&nbsp;<span class="ident" id="5182086">currentHuffmanTree</span><span class="op" id="5182104">.</span><span class="ident" id="5182105">Decode</span><span class="op" id="5182111">(</span><span class="ident" id="5182112">br</span><span class="op" id="5182114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182118">decoded</span><span class="op" id="5182125">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182131">if</span>&nbsp;<span class="ident" id="5182134">v</span>&nbsp;<span class="op" id="5182136">&lt;</span>&nbsp;<span class="num" id="5182138">2</span>&nbsp;<span class="op" id="5182140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182145">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182191">if</span>&nbsp;<span class="ident" id="5182194">repeat</span>&nbsp;<span class="op" id="5182201">==</span>&nbsp;<span class="num" id="5182204">0</span>&nbsp;<span class="op" id="5182206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182212">repeat_power</span>&nbsp;<span class="op" id="5182225">=</span>&nbsp;<span class="num" id="5182227">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182232">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182237">repeat</span>&nbsp;<span class="op" id="5182244">+=</span>&nbsp;<span class="ident" id="5182247">repeat_power</span>&nbsp;<span class="op" id="5182260">&lt;&lt;</span>&nbsp;<span class="ident" id="5182263">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182268">repeat_power</span>&nbsp;<span class="op" id="5182281">&lt;&lt;=</span>&nbsp;<span class="num" id="5182285">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182291">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182349">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182398">if</span>&nbsp;<span class="ident" id="5182401">repeat</span>&nbsp;<span class="op" id="5182408">&gt;</span>&nbsp;<span class="num" id="5182410">2</span><span class="op" id="5182411">*</span><span class="num" id="5182412">1024</span><span class="op" id="5182416">*</span><span class="num" id="5182417">1024</span>&nbsp;<span class="op" id="5182422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182428">return</span>&nbsp;<span class="ident" id="5182435">StructuralError</span><span class="op" id="5182450">(</span><span class="string" id="5182451">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5182475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182485">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182496">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182501">if</span>&nbsp;<span class="ident" id="5182504">repeat</span>&nbsp;<span class="op" id="5182511">&gt;</span>&nbsp;<span class="num" id="5182513">0</span>&nbsp;<span class="op" id="5182515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182520">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182578">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182618">if</span>&nbsp;<span class="ident" id="5182621">repeat</span>&nbsp;<span class="op" id="5182628">&gt;</span>&nbsp;<span class="ident" id="5182630">bz2</span><span class="op" id="5182633">.</span><span class="ident" id="5182634">blockSize</span><span class="op" id="5182643">-</span><span class="ident" id="5182644">bufIndex</span>&nbsp;<span class="op" id="5182653">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182659">return</span>&nbsp;<span class="ident" id="5182666">StructuralError</span><span class="op" id="5182681">(</span><span class="string" id="5182682">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5182709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182719">for</span>&nbsp;<span class="ident" id="5182723">i</span>&nbsp;<span class="op" id="5182725">:=</span>&nbsp;<span class="num" id="5182728">0</span><span class="op" id="5182729">;</span>&nbsp;<span class="ident" id="5182731">i</span>&nbsp;<span class="op" id="5182733">&lt;</span>&nbsp;<span class="ident" id="5182735">repeat</span><span class="op" id="5182741">;</span>&nbsp;<span class="ident" id="5182743">i</span><span class="op" id="5182744">++</span>&nbsp;<span class="op" id="5182747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182753">b</span>&nbsp;<span class="op" id="5182755">:=</span>&nbsp;<span class="builtintype" id="5182758">byte</span><span class="op" id="5182762">(</span><span class="ident" id="5182763">mtf</span><span class="op" id="5182766">.</span><span class="ident" id="5182767">First</span><span class="op" id="5182772">(</span><span class="op" id="5182773">)</span><span class="op" id="5182774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182780">bz2</span><span class="op" id="5182783">.</span><span class="ident" id="5182784">tt</span><span class="op" id="5182786">[</span><span class="ident" id="5182787">bufIndex</span><span class="op" id="5182795">]</span>&nbsp;<span class="op" id="5182797">=</span>&nbsp;<span class="builtintype" id="5182799">uint32</span><span class="op" id="5182805">(</span><span class="ident" id="5182806">b</span><span class="op" id="5182807">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182813">bz2</span><span class="op" id="5182816">.</span><span class="ident" id="5182817">c</span><span class="op" id="5182818">[</span><span class="ident" id="5182819">b</span><span class="op" id="5182820">]</span><span class="op" id="5182821">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182828">bufIndex</span><span class="op" id="5182836">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182847">repeat</span>&nbsp;<span class="op" id="5182854">=</span>&nbsp;<span class="num" id="5182856">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182860">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182865">if</span>&nbsp;<span class="builtintype" id="5182868">int</span><span class="op" id="5182871">(</span><span class="ident" id="5182872">v</span><span class="op" id="5182873">)</span>&nbsp;<span class="op" id="5182875">==</span>&nbsp;<span class="ident" id="5182878">numSymbols</span><span class="op" id="5182888">-</span><span class="num" id="5182889">1</span>&nbsp;<span class="op" id="5182891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182896">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182953">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183011">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183057">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183070">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183134">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183195">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183261">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183320">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183382">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183393">b</span>&nbsp;<span class="op" id="5183395">:=</span>&nbsp;<span class="builtintype" id="5183398">byte</span><span class="op" id="5183402">(</span><span class="ident" id="5183403">mtf</span><span class="op" id="5183406">.</span><span class="ident" id="5183407">Decode</span><span class="op" id="5183413">(</span><span class="builtintype" id="5183414">int</span><span class="op" id="5183417">(</span><span class="ident" id="5183418">v</span>&nbsp;<span class="op" id="5183420">-</span>&nbsp;<span class="num" id="5183422">1</span><span class="op" id="5183423">)</span><span class="op" id="5183424">)</span><span class="op" id="5183425">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183429">if</span>&nbsp;<span class="ident" id="5183432">bufIndex</span>&nbsp;<span class="op" id="5183441">&gt;=</span>&nbsp;<span class="ident" id="5183444">bz2</span><span class="op" id="5183447">.</span><span class="ident" id="5183448">blockSize</span>&nbsp;<span class="op" id="5183458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183463">return</span>&nbsp;<span class="ident" id="5183470">StructuralError</span><span class="op" id="5183485">(</span><span class="string" id="5183486">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5183511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183519">bz2</span><span class="op" id="5183522">.</span><span class="ident" id="5183523">tt</span><span class="op" id="5183525">[</span><span class="ident" id="5183526">bufIndex</span><span class="op" id="5183534">]</span>&nbsp;<span class="op" id="5183536">=</span>&nbsp;<span class="builtintype" id="5183538">uint32</span><span class="op" id="5183544">(</span><span class="ident" id="5183545">b</span><span class="op" id="5183546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183550">bz2</span><span class="op" id="5183553">.</span><span class="ident" id="5183554">c</span><span class="op" id="5183555">[</span><span class="ident" id="5183556">b</span><span class="op" id="5183557">]</span><span class="op" id="5183558">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183563">bufIndex</span><span class="op" id="5183571">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183579">if</span>&nbsp;<span class="ident" id="5183582">origPtr</span>&nbsp;<span class="op" id="5183590">&gt;=</span>&nbsp;<span class="builtintype" id="5183593">uint</span><span class="op" id="5183597">(</span><span class="ident" id="5183598">bufIndex</span><span class="op" id="5183606">)</span>&nbsp;<span class="op" id="5183608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183612">return</span>&nbsp;<span class="ident" id="5183619">StructuralError</span><span class="op" id="5183634">(</span><span class="string" id="5183635">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5183658">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183665">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5183732">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183774">bz2</span><span class="op" id="5183777">.</span><span class="ident" id="5183778">preRLE</span>&nbsp;<span class="op" id="5183785">=</span>&nbsp;<span class="ident" id="5183787">bz2</span><span class="op" id="5183790">.</span><span class="ident" id="5183791">tt</span><span class="op" id="5183793">[</span><span class="op" id="5183794">:</span><span class="ident" id="5183795">bufIndex</span><span class="op" id="5183803">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183806">bz2</span><span class="op" id="5183809">.</span><span class="ident" id="5183810">preRLEUsed</span>&nbsp;<span class="op" id="5183821">=</span>&nbsp;<span class="num" id="5183823">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183826">bz2</span><span class="op" id="5183829">.</span><span class="ident" id="5183830">tPos</span>&nbsp;<span class="op" id="5183835">=</span>&nbsp;<span class="ident" id="5183837">inverseBWT</span><span class="op" id="5183847">(</span><span class="ident" id="5183848">bz2</span><span class="op" id="5183851">.</span><span class="ident" id="5183852">preRLE</span><span class="op" id="5183858">,</span>&nbsp;<span class="ident" id="5183860">origPtr</span><span class="op" id="5183867">,</span>&nbsp;<span class="ident" id="5183869">bz2</span><span class="op" id="5183872">.</span><span class="ident" id="5183873">c</span><span class="op" id="5183874">[</span><span class="op" id="5183875">:</span><span class="op" id="5183876">]</span><span class="op" id="5183877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183880">bz2</span><span class="op" id="5183883">.</span><span class="ident" id="5183884">lastByte</span>&nbsp;<span class="op" id="5183893">=</span>&nbsp;<span class="op" id="5183895">-</span><span class="num" id="5183896">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183899">bz2</span><span class="op" id="5183902">.</span><span class="ident" id="5183903">byteRepeats</span>&nbsp;<span class="op" id="5183915">=</span>&nbsp;<span class="num" id="5183917">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183920">bz2</span><span class="op" id="5183923">.</span><span class="ident" id="5183924">repeats</span>&nbsp;<span class="op" id="5183932">=</span>&nbsp;<span class="num" id="5183934">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183938">return</span>&nbsp;<span class="ident" id="5183945">nil</span><br>
<span class="lineno"></span><span class="op" id="5183949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5183952">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5184031">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5184108">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5184184">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5184262">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5184297">//</span><br>
<span class="lineno">455</span><span class="comment" id="5184300">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5184377">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5184457">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5184534">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5184547">func</span>&nbsp;<span class="ident" id="5184552">inverseBWT</span><span class="op" id="5184562">(</span><span class="ident" id="5184563">tt</span>&nbsp;<span class="op" id="5184566">[</span><span class="op" id="5184567">]</span><span class="builtintype" id="5184568">uint32</span><span class="op" id="5184574">,</span>&nbsp;<span class="ident" id="5184576">origPtr</span>&nbsp;<span class="builtintype" id="5184584">uint</span><span class="op" id="5184588">,</span>&nbsp;<span class="ident" id="5184590">c</span>&nbsp;<span class="op" id="5184592">[</span><span class="op" id="5184593">]</span><span class="builtintype" id="5184594">uint</span><span class="op" id="5184598">)</span>&nbsp;<span class="builtintype" id="5184600">uint32</span>&nbsp;<span class="op" id="5184607">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184610">sum</span>&nbsp;<span class="op" id="5184614">:=</span>&nbsp;<span class="builtintype" id="5184617">uint</span><span class="op" id="5184621">(</span><span class="num" id="5184622">0</span><span class="op" id="5184623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184626">for</span>&nbsp;<span class="ident" id="5184630">i</span>&nbsp;<span class="op" id="5184632">:=</span>&nbsp;<span class="num" id="5184635">0</span><span class="op" id="5184636">;</span>&nbsp;<span class="ident" id="5184638">i</span>&nbsp;<span class="op" id="5184640">&lt;</span>&nbsp;<span class="num" id="5184642">256</span><span class="op" id="5184645">;</span>&nbsp;<span class="ident" id="5184647">i</span><span class="op" id="5184648">++</span>&nbsp;<span class="op" id="5184651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184655">sum</span>&nbsp;<span class="op" id="5184659">+=</span>&nbsp;<span class="ident" id="5184662">c</span><span class="op" id="5184663">[</span><span class="ident" id="5184664">i</span><span class="op" id="5184665">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184669">c</span><span class="op" id="5184670">[</span><span class="ident" id="5184671">i</span><span class="op" id="5184672">]</span>&nbsp;<span class="op" id="5184674">=</span>&nbsp;<span class="ident" id="5184676">sum</span>&nbsp;<span class="op" id="5184680">-</span>&nbsp;<span class="ident" id="5184682">c</span><span class="op" id="5184683">[</span><span class="ident" id="5184684">i</span><span class="op" id="5184685">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184688">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184692">for</span>&nbsp;<span class="ident" id="5184696">i</span>&nbsp;<span class="op" id="5184698">:=</span>&nbsp;<span class="keyword" id="5184701">range</span>&nbsp;<span class="ident" id="5184707">tt</span>&nbsp;<span class="op" id="5184710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184714">b</span>&nbsp;<span class="op" id="5184716">:=</span>&nbsp;<span class="ident" id="5184719">tt</span><span class="op" id="5184721">[</span><span class="ident" id="5184722">i</span><span class="op" id="5184723">]</span>&nbsp;<span class="op" id="5184725">&amp;</span>&nbsp;<span class="num" id="5184727">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184734">tt</span><span class="op" id="5184736">[</span><span class="ident" id="5184737">c</span><span class="op" id="5184738">[</span><span class="ident" id="5184739">b</span><span class="op" id="5184740">]</span><span class="op" id="5184741">]</span>&nbsp;<span class="op" id="5184743">|=</span>&nbsp;<span class="builtintype" id="5184746">uint32</span><span class="op" id="5184752">(</span><span class="ident" id="5184753">i</span><span class="op" id="5184754">)</span>&nbsp;<span class="op" id="5184756">&lt;&lt;</span>&nbsp;<span class="num" id="5184759">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184763">c</span><span class="op" id="5184764">[</span><span class="ident" id="5184765">b</span><span class="op" id="5184766">]</span><span class="op" id="5184767">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184775">return</span>&nbsp;<span class="ident" id="5184782">tt</span><span class="op" id="5184784">[</span><span class="ident" id="5184785">origPtr</span><span class="op" id="5184792">]</span>&nbsp;<span class="op" id="5184794">&gt;&gt;</span>&nbsp;<span class="num" id="5184797">8</span><br>
<span class="lineno"></span><span class="op" id="5184799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5184802">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5184890">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5184975">var</span>&nbsp;<span class="ident" id="5184979">crctab</span>&nbsp;<span class="op" id="5184986">[</span><span class="num" id="5184987">256</span><span class="op" id="5184990">]</span><span class="builtintype" id="5184991">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5184999">func</span>&nbsp;<span class="ident" id="5185004">init</span><span class="op" id="5185008">(</span><span class="op" id="5185009">)</span>&nbsp;<span class="op" id="5185011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185014">const</span>&nbsp;<span class="ident" id="5185020">poly</span>&nbsp;<span class="op" id="5185025">=</span>&nbsp;<span class="num" id="5185027">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185039">for</span>&nbsp;<span class="ident" id="5185043">i</span>&nbsp;<span class="op" id="5185045">:=</span>&nbsp;<span class="keyword" id="5185048">range</span>&nbsp;<span class="ident" id="5185054">crctab</span>&nbsp;<span class="op" id="5185061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185065">crc</span>&nbsp;<span class="op" id="5185069">:=</span>&nbsp;<span class="builtintype" id="5185072">uint32</span><span class="op" id="5185078">(</span><span class="ident" id="5185079">i</span><span class="op" id="5185080">)</span>&nbsp;<span class="op" id="5185082">&lt;&lt;</span>&nbsp;<span class="num" id="5185085">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185090">for</span>&nbsp;<span class="ident" id="5185094">j</span>&nbsp;<span class="op" id="5185096">:=</span>&nbsp;<span class="num" id="5185099">0</span><span class="op" id="5185100">;</span>&nbsp;<span class="ident" id="5185102">j</span>&nbsp;<span class="op" id="5185104">&lt;</span>&nbsp;<span class="num" id="5185106">8</span><span class="op" id="5185107">;</span>&nbsp;<span class="ident" id="5185109">j</span><span class="op" id="5185110">++</span>&nbsp;<span class="op" id="5185113">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185118">if</span>&nbsp;<span class="ident" id="5185121">crc</span><span class="op" id="5185124">&amp;</span><span class="num" id="5185125">0x80000000</span>&nbsp;<span class="op" id="5185136">!=</span>&nbsp;<span class="num" id="5185139">0</span>&nbsp;<span class="op" id="5185141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185147">crc</span>&nbsp;<span class="op" id="5185151">=</span>&nbsp;<span class="op" id="5185153">(</span><span class="ident" id="5185154">crc</span>&nbsp;<span class="op" id="5185158">&lt;&lt;</span>&nbsp;<span class="num" id="5185161">1</span><span class="op" id="5185162">)</span>&nbsp;<span class="op" id="5185164">^</span>&nbsp;<span class="ident" id="5185166">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185174">}</span>&nbsp;<span class="keyword" id="5185176">else</span>&nbsp;<span class="op" id="5185181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185187">crc</span>&nbsp;<span class="op" id="5185191">&lt;&lt;=</span>&nbsp;<span class="num" id="5185195">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185200">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185208">crctab</span><span class="op" id="5185214">[</span><span class="ident" id="5185215">i</span><span class="op" id="5185216">]</span>&nbsp;<span class="op" id="5185218">=</span>&nbsp;<span class="ident" id="5185220">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185225">}</span><br>
<span class="lineno"></span><span class="op" id="5185227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5185230">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5185295">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5185322">func</span>&nbsp;<span class="ident" id="5185327">updateCRC</span><span class="op" id="5185336">(</span><span class="ident" id="5185337">val</span>&nbsp;<span class="builtintype" id="5185341">uint32</span><span class="op" id="5185347">,</span>&nbsp;<span class="ident" id="5185349">b</span>&nbsp;<span class="op" id="5185351">[</span><span class="op" id="5185352">]</span><span class="builtintype" id="5185353">byte</span><span class="op" id="5185357">)</span>&nbsp;<span class="builtintype" id="5185359">uint32</span>&nbsp;<span class="op" id="5185366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185369">crc</span>&nbsp;<span class="op" id="5185373">:=</span>&nbsp;<span class="op" id="5185376">^</span><span class="ident" id="5185377">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185382">for</span>&nbsp;<span class="ident" id="5185386">_</span><span class="op" id="5185387">,</span>&nbsp;<span class="ident" id="5185389">v</span>&nbsp;<span class="op" id="5185391">:=</span>&nbsp;<span class="keyword" id="5185394">range</span>&nbsp;<span class="ident" id="5185400">b</span>&nbsp;<span class="op" id="5185402">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185406">crc</span>&nbsp;<span class="op" id="5185410">=</span>&nbsp;<span class="ident" id="5185412">crctab</span><span class="op" id="5185418">[</span><span class="builtintype" id="5185419">byte</span><span class="op" id="5185423">(</span><span class="ident" id="5185424">crc</span><span class="op" id="5185427">&gt;&gt;</span><span class="num" id="5185429">24</span><span class="op" id="5185431">)</span><span class="op" id="5185432">^</span><span class="ident" id="5185433">v</span><span class="op" id="5185434">]</span>&nbsp;<span class="op" id="5185436">^</span>&nbsp;<span class="op" id="5185438">(</span><span class="ident" id="5185439">crc</span>&nbsp;<span class="op" id="5185443">&lt;&lt;</span>&nbsp;<span class="num" id="5185446">8</span><span class="op" id="5185447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185453">return</span>&nbsp;<span class="op" id="5185460">^</span><span class="ident" id="5185461">crc</span><br>
<span class="lineno"></span><span class="op" id="5185465">}</span>
</div>
</body>
</html>
