<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6117031">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6117086">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6117140">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6117191">package</span>&nbsp;<span class="ident" id="6117199">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6117209">import</span>&nbsp;<span class="op" id="6117216">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117219">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117228">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117238">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117244">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117251">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117263">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6117280">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6117287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6117290">var</span>&nbsp;<span class="op" id="6117294">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117297">ErrPersistEOF</span>&nbsp;<span class="op" id="6117311">=</span>&nbsp;<span class="op" id="6117313">&amp;</span><span class="ident" id="6117314">http</span><span class="op" id="6117318">.</span><span class="ident" id="6117319">ProtocolError</span><span class="op" id="6117332">{</span><span class="ident" id="6117333">ErrorString</span><span class="op" id="6117344">:</span>&nbsp;<span class="string" id="6117346">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6117376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117379">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117393">=</span>&nbsp;<span class="op" id="6117395">&amp;</span><span class="ident" id="6117396">http</span><span class="op" id="6117400">.</span><span class="ident" id="6117401">ProtocolError</span><span class="op" id="6117414">{</span><span class="ident" id="6117415">ErrorString</span><span class="op" id="6117426">:</span>&nbsp;<span class="string" id="6117428">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6117455">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6117458">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6117472">=</span>&nbsp;<span class="op" id="6117474">&amp;</span><span class="ident" id="6117475">http</span><span class="op" id="6117479">.</span><span class="ident" id="6117480">ProtocolError</span><span class="op" id="6117493">{</span><span class="ident" id="6117494">ErrorString</span><span class="op" id="6117505">:</span>&nbsp;<span class="string" id="6117507">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6117523">}</span><br>
<span class="lineno"></span><span class="op" id="6117525">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6117528">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6117586">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6117651">var</span>&nbsp;<span class="ident" id="6117655">errClosed</span>&nbsp;<span class="op" id="6117665">=</span>&nbsp;<span class="ident" id="6117667">errors</span><span class="op" id="6117673">.</span><span class="ident" id="6117674">New</span><span class="op" id="6117677">(</span><span class="string" id="6117678">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6117714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6117717">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6117787">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6117861">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6117930">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6118005">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6118080">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6118114">//</span><br>
<span class="lineno"></span><span class="comment" id="6118117">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6118192">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6118220">type</span>&nbsp;<span class="ident" id="6118225">ServerConn</span>&nbsp;<span class="keyword" id="6118236">struct</span>&nbsp;<span class="op" id="6118243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118246">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118262">sync</span><span class="op" id="6118266">.</span><span class="ident" id="6118267">Mutex</span>&nbsp;<span class="comment" id="6118273">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118318">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118334">net</span><span class="op" id="6118337">.</span><span class="ident" id="6118338">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118344">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6118360">*</span><span class="ident" id="6118361">bufio</span><span class="op" id="6118366">.</span><span class="ident" id="6118367">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118375">re</span><span class="op" id="6118377">,</span>&nbsp;<span class="ident" id="6118379">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6118391">error</span>&nbsp;<span class="comment" id="6118397">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118419">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6118435">io</span><span class="op" id="6118437">.</span><span class="ident" id="6118438">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118450">nread</span><span class="op" id="6118455">,</span>&nbsp;<span class="ident" id="6118457">nwritten</span>&nbsp;<span class="builtintype" id="6118466">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118471">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6118487">map</span><span class="op" id="6118490">[</span><span class="op" id="6118491">*</span><span class="ident" id="6118492">http</span><span class="op" id="6118496">.</span><span class="ident" id="6118497">Request</span><span class="op" id="6118504">]</span><span class="builtintype" id="6118505">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118512">pipe</span>&nbsp;<span class="ident" id="6118517">textproto</span><span class="op" id="6118526">.</span><span class="ident" id="6118527">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6118536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6118539">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6118616">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6118664">//</span><br>
<span class="lineno"></span><span class="comment" id="6118667">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6118742">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6118770">func</span>&nbsp;<span class="ident" id="6118775">NewServerConn</span><span class="op" id="6118788">(</span><span class="ident" id="6118789">c</span>&nbsp;<span class="ident" id="6118791">net</span><span class="op" id="6118794">.</span><span class="ident" id="6118795">Conn</span><span class="op" id="6118799">,</span>&nbsp;<span class="ident" id="6118801">r</span>&nbsp;<span class="op" id="6118803">*</span><span class="ident" id="6118804">bufio</span><span class="op" id="6118809">.</span><span class="ident" id="6118810">Reader</span><span class="op" id="6118816">)</span>&nbsp;<span class="op" id="6118818">*</span><span class="ident" id="6118819">ServerConn</span>&nbsp;<span class="op" id="6118830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118833">if</span>&nbsp;<span class="ident" id="6118836">r</span>&nbsp;<span class="op" id="6118838">==</span>&nbsp;<span class="ident" id="6118841">nil</span>&nbsp;<span class="op" id="6118845">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6118849">r</span>&nbsp;<span class="op" id="6118851">=</span>&nbsp;<span class="ident" id="6118853">bufio</span><span class="op" id="6118858">.</span><span class="ident" id="6118859">NewReader</span><span class="op" id="6118868">(</span><span class="ident" id="6118869">c</span><span class="op" id="6118870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6118873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6118876">return</span>&nbsp;<span class="op" id="6118883">&amp;</span><span class="ident" id="6118884">ServerConn</span><span class="op" id="6118894">{</span><span class="ident" id="6118895">c</span><span class="op" id="6118896">:</span>&nbsp;<span class="ident" id="6118898">c</span><span class="op" id="6118899">,</span>&nbsp;<span class="ident" id="6118901">r</span><span class="op" id="6118902">:</span>&nbsp;<span class="ident" id="6118904">r</span><span class="op" id="6118905">,</span>&nbsp;<span class="ident" id="6118907">pipereq</span><span class="op" id="6118914">:</span>&nbsp;<span class="builtinfunc" id="6118916">make</span><span class="op" id="6118920">(</span><span class="keyword" id="6118921">map</span><span class="op" id="6118924">[</span><span class="op" id="6118925">*</span><span class="ident" id="6118926">http</span><span class="op" id="6118930">.</span><span class="ident" id="6118931">Request</span><span class="op" id="6118938">]</span><span class="builtintype" id="6118939">uint</span><span class="op" id="6118943">)</span><span class="op" id="6118944">}</span><br>
<span class="lineno"></span><span class="op" id="6118946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6118949">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6119029">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6119105">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6119182">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6119244">func</span>&nbsp;<span class="op" id="6119249">(</span><span class="ident" id="6119250">sc</span>&nbsp;<span class="op" id="6119253">*</span><span class="ident" id="6119254">ServerConn</span><span class="op" id="6119264">)</span>&nbsp;<span class="ident" id="6119266">Hijack</span><span class="op" id="6119272">(</span><span class="op" id="6119273">)</span>&nbsp;<span class="op" id="6119275">(</span><span class="ident" id="6119276">c</span>&nbsp;<span class="ident" id="6119278">net</span><span class="op" id="6119281">.</span><span class="ident" id="6119282">Conn</span><span class="op" id="6119286">,</span>&nbsp;<span class="ident" id="6119288">r</span>&nbsp;<span class="op" id="6119290">*</span><span class="ident" id="6119291">bufio</span><span class="op" id="6119296">.</span><span class="ident" id="6119297">Reader</span><span class="op" id="6119303">)</span>&nbsp;<span class="op" id="6119305">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119308">sc</span><span class="op" id="6119310">.</span><span class="ident" id="6119311">lk</span><span class="op" id="6119313">.</span><span class="ident" id="6119314">Lock</span><span class="op" id="6119318">(</span><span class="op" id="6119319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119322">defer</span>&nbsp;<span class="ident" id="6119328">sc</span><span class="op" id="6119330">.</span><span class="ident" id="6119331">lk</span><span class="op" id="6119333">.</span><span class="ident" id="6119334">Unlock</span><span class="op" id="6119340">(</span><span class="op" id="6119341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119344">c</span>&nbsp;<span class="op" id="6119346">=</span>&nbsp;<span class="ident" id="6119348">sc</span><span class="op" id="6119350">.</span><span class="ident" id="6119351">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119354">r</span>&nbsp;<span class="op" id="6119356">=</span>&nbsp;<span class="ident" id="6119358">sc</span><span class="op" id="6119360">.</span><span class="ident" id="6119361">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119364">sc</span><span class="op" id="6119366">.</span><span class="ident" id="6119367">c</span>&nbsp;<span class="op" id="6119369">=</span>&nbsp;<span class="ident" id="6119371">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119376">sc</span><span class="op" id="6119378">.</span><span class="ident" id="6119379">r</span>&nbsp;<span class="op" id="6119381">=</span>&nbsp;<span class="ident" id="6119383">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119388">return</span><br>
<span class="lineno"></span><span class="op" id="6119395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6119398">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6119467">func</span>&nbsp;<span class="op" id="6119472">(</span><span class="ident" id="6119473">sc</span>&nbsp;<span class="op" id="6119476">*</span><span class="ident" id="6119477">ServerConn</span><span class="op" id="6119487">)</span>&nbsp;<span class="ident" id="6119489">Close</span><span class="op" id="6119494">(</span><span class="op" id="6119495">)</span>&nbsp;<span class="builtintype" id="6119497">error</span>&nbsp;<span class="op" id="6119503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119506">c</span><span class="op" id="6119507">,</span>&nbsp;<span class="ident" id="6119509">_</span>&nbsp;<span class="op" id="6119511">:=</span>&nbsp;<span class="ident" id="6119514">sc</span><span class="op" id="6119516">.</span><span class="ident" id="6119517">Hijack</span><span class="op" id="6119523">(</span><span class="op" id="6119524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119527">if</span>&nbsp;<span class="ident" id="6119530">c</span>&nbsp;<span class="op" id="6119532">!=</span>&nbsp;<span class="ident" id="6119535">nil</span>&nbsp;<span class="op" id="6119539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119543">return</span>&nbsp;<span class="ident" id="6119550">c</span><span class="op" id="6119551">.</span><span class="ident" id="6119552">Close</span><span class="op" id="6119557">(</span><span class="op" id="6119558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6119561">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119564">return</span>&nbsp;<span class="ident" id="6119571">nil</span><br>
<span class="lineno"></span><span class="op" id="6119575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6119578">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6119656">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6119735">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6119812">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6119837">func</span>&nbsp;<span class="op" id="6119842">(</span><span class="ident" id="6119843">sc</span>&nbsp;<span class="op" id="6119846">*</span><span class="ident" id="6119847">ServerConn</span><span class="op" id="6119857">)</span>&nbsp;<span class="ident" id="6119859">Read</span><span class="op" id="6119863">(</span><span class="op" id="6119864">)</span>&nbsp;<span class="op" id="6119866">(</span><span class="ident" id="6119867">req</span>&nbsp;<span class="op" id="6119871">*</span><span class="ident" id="6119872">http</span><span class="op" id="6119876">.</span><span class="ident" id="6119877">Request</span><span class="op" id="6119884">,</span>&nbsp;<span class="ident" id="6119886">err</span>&nbsp;<span class="builtintype" id="6119890">error</span><span class="op" id="6119895">)</span>&nbsp;<span class="op" id="6119897">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6119901">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119950">id</span>&nbsp;<span class="op" id="6119953">:=</span>&nbsp;<span class="ident" id="6119956">sc</span><span class="op" id="6119958">.</span><span class="ident" id="6119959">pipe</span><span class="op" id="6119963">.</span><span class="ident" id="6119964">Next</span><span class="op" id="6119968">(</span><span class="op" id="6119969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6119972">sc</span><span class="op" id="6119974">.</span><span class="ident" id="6119975">pipe</span><span class="op" id="6119979">.</span><span class="ident" id="6119980">StartRequest</span><span class="op" id="6119992">(</span><span class="ident" id="6119993">id</span><span class="op" id="6119995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6119998">defer</span>&nbsp;<span class="keyword" id="6120004">func</span><span class="op" id="6120008">(</span><span class="op" id="6120009">)</span>&nbsp;<span class="op" id="6120011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120015">sc</span><span class="op" id="6120017">.</span><span class="ident" id="6120018">pipe</span><span class="op" id="6120022">.</span><span class="ident" id="6120023">EndRequest</span><span class="op" id="6120033">(</span><span class="ident" id="6120034">id</span><span class="op" id="6120036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120040">if</span>&nbsp;<span class="ident" id="6120043">req</span>&nbsp;<span class="op" id="6120047">==</span>&nbsp;<span class="ident" id="6120050">nil</span>&nbsp;<span class="op" id="6120054">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120059">sc</span><span class="op" id="6120061">.</span><span class="ident" id="6120062">pipe</span><span class="op" id="6120066">.</span><span class="ident" id="6120067">StartResponse</span><span class="op" id="6120080">(</span><span class="ident" id="6120081">id</span><span class="op" id="6120083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120088">sc</span><span class="op" id="6120090">.</span><span class="ident" id="6120091">pipe</span><span class="op" id="6120095">.</span><span class="ident" id="6120096">EndResponse</span><span class="op" id="6120107">(</span><span class="ident" id="6120108">id</span><span class="op" id="6120110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120114">}</span>&nbsp;<span class="keyword" id="6120116">else</span>&nbsp;<span class="op" id="6120121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120126">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120173">sc</span><span class="op" id="6120175">.</span><span class="ident" id="6120176">lk</span><span class="op" id="6120178">.</span><span class="ident" id="6120179">Lock</span><span class="op" id="6120183">(</span><span class="op" id="6120184">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120189">sc</span><span class="op" id="6120191">.</span><span class="ident" id="6120192">pipereq</span><span class="op" id="6120199">[</span><span class="ident" id="6120200">req</span><span class="op" id="6120203">]</span>&nbsp;<span class="op" id="6120205">=</span>&nbsp;<span class="ident" id="6120207">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120213">sc</span><span class="op" id="6120215">.</span><span class="ident" id="6120216">lk</span><span class="op" id="6120218">.</span><span class="ident" id="6120219">Unlock</span><span class="op" id="6120225">(</span><span class="op" id="6120226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120233">}</span><span class="op" id="6120234">(</span><span class="op" id="6120235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120239">sc</span><span class="op" id="6120241">.</span><span class="ident" id="6120242">lk</span><span class="op" id="6120244">.</span><span class="ident" id="6120245">Lock</span><span class="op" id="6120249">(</span><span class="op" id="6120250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120253">if</span>&nbsp;<span class="ident" id="6120256">sc</span><span class="op" id="6120258">.</span><span class="ident" id="6120259">we</span>&nbsp;<span class="op" id="6120262">!=</span>&nbsp;<span class="ident" id="6120265">nil</span>&nbsp;<span class="op" id="6120269">{</span>&nbsp;<span class="comment" id="6120271">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120326">defer</span>&nbsp;<span class="ident" id="6120332">sc</span><span class="op" id="6120334">.</span><span class="ident" id="6120335">lk</span><span class="op" id="6120337">.</span><span class="ident" id="6120338">Unlock</span><span class="op" id="6120344">(</span><span class="op" id="6120345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120349">return</span>&nbsp;<span class="ident" id="6120356">nil</span><span class="op" id="6120359">,</span>&nbsp;<span class="ident" id="6120361">sc</span><span class="op" id="6120363">.</span><span class="ident" id="6120364">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120368">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120371">if</span>&nbsp;<span class="ident" id="6120374">sc</span><span class="op" id="6120376">.</span><span class="ident" id="6120377">re</span>&nbsp;<span class="op" id="6120380">!=</span>&nbsp;<span class="ident" id="6120383">nil</span>&nbsp;<span class="op" id="6120387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120391">defer</span>&nbsp;<span class="ident" id="6120397">sc</span><span class="op" id="6120399">.</span><span class="ident" id="6120400">lk</span><span class="op" id="6120402">.</span><span class="ident" id="6120403">Unlock</span><span class="op" id="6120409">(</span><span class="op" id="6120410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120414">return</span>&nbsp;<span class="ident" id="6120421">nil</span><span class="op" id="6120424">,</span>&nbsp;<span class="ident" id="6120426">sc</span><span class="op" id="6120428">.</span><span class="ident" id="6120429">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120436">if</span>&nbsp;<span class="ident" id="6120439">sc</span><span class="op" id="6120441">.</span><span class="ident" id="6120442">r</span>&nbsp;<span class="op" id="6120444">==</span>&nbsp;<span class="ident" id="6120447">nil</span>&nbsp;<span class="op" id="6120451">{</span>&nbsp;<span class="comment" id="6120453">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120500">defer</span>&nbsp;<span class="ident" id="6120506">sc</span><span class="op" id="6120508">.</span><span class="ident" id="6120509">lk</span><span class="op" id="6120511">.</span><span class="ident" id="6120512">Unlock</span><span class="op" id="6120518">(</span><span class="op" id="6120519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120523">return</span>&nbsp;<span class="ident" id="6120530">nil</span><span class="op" id="6120533">,</span>&nbsp;<span class="ident" id="6120535">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120549">r</span>&nbsp;<span class="op" id="6120551">:=</span>&nbsp;<span class="ident" id="6120554">sc</span><span class="op" id="6120556">.</span><span class="ident" id="6120557">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120560">lastbody</span>&nbsp;<span class="op" id="6120569">:=</span>&nbsp;<span class="ident" id="6120572">sc</span><span class="op" id="6120574">.</span><span class="ident" id="6120575">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120585">sc</span><span class="op" id="6120587">.</span><span class="ident" id="6120588">lastbody</span>&nbsp;<span class="op" id="6120597">=</span>&nbsp;<span class="ident" id="6120599">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120604">sc</span><span class="op" id="6120606">.</span><span class="ident" id="6120607">lk</span><span class="op" id="6120609">.</span><span class="ident" id="6120610">Unlock</span><span class="op" id="6120616">(</span><span class="op" id="6120617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120621">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120697">if</span>&nbsp;<span class="ident" id="6120700">lastbody</span>&nbsp;<span class="op" id="6120709">!=</span>&nbsp;<span class="ident" id="6120712">nil</span>&nbsp;<span class="op" id="6120716">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120720">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120786">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6120844">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120859">err</span>&nbsp;<span class="op" id="6120863">=</span>&nbsp;<span class="ident" id="6120865">lastbody</span><span class="op" id="6120873">.</span><span class="ident" id="6120874">Close</span><span class="op" id="6120879">(</span><span class="op" id="6120880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120884">if</span>&nbsp;<span class="ident" id="6120887">err</span>&nbsp;<span class="op" id="6120891">!=</span>&nbsp;<span class="ident" id="6120894">nil</span>&nbsp;<span class="op" id="6120898">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120903">sc</span><span class="op" id="6120905">.</span><span class="ident" id="6120906">lk</span><span class="op" id="6120908">.</span><span class="ident" id="6120909">Lock</span><span class="op" id="6120913">(</span><span class="op" id="6120914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120919">defer</span>&nbsp;<span class="ident" id="6120925">sc</span><span class="op" id="6120927">.</span><span class="ident" id="6120928">lk</span><span class="op" id="6120930">.</span><span class="ident" id="6120931">Unlock</span><span class="op" id="6120937">(</span><span class="op" id="6120938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120943">sc</span><span class="op" id="6120945">.</span><span class="ident" id="6120946">re</span>&nbsp;<span class="op" id="6120949">=</span>&nbsp;<span class="ident" id="6120951">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6120958">return</span>&nbsp;<span class="ident" id="6120965">nil</span><span class="op" id="6120968">,</span>&nbsp;<span class="ident" id="6120970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120976">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6120979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6120983">req</span><span class="op" id="6120986">,</span>&nbsp;<span class="ident" id="6120988">err</span>&nbsp;<span class="op" id="6120992">=</span>&nbsp;<span class="ident" id="6120994">http</span><span class="op" id="6120998">.</span><span class="ident" id="6120999">ReadRequest</span><span class="op" id="6121010">(</span><span class="ident" id="6121011">r</span><span class="op" id="6121012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121015">sc</span><span class="op" id="6121017">.</span><span class="ident" id="6121018">lk</span><span class="op" id="6121020">.</span><span class="ident" id="6121021">Lock</span><span class="op" id="6121025">(</span><span class="op" id="6121026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121029">defer</span>&nbsp;<span class="ident" id="6121035">sc</span><span class="op" id="6121037">.</span><span class="ident" id="6121038">lk</span><span class="op" id="6121040">.</span><span class="ident" id="6121041">Unlock</span><span class="op" id="6121047">(</span><span class="op" id="6121048">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121051">if</span>&nbsp;<span class="ident" id="6121054">err</span>&nbsp;<span class="op" id="6121058">!=</span>&nbsp;<span class="ident" id="6121061">nil</span>&nbsp;<span class="op" id="6121065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121069">if</span>&nbsp;<span class="ident" id="6121072">err</span>&nbsp;<span class="op" id="6121076">==</span>&nbsp;<span class="ident" id="6121079">io</span><span class="op" id="6121081">.</span><span class="ident" id="6121082">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6121099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6121104">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6121159">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6121217">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121246">sc</span><span class="op" id="6121248">.</span><span class="ident" id="6121249">re</span>&nbsp;<span class="op" id="6121252">=</span>&nbsp;<span class="ident" id="6121254">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121271">return</span>&nbsp;<span class="ident" id="6121278">nil</span><span class="op" id="6121281">,</span>&nbsp;<span class="ident" id="6121283">sc</span><span class="op" id="6121285">.</span><span class="ident" id="6121286">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121291">}</span>&nbsp;<span class="keyword" id="6121293">else</span>&nbsp;<span class="op" id="6121298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121303">sc</span><span class="op" id="6121305">.</span><span class="ident" id="6121306">re</span>&nbsp;<span class="op" id="6121309">=</span>&nbsp;<span class="ident" id="6121311">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121318">return</span>&nbsp;<span class="ident" id="6121325">req</span><span class="op" id="6121328">,</span>&nbsp;<span class="ident" id="6121330">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121342">sc</span><span class="op" id="6121344">.</span><span class="ident" id="6121345">lastbody</span>&nbsp;<span class="op" id="6121354">=</span>&nbsp;<span class="ident" id="6121356">req</span><span class="op" id="6121359">.</span><span class="ident" id="6121360">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121366">sc</span><span class="op" id="6121368">.</span><span class="ident" id="6121369">nread</span><span class="op" id="6121374">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121378">if</span>&nbsp;<span class="ident" id="6121381">req</span><span class="op" id="6121384">.</span><span class="ident" id="6121385">Close</span>&nbsp;<span class="op" id="6121391">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121395">sc</span><span class="op" id="6121397">.</span><span class="ident" id="6121398">re</span>&nbsp;<span class="op" id="6121401">=</span>&nbsp;<span class="ident" id="6121403">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121419">return</span>&nbsp;<span class="ident" id="6121426">req</span><span class="op" id="6121429">,</span>&nbsp;<span class="ident" id="6121431">sc</span><span class="op" id="6121433">.</span><span class="ident" id="6121434">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6121438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121441">return</span>&nbsp;<span class="ident" id="6121448">req</span><span class="op" id="6121451">,</span>&nbsp;<span class="ident" id="6121453">err</span><br>
<span class="lineno"></span><span class="op" id="6121457">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6121460">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6121513">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6121559">func</span>&nbsp;<span class="op" id="6121564">(</span><span class="ident" id="6121565">sc</span>&nbsp;<span class="op" id="6121568">*</span><span class="ident" id="6121569">ServerConn</span><span class="op" id="6121579">)</span>&nbsp;<span class="ident" id="6121581">Pending</span><span class="op" id="6121588">(</span><span class="op" id="6121589">)</span>&nbsp;<span class="builtintype" id="6121591">int</span>&nbsp;<span class="op" id="6121595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6121598">sc</span><span class="op" id="6121600">.</span><span class="ident" id="6121601">lk</span><span class="op" id="6121603">.</span><span class="ident" id="6121604">Lock</span><span class="op" id="6121608">(</span><span class="op" id="6121609">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121612">defer</span>&nbsp;<span class="ident" id="6121618">sc</span><span class="op" id="6121620">.</span><span class="ident" id="6121621">lk</span><span class="op" id="6121623">.</span><span class="ident" id="6121624">Unlock</span><span class="op" id="6121630">(</span><span class="op" id="6121631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6121634">return</span>&nbsp;<span class="ident" id="6121641">sc</span><span class="op" id="6121643">.</span><span class="ident" id="6121644">nread</span>&nbsp;<span class="op" id="6121650">-</span>&nbsp;<span class="ident" id="6121652">sc</span><span class="op" id="6121654">.</span><span class="ident" id="6121655">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6121664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6121667">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6121752">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6121830">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6121906">func</span>&nbsp;<span class="op" id="6121911">(</span><span class="ident" id="6121912">sc</span>&nbsp;<span class="op" id="6121915">*</span><span class="ident" id="6121916">ServerConn</span><span class="op" id="6121926">)</span>&nbsp;<span class="ident" id="6121928">Write</span><span class="op" id="6121933">(</span><span class="ident" id="6121934">req</span>&nbsp;<span class="op" id="6121938">*</span><span class="ident" id="6121939">http</span><span class="op" id="6121943">.</span><span class="ident" id="6121944">Request</span><span class="op" id="6121951">,</span>&nbsp;<span class="ident" id="6121953">resp</span>&nbsp;<span class="op" id="6121958">*</span><span class="ident" id="6121959">http</span><span class="op" id="6121963">.</span><span class="ident" id="6121964">Response</span><span class="op" id="6121972">)</span>&nbsp;<span class="builtintype" id="6121974">error</span>&nbsp;<span class="op" id="6121980">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6121984">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122043">sc</span><span class="op" id="6122045">.</span><span class="ident" id="6122046">lk</span><span class="op" id="6122048">.</span><span class="ident" id="6122049">Lock</span><span class="op" id="6122053">(</span><span class="op" id="6122054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122057">id</span><span class="op" id="6122059">,</span>&nbsp;<span class="ident" id="6122061">ok</span>&nbsp;<span class="op" id="6122064">:=</span>&nbsp;<span class="ident" id="6122067">sc</span><span class="op" id="6122069">.</span><span class="ident" id="6122070">pipereq</span><span class="op" id="6122077">[</span><span class="ident" id="6122078">req</span><span class="op" id="6122081">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6122084">delete</span><span class="op" id="6122090">(</span><span class="ident" id="6122091">sc</span><span class="op" id="6122093">.</span><span class="ident" id="6122094">pipereq</span><span class="op" id="6122101">,</span>&nbsp;<span class="ident" id="6122103">req</span><span class="op" id="6122106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122109">if</span>&nbsp;<span class="op" id="6122112">!</span><span class="ident" id="6122113">ok</span>&nbsp;<span class="op" id="6122116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122120">sc</span><span class="op" id="6122122">.</span><span class="ident" id="6122123">lk</span><span class="op" id="6122125">.</span><span class="ident" id="6122126">Unlock</span><span class="op" id="6122132">(</span><span class="op" id="6122133">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122137">return</span>&nbsp;<span class="ident" id="6122144">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122160">sc</span><span class="op" id="6122162">.</span><span class="ident" id="6122163">lk</span><span class="op" id="6122165">.</span><span class="ident" id="6122166">Unlock</span><span class="op" id="6122172">(</span><span class="op" id="6122173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6122177">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122203">sc</span><span class="op" id="6122205">.</span><span class="ident" id="6122206">pipe</span><span class="op" id="6122210">.</span><span class="ident" id="6122211">StartResponse</span><span class="op" id="6122224">(</span><span class="ident" id="6122225">id</span><span class="op" id="6122227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122230">defer</span>&nbsp;<span class="ident" id="6122236">sc</span><span class="op" id="6122238">.</span><span class="ident" id="6122239">pipe</span><span class="op" id="6122243">.</span><span class="ident" id="6122244">EndResponse</span><span class="op" id="6122255">(</span><span class="ident" id="6122256">id</span><span class="op" id="6122258">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122262">sc</span><span class="op" id="6122264">.</span><span class="ident" id="6122265">lk</span><span class="op" id="6122267">.</span><span class="ident" id="6122268">Lock</span><span class="op" id="6122272">(</span><span class="op" id="6122273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122276">if</span>&nbsp;<span class="ident" id="6122279">sc</span><span class="op" id="6122281">.</span><span class="ident" id="6122282">we</span>&nbsp;<span class="op" id="6122285">!=</span>&nbsp;<span class="ident" id="6122288">nil</span>&nbsp;<span class="op" id="6122292">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122296">defer</span>&nbsp;<span class="ident" id="6122302">sc</span><span class="op" id="6122304">.</span><span class="ident" id="6122305">lk</span><span class="op" id="6122307">.</span><span class="ident" id="6122308">Unlock</span><span class="op" id="6122314">(</span><span class="op" id="6122315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122319">return</span>&nbsp;<span class="ident" id="6122326">sc</span><span class="op" id="6122328">.</span><span class="ident" id="6122329">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122336">if</span>&nbsp;<span class="ident" id="6122339">sc</span><span class="op" id="6122341">.</span><span class="ident" id="6122342">c</span>&nbsp;<span class="op" id="6122344">==</span>&nbsp;<span class="ident" id="6122347">nil</span>&nbsp;<span class="op" id="6122351">{</span>&nbsp;<span class="comment" id="6122353">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122400">defer</span>&nbsp;<span class="ident" id="6122406">sc</span><span class="op" id="6122408">.</span><span class="ident" id="6122409">lk</span><span class="op" id="6122411">.</span><span class="ident" id="6122412">Unlock</span><span class="op" id="6122418">(</span><span class="op" id="6122419">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122423">return</span>&nbsp;<span class="ident" id="6122430">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122444">c</span>&nbsp;<span class="op" id="6122446">:=</span>&nbsp;<span class="ident" id="6122449">sc</span><span class="op" id="6122451">.</span><span class="ident" id="6122452">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122455">if</span>&nbsp;<span class="ident" id="6122458">sc</span><span class="op" id="6122460">.</span><span class="ident" id="6122461">nread</span>&nbsp;<span class="op" id="6122467">&lt;=</span>&nbsp;<span class="ident" id="6122470">sc</span><span class="op" id="6122472">.</span><span class="ident" id="6122473">nwritten</span>&nbsp;<span class="op" id="6122482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122486">defer</span>&nbsp;<span class="ident" id="6122492">sc</span><span class="op" id="6122494">.</span><span class="ident" id="6122495">lk</span><span class="op" id="6122497">.</span><span class="ident" id="6122498">Unlock</span><span class="op" id="6122504">(</span><span class="op" id="6122505">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122509">return</span>&nbsp;<span class="ident" id="6122516">errors</span><span class="op" id="6122522">.</span><span class="ident" id="6122523">New</span><span class="op" id="6122526">(</span><span class="string" id="6122527">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6122554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122560">if</span>&nbsp;<span class="ident" id="6122563">resp</span><span class="op" id="6122567">.</span><span class="ident" id="6122568">Close</span>&nbsp;<span class="op" id="6122574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6122578">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6122640">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6122703">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122726">sc</span><span class="op" id="6122728">.</span><span class="ident" id="6122729">re</span>&nbsp;<span class="op" id="6122732">=</span>&nbsp;<span class="ident" id="6122734">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122752">sc</span><span class="op" id="6122754">.</span><span class="ident" id="6122755">lk</span><span class="op" id="6122757">.</span><span class="ident" id="6122758">Unlock</span><span class="op" id="6122764">(</span><span class="op" id="6122765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122769">err</span>&nbsp;<span class="op" id="6122773">:=</span>&nbsp;<span class="ident" id="6122776">resp</span><span class="op" id="6122780">.</span><span class="ident" id="6122781">Write</span><span class="op" id="6122786">(</span><span class="ident" id="6122787">c</span><span class="op" id="6122788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122791">sc</span><span class="op" id="6122793">.</span><span class="ident" id="6122794">lk</span><span class="op" id="6122796">.</span><span class="ident" id="6122797">Lock</span><span class="op" id="6122801">(</span><span class="op" id="6122802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122805">defer</span>&nbsp;<span class="ident" id="6122811">sc</span><span class="op" id="6122813">.</span><span class="ident" id="6122814">lk</span><span class="op" id="6122816">.</span><span class="ident" id="6122817">Unlock</span><span class="op" id="6122823">(</span><span class="op" id="6122824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122827">if</span>&nbsp;<span class="ident" id="6122830">err</span>&nbsp;<span class="op" id="6122834">!=</span>&nbsp;<span class="ident" id="6122837">nil</span>&nbsp;<span class="op" id="6122841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122845">sc</span><span class="op" id="6122847">.</span><span class="ident" id="6122848">we</span>&nbsp;<span class="op" id="6122851">=</span>&nbsp;<span class="ident" id="6122853">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122859">return</span>&nbsp;<span class="ident" id="6122866">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122874">sc</span><span class="op" id="6122876">.</span><span class="ident" id="6122877">nwritten</span><span class="op" id="6122885">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122890">return</span>&nbsp;<span class="ident" id="6122897">nil</span><br>
<span class="lineno">220</span><span class="op" id="6122901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6122904">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6122974">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6123043">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6123098">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6123172">//</span><br>
<span class="lineno"></span><span class="comment" id="6123175">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6123243">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6123291">type</span>&nbsp;<span class="ident" id="6123296">ClientConn</span>&nbsp;<span class="keyword" id="6123307">struct</span>&nbsp;<span class="op" id="6123314">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123317">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123333">sync</span><span class="op" id="6123337">.</span><span class="ident" id="6123338">Mutex</span>&nbsp;<span class="comment" id="6123344">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123389">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123405">net</span><span class="op" id="6123408">.</span><span class="ident" id="6123409">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123415">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6123431">*</span><span class="ident" id="6123432">bufio</span><span class="op" id="6123437">.</span><span class="ident" id="6123438">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123446">re</span><span class="op" id="6123448">,</span>&nbsp;<span class="ident" id="6123450">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6123462">error</span>&nbsp;<span class="comment" id="6123468">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123490">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123506">io</span><span class="op" id="6123508">.</span><span class="ident" id="6123509">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123521">nread</span><span class="op" id="6123526">,</span>&nbsp;<span class="ident" id="6123528">nwritten</span>&nbsp;<span class="builtintype" id="6123537">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123542">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6123558">map</span><span class="op" id="6123561">[</span><span class="op" id="6123562">*</span><span class="ident" id="6123563">http</span><span class="op" id="6123567">.</span><span class="ident" id="6123568">Request</span><span class="op" id="6123575">]</span><span class="builtintype" id="6123576">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123583">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6123592">textproto</span><span class="op" id="6123601">.</span><span class="ident" id="6123602">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123612">writeReq</span>&nbsp;<span class="keyword" id="6123621">func</span><span class="op" id="6123625">(</span><span class="op" id="6123626">*</span><span class="ident" id="6123627">http</span><span class="op" id="6123631">.</span><span class="ident" id="6123632">Request</span><span class="op" id="6123639">,</span>&nbsp;<span class="ident" id="6123641">io</span><span class="op" id="6123643">.</span><span class="ident" id="6123644">Writer</span><span class="op" id="6123650">)</span>&nbsp;<span class="builtintype" id="6123652">error</span><br>
<span class="lineno">240</span><span class="op" id="6123658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6123661">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6123739">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6123787">//</span><br>
<span class="lineno">245</span><span class="comment" id="6123790">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6123860">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6123898">func</span>&nbsp;<span class="ident" id="6123903">NewClientConn</span><span class="op" id="6123916">(</span><span class="ident" id="6123917">c</span>&nbsp;<span class="ident" id="6123919">net</span><span class="op" id="6123922">.</span><span class="ident" id="6123923">Conn</span><span class="op" id="6123927">,</span>&nbsp;<span class="ident" id="6123929">r</span>&nbsp;<span class="op" id="6123931">*</span><span class="ident" id="6123932">bufio</span><span class="op" id="6123937">.</span><span class="ident" id="6123938">Reader</span><span class="op" id="6123944">)</span>&nbsp;<span class="op" id="6123946">*</span><span class="ident" id="6123947">ClientConn</span>&nbsp;<span class="op" id="6123958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123961">if</span>&nbsp;<span class="ident" id="6123964">r</span>&nbsp;<span class="op" id="6123966">==</span>&nbsp;<span class="ident" id="6123969">nil</span>&nbsp;<span class="op" id="6123973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123977">r</span>&nbsp;<span class="op" id="6123979">=</span>&nbsp;<span class="ident" id="6123981">bufio</span><span class="op" id="6123986">.</span><span class="ident" id="6123987">NewReader</span><span class="op" id="6123996">(</span><span class="ident" id="6123997">c</span><span class="op" id="6123998">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124004">return</span>&nbsp;<span class="op" id="6124011">&amp;</span><span class="ident" id="6124012">ClientConn</span><span class="op" id="6124022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124026">c</span><span class="op" id="6124027">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124036">c</span><span class="op" id="6124037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124041">r</span><span class="op" id="6124042">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6124051">r</span><span class="op" id="6124052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124056">pipereq</span><span class="op" id="6124063">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6124066">make</span><span class="op" id="6124070">(</span><span class="keyword" id="6124071">map</span><span class="op" id="6124074">[</span><span class="op" id="6124075">*</span><span class="ident" id="6124076">http</span><span class="op" id="6124080">.</span><span class="ident" id="6124081">Request</span><span class="op" id="6124088">]</span><span class="builtintype" id="6124089">uint</span><span class="op" id="6124093">)</span><span class="op" id="6124094">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124098">writeReq</span><span class="op" id="6124106">:</span>&nbsp;<span class="op" id="6124108">(</span><span class="op" id="6124109">*</span><span class="ident" id="6124110">http</span><span class="op" id="6124114">.</span><span class="ident" id="6124115">Request</span><span class="op" id="6124122">)</span><span class="op" id="6124123">.</span><span class="ident" id="6124124">Write</span><span class="op" id="6124129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124132">}</span><br>
<span class="lineno"></span><span class="op" id="6124134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6124137">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6124204">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6124242">//</span><br>
<span class="lineno"></span><span class="comment" id="6124245">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6124306">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6124352">func</span>&nbsp;<span class="ident" id="6124357">NewProxyClientConn</span><span class="op" id="6124375">(</span><span class="ident" id="6124376">c</span>&nbsp;<span class="ident" id="6124378">net</span><span class="op" id="6124381">.</span><span class="ident" id="6124382">Conn</span><span class="op" id="6124386">,</span>&nbsp;<span class="ident" id="6124388">r</span>&nbsp;<span class="op" id="6124390">*</span><span class="ident" id="6124391">bufio</span><span class="op" id="6124396">.</span><span class="ident" id="6124397">Reader</span><span class="op" id="6124403">)</span>&nbsp;<span class="op" id="6124405">*</span><span class="ident" id="6124406">ClientConn</span>&nbsp;<span class="op" id="6124417">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124420">cc</span>&nbsp;<span class="op" id="6124423">:=</span>&nbsp;<span class="ident" id="6124426">NewClientConn</span><span class="op" id="6124439">(</span><span class="ident" id="6124440">c</span><span class="op" id="6124441">,</span>&nbsp;<span class="ident" id="6124443">r</span><span class="op" id="6124444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124447">cc</span><span class="op" id="6124449">.</span><span class="ident" id="6124450">writeReq</span>&nbsp;<span class="op" id="6124459">=</span>&nbsp;<span class="op" id="6124461">(</span><span class="op" id="6124462">*</span><span class="ident" id="6124463">http</span><span class="op" id="6124467">.</span><span class="ident" id="6124468">Request</span><span class="op" id="6124475">)</span><span class="op" id="6124476">.</span><span class="ident" id="6124477">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124489">return</span>&nbsp;<span class="ident" id="6124496">cc</span><br>
<span class="lineno"></span><span class="op" id="6124499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6124502">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6124582">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6124658">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6124732">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6124810">func</span>&nbsp;<span class="op" id="6124815">(</span><span class="ident" id="6124816">cc</span>&nbsp;<span class="op" id="6124819">*</span><span class="ident" id="6124820">ClientConn</span><span class="op" id="6124830">)</span>&nbsp;<span class="ident" id="6124832">Hijack</span><span class="op" id="6124838">(</span><span class="op" id="6124839">)</span>&nbsp;<span class="op" id="6124841">(</span><span class="ident" id="6124842">c</span>&nbsp;<span class="ident" id="6124844">net</span><span class="op" id="6124847">.</span><span class="ident" id="6124848">Conn</span><span class="op" id="6124852">,</span>&nbsp;<span class="ident" id="6124854">r</span>&nbsp;<span class="op" id="6124856">*</span><span class="ident" id="6124857">bufio</span><span class="op" id="6124862">.</span><span class="ident" id="6124863">Reader</span><span class="op" id="6124869">)</span>&nbsp;<span class="op" id="6124871">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124874">cc</span><span class="op" id="6124876">.</span><span class="ident" id="6124877">lk</span><span class="op" id="6124879">.</span><span class="ident" id="6124880">Lock</span><span class="op" id="6124884">(</span><span class="op" id="6124885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124888">defer</span>&nbsp;<span class="ident" id="6124894">cc</span><span class="op" id="6124896">.</span><span class="ident" id="6124897">lk</span><span class="op" id="6124899">.</span><span class="ident" id="6124900">Unlock</span><span class="op" id="6124906">(</span><span class="op" id="6124907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124910">c</span>&nbsp;<span class="op" id="6124912">=</span>&nbsp;<span class="ident" id="6124914">cc</span><span class="op" id="6124916">.</span><span class="ident" id="6124917">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124920">r</span>&nbsp;<span class="op" id="6124922">=</span>&nbsp;<span class="ident" id="6124924">cc</span><span class="op" id="6124926">.</span><span class="ident" id="6124927">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124930">cc</span><span class="op" id="6124932">.</span><span class="ident" id="6124933">c</span>&nbsp;<span class="op" id="6124935">=</span>&nbsp;<span class="ident" id="6124937">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124942">cc</span><span class="op" id="6124944">.</span><span class="ident" id="6124945">r</span>&nbsp;<span class="op" id="6124947">=</span>&nbsp;<span class="ident" id="6124949">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124954">return</span><br>
<span class="lineno"></span><span class="op" id="6124961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6124964">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6125033">func</span>&nbsp;<span class="op" id="6125038">(</span><span class="ident" id="6125039">cc</span>&nbsp;<span class="op" id="6125042">*</span><span class="ident" id="6125043">ClientConn</span><span class="op" id="6125053">)</span>&nbsp;<span class="ident" id="6125055">Close</span><span class="op" id="6125060">(</span><span class="op" id="6125061">)</span>&nbsp;<span class="builtintype" id="6125063">error</span>&nbsp;<span class="op" id="6125069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125072">c</span><span class="op" id="6125073">,</span>&nbsp;<span class="ident" id="6125075">_</span>&nbsp;<span class="op" id="6125077">:=</span>&nbsp;<span class="ident" id="6125080">cc</span><span class="op" id="6125082">.</span><span class="ident" id="6125083">Hijack</span><span class="op" id="6125089">(</span><span class="op" id="6125090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125093">if</span>&nbsp;<span class="ident" id="6125096">c</span>&nbsp;<span class="op" id="6125098">!=</span>&nbsp;<span class="ident" id="6125101">nil</span>&nbsp;<span class="op" id="6125105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125109">return</span>&nbsp;<span class="ident" id="6125116">c</span><span class="op" id="6125117">.</span><span class="ident" id="6125118">Close</span><span class="op" id="6125123">(</span><span class="op" id="6125124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125127">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125130">return</span>&nbsp;<span class="ident" id="6125137">nil</span><br>
<span class="lineno"></span><span class="op" id="6125141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6125144">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6125224">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6125301">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6125381">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6125456">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6125533">func</span>&nbsp;<span class="op" id="6125538">(</span><span class="ident" id="6125539">cc</span>&nbsp;<span class="op" id="6125542">*</span><span class="ident" id="6125543">ClientConn</span><span class="op" id="6125553">)</span>&nbsp;<span class="ident" id="6125555">Write</span><span class="op" id="6125560">(</span><span class="ident" id="6125561">req</span>&nbsp;<span class="op" id="6125565">*</span><span class="ident" id="6125566">http</span><span class="op" id="6125570">.</span><span class="ident" id="6125571">Request</span><span class="op" id="6125578">)</span>&nbsp;<span class="op" id="6125580">(</span><span class="ident" id="6125581">err</span>&nbsp;<span class="builtintype" id="6125585">error</span><span class="op" id="6125590">)</span>&nbsp;<span class="op" id="6125592">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125596">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125635">id</span>&nbsp;<span class="op" id="6125638">:=</span>&nbsp;<span class="ident" id="6125641">cc</span><span class="op" id="6125643">.</span><span class="ident" id="6125644">pipe</span><span class="op" id="6125648">.</span><span class="ident" id="6125649">Next</span><span class="op" id="6125653">(</span><span class="op" id="6125654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125657">cc</span><span class="op" id="6125659">.</span><span class="ident" id="6125660">pipe</span><span class="op" id="6125664">.</span><span class="ident" id="6125665">StartRequest</span><span class="op" id="6125677">(</span><span class="ident" id="6125678">id</span><span class="op" id="6125680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125683">defer</span>&nbsp;<span class="keyword" id="6125689">func</span><span class="op" id="6125693">(</span><span class="op" id="6125694">)</span>&nbsp;<span class="op" id="6125696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125700">cc</span><span class="op" id="6125702">.</span><span class="ident" id="6125703">pipe</span><span class="op" id="6125707">.</span><span class="ident" id="6125708">EndRequest</span><span class="op" id="6125718">(</span><span class="ident" id="6125719">id</span><span class="op" id="6125721">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125725">if</span>&nbsp;<span class="ident" id="6125728">err</span>&nbsp;<span class="op" id="6125732">!=</span>&nbsp;<span class="ident" id="6125735">nil</span>&nbsp;<span class="op" id="6125739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125744">cc</span><span class="op" id="6125746">.</span><span class="ident" id="6125747">pipe</span><span class="op" id="6125751">.</span><span class="ident" id="6125752">StartResponse</span><span class="op" id="6125765">(</span><span class="ident" id="6125766">id</span><span class="op" id="6125768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125773">cc</span><span class="op" id="6125775">.</span><span class="ident" id="6125776">pipe</span><span class="op" id="6125780">.</span><span class="ident" id="6125781">EndResponse</span><span class="op" id="6125792">(</span><span class="ident" id="6125793">id</span><span class="op" id="6125795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125799">}</span>&nbsp;<span class="keyword" id="6125801">else</span>&nbsp;<span class="op" id="6125806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125811">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125858">cc</span><span class="op" id="6125860">.</span><span class="ident" id="6125861">lk</span><span class="op" id="6125863">.</span><span class="ident" id="6125864">Lock</span><span class="op" id="6125868">(</span><span class="op" id="6125869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125874">cc</span><span class="op" id="6125876">.</span><span class="ident" id="6125877">pipereq</span><span class="op" id="6125884">[</span><span class="ident" id="6125885">req</span><span class="op" id="6125888">]</span>&nbsp;<span class="op" id="6125890">=</span>&nbsp;<span class="ident" id="6125892">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125898">cc</span><span class="op" id="6125900">.</span><span class="ident" id="6125901">lk</span><span class="op" id="6125903">.</span><span class="ident" id="6125904">Unlock</span><span class="op" id="6125910">(</span><span class="op" id="6125911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125918">}</span><span class="op" id="6125919">(</span><span class="op" id="6125920">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125924">cc</span><span class="op" id="6125926">.</span><span class="ident" id="6125927">lk</span><span class="op" id="6125929">.</span><span class="ident" id="6125930">Lock</span><span class="op" id="6125934">(</span><span class="op" id="6125935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125938">if</span>&nbsp;<span class="ident" id="6125941">cc</span><span class="op" id="6125943">.</span><span class="ident" id="6125944">re</span>&nbsp;<span class="op" id="6125947">!=</span>&nbsp;<span class="ident" id="6125950">nil</span>&nbsp;<span class="op" id="6125954">{</span>&nbsp;<span class="comment" id="6125956">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126008">defer</span>&nbsp;<span class="ident" id="6126014">cc</span><span class="op" id="6126016">.</span><span class="ident" id="6126017">lk</span><span class="op" id="6126019">.</span><span class="ident" id="6126020">Unlock</span><span class="op" id="6126026">(</span><span class="op" id="6126027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126031">return</span>&nbsp;<span class="ident" id="6126038">cc</span><span class="op" id="6126040">.</span><span class="ident" id="6126041">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126048">if</span>&nbsp;<span class="ident" id="6126051">cc</span><span class="op" id="6126053">.</span><span class="ident" id="6126054">we</span>&nbsp;<span class="op" id="6126057">!=</span>&nbsp;<span class="ident" id="6126060">nil</span>&nbsp;<span class="op" id="6126064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126068">defer</span>&nbsp;<span class="ident" id="6126074">cc</span><span class="op" id="6126076">.</span><span class="ident" id="6126077">lk</span><span class="op" id="6126079">.</span><span class="ident" id="6126080">Unlock</span><span class="op" id="6126086">(</span><span class="op" id="6126087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126091">return</span>&nbsp;<span class="ident" id="6126098">cc</span><span class="op" id="6126100">.</span><span class="ident" id="6126101">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126105">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126108">if</span>&nbsp;<span class="ident" id="6126111">cc</span><span class="op" id="6126113">.</span><span class="ident" id="6126114">c</span>&nbsp;<span class="op" id="6126116">==</span>&nbsp;<span class="ident" id="6126119">nil</span>&nbsp;<span class="op" id="6126123">{</span>&nbsp;<span class="comment" id="6126125">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126172">defer</span>&nbsp;<span class="ident" id="6126178">cc</span><span class="op" id="6126180">.</span><span class="ident" id="6126181">lk</span><span class="op" id="6126183">.</span><span class="ident" id="6126184">Unlock</span><span class="op" id="6126190">(</span><span class="op" id="6126191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126195">return</span>&nbsp;<span class="ident" id="6126202">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126216">c</span>&nbsp;<span class="op" id="6126218">:=</span>&nbsp;<span class="ident" id="6126221">cc</span><span class="op" id="6126223">.</span><span class="ident" id="6126224">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126227">if</span>&nbsp;<span class="ident" id="6126230">req</span><span class="op" id="6126233">.</span><span class="ident" id="6126234">Close</span>&nbsp;<span class="op" id="6126240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6126244">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6126305">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126346">cc</span><span class="op" id="6126348">.</span><span class="ident" id="6126349">we</span>&nbsp;<span class="op" id="6126352">=</span>&nbsp;<span class="ident" id="6126354">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126369">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126372">cc</span><span class="op" id="6126374">.</span><span class="ident" id="6126375">lk</span><span class="op" id="6126377">.</span><span class="ident" id="6126378">Unlock</span><span class="op" id="6126384">(</span><span class="op" id="6126385">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126389">err</span>&nbsp;<span class="op" id="6126393">=</span>&nbsp;<span class="ident" id="6126395">cc</span><span class="op" id="6126397">.</span><span class="ident" id="6126398">writeReq</span><span class="op" id="6126406">(</span><span class="ident" id="6126407">req</span><span class="op" id="6126410">,</span>&nbsp;<span class="ident" id="6126412">c</span><span class="op" id="6126413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126416">cc</span><span class="op" id="6126418">.</span><span class="ident" id="6126419">lk</span><span class="op" id="6126421">.</span><span class="ident" id="6126422">Lock</span><span class="op" id="6126426">(</span><span class="op" id="6126427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126430">defer</span>&nbsp;<span class="ident" id="6126436">cc</span><span class="op" id="6126438">.</span><span class="ident" id="6126439">lk</span><span class="op" id="6126441">.</span><span class="ident" id="6126442">Unlock</span><span class="op" id="6126448">(</span><span class="op" id="6126449">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126452">if</span>&nbsp;<span class="ident" id="6126455">err</span>&nbsp;<span class="op" id="6126459">!=</span>&nbsp;<span class="ident" id="6126462">nil</span>&nbsp;<span class="op" id="6126466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126470">cc</span><span class="op" id="6126472">.</span><span class="ident" id="6126473">we</span>&nbsp;<span class="op" id="6126476">=</span>&nbsp;<span class="ident" id="6126478">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126484">return</span>&nbsp;<span class="ident" id="6126491">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126499">cc</span><span class="op" id="6126501">.</span><span class="ident" id="6126502">nwritten</span><span class="op" id="6126510">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126515">return</span>&nbsp;<span class="ident" id="6126522">nil</span><br>
<span class="lineno"></span><span class="op" id="6126526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6126529">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6126582">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6126624">func</span>&nbsp;<span class="op" id="6126629">(</span><span class="ident" id="6126630">cc</span>&nbsp;<span class="op" id="6126633">*</span><span class="ident" id="6126634">ClientConn</span><span class="op" id="6126644">)</span>&nbsp;<span class="ident" id="6126646">Pending</span><span class="op" id="6126653">(</span><span class="op" id="6126654">)</span>&nbsp;<span class="builtintype" id="6126656">int</span>&nbsp;<span class="op" id="6126660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6126663">cc</span><span class="op" id="6126665">.</span><span class="ident" id="6126666">lk</span><span class="op" id="6126668">.</span><span class="ident" id="6126669">Lock</span><span class="op" id="6126673">(</span><span class="op" id="6126674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126677">defer</span>&nbsp;<span class="ident" id="6126683">cc</span><span class="op" id="6126685">.</span><span class="ident" id="6126686">lk</span><span class="op" id="6126688">.</span><span class="ident" id="6126689">Unlock</span><span class="op" id="6126695">(</span><span class="op" id="6126696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126699">return</span>&nbsp;<span class="ident" id="6126706">cc</span><span class="op" id="6126708">.</span><span class="ident" id="6126709">nwritten</span>&nbsp;<span class="op" id="6126718">-</span>&nbsp;<span class="ident" id="6126720">cc</span><span class="op" id="6126722">.</span><span class="ident" id="6126723">nread</span><br>
<span class="lineno">355</span><span class="op" id="6126729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6126732">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6126805">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6126877">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6126949">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6127004">func</span>&nbsp;<span class="op" id="6127009">(</span><span class="ident" id="6127010">cc</span>&nbsp;<span class="op" id="6127013">*</span><span class="ident" id="6127014">ClientConn</span><span class="op" id="6127024">)</span>&nbsp;<span class="ident" id="6127026">Read</span><span class="op" id="6127030">(</span><span class="ident" id="6127031">req</span>&nbsp;<span class="op" id="6127035">*</span><span class="ident" id="6127036">http</span><span class="op" id="6127040">.</span><span class="ident" id="6127041">Request</span><span class="op" id="6127048">)</span>&nbsp;<span class="op" id="6127050">(</span><span class="ident" id="6127051">resp</span>&nbsp;<span class="op" id="6127056">*</span><span class="ident" id="6127057">http</span><span class="op" id="6127061">.</span><span class="ident" id="6127062">Response</span><span class="op" id="6127070">,</span>&nbsp;<span class="ident" id="6127072">err</span>&nbsp;<span class="builtintype" id="6127076">error</span><span class="op" id="6127081">)</span>&nbsp;<span class="op" id="6127083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127086">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127145">cc</span><span class="op" id="6127147">.</span><span class="ident" id="6127148">lk</span><span class="op" id="6127150">.</span><span class="ident" id="6127151">Lock</span><span class="op" id="6127155">(</span><span class="op" id="6127156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127159">id</span><span class="op" id="6127161">,</span>&nbsp;<span class="ident" id="6127163">ok</span>&nbsp;<span class="op" id="6127166">:=</span>&nbsp;<span class="ident" id="6127169">cc</span><span class="op" id="6127171">.</span><span class="ident" id="6127172">pipereq</span><span class="op" id="6127179">[</span><span class="ident" id="6127180">req</span><span class="op" id="6127183">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6127186">delete</span><span class="op" id="6127192">(</span><span class="ident" id="6127193">cc</span><span class="op" id="6127195">.</span><span class="ident" id="6127196">pipereq</span><span class="op" id="6127203">,</span>&nbsp;<span class="ident" id="6127205">req</span><span class="op" id="6127208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127211">if</span>&nbsp;<span class="op" id="6127214">!</span><span class="ident" id="6127215">ok</span>&nbsp;<span class="op" id="6127218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127222">cc</span><span class="op" id="6127224">.</span><span class="ident" id="6127225">lk</span><span class="op" id="6127227">.</span><span class="ident" id="6127228">Unlock</span><span class="op" id="6127234">(</span><span class="op" id="6127235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127239">return</span>&nbsp;<span class="ident" id="6127246">nil</span><span class="op" id="6127249">,</span>&nbsp;<span class="ident" id="6127251">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127264">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127267">cc</span><span class="op" id="6127269">.</span><span class="ident" id="6127270">lk</span><span class="op" id="6127272">.</span><span class="ident" id="6127273">Unlock</span><span class="op" id="6127279">(</span><span class="op" id="6127280">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127284">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127310">cc</span><span class="op" id="6127312">.</span><span class="ident" id="6127313">pipe</span><span class="op" id="6127317">.</span><span class="ident" id="6127318">StartResponse</span><span class="op" id="6127331">(</span><span class="ident" id="6127332">id</span><span class="op" id="6127334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127337">defer</span>&nbsp;<span class="ident" id="6127343">cc</span><span class="op" id="6127345">.</span><span class="ident" id="6127346">pipe</span><span class="op" id="6127350">.</span><span class="ident" id="6127351">EndResponse</span><span class="op" id="6127362">(</span><span class="ident" id="6127363">id</span><span class="op" id="6127365">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127369">cc</span><span class="op" id="6127371">.</span><span class="ident" id="6127372">lk</span><span class="op" id="6127374">.</span><span class="ident" id="6127375">Lock</span><span class="op" id="6127379">(</span><span class="op" id="6127380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127383">if</span>&nbsp;<span class="ident" id="6127386">cc</span><span class="op" id="6127388">.</span><span class="ident" id="6127389">re</span>&nbsp;<span class="op" id="6127392">!=</span>&nbsp;<span class="ident" id="6127395">nil</span>&nbsp;<span class="op" id="6127399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127403">defer</span>&nbsp;<span class="ident" id="6127409">cc</span><span class="op" id="6127411">.</span><span class="ident" id="6127412">lk</span><span class="op" id="6127414">.</span><span class="ident" id="6127415">Unlock</span><span class="op" id="6127421">(</span><span class="op" id="6127422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127426">return</span>&nbsp;<span class="ident" id="6127433">nil</span><span class="op" id="6127436">,</span>&nbsp;<span class="ident" id="6127438">cc</span><span class="op" id="6127440">.</span><span class="ident" id="6127441">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127448">if</span>&nbsp;<span class="ident" id="6127451">cc</span><span class="op" id="6127453">.</span><span class="ident" id="6127454">r</span>&nbsp;<span class="op" id="6127456">==</span>&nbsp;<span class="ident" id="6127459">nil</span>&nbsp;<span class="op" id="6127463">{</span>&nbsp;<span class="comment" id="6127465">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127512">defer</span>&nbsp;<span class="ident" id="6127518">cc</span><span class="op" id="6127520">.</span><span class="ident" id="6127521">lk</span><span class="op" id="6127523">.</span><span class="ident" id="6127524">Unlock</span><span class="op" id="6127530">(</span><span class="op" id="6127531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127535">return</span>&nbsp;<span class="ident" id="6127542">nil</span><span class="op" id="6127545">,</span>&nbsp;<span class="ident" id="6127547">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127558">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127561">r</span>&nbsp;<span class="op" id="6127563">:=</span>&nbsp;<span class="ident" id="6127566">cc</span><span class="op" id="6127568">.</span><span class="ident" id="6127569">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127572">lastbody</span>&nbsp;<span class="op" id="6127581">:=</span>&nbsp;<span class="ident" id="6127584">cc</span><span class="op" id="6127586">.</span><span class="ident" id="6127587">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127597">cc</span><span class="op" id="6127599">.</span><span class="ident" id="6127600">lastbody</span>&nbsp;<span class="op" id="6127609">=</span>&nbsp;<span class="ident" id="6127611">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127616">cc</span><span class="op" id="6127618">.</span><span class="ident" id="6127619">lk</span><span class="op" id="6127621">.</span><span class="ident" id="6127622">Unlock</span><span class="op" id="6127628">(</span><span class="op" id="6127629">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127633">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127709">if</span>&nbsp;<span class="ident" id="6127712">lastbody</span>&nbsp;<span class="op" id="6127721">!=</span>&nbsp;<span class="ident" id="6127724">nil</span>&nbsp;<span class="op" id="6127728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127732">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127798">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6127856">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127871">err</span>&nbsp;<span class="op" id="6127875">=</span>&nbsp;<span class="ident" id="6127877">lastbody</span><span class="op" id="6127885">.</span><span class="ident" id="6127886">Close</span><span class="op" id="6127891">(</span><span class="op" id="6127892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127896">if</span>&nbsp;<span class="ident" id="6127899">err</span>&nbsp;<span class="op" id="6127903">!=</span>&nbsp;<span class="ident" id="6127906">nil</span>&nbsp;<span class="op" id="6127910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127915">cc</span><span class="op" id="6127917">.</span><span class="ident" id="6127918">lk</span><span class="op" id="6127920">.</span><span class="ident" id="6127921">Lock</span><span class="op" id="6127925">(</span><span class="op" id="6127926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127931">defer</span>&nbsp;<span class="ident" id="6127937">cc</span><span class="op" id="6127939">.</span><span class="ident" id="6127940">lk</span><span class="op" id="6127942">.</span><span class="ident" id="6127943">Unlock</span><span class="op" id="6127949">(</span><span class="op" id="6127950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127955">cc</span><span class="op" id="6127957">.</span><span class="ident" id="6127958">re</span>&nbsp;<span class="op" id="6127961">=</span>&nbsp;<span class="ident" id="6127963">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127970">return</span>&nbsp;<span class="ident" id="6127977">nil</span><span class="op" id="6127980">,</span>&nbsp;<span class="ident" id="6127982">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127995">resp</span><span class="op" id="6127999">,</span>&nbsp;<span class="ident" id="6128001">err</span>&nbsp;<span class="op" id="6128005">=</span>&nbsp;<span class="ident" id="6128007">http</span><span class="op" id="6128011">.</span><span class="ident" id="6128012">ReadResponse</span><span class="op" id="6128024">(</span><span class="ident" id="6128025">r</span><span class="op" id="6128026">,</span>&nbsp;<span class="ident" id="6128028">req</span><span class="op" id="6128031">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128034">cc</span><span class="op" id="6128036">.</span><span class="ident" id="6128037">lk</span><span class="op" id="6128039">.</span><span class="ident" id="6128040">Lock</span><span class="op" id="6128044">(</span><span class="op" id="6128045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128048">defer</span>&nbsp;<span class="ident" id="6128054">cc</span><span class="op" id="6128056">.</span><span class="ident" id="6128057">lk</span><span class="op" id="6128059">.</span><span class="ident" id="6128060">Unlock</span><span class="op" id="6128066">(</span><span class="op" id="6128067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128070">if</span>&nbsp;<span class="ident" id="6128073">err</span>&nbsp;<span class="op" id="6128077">!=</span>&nbsp;<span class="ident" id="6128080">nil</span>&nbsp;<span class="op" id="6128084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128088">cc</span><span class="op" id="6128090">.</span><span class="ident" id="6128091">re</span>&nbsp;<span class="op" id="6128094">=</span>&nbsp;<span class="ident" id="6128096">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128102">return</span>&nbsp;<span class="ident" id="6128109">resp</span><span class="op" id="6128113">,</span>&nbsp;<span class="ident" id="6128115">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128123">cc</span><span class="op" id="6128125">.</span><span class="ident" id="6128126">lastbody</span>&nbsp;<span class="op" id="6128135">=</span>&nbsp;<span class="ident" id="6128137">resp</span><span class="op" id="6128141">.</span><span class="ident" id="6128142">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128149">cc</span><span class="op" id="6128151">.</span><span class="ident" id="6128152">nread</span><span class="op" id="6128157">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128162">if</span>&nbsp;<span class="ident" id="6128165">resp</span><span class="op" id="6128169">.</span><span class="ident" id="6128170">Close</span>&nbsp;<span class="op" id="6128176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128180">cc</span><span class="op" id="6128182">.</span><span class="ident" id="6128183">re</span>&nbsp;<span class="op" id="6128186">=</span>&nbsp;<span class="ident" id="6128188">ErrPersistEOF</span>&nbsp;<span class="comment" id="6128202">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128236">return</span>&nbsp;<span class="ident" id="6128243">resp</span><span class="op" id="6128247">,</span>&nbsp;<span class="ident" id="6128249">cc</span><span class="op" id="6128251">.</span><span class="ident" id="6128252">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128259">return</span>&nbsp;<span class="ident" id="6128266">resp</span><span class="op" id="6128270">,</span>&nbsp;<span class="ident" id="6128272">err</span><br>
<span class="lineno">420</span><span class="op" id="6128276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128279">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6128351">func</span>&nbsp;<span class="op" id="6128356">(</span><span class="ident" id="6128357">cc</span>&nbsp;<span class="op" id="6128360">*</span><span class="ident" id="6128361">ClientConn</span><span class="op" id="6128371">)</span>&nbsp;<span class="ident" id="6128373">Do</span><span class="op" id="6128375">(</span><span class="ident" id="6128376">req</span>&nbsp;<span class="op" id="6128380">*</span><span class="ident" id="6128381">http</span><span class="op" id="6128385">.</span><span class="ident" id="6128386">Request</span><span class="op" id="6128393">)</span>&nbsp;<span class="op" id="6128395">(</span><span class="ident" id="6128396">resp</span>&nbsp;<span class="op" id="6128401">*</span><span class="ident" id="6128402">http</span><span class="op" id="6128406">.</span><span class="ident" id="6128407">Response</span><span class="op" id="6128415">,</span>&nbsp;<span class="ident" id="6128417">err</span>&nbsp;<span class="builtintype" id="6128421">error</span><span class="op" id="6128426">)</span>&nbsp;<span class="op" id="6128428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128431">err</span>&nbsp;<span class="op" id="6128435">=</span>&nbsp;<span class="ident" id="6128437">cc</span><span class="op" id="6128439">.</span><span class="ident" id="6128440">Write</span><span class="op" id="6128445">(</span><span class="ident" id="6128446">req</span><span class="op" id="6128449">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128452">if</span>&nbsp;<span class="ident" id="6128455">err</span>&nbsp;<span class="op" id="6128459">!=</span>&nbsp;<span class="ident" id="6128462">nil</span>&nbsp;<span class="op" id="6128466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128470">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128481">return</span>&nbsp;<span class="ident" id="6128488">cc</span><span class="op" id="6128490">.</span><span class="ident" id="6128491">Read</span><span class="op" id="6128495">(</span><span class="ident" id="6128496">req</span><span class="op" id="6128499">)</span><br>
<span class="lineno"></span><span class="op" id="6128501">}</span>
</div>
</body>
</html>
