<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3061774">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3061830">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3061884">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3061935">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3062013">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3062060">package</span>&nbsp;<span class="ident" id="3062068">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3062073">import</span>&nbsp;<span class="op" id="3062080">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3062083">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3062094">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3062101">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3062104">func</span>&nbsp;<span class="ident" id="3062109">probeIPv4Stack</span><span class="op" id="3062123">(</span><span class="op" id="3062124">)</span>&nbsp;<span class="builtintype" id="3062126">bool</span>&nbsp;<span class="op" id="3062131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062134">s</span><span class="op" id="3062135">,</span>&nbsp;<span class="ident" id="3062137">err</span>&nbsp;<span class="op" id="3062141">:=</span>&nbsp;<span class="ident" id="3062144">syscall</span><span class="op" id="3062151">.</span><span class="ident" id="3062152">Socket</span><span class="op" id="3062158">(</span><span class="ident" id="3062159">syscall</span><span class="op" id="3062166">.</span><span class="ident" id="3062167">AF_INET</span><span class="op" id="3062174">,</span>&nbsp;<span class="ident" id="3062176">syscall</span><span class="op" id="3062183">.</span><span class="ident" id="3062184">SOCK_STREAM</span><span class="op" id="3062195">,</span>&nbsp;<span class="ident" id="3062197">syscall</span><span class="op" id="3062204">.</span><span class="ident" id="3062205">IPPROTO_TCP</span><span class="op" id="3062216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062219">switch</span>&nbsp;<span class="ident" id="3062226">err</span>&nbsp;<span class="op" id="3062230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062233">case</span>&nbsp;<span class="ident" id="3062238">syscall</span><span class="op" id="3062245">.</span><span class="ident" id="3062246">EAFNOSUPPORT</span><span class="op" id="3062258">,</span>&nbsp;<span class="ident" id="3062260">syscall</span><span class="op" id="3062267">.</span><span class="ident" id="3062268">EPROTONOSUPPORT</span><span class="op" id="3062283">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062287">return</span>&nbsp;<span class="builtintype" id="3062294">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062301">case</span>&nbsp;<span class="ident" id="3062306">nil</span><span class="op" id="3062309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3062313">closesocket</span><span class="op" id="3062324">(</span><span class="ident" id="3062325">s</span><span class="op" id="3062326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3062329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3062332">return</span>&nbsp;<span class="builtintype" id="3062339">true</span><br>
<span class="lineno">25</span><span class="op" id="3062344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3062347">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3062406">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3062469">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3062535">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3062596">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3062659">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3062714">//</span><br>
<span class="lineno"></span><span class="comment" id="3062717">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3062784">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3062848">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3062902">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3062967">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3063033">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3063094">func</span>&nbsp;<span class="ident" id="3063099">probeIPv6Stack</span><span class="op" id="3063113">(</span><span class="op" id="3063114">)</span>&nbsp;<span class="op" id="3063116">(</span><span class="ident" id="3063117">supportsIPv6</span><span class="op" id="3063129">,</span>&nbsp;<span class="ident" id="3063131">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3063147">bool</span><span class="op" id="3063151">)</span>&nbsp;<span class="op" id="3063153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063156">var</span>&nbsp;<span class="ident" id="3063160">probes</span>&nbsp;<span class="op" id="3063167">=</span>&nbsp;<span class="op" id="3063169">[</span><span class="op" id="3063170">]</span><span class="keyword" id="3063171">struct</span>&nbsp;<span class="op" id="3063178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063182">laddr</span>&nbsp;<span class="ident" id="3063188">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063198">value</span>&nbsp;<span class="builtintype" id="3063204">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063210">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3063216">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063222">}</span><span class="op" id="3063223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063227">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063262">{</span><span class="ident" id="3063263">laddr</span><span class="op" id="3063268">:</span>&nbsp;<span class="ident" id="3063270">TCPAddr</span><span class="op" id="3063277">{</span><span class="ident" id="3063278">IP</span><span class="op" id="3063280">:</span>&nbsp;<span class="ident" id="3063282">ParseIP</span><span class="op" id="3063289">(</span><span class="string" id="3063290">&#34;::1&#34;</span><span class="op" id="3063295">)</span><span class="op" id="3063296">}</span><span class="op" id="3063297">,</span>&nbsp;<span class="ident" id="3063299">value</span><span class="op" id="3063304">:</span>&nbsp;<span class="num" id="3063306">1</span><span class="op" id="3063307">}</span><span class="op" id="3063308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3063312">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063367">{</span><span class="ident" id="3063368">laddr</span><span class="op" id="3063373">:</span>&nbsp;<span class="ident" id="3063375">TCPAddr</span><span class="op" id="3063382">{</span><span class="ident" id="3063383">IP</span><span class="op" id="3063385">:</span>&nbsp;<span class="ident" id="3063387">IPv4</span><span class="op" id="3063391">(</span><span class="num" id="3063392">127</span><span class="op" id="3063395">,</span>&nbsp;<span class="num" id="3063397">0</span><span class="op" id="3063398">,</span>&nbsp;<span class="num" id="3063400">0</span><span class="op" id="3063401">,</span>&nbsp;<span class="num" id="3063403">1</span><span class="op" id="3063404">)</span><span class="op" id="3063405">}</span><span class="op" id="3063406">,</span>&nbsp;<span class="ident" id="3063408">value</span><span class="op" id="3063413">:</span>&nbsp;<span class="num" id="3063415">0</span><span class="op" id="3063416">}</span><span class="op" id="3063417">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063424">for</span>&nbsp;<span class="ident" id="3063428">i</span>&nbsp;<span class="op" id="3063430">:=</span>&nbsp;<span class="keyword" id="3063433">range</span>&nbsp;<span class="ident" id="3063439">probes</span>&nbsp;<span class="op" id="3063446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063450">s</span><span class="op" id="3063451">,</span>&nbsp;<span class="ident" id="3063453">err</span>&nbsp;<span class="op" id="3063457">:=</span>&nbsp;<span class="ident" id="3063460">syscall</span><span class="op" id="3063467">.</span><span class="ident" id="3063468">Socket</span><span class="op" id="3063474">(</span><span class="ident" id="3063475">syscall</span><span class="op" id="3063482">.</span><span class="ident" id="3063483">AF_INET6</span><span class="op" id="3063491">,</span>&nbsp;<span class="ident" id="3063493">syscall</span><span class="op" id="3063500">.</span><span class="ident" id="3063501">SOCK_STREAM</span><span class="op" id="3063512">,</span>&nbsp;<span class="ident" id="3063514">syscall</span><span class="op" id="3063521">.</span><span class="ident" id="3063522">IPPROTO_TCP</span><span class="op" id="3063533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063537">if</span>&nbsp;<span class="ident" id="3063540">err</span>&nbsp;<span class="op" id="3063544">!=</span>&nbsp;<span class="ident" id="3063547">nil</span>&nbsp;<span class="op" id="3063551">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063556">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063571">defer</span>&nbsp;<span class="ident" id="3063577">closesocket</span><span class="op" id="3063588">(</span><span class="ident" id="3063589">s</span><span class="op" id="3063590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063594">syscall</span><span class="op" id="3063601">.</span><span class="ident" id="3063602">SetsockoptInt</span><span class="op" id="3063615">(</span><span class="ident" id="3063616">s</span><span class="op" id="3063617">,</span>&nbsp;<span class="ident" id="3063619">syscall</span><span class="op" id="3063626">.</span><span class="ident" id="3063627">IPPROTO_IPV6</span><span class="op" id="3063639">,</span>&nbsp;<span class="ident" id="3063641">syscall</span><span class="op" id="3063648">.</span><span class="ident" id="3063649">IPV6_V6ONLY</span><span class="op" id="3063660">,</span>&nbsp;<span class="ident" id="3063662">probes</span><span class="op" id="3063668">[</span><span class="ident" id="3063669">i</span><span class="op" id="3063670">]</span><span class="op" id="3063671">.</span><span class="ident" id="3063672">value</span><span class="op" id="3063677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063681">sa</span><span class="op" id="3063683">,</span>&nbsp;<span class="ident" id="3063685">err</span>&nbsp;<span class="op" id="3063689">:=</span>&nbsp;<span class="ident" id="3063692">probes</span><span class="op" id="3063698">[</span><span class="ident" id="3063699">i</span><span class="op" id="3063700">]</span><span class="op" id="3063701">.</span><span class="ident" id="3063702">laddr</span><span class="op" id="3063707">.</span><span class="ident" id="3063708">sockaddr</span><span class="op" id="3063716">(</span><span class="ident" id="3063717">syscall</span><span class="op" id="3063724">.</span><span class="ident" id="3063725">AF_INET6</span><span class="op" id="3063733">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063737">if</span>&nbsp;<span class="ident" id="3063740">err</span>&nbsp;<span class="op" id="3063744">!=</span>&nbsp;<span class="ident" id="3063747">nil</span>&nbsp;<span class="op" id="3063751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063756">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063771">if</span>&nbsp;<span class="ident" id="3063774">err</span>&nbsp;<span class="op" id="3063778">:=</span>&nbsp;<span class="ident" id="3063781">syscall</span><span class="op" id="3063788">.</span><span class="ident" id="3063789">Bind</span><span class="op" id="3063793">(</span><span class="ident" id="3063794">s</span><span class="op" id="3063795">,</span>&nbsp;<span class="ident" id="3063797">sa</span><span class="op" id="3063799">)</span><span class="op" id="3063800">;</span>&nbsp;<span class="ident" id="3063802">err</span>&nbsp;<span class="op" id="3063806">!=</span>&nbsp;<span class="ident" id="3063809">nil</span>&nbsp;<span class="op" id="3063813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063818">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3063833">probes</span><span class="op" id="3063839">[</span><span class="ident" id="3063840">i</span><span class="op" id="3063841">]</span><span class="op" id="3063842">.</span><span class="ident" id="3063843">ok</span>&nbsp;<span class="op" id="3063846">=</span>&nbsp;<span class="builtintype" id="3063848">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3063854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3063858">return</span>&nbsp;<span class="ident" id="3063865">probes</span><span class="op" id="3063871">[</span><span class="num" id="3063872">0</span><span class="op" id="3063873">]</span><span class="op" id="3063874">.</span><span class="ident" id="3063875">ok</span><span class="op" id="3063877">,</span>&nbsp;<span class="ident" id="3063879">probes</span><span class="op" id="3063885">[</span><span class="num" id="3063886">1</span><span class="op" id="3063887">]</span><span class="op" id="3063888">.</span><span class="ident" id="3063889">ok</span><br>
<span class="lineno">70</span><span class="op" id="3063892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3063895">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3063959">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3064021">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3064085">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3064147">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3064213">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3064277">//</span><br>
<span class="lineno"></span><span class="comment" id="3064280">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3064317">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3064377">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3064436">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3064492">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3064551">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3064602">//</span><br>
<span class="lineno"></span><span class="comment" id="3064605">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3064653">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3064667">//</span><br>
<span class="lineno"></span><span class="comment" id="3064670">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3064715">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3064774">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3064832">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3064892">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3064915">//</span><br>
<span class="lineno">95</span><span class="comment" id="3064918">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3064973">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3065026">//</span><br>
<span class="lineno"></span><span class="comment" id="3065029">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3065081">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3065142">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3065153">//</span><br>
<span class="lineno"></span><span class="comment" id="3065156">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3065224">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3065291">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3065325">//</span><br>
<span class="lineno"></span><span class="comment" id="3065328">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3065396">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3065457">func</span>&nbsp;<span class="ident" id="3065462">favoriteAddrFamily</span><span class="op" id="3065480">(</span><span class="ident" id="3065481">net</span>&nbsp;<span class="builtintype" id="3065485">string</span><span class="op" id="3065491">,</span>&nbsp;<span class="ident" id="3065493">laddr</span><span class="op" id="3065498">,</span>&nbsp;<span class="ident" id="3065500">raddr</span>&nbsp;<span class="ident" id="3065506">sockaddr</span><span class="op" id="3065514">,</span>&nbsp;<span class="ident" id="3065516">mode</span>&nbsp;<span class="builtintype" id="3065521">string</span><span class="op" id="3065527">)</span>&nbsp;<span class="op" id="3065529">(</span><span class="ident" id="3065530">family</span>&nbsp;<span class="builtintype" id="3065537">int</span><span class="op" id="3065540">,</span>&nbsp;<span class="ident" id="3065542">ipv6only</span>&nbsp;<span class="builtintype" id="3065551">bool</span><span class="op" id="3065555">)</span>&nbsp;<span class="op" id="3065557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065560">switch</span>&nbsp;<span class="ident" id="3065567">net</span><span class="op" id="3065570">[</span><span class="builtinfunc" id="3065571">len</span><span class="op" id="3065574">(</span><span class="ident" id="3065575">net</span><span class="op" id="3065578">)</span><span class="op" id="3065579">-</span><span class="num" id="3065580">1</span><span class="op" id="3065581">]</span>&nbsp;<span class="op" id="3065583">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065586">case</span>&nbsp;<span class="string" id="3065591">&#39;4&#39;</span><span class="op" id="3065594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065598">return</span>&nbsp;<span class="ident" id="3065605">syscall</span><span class="op" id="3065612">.</span><span class="ident" id="3065613">AF_INET</span><span class="op" id="3065620">,</span>&nbsp;<span class="builtintype" id="3065622">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065629">case</span>&nbsp;<span class="string" id="3065634">&#39;6&#39;</span><span class="op" id="3065637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065641">return</span>&nbsp;<span class="ident" id="3065648">syscall</span><span class="op" id="3065655">.</span><span class="ident" id="3065656">AF_INET6</span><span class="op" id="3065664">,</span>&nbsp;<span class="builtintype" id="3065666">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065672">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065676">if</span>&nbsp;<span class="ident" id="3065679">mode</span>&nbsp;<span class="op" id="3065684">==</span>&nbsp;<span class="string" id="3065687">&#34;listen&#34;</span>&nbsp;<span class="op" id="3065696">&amp;&amp;</span>&nbsp;<span class="op" id="3065699">(</span><span class="ident" id="3065700">laddr</span>&nbsp;<span class="op" id="3065706">==</span>&nbsp;<span class="ident" id="3065709">nil</span>&nbsp;<span class="op" id="3065713">||</span>&nbsp;<span class="ident" id="3065716">laddr</span><span class="op" id="3065721">.</span><span class="ident" id="3065722">isWildcard</span><span class="op" id="3065732">(</span><span class="op" id="3065733">)</span><span class="op" id="3065734">)</span>&nbsp;<span class="op" id="3065736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065740">if</span>&nbsp;<span class="ident" id="3065743">supportsIPv4map</span>&nbsp;<span class="op" id="3065759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065764">return</span>&nbsp;<span class="ident" id="3065771">syscall</span><span class="op" id="3065778">.</span><span class="ident" id="3065779">AF_INET6</span><span class="op" id="3065787">,</span>&nbsp;<span class="builtintype" id="3065789">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065797">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065801">if</span>&nbsp;<span class="ident" id="3065804">laddr</span>&nbsp;<span class="op" id="3065810">==</span>&nbsp;<span class="ident" id="3065813">nil</span>&nbsp;<span class="op" id="3065817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065822">return</span>&nbsp;<span class="ident" id="3065829">syscall</span><span class="op" id="3065836">.</span><span class="ident" id="3065837">AF_INET</span><span class="op" id="3065844">,</span>&nbsp;<span class="builtintype" id="3065846">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065858">return</span>&nbsp;<span class="ident" id="3065865">laddr</span><span class="op" id="3065870">.</span><span class="ident" id="3065871">family</span><span class="op" id="3065877">(</span><span class="op" id="3065878">)</span><span class="op" id="3065879">,</span>&nbsp;<span class="builtintype" id="3065881">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065888">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065892">if</span>&nbsp;<span class="op" id="3065895">(</span><span class="ident" id="3065896">laddr</span>&nbsp;<span class="op" id="3065902">==</span>&nbsp;<span class="ident" id="3065905">nil</span>&nbsp;<span class="op" id="3065909">||</span>&nbsp;<span class="ident" id="3065912">laddr</span><span class="op" id="3065917">.</span><span class="ident" id="3065918">family</span><span class="op" id="3065924">(</span><span class="op" id="3065925">)</span>&nbsp;<span class="op" id="3065927">==</span>&nbsp;<span class="ident" id="3065930">syscall</span><span class="op" id="3065937">.</span><span class="ident" id="3065938">AF_INET</span><span class="op" id="3065945">)</span>&nbsp;<span class="op" id="3065947">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065952">(</span><span class="ident" id="3065953">raddr</span>&nbsp;<span class="op" id="3065959">==</span>&nbsp;<span class="ident" id="3065962">nil</span>&nbsp;<span class="op" id="3065966">||</span>&nbsp;<span class="ident" id="3065969">raddr</span><span class="op" id="3065974">.</span><span class="ident" id="3065975">family</span><span class="op" id="3065981">(</span><span class="op" id="3065982">)</span>&nbsp;<span class="op" id="3065984">==</span>&nbsp;<span class="ident" id="3065987">syscall</span><span class="op" id="3065994">.</span><span class="ident" id="3065995">AF_INET</span><span class="op" id="3066002">)</span>&nbsp;<span class="op" id="3066004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066008">return</span>&nbsp;<span class="ident" id="3066015">syscall</span><span class="op" id="3066022">.</span><span class="ident" id="3066023">AF_INET</span><span class="op" id="3066030">,</span>&nbsp;<span class="builtintype" id="3066032">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066039">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066042">return</span>&nbsp;<span class="ident" id="3066049">syscall</span><span class="op" id="3066056">.</span><span class="ident" id="3066057">AF_INET6</span><span class="op" id="3066065">,</span>&nbsp;<span class="builtintype" id="3066067">false</span><br>
<span class="lineno"></span><span class="op" id="3066073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066076">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3066112">func</span>&nbsp;<span class="ident" id="3066117">internetSocket</span><span class="op" id="3066131">(</span><span class="ident" id="3066132">net</span>&nbsp;<span class="builtintype" id="3066136">string</span><span class="op" id="3066142">,</span>&nbsp;<span class="ident" id="3066144">laddr</span><span class="op" id="3066149">,</span>&nbsp;<span class="ident" id="3066151">raddr</span>&nbsp;<span class="ident" id="3066157">sockaddr</span><span class="op" id="3066165">,</span>&nbsp;<span class="ident" id="3066167">deadline</span>&nbsp;<span class="ident" id="3066176">time</span><span class="op" id="3066180">.</span><span class="ident" id="3066181">Time</span><span class="op" id="3066185">,</span>&nbsp;<span class="ident" id="3066187">sotype</span><span class="op" id="3066193">,</span>&nbsp;<span class="ident" id="3066195">proto</span>&nbsp;<span class="builtintype" id="3066201">int</span><span class="op" id="3066204">,</span>&nbsp;<span class="ident" id="3066206">mode</span>&nbsp;<span class="builtintype" id="3066211">string</span><span class="op" id="3066217">)</span>&nbsp;<span class="op" id="3066219">(</span><span class="ident" id="3066220">fd</span>&nbsp;<span class="op" id="3066223">*</span><span class="ident" id="3066224">netFD</span><span class="op" id="3066229">,</span>&nbsp;<span class="ident" id="3066231">err</span>&nbsp;<span class="builtintype" id="3066235">error</span><span class="op" id="3066240">)</span>&nbsp;<span class="op" id="3066242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066245">family</span><span class="op" id="3066251">,</span>&nbsp;<span class="ident" id="3066253">ipv6only</span>&nbsp;<span class="op" id="3066262">:=</span>&nbsp;<span class="ident" id="3066265">favoriteAddrFamily</span><span class="op" id="3066283">(</span><span class="ident" id="3066284">net</span><span class="op" id="3066287">,</span>&nbsp;<span class="ident" id="3066289">laddr</span><span class="op" id="3066294">,</span>&nbsp;<span class="ident" id="3066296">raddr</span><span class="op" id="3066301">,</span>&nbsp;<span class="ident" id="3066303">mode</span><span class="op" id="3066307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066310">return</span>&nbsp;<span class="ident" id="3066317">socket</span><span class="op" id="3066323">(</span><span class="ident" id="3066324">net</span><span class="op" id="3066327">,</span>&nbsp;<span class="ident" id="3066329">family</span><span class="op" id="3066335">,</span>&nbsp;<span class="ident" id="3066337">sotype</span><span class="op" id="3066343">,</span>&nbsp;<span class="ident" id="3066345">proto</span><span class="op" id="3066350">,</span>&nbsp;<span class="ident" id="3066352">ipv6only</span><span class="op" id="3066360">,</span>&nbsp;<span class="ident" id="3066362">laddr</span><span class="op" id="3066367">,</span>&nbsp;<span class="ident" id="3066369">raddr</span><span class="op" id="3066374">,</span>&nbsp;<span class="ident" id="3066376">deadline</span><span class="op" id="3066384">)</span><br>
<span class="lineno"></span><span class="op" id="3066386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3066389">func</span>&nbsp;<span class="ident" id="3066394">ipToSockaddr</span><span class="op" id="3066406">(</span><span class="ident" id="3066407">family</span>&nbsp;<span class="builtintype" id="3066414">int</span><span class="op" id="3066417">,</span>&nbsp;<span class="ident" id="3066419">ip</span>&nbsp;<span class="ident" id="3066422">IP</span><span class="op" id="3066424">,</span>&nbsp;<span class="ident" id="3066426">port</span>&nbsp;<span class="builtintype" id="3066431">int</span><span class="op" id="3066434">,</span>&nbsp;<span class="ident" id="3066436">zone</span>&nbsp;<span class="builtintype" id="3066441">string</span><span class="op" id="3066447">)</span>&nbsp;<span class="op" id="3066449">(</span><span class="ident" id="3066450">syscall</span><span class="op" id="3066457">.</span><span class="ident" id="3066458">Sockaddr</span><span class="op" id="3066466">,</span>&nbsp;<span class="builtintype" id="3066468">error</span><span class="op" id="3066473">)</span>&nbsp;<span class="op" id="3066475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066478">switch</span>&nbsp;<span class="ident" id="3066485">family</span>&nbsp;<span class="op" id="3066492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066495">case</span>&nbsp;<span class="ident" id="3066500">syscall</span><span class="op" id="3066507">.</span><span class="ident" id="3066508">AF_INET</span><span class="op" id="3066515">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066519">if</span>&nbsp;<span class="builtinfunc" id="3066522">len</span><span class="op" id="3066525">(</span><span class="ident" id="3066526">ip</span><span class="op" id="3066528">)</span>&nbsp;<span class="op" id="3066530">==</span>&nbsp;<span class="num" id="3066533">0</span>&nbsp;<span class="op" id="3066535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066540">ip</span>&nbsp;<span class="op" id="3066543">=</span>&nbsp;<span class="ident" id="3066545">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066560">if</span>&nbsp;<span class="ident" id="3066563">ip</span>&nbsp;<span class="op" id="3066566">=</span>&nbsp;<span class="ident" id="3066568">ip</span><span class="op" id="3066570">.</span><span class="ident" id="3066571">To4</span><span class="op" id="3066574">(</span><span class="op" id="3066575">)</span><span class="op" id="3066576">;</span>&nbsp;<span class="ident" id="3066578">ip</span>&nbsp;<span class="op" id="3066581">==</span>&nbsp;<span class="ident" id="3066584">nil</span>&nbsp;<span class="op" id="3066588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066593">return</span>&nbsp;<span class="ident" id="3066600">nil</span><span class="op" id="3066603">,</span>&nbsp;<span class="ident" id="3066605">InvalidAddrError</span><span class="op" id="3066621">(</span><span class="string" id="3066622">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3066640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066648">sa</span>&nbsp;<span class="op" id="3066651">:=</span>&nbsp;<span class="builtinfunc" id="3066654">new</span><span class="op" id="3066657">(</span><span class="ident" id="3066658">syscall</span><span class="op" id="3066665">.</span><span class="ident" id="3066666">SockaddrInet4</span><span class="op" id="3066679">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066683">for</span>&nbsp;<span class="ident" id="3066687">i</span>&nbsp;<span class="op" id="3066689">:=</span>&nbsp;<span class="num" id="3066692">0</span><span class="op" id="3066693">;</span>&nbsp;<span class="ident" id="3066695">i</span>&nbsp;<span class="op" id="3066697">&lt;</span>&nbsp;<span class="ident" id="3066699">IPv4len</span><span class="op" id="3066706">;</span>&nbsp;<span class="ident" id="3066708">i</span><span class="op" id="3066709">++</span>&nbsp;<span class="op" id="3066712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066717">sa</span><span class="op" id="3066719">.</span><span class="ident" id="3066720">Addr</span><span class="op" id="3066724">[</span><span class="ident" id="3066725">i</span><span class="op" id="3066726">]</span>&nbsp;<span class="op" id="3066728">=</span>&nbsp;<span class="ident" id="3066730">ip</span><span class="op" id="3066732">[</span><span class="ident" id="3066733">i</span><span class="op" id="3066734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066742">sa</span><span class="op" id="3066744">.</span><span class="ident" id="3066745">Port</span>&nbsp;<span class="op" id="3066750">=</span>&nbsp;<span class="ident" id="3066752">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066759">return</span>&nbsp;<span class="ident" id="3066766">sa</span><span class="op" id="3066768">,</span>&nbsp;<span class="ident" id="3066770">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066775">case</span>&nbsp;<span class="ident" id="3066780">syscall</span><span class="op" id="3066787">.</span><span class="ident" id="3066788">AF_INET6</span><span class="op" id="3066796">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066800">if</span>&nbsp;<span class="builtinfunc" id="3066803">len</span><span class="op" id="3066806">(</span><span class="ident" id="3066807">ip</span><span class="op" id="3066809">)</span>&nbsp;<span class="op" id="3066811">==</span>&nbsp;<span class="num" id="3066814">0</span>&nbsp;<span class="op" id="3066816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066821">ip</span>&nbsp;<span class="op" id="3066824">=</span>&nbsp;<span class="ident" id="3066826">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3066841">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3066916">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3066987">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067058">if</span>&nbsp;<span class="ident" id="3067061">ip</span><span class="op" id="3067063">.</span><span class="ident" id="3067064">Equal</span><span class="op" id="3067069">(</span><span class="ident" id="3067070">IPv4zero</span><span class="op" id="3067078">)</span>&nbsp;<span class="op" id="3067080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067085">ip</span>&nbsp;<span class="op" id="3067088">=</span>&nbsp;<span class="ident" id="3067090">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067101">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067105">if</span>&nbsp;<span class="ident" id="3067108">ip</span>&nbsp;<span class="op" id="3067111">=</span>&nbsp;<span class="ident" id="3067113">ip</span><span class="op" id="3067115">.</span><span class="ident" id="3067116">To16</span><span class="op" id="3067120">(</span><span class="op" id="3067121">)</span><span class="op" id="3067122">;</span>&nbsp;<span class="ident" id="3067124">ip</span>&nbsp;<span class="op" id="3067127">==</span>&nbsp;<span class="ident" id="3067130">nil</span>&nbsp;<span class="op" id="3067134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067139">return</span>&nbsp;<span class="ident" id="3067146">nil</span><span class="op" id="3067149">,</span>&nbsp;<span class="ident" id="3067151">InvalidAddrError</span><span class="op" id="3067167">(</span><span class="string" id="3067168">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3067186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067194">sa</span>&nbsp;<span class="op" id="3067197">:=</span>&nbsp;<span class="builtinfunc" id="3067200">new</span><span class="op" id="3067203">(</span><span class="ident" id="3067204">syscall</span><span class="op" id="3067211">.</span><span class="ident" id="3067212">SockaddrInet6</span><span class="op" id="3067225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067229">for</span>&nbsp;<span class="ident" id="3067233">i</span>&nbsp;<span class="op" id="3067235">:=</span>&nbsp;<span class="num" id="3067238">0</span><span class="op" id="3067239">;</span>&nbsp;<span class="ident" id="3067241">i</span>&nbsp;<span class="op" id="3067243">&lt;</span>&nbsp;<span class="ident" id="3067245">IPv6len</span><span class="op" id="3067252">;</span>&nbsp;<span class="ident" id="3067254">i</span><span class="op" id="3067255">++</span>&nbsp;<span class="op" id="3067258">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067263">sa</span><span class="op" id="3067265">.</span><span class="ident" id="3067266">Addr</span><span class="op" id="3067270">[</span><span class="ident" id="3067271">i</span><span class="op" id="3067272">]</span>&nbsp;<span class="op" id="3067274">=</span>&nbsp;<span class="ident" id="3067276">ip</span><span class="op" id="3067278">[</span><span class="ident" id="3067279">i</span><span class="op" id="3067280">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067288">sa</span><span class="op" id="3067290">.</span><span class="ident" id="3067291">Port</span>&nbsp;<span class="op" id="3067296">=</span>&nbsp;<span class="ident" id="3067298">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067305">sa</span><span class="op" id="3067307">.</span><span class="ident" id="3067308">ZoneId</span>&nbsp;<span class="op" id="3067315">=</span>&nbsp;<span class="builtintype" id="3067317">uint32</span><span class="op" id="3067323">(</span><span class="ident" id="3067324">zoneToInt</span><span class="op" id="3067333">(</span><span class="ident" id="3067334">zone</span><span class="op" id="3067338">)</span><span class="op" id="3067339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067343">return</span>&nbsp;<span class="ident" id="3067350">sa</span><span class="op" id="3067352">,</span>&nbsp;<span class="ident" id="3067354">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067362">return</span>&nbsp;<span class="ident" id="3067369">nil</span><span class="op" id="3067372">,</span>&nbsp;<span class="ident" id="3067374">InvalidAddrError</span><span class="op" id="3067390">(</span><span class="string" id="3067391">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3067417">)</span><br>
<span class="lineno"></span><span class="op" id="3067419">}</span>
</div>
</body>
</html>
