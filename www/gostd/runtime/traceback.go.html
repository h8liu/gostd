<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html" class="current">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1722144">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1722199">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1722253">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1722304">package</span>&nbsp;<span class="ident" id="1722312">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1722321">import</span>&nbsp;<span class="string" id="1722328">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1722338">//&nbsp;The&nbsp;code&nbsp;in&nbsp;this&nbsp;file&nbsp;implements&nbsp;stack&nbsp;trace&nbsp;walking&nbsp;for&nbsp;all&nbsp;architectures.</span><br>
<span class="lineno">10</span><span class="comment" id="1722417">//&nbsp;The&nbsp;most&nbsp;important&nbsp;fact&nbsp;about&nbsp;a&nbsp;given&nbsp;architecture&nbsp;is&nbsp;whether&nbsp;it&nbsp;uses&nbsp;a&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span><span class="comment" id="1722507">//&nbsp;On&nbsp;systems&nbsp;with&nbsp;link&nbsp;registers,&nbsp;the&nbsp;prologue&nbsp;for&nbsp;a&nbsp;non-leaf&nbsp;function&nbsp;stores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1722590">//&nbsp;incoming&nbsp;value&nbsp;of&nbsp;LR&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno"></span><span class="comment" id="1722664">//&nbsp;On&nbsp;systems&nbsp;without&nbsp;link&nbsp;registers,&nbsp;the&nbsp;architecture&nbsp;pushes&nbsp;a&nbsp;return&nbsp;PC&nbsp;during</span><br>
<span class="lineno"></span><span class="comment" id="1722745">//&nbsp;the&nbsp;call&nbsp;instruction,&nbsp;so&nbsp;the&nbsp;return&nbsp;PC&nbsp;ends&nbsp;up&nbsp;above&nbsp;the&nbsp;stack&nbsp;frame.</span><br>
<span class="lineno">15</span><span class="comment" id="1722818">//&nbsp;In&nbsp;this&nbsp;file,&nbsp;the&nbsp;return&nbsp;PC&nbsp;is&nbsp;always&nbsp;called&nbsp;LR,&nbsp;no&nbsp;matter&nbsp;how&nbsp;it&nbsp;was&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="1722898">//</span><br>
<span class="lineno"></span><span class="comment" id="1722901">//&nbsp;To&nbsp;date,&nbsp;the&nbsp;opposite&nbsp;of&nbsp;a&nbsp;link&nbsp;register&nbsp;architecture&nbsp;is&nbsp;an&nbsp;x86&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="comment" id="1722982">//&nbsp;This&nbsp;code&nbsp;may&nbsp;need&nbsp;to&nbsp;change&nbsp;if&nbsp;some&nbsp;other&nbsp;kind&nbsp;of&nbsp;non-link-register</span><br>
<span class="lineno"></span><span class="comment" id="1723054">//&nbsp;architecture&nbsp;comes&nbsp;along.</span><br>
<span class="lineno">20</span><span class="comment" id="1723083">//</span><br>
<span class="lineno"></span><span class="comment" id="1723086">//&nbsp;The&nbsp;other&nbsp;important&nbsp;fact&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;pointer:&nbsp;on&nbsp;32-bit&nbsp;systems&nbsp;the&nbsp;LR</span><br>
<span class="lineno"></span><span class="comment" id="1723165">//&nbsp;takes&nbsp;up&nbsp;only&nbsp;4&nbsp;bytes&nbsp;on&nbsp;the&nbsp;stack,&nbsp;while&nbsp;on&nbsp;64-bit&nbsp;systems&nbsp;it&nbsp;takes&nbsp;up&nbsp;8&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1723249">//&nbsp;Typically&nbsp;this&nbsp;is&nbsp;ptrSize.</span><br>
<span class="lineno"></span><span class="comment" id="1723279">//</span><br>
<span class="lineno">25</span><span class="comment" id="1723282">//&nbsp;As&nbsp;an&nbsp;exception,&nbsp;amd64p32&nbsp;has&nbsp;ptrSize&nbsp;==&nbsp;4&nbsp;but&nbsp;the&nbsp;CALL&nbsp;instruction&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="1723359">//&nbsp;stores&nbsp;an&nbsp;8-byte&nbsp;return&nbsp;PC&nbsp;onto&nbsp;the&nbsp;stack.&nbsp;To&nbsp;accommodate&nbsp;this,&nbsp;we&nbsp;use&nbsp;regSize</span><br>
<span class="lineno"></span><span class="comment" id="1723441">//&nbsp;as&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;architecture-pushed&nbsp;return&nbsp;PC.</span><br>
<span class="lineno"></span><span class="comment" id="1723494">//</span><br>
<span class="lineno"></span><span class="comment" id="1723497">//&nbsp;usesLR&nbsp;is&nbsp;defined&nbsp;below.&nbsp;ptrSize&nbsp;and&nbsp;regSize&nbsp;are&nbsp;defined&nbsp;in&nbsp;stubs.go.</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1723571">const</span>&nbsp;<span class="ident" id="1723577">usesLR</span>&nbsp;<span class="op" id="1723584">=</span>&nbsp;<span class="ident" id="1723586">GOARCH</span>&nbsp;<span class="op" id="1723593">!=</span>&nbsp;<span class="string" id="1723596">&#34;amd64&#34;</span>&nbsp;<span class="op" id="1723604">&amp;&amp;</span>&nbsp;<span class="ident" id="1723607">GOARCH</span>&nbsp;<span class="op" id="1723614">!=</span>&nbsp;<span class="string" id="1723617">&#34;amd64p32&#34;</span>&nbsp;<span class="op" id="1723628">&amp;&amp;</span>&nbsp;<span class="ident" id="1723631">GOARCH</span>&nbsp;<span class="op" id="1723638">!=</span>&nbsp;<span class="string" id="1723641">&#34;386&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1723648">var</span>&nbsp;<span class="op" id="1723652">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723655">//&nbsp;initialized&nbsp;in&nbsp;tracebackinit</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723688">deferprocPC</span>&nbsp;<span class="builtintype" id="1723700">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723709">goexitPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1723721">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723730">jmpdeferPC</span>&nbsp;&nbsp;<span class="builtintype" id="1723742">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723751">mcallPC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1723763">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723772">morestackPC</span>&nbsp;<span class="builtintype" id="1723784">uintptr</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723793">mstartPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1723805">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723814">newprocPC</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1723826">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723835">rt0_goPC</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1723847">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723856">sigpanicPC</span>&nbsp;&nbsp;<span class="builtintype" id="1723868">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1723878">externalthreadhandlerp</span>&nbsp;<span class="builtintype" id="1723901">uintptr</span>&nbsp;<span class="comment" id="1723909">//&nbsp;initialized&nbsp;elsewhere</span><br>
<span class="lineno"></span><span class="op" id="1723934">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1723937">func</span>&nbsp;<span class="ident" id="1723942">tracebackinit</span><span class="op" id="1723955">(</span><span class="op" id="1723956">)</span>&nbsp;<span class="op" id="1723958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1723961">//&nbsp;Go&nbsp;variable&nbsp;initialization&nbsp;happens&nbsp;late&nbsp;during&nbsp;runtime&nbsp;startup.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724029">//&nbsp;Instead&nbsp;of&nbsp;initializing&nbsp;the&nbsp;variables&nbsp;above&nbsp;in&nbsp;the&nbsp;declarations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724098">//&nbsp;schedinit&nbsp;calls&nbsp;this&nbsp;function&nbsp;so&nbsp;that&nbsp;the&nbsp;variables&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724158">//&nbsp;initialized&nbsp;and&nbsp;available&nbsp;earlier&nbsp;in&nbsp;the&nbsp;startup&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724221">deferprocPC</span>&nbsp;<span class="op" id="1724233">=</span>&nbsp;<span class="ident" id="1724235">funcPC</span><span class="op" id="1724241">(</span><span class="ident" id="1724242">deferproc</span><span class="op" id="1724251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724254">goexitPC</span>&nbsp;<span class="op" id="1724263">=</span>&nbsp;<span class="ident" id="1724265">funcPC</span><span class="op" id="1724271">(</span><span class="ident" id="1724272">goexit</span><span class="op" id="1724278">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724281">jmpdeferPC</span>&nbsp;<span class="op" id="1724292">=</span>&nbsp;<span class="ident" id="1724294">funcPC</span><span class="op" id="1724300">(</span><span class="ident" id="1724301">jmpdefer</span><span class="op" id="1724309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724312">mcallPC</span>&nbsp;<span class="op" id="1724320">=</span>&nbsp;<span class="ident" id="1724322">funcPC</span><span class="op" id="1724328">(</span><span class="ident" id="1724329">mcall</span><span class="op" id="1724334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724337">morestackPC</span>&nbsp;<span class="op" id="1724349">=</span>&nbsp;<span class="ident" id="1724351">funcPC</span><span class="op" id="1724357">(</span><span class="ident" id="1724358">morestack</span><span class="op" id="1724367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724370">mstartPC</span>&nbsp;<span class="op" id="1724379">=</span>&nbsp;<span class="ident" id="1724381">funcPC</span><span class="op" id="1724387">(</span><span class="ident" id="1724388">mstart</span><span class="op" id="1724394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724397">newprocPC</span>&nbsp;<span class="op" id="1724407">=</span>&nbsp;<span class="ident" id="1724409">funcPC</span><span class="op" id="1724415">(</span><span class="ident" id="1724416">newproc</span><span class="op" id="1724423">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724426">rt0_goPC</span>&nbsp;<span class="op" id="1724435">=</span>&nbsp;<span class="ident" id="1724437">funcPC</span><span class="op" id="1724443">(</span><span class="ident" id="1724444">rt0_go</span><span class="op" id="1724450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724453">sigpanicPC</span>&nbsp;<span class="op" id="1724464">=</span>&nbsp;<span class="ident" id="1724466">funcPC</span><span class="op" id="1724472">(</span><span class="ident" id="1724473">sigpanic</span><span class="op" id="1724481">)</span><br>
<span class="lineno"></span><span class="op" id="1724483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1724486">//&nbsp;Traceback&nbsp;over&nbsp;the&nbsp;deferred&nbsp;function&nbsp;calls.</span><br>
<span class="lineno">65</span><span class="comment" id="1724533">//&nbsp;Report&nbsp;them&nbsp;like&nbsp;calls&nbsp;that&nbsp;have&nbsp;been&nbsp;invoked&nbsp;but&nbsp;not&nbsp;started&nbsp;executing&nbsp;yet.</span><br>
<span class="lineno"></span><span class="keyword" id="1724613">func</span>&nbsp;<span class="ident" id="1724618">tracebackdefers</span><span class="op" id="1724633">(</span><span class="ident" id="1724634">gp</span>&nbsp;<span class="op" id="1724637">*</span><span class="ident" id="1724638">g</span><span class="op" id="1724639">,</span>&nbsp;<span class="ident" id="1724641">callback</span>&nbsp;<span class="keyword" id="1724650">func</span><span class="op" id="1724654">(</span><span class="op" id="1724655">*</span><span class="ident" id="1724656">stkframe</span><span class="op" id="1724664">,</span>&nbsp;<span class="ident" id="1724666">unsafe</span><span class="op" id="1724672">.</span><span class="ident" id="1724673">Pointer</span><span class="op" id="1724680">)</span>&nbsp;<span class="builtintype" id="1724682">bool</span><span class="op" id="1724686">,</span>&nbsp;<span class="ident" id="1724688">v</span>&nbsp;<span class="ident" id="1724690">unsafe</span><span class="op" id="1724696">.</span><span class="ident" id="1724697">Pointer</span><span class="op" id="1724704">)</span>&nbsp;<span class="op" id="1724706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724709">var</span>&nbsp;<span class="ident" id="1724713">frame</span>&nbsp;<span class="ident" id="1724719">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724729">for</span>&nbsp;<span class="ident" id="1724733">d</span>&nbsp;<span class="op" id="1724735">:=</span>&nbsp;<span class="ident" id="1724738">gp</span><span class="op" id="1724740">.</span><span class="ident" id="1724741">_defer</span><span class="op" id="1724747">;</span>&nbsp;<span class="ident" id="1724749">d</span>&nbsp;<span class="op" id="1724751">!=</span>&nbsp;<span class="builtintype" id="1724754">nil</span><span class="op" id="1724757">;</span>&nbsp;<span class="ident" id="1724759">d</span>&nbsp;<span class="op" id="1724761">=</span>&nbsp;<span class="ident" id="1724763">d</span><span class="op" id="1724764">.</span><span class="ident" id="1724765">link</span>&nbsp;<span class="op" id="1724770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724774">fn</span>&nbsp;<span class="op" id="1724777">:=</span>&nbsp;<span class="ident" id="1724780">d</span><span class="op" id="1724781">.</span><span class="ident" id="1724782">fn</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1724787">if</span>&nbsp;<span class="ident" id="1724790">fn</span>&nbsp;<span class="op" id="1724793">==</span>&nbsp;<span class="builtintype" id="1724796">nil</span>&nbsp;<span class="op" id="1724800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1724805">//&nbsp;Defer&nbsp;of&nbsp;nil&nbsp;function.&nbsp;Args&nbsp;don&#39;t&nbsp;matter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724853">frame</span><span class="op" id="1724858">.</span><span class="ident" id="1724859">pc</span>&nbsp;<span class="op" id="1724862">=</span>&nbsp;<span class="num" id="1724864">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724869">frame</span><span class="op" id="1724874">.</span><span class="ident" id="1724875">fn</span>&nbsp;<span class="op" id="1724878">=</span>&nbsp;<span class="builtintype" id="1724880">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724887">frame</span><span class="op" id="1724892">.</span><span class="ident" id="1724893">argp</span>&nbsp;<span class="op" id="1724898">=</span>&nbsp;<span class="num" id="1724900">0</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724905">frame</span><span class="op" id="1724910">.</span><span class="ident" id="1724911">arglen</span>&nbsp;<span class="op" id="1724918">=</span>&nbsp;<span class="num" id="1724920">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724925">frame</span><span class="op" id="1724930">.</span><span class="ident" id="1724931">argmap</span>&nbsp;<span class="op" id="1724938">=</span>&nbsp;<span class="builtintype" id="1724940">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1724946">}</span>&nbsp;<span class="keyword" id="1724948">else</span>&nbsp;<span class="op" id="1724953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724958">frame</span><span class="op" id="1724963">.</span><span class="ident" id="1724964">pc</span>&nbsp;<span class="op" id="1724967">=</span>&nbsp;<span class="builtintype" id="1724969">uintptr</span><span class="op" id="1724976">(</span><span class="ident" id="1724977">fn</span><span class="op" id="1724979">.</span><span class="ident" id="1724980">fn</span><span class="op" id="1724982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1724987">f</span>&nbsp;<span class="op" id="1724989">:=</span>&nbsp;<span class="ident" id="1724992">findfunc</span><span class="op" id="1725000">(</span><span class="ident" id="1725001">frame</span><span class="op" id="1725006">.</span><span class="ident" id="1725007">pc</span><span class="op" id="1725009">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725014">if</span>&nbsp;<span class="ident" id="1725017">f</span>&nbsp;<span class="op" id="1725019">==</span>&nbsp;<span class="builtintype" id="1725022">nil</span>&nbsp;<span class="op" id="1725026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1725032">print</span><span class="op" id="1725037">(</span><span class="string" id="1725038">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;in&nbsp;defer&nbsp;&#34;</span><span class="op" id="1725069">,</span>&nbsp;<span class="ident" id="1725071">hex</span><span class="op" id="1725074">(</span><span class="ident" id="1725075">frame</span><span class="op" id="1725080">.</span><span class="ident" id="1725081">pc</span><span class="op" id="1725083">)</span><span class="op" id="1725084">,</span>&nbsp;<span class="string" id="1725086">&#34;\n&#34;</span><span class="op" id="1725090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725096">gothrow</span><span class="op" id="1725103">(</span><span class="string" id="1725104">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1725116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725126">frame</span><span class="op" id="1725131">.</span><span class="ident" id="1725132">fn</span>&nbsp;<span class="op" id="1725135">=</span>&nbsp;<span class="ident" id="1725137">f</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725142">frame</span><span class="op" id="1725147">.</span><span class="ident" id="1725148">argp</span>&nbsp;<span class="op" id="1725153">=</span>&nbsp;<span class="builtintype" id="1725155">uintptr</span><span class="op" id="1725162">(</span><span class="ident" id="1725163">deferArgs</span><span class="op" id="1725172">(</span><span class="ident" id="1725173">d</span><span class="op" id="1725174">)</span><span class="op" id="1725175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725180">setArgInfo</span><span class="op" id="1725190">(</span><span class="op" id="1725191">&amp;</span><span class="ident" id="1725192">frame</span><span class="op" id="1725197">,</span>&nbsp;<span class="ident" id="1725199">f</span><span class="op" id="1725200">,</span>&nbsp;<span class="builtintype" id="1725202">true</span><span class="op" id="1725206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725214">frame</span><span class="op" id="1725219">.</span><span class="ident" id="1725220">continpc</span>&nbsp;<span class="op" id="1725229">=</span>&nbsp;<span class="ident" id="1725231">frame</span><span class="op" id="1725236">.</span><span class="ident" id="1725237">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725242">if</span>&nbsp;<span class="op" id="1725245">!</span><span class="ident" id="1725246">callback</span><span class="op" id="1725254">(</span><span class="op" id="1725255">(</span><span class="op" id="1725256">*</span><span class="ident" id="1725257">stkframe</span><span class="op" id="1725265">)</span><span class="op" id="1725266">(</span><span class="ident" id="1725267">noescape</span><span class="op" id="1725275">(</span><span class="ident" id="1725276">unsafe</span><span class="op" id="1725282">.</span><span class="ident" id="1725283">Pointer</span><span class="op" id="1725290">(</span><span class="op" id="1725291">&amp;</span><span class="ident" id="1725292">frame</span><span class="op" id="1725297">)</span><span class="op" id="1725298">)</span><span class="op" id="1725299">)</span><span class="op" id="1725300">,</span>&nbsp;<span class="ident" id="1725302">v</span><span class="op" id="1725303">)</span>&nbsp;<span class="op" id="1725305">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725310">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725322">}</span><br>
<span class="lineno"></span><span class="op" id="1725324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="1725327">//&nbsp;Generic&nbsp;traceback.&nbsp;&nbsp;Handles&nbsp;runtime&nbsp;stack&nbsp;prints&nbsp;(pcbuf&nbsp;==&nbsp;nil),</span><br>
<span class="lineno"></span><span class="comment" id="1725395">//&nbsp;the&nbsp;runtime.Callers&nbsp;function&nbsp;(pcbuf&nbsp;!=&nbsp;nil),&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;garbage</span><br>
<span class="lineno"></span><span class="comment" id="1725466">//&nbsp;collector&nbsp;(callback&nbsp;!=&nbsp;nil).&nbsp;&nbsp;A&nbsp;little&nbsp;clunky&nbsp;to&nbsp;merge&nbsp;these,&nbsp;but&nbsp;avoids</span><br>
<span class="lineno"></span><span class="comment" id="1725542">//&nbsp;duplicating&nbsp;the&nbsp;code&nbsp;and&nbsp;all&nbsp;its&nbsp;subtlety.</span><br>
<span class="lineno"></span><span class="keyword" id="1725588">func</span>&nbsp;<span class="ident" id="1725593">gentraceback</span><span class="op" id="1725605">(</span><span class="ident" id="1725606">pc0</span>&nbsp;<span class="builtintype" id="1725610">uintptr</span><span class="op" id="1725617">,</span>&nbsp;<span class="ident" id="1725619">sp0</span>&nbsp;<span class="builtintype" id="1725623">uintptr</span><span class="op" id="1725630">,</span>&nbsp;<span class="ident" id="1725632">lr0</span>&nbsp;<span class="builtintype" id="1725636">uintptr</span><span class="op" id="1725643">,</span>&nbsp;<span class="ident" id="1725645">gp</span>&nbsp;<span class="op" id="1725648">*</span><span class="ident" id="1725649">g</span><span class="op" id="1725650">,</span>&nbsp;<span class="ident" id="1725652">skip</span>&nbsp;<span class="builtintype" id="1725657">int</span><span class="op" id="1725660">,</span>&nbsp;<span class="ident" id="1725662">pcbuf</span>&nbsp;<span class="op" id="1725668">*</span><span class="builtintype" id="1725669">uintptr</span><span class="op" id="1725676">,</span>&nbsp;<span class="ident" id="1725678">max</span>&nbsp;<span class="builtintype" id="1725682">int</span><span class="op" id="1725685">,</span>&nbsp;<span class="ident" id="1725687">callback</span>&nbsp;<span class="keyword" id="1725696">func</span><span class="op" id="1725700">(</span><span class="op" id="1725701">*</span><span class="ident" id="1725702">stkframe</span><span class="op" id="1725710">,</span>&nbsp;<span class="ident" id="1725712">unsafe</span><span class="op" id="1725718">.</span><span class="ident" id="1725719">Pointer</span><span class="op" id="1725726">)</span>&nbsp;<span class="builtintype" id="1725728">bool</span><span class="op" id="1725732">,</span>&nbsp;<span class="ident" id="1725734">v</span>&nbsp;<span class="ident" id="1725736">unsafe</span><span class="op" id="1725742">.</span><span class="ident" id="1725743">Pointer</span><span class="op" id="1725750">,</span>&nbsp;<span class="ident" id="1725752">flags</span>&nbsp;<span class="builtintype" id="1725758">uint</span><span class="op" id="1725762">)</span>&nbsp;<span class="builtintype" id="1725764">int</span>&nbsp;<span class="op" id="1725768">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725771">if</span>&nbsp;<span class="ident" id="1725774">goexitPC</span>&nbsp;<span class="op" id="1725783">==</span>&nbsp;<span class="num" id="1725786">0</span>&nbsp;<span class="op" id="1725788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725792">gothrow</span><span class="op" id="1725799">(</span><span class="string" id="1725800">&#34;gentraceback&nbsp;before&nbsp;goexitPC&nbsp;initialization&#34;</span><span class="op" id="1725845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1725848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1725851">g</span>&nbsp;<span class="op" id="1725853">:=</span>&nbsp;<span class="ident" id="1725856">getg</span><span class="op" id="1725860">(</span><span class="op" id="1725861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1725864">if</span>&nbsp;<span class="ident" id="1725867">g</span>&nbsp;<span class="op" id="1725869">==</span>&nbsp;<span class="ident" id="1725872">gp</span>&nbsp;<span class="op" id="1725875">&amp;&amp;</span>&nbsp;<span class="ident" id="1725878">g</span>&nbsp;<span class="op" id="1725880">==</span>&nbsp;<span class="ident" id="1725883">g</span><span class="op" id="1725884">.</span><span class="ident" id="1725885">m</span><span class="op" id="1725886">.</span><span class="ident" id="1725887">curg</span>&nbsp;<span class="op" id="1725892">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1725896">//&nbsp;The&nbsp;starting&nbsp;sp&nbsp;has&nbsp;been&nbsp;passed&nbsp;in&nbsp;as&nbsp;a&nbsp;uintptr,&nbsp;and&nbsp;the&nbsp;caller&nbsp;may</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1725969">//&nbsp;have&nbsp;other&nbsp;uintptr-typed&nbsp;stack&nbsp;references&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726025">//&nbsp;If&nbsp;during&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;that&nbsp;got&nbsp;us&nbsp;here&nbsp;or&nbsp;during&nbsp;one&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726095">//&nbsp;callbacks&nbsp;below&nbsp;the&nbsp;stack&nbsp;must&nbsp;be&nbsp;grown,&nbsp;all&nbsp;these&nbsp;uintptr&nbsp;references</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726170">//&nbsp;to&nbsp;the&nbsp;stack&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;and&nbsp;gentraceback&nbsp;will&nbsp;continue</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726240">//&nbsp;to&nbsp;inspect&nbsp;the&nbsp;old&nbsp;stack&nbsp;memory,&nbsp;which&nbsp;may&nbsp;no&nbsp;longer&nbsp;be&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726308">//&nbsp;Even&nbsp;if&nbsp;all&nbsp;the&nbsp;variables&nbsp;were&nbsp;updated&nbsp;correctly,&nbsp;it&nbsp;is&nbsp;not&nbsp;clear&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726384">//&nbsp;we&nbsp;want&nbsp;to&nbsp;expose&nbsp;a&nbsp;traceback&nbsp;that&nbsp;begins&nbsp;on&nbsp;one&nbsp;stack&nbsp;and&nbsp;ends</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726453">//&nbsp;on&nbsp;another&nbsp;stack.&nbsp;That&nbsp;could&nbsp;confuse&nbsp;callers&nbsp;quite&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726516">//&nbsp;Instead,&nbsp;we&nbsp;require&nbsp;that&nbsp;gentraceback&nbsp;and&nbsp;any&nbsp;other&nbsp;function&nbsp;that</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726587">//&nbsp;accepts&nbsp;an&nbsp;sp&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;(typically&nbsp;obtained&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726655">//&nbsp;calling&nbsp;getcallersp)&nbsp;must&nbsp;not&nbsp;run&nbsp;on&nbsp;that&nbsp;goroutine&#39;s&nbsp;stack&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1726724">//&nbsp;instead&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726754">gothrow</span><span class="op" id="1726761">(</span><span class="string" id="1726762">&#34;gentraceback&nbsp;cannot&nbsp;trace&nbsp;user&nbsp;goroutine&nbsp;on&nbsp;its&nbsp;own&nbsp;stack&#34;</span><span class="op" id="1726821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1726824">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726827">gotraceback</span>&nbsp;<span class="op" id="1726839">:=</span>&nbsp;<span class="ident" id="1726842">gotraceback</span><span class="op" id="1726853">(</span><span class="builtintype" id="1726854">nil</span><span class="op" id="1726857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726860">if</span>&nbsp;<span class="ident" id="1726863">pc0</span>&nbsp;<span class="op" id="1726867">==</span>&nbsp;<span class="op" id="1726870">^</span><span class="builtintype" id="1726871">uintptr</span><span class="op" id="1726878">(</span><span class="num" id="1726879">0</span><span class="op" id="1726880">)</span>&nbsp;<span class="op" id="1726882">&amp;&amp;</span>&nbsp;<span class="ident" id="1726885">sp0</span>&nbsp;<span class="op" id="1726889">==</span>&nbsp;<span class="op" id="1726892">^</span><span class="builtintype" id="1726893">uintptr</span><span class="op" id="1726900">(</span><span class="num" id="1726901">0</span><span class="op" id="1726902">)</span>&nbsp;<span class="op" id="1726904">{</span>&nbsp;<span class="comment" id="1726906">//&nbsp;Signal&nbsp;to&nbsp;fetch&nbsp;saved&nbsp;values&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1726949">if</span>&nbsp;<span class="ident" id="1726952">gp</span><span class="op" id="1726954">.</span><span class="ident" id="1726955">syscallsp</span>&nbsp;<span class="op" id="1726965">!=</span>&nbsp;<span class="num" id="1726968">0</span>&nbsp;<span class="op" id="1726970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726975">pc0</span>&nbsp;<span class="op" id="1726979">=</span>&nbsp;<span class="ident" id="1726981">gp</span><span class="op" id="1726983">.</span><span class="ident" id="1726984">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1726997">sp0</span>&nbsp;<span class="op" id="1727001">=</span>&nbsp;<span class="ident" id="1727003">gp</span><span class="op" id="1727005">.</span><span class="ident" id="1727006">syscallsp</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727019">if</span>&nbsp;<span class="ident" id="1727022">usesLR</span>&nbsp;<span class="op" id="1727029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727035">lr0</span>&nbsp;<span class="op" id="1727039">=</span>&nbsp;<span class="num" id="1727041">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727050">}</span>&nbsp;<span class="keyword" id="1727052">else</span>&nbsp;<span class="op" id="1727057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727062">pc0</span>&nbsp;<span class="op" id="1727066">=</span>&nbsp;<span class="ident" id="1727068">gp</span><span class="op" id="1727070">.</span><span class="ident" id="1727071">sched</span><span class="op" id="1727076">.</span><span class="ident" id="1727077">pc</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727083">sp0</span>&nbsp;<span class="op" id="1727087">=</span>&nbsp;<span class="ident" id="1727089">gp</span><span class="op" id="1727091">.</span><span class="ident" id="1727092">sched</span><span class="op" id="1727097">.</span><span class="ident" id="1727098">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727104">if</span>&nbsp;<span class="ident" id="1727107">usesLR</span>&nbsp;<span class="op" id="1727114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727120">lr0</span>&nbsp;<span class="op" id="1727124">=</span>&nbsp;<span class="ident" id="1727126">gp</span><span class="op" id="1727128">.</span><span class="ident" id="1727129">sched</span><span class="op" id="1727134">.</span><span class="ident" id="1727135">lr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727145">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727152">nprint</span>&nbsp;<span class="op" id="1727159">:=</span>&nbsp;<span class="num" id="1727162">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727165">var</span>&nbsp;<span class="ident" id="1727169">frame</span>&nbsp;<span class="ident" id="1727175">stkframe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727185">frame</span><span class="op" id="1727190">.</span><span class="ident" id="1727191">pc</span>&nbsp;<span class="op" id="1727194">=</span>&nbsp;<span class="ident" id="1727196">pc0</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727201">frame</span><span class="op" id="1727206">.</span><span class="ident" id="1727207">sp</span>&nbsp;<span class="op" id="1727210">=</span>&nbsp;<span class="ident" id="1727212">sp0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727217">if</span>&nbsp;<span class="ident" id="1727220">usesLR</span>&nbsp;<span class="op" id="1727227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727231">frame</span><span class="op" id="1727236">.</span><span class="ident" id="1727237">lr</span>&nbsp;<span class="op" id="1727240">=</span>&nbsp;<span class="ident" id="1727242">lr0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727250">waspanic</span>&nbsp;<span class="op" id="1727259">:=</span>&nbsp;<span class="builtintype" id="1727262">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727269">wasnewproc</span>&nbsp;<span class="op" id="1727280">:=</span>&nbsp;<span class="builtintype" id="1727283">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727290">printing</span>&nbsp;<span class="op" id="1727299">:=</span>&nbsp;<span class="ident" id="1727302">pcbuf</span>&nbsp;<span class="op" id="1727308">==</span>&nbsp;<span class="builtintype" id="1727311">nil</span>&nbsp;<span class="op" id="1727315">&amp;&amp;</span>&nbsp;<span class="ident" id="1727318">callback</span>&nbsp;<span class="op" id="1727327">==</span>&nbsp;<span class="builtintype" id="1727330">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727335">_defer</span>&nbsp;<span class="op" id="1727342">:=</span>&nbsp;<span class="ident" id="1727345">gp</span><span class="op" id="1727347">.</span><span class="ident" id="1727348">_defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727357">for</span>&nbsp;<span class="ident" id="1727361">_defer</span>&nbsp;<span class="op" id="1727368">!=</span>&nbsp;<span class="builtintype" id="1727371">nil</span>&nbsp;<span class="op" id="1727375">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1727378">uintptr</span><span class="op" id="1727385">(</span><span class="ident" id="1727386">_defer</span><span class="op" id="1727392">.</span><span class="ident" id="1727393">argp</span><span class="op" id="1727397">)</span>&nbsp;<span class="op" id="1727399">==</span>&nbsp;<span class="ident" id="1727402">_NoArgs</span>&nbsp;<span class="op" id="1727410">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727414">_defer</span>&nbsp;<span class="op" id="1727421">=</span>&nbsp;<span class="ident" id="1727423">_defer</span><span class="op" id="1727429">.</span><span class="ident" id="1727430">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727440">//&nbsp;If&nbsp;the&nbsp;PC&nbsp;is&nbsp;zero,&nbsp;it&#39;s&nbsp;likely&nbsp;a&nbsp;nil&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727496">//&nbsp;Start&nbsp;in&nbsp;the&nbsp;caller&#39;s&nbsp;frame.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727529">if</span>&nbsp;<span class="ident" id="1727532">frame</span><span class="op" id="1727537">.</span><span class="ident" id="1727538">pc</span>&nbsp;<span class="op" id="1727541">==</span>&nbsp;<span class="num" id="1727544">0</span>&nbsp;<span class="op" id="1727546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727550">if</span>&nbsp;<span class="ident" id="1727553">usesLR</span>&nbsp;<span class="op" id="1727560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727565">frame</span><span class="op" id="1727570">.</span><span class="ident" id="1727571">pc</span>&nbsp;<span class="op" id="1727574">=</span>&nbsp;<span class="op" id="1727576">*</span><span class="op" id="1727577">(</span><span class="op" id="1727578">*</span><span class="builtintype" id="1727579">uintptr</span><span class="op" id="1727586">)</span><span class="op" id="1727587">(</span><span class="ident" id="1727588">unsafe</span><span class="op" id="1727594">.</span><span class="ident" id="1727595">Pointer</span><span class="op" id="1727602">(</span><span class="ident" id="1727603">frame</span><span class="op" id="1727608">.</span><span class="ident" id="1727609">sp</span><span class="op" id="1727611">)</span><span class="op" id="1727612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727617">frame</span><span class="op" id="1727622">.</span><span class="ident" id="1727623">lr</span>&nbsp;<span class="op" id="1727626">=</span>&nbsp;<span class="num" id="1727628">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727632">}</span>&nbsp;<span class="keyword" id="1727634">else</span>&nbsp;<span class="op" id="1727639">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727644">frame</span><span class="op" id="1727649">.</span><span class="ident" id="1727650">pc</span>&nbsp;<span class="op" id="1727653">=</span>&nbsp;<span class="builtintype" id="1727655">uintptr</span><span class="op" id="1727662">(</span><span class="op" id="1727663">*</span><span class="op" id="1727664">(</span><span class="op" id="1727665">*</span><span class="ident" id="1727666">uintreg</span><span class="op" id="1727673">)</span><span class="op" id="1727674">(</span><span class="ident" id="1727675">unsafe</span><span class="op" id="1727681">.</span><span class="ident" id="1727682">Pointer</span><span class="op" id="1727689">(</span><span class="ident" id="1727690">frame</span><span class="op" id="1727695">.</span><span class="ident" id="1727696">sp</span><span class="op" id="1727698">)</span><span class="op" id="1727699">)</span><span class="op" id="1727700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727705">frame</span><span class="op" id="1727710">.</span><span class="ident" id="1727711">sp</span>&nbsp;<span class="op" id="1727714">+=</span>&nbsp;<span class="ident" id="1727717">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727734">f</span>&nbsp;<span class="op" id="1727736">:=</span>&nbsp;<span class="ident" id="1727739">findfunc</span><span class="op" id="1727747">(</span><span class="ident" id="1727748">frame</span><span class="op" id="1727753">.</span><span class="ident" id="1727754">pc</span><span class="op" id="1727756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727759">if</span>&nbsp;<span class="ident" id="1727762">f</span>&nbsp;<span class="op" id="1727764">==</span>&nbsp;<span class="builtintype" id="1727767">nil</span>&nbsp;<span class="op" id="1727771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727775">if</span>&nbsp;<span class="ident" id="1727778">callback</span>&nbsp;<span class="op" id="1727787">!=</span>&nbsp;<span class="builtintype" id="1727790">nil</span>&nbsp;<span class="op" id="1727794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1727799">print</span><span class="op" id="1727804">(</span><span class="string" id="1727805">&#34;runtime:&nbsp;unknown&nbsp;pc&nbsp;&#34;</span><span class="op" id="1727827">,</span>&nbsp;<span class="ident" id="1727829">hex</span><span class="op" id="1727832">(</span><span class="ident" id="1727833">frame</span><span class="op" id="1727838">.</span><span class="ident" id="1727839">pc</span><span class="op" id="1727841">)</span><span class="op" id="1727842">,</span>&nbsp;<span class="string" id="1727844">&#34;\n&#34;</span><span class="op" id="1727848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727853">gothrow</span><span class="op" id="1727860">(</span><span class="string" id="1727861">&#34;unknown&nbsp;pc&#34;</span><span class="op" id="1727873">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727881">return</span>&nbsp;<span class="num" id="1727888">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1727891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727894">frame</span><span class="op" id="1727899">.</span><span class="ident" id="1727900">fn</span>&nbsp;<span class="op" id="1727903">=</span>&nbsp;<span class="ident" id="1727905">f</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1727909">n</span>&nbsp;<span class="op" id="1727911">:=</span>&nbsp;<span class="num" id="1727914">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1727917">for</span>&nbsp;<span class="ident" id="1727921">n</span>&nbsp;<span class="op" id="1727923">&lt;</span>&nbsp;<span class="ident" id="1727925">max</span>&nbsp;<span class="op" id="1727929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727933">//&nbsp;Typically:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727949">//&nbsp;&nbsp;&nbsp;&nbsp;pc&nbsp;is&nbsp;the&nbsp;PC&nbsp;of&nbsp;the&nbsp;running&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1727992">//&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;is&nbsp;the&nbsp;stack&nbsp;pointer&nbsp;at&nbsp;that&nbsp;program&nbsp;counter.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728046">//&nbsp;&nbsp;&nbsp;&nbsp;fp&nbsp;is&nbsp;the&nbsp;frame&nbsp;pointer&nbsp;(caller&#39;s&nbsp;stack&nbsp;pointer)&nbsp;at&nbsp;that&nbsp;program&nbsp;counter,&nbsp;or&nbsp;nil&nbsp;if&nbsp;unknown.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728144">//&nbsp;&nbsp;&nbsp;&nbsp;stk&nbsp;is&nbsp;the&nbsp;stack&nbsp;containing&nbsp;sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728181">//&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;caller&#39;s&nbsp;program&nbsp;counter&nbsp;is&nbsp;lr,&nbsp;unless&nbsp;lr&nbsp;is&nbsp;zero,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;is&nbsp;*(uintptr*)sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728276">f</span>&nbsp;<span class="op" id="1728278">=</span>&nbsp;<span class="ident" id="1728280">frame</span><span class="op" id="1728285">.</span><span class="ident" id="1728286">fn</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728292">//&nbsp;Found&nbsp;an&nbsp;actual&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728323">//&nbsp;Derive&nbsp;frame&nbsp;pointer&nbsp;and&nbsp;link&nbsp;register.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728368">if</span>&nbsp;<span class="ident" id="1728371">frame</span><span class="op" id="1728376">.</span><span class="ident" id="1728377">fp</span>&nbsp;<span class="op" id="1728380">==</span>&nbsp;<span class="num" id="1728383">0</span>&nbsp;<span class="op" id="1728385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728390">frame</span><span class="op" id="1728395">.</span><span class="ident" id="1728396">fp</span>&nbsp;<span class="op" id="1728399">=</span>&nbsp;<span class="ident" id="1728401">frame</span><span class="op" id="1728406">.</span><span class="ident" id="1728407">sp</span>&nbsp;<span class="op" id="1728410">+</span>&nbsp;<span class="builtintype" id="1728412">uintptr</span><span class="op" id="1728419">(</span><span class="ident" id="1728420">funcspdelta</span><span class="op" id="1728431">(</span><span class="ident" id="1728432">f</span><span class="op" id="1728433">,</span>&nbsp;<span class="ident" id="1728435">frame</span><span class="op" id="1728440">.</span><span class="ident" id="1728441">pc</span><span class="op" id="1728443">)</span><span class="op" id="1728444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728449">if</span>&nbsp;<span class="op" id="1728452">!</span><span class="ident" id="1728453">usesLR</span>&nbsp;<span class="op" id="1728460">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728466">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728545">frame</span><span class="op" id="1728550">.</span><span class="ident" id="1728551">fp</span>&nbsp;<span class="op" id="1728554">+=</span>&nbsp;<span class="ident" id="1728557">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728576">var</span>&nbsp;<span class="ident" id="1728580">flr</span>&nbsp;<span class="op" id="1728584">*</span><span class="ident" id="1728585">_func</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728593">if</span>&nbsp;<span class="ident" id="1728596">topofstack</span><span class="op" id="1728606">(</span><span class="ident" id="1728607">f</span><span class="op" id="1728608">)</span>&nbsp;<span class="op" id="1728610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728615">frame</span><span class="op" id="1728620">.</span><span class="ident" id="1728621">lr</span>&nbsp;<span class="op" id="1728624">=</span>&nbsp;<span class="num" id="1728626">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728631">flr</span>&nbsp;<span class="op" id="1728635">=</span>&nbsp;<span class="builtintype" id="1728637">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1728643">}</span>&nbsp;<span class="keyword" id="1728645">else</span>&nbsp;<span class="keyword" id="1728650">if</span>&nbsp;<span class="ident" id="1728653">usesLR</span>&nbsp;<span class="op" id="1728660">&amp;&amp;</span>&nbsp;<span class="ident" id="1728663">f</span><span class="op" id="1728664">.</span><span class="ident" id="1728665">entry</span>&nbsp;<span class="op" id="1728671">==</span>&nbsp;<span class="ident" id="1728674">jmpdeferPC</span>&nbsp;<span class="op" id="1728685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728690">//&nbsp;jmpdefer&nbsp;modifies&nbsp;SP/LR/PC&nbsp;non-atomically.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728739">//&nbsp;If&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;arrives&nbsp;during&nbsp;jmpdefer,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728795">//&nbsp;the&nbsp;stack&nbsp;unwind&nbsp;may&nbsp;see&nbsp;a&nbsp;mismatched&nbsp;register&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728852">//&nbsp;and&nbsp;get&nbsp;confused.&nbsp;Stop&nbsp;if&nbsp;we&nbsp;see&nbsp;PC&nbsp;within&nbsp;jmpdefer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728910">//&nbsp;to&nbsp;avoid&nbsp;that&nbsp;confusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1728941">//&nbsp;See&nbsp;golang.org/issue/8153.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1728974">if</span>&nbsp;<span class="ident" id="1728977">callback</span>&nbsp;<span class="op" id="1728986">!=</span>&nbsp;<span class="builtintype" id="1728989">nil</span>&nbsp;<span class="op" id="1728993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1728999">gothrow</span><span class="op" id="1729006">(</span><span class="string" id="1729007">&#34;traceback_arm:&nbsp;found&nbsp;jmpdefer&nbsp;when&nbsp;tracing&nbsp;with&nbsp;callback&#34;</span><span class="op" id="1729065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729075">frame</span><span class="op" id="1729080">.</span><span class="ident" id="1729081">lr</span>&nbsp;<span class="op" id="1729084">=</span>&nbsp;<span class="num" id="1729086">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729090">}</span>&nbsp;<span class="keyword" id="1729092">else</span>&nbsp;<span class="op" id="1729097">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729102">if</span>&nbsp;<span class="ident" id="1729105">usesLR</span>&nbsp;<span class="op" id="1729112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729118">if</span>&nbsp;<span class="ident" id="1729121">n</span>&nbsp;<span class="op" id="1729123">==</span>&nbsp;<span class="num" id="1729126">0</span>&nbsp;<span class="op" id="1729128">&amp;&amp;</span>&nbsp;<span class="ident" id="1729131">frame</span><span class="op" id="1729136">.</span><span class="ident" id="1729137">sp</span>&nbsp;<span class="op" id="1729140">&lt;</span>&nbsp;<span class="ident" id="1729142">frame</span><span class="op" id="1729147">.</span><span class="ident" id="1729148">fp</span>&nbsp;<span class="op" id="1729151">||</span>&nbsp;<span class="ident" id="1729154">frame</span><span class="op" id="1729159">.</span><span class="ident" id="1729160">lr</span>&nbsp;<span class="op" id="1729163">==</span>&nbsp;<span class="num" id="1729166">0</span>&nbsp;<span class="op" id="1729168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729175">frame</span><span class="op" id="1729180">.</span><span class="ident" id="1729181">lr</span>&nbsp;<span class="op" id="1729184">=</span>&nbsp;<span class="op" id="1729186">*</span><span class="op" id="1729187">(</span><span class="op" id="1729188">*</span><span class="builtintype" id="1729189">uintptr</span><span class="op" id="1729196">)</span><span class="op" id="1729197">(</span><span class="ident" id="1729198">unsafe</span><span class="op" id="1729204">.</span><span class="ident" id="1729205">Pointer</span><span class="op" id="1729212">(</span><span class="ident" id="1729213">frame</span><span class="op" id="1729218">.</span><span class="ident" id="1729219">sp</span><span class="op" id="1729221">)</span><span class="op" id="1729222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729233">}</span>&nbsp;<span class="keyword" id="1729235">else</span>&nbsp;<span class="op" id="1729240">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729246">if</span>&nbsp;<span class="ident" id="1729249">frame</span><span class="op" id="1729254">.</span><span class="ident" id="1729255">lr</span>&nbsp;<span class="op" id="1729258">==</span>&nbsp;<span class="num" id="1729261">0</span>&nbsp;<span class="op" id="1729263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729270">frame</span><span class="op" id="1729275">.</span><span class="ident" id="1729276">lr</span>&nbsp;<span class="op" id="1729279">=</span>&nbsp;<span class="builtintype" id="1729281">uintptr</span><span class="op" id="1729288">(</span><span class="op" id="1729289">*</span><span class="op" id="1729290">(</span><span class="op" id="1729291">*</span><span class="ident" id="1729292">uintreg</span><span class="op" id="1729299">)</span><span class="op" id="1729300">(</span><span class="ident" id="1729301">unsafe</span><span class="op" id="1729307">.</span><span class="ident" id="1729308">Pointer</span><span class="op" id="1729315">(</span><span class="ident" id="1729316">frame</span><span class="op" id="1729321">.</span><span class="ident" id="1729322">fp</span>&nbsp;<span class="op" id="1729325">-</span>&nbsp;<span class="ident" id="1729327">regSize</span><span class="op" id="1729334">)</span><span class="op" id="1729335">)</span><span class="op" id="1729336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729352">flr</span>&nbsp;<span class="op" id="1729356">=</span>&nbsp;<span class="ident" id="1729358">findfunc</span><span class="op" id="1729366">(</span><span class="ident" id="1729367">frame</span><span class="op" id="1729372">.</span><span class="ident" id="1729373">lr</span><span class="op" id="1729375">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729380">if</span>&nbsp;<span class="ident" id="1729383">flr</span>&nbsp;<span class="op" id="1729387">==</span>&nbsp;<span class="builtintype" id="1729390">nil</span>&nbsp;<span class="op" id="1729394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729400">//&nbsp;This&nbsp;happens&nbsp;if&nbsp;you&nbsp;get&nbsp;a&nbsp;profiling&nbsp;interrupt&nbsp;at&nbsp;just&nbsp;the&nbsp;wrong&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729477">//&nbsp;In&nbsp;that&nbsp;context&nbsp;it&nbsp;is&nbsp;okay&nbsp;to&nbsp;stop&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729526">//&nbsp;But&nbsp;if&nbsp;callback&nbsp;is&nbsp;set,&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;and&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729599">//&nbsp;get&nbsp;everything,&nbsp;so&nbsp;crash&nbsp;loudly.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729639">if</span>&nbsp;<span class="ident" id="1729642">callback</span>&nbsp;<span class="op" id="1729651">!=</span>&nbsp;<span class="builtintype" id="1729654">nil</span>&nbsp;<span class="op" id="1729658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1729665">print</span><span class="op" id="1729670">(</span><span class="string" id="1729671">&#34;runtime:&nbsp;unexpected&nbsp;return&nbsp;pc&nbsp;for&nbsp;&#34;</span><span class="op" id="1729707">,</span>&nbsp;<span class="ident" id="1729709">gofuncname</span><span class="op" id="1729719">(</span><span class="ident" id="1729720">f</span><span class="op" id="1729721">)</span><span class="op" id="1729722">,</span>&nbsp;<span class="string" id="1729724">&#34;&nbsp;called&nbsp;from&nbsp;&#34;</span><span class="op" id="1729739">,</span>&nbsp;<span class="ident" id="1729741">hex</span><span class="op" id="1729744">(</span><span class="ident" id="1729745">frame</span><span class="op" id="1729750">.</span><span class="ident" id="1729751">lr</span><span class="op" id="1729753">)</span><span class="op" id="1729754">,</span>&nbsp;<span class="string" id="1729756">&#34;\n&#34;</span><span class="op" id="1729760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729767">gothrow</span><span class="op" id="1729774">(</span><span class="string" id="1729775">&#34;unknown&nbsp;caller&nbsp;pc&#34;</span><span class="op" id="1729794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729805">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729814">frame</span><span class="op" id="1729819">.</span><span class="ident" id="1729820">varp</span>&nbsp;<span class="op" id="1729825">=</span>&nbsp;<span class="ident" id="1729827">frame</span><span class="op" id="1729832">.</span><span class="ident" id="1729833">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1729838">if</span>&nbsp;<span class="op" id="1729841">!</span><span class="ident" id="1729842">usesLR</span>&nbsp;<span class="op" id="1729849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729854">//&nbsp;On&nbsp;x86,&nbsp;call&nbsp;instruction&nbsp;pushes&nbsp;return&nbsp;PC&nbsp;before&nbsp;entering&nbsp;new&nbsp;function.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1729932">frame</span><span class="op" id="1729937">.</span><span class="ident" id="1729938">varp</span>&nbsp;<span class="op" id="1729943">-=</span>&nbsp;<span class="ident" id="1729946">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1729956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729961">//&nbsp;Derive&nbsp;size&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1729992">//&nbsp;Most&nbsp;functions&nbsp;have&nbsp;a&nbsp;fixed-size&nbsp;argument&nbsp;block,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730046">//&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;metadata&nbsp;about&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730096">//&nbsp;Not&nbsp;all,&nbsp;though:&nbsp;there&nbsp;are&nbsp;some&nbsp;variadic&nbsp;functions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730152">//&nbsp;in&nbsp;package&nbsp;runtime&nbsp;and&nbsp;reflect,&nbsp;and&nbsp;for&nbsp;those&nbsp;we&nbsp;use&nbsp;call-specific</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730224">//&nbsp;metadata&nbsp;recorded&nbsp;by&nbsp;f&#39;s&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730262">if</span>&nbsp;<span class="ident" id="1730265">callback</span>&nbsp;<span class="op" id="1730274">!=</span>&nbsp;<span class="builtintype" id="1730277">nil</span>&nbsp;<span class="op" id="1730281">||</span>&nbsp;<span class="ident" id="1730284">printing</span>&nbsp;<span class="op" id="1730293">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730298">frame</span><span class="op" id="1730303">.</span><span class="ident" id="1730304">argp</span>&nbsp;<span class="op" id="1730309">=</span>&nbsp;<span class="ident" id="1730311">frame</span><span class="op" id="1730316">.</span><span class="ident" id="1730317">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730323">if</span>&nbsp;<span class="ident" id="1730326">usesLR</span>&nbsp;<span class="op" id="1730333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730339">frame</span><span class="op" id="1730344">.</span><span class="ident" id="1730345">argp</span>&nbsp;<span class="op" id="1730350">+=</span>&nbsp;<span class="ident" id="1730353">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1730369">setArgInfo</span><span class="op" id="1730379">(</span><span class="op" id="1730380">&amp;</span><span class="ident" id="1730381">frame</span><span class="op" id="1730386">,</span>&nbsp;<span class="ident" id="1730388">f</span><span class="op" id="1730389">,</span>&nbsp;<span class="ident" id="1730391">callback</span>&nbsp;<span class="op" id="1730400">!=</span>&nbsp;<span class="builtintype" id="1730403">nil</span><span class="op" id="1730406">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1730410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730415">//&nbsp;Determine&nbsp;function&nbsp;SP&nbsp;where&nbsp;deferproc&nbsp;would&nbsp;find&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730484">var</span>&nbsp;<span class="ident" id="1730488">sparg</span>&nbsp;<span class="builtintype" id="1730494">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1730504">if</span>&nbsp;<span class="ident" id="1730507">usesLR</span>&nbsp;<span class="op" id="1730514">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730519">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack&nbsp;plus&nbsp;1&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730605">//&nbsp;for&nbsp;the&nbsp;saved&nbsp;LR.&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730691">//&nbsp;however,&nbsp;the&nbsp;SP&nbsp;is&nbsp;three&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730747">//&nbsp;If&nbsp;the&nbsp;function&nbsp;has&nbsp;no&nbsp;frame&nbsp;at&nbsp;all&nbsp;-&nbsp;perhaps&nbsp;it&nbsp;just&nbsp;started,&nbsp;or&nbsp;perhaps</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730827">//&nbsp;it&nbsp;is&nbsp;a&nbsp;leaf&nbsp;with&nbsp;no&nbsp;local&nbsp;variables&nbsp;-&nbsp;then&nbsp;we&nbsp;cannot&nbsp;possibly&nbsp;find&nbsp;its</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730905">//&nbsp;SP&nbsp;in&nbsp;a&nbsp;defer,&nbsp;and&nbsp;we&nbsp;might&nbsp;confuse&nbsp;its&nbsp;SP&nbsp;for&nbsp;its&nbsp;caller&#39;s&nbsp;SP,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1730978">//&nbsp;leave&nbsp;sparg=0&nbsp;in&nbsp;that&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1731012">if</span>&nbsp;<span class="ident" id="1731015">frame</span><span class="op" id="1731020">.</span><span class="ident" id="1731021">fp</span>&nbsp;<span class="op" id="1731024">!=</span>&nbsp;<span class="ident" id="1731027">frame</span><span class="op" id="1731032">.</span><span class="ident" id="1731033">sp</span>&nbsp;<span class="op" id="1731036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1731042">sparg</span>&nbsp;<span class="op" id="1731048">=</span>&nbsp;<span class="ident" id="1731050">frame</span><span class="op" id="1731055">.</span><span class="ident" id="1731056">sp</span>&nbsp;<span class="op" id="1731059">+</span>&nbsp;<span class="ident" id="1731061">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1731073">if</span>&nbsp;<span class="ident" id="1731076">wasnewproc</span>&nbsp;<span class="op" id="1731087">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1731094">sparg</span>&nbsp;<span class="op" id="1731100">+=</span>&nbsp;<span class="num" id="1731103">3</span>&nbsp;<span class="op" id="1731105">*</span>&nbsp;<span class="ident" id="1731107">regSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1731119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1731124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1731128">}</span>&nbsp;<span class="keyword" id="1731130">else</span>&nbsp;<span class="op" id="1731135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731140">//&nbsp;On&nbsp;x86&nbsp;that&#39;s&nbsp;the&nbsp;standard&nbsp;bottom-of-stack,&nbsp;so&nbsp;SP&nbsp;exactly.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731205">//&nbsp;If&nbsp;the&nbsp;previous&nbsp;frame&nbsp;was&nbsp;a&nbsp;direct&nbsp;call&nbsp;to&nbsp;newproc/deferproc,&nbsp;however,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731282">//&nbsp;the&nbsp;SP&nbsp;is&nbsp;two&nbsp;words&nbsp;lower&nbsp;than&nbsp;normal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1731327">sparg</span>&nbsp;<span class="op" id="1731333">=</span>&nbsp;<span class="ident" id="1731335">frame</span><span class="op" id="1731340">.</span><span class="ident" id="1731341">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1731347">if</span>&nbsp;<span class="ident" id="1731350">wasnewproc</span>&nbsp;<span class="op" id="1731361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1731367">sparg</span>&nbsp;<span class="op" id="1731373">+=</span>&nbsp;<span class="num" id="1731376">2</span>&nbsp;<span class="op" id="1731378">*</span>&nbsp;<span class="ident" id="1731380">ptrSize</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1731391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1731395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731400">//&nbsp;Determine&nbsp;frame&#39;s&nbsp;&#39;continuation&nbsp;PC&#39;,&nbsp;where&nbsp;it&nbsp;can&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731465">//&nbsp;Normally&nbsp;this&nbsp;is&nbsp;the&nbsp;return&nbsp;address&nbsp;on&nbsp;the&nbsp;stack,&nbsp;but&nbsp;if&nbsp;sigpanic</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731536">//&nbsp;is&nbsp;immediately&nbsp;below&nbsp;this&nbsp;function&nbsp;on&nbsp;the&nbsp;stack,&nbsp;then&nbsp;the&nbsp;frame</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731605">//&nbsp;stopped&nbsp;executing&nbsp;due&nbsp;to&nbsp;a&nbsp;trap,&nbsp;and&nbsp;frame.pc&nbsp;is&nbsp;probably&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731672">//&nbsp;a&nbsp;safe&nbsp;point&nbsp;for&nbsp;looking&nbsp;up&nbsp;liveness&nbsp;information.&nbsp;In&nbsp;this&nbsp;panicking&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731751">//&nbsp;the&nbsp;function&nbsp;either&nbsp;doesn&#39;t&nbsp;return&nbsp;at&nbsp;all&nbsp;(if&nbsp;it&nbsp;has&nbsp;no&nbsp;defers&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731829">//&nbsp;defers&nbsp;do&nbsp;not&nbsp;recover)&nbsp;or&nbsp;it&nbsp;returns&nbsp;from&nbsp;one&nbsp;of&nbsp;the&nbsp;calls&nbsp;to</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731896">//&nbsp;deferproc&nbsp;a&nbsp;second&nbsp;time&nbsp;(if&nbsp;the&nbsp;corresponding&nbsp;deferred&nbsp;func&nbsp;recovers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1731972">//&nbsp;It&nbsp;suffices&nbsp;to&nbsp;assume&nbsp;that&nbsp;the&nbsp;most&nbsp;recent&nbsp;deferproc&nbsp;is&nbsp;the&nbsp;one&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732046">//&nbsp;returns;&nbsp;everything&nbsp;live&nbsp;at&nbsp;earlier&nbsp;deferprocs&nbsp;is&nbsp;still&nbsp;live&nbsp;at&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732125">frame</span><span class="op" id="1732130">.</span><span class="ident" id="1732131">continpc</span>&nbsp;<span class="op" id="1732140">=</span>&nbsp;<span class="ident" id="1732142">frame</span><span class="op" id="1732147">.</span><span class="ident" id="1732148">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732153">if</span>&nbsp;<span class="ident" id="1732156">waspanic</span>&nbsp;<span class="op" id="1732165">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732170">if</span>&nbsp;<span class="ident" id="1732173">_defer</span>&nbsp;<span class="op" id="1732180">!=</span>&nbsp;<span class="builtintype" id="1732183">nil</span>&nbsp;<span class="op" id="1732187">&amp;&amp;</span>&nbsp;<span class="ident" id="1732190">_defer</span><span class="op" id="1732196">.</span><span class="ident" id="1732197">argp</span>&nbsp;<span class="op" id="1732202">==</span>&nbsp;<span class="ident" id="1732205">sparg</span>&nbsp;<span class="op" id="1732211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732217">frame</span><span class="op" id="1732222">.</span><span class="ident" id="1732223">continpc</span>&nbsp;<span class="op" id="1732232">=</span>&nbsp;<span class="ident" id="1732234">_defer</span><span class="op" id="1732240">.</span><span class="ident" id="1732241">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732247">}</span>&nbsp;<span class="keyword" id="1732249">else</span>&nbsp;<span class="op" id="1732254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732260">frame</span><span class="op" id="1732265">.</span><span class="ident" id="1732266">continpc</span>&nbsp;<span class="op" id="1732275">=</span>&nbsp;<span class="num" id="1732277">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732282">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732291">//&nbsp;Unwind&nbsp;our&nbsp;local&nbsp;defer&nbsp;stack&nbsp;past&nbsp;this&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732342">for</span>&nbsp;<span class="ident" id="1732346">_defer</span>&nbsp;<span class="op" id="1732353">!=</span>&nbsp;<span class="builtintype" id="1732356">nil</span>&nbsp;<span class="op" id="1732360">&amp;&amp;</span>&nbsp;<span class="op" id="1732363">(</span><span class="ident" id="1732364">_defer</span><span class="op" id="1732370">.</span><span class="ident" id="1732371">argp</span>&nbsp;<span class="op" id="1732376">==</span>&nbsp;<span class="ident" id="1732379">sparg</span>&nbsp;<span class="op" id="1732385">||</span>&nbsp;<span class="ident" id="1732388">_defer</span><span class="op" id="1732394">.</span><span class="ident" id="1732395">argp</span>&nbsp;<span class="op" id="1732400">==</span>&nbsp;<span class="ident" id="1732403">_NoArgs</span><span class="op" id="1732410">)</span>&nbsp;<span class="op" id="1732412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732417">_defer</span>&nbsp;<span class="op" id="1732424">=</span>&nbsp;<span class="ident" id="1732426">_defer</span><span class="op" id="1732432">.</span><span class="ident" id="1732433">link</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732445">if</span>&nbsp;<span class="ident" id="1732448">skip</span>&nbsp;<span class="op" id="1732453">&gt;</span>&nbsp;<span class="num" id="1732455">0</span>&nbsp;<span class="op" id="1732457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732462">skip</span><span class="op" id="1732466">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732472">goto</span>&nbsp;<span class="ident" id="1732477">skipped</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732492">if</span>&nbsp;<span class="ident" id="1732495">pcbuf</span>&nbsp;<span class="op" id="1732501">!=</span>&nbsp;<span class="builtintype" id="1732504">nil</span>&nbsp;<span class="op" id="1732508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732513">(</span><span class="op" id="1732514">*</span><span class="op" id="1732515">[</span><span class="num" id="1732516">1</span>&nbsp;<span class="op" id="1732518">&lt;&lt;</span>&nbsp;<span class="num" id="1732521">20</span><span class="op" id="1732523">]</span><span class="builtintype" id="1732524">uintptr</span><span class="op" id="1732531">)</span><span class="op" id="1732532">(</span><span class="ident" id="1732533">unsafe</span><span class="op" id="1732539">.</span><span class="ident" id="1732540">Pointer</span><span class="op" id="1732547">(</span><span class="ident" id="1732548">pcbuf</span><span class="op" id="1732553">)</span><span class="op" id="1732554">)</span><span class="op" id="1732555">[</span><span class="ident" id="1732556">n</span><span class="op" id="1732557">]</span>&nbsp;<span class="op" id="1732559">=</span>&nbsp;<span class="ident" id="1732561">frame</span><span class="op" id="1732566">.</span><span class="ident" id="1732567">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732572">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732576">if</span>&nbsp;<span class="ident" id="1732579">callback</span>&nbsp;<span class="op" id="1732588">!=</span>&nbsp;<span class="builtintype" id="1732591">nil</span>&nbsp;<span class="op" id="1732595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732600">if</span>&nbsp;<span class="op" id="1732603">!</span><span class="ident" id="1732604">callback</span><span class="op" id="1732612">(</span><span class="op" id="1732613">(</span><span class="op" id="1732614">*</span><span class="ident" id="1732615">stkframe</span><span class="op" id="1732623">)</span><span class="op" id="1732624">(</span><span class="ident" id="1732625">noescape</span><span class="op" id="1732633">(</span><span class="ident" id="1732634">unsafe</span><span class="op" id="1732640">.</span><span class="ident" id="1732641">Pointer</span><span class="op" id="1732648">(</span><span class="op" id="1732649">&amp;</span><span class="ident" id="1732650">frame</span><span class="op" id="1732655">)</span><span class="op" id="1732656">)</span><span class="op" id="1732657">)</span><span class="op" id="1732658">,</span>&nbsp;<span class="ident" id="1732660">v</span><span class="op" id="1732661">)</span>&nbsp;<span class="op" id="1732663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732669">return</span>&nbsp;<span class="ident" id="1732676">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1732685">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732689">if</span>&nbsp;<span class="ident" id="1732692">printing</span>&nbsp;<span class="op" id="1732701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732706">if</span>&nbsp;<span class="op" id="1732709">(</span><span class="ident" id="1732710">flags</span><span class="op" id="1732715">&amp;</span><span class="ident" id="1732716">_TraceRuntimeFrames</span><span class="op" id="1732735">)</span>&nbsp;<span class="op" id="1732737">!=</span>&nbsp;<span class="num" id="1732740">0</span>&nbsp;<span class="op" id="1732742">||</span>&nbsp;<span class="ident" id="1732745">showframe</span><span class="op" id="1732754">(</span><span class="ident" id="1732755">f</span><span class="op" id="1732756">,</span>&nbsp;<span class="ident" id="1732758">gp</span><span class="op" id="1732760">)</span>&nbsp;<span class="op" id="1732762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732768">//&nbsp;Print&nbsp;during&nbsp;crash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732795">//&nbsp;&nbsp;&nbsp;&nbsp;main(0x1,&nbsp;0x2,&nbsp;0x3)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732822">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/home/rsc/go/src/runtime/x.go:23&nbsp;+0xf</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1732868">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1732875">tracepc</span>&nbsp;<span class="op" id="1732883">:=</span>&nbsp;<span class="ident" id="1732886">frame</span><span class="op" id="1732891">.</span><span class="ident" id="1732892">pc</span>&nbsp;<span class="comment" id="1732895">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1732944">if</span>&nbsp;<span class="op" id="1732947">(</span><span class="ident" id="1732948">n</span>&nbsp;<span class="op" id="1732950">&gt;</span>&nbsp;<span class="num" id="1732952">0</span>&nbsp;<span class="op" id="1732954">||</span>&nbsp;<span class="ident" id="1732957">flags</span><span class="op" id="1732962">&amp;</span><span class="ident" id="1732963">_TraceTrap</span>&nbsp;<span class="op" id="1732974">==</span>&nbsp;<span class="num" id="1732977">0</span><span class="op" id="1732978">)</span>&nbsp;<span class="op" id="1732980">&amp;&amp;</span>&nbsp;<span class="ident" id="1732983">frame</span><span class="op" id="1732988">.</span><span class="ident" id="1732989">pc</span>&nbsp;<span class="op" id="1732992">&gt;</span>&nbsp;<span class="ident" id="1732994">f</span><span class="op" id="1732995">.</span><span class="ident" id="1732996">entry</span>&nbsp;<span class="op" id="1733002">&amp;&amp;</span>&nbsp;<span class="op" id="1733005">!</span><span class="ident" id="1733006">waspanic</span>&nbsp;<span class="op" id="1733015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733022">tracepc</span><span class="op" id="1733029">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733036">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733042">print</span><span class="op" id="1733047">(</span><span class="ident" id="1733048">gofuncname</span><span class="op" id="1733058">(</span><span class="ident" id="1733059">f</span><span class="op" id="1733060">)</span><span class="op" id="1733061">,</span>&nbsp;<span class="string" id="1733063">&#34;(&#34;</span><span class="op" id="1733066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733072">argp</span>&nbsp;<span class="op" id="1733077">:=</span>&nbsp;<span class="op" id="1733080">(</span><span class="op" id="1733081">*</span><span class="op" id="1733082">[</span><span class="num" id="1733083">100</span><span class="op" id="1733086">]</span><span class="builtintype" id="1733087">uintptr</span><span class="op" id="1733094">)</span><span class="op" id="1733095">(</span><span class="ident" id="1733096">unsafe</span><span class="op" id="1733102">.</span><span class="ident" id="1733103">Pointer</span><span class="op" id="1733110">(</span><span class="ident" id="1733111">frame</span><span class="op" id="1733116">.</span><span class="ident" id="1733117">argp</span><span class="op" id="1733121">)</span><span class="op" id="1733122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733128">for</span>&nbsp;<span class="ident" id="1733132">i</span>&nbsp;<span class="op" id="1733134">:=</span>&nbsp;<span class="builtintype" id="1733137">uintptr</span><span class="op" id="1733144">(</span><span class="num" id="1733145">0</span><span class="op" id="1733146">)</span><span class="op" id="1733147">;</span>&nbsp;<span class="ident" id="1733149">i</span>&nbsp;<span class="op" id="1733151">&lt;</span>&nbsp;<span class="ident" id="1733153">frame</span><span class="op" id="1733158">.</span><span class="ident" id="1733159">arglen</span><span class="op" id="1733165">/</span><span class="ident" id="1733166">ptrSize</span><span class="op" id="1733173">;</span>&nbsp;<span class="ident" id="1733175">i</span><span class="op" id="1733176">++</span>&nbsp;<span class="op" id="1733179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733186">if</span>&nbsp;<span class="ident" id="1733189">i</span>&nbsp;<span class="op" id="1733191">&gt;=</span>&nbsp;<span class="num" id="1733194">10</span>&nbsp;<span class="op" id="1733197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733205">print</span><span class="op" id="1733210">(</span><span class="string" id="1733211">&#34;,&nbsp;...&#34;</span><span class="op" id="1733218">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733226">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733244">if</span>&nbsp;<span class="ident" id="1733247">i</span>&nbsp;<span class="op" id="1733249">!=</span>&nbsp;<span class="num" id="1733252">0</span>&nbsp;<span class="op" id="1733254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733262">print</span><span class="op" id="1733267">(</span><span class="string" id="1733268">&#34;,&nbsp;&#34;</span><span class="op" id="1733272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733279">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733286">print</span><span class="op" id="1733291">(</span><span class="ident" id="1733292">hex</span><span class="op" id="1733295">(</span><span class="ident" id="1733296">argp</span><span class="op" id="1733300">[</span><span class="ident" id="1733301">i</span><span class="op" id="1733302">]</span><span class="op" id="1733303">)</span><span class="op" id="1733304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733316">print</span><span class="op" id="1733321">(</span><span class="string" id="1733322">&#34;)\n&#34;</span><span class="op" id="1733327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733333">var</span>&nbsp;<span class="ident" id="1733337">file</span>&nbsp;<span class="builtintype" id="1733342">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733353">line</span>&nbsp;<span class="op" id="1733358">:=</span>&nbsp;<span class="ident" id="1733361">funcline</span><span class="op" id="1733369">(</span><span class="ident" id="1733370">f</span><span class="op" id="1733371">,</span>&nbsp;<span class="ident" id="1733373">tracepc</span><span class="op" id="1733380">,</span>&nbsp;<span class="op" id="1733382">&amp;</span><span class="ident" id="1733383">file</span><span class="op" id="1733387">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733393">print</span><span class="op" id="1733398">(</span><span class="string" id="1733399">&#34;\t&#34;</span><span class="op" id="1733403">,</span>&nbsp;<span class="ident" id="1733405">file</span><span class="op" id="1733409">,</span>&nbsp;<span class="string" id="1733411">&#34;:&#34;</span><span class="op" id="1733414">,</span>&nbsp;<span class="ident" id="1733416">line</span><span class="op" id="1733420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733426">if</span>&nbsp;<span class="ident" id="1733429">frame</span><span class="op" id="1733434">.</span><span class="ident" id="1733435">pc</span>&nbsp;<span class="op" id="1733438">&gt;</span>&nbsp;<span class="ident" id="1733440">f</span><span class="op" id="1733441">.</span><span class="ident" id="1733442">entry</span>&nbsp;<span class="op" id="1733448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733455">print</span><span class="op" id="1733460">(</span><span class="string" id="1733461">&#34;&nbsp;+&#34;</span><span class="op" id="1733465">,</span>&nbsp;<span class="ident" id="1733467">hex</span><span class="op" id="1733470">(</span><span class="ident" id="1733471">frame</span><span class="op" id="1733476">.</span><span class="ident" id="1733477">pc</span><span class="op" id="1733479">-</span><span class="ident" id="1733480">f</span><span class="op" id="1733481">.</span><span class="ident" id="1733482">entry</span><span class="op" id="1733487">)</span><span class="op" id="1733488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733500">if</span>&nbsp;<span class="ident" id="1733503">g</span><span class="op" id="1733504">.</span><span class="ident" id="1733505">m</span><span class="op" id="1733506">.</span><span class="ident" id="1733507">throwing</span>&nbsp;<span class="op" id="1733516">&gt;</span>&nbsp;<span class="num" id="1733518">0</span>&nbsp;<span class="op" id="1733520">&amp;&amp;</span>&nbsp;<span class="ident" id="1733523">gp</span>&nbsp;<span class="op" id="1733526">==</span>&nbsp;<span class="ident" id="1733529">g</span><span class="op" id="1733530">.</span><span class="ident" id="1733531">m</span><span class="op" id="1733532">.</span><span class="ident" id="1733533">curg</span>&nbsp;<span class="op" id="1733538">||</span>&nbsp;<span class="ident" id="1733541">gotraceback</span>&nbsp;<span class="op" id="1733553">&gt;=</span>&nbsp;<span class="num" id="1733556">2</span>&nbsp;<span class="op" id="1733558">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733565">print</span><span class="op" id="1733570">(</span><span class="string" id="1733571">&#34;&nbsp;fp=&#34;</span><span class="op" id="1733577">,</span>&nbsp;<span class="ident" id="1733579">hex</span><span class="op" id="1733582">(</span><span class="ident" id="1733583">frame</span><span class="op" id="1733588">.</span><span class="ident" id="1733589">fp</span><span class="op" id="1733591">)</span><span class="op" id="1733592">,</span>&nbsp;<span class="string" id="1733594">&#34;&nbsp;sp=&#34;</span><span class="op" id="1733600">,</span>&nbsp;<span class="ident" id="1733602">hex</span><span class="op" id="1733605">(</span><span class="ident" id="1733606">frame</span><span class="op" id="1733611">.</span><span class="ident" id="1733612">sp</span><span class="op" id="1733614">)</span><span class="op" id="1733615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1733627">print</span><span class="op" id="1733632">(</span><span class="string" id="1733633">&#34;\n&#34;</span><span class="op" id="1733637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733643">nprint</span><span class="op" id="1733649">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733655">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733663">n</span><span class="op" id="1733664">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733669">skipped</span><span class="op" id="1733676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733680">waspanic</span>&nbsp;<span class="op" id="1733689">=</span>&nbsp;<span class="ident" id="1733691">f</span><span class="op" id="1733692">.</span><span class="ident" id="1733693">entry</span>&nbsp;<span class="op" id="1733699">==</span>&nbsp;<span class="ident" id="1733702">sigpanicPC</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733715">wasnewproc</span>&nbsp;<span class="op" id="1733726">=</span>&nbsp;<span class="ident" id="1733728">f</span><span class="op" id="1733729">.</span><span class="ident" id="1733730">entry</span>&nbsp;<span class="op" id="1733736">==</span>&nbsp;<span class="ident" id="1733739">newprocPC</span>&nbsp;<span class="op" id="1733749">||</span>&nbsp;<span class="ident" id="1733752">f</span><span class="op" id="1733753">.</span><span class="ident" id="1733754">entry</span>&nbsp;<span class="op" id="1733760">==</span>&nbsp;<span class="ident" id="1733763">deferprocPC</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1733778">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;past&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733827">if</span>&nbsp;<span class="ident" id="1733830">flr</span>&nbsp;<span class="op" id="1733834">==</span>&nbsp;<span class="builtintype" id="1733837">nil</span>&nbsp;<span class="op" id="1733841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1733846">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1733854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1733859">//&nbsp;Unwind&nbsp;to&nbsp;next&nbsp;frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733886">frame</span><span class="op" id="1733891">.</span><span class="ident" id="1733892">fn</span>&nbsp;<span class="op" id="1733895">=</span>&nbsp;<span class="ident" id="1733897">flr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733903">frame</span><span class="op" id="1733908">.</span><span class="ident" id="1733909">pc</span>&nbsp;<span class="op" id="1733912">=</span>&nbsp;<span class="ident" id="1733914">frame</span><span class="op" id="1733919">.</span><span class="ident" id="1733920">lr</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733925">frame</span><span class="op" id="1733930">.</span><span class="ident" id="1733931">lr</span>&nbsp;<span class="op" id="1733934">=</span>&nbsp;<span class="num" id="1733936">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733940">frame</span><span class="op" id="1733945">.</span><span class="ident" id="1733946">sp</span>&nbsp;<span class="op" id="1733949">=</span>&nbsp;<span class="ident" id="1733951">frame</span><span class="op" id="1733956">.</span><span class="ident" id="1733957">fp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733962">frame</span><span class="op" id="1733967">.</span><span class="ident" id="1733968">fp</span>&nbsp;<span class="op" id="1733971">=</span>&nbsp;<span class="num" id="1733973">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1733977">frame</span><span class="op" id="1733982">.</span><span class="ident" id="1733983">argmap</span>&nbsp;<span class="op" id="1733990">=</span>&nbsp;<span class="builtintype" id="1733992">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1733999">//&nbsp;On&nbsp;link&nbsp;register&nbsp;architectures,&nbsp;sighandler&nbsp;saves&nbsp;the&nbsp;LR&nbsp;on&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734069">//&nbsp;before&nbsp;faking&nbsp;a&nbsp;call&nbsp;to&nbsp;sigpanic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1734108">if</span>&nbsp;<span class="ident" id="1734111">usesLR</span>&nbsp;<span class="op" id="1734118">&amp;&amp;</span>&nbsp;<span class="ident" id="1734121">waspanic</span>&nbsp;<span class="op" id="1734130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734135">x</span>&nbsp;<span class="op" id="1734137">:=</span>&nbsp;<span class="op" id="1734140">*</span><span class="op" id="1734141">(</span><span class="op" id="1734142">*</span><span class="builtintype" id="1734143">uintptr</span><span class="op" id="1734150">)</span><span class="op" id="1734151">(</span><span class="ident" id="1734152">unsafe</span><span class="op" id="1734158">.</span><span class="ident" id="1734159">Pointer</span><span class="op" id="1734166">(</span><span class="ident" id="1734167">frame</span><span class="op" id="1734172">.</span><span class="ident" id="1734173">sp</span><span class="op" id="1734175">)</span><span class="op" id="1734176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734181">frame</span><span class="op" id="1734186">.</span><span class="ident" id="1734187">sp</span>&nbsp;<span class="op" id="1734190">+=</span>&nbsp;<span class="ident" id="1734193">ptrSize</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734204">f</span>&nbsp;<span class="op" id="1734206">=</span>&nbsp;<span class="ident" id="1734208">findfunc</span><span class="op" id="1734216">(</span><span class="ident" id="1734217">frame</span><span class="op" id="1734222">.</span><span class="ident" id="1734223">pc</span><span class="op" id="1734225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734230">frame</span><span class="op" id="1734235">.</span><span class="ident" id="1734236">fn</span>&nbsp;<span class="op" id="1734239">=</span>&nbsp;<span class="ident" id="1734241">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1734246">if</span>&nbsp;<span class="ident" id="1734249">f</span>&nbsp;<span class="op" id="1734251">==</span>&nbsp;<span class="builtintype" id="1734254">nil</span>&nbsp;<span class="op" id="1734258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734264">frame</span><span class="op" id="1734269">.</span><span class="ident" id="1734270">pc</span>&nbsp;<span class="op" id="1734273">=</span>&nbsp;<span class="ident" id="1734275">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1734280">}</span>&nbsp;<span class="keyword" id="1734282">else</span>&nbsp;<span class="keyword" id="1734287">if</span>&nbsp;<span class="ident" id="1734290">f</span><span class="op" id="1734291">.</span><span class="ident" id="1734292">frame</span>&nbsp;<span class="op" id="1734298">==</span>&nbsp;<span class="num" id="1734301">0</span>&nbsp;<span class="op" id="1734303">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734309">frame</span><span class="op" id="1734314">.</span><span class="ident" id="1734315">lr</span>&nbsp;<span class="op" id="1734318">=</span>&nbsp;<span class="ident" id="1734320">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1734325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1734329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1734332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1734336">if</span>&nbsp;<span class="ident" id="1734339">pcbuf</span>&nbsp;<span class="op" id="1734345">==</span>&nbsp;<span class="builtintype" id="1734348">nil</span>&nbsp;<span class="op" id="1734352">&amp;&amp;</span>&nbsp;<span class="ident" id="1734355">callback</span>&nbsp;<span class="op" id="1734364">==</span>&nbsp;<span class="builtintype" id="1734367">nil</span>&nbsp;<span class="op" id="1734371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1734375">n</span>&nbsp;<span class="op" id="1734377">=</span>&nbsp;<span class="ident" id="1734379">nprint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1734387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734391">//&nbsp;If&nbsp;callback&nbsp;!=&nbsp;nil,&nbsp;we&#39;re&nbsp;being&nbsp;called&nbsp;to&nbsp;gather&nbsp;stack&nbsp;information&nbsp;during</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734469">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth.&nbsp;In&nbsp;that&nbsp;context,&nbsp;require&nbsp;that&nbsp;we&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734547">//&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;not,&nbsp;then&nbsp;there&nbsp;is&nbsp;a&nbsp;bug&nbsp;somewhere&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734624">//&nbsp;garbage&nbsp;collection&nbsp;or&nbsp;stack&nbsp;growth&nbsp;may&nbsp;not&nbsp;have&nbsp;seen&nbsp;the&nbsp;correct&nbsp;picture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734701">//&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Crash&nbsp;now&nbsp;instead&nbsp;of&nbsp;silently&nbsp;executing&nbsp;the&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734782">//&nbsp;or&nbsp;stack&nbsp;copy&nbsp;incorrectly&nbsp;and&nbsp;setting&nbsp;up&nbsp;for&nbsp;a&nbsp;mysterious&nbsp;crash&nbsp;later.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734857">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734861">//&nbsp;Note&nbsp;that&nbsp;panic&nbsp;!=&nbsp;nil&nbsp;is&nbsp;okay&nbsp;here:&nbsp;there&nbsp;can&nbsp;be&nbsp;leftover&nbsp;panics,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1734932">//&nbsp;because&nbsp;the&nbsp;defers&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;do&nbsp;not&nbsp;nest&nbsp;in&nbsp;frame&nbsp;order&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735004">//&nbsp;they&nbsp;do&nbsp;on&nbsp;the&nbsp;defer&nbsp;stack.&nbsp;If&nbsp;you&nbsp;have:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735049">//</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735053">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;1&nbsp;defers&nbsp;d1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735075">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;2&nbsp;defers&nbsp;d2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735097">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;3&nbsp;defers&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735119">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735138">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;4&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735180">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5,&nbsp;running&nbsp;d3,&nbsp;defers&nbsp;d4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735215">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&nbsp;panics</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735234">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;5&#39;s&nbsp;panic&nbsp;starts&nbsp;running&nbsp;defers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735276">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d4,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735318">//&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;6,&nbsp;running&nbsp;d2,&nbsp;garbage&nbsp;collects</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735360">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735364">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d4,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d4&nbsp;-&gt;&nbsp;d3,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735431">//&nbsp;is&nbsp;nested&nbsp;properly,&nbsp;and&nbsp;we&#39;ll&nbsp;treat&nbsp;frame&nbsp;3&nbsp;as&nbsp;resumable,&nbsp;because&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735504">//&nbsp;can&nbsp;find&nbsp;d3.&nbsp;(And&nbsp;in&nbsp;fact&nbsp;frame&nbsp;3&nbsp;is&nbsp;resumable.&nbsp;If&nbsp;d4&nbsp;recovers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735571">//&nbsp;and&nbsp;frame&nbsp;5&nbsp;continues&nbsp;running,&nbsp;d3,&nbsp;d3&nbsp;can&nbsp;recover&nbsp;and&nbsp;we&#39;ll</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735635">//&nbsp;resume&nbsp;execution&nbsp;in&nbsp;(returning&nbsp;from)&nbsp;frame&nbsp;3.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735686">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735690">//&nbsp;During&nbsp;the&nbsp;execution&nbsp;of&nbsp;d2,&nbsp;however,&nbsp;the&nbsp;panic&nbsp;stack&nbsp;is&nbsp;d2&nbsp;-&gt;&nbsp;d3,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735760">//&nbsp;which&nbsp;is&nbsp;inverted.&nbsp;The&nbsp;scan&nbsp;will&nbsp;match&nbsp;d2&nbsp;to&nbsp;frame&nbsp;2&nbsp;but&nbsp;having</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735828">//&nbsp;d2&nbsp;on&nbsp;the&nbsp;stack&nbsp;until&nbsp;then&nbsp;means&nbsp;it&nbsp;will&nbsp;not&nbsp;match&nbsp;d3&nbsp;to&nbsp;frame&nbsp;3.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735898">//&nbsp;This&nbsp;is&nbsp;okay:&nbsp;if&nbsp;we&#39;re&nbsp;running&nbsp;d2,&nbsp;then&nbsp;all&nbsp;the&nbsp;defers&nbsp;after&nbsp;d2&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1735971">//&nbsp;completed&nbsp;and&nbsp;their&nbsp;corresponding&nbsp;frames&nbsp;are&nbsp;dead.&nbsp;Not&nbsp;finding&nbsp;d3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736041">//&nbsp;for&nbsp;frame&nbsp;3&nbsp;means&nbsp;we&#39;ll&nbsp;set&nbsp;frame&nbsp;3&#39;s&nbsp;continpc&nbsp;==&nbsp;0,&nbsp;which&nbsp;is&nbsp;correct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736115">//&nbsp;(frame&nbsp;3&nbsp;is&nbsp;dead).&nbsp;At&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;walk&nbsp;the&nbsp;panic&nbsp;stack&nbsp;can&nbsp;thus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736186">//&nbsp;contain&nbsp;defers&nbsp;(d3&nbsp;in&nbsp;this&nbsp;case)&nbsp;for&nbsp;dead&nbsp;frames.&nbsp;The&nbsp;inversion&nbsp;here</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736259">//&nbsp;always&nbsp;indicates&nbsp;a&nbsp;dead&nbsp;frame,&nbsp;and&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;inversion&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736333">//&nbsp;scan&nbsp;is&nbsp;to&nbsp;hide&nbsp;those&nbsp;dead&nbsp;frames,&nbsp;so&nbsp;the&nbsp;scan&nbsp;is&nbsp;still&nbsp;okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736399">//&nbsp;what&#39;s&nbsp;left&nbsp;on&nbsp;the&nbsp;panic&nbsp;stack&nbsp;are&nbsp;exactly&nbsp;(and&nbsp;only)&nbsp;the&nbsp;dead&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736474">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736478">//&nbsp;We&nbsp;require&nbsp;callback&nbsp;!=&nbsp;nil&nbsp;here&nbsp;because&nbsp;only&nbsp;when&nbsp;callback&nbsp;!=&nbsp;nil</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736548">//&nbsp;do&nbsp;we&nbsp;know&nbsp;that&nbsp;gentraceback&nbsp;is&nbsp;being&nbsp;called&nbsp;in&nbsp;a&nbsp;&#34;must&nbsp;be&nbsp;correct&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736620">//&nbsp;context&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;&#34;best&nbsp;effort&#34;&nbsp;context.&nbsp;The&nbsp;tracebacks&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736691">//&nbsp;callbacks&nbsp;only&nbsp;happen&nbsp;when&nbsp;everything&nbsp;is&nbsp;stopped&nbsp;nicely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736752">//&nbsp;At&nbsp;other&nbsp;times,&nbsp;such&nbsp;as&nbsp;when&nbsp;gathering&nbsp;a&nbsp;stack&nbsp;for&nbsp;a&nbsp;profiling&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736826">//&nbsp;or&nbsp;when&nbsp;printing&nbsp;a&nbsp;traceback&nbsp;during&nbsp;a&nbsp;crash,&nbsp;everything&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736897">//&nbsp;stopped&nbsp;nicely,&nbsp;and&nbsp;the&nbsp;stack&nbsp;walk&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;complete.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1736965">//&nbsp;It&#39;s&nbsp;okay&nbsp;in&nbsp;those&nbsp;situations&nbsp;not&nbsp;to&nbsp;use&nbsp;up&nbsp;the&nbsp;entire&nbsp;defer&nbsp;stack:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1737037">//&nbsp;incomplete&nbsp;information&nbsp;then&nbsp;is&nbsp;still&nbsp;better&nbsp;than&nbsp;nothing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737099">if</span>&nbsp;<span class="ident" id="1737102">callback</span>&nbsp;<span class="op" id="1737111">!=</span>&nbsp;<span class="builtintype" id="1737114">nil</span>&nbsp;<span class="op" id="1737118">&amp;&amp;</span>&nbsp;<span class="ident" id="1737121">n</span>&nbsp;<span class="op" id="1737123">&lt;</span>&nbsp;<span class="ident" id="1737125">max</span>&nbsp;<span class="op" id="1737129">&amp;&amp;</span>&nbsp;<span class="ident" id="1737132">_defer</span>&nbsp;<span class="op" id="1737139">!=</span>&nbsp;<span class="builtintype" id="1737142">nil</span>&nbsp;<span class="op" id="1737146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737150">if</span>&nbsp;<span class="ident" id="1737153">_defer</span>&nbsp;<span class="op" id="1737160">!=</span>&nbsp;<span class="builtintype" id="1737163">nil</span>&nbsp;<span class="op" id="1737167">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1737172">print</span><span class="op" id="1737177">(</span><span class="string" id="1737178">&#34;runtime:&nbsp;g&#34;</span><span class="op" id="1737190">,</span>&nbsp;<span class="ident" id="1737192">gp</span><span class="op" id="1737194">.</span><span class="ident" id="1737195">goid</span><span class="op" id="1737199">,</span>&nbsp;<span class="string" id="1737201">&#34;:&nbsp;leftover&nbsp;defer&nbsp;argp=&#34;</span><span class="op" id="1737225">,</span>&nbsp;<span class="ident" id="1737227">hex</span><span class="op" id="1737230">(</span><span class="ident" id="1737231">_defer</span><span class="op" id="1737237">.</span><span class="ident" id="1737238">argp</span><span class="op" id="1737242">)</span><span class="op" id="1737243">,</span>&nbsp;<span class="string" id="1737245">&#34;&nbsp;pc=&#34;</span><span class="op" id="1737251">,</span>&nbsp;<span class="ident" id="1737253">hex</span><span class="op" id="1737256">(</span><span class="ident" id="1737257">_defer</span><span class="op" id="1737263">.</span><span class="ident" id="1737264">pc</span><span class="op" id="1737266">)</span><span class="op" id="1737267">,</span>&nbsp;<span class="string" id="1737269">&#34;\n&#34;</span><span class="op" id="1737273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1737277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737281">for</span>&nbsp;<span class="ident" id="1737285">_defer</span>&nbsp;<span class="op" id="1737292">=</span>&nbsp;<span class="ident" id="1737294">gp</span><span class="op" id="1737296">.</span><span class="ident" id="1737297">_defer</span><span class="op" id="1737303">;</span>&nbsp;<span class="ident" id="1737305">_defer</span>&nbsp;<span class="op" id="1737312">!=</span>&nbsp;<span class="builtintype" id="1737315">nil</span><span class="op" id="1737318">;</span>&nbsp;<span class="ident" id="1737320">_defer</span>&nbsp;<span class="op" id="1737327">=</span>&nbsp;<span class="ident" id="1737329">_defer</span><span class="op" id="1737335">.</span><span class="ident" id="1737336">link</span>&nbsp;<span class="op" id="1737341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1737346">print</span><span class="op" id="1737351">(</span><span class="string" id="1737352">&#34;\tdefer&nbsp;&#34;</span><span class="op" id="1737362">,</span>&nbsp;<span class="ident" id="1737364">_defer</span><span class="op" id="1737370">,</span>&nbsp;<span class="string" id="1737372">&#34;&nbsp;argp=&#34;</span><span class="op" id="1737380">,</span>&nbsp;<span class="ident" id="1737382">hex</span><span class="op" id="1737385">(</span><span class="ident" id="1737386">_defer</span><span class="op" id="1737392">.</span><span class="ident" id="1737393">argp</span><span class="op" id="1737397">)</span><span class="op" id="1737398">,</span>&nbsp;<span class="string" id="1737400">&#34;&nbsp;pc=&#34;</span><span class="op" id="1737406">,</span>&nbsp;<span class="ident" id="1737408">hex</span><span class="op" id="1737411">(</span><span class="ident" id="1737412">_defer</span><span class="op" id="1737418">.</span><span class="ident" id="1737419">pc</span><span class="op" id="1737421">)</span><span class="op" id="1737422">,</span>&nbsp;<span class="string" id="1737424">&#34;\n&#34;</span><span class="op" id="1737428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1737432">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737436">gothrow</span><span class="op" id="1737443">(</span><span class="string" id="1737444">&#34;traceback&nbsp;has&nbsp;leftover&nbsp;defers&#34;</span><span class="op" id="1737475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1737478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737482">return</span>&nbsp;<span class="ident" id="1737489">n</span><br>
<span class="lineno"></span><span class="op" id="1737491">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1737494">func</span>&nbsp;<span class="ident" id="1737499">setArgInfo</span><span class="op" id="1737509">(</span><span class="ident" id="1737510">frame</span>&nbsp;<span class="op" id="1737516">*</span><span class="ident" id="1737517">stkframe</span><span class="op" id="1737525">,</span>&nbsp;<span class="ident" id="1737527">f</span>&nbsp;<span class="op" id="1737529">*</span><span class="ident" id="1737530">_func</span><span class="op" id="1737535">,</span>&nbsp;<span class="ident" id="1737537">needArgMap</span>&nbsp;<span class="builtintype" id="1737548">bool</span><span class="op" id="1737552">)</span>&nbsp;<span class="op" id="1737554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737557">frame</span><span class="op" id="1737562">.</span><span class="ident" id="1737563">arglen</span>&nbsp;<span class="op" id="1737570">=</span>&nbsp;<span class="builtintype" id="1737572">uintptr</span><span class="op" id="1737579">(</span><span class="ident" id="1737580">f</span><span class="op" id="1737581">.</span><span class="ident" id="1737582">args</span><span class="op" id="1737586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737589">if</span>&nbsp;<span class="ident" id="1737592">needArgMap</span>&nbsp;<span class="op" id="1737603">&amp;&amp;</span>&nbsp;<span class="ident" id="1737606">f</span><span class="op" id="1737607">.</span><span class="ident" id="1737608">args</span>&nbsp;<span class="op" id="1737613">==</span>&nbsp;<span class="ident" id="1737616">_ArgsSizeUnknown</span>&nbsp;<span class="op" id="1737633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1737637">//&nbsp;Extract&nbsp;argument&nbsp;bitmaps&nbsp;for&nbsp;reflect&nbsp;stubs&nbsp;from&nbsp;the&nbsp;calls&nbsp;they&nbsp;made&nbsp;to&nbsp;reflect.</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737722">switch</span>&nbsp;<span class="ident" id="1737729">gofuncname</span><span class="op" id="1737739">(</span><span class="ident" id="1737740">f</span><span class="op" id="1737741">)</span>&nbsp;<span class="op" id="1737743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737747">case</span>&nbsp;<span class="string" id="1737752">&#34;reflect.makeFuncStub&#34;</span><span class="op" id="1737774">,</span>&nbsp;<span class="string" id="1737776">&#34;reflect.methodValueCall&#34;</span><span class="op" id="1737801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737806">arg0</span>&nbsp;<span class="op" id="1737811">:=</span>&nbsp;<span class="ident" id="1737814">frame</span><span class="op" id="1737819">.</span><span class="ident" id="1737820">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737826">if</span>&nbsp;<span class="ident" id="1737829">usesLR</span>&nbsp;<span class="op" id="1737836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737842">arg0</span>&nbsp;<span class="op" id="1737847">+=</span>&nbsp;<span class="ident" id="1737850">ptrSize</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1737861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737866">fn</span>&nbsp;<span class="op" id="1737869">:=</span>&nbsp;<span class="op" id="1737872">*</span><span class="op" id="1737873">(</span><span class="op" id="1737874">*</span><span class="op" id="1737875">*</span><span class="op" id="1737876">[</span><span class="num" id="1737877">2</span><span class="op" id="1737878">]</span><span class="builtintype" id="1737879">uintptr</span><span class="op" id="1737886">)</span><span class="op" id="1737887">(</span><span class="ident" id="1737888">unsafe</span><span class="op" id="1737894">.</span><span class="ident" id="1737895">Pointer</span><span class="op" id="1737902">(</span><span class="ident" id="1737903">arg0</span><span class="op" id="1737907">)</span><span class="op" id="1737908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1737913">if</span>&nbsp;<span class="ident" id="1737916">fn</span><span class="op" id="1737918">[</span><span class="num" id="1737919">0</span><span class="op" id="1737920">]</span>&nbsp;<span class="op" id="1737922">!=</span>&nbsp;<span class="ident" id="1737925">f</span><span class="op" id="1737926">.</span><span class="ident" id="1737927">entry</span>&nbsp;<span class="op" id="1737933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1737939">print</span><span class="op" id="1737944">(</span><span class="string" id="1737945">&#34;runtime:&nbsp;confused&nbsp;by&nbsp;&#34;</span><span class="op" id="1737968">,</span>&nbsp;<span class="ident" id="1737970">gofuncname</span><span class="op" id="1737980">(</span><span class="ident" id="1737981">f</span><span class="op" id="1737982">)</span><span class="op" id="1737983">,</span>&nbsp;<span class="string" id="1737985">&#34;\n&#34;</span><span class="op" id="1737989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1737995">gothrow</span><span class="op" id="1738002">(</span><span class="string" id="1738003">&#34;reflect&nbsp;mismatch&#34;</span><span class="op" id="1738021">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738031">bv</span>&nbsp;<span class="op" id="1738034">:=</span>&nbsp;<span class="op" id="1738037">(</span><span class="op" id="1738038">*</span><span class="ident" id="1738039">bitvector</span><span class="op" id="1738048">)</span><span class="op" id="1738049">(</span><span class="ident" id="1738050">unsafe</span><span class="op" id="1738056">.</span><span class="ident" id="1738057">Pointer</span><span class="op" id="1738064">(</span><span class="ident" id="1738065">fn</span><span class="op" id="1738067">[</span><span class="num" id="1738068">1</span><span class="op" id="1738069">]</span><span class="op" id="1738070">)</span><span class="op" id="1738071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738076">frame</span><span class="op" id="1738081">.</span><span class="ident" id="1738082">arglen</span>&nbsp;<span class="op" id="1738089">=</span>&nbsp;<span class="builtintype" id="1738091">uintptr</span><span class="op" id="1738098">(</span><span class="ident" id="1738099">bv</span><span class="op" id="1738101">.</span><span class="ident" id="1738102">n</span>&nbsp;<span class="op" id="1738104">/</span>&nbsp;<span class="num" id="1738106">2</span>&nbsp;<span class="op" id="1738108">*</span>&nbsp;<span class="ident" id="1738110">ptrSize</span><span class="op" id="1738117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738122">frame</span><span class="op" id="1738127">.</span><span class="ident" id="1738128">argmap</span>&nbsp;<span class="op" id="1738135">=</span>&nbsp;<span class="ident" id="1738137">bv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738142">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738145">}</span><br>
<span class="lineno"></span><span class="op" id="1738147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1738150">func</span>&nbsp;<span class="ident" id="1738155">printcreatedby</span><span class="op" id="1738169">(</span><span class="ident" id="1738170">gp</span>&nbsp;<span class="op" id="1738173">*</span><span class="ident" id="1738174">g</span><span class="op" id="1738175">)</span>&nbsp;<span class="op" id="1738177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1738180">//&nbsp;Show&nbsp;what&nbsp;created&nbsp;goroutine,&nbsp;except&nbsp;main&nbsp;goroutine&nbsp;(goid&nbsp;1).</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738245">pc</span>&nbsp;<span class="op" id="1738248">:=</span>&nbsp;<span class="ident" id="1738251">gp</span><span class="op" id="1738253">.</span><span class="ident" id="1738254">gopc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738260">f</span>&nbsp;<span class="op" id="1738262">:=</span>&nbsp;<span class="ident" id="1738265">findfunc</span><span class="op" id="1738273">(</span><span class="ident" id="1738274">pc</span><span class="op" id="1738276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1738279">if</span>&nbsp;<span class="ident" id="1738282">f</span>&nbsp;<span class="op" id="1738284">!=</span>&nbsp;<span class="builtintype" id="1738287">nil</span>&nbsp;<span class="op" id="1738291">&amp;&amp;</span>&nbsp;<span class="ident" id="1738294">showframe</span><span class="op" id="1738303">(</span><span class="ident" id="1738304">f</span><span class="op" id="1738305">,</span>&nbsp;<span class="ident" id="1738307">gp</span><span class="op" id="1738309">)</span>&nbsp;<span class="op" id="1738311">&amp;&amp;</span>&nbsp;<span class="ident" id="1738314">gp</span><span class="op" id="1738316">.</span><span class="ident" id="1738317">goid</span>&nbsp;<span class="op" id="1738322">!=</span>&nbsp;<span class="num" id="1738325">1</span>&nbsp;<span class="op" id="1738327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1738331">print</span><span class="op" id="1738336">(</span><span class="string" id="1738337">&#34;created&nbsp;by&nbsp;&#34;</span><span class="op" id="1738350">,</span>&nbsp;<span class="ident" id="1738352">gofuncname</span><span class="op" id="1738362">(</span><span class="ident" id="1738363">f</span><span class="op" id="1738364">)</span><span class="op" id="1738365">,</span>&nbsp;<span class="string" id="1738367">&#34;\n&#34;</span><span class="op" id="1738371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738375">tracepc</span>&nbsp;<span class="op" id="1738383">:=</span>&nbsp;<span class="ident" id="1738386">pc</span>&nbsp;<span class="comment" id="1738389">//&nbsp;back&nbsp;up&nbsp;to&nbsp;CALL&nbsp;instruction&nbsp;for&nbsp;funcline.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1738436">if</span>&nbsp;<span class="ident" id="1738439">pc</span>&nbsp;<span class="op" id="1738442">&gt;</span>&nbsp;<span class="ident" id="1738444">f</span><span class="op" id="1738445">.</span><span class="ident" id="1738446">entry</span>&nbsp;<span class="op" id="1738452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738457">tracepc</span>&nbsp;<span class="op" id="1738465">-=</span>&nbsp;<span class="ident" id="1738468">_PCQuantum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1738485">var</span>&nbsp;<span class="ident" id="1738489">file</span>&nbsp;<span class="builtintype" id="1738494">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738503">line</span>&nbsp;<span class="op" id="1738508">:=</span>&nbsp;<span class="ident" id="1738511">funcline</span><span class="op" id="1738519">(</span><span class="ident" id="1738520">f</span><span class="op" id="1738521">,</span>&nbsp;<span class="ident" id="1738523">tracepc</span><span class="op" id="1738530">,</span>&nbsp;<span class="op" id="1738532">&amp;</span><span class="ident" id="1738533">file</span><span class="op" id="1738537">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1738541">print</span><span class="op" id="1738546">(</span><span class="string" id="1738547">&#34;\t&#34;</span><span class="op" id="1738551">,</span>&nbsp;<span class="ident" id="1738553">file</span><span class="op" id="1738557">,</span>&nbsp;<span class="string" id="1738559">&#34;:&#34;</span><span class="op" id="1738562">,</span>&nbsp;<span class="ident" id="1738564">line</span><span class="op" id="1738568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1738572">if</span>&nbsp;<span class="ident" id="1738575">pc</span>&nbsp;<span class="op" id="1738578">&gt;</span>&nbsp;<span class="ident" id="1738580">f</span><span class="op" id="1738581">.</span><span class="ident" id="1738582">entry</span>&nbsp;<span class="op" id="1738588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1738593">print</span><span class="op" id="1738598">(</span><span class="string" id="1738599">&#34;&nbsp;+&#34;</span><span class="op" id="1738603">,</span>&nbsp;<span class="ident" id="1738605">hex</span><span class="op" id="1738608">(</span><span class="ident" id="1738609">pc</span><span class="op" id="1738611">-</span><span class="ident" id="1738612">f</span><span class="op" id="1738613">.</span><span class="ident" id="1738614">entry</span><span class="op" id="1738619">)</span><span class="op" id="1738620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1738628">print</span><span class="op" id="1738633">(</span><span class="string" id="1738634">&#34;\n&#34;</span><span class="op" id="1738638">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1738641">}</span><br>
<span class="lineno"></span><span class="op" id="1738643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1738646">func</span>&nbsp;<span class="ident" id="1738651">traceback</span><span class="op" id="1738660">(</span><span class="ident" id="1738661">pc</span>&nbsp;<span class="builtintype" id="1738664">uintptr</span><span class="op" id="1738671">,</span>&nbsp;<span class="ident" id="1738673">sp</span>&nbsp;<span class="builtintype" id="1738676">uintptr</span><span class="op" id="1738683">,</span>&nbsp;<span class="ident" id="1738685">lr</span>&nbsp;<span class="builtintype" id="1738688">uintptr</span><span class="op" id="1738695">,</span>&nbsp;<span class="ident" id="1738697">gp</span>&nbsp;<span class="op" id="1738700">*</span><span class="ident" id="1738701">g</span><span class="op" id="1738702">)</span>&nbsp;<span class="op" id="1738704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1738707">traceback1</span><span class="op" id="1738717">(</span><span class="ident" id="1738718">pc</span><span class="op" id="1738720">,</span>&nbsp;<span class="ident" id="1738722">sp</span><span class="op" id="1738724">,</span>&nbsp;<span class="ident" id="1738726">lr</span><span class="op" id="1738728">,</span>&nbsp;<span class="ident" id="1738730">gp</span><span class="op" id="1738732">,</span>&nbsp;<span class="num" id="1738734">0</span><span class="op" id="1738735">)</span><br>
<span class="lineno">495</span><span class="op" id="1738737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1738740">//&nbsp;tracebacktrap&nbsp;is&nbsp;like&nbsp;traceback&nbsp;but&nbsp;expects&nbsp;that&nbsp;the&nbsp;PC&nbsp;and&nbsp;SP&nbsp;were&nbsp;obtained</span><br>
<span class="lineno"></span><span class="comment" id="1738820">//&nbsp;from&nbsp;a&nbsp;trap,&nbsp;not&nbsp;from&nbsp;gp-&gt;sched&nbsp;or&nbsp;gp-&gt;syscallpc/gp-&gt;syscallsp&nbsp;or&nbsp;getcallerpc/getcallersp.</span><br>
<span class="lineno"></span><span class="comment" id="1738914">//&nbsp;Because&nbsp;they&nbsp;are&nbsp;from&nbsp;a&nbsp;trap&nbsp;instead&nbsp;of&nbsp;from&nbsp;a&nbsp;saved&nbsp;pair,</span><br>
<span class="lineno">500</span><span class="comment" id="1738976">//&nbsp;the&nbsp;initial&nbsp;PC&nbsp;must&nbsp;not&nbsp;be&nbsp;rewound&nbsp;to&nbsp;the&nbsp;previous&nbsp;instruction.</span><br>
<span class="lineno"></span><span class="comment" id="1739043">//&nbsp;(All&nbsp;the&nbsp;saved&nbsp;pairs&nbsp;record&nbsp;a&nbsp;PC&nbsp;that&nbsp;is&nbsp;a&nbsp;return&nbsp;address,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="1739111">//&nbsp;rewind&nbsp;it&nbsp;into&nbsp;the&nbsp;CALL&nbsp;instruction.)</span><br>
<span class="lineno"></span><span class="keyword" id="1739152">func</span>&nbsp;<span class="ident" id="1739157">tracebacktrap</span><span class="op" id="1739170">(</span><span class="ident" id="1739171">pc</span>&nbsp;<span class="builtintype" id="1739174">uintptr</span><span class="op" id="1739181">,</span>&nbsp;<span class="ident" id="1739183">sp</span>&nbsp;<span class="builtintype" id="1739186">uintptr</span><span class="op" id="1739193">,</span>&nbsp;<span class="ident" id="1739195">lr</span>&nbsp;<span class="builtintype" id="1739198">uintptr</span><span class="op" id="1739205">,</span>&nbsp;<span class="ident" id="1739207">gp</span>&nbsp;<span class="op" id="1739210">*</span><span class="ident" id="1739211">g</span><span class="op" id="1739212">)</span>&nbsp;<span class="op" id="1739214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739217">traceback1</span><span class="op" id="1739227">(</span><span class="ident" id="1739228">pc</span><span class="op" id="1739230">,</span>&nbsp;<span class="ident" id="1739232">sp</span><span class="op" id="1739234">,</span>&nbsp;<span class="ident" id="1739236">lr</span><span class="op" id="1739238">,</span>&nbsp;<span class="ident" id="1739240">gp</span><span class="op" id="1739242">,</span>&nbsp;<span class="ident" id="1739244">_TraceTrap</span><span class="op" id="1739254">)</span><br>
<span class="lineno">505</span><span class="op" id="1739256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1739259">func</span>&nbsp;<span class="ident" id="1739264">traceback1</span><span class="op" id="1739274">(</span><span class="ident" id="1739275">pc</span>&nbsp;<span class="builtintype" id="1739278">uintptr</span><span class="op" id="1739285">,</span>&nbsp;<span class="ident" id="1739287">sp</span>&nbsp;<span class="builtintype" id="1739290">uintptr</span><span class="op" id="1739297">,</span>&nbsp;<span class="ident" id="1739299">lr</span>&nbsp;<span class="builtintype" id="1739302">uintptr</span><span class="op" id="1739309">,</span>&nbsp;<span class="ident" id="1739311">gp</span>&nbsp;<span class="op" id="1739314">*</span><span class="ident" id="1739315">g</span><span class="op" id="1739316">,</span>&nbsp;<span class="ident" id="1739318">flags</span>&nbsp;<span class="builtintype" id="1739324">uint</span><span class="op" id="1739328">)</span>&nbsp;<span class="op" id="1739330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1739333">var</span>&nbsp;<span class="ident" id="1739337">n</span>&nbsp;<span class="builtintype" id="1739339">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1739344">if</span>&nbsp;<span class="ident" id="1739347">readgstatus</span><span class="op" id="1739358">(</span><span class="ident" id="1739359">gp</span><span class="op" id="1739361">)</span><span class="op" id="1739362">&amp;^</span><span class="ident" id="1739364">_Gscan</span>&nbsp;<span class="op" id="1739371">==</span>&nbsp;<span class="ident" id="1739374">_Gsyscall</span>&nbsp;<span class="op" id="1739384">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1739388">//&nbsp;Override&nbsp;registers&nbsp;if&nbsp;blocked&nbsp;in&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739439">pc</span>&nbsp;<span class="op" id="1739442">=</span>&nbsp;<span class="ident" id="1739444">gp</span><span class="op" id="1739446">.</span><span class="ident" id="1739447">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739459">sp</span>&nbsp;<span class="op" id="1739462">=</span>&nbsp;<span class="ident" id="1739464">gp</span><span class="op" id="1739466">.</span><span class="ident" id="1739467">syscallsp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739479">flags</span>&nbsp;<span class="op" id="1739485">&amp;^=</span>&nbsp;<span class="ident" id="1739489">_TraceTrap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1739501">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1739504">//&nbsp;Print&nbsp;traceback.&nbsp;By&nbsp;default,&nbsp;omits&nbsp;runtime&nbsp;frames.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1739559">//&nbsp;If&nbsp;that&nbsp;means&nbsp;we&nbsp;print&nbsp;nothing&nbsp;at&nbsp;all,&nbsp;repeat&nbsp;forcing&nbsp;all&nbsp;frames&nbsp;printed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739637">n</span>&nbsp;<span class="op" id="1739639">=</span>&nbsp;<span class="ident" id="1739641">gentraceback</span><span class="op" id="1739653">(</span><span class="ident" id="1739654">pc</span><span class="op" id="1739656">,</span>&nbsp;<span class="ident" id="1739658">sp</span><span class="op" id="1739660">,</span>&nbsp;<span class="ident" id="1739662">lr</span><span class="op" id="1739664">,</span>&nbsp;<span class="ident" id="1739666">gp</span><span class="op" id="1739668">,</span>&nbsp;<span class="num" id="1739670">0</span><span class="op" id="1739671">,</span>&nbsp;<span class="builtintype" id="1739673">nil</span><span class="op" id="1739676">,</span>&nbsp;<span class="ident" id="1739678">_TracebackMaxFrames</span><span class="op" id="1739697">,</span>&nbsp;<span class="builtintype" id="1739699">nil</span><span class="op" id="1739702">,</span>&nbsp;<span class="builtintype" id="1739704">nil</span><span class="op" id="1739707">,</span>&nbsp;<span class="ident" id="1739709">flags</span><span class="op" id="1739714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1739717">if</span>&nbsp;<span class="ident" id="1739720">n</span>&nbsp;<span class="op" id="1739722">==</span>&nbsp;<span class="num" id="1739725">0</span>&nbsp;<span class="op" id="1739727">&amp;&amp;</span>&nbsp;<span class="op" id="1739730">(</span><span class="ident" id="1739731">flags</span><span class="op" id="1739736">&amp;</span><span class="ident" id="1739737">_TraceRuntimeFrames</span><span class="op" id="1739756">)</span>&nbsp;<span class="op" id="1739758">==</span>&nbsp;<span class="num" id="1739761">0</span>&nbsp;<span class="op" id="1739763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739767">n</span>&nbsp;<span class="op" id="1739769">=</span>&nbsp;<span class="ident" id="1739771">gentraceback</span><span class="op" id="1739783">(</span><span class="ident" id="1739784">pc</span><span class="op" id="1739786">,</span>&nbsp;<span class="ident" id="1739788">sp</span><span class="op" id="1739790">,</span>&nbsp;<span class="ident" id="1739792">lr</span><span class="op" id="1739794">,</span>&nbsp;<span class="ident" id="1739796">gp</span><span class="op" id="1739798">,</span>&nbsp;<span class="num" id="1739800">0</span><span class="op" id="1739801">,</span>&nbsp;<span class="builtintype" id="1739803">nil</span><span class="op" id="1739806">,</span>&nbsp;<span class="ident" id="1739808">_TracebackMaxFrames</span><span class="op" id="1739827">,</span>&nbsp;<span class="builtintype" id="1739829">nil</span><span class="op" id="1739832">,</span>&nbsp;<span class="builtintype" id="1739834">nil</span><span class="op" id="1739837">,</span>&nbsp;<span class="ident" id="1739839">flags</span><span class="op" id="1739844">|</span><span class="ident" id="1739845">_TraceRuntimeFrames</span><span class="op" id="1739864">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1739867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1739870">if</span>&nbsp;<span class="ident" id="1739873">n</span>&nbsp;<span class="op" id="1739875">==</span>&nbsp;<span class="ident" id="1739878">_TracebackMaxFrames</span>&nbsp;<span class="op" id="1739898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1739902">print</span><span class="op" id="1739907">(</span><span class="string" id="1739908">&#34;...additional&nbsp;frames&nbsp;elided...\n&#34;</span><span class="op" id="1739942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1739945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1739948">printcreatedby</span><span class="op" id="1739962">(</span><span class="ident" id="1739963">gp</span><span class="op" id="1739965">)</span><br>
<span class="lineno">525</span><span class="op" id="1739967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1739970">func</span>&nbsp;<span class="ident" id="1739975">callers</span><span class="op" id="1739982">(</span><span class="ident" id="1739983">skip</span>&nbsp;<span class="builtintype" id="1739988">int</span><span class="op" id="1739991">,</span>&nbsp;<span class="ident" id="1739993">pcbuf</span>&nbsp;<span class="op" id="1739999">*</span><span class="builtintype" id="1740000">uintptr</span><span class="op" id="1740007">,</span>&nbsp;<span class="ident" id="1740009">m</span>&nbsp;<span class="builtintype" id="1740011">int</span><span class="op" id="1740014">)</span>&nbsp;<span class="builtintype" id="1740016">int</span>&nbsp;<span class="op" id="1740020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740023">sp</span>&nbsp;<span class="op" id="1740026">:=</span>&nbsp;<span class="ident" id="1740029">getcallersp</span><span class="op" id="1740040">(</span><span class="ident" id="1740041">unsafe</span><span class="op" id="1740047">.</span><span class="ident" id="1740048">Pointer</span><span class="op" id="1740055">(</span><span class="op" id="1740056">&amp;</span><span class="ident" id="1740057">skip</span><span class="op" id="1740061">)</span><span class="op" id="1740062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740065">pc</span>&nbsp;<span class="op" id="1740068">:=</span>&nbsp;<span class="builtintype" id="1740071">uintptr</span><span class="op" id="1740078">(</span><span class="ident" id="1740079">getcallerpc</span><span class="op" id="1740090">(</span><span class="ident" id="1740091">unsafe</span><span class="op" id="1740097">.</span><span class="ident" id="1740098">Pointer</span><span class="op" id="1740105">(</span><span class="op" id="1740106">&amp;</span><span class="ident" id="1740107">skip</span><span class="op" id="1740111">)</span><span class="op" id="1740112">)</span><span class="op" id="1740113">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740116">var</span>&nbsp;<span class="ident" id="1740120">n</span>&nbsp;<span class="builtintype" id="1740122">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740127">onM</span><span class="op" id="1740130">(</span><span class="keyword" id="1740131">func</span><span class="op" id="1740135">(</span><span class="op" id="1740136">)</span>&nbsp;<span class="op" id="1740138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740142">n</span>&nbsp;<span class="op" id="1740144">=</span>&nbsp;<span class="ident" id="1740146">gentraceback</span><span class="op" id="1740158">(</span><span class="ident" id="1740159">pc</span><span class="op" id="1740161">,</span>&nbsp;<span class="ident" id="1740163">sp</span><span class="op" id="1740165">,</span>&nbsp;<span class="num" id="1740167">0</span><span class="op" id="1740168">,</span>&nbsp;<span class="ident" id="1740170">getg</span><span class="op" id="1740174">(</span><span class="op" id="1740175">)</span><span class="op" id="1740176">,</span>&nbsp;<span class="ident" id="1740178">skip</span><span class="op" id="1740182">,</span>&nbsp;<span class="ident" id="1740184">pcbuf</span><span class="op" id="1740189">,</span>&nbsp;<span class="ident" id="1740191">m</span><span class="op" id="1740192">,</span>&nbsp;<span class="builtintype" id="1740194">nil</span><span class="op" id="1740197">,</span>&nbsp;<span class="builtintype" id="1740199">nil</span><span class="op" id="1740202">,</span>&nbsp;<span class="num" id="1740204">0</span><span class="op" id="1740205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1740208">}</span><span class="op" id="1740209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740212">return</span>&nbsp;<span class="ident" id="1740219">n</span><br>
<span class="lineno">535</span><span class="op" id="1740221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1740224">func</span>&nbsp;<span class="ident" id="1740229">gcallers</span><span class="op" id="1740237">(</span><span class="ident" id="1740238">gp</span>&nbsp;<span class="op" id="1740241">*</span><span class="ident" id="1740242">g</span><span class="op" id="1740243">,</span>&nbsp;<span class="ident" id="1740245">skip</span>&nbsp;<span class="builtintype" id="1740250">int</span><span class="op" id="1740253">,</span>&nbsp;<span class="ident" id="1740255">pcbuf</span>&nbsp;<span class="op" id="1740261">*</span><span class="builtintype" id="1740262">uintptr</span><span class="op" id="1740269">,</span>&nbsp;<span class="ident" id="1740271">m</span>&nbsp;<span class="builtintype" id="1740273">int</span><span class="op" id="1740276">)</span>&nbsp;<span class="builtintype" id="1740278">int</span>&nbsp;<span class="op" id="1740282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740285">return</span>&nbsp;<span class="ident" id="1740292">gentraceback</span><span class="op" id="1740304">(</span><span class="op" id="1740305">^</span><span class="builtintype" id="1740306">uintptr</span><span class="op" id="1740313">(</span><span class="num" id="1740314">0</span><span class="op" id="1740315">)</span><span class="op" id="1740316">,</span>&nbsp;<span class="op" id="1740318">^</span><span class="builtintype" id="1740319">uintptr</span><span class="op" id="1740326">(</span><span class="num" id="1740327">0</span><span class="op" id="1740328">)</span><span class="op" id="1740329">,</span>&nbsp;<span class="num" id="1740331">0</span><span class="op" id="1740332">,</span>&nbsp;<span class="ident" id="1740334">gp</span><span class="op" id="1740336">,</span>&nbsp;<span class="ident" id="1740338">skip</span><span class="op" id="1740342">,</span>&nbsp;<span class="ident" id="1740344">pcbuf</span><span class="op" id="1740349">,</span>&nbsp;<span class="ident" id="1740351">m</span><span class="op" id="1740352">,</span>&nbsp;<span class="builtintype" id="1740354">nil</span><span class="op" id="1740357">,</span>&nbsp;<span class="builtintype" id="1740359">nil</span><span class="op" id="1740362">,</span>&nbsp;<span class="num" id="1740364">0</span><span class="op" id="1740365">)</span><br>
<span class="lineno"></span><span class="op" id="1740367">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="1740370">func</span>&nbsp;<span class="ident" id="1740375">showframe</span><span class="op" id="1740384">(</span><span class="ident" id="1740385">f</span>&nbsp;<span class="op" id="1740387">*</span><span class="ident" id="1740388">_func</span><span class="op" id="1740393">,</span>&nbsp;<span class="ident" id="1740395">gp</span>&nbsp;<span class="op" id="1740398">*</span><span class="ident" id="1740399">g</span><span class="op" id="1740400">)</span>&nbsp;<span class="builtintype" id="1740402">bool</span>&nbsp;<span class="op" id="1740407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740410">g</span>&nbsp;<span class="op" id="1740412">:=</span>&nbsp;<span class="ident" id="1740415">getg</span><span class="op" id="1740419">(</span><span class="op" id="1740420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740423">if</span>&nbsp;<span class="ident" id="1740426">g</span><span class="op" id="1740427">.</span><span class="ident" id="1740428">m</span><span class="op" id="1740429">.</span><span class="ident" id="1740430">throwing</span>&nbsp;<span class="op" id="1740439">&gt;</span>&nbsp;<span class="num" id="1740441">0</span>&nbsp;<span class="op" id="1740443">&amp;&amp;</span>&nbsp;<span class="ident" id="1740446">gp</span>&nbsp;<span class="op" id="1740449">!=</span>&nbsp;<span class="builtintype" id="1740452">nil</span>&nbsp;<span class="op" id="1740456">&amp;&amp;</span>&nbsp;<span class="op" id="1740459">(</span><span class="ident" id="1740460">gp</span>&nbsp;<span class="op" id="1740463">==</span>&nbsp;<span class="ident" id="1740466">g</span><span class="op" id="1740467">.</span><span class="ident" id="1740468">m</span><span class="op" id="1740469">.</span><span class="ident" id="1740470">curg</span>&nbsp;<span class="op" id="1740475">||</span>&nbsp;<span class="ident" id="1740478">gp</span>&nbsp;<span class="op" id="1740481">==</span>&nbsp;<span class="ident" id="1740484">g</span><span class="op" id="1740485">.</span><span class="ident" id="1740486">m</span><span class="op" id="1740487">.</span><span class="ident" id="1740488">caughtsig</span><span class="op" id="1740497">)</span>&nbsp;<span class="op" id="1740499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740503">return</span>&nbsp;<span class="builtintype" id="1740510">true</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1740516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740519">traceback</span>&nbsp;<span class="op" id="1740529">:=</span>&nbsp;<span class="ident" id="1740532">gotraceback</span><span class="op" id="1740543">(</span><span class="builtintype" id="1740544">nil</span><span class="op" id="1740547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1740550">name</span>&nbsp;<span class="op" id="1740555">:=</span>&nbsp;<span class="ident" id="1740558">gostringnocopy</span><span class="op" id="1740572">(</span><span class="ident" id="1740573">funcname</span><span class="op" id="1740581">(</span><span class="ident" id="1740582">f</span><span class="op" id="1740583">)</span><span class="op" id="1740584">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1740588">//&nbsp;Special&nbsp;case:&nbsp;always&nbsp;show&nbsp;runtime.panic&nbsp;frame,&nbsp;so&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1740654">//&nbsp;see&nbsp;where&nbsp;a&nbsp;panic&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1740716">//&nbsp;See&nbsp;golang.org/issue/5832.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740747">if</span>&nbsp;<span class="ident" id="1740750">name</span>&nbsp;<span class="op" id="1740755">==</span>&nbsp;<span class="string" id="1740758">&#34;runtime.panic&#34;</span>&nbsp;<span class="op" id="1740774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740778">return</span>&nbsp;<span class="builtintype" id="1740785">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1740791">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1740795">return</span>&nbsp;<span class="ident" id="1740802">traceback</span>&nbsp;<span class="op" id="1740812">&gt;</span>&nbsp;<span class="num" id="1740814">1</span>&nbsp;<span class="op" id="1740816">||</span>&nbsp;<span class="ident" id="1740819">f</span>&nbsp;<span class="op" id="1740821">!=</span>&nbsp;<span class="builtintype" id="1740824">nil</span>&nbsp;<span class="op" id="1740828">&amp;&amp;</span>&nbsp;<span class="ident" id="1740831">contains</span><span class="op" id="1740839">(</span><span class="ident" id="1740840">name</span><span class="op" id="1740844">,</span>&nbsp;<span class="string" id="1740846">&#34;.&#34;</span><span class="op" id="1740849">)</span>&nbsp;<span class="op" id="1740851">&amp;&amp;</span>&nbsp;<span class="op" id="1740854">(</span><span class="op" id="1740855">!</span><span class="ident" id="1740856">hasprefix</span><span class="op" id="1740865">(</span><span class="ident" id="1740866">name</span><span class="op" id="1740870">,</span>&nbsp;<span class="string" id="1740872">&#34;runtime.&#34;</span><span class="op" id="1740882">)</span>&nbsp;<span class="op" id="1740884">||</span>&nbsp;<span class="ident" id="1740887">isExportedRuntime</span><span class="op" id="1740904">(</span><span class="ident" id="1740905">name</span><span class="op" id="1740909">)</span><span class="op" id="1740910">)</span><br>
<span class="lineno"></span><span class="op" id="1740912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1740915">//&nbsp;isExportedRuntime&nbsp;reports&nbsp;whether&nbsp;name&nbsp;is&nbsp;an&nbsp;exported&nbsp;runtime&nbsp;function.</span><br>
<span class="lineno">560</span><span class="comment" id="1740990">//&nbsp;It&nbsp;is&nbsp;only&nbsp;for&nbsp;runtime&nbsp;functions,&nbsp;so&nbsp;ASCII&nbsp;A-Z&nbsp;is&nbsp;fine.</span><br>
<span class="lineno"></span><span class="keyword" id="1741049">func</span>&nbsp;<span class="ident" id="1741054">isExportedRuntime</span><span class="op" id="1741071">(</span><span class="ident" id="1741072">name</span>&nbsp;<span class="builtintype" id="1741077">string</span><span class="op" id="1741083">)</span>&nbsp;<span class="builtintype" id="1741085">bool</span>&nbsp;<span class="op" id="1741090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1741093">const</span>&nbsp;<span class="ident" id="1741099">n</span>&nbsp;<span class="op" id="1741101">=</span>&nbsp;<span class="builtinfunc" id="1741103">len</span><span class="op" id="1741106">(</span><span class="string" id="1741107">&#34;runtime.&#34;</span><span class="op" id="1741117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1741120">return</span>&nbsp;<span class="builtinfunc" id="1741127">len</span><span class="op" id="1741130">(</span><span class="ident" id="1741131">name</span><span class="op" id="1741135">)</span>&nbsp;<span class="op" id="1741137">&gt;</span>&nbsp;<span class="ident" id="1741139">n</span>&nbsp;<span class="op" id="1741141">&amp;&amp;</span>&nbsp;<span class="ident" id="1741144">name</span><span class="op" id="1741148">[</span><span class="op" id="1741149">:</span><span class="ident" id="1741150">n</span><span class="op" id="1741151">]</span>&nbsp;<span class="op" id="1741153">==</span>&nbsp;<span class="string" id="1741156">&#34;runtime.&#34;</span>&nbsp;<span class="op" id="1741167">&amp;&amp;</span>&nbsp;<span class="string" id="1741170">&#39;A&#39;</span>&nbsp;<span class="op" id="1741174">&lt;=</span>&nbsp;<span class="ident" id="1741177">name</span><span class="op" id="1741181">[</span><span class="ident" id="1741182">n</span><span class="op" id="1741183">]</span>&nbsp;<span class="op" id="1741185">&amp;&amp;</span>&nbsp;<span class="ident" id="1741188">name</span><span class="op" id="1741192">[</span><span class="ident" id="1741193">n</span><span class="op" id="1741194">]</span>&nbsp;<span class="op" id="1741196">&lt;=</span>&nbsp;<span class="string" id="1741199">&#39;Z&#39;</span><br>
<span class="lineno"></span><span class="op" id="1741203">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1741206">var</span>&nbsp;<span class="ident" id="1741210">gStatusStrings</span>&nbsp;<span class="op" id="1741225">=</span>&nbsp;<span class="op" id="1741227">[</span><span class="op" id="1741228">...</span><span class="op" id="1741231">]</span><span class="builtintype" id="1741232">string</span><span class="op" id="1741238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741241">_Gidle</span><span class="op" id="1741247">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1741254">&#34;idle&#34;</span><span class="op" id="1741260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741263">_Grunnable</span><span class="op" id="1741273">:</span>&nbsp;&nbsp;<span class="string" id="1741276">&#34;runnable&#34;</span><span class="op" id="1741286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741289">_Grunning</span><span class="op" id="1741298">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1741302">&#34;running&#34;</span><span class="op" id="1741311">,</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741314">_Gsyscall</span><span class="op" id="1741323">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1741327">&#34;syscall&#34;</span><span class="op" id="1741336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741339">_Gwaiting</span><span class="op" id="1741348">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1741352">&#34;waiting&#34;</span><span class="op" id="1741361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741364">_Gdead</span><span class="op" id="1741370">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1741377">&#34;dead&#34;</span><span class="op" id="1741383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741386">_Genqueue</span><span class="op" id="1741395">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="1741399">&#34;enqueue&#34;</span><span class="op" id="1741408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741411">_Gcopystack</span><span class="op" id="1741422">:</span>&nbsp;<span class="string" id="1741424">&#34;copystack&#34;</span><span class="op" id="1741435">,</span><br>
<span class="lineno">575</span><span class="op" id="1741437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1741440">var</span>&nbsp;<span class="ident" id="1741444">gScanStatusStrings</span>&nbsp;<span class="op" id="1741463">=</span>&nbsp;<span class="op" id="1741465">[</span><span class="op" id="1741466">...</span><span class="op" id="1741469">]</span><span class="builtintype" id="1741470">string</span><span class="op" id="1741476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="1741479">0</span><span class="op" id="1741480">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1741491">&#34;scan&#34;</span><span class="op" id="1741497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741500">_Grunnable</span><span class="op" id="1741510">:</span>&nbsp;<span class="string" id="1741512">&#34;scanrunnable&#34;</span><span class="op" id="1741526">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741529">_Grunning</span><span class="op" id="1741538">:</span>&nbsp;&nbsp;<span class="string" id="1741541">&#34;scanrunning&#34;</span><span class="op" id="1741554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741557">_Gsyscall</span><span class="op" id="1741566">:</span>&nbsp;&nbsp;<span class="string" id="1741569">&#34;scansyscall&#34;</span><span class="op" id="1741582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741585">_Gwaiting</span><span class="op" id="1741594">:</span>&nbsp;&nbsp;<span class="string" id="1741597">&#34;scanwaiting&#34;</span><span class="op" id="1741610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741613">_Gdead</span><span class="op" id="1741619">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1741625">&#34;scandead&#34;</span><span class="op" id="1741635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741638">_Genqueue</span><span class="op" id="1741647">:</span>&nbsp;&nbsp;<span class="string" id="1741650">&#34;scanenqueue&#34;</span><span class="op" id="1741663">,</span><br>
<span class="lineno">585</span><span class="op" id="1741665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1741668">func</span>&nbsp;<span class="ident" id="1741673">goroutineheader</span><span class="op" id="1741688">(</span><span class="ident" id="1741689">gp</span>&nbsp;<span class="op" id="1741692">*</span><span class="ident" id="1741693">g</span><span class="op" id="1741694">)</span>&nbsp;<span class="op" id="1741696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741699">gpstatus</span>&nbsp;<span class="op" id="1741708">:=</span>&nbsp;<span class="ident" id="1741711">readgstatus</span><span class="op" id="1741722">(</span><span class="ident" id="1741723">gp</span><span class="op" id="1741725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1741729">//&nbsp;Basic&nbsp;string&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1741753">var</span>&nbsp;<span class="ident" id="1741757">status</span>&nbsp;<span class="builtintype" id="1741764">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1741772">if</span>&nbsp;<span class="num" id="1741775">0</span>&nbsp;<span class="op" id="1741777">&lt;=</span>&nbsp;<span class="ident" id="1741780">gpstatus</span>&nbsp;<span class="op" id="1741789">&amp;&amp;</span>&nbsp;<span class="ident" id="1741792">gpstatus</span>&nbsp;<span class="op" id="1741801">&lt;</span>&nbsp;<span class="builtintype" id="1741803">uint32</span><span class="op" id="1741809">(</span><span class="builtinfunc" id="1741810">len</span><span class="op" id="1741813">(</span><span class="ident" id="1741814">gStatusStrings</span><span class="op" id="1741828">)</span><span class="op" id="1741829">)</span>&nbsp;<span class="op" id="1741831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741835">status</span>&nbsp;<span class="op" id="1741842">=</span>&nbsp;<span class="ident" id="1741844">gStatusStrings</span><span class="op" id="1741858">[</span><span class="ident" id="1741859">gpstatus</span><span class="op" id="1741867">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1741870">}</span>&nbsp;<span class="keyword" id="1741872">else</span>&nbsp;<span class="keyword" id="1741877">if</span>&nbsp;<span class="ident" id="1741880">gpstatus</span><span class="op" id="1741888">&amp;</span><span class="ident" id="1741889">_Gscan</span>&nbsp;<span class="op" id="1741896">!=</span>&nbsp;<span class="num" id="1741899">0</span>&nbsp;<span class="op" id="1741901">&amp;&amp;</span>&nbsp;<span class="num" id="1741904">0</span>&nbsp;<span class="op" id="1741906">&lt;=</span>&nbsp;<span class="ident" id="1741909">gpstatus</span><span class="op" id="1741917">&amp;^</span><span class="ident" id="1741919">_Gscan</span>&nbsp;<span class="op" id="1741926">&amp;&amp;</span>&nbsp;<span class="ident" id="1741929">gpstatus</span><span class="op" id="1741937">&amp;^</span><span class="ident" id="1741939">_Gscan</span>&nbsp;<span class="op" id="1741946">&lt;</span>&nbsp;<span class="builtintype" id="1741948">uint32</span><span class="op" id="1741954">(</span><span class="builtinfunc" id="1741955">len</span><span class="op" id="1741958">(</span><span class="ident" id="1741959">gStatusStrings</span><span class="op" id="1741973">)</span><span class="op" id="1741974">)</span>&nbsp;<span class="op" id="1741976">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1741980">status</span>&nbsp;<span class="op" id="1741987">=</span>&nbsp;<span class="ident" id="1741989">gStatusStrings</span><span class="op" id="1742003">[</span><span class="ident" id="1742004">gpstatus</span><span class="op" id="1742012">&amp;^</span><span class="ident" id="1742014">_Gscan</span><span class="op" id="1742020">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742023">}</span>&nbsp;<span class="keyword" id="1742025">else</span>&nbsp;<span class="op" id="1742030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742034">status</span>&nbsp;<span class="op" id="1742041">=</span>&nbsp;<span class="string" id="1742043">&#34;???&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1742054">//&nbsp;Override.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742068">if</span>&nbsp;<span class="op" id="1742071">(</span><span class="ident" id="1742072">gpstatus</span>&nbsp;<span class="op" id="1742081">==</span>&nbsp;<span class="ident" id="1742084">_Gwaiting</span>&nbsp;<span class="op" id="1742094">||</span>&nbsp;<span class="ident" id="1742097">gpstatus</span>&nbsp;<span class="op" id="1742106">==</span>&nbsp;<span class="ident" id="1742109">_Gscanwaiting</span><span class="op" id="1742122">)</span>&nbsp;<span class="op" id="1742124">&amp;&amp;</span>&nbsp;<span class="ident" id="1742127">gp</span><span class="op" id="1742129">.</span><span class="ident" id="1742130">waitreason</span>&nbsp;<span class="op" id="1742141">!=</span>&nbsp;<span class="string" id="1742144">&#34;&#34;</span>&nbsp;<span class="op" id="1742147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742151">status</span>&nbsp;<span class="op" id="1742158">=</span>&nbsp;<span class="ident" id="1742160">gp</span><span class="op" id="1742162">.</span><span class="ident" id="1742163">waitreason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1742179">//&nbsp;approx&nbsp;time&nbsp;the&nbsp;G&nbsp;is&nbsp;blocked,&nbsp;in&nbsp;minutes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742224">var</span>&nbsp;<span class="ident" id="1742228">waitfor</span>&nbsp;<span class="ident" id="1742236">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742243">gpstatus</span>&nbsp;<span class="op" id="1742252">&amp;^=</span>&nbsp;<span class="ident" id="1742256">_Gscan</span>&nbsp;<span class="comment" id="1742263">//&nbsp;drop&nbsp;the&nbsp;scan&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742285">if</span>&nbsp;<span class="op" id="1742288">(</span><span class="ident" id="1742289">gpstatus</span>&nbsp;<span class="op" id="1742298">==</span>&nbsp;<span class="ident" id="1742301">_Gwaiting</span>&nbsp;<span class="op" id="1742311">||</span>&nbsp;<span class="ident" id="1742314">gpstatus</span>&nbsp;<span class="op" id="1742323">==</span>&nbsp;<span class="ident" id="1742326">_Gsyscall</span><span class="op" id="1742335">)</span>&nbsp;<span class="op" id="1742337">&amp;&amp;</span>&nbsp;<span class="ident" id="1742340">gp</span><span class="op" id="1742342">.</span><span class="ident" id="1742343">waitsince</span>&nbsp;<span class="op" id="1742353">!=</span>&nbsp;<span class="num" id="1742356">0</span>&nbsp;<span class="op" id="1742358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742362">waitfor</span>&nbsp;<span class="op" id="1742370">=</span>&nbsp;<span class="op" id="1742372">(</span><span class="ident" id="1742373">nanotime</span><span class="op" id="1742381">(</span><span class="op" id="1742382">)</span>&nbsp;<span class="op" id="1742384">-</span>&nbsp;<span class="ident" id="1742386">gp</span><span class="op" id="1742388">.</span><span class="ident" id="1742389">waitsince</span><span class="op" id="1742398">)</span>&nbsp;<span class="op" id="1742400">/</span>&nbsp;<span class="num" id="1742402">60e9</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1742411">print</span><span class="op" id="1742416">(</span><span class="string" id="1742417">&#34;goroutine&nbsp;&#34;</span><span class="op" id="1742429">,</span>&nbsp;<span class="ident" id="1742431">gp</span><span class="op" id="1742433">.</span><span class="ident" id="1742434">goid</span><span class="op" id="1742438">,</span>&nbsp;<span class="string" id="1742440">&#34;&nbsp;[&#34;</span><span class="op" id="1742444">,</span>&nbsp;<span class="ident" id="1742446">status</span><span class="op" id="1742452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742455">if</span>&nbsp;<span class="ident" id="1742458">waitfor</span>&nbsp;<span class="op" id="1742466">&gt;=</span>&nbsp;<span class="num" id="1742469">1</span>&nbsp;<span class="op" id="1742471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1742475">print</span><span class="op" id="1742480">(</span><span class="string" id="1742481">&#34;,&nbsp;&#34;</span><span class="op" id="1742485">,</span>&nbsp;<span class="ident" id="1742487">waitfor</span><span class="op" id="1742494">,</span>&nbsp;<span class="string" id="1742496">&#34;&nbsp;minutes&#34;</span><span class="op" id="1742506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742509">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742512">if</span>&nbsp;<span class="ident" id="1742515">gp</span><span class="op" id="1742517">.</span><span class="ident" id="1742518">lockedm</span>&nbsp;<span class="op" id="1742526">!=</span>&nbsp;<span class="builtintype" id="1742529">nil</span>&nbsp;<span class="op" id="1742533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1742537">print</span><span class="op" id="1742542">(</span><span class="string" id="1742543">&#34;,&nbsp;locked&nbsp;to&nbsp;thread&#34;</span><span class="op" id="1742563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1742569">print</span><span class="op" id="1742574">(</span><span class="string" id="1742575">&#34;]:\n&#34;</span><span class="op" id="1742581">)</span><br>
<span class="lineno"></span><span class="op" id="1742583">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="1742586">func</span>&nbsp;<span class="ident" id="1742591">tracebackothers</span><span class="op" id="1742606">(</span><span class="ident" id="1742607">me</span>&nbsp;<span class="op" id="1742610">*</span><span class="ident" id="1742611">g</span><span class="op" id="1742612">)</span>&nbsp;<span class="op" id="1742614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742617">level</span>&nbsp;<span class="op" id="1742623">:=</span>&nbsp;<span class="ident" id="1742626">gotraceback</span><span class="op" id="1742637">(</span><span class="builtintype" id="1742638">nil</span><span class="op" id="1742641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1742645">//&nbsp;Show&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;first,&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742706">g</span>&nbsp;<span class="op" id="1742708">:=</span>&nbsp;<span class="ident" id="1742711">getg</span><span class="op" id="1742715">(</span><span class="op" id="1742716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742719">gp</span>&nbsp;<span class="op" id="1742722">:=</span>&nbsp;<span class="ident" id="1742725">g</span><span class="op" id="1742726">.</span><span class="ident" id="1742727">m</span><span class="op" id="1742728">.</span><span class="ident" id="1742729">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742735">if</span>&nbsp;<span class="ident" id="1742738">gp</span>&nbsp;<span class="op" id="1742741">!=</span>&nbsp;<span class="builtintype" id="1742744">nil</span>&nbsp;<span class="op" id="1742748">&amp;&amp;</span>&nbsp;<span class="ident" id="1742751">gp</span>&nbsp;<span class="op" id="1742754">!=</span>&nbsp;<span class="ident" id="1742757">me</span>&nbsp;<span class="op" id="1742760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1742764">print</span><span class="op" id="1742769">(</span><span class="string" id="1742770">&#34;\n&#34;</span><span class="op" id="1742774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742778">goroutineheader</span><span class="op" id="1742793">(</span><span class="ident" id="1742794">gp</span><span class="op" id="1742796">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742800">traceback</span><span class="op" id="1742809">(</span><span class="op" id="1742810">^</span><span class="builtintype" id="1742811">uintptr</span><span class="op" id="1742818">(</span><span class="num" id="1742819">0</span><span class="op" id="1742820">)</span><span class="op" id="1742821">,</span>&nbsp;<span class="op" id="1742823">^</span><span class="builtintype" id="1742824">uintptr</span><span class="op" id="1742831">(</span><span class="num" id="1742832">0</span><span class="op" id="1742833">)</span><span class="op" id="1742834">,</span>&nbsp;<span class="num" id="1742836">0</span><span class="op" id="1742837">,</span>&nbsp;<span class="ident" id="1742839">gp</span><span class="op" id="1742841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1742848">lock</span><span class="op" id="1742852">(</span><span class="op" id="1742853">&amp;</span><span class="ident" id="1742854">allglock</span><span class="op" id="1742862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742865">for</span>&nbsp;<span class="ident" id="1742869">_</span><span class="op" id="1742870">,</span>&nbsp;<span class="ident" id="1742872">gp</span>&nbsp;<span class="op" id="1742875">:=</span>&nbsp;<span class="keyword" id="1742878">range</span>&nbsp;<span class="ident" id="1742884">allgs</span>&nbsp;<span class="op" id="1742890">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742894">if</span>&nbsp;<span class="ident" id="1742897">gp</span>&nbsp;<span class="op" id="1742900">==</span>&nbsp;<span class="ident" id="1742903">me</span>&nbsp;<span class="op" id="1742906">||</span>&nbsp;<span class="ident" id="1742909">gp</span>&nbsp;<span class="op" id="1742912">==</span>&nbsp;<span class="ident" id="1742915">g</span><span class="op" id="1742916">.</span><span class="ident" id="1742917">m</span><span class="op" id="1742918">.</span><span class="ident" id="1742919">curg</span>&nbsp;<span class="op" id="1742924">||</span>&nbsp;<span class="ident" id="1742927">readgstatus</span><span class="op" id="1742938">(</span><span class="ident" id="1742939">gp</span><span class="op" id="1742941">)</span>&nbsp;<span class="op" id="1742943">==</span>&nbsp;<span class="ident" id="1742946">_Gdead</span>&nbsp;<span class="op" id="1742953">||</span>&nbsp;<span class="ident" id="1742956">gp</span><span class="op" id="1742958">.</span><span class="ident" id="1742959">issystem</span>&nbsp;<span class="op" id="1742968">&amp;&amp;</span>&nbsp;<span class="ident" id="1742971">level</span>&nbsp;<span class="op" id="1742977">&lt;</span>&nbsp;<span class="num" id="1742979">2</span>&nbsp;<span class="op" id="1742981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1742986">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1743001">print</span><span class="op" id="1743006">(</span><span class="string" id="1743007">&#34;\n&#34;</span><span class="op" id="1743011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743015">goroutineheader</span><span class="op" id="1743030">(</span><span class="ident" id="1743031">gp</span><span class="op" id="1743033">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1743037">if</span>&nbsp;<span class="ident" id="1743040">readgstatus</span><span class="op" id="1743051">(</span><span class="ident" id="1743052">gp</span><span class="op" id="1743054">)</span><span class="op" id="1743055">&amp;^</span><span class="ident" id="1743057">_Gscan</span>&nbsp;<span class="op" id="1743064">==</span>&nbsp;<span class="ident" id="1743067">_Grunning</span>&nbsp;<span class="op" id="1743077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1743082">print</span><span class="op" id="1743087">(</span><span class="string" id="1743088">&#34;\tgoroutine&nbsp;running&nbsp;on&nbsp;other&nbsp;thread;&nbsp;stack&nbsp;unavailable\n&#34;</span><span class="op" id="1743146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743151">printcreatedby</span><span class="op" id="1743165">(</span><span class="ident" id="1743166">gp</span><span class="op" id="1743168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1743172">}</span>&nbsp;<span class="keyword" id="1743174">else</span>&nbsp;<span class="op" id="1743179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743184">traceback</span><span class="op" id="1743193">(</span><span class="op" id="1743194">^</span><span class="builtintype" id="1743195">uintptr</span><span class="op" id="1743202">(</span><span class="num" id="1743203">0</span><span class="op" id="1743204">)</span><span class="op" id="1743205">,</span>&nbsp;<span class="op" id="1743207">^</span><span class="builtintype" id="1743208">uintptr</span><span class="op" id="1743215">(</span><span class="num" id="1743216">0</span><span class="op" id="1743217">)</span><span class="op" id="1743218">,</span>&nbsp;<span class="num" id="1743220">0</span><span class="op" id="1743221">,</span>&nbsp;<span class="ident" id="1743223">gp</span><span class="op" id="1743225">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1743229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1743232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743235">unlock</span><span class="op" id="1743241">(</span><span class="op" id="1743242">&amp;</span><span class="ident" id="1743243">allglock</span><span class="op" id="1743251">)</span><br>
<span class="lineno"></span><span class="op" id="1743253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="1743256">//&nbsp;Does&nbsp;f&nbsp;mark&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;goroutine&nbsp;stack?</span><br>
<span class="lineno"></span><span class="keyword" id="1743301">func</span>&nbsp;<span class="ident" id="1743306">topofstack</span><span class="op" id="1743316">(</span><span class="ident" id="1743317">f</span>&nbsp;<span class="op" id="1743319">*</span><span class="ident" id="1743320">_func</span><span class="op" id="1743325">)</span>&nbsp;<span class="builtintype" id="1743327">bool</span>&nbsp;<span class="op" id="1743332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743335">pc</span>&nbsp;<span class="op" id="1743338">:=</span>&nbsp;<span class="ident" id="1743341">f</span><span class="op" id="1743342">.</span><span class="ident" id="1743343">entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1743350">return</span>&nbsp;<span class="ident" id="1743357">pc</span>&nbsp;<span class="op" id="1743360">==</span>&nbsp;<span class="ident" id="1743363">goexitPC</span>&nbsp;<span class="op" id="1743372">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743377">pc</span>&nbsp;<span class="op" id="1743380">==</span>&nbsp;<span class="ident" id="1743383">mstartPC</span>&nbsp;<span class="op" id="1743392">||</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743397">pc</span>&nbsp;<span class="op" id="1743400">==</span>&nbsp;<span class="ident" id="1743403">mcallPC</span>&nbsp;<span class="op" id="1743411">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743416">pc</span>&nbsp;<span class="op" id="1743419">==</span>&nbsp;<span class="ident" id="1743422">morestackPC</span>&nbsp;<span class="op" id="1743434">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743439">pc</span>&nbsp;<span class="op" id="1743442">==</span>&nbsp;<span class="ident" id="1743445">rt0_goPC</span>&nbsp;<span class="op" id="1743454">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1743459">externalthreadhandlerp</span>&nbsp;<span class="op" id="1743482">!=</span>&nbsp;<span class="num" id="1743485">0</span>&nbsp;<span class="op" id="1743487">&amp;&amp;</span>&nbsp;<span class="ident" id="1743490">pc</span>&nbsp;<span class="op" id="1743493">==</span>&nbsp;<span class="ident" id="1743496">externalthreadhandlerp</span><br>
<span class="lineno"></span><span class="op" id="1743519">}</span>
</div>
</body>
</html>
