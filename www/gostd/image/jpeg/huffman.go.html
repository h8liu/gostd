<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5879020">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5879075">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5879129">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5879180">package</span>&nbsp;<span class="ident" id="5879188">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5879194">import</span>&nbsp;<span class="op" id="5879201">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5879204">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5879209">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5879212">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5879290">const</span>&nbsp;<span class="ident" id="5879296">maxCodeLength</span>&nbsp;<span class="op" id="5879310">=</span>&nbsp;<span class="num" id="5879312">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879316">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5879391">const</span>&nbsp;<span class="ident" id="5879397">maxNCodes</span>&nbsp;<span class="op" id="5879407">=</span>&nbsp;<span class="num" id="5879409">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5879414">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5879483">const</span>&nbsp;<span class="ident" id="5879489">lutSize</span>&nbsp;<span class="op" id="5879497">=</span>&nbsp;<span class="num" id="5879499">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5879502">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5879559">type</span>&nbsp;<span class="ident" id="5879564">huffman</span>&nbsp;<span class="keyword" id="5879572">struct</span>&nbsp;<span class="op" id="5879579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879582">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879629">nCodes</span>&nbsp;<span class="builtintype" id="5879636">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879643">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879717">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879789">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879862">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879880">lut</span>&nbsp;<span class="op" id="5879884">[</span><span class="num" id="5879885">1</span>&nbsp;<span class="op" id="5879887">&lt;&lt;</span>&nbsp;<span class="ident" id="5879890">lutSize</span><span class="op" id="5879897">]</span><span class="builtintype" id="5879898">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879906">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879965">vals</span>&nbsp;<span class="op" id="5879970">[</span><span class="ident" id="5879971">maxNCodes</span><span class="op" id="5879980">]</span><span class="builtintype" id="5879981">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5879988">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880059">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880085">minCodes</span>&nbsp;<span class="op" id="5880094">[</span><span class="ident" id="5880095">maxCodeLength</span><span class="op" id="5880108">]</span><span class="builtintype" id="5880109">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880116">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880187">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880213">maxCodes</span>&nbsp;<span class="op" id="5880222">[</span><span class="ident" id="5880223">maxCodeLength</span><span class="op" id="5880236">]</span><span class="builtintype" id="5880237">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880244">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880302">valsIndices</span>&nbsp;<span class="op" id="5880314">[</span><span class="ident" id="5880315">maxCodeLength</span><span class="op" id="5880328">]</span><span class="builtintype" id="5880329">int32</span><br>
<span class="lineno"></span><span class="op" id="5880335">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5880338">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5880414">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5880431">var</span>&nbsp;<span class="ident" id="5880435">errShortHuffmanData</span>&nbsp;<span class="op" id="5880455">=</span>&nbsp;<span class="ident" id="5880457">FormatError</span><span class="op" id="5880468">(</span><span class="string" id="5880469">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5880489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5880492">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5880570">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5880647">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5880722">func</span>&nbsp;<span class="op" id="5880727">(</span><span class="ident" id="5880728">d</span>&nbsp;<span class="op" id="5880730">*</span><span class="ident" id="5880731">decoder</span><span class="op" id="5880738">)</span>&nbsp;<span class="ident" id="5880740">ensureNBits</span><span class="op" id="5880751">(</span><span class="ident" id="5880752">n</span>&nbsp;<span class="builtintype" id="5880754">int32</span><span class="op" id="5880759">)</span>&nbsp;<span class="builtintype" id="5880761">error</span>&nbsp;<span class="op" id="5880767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880770">for</span>&nbsp;<span class="op" id="5880774">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880778">c</span><span class="op" id="5880779">,</span>&nbsp;<span class="ident" id="5880781">err</span>&nbsp;<span class="op" id="5880785">:=</span>&nbsp;<span class="ident" id="5880788">d</span><span class="op" id="5880789">.</span><span class="ident" id="5880790">readByteStuffedByte</span><span class="op" id="5880809">(</span><span class="op" id="5880810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880814">if</span>&nbsp;<span class="ident" id="5880817">err</span>&nbsp;<span class="op" id="5880821">!=</span>&nbsp;<span class="ident" id="5880824">nil</span>&nbsp;<span class="op" id="5880828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880833">if</span>&nbsp;<span class="ident" id="5880836">err</span>&nbsp;<span class="op" id="5880840">==</span>&nbsp;<span class="ident" id="5880843">io</span><span class="op" id="5880845">.</span><span class="ident" id="5880846">EOF</span>&nbsp;<span class="op" id="5880850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880856">return</span>&nbsp;<span class="ident" id="5880863">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880886">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880891">return</span>&nbsp;<span class="ident" id="5880898">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880908">d</span><span class="op" id="5880909">.</span><span class="ident" id="5880910">bits</span><span class="op" id="5880914">.</span><span class="ident" id="5880915">a</span>&nbsp;<span class="op" id="5880917">=</span>&nbsp;<span class="ident" id="5880919">d</span><span class="op" id="5880920">.</span><span class="ident" id="5880921">bits</span><span class="op" id="5880925">.</span><span class="ident" id="5880926">a</span><span class="op" id="5880927">&lt;&lt;</span><span class="num" id="5880929">8</span>&nbsp;<span class="op" id="5880931">|</span>&nbsp;<span class="builtintype" id="5880933">uint32</span><span class="op" id="5880939">(</span><span class="ident" id="5880940">c</span><span class="op" id="5880941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880945">d</span><span class="op" id="5880946">.</span><span class="ident" id="5880947">bits</span><span class="op" id="5880951">.</span><span class="ident" id="5880952">n</span>&nbsp;<span class="op" id="5880954">+=</span>&nbsp;<span class="num" id="5880957">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880961">if</span>&nbsp;<span class="ident" id="5880964">d</span><span class="op" id="5880965">.</span><span class="ident" id="5880966">bits</span><span class="op" id="5880970">.</span><span class="ident" id="5880971">m</span>&nbsp;<span class="op" id="5880973">==</span>&nbsp;<span class="num" id="5880976">0</span>&nbsp;<span class="op" id="5880978">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880983">d</span><span class="op" id="5880984">.</span><span class="ident" id="5880985">bits</span><span class="op" id="5880989">.</span><span class="ident" id="5880990">m</span>&nbsp;<span class="op" id="5880992">=</span>&nbsp;<span class="num" id="5880994">1</span>&nbsp;<span class="op" id="5880996">&lt;&lt;</span>&nbsp;<span class="num" id="5880999">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881003">}</span>&nbsp;<span class="keyword" id="5881005">else</span>&nbsp;<span class="op" id="5881010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881015">d</span><span class="op" id="5881016">.</span><span class="ident" id="5881017">bits</span><span class="op" id="5881021">.</span><span class="ident" id="5881022">m</span>&nbsp;<span class="op" id="5881024">&lt;&lt;=</span>&nbsp;<span class="num" id="5881028">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881036">if</span>&nbsp;<span class="ident" id="5881039">d</span><span class="op" id="5881040">.</span><span class="ident" id="5881041">bits</span><span class="op" id="5881045">.</span><span class="ident" id="5881046">n</span>&nbsp;<span class="op" id="5881048">&gt;=</span>&nbsp;<span class="ident" id="5881051">n</span>&nbsp;<span class="op" id="5881053">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881058">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881072">return</span>&nbsp;<span class="ident" id="5881079">nil</span><br>
<span class="lineno"></span><span class="op" id="5881083">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5881086">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5881166">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5881178">func</span>&nbsp;<span class="op" id="5881183">(</span><span class="ident" id="5881184">d</span>&nbsp;<span class="op" id="5881186">*</span><span class="ident" id="5881187">decoder</span><span class="op" id="5881194">)</span>&nbsp;<span class="ident" id="5881196">receiveExtend</span><span class="op" id="5881209">(</span><span class="ident" id="5881210">t</span>&nbsp;<span class="builtintype" id="5881212">uint8</span><span class="op" id="5881217">)</span>&nbsp;<span class="op" id="5881219">(</span><span class="builtintype" id="5881220">int32</span><span class="op" id="5881225">,</span>&nbsp;<span class="builtintype" id="5881227">error</span><span class="op" id="5881232">)</span>&nbsp;<span class="op" id="5881234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881237">if</span>&nbsp;<span class="ident" id="5881240">d</span><span class="op" id="5881241">.</span><span class="ident" id="5881242">bits</span><span class="op" id="5881246">.</span><span class="ident" id="5881247">n</span>&nbsp;<span class="op" id="5881249">&lt;</span>&nbsp;<span class="builtintype" id="5881251">int32</span><span class="op" id="5881256">(</span><span class="ident" id="5881257">t</span><span class="op" id="5881258">)</span>&nbsp;<span class="op" id="5881260">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881264">if</span>&nbsp;<span class="ident" id="5881267">err</span>&nbsp;<span class="op" id="5881271">:=</span>&nbsp;<span class="ident" id="5881274">d</span><span class="op" id="5881275">.</span><span class="ident" id="5881276">ensureNBits</span><span class="op" id="5881287">(</span><span class="builtintype" id="5881288">int32</span><span class="op" id="5881293">(</span><span class="ident" id="5881294">t</span><span class="op" id="5881295">)</span><span class="op" id="5881296">)</span><span class="op" id="5881297">;</span>&nbsp;<span class="ident" id="5881299">err</span>&nbsp;<span class="op" id="5881303">!=</span>&nbsp;<span class="ident" id="5881306">nil</span>&nbsp;<span class="op" id="5881310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881315">return</span>&nbsp;<span class="num" id="5881322">0</span><span class="op" id="5881323">,</span>&nbsp;<span class="ident" id="5881325">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881337">d</span><span class="op" id="5881338">.</span><span class="ident" id="5881339">bits</span><span class="op" id="5881343">.</span><span class="ident" id="5881344">n</span>&nbsp;<span class="op" id="5881346">-=</span>&nbsp;<span class="builtintype" id="5881349">int32</span><span class="op" id="5881354">(</span><span class="ident" id="5881355">t</span><span class="op" id="5881356">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881359">d</span><span class="op" id="5881360">.</span><span class="ident" id="5881361">bits</span><span class="op" id="5881365">.</span><span class="ident" id="5881366">m</span>&nbsp;<span class="op" id="5881368">&gt;&gt;=</span>&nbsp;<span class="ident" id="5881372">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881375">s</span>&nbsp;<span class="op" id="5881377">:=</span>&nbsp;<span class="builtintype" id="5881380">int32</span><span class="op" id="5881385">(</span><span class="num" id="5881386">1</span><span class="op" id="5881387">)</span>&nbsp;<span class="op" id="5881389">&lt;&lt;</span>&nbsp;<span class="ident" id="5881392">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881395">x</span>&nbsp;<span class="op" id="5881397">:=</span>&nbsp;<span class="builtintype" id="5881400">int32</span><span class="op" id="5881405">(</span><span class="ident" id="5881406">d</span><span class="op" id="5881407">.</span><span class="ident" id="5881408">bits</span><span class="op" id="5881412">.</span><span class="ident" id="5881413">a</span><span class="op" id="5881414">&gt;&gt;</span><span class="builtintype" id="5881416">uint8</span><span class="op" id="5881421">(</span><span class="ident" id="5881422">d</span><span class="op" id="5881423">.</span><span class="ident" id="5881424">bits</span><span class="op" id="5881428">.</span><span class="ident" id="5881429">n</span><span class="op" id="5881430">)</span><span class="op" id="5881431">)</span>&nbsp;<span class="op" id="5881433">&amp;</span>&nbsp;<span class="op" id="5881435">(</span><span class="ident" id="5881436">s</span>&nbsp;<span class="op" id="5881438">-</span>&nbsp;<span class="num" id="5881440">1</span><span class="op" id="5881441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881444">if</span>&nbsp;<span class="ident" id="5881447">x</span>&nbsp;<span class="op" id="5881449">&lt;</span>&nbsp;<span class="ident" id="5881451">s</span><span class="op" id="5881452">&gt;&gt;</span><span class="num" id="5881454">1</span>&nbsp;<span class="op" id="5881456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881460">x</span>&nbsp;<span class="op" id="5881462">+=</span>&nbsp;<span class="op" id="5881465">(</span><span class="op" id="5881466">(</span><span class="op" id="5881467">-</span><span class="num" id="5881468">1</span><span class="op" id="5881469">)</span>&nbsp;<span class="op" id="5881471">&lt;&lt;</span>&nbsp;<span class="ident" id="5881474">t</span><span class="op" id="5881475">)</span>&nbsp;<span class="op" id="5881477">+</span>&nbsp;<span class="num" id="5881479">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881485">return</span>&nbsp;<span class="ident" id="5881492">x</span><span class="op" id="5881493">,</span>&nbsp;<span class="ident" id="5881495">nil</span><br>
<span class="lineno"></span><span class="op" id="5881499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881502">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5881583">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5881642">func</span>&nbsp;<span class="op" id="5881647">(</span><span class="ident" id="5881648">d</span>&nbsp;<span class="op" id="5881650">*</span><span class="ident" id="5881651">decoder</span><span class="op" id="5881658">)</span>&nbsp;<span class="ident" id="5881660">processDHT</span><span class="op" id="5881670">(</span><span class="ident" id="5881671">n</span>&nbsp;<span class="builtintype" id="5881673">int</span><span class="op" id="5881676">)</span>&nbsp;<span class="builtintype" id="5881678">error</span>&nbsp;<span class="op" id="5881684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881687">for</span>&nbsp;<span class="ident" id="5881691">n</span>&nbsp;<span class="op" id="5881693">&gt;</span>&nbsp;<span class="num" id="5881695">0</span>&nbsp;<span class="op" id="5881697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881701">if</span>&nbsp;<span class="ident" id="5881704">n</span>&nbsp;<span class="op" id="5881706">&lt;</span>&nbsp;<span class="num" id="5881708">17</span>&nbsp;<span class="op" id="5881711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881716">return</span>&nbsp;<span class="ident" id="5881723">FormatError</span><span class="op" id="5881734">(</span><span class="string" id="5881735">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5881757">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881765">if</span>&nbsp;<span class="ident" id="5881768">err</span>&nbsp;<span class="op" id="5881772">:=</span>&nbsp;<span class="ident" id="5881775">d</span><span class="op" id="5881776">.</span><span class="ident" id="5881777">readFull</span><span class="op" id="5881785">(</span><span class="ident" id="5881786">d</span><span class="op" id="5881787">.</span><span class="ident" id="5881788">tmp</span><span class="op" id="5881791">[</span><span class="op" id="5881792">:</span><span class="num" id="5881793">17</span><span class="op" id="5881795">]</span><span class="op" id="5881796">)</span><span class="op" id="5881797">;</span>&nbsp;<span class="ident" id="5881799">err</span>&nbsp;<span class="op" id="5881803">!=</span>&nbsp;<span class="ident" id="5881806">nil</span>&nbsp;<span class="op" id="5881810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881815">return</span>&nbsp;<span class="ident" id="5881822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881832">tc</span>&nbsp;<span class="op" id="5881835">:=</span>&nbsp;<span class="ident" id="5881838">d</span><span class="op" id="5881839">.</span><span class="ident" id="5881840">tmp</span><span class="op" id="5881843">[</span><span class="num" id="5881844">0</span><span class="op" id="5881845">]</span>&nbsp;<span class="op" id="5881847">&gt;&gt;</span>&nbsp;<span class="num" id="5881850">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881854">if</span>&nbsp;<span class="ident" id="5881857">tc</span>&nbsp;<span class="op" id="5881860">&gt;</span>&nbsp;<span class="ident" id="5881862">maxTc</span>&nbsp;<span class="op" id="5881868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881873">return</span>&nbsp;<span class="ident" id="5881880">FormatError</span><span class="op" id="5881891">(</span><span class="string" id="5881892">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5881906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881914">th</span>&nbsp;<span class="op" id="5881917">:=</span>&nbsp;<span class="ident" id="5881920">d</span><span class="op" id="5881921">.</span><span class="ident" id="5881922">tmp</span><span class="op" id="5881925">[</span><span class="num" id="5881926">0</span><span class="op" id="5881927">]</span>&nbsp;<span class="op" id="5881929">&amp;</span>&nbsp;<span class="num" id="5881931">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881938">if</span>&nbsp;<span class="ident" id="5881941">th</span>&nbsp;<span class="op" id="5881944">&gt;</span>&nbsp;<span class="ident" id="5881946">maxTh</span>&nbsp;<span class="op" id="5881952">||</span>&nbsp;<span class="op" id="5881955">!</span><span class="ident" id="5881956">d</span><span class="op" id="5881957">.</span><span class="ident" id="5881958">progressive</span>&nbsp;<span class="op" id="5881970">&amp;&amp;</span>&nbsp;<span class="ident" id="5881973">th</span>&nbsp;<span class="op" id="5881976">&gt;</span>&nbsp;<span class="num" id="5881978">1</span>&nbsp;<span class="op" id="5881980">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881985">return</span>&nbsp;<span class="ident" id="5881992">FormatError</span><span class="op" id="5882003">(</span><span class="string" id="5882004">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5882018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882026">h</span>&nbsp;<span class="op" id="5882028">:=</span>&nbsp;<span class="op" id="5882031">&amp;</span><span class="ident" id="5882032">d</span><span class="op" id="5882033">.</span><span class="ident" id="5882034">huff</span><span class="op" id="5882038">[</span><span class="ident" id="5882039">tc</span><span class="op" id="5882041">]</span><span class="op" id="5882042">[</span><span class="ident" id="5882043">th</span><span class="op" id="5882045">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882050">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882101">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882159">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882203">h</span><span class="op" id="5882204">.</span><span class="ident" id="5882205">nCodes</span>&nbsp;<span class="op" id="5882212">=</span>&nbsp;<span class="num" id="5882214">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882218">var</span>&nbsp;<span class="ident" id="5882222">nCodes</span>&nbsp;<span class="op" id="5882229">[</span><span class="ident" id="5882230">maxCodeLength</span><span class="op" id="5882243">]</span><span class="builtintype" id="5882244">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882252">for</span>&nbsp;<span class="ident" id="5882256">i</span>&nbsp;<span class="op" id="5882258">:=</span>&nbsp;<span class="keyword" id="5882261">range</span>&nbsp;<span class="ident" id="5882267">nCodes</span>&nbsp;<span class="op" id="5882274">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882279">nCodes</span><span class="op" id="5882285">[</span><span class="ident" id="5882286">i</span><span class="op" id="5882287">]</span>&nbsp;<span class="op" id="5882289">=</span>&nbsp;<span class="builtintype" id="5882291">int32</span><span class="op" id="5882296">(</span><span class="ident" id="5882297">d</span><span class="op" id="5882298">.</span><span class="ident" id="5882299">tmp</span><span class="op" id="5882302">[</span><span class="ident" id="5882303">i</span><span class="op" id="5882304">+</span><span class="num" id="5882305">1</span><span class="op" id="5882306">]</span><span class="op" id="5882307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882312">h</span><span class="op" id="5882313">.</span><span class="ident" id="5882314">nCodes</span>&nbsp;<span class="op" id="5882321">+=</span>&nbsp;<span class="ident" id="5882324">nCodes</span><span class="op" id="5882330">[</span><span class="ident" id="5882331">i</span><span class="op" id="5882332">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882340">if</span>&nbsp;<span class="ident" id="5882343">h</span><span class="op" id="5882344">.</span><span class="ident" id="5882345">nCodes</span>&nbsp;<span class="op" id="5882352">==</span>&nbsp;<span class="num" id="5882355">0</span>&nbsp;<span class="op" id="5882357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882362">return</span>&nbsp;<span class="ident" id="5882369">FormatError</span><span class="op" id="5882380">(</span><span class="string" id="5882381">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5882412">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882420">if</span>&nbsp;<span class="ident" id="5882423">h</span><span class="op" id="5882424">.</span><span class="ident" id="5882425">nCodes</span>&nbsp;<span class="op" id="5882432">&gt;</span>&nbsp;<span class="ident" id="5882434">maxNCodes</span>&nbsp;<span class="op" id="5882444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882449">return</span>&nbsp;<span class="ident" id="5882456">FormatError</span><span class="op" id="5882467">(</span><span class="string" id="5882468">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5882504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882512">n</span>&nbsp;<span class="op" id="5882514">-=</span>&nbsp;<span class="builtintype" id="5882517">int</span><span class="op" id="5882520">(</span><span class="ident" id="5882521">h</span><span class="op" id="5882522">.</span><span class="ident" id="5882523">nCodes</span><span class="op" id="5882529">)</span>&nbsp;<span class="op" id="5882531">+</span>&nbsp;<span class="num" id="5882533">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882538">if</span>&nbsp;<span class="ident" id="5882541">n</span>&nbsp;<span class="op" id="5882543">&lt;</span>&nbsp;<span class="num" id="5882545">0</span>&nbsp;<span class="op" id="5882547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882552">return</span>&nbsp;<span class="ident" id="5882559">FormatError</span><span class="op" id="5882570">(</span><span class="string" id="5882571">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5882593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882601">if</span>&nbsp;<span class="ident" id="5882604">err</span>&nbsp;<span class="op" id="5882608">:=</span>&nbsp;<span class="ident" id="5882611">d</span><span class="op" id="5882612">.</span><span class="ident" id="5882613">readFull</span><span class="op" id="5882621">(</span><span class="ident" id="5882622">h</span><span class="op" id="5882623">.</span><span class="ident" id="5882624">vals</span><span class="op" id="5882628">[</span><span class="op" id="5882629">:</span><span class="ident" id="5882630">h</span><span class="op" id="5882631">.</span><span class="ident" id="5882632">nCodes</span><span class="op" id="5882638">]</span><span class="op" id="5882639">)</span><span class="op" id="5882640">;</span>&nbsp;<span class="ident" id="5882642">err</span>&nbsp;<span class="op" id="5882646">!=</span>&nbsp;<span class="ident" id="5882649">nil</span>&nbsp;<span class="op" id="5882653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882658">return</span>&nbsp;<span class="ident" id="5882665">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882676">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882707">for</span>&nbsp;<span class="ident" id="5882711">i</span>&nbsp;<span class="op" id="5882713">:=</span>&nbsp;<span class="keyword" id="5882716">range</span>&nbsp;<span class="ident" id="5882722">h</span><span class="op" id="5882723">.</span><span class="ident" id="5882724">lut</span>&nbsp;<span class="op" id="5882728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882733">h</span><span class="op" id="5882734">.</span><span class="ident" id="5882735">lut</span><span class="op" id="5882738">[</span><span class="ident" id="5882739">i</span><span class="op" id="5882740">]</span>&nbsp;<span class="op" id="5882742">=</span>&nbsp;<span class="num" id="5882744">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882752">var</span>&nbsp;<span class="ident" id="5882756">x</span><span class="op" id="5882757">,</span>&nbsp;<span class="ident" id="5882759">code</span>&nbsp;<span class="builtintype" id="5882764">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882773">for</span>&nbsp;<span class="ident" id="5882777">i</span>&nbsp;<span class="op" id="5882779">:=</span>&nbsp;<span class="builtintype" id="5882782">uint32</span><span class="op" id="5882788">(</span><span class="num" id="5882789">0</span><span class="op" id="5882790">)</span><span class="op" id="5882791">;</span>&nbsp;<span class="ident" id="5882793">i</span>&nbsp;<span class="op" id="5882795">&lt;</span>&nbsp;<span class="ident" id="5882797">lutSize</span><span class="op" id="5882804">;</span>&nbsp;<span class="ident" id="5882806">i</span><span class="op" id="5882807">++</span>&nbsp;<span class="op" id="5882810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882815">code</span>&nbsp;<span class="op" id="5882820">&lt;&lt;=</span>&nbsp;<span class="num" id="5882824">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882829">for</span>&nbsp;<span class="ident" id="5882833">j</span>&nbsp;<span class="op" id="5882835">:=</span>&nbsp;<span class="builtintype" id="5882838">int32</span><span class="op" id="5882843">(</span><span class="num" id="5882844">0</span><span class="op" id="5882845">)</span><span class="op" id="5882846">;</span>&nbsp;<span class="ident" id="5882848">j</span>&nbsp;<span class="op" id="5882850">&lt;</span>&nbsp;<span class="ident" id="5882852">nCodes</span><span class="op" id="5882858">[</span><span class="ident" id="5882859">i</span><span class="op" id="5882860">]</span><span class="op" id="5882861">;</span>&nbsp;<span class="ident" id="5882863">j</span><span class="op" id="5882864">++</span>&nbsp;<span class="op" id="5882867">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882873">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882931">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5882987">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883037">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883095">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883144">base</span>&nbsp;<span class="op" id="5883149">:=</span>&nbsp;<span class="builtintype" id="5883152">uint8</span><span class="op" id="5883157">(</span><span class="ident" id="5883158">code</span>&nbsp;<span class="op" id="5883163">&lt;&lt;</span>&nbsp;<span class="op" id="5883166">(</span><span class="num" id="5883167">7</span>&nbsp;<span class="op" id="5883169">-</span>&nbsp;<span class="ident" id="5883171">i</span><span class="op" id="5883172">)</span><span class="op" id="5883173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883179">lutValue</span>&nbsp;<span class="op" id="5883188">:=</span>&nbsp;<span class="builtintype" id="5883191">uint16</span><span class="op" id="5883197">(</span><span class="ident" id="5883198">h</span><span class="op" id="5883199">.</span><span class="ident" id="5883200">vals</span><span class="op" id="5883204">[</span><span class="ident" id="5883205">x</span><span class="op" id="5883206">]</span><span class="op" id="5883207">)</span><span class="op" id="5883208">&lt;&lt;</span><span class="num" id="5883210">8</span>&nbsp;<span class="op" id="5883212">|</span>&nbsp;<span class="builtintype" id="5883214">uint16</span><span class="op" id="5883220">(</span><span class="num" id="5883221">2</span><span class="op" id="5883222">+</span><span class="ident" id="5883223">i</span><span class="op" id="5883224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883230">for</span>&nbsp;<span class="ident" id="5883234">k</span>&nbsp;<span class="op" id="5883236">:=</span>&nbsp;<span class="builtintype" id="5883239">uint8</span><span class="op" id="5883244">(</span><span class="num" id="5883245">0</span><span class="op" id="5883246">)</span><span class="op" id="5883247">;</span>&nbsp;<span class="ident" id="5883249">k</span>&nbsp;<span class="op" id="5883251">&lt;</span>&nbsp;<span class="num" id="5883253">1</span><span class="op" id="5883254">&lt;&lt;</span><span class="op" id="5883256">(</span><span class="num" id="5883257">7</span><span class="op" id="5883258">-</span><span class="ident" id="5883259">i</span><span class="op" id="5883260">)</span><span class="op" id="5883261">;</span>&nbsp;<span class="ident" id="5883263">k</span><span class="op" id="5883264">++</span>&nbsp;<span class="op" id="5883267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883274">h</span><span class="op" id="5883275">.</span><span class="ident" id="5883276">lut</span><span class="op" id="5883279">[</span><span class="ident" id="5883280">base</span><span class="op" id="5883284">|</span><span class="ident" id="5883285">k</span><span class="op" id="5883286">]</span>&nbsp;<span class="op" id="5883288">=</span>&nbsp;<span class="ident" id="5883290">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883303">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883309">code</span><span class="op" id="5883313">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883320">x</span><span class="op" id="5883321">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883336">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883385">var</span>&nbsp;<span class="ident" id="5883389">c</span><span class="op" id="5883390">,</span>&nbsp;<span class="ident" id="5883392">index</span>&nbsp;<span class="builtintype" id="5883398">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883406">for</span>&nbsp;<span class="ident" id="5883410">i</span><span class="op" id="5883411">,</span>&nbsp;<span class="ident" id="5883413">n</span>&nbsp;<span class="op" id="5883415">:=</span>&nbsp;<span class="keyword" id="5883418">range</span>&nbsp;<span class="ident" id="5883424">nCodes</span>&nbsp;<span class="op" id="5883431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883436">if</span>&nbsp;<span class="ident" id="5883439">n</span>&nbsp;<span class="op" id="5883441">==</span>&nbsp;<span class="num" id="5883444">0</span>&nbsp;<span class="op" id="5883446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883452">h</span><span class="op" id="5883453">.</span><span class="ident" id="5883454">minCodes</span><span class="op" id="5883462">[</span><span class="ident" id="5883463">i</span><span class="op" id="5883464">]</span>&nbsp;<span class="op" id="5883466">=</span>&nbsp;<span class="op" id="5883468">-</span><span class="num" id="5883469">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883475">h</span><span class="op" id="5883476">.</span><span class="ident" id="5883477">maxCodes</span><span class="op" id="5883485">[</span><span class="ident" id="5883486">i</span><span class="op" id="5883487">]</span>&nbsp;<span class="op" id="5883489">=</span>&nbsp;<span class="op" id="5883491">-</span><span class="num" id="5883492">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883498">h</span><span class="op" id="5883499">.</span><span class="ident" id="5883500">valsIndices</span><span class="op" id="5883511">[</span><span class="ident" id="5883512">i</span><span class="op" id="5883513">]</span>&nbsp;<span class="op" id="5883515">=</span>&nbsp;<span class="op" id="5883517">-</span><span class="num" id="5883518">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883523">}</span>&nbsp;<span class="keyword" id="5883525">else</span>&nbsp;<span class="op" id="5883530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883536">h</span><span class="op" id="5883537">.</span><span class="ident" id="5883538">minCodes</span><span class="op" id="5883546">[</span><span class="ident" id="5883547">i</span><span class="op" id="5883548">]</span>&nbsp;<span class="op" id="5883550">=</span>&nbsp;<span class="ident" id="5883552">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883558">h</span><span class="op" id="5883559">.</span><span class="ident" id="5883560">maxCodes</span><span class="op" id="5883568">[</span><span class="ident" id="5883569">i</span><span class="op" id="5883570">]</span>&nbsp;<span class="op" id="5883572">=</span>&nbsp;<span class="ident" id="5883574">c</span>&nbsp;<span class="op" id="5883576">+</span>&nbsp;<span class="ident" id="5883578">n</span>&nbsp;<span class="op" id="5883580">-</span>&nbsp;<span class="num" id="5883582">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883588">h</span><span class="op" id="5883589">.</span><span class="ident" id="5883590">valsIndices</span><span class="op" id="5883601">[</span><span class="ident" id="5883602">i</span><span class="op" id="5883603">]</span>&nbsp;<span class="op" id="5883605">=</span>&nbsp;<span class="ident" id="5883607">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883617">c</span>&nbsp;<span class="op" id="5883619">+=</span>&nbsp;<span class="ident" id="5883622">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883628">index</span>&nbsp;<span class="op" id="5883634">+=</span>&nbsp;<span class="ident" id="5883637">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883647">c</span>&nbsp;<span class="op" id="5883649">&lt;&lt;=</span>&nbsp;<span class="num" id="5883653">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883663">return</span>&nbsp;<span class="ident" id="5883670">nil</span><br>
<span class="lineno"></span><span class="op" id="5883674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5883677">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5883752">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5883779">func</span>&nbsp;<span class="op" id="5883784">(</span><span class="ident" id="5883785">d</span>&nbsp;<span class="op" id="5883787">*</span><span class="ident" id="5883788">decoder</span><span class="op" id="5883795">)</span>&nbsp;<span class="ident" id="5883797">decodeHuffman</span><span class="op" id="5883810">(</span><span class="ident" id="5883811">h</span>&nbsp;<span class="op" id="5883813">*</span><span class="ident" id="5883814">huffman</span><span class="op" id="5883821">)</span>&nbsp;<span class="op" id="5883823">(</span><span class="builtintype" id="5883824">uint8</span><span class="op" id="5883829">,</span>&nbsp;<span class="builtintype" id="5883831">error</span><span class="op" id="5883836">)</span>&nbsp;<span class="op" id="5883838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883841">if</span>&nbsp;<span class="ident" id="5883844">h</span><span class="op" id="5883845">.</span><span class="ident" id="5883846">nCodes</span>&nbsp;<span class="op" id="5883853">==</span>&nbsp;<span class="num" id="5883856">0</span>&nbsp;<span class="op" id="5883858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883862">return</span>&nbsp;<span class="num" id="5883869">0</span><span class="op" id="5883870">,</span>&nbsp;<span class="ident" id="5883872">FormatError</span><span class="op" id="5883883">(</span><span class="string" id="5883884">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5883913">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5883916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883920">if</span>&nbsp;<span class="ident" id="5883923">d</span><span class="op" id="5883924">.</span><span class="ident" id="5883925">bits</span><span class="op" id="5883929">.</span><span class="ident" id="5883930">n</span>&nbsp;<span class="op" id="5883932">&lt;</span>&nbsp;<span class="num" id="5883934">8</span>&nbsp;<span class="op" id="5883936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883940">if</span>&nbsp;<span class="ident" id="5883943">err</span>&nbsp;<span class="op" id="5883947">:=</span>&nbsp;<span class="ident" id="5883950">d</span><span class="op" id="5883951">.</span><span class="ident" id="5883952">ensureNBits</span><span class="op" id="5883963">(</span><span class="num" id="5883964">8</span><span class="op" id="5883965">)</span><span class="op" id="5883966">;</span>&nbsp;<span class="ident" id="5883968">err</span>&nbsp;<span class="op" id="5883972">!=</span>&nbsp;<span class="ident" id="5883975">nil</span>&nbsp;<span class="op" id="5883979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883984">if</span>&nbsp;<span class="ident" id="5883987">err</span>&nbsp;<span class="op" id="5883991">!=</span>&nbsp;<span class="ident" id="5883994">errMissingFF00</span>&nbsp;<span class="op" id="5884009">&amp;&amp;</span>&nbsp;<span class="ident" id="5884012">err</span>&nbsp;<span class="op" id="5884016">!=</span>&nbsp;<span class="ident" id="5884019">errShortHuffmanData</span>&nbsp;<span class="op" id="5884039">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884045">return</span>&nbsp;<span class="num" id="5884052">0</span><span class="op" id="5884053">,</span>&nbsp;<span class="ident" id="5884055">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884067">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884139">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5884210">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884273">d</span><span class="op" id="5884274">.</span><span class="ident" id="5884275">unreadByteStuffedByte</span><span class="op" id="5884296">(</span><span class="op" id="5884297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884302">goto</span>&nbsp;<span class="ident" id="5884307">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884324">if</span>&nbsp;<span class="ident" id="5884327">v</span>&nbsp;<span class="op" id="5884329">:=</span>&nbsp;<span class="ident" id="5884332">h</span><span class="op" id="5884333">.</span><span class="ident" id="5884334">lut</span><span class="op" id="5884337">[</span><span class="op" id="5884338">(</span><span class="ident" id="5884339">d</span><span class="op" id="5884340">.</span><span class="ident" id="5884341">bits</span><span class="op" id="5884345">.</span><span class="ident" id="5884346">a</span><span class="op" id="5884347">&gt;&gt;</span><span class="builtintype" id="5884349">uint32</span><span class="op" id="5884355">(</span><span class="ident" id="5884356">d</span><span class="op" id="5884357">.</span><span class="ident" id="5884358">bits</span><span class="op" id="5884362">.</span><span class="ident" id="5884363">n</span><span class="op" id="5884364">-</span><span class="ident" id="5884365">lutSize</span><span class="op" id="5884372">)</span><span class="op" id="5884373">)</span><span class="op" id="5884374">&amp;</span><span class="num" id="5884375">0xff</span><span class="op" id="5884379">]</span><span class="op" id="5884380">;</span>&nbsp;<span class="ident" id="5884382">v</span>&nbsp;<span class="op" id="5884384">!=</span>&nbsp;<span class="num" id="5884387">0</span>&nbsp;<span class="op" id="5884389">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884393">n</span>&nbsp;<span class="op" id="5884395">:=</span>&nbsp;<span class="op" id="5884398">(</span><span class="ident" id="5884399">v</span>&nbsp;<span class="op" id="5884401">&amp;</span>&nbsp;<span class="num" id="5884403">0xff</span><span class="op" id="5884407">)</span>&nbsp;<span class="op" id="5884409">-</span>&nbsp;<span class="num" id="5884411">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884415">d</span><span class="op" id="5884416">.</span><span class="ident" id="5884417">bits</span><span class="op" id="5884421">.</span><span class="ident" id="5884422">n</span>&nbsp;<span class="op" id="5884424">-=</span>&nbsp;<span class="builtintype" id="5884427">int32</span><span class="op" id="5884432">(</span><span class="ident" id="5884433">n</span><span class="op" id="5884434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884438">d</span><span class="op" id="5884439">.</span><span class="ident" id="5884440">bits</span><span class="op" id="5884444">.</span><span class="ident" id="5884445">m</span>&nbsp;<span class="op" id="5884447">&gt;&gt;=</span>&nbsp;<span class="ident" id="5884451">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884455">return</span>&nbsp;<span class="builtintype" id="5884462">uint8</span><span class="op" id="5884467">(</span><span class="ident" id="5884468">v</span>&nbsp;<span class="op" id="5884470">&gt;&gt;</span>&nbsp;<span class="num" id="5884473">8</span><span class="op" id="5884474">)</span><span class="op" id="5884475">,</span>&nbsp;<span class="ident" id="5884477">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884482">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5884485">slowPath</span><span class="op" id="5884493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884496">for</span>&nbsp;<span class="ident" id="5884500">i</span><span class="op" id="5884501">,</span>&nbsp;<span class="ident" id="5884503">code</span>&nbsp;<span class="op" id="5884508">:=</span>&nbsp;<span class="num" id="5884511">0</span><span class="op" id="5884512">,</span>&nbsp;<span class="builtintype" id="5884514">int32</span><span class="op" id="5884519">(</span><span class="num" id="5884520">0</span><span class="op" id="5884521">)</span><span class="op" id="5884522">;</span>&nbsp;<span class="ident" id="5884524">i</span>&nbsp;<span class="op" id="5884526">&lt;</span>&nbsp;<span class="ident" id="5884528">maxCodeLength</span><span class="op" id="5884541">;</span>&nbsp;<span class="ident" id="5884543">i</span><span class="op" id="5884544">++</span>&nbsp;<span class="op" id="5884547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884551">if</span>&nbsp;<span class="ident" id="5884554">d</span><span class="op" id="5884555">.</span><span class="ident" id="5884556">bits</span><span class="op" id="5884560">.</span><span class="ident" id="5884561">n</span>&nbsp;<span class="op" id="5884563">==</span>&nbsp;<span class="num" id="5884566">0</span>&nbsp;<span class="op" id="5884568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884573">if</span>&nbsp;<span class="ident" id="5884576">err</span>&nbsp;<span class="op" id="5884580">:=</span>&nbsp;<span class="ident" id="5884583">d</span><span class="op" id="5884584">.</span><span class="ident" id="5884585">ensureNBits</span><span class="op" id="5884596">(</span><span class="num" id="5884597">1</span><span class="op" id="5884598">)</span><span class="op" id="5884599">;</span>&nbsp;<span class="ident" id="5884601">err</span>&nbsp;<span class="op" id="5884605">!=</span>&nbsp;<span class="ident" id="5884608">nil</span>&nbsp;<span class="op" id="5884612">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884618">return</span>&nbsp;<span class="num" id="5884625">0</span><span class="op" id="5884626">,</span>&nbsp;<span class="ident" id="5884628">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884643">if</span>&nbsp;<span class="ident" id="5884646">d</span><span class="op" id="5884647">.</span><span class="ident" id="5884648">bits</span><span class="op" id="5884652">.</span><span class="ident" id="5884653">a</span><span class="op" id="5884654">&amp;</span><span class="ident" id="5884655">d</span><span class="op" id="5884656">.</span><span class="ident" id="5884657">bits</span><span class="op" id="5884661">.</span><span class="ident" id="5884662">m</span>&nbsp;<span class="op" id="5884664">!=</span>&nbsp;<span class="num" id="5884667">0</span>&nbsp;<span class="op" id="5884669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884674">code</span>&nbsp;<span class="op" id="5884679">|=</span>&nbsp;<span class="num" id="5884682">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884690">d</span><span class="op" id="5884691">.</span><span class="ident" id="5884692">bits</span><span class="op" id="5884696">.</span><span class="ident" id="5884697">n</span><span class="op" id="5884698">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884703">d</span><span class="op" id="5884704">.</span><span class="ident" id="5884705">bits</span><span class="op" id="5884709">.</span><span class="ident" id="5884710">m</span>&nbsp;<span class="op" id="5884712">&gt;&gt;=</span>&nbsp;<span class="num" id="5884716">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884720">if</span>&nbsp;<span class="ident" id="5884723">code</span>&nbsp;<span class="op" id="5884728">&lt;=</span>&nbsp;<span class="ident" id="5884731">h</span><span class="op" id="5884732">.</span><span class="ident" id="5884733">maxCodes</span><span class="op" id="5884741">[</span><span class="ident" id="5884742">i</span><span class="op" id="5884743">]</span>&nbsp;<span class="op" id="5884745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884750">return</span>&nbsp;<span class="ident" id="5884757">h</span><span class="op" id="5884758">.</span><span class="ident" id="5884759">vals</span><span class="op" id="5884763">[</span><span class="ident" id="5884764">h</span><span class="op" id="5884765">.</span><span class="ident" id="5884766">valsIndices</span><span class="op" id="5884777">[</span><span class="ident" id="5884778">i</span><span class="op" id="5884779">]</span><span class="op" id="5884780">+</span><span class="ident" id="5884781">code</span><span class="op" id="5884785">-</span><span class="ident" id="5884786">h</span><span class="op" id="5884787">.</span><span class="ident" id="5884788">minCodes</span><span class="op" id="5884796">[</span><span class="ident" id="5884797">i</span><span class="op" id="5884798">]</span><span class="op" id="5884799">]</span><span class="op" id="5884800">,</span>&nbsp;<span class="ident" id="5884802">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884812">code</span>&nbsp;<span class="op" id="5884817">&lt;&lt;=</span>&nbsp;<span class="num" id="5884821">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884827">return</span>&nbsp;<span class="num" id="5884834">0</span><span class="op" id="5884835">,</span>&nbsp;<span class="ident" id="5884837">FormatError</span><span class="op" id="5884848">(</span><span class="string" id="5884849">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5884867">)</span><br>
<span class="lineno"></span><span class="op" id="5884869">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5884872">func</span>&nbsp;<span class="op" id="5884877">(</span><span class="ident" id="5884878">d</span>&nbsp;<span class="op" id="5884880">*</span><span class="ident" id="5884881">decoder</span><span class="op" id="5884888">)</span>&nbsp;<span class="ident" id="5884890">decodeBit</span><span class="op" id="5884899">(</span><span class="op" id="5884900">)</span>&nbsp;<span class="op" id="5884902">(</span><span class="builtintype" id="5884903">bool</span><span class="op" id="5884907">,</span>&nbsp;<span class="builtintype" id="5884909">error</span><span class="op" id="5884914">)</span>&nbsp;<span class="op" id="5884916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884919">if</span>&nbsp;<span class="ident" id="5884922">d</span><span class="op" id="5884923">.</span><span class="ident" id="5884924">bits</span><span class="op" id="5884928">.</span><span class="ident" id="5884929">n</span>&nbsp;<span class="op" id="5884931">==</span>&nbsp;<span class="num" id="5884934">0</span>&nbsp;<span class="op" id="5884936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884940">if</span>&nbsp;<span class="ident" id="5884943">err</span>&nbsp;<span class="op" id="5884947">:=</span>&nbsp;<span class="ident" id="5884950">d</span><span class="op" id="5884951">.</span><span class="ident" id="5884952">ensureNBits</span><span class="op" id="5884963">(</span><span class="num" id="5884964">1</span><span class="op" id="5884965">)</span><span class="op" id="5884966">;</span>&nbsp;<span class="ident" id="5884968">err</span>&nbsp;<span class="op" id="5884972">!=</span>&nbsp;<span class="ident" id="5884975">nil</span>&nbsp;<span class="op" id="5884979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884984">return</span>&nbsp;<span class="builtintype" id="5884991">false</span><span class="op" id="5884996">,</span>&nbsp;<span class="ident" id="5884998">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885010">ret</span>&nbsp;<span class="op" id="5885014">:=</span>&nbsp;<span class="ident" id="5885017">d</span><span class="op" id="5885018">.</span><span class="ident" id="5885019">bits</span><span class="op" id="5885023">.</span><span class="ident" id="5885024">a</span><span class="op" id="5885025">&amp;</span><span class="ident" id="5885026">d</span><span class="op" id="5885027">.</span><span class="ident" id="5885028">bits</span><span class="op" id="5885032">.</span><span class="ident" id="5885033">m</span>&nbsp;<span class="op" id="5885035">!=</span>&nbsp;<span class="num" id="5885038">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885041">d</span><span class="op" id="5885042">.</span><span class="ident" id="5885043">bits</span><span class="op" id="5885047">.</span><span class="ident" id="5885048">n</span><span class="op" id="5885049">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885053">d</span><span class="op" id="5885054">.</span><span class="ident" id="5885055">bits</span><span class="op" id="5885059">.</span><span class="ident" id="5885060">m</span>&nbsp;<span class="op" id="5885062">&gt;&gt;=</span>&nbsp;<span class="num" id="5885066">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885069">return</span>&nbsp;<span class="ident" id="5885076">ret</span><span class="op" id="5885079">,</span>&nbsp;<span class="ident" id="5885081">nil</span><br>
<span class="lineno"></span><span class="op" id="5885085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5885088">func</span>&nbsp;<span class="op" id="5885093">(</span><span class="ident" id="5885094">d</span>&nbsp;<span class="op" id="5885096">*</span><span class="ident" id="5885097">decoder</span><span class="op" id="5885104">)</span>&nbsp;<span class="ident" id="5885106">decodeBits</span><span class="op" id="5885116">(</span><span class="ident" id="5885117">n</span>&nbsp;<span class="builtintype" id="5885119">int32</span><span class="op" id="5885124">)</span>&nbsp;<span class="op" id="5885126">(</span><span class="builtintype" id="5885127">uint32</span><span class="op" id="5885133">,</span>&nbsp;<span class="builtintype" id="5885135">error</span><span class="op" id="5885140">)</span>&nbsp;<span class="op" id="5885142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885145">if</span>&nbsp;<span class="ident" id="5885148">d</span><span class="op" id="5885149">.</span><span class="ident" id="5885150">bits</span><span class="op" id="5885154">.</span><span class="ident" id="5885155">n</span>&nbsp;<span class="op" id="5885157">&lt;</span>&nbsp;<span class="ident" id="5885159">n</span>&nbsp;<span class="op" id="5885161">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885165">if</span>&nbsp;<span class="ident" id="5885168">err</span>&nbsp;<span class="op" id="5885172">:=</span>&nbsp;<span class="ident" id="5885175">d</span><span class="op" id="5885176">.</span><span class="ident" id="5885177">ensureNBits</span><span class="op" id="5885188">(</span><span class="ident" id="5885189">n</span><span class="op" id="5885190">)</span><span class="op" id="5885191">;</span>&nbsp;<span class="ident" id="5885193">err</span>&nbsp;<span class="op" id="5885197">!=</span>&nbsp;<span class="ident" id="5885200">nil</span>&nbsp;<span class="op" id="5885204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885209">return</span>&nbsp;<span class="num" id="5885216">0</span><span class="op" id="5885217">,</span>&nbsp;<span class="ident" id="5885219">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5885228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885231">ret</span>&nbsp;<span class="op" id="5885235">:=</span>&nbsp;<span class="ident" id="5885238">d</span><span class="op" id="5885239">.</span><span class="ident" id="5885240">bits</span><span class="op" id="5885244">.</span><span class="ident" id="5885245">a</span>&nbsp;<span class="op" id="5885247">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5885250">uint32</span><span class="op" id="5885256">(</span><span class="ident" id="5885257">d</span><span class="op" id="5885258">.</span><span class="ident" id="5885259">bits</span><span class="op" id="5885263">.</span><span class="ident" id="5885264">n</span><span class="op" id="5885265">-</span><span class="ident" id="5885266">n</span><span class="op" id="5885267">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885270">ret</span>&nbsp;<span class="op" id="5885274">&amp;=</span>&nbsp;<span class="op" id="5885277">(</span><span class="num" id="5885278">1</span>&nbsp;<span class="op" id="5885280">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5885283">uint32</span><span class="op" id="5885289">(</span><span class="ident" id="5885290">n</span><span class="op" id="5885291">)</span><span class="op" id="5885292">)</span>&nbsp;<span class="op" id="5885294">-</span>&nbsp;<span class="num" id="5885296">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885299">d</span><span class="op" id="5885300">.</span><span class="ident" id="5885301">bits</span><span class="op" id="5885305">.</span><span class="ident" id="5885306">n</span>&nbsp;<span class="op" id="5885308">-=</span>&nbsp;<span class="ident" id="5885311">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885314">d</span><span class="op" id="5885315">.</span><span class="ident" id="5885316">bits</span><span class="op" id="5885320">.</span><span class="ident" id="5885321">m</span>&nbsp;<span class="op" id="5885323">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5885327">uint32</span><span class="op" id="5885333">(</span><span class="ident" id="5885334">n</span><span class="op" id="5885335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5885338">return</span>&nbsp;<span class="ident" id="5885345">ret</span><span class="op" id="5885348">,</span>&nbsp;<span class="ident" id="5885350">nil</span><br>
<span class="lineno"></span><span class="op" id="5885354">}</span>
</div>
</body>
</html>
