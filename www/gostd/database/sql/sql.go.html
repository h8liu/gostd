<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6250168">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6250223">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6250277">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6250328">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="6250397">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="6250411">//</span><br>
<span class="lineno"></span><span class="comment" id="6250414">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6250485">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="6250546">//</span><br>
<span class="lineno"></span><span class="comment" id="6250549">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6250598">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="6250630">package</span>&nbsp;<span class="ident" id="6250638">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6250643">import</span>&nbsp;<span class="op" id="6250650">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250653">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250676">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250686">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250693">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250699">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250710">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6250718">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6250725">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6250728">var</span>&nbsp;<span class="ident" id="6250732">drivers</span>&nbsp;<span class="op" id="6250740">=</span>&nbsp;<span class="builtinfunc" id="6250742">make</span><span class="op" id="6250746">(</span><span class="keyword" id="6250747">map</span><span class="op" id="6250750">[</span><span class="builtintype" id="6250751">string</span><span class="op" id="6250757">]</span><span class="ident" id="6250758">driver</span><span class="op" id="6250764">.</span><span class="ident" id="6250765">Driver</span><span class="op" id="6250771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6250774">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="6250842">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="6250913">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="6250927">func</span>&nbsp;<span class="ident" id="6250932">Register</span><span class="op" id="6250940">(</span><span class="ident" id="6250941">name</span>&nbsp;<span class="builtintype" id="6250946">string</span><span class="op" id="6250952">,</span>&nbsp;<span class="ident" id="6250954">driver</span>&nbsp;<span class="ident" id="6250961">driver</span><span class="op" id="6250967">.</span><span class="ident" id="6250968">Driver</span><span class="op" id="6250974">)</span>&nbsp;<span class="op" id="6250976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6250979">if</span>&nbsp;<span class="ident" id="6250982">driver</span>&nbsp;<span class="op" id="6250989">==</span>&nbsp;<span class="ident" id="6250992">nil</span>&nbsp;<span class="op" id="6250996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6251000">panic</span><span class="op" id="6251005">(</span><span class="string" id="6251006">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="6251035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6251038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251041">if</span>&nbsp;<span class="ident" id="6251044">_</span><span class="op" id="6251045">,</span>&nbsp;<span class="ident" id="6251047">dup</span>&nbsp;<span class="op" id="6251051">:=</span>&nbsp;<span class="ident" id="6251054">drivers</span><span class="op" id="6251061">[</span><span class="ident" id="6251062">name</span><span class="op" id="6251066">]</span><span class="op" id="6251067">;</span>&nbsp;<span class="ident" id="6251069">dup</span>&nbsp;<span class="op" id="6251073">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6251077">panic</span><span class="op" id="6251082">(</span><span class="string" id="6251083">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="6251124">+</span>&nbsp;<span class="ident" id="6251126">name</span><span class="op" id="6251130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6251133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251136">drivers</span><span class="op" id="6251143">[</span><span class="ident" id="6251144">name</span><span class="op" id="6251148">]</span>&nbsp;<span class="op" id="6251150">=</span>&nbsp;<span class="ident" id="6251152">driver</span><br>
<span class="lineno"></span><span class="op" id="6251159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6251162">func</span>&nbsp;<span class="ident" id="6251167">unregisterAllDrivers</span><span class="op" id="6251187">(</span><span class="op" id="6251188">)</span>&nbsp;<span class="op" id="6251190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6251193">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251208">drivers</span>&nbsp;<span class="op" id="6251216">=</span>&nbsp;<span class="builtinfunc" id="6251218">make</span><span class="op" id="6251222">(</span><span class="keyword" id="6251223">map</span><span class="op" id="6251226">[</span><span class="builtintype" id="6251227">string</span><span class="op" id="6251233">]</span><span class="ident" id="6251234">driver</span><span class="op" id="6251240">.</span><span class="ident" id="6251241">Driver</span><span class="op" id="6251247">)</span><br>
<span class="lineno"></span><span class="op" id="6251249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6251252">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="6251325">func</span>&nbsp;<span class="ident" id="6251330">Drivers</span><span class="op" id="6251337">(</span><span class="op" id="6251338">)</span>&nbsp;<span class="op" id="6251340">[</span><span class="op" id="6251341">]</span><span class="builtintype" id="6251342">string</span>&nbsp;<span class="op" id="6251349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251352">var</span>&nbsp;<span class="ident" id="6251356">list</span>&nbsp;<span class="op" id="6251361">[</span><span class="op" id="6251362">]</span><span class="builtintype" id="6251363">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251371">for</span>&nbsp;<span class="ident" id="6251375">name</span>&nbsp;<span class="op" id="6251380">:=</span>&nbsp;<span class="keyword" id="6251383">range</span>&nbsp;<span class="ident" id="6251389">drivers</span>&nbsp;<span class="op" id="6251397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251401">list</span>&nbsp;<span class="op" id="6251406">=</span>&nbsp;<span class="builtinfunc" id="6251408">append</span><span class="op" id="6251414">(</span><span class="ident" id="6251415">list</span><span class="op" id="6251419">,</span>&nbsp;<span class="ident" id="6251421">name</span><span class="op" id="6251425">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6251428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6251431">sort</span><span class="op" id="6251435">.</span><span class="ident" id="6251436">Strings</span><span class="op" id="6251443">(</span><span class="ident" id="6251444">list</span><span class="op" id="6251448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6251451">return</span>&nbsp;<span class="ident" id="6251458">list</span><br>
<span class="lineno"></span><span class="op" id="6251463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="6251466">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="6251536">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="6251608">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6251662">type</span>&nbsp;<span class="ident" id="6251667">RawBytes</span>&nbsp;<span class="op" id="6251676">[</span><span class="op" id="6251677">]</span><span class="builtintype" id="6251678">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6251684">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6251736">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6251786">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="6251827">//</span><br>
<span class="lineno"></span><span class="comment" id="6251830">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="6251851">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="6251922">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6251930">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6251947">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="6251970">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="6251983">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6252004">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6252010">//</span><br>
<span class="lineno"></span><span class="keyword" id="6252013">type</span>&nbsp;<span class="ident" id="6252018">NullString</span>&nbsp;<span class="keyword" id="6252029">struct</span>&nbsp;<span class="op" id="6252036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252039">String</span>&nbsp;<span class="builtintype" id="6252046">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252054">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="6252061">bool</span>&nbsp;<span class="comment" id="6252066">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6252105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6252108">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6252150">func</span>&nbsp;<span class="op" id="6252155">(</span><span class="ident" id="6252156">ns</span>&nbsp;<span class="op" id="6252159">*</span><span class="ident" id="6252160">NullString</span><span class="op" id="6252170">)</span>&nbsp;<span class="ident" id="6252172">Scan</span><span class="op" id="6252176">(</span><span class="ident" id="6252177">value</span>&nbsp;<span class="keyword" id="6252183">interface</span><span class="op" id="6252192">{</span><span class="op" id="6252193">}</span><span class="op" id="6252194">)</span>&nbsp;<span class="builtintype" id="6252196">error</span>&nbsp;<span class="op" id="6252202">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252205">if</span>&nbsp;<span class="ident" id="6252208">value</span>&nbsp;<span class="op" id="6252214">==</span>&nbsp;<span class="ident" id="6252217">nil</span>&nbsp;<span class="op" id="6252221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252225">ns</span><span class="op" id="6252227">.</span><span class="ident" id="6252228">String</span><span class="op" id="6252234">,</span>&nbsp;<span class="ident" id="6252236">ns</span><span class="op" id="6252238">.</span><span class="ident" id="6252239">Valid</span>&nbsp;<span class="op" id="6252245">=</span>&nbsp;<span class="string" id="6252247">&#34;&#34;</span><span class="op" id="6252249">,</span>&nbsp;<span class="builtintype" id="6252251">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252259">return</span>&nbsp;<span class="ident" id="6252266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252274">ns</span><span class="op" id="6252276">.</span><span class="ident" id="6252277">Valid</span>&nbsp;<span class="op" id="6252283">=</span>&nbsp;<span class="builtintype" id="6252285">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252291">return</span>&nbsp;<span class="ident" id="6252298">convertAssign</span><span class="op" id="6252311">(</span><span class="op" id="6252312">&amp;</span><span class="ident" id="6252313">ns</span><span class="op" id="6252315">.</span><span class="ident" id="6252316">String</span><span class="op" id="6252322">,</span>&nbsp;<span class="ident" id="6252324">value</span><span class="op" id="6252329">)</span><br>
<span class="lineno"></span><span class="op" id="6252331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6252334">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6252383">func</span>&nbsp;<span class="op" id="6252388">(</span><span class="ident" id="6252389">ns</span>&nbsp;<span class="ident" id="6252392">NullString</span><span class="op" id="6252402">)</span>&nbsp;<span class="ident" id="6252404">Value</span><span class="op" id="6252409">(</span><span class="op" id="6252410">)</span>&nbsp;<span class="op" id="6252412">(</span><span class="ident" id="6252413">driver</span><span class="op" id="6252419">.</span><span class="ident" id="6252420">Value</span><span class="op" id="6252425">,</span>&nbsp;<span class="builtintype" id="6252427">error</span><span class="op" id="6252432">)</span>&nbsp;<span class="op" id="6252434">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252437">if</span>&nbsp;<span class="op" id="6252440">!</span><span class="ident" id="6252441">ns</span><span class="op" id="6252443">.</span><span class="ident" id="6252444">Valid</span>&nbsp;<span class="op" id="6252450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252454">return</span>&nbsp;<span class="ident" id="6252461">nil</span><span class="op" id="6252464">,</span>&nbsp;<span class="ident" id="6252466">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252474">return</span>&nbsp;<span class="ident" id="6252481">ns</span><span class="op" id="6252483">.</span><span class="ident" id="6252484">String</span><span class="op" id="6252490">,</span>&nbsp;<span class="ident" id="6252492">nil</span><br>
<span class="lineno"></span><span class="op" id="6252496">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="6252499">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6252550">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6252599">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6252663">type</span>&nbsp;<span class="ident" id="6252668">NullInt64</span>&nbsp;<span class="keyword" id="6252678">struct</span>&nbsp;<span class="op" id="6252685">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252688">Int64</span>&nbsp;<span class="ident" id="6252694">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252701">Valid</span>&nbsp;<span class="builtintype" id="6252707">bool</span>&nbsp;<span class="comment" id="6252712">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6252750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6252753">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="6252795">func</span>&nbsp;<span class="op" id="6252800">(</span><span class="ident" id="6252801">n</span>&nbsp;<span class="op" id="6252803">*</span><span class="ident" id="6252804">NullInt64</span><span class="op" id="6252813">)</span>&nbsp;<span class="ident" id="6252815">Scan</span><span class="op" id="6252819">(</span><span class="ident" id="6252820">value</span>&nbsp;<span class="keyword" id="6252826">interface</span><span class="op" id="6252835">{</span><span class="op" id="6252836">}</span><span class="op" id="6252837">)</span>&nbsp;<span class="builtintype" id="6252839">error</span>&nbsp;<span class="op" id="6252845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252848">if</span>&nbsp;<span class="ident" id="6252851">value</span>&nbsp;<span class="op" id="6252857">==</span>&nbsp;<span class="ident" id="6252860">nil</span>&nbsp;<span class="op" id="6252864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252868">n</span><span class="op" id="6252869">.</span><span class="ident" id="6252870">Int64</span><span class="op" id="6252875">,</span>&nbsp;<span class="ident" id="6252877">n</span><span class="op" id="6252878">.</span><span class="ident" id="6252879">Valid</span>&nbsp;<span class="op" id="6252885">=</span>&nbsp;<span class="num" id="6252887">0</span><span class="op" id="6252888">,</span>&nbsp;<span class="builtintype" id="6252890">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252898">return</span>&nbsp;<span class="ident" id="6252905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6252910">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6252913">n</span><span class="op" id="6252914">.</span><span class="ident" id="6252915">Valid</span>&nbsp;<span class="op" id="6252921">=</span>&nbsp;<span class="builtintype" id="6252923">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6252929">return</span>&nbsp;<span class="ident" id="6252936">convertAssign</span><span class="op" id="6252949">(</span><span class="op" id="6252950">&amp;</span><span class="ident" id="6252951">n</span><span class="op" id="6252952">.</span><span class="ident" id="6252953">Int64</span><span class="op" id="6252958">,</span>&nbsp;<span class="ident" id="6252960">value</span><span class="op" id="6252965">)</span><br>
<span class="lineno"></span><span class="op" id="6252967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6252970">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="6253019">func</span>&nbsp;<span class="op" id="6253024">(</span><span class="ident" id="6253025">n</span>&nbsp;<span class="ident" id="6253027">NullInt64</span><span class="op" id="6253036">)</span>&nbsp;<span class="ident" id="6253038">Value</span><span class="op" id="6253043">(</span><span class="op" id="6253044">)</span>&nbsp;<span class="op" id="6253046">(</span><span class="ident" id="6253047">driver</span><span class="op" id="6253053">.</span><span class="ident" id="6253054">Value</span><span class="op" id="6253059">,</span>&nbsp;<span class="builtintype" id="6253061">error</span><span class="op" id="6253066">)</span>&nbsp;<span class="op" id="6253068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253071">if</span>&nbsp;<span class="op" id="6253074">!</span><span class="ident" id="6253075">n</span><span class="op" id="6253076">.</span><span class="ident" id="6253077">Valid</span>&nbsp;<span class="op" id="6253083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253087">return</span>&nbsp;<span class="ident" id="6253094">nil</span><span class="op" id="6253097">,</span>&nbsp;<span class="ident" id="6253099">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253107">return</span>&nbsp;<span class="ident" id="6253114">n</span><span class="op" id="6253115">.</span><span class="ident" id="6253116">Int64</span><span class="op" id="6253121">,</span>&nbsp;<span class="ident" id="6253123">nil</span><br>
<span class="lineno">120</span><span class="op" id="6253127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6253130">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6253184">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="6253235">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="6253299">type</span>&nbsp;<span class="ident" id="6253304">NullFloat64</span>&nbsp;<span class="keyword" id="6253316">struct</span>&nbsp;<span class="op" id="6253323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253326">Float64</span>&nbsp;<span class="builtintype" id="6253334">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253343">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6253351">bool</span>&nbsp;<span class="comment" id="6253356">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6253396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6253399">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6253441">func</span>&nbsp;<span class="op" id="6253446">(</span><span class="ident" id="6253447">n</span>&nbsp;<span class="op" id="6253449">*</span><span class="ident" id="6253450">NullFloat64</span><span class="op" id="6253461">)</span>&nbsp;<span class="ident" id="6253463">Scan</span><span class="op" id="6253467">(</span><span class="ident" id="6253468">value</span>&nbsp;<span class="keyword" id="6253474">interface</span><span class="op" id="6253483">{</span><span class="op" id="6253484">}</span><span class="op" id="6253485">)</span>&nbsp;<span class="builtintype" id="6253487">error</span>&nbsp;<span class="op" id="6253493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253496">if</span>&nbsp;<span class="ident" id="6253499">value</span>&nbsp;<span class="op" id="6253505">==</span>&nbsp;<span class="ident" id="6253508">nil</span>&nbsp;<span class="op" id="6253512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253516">n</span><span class="op" id="6253517">.</span><span class="ident" id="6253518">Float64</span><span class="op" id="6253525">,</span>&nbsp;<span class="ident" id="6253527">n</span><span class="op" id="6253528">.</span><span class="ident" id="6253529">Valid</span>&nbsp;<span class="op" id="6253535">=</span>&nbsp;<span class="num" id="6253537">0</span><span class="op" id="6253538">,</span>&nbsp;<span class="builtintype" id="6253540">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253548">return</span>&nbsp;<span class="ident" id="6253555">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253563">n</span><span class="op" id="6253564">.</span><span class="ident" id="6253565">Valid</span>&nbsp;<span class="op" id="6253571">=</span>&nbsp;<span class="builtintype" id="6253573">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253579">return</span>&nbsp;<span class="ident" id="6253586">convertAssign</span><span class="op" id="6253599">(</span><span class="op" id="6253600">&amp;</span><span class="ident" id="6253601">n</span><span class="op" id="6253602">.</span><span class="ident" id="6253603">Float64</span><span class="op" id="6253610">,</span>&nbsp;<span class="ident" id="6253612">value</span><span class="op" id="6253617">)</span><br>
<span class="lineno"></span><span class="op" id="6253619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="6253622">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6253671">func</span>&nbsp;<span class="op" id="6253676">(</span><span class="ident" id="6253677">n</span>&nbsp;<span class="ident" id="6253679">NullFloat64</span><span class="op" id="6253690">)</span>&nbsp;<span class="ident" id="6253692">Value</span><span class="op" id="6253697">(</span><span class="op" id="6253698">)</span>&nbsp;<span class="op" id="6253700">(</span><span class="ident" id="6253701">driver</span><span class="op" id="6253707">.</span><span class="ident" id="6253708">Value</span><span class="op" id="6253713">,</span>&nbsp;<span class="builtintype" id="6253715">error</span><span class="op" id="6253720">)</span>&nbsp;<span class="op" id="6253722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253725">if</span>&nbsp;<span class="op" id="6253728">!</span><span class="ident" id="6253729">n</span><span class="op" id="6253730">.</span><span class="ident" id="6253731">Valid</span>&nbsp;<span class="op" id="6253737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253741">return</span>&nbsp;<span class="ident" id="6253748">nil</span><span class="op" id="6253751">,</span>&nbsp;<span class="ident" id="6253753">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6253758">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6253761">return</span>&nbsp;<span class="ident" id="6253768">n</span><span class="op" id="6253769">.</span><span class="ident" id="6253770">Float64</span><span class="op" id="6253777">,</span>&nbsp;<span class="ident" id="6253779">nil</span><br>
<span class="lineno"></span><span class="op" id="6253783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6253786">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="6253834">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="6253882">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="6253946">type</span>&nbsp;<span class="ident" id="6253951">NullBool</span>&nbsp;<span class="keyword" id="6253960">struct</span>&nbsp;<span class="op" id="6253967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253970">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="6253976">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6253982">Valid</span>&nbsp;<span class="builtintype" id="6253988">bool</span>&nbsp;<span class="comment" id="6253993">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="6254030">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6254033">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6254075">func</span>&nbsp;<span class="op" id="6254080">(</span><span class="ident" id="6254081">n</span>&nbsp;<span class="op" id="6254083">*</span><span class="ident" id="6254084">NullBool</span><span class="op" id="6254092">)</span>&nbsp;<span class="ident" id="6254094">Scan</span><span class="op" id="6254098">(</span><span class="ident" id="6254099">value</span>&nbsp;<span class="keyword" id="6254105">interface</span><span class="op" id="6254114">{</span><span class="op" id="6254115">}</span><span class="op" id="6254116">)</span>&nbsp;<span class="builtintype" id="6254118">error</span>&nbsp;<span class="op" id="6254124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254127">if</span>&nbsp;<span class="ident" id="6254130">value</span>&nbsp;<span class="op" id="6254136">==</span>&nbsp;<span class="ident" id="6254139">nil</span>&nbsp;<span class="op" id="6254143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254147">n</span><span class="op" id="6254148">.</span><span class="ident" id="6254149">Bool</span><span class="op" id="6254153">,</span>&nbsp;<span class="ident" id="6254155">n</span><span class="op" id="6254156">.</span><span class="ident" id="6254157">Valid</span>&nbsp;<span class="op" id="6254163">=</span>&nbsp;<span class="builtintype" id="6254165">false</span><span class="op" id="6254170">,</span>&nbsp;<span class="builtintype" id="6254172">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254180">return</span>&nbsp;<span class="ident" id="6254187">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254195">n</span><span class="op" id="6254196">.</span><span class="ident" id="6254197">Valid</span>&nbsp;<span class="op" id="6254203">=</span>&nbsp;<span class="builtintype" id="6254205">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254211">return</span>&nbsp;<span class="ident" id="6254218">convertAssign</span><span class="op" id="6254231">(</span><span class="op" id="6254232">&amp;</span><span class="ident" id="6254233">n</span><span class="op" id="6254234">.</span><span class="ident" id="6254235">Bool</span><span class="op" id="6254239">,</span>&nbsp;<span class="ident" id="6254241">value</span><span class="op" id="6254246">)</span><br>
<span class="lineno"></span><span class="op" id="6254248">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="6254251">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6254300">func</span>&nbsp;<span class="op" id="6254305">(</span><span class="ident" id="6254306">n</span>&nbsp;<span class="ident" id="6254308">NullBool</span><span class="op" id="6254316">)</span>&nbsp;<span class="ident" id="6254318">Value</span><span class="op" id="6254323">(</span><span class="op" id="6254324">)</span>&nbsp;<span class="op" id="6254326">(</span><span class="ident" id="6254327">driver</span><span class="op" id="6254333">.</span><span class="ident" id="6254334">Value</span><span class="op" id="6254339">,</span>&nbsp;<span class="builtintype" id="6254341">error</span><span class="op" id="6254346">)</span>&nbsp;<span class="op" id="6254348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254351">if</span>&nbsp;<span class="op" id="6254354">!</span><span class="ident" id="6254355">n</span><span class="op" id="6254356">.</span><span class="ident" id="6254357">Valid</span>&nbsp;<span class="op" id="6254363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254367">return</span>&nbsp;<span class="ident" id="6254374">nil</span><span class="op" id="6254377">,</span>&nbsp;<span class="ident" id="6254379">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6254384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6254387">return</span>&nbsp;<span class="ident" id="6254394">n</span><span class="op" id="6254395">.</span><span class="ident" id="6254396">Bool</span><span class="op" id="6254400">,</span>&nbsp;<span class="ident" id="6254402">nil</span><br>
<span class="lineno"></span><span class="op" id="6254406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6254409">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="6254450">type</span>&nbsp;<span class="ident" id="6254455">Scanner</span>&nbsp;<span class="keyword" id="6254463">interface</span>&nbsp;<span class="op" id="6254473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254476">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254525">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254529">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254590">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254608">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254612">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254625">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254640">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254652">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254666">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254680">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254697">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254726">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254730">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6254793">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6254826">Scan</span><span class="op" id="6254830">(</span><span class="ident" id="6254831">src</span>&nbsp;<span class="keyword" id="6254835">interface</span><span class="op" id="6254844">{</span><span class="op" id="6254845">}</span><span class="op" id="6254846">)</span>&nbsp;<span class="builtintype" id="6254848">error</span><br>
<span class="lineno"></span><span class="op" id="6254854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6254857">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="6254921">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="6254992">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="6255027">var</span>&nbsp;<span class="ident" id="6255031">ErrNoRows</span>&nbsp;<span class="op" id="6255041">=</span>&nbsp;<span class="ident" id="6255043">errors</span><span class="op" id="6255049">.</span><span class="ident" id="6255050">New</span><span class="op" id="6255053">(</span><span class="string" id="6255054">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="6255082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6255085">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="6255148">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="6255216">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="6255231">//</span><br>
<span class="lineno"></span><span class="comment" id="6255234">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6255301">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="6255372">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="6255442">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6255505">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6255568">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="6255629">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="6255699">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="6255742">type</span>&nbsp;<span class="ident" id="6255747">DB</span>&nbsp;<span class="keyword" id="6255750">struct</span>&nbsp;<span class="op" id="6255757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255760">driver</span>&nbsp;<span class="ident" id="6255767">driver</span><span class="op" id="6255773">.</span><span class="ident" id="6255774">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255782">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6255789">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255798">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6255811">sync</span><span class="op" id="6255815">.</span><span class="ident" id="6255816">Mutex</span>&nbsp;<span class="comment" id="6255822">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255852">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6255865">[</span><span class="op" id="6255866">]</span><span class="op" id="6255867">*</span><span class="ident" id="6255868">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255880">connRequests</span>&nbsp;<span class="op" id="6255893">[</span><span class="op" id="6255894">]</span><span class="keyword" id="6255895">chan</span>&nbsp;<span class="ident" id="6255900">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255913">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6255926">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255931">pendingOpens</span>&nbsp;<span class="builtintype" id="6255944">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6255949">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6255997">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6256063">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6256142">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6256215">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256238">openerCh</span>&nbsp;<span class="keyword" id="6256247">chan</span>&nbsp;<span class="keyword" id="6256252">struct</span><span class="op" id="6256258">{</span><span class="op" id="6256259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256262">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6256271">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256277">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6256286">map</span><span class="op" id="6256289">[</span><span class="ident" id="6256290">finalCloser</span><span class="op" id="6256301">]</span><span class="ident" id="6256302">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256310">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="6256319">map</span><span class="op" id="6256322">[</span><span class="op" id="6256323">*</span><span class="ident" id="6256324">driverConn</span><span class="op" id="6256334">]</span><span class="builtintype" id="6256335">string</span>&nbsp;<span class="comment" id="6256342">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256388">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="6256397">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6256420">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256473">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="6256482">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6256505">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="6256529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6256532">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6256583">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="6256652">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="6256717">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="6256734">type</span>&nbsp;<span class="ident" id="6256739">driverConn</span>&nbsp;<span class="keyword" id="6256750">struct</span>&nbsp;<span class="op" id="6256757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256760">db</span>&nbsp;<span class="op" id="6256763">*</span><span class="ident" id="6256764">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256769">sync</span><span class="op" id="6256773">.</span><span class="ident" id="6256774">Mutex</span>&nbsp;&nbsp;<span class="comment" id="6256781">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256802">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6256814">driver</span><span class="op" id="6256820">.</span><span class="ident" id="6256821">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256827">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6256839">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256845">finalClosed</span>&nbsp;<span class="builtintype" id="6256857">bool</span>&nbsp;<span class="comment" id="6256862">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256891">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6256903">map</span><span class="op" id="6256906">[</span><span class="ident" id="6256907">driver</span><span class="op" id="6256913">.</span><span class="ident" id="6256914">Stmt</span><span class="op" id="6256918">]</span><span class="builtintype" id="6256919">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6256926">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256947">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6256958">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256964">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6256975">[</span><span class="op" id="6256976">]</span><span class="keyword" id="6256977">func</span><span class="op" id="6256981">(</span><span class="op" id="6256982">)</span>&nbsp;<span class="comment" id="6256984">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257042">dbmuClosed</span>&nbsp;<span class="builtintype" id="6257053">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6257062">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="6257118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6257121">func</span>&nbsp;<span class="op" id="6257126">(</span><span class="ident" id="6257127">dc</span>&nbsp;<span class="op" id="6257130">*</span><span class="ident" id="6257131">driverConn</span><span class="op" id="6257141">)</span>&nbsp;<span class="ident" id="6257143">releaseConn</span><span class="op" id="6257154">(</span><span class="ident" id="6257155">err</span>&nbsp;<span class="builtintype" id="6257159">error</span><span class="op" id="6257164">)</span>&nbsp;<span class="op" id="6257166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257169">dc</span><span class="op" id="6257171">.</span><span class="ident" id="6257172">db</span><span class="op" id="6257174">.</span><span class="ident" id="6257175">putConn</span><span class="op" id="6257182">(</span><span class="ident" id="6257183">dc</span><span class="op" id="6257185">,</span>&nbsp;<span class="ident" id="6257187">err</span><span class="op" id="6257190">)</span><br>
<span class="lineno"></span><span class="op" id="6257192">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6257195">func</span>&nbsp;<span class="op" id="6257200">(</span><span class="ident" id="6257201">dc</span>&nbsp;<span class="op" id="6257204">*</span><span class="ident" id="6257205">driverConn</span><span class="op" id="6257215">)</span>&nbsp;<span class="ident" id="6257217">removeOpenStmt</span><span class="op" id="6257231">(</span><span class="ident" id="6257232">si</span>&nbsp;<span class="ident" id="6257235">driver</span><span class="op" id="6257241">.</span><span class="ident" id="6257242">Stmt</span><span class="op" id="6257246">)</span>&nbsp;<span class="op" id="6257248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257251">dc</span><span class="op" id="6257253">.</span><span class="ident" id="6257254">Lock</span><span class="op" id="6257258">(</span><span class="op" id="6257259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257262">defer</span>&nbsp;<span class="ident" id="6257268">dc</span><span class="op" id="6257270">.</span><span class="ident" id="6257271">Unlock</span><span class="op" id="6257277">(</span><span class="op" id="6257278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6257281">delete</span><span class="op" id="6257287">(</span><span class="ident" id="6257288">dc</span><span class="op" id="6257290">.</span><span class="ident" id="6257291">openStmt</span><span class="op" id="6257299">,</span>&nbsp;<span class="ident" id="6257301">si</span><span class="op" id="6257303">)</span><br>
<span class="lineno">260</span><span class="op" id="6257305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6257308">func</span>&nbsp;<span class="op" id="6257313">(</span><span class="ident" id="6257314">dc</span>&nbsp;<span class="op" id="6257317">*</span><span class="ident" id="6257318">driverConn</span><span class="op" id="6257328">)</span>&nbsp;<span class="ident" id="6257330">prepareLocked</span><span class="op" id="6257343">(</span><span class="ident" id="6257344">query</span>&nbsp;<span class="builtintype" id="6257350">string</span><span class="op" id="6257356">)</span>&nbsp;<span class="op" id="6257358">(</span><span class="ident" id="6257359">driver</span><span class="op" id="6257365">.</span><span class="ident" id="6257366">Stmt</span><span class="op" id="6257370">,</span>&nbsp;<span class="builtintype" id="6257372">error</span><span class="op" id="6257377">)</span>&nbsp;<span class="op" id="6257379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257382">si</span><span class="op" id="6257384">,</span>&nbsp;<span class="ident" id="6257386">err</span>&nbsp;<span class="op" id="6257390">:=</span>&nbsp;<span class="ident" id="6257393">dc</span><span class="op" id="6257395">.</span><span class="ident" id="6257396">ci</span><span class="op" id="6257398">.</span><span class="ident" id="6257399">Prepare</span><span class="op" id="6257406">(</span><span class="ident" id="6257407">query</span><span class="op" id="6257412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257415">if</span>&nbsp;<span class="ident" id="6257418">err</span>&nbsp;<span class="op" id="6257422">==</span>&nbsp;<span class="ident" id="6257425">nil</span>&nbsp;<span class="op" id="6257429">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257433">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257500">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257530">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257535">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257592">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257655">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257712">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257717">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257773">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257822">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257867">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257911">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257960">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258006">if</span>&nbsp;<span class="ident" id="6258009">dc</span><span class="op" id="6258011">.</span><span class="ident" id="6258012">openStmt</span>&nbsp;<span class="op" id="6258021">==</span>&nbsp;<span class="ident" id="6258024">nil</span>&nbsp;<span class="op" id="6258028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258033">dc</span><span class="op" id="6258035">.</span><span class="ident" id="6258036">openStmt</span>&nbsp;<span class="op" id="6258045">=</span>&nbsp;<span class="builtinfunc" id="6258047">make</span><span class="op" id="6258051">(</span><span class="keyword" id="6258052">map</span><span class="op" id="6258055">[</span><span class="ident" id="6258056">driver</span><span class="op" id="6258062">.</span><span class="ident" id="6258063">Stmt</span><span class="op" id="6258067">]</span><span class="builtintype" id="6258068">bool</span><span class="op" id="6258072">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258080">dc</span><span class="op" id="6258082">.</span><span class="ident" id="6258083">openStmt</span><span class="op" id="6258091">[</span><span class="ident" id="6258092">si</span><span class="op" id="6258094">]</span>&nbsp;<span class="op" id="6258096">=</span>&nbsp;<span class="builtintype" id="6258098">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258107">return</span>&nbsp;<span class="ident" id="6258114">si</span><span class="op" id="6258116">,</span>&nbsp;<span class="ident" id="6258118">err</span><br>
<span class="lineno"></span><span class="op" id="6258122">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="6258125">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6258155">func</span>&nbsp;<span class="op" id="6258160">(</span><span class="ident" id="6258161">dc</span>&nbsp;<span class="op" id="6258164">*</span><span class="ident" id="6258165">driverConn</span><span class="op" id="6258175">)</span>&nbsp;<span class="ident" id="6258177">closeDBLocked</span><span class="op" id="6258190">(</span><span class="op" id="6258191">)</span>&nbsp;<span class="keyword" id="6258193">func</span><span class="op" id="6258197">(</span><span class="op" id="6258198">)</span>&nbsp;<span class="builtintype" id="6258200">error</span>&nbsp;<span class="op" id="6258206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258209">dc</span><span class="op" id="6258211">.</span><span class="ident" id="6258212">Lock</span><span class="op" id="6258216">(</span><span class="op" id="6258217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258220">defer</span>&nbsp;<span class="ident" id="6258226">dc</span><span class="op" id="6258228">.</span><span class="ident" id="6258229">Unlock</span><span class="op" id="6258235">(</span><span class="op" id="6258236">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258239">if</span>&nbsp;<span class="ident" id="6258242">dc</span><span class="op" id="6258244">.</span><span class="ident" id="6258245">closed</span>&nbsp;<span class="op" id="6258252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258256">return</span>&nbsp;<span class="keyword" id="6258263">func</span><span class="op" id="6258267">(</span><span class="op" id="6258268">)</span>&nbsp;<span class="builtintype" id="6258270">error</span>&nbsp;<span class="op" id="6258276">{</span>&nbsp;<span class="keyword" id="6258278">return</span>&nbsp;<span class="ident" id="6258285">errors</span><span class="op" id="6258291">.</span><span class="ident" id="6258292">New</span><span class="op" id="6258295">(</span><span class="string" id="6258296">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6258329">)</span>&nbsp;<span class="op" id="6258331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258337">dc</span><span class="op" id="6258339">.</span><span class="ident" id="6258340">closed</span>&nbsp;<span class="op" id="6258347">=</span>&nbsp;<span class="builtintype" id="6258349">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258355">return</span>&nbsp;<span class="ident" id="6258362">dc</span><span class="op" id="6258364">.</span><span class="ident" id="6258365">db</span><span class="op" id="6258367">.</span><span class="ident" id="6258368">removeDepLocked</span><span class="op" id="6258383">(</span><span class="ident" id="6258384">dc</span><span class="op" id="6258386">,</span>&nbsp;<span class="ident" id="6258388">dc</span><span class="op" id="6258390">)</span><br>
<span class="lineno">295</span><span class="op" id="6258392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258395">func</span>&nbsp;<span class="op" id="6258400">(</span><span class="ident" id="6258401">dc</span>&nbsp;<span class="op" id="6258404">*</span><span class="ident" id="6258405">driverConn</span><span class="op" id="6258415">)</span>&nbsp;<span class="ident" id="6258417">Close</span><span class="op" id="6258422">(</span><span class="op" id="6258423">)</span>&nbsp;<span class="builtintype" id="6258425">error</span>&nbsp;<span class="op" id="6258431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258434">dc</span><span class="op" id="6258436">.</span><span class="ident" id="6258437">Lock</span><span class="op" id="6258441">(</span><span class="op" id="6258442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258445">if</span>&nbsp;<span class="ident" id="6258448">dc</span><span class="op" id="6258450">.</span><span class="ident" id="6258451">closed</span>&nbsp;<span class="op" id="6258458">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258462">dc</span><span class="op" id="6258464">.</span><span class="ident" id="6258465">Unlock</span><span class="op" id="6258471">(</span><span class="op" id="6258472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258476">return</span>&nbsp;<span class="ident" id="6258483">errors</span><span class="op" id="6258489">.</span><span class="ident" id="6258490">New</span><span class="op" id="6258493">(</span><span class="string" id="6258494">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="6258527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258533">dc</span><span class="op" id="6258535">.</span><span class="ident" id="6258536">closed</span>&nbsp;<span class="op" id="6258543">=</span>&nbsp;<span class="builtintype" id="6258545">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258551">dc</span><span class="op" id="6258553">.</span><span class="ident" id="6258554">Unlock</span><span class="op" id="6258560">(</span><span class="op" id="6258561">)</span>&nbsp;<span class="comment" id="6258563">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258623">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258676">dc</span><span class="op" id="6258678">.</span><span class="ident" id="6258679">db</span><span class="op" id="6258681">.</span><span class="ident" id="6258682">mu</span><span class="op" id="6258684">.</span><span class="ident" id="6258685">Lock</span><span class="op" id="6258689">(</span><span class="op" id="6258690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258693">dc</span><span class="op" id="6258695">.</span><span class="ident" id="6258696">dbmuClosed</span>&nbsp;<span class="op" id="6258707">=</span>&nbsp;<span class="builtintype" id="6258709">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258715">fn</span>&nbsp;<span class="op" id="6258718">:=</span>&nbsp;<span class="ident" id="6258721">dc</span><span class="op" id="6258723">.</span><span class="ident" id="6258724">db</span><span class="op" id="6258726">.</span><span class="ident" id="6258727">removeDepLocked</span><span class="op" id="6258742">(</span><span class="ident" id="6258743">dc</span><span class="op" id="6258745">,</span>&nbsp;<span class="ident" id="6258747">dc</span><span class="op" id="6258749">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258752">dc</span><span class="op" id="6258754">.</span><span class="ident" id="6258755">db</span><span class="op" id="6258757">.</span><span class="ident" id="6258758">mu</span><span class="op" id="6258760">.</span><span class="ident" id="6258761">Unlock</span><span class="op" id="6258767">(</span><span class="op" id="6258768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258771">return</span>&nbsp;<span class="ident" id="6258778">fn</span><span class="op" id="6258780">(</span><span class="op" id="6258781">)</span><br>
<span class="lineno"></span><span class="op" id="6258783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258786">func</span>&nbsp;<span class="op" id="6258791">(</span><span class="ident" id="6258792">dc</span>&nbsp;<span class="op" id="6258795">*</span><span class="ident" id="6258796">driverConn</span><span class="op" id="6258806">)</span>&nbsp;<span class="ident" id="6258808">finalClose</span><span class="op" id="6258818">(</span><span class="op" id="6258819">)</span>&nbsp;<span class="builtintype" id="6258821">error</span>&nbsp;<span class="op" id="6258827">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258830">dc</span><span class="op" id="6258832">.</span><span class="ident" id="6258833">Lock</span><span class="op" id="6258837">(</span><span class="op" id="6258838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258842">for</span>&nbsp;<span class="ident" id="6258846">si</span>&nbsp;<span class="op" id="6258849">:=</span>&nbsp;<span class="keyword" id="6258852">range</span>&nbsp;<span class="ident" id="6258858">dc</span><span class="op" id="6258860">.</span><span class="ident" id="6258861">openStmt</span>&nbsp;<span class="op" id="6258870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258874">si</span><span class="op" id="6258876">.</span><span class="ident" id="6258877">Close</span><span class="op" id="6258882">(</span><span class="op" id="6258883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258886">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258889">dc</span><span class="op" id="6258891">.</span><span class="ident" id="6258892">openStmt</span>&nbsp;<span class="op" id="6258901">=</span>&nbsp;<span class="ident" id="6258903">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258909">err</span>&nbsp;<span class="op" id="6258913">:=</span>&nbsp;<span class="ident" id="6258916">dc</span><span class="op" id="6258918">.</span><span class="ident" id="6258919">ci</span><span class="op" id="6258921">.</span><span class="ident" id="6258922">Close</span><span class="op" id="6258927">(</span><span class="op" id="6258928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258931">dc</span><span class="op" id="6258933">.</span><span class="ident" id="6258934">ci</span>&nbsp;<span class="op" id="6258937">=</span>&nbsp;<span class="ident" id="6258939">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258944">dc</span><span class="op" id="6258946">.</span><span class="ident" id="6258947">finalClosed</span>&nbsp;<span class="op" id="6258959">=</span>&nbsp;<span class="builtintype" id="6258961">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258967">dc</span><span class="op" id="6258969">.</span><span class="ident" id="6258970">Unlock</span><span class="op" id="6258976">(</span><span class="op" id="6258977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258981">dc</span><span class="op" id="6258983">.</span><span class="ident" id="6258984">db</span><span class="op" id="6258986">.</span><span class="ident" id="6258987">mu</span><span class="op" id="6258989">.</span><span class="ident" id="6258990">Lock</span><span class="op" id="6258994">(</span><span class="op" id="6258995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258998">dc</span><span class="op" id="6259000">.</span><span class="ident" id="6259001">db</span><span class="op" id="6259003">.</span><span class="ident" id="6259004">numOpen</span><span class="op" id="6259011">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259015">dc</span><span class="op" id="6259017">.</span><span class="ident" id="6259018">db</span><span class="op" id="6259020">.</span><span class="ident" id="6259021">maybeOpenNewConnections</span><span class="op" id="6259044">(</span><span class="op" id="6259045">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259048">dc</span><span class="op" id="6259050">.</span><span class="ident" id="6259051">db</span><span class="op" id="6259053">.</span><span class="ident" id="6259054">mu</span><span class="op" id="6259056">.</span><span class="ident" id="6259057">Unlock</span><span class="op" id="6259063">(</span><span class="op" id="6259064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259068">return</span>&nbsp;<span class="ident" id="6259075">err</span><br>
<span class="lineno"></span><span class="op" id="6259079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="6259082">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6259130">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6259197">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="6259219">type</span>&nbsp;<span class="ident" id="6259224">driverStmt</span>&nbsp;<span class="keyword" id="6259235">struct</span>&nbsp;<span class="op" id="6259242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259245">sync</span><span class="op" id="6259249">.</span><span class="ident" id="6259250">Locker</span>&nbsp;<span class="comment" id="6259257">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259277">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259289">driver</span><span class="op" id="6259295">.</span><span class="ident" id="6259296">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6259301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259304">func</span>&nbsp;<span class="op" id="6259309">(</span><span class="ident" id="6259310">ds</span>&nbsp;<span class="op" id="6259313">*</span><span class="ident" id="6259314">driverStmt</span><span class="op" id="6259324">)</span>&nbsp;<span class="ident" id="6259326">Close</span><span class="op" id="6259331">(</span><span class="op" id="6259332">)</span>&nbsp;<span class="builtintype" id="6259334">error</span>&nbsp;<span class="op" id="6259340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259343">ds</span><span class="op" id="6259345">.</span><span class="ident" id="6259346">Lock</span><span class="op" id="6259350">(</span><span class="op" id="6259351">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259354">defer</span>&nbsp;<span class="ident" id="6259360">ds</span><span class="op" id="6259362">.</span><span class="ident" id="6259363">Unlock</span><span class="op" id="6259369">(</span><span class="op" id="6259370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259373">return</span>&nbsp;<span class="ident" id="6259380">ds</span><span class="op" id="6259382">.</span><span class="ident" id="6259383">si</span><span class="op" id="6259385">.</span><span class="ident" id="6259386">Close</span><span class="op" id="6259391">(</span><span class="op" id="6259392">)</span><br>
<span class="lineno"></span><span class="op" id="6259394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6259397">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="6259451">type</span>&nbsp;<span class="ident" id="6259456">depSet</span>&nbsp;<span class="keyword" id="6259463">map</span><span class="op" id="6259466">[</span><span class="keyword" id="6259467">interface</span><span class="op" id="6259476">{</span><span class="op" id="6259477">}</span><span class="op" id="6259478">]</span><span class="builtintype" id="6259479">bool</span>&nbsp;<span class="comment" id="6259484">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6259506">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="6259571">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="6259605">type</span>&nbsp;<span class="ident" id="6259610">finalCloser</span>&nbsp;<span class="keyword" id="6259622">interface</span>&nbsp;<span class="op" id="6259632">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259635">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259698">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259755">finalClose</span><span class="op" id="6259765">(</span><span class="op" id="6259766">)</span>&nbsp;<span class="builtintype" id="6259768">error</span><br>
<span class="lineno"></span><span class="op" id="6259774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="6259777">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6259848">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="6259916">func</span>&nbsp;<span class="op" id="6259921">(</span><span class="ident" id="6259922">db</span>&nbsp;<span class="op" id="6259925">*</span><span class="ident" id="6259926">DB</span><span class="op" id="6259928">)</span>&nbsp;<span class="ident" id="6259930">addDep</span><span class="op" id="6259936">(</span><span class="ident" id="6259937">x</span>&nbsp;<span class="ident" id="6259939">finalCloser</span><span class="op" id="6259950">,</span>&nbsp;<span class="ident" id="6259952">dep</span>&nbsp;<span class="keyword" id="6259956">interface</span><span class="op" id="6259965">{</span><span class="op" id="6259966">}</span><span class="op" id="6259967">)</span>&nbsp;<span class="op" id="6259969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259972">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260036">db</span><span class="op" id="6260038">.</span><span class="ident" id="6260039">mu</span><span class="op" id="6260041">.</span><span class="ident" id="6260042">Lock</span><span class="op" id="6260046">(</span><span class="op" id="6260047">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260050">defer</span>&nbsp;<span class="ident" id="6260056">db</span><span class="op" id="6260058">.</span><span class="ident" id="6260059">mu</span><span class="op" id="6260061">.</span><span class="ident" id="6260062">Unlock</span><span class="op" id="6260068">(</span><span class="op" id="6260069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260072">db</span><span class="op" id="6260074">.</span><span class="ident" id="6260075">addDepLocked</span><span class="op" id="6260087">(</span><span class="ident" id="6260088">x</span><span class="op" id="6260089">,</span>&nbsp;<span class="ident" id="6260091">dep</span><span class="op" id="6260094">)</span><br>
<span class="lineno"></span><span class="op" id="6260096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260099">func</span>&nbsp;<span class="op" id="6260104">(</span><span class="ident" id="6260105">db</span>&nbsp;<span class="op" id="6260108">*</span><span class="ident" id="6260109">DB</span><span class="op" id="6260111">)</span>&nbsp;<span class="ident" id="6260113">addDepLocked</span><span class="op" id="6260125">(</span><span class="ident" id="6260126">x</span>&nbsp;<span class="ident" id="6260128">finalCloser</span><span class="op" id="6260139">,</span>&nbsp;<span class="ident" id="6260141">dep</span>&nbsp;<span class="keyword" id="6260145">interface</span><span class="op" id="6260154">{</span><span class="op" id="6260155">}</span><span class="op" id="6260156">)</span>&nbsp;<span class="op" id="6260158">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260161">if</span>&nbsp;<span class="ident" id="6260164">db</span><span class="op" id="6260166">.</span><span class="ident" id="6260167">dep</span>&nbsp;<span class="op" id="6260171">==</span>&nbsp;<span class="ident" id="6260174">nil</span>&nbsp;<span class="op" id="6260178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260182">db</span><span class="op" id="6260184">.</span><span class="ident" id="6260185">dep</span>&nbsp;<span class="op" id="6260189">=</span>&nbsp;<span class="builtinfunc" id="6260191">make</span><span class="op" id="6260195">(</span><span class="keyword" id="6260196">map</span><span class="op" id="6260199">[</span><span class="ident" id="6260200">finalCloser</span><span class="op" id="6260211">]</span><span class="ident" id="6260212">depSet</span><span class="op" id="6260218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260224">xdep</span>&nbsp;<span class="op" id="6260229">:=</span>&nbsp;<span class="ident" id="6260232">db</span><span class="op" id="6260234">.</span><span class="ident" id="6260235">dep</span><span class="op" id="6260238">[</span><span class="ident" id="6260239">x</span><span class="op" id="6260240">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260243">if</span>&nbsp;<span class="ident" id="6260246">xdep</span>&nbsp;<span class="op" id="6260251">==</span>&nbsp;<span class="ident" id="6260254">nil</span>&nbsp;<span class="op" id="6260258">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260262">xdep</span>&nbsp;<span class="op" id="6260267">=</span>&nbsp;<span class="builtinfunc" id="6260269">make</span><span class="op" id="6260273">(</span><span class="ident" id="6260274">depSet</span><span class="op" id="6260280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260284">db</span><span class="op" id="6260286">.</span><span class="ident" id="6260287">dep</span><span class="op" id="6260290">[</span><span class="ident" id="6260291">x</span><span class="op" id="6260292">]</span>&nbsp;<span class="op" id="6260294">=</span>&nbsp;<span class="ident" id="6260296">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260305">xdep</span><span class="op" id="6260309">[</span><span class="ident" id="6260310">dep</span><span class="op" id="6260313">]</span>&nbsp;<span class="op" id="6260315">=</span>&nbsp;<span class="builtintype" id="6260317">true</span><br>
<span class="lineno"></span><span class="op" id="6260322">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6260325">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="6260377">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="6260426">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6260496">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="6260544">func</span>&nbsp;<span class="op" id="6260549">(</span><span class="ident" id="6260550">db</span>&nbsp;<span class="op" id="6260553">*</span><span class="ident" id="6260554">DB</span><span class="op" id="6260556">)</span>&nbsp;<span class="ident" id="6260558">removeDep</span><span class="op" id="6260567">(</span><span class="ident" id="6260568">x</span>&nbsp;<span class="ident" id="6260570">finalCloser</span><span class="op" id="6260581">,</span>&nbsp;<span class="ident" id="6260583">dep</span>&nbsp;<span class="keyword" id="6260587">interface</span><span class="op" id="6260596">{</span><span class="op" id="6260597">}</span><span class="op" id="6260598">)</span>&nbsp;<span class="builtintype" id="6260600">error</span>&nbsp;<span class="op" id="6260606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260609">db</span><span class="op" id="6260611">.</span><span class="ident" id="6260612">mu</span><span class="op" id="6260614">.</span><span class="ident" id="6260615">Lock</span><span class="op" id="6260619">(</span><span class="op" id="6260620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260623">fn</span>&nbsp;<span class="op" id="6260626">:=</span>&nbsp;<span class="ident" id="6260629">db</span><span class="op" id="6260631">.</span><span class="ident" id="6260632">removeDepLocked</span><span class="op" id="6260647">(</span><span class="ident" id="6260648">x</span><span class="op" id="6260649">,</span>&nbsp;<span class="ident" id="6260651">dep</span><span class="op" id="6260654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260657">db</span><span class="op" id="6260659">.</span><span class="ident" id="6260660">mu</span><span class="op" id="6260662">.</span><span class="ident" id="6260663">Unlock</span><span class="op" id="6260669">(</span><span class="op" id="6260670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260673">return</span>&nbsp;<span class="ident" id="6260680">fn</span><span class="op" id="6260682">(</span><span class="op" id="6260683">)</span><br>
<span class="lineno">390</span><span class="op" id="6260685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260688">func</span>&nbsp;<span class="op" id="6260693">(</span><span class="ident" id="6260694">db</span>&nbsp;<span class="op" id="6260697">*</span><span class="ident" id="6260698">DB</span><span class="op" id="6260700">)</span>&nbsp;<span class="ident" id="6260702">removeDepLocked</span><span class="op" id="6260717">(</span><span class="ident" id="6260718">x</span>&nbsp;<span class="ident" id="6260720">finalCloser</span><span class="op" id="6260731">,</span>&nbsp;<span class="ident" id="6260733">dep</span>&nbsp;<span class="keyword" id="6260737">interface</span><span class="op" id="6260746">{</span><span class="op" id="6260747">}</span><span class="op" id="6260748">)</span>&nbsp;<span class="keyword" id="6260750">func</span><span class="op" id="6260754">(</span><span class="op" id="6260755">)</span>&nbsp;<span class="builtintype" id="6260757">error</span>&nbsp;<span class="op" id="6260763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6260766">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260834">xdep</span><span class="op" id="6260838">,</span>&nbsp;<span class="ident" id="6260840">ok</span>&nbsp;<span class="op" id="6260843">:=</span>&nbsp;<span class="ident" id="6260846">db</span><span class="op" id="6260848">.</span><span class="ident" id="6260849">dep</span><span class="op" id="6260852">[</span><span class="ident" id="6260853">x</span><span class="op" id="6260854">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260857">if</span>&nbsp;<span class="op" id="6260860">!</span><span class="ident" id="6260861">ok</span>&nbsp;<span class="op" id="6260864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6260868">panic</span><span class="op" id="6260873">(</span><span class="ident" id="6260874">fmt</span><span class="op" id="6260877">.</span><span class="ident" id="6260878">Sprintf</span><span class="op" id="6260885">(</span><span class="string" id="6260886">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="6260922">,</span>&nbsp;<span class="ident" id="6260924">x</span><span class="op" id="6260925">)</span><span class="op" id="6260926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260933">l0</span>&nbsp;<span class="op" id="6260936">:=</span>&nbsp;<span class="builtinfunc" id="6260939">len</span><span class="op" id="6260942">(</span><span class="ident" id="6260943">xdep</span><span class="op" id="6260947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6260950">delete</span><span class="op" id="6260956">(</span><span class="ident" id="6260957">xdep</span><span class="op" id="6260961">,</span>&nbsp;<span class="ident" id="6260963">dep</span><span class="op" id="6260966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260970">switch</span>&nbsp;<span class="builtinfunc" id="6260977">len</span><span class="op" id="6260980">(</span><span class="ident" id="6260981">xdep</span><span class="op" id="6260985">)</span>&nbsp;<span class="op" id="6260987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260990">case</span>&nbsp;<span class="ident" id="6260995">l0</span><span class="op" id="6260997">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6261001">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6261041">panic</span><span class="op" id="6261046">(</span><span class="ident" id="6261047">fmt</span><span class="op" id="6261050">.</span><span class="ident" id="6261051">Sprintf</span><span class="op" id="6261058">(</span><span class="string" id="6261059">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="6261096">,</span>&nbsp;<span class="ident" id="6261098">dep</span><span class="op" id="6261101">,</span>&nbsp;<span class="ident" id="6261103">x</span><span class="op" id="6261104">)</span><span class="op" id="6261105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261108">case</span>&nbsp;<span class="num" id="6261113">0</span><span class="op" id="6261114">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6261118">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6261145">delete</span><span class="op" id="6261151">(</span><span class="ident" id="6261152">db</span><span class="op" id="6261154">.</span><span class="ident" id="6261155">dep</span><span class="op" id="6261158">,</span>&nbsp;<span class="ident" id="6261160">x</span><span class="op" id="6261161">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261165">return</span>&nbsp;<span class="ident" id="6261172">x</span><span class="op" id="6261173">.</span><span class="ident" id="6261174">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261186">default</span><span class="op" id="6261193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6261197">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261223">return</span>&nbsp;<span class="keyword" id="6261230">func</span><span class="op" id="6261234">(</span><span class="op" id="6261235">)</span>&nbsp;<span class="builtintype" id="6261237">error</span>&nbsp;<span class="op" id="6261243">{</span>&nbsp;<span class="keyword" id="6261245">return</span>&nbsp;<span class="ident" id="6261252">nil</span>&nbsp;<span class="op" id="6261256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6261259">}</span><br>
<span class="lineno">415</span><span class="op" id="6261261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6261264">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="6261336">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6261398">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="6261462">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="6261539">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6261615">var</span>&nbsp;<span class="ident" id="6261619">connectionRequestQueueSize</span>&nbsp;<span class="op" id="6261646">=</span>&nbsp;<span class="num" id="6261648">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6261657">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="6261726">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6261796">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="6261841">//</span><br>
<span class="lineno"></span><span class="comment" id="6261844">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6261912">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="6261984">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6262054">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="6262088">//</span><br>
<span class="lineno"></span><span class="comment" id="6262091">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6262161">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="6262232">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="6262241">//</span><br>
<span class="lineno"></span><span class="comment" id="6262244">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="6262313">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="6262379">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="6262445">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="6262460">func</span>&nbsp;<span class="ident" id="6262465">Open</span><span class="op" id="6262469">(</span><span class="ident" id="6262470">driverName</span><span class="op" id="6262480">,</span>&nbsp;<span class="ident" id="6262482">dataSourceName</span>&nbsp;<span class="builtintype" id="6262497">string</span><span class="op" id="6262503">)</span>&nbsp;<span class="op" id="6262505">(</span><span class="op" id="6262506">*</span><span class="ident" id="6262507">DB</span><span class="op" id="6262509">,</span>&nbsp;<span class="builtintype" id="6262511">error</span><span class="op" id="6262516">)</span>&nbsp;<span class="op" id="6262518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262521">driveri</span><span class="op" id="6262528">,</span>&nbsp;<span class="ident" id="6262530">ok</span>&nbsp;<span class="op" id="6262533">:=</span>&nbsp;<span class="ident" id="6262536">drivers</span><span class="op" id="6262543">[</span><span class="ident" id="6262544">driverName</span><span class="op" id="6262554">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262557">if</span>&nbsp;<span class="op" id="6262560">!</span><span class="ident" id="6262561">ok</span>&nbsp;<span class="op" id="6262564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262568">return</span>&nbsp;<span class="ident" id="6262575">nil</span><span class="op" id="6262578">,</span>&nbsp;<span class="ident" id="6262580">fmt</span><span class="op" id="6262583">.</span><span class="ident" id="6262584">Errorf</span><span class="op" id="6262590">(</span><span class="string" id="6262591">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="6262635">,</span>&nbsp;<span class="ident" id="6262637">driverName</span><span class="op" id="6262647">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6262650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262653">db</span>&nbsp;<span class="op" id="6262656">:=</span>&nbsp;<span class="op" id="6262659">&amp;</span><span class="ident" id="6262660">DB</span><span class="op" id="6262662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262666">driver</span><span class="op" id="6262672">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6262676">driveri</span><span class="op" id="6262683">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262687">dsn</span><span class="op" id="6262690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262697">dataSourceName</span><span class="op" id="6262711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262715">openerCh</span><span class="op" id="6262723">:</span>&nbsp;<span class="builtinfunc" id="6262725">make</span><span class="op" id="6262729">(</span><span class="keyword" id="6262730">chan</span>&nbsp;<span class="keyword" id="6262735">struct</span><span class="op" id="6262741">{</span><span class="op" id="6262742">}</span><span class="op" id="6262743">,</span>&nbsp;<span class="ident" id="6262745">connectionRequestQueueSize</span><span class="op" id="6262771">)</span><span class="op" id="6262772">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262776">lastPut</span><span class="op" id="6262783">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6262786">make</span><span class="op" id="6262790">(</span><span class="keyword" id="6262791">map</span><span class="op" id="6262794">[</span><span class="op" id="6262795">*</span><span class="ident" id="6262796">driverConn</span><span class="op" id="6262806">]</span><span class="builtintype" id="6262807">string</span><span class="op" id="6262813">)</span><span class="op" id="6262814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6262817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262820">go</span>&nbsp;<span class="ident" id="6262823">db</span><span class="op" id="6262825">.</span><span class="ident" id="6262826">connectionOpener</span><span class="op" id="6262842">(</span><span class="op" id="6262843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262846">return</span>&nbsp;<span class="ident" id="6262853">db</span><span class="op" id="6262855">,</span>&nbsp;<span class="ident" id="6262857">nil</span><br>
<span class="lineno"></span><span class="op" id="6262861">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="6262864">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="6262926">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="6262969">func</span>&nbsp;<span class="op" id="6262974">(</span><span class="ident" id="6262975">db</span>&nbsp;<span class="op" id="6262978">*</span><span class="ident" id="6262979">DB</span><span class="op" id="6262981">)</span>&nbsp;<span class="ident" id="6262983">Ping</span><span class="op" id="6262987">(</span><span class="op" id="6262988">)</span>&nbsp;<span class="builtintype" id="6262990">error</span>&nbsp;<span class="op" id="6262996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6262999">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6263062">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6263121">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263135">dc</span><span class="op" id="6263137">,</span>&nbsp;<span class="ident" id="6263139">err</span>&nbsp;<span class="op" id="6263143">:=</span>&nbsp;<span class="ident" id="6263146">db</span><span class="op" id="6263148">.</span><span class="ident" id="6263149">conn</span><span class="op" id="6263153">(</span><span class="op" id="6263154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263157">if</span>&nbsp;<span class="ident" id="6263160">err</span>&nbsp;<span class="op" id="6263164">!=</span>&nbsp;<span class="ident" id="6263167">nil</span>&nbsp;<span class="op" id="6263171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263175">return</span>&nbsp;<span class="ident" id="6263182">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263190">db</span><span class="op" id="6263192">.</span><span class="ident" id="6263193">putConn</span><span class="op" id="6263200">(</span><span class="ident" id="6263201">dc</span><span class="op" id="6263203">,</span>&nbsp;<span class="ident" id="6263205">nil</span><span class="op" id="6263208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263211">return</span>&nbsp;<span class="ident" id="6263218">nil</span><br>
<span class="lineno"></span><span class="op" id="6263222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="6263225">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="6263285">//</span><br>
<span class="lineno"></span><span class="comment" id="6263288">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6263349">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6263399">func</span>&nbsp;<span class="op" id="6263404">(</span><span class="ident" id="6263405">db</span>&nbsp;<span class="op" id="6263408">*</span><span class="ident" id="6263409">DB</span><span class="op" id="6263411">)</span>&nbsp;<span class="ident" id="6263413">Close</span><span class="op" id="6263418">(</span><span class="op" id="6263419">)</span>&nbsp;<span class="builtintype" id="6263421">error</span>&nbsp;<span class="op" id="6263427">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263430">db</span><span class="op" id="6263432">.</span><span class="ident" id="6263433">mu</span><span class="op" id="6263435">.</span><span class="ident" id="6263436">Lock</span><span class="op" id="6263440">(</span><span class="op" id="6263441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263444">if</span>&nbsp;<span class="ident" id="6263447">db</span><span class="op" id="6263449">.</span><span class="ident" id="6263450">closed</span>&nbsp;<span class="op" id="6263457">{</span>&nbsp;<span class="comment" id="6263459">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263489">db</span><span class="op" id="6263491">.</span><span class="ident" id="6263492">mu</span><span class="op" id="6263494">.</span><span class="ident" id="6263495">Unlock</span><span class="op" id="6263501">(</span><span class="op" id="6263502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263506">return</span>&nbsp;<span class="ident" id="6263513">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263518">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6263521">close</span><span class="op" id="6263526">(</span><span class="ident" id="6263527">db</span><span class="op" id="6263529">.</span><span class="ident" id="6263530">openerCh</span><span class="op" id="6263538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263541">var</span>&nbsp;<span class="ident" id="6263545">err</span>&nbsp;<span class="builtintype" id="6263549">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263556">fns</span>&nbsp;<span class="op" id="6263560">:=</span>&nbsp;<span class="builtinfunc" id="6263563">make</span><span class="op" id="6263567">(</span><span class="op" id="6263568">[</span><span class="op" id="6263569">]</span><span class="keyword" id="6263570">func</span><span class="op" id="6263574">(</span><span class="op" id="6263575">)</span>&nbsp;<span class="builtintype" id="6263577">error</span><span class="op" id="6263582">,</span>&nbsp;<span class="num" id="6263584">0</span><span class="op" id="6263585">,</span>&nbsp;<span class="builtinfunc" id="6263587">len</span><span class="op" id="6263590">(</span><span class="ident" id="6263591">db</span><span class="op" id="6263593">.</span><span class="ident" id="6263594">freeConn</span><span class="op" id="6263602">)</span><span class="op" id="6263603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263606">for</span>&nbsp;<span class="ident" id="6263610">_</span><span class="op" id="6263611">,</span>&nbsp;<span class="ident" id="6263613">dc</span>&nbsp;<span class="op" id="6263616">:=</span>&nbsp;<span class="keyword" id="6263619">range</span>&nbsp;<span class="ident" id="6263625">db</span><span class="op" id="6263627">.</span><span class="ident" id="6263628">freeConn</span>&nbsp;<span class="op" id="6263637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263641">fns</span>&nbsp;<span class="op" id="6263645">=</span>&nbsp;<span class="builtinfunc" id="6263647">append</span><span class="op" id="6263653">(</span><span class="ident" id="6263654">fns</span><span class="op" id="6263657">,</span>&nbsp;<span class="ident" id="6263659">dc</span><span class="op" id="6263661">.</span><span class="ident" id="6263662">closeDBLocked</span><span class="op" id="6263675">(</span><span class="op" id="6263676">)</span><span class="op" id="6263677">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263683">db</span><span class="op" id="6263685">.</span><span class="ident" id="6263686">freeConn</span>&nbsp;<span class="op" id="6263695">=</span>&nbsp;<span class="ident" id="6263697">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263702">db</span><span class="op" id="6263704">.</span><span class="ident" id="6263705">closed</span>&nbsp;<span class="op" id="6263712">=</span>&nbsp;<span class="builtintype" id="6263714">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263720">for</span>&nbsp;<span class="ident" id="6263724">_</span><span class="op" id="6263725">,</span>&nbsp;<span class="ident" id="6263727">req</span>&nbsp;<span class="op" id="6263731">:=</span>&nbsp;<span class="keyword" id="6263734">range</span>&nbsp;<span class="ident" id="6263740">db</span><span class="op" id="6263742">.</span><span class="ident" id="6263743">connRequests</span>&nbsp;<span class="op" id="6263756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6263760">close</span><span class="op" id="6263765">(</span><span class="ident" id="6263766">req</span><span class="op" id="6263769">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263775">db</span><span class="op" id="6263777">.</span><span class="ident" id="6263778">mu</span><span class="op" id="6263780">.</span><span class="ident" id="6263781">Unlock</span><span class="op" id="6263787">(</span><span class="op" id="6263788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263791">for</span>&nbsp;<span class="ident" id="6263795">_</span><span class="op" id="6263796">,</span>&nbsp;<span class="ident" id="6263798">fn</span>&nbsp;<span class="op" id="6263801">:=</span>&nbsp;<span class="keyword" id="6263804">range</span>&nbsp;<span class="ident" id="6263810">fns</span>&nbsp;<span class="op" id="6263814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263818">err1</span>&nbsp;<span class="op" id="6263823">:=</span>&nbsp;<span class="ident" id="6263826">fn</span><span class="op" id="6263828">(</span><span class="op" id="6263829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263833">if</span>&nbsp;<span class="ident" id="6263836">err1</span>&nbsp;<span class="op" id="6263841">!=</span>&nbsp;<span class="ident" id="6263844">nil</span>&nbsp;<span class="op" id="6263848">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263853">err</span>&nbsp;<span class="op" id="6263857">=</span>&nbsp;<span class="ident" id="6263859">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6263869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263872">return</span>&nbsp;<span class="ident" id="6263879">err</span><br>
<span class="lineno"></span><span class="op" id="6263883">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6263886">const</span>&nbsp;<span class="ident" id="6263892">defaultMaxIdleConns</span>&nbsp;<span class="op" id="6263912">=</span>&nbsp;<span class="num" id="6263914">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6263917">func</span>&nbsp;<span class="op" id="6263922">(</span><span class="ident" id="6263923">db</span>&nbsp;<span class="op" id="6263926">*</span><span class="ident" id="6263927">DB</span><span class="op" id="6263929">)</span>&nbsp;<span class="ident" id="6263931">maxIdleConnsLocked</span><span class="op" id="6263949">(</span><span class="op" id="6263950">)</span>&nbsp;<span class="builtintype" id="6263952">int</span>&nbsp;<span class="op" id="6263956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6263959">n</span>&nbsp;<span class="op" id="6263961">:=</span>&nbsp;<span class="ident" id="6263964">db</span><span class="op" id="6263966">.</span><span class="ident" id="6263967">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263976">switch</span>&nbsp;<span class="op" id="6263983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6263986">case</span>&nbsp;<span class="ident" id="6263991">n</span>&nbsp;<span class="op" id="6263993">==</span>&nbsp;<span class="num" id="6263996">0</span><span class="op" id="6263997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6264001">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264075">return</span>&nbsp;<span class="ident" id="6264082">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264103">case</span>&nbsp;<span class="ident" id="6264108">n</span>&nbsp;<span class="op" id="6264110">&lt;</span>&nbsp;<span class="num" id="6264112">0</span><span class="op" id="6264113">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264117">return</span>&nbsp;<span class="num" id="6264124">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264127">default</span><span class="op" id="6264134">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264138">return</span>&nbsp;<span class="ident" id="6264145">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264148">}</span><br>
<span class="lineno"></span><span class="op" id="6264150">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="6264153">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6264223">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="6264243">//</span><br>
<span class="lineno"></span><span class="comment" id="6264246">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="6264318">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6264395">//</span><br>
<span class="lineno"></span><span class="comment" id="6264398">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="6264446">func</span>&nbsp;<span class="op" id="6264451">(</span><span class="ident" id="6264452">db</span>&nbsp;<span class="op" id="6264455">*</span><span class="ident" id="6264456">DB</span><span class="op" id="6264458">)</span>&nbsp;<span class="ident" id="6264460">SetMaxIdleConns</span><span class="op" id="6264475">(</span><span class="ident" id="6264476">n</span>&nbsp;<span class="builtintype" id="6264478">int</span><span class="op" id="6264481">)</span>&nbsp;<span class="op" id="6264483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264486">db</span><span class="op" id="6264488">.</span><span class="ident" id="6264489">mu</span><span class="op" id="6264491">.</span><span class="ident" id="6264492">Lock</span><span class="op" id="6264496">(</span><span class="op" id="6264497">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264500">if</span>&nbsp;<span class="ident" id="6264503">n</span>&nbsp;<span class="op" id="6264505">&gt;</span>&nbsp;<span class="num" id="6264507">0</span>&nbsp;<span class="op" id="6264509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264513">db</span><span class="op" id="6264515">.</span><span class="ident" id="6264516">maxIdle</span>&nbsp;<span class="op" id="6264524">=</span>&nbsp;<span class="ident" id="6264526">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264529">}</span>&nbsp;<span class="keyword" id="6264531">else</span>&nbsp;<span class="op" id="6264536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6264540">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264566">db</span><span class="op" id="6264568">.</span><span class="ident" id="6264569">maxIdle</span>&nbsp;<span class="op" id="6264577">=</span>&nbsp;<span class="op" id="6264579">-</span><span class="num" id="6264580">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6264586">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264631">if</span>&nbsp;<span class="ident" id="6264634">db</span><span class="op" id="6264636">.</span><span class="ident" id="6264637">maxOpen</span>&nbsp;<span class="op" id="6264645">&gt;</span>&nbsp;<span class="num" id="6264647">0</span>&nbsp;<span class="op" id="6264649">&amp;&amp;</span>&nbsp;<span class="ident" id="6264652">db</span><span class="op" id="6264654">.</span><span class="ident" id="6264655">maxIdleConnsLocked</span><span class="op" id="6264673">(</span><span class="op" id="6264674">)</span>&nbsp;<span class="op" id="6264676">&gt;</span>&nbsp;<span class="ident" id="6264678">db</span><span class="op" id="6264680">.</span><span class="ident" id="6264681">maxOpen</span>&nbsp;<span class="op" id="6264689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264693">db</span><span class="op" id="6264695">.</span><span class="ident" id="6264696">maxIdle</span>&nbsp;<span class="op" id="6264704">=</span>&nbsp;<span class="ident" id="6264706">db</span><span class="op" id="6264708">.</span><span class="ident" id="6264709">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264718">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264721">var</span>&nbsp;<span class="ident" id="6264725">closing</span>&nbsp;<span class="op" id="6264733">[</span><span class="op" id="6264734">]</span><span class="op" id="6264735">*</span><span class="ident" id="6264736">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264748">idleCount</span>&nbsp;<span class="op" id="6264758">:=</span>&nbsp;<span class="builtinfunc" id="6264761">len</span><span class="op" id="6264764">(</span><span class="ident" id="6264765">db</span><span class="op" id="6264767">.</span><span class="ident" id="6264768">freeConn</span><span class="op" id="6264776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264779">maxIdle</span>&nbsp;<span class="op" id="6264787">:=</span>&nbsp;<span class="ident" id="6264790">db</span><span class="op" id="6264792">.</span><span class="ident" id="6264793">maxIdleConnsLocked</span><span class="op" id="6264811">(</span><span class="op" id="6264812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264815">if</span>&nbsp;<span class="ident" id="6264818">idleCount</span>&nbsp;<span class="op" id="6264828">&gt;</span>&nbsp;<span class="ident" id="6264830">maxIdle</span>&nbsp;<span class="op" id="6264838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264842">closing</span>&nbsp;<span class="op" id="6264850">=</span>&nbsp;<span class="ident" id="6264852">db</span><span class="op" id="6264854">.</span><span class="ident" id="6264855">freeConn</span><span class="op" id="6264863">[</span><span class="ident" id="6264864">maxIdle</span><span class="op" id="6264871">:</span><span class="op" id="6264872">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264876">db</span><span class="op" id="6264878">.</span><span class="ident" id="6264879">freeConn</span>&nbsp;<span class="op" id="6264888">=</span>&nbsp;<span class="ident" id="6264890">db</span><span class="op" id="6264892">.</span><span class="ident" id="6264893">freeConn</span><span class="op" id="6264901">[</span><span class="op" id="6264902">:</span><span class="ident" id="6264903">maxIdle</span><span class="op" id="6264910">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264916">db</span><span class="op" id="6264918">.</span><span class="ident" id="6264919">mu</span><span class="op" id="6264921">.</span><span class="ident" id="6264922">Unlock</span><span class="op" id="6264928">(</span><span class="op" id="6264929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6264932">for</span>&nbsp;<span class="ident" id="6264936">_</span><span class="op" id="6264937">,</span>&nbsp;<span class="ident" id="6264939">c</span>&nbsp;<span class="op" id="6264941">:=</span>&nbsp;<span class="keyword" id="6264944">range</span>&nbsp;<span class="ident" id="6264950">closing</span>&nbsp;<span class="op" id="6264958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6264962">c</span><span class="op" id="6264963">.</span><span class="ident" id="6264964">Close</span><span class="op" id="6264969">(</span><span class="op" id="6264970">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6264973">}</span><br>
<span class="lineno"></span><span class="op" id="6264975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6264978">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="6265058">//</span><br>
<span class="lineno">550</span><span class="comment" id="6265061">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="6265136">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6265204">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="6265226">//</span><br>
<span class="lineno"></span><span class="comment" id="6265229">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="6265301">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="6265334">func</span>&nbsp;<span class="op" id="6265339">(</span><span class="ident" id="6265340">db</span>&nbsp;<span class="op" id="6265343">*</span><span class="ident" id="6265344">DB</span><span class="op" id="6265346">)</span>&nbsp;<span class="ident" id="6265348">SetMaxOpenConns</span><span class="op" id="6265363">(</span><span class="ident" id="6265364">n</span>&nbsp;<span class="builtintype" id="6265366">int</span><span class="op" id="6265369">)</span>&nbsp;<span class="op" id="6265371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265374">db</span><span class="op" id="6265376">.</span><span class="ident" id="6265377">mu</span><span class="op" id="6265379">.</span><span class="ident" id="6265380">Lock</span><span class="op" id="6265384">(</span><span class="op" id="6265385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265388">db</span><span class="op" id="6265390">.</span><span class="ident" id="6265391">maxOpen</span>&nbsp;<span class="op" id="6265399">=</span>&nbsp;<span class="ident" id="6265401">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6265404">if</span>&nbsp;<span class="ident" id="6265407">n</span>&nbsp;<span class="op" id="6265409">&lt;</span>&nbsp;<span class="num" id="6265411">0</span>&nbsp;<span class="op" id="6265413">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265417">db</span><span class="op" id="6265419">.</span><span class="ident" id="6265420">maxOpen</span>&nbsp;<span class="op" id="6265428">=</span>&nbsp;<span class="num" id="6265430">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6265433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265436">syncMaxIdle</span>&nbsp;<span class="op" id="6265448">:=</span>&nbsp;<span class="ident" id="6265451">db</span><span class="op" id="6265453">.</span><span class="ident" id="6265454">maxOpen</span>&nbsp;<span class="op" id="6265462">&gt;</span>&nbsp;<span class="num" id="6265464">0</span>&nbsp;<span class="op" id="6265466">&amp;&amp;</span>&nbsp;<span class="ident" id="6265469">db</span><span class="op" id="6265471">.</span><span class="ident" id="6265472">maxIdleConnsLocked</span><span class="op" id="6265490">(</span><span class="op" id="6265491">)</span>&nbsp;<span class="op" id="6265493">&gt;</span>&nbsp;<span class="ident" id="6265495">db</span><span class="op" id="6265497">.</span><span class="ident" id="6265498">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265507">db</span><span class="op" id="6265509">.</span><span class="ident" id="6265510">mu</span><span class="op" id="6265512">.</span><span class="ident" id="6265513">Unlock</span><span class="op" id="6265519">(</span><span class="op" id="6265520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6265523">if</span>&nbsp;<span class="ident" id="6265526">syncMaxIdle</span>&nbsp;<span class="op" id="6265538">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265542">db</span><span class="op" id="6265544">.</span><span class="ident" id="6265545">SetMaxIdleConns</span><span class="op" id="6265560">(</span><span class="ident" id="6265561">n</span><span class="op" id="6265562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6265565">}</span><br>
<span class="lineno"></span><span class="op" id="6265567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6265570">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="6265598">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="6265673">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="6265732">func</span>&nbsp;<span class="op" id="6265737">(</span><span class="ident" id="6265738">db</span>&nbsp;<span class="op" id="6265741">*</span><span class="ident" id="6265742">DB</span><span class="op" id="6265744">)</span>&nbsp;<span class="ident" id="6265746">maybeOpenNewConnections</span><span class="op" id="6265769">(</span><span class="op" id="6265770">)</span>&nbsp;<span class="op" id="6265772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265775">numRequests</span>&nbsp;<span class="op" id="6265787">:=</span>&nbsp;<span class="builtinfunc" id="6265790">len</span><span class="op" id="6265793">(</span><span class="ident" id="6265794">db</span><span class="op" id="6265796">.</span><span class="ident" id="6265797">connRequests</span><span class="op" id="6265809">)</span>&nbsp;<span class="op" id="6265811">-</span>&nbsp;<span class="ident" id="6265813">db</span><span class="op" id="6265815">.</span><span class="ident" id="6265816">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6265830">if</span>&nbsp;<span class="ident" id="6265833">db</span><span class="op" id="6265835">.</span><span class="ident" id="6265836">maxOpen</span>&nbsp;<span class="op" id="6265844">&gt;</span>&nbsp;<span class="num" id="6265846">0</span>&nbsp;<span class="op" id="6265848">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265852">numCanOpen</span>&nbsp;<span class="op" id="6265863">:=</span>&nbsp;<span class="ident" id="6265866">db</span><span class="op" id="6265868">.</span><span class="ident" id="6265869">maxOpen</span>&nbsp;<span class="op" id="6265877">-</span>&nbsp;<span class="op" id="6265879">(</span><span class="ident" id="6265880">db</span><span class="op" id="6265882">.</span><span class="ident" id="6265883">numOpen</span>&nbsp;<span class="op" id="6265891">+</span>&nbsp;<span class="ident" id="6265893">db</span><span class="op" id="6265895">.</span><span class="ident" id="6265896">pendingOpens</span><span class="op" id="6265908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6265912">if</span>&nbsp;<span class="ident" id="6265915">numRequests</span>&nbsp;<span class="op" id="6265927">&gt;</span>&nbsp;<span class="ident" id="6265929">numCanOpen</span>&nbsp;<span class="op" id="6265940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6265945">numRequests</span>&nbsp;<span class="op" id="6265957">=</span>&nbsp;<span class="ident" id="6265959">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6265972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6265975">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6265978">for</span>&nbsp;<span class="ident" id="6265982">numRequests</span>&nbsp;<span class="op" id="6265994">&gt;</span>&nbsp;<span class="num" id="6265996">0</span>&nbsp;<span class="op" id="6265998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266002">db</span><span class="op" id="6266004">.</span><span class="ident" id="6266005">pendingOpens</span><span class="op" id="6266017">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266022">numRequests</span><span class="op" id="6266033">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266038">db</span><span class="op" id="6266040">.</span><span class="ident" id="6266041">openerCh</span>&nbsp;<span class="op" id="6266050">&lt;-</span>&nbsp;<span class="keyword" id="6266053">struct</span><span class="op" id="6266059">{</span><span class="op" id="6266060">}</span><span class="op" id="6266061">{</span><span class="op" id="6266062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266065">}</span><br>
<span class="lineno">585</span><span class="op" id="6266067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6266070">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="6266141">func</span>&nbsp;<span class="op" id="6266146">(</span><span class="ident" id="6266147">db</span>&nbsp;<span class="op" id="6266150">*</span><span class="ident" id="6266151">DB</span><span class="op" id="6266153">)</span>&nbsp;<span class="ident" id="6266155">connectionOpener</span><span class="op" id="6266171">(</span><span class="op" id="6266172">)</span>&nbsp;<span class="op" id="6266174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266177">for</span>&nbsp;<span class="keyword" id="6266181">range</span>&nbsp;<span class="ident" id="6266187">db</span><span class="op" id="6266189">.</span><span class="ident" id="6266190">openerCh</span>&nbsp;<span class="op" id="6266199">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266203">db</span><span class="op" id="6266205">.</span><span class="ident" id="6266206">openNewConnection</span><span class="op" id="6266223">(</span><span class="op" id="6266224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266227">}</span><br>
<span class="lineno"></span><span class="op" id="6266229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6266232">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="6266259">func</span>&nbsp;<span class="op" id="6266264">(</span><span class="ident" id="6266265">db</span>&nbsp;<span class="op" id="6266268">*</span><span class="ident" id="6266269">DB</span><span class="op" id="6266271">)</span>&nbsp;<span class="ident" id="6266273">openNewConnection</span><span class="op" id="6266290">(</span><span class="op" id="6266291">)</span>&nbsp;<span class="op" id="6266293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266296">ci</span><span class="op" id="6266298">,</span>&nbsp;<span class="ident" id="6266300">err</span>&nbsp;<span class="op" id="6266304">:=</span>&nbsp;<span class="ident" id="6266307">db</span><span class="op" id="6266309">.</span><span class="ident" id="6266310">driver</span><span class="op" id="6266316">.</span><span class="ident" id="6266317">Open</span><span class="op" id="6266321">(</span><span class="ident" id="6266322">db</span><span class="op" id="6266324">.</span><span class="ident" id="6266325">dsn</span><span class="op" id="6266328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266331">db</span><span class="op" id="6266333">.</span><span class="ident" id="6266334">mu</span><span class="op" id="6266336">.</span><span class="ident" id="6266337">Lock</span><span class="op" id="6266341">(</span><span class="op" id="6266342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266345">defer</span>&nbsp;<span class="ident" id="6266351">db</span><span class="op" id="6266353">.</span><span class="ident" id="6266354">mu</span><span class="op" id="6266356">.</span><span class="ident" id="6266357">Unlock</span><span class="op" id="6266363">(</span><span class="op" id="6266364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266367">if</span>&nbsp;<span class="ident" id="6266370">db</span><span class="op" id="6266372">.</span><span class="ident" id="6266373">closed</span>&nbsp;<span class="op" id="6266380">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266384">if</span>&nbsp;<span class="ident" id="6266387">err</span>&nbsp;<span class="op" id="6266391">==</span>&nbsp;<span class="ident" id="6266394">nil</span>&nbsp;<span class="op" id="6266398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266403">ci</span><span class="op" id="6266405">.</span><span class="ident" id="6266406">Close</span><span class="op" id="6266411">(</span><span class="op" id="6266412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266420">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266428">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266431">db</span><span class="op" id="6266433">.</span><span class="ident" id="6266434">pendingOpens</span><span class="op" id="6266446">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266450">if</span>&nbsp;<span class="ident" id="6266453">err</span>&nbsp;<span class="op" id="6266457">!=</span>&nbsp;<span class="ident" id="6266460">nil</span>&nbsp;<span class="op" id="6266464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266468">db</span><span class="op" id="6266470">.</span><span class="ident" id="6266471">putConnDBLocked</span><span class="op" id="6266486">(</span><span class="ident" id="6266487">nil</span><span class="op" id="6266490">,</span>&nbsp;<span class="ident" id="6266492">err</span><span class="op" id="6266495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266499">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266507">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266510">dc</span>&nbsp;<span class="op" id="6266513">:=</span>&nbsp;<span class="op" id="6266516">&amp;</span><span class="ident" id="6266517">driverConn</span><span class="op" id="6266527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266531">db</span><span class="op" id="6266533">:</span>&nbsp;<span class="ident" id="6266535">db</span><span class="op" id="6266537">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266541">ci</span><span class="op" id="6266543">:</span>&nbsp;<span class="ident" id="6266545">ci</span><span class="op" id="6266547">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6266553">if</span>&nbsp;<span class="ident" id="6266556">db</span><span class="op" id="6266558">.</span><span class="ident" id="6266559">putConnDBLocked</span><span class="op" id="6266574">(</span><span class="ident" id="6266575">dc</span><span class="op" id="6266577">,</span>&nbsp;<span class="ident" id="6266579">err</span><span class="op" id="6266582">)</span>&nbsp;<span class="op" id="6266584">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266588">db</span><span class="op" id="6266590">.</span><span class="ident" id="6266591">addDepLocked</span><span class="op" id="6266603">(</span><span class="ident" id="6266604">dc</span><span class="op" id="6266606">,</span>&nbsp;<span class="ident" id="6266608">dc</span><span class="op" id="6266610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266614">db</span><span class="op" id="6266616">.</span><span class="ident" id="6266617">numOpen</span><span class="op" id="6266624">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266628">}</span>&nbsp;<span class="keyword" id="6266630">else</span>&nbsp;<span class="op" id="6266635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266639">ci</span><span class="op" id="6266641">.</span><span class="ident" id="6266642">Close</span><span class="op" id="6266647">(</span><span class="op" id="6266648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6266651">}</span><br>
<span class="lineno">620</span><span class="op" id="6266653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6266656">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6266715">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="6266784">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="6266845">type</span>&nbsp;<span class="ident" id="6266850">connRequest</span>&nbsp;<span class="keyword" id="6266862">struct</span>&nbsp;<span class="op" id="6266869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266872">conn</span>&nbsp;<span class="op" id="6266877">*</span><span class="ident" id="6266878">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6266890">err</span>&nbsp;&nbsp;<span class="builtintype" id="6266895">error</span><br>
<span class="lineno"></span><span class="op" id="6266901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="6266904">var</span>&nbsp;<span class="ident" id="6266908">errDBClosed</span>&nbsp;<span class="op" id="6266920">=</span>&nbsp;<span class="ident" id="6266922">errors</span><span class="op" id="6266928">.</span><span class="ident" id="6266929">New</span><span class="op" id="6266932">(</span><span class="string" id="6266933">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6266958">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6266961">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="6267014">func</span>&nbsp;<span class="op" id="6267019">(</span><span class="ident" id="6267020">db</span>&nbsp;<span class="op" id="6267023">*</span><span class="ident" id="6267024">DB</span><span class="op" id="6267026">)</span>&nbsp;<span class="ident" id="6267028">conn</span><span class="op" id="6267032">(</span><span class="op" id="6267033">)</span>&nbsp;<span class="op" id="6267035">(</span><span class="op" id="6267036">*</span><span class="ident" id="6267037">driverConn</span><span class="op" id="6267047">,</span>&nbsp;<span class="builtintype" id="6267049">error</span><span class="op" id="6267054">)</span>&nbsp;<span class="op" id="6267056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267059">db</span><span class="op" id="6267061">.</span><span class="ident" id="6267062">mu</span><span class="op" id="6267064">.</span><span class="ident" id="6267065">Lock</span><span class="op" id="6267069">(</span><span class="op" id="6267070">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267073">if</span>&nbsp;<span class="ident" id="6267076">db</span><span class="op" id="6267078">.</span><span class="ident" id="6267079">closed</span>&nbsp;<span class="op" id="6267086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267090">db</span><span class="op" id="6267092">.</span><span class="ident" id="6267093">mu</span><span class="op" id="6267095">.</span><span class="ident" id="6267096">Unlock</span><span class="op" id="6267102">(</span><span class="op" id="6267103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267107">return</span>&nbsp;<span class="ident" id="6267114">nil</span><span class="op" id="6267117">,</span>&nbsp;<span class="ident" id="6267119">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6267132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6267136">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6267211">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267274">if</span>&nbsp;<span class="ident" id="6267277">db</span><span class="op" id="6267279">.</span><span class="ident" id="6267280">maxOpen</span>&nbsp;<span class="op" id="6267288">&gt;</span>&nbsp;<span class="num" id="6267290">0</span>&nbsp;<span class="op" id="6267292">&amp;&amp;</span>&nbsp;<span class="ident" id="6267295">db</span><span class="op" id="6267297">.</span><span class="ident" id="6267298">numOpen</span>&nbsp;<span class="op" id="6267306">&gt;=</span>&nbsp;<span class="ident" id="6267309">db</span><span class="op" id="6267311">.</span><span class="ident" id="6267312">maxOpen</span>&nbsp;<span class="op" id="6267320">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6267323">len</span><span class="op" id="6267326">(</span><span class="ident" id="6267327">db</span><span class="op" id="6267329">.</span><span class="ident" id="6267330">freeConn</span><span class="op" id="6267338">)</span>&nbsp;<span class="op" id="6267340">==</span>&nbsp;<span class="num" id="6267343">0</span>&nbsp;<span class="op" id="6267345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6267349">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6267410">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267484">req</span>&nbsp;<span class="op" id="6267488">:=</span>&nbsp;<span class="builtinfunc" id="6267491">make</span><span class="op" id="6267495">(</span><span class="keyword" id="6267496">chan</span>&nbsp;<span class="ident" id="6267501">connRequest</span><span class="op" id="6267512">,</span>&nbsp;<span class="num" id="6267514">1</span><span class="op" id="6267515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267519">db</span><span class="op" id="6267521">.</span><span class="ident" id="6267522">connRequests</span>&nbsp;<span class="op" id="6267535">=</span>&nbsp;<span class="builtinfunc" id="6267537">append</span><span class="op" id="6267543">(</span><span class="ident" id="6267544">db</span><span class="op" id="6267546">.</span><span class="ident" id="6267547">connRequests</span><span class="op" id="6267559">,</span>&nbsp;<span class="ident" id="6267561">req</span><span class="op" id="6267564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267568">db</span><span class="op" id="6267570">.</span><span class="ident" id="6267571">maybeOpenNewConnections</span><span class="op" id="6267594">(</span><span class="op" id="6267595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267599">db</span><span class="op" id="6267601">.</span><span class="ident" id="6267602">mu</span><span class="op" id="6267604">.</span><span class="ident" id="6267605">Unlock</span><span class="op" id="6267611">(</span><span class="op" id="6267612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267616">ret</span>&nbsp;<span class="op" id="6267620">:=</span>&nbsp;<span class="op" id="6267623">&lt;-</span><span class="ident" id="6267625">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267631">return</span>&nbsp;<span class="ident" id="6267638">ret</span><span class="op" id="6267641">.</span><span class="ident" id="6267642">conn</span><span class="op" id="6267646">,</span>&nbsp;<span class="ident" id="6267648">ret</span><span class="op" id="6267651">.</span><span class="ident" id="6267652">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6267657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267661">if</span>&nbsp;<span class="ident" id="6267664">c</span>&nbsp;<span class="op" id="6267666">:=</span>&nbsp;<span class="builtinfunc" id="6267669">len</span><span class="op" id="6267672">(</span><span class="ident" id="6267673">db</span><span class="op" id="6267675">.</span><span class="ident" id="6267676">freeConn</span><span class="op" id="6267684">)</span><span class="op" id="6267685">;</span>&nbsp;<span class="ident" id="6267687">c</span>&nbsp;<span class="op" id="6267689">&gt;</span>&nbsp;<span class="num" id="6267691">0</span>&nbsp;<span class="op" id="6267693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267697">conn</span>&nbsp;<span class="op" id="6267702">:=</span>&nbsp;<span class="ident" id="6267705">db</span><span class="op" id="6267707">.</span><span class="ident" id="6267708">freeConn</span><span class="op" id="6267716">[</span><span class="num" id="6267717">0</span><span class="op" id="6267718">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6267722">copy</span><span class="op" id="6267726">(</span><span class="ident" id="6267727">db</span><span class="op" id="6267729">.</span><span class="ident" id="6267730">freeConn</span><span class="op" id="6267738">,</span>&nbsp;<span class="ident" id="6267740">db</span><span class="op" id="6267742">.</span><span class="ident" id="6267743">freeConn</span><span class="op" id="6267751">[</span><span class="num" id="6267752">1</span><span class="op" id="6267753">:</span><span class="op" id="6267754">]</span><span class="op" id="6267755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267759">db</span><span class="op" id="6267761">.</span><span class="ident" id="6267762">freeConn</span>&nbsp;<span class="op" id="6267771">=</span>&nbsp;<span class="ident" id="6267773">db</span><span class="op" id="6267775">.</span><span class="ident" id="6267776">freeConn</span><span class="op" id="6267784">[</span><span class="op" id="6267785">:</span><span class="ident" id="6267786">c</span><span class="op" id="6267787">-</span><span class="num" id="6267788">1</span><span class="op" id="6267789">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267793">conn</span><span class="op" id="6267797">.</span><span class="ident" id="6267798">inUse</span>&nbsp;<span class="op" id="6267804">=</span>&nbsp;<span class="builtintype" id="6267806">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267813">db</span><span class="op" id="6267815">.</span><span class="ident" id="6267816">mu</span><span class="op" id="6267818">.</span><span class="ident" id="6267819">Unlock</span><span class="op" id="6267825">(</span><span class="op" id="6267826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267830">return</span>&nbsp;<span class="ident" id="6267837">conn</span><span class="op" id="6267841">,</span>&nbsp;<span class="ident" id="6267843">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6267848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267852">db</span><span class="op" id="6267854">.</span><span class="ident" id="6267855">numOpen</span><span class="op" id="6267862">++</span>&nbsp;<span class="comment" id="6267865">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267884">db</span><span class="op" id="6267886">.</span><span class="ident" id="6267887">mu</span><span class="op" id="6267889">.</span><span class="ident" id="6267890">Unlock</span><span class="op" id="6267896">(</span><span class="op" id="6267897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267900">ci</span><span class="op" id="6267902">,</span>&nbsp;<span class="ident" id="6267904">err</span>&nbsp;<span class="op" id="6267908">:=</span>&nbsp;<span class="ident" id="6267911">db</span><span class="op" id="6267913">.</span><span class="ident" id="6267914">driver</span><span class="op" id="6267920">.</span><span class="ident" id="6267921">Open</span><span class="op" id="6267925">(</span><span class="ident" id="6267926">db</span><span class="op" id="6267928">.</span><span class="ident" id="6267929">dsn</span><span class="op" id="6267932">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6267935">if</span>&nbsp;<span class="ident" id="6267938">err</span>&nbsp;<span class="op" id="6267942">!=</span>&nbsp;<span class="ident" id="6267945">nil</span>&nbsp;<span class="op" id="6267949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267953">db</span><span class="op" id="6267955">.</span><span class="ident" id="6267956">mu</span><span class="op" id="6267958">.</span><span class="ident" id="6267959">Lock</span><span class="op" id="6267963">(</span><span class="op" id="6267964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6267968">db</span><span class="op" id="6267970">.</span><span class="ident" id="6267971">numOpen</span><span class="op" id="6267978">--</span>&nbsp;<span class="comment" id="6267981">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268015">db</span><span class="op" id="6268017">.</span><span class="ident" id="6268018">mu</span><span class="op" id="6268020">.</span><span class="ident" id="6268021">Unlock</span><span class="op" id="6268027">(</span><span class="op" id="6268028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268032">return</span>&nbsp;<span class="ident" id="6268039">nil</span><span class="op" id="6268042">,</span>&nbsp;<span class="ident" id="6268044">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268052">db</span><span class="op" id="6268054">.</span><span class="ident" id="6268055">mu</span><span class="op" id="6268057">.</span><span class="ident" id="6268058">Lock</span><span class="op" id="6268062">(</span><span class="op" id="6268063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268066">dc</span>&nbsp;<span class="op" id="6268069">:=</span>&nbsp;<span class="op" id="6268072">&amp;</span><span class="ident" id="6268073">driverConn</span><span class="op" id="6268083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268087">db</span><span class="op" id="6268089">:</span>&nbsp;<span class="ident" id="6268091">db</span><span class="op" id="6268093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268097">ci</span><span class="op" id="6268099">:</span>&nbsp;<span class="ident" id="6268101">ci</span><span class="op" id="6268103">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268109">db</span><span class="op" id="6268111">.</span><span class="ident" id="6268112">addDepLocked</span><span class="op" id="6268124">(</span><span class="ident" id="6268125">dc</span><span class="op" id="6268127">,</span>&nbsp;<span class="ident" id="6268129">dc</span><span class="op" id="6268131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268134">dc</span><span class="op" id="6268136">.</span><span class="ident" id="6268137">inUse</span>&nbsp;<span class="op" id="6268143">=</span>&nbsp;<span class="builtintype" id="6268145">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268151">db</span><span class="op" id="6268153">.</span><span class="ident" id="6268154">mu</span><span class="op" id="6268156">.</span><span class="ident" id="6268157">Unlock</span><span class="op" id="6268163">(</span><span class="op" id="6268164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268167">return</span>&nbsp;<span class="ident" id="6268174">dc</span><span class="op" id="6268176">,</span>&nbsp;<span class="ident" id="6268178">nil</span><br>
<span class="lineno">680</span><span class="op" id="6268182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6268185">var</span>&nbsp;<span class="op" id="6268189">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268192">errConnClosed</span>&nbsp;<span class="op" id="6268206">=</span>&nbsp;<span class="ident" id="6268208">errors</span><span class="op" id="6268214">.</span><span class="ident" id="6268215">New</span><span class="op" id="6268218">(</span><span class="string" id="6268219">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6268274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268277">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6268291">=</span>&nbsp;<span class="ident" id="6268293">errors</span><span class="op" id="6268299">.</span><span class="ident" id="6268300">New</span><span class="op" id="6268303">(</span><span class="string" id="6268304">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="6268357">)</span><br>
<span class="lineno">685</span><span class="op" id="6268359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6268362">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6268434">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="6268451">//</span><br>
<span class="lineno">690</span><span class="comment" id="6268454">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6268530">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6268570">//</span><br>
<span class="lineno"></span><span class="comment" id="6268573">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="6268630">func</span>&nbsp;<span class="op" id="6268635">(</span><span class="ident" id="6268636">db</span>&nbsp;<span class="op" id="6268639">*</span><span class="ident" id="6268640">DB</span><span class="op" id="6268642">)</span>&nbsp;<span class="ident" id="6268644">connIfFree</span><span class="op" id="6268654">(</span><span class="ident" id="6268655">wanted</span>&nbsp;<span class="op" id="6268662">*</span><span class="ident" id="6268663">driverConn</span><span class="op" id="6268673">)</span>&nbsp;<span class="op" id="6268675">(</span><span class="op" id="6268676">*</span><span class="ident" id="6268677">driverConn</span><span class="op" id="6268687">,</span>&nbsp;<span class="builtintype" id="6268689">error</span><span class="op" id="6268694">)</span>&nbsp;<span class="op" id="6268696">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268699">db</span><span class="op" id="6268701">.</span><span class="ident" id="6268702">mu</span><span class="op" id="6268704">.</span><span class="ident" id="6268705">Lock</span><span class="op" id="6268709">(</span><span class="op" id="6268710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268713">defer</span>&nbsp;<span class="ident" id="6268719">db</span><span class="op" id="6268721">.</span><span class="ident" id="6268722">mu</span><span class="op" id="6268724">.</span><span class="ident" id="6268725">Unlock</span><span class="op" id="6268731">(</span><span class="op" id="6268732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268735">if</span>&nbsp;<span class="ident" id="6268738">wanted</span><span class="op" id="6268744">.</span><span class="ident" id="6268745">dbmuClosed</span>&nbsp;<span class="op" id="6268756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268760">return</span>&nbsp;<span class="ident" id="6268767">nil</span><span class="op" id="6268770">,</span>&nbsp;<span class="ident" id="6268772">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268787">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268790">if</span>&nbsp;<span class="ident" id="6268793">wanted</span><span class="op" id="6268799">.</span><span class="ident" id="6268800">inUse</span>&nbsp;<span class="op" id="6268806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268810">return</span>&nbsp;<span class="ident" id="6268817">nil</span><span class="op" id="6268820">,</span>&nbsp;<span class="ident" id="6268822">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268838">idx</span>&nbsp;<span class="op" id="6268842">:=</span>&nbsp;<span class="op" id="6268845">-</span><span class="num" id="6268846">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268849">for</span>&nbsp;<span class="ident" id="6268853">ii</span><span class="op" id="6268855">,</span>&nbsp;<span class="ident" id="6268857">v</span>&nbsp;<span class="op" id="6268859">:=</span>&nbsp;<span class="keyword" id="6268862">range</span>&nbsp;<span class="ident" id="6268868">db</span><span class="op" id="6268870">.</span><span class="ident" id="6268871">freeConn</span>&nbsp;<span class="op" id="6268880">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268884">if</span>&nbsp;<span class="ident" id="6268887">v</span>&nbsp;<span class="op" id="6268889">==</span>&nbsp;<span class="ident" id="6268892">wanted</span>&nbsp;<span class="op" id="6268899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268904">idx</span>&nbsp;<span class="op" id="6268908">=</span>&nbsp;<span class="ident" id="6268910">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268916">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6268927">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6268930">if</span>&nbsp;<span class="ident" id="6268933">idx</span>&nbsp;<span class="op" id="6268937">&gt;=</span>&nbsp;<span class="num" id="6268940">0</span>&nbsp;<span class="op" id="6268942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6268946">db</span><span class="op" id="6268948">.</span><span class="ident" id="6268949">freeConn</span>&nbsp;<span class="op" id="6268958">=</span>&nbsp;<span class="builtinfunc" id="6268960">append</span><span class="op" id="6268966">(</span><span class="ident" id="6268967">db</span><span class="op" id="6268969">.</span><span class="ident" id="6268970">freeConn</span><span class="op" id="6268978">[</span><span class="op" id="6268979">:</span><span class="ident" id="6268980">idx</span><span class="op" id="6268983">]</span><span class="op" id="6268984">,</span>&nbsp;<span class="ident" id="6268986">db</span><span class="op" id="6268988">.</span><span class="ident" id="6268989">freeConn</span><span class="op" id="6268997">[</span><span class="ident" id="6268998">idx</span><span class="op" id="6269001">+</span><span class="num" id="6269002">1</span><span class="op" id="6269003">:</span><span class="op" id="6269004">]</span><span class="op" id="6269005">...</span><span class="op" id="6269008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269012">wanted</span><span class="op" id="6269018">.</span><span class="ident" id="6269019">inUse</span>&nbsp;<span class="op" id="6269025">=</span>&nbsp;<span class="builtintype" id="6269027">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269034">return</span>&nbsp;<span class="ident" id="6269041">wanted</span><span class="op" id="6269047">,</span>&nbsp;<span class="ident" id="6269049">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6269054">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269057">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269127">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269204">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269273">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6269293">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269339">return</span>&nbsp;<span class="ident" id="6269346">nil</span><span class="op" id="6269349">,</span>&nbsp;<span class="ident" id="6269351">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="6269363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6269366">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="6269404">var</span>&nbsp;<span class="ident" id="6269408">putConnHook</span>&nbsp;<span class="keyword" id="6269420">func</span><span class="op" id="6269424">(</span><span class="op" id="6269425">*</span><span class="ident" id="6269426">DB</span><span class="op" id="6269428">,</span>&nbsp;<span class="op" id="6269430">*</span><span class="ident" id="6269431">driverConn</span><span class="op" id="6269441">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="6269444">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="6269516">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6269588">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="6269607">func</span>&nbsp;<span class="op" id="6269612">(</span><span class="ident" id="6269613">db</span>&nbsp;<span class="op" id="6269616">*</span><span class="ident" id="6269617">DB</span><span class="op" id="6269619">)</span>&nbsp;<span class="ident" id="6269621">noteUnusedDriverStatement</span><span class="op" id="6269646">(</span><span class="ident" id="6269647">c</span>&nbsp;<span class="op" id="6269649">*</span><span class="ident" id="6269650">driverConn</span><span class="op" id="6269660">,</span>&nbsp;<span class="ident" id="6269662">si</span>&nbsp;<span class="ident" id="6269665">driver</span><span class="op" id="6269671">.</span><span class="ident" id="6269672">Stmt</span><span class="op" id="6269676">)</span>&nbsp;<span class="op" id="6269678">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269681">db</span><span class="op" id="6269683">.</span><span class="ident" id="6269684">mu</span><span class="op" id="6269686">.</span><span class="ident" id="6269687">Lock</span><span class="op" id="6269691">(</span><span class="op" id="6269692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269695">defer</span>&nbsp;<span class="ident" id="6269701">db</span><span class="op" id="6269703">.</span><span class="ident" id="6269704">mu</span><span class="op" id="6269706">.</span><span class="ident" id="6269707">Unlock</span><span class="op" id="6269713">(</span><span class="op" id="6269714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269717">if</span>&nbsp;<span class="ident" id="6269720">c</span><span class="op" id="6269721">.</span><span class="ident" id="6269722">inUse</span>&nbsp;<span class="op" id="6269728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269732">c</span><span class="op" id="6269733">.</span><span class="ident" id="6269734">onPut</span>&nbsp;<span class="op" id="6269740">=</span>&nbsp;<span class="builtinfunc" id="6269742">append</span><span class="op" id="6269748">(</span><span class="ident" id="6269749">c</span><span class="op" id="6269750">.</span><span class="ident" id="6269751">onPut</span><span class="op" id="6269756">,</span>&nbsp;<span class="keyword" id="6269758">func</span><span class="op" id="6269762">(</span><span class="op" id="6269763">)</span>&nbsp;<span class="op" id="6269765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269770">si</span><span class="op" id="6269772">.</span><span class="ident" id="6269773">Close</span><span class="op" id="6269778">(</span><span class="op" id="6269779">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6269783">}</span><span class="op" id="6269784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6269787">}</span>&nbsp;<span class="keyword" id="6269789">else</span>&nbsp;<span class="op" id="6269794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269798">c</span><span class="op" id="6269799">.</span><span class="ident" id="6269800">Lock</span><span class="op" id="6269804">(</span><span class="op" id="6269805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269809">defer</span>&nbsp;<span class="ident" id="6269815">c</span><span class="op" id="6269816">.</span><span class="ident" id="6269817">Unlock</span><span class="op" id="6269823">(</span><span class="op" id="6269824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6269828">if</span>&nbsp;<span class="op" id="6269831">!</span><span class="ident" id="6269832">c</span><span class="op" id="6269833">.</span><span class="ident" id="6269834">finalClosed</span>&nbsp;<span class="op" id="6269846">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6269851">si</span><span class="op" id="6269853">.</span><span class="ident" id="6269854">Close</span><span class="op" id="6269859">(</span><span class="op" id="6269860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6269864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6269867">}</span><br>
<span class="lineno"></span><span class="op" id="6269869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="6269872">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="6269944">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="6269986">const</span>&nbsp;<span class="ident" id="6269992">debugGetPut</span>&nbsp;<span class="op" id="6270004">=</span>&nbsp;<span class="builtintype" id="6270006">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6270013">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="6270065">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6270135">func</span>&nbsp;<span class="op" id="6270140">(</span><span class="ident" id="6270141">db</span>&nbsp;<span class="op" id="6270144">*</span><span class="ident" id="6270145">DB</span><span class="op" id="6270147">)</span>&nbsp;<span class="ident" id="6270149">putConn</span><span class="op" id="6270156">(</span><span class="ident" id="6270157">dc</span>&nbsp;<span class="op" id="6270160">*</span><span class="ident" id="6270161">driverConn</span><span class="op" id="6270171">,</span>&nbsp;<span class="ident" id="6270173">err</span>&nbsp;<span class="builtintype" id="6270177">error</span><span class="op" id="6270182">)</span>&nbsp;<span class="op" id="6270184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270187">db</span><span class="op" id="6270189">.</span><span class="ident" id="6270190">mu</span><span class="op" id="6270192">.</span><span class="ident" id="6270193">Lock</span><span class="op" id="6270197">(</span><span class="op" id="6270198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270201">if</span>&nbsp;<span class="op" id="6270204">!</span><span class="ident" id="6270205">dc</span><span class="op" id="6270207">.</span><span class="ident" id="6270208">inUse</span>&nbsp;<span class="op" id="6270214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270218">if</span>&nbsp;<span class="ident" id="6270221">debugGetPut</span>&nbsp;<span class="op" id="6270233">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270238">fmt</span><span class="op" id="6270241">.</span><span class="ident" id="6270242">Printf</span><span class="op" id="6270248">(</span><span class="string" id="6270249">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="6270300">,</span>&nbsp;<span class="ident" id="6270302">dc</span><span class="op" id="6270304">,</span>&nbsp;<span class="ident" id="6270306">stack</span><span class="op" id="6270311">(</span><span class="op" id="6270312">)</span><span class="op" id="6270313">,</span>&nbsp;<span class="ident" id="6270315">db</span><span class="op" id="6270317">.</span><span class="ident" id="6270318">lastPut</span><span class="op" id="6270325">[</span><span class="ident" id="6270326">dc</span><span class="op" id="6270328">]</span><span class="op" id="6270329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6270337">panic</span><span class="op" id="6270342">(</span><span class="string" id="6270343">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="6270388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270394">if</span>&nbsp;<span class="ident" id="6270397">debugGetPut</span>&nbsp;<span class="op" id="6270409">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270413">db</span><span class="op" id="6270415">.</span><span class="ident" id="6270416">lastPut</span><span class="op" id="6270423">[</span><span class="ident" id="6270424">dc</span><span class="op" id="6270426">]</span>&nbsp;<span class="op" id="6270428">=</span>&nbsp;<span class="ident" id="6270430">stack</span><span class="op" id="6270435">(</span><span class="op" id="6270436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270442">dc</span><span class="op" id="6270444">.</span><span class="ident" id="6270445">inUse</span>&nbsp;<span class="op" id="6270451">=</span>&nbsp;<span class="builtintype" id="6270453">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270461">for</span>&nbsp;<span class="ident" id="6270465">_</span><span class="op" id="6270466">,</span>&nbsp;<span class="ident" id="6270468">fn</span>&nbsp;<span class="op" id="6270471">:=</span>&nbsp;<span class="keyword" id="6270474">range</span>&nbsp;<span class="ident" id="6270480">dc</span><span class="op" id="6270482">.</span><span class="ident" id="6270483">onPut</span>&nbsp;<span class="op" id="6270489">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270493">fn</span><span class="op" id="6270495">(</span><span class="op" id="6270496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270502">dc</span><span class="op" id="6270504">.</span><span class="ident" id="6270505">onPut</span>&nbsp;<span class="op" id="6270511">=</span>&nbsp;<span class="ident" id="6270513">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270519">if</span>&nbsp;<span class="ident" id="6270522">err</span>&nbsp;<span class="op" id="6270526">==</span>&nbsp;<span class="ident" id="6270529">driver</span><span class="op" id="6270535">.</span><span class="ident" id="6270536">ErrBadConn</span>&nbsp;<span class="op" id="6270547">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6270551">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6270585">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6270656">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6270725">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270749">db</span><span class="op" id="6270751">.</span><span class="ident" id="6270752">maybeOpenNewConnections</span><span class="op" id="6270775">(</span><span class="op" id="6270776">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270780">db</span><span class="op" id="6270782">.</span><span class="ident" id="6270783">mu</span><span class="op" id="6270785">.</span><span class="ident" id="6270786">Unlock</span><span class="op" id="6270792">(</span><span class="op" id="6270793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270797">dc</span><span class="op" id="6270799">.</span><span class="ident" id="6270800">Close</span><span class="op" id="6270805">(</span><span class="op" id="6270806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270821">if</span>&nbsp;<span class="ident" id="6270824">putConnHook</span>&nbsp;<span class="op" id="6270836">!=</span>&nbsp;<span class="ident" id="6270839">nil</span>&nbsp;<span class="op" id="6270843">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270847">putConnHook</span><span class="op" id="6270858">(</span><span class="ident" id="6270859">db</span><span class="op" id="6270861">,</span>&nbsp;<span class="ident" id="6270863">dc</span><span class="op" id="6270865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270871">added</span>&nbsp;<span class="op" id="6270877">:=</span>&nbsp;<span class="ident" id="6270880">db</span><span class="op" id="6270882">.</span><span class="ident" id="6270883">putConnDBLocked</span><span class="op" id="6270898">(</span><span class="ident" id="6270899">dc</span><span class="op" id="6270901">,</span>&nbsp;<span class="ident" id="6270903">nil</span><span class="op" id="6270906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270909">db</span><span class="op" id="6270911">.</span><span class="ident" id="6270912">mu</span><span class="op" id="6270914">.</span><span class="ident" id="6270915">Unlock</span><span class="op" id="6270921">(</span><span class="op" id="6270922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6270926">if</span>&nbsp;<span class="op" id="6270929">!</span><span class="ident" id="6270930">added</span>&nbsp;<span class="op" id="6270936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6270940">dc</span><span class="op" id="6270942">.</span><span class="ident" id="6270943">Close</span><span class="op" id="6270948">(</span><span class="op" id="6270949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6270952">}</span><br>
<span class="lineno"></span><span class="op" id="6270954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="6270957">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="6271037">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="6271057">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6271131">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="6271205">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="6271247">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="6271293">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="6271339">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6271410">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6271480">func</span>&nbsp;<span class="op" id="6271485">(</span><span class="ident" id="6271486">db</span>&nbsp;<span class="op" id="6271489">*</span><span class="ident" id="6271490">DB</span><span class="op" id="6271492">)</span>&nbsp;<span class="ident" id="6271494">putConnDBLocked</span><span class="op" id="6271509">(</span><span class="ident" id="6271510">dc</span>&nbsp;<span class="op" id="6271513">*</span><span class="ident" id="6271514">driverConn</span><span class="op" id="6271524">,</span>&nbsp;<span class="ident" id="6271526">err</span>&nbsp;<span class="builtintype" id="6271530">error</span><span class="op" id="6271535">)</span>&nbsp;<span class="builtintype" id="6271537">bool</span>&nbsp;<span class="op" id="6271542">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271545">if</span>&nbsp;<span class="ident" id="6271548">c</span>&nbsp;<span class="op" id="6271550">:=</span>&nbsp;<span class="builtinfunc" id="6271553">len</span><span class="op" id="6271556">(</span><span class="ident" id="6271557">db</span><span class="op" id="6271559">.</span><span class="ident" id="6271560">connRequests</span><span class="op" id="6271572">)</span><span class="op" id="6271573">;</span>&nbsp;<span class="ident" id="6271575">c</span>&nbsp;<span class="op" id="6271577">&gt;</span>&nbsp;<span class="num" id="6271579">0</span>&nbsp;<span class="op" id="6271581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271585">req</span>&nbsp;<span class="op" id="6271589">:=</span>&nbsp;<span class="ident" id="6271592">db</span><span class="op" id="6271594">.</span><span class="ident" id="6271595">connRequests</span><span class="op" id="6271607">[</span><span class="num" id="6271608">0</span><span class="op" id="6271609">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271613">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271679">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6271733">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6271763">copy</span><span class="op" id="6271767">(</span><span class="ident" id="6271768">db</span><span class="op" id="6271770">.</span><span class="ident" id="6271771">connRequests</span><span class="op" id="6271783">,</span>&nbsp;<span class="ident" id="6271785">db</span><span class="op" id="6271787">.</span><span class="ident" id="6271788">connRequests</span><span class="op" id="6271800">[</span><span class="num" id="6271801">1</span><span class="op" id="6271802">:</span><span class="op" id="6271803">]</span><span class="op" id="6271804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271808">db</span><span class="op" id="6271810">.</span><span class="ident" id="6271811">connRequests</span>&nbsp;<span class="op" id="6271824">=</span>&nbsp;<span class="ident" id="6271826">db</span><span class="op" id="6271828">.</span><span class="ident" id="6271829">connRequests</span><span class="op" id="6271841">[</span><span class="op" id="6271842">:</span><span class="ident" id="6271843">c</span><span class="op" id="6271844">-</span><span class="num" id="6271845">1</span><span class="op" id="6271846">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271850">if</span>&nbsp;<span class="ident" id="6271853">err</span>&nbsp;<span class="op" id="6271857">==</span>&nbsp;<span class="ident" id="6271860">nil</span>&nbsp;<span class="op" id="6271864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271869">dc</span><span class="op" id="6271871">.</span><span class="ident" id="6271872">inUse</span>&nbsp;<span class="op" id="6271878">=</span>&nbsp;<span class="builtintype" id="6271880">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6271887">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271891">req</span>&nbsp;<span class="op" id="6271895">&lt;-</span>&nbsp;<span class="ident" id="6271898">connRequest</span><span class="op" id="6271909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271914">conn</span><span class="op" id="6271918">:</span>&nbsp;<span class="ident" id="6271920">dc</span><span class="op" id="6271922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6271927">err</span><span class="op" id="6271930">:</span>&nbsp;&nbsp;<span class="ident" id="6271933">err</span><span class="op" id="6271936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6271940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6271944">return</span>&nbsp;<span class="builtintype" id="6271951">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6271957">}</span>&nbsp;<span class="keyword" id="6271959">else</span>&nbsp;<span class="keyword" id="6271964">if</span>&nbsp;<span class="ident" id="6271967">err</span>&nbsp;<span class="op" id="6271971">==</span>&nbsp;<span class="ident" id="6271974">nil</span>&nbsp;<span class="op" id="6271978">&amp;&amp;</span>&nbsp;<span class="op" id="6271981">!</span><span class="ident" id="6271982">db</span><span class="op" id="6271984">.</span><span class="ident" id="6271985">closed</span>&nbsp;<span class="op" id="6271992">&amp;&amp;</span>&nbsp;<span class="ident" id="6271995">db</span><span class="op" id="6271997">.</span><span class="ident" id="6271998">maxIdleConnsLocked</span><span class="op" id="6272016">(</span><span class="op" id="6272017">)</span>&nbsp;<span class="op" id="6272019">&gt;</span>&nbsp;<span class="builtinfunc" id="6272021">len</span><span class="op" id="6272024">(</span><span class="ident" id="6272025">db</span><span class="op" id="6272027">.</span><span class="ident" id="6272028">freeConn</span><span class="op" id="6272036">)</span>&nbsp;<span class="op" id="6272038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272042">db</span><span class="op" id="6272044">.</span><span class="ident" id="6272045">freeConn</span>&nbsp;<span class="op" id="6272054">=</span>&nbsp;<span class="builtinfunc" id="6272056">append</span><span class="op" id="6272062">(</span><span class="ident" id="6272063">db</span><span class="op" id="6272065">.</span><span class="ident" id="6272066">freeConn</span><span class="op" id="6272074">,</span>&nbsp;<span class="ident" id="6272076">dc</span><span class="op" id="6272078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272082">return</span>&nbsp;<span class="builtintype" id="6272089">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272098">return</span>&nbsp;<span class="builtintype" id="6272105">false</span><br>
<span class="lineno">820</span><span class="op" id="6272111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6272114">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6272190">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6272242">const</span>&nbsp;<span class="ident" id="6272248">maxBadConnRetries</span>&nbsp;<span class="op" id="6272266">=</span>&nbsp;<span class="num" id="6272268">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="6272272">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="6272345">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6272412">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6272435">func</span>&nbsp;<span class="op" id="6272440">(</span><span class="ident" id="6272441">db</span>&nbsp;<span class="op" id="6272444">*</span><span class="ident" id="6272445">DB</span><span class="op" id="6272447">)</span>&nbsp;<span class="ident" id="6272449">Prepare</span><span class="op" id="6272456">(</span><span class="ident" id="6272457">query</span>&nbsp;<span class="builtintype" id="6272463">string</span><span class="op" id="6272469">)</span>&nbsp;<span class="op" id="6272471">(</span><span class="op" id="6272472">*</span><span class="ident" id="6272473">Stmt</span><span class="op" id="6272477">,</span>&nbsp;<span class="builtintype" id="6272479">error</span><span class="op" id="6272484">)</span>&nbsp;<span class="op" id="6272486">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272489">var</span>&nbsp;<span class="ident" id="6272493">stmt</span>&nbsp;<span class="op" id="6272498">*</span><span class="ident" id="6272499">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272505">var</span>&nbsp;<span class="ident" id="6272509">err</span>&nbsp;<span class="builtintype" id="6272513">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272520">for</span>&nbsp;<span class="ident" id="6272524">i</span>&nbsp;<span class="op" id="6272526">:=</span>&nbsp;<span class="num" id="6272529">0</span><span class="op" id="6272530">;</span>&nbsp;<span class="ident" id="6272532">i</span>&nbsp;<span class="op" id="6272534">&lt;</span>&nbsp;<span class="ident" id="6272536">maxBadConnRetries</span><span class="op" id="6272553">;</span>&nbsp;<span class="ident" id="6272555">i</span><span class="op" id="6272556">++</span>&nbsp;<span class="op" id="6272559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6272563">stmt</span><span class="op" id="6272567">,</span>&nbsp;<span class="ident" id="6272569">err</span>&nbsp;<span class="op" id="6272573">=</span>&nbsp;<span class="ident" id="6272575">db</span><span class="op" id="6272577">.</span><span class="ident" id="6272578">prepare</span><span class="op" id="6272585">(</span><span class="ident" id="6272586">query</span><span class="op" id="6272591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272595">if</span>&nbsp;<span class="ident" id="6272598">err</span>&nbsp;<span class="op" id="6272602">!=</span>&nbsp;<span class="ident" id="6272605">driver</span><span class="op" id="6272611">.</span><span class="ident" id="6272612">ErrBadConn</span>&nbsp;<span class="op" id="6272623">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272628">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6272639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6272642">return</span>&nbsp;<span class="ident" id="6272649">stmt</span><span class="op" id="6272653">,</span>&nbsp;<span class="ident" id="6272655">err</span><br>
<span class="lineno"></span><span class="op" id="6272659">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="6272662">func</span>&nbsp;<span class="op" id="6272667">(</span><span class="ident" id="6272668">db</span>&nbsp;<span class="op" id="6272671">*</span><span class="ident" id="6272672">DB</span><span class="op" id="6272674">)</span>&nbsp;<span class="ident" id="6272676">prepare</span><span class="op" id="6272683">(</span><span class="ident" id="6272684">query</span>&nbsp;<span class="builtintype" id="6272690">string</span><span class="op" id="6272696">)</span>&nbsp;<span class="op" id="6272698">(</span><span class="op" id="6272699">*</span><span class="ident" id="6272700">Stmt</span><span class="op" id="6272704">,</span>&nbsp;<span class="builtintype" id="6272706">error</span><span class="op" id="6272711">)</span>&nbsp;<span class="op" id="6272713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272716">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272766">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272826">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272882">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6272942">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6273005">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273066">dc</span><span class="op" id="6273068">,</span>&nbsp;<span class="ident" id="6273070">err</span>&nbsp;<span class="op" id="6273074">:=</span>&nbsp;<span class="ident" id="6273077">db</span><span class="op" id="6273079">.</span><span class="ident" id="6273080">conn</span><span class="op" id="6273084">(</span><span class="op" id="6273085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273088">if</span>&nbsp;<span class="ident" id="6273091">err</span>&nbsp;<span class="op" id="6273095">!=</span>&nbsp;<span class="ident" id="6273098">nil</span>&nbsp;<span class="op" id="6273102">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273106">return</span>&nbsp;<span class="ident" id="6273113">nil</span><span class="op" id="6273116">,</span>&nbsp;<span class="ident" id="6273118">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273126">dc</span><span class="op" id="6273128">.</span><span class="ident" id="6273129">Lock</span><span class="op" id="6273133">(</span><span class="op" id="6273134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273137">si</span><span class="op" id="6273139">,</span>&nbsp;<span class="ident" id="6273141">err</span>&nbsp;<span class="op" id="6273145">:=</span>&nbsp;<span class="ident" id="6273148">dc</span><span class="op" id="6273150">.</span><span class="ident" id="6273151">prepareLocked</span><span class="op" id="6273164">(</span><span class="ident" id="6273165">query</span><span class="op" id="6273170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273173">dc</span><span class="op" id="6273175">.</span><span class="ident" id="6273176">Unlock</span><span class="op" id="6273182">(</span><span class="op" id="6273183">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273186">if</span>&nbsp;<span class="ident" id="6273189">err</span>&nbsp;<span class="op" id="6273193">!=</span>&nbsp;<span class="ident" id="6273196">nil</span>&nbsp;<span class="op" id="6273200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273204">db</span><span class="op" id="6273206">.</span><span class="ident" id="6273207">putConn</span><span class="op" id="6273214">(</span><span class="ident" id="6273215">dc</span><span class="op" id="6273217">,</span>&nbsp;<span class="ident" id="6273219">err</span><span class="op" id="6273222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273226">return</span>&nbsp;<span class="ident" id="6273233">nil</span><span class="op" id="6273236">,</span>&nbsp;<span class="ident" id="6273238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273246">stmt</span>&nbsp;<span class="op" id="6273251">:=</span>&nbsp;<span class="op" id="6273254">&amp;</span><span class="ident" id="6273255">Stmt</span><span class="op" id="6273259">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273263">db</span><span class="op" id="6273265">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6273270">db</span><span class="op" id="6273272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273276">query</span><span class="op" id="6273281">:</span>&nbsp;<span class="ident" id="6273283">query</span><span class="op" id="6273288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273292">css</span><span class="op" id="6273295">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6273299">[</span><span class="op" id="6273300">]</span><span class="ident" id="6273301">connStmt</span><span class="op" id="6273309">{</span><span class="op" id="6273310">{</span><span class="ident" id="6273311">dc</span><span class="op" id="6273313">,</span>&nbsp;<span class="ident" id="6273315">si</span><span class="op" id="6273317">}</span><span class="op" id="6273318">}</span><span class="op" id="6273319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273325">db</span><span class="op" id="6273327">.</span><span class="ident" id="6273328">addDep</span><span class="op" id="6273334">(</span><span class="ident" id="6273335">stmt</span><span class="op" id="6273339">,</span>&nbsp;<span class="ident" id="6273341">stmt</span><span class="op" id="6273345">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273348">db</span><span class="op" id="6273350">.</span><span class="ident" id="6273351">putConn</span><span class="op" id="6273358">(</span><span class="ident" id="6273359">dc</span><span class="op" id="6273361">,</span>&nbsp;<span class="ident" id="6273363">nil</span><span class="op" id="6273366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273369">return</span>&nbsp;<span class="ident" id="6273376">stmt</span><span class="op" id="6273380">,</span>&nbsp;<span class="ident" id="6273382">nil</span><br>
<span class="lineno"></span><span class="op" id="6273386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6273389">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="6273442">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="6273503">func</span>&nbsp;<span class="op" id="6273508">(</span><span class="ident" id="6273509">db</span>&nbsp;<span class="op" id="6273512">*</span><span class="ident" id="6273513">DB</span><span class="op" id="6273515">)</span>&nbsp;<span class="ident" id="6273517">Exec</span><span class="op" id="6273521">(</span><span class="ident" id="6273522">query</span>&nbsp;<span class="builtintype" id="6273528">string</span><span class="op" id="6273534">,</span>&nbsp;<span class="ident" id="6273536">args</span>&nbsp;<span class="op" id="6273541">...</span><span class="keyword" id="6273544">interface</span><span class="op" id="6273553">{</span><span class="op" id="6273554">}</span><span class="op" id="6273555">)</span>&nbsp;<span class="op" id="6273557">(</span><span class="ident" id="6273558">Result</span><span class="op" id="6273564">,</span>&nbsp;<span class="builtintype" id="6273566">error</span><span class="op" id="6273571">)</span>&nbsp;<span class="op" id="6273573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273576">var</span>&nbsp;<span class="ident" id="6273580">res</span>&nbsp;<span class="ident" id="6273584">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273592">var</span>&nbsp;<span class="ident" id="6273596">err</span>&nbsp;<span class="builtintype" id="6273600">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273607">for</span>&nbsp;<span class="ident" id="6273611">i</span>&nbsp;<span class="op" id="6273613">:=</span>&nbsp;<span class="num" id="6273616">0</span><span class="op" id="6273617">;</span>&nbsp;<span class="ident" id="6273619">i</span>&nbsp;<span class="op" id="6273621">&lt;</span>&nbsp;<span class="ident" id="6273623">maxBadConnRetries</span><span class="op" id="6273640">;</span>&nbsp;<span class="ident" id="6273642">i</span><span class="op" id="6273643">++</span>&nbsp;<span class="op" id="6273646">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273650">res</span><span class="op" id="6273653">,</span>&nbsp;<span class="ident" id="6273655">err</span>&nbsp;<span class="op" id="6273659">=</span>&nbsp;<span class="ident" id="6273661">db</span><span class="op" id="6273663">.</span><span class="ident" id="6273664">exec</span><span class="op" id="6273668">(</span><span class="ident" id="6273669">query</span><span class="op" id="6273674">,</span>&nbsp;<span class="ident" id="6273676">args</span><span class="op" id="6273680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273684">if</span>&nbsp;<span class="ident" id="6273687">err</span>&nbsp;<span class="op" id="6273691">!=</span>&nbsp;<span class="ident" id="6273694">driver</span><span class="op" id="6273700">.</span><span class="ident" id="6273701">ErrBadConn</span>&nbsp;<span class="op" id="6273712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273717">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273728">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273731">return</span>&nbsp;<span class="ident" id="6273738">res</span><span class="op" id="6273741">,</span>&nbsp;<span class="ident" id="6273743">err</span><br>
<span class="lineno"></span><span class="op" id="6273747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6273750">func</span>&nbsp;<span class="op" id="6273755">(</span><span class="ident" id="6273756">db</span>&nbsp;<span class="op" id="6273759">*</span><span class="ident" id="6273760">DB</span><span class="op" id="6273762">)</span>&nbsp;<span class="ident" id="6273764">exec</span><span class="op" id="6273768">(</span><span class="ident" id="6273769">query</span>&nbsp;<span class="builtintype" id="6273775">string</span><span class="op" id="6273781">,</span>&nbsp;<span class="ident" id="6273783">args</span>&nbsp;<span class="op" id="6273788">[</span><span class="op" id="6273789">]</span><span class="keyword" id="6273790">interface</span><span class="op" id="6273799">{</span><span class="op" id="6273800">}</span><span class="op" id="6273801">)</span>&nbsp;<span class="op" id="6273803">(</span><span class="ident" id="6273804">res</span>&nbsp;<span class="ident" id="6273808">Result</span><span class="op" id="6273814">,</span>&nbsp;<span class="ident" id="6273816">err</span>&nbsp;<span class="builtintype" id="6273820">error</span><span class="op" id="6273825">)</span>&nbsp;<span class="op" id="6273827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273830">dc</span><span class="op" id="6273832">,</span>&nbsp;<span class="ident" id="6273834">err</span>&nbsp;<span class="op" id="6273838">:=</span>&nbsp;<span class="ident" id="6273841">db</span><span class="op" id="6273843">.</span><span class="ident" id="6273844">conn</span><span class="op" id="6273848">(</span><span class="op" id="6273849">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273852">if</span>&nbsp;<span class="ident" id="6273855">err</span>&nbsp;<span class="op" id="6273859">!=</span>&nbsp;<span class="ident" id="6273862">nil</span>&nbsp;<span class="op" id="6273866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273870">return</span>&nbsp;<span class="ident" id="6273877">nil</span><span class="op" id="6273880">,</span>&nbsp;<span class="ident" id="6273882">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273890">defer</span>&nbsp;<span class="keyword" id="6273896">func</span><span class="op" id="6273900">(</span><span class="op" id="6273901">)</span>&nbsp;<span class="op" id="6273903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273907">db</span><span class="op" id="6273909">.</span><span class="ident" id="6273910">putConn</span><span class="op" id="6273917">(</span><span class="ident" id="6273918">dc</span><span class="op" id="6273920">,</span>&nbsp;<span class="ident" id="6273922">err</span><span class="op" id="6273925">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6273928">}</span><span class="op" id="6273929">(</span><span class="op" id="6273930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6273934">if</span>&nbsp;<span class="ident" id="6273937">execer</span><span class="op" id="6273943">,</span>&nbsp;<span class="ident" id="6273945">ok</span>&nbsp;<span class="op" id="6273948">:=</span>&nbsp;<span class="ident" id="6273951">dc</span><span class="op" id="6273953">.</span><span class="ident" id="6273954">ci</span><span class="op" id="6273956">.</span><span class="op" id="6273957">(</span><span class="ident" id="6273958">driver</span><span class="op" id="6273964">.</span><span class="ident" id="6273965">Execer</span><span class="op" id="6273971">)</span><span class="op" id="6273972">;</span>&nbsp;<span class="ident" id="6273974">ok</span>&nbsp;<span class="op" id="6273977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6273981">dargs</span><span class="op" id="6273986">,</span>&nbsp;<span class="ident" id="6273988">err</span>&nbsp;<span class="op" id="6273992">:=</span>&nbsp;<span class="ident" id="6273995">driverArgs</span><span class="op" id="6274005">(</span><span class="ident" id="6274006">nil</span><span class="op" id="6274009">,</span>&nbsp;<span class="ident" id="6274011">args</span><span class="op" id="6274015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274019">if</span>&nbsp;<span class="ident" id="6274022">err</span>&nbsp;<span class="op" id="6274026">!=</span>&nbsp;<span class="ident" id="6274029">nil</span>&nbsp;<span class="op" id="6274033">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274038">return</span>&nbsp;<span class="ident" id="6274045">nil</span><span class="op" id="6274048">,</span>&nbsp;<span class="ident" id="6274050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274060">dc</span><span class="op" id="6274062">.</span><span class="ident" id="6274063">Lock</span><span class="op" id="6274067">(</span><span class="op" id="6274068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274072">resi</span><span class="op" id="6274076">,</span>&nbsp;<span class="ident" id="6274078">err</span>&nbsp;<span class="op" id="6274082">:=</span>&nbsp;<span class="ident" id="6274085">execer</span><span class="op" id="6274091">.</span><span class="ident" id="6274092">Exec</span><span class="op" id="6274096">(</span><span class="ident" id="6274097">query</span><span class="op" id="6274102">,</span>&nbsp;<span class="ident" id="6274104">dargs</span><span class="op" id="6274109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274113">dc</span><span class="op" id="6274115">.</span><span class="ident" id="6274116">Unlock</span><span class="op" id="6274122">(</span><span class="op" id="6274123">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274127">if</span>&nbsp;<span class="ident" id="6274130">err</span>&nbsp;<span class="op" id="6274134">!=</span>&nbsp;<span class="ident" id="6274137">driver</span><span class="op" id="6274143">.</span><span class="ident" id="6274144">ErrSkip</span>&nbsp;<span class="op" id="6274152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274157">if</span>&nbsp;<span class="ident" id="6274160">err</span>&nbsp;<span class="op" id="6274164">!=</span>&nbsp;<span class="ident" id="6274167">nil</span>&nbsp;<span class="op" id="6274171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274177">return</span>&nbsp;<span class="ident" id="6274184">nil</span><span class="op" id="6274187">,</span>&nbsp;<span class="ident" id="6274189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274201">return</span>&nbsp;<span class="ident" id="6274208">driverResult</span><span class="op" id="6274220">{</span><span class="ident" id="6274221">dc</span><span class="op" id="6274223">,</span>&nbsp;<span class="ident" id="6274225">resi</span><span class="op" id="6274229">}</span><span class="op" id="6274230">,</span>&nbsp;<span class="ident" id="6274232">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274245">dc</span><span class="op" id="6274247">.</span><span class="ident" id="6274248">Lock</span><span class="op" id="6274252">(</span><span class="op" id="6274253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274256">si</span><span class="op" id="6274258">,</span>&nbsp;<span class="ident" id="6274260">err</span>&nbsp;<span class="op" id="6274264">:=</span>&nbsp;<span class="ident" id="6274267">dc</span><span class="op" id="6274269">.</span><span class="ident" id="6274270">ci</span><span class="op" id="6274272">.</span><span class="ident" id="6274273">Prepare</span><span class="op" id="6274280">(</span><span class="ident" id="6274281">query</span><span class="op" id="6274286">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274289">dc</span><span class="op" id="6274291">.</span><span class="ident" id="6274292">Unlock</span><span class="op" id="6274298">(</span><span class="op" id="6274299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274302">if</span>&nbsp;<span class="ident" id="6274305">err</span>&nbsp;<span class="op" id="6274309">!=</span>&nbsp;<span class="ident" id="6274312">nil</span>&nbsp;<span class="op" id="6274316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274320">return</span>&nbsp;<span class="ident" id="6274327">nil</span><span class="op" id="6274330">,</span>&nbsp;<span class="ident" id="6274332">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274340">defer</span>&nbsp;<span class="ident" id="6274346">withLock</span><span class="op" id="6274354">(</span><span class="ident" id="6274355">dc</span><span class="op" id="6274357">,</span>&nbsp;<span class="keyword" id="6274359">func</span><span class="op" id="6274363">(</span><span class="op" id="6274364">)</span>&nbsp;<span class="op" id="6274366">{</span>&nbsp;<span class="ident" id="6274368">si</span><span class="op" id="6274370">.</span><span class="ident" id="6274371">Close</span><span class="op" id="6274376">(</span><span class="op" id="6274377">)</span>&nbsp;<span class="op" id="6274379">}</span><span class="op" id="6274380">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274383">return</span>&nbsp;<span class="ident" id="6274390">resultFromStatement</span><span class="op" id="6274409">(</span><span class="ident" id="6274410">driverStmt</span><span class="op" id="6274420">{</span><span class="ident" id="6274421">dc</span><span class="op" id="6274423">,</span>&nbsp;<span class="ident" id="6274425">si</span><span class="op" id="6274427">}</span><span class="op" id="6274428">,</span>&nbsp;<span class="ident" id="6274430">args</span><span class="op" id="6274434">...</span><span class="op" id="6274437">)</span><br>
<span class="lineno"></span><span class="op" id="6274439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6274442">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="6274507">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="6274568">func</span>&nbsp;<span class="op" id="6274573">(</span><span class="ident" id="6274574">db</span>&nbsp;<span class="op" id="6274577">*</span><span class="ident" id="6274578">DB</span><span class="op" id="6274580">)</span>&nbsp;<span class="ident" id="6274582">Query</span><span class="op" id="6274587">(</span><span class="ident" id="6274588">query</span>&nbsp;<span class="builtintype" id="6274594">string</span><span class="op" id="6274600">,</span>&nbsp;<span class="ident" id="6274602">args</span>&nbsp;<span class="op" id="6274607">...</span><span class="keyword" id="6274610">interface</span><span class="op" id="6274619">{</span><span class="op" id="6274620">}</span><span class="op" id="6274621">)</span>&nbsp;<span class="op" id="6274623">(</span><span class="op" id="6274624">*</span><span class="ident" id="6274625">Rows</span><span class="op" id="6274629">,</span>&nbsp;<span class="builtintype" id="6274631">error</span><span class="op" id="6274636">)</span>&nbsp;<span class="op" id="6274638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274641">var</span>&nbsp;<span class="ident" id="6274645">rows</span>&nbsp;<span class="op" id="6274650">*</span><span class="ident" id="6274651">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274657">var</span>&nbsp;<span class="ident" id="6274661">err</span>&nbsp;<span class="builtintype" id="6274665">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274672">for</span>&nbsp;<span class="ident" id="6274676">i</span>&nbsp;<span class="op" id="6274678">:=</span>&nbsp;<span class="num" id="6274681">0</span><span class="op" id="6274682">;</span>&nbsp;<span class="ident" id="6274684">i</span>&nbsp;<span class="op" id="6274686">&lt;</span>&nbsp;<span class="ident" id="6274688">maxBadConnRetries</span><span class="op" id="6274705">;</span>&nbsp;<span class="ident" id="6274707">i</span><span class="op" id="6274708">++</span>&nbsp;<span class="op" id="6274711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274715">rows</span><span class="op" id="6274719">,</span>&nbsp;<span class="ident" id="6274721">err</span>&nbsp;<span class="op" id="6274725">=</span>&nbsp;<span class="ident" id="6274727">db</span><span class="op" id="6274729">.</span><span class="ident" id="6274730">query</span><span class="op" id="6274735">(</span><span class="ident" id="6274736">query</span><span class="op" id="6274741">,</span>&nbsp;<span class="ident" id="6274743">args</span><span class="op" id="6274747">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274751">if</span>&nbsp;<span class="ident" id="6274754">err</span>&nbsp;<span class="op" id="6274758">!=</span>&nbsp;<span class="ident" id="6274761">driver</span><span class="op" id="6274767">.</span><span class="ident" id="6274768">ErrBadConn</span>&nbsp;<span class="op" id="6274779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274784">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274798">return</span>&nbsp;<span class="ident" id="6274805">rows</span><span class="op" id="6274809">,</span>&nbsp;<span class="ident" id="6274811">err</span><br>
<span class="lineno">930</span><span class="op" id="6274815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6274818">func</span>&nbsp;<span class="op" id="6274823">(</span><span class="ident" id="6274824">db</span>&nbsp;<span class="op" id="6274827">*</span><span class="ident" id="6274828">DB</span><span class="op" id="6274830">)</span>&nbsp;<span class="ident" id="6274832">query</span><span class="op" id="6274837">(</span><span class="ident" id="6274838">query</span>&nbsp;<span class="builtintype" id="6274844">string</span><span class="op" id="6274850">,</span>&nbsp;<span class="ident" id="6274852">args</span>&nbsp;<span class="op" id="6274857">[</span><span class="op" id="6274858">]</span><span class="keyword" id="6274859">interface</span><span class="op" id="6274868">{</span><span class="op" id="6274869">}</span><span class="op" id="6274870">)</span>&nbsp;<span class="op" id="6274872">(</span><span class="op" id="6274873">*</span><span class="ident" id="6274874">Rows</span><span class="op" id="6274878">,</span>&nbsp;<span class="builtintype" id="6274880">error</span><span class="op" id="6274885">)</span>&nbsp;<span class="op" id="6274887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6274890">ci</span><span class="op" id="6274892">,</span>&nbsp;<span class="ident" id="6274894">err</span>&nbsp;<span class="op" id="6274898">:=</span>&nbsp;<span class="ident" id="6274901">db</span><span class="op" id="6274903">.</span><span class="ident" id="6274904">conn</span><span class="op" id="6274908">(</span><span class="op" id="6274909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274912">if</span>&nbsp;<span class="ident" id="6274915">err</span>&nbsp;<span class="op" id="6274919">!=</span>&nbsp;<span class="ident" id="6274922">nil</span>&nbsp;<span class="op" id="6274926">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274930">return</span>&nbsp;<span class="ident" id="6274937">nil</span><span class="op" id="6274940">,</span>&nbsp;<span class="ident" id="6274942">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6274947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6274951">return</span>&nbsp;<span class="ident" id="6274958">db</span><span class="op" id="6274960">.</span><span class="ident" id="6274961">queryConn</span><span class="op" id="6274970">(</span><span class="ident" id="6274971">ci</span><span class="op" id="6274973">,</span>&nbsp;<span class="ident" id="6274975">ci</span><span class="op" id="6274977">.</span><span class="ident" id="6274978">releaseConn</span><span class="op" id="6274989">,</span>&nbsp;<span class="ident" id="6274991">query</span><span class="op" id="6274996">,</span>&nbsp;<span class="ident" id="6274998">args</span><span class="op" id="6275002">)</span><br>
<span class="lineno"></span><span class="op" id="6275004">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="6275007">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="6275062">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="6275123">func</span>&nbsp;<span class="op" id="6275128">(</span><span class="ident" id="6275129">db</span>&nbsp;<span class="op" id="6275132">*</span><span class="ident" id="6275133">DB</span><span class="op" id="6275135">)</span>&nbsp;<span class="ident" id="6275137">queryConn</span><span class="op" id="6275146">(</span><span class="ident" id="6275147">dc</span>&nbsp;<span class="op" id="6275150">*</span><span class="ident" id="6275151">driverConn</span><span class="op" id="6275161">,</span>&nbsp;<span class="ident" id="6275163">releaseConn</span>&nbsp;<span class="keyword" id="6275175">func</span><span class="op" id="6275179">(</span><span class="builtintype" id="6275180">error</span><span class="op" id="6275185">)</span><span class="op" id="6275186">,</span>&nbsp;<span class="ident" id="6275188">query</span>&nbsp;<span class="builtintype" id="6275194">string</span><span class="op" id="6275200">,</span>&nbsp;<span class="ident" id="6275202">args</span>&nbsp;<span class="op" id="6275207">[</span><span class="op" id="6275208">]</span><span class="keyword" id="6275209">interface</span><span class="op" id="6275218">{</span><span class="op" id="6275219">}</span><span class="op" id="6275220">)</span>&nbsp;<span class="op" id="6275222">(</span><span class="op" id="6275223">*</span><span class="ident" id="6275224">Rows</span><span class="op" id="6275228">,</span>&nbsp;<span class="builtintype" id="6275230">error</span><span class="op" id="6275235">)</span>&nbsp;<span class="op" id="6275237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275240">if</span>&nbsp;<span class="ident" id="6275243">queryer</span><span class="op" id="6275250">,</span>&nbsp;<span class="ident" id="6275252">ok</span>&nbsp;<span class="op" id="6275255">:=</span>&nbsp;<span class="ident" id="6275258">dc</span><span class="op" id="6275260">.</span><span class="ident" id="6275261">ci</span><span class="op" id="6275263">.</span><span class="op" id="6275264">(</span><span class="ident" id="6275265">driver</span><span class="op" id="6275271">.</span><span class="ident" id="6275272">Queryer</span><span class="op" id="6275279">)</span><span class="op" id="6275280">;</span>&nbsp;<span class="ident" id="6275282">ok</span>&nbsp;<span class="op" id="6275285">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275289">dargs</span><span class="op" id="6275294">,</span>&nbsp;<span class="ident" id="6275296">err</span>&nbsp;<span class="op" id="6275300">:=</span>&nbsp;<span class="ident" id="6275303">driverArgs</span><span class="op" id="6275313">(</span><span class="ident" id="6275314">nil</span><span class="op" id="6275317">,</span>&nbsp;<span class="ident" id="6275319">args</span><span class="op" id="6275323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275327">if</span>&nbsp;<span class="ident" id="6275330">err</span>&nbsp;<span class="op" id="6275334">!=</span>&nbsp;<span class="ident" id="6275337">nil</span>&nbsp;<span class="op" id="6275341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275346">releaseConn</span><span class="op" id="6275357">(</span><span class="ident" id="6275358">err</span><span class="op" id="6275361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275366">return</span>&nbsp;<span class="ident" id="6275373">nil</span><span class="op" id="6275376">,</span>&nbsp;<span class="ident" id="6275378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275384">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275388">dc</span><span class="op" id="6275390">.</span><span class="ident" id="6275391">Lock</span><span class="op" id="6275395">(</span><span class="op" id="6275396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275400">rowsi</span><span class="op" id="6275405">,</span>&nbsp;<span class="ident" id="6275407">err</span>&nbsp;<span class="op" id="6275411">:=</span>&nbsp;<span class="ident" id="6275414">queryer</span><span class="op" id="6275421">.</span><span class="ident" id="6275422">Query</span><span class="op" id="6275427">(</span><span class="ident" id="6275428">query</span><span class="op" id="6275433">,</span>&nbsp;<span class="ident" id="6275435">dargs</span><span class="op" id="6275440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275444">dc</span><span class="op" id="6275446">.</span><span class="ident" id="6275447">Unlock</span><span class="op" id="6275453">(</span><span class="op" id="6275454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275458">if</span>&nbsp;<span class="ident" id="6275461">err</span>&nbsp;<span class="op" id="6275465">!=</span>&nbsp;<span class="ident" id="6275468">driver</span><span class="op" id="6275474">.</span><span class="ident" id="6275475">ErrSkip</span>&nbsp;<span class="op" id="6275483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275488">if</span>&nbsp;<span class="ident" id="6275491">err</span>&nbsp;<span class="op" id="6275495">!=</span>&nbsp;<span class="ident" id="6275498">nil</span>&nbsp;<span class="op" id="6275502">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275508">releaseConn</span><span class="op" id="6275519">(</span><span class="ident" id="6275520">err</span><span class="op" id="6275523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275529">return</span>&nbsp;<span class="ident" id="6275536">nil</span><span class="op" id="6275539">,</span>&nbsp;<span class="ident" id="6275541">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6275553">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6275614">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275638">rows</span>&nbsp;<span class="op" id="6275643">:=</span>&nbsp;<span class="op" id="6275646">&amp;</span><span class="ident" id="6275647">Rows</span><span class="op" id="6275651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275657">dc</span><span class="op" id="6275659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6275670">dc</span><span class="op" id="6275672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275678">releaseConn</span><span class="op" id="6275689">:</span>&nbsp;<span class="ident" id="6275691">releaseConn</span><span class="op" id="6275702">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275708">rowsi</span><span class="op" id="6275713">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6275721">rowsi</span><span class="op" id="6275726">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275731">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275736">return</span>&nbsp;<span class="ident" id="6275743">rows</span><span class="op" id="6275747">,</span>&nbsp;<span class="ident" id="6275749">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275762">dc</span><span class="op" id="6275764">.</span><span class="ident" id="6275765">Lock</span><span class="op" id="6275769">(</span><span class="op" id="6275770">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275773">si</span><span class="op" id="6275775">,</span>&nbsp;<span class="ident" id="6275777">err</span>&nbsp;<span class="op" id="6275781">:=</span>&nbsp;<span class="ident" id="6275784">dc</span><span class="op" id="6275786">.</span><span class="ident" id="6275787">ci</span><span class="op" id="6275789">.</span><span class="ident" id="6275790">Prepare</span><span class="op" id="6275797">(</span><span class="ident" id="6275798">query</span><span class="op" id="6275803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275806">dc</span><span class="op" id="6275808">.</span><span class="ident" id="6275809">Unlock</span><span class="op" id="6275815">(</span><span class="op" id="6275816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275819">if</span>&nbsp;<span class="ident" id="6275822">err</span>&nbsp;<span class="op" id="6275826">!=</span>&nbsp;<span class="ident" id="6275829">nil</span>&nbsp;<span class="op" id="6275833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275837">releaseConn</span><span class="op" id="6275848">(</span><span class="ident" id="6275849">err</span><span class="op" id="6275852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275856">return</span>&nbsp;<span class="ident" id="6275863">nil</span><span class="op" id="6275866">,</span>&nbsp;<span class="ident" id="6275868">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6275873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275877">ds</span>&nbsp;<span class="op" id="6275880">:=</span>&nbsp;<span class="ident" id="6275883">driverStmt</span><span class="op" id="6275893">{</span><span class="ident" id="6275894">dc</span><span class="op" id="6275896">,</span>&nbsp;<span class="ident" id="6275898">si</span><span class="op" id="6275900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275903">rowsi</span><span class="op" id="6275908">,</span>&nbsp;<span class="ident" id="6275910">err</span>&nbsp;<span class="op" id="6275914">:=</span>&nbsp;<span class="ident" id="6275917">rowsiFromStatement</span><span class="op" id="6275935">(</span><span class="ident" id="6275936">ds</span><span class="op" id="6275938">,</span>&nbsp;<span class="ident" id="6275940">args</span><span class="op" id="6275944">...</span><span class="op" id="6275947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6275950">if</span>&nbsp;<span class="ident" id="6275953">err</span>&nbsp;<span class="op" id="6275957">!=</span>&nbsp;<span class="ident" id="6275960">nil</span>&nbsp;<span class="op" id="6275964">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275968">dc</span><span class="op" id="6275970">.</span><span class="ident" id="6275971">Lock</span><span class="op" id="6275975">(</span><span class="op" id="6275976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275980">si</span><span class="op" id="6275982">.</span><span class="ident" id="6275983">Close</span><span class="op" id="6275988">(</span><span class="op" id="6275989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6275993">dc</span><span class="op" id="6275995">.</span><span class="ident" id="6275996">Unlock</span><span class="op" id="6276002">(</span><span class="op" id="6276003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276007">releaseConn</span><span class="op" id="6276018">(</span><span class="ident" id="6276019">err</span><span class="op" id="6276022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276026">return</span>&nbsp;<span class="ident" id="6276033">nil</span><span class="op" id="6276036">,</span>&nbsp;<span class="ident" id="6276038">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6276047">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6276106">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276128">rows</span>&nbsp;<span class="op" id="6276133">:=</span>&nbsp;<span class="op" id="6276136">&amp;</span><span class="ident" id="6276137">Rows</span><span class="op" id="6276141">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276145">dc</span><span class="op" id="6276147">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6276158">dc</span><span class="op" id="6276160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276164">releaseConn</span><span class="op" id="6276175">:</span>&nbsp;<span class="ident" id="6276177">releaseConn</span><span class="op" id="6276188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276192">rowsi</span><span class="op" id="6276197">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6276205">rowsi</span><span class="op" id="6276210">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276214">closeStmt</span><span class="op" id="6276223">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6276227">si</span><span class="op" id="6276229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276232">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276235">return</span>&nbsp;<span class="ident" id="6276242">rows</span><span class="op" id="6276246">,</span>&nbsp;<span class="ident" id="6276248">nil</span><br>
<span class="lineno"></span><span class="op" id="6276252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6276255">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6276328">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="6276397">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="6276429">func</span>&nbsp;<span class="op" id="6276434">(</span><span class="ident" id="6276435">db</span>&nbsp;<span class="op" id="6276438">*</span><span class="ident" id="6276439">DB</span><span class="op" id="6276441">)</span>&nbsp;<span class="ident" id="6276443">QueryRow</span><span class="op" id="6276451">(</span><span class="ident" id="6276452">query</span>&nbsp;<span class="builtintype" id="6276458">string</span><span class="op" id="6276464">,</span>&nbsp;<span class="ident" id="6276466">args</span>&nbsp;<span class="op" id="6276471">...</span><span class="keyword" id="6276474">interface</span><span class="op" id="6276483">{</span><span class="op" id="6276484">}</span><span class="op" id="6276485">)</span>&nbsp;<span class="op" id="6276487">*</span><span class="ident" id="6276488">Row</span>&nbsp;<span class="op" id="6276492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276495">rows</span><span class="op" id="6276499">,</span>&nbsp;<span class="ident" id="6276501">err</span>&nbsp;<span class="op" id="6276505">:=</span>&nbsp;<span class="ident" id="6276508">db</span><span class="op" id="6276510">.</span><span class="ident" id="6276511">Query</span><span class="op" id="6276516">(</span><span class="ident" id="6276517">query</span><span class="op" id="6276522">,</span>&nbsp;<span class="ident" id="6276524">args</span><span class="op" id="6276528">...</span><span class="op" id="6276531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276534">return</span>&nbsp;<span class="op" id="6276541">&amp;</span><span class="ident" id="6276542">Row</span><span class="op" id="6276545">{</span><span class="ident" id="6276546">rows</span><span class="op" id="6276550">:</span>&nbsp;<span class="ident" id="6276552">rows</span><span class="op" id="6276556">,</span>&nbsp;<span class="ident" id="6276558">err</span><span class="op" id="6276561">:</span>&nbsp;<span class="ident" id="6276563">err</span><span class="op" id="6276566">}</span><br>
<span class="lineno"></span><span class="op" id="6276568">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="6276571">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6276638">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="6276653">func</span>&nbsp;<span class="op" id="6276658">(</span><span class="ident" id="6276659">db</span>&nbsp;<span class="op" id="6276662">*</span><span class="ident" id="6276663">DB</span><span class="op" id="6276665">)</span>&nbsp;<span class="ident" id="6276667">Begin</span><span class="op" id="6276672">(</span><span class="op" id="6276673">)</span>&nbsp;<span class="op" id="6276675">(</span><span class="op" id="6276676">*</span><span class="ident" id="6276677">Tx</span><span class="op" id="6276679">,</span>&nbsp;<span class="builtintype" id="6276681">error</span><span class="op" id="6276686">)</span>&nbsp;<span class="op" id="6276688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276691">var</span>&nbsp;<span class="ident" id="6276695">tx</span>&nbsp;<span class="op" id="6276698">*</span><span class="ident" id="6276699">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276703">var</span>&nbsp;<span class="ident" id="6276707">err</span>&nbsp;<span class="builtintype" id="6276711">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276718">for</span>&nbsp;<span class="ident" id="6276722">i</span>&nbsp;<span class="op" id="6276724">:=</span>&nbsp;<span class="num" id="6276727">0</span><span class="op" id="6276728">;</span>&nbsp;<span class="ident" id="6276730">i</span>&nbsp;<span class="op" id="6276732">&lt;</span>&nbsp;<span class="ident" id="6276734">maxBadConnRetries</span><span class="op" id="6276751">;</span>&nbsp;<span class="ident" id="6276753">i</span><span class="op" id="6276754">++</span>&nbsp;<span class="op" id="6276757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276761">tx</span><span class="op" id="6276763">,</span>&nbsp;<span class="ident" id="6276765">err</span>&nbsp;<span class="op" id="6276769">=</span>&nbsp;<span class="ident" id="6276771">db</span><span class="op" id="6276773">.</span><span class="ident" id="6276774">begin</span><span class="op" id="6276779">(</span><span class="op" id="6276780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276784">if</span>&nbsp;<span class="ident" id="6276787">err</span>&nbsp;<span class="op" id="6276791">!=</span>&nbsp;<span class="ident" id="6276794">driver</span><span class="op" id="6276800">.</span><span class="ident" id="6276801">ErrBadConn</span>&nbsp;<span class="op" id="6276812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276817">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276831">return</span>&nbsp;<span class="ident" id="6276838">tx</span><span class="op" id="6276840">,</span>&nbsp;<span class="ident" id="6276842">err</span><br>
<span class="lineno"></span><span class="op" id="6276846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="6276849">func</span>&nbsp;<span class="op" id="6276854">(</span><span class="ident" id="6276855">db</span>&nbsp;<span class="op" id="6276858">*</span><span class="ident" id="6276859">DB</span><span class="op" id="6276861">)</span>&nbsp;<span class="ident" id="6276863">begin</span><span class="op" id="6276868">(</span><span class="op" id="6276869">)</span>&nbsp;<span class="op" id="6276871">(</span><span class="ident" id="6276872">tx</span>&nbsp;<span class="op" id="6276875">*</span><span class="ident" id="6276876">Tx</span><span class="op" id="6276878">,</span>&nbsp;<span class="ident" id="6276880">err</span>&nbsp;<span class="builtintype" id="6276884">error</span><span class="op" id="6276889">)</span>&nbsp;<span class="op" id="6276891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276894">dc</span><span class="op" id="6276896">,</span>&nbsp;<span class="ident" id="6276898">err</span>&nbsp;<span class="op" id="6276902">:=</span>&nbsp;<span class="ident" id="6276905">db</span><span class="op" id="6276907">.</span><span class="ident" id="6276908">conn</span><span class="op" id="6276912">(</span><span class="op" id="6276913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276916">if</span>&nbsp;<span class="ident" id="6276919">err</span>&nbsp;<span class="op" id="6276923">!=</span>&nbsp;<span class="ident" id="6276926">nil</span>&nbsp;<span class="op" id="6276930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6276934">return</span>&nbsp;<span class="ident" id="6276941">nil</span><span class="op" id="6276944">,</span>&nbsp;<span class="ident" id="6276946">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6276951">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276954">dc</span><span class="op" id="6276956">.</span><span class="ident" id="6276957">Lock</span><span class="op" id="6276961">(</span><span class="op" id="6276962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276965">txi</span><span class="op" id="6276968">,</span>&nbsp;<span class="ident" id="6276970">err</span>&nbsp;<span class="op" id="6276974">:=</span>&nbsp;<span class="ident" id="6276977">dc</span><span class="op" id="6276979">.</span><span class="ident" id="6276980">ci</span><span class="op" id="6276982">.</span><span class="ident" id="6276983">Begin</span><span class="op" id="6276988">(</span><span class="op" id="6276989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6276992">dc</span><span class="op" id="6276994">.</span><span class="ident" id="6276995">Unlock</span><span class="op" id="6277001">(</span><span class="op" id="6277002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277005">if</span>&nbsp;<span class="ident" id="6277008">err</span>&nbsp;<span class="op" id="6277012">!=</span>&nbsp;<span class="ident" id="6277015">nil</span>&nbsp;<span class="op" id="6277019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277023">db</span><span class="op" id="6277025">.</span><span class="ident" id="6277026">putConn</span><span class="op" id="6277033">(</span><span class="ident" id="6277034">dc</span><span class="op" id="6277036">,</span>&nbsp;<span class="ident" id="6277038">err</span><span class="op" id="6277041">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277045">return</span>&nbsp;<span class="ident" id="6277052">nil</span><span class="op" id="6277055">,</span>&nbsp;<span class="ident" id="6277057">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277065">return</span>&nbsp;<span class="op" id="6277072">&amp;</span><span class="ident" id="6277073">Tx</span><span class="op" id="6277075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277079">db</span><span class="op" id="6277081">:</span>&nbsp;&nbsp;<span class="ident" id="6277084">db</span><span class="op" id="6277086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277090">dc</span><span class="op" id="6277092">:</span>&nbsp;&nbsp;<span class="ident" id="6277095">dc</span><span class="op" id="6277097">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277101">txi</span><span class="op" id="6277104">:</span>&nbsp;<span class="ident" id="6277106">txi</span><span class="op" id="6277109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277112">}</span><span class="op" id="6277113">,</span>&nbsp;<span class="ident" id="6277115">nil</span><br>
<span class="lineno"></span><span class="op" id="6277119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6277122">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="6277174">func</span>&nbsp;<span class="op" id="6277179">(</span><span class="ident" id="6277180">db</span>&nbsp;<span class="op" id="6277183">*</span><span class="ident" id="6277184">DB</span><span class="op" id="6277186">)</span>&nbsp;<span class="ident" id="6277188">Driver</span><span class="op" id="6277194">(</span><span class="op" id="6277195">)</span>&nbsp;<span class="ident" id="6277197">driver</span><span class="op" id="6277203">.</span><span class="ident" id="6277204">Driver</span>&nbsp;<span class="op" id="6277211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6277214">return</span>&nbsp;<span class="ident" id="6277221">db</span><span class="op" id="6277223">.</span><span class="ident" id="6277224">driver</span><br>
<span class="lineno"></span><span class="op" id="6277231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6277234">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="6277280">//</span><br>
<span class="lineno"></span><span class="comment" id="6277283">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="6277344">//</span><br>
<span class="lineno"></span><span class="comment" id="6277347">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6277408">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="6277444">type</span>&nbsp;<span class="ident" id="6277449">Tx</span>&nbsp;<span class="keyword" id="6277452">struct</span>&nbsp;<span class="op" id="6277459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277462">db</span>&nbsp;<span class="op" id="6277465">*</span><span class="ident" id="6277466">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277471">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277540">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277572">dc</span>&nbsp;&nbsp;<span class="op" id="6277576">*</span><span class="ident" id="6277577">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277589">txi</span>&nbsp;<span class="ident" id="6277593">driver</span><span class="op" id="6277599">.</span><span class="ident" id="6277600">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277605">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277669">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277722">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277737">done</span>&nbsp;<span class="builtintype" id="6277742">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277749">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277826">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277877">stmts</span>&nbsp;<span class="keyword" id="6277883">struct</span>&nbsp;<span class="op" id="6277890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277894">sync</span><span class="op" id="6277898">.</span><span class="ident" id="6277899">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277907">v</span>&nbsp;<span class="op" id="6277909">[</span><span class="op" id="6277910">]</span><span class="op" id="6277911">*</span><span class="ident" id="6277912">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6277918">}</span><br>
<span class="lineno"></span><span class="op" id="6277920">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="6277923">var</span>&nbsp;<span class="ident" id="6277927">ErrTxDone</span>&nbsp;<span class="op" id="6277937">=</span>&nbsp;<span class="ident" id="6277939">errors</span><span class="op" id="6277945">.</span><span class="ident" id="6277946">New</span><span class="op" id="6277949">(</span><span class="string" id="6277950">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="6278010">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278013">func</span>&nbsp;<span class="op" id="6278018">(</span><span class="ident" id="6278019">tx</span>&nbsp;<span class="op" id="6278022">*</span><span class="ident" id="6278023">Tx</span><span class="op" id="6278025">)</span>&nbsp;<span class="builtinfunc" id="6278027">close</span><span class="op" id="6278032">(</span><span class="op" id="6278033">)</span>&nbsp;<span class="op" id="6278035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278038">if</span>&nbsp;<span class="ident" id="6278041">tx</span><span class="op" id="6278043">.</span><span class="ident" id="6278044">done</span>&nbsp;<span class="op" id="6278049">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6278053">panic</span><span class="op" id="6278058">(</span><span class="string" id="6278059">&#34;double&nbsp;close&#34;</span><span class="op" id="6278073">)</span>&nbsp;<span class="comment" id="6278075">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278097">tx</span><span class="op" id="6278099">.</span><span class="ident" id="6278100">done</span>&nbsp;<span class="op" id="6278105">=</span>&nbsp;<span class="builtintype" id="6278107">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278113">tx</span><span class="op" id="6278115">.</span><span class="ident" id="6278116">db</span><span class="op" id="6278118">.</span><span class="ident" id="6278119">putConn</span><span class="op" id="6278126">(</span><span class="ident" id="6278127">tx</span><span class="op" id="6278129">.</span><span class="ident" id="6278130">dc</span><span class="op" id="6278132">,</span>&nbsp;<span class="ident" id="6278134">nil</span><span class="op" id="6278137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278140">tx</span><span class="op" id="6278142">.</span><span class="ident" id="6278143">dc</span>&nbsp;<span class="op" id="6278146">=</span>&nbsp;<span class="ident" id="6278148">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278153">tx</span><span class="op" id="6278155">.</span><span class="ident" id="6278156">txi</span>&nbsp;<span class="op" id="6278160">=</span>&nbsp;<span class="ident" id="6278162">nil</span><br>
<span class="lineno"></span><span class="op" id="6278166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278169">func</span>&nbsp;<span class="op" id="6278174">(</span><span class="ident" id="6278175">tx</span>&nbsp;<span class="op" id="6278178">*</span><span class="ident" id="6278179">Tx</span><span class="op" id="6278181">)</span>&nbsp;<span class="ident" id="6278183">grabConn</span><span class="op" id="6278191">(</span><span class="op" id="6278192">)</span>&nbsp;<span class="op" id="6278194">(</span><span class="op" id="6278195">*</span><span class="ident" id="6278196">driverConn</span><span class="op" id="6278206">,</span>&nbsp;<span class="builtintype" id="6278208">error</span><span class="op" id="6278213">)</span>&nbsp;<span class="op" id="6278215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278218">if</span>&nbsp;<span class="ident" id="6278221">tx</span><span class="op" id="6278223">.</span><span class="ident" id="6278224">done</span>&nbsp;<span class="op" id="6278229">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278233">return</span>&nbsp;<span class="ident" id="6278240">nil</span><span class="op" id="6278243">,</span>&nbsp;<span class="ident" id="6278245">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278259">return</span>&nbsp;<span class="ident" id="6278266">tx</span><span class="op" id="6278268">.</span><span class="ident" id="6278269">dc</span><span class="op" id="6278271">,</span>&nbsp;<span class="ident" id="6278273">nil</span><br>
<span class="lineno"></span><span class="op" id="6278277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="6278280">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="6278331">func</span>&nbsp;<span class="op" id="6278336">(</span><span class="ident" id="6278337">tx</span>&nbsp;<span class="op" id="6278340">*</span><span class="ident" id="6278341">Tx</span><span class="op" id="6278343">)</span>&nbsp;<span class="ident" id="6278345">closePrepared</span><span class="op" id="6278358">(</span><span class="op" id="6278359">)</span>&nbsp;<span class="op" id="6278361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278364">tx</span><span class="op" id="6278366">.</span><span class="ident" id="6278367">stmts</span><span class="op" id="6278372">.</span><span class="ident" id="6278373">Lock</span><span class="op" id="6278377">(</span><span class="op" id="6278378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278381">for</span>&nbsp;<span class="ident" id="6278385">_</span><span class="op" id="6278386">,</span>&nbsp;<span class="ident" id="6278388">stmt</span>&nbsp;<span class="op" id="6278393">:=</span>&nbsp;<span class="keyword" id="6278396">range</span>&nbsp;<span class="ident" id="6278402">tx</span><span class="op" id="6278404">.</span><span class="ident" id="6278405">stmts</span><span class="op" id="6278410">.</span><span class="ident" id="6278411">v</span>&nbsp;<span class="op" id="6278413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278417">stmt</span><span class="op" id="6278421">.</span><span class="ident" id="6278422">Close</span><span class="op" id="6278427">(</span><span class="op" id="6278428">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278434">tx</span><span class="op" id="6278436">.</span><span class="ident" id="6278437">stmts</span><span class="op" id="6278442">.</span><span class="ident" id="6278443">Unlock</span><span class="op" id="6278449">(</span><span class="op" id="6278450">)</span><br>
<span class="lineno"></span><span class="op" id="6278452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6278455">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="6278490">func</span>&nbsp;<span class="op" id="6278495">(</span><span class="ident" id="6278496">tx</span>&nbsp;<span class="op" id="6278499">*</span><span class="ident" id="6278500">Tx</span><span class="op" id="6278502">)</span>&nbsp;<span class="ident" id="6278504">Commit</span><span class="op" id="6278510">(</span><span class="op" id="6278511">)</span>&nbsp;<span class="builtintype" id="6278513">error</span>&nbsp;<span class="op" id="6278519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278522">if</span>&nbsp;<span class="ident" id="6278525">tx</span><span class="op" id="6278527">.</span><span class="ident" id="6278528">done</span>&nbsp;<span class="op" id="6278533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278537">return</span>&nbsp;<span class="ident" id="6278544">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278558">defer</span>&nbsp;<span class="ident" id="6278564">tx</span><span class="op" id="6278566">.</span><span class="builtinfunc" id="6278567">close</span><span class="op" id="6278572">(</span><span class="op" id="6278573">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278576">tx</span><span class="op" id="6278578">.</span><span class="ident" id="6278579">dc</span><span class="op" id="6278581">.</span><span class="ident" id="6278582">Lock</span><span class="op" id="6278586">(</span><span class="op" id="6278587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278590">err</span>&nbsp;<span class="op" id="6278594">:=</span>&nbsp;<span class="ident" id="6278597">tx</span><span class="op" id="6278599">.</span><span class="ident" id="6278600">txi</span><span class="op" id="6278603">.</span><span class="ident" id="6278604">Commit</span><span class="op" id="6278610">(</span><span class="op" id="6278611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278614">tx</span><span class="op" id="6278616">.</span><span class="ident" id="6278617">dc</span><span class="op" id="6278619">.</span><span class="ident" id="6278620">Unlock</span><span class="op" id="6278626">(</span><span class="op" id="6278627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278630">if</span>&nbsp;<span class="ident" id="6278633">err</span>&nbsp;<span class="op" id="6278637">!=</span>&nbsp;<span class="ident" id="6278640">driver</span><span class="op" id="6278646">.</span><span class="ident" id="6278647">ErrBadConn</span>&nbsp;<span class="op" id="6278658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278662">tx</span><span class="op" id="6278664">.</span><span class="ident" id="6278665">closePrepared</span><span class="op" id="6278678">(</span><span class="op" id="6278679">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278685">return</span>&nbsp;<span class="ident" id="6278692">err</span><br>
<span class="lineno"></span><span class="op" id="6278696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6278699">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="6278735">func</span>&nbsp;<span class="op" id="6278740">(</span><span class="ident" id="6278741">tx</span>&nbsp;<span class="op" id="6278744">*</span><span class="ident" id="6278745">Tx</span><span class="op" id="6278747">)</span>&nbsp;<span class="ident" id="6278749">Rollback</span><span class="op" id="6278757">(</span><span class="op" id="6278758">)</span>&nbsp;<span class="builtintype" id="6278760">error</span>&nbsp;<span class="op" id="6278766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278769">if</span>&nbsp;<span class="ident" id="6278772">tx</span><span class="op" id="6278774">.</span><span class="ident" id="6278775">done</span>&nbsp;<span class="op" id="6278780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278784">return</span>&nbsp;<span class="ident" id="6278791">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278805">defer</span>&nbsp;<span class="ident" id="6278811">tx</span><span class="op" id="6278813">.</span><span class="builtinfunc" id="6278814">close</span><span class="op" id="6278819">(</span><span class="op" id="6278820">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278823">tx</span><span class="op" id="6278825">.</span><span class="ident" id="6278826">dc</span><span class="op" id="6278828">.</span><span class="ident" id="6278829">Lock</span><span class="op" id="6278833">(</span><span class="op" id="6278834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278837">err</span>&nbsp;<span class="op" id="6278841">:=</span>&nbsp;<span class="ident" id="6278844">tx</span><span class="op" id="6278846">.</span><span class="ident" id="6278847">txi</span><span class="op" id="6278850">.</span><span class="ident" id="6278851">Rollback</span><span class="op" id="6278859">(</span><span class="op" id="6278860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278863">tx</span><span class="op" id="6278865">.</span><span class="ident" id="6278866">dc</span><span class="op" id="6278868">.</span><span class="ident" id="6278869">Unlock</span><span class="op" id="6278875">(</span><span class="op" id="6278876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278879">if</span>&nbsp;<span class="ident" id="6278882">err</span>&nbsp;<span class="op" id="6278886">!=</span>&nbsp;<span class="ident" id="6278889">driver</span><span class="op" id="6278895">.</span><span class="ident" id="6278896">ErrBadConn</span>&nbsp;<span class="op" id="6278907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278911">tx</span><span class="op" id="6278913">.</span><span class="ident" id="6278914">closePrepared</span><span class="op" id="6278927">(</span><span class="op" id="6278928">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278934">return</span>&nbsp;<span class="ident" id="6278941">err</span><br>
<span class="lineno"></span><span class="op" id="6278945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6278948">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="6279018">//</span><br>
<span class="lineno"></span><span class="comment" id="6279021">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="6279097">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="6279164">//</span><br>
<span class="lineno"></span><span class="comment" id="6279167">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="6279242">func</span>&nbsp;<span class="op" id="6279247">(</span><span class="ident" id="6279248">tx</span>&nbsp;<span class="op" id="6279251">*</span><span class="ident" id="6279252">Tx</span><span class="op" id="6279254">)</span>&nbsp;<span class="ident" id="6279256">Prepare</span><span class="op" id="6279263">(</span><span class="ident" id="6279264">query</span>&nbsp;<span class="builtintype" id="6279270">string</span><span class="op" id="6279276">)</span>&nbsp;<span class="op" id="6279278">(</span><span class="op" id="6279279">*</span><span class="ident" id="6279280">Stmt</span><span class="op" id="6279284">,</span>&nbsp;<span class="builtintype" id="6279286">error</span><span class="op" id="6279291">)</span>&nbsp;<span class="op" id="6279293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279296">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279359">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279417">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279481">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279544">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279600">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279661">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279723">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279782">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279842">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279902">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279961">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280025">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280066">dc</span><span class="op" id="6280068">,</span>&nbsp;<span class="ident" id="6280070">err</span>&nbsp;<span class="op" id="6280074">:=</span>&nbsp;<span class="ident" id="6280077">tx</span><span class="op" id="6280079">.</span><span class="ident" id="6280080">grabConn</span><span class="op" id="6280088">(</span><span class="op" id="6280089">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280092">if</span>&nbsp;<span class="ident" id="6280095">err</span>&nbsp;<span class="op" id="6280099">!=</span>&nbsp;<span class="ident" id="6280102">nil</span>&nbsp;<span class="op" id="6280106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280110">return</span>&nbsp;<span class="ident" id="6280117">nil</span><span class="op" id="6280120">,</span>&nbsp;<span class="ident" id="6280122">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280131">dc</span><span class="op" id="6280133">.</span><span class="ident" id="6280134">Lock</span><span class="op" id="6280138">(</span><span class="op" id="6280139">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280142">si</span><span class="op" id="6280144">,</span>&nbsp;<span class="ident" id="6280146">err</span>&nbsp;<span class="op" id="6280150">:=</span>&nbsp;<span class="ident" id="6280153">dc</span><span class="op" id="6280155">.</span><span class="ident" id="6280156">ci</span><span class="op" id="6280158">.</span><span class="ident" id="6280159">Prepare</span><span class="op" id="6280166">(</span><span class="ident" id="6280167">query</span><span class="op" id="6280172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280175">dc</span><span class="op" id="6280177">.</span><span class="ident" id="6280178">Unlock</span><span class="op" id="6280184">(</span><span class="op" id="6280185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280188">if</span>&nbsp;<span class="ident" id="6280191">err</span>&nbsp;<span class="op" id="6280195">!=</span>&nbsp;<span class="ident" id="6280198">nil</span>&nbsp;<span class="op" id="6280202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280206">return</span>&nbsp;<span class="ident" id="6280213">nil</span><span class="op" id="6280216">,</span>&nbsp;<span class="ident" id="6280218">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280223">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280227">stmt</span>&nbsp;<span class="op" id="6280232">:=</span>&nbsp;<span class="op" id="6280235">&amp;</span><span class="ident" id="6280236">Stmt</span><span class="op" id="6280240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280244">db</span><span class="op" id="6280246">:</span>&nbsp;<span class="ident" id="6280248">tx</span><span class="op" id="6280250">.</span><span class="ident" id="6280251">db</span><span class="op" id="6280253">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280257">tx</span><span class="op" id="6280259">:</span>&nbsp;<span class="ident" id="6280261">tx</span><span class="op" id="6280263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280267">txsi</span><span class="op" id="6280271">:</span>&nbsp;<span class="op" id="6280273">&amp;</span><span class="ident" id="6280274">driverStmt</span><span class="op" id="6280284">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280289">Locker</span><span class="op" id="6280295">:</span>&nbsp;<span class="ident" id="6280297">dc</span><span class="op" id="6280299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280304">si</span><span class="op" id="6280306">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280312">si</span><span class="op" id="6280314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280318">}</span><span class="op" id="6280319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280323">query</span><span class="op" id="6280328">:</span>&nbsp;<span class="ident" id="6280330">query</span><span class="op" id="6280335">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6280338">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280341">tx</span><span class="op" id="6280343">.</span><span class="ident" id="6280344">stmts</span><span class="op" id="6280349">.</span><span class="ident" id="6280350">Lock</span><span class="op" id="6280354">(</span><span class="op" id="6280355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280358">tx</span><span class="op" id="6280360">.</span><span class="ident" id="6280361">stmts</span><span class="op" id="6280366">.</span><span class="ident" id="6280367">v</span>&nbsp;<span class="op" id="6280369">=</span>&nbsp;<span class="builtinfunc" id="6280371">append</span><span class="op" id="6280377">(</span><span class="ident" id="6280378">tx</span><span class="op" id="6280380">.</span><span class="ident" id="6280381">stmts</span><span class="op" id="6280386">.</span><span class="ident" id="6280387">v</span><span class="op" id="6280388">,</span>&nbsp;<span class="ident" id="6280390">stmt</span><span class="op" id="6280394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280397">tx</span><span class="op" id="6280399">.</span><span class="ident" id="6280400">stmts</span><span class="op" id="6280405">.</span><span class="ident" id="6280406">Unlock</span><span class="op" id="6280412">(</span><span class="op" id="6280413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280416">return</span>&nbsp;<span class="ident" id="6280423">stmt</span><span class="op" id="6280427">,</span>&nbsp;<span class="ident" id="6280429">nil</span><br>
<span class="lineno"></span><span class="op" id="6280433">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="6280436">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="6280499">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="6280525">//</span><br>
<span class="lineno"></span><span class="comment" id="6280528">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="6280540">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6280622">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6280630">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="6280656">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6280664">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="6280724">func</span>&nbsp;<span class="op" id="6280729">(</span><span class="ident" id="6280730">tx</span>&nbsp;<span class="op" id="6280733">*</span><span class="ident" id="6280734">Tx</span><span class="op" id="6280736">)</span>&nbsp;<span class="ident" id="6280738">Stmt</span><span class="op" id="6280742">(</span><span class="ident" id="6280743">stmt</span>&nbsp;<span class="op" id="6280748">*</span><span class="ident" id="6280749">Stmt</span><span class="op" id="6280753">)</span>&nbsp;<span class="op" id="6280755">*</span><span class="ident" id="6280756">Stmt</span>&nbsp;<span class="op" id="6280761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280764">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280826">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280889">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6280944">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6280999">if</span>&nbsp;<span class="ident" id="6281002">tx</span><span class="op" id="6281004">.</span><span class="ident" id="6281005">db</span>&nbsp;<span class="op" id="6281008">!=</span>&nbsp;<span class="ident" id="6281011">stmt</span><span class="op" id="6281015">.</span><span class="ident" id="6281016">db</span>&nbsp;<span class="op" id="6281019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281023">return</span>&nbsp;<span class="op" id="6281030">&amp;</span><span class="ident" id="6281031">Stmt</span><span class="op" id="6281035">{</span><span class="ident" id="6281036">stickyErr</span><span class="op" id="6281045">:</span>&nbsp;<span class="ident" id="6281047">errors</span><span class="op" id="6281053">.</span><span class="ident" id="6281054">New</span><span class="op" id="6281057">(</span><span class="string" id="6281058">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="6281112">)</span><span class="op" id="6281113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281119">dc</span><span class="op" id="6281121">,</span>&nbsp;<span class="ident" id="6281123">err</span>&nbsp;<span class="op" id="6281127">:=</span>&nbsp;<span class="ident" id="6281130">tx</span><span class="op" id="6281132">.</span><span class="ident" id="6281133">grabConn</span><span class="op" id="6281141">(</span><span class="op" id="6281142">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281145">if</span>&nbsp;<span class="ident" id="6281148">err</span>&nbsp;<span class="op" id="6281152">!=</span>&nbsp;<span class="ident" id="6281155">nil</span>&nbsp;<span class="op" id="6281159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281163">return</span>&nbsp;<span class="op" id="6281170">&amp;</span><span class="ident" id="6281171">Stmt</span><span class="op" id="6281175">{</span><span class="ident" id="6281176">stickyErr</span><span class="op" id="6281185">:</span>&nbsp;<span class="ident" id="6281187">err</span><span class="op" id="6281190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281196">dc</span><span class="op" id="6281198">.</span><span class="ident" id="6281199">Lock</span><span class="op" id="6281203">(</span><span class="op" id="6281204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281207">si</span><span class="op" id="6281209">,</span>&nbsp;<span class="ident" id="6281211">err</span>&nbsp;<span class="op" id="6281215">:=</span>&nbsp;<span class="ident" id="6281218">dc</span><span class="op" id="6281220">.</span><span class="ident" id="6281221">ci</span><span class="op" id="6281223">.</span><span class="ident" id="6281224">Prepare</span><span class="op" id="6281231">(</span><span class="ident" id="6281232">stmt</span><span class="op" id="6281236">.</span><span class="ident" id="6281237">query</span><span class="op" id="6281242">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281245">dc</span><span class="op" id="6281247">.</span><span class="ident" id="6281248">Unlock</span><span class="op" id="6281254">(</span><span class="op" id="6281255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281258">txs</span>&nbsp;<span class="op" id="6281262">:=</span>&nbsp;<span class="op" id="6281265">&amp;</span><span class="ident" id="6281266">Stmt</span><span class="op" id="6281270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281274">db</span><span class="op" id="6281276">:</span>&nbsp;<span class="ident" id="6281278">tx</span><span class="op" id="6281280">.</span><span class="ident" id="6281281">db</span><span class="op" id="6281283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281287">tx</span><span class="op" id="6281289">:</span>&nbsp;<span class="ident" id="6281291">tx</span><span class="op" id="6281293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281297">txsi</span><span class="op" id="6281301">:</span>&nbsp;<span class="op" id="6281303">&amp;</span><span class="ident" id="6281304">driverStmt</span><span class="op" id="6281314">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281319">Locker</span><span class="op" id="6281325">:</span>&nbsp;<span class="ident" id="6281327">dc</span><span class="op" id="6281329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281334">si</span><span class="op" id="6281336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281342">si</span><span class="op" id="6281344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281348">}</span><span class="op" id="6281349">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281353">query</span><span class="op" id="6281358">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281364">stmt</span><span class="op" id="6281368">.</span><span class="ident" id="6281369">query</span><span class="op" id="6281374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281378">stickyErr</span><span class="op" id="6281387">:</span>&nbsp;<span class="ident" id="6281389">err</span><span class="op" id="6281392">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281398">tx</span><span class="op" id="6281400">.</span><span class="ident" id="6281401">stmts</span><span class="op" id="6281406">.</span><span class="ident" id="6281407">Lock</span><span class="op" id="6281411">(</span><span class="op" id="6281412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281415">tx</span><span class="op" id="6281417">.</span><span class="ident" id="6281418">stmts</span><span class="op" id="6281423">.</span><span class="ident" id="6281424">v</span>&nbsp;<span class="op" id="6281426">=</span>&nbsp;<span class="builtinfunc" id="6281428">append</span><span class="op" id="6281434">(</span><span class="ident" id="6281435">tx</span><span class="op" id="6281437">.</span><span class="ident" id="6281438">stmts</span><span class="op" id="6281443">.</span><span class="ident" id="6281444">v</span><span class="op" id="6281445">,</span>&nbsp;<span class="ident" id="6281447">txs</span><span class="op" id="6281450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281453">tx</span><span class="op" id="6281455">.</span><span class="ident" id="6281456">stmts</span><span class="op" id="6281461">.</span><span class="ident" id="6281462">Unlock</span><span class="op" id="6281468">(</span><span class="op" id="6281469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281472">return</span>&nbsp;<span class="ident" id="6281479">txs</span><br>
<span class="lineno">1215</span><span class="op" id="6281483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6281486">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="6281537">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="6281575">func</span>&nbsp;<span class="op" id="6281580">(</span><span class="ident" id="6281581">tx</span>&nbsp;<span class="op" id="6281584">*</span><span class="ident" id="6281585">Tx</span><span class="op" id="6281587">)</span>&nbsp;<span class="ident" id="6281589">Exec</span><span class="op" id="6281593">(</span><span class="ident" id="6281594">query</span>&nbsp;<span class="builtintype" id="6281600">string</span><span class="op" id="6281606">,</span>&nbsp;<span class="ident" id="6281608">args</span>&nbsp;<span class="op" id="6281613">...</span><span class="keyword" id="6281616">interface</span><span class="op" id="6281625">{</span><span class="op" id="6281626">}</span><span class="op" id="6281627">)</span>&nbsp;<span class="op" id="6281629">(</span><span class="ident" id="6281630">Result</span><span class="op" id="6281636">,</span>&nbsp;<span class="builtintype" id="6281638">error</span><span class="op" id="6281643">)</span>&nbsp;<span class="op" id="6281645">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281648">dc</span><span class="op" id="6281650">,</span>&nbsp;<span class="ident" id="6281652">err</span>&nbsp;<span class="op" id="6281656">:=</span>&nbsp;<span class="ident" id="6281659">tx</span><span class="op" id="6281661">.</span><span class="ident" id="6281662">grabConn</span><span class="op" id="6281670">(</span><span class="op" id="6281671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281674">if</span>&nbsp;<span class="ident" id="6281677">err</span>&nbsp;<span class="op" id="6281681">!=</span>&nbsp;<span class="ident" id="6281684">nil</span>&nbsp;<span class="op" id="6281688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281692">return</span>&nbsp;<span class="ident" id="6281699">nil</span><span class="op" id="6281702">,</span>&nbsp;<span class="ident" id="6281704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281713">if</span>&nbsp;<span class="ident" id="6281716">execer</span><span class="op" id="6281722">,</span>&nbsp;<span class="ident" id="6281724">ok</span>&nbsp;<span class="op" id="6281727">:=</span>&nbsp;<span class="ident" id="6281730">dc</span><span class="op" id="6281732">.</span><span class="ident" id="6281733">ci</span><span class="op" id="6281735">.</span><span class="op" id="6281736">(</span><span class="ident" id="6281737">driver</span><span class="op" id="6281743">.</span><span class="ident" id="6281744">Execer</span><span class="op" id="6281750">)</span><span class="op" id="6281751">;</span>&nbsp;<span class="ident" id="6281753">ok</span>&nbsp;<span class="op" id="6281756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281760">dargs</span><span class="op" id="6281765">,</span>&nbsp;<span class="ident" id="6281767">err</span>&nbsp;<span class="op" id="6281771">:=</span>&nbsp;<span class="ident" id="6281774">driverArgs</span><span class="op" id="6281784">(</span><span class="ident" id="6281785">nil</span><span class="op" id="6281788">,</span>&nbsp;<span class="ident" id="6281790">args</span><span class="op" id="6281794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281798">if</span>&nbsp;<span class="ident" id="6281801">err</span>&nbsp;<span class="op" id="6281805">!=</span>&nbsp;<span class="ident" id="6281808">nil</span>&nbsp;<span class="op" id="6281812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281817">return</span>&nbsp;<span class="ident" id="6281824">nil</span><span class="op" id="6281827">,</span>&nbsp;<span class="ident" id="6281829">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281835">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281839">dc</span><span class="op" id="6281841">.</span><span class="ident" id="6281842">Lock</span><span class="op" id="6281846">(</span><span class="op" id="6281847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281851">resi</span><span class="op" id="6281855">,</span>&nbsp;<span class="ident" id="6281857">err</span>&nbsp;<span class="op" id="6281861">:=</span>&nbsp;<span class="ident" id="6281864">execer</span><span class="op" id="6281870">.</span><span class="ident" id="6281871">Exec</span><span class="op" id="6281875">(</span><span class="ident" id="6281876">query</span><span class="op" id="6281881">,</span>&nbsp;<span class="ident" id="6281883">dargs</span><span class="op" id="6281888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6281892">dc</span><span class="op" id="6281894">.</span><span class="ident" id="6281895">Unlock</span><span class="op" id="6281901">(</span><span class="op" id="6281902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281906">if</span>&nbsp;<span class="ident" id="6281909">err</span>&nbsp;<span class="op" id="6281913">==</span>&nbsp;<span class="ident" id="6281916">nil</span>&nbsp;<span class="op" id="6281920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281925">return</span>&nbsp;<span class="ident" id="6281932">driverResult</span><span class="op" id="6281944">{</span><span class="ident" id="6281945">dc</span><span class="op" id="6281947">,</span>&nbsp;<span class="ident" id="6281949">resi</span><span class="op" id="6281953">}</span><span class="op" id="6281954">,</span>&nbsp;<span class="ident" id="6281956">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6281962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281966">if</span>&nbsp;<span class="ident" id="6281969">err</span>&nbsp;<span class="op" id="6281973">!=</span>&nbsp;<span class="ident" id="6281976">driver</span><span class="op" id="6281982">.</span><span class="ident" id="6281983">ErrSkip</span>&nbsp;<span class="op" id="6281991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6281996">return</span>&nbsp;<span class="ident" id="6282003">nil</span><span class="op" id="6282006">,</span>&nbsp;<span class="ident" id="6282008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282017">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282021">dc</span><span class="op" id="6282023">.</span><span class="ident" id="6282024">Lock</span><span class="op" id="6282028">(</span><span class="op" id="6282029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282032">si</span><span class="op" id="6282034">,</span>&nbsp;<span class="ident" id="6282036">err</span>&nbsp;<span class="op" id="6282040">:=</span>&nbsp;<span class="ident" id="6282043">dc</span><span class="op" id="6282045">.</span><span class="ident" id="6282046">ci</span><span class="op" id="6282048">.</span><span class="ident" id="6282049">Prepare</span><span class="op" id="6282056">(</span><span class="ident" id="6282057">query</span><span class="op" id="6282062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282065">dc</span><span class="op" id="6282067">.</span><span class="ident" id="6282068">Unlock</span><span class="op" id="6282074">(</span><span class="op" id="6282075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282078">if</span>&nbsp;<span class="ident" id="6282081">err</span>&nbsp;<span class="op" id="6282085">!=</span>&nbsp;<span class="ident" id="6282088">nil</span>&nbsp;<span class="op" id="6282092">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282096">return</span>&nbsp;<span class="ident" id="6282103">nil</span><span class="op" id="6282106">,</span>&nbsp;<span class="ident" id="6282108">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282116">defer</span>&nbsp;<span class="ident" id="6282122">withLock</span><span class="op" id="6282130">(</span><span class="ident" id="6282131">dc</span><span class="op" id="6282133">,</span>&nbsp;<span class="keyword" id="6282135">func</span><span class="op" id="6282139">(</span><span class="op" id="6282140">)</span>&nbsp;<span class="op" id="6282142">{</span>&nbsp;<span class="ident" id="6282144">si</span><span class="op" id="6282146">.</span><span class="ident" id="6282147">Close</span><span class="op" id="6282152">(</span><span class="op" id="6282153">)</span>&nbsp;<span class="op" id="6282155">}</span><span class="op" id="6282156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282160">return</span>&nbsp;<span class="ident" id="6282167">resultFromStatement</span><span class="op" id="6282186">(</span><span class="ident" id="6282187">driverStmt</span><span class="op" id="6282197">{</span><span class="ident" id="6282198">dc</span><span class="op" id="6282200">,</span>&nbsp;<span class="ident" id="6282202">si</span><span class="op" id="6282204">}</span><span class="op" id="6282205">,</span>&nbsp;<span class="ident" id="6282207">args</span><span class="op" id="6282211">...</span><span class="op" id="6282214">)</span><br>
<span class="lineno">1250</span><span class="op" id="6282216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6282219">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="6282284">func</span>&nbsp;<span class="op" id="6282289">(</span><span class="ident" id="6282290">tx</span>&nbsp;<span class="op" id="6282293">*</span><span class="ident" id="6282294">Tx</span><span class="op" id="6282296">)</span>&nbsp;<span class="ident" id="6282298">Query</span><span class="op" id="6282303">(</span><span class="ident" id="6282304">query</span>&nbsp;<span class="builtintype" id="6282310">string</span><span class="op" id="6282316">,</span>&nbsp;<span class="ident" id="6282318">args</span>&nbsp;<span class="op" id="6282323">...</span><span class="keyword" id="6282326">interface</span><span class="op" id="6282335">{</span><span class="op" id="6282336">}</span><span class="op" id="6282337">)</span>&nbsp;<span class="op" id="6282339">(</span><span class="op" id="6282340">*</span><span class="ident" id="6282341">Rows</span><span class="op" id="6282345">,</span>&nbsp;<span class="builtintype" id="6282347">error</span><span class="op" id="6282352">)</span>&nbsp;<span class="op" id="6282354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282357">dc</span><span class="op" id="6282359">,</span>&nbsp;<span class="ident" id="6282361">err</span>&nbsp;<span class="op" id="6282365">:=</span>&nbsp;<span class="ident" id="6282368">tx</span><span class="op" id="6282370">.</span><span class="ident" id="6282371">grabConn</span><span class="op" id="6282379">(</span><span class="op" id="6282380">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282383">if</span>&nbsp;<span class="ident" id="6282386">err</span>&nbsp;<span class="op" id="6282390">!=</span>&nbsp;<span class="ident" id="6282393">nil</span>&nbsp;<span class="op" id="6282397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282401">return</span>&nbsp;<span class="ident" id="6282408">nil</span><span class="op" id="6282411">,</span>&nbsp;<span class="ident" id="6282413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6282418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282421">releaseConn</span>&nbsp;<span class="op" id="6282433">:=</span>&nbsp;<span class="keyword" id="6282436">func</span><span class="op" id="6282440">(</span><span class="builtintype" id="6282441">error</span><span class="op" id="6282446">)</span>&nbsp;<span class="op" id="6282448">{</span><span class="op" id="6282449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282452">return</span>&nbsp;<span class="ident" id="6282459">tx</span><span class="op" id="6282461">.</span><span class="ident" id="6282462">db</span><span class="op" id="6282464">.</span><span class="ident" id="6282465">queryConn</span><span class="op" id="6282474">(</span><span class="ident" id="6282475">dc</span><span class="op" id="6282477">,</span>&nbsp;<span class="ident" id="6282479">releaseConn</span><span class="op" id="6282490">,</span>&nbsp;<span class="ident" id="6282492">query</span><span class="op" id="6282497">,</span>&nbsp;<span class="ident" id="6282499">args</span><span class="op" id="6282503">)</span><br>
<span class="lineno">1260</span><span class="op" id="6282505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6282508">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="6282581">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6282650">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="6282682">func</span>&nbsp;<span class="op" id="6282687">(</span><span class="ident" id="6282688">tx</span>&nbsp;<span class="op" id="6282691">*</span><span class="ident" id="6282692">Tx</span><span class="op" id="6282694">)</span>&nbsp;<span class="ident" id="6282696">QueryRow</span><span class="op" id="6282704">(</span><span class="ident" id="6282705">query</span>&nbsp;<span class="builtintype" id="6282711">string</span><span class="op" id="6282717">,</span>&nbsp;<span class="ident" id="6282719">args</span>&nbsp;<span class="op" id="6282724">...</span><span class="keyword" id="6282727">interface</span><span class="op" id="6282736">{</span><span class="op" id="6282737">}</span><span class="op" id="6282738">)</span>&nbsp;<span class="op" id="6282740">*</span><span class="ident" id="6282741">Row</span>&nbsp;<span class="op" id="6282745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282748">rows</span><span class="op" id="6282752">,</span>&nbsp;<span class="ident" id="6282754">err</span>&nbsp;<span class="op" id="6282758">:=</span>&nbsp;<span class="ident" id="6282761">tx</span><span class="op" id="6282763">.</span><span class="ident" id="6282764">Query</span><span class="op" id="6282769">(</span><span class="ident" id="6282770">query</span><span class="op" id="6282775">,</span>&nbsp;<span class="ident" id="6282777">args</span><span class="op" id="6282781">...</span><span class="op" id="6282784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6282787">return</span>&nbsp;<span class="op" id="6282794">&amp;</span><span class="ident" id="6282795">Row</span><span class="op" id="6282798">{</span><span class="ident" id="6282799">rows</span><span class="op" id="6282803">:</span>&nbsp;<span class="ident" id="6282805">rows</span><span class="op" id="6282809">,</span>&nbsp;<span class="ident" id="6282811">err</span><span class="op" id="6282814">:</span>&nbsp;<span class="ident" id="6282816">err</span><span class="op" id="6282819">}</span><br>
<span class="lineno"></span><span class="op" id="6282821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="6282824">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6282888">type</span>&nbsp;<span class="ident" id="6282893">connStmt</span>&nbsp;<span class="keyword" id="6282902">struct</span>&nbsp;<span class="op" id="6282909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282912">dc</span>&nbsp;<span class="op" id="6282915">*</span><span class="ident" id="6282916">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6282928">si</span>&nbsp;<span class="ident" id="6282931">driver</span><span class="op" id="6282937">.</span><span class="ident" id="6282938">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6282943">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="6282946">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6283035">type</span>&nbsp;<span class="ident" id="6283040">Stmt</span>&nbsp;<span class="keyword" id="6283045">struct</span>&nbsp;<span class="op" id="6283052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283055">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283070">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6283080">*</span><span class="ident" id="6283081">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283087">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283110">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6283120">string</span>&nbsp;<span class="comment" id="6283127">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283153">stickyErr</span>&nbsp;<span class="builtintype" id="6283163">error</span>&nbsp;&nbsp;<span class="comment" id="6283170">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283229">closemu</span>&nbsp;<span class="ident" id="6283237">sync</span><span class="op" id="6283241">.</span><span class="ident" id="6283242">RWMutex</span>&nbsp;<span class="comment" id="6283250">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283306">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283346">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6283351">*</span><span class="ident" id="6283352">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283356">txsi</span>&nbsp;<span class="op" id="6283361">*</span><span class="ident" id="6283362">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283375">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283382">sync</span><span class="op" id="6283386">.</span><span class="ident" id="6283387">Mutex</span>&nbsp;<span class="comment" id="6283393">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283429">closed</span>&nbsp;<span class="builtintype" id="6283436">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283443">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283503">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283563">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6283616">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283669">css</span>&nbsp;<span class="op" id="6283673">[</span><span class="op" id="6283674">]</span><span class="ident" id="6283675">connStmt</span><br>
<span class="lineno"></span><span class="op" id="6283684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6283687">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="6283754">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6283815">func</span>&nbsp;<span class="op" id="6283820">(</span><span class="ident" id="6283821">s</span>&nbsp;<span class="op" id="6283823">*</span><span class="ident" id="6283824">Stmt</span><span class="op" id="6283828">)</span>&nbsp;<span class="ident" id="6283830">Exec</span><span class="op" id="6283834">(</span><span class="ident" id="6283835">args</span>&nbsp;<span class="op" id="6283840">...</span><span class="keyword" id="6283843">interface</span><span class="op" id="6283852">{</span><span class="op" id="6283853">}</span><span class="op" id="6283854">)</span>&nbsp;<span class="op" id="6283856">(</span><span class="ident" id="6283857">Result</span><span class="op" id="6283863">,</span>&nbsp;<span class="builtintype" id="6283865">error</span><span class="op" id="6283870">)</span>&nbsp;<span class="op" id="6283872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283875">s</span><span class="op" id="6283876">.</span><span class="ident" id="6283877">closemu</span><span class="op" id="6283884">.</span><span class="ident" id="6283885">RLock</span><span class="op" id="6283890">(</span><span class="op" id="6283891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283894">defer</span>&nbsp;<span class="ident" id="6283900">s</span><span class="op" id="6283901">.</span><span class="ident" id="6283902">closemu</span><span class="op" id="6283909">.</span><span class="ident" id="6283910">RUnlock</span><span class="op" id="6283917">(</span><span class="op" id="6283918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283922">var</span>&nbsp;<span class="ident" id="6283926">res</span>&nbsp;<span class="ident" id="6283930">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6283938">for</span>&nbsp;<span class="ident" id="6283942">i</span>&nbsp;<span class="op" id="6283944">:=</span>&nbsp;<span class="num" id="6283947">0</span><span class="op" id="6283948">;</span>&nbsp;<span class="ident" id="6283950">i</span>&nbsp;<span class="op" id="6283952">&lt;</span>&nbsp;<span class="ident" id="6283954">maxBadConnRetries</span><span class="op" id="6283971">;</span>&nbsp;<span class="ident" id="6283973">i</span><span class="op" id="6283974">++</span>&nbsp;<span class="op" id="6283977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6283981">dc</span><span class="op" id="6283983">,</span>&nbsp;<span class="ident" id="6283985">releaseConn</span><span class="op" id="6283996">,</span>&nbsp;<span class="ident" id="6283998">si</span><span class="op" id="6284000">,</span>&nbsp;<span class="ident" id="6284002">err</span>&nbsp;<span class="op" id="6284006">:=</span>&nbsp;<span class="ident" id="6284009">s</span><span class="op" id="6284010">.</span><span class="ident" id="6284011">connStmt</span><span class="op" id="6284019">(</span><span class="op" id="6284020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284024">if</span>&nbsp;<span class="ident" id="6284027">err</span>&nbsp;<span class="op" id="6284031">!=</span>&nbsp;<span class="ident" id="6284034">nil</span>&nbsp;<span class="op" id="6284038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284043">if</span>&nbsp;<span class="ident" id="6284046">err</span>&nbsp;<span class="op" id="6284050">==</span>&nbsp;<span class="ident" id="6284053">driver</span><span class="op" id="6284059">.</span><span class="ident" id="6284060">ErrBadConn</span>&nbsp;<span class="op" id="6284071">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284077">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284094">return</span>&nbsp;<span class="ident" id="6284101">nil</span><span class="op" id="6284104">,</span>&nbsp;<span class="ident" id="6284106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284117">res</span><span class="op" id="6284120">,</span>&nbsp;<span class="ident" id="6284122">err</span>&nbsp;<span class="op" id="6284126">=</span>&nbsp;<span class="ident" id="6284128">resultFromStatement</span><span class="op" id="6284147">(</span><span class="ident" id="6284148">driverStmt</span><span class="op" id="6284158">{</span><span class="ident" id="6284159">dc</span><span class="op" id="6284161">,</span>&nbsp;<span class="ident" id="6284163">si</span><span class="op" id="6284165">}</span><span class="op" id="6284166">,</span>&nbsp;<span class="ident" id="6284168">args</span><span class="op" id="6284172">...</span><span class="op" id="6284175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284179">releaseConn</span><span class="op" id="6284190">(</span><span class="ident" id="6284191">err</span><span class="op" id="6284194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284198">if</span>&nbsp;<span class="ident" id="6284201">err</span>&nbsp;<span class="op" id="6284205">!=</span>&nbsp;<span class="ident" id="6284208">driver</span><span class="op" id="6284214">.</span><span class="ident" id="6284215">ErrBadConn</span>&nbsp;<span class="op" id="6284226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284231">return</span>&nbsp;<span class="ident" id="6284238">res</span><span class="op" id="6284241">,</span>&nbsp;<span class="ident" id="6284243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284249">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284255">return</span>&nbsp;<span class="ident" id="6284262">nil</span><span class="op" id="6284265">,</span>&nbsp;<span class="ident" id="6284267">driver</span><span class="op" id="6284273">.</span><span class="ident" id="6284274">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6284285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284288">func</span>&nbsp;<span class="ident" id="6284293">resultFromStatement</span><span class="op" id="6284312">(</span><span class="ident" id="6284313">ds</span>&nbsp;<span class="ident" id="6284316">driverStmt</span><span class="op" id="6284326">,</span>&nbsp;<span class="ident" id="6284328">args</span>&nbsp;<span class="op" id="6284333">...</span><span class="keyword" id="6284336">interface</span><span class="op" id="6284345">{</span><span class="op" id="6284346">}</span><span class="op" id="6284347">)</span>&nbsp;<span class="op" id="6284349">(</span><span class="ident" id="6284350">Result</span><span class="op" id="6284356">,</span>&nbsp;<span class="builtintype" id="6284358">error</span><span class="op" id="6284363">)</span>&nbsp;<span class="op" id="6284365">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284368">ds</span><span class="op" id="6284370">.</span><span class="ident" id="6284371">Lock</span><span class="op" id="6284375">(</span><span class="op" id="6284376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284379">want</span>&nbsp;<span class="op" id="6284384">:=</span>&nbsp;<span class="ident" id="6284387">ds</span><span class="op" id="6284389">.</span><span class="ident" id="6284390">si</span><span class="op" id="6284392">.</span><span class="ident" id="6284393">NumInput</span><span class="op" id="6284401">(</span><span class="op" id="6284402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284405">ds</span><span class="op" id="6284407">.</span><span class="ident" id="6284408">Unlock</span><span class="op" id="6284414">(</span><span class="op" id="6284415">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284419">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284483">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6284557">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284586">if</span>&nbsp;<span class="ident" id="6284589">want</span>&nbsp;<span class="op" id="6284594">!=</span>&nbsp;<span class="op" id="6284597">-</span><span class="num" id="6284598">1</span>&nbsp;<span class="op" id="6284600">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6284603">len</span><span class="op" id="6284606">(</span><span class="ident" id="6284607">args</span><span class="op" id="6284611">)</span>&nbsp;<span class="op" id="6284613">!=</span>&nbsp;<span class="ident" id="6284616">want</span>&nbsp;<span class="op" id="6284621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284625">return</span>&nbsp;<span class="ident" id="6284632">nil</span><span class="op" id="6284635">,</span>&nbsp;<span class="ident" id="6284637">fmt</span><span class="op" id="6284640">.</span><span class="ident" id="6284641">Errorf</span><span class="op" id="6284647">(</span><span class="string" id="6284648">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6284684">,</span>&nbsp;<span class="ident" id="6284686">want</span><span class="op" id="6284690">,</span>&nbsp;<span class="builtinfunc" id="6284692">len</span><span class="op" id="6284695">(</span><span class="ident" id="6284696">args</span><span class="op" id="6284700">)</span><span class="op" id="6284701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284704">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284708">dargs</span><span class="op" id="6284713">,</span>&nbsp;<span class="ident" id="6284715">err</span>&nbsp;<span class="op" id="6284719">:=</span>&nbsp;<span class="ident" id="6284722">driverArgs</span><span class="op" id="6284732">(</span><span class="op" id="6284733">&amp;</span><span class="ident" id="6284734">ds</span><span class="op" id="6284736">,</span>&nbsp;<span class="ident" id="6284738">args</span><span class="op" id="6284742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284745">if</span>&nbsp;<span class="ident" id="6284748">err</span>&nbsp;<span class="op" id="6284752">!=</span>&nbsp;<span class="ident" id="6284755">nil</span>&nbsp;<span class="op" id="6284759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284763">return</span>&nbsp;<span class="ident" id="6284770">nil</span><span class="op" id="6284773">,</span>&nbsp;<span class="ident" id="6284775">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284780">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284784">ds</span><span class="op" id="6284786">.</span><span class="ident" id="6284787">Lock</span><span class="op" id="6284791">(</span><span class="op" id="6284792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284795">resi</span><span class="op" id="6284799">,</span>&nbsp;<span class="ident" id="6284801">err</span>&nbsp;<span class="op" id="6284805">:=</span>&nbsp;<span class="ident" id="6284808">ds</span><span class="op" id="6284810">.</span><span class="ident" id="6284811">si</span><span class="op" id="6284813">.</span><span class="ident" id="6284814">Exec</span><span class="op" id="6284818">(</span><span class="ident" id="6284819">dargs</span><span class="op" id="6284824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6284827">ds</span><span class="op" id="6284829">.</span><span class="ident" id="6284830">Unlock</span><span class="op" id="6284836">(</span><span class="op" id="6284837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284840">if</span>&nbsp;<span class="ident" id="6284843">err</span>&nbsp;<span class="op" id="6284847">!=</span>&nbsp;<span class="ident" id="6284850">nil</span>&nbsp;<span class="op" id="6284854">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284858">return</span>&nbsp;<span class="ident" id="6284865">nil</span><span class="op" id="6284868">,</span>&nbsp;<span class="ident" id="6284870">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6284875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6284878">return</span>&nbsp;<span class="ident" id="6284885">driverResult</span><span class="op" id="6284897">{</span><span class="ident" id="6284898">ds</span><span class="op" id="6284900">.</span><span class="ident" id="6284901">Locker</span><span class="op" id="6284907">,</span>&nbsp;<span class="ident" id="6284909">resi</span><span class="op" id="6284913">}</span><span class="op" id="6284914">,</span>&nbsp;<span class="ident" id="6284916">nil</span><br>
<span class="lineno"></span><span class="op" id="6284920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="6284923">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6284992">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6285058">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6285097">func</span>&nbsp;<span class="op" id="6285102">(</span><span class="ident" id="6285103">s</span>&nbsp;<span class="op" id="6285105">*</span><span class="ident" id="6285106">Stmt</span><span class="op" id="6285110">)</span>&nbsp;<span class="ident" id="6285112">connStmt</span><span class="op" id="6285120">(</span><span class="op" id="6285121">)</span>&nbsp;<span class="op" id="6285123">(</span><span class="ident" id="6285124">ci</span>&nbsp;<span class="op" id="6285127">*</span><span class="ident" id="6285128">driverConn</span><span class="op" id="6285138">,</span>&nbsp;<span class="ident" id="6285140">releaseConn</span>&nbsp;<span class="keyword" id="6285152">func</span><span class="op" id="6285156">(</span><span class="builtintype" id="6285157">error</span><span class="op" id="6285162">)</span><span class="op" id="6285163">,</span>&nbsp;<span class="ident" id="6285165">si</span>&nbsp;<span class="ident" id="6285168">driver</span><span class="op" id="6285174">.</span><span class="ident" id="6285175">Stmt</span><span class="op" id="6285179">,</span>&nbsp;<span class="ident" id="6285181">err</span>&nbsp;<span class="builtintype" id="6285185">error</span><span class="op" id="6285190">)</span>&nbsp;<span class="op" id="6285192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285195">if</span>&nbsp;<span class="ident" id="6285198">err</span>&nbsp;<span class="op" id="6285202">=</span>&nbsp;<span class="ident" id="6285204">s</span><span class="op" id="6285205">.</span><span class="ident" id="6285206">stickyErr</span><span class="op" id="6285215">;</span>&nbsp;<span class="ident" id="6285217">err</span>&nbsp;<span class="op" id="6285221">!=</span>&nbsp;<span class="ident" id="6285224">nil</span>&nbsp;<span class="op" id="6285228">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285232">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285243">s</span><span class="op" id="6285244">.</span><span class="ident" id="6285245">mu</span><span class="op" id="6285247">.</span><span class="ident" id="6285248">Lock</span><span class="op" id="6285252">(</span><span class="op" id="6285253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285256">if</span>&nbsp;<span class="ident" id="6285259">s</span><span class="op" id="6285260">.</span><span class="ident" id="6285261">closed</span>&nbsp;<span class="op" id="6285268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285272">s</span><span class="op" id="6285273">.</span><span class="ident" id="6285274">mu</span><span class="op" id="6285276">.</span><span class="ident" id="6285277">Unlock</span><span class="op" id="6285283">(</span><span class="op" id="6285284">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285288">err</span>&nbsp;<span class="op" id="6285292">=</span>&nbsp;<span class="ident" id="6285294">errors</span><span class="op" id="6285300">.</span><span class="ident" id="6285301">New</span><span class="op" id="6285304">(</span><span class="string" id="6285305">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6285331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285335">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285347">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285407">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285439">if</span>&nbsp;<span class="ident" id="6285442">s</span><span class="op" id="6285443">.</span><span class="ident" id="6285444">tx</span>&nbsp;<span class="op" id="6285447">!=</span>&nbsp;<span class="ident" id="6285450">nil</span>&nbsp;<span class="op" id="6285454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285458">s</span><span class="op" id="6285459">.</span><span class="ident" id="6285460">mu</span><span class="op" id="6285462">.</span><span class="ident" id="6285463">Unlock</span><span class="op" id="6285469">(</span><span class="op" id="6285470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285474">ci</span><span class="op" id="6285476">,</span>&nbsp;<span class="ident" id="6285478">err</span>&nbsp;<span class="op" id="6285482">=</span>&nbsp;<span class="ident" id="6285484">s</span><span class="op" id="6285485">.</span><span class="ident" id="6285486">tx</span><span class="op" id="6285488">.</span><span class="ident" id="6285489">grabConn</span><span class="op" id="6285497">(</span><span class="op" id="6285498">)</span>&nbsp;<span class="comment" id="6285500">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285541">if</span>&nbsp;<span class="ident" id="6285544">err</span>&nbsp;<span class="op" id="6285548">!=</span>&nbsp;<span class="ident" id="6285551">nil</span>&nbsp;<span class="op" id="6285555">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285560">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285573">releaseConn</span>&nbsp;<span class="op" id="6285585">=</span>&nbsp;<span class="keyword" id="6285587">func</span><span class="op" id="6285591">(</span><span class="builtintype" id="6285592">error</span><span class="op" id="6285597">)</span>&nbsp;<span class="op" id="6285599">{</span><span class="op" id="6285600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285604">return</span>&nbsp;<span class="ident" id="6285611">ci</span><span class="op" id="6285613">,</span>&nbsp;<span class="ident" id="6285615">releaseConn</span><span class="op" id="6285626">,</span>&nbsp;<span class="ident" id="6285628">s</span><span class="op" id="6285629">.</span><span class="ident" id="6285630">txsi</span><span class="op" id="6285634">.</span><span class="ident" id="6285635">si</span><span class="op" id="6285637">,</span>&nbsp;<span class="ident" id="6285639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285644">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285648">for</span>&nbsp;<span class="ident" id="6285652">i</span>&nbsp;<span class="op" id="6285654">:=</span>&nbsp;<span class="num" id="6285657">0</span><span class="op" id="6285658">;</span>&nbsp;<span class="ident" id="6285660">i</span>&nbsp;<span class="op" id="6285662">&lt;</span>&nbsp;<span class="builtinfunc" id="6285664">len</span><span class="op" id="6285667">(</span><span class="ident" id="6285668">s</span><span class="op" id="6285669">.</span><span class="ident" id="6285670">css</span><span class="op" id="6285673">)</span><span class="op" id="6285674">;</span>&nbsp;<span class="ident" id="6285676">i</span><span class="op" id="6285677">++</span>&nbsp;<span class="op" id="6285680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285684">v</span>&nbsp;<span class="op" id="6285686">:=</span>&nbsp;<span class="ident" id="6285689">s</span><span class="op" id="6285690">.</span><span class="ident" id="6285691">css</span><span class="op" id="6285694">[</span><span class="ident" id="6285695">i</span><span class="op" id="6285696">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285700">_</span><span class="op" id="6285701">,</span>&nbsp;<span class="ident" id="6285703">err</span>&nbsp;<span class="op" id="6285707">:=</span>&nbsp;<span class="ident" id="6285710">s</span><span class="op" id="6285711">.</span><span class="ident" id="6285712">db</span><span class="op" id="6285714">.</span><span class="ident" id="6285715">connIfFree</span><span class="op" id="6285725">(</span><span class="ident" id="6285726">v</span><span class="op" id="6285727">.</span><span class="ident" id="6285728">dc</span><span class="op" id="6285730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285734">if</span>&nbsp;<span class="ident" id="6285737">err</span>&nbsp;<span class="op" id="6285741">==</span>&nbsp;<span class="ident" id="6285744">nil</span>&nbsp;<span class="op" id="6285748">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285753">s</span><span class="op" id="6285754">.</span><span class="ident" id="6285755">mu</span><span class="op" id="6285757">.</span><span class="ident" id="6285758">Unlock</span><span class="op" id="6285764">(</span><span class="op" id="6285765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285770">return</span>&nbsp;<span class="ident" id="6285777">v</span><span class="op" id="6285778">.</span><span class="ident" id="6285779">dc</span><span class="op" id="6285781">,</span>&nbsp;<span class="ident" id="6285783">v</span><span class="op" id="6285784">.</span><span class="ident" id="6285785">dc</span><span class="op" id="6285787">.</span><span class="ident" id="6285788">releaseConn</span><span class="op" id="6285799">,</span>&nbsp;<span class="ident" id="6285801">v</span><span class="op" id="6285802">.</span><span class="ident" id="6285803">si</span><span class="op" id="6285805">,</span>&nbsp;<span class="ident" id="6285807">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6285817">if</span>&nbsp;<span class="ident" id="6285820">err</span>&nbsp;<span class="op" id="6285824">==</span>&nbsp;<span class="ident" id="6285827">errConnClosed</span>&nbsp;<span class="op" id="6285841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285846">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285895">s</span><span class="op" id="6285896">.</span><span class="ident" id="6285897">css</span><span class="op" id="6285900">[</span><span class="ident" id="6285901">i</span><span class="op" id="6285902">]</span>&nbsp;<span class="op" id="6285904">=</span>&nbsp;<span class="ident" id="6285906">s</span><span class="op" id="6285907">.</span><span class="ident" id="6285908">css</span><span class="op" id="6285911">[</span><span class="builtinfunc" id="6285912">len</span><span class="op" id="6285915">(</span><span class="ident" id="6285916">s</span><span class="op" id="6285917">.</span><span class="ident" id="6285918">css</span><span class="op" id="6285921">)</span><span class="op" id="6285922">-</span><span class="num" id="6285923">1</span><span class="op" id="6285924">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285929">s</span><span class="op" id="6285930">.</span><span class="ident" id="6285931">css</span>&nbsp;<span class="op" id="6285935">=</span>&nbsp;<span class="ident" id="6285937">s</span><span class="op" id="6285938">.</span><span class="ident" id="6285939">css</span><span class="op" id="6285942">[</span><span class="op" id="6285943">:</span><span class="builtinfunc" id="6285944">len</span><span class="op" id="6285947">(</span><span class="ident" id="6285948">s</span><span class="op" id="6285949">.</span><span class="ident" id="6285950">css</span><span class="op" id="6285953">)</span><span class="op" id="6285954">-</span><span class="num" id="6285955">1</span><span class="op" id="6285956">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285961">i</span><span class="op" id="6285962">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6285971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6285974">s</span><span class="op" id="6285975">.</span><span class="ident" id="6285976">mu</span><span class="op" id="6285978">.</span><span class="ident" id="6285979">Unlock</span><span class="op" id="6285985">(</span><span class="op" id="6285986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6285990">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286067">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286141">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286154">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286158">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286227">dc</span><span class="op" id="6286229">,</span>&nbsp;<span class="ident" id="6286231">err</span>&nbsp;<span class="op" id="6286235">:=</span>&nbsp;<span class="ident" id="6286238">s</span><span class="op" id="6286239">.</span><span class="ident" id="6286240">db</span><span class="op" id="6286242">.</span><span class="ident" id="6286243">conn</span><span class="op" id="6286247">(</span><span class="op" id="6286248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286251">if</span>&nbsp;<span class="ident" id="6286254">err</span>&nbsp;<span class="op" id="6286258">!=</span>&nbsp;<span class="ident" id="6286261">nil</span>&nbsp;<span class="op" id="6286265">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286269">return</span>&nbsp;<span class="ident" id="6286276">nil</span><span class="op" id="6286279">,</span>&nbsp;<span class="ident" id="6286281">nil</span><span class="op" id="6286284">,</span>&nbsp;<span class="ident" id="6286286">nil</span><span class="op" id="6286289">,</span>&nbsp;<span class="ident" id="6286291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286300">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286368">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286428">s</span><span class="op" id="6286429">.</span><span class="ident" id="6286430">mu</span><span class="op" id="6286432">.</span><span class="ident" id="6286433">Lock</span><span class="op" id="6286437">(</span><span class="op" id="6286438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286441">for</span>&nbsp;<span class="ident" id="6286445">_</span><span class="op" id="6286446">,</span>&nbsp;<span class="ident" id="6286448">v</span>&nbsp;<span class="op" id="6286450">:=</span>&nbsp;<span class="keyword" id="6286453">range</span>&nbsp;<span class="ident" id="6286459">s</span><span class="op" id="6286460">.</span><span class="ident" id="6286461">css</span>&nbsp;<span class="op" id="6286465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286469">if</span>&nbsp;<span class="ident" id="6286472">v</span><span class="op" id="6286473">.</span><span class="ident" id="6286474">dc</span>&nbsp;<span class="op" id="6286477">==</span>&nbsp;<span class="ident" id="6286480">dc</span>&nbsp;<span class="op" id="6286483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286488">s</span><span class="op" id="6286489">.</span><span class="ident" id="6286490">mu</span><span class="op" id="6286492">.</span><span class="ident" id="6286493">Unlock</span><span class="op" id="6286499">(</span><span class="op" id="6286500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286505">return</span>&nbsp;<span class="ident" id="6286512">dc</span><span class="op" id="6286514">,</span>&nbsp;<span class="ident" id="6286516">dc</span><span class="op" id="6286518">.</span><span class="ident" id="6286519">releaseConn</span><span class="op" id="6286530">,</span>&nbsp;<span class="ident" id="6286532">v</span><span class="op" id="6286533">.</span><span class="ident" id="6286534">si</span><span class="op" id="6286536">,</span>&nbsp;<span class="ident" id="6286538">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286550">s</span><span class="op" id="6286551">.</span><span class="ident" id="6286552">mu</span><span class="op" id="6286554">.</span><span class="ident" id="6286555">Unlock</span><span class="op" id="6286561">(</span><span class="op" id="6286562">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6286566">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286631">dc</span><span class="op" id="6286633">.</span><span class="ident" id="6286634">Lock</span><span class="op" id="6286638">(</span><span class="op" id="6286639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286642">si</span><span class="op" id="6286644">,</span>&nbsp;<span class="ident" id="6286646">err</span>&nbsp;<span class="op" id="6286650">=</span>&nbsp;<span class="ident" id="6286652">dc</span><span class="op" id="6286654">.</span><span class="ident" id="6286655">prepareLocked</span><span class="op" id="6286668">(</span><span class="ident" id="6286669">s</span><span class="op" id="6286670">.</span><span class="ident" id="6286671">query</span><span class="op" id="6286676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286679">dc</span><span class="op" id="6286681">.</span><span class="ident" id="6286682">Unlock</span><span class="op" id="6286688">(</span><span class="op" id="6286689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286692">if</span>&nbsp;<span class="ident" id="6286695">err</span>&nbsp;<span class="op" id="6286699">!=</span>&nbsp;<span class="ident" id="6286702">nil</span>&nbsp;<span class="op" id="6286706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286710">s</span><span class="op" id="6286711">.</span><span class="ident" id="6286712">db</span><span class="op" id="6286714">.</span><span class="ident" id="6286715">putConn</span><span class="op" id="6286722">(</span><span class="ident" id="6286723">dc</span><span class="op" id="6286725">,</span>&nbsp;<span class="ident" id="6286727">err</span><span class="op" id="6286730">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286734">return</span>&nbsp;<span class="ident" id="6286741">nil</span><span class="op" id="6286744">,</span>&nbsp;<span class="ident" id="6286746">nil</span><span class="op" id="6286749">,</span>&nbsp;<span class="ident" id="6286751">nil</span><span class="op" id="6286754">,</span>&nbsp;<span class="ident" id="6286756">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6286761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286764">s</span><span class="op" id="6286765">.</span><span class="ident" id="6286766">mu</span><span class="op" id="6286768">.</span><span class="ident" id="6286769">Lock</span><span class="op" id="6286773">(</span><span class="op" id="6286774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286777">cs</span>&nbsp;<span class="op" id="6286780">:=</span>&nbsp;<span class="ident" id="6286783">connStmt</span><span class="op" id="6286791">{</span><span class="ident" id="6286792">dc</span><span class="op" id="6286794">,</span>&nbsp;<span class="ident" id="6286796">si</span><span class="op" id="6286798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286801">s</span><span class="op" id="6286802">.</span><span class="ident" id="6286803">css</span>&nbsp;<span class="op" id="6286807">=</span>&nbsp;<span class="builtinfunc" id="6286809">append</span><span class="op" id="6286815">(</span><span class="ident" id="6286816">s</span><span class="op" id="6286817">.</span><span class="ident" id="6286818">css</span><span class="op" id="6286821">,</span>&nbsp;<span class="ident" id="6286823">cs</span><span class="op" id="6286825">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6286828">s</span><span class="op" id="6286829">.</span><span class="ident" id="6286830">mu</span><span class="op" id="6286832">.</span><span class="ident" id="6286833">Unlock</span><span class="op" id="6286839">(</span><span class="op" id="6286840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6286844">return</span>&nbsp;<span class="ident" id="6286851">dc</span><span class="op" id="6286853">,</span>&nbsp;<span class="ident" id="6286855">dc</span><span class="op" id="6286857">.</span><span class="ident" id="6286858">releaseConn</span><span class="op" id="6286869">,</span>&nbsp;<span class="ident" id="6286871">si</span><span class="op" id="6286873">,</span>&nbsp;<span class="ident" id="6286875">nil</span><br>
<span class="lineno"></span><span class="op" id="6286879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="6286882">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="6286952">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="6286997">func</span>&nbsp;<span class="op" id="6287002">(</span><span class="ident" id="6287003">s</span>&nbsp;<span class="op" id="6287005">*</span><span class="ident" id="6287006">Stmt</span><span class="op" id="6287010">)</span>&nbsp;<span class="ident" id="6287012">Query</span><span class="op" id="6287017">(</span><span class="ident" id="6287018">args</span>&nbsp;<span class="op" id="6287023">...</span><span class="keyword" id="6287026">interface</span><span class="op" id="6287035">{</span><span class="op" id="6287036">}</span><span class="op" id="6287037">)</span>&nbsp;<span class="op" id="6287039">(</span><span class="op" id="6287040">*</span><span class="ident" id="6287041">Rows</span><span class="op" id="6287045">,</span>&nbsp;<span class="builtintype" id="6287047">error</span><span class="op" id="6287052">)</span>&nbsp;<span class="op" id="6287054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287057">s</span><span class="op" id="6287058">.</span><span class="ident" id="6287059">closemu</span><span class="op" id="6287066">.</span><span class="ident" id="6287067">RLock</span><span class="op" id="6287072">(</span><span class="op" id="6287073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287076">defer</span>&nbsp;<span class="ident" id="6287082">s</span><span class="op" id="6287083">.</span><span class="ident" id="6287084">closemu</span><span class="op" id="6287091">.</span><span class="ident" id="6287092">RUnlock</span><span class="op" id="6287099">(</span><span class="op" id="6287100">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287104">var</span>&nbsp;<span class="ident" id="6287108">rowsi</span>&nbsp;<span class="ident" id="6287114">driver</span><span class="op" id="6287120">.</span><span class="ident" id="6287121">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287127">for</span>&nbsp;<span class="ident" id="6287131">i</span>&nbsp;<span class="op" id="6287133">:=</span>&nbsp;<span class="num" id="6287136">0</span><span class="op" id="6287137">;</span>&nbsp;<span class="ident" id="6287139">i</span>&nbsp;<span class="op" id="6287141">&lt;</span>&nbsp;<span class="ident" id="6287143">maxBadConnRetries</span><span class="op" id="6287160">;</span>&nbsp;<span class="ident" id="6287162">i</span><span class="op" id="6287163">++</span>&nbsp;<span class="op" id="6287166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287170">dc</span><span class="op" id="6287172">,</span>&nbsp;<span class="ident" id="6287174">releaseConn</span><span class="op" id="6287185">,</span>&nbsp;<span class="ident" id="6287187">si</span><span class="op" id="6287189">,</span>&nbsp;<span class="ident" id="6287191">err</span>&nbsp;<span class="op" id="6287195">:=</span>&nbsp;<span class="ident" id="6287198">s</span><span class="op" id="6287199">.</span><span class="ident" id="6287200">connStmt</span><span class="op" id="6287208">(</span><span class="op" id="6287209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287213">if</span>&nbsp;<span class="ident" id="6287216">err</span>&nbsp;<span class="op" id="6287220">!=</span>&nbsp;<span class="ident" id="6287223">nil</span>&nbsp;<span class="op" id="6287227">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287232">if</span>&nbsp;<span class="ident" id="6287235">err</span>&nbsp;<span class="op" id="6287239">==</span>&nbsp;<span class="ident" id="6287242">driver</span><span class="op" id="6287248">.</span><span class="ident" id="6287249">ErrBadConn</span>&nbsp;<span class="op" id="6287260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287266">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287283">return</span>&nbsp;<span class="ident" id="6287290">nil</span><span class="op" id="6287293">,</span>&nbsp;<span class="ident" id="6287295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287301">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287306">rowsi</span><span class="op" id="6287311">,</span>&nbsp;<span class="ident" id="6287313">err</span>&nbsp;<span class="op" id="6287317">=</span>&nbsp;<span class="ident" id="6287319">rowsiFromStatement</span><span class="op" id="6287337">(</span><span class="ident" id="6287338">driverStmt</span><span class="op" id="6287348">{</span><span class="ident" id="6287349">dc</span><span class="op" id="6287351">,</span>&nbsp;<span class="ident" id="6287353">si</span><span class="op" id="6287355">}</span><span class="op" id="6287356">,</span>&nbsp;<span class="ident" id="6287358">args</span><span class="op" id="6287362">...</span><span class="op" id="6287365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287369">if</span>&nbsp;<span class="ident" id="6287372">err</span>&nbsp;<span class="op" id="6287376">==</span>&nbsp;<span class="ident" id="6287379">nil</span>&nbsp;<span class="op" id="6287383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6287388">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6287449">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287473">rows</span>&nbsp;<span class="op" id="6287478">:=</span>&nbsp;<span class="op" id="6287481">&amp;</span><span class="ident" id="6287482">Rows</span><span class="op" id="6287486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287492">dc</span><span class="op" id="6287494">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287499">dc</span><span class="op" id="6287501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287507">rowsi</span><span class="op" id="6287512">:</span>&nbsp;<span class="ident" id="6287514">rowsi</span><span class="op" id="6287519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6287525">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287553">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287558">s</span><span class="op" id="6287559">.</span><span class="ident" id="6287560">db</span><span class="op" id="6287562">.</span><span class="ident" id="6287563">addDep</span><span class="op" id="6287569">(</span><span class="ident" id="6287570">s</span><span class="op" id="6287571">,</span>&nbsp;<span class="ident" id="6287573">rows</span><span class="op" id="6287577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287582">rows</span><span class="op" id="6287586">.</span><span class="ident" id="6287587">releaseConn</span>&nbsp;<span class="op" id="6287599">=</span>&nbsp;<span class="keyword" id="6287601">func</span><span class="op" id="6287605">(</span><span class="ident" id="6287606">err</span>&nbsp;<span class="builtintype" id="6287610">error</span><span class="op" id="6287615">)</span>&nbsp;<span class="op" id="6287617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287623">releaseConn</span><span class="op" id="6287634">(</span><span class="ident" id="6287635">err</span><span class="op" id="6287638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287644">s</span><span class="op" id="6287645">.</span><span class="ident" id="6287646">db</span><span class="op" id="6287648">.</span><span class="ident" id="6287649">removeDep</span><span class="op" id="6287658">(</span><span class="ident" id="6287659">s</span><span class="op" id="6287660">,</span>&nbsp;<span class="ident" id="6287662">rows</span><span class="op" id="6287666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287671">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287676">return</span>&nbsp;<span class="ident" id="6287683">rows</span><span class="op" id="6287687">,</span>&nbsp;<span class="ident" id="6287689">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287700">releaseConn</span><span class="op" id="6287711">(</span><span class="ident" id="6287712">err</span><span class="op" id="6287715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287719">if</span>&nbsp;<span class="ident" id="6287722">err</span>&nbsp;<span class="op" id="6287726">!=</span>&nbsp;<span class="ident" id="6287729">driver</span><span class="op" id="6287735">.</span><span class="ident" id="6287736">ErrBadConn</span>&nbsp;<span class="op" id="6287747">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287752">return</span>&nbsp;<span class="ident" id="6287759">nil</span><span class="op" id="6287762">,</span>&nbsp;<span class="ident" id="6287764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6287773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6287776">return</span>&nbsp;<span class="ident" id="6287783">nil</span><span class="op" id="6287786">,</span>&nbsp;<span class="ident" id="6287788">driver</span><span class="op" id="6287794">.</span><span class="ident" id="6287795">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="6287806">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="6287809">func</span>&nbsp;<span class="ident" id="6287814">rowsiFromStatement</span><span class="op" id="6287832">(</span><span class="ident" id="6287833">ds</span>&nbsp;<span class="ident" id="6287836">driverStmt</span><span class="op" id="6287846">,</span>&nbsp;<span class="ident" id="6287848">args</span>&nbsp;<span class="op" id="6287853">...</span><span class="keyword" id="6287856">interface</span><span class="op" id="6287865">{</span><span class="op" id="6287866">}</span><span class="op" id="6287867">)</span>&nbsp;<span class="op" id="6287869">(</span><span class="ident" id="6287870">driver</span><span class="op" id="6287876">.</span><span class="ident" id="6287877">Rows</span><span class="op" id="6287881">,</span>&nbsp;<span class="builtintype" id="6287883">error</span><span class="op" id="6287888">)</span>&nbsp;<span class="op" id="6287890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287893">ds</span><span class="op" id="6287895">.</span><span class="ident" id="6287896">Lock</span><span class="op" id="6287900">(</span><span class="op" id="6287901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287904">want</span>&nbsp;<span class="op" id="6287909">:=</span>&nbsp;<span class="ident" id="6287912">ds</span><span class="op" id="6287914">.</span><span class="ident" id="6287915">si</span><span class="op" id="6287917">.</span><span class="ident" id="6287918">NumInput</span><span class="op" id="6287926">(</span><span class="op" id="6287927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6287930">ds</span><span class="op" id="6287932">.</span><span class="ident" id="6287933">Unlock</span><span class="op" id="6287939">(</span><span class="op" id="6287940">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6287944">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6288008">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6288082">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288111">if</span>&nbsp;<span class="ident" id="6288114">want</span>&nbsp;<span class="op" id="6288119">!=</span>&nbsp;<span class="op" id="6288122">-</span><span class="num" id="6288123">1</span>&nbsp;<span class="op" id="6288125">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6288128">len</span><span class="op" id="6288131">(</span><span class="ident" id="6288132">args</span><span class="op" id="6288136">)</span>&nbsp;<span class="op" id="6288138">!=</span>&nbsp;<span class="ident" id="6288141">want</span>&nbsp;<span class="op" id="6288146">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288150">return</span>&nbsp;<span class="ident" id="6288157">nil</span><span class="op" id="6288160">,</span>&nbsp;<span class="ident" id="6288162">fmt</span><span class="op" id="6288165">.</span><span class="ident" id="6288166">Errorf</span><span class="op" id="6288172">(</span><span class="string" id="6288173">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6288215">,</span>&nbsp;<span class="ident" id="6288217">want</span><span class="op" id="6288221">,</span>&nbsp;<span class="builtinfunc" id="6288223">len</span><span class="op" id="6288226">(</span><span class="ident" id="6288227">args</span><span class="op" id="6288231">)</span><span class="op" id="6288232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288239">dargs</span><span class="op" id="6288244">,</span>&nbsp;<span class="ident" id="6288246">err</span>&nbsp;<span class="op" id="6288250">:=</span>&nbsp;<span class="ident" id="6288253">driverArgs</span><span class="op" id="6288263">(</span><span class="op" id="6288264">&amp;</span><span class="ident" id="6288265">ds</span><span class="op" id="6288267">,</span>&nbsp;<span class="ident" id="6288269">args</span><span class="op" id="6288273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288276">if</span>&nbsp;<span class="ident" id="6288279">err</span>&nbsp;<span class="op" id="6288283">!=</span>&nbsp;<span class="ident" id="6288286">nil</span>&nbsp;<span class="op" id="6288290">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288294">return</span>&nbsp;<span class="ident" id="6288301">nil</span><span class="op" id="6288304">,</span>&nbsp;<span class="ident" id="6288306">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288315">ds</span><span class="op" id="6288317">.</span><span class="ident" id="6288318">Lock</span><span class="op" id="6288322">(</span><span class="op" id="6288323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288326">rowsi</span><span class="op" id="6288331">,</span>&nbsp;<span class="ident" id="6288333">err</span>&nbsp;<span class="op" id="6288337">:=</span>&nbsp;<span class="ident" id="6288340">ds</span><span class="op" id="6288342">.</span><span class="ident" id="6288343">si</span><span class="op" id="6288345">.</span><span class="ident" id="6288346">Query</span><span class="op" id="6288351">(</span><span class="ident" id="6288352">dargs</span><span class="op" id="6288357">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288360">ds</span><span class="op" id="6288362">.</span><span class="ident" id="6288363">Unlock</span><span class="op" id="6288369">(</span><span class="op" id="6288370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288373">if</span>&nbsp;<span class="ident" id="6288376">err</span>&nbsp;<span class="op" id="6288380">!=</span>&nbsp;<span class="ident" id="6288383">nil</span>&nbsp;<span class="op" id="6288387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288391">return</span>&nbsp;<span class="ident" id="6288398">nil</span><span class="op" id="6288401">,</span>&nbsp;<span class="ident" id="6288403">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6288408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6288411">return</span>&nbsp;<span class="ident" id="6288418">rowsi</span><span class="op" id="6288423">,</span>&nbsp;<span class="ident" id="6288425">nil</span><br>
<span class="lineno">1495</span><span class="op" id="6288429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6288432">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="6288506">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="6288583">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="6288663">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="6288735">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="6288807">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="6288820">//</span><br>
<span class="lineno"></span><span class="comment" id="6288823">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="6288841">//</span><br>
<span class="lineno"></span><span class="comment" id="6288844">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6288864">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="6288917">func</span>&nbsp;<span class="op" id="6288922">(</span><span class="ident" id="6288923">s</span>&nbsp;<span class="op" id="6288925">*</span><span class="ident" id="6288926">Stmt</span><span class="op" id="6288930">)</span>&nbsp;<span class="ident" id="6288932">QueryRow</span><span class="op" id="6288940">(</span><span class="ident" id="6288941">args</span>&nbsp;<span class="op" id="6288946">...</span><span class="keyword" id="6288949">interface</span><span class="op" id="6288958">{</span><span class="op" id="6288959">}</span><span class="op" id="6288960">)</span>&nbsp;<span class="op" id="6288962">*</span><span class="ident" id="6288963">Row</span>&nbsp;<span class="op" id="6288967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6288970">rows</span><span class="op" id="6288974">,</span>&nbsp;<span class="ident" id="6288976">err</span>&nbsp;<span class="op" id="6288980">:=</span>&nbsp;<span class="ident" id="6288983">s</span><span class="op" id="6288984">.</span><span class="ident" id="6288985">Query</span><span class="op" id="6288990">(</span><span class="ident" id="6288991">args</span><span class="op" id="6288995">...</span><span class="op" id="6288998">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289001">if</span>&nbsp;<span class="ident" id="6289004">err</span>&nbsp;<span class="op" id="6289008">!=</span>&nbsp;<span class="ident" id="6289011">nil</span>&nbsp;<span class="op" id="6289015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289019">return</span>&nbsp;<span class="op" id="6289026">&amp;</span><span class="ident" id="6289027">Row</span><span class="op" id="6289030">{</span><span class="ident" id="6289031">err</span><span class="op" id="6289034">:</span>&nbsp;<span class="ident" id="6289036">err</span><span class="op" id="6289039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289045">return</span>&nbsp;<span class="op" id="6289052">&amp;</span><span class="ident" id="6289053">Row</span><span class="op" id="6289056">{</span><span class="ident" id="6289057">rows</span><span class="op" id="6289061">:</span>&nbsp;<span class="ident" id="6289063">rows</span><span class="op" id="6289067">}</span><br>
<span class="lineno"></span><span class="op" id="6289069">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="6289072">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6289103">func</span>&nbsp;<span class="op" id="6289108">(</span><span class="ident" id="6289109">s</span>&nbsp;<span class="op" id="6289111">*</span><span class="ident" id="6289112">Stmt</span><span class="op" id="6289116">)</span>&nbsp;<span class="ident" id="6289118">Close</span><span class="op" id="6289123">(</span><span class="op" id="6289124">)</span>&nbsp;<span class="builtintype" id="6289126">error</span>&nbsp;<span class="op" id="6289132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289135">s</span><span class="op" id="6289136">.</span><span class="ident" id="6289137">closemu</span><span class="op" id="6289144">.</span><span class="ident" id="6289145">Lock</span><span class="op" id="6289149">(</span><span class="op" id="6289150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289153">defer</span>&nbsp;<span class="ident" id="6289159">s</span><span class="op" id="6289160">.</span><span class="ident" id="6289161">closemu</span><span class="op" id="6289168">.</span><span class="ident" id="6289169">Unlock</span><span class="op" id="6289175">(</span><span class="op" id="6289176">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289180">if</span>&nbsp;<span class="ident" id="6289183">s</span><span class="op" id="6289184">.</span><span class="ident" id="6289185">stickyErr</span>&nbsp;<span class="op" id="6289195">!=</span>&nbsp;<span class="ident" id="6289198">nil</span>&nbsp;<span class="op" id="6289202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289206">return</span>&nbsp;<span class="ident" id="6289213">s</span><span class="op" id="6289214">.</span><span class="ident" id="6289215">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289229">s</span><span class="op" id="6289230">.</span><span class="ident" id="6289231">mu</span><span class="op" id="6289233">.</span><span class="ident" id="6289234">Lock</span><span class="op" id="6289238">(</span><span class="op" id="6289239">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289242">if</span>&nbsp;<span class="ident" id="6289245">s</span><span class="op" id="6289246">.</span><span class="ident" id="6289247">closed</span>&nbsp;<span class="op" id="6289254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289258">s</span><span class="op" id="6289259">.</span><span class="ident" id="6289260">mu</span><span class="op" id="6289262">.</span><span class="ident" id="6289263">Unlock</span><span class="op" id="6289269">(</span><span class="op" id="6289270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289274">return</span>&nbsp;<span class="ident" id="6289281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289289">s</span><span class="op" id="6289290">.</span><span class="ident" id="6289291">closed</span>&nbsp;<span class="op" id="6289298">=</span>&nbsp;<span class="builtintype" id="6289300">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289307">if</span>&nbsp;<span class="ident" id="6289310">s</span><span class="op" id="6289311">.</span><span class="ident" id="6289312">tx</span>&nbsp;<span class="op" id="6289315">!=</span>&nbsp;<span class="ident" id="6289318">nil</span>&nbsp;<span class="op" id="6289322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289326">s</span><span class="op" id="6289327">.</span><span class="ident" id="6289328">txsi</span><span class="op" id="6289332">.</span><span class="ident" id="6289333">Close</span><span class="op" id="6289338">(</span><span class="op" id="6289339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289343">s</span><span class="op" id="6289344">.</span><span class="ident" id="6289345">mu</span><span class="op" id="6289347">.</span><span class="ident" id="6289348">Unlock</span><span class="op" id="6289354">(</span><span class="op" id="6289355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289359">return</span>&nbsp;<span class="ident" id="6289366">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289374">s</span><span class="op" id="6289375">.</span><span class="ident" id="6289376">mu</span><span class="op" id="6289378">.</span><span class="ident" id="6289379">Unlock</span><span class="op" id="6289385">(</span><span class="op" id="6289386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289390">return</span>&nbsp;<span class="ident" id="6289397">s</span><span class="op" id="6289398">.</span><span class="ident" id="6289399">db</span><span class="op" id="6289401">.</span><span class="ident" id="6289402">removeDep</span><span class="op" id="6289411">(</span><span class="ident" id="6289412">s</span><span class="op" id="6289413">,</span>&nbsp;<span class="ident" id="6289415">s</span><span class="op" id="6289416">)</span><br>
<span class="lineno"></span><span class="op" id="6289418">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="6289421">func</span>&nbsp;<span class="op" id="6289426">(</span><span class="ident" id="6289427">s</span>&nbsp;<span class="op" id="6289429">*</span><span class="ident" id="6289430">Stmt</span><span class="op" id="6289434">)</span>&nbsp;<span class="ident" id="6289436">finalClose</span><span class="op" id="6289446">(</span><span class="op" id="6289447">)</span>&nbsp;<span class="builtintype" id="6289449">error</span>&nbsp;<span class="op" id="6289455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289458">s</span><span class="op" id="6289459">.</span><span class="ident" id="6289460">mu</span><span class="op" id="6289462">.</span><span class="ident" id="6289463">Lock</span><span class="op" id="6289467">(</span><span class="op" id="6289468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289471">defer</span>&nbsp;<span class="ident" id="6289477">s</span><span class="op" id="6289478">.</span><span class="ident" id="6289479">mu</span><span class="op" id="6289481">.</span><span class="ident" id="6289482">Unlock</span><span class="op" id="6289488">(</span><span class="op" id="6289489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289492">if</span>&nbsp;<span class="ident" id="6289495">s</span><span class="op" id="6289496">.</span><span class="ident" id="6289497">css</span>&nbsp;<span class="op" id="6289501">!=</span>&nbsp;<span class="ident" id="6289504">nil</span>&nbsp;<span class="op" id="6289508">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289512">for</span>&nbsp;<span class="ident" id="6289516">_</span><span class="op" id="6289517">,</span>&nbsp;<span class="ident" id="6289519">v</span>&nbsp;<span class="op" id="6289521">:=</span>&nbsp;<span class="keyword" id="6289524">range</span>&nbsp;<span class="ident" id="6289530">s</span><span class="op" id="6289531">.</span><span class="ident" id="6289532">css</span>&nbsp;<span class="op" id="6289536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289541">s</span><span class="op" id="6289542">.</span><span class="ident" id="6289543">db</span><span class="op" id="6289545">.</span><span class="ident" id="6289546">noteUnusedDriverStatement</span><span class="op" id="6289571">(</span><span class="ident" id="6289572">v</span><span class="op" id="6289573">.</span><span class="ident" id="6289574">dc</span><span class="op" id="6289576">,</span>&nbsp;<span class="ident" id="6289578">v</span><span class="op" id="6289579">.</span><span class="ident" id="6289580">si</span><span class="op" id="6289582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289587">v</span><span class="op" id="6289588">.</span><span class="ident" id="6289589">dc</span><span class="op" id="6289591">.</span><span class="ident" id="6289592">removeOpenStmt</span><span class="op" id="6289606">(</span><span class="ident" id="6289607">v</span><span class="op" id="6289608">.</span><span class="ident" id="6289609">si</span><span class="op" id="6289611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6289619">s</span><span class="op" id="6289620">.</span><span class="ident" id="6289621">css</span>&nbsp;<span class="op" id="6289625">=</span>&nbsp;<span class="ident" id="6289627">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6289632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6289635">return</span>&nbsp;<span class="ident" id="6289642">nil</span><br>
<span class="lineno"></span><span class="op" id="6289646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6289649">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="6289722">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="6289782">//</span><br>
<span class="lineno"></span><span class="comment" id="6289785">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="6289828">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="6289839">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="6289865">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="6289890">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="6289912">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="6289939">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="6289978">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="6289993">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="6290002">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="6290072">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="6290083">type</span>&nbsp;<span class="ident" id="6290088">Rows</span>&nbsp;<span class="keyword" id="6290093">struct</span>&nbsp;<span class="op" id="6290100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290103">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290115">*</span><span class="ident" id="6290116">driverConn</span>&nbsp;<span class="comment" id="6290127">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290183">releaseConn</span>&nbsp;<span class="keyword" id="6290195">func</span><span class="op" id="6290199">(</span><span class="builtintype" id="6290200">error</span><span class="op" id="6290205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290208">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290220">driver</span><span class="op" id="6290226">.</span><span class="ident" id="6290227">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290234">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6290244">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290250">lastcols</span>&nbsp;&nbsp;<span class="op" id="6290260">[</span><span class="op" id="6290261">]</span><span class="ident" id="6290262">driver</span><span class="op" id="6290268">.</span><span class="ident" id="6290269">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290276">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6290286">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290298">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290333">closeStmt</span>&nbsp;<span class="ident" id="6290343">driver</span><span class="op" id="6290349">.</span><span class="ident" id="6290350">Stmt</span>&nbsp;<span class="comment" id="6290355">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="6290398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6290401">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="6290476">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="6290556">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="6290636">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="6290654">//</span><br>
<span class="lineno"></span><span class="comment" id="6290657">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="6290736">func</span>&nbsp;<span class="op" id="6290741">(</span><span class="ident" id="6290742">rs</span>&nbsp;<span class="op" id="6290745">*</span><span class="ident" id="6290746">Rows</span><span class="op" id="6290750">)</span>&nbsp;<span class="ident" id="6290752">Next</span><span class="op" id="6290756">(</span><span class="op" id="6290757">)</span>&nbsp;<span class="builtintype" id="6290759">bool</span>&nbsp;<span class="op" id="6290764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290767">if</span>&nbsp;<span class="ident" id="6290770">rs</span><span class="op" id="6290772">.</span><span class="ident" id="6290773">closed</span>&nbsp;<span class="op" id="6290780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290784">return</span>&nbsp;<span class="builtintype" id="6290791">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6290798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290801">if</span>&nbsp;<span class="ident" id="6290804">rs</span><span class="op" id="6290806">.</span><span class="ident" id="6290807">lastcols</span>&nbsp;<span class="op" id="6290816">==</span>&nbsp;<span class="ident" id="6290819">nil</span>&nbsp;<span class="op" id="6290823">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290827">rs</span><span class="op" id="6290829">.</span><span class="ident" id="6290830">lastcols</span>&nbsp;<span class="op" id="6290839">=</span>&nbsp;<span class="builtinfunc" id="6290841">make</span><span class="op" id="6290845">(</span><span class="op" id="6290846">[</span><span class="op" id="6290847">]</span><span class="ident" id="6290848">driver</span><span class="op" id="6290854">.</span><span class="ident" id="6290855">Value</span><span class="op" id="6290860">,</span>&nbsp;<span class="builtinfunc" id="6290862">len</span><span class="op" id="6290865">(</span><span class="ident" id="6290866">rs</span><span class="op" id="6290868">.</span><span class="ident" id="6290869">rowsi</span><span class="op" id="6290874">.</span><span class="ident" id="6290875">Columns</span><span class="op" id="6290882">(</span><span class="op" id="6290883">)</span><span class="op" id="6290884">)</span><span class="op" id="6290885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6290888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290891">rs</span><span class="op" id="6290893">.</span><span class="ident" id="6290894">lasterr</span>&nbsp;<span class="op" id="6290902">=</span>&nbsp;<span class="ident" id="6290904">rs</span><span class="op" id="6290906">.</span><span class="ident" id="6290907">rowsi</span><span class="op" id="6290912">.</span><span class="ident" id="6290913">Next</span><span class="op" id="6290917">(</span><span class="ident" id="6290918">rs</span><span class="op" id="6290920">.</span><span class="ident" id="6290921">lastcols</span><span class="op" id="6290929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290932">if</span>&nbsp;<span class="ident" id="6290935">rs</span><span class="op" id="6290937">.</span><span class="ident" id="6290938">lasterr</span>&nbsp;<span class="op" id="6290946">!=</span>&nbsp;<span class="ident" id="6290949">nil</span>&nbsp;<span class="op" id="6290953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6290957">rs</span><span class="op" id="6290959">.</span><span class="ident" id="6290960">Close</span><span class="op" id="6290965">(</span><span class="op" id="6290966">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290970">return</span>&nbsp;<span class="builtintype" id="6290977">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6290984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6290987">return</span>&nbsp;<span class="builtintype" id="6290994">true</span><br>
<span class="lineno"></span><span class="op" id="6290999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="6291002">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="6291075">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6291133">func</span>&nbsp;<span class="op" id="6291138">(</span><span class="ident" id="6291139">rs</span>&nbsp;<span class="op" id="6291142">*</span><span class="ident" id="6291143">Rows</span><span class="op" id="6291147">)</span>&nbsp;<span class="ident" id="6291149">Err</span><span class="op" id="6291152">(</span><span class="op" id="6291153">)</span>&nbsp;<span class="builtintype" id="6291155">error</span>&nbsp;<span class="op" id="6291161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291164">if</span>&nbsp;<span class="ident" id="6291167">rs</span><span class="op" id="6291169">.</span><span class="ident" id="6291170">lasterr</span>&nbsp;<span class="op" id="6291178">==</span>&nbsp;<span class="ident" id="6291181">io</span><span class="op" id="6291183">.</span><span class="ident" id="6291184">EOF</span>&nbsp;<span class="op" id="6291188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291192">return</span>&nbsp;<span class="ident" id="6291199">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6291204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291207">return</span>&nbsp;<span class="ident" id="6291214">rs</span><span class="op" id="6291216">.</span><span class="ident" id="6291217">lasterr</span><br>
<span class="lineno"></span><span class="op" id="6291225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6291228">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="6291265">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="6291332">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6291385">func</span>&nbsp;<span class="op" id="6291390">(</span><span class="ident" id="6291391">rs</span>&nbsp;<span class="op" id="6291394">*</span><span class="ident" id="6291395">Rows</span><span class="op" id="6291399">)</span>&nbsp;<span class="ident" id="6291401">Columns</span><span class="op" id="6291408">(</span><span class="op" id="6291409">)</span>&nbsp;<span class="op" id="6291411">(</span><span class="op" id="6291412">[</span><span class="op" id="6291413">]</span><span class="builtintype" id="6291414">string</span><span class="op" id="6291420">,</span>&nbsp;<span class="builtintype" id="6291422">error</span><span class="op" id="6291427">)</span>&nbsp;<span class="op" id="6291429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291432">if</span>&nbsp;<span class="ident" id="6291435">rs</span><span class="op" id="6291437">.</span><span class="ident" id="6291438">closed</span>&nbsp;<span class="op" id="6291445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291449">return</span>&nbsp;<span class="ident" id="6291456">nil</span><span class="op" id="6291459">,</span>&nbsp;<span class="ident" id="6291461">errors</span><span class="op" id="6291467">.</span><span class="ident" id="6291468">New</span><span class="op" id="6291471">(</span><span class="string" id="6291472">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6291494">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6291497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291500">if</span>&nbsp;<span class="ident" id="6291503">rs</span><span class="op" id="6291505">.</span><span class="ident" id="6291506">rowsi</span>&nbsp;<span class="op" id="6291512">==</span>&nbsp;<span class="ident" id="6291515">nil</span>&nbsp;<span class="op" id="6291519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291523">return</span>&nbsp;<span class="ident" id="6291530">nil</span><span class="op" id="6291533">,</span>&nbsp;<span class="ident" id="6291535">errors</span><span class="op" id="6291541">.</span><span class="ident" id="6291542">New</span><span class="op" id="6291545">(</span><span class="string" id="6291546">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="6291570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6291573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6291576">return</span>&nbsp;<span class="ident" id="6291583">rs</span><span class="op" id="6291585">.</span><span class="ident" id="6291586">rowsi</span><span class="op" id="6291591">.</span><span class="ident" id="6291592">Columns</span><span class="op" id="6291599">(</span><span class="op" id="6291600">)</span><span class="op" id="6291601">,</span>&nbsp;<span class="ident" id="6291603">nil</span><br>
<span class="lineno">1620</span><span class="op" id="6291607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6291610">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="6291680">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="6291695">//</span><br>
<span class="lineno">1625</span><span class="comment" id="6291698">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="6291769">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="6291839">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="6291910">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6291978">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="6292019">//</span><br>
<span class="lineno"></span><span class="comment" id="6292022">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6292085">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="6292155">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="6292224">func</span>&nbsp;<span class="op" id="6292229">(</span><span class="ident" id="6292230">rs</span>&nbsp;<span class="op" id="6292233">*</span><span class="ident" id="6292234">Rows</span><span class="op" id="6292238">)</span>&nbsp;<span class="ident" id="6292240">Scan</span><span class="op" id="6292244">(</span><span class="ident" id="6292245">dest</span>&nbsp;<span class="op" id="6292250">...</span><span class="keyword" id="6292253">interface</span><span class="op" id="6292262">{</span><span class="op" id="6292263">}</span><span class="op" id="6292264">)</span>&nbsp;<span class="builtintype" id="6292266">error</span>&nbsp;<span class="op" id="6292272">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292275">if</span>&nbsp;<span class="ident" id="6292278">rs</span><span class="op" id="6292280">.</span><span class="ident" id="6292281">closed</span>&nbsp;<span class="op" id="6292288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292292">return</span>&nbsp;<span class="ident" id="6292299">errors</span><span class="op" id="6292305">.</span><span class="ident" id="6292306">New</span><span class="op" id="6292309">(</span><span class="string" id="6292310">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="6292332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6292335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292338">if</span>&nbsp;<span class="ident" id="6292341">rs</span><span class="op" id="6292343">.</span><span class="ident" id="6292344">lastcols</span>&nbsp;<span class="op" id="6292353">==</span>&nbsp;<span class="ident" id="6292356">nil</span>&nbsp;<span class="op" id="6292360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292364">return</span>&nbsp;<span class="ident" id="6292371">errors</span><span class="op" id="6292377">.</span><span class="ident" id="6292378">New</span><span class="op" id="6292381">(</span><span class="string" id="6292382">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="6292421">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6292424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292427">if</span>&nbsp;<span class="builtinfunc" id="6292430">len</span><span class="op" id="6292433">(</span><span class="ident" id="6292434">dest</span><span class="op" id="6292438">)</span>&nbsp;<span class="op" id="6292440">!=</span>&nbsp;<span class="builtinfunc" id="6292443">len</span><span class="op" id="6292446">(</span><span class="ident" id="6292447">rs</span><span class="op" id="6292449">.</span><span class="ident" id="6292450">lastcols</span><span class="op" id="6292458">)</span>&nbsp;<span class="op" id="6292460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292464">return</span>&nbsp;<span class="ident" id="6292471">fmt</span><span class="op" id="6292474">.</span><span class="ident" id="6292475">Errorf</span><span class="op" id="6292481">(</span><span class="string" id="6292482">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="6292538">,</span>&nbsp;<span class="builtinfunc" id="6292540">len</span><span class="op" id="6292543">(</span><span class="ident" id="6292544">rs</span><span class="op" id="6292546">.</span><span class="ident" id="6292547">lastcols</span><span class="op" id="6292555">)</span><span class="op" id="6292556">,</span>&nbsp;<span class="builtinfunc" id="6292558">len</span><span class="op" id="6292561">(</span><span class="ident" id="6292562">dest</span><span class="op" id="6292566">)</span><span class="op" id="6292567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6292570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292573">for</span>&nbsp;<span class="ident" id="6292577">i</span><span class="op" id="6292578">,</span>&nbsp;<span class="ident" id="6292580">sv</span>&nbsp;<span class="op" id="6292583">:=</span>&nbsp;<span class="keyword" id="6292586">range</span>&nbsp;<span class="ident" id="6292592">rs</span><span class="op" id="6292594">.</span><span class="ident" id="6292595">lastcols</span>&nbsp;<span class="op" id="6292604">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6292608">err</span>&nbsp;<span class="op" id="6292612">:=</span>&nbsp;<span class="ident" id="6292615">convertAssign</span><span class="op" id="6292628">(</span><span class="ident" id="6292629">dest</span><span class="op" id="6292633">[</span><span class="ident" id="6292634">i</span><span class="op" id="6292635">]</span><span class="op" id="6292636">,</span>&nbsp;<span class="ident" id="6292638">sv</span><span class="op" id="6292640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292644">if</span>&nbsp;<span class="ident" id="6292647">err</span>&nbsp;<span class="op" id="6292651">!=</span>&nbsp;<span class="ident" id="6292654">nil</span>&nbsp;<span class="op" id="6292658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292663">return</span>&nbsp;<span class="ident" id="6292670">fmt</span><span class="op" id="6292673">.</span><span class="ident" id="6292674">Errorf</span><span class="op" id="6292680">(</span><span class="string" id="6292681">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="6292721">,</span>&nbsp;<span class="ident" id="6292723">i</span><span class="op" id="6292724">,</span>&nbsp;<span class="ident" id="6292726">err</span><span class="op" id="6292729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6292733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6292736">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6292739">return</span>&nbsp;<span class="ident" id="6292746">nil</span><br>
<span class="lineno"></span><span class="op" id="6292750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6292753">var</span>&nbsp;<span class="ident" id="6292757">rowsCloseHook</span>&nbsp;<span class="keyword" id="6292771">func</span><span class="op" id="6292775">(</span><span class="op" id="6292776">*</span><span class="ident" id="6292777">Rows</span><span class="op" id="6292781">,</span>&nbsp;<span class="op" id="6292783">*</span><span class="builtintype" id="6292784">error</span><span class="op" id="6292789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="6292792">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6292866">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6292943">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="6293020">func</span>&nbsp;<span class="op" id="6293025">(</span><span class="ident" id="6293026">rs</span>&nbsp;<span class="op" id="6293029">*</span><span class="ident" id="6293030">Rows</span><span class="op" id="6293034">)</span>&nbsp;<span class="ident" id="6293036">Close</span><span class="op" id="6293041">(</span><span class="op" id="6293042">)</span>&nbsp;<span class="builtintype" id="6293044">error</span>&nbsp;<span class="op" id="6293050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293053">if</span>&nbsp;<span class="ident" id="6293056">rs</span><span class="op" id="6293058">.</span><span class="ident" id="6293059">closed</span>&nbsp;<span class="op" id="6293066">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293070">return</span>&nbsp;<span class="ident" id="6293077">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6293082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293085">rs</span><span class="op" id="6293087">.</span><span class="ident" id="6293088">closed</span>&nbsp;<span class="op" id="6293095">=</span>&nbsp;<span class="builtintype" id="6293097">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293103">err</span>&nbsp;<span class="op" id="6293107">:=</span>&nbsp;<span class="ident" id="6293110">rs</span><span class="op" id="6293112">.</span><span class="ident" id="6293113">rowsi</span><span class="op" id="6293118">.</span><span class="ident" id="6293119">Close</span><span class="op" id="6293124">(</span><span class="op" id="6293125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293128">if</span>&nbsp;<span class="ident" id="6293131">fn</span>&nbsp;<span class="op" id="6293134">:=</span>&nbsp;<span class="ident" id="6293137">rowsCloseHook</span><span class="op" id="6293150">;</span>&nbsp;<span class="ident" id="6293152">fn</span>&nbsp;<span class="op" id="6293155">!=</span>&nbsp;<span class="ident" id="6293158">nil</span>&nbsp;<span class="op" id="6293162">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293166">fn</span><span class="op" id="6293168">(</span><span class="ident" id="6293169">rs</span><span class="op" id="6293171">,</span>&nbsp;<span class="op" id="6293173">&amp;</span><span class="ident" id="6293174">err</span><span class="op" id="6293177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6293180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293183">if</span>&nbsp;<span class="ident" id="6293186">rs</span><span class="op" id="6293188">.</span><span class="ident" id="6293189">closeStmt</span>&nbsp;<span class="op" id="6293199">!=</span>&nbsp;<span class="ident" id="6293202">nil</span>&nbsp;<span class="op" id="6293206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293210">rs</span><span class="op" id="6293212">.</span><span class="ident" id="6293213">closeStmt</span><span class="op" id="6293222">.</span><span class="ident" id="6293223">Close</span><span class="op" id="6293228">(</span><span class="op" id="6293229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6293232">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293235">rs</span><span class="op" id="6293237">.</span><span class="ident" id="6293238">releaseConn</span><span class="op" id="6293249">(</span><span class="ident" id="6293250">err</span><span class="op" id="6293253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293256">return</span>&nbsp;<span class="ident" id="6293263">err</span><br>
<span class="lineno"></span><span class="op" id="6293267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6293270">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="6293335">type</span>&nbsp;<span class="ident" id="6293340">Row</span>&nbsp;<span class="keyword" id="6293344">struct</span>&nbsp;<span class="op" id="6293351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293354">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293392">err</span>&nbsp;&nbsp;<span class="builtintype" id="6293397">error</span>&nbsp;<span class="comment" id="6293403">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6293440">rows</span>&nbsp;<span class="op" id="6293445">*</span><span class="ident" id="6293446">Rows</span><br>
<span class="lineno"></span><span class="op" id="6293451">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="6293454">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="6293518">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="6293582">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="6293651">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="6293689">func</span>&nbsp;<span class="op" id="6293694">(</span><span class="ident" id="6293695">r</span>&nbsp;<span class="op" id="6293697">*</span><span class="ident" id="6293698">Row</span><span class="op" id="6293701">)</span>&nbsp;<span class="ident" id="6293703">Scan</span><span class="op" id="6293707">(</span><span class="ident" id="6293708">dest</span>&nbsp;<span class="op" id="6293713">...</span><span class="keyword" id="6293716">interface</span><span class="op" id="6293725">{</span><span class="op" id="6293726">}</span><span class="op" id="6293727">)</span>&nbsp;<span class="builtintype" id="6293729">error</span>&nbsp;<span class="op" id="6293735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293738">if</span>&nbsp;<span class="ident" id="6293741">r</span><span class="op" id="6293742">.</span><span class="ident" id="6293743">err</span>&nbsp;<span class="op" id="6293747">!=</span>&nbsp;<span class="ident" id="6293750">nil</span>&nbsp;<span class="op" id="6293754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6293758">return</span>&nbsp;<span class="ident" id="6293765">r</span><span class="op" id="6293766">.</span><span class="ident" id="6293767">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6293772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293776">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293837">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293889">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6293945">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294007">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294071">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294132">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294196">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294257">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294313">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294375">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294436">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294499">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294515">defer</span>&nbsp;<span class="ident" id="6294521">r</span><span class="op" id="6294522">.</span><span class="ident" id="6294523">rows</span><span class="op" id="6294527">.</span><span class="ident" id="6294528">Close</span><span class="op" id="6294533">(</span><span class="op" id="6294534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294537">for</span>&nbsp;<span class="ident" id="6294541">_</span><span class="op" id="6294542">,</span>&nbsp;<span class="ident" id="6294544">dp</span>&nbsp;<span class="op" id="6294547">:=</span>&nbsp;<span class="keyword" id="6294550">range</span>&nbsp;<span class="ident" id="6294556">dest</span>&nbsp;<span class="op" id="6294561">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294565">if</span>&nbsp;<span class="ident" id="6294568">_</span><span class="op" id="6294569">,</span>&nbsp;<span class="ident" id="6294571">ok</span>&nbsp;<span class="op" id="6294574">:=</span>&nbsp;<span class="ident" id="6294577">dp</span><span class="op" id="6294579">.</span><span class="op" id="6294580">(</span><span class="op" id="6294581">*</span><span class="ident" id="6294582">RawBytes</span><span class="op" id="6294590">)</span><span class="op" id="6294591">;</span>&nbsp;<span class="ident" id="6294593">ok</span>&nbsp;<span class="op" id="6294596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294601">return</span>&nbsp;<span class="ident" id="6294608">errors</span><span class="op" id="6294614">.</span><span class="ident" id="6294615">New</span><span class="op" id="6294618">(</span><span class="string" id="6294619">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="6294660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294671">if</span>&nbsp;<span class="op" id="6294674">!</span><span class="ident" id="6294675">r</span><span class="op" id="6294676">.</span><span class="ident" id="6294677">rows</span><span class="op" id="6294681">.</span><span class="ident" id="6294682">Next</span><span class="op" id="6294686">(</span><span class="op" id="6294687">)</span>&nbsp;<span class="op" id="6294689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294693">if</span>&nbsp;<span class="ident" id="6294696">err</span>&nbsp;<span class="op" id="6294700">:=</span>&nbsp;<span class="ident" id="6294703">r</span><span class="op" id="6294704">.</span><span class="ident" id="6294705">rows</span><span class="op" id="6294709">.</span><span class="ident" id="6294710">Err</span><span class="op" id="6294713">(</span><span class="op" id="6294714">)</span><span class="op" id="6294715">;</span>&nbsp;<span class="ident" id="6294717">err</span>&nbsp;<span class="op" id="6294721">!=</span>&nbsp;<span class="ident" id="6294724">nil</span>&nbsp;<span class="op" id="6294728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294733">return</span>&nbsp;<span class="ident" id="6294740">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294750">return</span>&nbsp;<span class="ident" id="6294757">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6294771">err</span>&nbsp;<span class="op" id="6294775">:=</span>&nbsp;<span class="ident" id="6294778">r</span><span class="op" id="6294779">.</span><span class="ident" id="6294780">rows</span><span class="op" id="6294784">.</span><span class="ident" id="6294785">Scan</span><span class="op" id="6294789">(</span><span class="ident" id="6294790">dest</span><span class="op" id="6294794">...</span><span class="op" id="6294797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294800">if</span>&nbsp;<span class="ident" id="6294803">err</span>&nbsp;<span class="op" id="6294807">!=</span>&nbsp;<span class="ident" id="6294810">nil</span>&nbsp;<span class="op" id="6294814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294818">return</span>&nbsp;<span class="ident" id="6294825">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294830">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6294833">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294904">if</span>&nbsp;<span class="ident" id="6294907">err</span>&nbsp;<span class="op" id="6294911">:=</span>&nbsp;<span class="ident" id="6294914">r</span><span class="op" id="6294915">.</span><span class="ident" id="6294916">rows</span><span class="op" id="6294920">.</span><span class="ident" id="6294921">Close</span><span class="op" id="6294926">(</span><span class="op" id="6294927">)</span><span class="op" id="6294928">;</span>&nbsp;<span class="ident" id="6294930">err</span>&nbsp;<span class="op" id="6294934">!=</span>&nbsp;<span class="ident" id="6294937">nil</span>&nbsp;<span class="op" id="6294941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294945">return</span>&nbsp;<span class="ident" id="6294952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6294957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6294961">return</span>&nbsp;<span class="ident" id="6294968">nil</span><br>
<span class="lineno"></span><span class="op" id="6294972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6294975">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="6295023">type</span>&nbsp;<span class="ident" id="6295028">Result</span>&nbsp;<span class="keyword" id="6295035">interface</span>&nbsp;<span class="op" id="6295045">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295048">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295111">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295172">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295234">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295293">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295316">LastInsertId</span><span class="op" id="6295328">(</span><span class="op" id="6295329">)</span>&nbsp;<span class="op" id="6295331">(</span><span class="ident" id="6295332">int64</span><span class="op" id="6295337">,</span>&nbsp;<span class="builtintype" id="6295339">error</span><span class="op" id="6295344">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295348">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295407">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6295469">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295498">RowsAffected</span><span class="op" id="6295510">(</span><span class="op" id="6295511">)</span>&nbsp;<span class="op" id="6295513">(</span><span class="ident" id="6295514">int64</span><span class="op" id="6295519">,</span>&nbsp;<span class="builtintype" id="6295521">error</span><span class="op" id="6295526">)</span><br>
<span class="lineno"></span><span class="op" id="6295528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6295531">type</span>&nbsp;<span class="ident" id="6295536">driverResult</span>&nbsp;<span class="keyword" id="6295549">struct</span>&nbsp;<span class="op" id="6295556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295559">sync</span><span class="op" id="6295563">.</span><span class="ident" id="6295564">Locker</span>&nbsp;<span class="comment" id="6295571">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295591">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6295603">driver</span><span class="op" id="6295609">.</span><span class="ident" id="6295610">Result</span><br>
<span class="lineno"></span><span class="op" id="6295617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6295620">func</span>&nbsp;<span class="op" id="6295625">(</span><span class="ident" id="6295626">dr</span>&nbsp;<span class="ident" id="6295629">driverResult</span><span class="op" id="6295641">)</span>&nbsp;<span class="ident" id="6295643">LastInsertId</span><span class="op" id="6295655">(</span><span class="op" id="6295656">)</span>&nbsp;<span class="op" id="6295658">(</span><span class="ident" id="6295659">int64</span><span class="op" id="6295664">,</span>&nbsp;<span class="builtintype" id="6295666">error</span><span class="op" id="6295671">)</span>&nbsp;<span class="op" id="6295673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295676">dr</span><span class="op" id="6295678">.</span><span class="ident" id="6295679">Lock</span><span class="op" id="6295683">(</span><span class="op" id="6295684">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295687">defer</span>&nbsp;<span class="ident" id="6295693">dr</span><span class="op" id="6295695">.</span><span class="ident" id="6295696">Unlock</span><span class="op" id="6295702">(</span><span class="op" id="6295703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295706">return</span>&nbsp;<span class="ident" id="6295713">dr</span><span class="op" id="6295715">.</span><span class="ident" id="6295716">resi</span><span class="op" id="6295720">.</span><span class="ident" id="6295721">LastInsertId</span><span class="op" id="6295733">(</span><span class="op" id="6295734">)</span><br>
<span class="lineno"></span><span class="op" id="6295736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6295739">func</span>&nbsp;<span class="op" id="6295744">(</span><span class="ident" id="6295745">dr</span>&nbsp;<span class="ident" id="6295748">driverResult</span><span class="op" id="6295760">)</span>&nbsp;<span class="ident" id="6295762">RowsAffected</span><span class="op" id="6295774">(</span><span class="op" id="6295775">)</span>&nbsp;<span class="op" id="6295777">(</span><span class="ident" id="6295778">int64</span><span class="op" id="6295783">,</span>&nbsp;<span class="builtintype" id="6295785">error</span><span class="op" id="6295790">)</span>&nbsp;<span class="op" id="6295792">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6295795">dr</span><span class="op" id="6295797">.</span><span class="ident" id="6295798">Lock</span><span class="op" id="6295802">(</span><span class="op" id="6295803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295806">defer</span>&nbsp;<span class="ident" id="6295812">dr</span><span class="op" id="6295814">.</span><span class="ident" id="6295815">Unlock</span><span class="op" id="6295821">(</span><span class="op" id="6295822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295825">return</span>&nbsp;<span class="ident" id="6295832">dr</span><span class="op" id="6295834">.</span><span class="ident" id="6295835">resi</span><span class="op" id="6295839">.</span><span class="ident" id="6295840">RowsAffected</span><span class="op" id="6295852">(</span><span class="op" id="6295853">)</span><br>
<span class="lineno"></span><span class="op" id="6295855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="6295858">func</span>&nbsp;<span class="ident" id="6295863">stack</span><span class="op" id="6295868">(</span><span class="op" id="6295869">)</span>&nbsp;<span class="builtintype" id="6295871">string</span>&nbsp;<span class="op" id="6295878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295881">var</span>&nbsp;<span class="ident" id="6295885">buf</span>&nbsp;<span class="op" id="6295889">[</span><span class="num" id="6295890">2</span>&nbsp;<span class="op" id="6295892">&lt;&lt;</span>&nbsp;<span class="num" id="6295895">10</span><span class="op" id="6295897">]</span><span class="builtintype" id="6295898">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6295904">return</span>&nbsp;<span class="builtintype" id="6295911">string</span><span class="op" id="6295917">(</span><span class="ident" id="6295918">buf</span><span class="op" id="6295921">[</span><span class="op" id="6295922">:</span><span class="ident" id="6295923">runtime</span><span class="op" id="6295930">.</span><span class="ident" id="6295931">Stack</span><span class="op" id="6295936">(</span><span class="ident" id="6295937">buf</span><span class="op" id="6295940">[</span><span class="op" id="6295941">:</span><span class="op" id="6295942">]</span><span class="op" id="6295943">,</span>&nbsp;<span class="builtintype" id="6295945">false</span><span class="op" id="6295950">)</span><span class="op" id="6295951">]</span><span class="op" id="6295952">)</span><br>
<span class="lineno"></span><span class="op" id="6295954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="6295957">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="6295992">func</span>&nbsp;<span class="ident" id="6295997">withLock</span><span class="op" id="6296005">(</span><span class="ident" id="6296006">lk</span>&nbsp;<span class="ident" id="6296009">sync</span><span class="op" id="6296013">.</span><span class="ident" id="6296014">Locker</span><span class="op" id="6296020">,</span>&nbsp;<span class="ident" id="6296022">fn</span>&nbsp;<span class="keyword" id="6296025">func</span><span class="op" id="6296029">(</span><span class="op" id="6296030">)</span><span class="op" id="6296031">)</span>&nbsp;<span class="op" id="6296033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296036">lk</span><span class="op" id="6296038">.</span><span class="ident" id="6296039">Lock</span><span class="op" id="6296043">(</span><span class="op" id="6296044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296047">fn</span><span class="op" id="6296049">(</span><span class="op" id="6296050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6296053">lk</span><span class="op" id="6296055">.</span><span class="ident" id="6296056">Unlock</span><span class="op" id="6296062">(</span><span class="op" id="6296063">)</span><br>
<span class="lineno">1770</span><span class="op" id="6296065">}</span>
</div>
</body>
</html>
