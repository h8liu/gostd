<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5438481">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5438536">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5438590">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5438641">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Package&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;network&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;methods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Only&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;sees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;typically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;listener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;NewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Client&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;call,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;parameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;launches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;structure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;Unless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;transport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;At&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;Then&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;or<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;divCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;client.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5442470">package</span>&nbsp;<span class="ident" id="5442478">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442483">import</span>&nbsp;<span class="op" id="5442490">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442493">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442502">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442518">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442528">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442534">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442541">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442548">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442560">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442571">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442582">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442590">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442601">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5442616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442619">const</span>&nbsp;<span class="op" id="5442625">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5442628">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442660">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5442677">=</span>&nbsp;<span class="string" id="5442679">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442691">DefaultDebugPath</span>&nbsp;<span class="op" id="5442708">=</span>&nbsp;<span class="string" id="5442710">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5442723">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5442726">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5442794">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5442863">var</span>&nbsp;<span class="ident" id="5442867">typeOfError</span>&nbsp;<span class="op" id="5442879">=</span>&nbsp;<span class="ident" id="5442881">reflect</span><span class="op" id="5442888">.</span><span class="ident" id="5442889">TypeOf</span><span class="op" id="5442895">(</span><span class="op" id="5442896">(</span><span class="op" id="5442897">*</span><span class="builtintype" id="5442898">error</span><span class="op" id="5442903">)</span><span class="op" id="5442904">(</span><span class="builtintype" id="5442905">nil</span><span class="op" id="5442908">)</span><span class="op" id="5442909">)</span><span class="op" id="5442910">.</span><span class="ident" id="5442911">Elem</span><span class="op" id="5442915">(</span><span class="op" id="5442916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442919">type</span>&nbsp;<span class="ident" id="5442924">methodType</span>&nbsp;<span class="keyword" id="5442935">struct</span>&nbsp;<span class="op" id="5442942">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442945">sync</span><span class="op" id="5442949">.</span><span class="ident" id="5442950">Mutex</span>&nbsp;<span class="comment" id="5442956">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442978">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442989">reflect</span><span class="op" id="5442996">.</span><span class="ident" id="5442997">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443005">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443016">reflect</span><span class="op" id="5443023">.</span><span class="ident" id="5443024">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443030">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5443041">reflect</span><span class="op" id="5443048">.</span><span class="ident" id="5443049">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443055">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5443066">uint</span><br>
<span class="lineno">155</span><span class="op" id="5443071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5443074">type</span>&nbsp;<span class="ident" id="5443079">service</span>&nbsp;<span class="keyword" id="5443087">struct</span>&nbsp;<span class="op" id="5443094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443097">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5443104">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443127">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443147">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5443154">reflect</span><span class="op" id="5443161">.</span><span class="ident" id="5443162">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443177">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443217">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443224">reflect</span><span class="op" id="5443231">.</span><span class="ident" id="5443232">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443247">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443272">method</span>&nbsp;<span class="keyword" id="5443279">map</span><span class="op" id="5443282">[</span><span class="builtintype" id="5443283">string</span><span class="op" id="5443289">]</span><span class="op" id="5443290">*</span><span class="ident" id="5443291">methodType</span>&nbsp;<span class="comment" id="5443302">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5443324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5443327">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5443404">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5443474">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5443494">type</span>&nbsp;<span class="ident" id="5443499">Request</span>&nbsp;<span class="keyword" id="5443507">struct</span>&nbsp;<span class="op" id="5443514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443517">ServiceMethod</span>&nbsp;<span class="builtintype" id="5443531">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5443540">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443569">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443583">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5443592">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443629">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5443643">*</span><span class="ident" id="5443644">Request</span>&nbsp;<span class="comment" id="5443652">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5443679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5443682">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5443762">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5443832">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5443852">type</span>&nbsp;<span class="ident" id="5443857">Response</span>&nbsp;<span class="keyword" id="5443866">struct</span>&nbsp;<span class="op" id="5443873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443876">ServiceMethod</span>&nbsp;<span class="builtintype" id="5443890">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443900">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443931">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443945">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443955">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443986">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5444000">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444010">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444029">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444043">*</span><span class="ident" id="5444044">Response</span>&nbsp;<span class="comment" id="5444053">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5444080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444083">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5444119">type</span>&nbsp;<span class="ident" id="5444124">Server</span>&nbsp;<span class="keyword" id="5444131">struct</span>&nbsp;<span class="op" id="5444138">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444141">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444152">sync</span><span class="op" id="5444156">.</span><span class="ident" id="5444157">RWMutex</span>&nbsp;<span class="comment" id="5444165">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444193">serviceMap</span>&nbsp;<span class="keyword" id="5444204">map</span><span class="op" id="5444207">[</span><span class="builtintype" id="5444208">string</span><span class="op" id="5444214">]</span><span class="op" id="5444215">*</span><span class="ident" id="5444216">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444225">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444236">sync</span><span class="op" id="5444240">.</span><span class="ident" id="5444241">Mutex</span>&nbsp;<span class="comment" id="5444247">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444268">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444279">*</span><span class="ident" id="5444280">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444289">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5444300">sync</span><span class="op" id="5444304">.</span><span class="ident" id="5444305">Mutex</span>&nbsp;<span class="comment" id="5444311">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444333">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5444344">*</span><span class="ident" id="5444345">Response</span><br>
<span class="lineno"></span><span class="op" id="5444354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444357">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5444392">func</span>&nbsp;<span class="ident" id="5444397">NewServer</span><span class="op" id="5444406">(</span><span class="op" id="5444407">)</span>&nbsp;<span class="op" id="5444409">*</span><span class="ident" id="5444410">Server</span>&nbsp;<span class="op" id="5444417">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444420">return</span>&nbsp;<span class="op" id="5444427">&amp;</span><span class="ident" id="5444428">Server</span><span class="op" id="5444434">{</span><span class="ident" id="5444435">serviceMap</span><span class="op" id="5444445">:</span>&nbsp;<span class="builtinfunc" id="5444447">make</span><span class="op" id="5444451">(</span><span class="keyword" id="5444452">map</span><span class="op" id="5444455">[</span><span class="builtintype" id="5444456">string</span><span class="op" id="5444462">]</span><span class="op" id="5444463">*</span><span class="ident" id="5444464">service</span><span class="op" id="5444471">)</span><span class="op" id="5444472">}</span><br>
<span class="lineno"></span><span class="op" id="5444474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444477">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5444530">var</span>&nbsp;<span class="ident" id="5444534">DefaultServer</span>&nbsp;<span class="op" id="5444548">=</span>&nbsp;<span class="ident" id="5444550">NewServer</span><span class="op" id="5444559">(</span><span class="op" id="5444560">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5444563">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5444607">func</span>&nbsp;<span class="ident" id="5444612">isExported</span><span class="op" id="5444622">(</span><span class="ident" id="5444623">name</span>&nbsp;<span class="builtintype" id="5444628">string</span><span class="op" id="5444634">)</span>&nbsp;<span class="builtintype" id="5444636">bool</span>&nbsp;<span class="op" id="5444641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5444644">rune</span><span class="op" id="5444648">,</span>&nbsp;<span class="ident" id="5444650">_</span>&nbsp;<span class="op" id="5444652">:=</span>&nbsp;<span class="ident" id="5444655">utf8</span><span class="op" id="5444659">.</span><span class="ident" id="5444660">DecodeRuneInString</span><span class="op" id="5444678">(</span><span class="ident" id="5444679">name</span><span class="op" id="5444683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444686">return</span>&nbsp;<span class="ident" id="5444693">unicode</span><span class="op" id="5444700">.</span><span class="ident" id="5444701">IsUpper</span><span class="op" id="5444708">(</span><span class="builtintype" id="5444709">rune</span><span class="op" id="5444713">)</span><br>
<span class="lineno">205</span><span class="op" id="5444715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444718">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5444757">func</span>&nbsp;<span class="ident" id="5444762">isExportedOrBuiltinType</span><span class="op" id="5444785">(</span><span class="ident" id="5444786">t</span>&nbsp;<span class="ident" id="5444788">reflect</span><span class="op" id="5444795">.</span><span class="ident" id="5444796">Type</span><span class="op" id="5444800">)</span>&nbsp;<span class="builtintype" id="5444802">bool</span>&nbsp;<span class="op" id="5444807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444810">for</span>&nbsp;<span class="ident" id="5444814">t</span><span class="op" id="5444815">.</span><span class="ident" id="5444816">Kind</span><span class="op" id="5444820">(</span><span class="op" id="5444821">)</span>&nbsp;<span class="op" id="5444823">==</span>&nbsp;<span class="ident" id="5444826">reflect</span><span class="op" id="5444833">.</span><span class="ident" id="5444834">Ptr</span>&nbsp;<span class="op" id="5444838">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444842">t</span>&nbsp;<span class="op" id="5444844">=</span>&nbsp;<span class="ident" id="5444846">t</span><span class="op" id="5444847">.</span><span class="ident" id="5444848">Elem</span><span class="op" id="5444852">(</span><span class="op" id="5444853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444859">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444916">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444963">return</span>&nbsp;<span class="ident" id="5444970">isExported</span><span class="op" id="5444980">(</span><span class="ident" id="5444981">t</span><span class="op" id="5444982">.</span><span class="ident" id="5444983">Name</span><span class="op" id="5444987">(</span><span class="op" id="5444988">)</span><span class="op" id="5444989">)</span>&nbsp;<span class="op" id="5444991">||</span>&nbsp;<span class="ident" id="5444994">t</span><span class="op" id="5444995">.</span><span class="ident" id="5444996">PkgPath</span><span class="op" id="5445003">(</span><span class="op" id="5445004">)</span>&nbsp;<span class="op" id="5445006">==</span>&nbsp;<span class="string" id="5445009">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5445012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5445015">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5445077">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5445134">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5445155">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5445197">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5445235">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5445272">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5445342">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5445408">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5445485">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5445532">func</span>&nbsp;<span class="op" id="5445537">(</span><span class="ident" id="5445538">server</span>&nbsp;<span class="op" id="5445545">*</span><span class="ident" id="5445546">Server</span><span class="op" id="5445552">)</span>&nbsp;<span class="ident" id="5445554">Register</span><span class="op" id="5445562">(</span><span class="ident" id="5445563">rcvr</span>&nbsp;<span class="keyword" id="5445568">interface</span><span class="op" id="5445577">{</span><span class="op" id="5445578">}</span><span class="op" id="5445579">)</span>&nbsp;<span class="builtintype" id="5445581">error</span>&nbsp;<span class="op" id="5445587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445590">return</span>&nbsp;<span class="ident" id="5445597">server</span><span class="op" id="5445603">.</span><span class="ident" id="5445604">register</span><span class="op" id="5445612">(</span><span class="ident" id="5445613">rcvr</span><span class="op" id="5445617">,</span>&nbsp;<span class="string" id="5445619">&#34;&#34;</span><span class="op" id="5445621">,</span>&nbsp;<span class="builtintype" id="5445623">false</span><span class="op" id="5445628">)</span><br>
<span class="lineno"></span><span class="op" id="5445630">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5445633">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5445706">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5445750">func</span>&nbsp;<span class="op" id="5445755">(</span><span class="ident" id="5445756">server</span>&nbsp;<span class="op" id="5445763">*</span><span class="ident" id="5445764">Server</span><span class="op" id="5445770">)</span>&nbsp;<span class="ident" id="5445772">RegisterName</span><span class="op" id="5445784">(</span><span class="ident" id="5445785">name</span>&nbsp;<span class="builtintype" id="5445790">string</span><span class="op" id="5445796">,</span>&nbsp;<span class="ident" id="5445798">rcvr</span>&nbsp;<span class="keyword" id="5445803">interface</span><span class="op" id="5445812">{</span><span class="op" id="5445813">}</span><span class="op" id="5445814">)</span>&nbsp;<span class="builtintype" id="5445816">error</span>&nbsp;<span class="op" id="5445822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445825">return</span>&nbsp;<span class="ident" id="5445832">server</span><span class="op" id="5445838">.</span><span class="ident" id="5445839">register</span><span class="op" id="5445847">(</span><span class="ident" id="5445848">rcvr</span><span class="op" id="5445852">,</span>&nbsp;<span class="ident" id="5445854">name</span><span class="op" id="5445858">,</span>&nbsp;<span class="builtintype" id="5445860">true</span><span class="op" id="5445864">)</span><br>
<span class="lineno">235</span><span class="op" id="5445866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445869">func</span>&nbsp;<span class="op" id="5445874">(</span><span class="ident" id="5445875">server</span>&nbsp;<span class="op" id="5445882">*</span><span class="ident" id="5445883">Server</span><span class="op" id="5445889">)</span>&nbsp;<span class="ident" id="5445891">register</span><span class="op" id="5445899">(</span><span class="ident" id="5445900">rcvr</span>&nbsp;<span class="keyword" id="5445905">interface</span><span class="op" id="5445914">{</span><span class="op" id="5445915">}</span><span class="op" id="5445916">,</span>&nbsp;<span class="ident" id="5445918">name</span>&nbsp;<span class="builtintype" id="5445923">string</span><span class="op" id="5445929">,</span>&nbsp;<span class="ident" id="5445931">useName</span>&nbsp;<span class="builtintype" id="5445939">bool</span><span class="op" id="5445943">)</span>&nbsp;<span class="builtintype" id="5445945">error</span>&nbsp;<span class="op" id="5445951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445954">server</span><span class="op" id="5445960">.</span><span class="ident" id="5445961">mu</span><span class="op" id="5445963">.</span><span class="ident" id="5445964">Lock</span><span class="op" id="5445968">(</span><span class="op" id="5445969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445972">defer</span>&nbsp;<span class="ident" id="5445978">server</span><span class="op" id="5445984">.</span><span class="ident" id="5445985">mu</span><span class="op" id="5445987">.</span><span class="ident" id="5445988">Unlock</span><span class="op" id="5445994">(</span><span class="op" id="5445995">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445998">if</span>&nbsp;<span class="ident" id="5446001">server</span><span class="op" id="5446007">.</span><span class="ident" id="5446008">serviceMap</span>&nbsp;<span class="op" id="5446019">==</span>&nbsp;<span class="builtintype" id="5446022">nil</span>&nbsp;<span class="op" id="5446026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446030">server</span><span class="op" id="5446036">.</span><span class="ident" id="5446037">serviceMap</span>&nbsp;<span class="op" id="5446048">=</span>&nbsp;<span class="builtinfunc" id="5446050">make</span><span class="op" id="5446054">(</span><span class="keyword" id="5446055">map</span><span class="op" id="5446058">[</span><span class="builtintype" id="5446059">string</span><span class="op" id="5446065">]</span><span class="op" id="5446066">*</span><span class="ident" id="5446067">service</span><span class="op" id="5446074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446080">s</span>&nbsp;<span class="op" id="5446082">:=</span>&nbsp;<span class="builtinfunc" id="5446085">new</span><span class="op" id="5446088">(</span><span class="ident" id="5446089">service</span><span class="op" id="5446096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446099">s</span><span class="op" id="5446100">.</span><span class="ident" id="5446101">typ</span>&nbsp;<span class="op" id="5446105">=</span>&nbsp;<span class="ident" id="5446107">reflect</span><span class="op" id="5446114">.</span><span class="ident" id="5446115">TypeOf</span><span class="op" id="5446121">(</span><span class="ident" id="5446122">rcvr</span><span class="op" id="5446126">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446129">s</span><span class="op" id="5446130">.</span><span class="ident" id="5446131">rcvr</span>&nbsp;<span class="op" id="5446136">=</span>&nbsp;<span class="ident" id="5446138">reflect</span><span class="op" id="5446145">.</span><span class="ident" id="5446146">ValueOf</span><span class="op" id="5446153">(</span><span class="ident" id="5446154">rcvr</span><span class="op" id="5446158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446161">sname</span>&nbsp;<span class="op" id="5446167">:=</span>&nbsp;<span class="ident" id="5446170">reflect</span><span class="op" id="5446177">.</span><span class="ident" id="5446178">Indirect</span><span class="op" id="5446186">(</span><span class="ident" id="5446187">s</span><span class="op" id="5446188">.</span><span class="ident" id="5446189">rcvr</span><span class="op" id="5446193">)</span><span class="op" id="5446194">.</span><span class="ident" id="5446195">Type</span><span class="op" id="5446199">(</span><span class="op" id="5446200">)</span><span class="op" id="5446201">.</span><span class="ident" id="5446202">Name</span><span class="op" id="5446206">(</span><span class="op" id="5446207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446210">if</span>&nbsp;<span class="ident" id="5446213">useName</span>&nbsp;<span class="op" id="5446221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446225">sname</span>&nbsp;<span class="op" id="5446231">=</span>&nbsp;<span class="ident" id="5446233">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446239">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446242">if</span>&nbsp;<span class="ident" id="5446245">sname</span>&nbsp;<span class="op" id="5446251">==</span>&nbsp;<span class="string" id="5446254">&#34;&#34;</span>&nbsp;<span class="op" id="5446257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446261">s</span>&nbsp;<span class="op" id="5446263">:=</span>&nbsp;<span class="string" id="5446266">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5446308">+</span>&nbsp;<span class="ident" id="5446310">s</span><span class="op" id="5446311">.</span><span class="ident" id="5446312">typ</span><span class="op" id="5446315">.</span><span class="ident" id="5446316">String</span><span class="op" id="5446322">(</span><span class="op" id="5446323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446327">log</span><span class="op" id="5446330">.</span><span class="ident" id="5446331">Print</span><span class="op" id="5446336">(</span><span class="ident" id="5446337">s</span><span class="op" id="5446338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446342">return</span>&nbsp;<span class="ident" id="5446349">errors</span><span class="op" id="5446355">.</span><span class="ident" id="5446356">New</span><span class="op" id="5446359">(</span><span class="ident" id="5446360">s</span><span class="op" id="5446361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446364">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446367">if</span>&nbsp;<span class="op" id="5446370">!</span><span class="ident" id="5446371">isExported</span><span class="op" id="5446381">(</span><span class="ident" id="5446382">sname</span><span class="op" id="5446387">)</span>&nbsp;<span class="op" id="5446389">&amp;&amp;</span>&nbsp;<span class="op" id="5446392">!</span><span class="ident" id="5446393">useName</span>&nbsp;<span class="op" id="5446401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446405">s</span>&nbsp;<span class="op" id="5446407">:=</span>&nbsp;<span class="string" id="5446410">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5446432">+</span>&nbsp;<span class="ident" id="5446434">sname</span>&nbsp;<span class="op" id="5446440">+</span>&nbsp;<span class="string" id="5446442">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446463">log</span><span class="op" id="5446466">.</span><span class="ident" id="5446467">Print</span><span class="op" id="5446472">(</span><span class="ident" id="5446473">s</span><span class="op" id="5446474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446478">return</span>&nbsp;<span class="ident" id="5446485">errors</span><span class="op" id="5446491">.</span><span class="ident" id="5446492">New</span><span class="op" id="5446495">(</span><span class="ident" id="5446496">s</span><span class="op" id="5446497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446500">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446503">if</span>&nbsp;<span class="ident" id="5446506">_</span><span class="op" id="5446507">,</span>&nbsp;<span class="ident" id="5446509">present</span>&nbsp;<span class="op" id="5446517">:=</span>&nbsp;<span class="ident" id="5446520">server</span><span class="op" id="5446526">.</span><span class="ident" id="5446527">serviceMap</span><span class="op" id="5446537">[</span><span class="ident" id="5446538">sname</span><span class="op" id="5446543">]</span><span class="op" id="5446544">;</span>&nbsp;<span class="ident" id="5446546">present</span>&nbsp;<span class="op" id="5446554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446558">return</span>&nbsp;<span class="ident" id="5446565">errors</span><span class="op" id="5446571">.</span><span class="ident" id="5446572">New</span><span class="op" id="5446575">(</span><span class="string" id="5446576">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5446609">+</span>&nbsp;<span class="ident" id="5446611">sname</span><span class="op" id="5446616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446622">s</span><span class="op" id="5446623">.</span><span class="ident" id="5446624">name</span>&nbsp;<span class="op" id="5446629">=</span>&nbsp;<span class="ident" id="5446631">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5446639">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446663">s</span><span class="op" id="5446664">.</span><span class="ident" id="5446665">method</span>&nbsp;<span class="op" id="5446672">=</span>&nbsp;<span class="ident" id="5446674">suitableMethods</span><span class="op" id="5446689">(</span><span class="ident" id="5446690">s</span><span class="op" id="5446691">.</span><span class="ident" id="5446692">typ</span><span class="op" id="5446695">,</span>&nbsp;<span class="builtintype" id="5446697">true</span><span class="op" id="5446701">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446705">if</span>&nbsp;<span class="builtinfunc" id="5446708">len</span><span class="op" id="5446711">(</span><span class="ident" id="5446712">s</span><span class="op" id="5446713">.</span><span class="ident" id="5446714">method</span><span class="op" id="5446720">)</span>&nbsp;<span class="op" id="5446722">==</span>&nbsp;<span class="num" id="5446725">0</span>&nbsp;<span class="op" id="5446727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446731">str</span>&nbsp;<span class="op" id="5446735">:=</span>&nbsp;<span class="string" id="5446738">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5446744">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446805">method</span>&nbsp;<span class="op" id="5446812">:=</span>&nbsp;<span class="ident" id="5446815">suitableMethods</span><span class="op" id="5446830">(</span><span class="ident" id="5446831">reflect</span><span class="op" id="5446838">.</span><span class="ident" id="5446839">PtrTo</span><span class="op" id="5446844">(</span><span class="ident" id="5446845">s</span><span class="op" id="5446846">.</span><span class="ident" id="5446847">typ</span><span class="op" id="5446850">)</span><span class="op" id="5446851">,</span>&nbsp;<span class="builtintype" id="5446853">false</span><span class="op" id="5446858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446862">if</span>&nbsp;<span class="builtinfunc" id="5446865">len</span><span class="op" id="5446868">(</span><span class="ident" id="5446869">method</span><span class="op" id="5446875">)</span>&nbsp;<span class="op" id="5446877">!=</span>&nbsp;<span class="num" id="5446880">0</span>&nbsp;<span class="op" id="5446882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446887">str</span>&nbsp;<span class="op" id="5446891">=</span>&nbsp;<span class="string" id="5446893">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5446915">+</span>&nbsp;<span class="ident" id="5446917">sname</span>&nbsp;<span class="op" id="5446923">+</span>&nbsp;<span class="string" id="5446925">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447016">}</span>&nbsp;<span class="keyword" id="5447018">else</span>&nbsp;<span class="op" id="5447023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447028">str</span>&nbsp;<span class="op" id="5447032">=</span>&nbsp;<span class="string" id="5447034">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5447056">+</span>&nbsp;<span class="ident" id="5447058">sname</span>&nbsp;<span class="op" id="5447064">+</span>&nbsp;<span class="string" id="5447066">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447116">log</span><span class="op" id="5447119">.</span><span class="ident" id="5447120">Print</span><span class="op" id="5447125">(</span><span class="ident" id="5447126">str</span><span class="op" id="5447129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447133">return</span>&nbsp;<span class="ident" id="5447140">errors</span><span class="op" id="5447146">.</span><span class="ident" id="5447147">New</span><span class="op" id="5447150">(</span><span class="ident" id="5447151">str</span><span class="op" id="5447154">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447160">server</span><span class="op" id="5447166">.</span><span class="ident" id="5447167">serviceMap</span><span class="op" id="5447177">[</span><span class="ident" id="5447178">s</span><span class="op" id="5447179">.</span><span class="ident" id="5447180">name</span><span class="op" id="5447184">]</span>&nbsp;<span class="op" id="5447186">=</span>&nbsp;<span class="ident" id="5447188">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447191">return</span>&nbsp;<span class="builtintype" id="5447198">nil</span><br>
<span class="lineno"></span><span class="op" id="5447202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5447205">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5447276">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5447317">func</span>&nbsp;<span class="ident" id="5447322">suitableMethods</span><span class="op" id="5447337">(</span><span class="ident" id="5447338">typ</span>&nbsp;<span class="ident" id="5447342">reflect</span><span class="op" id="5447349">.</span><span class="ident" id="5447350">Type</span><span class="op" id="5447354">,</span>&nbsp;<span class="ident" id="5447356">reportErr</span>&nbsp;<span class="builtintype" id="5447366">bool</span><span class="op" id="5447370">)</span>&nbsp;<span class="keyword" id="5447372">map</span><span class="op" id="5447375">[</span><span class="builtintype" id="5447376">string</span><span class="op" id="5447382">]</span><span class="op" id="5447383">*</span><span class="ident" id="5447384">methodType</span>&nbsp;<span class="op" id="5447395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447398">methods</span>&nbsp;<span class="op" id="5447406">:=</span>&nbsp;<span class="builtinfunc" id="5447409">make</span><span class="op" id="5447413">(</span><span class="keyword" id="5447414">map</span><span class="op" id="5447417">[</span><span class="builtintype" id="5447418">string</span><span class="op" id="5447424">]</span><span class="op" id="5447425">*</span><span class="ident" id="5447426">methodType</span><span class="op" id="5447436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447439">for</span>&nbsp;<span class="ident" id="5447443">m</span>&nbsp;<span class="op" id="5447445">:=</span>&nbsp;<span class="num" id="5447448">0</span><span class="op" id="5447449">;</span>&nbsp;<span class="ident" id="5447451">m</span>&nbsp;<span class="op" id="5447453">&lt;</span>&nbsp;<span class="ident" id="5447455">typ</span><span class="op" id="5447458">.</span><span class="ident" id="5447459">NumMethod</span><span class="op" id="5447468">(</span><span class="op" id="5447469">)</span><span class="op" id="5447470">;</span>&nbsp;<span class="ident" id="5447472">m</span><span class="op" id="5447473">++</span>&nbsp;<span class="op" id="5447476">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447480">method</span>&nbsp;<span class="op" id="5447487">:=</span>&nbsp;<span class="ident" id="5447490">typ</span><span class="op" id="5447493">.</span><span class="ident" id="5447494">Method</span><span class="op" id="5447500">(</span><span class="ident" id="5447501">m</span><span class="op" id="5447502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447506">mtype</span>&nbsp;<span class="op" id="5447512">:=</span>&nbsp;<span class="ident" id="5447515">method</span><span class="op" id="5447521">.</span><span class="ident" id="5447522">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447529">mname</span>&nbsp;<span class="op" id="5447535">:=</span>&nbsp;<span class="ident" id="5447538">method</span><span class="op" id="5447544">.</span><span class="ident" id="5447545">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5447552">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447582">if</span>&nbsp;<span class="ident" id="5447585">method</span><span class="op" id="5447591">.</span><span class="ident" id="5447592">PkgPath</span>&nbsp;<span class="op" id="5447600">!=</span>&nbsp;<span class="string" id="5447603">&#34;&#34;</span>&nbsp;<span class="op" id="5447606">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447611">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5447626">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447680">if</span>&nbsp;<span class="ident" id="5447683">mtype</span><span class="op" id="5447688">.</span><span class="ident" id="5447689">NumIn</span><span class="op" id="5447694">(</span><span class="op" id="5447695">)</span>&nbsp;<span class="op" id="5447697">!=</span>&nbsp;<span class="num" id="5447700">3</span>&nbsp;<span class="op" id="5447702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447707">if</span>&nbsp;<span class="ident" id="5447710">reportErr</span>&nbsp;<span class="op" id="5447720">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447726">log</span><span class="op" id="5447729">.</span><span class="ident" id="5447730">Println</span><span class="op" id="5447737">(</span><span class="string" id="5447738">&#34;method&#34;</span><span class="op" id="5447746">,</span>&nbsp;<span class="ident" id="5447748">mname</span><span class="op" id="5447753">,</span>&nbsp;<span class="string" id="5447755">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5447781">,</span>&nbsp;<span class="ident" id="5447783">mtype</span><span class="op" id="5447788">.</span><span class="ident" id="5447789">NumIn</span><span class="op" id="5447794">(</span><span class="op" id="5447795">)</span><span class="op" id="5447796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447806">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5447821">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447859">argType</span>&nbsp;<span class="op" id="5447867">:=</span>&nbsp;<span class="ident" id="5447870">mtype</span><span class="op" id="5447875">.</span><span class="ident" id="5447876">In</span><span class="op" id="5447878">(</span><span class="num" id="5447879">1</span><span class="op" id="5447880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447884">if</span>&nbsp;<span class="op" id="5447887">!</span><span class="ident" id="5447888">isExportedOrBuiltinType</span><span class="op" id="5447911">(</span><span class="ident" id="5447912">argType</span><span class="op" id="5447919">)</span>&nbsp;<span class="op" id="5447921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447926">if</span>&nbsp;<span class="ident" id="5447929">reportErr</span>&nbsp;<span class="op" id="5447939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447945">log</span><span class="op" id="5447948">.</span><span class="ident" id="5447949">Println</span><span class="op" id="5447956">(</span><span class="ident" id="5447957">mname</span><span class="op" id="5447962">,</span>&nbsp;<span class="string" id="5447964">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5447993">,</span>&nbsp;<span class="ident" id="5447995">argType</span><span class="op" id="5448002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448007">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448012">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5448027">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448062">replyType</span>&nbsp;<span class="op" id="5448072">:=</span>&nbsp;<span class="ident" id="5448075">mtype</span><span class="op" id="5448080">.</span><span class="ident" id="5448081">In</span><span class="op" id="5448083">(</span><span class="num" id="5448084">2</span><span class="op" id="5448085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448089">if</span>&nbsp;<span class="ident" id="5448092">replyType</span><span class="op" id="5448101">.</span><span class="ident" id="5448102">Kind</span><span class="op" id="5448106">(</span><span class="op" id="5448107">)</span>&nbsp;<span class="op" id="5448109">!=</span>&nbsp;<span class="ident" id="5448112">reflect</span><span class="op" id="5448119">.</span><span class="ident" id="5448120">Ptr</span>&nbsp;<span class="op" id="5448124">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448129">if</span>&nbsp;<span class="ident" id="5448132">reportErr</span>&nbsp;<span class="op" id="5448142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448148">log</span><span class="op" id="5448151">.</span><span class="ident" id="5448152">Println</span><span class="op" id="5448159">(</span><span class="string" id="5448160">&#34;method&#34;</span><span class="op" id="5448168">,</span>&nbsp;<span class="ident" id="5448170">mname</span><span class="op" id="5448175">,</span>&nbsp;<span class="string" id="5448177">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5448204">,</span>&nbsp;<span class="ident" id="5448206">replyType</span><span class="op" id="5448215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448225">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448236">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5448240">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448274">if</span>&nbsp;<span class="op" id="5448277">!</span><span class="ident" id="5448278">isExportedOrBuiltinType</span><span class="op" id="5448301">(</span><span class="ident" id="5448302">replyType</span><span class="op" id="5448311">)</span>&nbsp;<span class="op" id="5448313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448318">if</span>&nbsp;<span class="ident" id="5448321">reportErr</span>&nbsp;<span class="op" id="5448331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448337">log</span><span class="op" id="5448340">.</span><span class="ident" id="5448341">Println</span><span class="op" id="5448348">(</span><span class="string" id="5448349">&#34;method&#34;</span><span class="op" id="5448357">,</span>&nbsp;<span class="ident" id="5448359">mname</span><span class="op" id="5448364">,</span>&nbsp;<span class="string" id="5448366">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5448392">,</span>&nbsp;<span class="ident" id="5448394">replyType</span><span class="op" id="5448403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448408">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448413">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5448428">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448455">if</span>&nbsp;<span class="ident" id="5448458">mtype</span><span class="op" id="5448463">.</span><span class="ident" id="5448464">NumOut</span><span class="op" id="5448470">(</span><span class="op" id="5448471">)</span>&nbsp;<span class="op" id="5448473">!=</span>&nbsp;<span class="num" id="5448476">1</span>&nbsp;<span class="op" id="5448478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448483">if</span>&nbsp;<span class="ident" id="5448486">reportErr</span>&nbsp;<span class="op" id="5448496">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448502">log</span><span class="op" id="5448505">.</span><span class="ident" id="5448506">Println</span><span class="op" id="5448513">(</span><span class="string" id="5448514">&#34;method&#34;</span><span class="op" id="5448522">,</span>&nbsp;<span class="ident" id="5448524">mname</span><span class="op" id="5448529">,</span>&nbsp;<span class="string" id="5448531">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5448558">,</span>&nbsp;<span class="ident" id="5448560">mtype</span><span class="op" id="5448565">.</span><span class="ident" id="5448566">NumOut</span><span class="op" id="5448572">(</span><span class="op" id="5448573">)</span><span class="op" id="5448574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448584">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5448599">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448649">if</span>&nbsp;<span class="ident" id="5448652">returnType</span>&nbsp;<span class="op" id="5448663">:=</span>&nbsp;<span class="ident" id="5448666">mtype</span><span class="op" id="5448671">.</span><span class="ident" id="5448672">Out</span><span class="op" id="5448675">(</span><span class="num" id="5448676">0</span><span class="op" id="5448677">)</span><span class="op" id="5448678">;</span>&nbsp;<span class="ident" id="5448680">returnType</span>&nbsp;<span class="op" id="5448691">!=</span>&nbsp;<span class="ident" id="5448694">typeOfError</span>&nbsp;<span class="op" id="5448706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448711">if</span>&nbsp;<span class="ident" id="5448714">reportErr</span>&nbsp;<span class="op" id="5448724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448730">log</span><span class="op" id="5448733">.</span><span class="ident" id="5448734">Println</span><span class="op" id="5448741">(</span><span class="string" id="5448742">&#34;method&#34;</span><span class="op" id="5448750">,</span>&nbsp;<span class="ident" id="5448752">mname</span><span class="op" id="5448757">,</span>&nbsp;<span class="string" id="5448759">&#34;returns&#34;</span><span class="op" id="5448768">,</span>&nbsp;<span class="ident" id="5448770">returnType</span><span class="op" id="5448780">.</span><span class="ident" id="5448781">String</span><span class="op" id="5448787">(</span><span class="op" id="5448788">)</span><span class="op" id="5448789">,</span>&nbsp;<span class="string" id="5448791">&#34;not&nbsp;error&#34;</span><span class="op" id="5448802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448812">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5448827">methods</span><span class="op" id="5448834">[</span><span class="ident" id="5448835">mname</span><span class="op" id="5448840">]</span>&nbsp;<span class="op" id="5448842">=</span>&nbsp;<span class="op" id="5448844">&amp;</span><span class="ident" id="5448845">methodType</span><span class="op" id="5448855">{</span><span class="ident" id="5448856">method</span><span class="op" id="5448862">:</span>&nbsp;<span class="ident" id="5448864">method</span><span class="op" id="5448870">,</span>&nbsp;<span class="ident" id="5448872">ArgType</span><span class="op" id="5448879">:</span>&nbsp;<span class="ident" id="5448881">argType</span><span class="op" id="5448888">,</span>&nbsp;<span class="ident" id="5448890">ReplyType</span><span class="op" id="5448899">:</span>&nbsp;<span class="ident" id="5448901">replyType</span><span class="op" id="5448910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5448913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5448916">return</span>&nbsp;<span class="ident" id="5448923">methods</span><br>
<span class="lineno"></span><span class="op" id="5448931">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5448934">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5449015">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5449100">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5449138">var</span>&nbsp;<span class="ident" id="5449142">invalidRequest</span>&nbsp;<span class="op" id="5449157">=</span>&nbsp;<span class="keyword" id="5449159">struct</span><span class="op" id="5449165">{</span><span class="op" id="5449166">}</span><span class="op" id="5449167">{</span><span class="op" id="5449168">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5449171">func</span>&nbsp;<span class="op" id="5449176">(</span><span class="ident" id="5449177">server</span>&nbsp;<span class="op" id="5449184">*</span><span class="ident" id="5449185">Server</span><span class="op" id="5449191">)</span>&nbsp;<span class="ident" id="5449193">sendResponse</span><span class="op" id="5449205">(</span><span class="ident" id="5449206">sending</span>&nbsp;<span class="op" id="5449214">*</span><span class="ident" id="5449215">sync</span><span class="op" id="5449219">.</span><span class="ident" id="5449220">Mutex</span><span class="op" id="5449225">,</span>&nbsp;<span class="ident" id="5449227">req</span>&nbsp;<span class="op" id="5449231">*</span><span class="ident" id="5449232">Request</span><span class="op" id="5449239">,</span>&nbsp;<span class="ident" id="5449241">reply</span>&nbsp;<span class="keyword" id="5449247">interface</span><span class="op" id="5449256">{</span><span class="op" id="5449257">}</span><span class="op" id="5449258">,</span>&nbsp;<span class="ident" id="5449260">codec</span>&nbsp;<span class="ident" id="5449266">ServerCodec</span><span class="op" id="5449277">,</span>&nbsp;<span class="ident" id="5449279">errmsg</span>&nbsp;<span class="builtintype" id="5449286">string</span><span class="op" id="5449292">)</span>&nbsp;<span class="op" id="5449294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449297">resp</span>&nbsp;<span class="op" id="5449302">:=</span>&nbsp;<span class="ident" id="5449305">server</span><span class="op" id="5449311">.</span><span class="ident" id="5449312">getResponse</span><span class="op" id="5449323">(</span><span class="op" id="5449324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5449327">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449358">resp</span><span class="op" id="5449362">.</span><span class="ident" id="5449363">ServiceMethod</span>&nbsp;<span class="op" id="5449377">=</span>&nbsp;<span class="ident" id="5449379">req</span><span class="op" id="5449382">.</span><span class="ident" id="5449383">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5449398">if</span>&nbsp;<span class="ident" id="5449401">errmsg</span>&nbsp;<span class="op" id="5449408">!=</span>&nbsp;<span class="string" id="5449411">&#34;&#34;</span>&nbsp;<span class="op" id="5449414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449418">resp</span><span class="op" id="5449422">.</span><span class="ident" id="5449423">Error</span>&nbsp;<span class="op" id="5449429">=</span>&nbsp;<span class="ident" id="5449431">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449440">reply</span>&nbsp;<span class="op" id="5449446">=</span>&nbsp;<span class="ident" id="5449448">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5449464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449467">resp</span><span class="op" id="5449471">.</span><span class="ident" id="5449472">Seq</span>&nbsp;<span class="op" id="5449476">=</span>&nbsp;<span class="ident" id="5449478">req</span><span class="op" id="5449481">.</span><span class="ident" id="5449482">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449487">sending</span><span class="op" id="5449494">.</span><span class="ident" id="5449495">Lock</span><span class="op" id="5449499">(</span><span class="op" id="5449500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449503">err</span>&nbsp;<span class="op" id="5449507">:=</span>&nbsp;<span class="ident" id="5449510">codec</span><span class="op" id="5449515">.</span><span class="ident" id="5449516">WriteResponse</span><span class="op" id="5449529">(</span><span class="ident" id="5449530">resp</span><span class="op" id="5449534">,</span>&nbsp;<span class="ident" id="5449536">reply</span><span class="op" id="5449541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5449544">if</span>&nbsp;<span class="ident" id="5449547">debugLog</span>&nbsp;<span class="op" id="5449556">&amp;&amp;</span>&nbsp;<span class="ident" id="5449559">err</span>&nbsp;<span class="op" id="5449563">!=</span>&nbsp;<span class="builtintype" id="5449566">nil</span>&nbsp;<span class="op" id="5449570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449574">log</span><span class="op" id="5449577">.</span><span class="ident" id="5449578">Println</span><span class="op" id="5449585">(</span><span class="string" id="5449586">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5449610">,</span>&nbsp;<span class="ident" id="5449612">err</span><span class="op" id="5449615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5449618">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449621">sending</span><span class="op" id="5449628">.</span><span class="ident" id="5449629">Unlock</span><span class="op" id="5449635">(</span><span class="op" id="5449636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449639">server</span><span class="op" id="5449645">.</span><span class="ident" id="5449646">freeResponse</span><span class="op" id="5449658">(</span><span class="ident" id="5449659">resp</span><span class="op" id="5449663">)</span><br>
<span class="lineno"></span><span class="op" id="5449665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5449668">func</span>&nbsp;<span class="op" id="5449673">(</span><span class="ident" id="5449674">m</span>&nbsp;<span class="op" id="5449676">*</span><span class="ident" id="5449677">methodType</span><span class="op" id="5449687">)</span>&nbsp;<span class="ident" id="5449689">NumCalls</span><span class="op" id="5449697">(</span><span class="op" id="5449698">)</span>&nbsp;<span class="op" id="5449700">(</span><span class="ident" id="5449701">n</span>&nbsp;<span class="builtintype" id="5449703">uint</span><span class="op" id="5449707">)</span>&nbsp;<span class="op" id="5449709">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449712">m</span><span class="op" id="5449713">.</span><span class="ident" id="5449714">Lock</span><span class="op" id="5449718">(</span><span class="op" id="5449719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449722">n</span>&nbsp;<span class="op" id="5449724">=</span>&nbsp;<span class="ident" id="5449726">m</span><span class="op" id="5449727">.</span><span class="ident" id="5449728">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449738">m</span><span class="op" id="5449739">.</span><span class="ident" id="5449740">Unlock</span><span class="op" id="5449746">(</span><span class="op" id="5449747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5449750">return</span>&nbsp;<span class="ident" id="5449757">n</span><br>
<span class="lineno"></span><span class="op" id="5449759">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5449762">func</span>&nbsp;<span class="op" id="5449767">(</span><span class="ident" id="5449768">s</span>&nbsp;<span class="op" id="5449770">*</span><span class="ident" id="5449771">service</span><span class="op" id="5449778">)</span>&nbsp;<span class="ident" id="5449780">call</span><span class="op" id="5449784">(</span><span class="ident" id="5449785">server</span>&nbsp;<span class="op" id="5449792">*</span><span class="ident" id="5449793">Server</span><span class="op" id="5449799">,</span>&nbsp;<span class="ident" id="5449801">sending</span>&nbsp;<span class="op" id="5449809">*</span><span class="ident" id="5449810">sync</span><span class="op" id="5449814">.</span><span class="ident" id="5449815">Mutex</span><span class="op" id="5449820">,</span>&nbsp;<span class="ident" id="5449822">mtype</span>&nbsp;<span class="op" id="5449828">*</span><span class="ident" id="5449829">methodType</span><span class="op" id="5449839">,</span>&nbsp;<span class="ident" id="5449841">req</span>&nbsp;<span class="op" id="5449845">*</span><span class="ident" id="5449846">Request</span><span class="op" id="5449853">,</span>&nbsp;<span class="ident" id="5449855">argv</span><span class="op" id="5449859">,</span>&nbsp;<span class="ident" id="5449861">replyv</span>&nbsp;<span class="ident" id="5449868">reflect</span><span class="op" id="5449875">.</span><span class="ident" id="5449876">Value</span><span class="op" id="5449881">,</span>&nbsp;<span class="ident" id="5449883">codec</span>&nbsp;<span class="ident" id="5449889">ServerCodec</span><span class="op" id="5449900">)</span>&nbsp;<span class="op" id="5449902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449905">mtype</span><span class="op" id="5449910">.</span><span class="ident" id="5449911">Lock</span><span class="op" id="5449915">(</span><span class="op" id="5449916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449919">mtype</span><span class="op" id="5449924">.</span><span class="ident" id="5449925">numCalls</span><span class="op" id="5449933">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449937">mtype</span><span class="op" id="5449942">.</span><span class="ident" id="5449943">Unlock</span><span class="op" id="5449949">(</span><span class="op" id="5449950">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5449953">function</span>&nbsp;<span class="op" id="5449962">:=</span>&nbsp;<span class="ident" id="5449965">mtype</span><span class="op" id="5449970">.</span><span class="ident" id="5449971">method</span><span class="op" id="5449977">.</span><span class="ident" id="5449978">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5449984">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450044">returnValues</span>&nbsp;<span class="op" id="5450057">:=</span>&nbsp;<span class="ident" id="5450060">function</span><span class="op" id="5450068">.</span><span class="ident" id="5450069">Call</span><span class="op" id="5450073">(</span><span class="op" id="5450074">[</span><span class="op" id="5450075">]</span><span class="ident" id="5450076">reflect</span><span class="op" id="5450083">.</span><span class="ident" id="5450084">Value</span><span class="op" id="5450089">{</span><span class="ident" id="5450090">s</span><span class="op" id="5450091">.</span><span class="ident" id="5450092">rcvr</span><span class="op" id="5450096">,</span>&nbsp;<span class="ident" id="5450098">argv</span><span class="op" id="5450102">,</span>&nbsp;<span class="ident" id="5450104">replyv</span><span class="op" id="5450110">}</span><span class="op" id="5450111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5450114">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450163">errInter</span>&nbsp;<span class="op" id="5450172">:=</span>&nbsp;<span class="ident" id="5450175">returnValues</span><span class="op" id="5450187">[</span><span class="num" id="5450188">0</span><span class="op" id="5450189">]</span><span class="op" id="5450190">.</span><span class="ident" id="5450191">Interface</span><span class="op" id="5450200">(</span><span class="op" id="5450201">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450204">errmsg</span>&nbsp;<span class="op" id="5450211">:=</span>&nbsp;<span class="string" id="5450214">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5450218">if</span>&nbsp;<span class="ident" id="5450221">errInter</span>&nbsp;<span class="op" id="5450230">!=</span>&nbsp;<span class="builtintype" id="5450233">nil</span>&nbsp;<span class="op" id="5450237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450241">errmsg</span>&nbsp;<span class="op" id="5450248">=</span>&nbsp;<span class="ident" id="5450250">errInter</span><span class="op" id="5450258">.</span><span class="op" id="5450259">(</span><span class="builtintype" id="5450260">error</span><span class="op" id="5450265">)</span><span class="op" id="5450266">.</span><span class="ident" id="5450267">Error</span><span class="op" id="5450272">(</span><span class="op" id="5450273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5450276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450279">server</span><span class="op" id="5450285">.</span><span class="ident" id="5450286">sendResponse</span><span class="op" id="5450298">(</span><span class="ident" id="5450299">sending</span><span class="op" id="5450306">,</span>&nbsp;<span class="ident" id="5450308">req</span><span class="op" id="5450311">,</span>&nbsp;<span class="ident" id="5450313">replyv</span><span class="op" id="5450319">.</span><span class="ident" id="5450320">Interface</span><span class="op" id="5450329">(</span><span class="op" id="5450330">)</span><span class="op" id="5450331">,</span>&nbsp;<span class="ident" id="5450333">codec</span><span class="op" id="5450338">,</span>&nbsp;<span class="ident" id="5450340">errmsg</span><span class="op" id="5450346">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450349">server</span><span class="op" id="5450355">.</span><span class="ident" id="5450356">freeRequest</span><span class="op" id="5450367">(</span><span class="ident" id="5450368">req</span><span class="op" id="5450371">)</span><br>
<span class="lineno"></span><span class="op" id="5450373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5450376">type</span>&nbsp;<span class="ident" id="5450381">gobServerCodec</span>&nbsp;<span class="keyword" id="5450396">struct</span>&nbsp;<span class="op" id="5450403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450406">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450413">io</span><span class="op" id="5450415">.</span><span class="ident" id="5450416">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450433">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5450440">*</span><span class="ident" id="5450441">gob</span><span class="op" id="5450444">.</span><span class="ident" id="5450445">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450454">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5450461">*</span><span class="ident" id="5450462">gob</span><span class="op" id="5450465">.</span><span class="ident" id="5450466">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450475">encBuf</span>&nbsp;<span class="op" id="5450482">*</span><span class="ident" id="5450483">bufio</span><span class="op" id="5450488">.</span><span class="ident" id="5450489">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5450497">closed</span>&nbsp;<span class="builtintype" id="5450504">bool</span><br>
<span class="lineno"></span><span class="op" id="5450509">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5450512">func</span>&nbsp;<span class="op" id="5450517">(</span><span class="ident" id="5450518">c</span>&nbsp;<span class="op" id="5450520">*</span><span class="ident" id="5450521">gobServerCodec</span><span class="op" id="5450535">)</span>&nbsp;<span class="ident" id="5450537">ReadRequestHeader</span><span class="op" id="5450554">(</span><span class="ident" id="5450555">r</span>&nbsp;<span class="op" id="5450557">*</span><span class="ident" id="5450558">Request</span><span class="op" id="5450565">)</span>&nbsp;<span class="builtintype" id="5450567">error</span>&nbsp;<span class="op" id="5450573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5450576">return</span>&nbsp;<span class="ident" id="5450583">c</span><span class="op" id="5450584">.</span><span class="ident" id="5450585">dec</span><span class="op" id="5450588">.</span><span class="ident" id="5450589">Decode</span><span class="op" id="5450595">(</span><span class="ident" id="5450596">r</span><span class="op" id="5450597">)</span><br>
<span class="lineno"></span><span class="op" id="5450599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5450602">func</span>&nbsp;<span class="op" id="5450607">(</span><span class="ident" id="5450608">c</span>&nbsp;<span class="op" id="5450610">*</span><span class="ident" id="5450611">gobServerCodec</span><span class="op" id="5450625">)</span>&nbsp;<span class="ident" id="5450627">ReadRequestBody</span><span class="op" id="5450642">(</span><span class="ident" id="5450643">body</span>&nbsp;<span class="keyword" id="5450648">interface</span><span class="op" id="5450657">{</span><span class="op" id="5450658">}</span><span class="op" id="5450659">)</span>&nbsp;<span class="builtintype" id="5450661">error</span>&nbsp;<span class="op" id="5450667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5450670">return</span>&nbsp;<span class="ident" id="5450677">c</span><span class="op" id="5450678">.</span><span class="ident" id="5450679">dec</span><span class="op" id="5450682">.</span><span class="ident" id="5450683">Decode</span><span class="op" id="5450689">(</span><span class="ident" id="5450690">body</span><span class="op" id="5450694">)</span><br>
<span class="lineno"></span><span class="op" id="5450696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5450699">func</span>&nbsp;<span class="op" id="5450704">(</span><span class="ident" id="5450705">c</span>&nbsp;<span class="op" id="5450707">*</span><span class="ident" id="5450708">gobServerCodec</span><span class="op" id="5450722">)</span>&nbsp;<span class="ident" id="5450724">WriteResponse</span><span class="op" id="5450737">(</span><span class="ident" id="5450738">r</span>&nbsp;<span class="op" id="5450740">*</span><span class="ident" id="5450741">Response</span><span class="op" id="5450749">,</span>&nbsp;<span class="ident" id="5450751">body</span>&nbsp;<span class="keyword" id="5450756">interface</span><span class="op" id="5450765">{</span><span class="op" id="5450766">}</span><span class="op" id="5450767">)</span>&nbsp;<span class="op" id="5450769">(</span><span class="ident" id="5450770">err</span>&nbsp;<span class="builtintype" id="5450774">error</span><span class="op" id="5450779">)</span>&nbsp;<span class="op" id="5450781">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5450784">if</span>&nbsp;<span class="ident" id="5450787">err</span>&nbsp;<span class="op" id="5450791">=</span>&nbsp;<span class="ident" id="5450793">c</span><span class="op" id="5450794">.</span><span class="ident" id="5450795">enc</span><span class="op" id="5450798">.</span><span class="ident" id="5450799">Encode</span><span class="op" id="5450805">(</span><span class="ident" id="5450806">r</span><span class="op" id="5450807">)</span><span class="op" id="5450808">;</span>&nbsp;<span class="ident" id="5450810">err</span>&nbsp;<span class="op" id="5450814">!=</span>&nbsp;<span class="builtintype" id="5450817">nil</span>&nbsp;<span class="op" id="5450821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5450825">if</span>&nbsp;<span class="ident" id="5450828">c</span><span class="op" id="5450829">.</span><span class="ident" id="5450830">encBuf</span><span class="op" id="5450836">.</span><span class="ident" id="5450837">Flush</span><span class="op" id="5450842">(</span><span class="op" id="5450843">)</span>&nbsp;<span class="op" id="5450845">==</span>&nbsp;<span class="builtintype" id="5450848">nil</span>&nbsp;<span class="op" id="5450852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5450857">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5450929">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451001">log</span><span class="op" id="5451004">.</span><span class="ident" id="5451005">Println</span><span class="op" id="5451012">(</span><span class="string" id="5451013">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5451048">,</span>&nbsp;<span class="ident" id="5451050">err</span><span class="op" id="5451053">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451058">c</span><span class="op" id="5451059">.</span><span class="ident" id="5451060">Close</span><span class="op" id="5451065">(</span><span class="op" id="5451066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5451070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451074">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5451082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451085">if</span>&nbsp;<span class="ident" id="5451088">err</span>&nbsp;<span class="op" id="5451092">=</span>&nbsp;<span class="ident" id="5451094">c</span><span class="op" id="5451095">.</span><span class="ident" id="5451096">enc</span><span class="op" id="5451099">.</span><span class="ident" id="5451100">Encode</span><span class="op" id="5451106">(</span><span class="ident" id="5451107">body</span><span class="op" id="5451111">)</span><span class="op" id="5451112">;</span>&nbsp;<span class="ident" id="5451114">err</span>&nbsp;<span class="op" id="5451118">!=</span>&nbsp;<span class="builtintype" id="5451121">nil</span>&nbsp;<span class="op" id="5451125">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451129">if</span>&nbsp;<span class="ident" id="5451132">c</span><span class="op" id="5451133">.</span><span class="ident" id="5451134">encBuf</span><span class="op" id="5451140">.</span><span class="ident" id="5451141">Flush</span><span class="op" id="5451146">(</span><span class="op" id="5451147">)</span>&nbsp;<span class="op" id="5451149">==</span>&nbsp;<span class="builtintype" id="5451152">nil</span>&nbsp;<span class="op" id="5451156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5451161">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5451236">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451308">log</span><span class="op" id="5451311">.</span><span class="ident" id="5451312">Println</span><span class="op" id="5451319">(</span><span class="string" id="5451320">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5451351">,</span>&nbsp;<span class="ident" id="5451353">err</span><span class="op" id="5451356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451361">c</span><span class="op" id="5451362">.</span><span class="ident" id="5451363">Close</span><span class="op" id="5451368">(</span><span class="op" id="5451369">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5451373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451377">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5451385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451388">return</span>&nbsp;<span class="ident" id="5451395">c</span><span class="op" id="5451396">.</span><span class="ident" id="5451397">encBuf</span><span class="op" id="5451403">.</span><span class="ident" id="5451404">Flush</span><span class="op" id="5451409">(</span><span class="op" id="5451410">)</span><br>
<span class="lineno"></span><span class="op" id="5451412">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5451415">func</span>&nbsp;<span class="op" id="5451420">(</span><span class="ident" id="5451421">c</span>&nbsp;<span class="op" id="5451423">*</span><span class="ident" id="5451424">gobServerCodec</span><span class="op" id="5451438">)</span>&nbsp;<span class="ident" id="5451440">Close</span><span class="op" id="5451445">(</span><span class="op" id="5451446">)</span>&nbsp;<span class="builtintype" id="5451448">error</span>&nbsp;<span class="op" id="5451454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451457">if</span>&nbsp;<span class="ident" id="5451460">c</span><span class="op" id="5451461">.</span><span class="ident" id="5451462">closed</span>&nbsp;<span class="op" id="5451469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5451473">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451545">return</span>&nbsp;<span class="builtintype" id="5451552">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5451557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451560">c</span><span class="op" id="5451561">.</span><span class="ident" id="5451562">closed</span>&nbsp;<span class="op" id="5451569">=</span>&nbsp;<span class="builtintype" id="5451571">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5451577">return</span>&nbsp;<span class="ident" id="5451584">c</span><span class="op" id="5451585">.</span><span class="ident" id="5451586">rwc</span><span class="op" id="5451589">.</span><span class="ident" id="5451590">Close</span><span class="op" id="5451595">(</span><span class="op" id="5451596">)</span><br>
<span class="lineno"></span><span class="op" id="5451598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5451601">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5451654">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5451725">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5451786">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5451849">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5451908">func</span>&nbsp;<span class="op" id="5451913">(</span><span class="ident" id="5451914">server</span>&nbsp;<span class="op" id="5451921">*</span><span class="ident" id="5451922">Server</span><span class="op" id="5451928">)</span>&nbsp;<span class="ident" id="5451930">ServeConn</span><span class="op" id="5451939">(</span><span class="ident" id="5451940">conn</span>&nbsp;<span class="ident" id="5451945">io</span><span class="op" id="5451947">.</span><span class="ident" id="5451948">ReadWriteCloser</span><span class="op" id="5451963">)</span>&nbsp;<span class="op" id="5451965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451968">buf</span>&nbsp;<span class="op" id="5451972">:=</span>&nbsp;<span class="ident" id="5451975">bufio</span><span class="op" id="5451980">.</span><span class="ident" id="5451981">NewWriter</span><span class="op" id="5451990">(</span><span class="ident" id="5451991">conn</span><span class="op" id="5451995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5451998">srv</span>&nbsp;<span class="op" id="5452002">:=</span>&nbsp;<span class="op" id="5452005">&amp;</span><span class="ident" id="5452006">gobServerCodec</span><span class="op" id="5452020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452024">rwc</span><span class="op" id="5452027">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452032">conn</span><span class="op" id="5452036">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452040">dec</span><span class="op" id="5452043">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452048">gob</span><span class="op" id="5452051">.</span><span class="ident" id="5452052">NewDecoder</span><span class="op" id="5452062">(</span><span class="ident" id="5452063">conn</span><span class="op" id="5452067">)</span><span class="op" id="5452068">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452072">enc</span><span class="op" id="5452075">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452080">gob</span><span class="op" id="5452083">.</span><span class="ident" id="5452084">NewEncoder</span><span class="op" id="5452094">(</span><span class="ident" id="5452095">buf</span><span class="op" id="5452098">)</span><span class="op" id="5452099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452103">encBuf</span><span class="op" id="5452109">:</span>&nbsp;<span class="ident" id="5452111">buf</span><span class="op" id="5452114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452120">server</span><span class="op" id="5452126">.</span><span class="ident" id="5452127">ServeCodec</span><span class="op" id="5452137">(</span><span class="ident" id="5452138">srv</span><span class="op" id="5452141">)</span><br>
<span class="lineno"></span><span class="op" id="5452143">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5452146">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5452210">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5452251">func</span>&nbsp;<span class="op" id="5452256">(</span><span class="ident" id="5452257">server</span>&nbsp;<span class="op" id="5452264">*</span><span class="ident" id="5452265">Server</span><span class="op" id="5452271">)</span>&nbsp;<span class="ident" id="5452273">ServeCodec</span><span class="op" id="5452283">(</span><span class="ident" id="5452284">codec</span>&nbsp;<span class="ident" id="5452290">ServerCodec</span><span class="op" id="5452301">)</span>&nbsp;<span class="op" id="5452303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452306">sending</span>&nbsp;<span class="op" id="5452314">:=</span>&nbsp;<span class="builtinfunc" id="5452317">new</span><span class="op" id="5452320">(</span><span class="ident" id="5452321">sync</span><span class="op" id="5452325">.</span><span class="ident" id="5452326">Mutex</span><span class="op" id="5452331">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452334">for</span>&nbsp;<span class="op" id="5452338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452342">service</span><span class="op" id="5452349">,</span>&nbsp;<span class="ident" id="5452351">mtype</span><span class="op" id="5452356">,</span>&nbsp;<span class="ident" id="5452358">req</span><span class="op" id="5452361">,</span>&nbsp;<span class="ident" id="5452363">argv</span><span class="op" id="5452367">,</span>&nbsp;<span class="ident" id="5452369">replyv</span><span class="op" id="5452375">,</span>&nbsp;<span class="ident" id="5452377">keepReading</span><span class="op" id="5452388">,</span>&nbsp;<span class="ident" id="5452390">err</span>&nbsp;<span class="op" id="5452394">:=</span>&nbsp;<span class="ident" id="5452397">server</span><span class="op" id="5452403">.</span><span class="ident" id="5452404">readRequest</span><span class="op" id="5452415">(</span><span class="ident" id="5452416">codec</span><span class="op" id="5452421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452425">if</span>&nbsp;<span class="ident" id="5452428">err</span>&nbsp;<span class="op" id="5452432">!=</span>&nbsp;<span class="builtintype" id="5452435">nil</span>&nbsp;<span class="op" id="5452439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452444">if</span>&nbsp;<span class="ident" id="5452447">debugLog</span>&nbsp;<span class="op" id="5452456">&amp;&amp;</span>&nbsp;<span class="ident" id="5452459">err</span>&nbsp;<span class="op" id="5452463">!=</span>&nbsp;<span class="ident" id="5452466">io</span><span class="op" id="5452468">.</span><span class="ident" id="5452469">EOF</span>&nbsp;<span class="op" id="5452473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452479">log</span><span class="op" id="5452482">.</span><span class="ident" id="5452483">Println</span><span class="op" id="5452490">(</span><span class="string" id="5452491">&#34;rpc:&#34;</span><span class="op" id="5452497">,</span>&nbsp;<span class="ident" id="5452499">err</span><span class="op" id="5452502">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452512">if</span>&nbsp;<span class="op" id="5452515">!</span><span class="ident" id="5452516">keepReading</span>&nbsp;<span class="op" id="5452528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452534">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5452548">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452611">if</span>&nbsp;<span class="ident" id="5452614">req</span>&nbsp;<span class="op" id="5452618">!=</span>&nbsp;<span class="builtintype" id="5452621">nil</span>&nbsp;<span class="op" id="5452625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452631">server</span><span class="op" id="5452637">.</span><span class="ident" id="5452638">sendResponse</span><span class="op" id="5452650">(</span><span class="ident" id="5452651">sending</span><span class="op" id="5452658">,</span>&nbsp;<span class="ident" id="5452660">req</span><span class="op" id="5452663">,</span>&nbsp;<span class="ident" id="5452665">invalidRequest</span><span class="op" id="5452679">,</span>&nbsp;<span class="ident" id="5452681">codec</span><span class="op" id="5452686">,</span>&nbsp;<span class="ident" id="5452688">err</span><span class="op" id="5452691">.</span><span class="ident" id="5452692">Error</span><span class="op" id="5452697">(</span><span class="op" id="5452698">)</span><span class="op" id="5452699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452705">server</span><span class="op" id="5452711">.</span><span class="ident" id="5452712">freeRequest</span><span class="op" id="5452723">(</span><span class="ident" id="5452724">req</span><span class="op" id="5452727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452737">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5452752">go</span>&nbsp;<span class="ident" id="5452755">service</span><span class="op" id="5452762">.</span><span class="ident" id="5452763">call</span><span class="op" id="5452767">(</span><span class="ident" id="5452768">server</span><span class="op" id="5452774">,</span>&nbsp;<span class="ident" id="5452776">sending</span><span class="op" id="5452783">,</span>&nbsp;<span class="ident" id="5452785">mtype</span><span class="op" id="5452790">,</span>&nbsp;<span class="ident" id="5452792">req</span><span class="op" id="5452795">,</span>&nbsp;<span class="ident" id="5452797">argv</span><span class="op" id="5452801">,</span>&nbsp;<span class="ident" id="5452803">replyv</span><span class="op" id="5452809">,</span>&nbsp;<span class="ident" id="5452811">codec</span><span class="op" id="5452816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5452819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5452822">codec</span><span class="op" id="5452827">.</span><span class="ident" id="5452828">Close</span><span class="op" id="5452833">(</span><span class="op" id="5452834">)</span><br>
<span class="lineno"></span><span class="op" id="5452836">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5452839">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5452917">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5452965">func</span>&nbsp;<span class="op" id="5452970">(</span><span class="ident" id="5452971">server</span>&nbsp;<span class="op" id="5452978">*</span><span class="ident" id="5452979">Server</span><span class="op" id="5452985">)</span>&nbsp;<span class="ident" id="5452987">ServeRequest</span><span class="op" id="5452999">(</span><span class="ident" id="5453000">codec</span>&nbsp;<span class="ident" id="5453006">ServerCodec</span><span class="op" id="5453017">)</span>&nbsp;<span class="builtintype" id="5453019">error</span>&nbsp;<span class="op" id="5453025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453028">sending</span>&nbsp;<span class="op" id="5453036">:=</span>&nbsp;<span class="builtinfunc" id="5453039">new</span><span class="op" id="5453042">(</span><span class="ident" id="5453043">sync</span><span class="op" id="5453047">.</span><span class="ident" id="5453048">Mutex</span><span class="op" id="5453053">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453056">service</span><span class="op" id="5453063">,</span>&nbsp;<span class="ident" id="5453065">mtype</span><span class="op" id="5453070">,</span>&nbsp;<span class="ident" id="5453072">req</span><span class="op" id="5453075">,</span>&nbsp;<span class="ident" id="5453077">argv</span><span class="op" id="5453081">,</span>&nbsp;<span class="ident" id="5453083">replyv</span><span class="op" id="5453089">,</span>&nbsp;<span class="ident" id="5453091">keepReading</span><span class="op" id="5453102">,</span>&nbsp;<span class="ident" id="5453104">err</span>&nbsp;<span class="op" id="5453108">:=</span>&nbsp;<span class="ident" id="5453111">server</span><span class="op" id="5453117">.</span><span class="ident" id="5453118">readRequest</span><span class="op" id="5453129">(</span><span class="ident" id="5453130">codec</span><span class="op" id="5453135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453138">if</span>&nbsp;<span class="ident" id="5453141">err</span>&nbsp;<span class="op" id="5453145">!=</span>&nbsp;<span class="builtintype" id="5453148">nil</span>&nbsp;<span class="op" id="5453152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453156">if</span>&nbsp;<span class="op" id="5453159">!</span><span class="ident" id="5453160">keepReading</span>&nbsp;<span class="op" id="5453172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453177">return</span>&nbsp;<span class="ident" id="5453184">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453190">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5453194">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453256">if</span>&nbsp;<span class="ident" id="5453259">req</span>&nbsp;<span class="op" id="5453263">!=</span>&nbsp;<span class="builtintype" id="5453266">nil</span>&nbsp;<span class="op" id="5453270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453275">server</span><span class="op" id="5453281">.</span><span class="ident" id="5453282">sendResponse</span><span class="op" id="5453294">(</span><span class="ident" id="5453295">sending</span><span class="op" id="5453302">,</span>&nbsp;<span class="ident" id="5453304">req</span><span class="op" id="5453307">,</span>&nbsp;<span class="ident" id="5453309">invalidRequest</span><span class="op" id="5453323">,</span>&nbsp;<span class="ident" id="5453325">codec</span><span class="op" id="5453330">,</span>&nbsp;<span class="ident" id="5453332">err</span><span class="op" id="5453335">.</span><span class="ident" id="5453336">Error</span><span class="op" id="5453341">(</span><span class="op" id="5453342">)</span><span class="op" id="5453343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453348">server</span><span class="op" id="5453354">.</span><span class="ident" id="5453355">freeRequest</span><span class="op" id="5453366">(</span><span class="ident" id="5453367">req</span><span class="op" id="5453370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453374">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453378">return</span>&nbsp;<span class="ident" id="5453385">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453393">service</span><span class="op" id="5453400">.</span><span class="ident" id="5453401">call</span><span class="op" id="5453405">(</span><span class="ident" id="5453406">server</span><span class="op" id="5453412">,</span>&nbsp;<span class="ident" id="5453414">sending</span><span class="op" id="5453421">,</span>&nbsp;<span class="ident" id="5453423">mtype</span><span class="op" id="5453428">,</span>&nbsp;<span class="ident" id="5453430">req</span><span class="op" id="5453433">,</span>&nbsp;<span class="ident" id="5453435">argv</span><span class="op" id="5453439">,</span>&nbsp;<span class="ident" id="5453441">replyv</span><span class="op" id="5453447">,</span>&nbsp;<span class="ident" id="5453449">codec</span><span class="op" id="5453454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453457">return</span>&nbsp;<span class="builtintype" id="5453464">nil</span><br>
<span class="lineno"></span><span class="op" id="5453468">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5453471">func</span>&nbsp;<span class="op" id="5453476">(</span><span class="ident" id="5453477">server</span>&nbsp;<span class="op" id="5453484">*</span><span class="ident" id="5453485">Server</span><span class="op" id="5453491">)</span>&nbsp;<span class="ident" id="5453493">getRequest</span><span class="op" id="5453503">(</span><span class="op" id="5453504">)</span>&nbsp;<span class="op" id="5453506">*</span><span class="ident" id="5453507">Request</span>&nbsp;<span class="op" id="5453515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453518">server</span><span class="op" id="5453524">.</span><span class="ident" id="5453525">reqLock</span><span class="op" id="5453532">.</span><span class="ident" id="5453533">Lock</span><span class="op" id="5453537">(</span><span class="op" id="5453538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453541">req</span>&nbsp;<span class="op" id="5453545">:=</span>&nbsp;<span class="ident" id="5453548">server</span><span class="op" id="5453554">.</span><span class="ident" id="5453555">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453564">if</span>&nbsp;<span class="ident" id="5453567">req</span>&nbsp;<span class="op" id="5453571">==</span>&nbsp;<span class="builtintype" id="5453574">nil</span>&nbsp;<span class="op" id="5453578">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453582">req</span>&nbsp;<span class="op" id="5453586">=</span>&nbsp;<span class="builtinfunc" id="5453588">new</span><span class="op" id="5453591">(</span><span class="ident" id="5453592">Request</span><span class="op" id="5453599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453602">}</span>&nbsp;<span class="keyword" id="5453604">else</span>&nbsp;<span class="op" id="5453609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453613">server</span><span class="op" id="5453619">.</span><span class="ident" id="5453620">freeReq</span>&nbsp;<span class="op" id="5453628">=</span>&nbsp;<span class="ident" id="5453630">req</span><span class="op" id="5453633">.</span><span class="ident" id="5453634">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453641">*</span><span class="ident" id="5453642">req</span>&nbsp;<span class="op" id="5453646">=</span>&nbsp;<span class="ident" id="5453648">Request</span><span class="op" id="5453655">{</span><span class="op" id="5453656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453659">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453662">server</span><span class="op" id="5453668">.</span><span class="ident" id="5453669">reqLock</span><span class="op" id="5453676">.</span><span class="ident" id="5453677">Unlock</span><span class="op" id="5453683">(</span><span class="op" id="5453684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453687">return</span>&nbsp;<span class="ident" id="5453694">req</span><br>
<span class="lineno"></span><span class="op" id="5453698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5453701">func</span>&nbsp;<span class="op" id="5453706">(</span><span class="ident" id="5453707">server</span>&nbsp;<span class="op" id="5453714">*</span><span class="ident" id="5453715">Server</span><span class="op" id="5453721">)</span>&nbsp;<span class="ident" id="5453723">freeRequest</span><span class="op" id="5453734">(</span><span class="ident" id="5453735">req</span>&nbsp;<span class="op" id="5453739">*</span><span class="ident" id="5453740">Request</span><span class="op" id="5453747">)</span>&nbsp;<span class="op" id="5453749">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453752">server</span><span class="op" id="5453758">.</span><span class="ident" id="5453759">reqLock</span><span class="op" id="5453766">.</span><span class="ident" id="5453767">Lock</span><span class="op" id="5453771">(</span><span class="op" id="5453772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453775">req</span><span class="op" id="5453778">.</span><span class="ident" id="5453779">next</span>&nbsp;<span class="op" id="5453784">=</span>&nbsp;<span class="ident" id="5453786">server</span><span class="op" id="5453792">.</span><span class="ident" id="5453793">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453802">server</span><span class="op" id="5453808">.</span><span class="ident" id="5453809">freeReq</span>&nbsp;<span class="op" id="5453817">=</span>&nbsp;<span class="ident" id="5453819">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453824">server</span><span class="op" id="5453830">.</span><span class="ident" id="5453831">reqLock</span><span class="op" id="5453838">.</span><span class="ident" id="5453839">Unlock</span><span class="op" id="5453845">(</span><span class="op" id="5453846">)</span><br>
<span class="lineno"></span><span class="op" id="5453848">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5453851">func</span>&nbsp;<span class="op" id="5453856">(</span><span class="ident" id="5453857">server</span>&nbsp;<span class="op" id="5453864">*</span><span class="ident" id="5453865">Server</span><span class="op" id="5453871">)</span>&nbsp;<span class="ident" id="5453873">getResponse</span><span class="op" id="5453884">(</span><span class="op" id="5453885">)</span>&nbsp;<span class="op" id="5453887">*</span><span class="ident" id="5453888">Response</span>&nbsp;<span class="op" id="5453897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453900">server</span><span class="op" id="5453906">.</span><span class="ident" id="5453907">respLock</span><span class="op" id="5453915">.</span><span class="ident" id="5453916">Lock</span><span class="op" id="5453920">(</span><span class="op" id="5453921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453924">resp</span>&nbsp;<span class="op" id="5453929">:=</span>&nbsp;<span class="ident" id="5453932">server</span><span class="op" id="5453938">.</span><span class="ident" id="5453939">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5453949">if</span>&nbsp;<span class="ident" id="5453952">resp</span>&nbsp;<span class="op" id="5453957">==</span>&nbsp;<span class="builtintype" id="5453960">nil</span>&nbsp;<span class="op" id="5453964">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5453968">resp</span>&nbsp;<span class="op" id="5453973">=</span>&nbsp;<span class="builtinfunc" id="5453975">new</span><span class="op" id="5453978">(</span><span class="ident" id="5453979">Response</span><span class="op" id="5453987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5453990">}</span>&nbsp;<span class="keyword" id="5453992">else</span>&nbsp;<span class="op" id="5453997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454001">server</span><span class="op" id="5454007">.</span><span class="ident" id="5454008">freeResp</span>&nbsp;<span class="op" id="5454017">=</span>&nbsp;<span class="ident" id="5454019">resp</span><span class="op" id="5454023">.</span><span class="ident" id="5454024">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454031">*</span><span class="ident" id="5454032">resp</span>&nbsp;<span class="op" id="5454037">=</span>&nbsp;<span class="ident" id="5454039">Response</span><span class="op" id="5454047">{</span><span class="op" id="5454048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454051">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454054">server</span><span class="op" id="5454060">.</span><span class="ident" id="5454061">respLock</span><span class="op" id="5454069">.</span><span class="ident" id="5454070">Unlock</span><span class="op" id="5454076">(</span><span class="op" id="5454077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454080">return</span>&nbsp;<span class="ident" id="5454087">resp</span><br>
<span class="lineno"></span><span class="op" id="5454092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5454095">func</span>&nbsp;<span class="op" id="5454100">(</span><span class="ident" id="5454101">server</span>&nbsp;<span class="op" id="5454108">*</span><span class="ident" id="5454109">Server</span><span class="op" id="5454115">)</span>&nbsp;<span class="ident" id="5454117">freeResponse</span><span class="op" id="5454129">(</span><span class="ident" id="5454130">resp</span>&nbsp;<span class="op" id="5454135">*</span><span class="ident" id="5454136">Response</span><span class="op" id="5454144">)</span>&nbsp;<span class="op" id="5454146">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454149">server</span><span class="op" id="5454155">.</span><span class="ident" id="5454156">respLock</span><span class="op" id="5454164">.</span><span class="ident" id="5454165">Lock</span><span class="op" id="5454169">(</span><span class="op" id="5454170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454173">resp</span><span class="op" id="5454177">.</span><span class="ident" id="5454178">next</span>&nbsp;<span class="op" id="5454183">=</span>&nbsp;<span class="ident" id="5454185">server</span><span class="op" id="5454191">.</span><span class="ident" id="5454192">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454202">server</span><span class="op" id="5454208">.</span><span class="ident" id="5454209">freeResp</span>&nbsp;<span class="op" id="5454218">=</span>&nbsp;<span class="ident" id="5454220">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454226">server</span><span class="op" id="5454232">.</span><span class="ident" id="5454233">respLock</span><span class="op" id="5454241">.</span><span class="ident" id="5454242">Unlock</span><span class="op" id="5454248">(</span><span class="op" id="5454249">)</span><br>
<span class="lineno"></span><span class="op" id="5454251">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5454254">func</span>&nbsp;<span class="op" id="5454259">(</span><span class="ident" id="5454260">server</span>&nbsp;<span class="op" id="5454267">*</span><span class="ident" id="5454268">Server</span><span class="op" id="5454274">)</span>&nbsp;<span class="ident" id="5454276">readRequest</span><span class="op" id="5454287">(</span><span class="ident" id="5454288">codec</span>&nbsp;<span class="ident" id="5454294">ServerCodec</span><span class="op" id="5454305">)</span>&nbsp;<span class="op" id="5454307">(</span><span class="ident" id="5454308">service</span>&nbsp;<span class="op" id="5454316">*</span><span class="ident" id="5454317">service</span><span class="op" id="5454324">,</span>&nbsp;<span class="ident" id="5454326">mtype</span>&nbsp;<span class="op" id="5454332">*</span><span class="ident" id="5454333">methodType</span><span class="op" id="5454343">,</span>&nbsp;<span class="ident" id="5454345">req</span>&nbsp;<span class="op" id="5454349">*</span><span class="ident" id="5454350">Request</span><span class="op" id="5454357">,</span>&nbsp;<span class="ident" id="5454359">argv</span><span class="op" id="5454363">,</span>&nbsp;<span class="ident" id="5454365">replyv</span>&nbsp;<span class="ident" id="5454372">reflect</span><span class="op" id="5454379">.</span><span class="ident" id="5454380">Value</span><span class="op" id="5454385">,</span>&nbsp;<span class="ident" id="5454387">keepReading</span>&nbsp;<span class="builtintype" id="5454399">bool</span><span class="op" id="5454403">,</span>&nbsp;<span class="ident" id="5454405">err</span>&nbsp;<span class="builtintype" id="5454409">error</span><span class="op" id="5454414">)</span>&nbsp;<span class="op" id="5454416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454419">service</span><span class="op" id="5454426">,</span>&nbsp;<span class="ident" id="5454428">mtype</span><span class="op" id="5454433">,</span>&nbsp;<span class="ident" id="5454435">req</span><span class="op" id="5454438">,</span>&nbsp;<span class="ident" id="5454440">keepReading</span><span class="op" id="5454451">,</span>&nbsp;<span class="ident" id="5454453">err</span>&nbsp;<span class="op" id="5454457">=</span>&nbsp;<span class="ident" id="5454459">server</span><span class="op" id="5454465">.</span><span class="ident" id="5454466">readRequestHeader</span><span class="op" id="5454483">(</span><span class="ident" id="5454484">codec</span><span class="op" id="5454489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454492">if</span>&nbsp;<span class="ident" id="5454495">err</span>&nbsp;<span class="op" id="5454499">!=</span>&nbsp;<span class="builtintype" id="5454502">nil</span>&nbsp;<span class="op" id="5454506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454510">if</span>&nbsp;<span class="op" id="5454513">!</span><span class="ident" id="5454514">keepReading</span>&nbsp;<span class="op" id="5454526">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454544">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454562">codec</span><span class="op" id="5454567">.</span><span class="ident" id="5454568">ReadRequestBody</span><span class="op" id="5454583">(</span><span class="builtintype" id="5454584">nil</span><span class="op" id="5454587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454591">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454603">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454634">argIsValue</span>&nbsp;<span class="op" id="5454645">:=</span>&nbsp;<span class="builtintype" id="5454648">false</span>&nbsp;<span class="comment" id="5454654">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454700">if</span>&nbsp;<span class="ident" id="5454703">mtype</span><span class="op" id="5454708">.</span><span class="ident" id="5454709">ArgType</span><span class="op" id="5454716">.</span><span class="ident" id="5454717">Kind</span><span class="op" id="5454721">(</span><span class="op" id="5454722">)</span>&nbsp;<span class="op" id="5454724">==</span>&nbsp;<span class="ident" id="5454727">reflect</span><span class="op" id="5454734">.</span><span class="ident" id="5454735">Ptr</span>&nbsp;<span class="op" id="5454739">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454743">argv</span>&nbsp;<span class="op" id="5454748">=</span>&nbsp;<span class="ident" id="5454750">reflect</span><span class="op" id="5454757">.</span><span class="ident" id="5454758">New</span><span class="op" id="5454761">(</span><span class="ident" id="5454762">mtype</span><span class="op" id="5454767">.</span><span class="ident" id="5454768">ArgType</span><span class="op" id="5454775">.</span><span class="ident" id="5454776">Elem</span><span class="op" id="5454780">(</span><span class="op" id="5454781">)</span><span class="op" id="5454782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454785">}</span>&nbsp;<span class="keyword" id="5454787">else</span>&nbsp;<span class="op" id="5454792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454796">argv</span>&nbsp;<span class="op" id="5454801">=</span>&nbsp;<span class="ident" id="5454803">reflect</span><span class="op" id="5454810">.</span><span class="ident" id="5454811">New</span><span class="op" id="5454814">(</span><span class="ident" id="5454815">mtype</span><span class="op" id="5454820">.</span><span class="ident" id="5454821">ArgType</span><span class="op" id="5454828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454832">argIsValue</span>&nbsp;<span class="op" id="5454843">=</span>&nbsp;<span class="builtintype" id="5454845">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454851">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5454854">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454895">if</span>&nbsp;<span class="ident" id="5454898">err</span>&nbsp;<span class="op" id="5454902">=</span>&nbsp;<span class="ident" id="5454904">codec</span><span class="op" id="5454909">.</span><span class="ident" id="5454910">ReadRequestBody</span><span class="op" id="5454925">(</span><span class="ident" id="5454926">argv</span><span class="op" id="5454930">.</span><span class="ident" id="5454931">Interface</span><span class="op" id="5454940">(</span><span class="op" id="5454941">)</span><span class="op" id="5454942">)</span><span class="op" id="5454943">;</span>&nbsp;<span class="ident" id="5454945">err</span>&nbsp;<span class="op" id="5454949">!=</span>&nbsp;<span class="builtintype" id="5454952">nil</span>&nbsp;<span class="op" id="5454956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454960">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5454968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5454971">if</span>&nbsp;<span class="ident" id="5454974">argIsValue</span>&nbsp;<span class="op" id="5454985">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5454989">argv</span>&nbsp;<span class="op" id="5454994">=</span>&nbsp;<span class="ident" id="5454996">argv</span><span class="op" id="5455000">.</span><span class="ident" id="5455001">Elem</span><span class="op" id="5455005">(</span><span class="op" id="5455006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5455009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455013">replyv</span>&nbsp;<span class="op" id="5455020">=</span>&nbsp;<span class="ident" id="5455022">reflect</span><span class="op" id="5455029">.</span><span class="ident" id="5455030">New</span><span class="op" id="5455033">(</span><span class="ident" id="5455034">mtype</span><span class="op" id="5455039">.</span><span class="ident" id="5455040">ReplyType</span><span class="op" id="5455049">.</span><span class="ident" id="5455050">Elem</span><span class="op" id="5455054">(</span><span class="op" id="5455055">)</span><span class="op" id="5455056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455059">return</span><br>
<span class="lineno">570</span><span class="op" id="5455066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5455069">func</span>&nbsp;<span class="op" id="5455074">(</span><span class="ident" id="5455075">server</span>&nbsp;<span class="op" id="5455082">*</span><span class="ident" id="5455083">Server</span><span class="op" id="5455089">)</span>&nbsp;<span class="ident" id="5455091">readRequestHeader</span><span class="op" id="5455108">(</span><span class="ident" id="5455109">codec</span>&nbsp;<span class="ident" id="5455115">ServerCodec</span><span class="op" id="5455126">)</span>&nbsp;<span class="op" id="5455128">(</span><span class="ident" id="5455129">service</span>&nbsp;<span class="op" id="5455137">*</span><span class="ident" id="5455138">service</span><span class="op" id="5455145">,</span>&nbsp;<span class="ident" id="5455147">mtype</span>&nbsp;<span class="op" id="5455153">*</span><span class="ident" id="5455154">methodType</span><span class="op" id="5455164">,</span>&nbsp;<span class="ident" id="5455166">req</span>&nbsp;<span class="op" id="5455170">*</span><span class="ident" id="5455171">Request</span><span class="op" id="5455178">,</span>&nbsp;<span class="ident" id="5455180">keepReading</span>&nbsp;<span class="builtintype" id="5455192">bool</span><span class="op" id="5455196">,</span>&nbsp;<span class="ident" id="5455198">err</span>&nbsp;<span class="builtintype" id="5455202">error</span><span class="op" id="5455207">)</span>&nbsp;<span class="op" id="5455209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5455212">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455241">req</span>&nbsp;<span class="op" id="5455245">=</span>&nbsp;<span class="ident" id="5455247">server</span><span class="op" id="5455253">.</span><span class="ident" id="5455254">getRequest</span><span class="op" id="5455264">(</span><span class="op" id="5455265">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455268">err</span>&nbsp;<span class="op" id="5455272">=</span>&nbsp;<span class="ident" id="5455274">codec</span><span class="op" id="5455279">.</span><span class="ident" id="5455280">ReadRequestHeader</span><span class="op" id="5455297">(</span><span class="ident" id="5455298">req</span><span class="op" id="5455301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455304">if</span>&nbsp;<span class="ident" id="5455307">err</span>&nbsp;<span class="op" id="5455311">!=</span>&nbsp;<span class="builtintype" id="5455314">nil</span>&nbsp;<span class="op" id="5455318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455322">req</span>&nbsp;<span class="op" id="5455326">=</span>&nbsp;<span class="builtintype" id="5455328">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455334">if</span>&nbsp;<span class="ident" id="5455337">err</span>&nbsp;<span class="op" id="5455341">==</span>&nbsp;<span class="ident" id="5455344">io</span><span class="op" id="5455346">.</span><span class="ident" id="5455347">EOF</span>&nbsp;<span class="op" id="5455351">||</span>&nbsp;<span class="ident" id="5455354">err</span>&nbsp;<span class="op" id="5455358">==</span>&nbsp;<span class="ident" id="5455361">io</span><span class="op" id="5455363">.</span><span class="ident" id="5455364">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5455381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455386">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5455395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455399">err</span>&nbsp;<span class="op" id="5455403">=</span>&nbsp;<span class="ident" id="5455405">errors</span><span class="op" id="5455411">.</span><span class="ident" id="5455412">New</span><span class="op" id="5455415">(</span><span class="string" id="5455416">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5455454">+</span>&nbsp;<span class="ident" id="5455456">err</span><span class="op" id="5455459">.</span><span class="ident" id="5455460">Error</span><span class="op" id="5455465">(</span><span class="op" id="5455466">)</span><span class="op" id="5455467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5455479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5455483">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5455545">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455603">keepReading</span>&nbsp;<span class="op" id="5455615">=</span>&nbsp;<span class="builtintype" id="5455617">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455624">dot</span>&nbsp;<span class="op" id="5455628">:=</span>&nbsp;<span class="ident" id="5455631">strings</span><span class="op" id="5455638">.</span><span class="ident" id="5455639">LastIndex</span><span class="op" id="5455648">(</span><span class="ident" id="5455649">req</span><span class="op" id="5455652">.</span><span class="ident" id="5455653">ServiceMethod</span><span class="op" id="5455666">,</span>&nbsp;<span class="string" id="5455668">&#34;.&#34;</span><span class="op" id="5455671">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455674">if</span>&nbsp;<span class="ident" id="5455677">dot</span>&nbsp;<span class="op" id="5455681">&lt;</span>&nbsp;<span class="num" id="5455683">0</span>&nbsp;<span class="op" id="5455685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455689">err</span>&nbsp;<span class="op" id="5455693">=</span>&nbsp;<span class="ident" id="5455695">errors</span><span class="op" id="5455701">.</span><span class="ident" id="5455702">New</span><span class="op" id="5455705">(</span><span class="string" id="5455706">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5455749">+</span>&nbsp;<span class="ident" id="5455751">req</span><span class="op" id="5455754">.</span><span class="ident" id="5455755">ServiceMethod</span><span class="op" id="5455768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455772">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5455780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455783">serviceName</span>&nbsp;<span class="op" id="5455795">:=</span>&nbsp;<span class="ident" id="5455798">req</span><span class="op" id="5455801">.</span><span class="ident" id="5455802">ServiceMethod</span><span class="op" id="5455815">[</span><span class="op" id="5455816">:</span><span class="ident" id="5455817">dot</span><span class="op" id="5455820">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455823">methodName</span>&nbsp;<span class="op" id="5455834">:=</span>&nbsp;<span class="ident" id="5455837">req</span><span class="op" id="5455840">.</span><span class="ident" id="5455841">ServiceMethod</span><span class="op" id="5455854">[</span><span class="ident" id="5455855">dot</span><span class="op" id="5455858">+</span><span class="num" id="5455859">1</span><span class="op" id="5455860">:</span><span class="op" id="5455861">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5455865">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455890">server</span><span class="op" id="5455896">.</span><span class="ident" id="5455897">mu</span><span class="op" id="5455899">.</span><span class="ident" id="5455900">RLock</span><span class="op" id="5455905">(</span><span class="op" id="5455906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455909">service</span>&nbsp;<span class="op" id="5455917">=</span>&nbsp;<span class="ident" id="5455919">server</span><span class="op" id="5455925">.</span><span class="ident" id="5455926">serviceMap</span><span class="op" id="5455936">[</span><span class="ident" id="5455937">serviceName</span><span class="op" id="5455948">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455951">server</span><span class="op" id="5455957">.</span><span class="ident" id="5455958">mu</span><span class="op" id="5455960">.</span><span class="ident" id="5455961">RUnlock</span><span class="op" id="5455968">(</span><span class="op" id="5455969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5455972">if</span>&nbsp;<span class="ident" id="5455975">service</span>&nbsp;<span class="op" id="5455983">==</span>&nbsp;<span class="builtintype" id="5455986">nil</span>&nbsp;<span class="op" id="5455990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5455994">err</span>&nbsp;<span class="op" id="5455998">=</span>&nbsp;<span class="ident" id="5456000">errors</span><span class="op" id="5456006">.</span><span class="ident" id="5456007">New</span><span class="op" id="5456010">(</span><span class="string" id="5456011">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5456038">+</span>&nbsp;<span class="ident" id="5456040">req</span><span class="op" id="5456043">.</span><span class="ident" id="5456044">ServiceMethod</span><span class="op" id="5456057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456061">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5456069">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5456072">mtype</span>&nbsp;<span class="op" id="5456078">=</span>&nbsp;<span class="ident" id="5456080">service</span><span class="op" id="5456087">.</span><span class="ident" id="5456088">method</span><span class="op" id="5456094">[</span><span class="ident" id="5456095">methodName</span><span class="op" id="5456105">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456108">if</span>&nbsp;<span class="ident" id="5456111">mtype</span>&nbsp;<span class="op" id="5456117">==</span>&nbsp;<span class="builtintype" id="5456120">nil</span>&nbsp;<span class="op" id="5456124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5456128">err</span>&nbsp;<span class="op" id="5456132">=</span>&nbsp;<span class="ident" id="5456134">errors</span><span class="op" id="5456140">.</span><span class="ident" id="5456141">New</span><span class="op" id="5456144">(</span><span class="string" id="5456145">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5456171">+</span>&nbsp;<span class="ident" id="5456173">req</span><span class="op" id="5456176">.</span><span class="ident" id="5456177">ServiceMethod</span><span class="op" id="5456190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5456193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456196">return</span><br>
<span class="lineno">610</span><span class="op" id="5456203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5456206">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5456272">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5456342">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5456375">func</span>&nbsp;<span class="op" id="5456380">(</span><span class="ident" id="5456381">server</span>&nbsp;<span class="op" id="5456388">*</span><span class="ident" id="5456389">Server</span><span class="op" id="5456395">)</span>&nbsp;<span class="ident" id="5456397">Accept</span><span class="op" id="5456403">(</span><span class="ident" id="5456404">lis</span>&nbsp;<span class="ident" id="5456408">net</span><span class="op" id="5456411">.</span><span class="ident" id="5456412">Listener</span><span class="op" id="5456420">)</span>&nbsp;<span class="op" id="5456422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456425">for</span>&nbsp;<span class="op" id="5456429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5456433">conn</span><span class="op" id="5456437">,</span>&nbsp;<span class="ident" id="5456439">err</span>&nbsp;<span class="op" id="5456443">:=</span>&nbsp;<span class="ident" id="5456446">lis</span><span class="op" id="5456449">.</span><span class="ident" id="5456450">Accept</span><span class="op" id="5456456">(</span><span class="op" id="5456457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456461">if</span>&nbsp;<span class="ident" id="5456464">err</span>&nbsp;<span class="op" id="5456468">!=</span>&nbsp;<span class="builtintype" id="5456471">nil</span>&nbsp;<span class="op" id="5456475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5456480">log</span><span class="op" id="5456483">.</span><span class="ident" id="5456484">Fatal</span><span class="op" id="5456489">(</span><span class="string" id="5456490">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5456510">,</span>&nbsp;<span class="ident" id="5456512">err</span><span class="op" id="5456515">.</span><span class="ident" id="5456516">Error</span><span class="op" id="5456521">(</span><span class="op" id="5456522">)</span><span class="op" id="5456523">)</span>&nbsp;<span class="comment" id="5456525">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5456545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456549">go</span>&nbsp;<span class="ident" id="5456552">server</span><span class="op" id="5456558">.</span><span class="ident" id="5456559">ServeConn</span><span class="op" id="5456568">(</span><span class="ident" id="5456569">conn</span><span class="op" id="5456573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5456576">}</span><br>
<span class="lineno"></span><span class="op" id="5456578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5456581">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5456648">func</span>&nbsp;<span class="ident" id="5456653">Register</span><span class="op" id="5456661">(</span><span class="ident" id="5456662">rcvr</span>&nbsp;<span class="keyword" id="5456667">interface</span><span class="op" id="5456676">{</span><span class="op" id="5456677">}</span><span class="op" id="5456678">)</span>&nbsp;<span class="builtintype" id="5456680">error</span>&nbsp;<span class="op" id="5456686">{</span>&nbsp;<span class="keyword" id="5456688">return</span>&nbsp;<span class="ident" id="5456695">DefaultServer</span><span class="op" id="5456708">.</span><span class="ident" id="5456709">Register</span><span class="op" id="5456717">(</span><span class="ident" id="5456718">rcvr</span><span class="op" id="5456722">)</span>&nbsp;<span class="op" id="5456724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5456727">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5456800">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5456844">func</span>&nbsp;<span class="ident" id="5456849">RegisterName</span><span class="op" id="5456861">(</span><span class="ident" id="5456862">name</span>&nbsp;<span class="builtintype" id="5456867">string</span><span class="op" id="5456873">,</span>&nbsp;<span class="ident" id="5456875">rcvr</span>&nbsp;<span class="keyword" id="5456880">interface</span><span class="op" id="5456889">{</span><span class="op" id="5456890">}</span><span class="op" id="5456891">)</span>&nbsp;<span class="builtintype" id="5456893">error</span>&nbsp;<span class="op" id="5456899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5456902">return</span>&nbsp;<span class="ident" id="5456909">DefaultServer</span><span class="op" id="5456922">.</span><span class="ident" id="5456923">RegisterName</span><span class="op" id="5456935">(</span><span class="ident" id="5456936">name</span><span class="op" id="5456940">,</span>&nbsp;<span class="ident" id="5456942">rcvr</span><span class="op" id="5456946">)</span><br>
<span class="lineno"></span><span class="op" id="5456948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5456951">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5457018">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5457074">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5457141">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5457212">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5457285">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5457341">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5457412">type</span>&nbsp;<span class="ident" id="5457417">ServerCodec</span>&nbsp;<span class="keyword" id="5457429">interface</span>&nbsp;<span class="op" id="5457439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5457442">ReadRequestHeader</span><span class="op" id="5457459">(</span><span class="op" id="5457460">*</span><span class="ident" id="5457461">Request</span><span class="op" id="5457468">)</span>&nbsp;<span class="builtintype" id="5457470">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5457477">ReadRequestBody</span><span class="op" id="5457492">(</span><span class="keyword" id="5457493">interface</span><span class="op" id="5457502">{</span><span class="op" id="5457503">}</span><span class="op" id="5457504">)</span>&nbsp;<span class="builtintype" id="5457506">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5457513">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5457587">WriteResponse</span><span class="op" id="5457600">(</span><span class="op" id="5457601">*</span><span class="ident" id="5457602">Response</span><span class="op" id="5457610">,</span>&nbsp;<span class="keyword" id="5457612">interface</span><span class="op" id="5457621">{</span><span class="op" id="5457622">}</span><span class="op" id="5457623">)</span>&nbsp;<span class="builtintype" id="5457625">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5457633">Close</span><span class="op" id="5457638">(</span><span class="op" id="5457639">)</span>&nbsp;<span class="builtintype" id="5457641">error</span><br>
<span class="lineno"></span><span class="op" id="5457647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5457650">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5457710">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5457781">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5457842">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5457905">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5457964">func</span>&nbsp;<span class="ident" id="5457969">ServeConn</span><span class="op" id="5457978">(</span><span class="ident" id="5457979">conn</span>&nbsp;<span class="ident" id="5457984">io</span><span class="op" id="5457986">.</span><span class="ident" id="5457987">ReadWriteCloser</span><span class="op" id="5458002">)</span>&nbsp;<span class="op" id="5458004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5458007">DefaultServer</span><span class="op" id="5458020">.</span><span class="ident" id="5458021">ServeConn</span><span class="op" id="5458030">(</span><span class="ident" id="5458031">conn</span><span class="op" id="5458035">)</span><br>
<span class="lineno"></span><span class="op" id="5458037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5458040">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5458104">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5458145">func</span>&nbsp;<span class="ident" id="5458150">ServeCodec</span><span class="op" id="5458160">(</span><span class="ident" id="5458161">codec</span>&nbsp;<span class="ident" id="5458167">ServerCodec</span><span class="op" id="5458178">)</span>&nbsp;<span class="op" id="5458180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5458183">DefaultServer</span><span class="op" id="5458196">.</span><span class="ident" id="5458197">ServeCodec</span><span class="op" id="5458207">(</span><span class="ident" id="5458208">codec</span><span class="op" id="5458213">)</span><br>
<span class="lineno"></span><span class="op" id="5458215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5458218">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5458296">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5458344">func</span>&nbsp;<span class="ident" id="5458349">ServeRequest</span><span class="op" id="5458361">(</span><span class="ident" id="5458362">codec</span>&nbsp;<span class="ident" id="5458368">ServerCodec</span><span class="op" id="5458379">)</span>&nbsp;<span class="builtintype" id="5458381">error</span>&nbsp;<span class="op" id="5458387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5458390">return</span>&nbsp;<span class="ident" id="5458397">DefaultServer</span><span class="op" id="5458410">.</span><span class="ident" id="5458411">ServeRequest</span><span class="op" id="5458423">(</span><span class="ident" id="5458424">codec</span><span class="op" id="5458429">)</span><br>
<span class="lineno"></span><span class="op" id="5458431">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5458434">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5458500">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5458550">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5458619">func</span>&nbsp;<span class="ident" id="5458624">Accept</span><span class="op" id="5458630">(</span><span class="ident" id="5458631">lis</span>&nbsp;<span class="ident" id="5458635">net</span><span class="op" id="5458638">.</span><span class="ident" id="5458639">Listener</span><span class="op" id="5458647">)</span>&nbsp;<span class="op" id="5458649">{</span>&nbsp;<span class="ident" id="5458651">DefaultServer</span><span class="op" id="5458664">.</span><span class="ident" id="5458665">Accept</span><span class="op" id="5458671">(</span><span class="ident" id="5458672">lis</span><span class="op" id="5458675">)</span>&nbsp;<span class="op" id="5458677">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5458680">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5458741">var</span>&nbsp;<span class="ident" id="5458745">connected</span>&nbsp;<span class="op" id="5458755">=</span>&nbsp;<span class="string" id="5458757">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5458784">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5458851">func</span>&nbsp;<span class="op" id="5458856">(</span><span class="ident" id="5458857">server</span>&nbsp;<span class="op" id="5458864">*</span><span class="ident" id="5458865">Server</span><span class="op" id="5458871">)</span>&nbsp;<span class="ident" id="5458873">ServeHTTP</span><span class="op" id="5458882">(</span><span class="ident" id="5458883">w</span>&nbsp;<span class="ident" id="5458885">http</span><span class="op" id="5458889">.</span><span class="ident" id="5458890">ResponseWriter</span><span class="op" id="5458904">,</span>&nbsp;<span class="ident" id="5458906">req</span>&nbsp;<span class="op" id="5458910">*</span><span class="ident" id="5458911">http</span><span class="op" id="5458915">.</span><span class="ident" id="5458916">Request</span><span class="op" id="5458923">)</span>&nbsp;<span class="op" id="5458925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5458928">if</span>&nbsp;<span class="ident" id="5458931">req</span><span class="op" id="5458934">.</span><span class="ident" id="5458935">Method</span>&nbsp;<span class="op" id="5458942">!=</span>&nbsp;<span class="string" id="5458945">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5458955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5458959">w</span><span class="op" id="5458960">.</span><span class="ident" id="5458961">Header</span><span class="op" id="5458967">(</span><span class="op" id="5458968">)</span><span class="op" id="5458969">.</span><span class="ident" id="5458970">Set</span><span class="op" id="5458973">(</span><span class="string" id="5458974">&#34;Content-Type&#34;</span><span class="op" id="5458988">,</span>&nbsp;<span class="string" id="5458990">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5459017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459021">w</span><span class="op" id="5459022">.</span><span class="ident" id="5459023">WriteHeader</span><span class="op" id="5459034">(</span><span class="ident" id="5459035">http</span><span class="op" id="5459039">.</span><span class="ident" id="5459040">StatusMethodNotAllowed</span><span class="op" id="5459062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459066">io</span><span class="op" id="5459068">.</span><span class="ident" id="5459069">WriteString</span><span class="op" id="5459080">(</span><span class="ident" id="5459081">w</span><span class="op" id="5459082">,</span>&nbsp;<span class="string" id="5459084">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5459104">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5459108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5459116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459119">conn</span><span class="op" id="5459123">,</span>&nbsp;<span class="ident" id="5459125">_</span><span class="op" id="5459126">,</span>&nbsp;<span class="ident" id="5459128">err</span>&nbsp;<span class="op" id="5459132">:=</span>&nbsp;<span class="ident" id="5459135">w</span><span class="op" id="5459136">.</span><span class="op" id="5459137">(</span><span class="ident" id="5459138">http</span><span class="op" id="5459142">.</span><span class="ident" id="5459143">Hijacker</span><span class="op" id="5459151">)</span><span class="op" id="5459152">.</span><span class="ident" id="5459153">Hijack</span><span class="op" id="5459159">(</span><span class="op" id="5459160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5459163">if</span>&nbsp;<span class="ident" id="5459166">err</span>&nbsp;<span class="op" id="5459170">!=</span>&nbsp;<span class="builtintype" id="5459173">nil</span>&nbsp;<span class="op" id="5459177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459181">log</span><span class="op" id="5459184">.</span><span class="ident" id="5459185">Print</span><span class="op" id="5459190">(</span><span class="string" id="5459191">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5459207">,</span>&nbsp;<span class="ident" id="5459209">req</span><span class="op" id="5459212">.</span><span class="ident" id="5459213">RemoteAddr</span><span class="op" id="5459223">,</span>&nbsp;<span class="string" id="5459225">&#34;:&nbsp;&#34;</span><span class="op" id="5459229">,</span>&nbsp;<span class="ident" id="5459231">err</span><span class="op" id="5459234">.</span><span class="ident" id="5459235">Error</span><span class="op" id="5459240">(</span><span class="op" id="5459241">)</span><span class="op" id="5459242">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5459246">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5459254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459257">io</span><span class="op" id="5459259">.</span><span class="ident" id="5459260">WriteString</span><span class="op" id="5459271">(</span><span class="ident" id="5459272">conn</span><span class="op" id="5459276">,</span>&nbsp;<span class="string" id="5459278">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5459289">+</span><span class="ident" id="5459290">connected</span><span class="op" id="5459299">+</span><span class="string" id="5459300">&#34;\n\n&#34;</span><span class="op" id="5459306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459309">server</span><span class="op" id="5459315">.</span><span class="ident" id="5459316">ServeConn</span><span class="op" id="5459325">(</span><span class="ident" id="5459326">conn</span><span class="op" id="5459330">)</span><br>
<span class="lineno"></span><span class="op" id="5459332">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5459335">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5459404">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5459445">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5459523">func</span>&nbsp;<span class="op" id="5459528">(</span><span class="ident" id="5459529">server</span>&nbsp;<span class="op" id="5459536">*</span><span class="ident" id="5459537">Server</span><span class="op" id="5459543">)</span>&nbsp;<span class="ident" id="5459545">HandleHTTP</span><span class="op" id="5459555">(</span><span class="ident" id="5459556">rpcPath</span><span class="op" id="5459563">,</span>&nbsp;<span class="ident" id="5459565">debugPath</span>&nbsp;<span class="builtintype" id="5459575">string</span><span class="op" id="5459581">)</span>&nbsp;<span class="op" id="5459583">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459586">http</span><span class="op" id="5459590">.</span><span class="ident" id="5459591">Handle</span><span class="op" id="5459597">(</span><span class="ident" id="5459598">rpcPath</span><span class="op" id="5459605">,</span>&nbsp;<span class="ident" id="5459607">server</span><span class="op" id="5459613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459616">http</span><span class="op" id="5459620">.</span><span class="ident" id="5459621">Handle</span><span class="op" id="5459627">(</span><span class="ident" id="5459628">debugPath</span><span class="op" id="5459637">,</span>&nbsp;<span class="ident" id="5459639">debugHTTP</span><span class="op" id="5459648">{</span><span class="ident" id="5459649">server</span><span class="op" id="5459655">}</span><span class="op" id="5459656">)</span><br>
<span class="lineno"></span><span class="op" id="5459658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5459661">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5459735">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5459801">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5459879">func</span>&nbsp;<span class="ident" id="5459884">HandleHTTP</span><span class="op" id="5459894">(</span><span class="op" id="5459895">)</span>&nbsp;<span class="op" id="5459897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5459900">DefaultServer</span><span class="op" id="5459913">.</span><span class="ident" id="5459914">HandleHTTP</span><span class="op" id="5459924">(</span><span class="ident" id="5459925">DefaultRPCPath</span><span class="op" id="5459939">,</span>&nbsp;<span class="ident" id="5459941">DefaultDebugPath</span><span class="op" id="5459957">)</span><br>
<span class="lineno"></span><span class="op" id="5459959">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
