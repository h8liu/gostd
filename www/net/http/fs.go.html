<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3512417">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3512472">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3512526">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3512577">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512614">package</span>&nbsp;<span class="ident" id="3512622">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512628">import</span>&nbsp;<span class="op" id="3512635">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512638">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512648">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512655">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512661">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512669">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512687">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512704">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512715">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512721">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512729">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512746">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512757">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3512768">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3512775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3512778">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3512854">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="3512882">//</span><br>
<span class="lineno"></span><span class="comment" id="3512885">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3512963">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="3513043">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="3513098">//</span><br>
<span class="lineno"></span><span class="comment" id="3513101">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3513136">type</span>&nbsp;<span class="ident" id="3513141">Dir</span>&nbsp;<span class="builtintype" id="3513145">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="3513153">func</span>&nbsp;<span class="op" id="3513158">(</span><span class="ident" id="3513159">d</span>&nbsp;<span class="ident" id="3513161">Dir</span><span class="op" id="3513164">)</span>&nbsp;<span class="ident" id="3513166">Open</span><span class="op" id="3513170">(</span><span class="ident" id="3513171">name</span>&nbsp;<span class="builtintype" id="3513176">string</span><span class="op" id="3513182">)</span>&nbsp;<span class="op" id="3513184">(</span><span class="ident" id="3513185">File</span><span class="op" id="3513189">,</span>&nbsp;<span class="builtintype" id="3513191">error</span><span class="op" id="3513196">)</span>&nbsp;<span class="op" id="3513198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513201">if</span>&nbsp;<span class="ident" id="3513204">filepath</span><span class="op" id="3513212">.</span><span class="ident" id="3513213">Separator</span>&nbsp;<span class="op" id="3513223">!=</span>&nbsp;<span class="string" id="3513226">&#39;/&#39;</span>&nbsp;<span class="op" id="3513230">&amp;&amp;</span>&nbsp;<span class="ident" id="3513233">strings</span><span class="op" id="3513240">.</span><span class="ident" id="3513241">IndexRune</span><span class="op" id="3513250">(</span><span class="ident" id="3513251">name</span><span class="op" id="3513255">,</span>&nbsp;<span class="ident" id="3513257">filepath</span><span class="op" id="3513265">.</span><span class="ident" id="3513266">Separator</span><span class="op" id="3513275">)</span>&nbsp;<span class="op" id="3513277">&gt;=</span>&nbsp;<span class="num" id="3513280">0</span>&nbsp;<span class="op" id="3513282">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513287">strings</span><span class="op" id="3513294">.</span><span class="ident" id="3513295">Contains</span><span class="op" id="3513303">(</span><span class="ident" id="3513304">name</span><span class="op" id="3513308">,</span>&nbsp;<span class="string" id="3513310">&#34;\x00&#34;</span><span class="op" id="3513316">)</span>&nbsp;<span class="op" id="3513318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513322">return</span>&nbsp;<span class="ident" id="3513329">nil</span><span class="op" id="3513332">,</span>&nbsp;<span class="ident" id="3513334">errors</span><span class="op" id="3513340">.</span><span class="ident" id="3513341">New</span><span class="op" id="3513344">(</span><span class="string" id="3513345">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="3513383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513386">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513389">dir</span>&nbsp;<span class="op" id="3513393">:=</span>&nbsp;<span class="builtintype" id="3513396">string</span><span class="op" id="3513402">(</span><span class="ident" id="3513403">d</span><span class="op" id="3513404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513407">if</span>&nbsp;<span class="ident" id="3513410">dir</span>&nbsp;<span class="op" id="3513414">==</span>&nbsp;<span class="string" id="3513417">&#34;&#34;</span>&nbsp;<span class="op" id="3513420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513424">dir</span>&nbsp;<span class="op" id="3513428">=</span>&nbsp;<span class="string" id="3513430">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513438">f</span><span class="op" id="3513439">,</span>&nbsp;<span class="ident" id="3513441">err</span>&nbsp;<span class="op" id="3513445">:=</span>&nbsp;<span class="ident" id="3513448">os</span><span class="op" id="3513450">.</span><span class="ident" id="3513451">Open</span><span class="op" id="3513455">(</span><span class="ident" id="3513456">filepath</span><span class="op" id="3513464">.</span><span class="ident" id="3513465">Join</span><span class="op" id="3513469">(</span><span class="ident" id="3513470">dir</span><span class="op" id="3513473">,</span>&nbsp;<span class="ident" id="3513475">filepath</span><span class="op" id="3513483">.</span><span class="ident" id="3513484">FromSlash</span><span class="op" id="3513493">(</span><span class="ident" id="3513494">path</span><span class="op" id="3513498">.</span><span class="ident" id="3513499">Clean</span><span class="op" id="3513504">(</span><span class="string" id="3513505">&#34;/&#34;</span><span class="op" id="3513508">+</span><span class="ident" id="3513509">name</span><span class="op" id="3513513">)</span><span class="op" id="3513514">)</span><span class="op" id="3513515">)</span><span class="op" id="3513516">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513519">if</span>&nbsp;<span class="ident" id="3513522">err</span>&nbsp;<span class="op" id="3513526">!=</span>&nbsp;<span class="ident" id="3513529">nil</span>&nbsp;<span class="op" id="3513533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513537">return</span>&nbsp;<span class="ident" id="3513544">nil</span><span class="op" id="3513547">,</span>&nbsp;<span class="ident" id="3513549">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513557">return</span>&nbsp;<span class="ident" id="3513564">f</span><span class="op" id="3513565">,</span>&nbsp;<span class="ident" id="3513567">nil</span><br>
<span class="lineno"></span><span class="op" id="3513571">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3513574">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="3513640">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="3513708">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="3513771">type</span>&nbsp;<span class="ident" id="3513776">FileSystem</span>&nbsp;<span class="keyword" id="3513787">interface</span>&nbsp;<span class="op" id="3513797">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513800">Open</span><span class="op" id="3513804">(</span><span class="ident" id="3513805">name</span>&nbsp;<span class="builtintype" id="3513810">string</span><span class="op" id="3513816">)</span>&nbsp;<span class="op" id="3513818">(</span><span class="ident" id="3513819">File</span><span class="op" id="3513823">,</span>&nbsp;<span class="builtintype" id="3513825">error</span><span class="op" id="3513830">)</span><br>
<span class="lineno"></span><span class="op" id="3513832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3513835">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3513898">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="3513942">//</span><br>
<span class="lineno"></span><span class="comment" id="3513945">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="3514008">type</span>&nbsp;<span class="ident" id="3514013">File</span>&nbsp;<span class="keyword" id="3514018">interface</span>&nbsp;<span class="op" id="3514028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514031">io</span><span class="op" id="3514033">.</span><span class="ident" id="3514034">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514042">io</span><span class="op" id="3514044">.</span><span class="ident" id="3514045">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514053">Readdir</span><span class="op" id="3514060">(</span><span class="ident" id="3514061">count</span>&nbsp;<span class="builtintype" id="3514067">int</span><span class="op" id="3514070">)</span>&nbsp;<span class="op" id="3514072">(</span><span class="op" id="3514073">[</span><span class="op" id="3514074">]</span><span class="ident" id="3514075">os</span><span class="op" id="3514077">.</span><span class="ident" id="3514078">FileInfo</span><span class="op" id="3514086">,</span>&nbsp;<span class="builtintype" id="3514088">error</span><span class="op" id="3514093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514096">Seek</span><span class="op" id="3514100">(</span><span class="ident" id="3514101">offset</span>&nbsp;<span class="ident" id="3514108">int64</span><span class="op" id="3514113">,</span>&nbsp;<span class="ident" id="3514115">whence</span>&nbsp;<span class="builtintype" id="3514122">int</span><span class="op" id="3514125">)</span>&nbsp;<span class="op" id="3514127">(</span><span class="ident" id="3514128">int64</span><span class="op" id="3514133">,</span>&nbsp;<span class="builtintype" id="3514135">error</span><span class="op" id="3514140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514143">Stat</span><span class="op" id="3514147">(</span><span class="op" id="3514148">)</span>&nbsp;<span class="op" id="3514150">(</span><span class="ident" id="3514151">os</span><span class="op" id="3514153">.</span><span class="ident" id="3514154">FileInfo</span><span class="op" id="3514162">,</span>&nbsp;<span class="builtintype" id="3514164">error</span><span class="op" id="3514169">)</span><br>
<span class="lineno"></span><span class="op" id="3514171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3514174">func</span>&nbsp;<span class="ident" id="3514179">dirList</span><span class="op" id="3514186">(</span><span class="ident" id="3514187">w</span>&nbsp;<span class="ident" id="3514189">ResponseWriter</span><span class="op" id="3514203">,</span>&nbsp;<span class="ident" id="3514205">f</span>&nbsp;<span class="ident" id="3514207">File</span><span class="op" id="3514211">)</span>&nbsp;<span class="op" id="3514213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514216">w</span><span class="op" id="3514217">.</span><span class="ident" id="3514218">Header</span><span class="op" id="3514224">(</span><span class="op" id="3514225">)</span><span class="op" id="3514226">.</span><span class="ident" id="3514227">Set</span><span class="op" id="3514230">(</span><span class="string" id="3514231">&#34;Content-Type&#34;</span><span class="op" id="3514245">,</span>&nbsp;<span class="string" id="3514247">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="3514273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514276">fmt</span><span class="op" id="3514279">.</span><span class="ident" id="3514280">Fprintf</span><span class="op" id="3514287">(</span><span class="ident" id="3514288">w</span><span class="op" id="3514289">,</span>&nbsp;<span class="string" id="3514291">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="3514300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514303">for</span>&nbsp;<span class="op" id="3514307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514311">dirs</span><span class="op" id="3514315">,</span>&nbsp;<span class="ident" id="3514317">err</span>&nbsp;<span class="op" id="3514321">:=</span>&nbsp;<span class="ident" id="3514324">f</span><span class="op" id="3514325">.</span><span class="ident" id="3514326">Readdir</span><span class="op" id="3514333">(</span><span class="num" id="3514334">100</span><span class="op" id="3514337">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514341">if</span>&nbsp;<span class="ident" id="3514344">err</span>&nbsp;<span class="op" id="3514348">!=</span>&nbsp;<span class="ident" id="3514351">nil</span>&nbsp;<span class="op" id="3514355">||</span>&nbsp;<span class="builtinfunc" id="3514358">len</span><span class="op" id="3514361">(</span><span class="ident" id="3514362">dirs</span><span class="op" id="3514366">)</span>&nbsp;<span class="op" id="3514368">==</span>&nbsp;<span class="num" id="3514371">0</span>&nbsp;<span class="op" id="3514373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514378">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514390">for</span>&nbsp;<span class="ident" id="3514394">_</span><span class="op" id="3514395">,</span>&nbsp;<span class="ident" id="3514397">d</span>&nbsp;<span class="op" id="3514399">:=</span>&nbsp;<span class="keyword" id="3514402">range</span>&nbsp;<span class="ident" id="3514408">dirs</span>&nbsp;<span class="op" id="3514413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514418">name</span>&nbsp;<span class="op" id="3514423">:=</span>&nbsp;<span class="ident" id="3514426">d</span><span class="op" id="3514427">.</span><span class="ident" id="3514428">Name</span><span class="op" id="3514432">(</span><span class="op" id="3514433">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514438">if</span>&nbsp;<span class="ident" id="3514441">d</span><span class="op" id="3514442">.</span><span class="ident" id="3514443">IsDir</span><span class="op" id="3514448">(</span><span class="op" id="3514449">)</span>&nbsp;<span class="op" id="3514451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514457">name</span>&nbsp;<span class="op" id="3514462">+=</span>&nbsp;<span class="string" id="3514465">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514477">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514544">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514610">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514636">url</span>&nbsp;<span class="op" id="3514640">:=</span>&nbsp;<span class="ident" id="3514643">url</span><span class="op" id="3514646">.</span><span class="ident" id="3514647">URL</span><span class="op" id="3514650">{</span><span class="ident" id="3514651">Path</span><span class="op" id="3514655">:</span>&nbsp;<span class="ident" id="3514657">name</span><span class="op" id="3514661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514666">fmt</span><span class="op" id="3514669">.</span><span class="ident" id="3514670">Fprintf</span><span class="op" id="3514677">(</span><span class="ident" id="3514678">w</span><span class="op" id="3514679">,</span>&nbsp;<span class="string" id="3514681">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="3514706">,</span>&nbsp;<span class="ident" id="3514708">url</span><span class="op" id="3514711">.</span><span class="ident" id="3514712">String</span><span class="op" id="3514718">(</span><span class="op" id="3514719">)</span><span class="op" id="3514720">,</span>&nbsp;<span class="ident" id="3514722">htmlReplacer</span><span class="op" id="3514734">.</span><span class="ident" id="3514735">Replace</span><span class="op" id="3514742">(</span><span class="ident" id="3514743">name</span><span class="op" id="3514747">)</span><span class="op" id="3514748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514755">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514758">fmt</span><span class="op" id="3514761">.</span><span class="ident" id="3514762">Fprintf</span><span class="op" id="3514769">(</span><span class="ident" id="3514770">w</span><span class="op" id="3514771">,</span>&nbsp;<span class="string" id="3514773">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="3514783">)</span><br>
<span class="lineno"></span><span class="op" id="3514785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3514788">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3514852">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="3514923">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3514994">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="3515033">//</span><br>
<span class="lineno"></span><span class="comment" id="3515036">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="3515102">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="3515168">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3515239">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="3515279">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3515349">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3515380">//</span><br>
<span class="lineno">105</span><span class="comment" id="3515383">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3515449">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3515518">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="3515583">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="3515631">//</span><br>
<span class="lineno">110</span><span class="comment" id="3515634">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="3515692">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="3515751">//</span><br>
<span class="lineno"></span><span class="comment" id="3515754">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3515820">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="3515873">//</span><br>
<span class="lineno"></span><span class="comment" id="3515876">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3515938">func</span>&nbsp;<span class="ident" id="3515943">ServeContent</span><span class="op" id="3515955">(</span><span class="ident" id="3515956">w</span>&nbsp;<span class="ident" id="3515958">ResponseWriter</span><span class="op" id="3515972">,</span>&nbsp;<span class="ident" id="3515974">req</span>&nbsp;<span class="op" id="3515978">*</span><span class="ident" id="3515979">Request</span><span class="op" id="3515986">,</span>&nbsp;<span class="ident" id="3515988">name</span>&nbsp;<span class="builtintype" id="3515993">string</span><span class="op" id="3515999">,</span>&nbsp;<span class="ident" id="3516001">modtime</span>&nbsp;<span class="ident" id="3516009">time</span><span class="op" id="3516013">.</span><span class="ident" id="3516014">Time</span><span class="op" id="3516018">,</span>&nbsp;<span class="ident" id="3516020">content</span>&nbsp;<span class="ident" id="3516028">io</span><span class="op" id="3516030">.</span><span class="ident" id="3516031">ReadSeeker</span><span class="op" id="3516041">)</span>&nbsp;<span class="op" id="3516043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516046">sizeFunc</span>&nbsp;<span class="op" id="3516055">:=</span>&nbsp;<span class="keyword" id="3516058">func</span><span class="op" id="3516062">(</span><span class="op" id="3516063">)</span>&nbsp;<span class="op" id="3516065">(</span><span class="ident" id="3516066">int64</span><span class="op" id="3516071">,</span>&nbsp;<span class="builtintype" id="3516073">error</span><span class="op" id="3516078">)</span>&nbsp;<span class="op" id="3516080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516084">size</span><span class="op" id="3516088">,</span>&nbsp;<span class="ident" id="3516090">err</span>&nbsp;<span class="op" id="3516094">:=</span>&nbsp;<span class="ident" id="3516097">content</span><span class="op" id="3516104">.</span><span class="ident" id="3516105">Seek</span><span class="op" id="3516109">(</span><span class="num" id="3516110">0</span><span class="op" id="3516111">,</span>&nbsp;<span class="ident" id="3516113">os</span><span class="op" id="3516115">.</span><span class="ident" id="3516116">SEEK_END</span><span class="op" id="3516124">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516128">if</span>&nbsp;<span class="ident" id="3516131">err</span>&nbsp;<span class="op" id="3516135">!=</span>&nbsp;<span class="ident" id="3516138">nil</span>&nbsp;<span class="op" id="3516142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516147">return</span>&nbsp;<span class="num" id="3516154">0</span><span class="op" id="3516155">,</span>&nbsp;<span class="ident" id="3516157">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516173">_</span><span class="op" id="3516174">,</span>&nbsp;<span class="ident" id="3516176">err</span>&nbsp;<span class="op" id="3516180">=</span>&nbsp;<span class="ident" id="3516182">content</span><span class="op" id="3516189">.</span><span class="ident" id="3516190">Seek</span><span class="op" id="3516194">(</span><span class="num" id="3516195">0</span><span class="op" id="3516196">,</span>&nbsp;<span class="ident" id="3516198">os</span><span class="op" id="3516200">.</span><span class="ident" id="3516201">SEEK_SET</span><span class="op" id="3516209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516213">if</span>&nbsp;<span class="ident" id="3516216">err</span>&nbsp;<span class="op" id="3516220">!=</span>&nbsp;<span class="ident" id="3516223">nil</span>&nbsp;<span class="op" id="3516227">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516232">return</span>&nbsp;<span class="num" id="3516239">0</span><span class="op" id="3516240">,</span>&nbsp;<span class="ident" id="3516242">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516258">return</span>&nbsp;<span class="ident" id="3516265">size</span><span class="op" id="3516269">,</span>&nbsp;<span class="ident" id="3516271">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516279">serveContent</span><span class="op" id="3516291">(</span><span class="ident" id="3516292">w</span><span class="op" id="3516293">,</span>&nbsp;<span class="ident" id="3516295">req</span><span class="op" id="3516298">,</span>&nbsp;<span class="ident" id="3516300">name</span><span class="op" id="3516304">,</span>&nbsp;<span class="ident" id="3516306">modtime</span><span class="op" id="3516313">,</span>&nbsp;<span class="ident" id="3516315">sizeFunc</span><span class="op" id="3516323">,</span>&nbsp;<span class="ident" id="3516325">content</span><span class="op" id="3516332">)</span><br>
<span class="lineno">130</span><span class="op" id="3516334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516337">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3516406">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3516473">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="3516541">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="3516551">var</span>&nbsp;<span class="ident" id="3516555">errSeeker</span>&nbsp;<span class="op" id="3516565">=</span>&nbsp;<span class="ident" id="3516567">errors</span><span class="op" id="3516573">.</span><span class="ident" id="3516574">New</span><span class="op" id="3516577">(</span><span class="string" id="3516578">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3516597">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3516600">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="3516680">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="3516724">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3516780">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3516869">func</span>&nbsp;<span class="ident" id="3516874">serveContent</span><span class="op" id="3516886">(</span><span class="ident" id="3516887">w</span>&nbsp;<span class="ident" id="3516889">ResponseWriter</span><span class="op" id="3516903">,</span>&nbsp;<span class="ident" id="3516905">r</span>&nbsp;<span class="op" id="3516907">*</span><span class="ident" id="3516908">Request</span><span class="op" id="3516915">,</span>&nbsp;<span class="ident" id="3516917">name</span>&nbsp;<span class="builtintype" id="3516922">string</span><span class="op" id="3516928">,</span>&nbsp;<span class="ident" id="3516930">modtime</span>&nbsp;<span class="ident" id="3516938">time</span><span class="op" id="3516942">.</span><span class="ident" id="3516943">Time</span><span class="op" id="3516947">,</span>&nbsp;<span class="ident" id="3516949">sizeFunc</span>&nbsp;<span class="keyword" id="3516958">func</span><span class="op" id="3516962">(</span><span class="op" id="3516963">)</span>&nbsp;<span class="op" id="3516965">(</span><span class="ident" id="3516966">int64</span><span class="op" id="3516971">,</span>&nbsp;<span class="builtintype" id="3516973">error</span><span class="op" id="3516978">)</span><span class="op" id="3516979">,</span>&nbsp;<span class="ident" id="3516981">content</span>&nbsp;<span class="ident" id="3516989">io</span><span class="op" id="3516991">.</span><span class="ident" id="3516992">ReadSeeker</span><span class="op" id="3517002">)</span>&nbsp;<span class="op" id="3517004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517007">if</span>&nbsp;<span class="ident" id="3517010">checkLastModified</span><span class="op" id="3517027">(</span><span class="ident" id="3517028">w</span><span class="op" id="3517029">,</span>&nbsp;<span class="ident" id="3517031">r</span><span class="op" id="3517032">,</span>&nbsp;<span class="ident" id="3517034">modtime</span><span class="op" id="3517041">)</span>&nbsp;<span class="op" id="3517043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517047">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517058">rangeReq</span><span class="op" id="3517066">,</span>&nbsp;<span class="ident" id="3517068">done</span>&nbsp;<span class="op" id="3517073">:=</span>&nbsp;<span class="ident" id="3517076">checkETag</span><span class="op" id="3517085">(</span><span class="ident" id="3517086">w</span><span class="op" id="3517087">,</span>&nbsp;<span class="ident" id="3517089">r</span><span class="op" id="3517090">,</span>&nbsp;<span class="ident" id="3517092">modtime</span><span class="op" id="3517099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517102">if</span>&nbsp;<span class="ident" id="3517105">done</span>&nbsp;<span class="op" id="3517110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517122">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517126">code</span>&nbsp;<span class="op" id="3517131">:=</span>&nbsp;<span class="ident" id="3517134">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517145">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517217">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517285">ctypes</span><span class="op" id="3517291">,</span>&nbsp;<span class="ident" id="3517293">haveType</span>&nbsp;<span class="op" id="3517302">:=</span>&nbsp;<span class="ident" id="3517305">w</span><span class="op" id="3517306">.</span><span class="ident" id="3517307">Header</span><span class="op" id="3517313">(</span><span class="op" id="3517314">)</span><span class="op" id="3517315">[</span><span class="string" id="3517316">&#34;Content-Type&#34;</span><span class="op" id="3517330">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517333">var</span>&nbsp;<span class="ident" id="3517337">ctype</span>&nbsp;<span class="builtintype" id="3517343">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517351">if</span>&nbsp;<span class="op" id="3517354">!</span><span class="ident" id="3517355">haveType</span>&nbsp;<span class="op" id="3517364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517368">ctype</span>&nbsp;<span class="op" id="3517374">=</span>&nbsp;<span class="ident" id="3517376">mime</span><span class="op" id="3517380">.</span><span class="ident" id="3517381">TypeByExtension</span><span class="op" id="3517396">(</span><span class="ident" id="3517397">filepath</span><span class="op" id="3517405">.</span><span class="ident" id="3517406">Ext</span><span class="op" id="3517409">(</span><span class="ident" id="3517410">name</span><span class="op" id="3517414">)</span><span class="op" id="3517415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517419">if</span>&nbsp;<span class="ident" id="3517422">ctype</span>&nbsp;<span class="op" id="3517428">==</span>&nbsp;<span class="string" id="3517431">&#34;&#34;</span>&nbsp;<span class="op" id="3517434">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517439">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517498">var</span>&nbsp;<span class="ident" id="3517502">buf</span>&nbsp;<span class="op" id="3517506">[</span><span class="ident" id="3517507">sniffLen</span><span class="op" id="3517515">]</span><span class="builtintype" id="3517516">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517524">n</span><span class="op" id="3517525">,</span>&nbsp;<span class="ident" id="3517527">_</span>&nbsp;<span class="op" id="3517529">:=</span>&nbsp;<span class="ident" id="3517532">io</span><span class="op" id="3517534">.</span><span class="ident" id="3517535">ReadFull</span><span class="op" id="3517543">(</span><span class="ident" id="3517544">content</span><span class="op" id="3517551">,</span>&nbsp;<span class="ident" id="3517553">buf</span><span class="op" id="3517556">[</span><span class="op" id="3517557">:</span><span class="op" id="3517558">]</span><span class="op" id="3517559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517564">ctype</span>&nbsp;<span class="op" id="3517570">=</span>&nbsp;<span class="ident" id="3517572">DetectContentType</span><span class="op" id="3517589">(</span><span class="ident" id="3517590">buf</span><span class="op" id="3517593">[</span><span class="op" id="3517594">:</span><span class="ident" id="3517595">n</span><span class="op" id="3517596">]</span><span class="op" id="3517597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517602">_</span><span class="op" id="3517603">,</span>&nbsp;<span class="ident" id="3517605">err</span>&nbsp;<span class="op" id="3517609">:=</span>&nbsp;<span class="ident" id="3517612">content</span><span class="op" id="3517619">.</span><span class="ident" id="3517620">Seek</span><span class="op" id="3517624">(</span><span class="num" id="3517625">0</span><span class="op" id="3517626">,</span>&nbsp;<span class="ident" id="3517628">os</span><span class="op" id="3517630">.</span><span class="ident" id="3517631">SEEK_SET</span><span class="op" id="3517639">)</span>&nbsp;<span class="comment" id="3517641">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517675">if</span>&nbsp;<span class="ident" id="3517678">err</span>&nbsp;<span class="op" id="3517682">!=</span>&nbsp;<span class="ident" id="3517685">nil</span>&nbsp;<span class="op" id="3517689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517695">Error</span><span class="op" id="3517700">(</span><span class="ident" id="3517701">w</span><span class="op" id="3517702">,</span>&nbsp;<span class="string" id="3517704">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3517723">,</span>&nbsp;<span class="ident" id="3517725">StatusInternalServerError</span><span class="op" id="3517750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517756">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517770">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517774">w</span><span class="op" id="3517775">.</span><span class="ident" id="3517776">Header</span><span class="op" id="3517782">(</span><span class="op" id="3517783">)</span><span class="op" id="3517784">.</span><span class="ident" id="3517785">Set</span><span class="op" id="3517788">(</span><span class="string" id="3517789">&#34;Content-Type&#34;</span><span class="op" id="3517803">,</span>&nbsp;<span class="ident" id="3517805">ctype</span><span class="op" id="3517810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517813">}</span>&nbsp;<span class="keyword" id="3517815">else</span>&nbsp;<span class="keyword" id="3517820">if</span>&nbsp;<span class="builtinfunc" id="3517823">len</span><span class="op" id="3517826">(</span><span class="ident" id="3517827">ctypes</span><span class="op" id="3517833">)</span>&nbsp;<span class="op" id="3517835">&gt;</span>&nbsp;<span class="num" id="3517837">0</span>&nbsp;<span class="op" id="3517839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517843">ctype</span>&nbsp;<span class="op" id="3517849">=</span>&nbsp;<span class="ident" id="3517851">ctypes</span><span class="op" id="3517857">[</span><span class="num" id="3517858">0</span><span class="op" id="3517859">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517866">size</span><span class="op" id="3517870">,</span>&nbsp;<span class="ident" id="3517872">err</span>&nbsp;<span class="op" id="3517876">:=</span>&nbsp;<span class="ident" id="3517879">sizeFunc</span><span class="op" id="3517887">(</span><span class="op" id="3517888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517891">if</span>&nbsp;<span class="ident" id="3517894">err</span>&nbsp;<span class="op" id="3517898">!=</span>&nbsp;<span class="ident" id="3517901">nil</span>&nbsp;<span class="op" id="3517905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517909">Error</span><span class="op" id="3517914">(</span><span class="ident" id="3517915">w</span><span class="op" id="3517916">,</span>&nbsp;<span class="ident" id="3517918">err</span><span class="op" id="3517921">.</span><span class="ident" id="3517922">Error</span><span class="op" id="3517927">(</span><span class="op" id="3517928">)</span><span class="op" id="3517929">,</span>&nbsp;<span class="ident" id="3517931">StatusInternalServerError</span><span class="op" id="3517956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517960">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517968">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517972">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518005">sendSize</span>&nbsp;<span class="op" id="3518014">:=</span>&nbsp;<span class="ident" id="3518017">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518023">var</span>&nbsp;<span class="ident" id="3518027">sendContent</span>&nbsp;<span class="ident" id="3518039">io</span><span class="op" id="3518041">.</span><span class="ident" id="3518042">Reader</span>&nbsp;<span class="op" id="3518049">=</span>&nbsp;<span class="ident" id="3518051">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518060">if</span>&nbsp;<span class="ident" id="3518063">size</span>&nbsp;<span class="op" id="3518068">&gt;=</span>&nbsp;<span class="num" id="3518071">0</span>&nbsp;<span class="op" id="3518073">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518077">ranges</span><span class="op" id="3518083">,</span>&nbsp;<span class="ident" id="3518085">err</span>&nbsp;<span class="op" id="3518089">:=</span>&nbsp;<span class="ident" id="3518092">parseRange</span><span class="op" id="3518102">(</span><span class="ident" id="3518103">rangeReq</span><span class="op" id="3518111">,</span>&nbsp;<span class="ident" id="3518113">size</span><span class="op" id="3518117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518121">if</span>&nbsp;<span class="ident" id="3518124">err</span>&nbsp;<span class="op" id="3518128">!=</span>&nbsp;<span class="ident" id="3518131">nil</span>&nbsp;<span class="op" id="3518135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518140">Error</span><span class="op" id="3518145">(</span><span class="ident" id="3518146">w</span><span class="op" id="3518147">,</span>&nbsp;<span class="ident" id="3518149">err</span><span class="op" id="3518152">.</span><span class="ident" id="3518153">Error</span><span class="op" id="3518158">(</span><span class="op" id="3518159">)</span><span class="op" id="3518160">,</span>&nbsp;<span class="ident" id="3518162">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3518196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518201">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518210">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518214">if</span>&nbsp;<span class="ident" id="3518217">sumRangesSize</span><span class="op" id="3518230">(</span><span class="ident" id="3518231">ranges</span><span class="op" id="3518237">)</span>&nbsp;<span class="op" id="3518239">&gt;</span>&nbsp;<span class="ident" id="3518241">size</span>&nbsp;<span class="op" id="3518246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518251">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518301">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518346">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518396">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518442">ranges</span>&nbsp;<span class="op" id="3518449">=</span>&nbsp;<span class="ident" id="3518451">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518461">switch</span>&nbsp;<span class="op" id="3518468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518472">case</span>&nbsp;<span class="builtinfunc" id="3518477">len</span><span class="op" id="3518480">(</span><span class="ident" id="3518481">ranges</span><span class="op" id="3518487">)</span>&nbsp;<span class="op" id="3518489">==</span>&nbsp;<span class="num" id="3518492">1</span><span class="op" id="3518493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518498">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518529">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518590">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518646">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518702">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518757">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518810">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518866">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518894">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518904">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518962">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519020">ra</span>&nbsp;<span class="op" id="3519023">:=</span>&nbsp;<span class="ident" id="3519026">ranges</span><span class="op" id="3519032">[</span><span class="num" id="3519033">0</span><span class="op" id="3519034">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519039">if</span>&nbsp;<span class="ident" id="3519042">_</span><span class="op" id="3519043">,</span>&nbsp;<span class="ident" id="3519045">err</span>&nbsp;<span class="op" id="3519049">:=</span>&nbsp;<span class="ident" id="3519052">content</span><span class="op" id="3519059">.</span><span class="ident" id="3519060">Seek</span><span class="op" id="3519064">(</span><span class="ident" id="3519065">ra</span><span class="op" id="3519067">.</span><span class="ident" id="3519068">start</span><span class="op" id="3519073">,</span>&nbsp;<span class="ident" id="3519075">os</span><span class="op" id="3519077">.</span><span class="ident" id="3519078">SEEK_SET</span><span class="op" id="3519086">)</span><span class="op" id="3519087">;</span>&nbsp;<span class="ident" id="3519089">err</span>&nbsp;<span class="op" id="3519093">!=</span>&nbsp;<span class="ident" id="3519096">nil</span>&nbsp;<span class="op" id="3519100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519106">Error</span><span class="op" id="3519111">(</span><span class="ident" id="3519112">w</span><span class="op" id="3519113">,</span>&nbsp;<span class="ident" id="3519115">err</span><span class="op" id="3519118">.</span><span class="ident" id="3519119">Error</span><span class="op" id="3519124">(</span><span class="op" id="3519125">)</span><span class="op" id="3519126">,</span>&nbsp;<span class="ident" id="3519128">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3519162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519168">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519178">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519183">sendSize</span>&nbsp;<span class="op" id="3519192">=</span>&nbsp;<span class="ident" id="3519194">ra</span><span class="op" id="3519196">.</span><span class="ident" id="3519197">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519207">code</span>&nbsp;<span class="op" id="3519212">=</span>&nbsp;<span class="ident" id="3519214">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519238">w</span><span class="op" id="3519239">.</span><span class="ident" id="3519240">Header</span><span class="op" id="3519246">(</span><span class="op" id="3519247">)</span><span class="op" id="3519248">.</span><span class="ident" id="3519249">Set</span><span class="op" id="3519252">(</span><span class="string" id="3519253">&#34;Content-Range&#34;</span><span class="op" id="3519268">,</span>&nbsp;<span class="ident" id="3519270">ra</span><span class="op" id="3519272">.</span><span class="ident" id="3519273">contentRange</span><span class="op" id="3519285">(</span><span class="ident" id="3519286">size</span><span class="op" id="3519290">)</span><span class="op" id="3519291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519295">case</span>&nbsp;<span class="builtinfunc" id="3519300">len</span><span class="op" id="3519303">(</span><span class="ident" id="3519304">ranges</span><span class="op" id="3519310">)</span>&nbsp;<span class="op" id="3519312">&gt;</span>&nbsp;<span class="num" id="3519314">1</span><span class="op" id="3519315">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519320">sendSize</span>&nbsp;<span class="op" id="3519329">=</span>&nbsp;<span class="ident" id="3519331">rangesMIMESize</span><span class="op" id="3519345">(</span><span class="ident" id="3519346">ranges</span><span class="op" id="3519352">,</span>&nbsp;<span class="ident" id="3519354">ctype</span><span class="op" id="3519359">,</span>&nbsp;<span class="ident" id="3519361">size</span><span class="op" id="3519365">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519370">code</span>&nbsp;<span class="op" id="3519375">=</span>&nbsp;<span class="ident" id="3519377">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519402">pr</span><span class="op" id="3519404">,</span>&nbsp;<span class="ident" id="3519406">pw</span>&nbsp;<span class="op" id="3519409">:=</span>&nbsp;<span class="ident" id="3519412">io</span><span class="op" id="3519414">.</span><span class="ident" id="3519415">Pipe</span><span class="op" id="3519419">(</span><span class="op" id="3519420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519425">mw</span>&nbsp;<span class="op" id="3519428">:=</span>&nbsp;<span class="ident" id="3519431">multipart</span><span class="op" id="3519440">.</span><span class="ident" id="3519441">NewWriter</span><span class="op" id="3519450">(</span><span class="ident" id="3519451">pw</span><span class="op" id="3519453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519458">w</span><span class="op" id="3519459">.</span><span class="ident" id="3519460">Header</span><span class="op" id="3519466">(</span><span class="op" id="3519467">)</span><span class="op" id="3519468">.</span><span class="ident" id="3519469">Set</span><span class="op" id="3519472">(</span><span class="string" id="3519473">&#34;Content-Type&#34;</span><span class="op" id="3519487">,</span>&nbsp;<span class="string" id="3519489">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3519522">+</span><span class="ident" id="3519523">mw</span><span class="op" id="3519525">.</span><span class="ident" id="3519526">Boundary</span><span class="op" id="3519534">(</span><span class="op" id="3519535">)</span><span class="op" id="3519536">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519541">sendContent</span>&nbsp;<span class="op" id="3519553">=</span>&nbsp;<span class="ident" id="3519555">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519561">defer</span>&nbsp;<span class="ident" id="3519567">pr</span><span class="op" id="3519569">.</span><span class="ident" id="3519570">Close</span><span class="op" id="3519575">(</span><span class="op" id="3519576">)</span>&nbsp;<span class="comment" id="3519578">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519650">go</span>&nbsp;<span class="keyword" id="3519653">func</span><span class="op" id="3519657">(</span><span class="op" id="3519658">)</span>&nbsp;<span class="op" id="3519660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519666">for</span>&nbsp;<span class="ident" id="3519670">_</span><span class="op" id="3519671">,</span>&nbsp;<span class="ident" id="3519673">ra</span>&nbsp;<span class="op" id="3519676">:=</span>&nbsp;<span class="keyword" id="3519679">range</span>&nbsp;<span class="ident" id="3519685">ranges</span>&nbsp;<span class="op" id="3519692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519699">part</span><span class="op" id="3519703">,</span>&nbsp;<span class="ident" id="3519705">err</span>&nbsp;<span class="op" id="3519709">:=</span>&nbsp;<span class="ident" id="3519712">mw</span><span class="op" id="3519714">.</span><span class="ident" id="3519715">CreatePart</span><span class="op" id="3519725">(</span><span class="ident" id="3519726">ra</span><span class="op" id="3519728">.</span><span class="ident" id="3519729">mimeHeader</span><span class="op" id="3519739">(</span><span class="ident" id="3519740">ctype</span><span class="op" id="3519745">,</span>&nbsp;<span class="ident" id="3519747">size</span><span class="op" id="3519751">)</span><span class="op" id="3519752">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519759">if</span>&nbsp;<span class="ident" id="3519762">err</span>&nbsp;<span class="op" id="3519766">!=</span>&nbsp;<span class="ident" id="3519769">nil</span>&nbsp;<span class="op" id="3519773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519781">pw</span><span class="op" id="3519783">.</span><span class="ident" id="3519784">CloseWithError</span><span class="op" id="3519798">(</span><span class="ident" id="3519799">err</span><span class="op" id="3519802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519829">if</span>&nbsp;<span class="ident" id="3519832">_</span><span class="op" id="3519833">,</span>&nbsp;<span class="ident" id="3519835">err</span>&nbsp;<span class="op" id="3519839">:=</span>&nbsp;<span class="ident" id="3519842">content</span><span class="op" id="3519849">.</span><span class="ident" id="3519850">Seek</span><span class="op" id="3519854">(</span><span class="ident" id="3519855">ra</span><span class="op" id="3519857">.</span><span class="ident" id="3519858">start</span><span class="op" id="3519863">,</span>&nbsp;<span class="ident" id="3519865">os</span><span class="op" id="3519867">.</span><span class="ident" id="3519868">SEEK_SET</span><span class="op" id="3519876">)</span><span class="op" id="3519877">;</span>&nbsp;<span class="ident" id="3519879">err</span>&nbsp;<span class="op" id="3519883">!=</span>&nbsp;<span class="ident" id="3519886">nil</span>&nbsp;<span class="op" id="3519890">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519898">pw</span><span class="op" id="3519900">.</span><span class="ident" id="3519901">CloseWithError</span><span class="op" id="3519915">(</span><span class="ident" id="3519916">err</span><span class="op" id="3519919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519927">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519946">if</span>&nbsp;<span class="ident" id="3519949">_</span><span class="op" id="3519950">,</span>&nbsp;<span class="ident" id="3519952">err</span>&nbsp;<span class="op" id="3519956">:=</span>&nbsp;<span class="ident" id="3519959">io</span><span class="op" id="3519961">.</span><span class="ident" id="3519962">CopyN</span><span class="op" id="3519967">(</span><span class="ident" id="3519968">part</span><span class="op" id="3519972">,</span>&nbsp;<span class="ident" id="3519974">content</span><span class="op" id="3519981">,</span>&nbsp;<span class="ident" id="3519983">ra</span><span class="op" id="3519985">.</span><span class="ident" id="3519986">length</span><span class="op" id="3519992">)</span><span class="op" id="3519993">;</span>&nbsp;<span class="ident" id="3519995">err</span>&nbsp;<span class="op" id="3519999">!=</span>&nbsp;<span class="ident" id="3520002">nil</span>&nbsp;<span class="op" id="3520006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520014">pw</span><span class="op" id="3520016">.</span><span class="ident" id="3520017">CloseWithError</span><span class="op" id="3520031">(</span><span class="ident" id="3520032">err</span><span class="op" id="3520035">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520043">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520067">mw</span><span class="op" id="3520069">.</span><span class="ident" id="3520070">Close</span><span class="op" id="3520075">(</span><span class="op" id="3520076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520082">pw</span><span class="op" id="3520084">.</span><span class="ident" id="3520085">Close</span><span class="op" id="3520090">(</span><span class="op" id="3520091">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520096">}</span><span class="op" id="3520097">(</span><span class="op" id="3520098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520107">w</span><span class="op" id="3520108">.</span><span class="ident" id="3520109">Header</span><span class="op" id="3520115">(</span><span class="op" id="3520116">)</span><span class="op" id="3520117">.</span><span class="ident" id="3520118">Set</span><span class="op" id="3520121">(</span><span class="string" id="3520122">&#34;Accept-Ranges&#34;</span><span class="op" id="3520137">,</span>&nbsp;<span class="string" id="3520139">&#34;bytes&#34;</span><span class="op" id="3520146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520150">if</span>&nbsp;<span class="ident" id="3520153">w</span><span class="op" id="3520154">.</span><span class="ident" id="3520155">Header</span><span class="op" id="3520161">(</span><span class="op" id="3520162">)</span><span class="op" id="3520163">.</span><span class="ident" id="3520164">Get</span><span class="op" id="3520167">(</span><span class="string" id="3520168">&#34;Content-Encoding&#34;</span><span class="op" id="3520186">)</span>&nbsp;<span class="op" id="3520188">==</span>&nbsp;<span class="string" id="3520191">&#34;&#34;</span>&nbsp;<span class="op" id="3520194">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520199">w</span><span class="op" id="3520200">.</span><span class="ident" id="3520201">Header</span><span class="op" id="3520207">(</span><span class="op" id="3520208">)</span><span class="op" id="3520209">.</span><span class="ident" id="3520210">Set</span><span class="op" id="3520213">(</span><span class="string" id="3520214">&#34;Content-Length&#34;</span><span class="op" id="3520230">,</span>&nbsp;<span class="ident" id="3520232">strconv</span><span class="op" id="3520239">.</span><span class="ident" id="3520240">FormatInt</span><span class="op" id="3520249">(</span><span class="ident" id="3520250">sendSize</span><span class="op" id="3520258">,</span>&nbsp;<span class="num" id="3520260">10</span><span class="op" id="3520262">)</span><span class="op" id="3520263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520274">w</span><span class="op" id="3520275">.</span><span class="ident" id="3520276">WriteHeader</span><span class="op" id="3520287">(</span><span class="ident" id="3520288">code</span><span class="op" id="3520292">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520296">if</span>&nbsp;<span class="ident" id="3520299">r</span><span class="op" id="3520300">.</span><span class="ident" id="3520301">Method</span>&nbsp;<span class="op" id="3520308">!=</span>&nbsp;<span class="string" id="3520311">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3520318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520322">io</span><span class="op" id="3520324">.</span><span class="ident" id="3520325">CopyN</span><span class="op" id="3520330">(</span><span class="ident" id="3520331">w</span><span class="op" id="3520332">,</span>&nbsp;<span class="ident" id="3520334">sendContent</span><span class="op" id="3520345">,</span>&nbsp;<span class="ident" id="3520347">sendSize</span><span class="op" id="3520355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520358">}</span><br>
<span class="lineno"></span><span class="op" id="3520360">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3520363">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3520442">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3520499">func</span>&nbsp;<span class="ident" id="3520504">checkLastModified</span><span class="op" id="3520521">(</span><span class="ident" id="3520522">w</span>&nbsp;<span class="ident" id="3520524">ResponseWriter</span><span class="op" id="3520538">,</span>&nbsp;<span class="ident" id="3520540">r</span>&nbsp;<span class="op" id="3520542">*</span><span class="ident" id="3520543">Request</span><span class="op" id="3520550">,</span>&nbsp;<span class="ident" id="3520552">modtime</span>&nbsp;<span class="ident" id="3520560">time</span><span class="op" id="3520564">.</span><span class="ident" id="3520565">Time</span><span class="op" id="3520569">)</span>&nbsp;<span class="builtintype" id="3520571">bool</span>&nbsp;<span class="op" id="3520576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520579">if</span>&nbsp;<span class="ident" id="3520582">modtime</span><span class="op" id="3520589">.</span><span class="ident" id="3520590">IsZero</span><span class="op" id="3520596">(</span><span class="op" id="3520597">)</span>&nbsp;<span class="op" id="3520599">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520603">return</span>&nbsp;<span class="ident" id="3520610">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520621">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520685">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520753">if</span>&nbsp;<span class="ident" id="3520756">t</span><span class="op" id="3520757">,</span>&nbsp;<span class="ident" id="3520759">err</span>&nbsp;<span class="op" id="3520763">:=</span>&nbsp;<span class="ident" id="3520766">time</span><span class="op" id="3520770">.</span><span class="ident" id="3520771">Parse</span><span class="op" id="3520776">(</span><span class="ident" id="3520777">TimeFormat</span><span class="op" id="3520787">,</span>&nbsp;<span class="ident" id="3520789">r</span><span class="op" id="3520790">.</span><span class="ident" id="3520791">Header</span><span class="op" id="3520797">.</span><span class="ident" id="3520798">Get</span><span class="op" id="3520801">(</span><span class="string" id="3520802">&#34;If-Modified-Since&#34;</span><span class="op" id="3520821">)</span><span class="op" id="3520822">)</span><span class="op" id="3520823">;</span>&nbsp;<span class="ident" id="3520825">err</span>&nbsp;<span class="op" id="3520829">==</span>&nbsp;<span class="ident" id="3520832">nil</span>&nbsp;<span class="op" id="3520836">&amp;&amp;</span>&nbsp;<span class="ident" id="3520839">modtime</span><span class="op" id="3520846">.</span><span class="ident" id="3520847">Before</span><span class="op" id="3520853">(</span><span class="ident" id="3520854">t</span><span class="op" id="3520855">.</span><span class="ident" id="3520856">Add</span><span class="op" id="3520859">(</span><span class="num" id="3520860">1</span><span class="op" id="3520861">*</span><span class="ident" id="3520862">time</span><span class="op" id="3520866">.</span><span class="ident" id="3520867">Second</span><span class="op" id="3520873">)</span><span class="op" id="3520874">)</span>&nbsp;<span class="op" id="3520876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520880">h</span>&nbsp;<span class="op" id="3520882">:=</span>&nbsp;<span class="ident" id="3520885">w</span><span class="op" id="3520886">.</span><span class="ident" id="3520887">Header</span><span class="op" id="3520893">(</span><span class="op" id="3520894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3520898">delete</span><span class="op" id="3520904">(</span><span class="ident" id="3520905">h</span><span class="op" id="3520906">,</span>&nbsp;<span class="string" id="3520908">&#34;Content-Type&#34;</span><span class="op" id="3520922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3520926">delete</span><span class="op" id="3520932">(</span><span class="ident" id="3520933">h</span><span class="op" id="3520934">,</span>&nbsp;<span class="string" id="3520936">&#34;Content-Length&#34;</span><span class="op" id="3520952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520956">w</span><span class="op" id="3520957">.</span><span class="ident" id="3520958">WriteHeader</span><span class="op" id="3520969">(</span><span class="ident" id="3520970">StatusNotModified</span><span class="op" id="3520987">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520991">return</span>&nbsp;<span class="ident" id="3520998">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521007">w</span><span class="op" id="3521008">.</span><span class="ident" id="3521009">Header</span><span class="op" id="3521015">(</span><span class="op" id="3521016">)</span><span class="op" id="3521017">.</span><span class="ident" id="3521018">Set</span><span class="op" id="3521021">(</span><span class="string" id="3521022">&#34;Last-Modified&#34;</span><span class="op" id="3521037">,</span>&nbsp;<span class="ident" id="3521039">modtime</span><span class="op" id="3521046">.</span><span class="ident" id="3521047">UTC</span><span class="op" id="3521050">(</span><span class="op" id="3521051">)</span><span class="op" id="3521052">.</span><span class="ident" id="3521053">Format</span><span class="op" id="3521059">(</span><span class="ident" id="3521060">TimeFormat</span><span class="op" id="3521070">)</span><span class="op" id="3521071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521074">return</span>&nbsp;<span class="ident" id="3521081">false</span><br>
<span class="lineno"></span><span class="op" id="3521087">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3521090">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3521149">//</span><br>
<span class="lineno"></span><span class="comment" id="3521152">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3521212">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3521281">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3521339">//</span><br>
<span class="lineno"></span><span class="comment" id="3521342">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3521413">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3521461">func</span>&nbsp;<span class="ident" id="3521466">checkETag</span><span class="op" id="3521475">(</span><span class="ident" id="3521476">w</span>&nbsp;<span class="ident" id="3521478">ResponseWriter</span><span class="op" id="3521492">,</span>&nbsp;<span class="ident" id="3521494">r</span>&nbsp;<span class="op" id="3521496">*</span><span class="ident" id="3521497">Request</span><span class="op" id="3521504">,</span>&nbsp;<span class="ident" id="3521506">modtime</span>&nbsp;<span class="ident" id="3521514">time</span><span class="op" id="3521518">.</span><span class="ident" id="3521519">Time</span><span class="op" id="3521523">)</span>&nbsp;<span class="op" id="3521525">(</span><span class="ident" id="3521526">rangeReq</span>&nbsp;<span class="builtintype" id="3521535">string</span><span class="op" id="3521541">,</span>&nbsp;<span class="ident" id="3521543">done</span>&nbsp;<span class="builtintype" id="3521548">bool</span><span class="op" id="3521552">)</span>&nbsp;<span class="op" id="3521554">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521557">etag</span>&nbsp;<span class="op" id="3521562">:=</span>&nbsp;<span class="ident" id="3521565">w</span><span class="op" id="3521566">.</span><span class="ident" id="3521567">Header</span><span class="op" id="3521573">(</span><span class="op" id="3521574">)</span><span class="op" id="3521575">.</span><span class="ident" id="3521576">get</span><span class="op" id="3521579">(</span><span class="string" id="3521580">&#34;Etag&#34;</span><span class="op" id="3521586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521589">rangeReq</span>&nbsp;<span class="op" id="3521598">=</span>&nbsp;<span class="ident" id="3521600">r</span><span class="op" id="3521601">.</span><span class="ident" id="3521602">Header</span><span class="op" id="3521608">.</span><span class="ident" id="3521609">get</span><span class="op" id="3521612">(</span><span class="string" id="3521613">&#34;Range&#34;</span><span class="op" id="3521620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521624">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521693">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521723">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521806">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521825">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521860">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521923">if</span>&nbsp;<span class="ident" id="3521926">ir</span>&nbsp;<span class="op" id="3521929">:=</span>&nbsp;<span class="ident" id="3521932">r</span><span class="op" id="3521933">.</span><span class="ident" id="3521934">Header</span><span class="op" id="3521940">.</span><span class="ident" id="3521941">get</span><span class="op" id="3521944">(</span><span class="string" id="3521945">&#34;If-Range&#34;</span><span class="op" id="3521955">)</span><span class="op" id="3521956">;</span>&nbsp;<span class="ident" id="3521958">ir</span>&nbsp;<span class="op" id="3521961">!=</span>&nbsp;<span class="string" id="3521964">&#34;&#34;</span>&nbsp;<span class="op" id="3521967">&amp;&amp;</span>&nbsp;<span class="ident" id="3521970">ir</span>&nbsp;<span class="op" id="3521973">!=</span>&nbsp;<span class="ident" id="3521976">etag</span>&nbsp;<span class="op" id="3521981">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521985">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522057">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522107">timeMatches</span>&nbsp;<span class="op" id="3522119">:=</span>&nbsp;<span class="ident" id="3522122">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522130">if</span>&nbsp;<span class="op" id="3522133">!</span><span class="ident" id="3522134">modtime</span><span class="op" id="3522141">.</span><span class="ident" id="3522142">IsZero</span><span class="op" id="3522148">(</span><span class="op" id="3522149">)</span>&nbsp;<span class="op" id="3522151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522156">if</span>&nbsp;<span class="ident" id="3522159">t</span><span class="op" id="3522160">,</span>&nbsp;<span class="ident" id="3522162">err</span>&nbsp;<span class="op" id="3522166">:=</span>&nbsp;<span class="ident" id="3522169">ParseTime</span><span class="op" id="3522178">(</span><span class="ident" id="3522179">ir</span><span class="op" id="3522181">)</span><span class="op" id="3522182">;</span>&nbsp;<span class="ident" id="3522184">err</span>&nbsp;<span class="op" id="3522188">==</span>&nbsp;<span class="ident" id="3522191">nil</span>&nbsp;<span class="op" id="3522195">&amp;&amp;</span>&nbsp;<span class="ident" id="3522198">t</span><span class="op" id="3522199">.</span><span class="ident" id="3522200">Unix</span><span class="op" id="3522204">(</span><span class="op" id="3522205">)</span>&nbsp;<span class="op" id="3522207">==</span>&nbsp;<span class="ident" id="3522210">modtime</span><span class="op" id="3522217">.</span><span class="ident" id="3522218">Unix</span><span class="op" id="3522222">(</span><span class="op" id="3522223">)</span>&nbsp;<span class="op" id="3522225">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522231">timeMatches</span>&nbsp;<span class="op" id="3522243">=</span>&nbsp;<span class="ident" id="3522245">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522261">if</span>&nbsp;<span class="op" id="3522264">!</span><span class="ident" id="3522265">timeMatches</span>&nbsp;<span class="op" id="3522277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522282">rangeReq</span>&nbsp;<span class="op" id="3522291">=</span>&nbsp;<span class="string" id="3522293">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522305">if</span>&nbsp;<span class="ident" id="3522308">inm</span>&nbsp;<span class="op" id="3522312">:=</span>&nbsp;<span class="ident" id="3522315">r</span><span class="op" id="3522316">.</span><span class="ident" id="3522317">Header</span><span class="op" id="3522323">.</span><span class="ident" id="3522324">get</span><span class="op" id="3522327">(</span><span class="string" id="3522328">&#34;If-None-Match&#34;</span><span class="op" id="3522343">)</span><span class="op" id="3522344">;</span>&nbsp;<span class="ident" id="3522346">inm</span>&nbsp;<span class="op" id="3522350">!=</span>&nbsp;<span class="string" id="3522353">&#34;&#34;</span>&nbsp;<span class="op" id="3522356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522360">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522381">if</span>&nbsp;<span class="ident" id="3522384">etag</span>&nbsp;<span class="op" id="3522389">==</span>&nbsp;<span class="string" id="3522392">&#34;&#34;</span>&nbsp;<span class="op" id="3522395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522400">return</span>&nbsp;<span class="ident" id="3522407">rangeReq</span><span class="op" id="3522415">,</span>&nbsp;<span class="ident" id="3522417">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522430">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522492">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522545">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522605">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522665">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522720">if</span>&nbsp;<span class="ident" id="3522723">r</span><span class="op" id="3522724">.</span><span class="ident" id="3522725">Method</span>&nbsp;<span class="op" id="3522732">!=</span>&nbsp;<span class="string" id="3522735">&#34;GET&#34;</span>&nbsp;<span class="op" id="3522741">&amp;&amp;</span>&nbsp;<span class="ident" id="3522744">r</span><span class="op" id="3522745">.</span><span class="ident" id="3522746">Method</span>&nbsp;<span class="op" id="3522753">!=</span>&nbsp;<span class="string" id="3522756">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3522763">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522768">return</span>&nbsp;<span class="ident" id="3522775">rangeReq</span><span class="op" id="3522783">,</span>&nbsp;<span class="ident" id="3522785">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522798">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522864">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522931">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522959">if</span>&nbsp;<span class="ident" id="3522962">inm</span>&nbsp;<span class="op" id="3522966">==</span>&nbsp;<span class="ident" id="3522969">etag</span>&nbsp;<span class="op" id="3522974">||</span>&nbsp;<span class="ident" id="3522977">inm</span>&nbsp;<span class="op" id="3522981">==</span>&nbsp;<span class="string" id="3522984">&#34;*&#34;</span>&nbsp;<span class="op" id="3522988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522993">h</span>&nbsp;<span class="op" id="3522995">:=</span>&nbsp;<span class="ident" id="3522998">w</span><span class="op" id="3522999">.</span><span class="ident" id="3523000">Header</span><span class="op" id="3523006">(</span><span class="op" id="3523007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523012">delete</span><span class="op" id="3523018">(</span><span class="ident" id="3523019">h</span><span class="op" id="3523020">,</span>&nbsp;<span class="string" id="3523022">&#34;Content-Type&#34;</span><span class="op" id="3523036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3523041">delete</span><span class="op" id="3523047">(</span><span class="ident" id="3523048">h</span><span class="op" id="3523049">,</span>&nbsp;<span class="string" id="3523051">&#34;Content-Length&#34;</span><span class="op" id="3523067">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523072">w</span><span class="op" id="3523073">.</span><span class="ident" id="3523074">WriteHeader</span><span class="op" id="3523085">(</span><span class="ident" id="3523086">StatusNotModified</span><span class="op" id="3523103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523108">return</span>&nbsp;<span class="string" id="3523115">&#34;&#34;</span><span class="op" id="3523117">,</span>&nbsp;<span class="ident" id="3523119">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523132">return</span>&nbsp;<span class="ident" id="3523139">rangeReq</span><span class="op" id="3523147">,</span>&nbsp;<span class="ident" id="3523149">false</span><br>
<span class="lineno">340</span><span class="op" id="3523155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3523158">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3523208">func</span>&nbsp;<span class="ident" id="3523213">serveFile</span><span class="op" id="3523222">(</span><span class="ident" id="3523223">w</span>&nbsp;<span class="ident" id="3523225">ResponseWriter</span><span class="op" id="3523239">,</span>&nbsp;<span class="ident" id="3523241">r</span>&nbsp;<span class="op" id="3523243">*</span><span class="ident" id="3523244">Request</span><span class="op" id="3523251">,</span>&nbsp;<span class="ident" id="3523253">fs</span>&nbsp;<span class="ident" id="3523256">FileSystem</span><span class="op" id="3523266">,</span>&nbsp;<span class="ident" id="3523268">name</span>&nbsp;<span class="builtintype" id="3523273">string</span><span class="op" id="3523279">,</span>&nbsp;<span class="ident" id="3523281">redirect</span>&nbsp;<span class="builtintype" id="3523290">bool</span><span class="op" id="3523294">)</span>&nbsp;<span class="op" id="3523296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523299">const</span>&nbsp;<span class="ident" id="3523305">indexPage</span>&nbsp;<span class="op" id="3523315">=</span>&nbsp;<span class="string" id="3523317">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523333">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523369">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523437">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523492">if</span>&nbsp;<span class="ident" id="3523495">strings</span><span class="op" id="3523502">.</span><span class="ident" id="3523503">HasSuffix</span><span class="op" id="3523512">(</span><span class="ident" id="3523513">r</span><span class="op" id="3523514">.</span><span class="ident" id="3523515">URL</span><span class="op" id="3523518">.</span><span class="ident" id="3523519">Path</span><span class="op" id="3523523">,</span>&nbsp;<span class="ident" id="3523525">indexPage</span><span class="op" id="3523534">)</span>&nbsp;<span class="op" id="3523536">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523540">localRedirect</span><span class="op" id="3523553">(</span><span class="ident" id="3523554">w</span><span class="op" id="3523555">,</span>&nbsp;<span class="ident" id="3523557">r</span><span class="op" id="3523558">,</span>&nbsp;<span class="string" id="3523560">&#34;./&#34;</span><span class="op" id="3523564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523568">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523580">f</span><span class="op" id="3523581">,</span>&nbsp;<span class="ident" id="3523583">err</span>&nbsp;<span class="op" id="3523587">:=</span>&nbsp;<span class="ident" id="3523590">fs</span><span class="op" id="3523592">.</span><span class="ident" id="3523593">Open</span><span class="op" id="3523597">(</span><span class="ident" id="3523598">name</span><span class="op" id="3523602">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523605">if</span>&nbsp;<span class="ident" id="3523608">err</span>&nbsp;<span class="op" id="3523612">!=</span>&nbsp;<span class="ident" id="3523615">nil</span>&nbsp;<span class="op" id="3523619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523623">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523654">NotFound</span><span class="op" id="3523662">(</span><span class="ident" id="3523663">w</span><span class="op" id="3523664">,</span>&nbsp;<span class="ident" id="3523666">r</span><span class="op" id="3523667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523671">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523679">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523682">defer</span>&nbsp;<span class="ident" id="3523688">f</span><span class="op" id="3523689">.</span><span class="ident" id="3523690">Close</span><span class="op" id="3523695">(</span><span class="op" id="3523696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523700">d</span><span class="op" id="3523701">,</span>&nbsp;<span class="ident" id="3523703">err1</span>&nbsp;<span class="op" id="3523708">:=</span>&nbsp;<span class="ident" id="3523711">f</span><span class="op" id="3523712">.</span><span class="ident" id="3523713">Stat</span><span class="op" id="3523717">(</span><span class="op" id="3523718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523721">if</span>&nbsp;<span class="ident" id="3523724">err1</span>&nbsp;<span class="op" id="3523729">!=</span>&nbsp;<span class="ident" id="3523732">nil</span>&nbsp;<span class="op" id="3523736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523740">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523771">NotFound</span><span class="op" id="3523779">(</span><span class="ident" id="3523780">w</span><span class="op" id="3523781">,</span>&nbsp;<span class="ident" id="3523783">r</span><span class="op" id="3523784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523788">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523800">if</span>&nbsp;<span class="ident" id="3523803">redirect</span>&nbsp;<span class="op" id="3523812">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523816">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523875">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523912">url</span>&nbsp;<span class="op" id="3523916">:=</span>&nbsp;<span class="ident" id="3523919">r</span><span class="op" id="3523920">.</span><span class="ident" id="3523921">URL</span><span class="op" id="3523924">.</span><span class="ident" id="3523925">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523932">if</span>&nbsp;<span class="ident" id="3523935">d</span><span class="op" id="3523936">.</span><span class="ident" id="3523937">IsDir</span><span class="op" id="3523942">(</span><span class="op" id="3523943">)</span>&nbsp;<span class="op" id="3523945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523950">if</span>&nbsp;<span class="ident" id="3523953">url</span><span class="op" id="3523956">[</span><span class="builtinfunc" id="3523957">len</span><span class="op" id="3523960">(</span><span class="ident" id="3523961">url</span><span class="op" id="3523964">)</span><span class="op" id="3523965">-</span><span class="num" id="3523966">1</span><span class="op" id="3523967">]</span>&nbsp;<span class="op" id="3523969">!=</span>&nbsp;<span class="string" id="3523972">&#39;/&#39;</span>&nbsp;<span class="op" id="3523976">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523982">localRedirect</span><span class="op" id="3523995">(</span><span class="ident" id="3523996">w</span><span class="op" id="3523997">,</span>&nbsp;<span class="ident" id="3523999">r</span><span class="op" id="3524000">,</span>&nbsp;<span class="ident" id="3524002">path</span><span class="op" id="3524006">.</span><span class="ident" id="3524007">Base</span><span class="op" id="3524011">(</span><span class="ident" id="3524012">url</span><span class="op" id="3524015">)</span><span class="op" id="3524016">+</span><span class="string" id="3524017">&#34;/&#34;</span><span class="op" id="3524020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524026">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524040">}</span>&nbsp;<span class="keyword" id="3524042">else</span>&nbsp;<span class="op" id="3524047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524052">if</span>&nbsp;<span class="ident" id="3524055">url</span><span class="op" id="3524058">[</span><span class="builtinfunc" id="3524059">len</span><span class="op" id="3524062">(</span><span class="ident" id="3524063">url</span><span class="op" id="3524066">)</span><span class="op" id="3524067">-</span><span class="num" id="3524068">1</span><span class="op" id="3524069">]</span>&nbsp;<span class="op" id="3524071">==</span>&nbsp;<span class="string" id="3524074">&#39;/&#39;</span>&nbsp;<span class="op" id="3524078">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524084">localRedirect</span><span class="op" id="3524097">(</span><span class="ident" id="3524098">w</span><span class="op" id="3524099">,</span>&nbsp;<span class="ident" id="3524101">r</span><span class="op" id="3524102">,</span>&nbsp;<span class="string" id="3524104">&#34;../&#34;</span><span class="op" id="3524109">+</span><span class="ident" id="3524110">path</span><span class="op" id="3524114">.</span><span class="ident" id="3524115">Base</span><span class="op" id="3524119">(</span><span class="ident" id="3524120">url</span><span class="op" id="3524123">)</span><span class="op" id="3524124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524130">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524147">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524151">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524208">if</span>&nbsp;<span class="ident" id="3524211">d</span><span class="op" id="3524212">.</span><span class="ident" id="3524213">IsDir</span><span class="op" id="3524218">(</span><span class="op" id="3524219">)</span>&nbsp;<span class="op" id="3524221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524225">index</span>&nbsp;<span class="op" id="3524231">:=</span>&nbsp;<span class="ident" id="3524234">strings</span><span class="op" id="3524241">.</span><span class="ident" id="3524242">TrimSuffix</span><span class="op" id="3524252">(</span><span class="ident" id="3524253">name</span><span class="op" id="3524257">,</span>&nbsp;<span class="string" id="3524259">&#34;/&#34;</span><span class="op" id="3524262">)</span>&nbsp;<span class="op" id="3524264">+</span>&nbsp;<span class="ident" id="3524266">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524278">ff</span><span class="op" id="3524280">,</span>&nbsp;<span class="ident" id="3524282">err</span>&nbsp;<span class="op" id="3524286">:=</span>&nbsp;<span class="ident" id="3524289">fs</span><span class="op" id="3524291">.</span><span class="ident" id="3524292">Open</span><span class="op" id="3524296">(</span><span class="ident" id="3524297">index</span><span class="op" id="3524302">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524306">if</span>&nbsp;<span class="ident" id="3524309">err</span>&nbsp;<span class="op" id="3524313">==</span>&nbsp;<span class="ident" id="3524316">nil</span>&nbsp;<span class="op" id="3524320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524325">defer</span>&nbsp;<span class="ident" id="3524331">ff</span><span class="op" id="3524333">.</span><span class="ident" id="3524334">Close</span><span class="op" id="3524339">(</span><span class="op" id="3524340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524345">dd</span><span class="op" id="3524347">,</span>&nbsp;<span class="ident" id="3524349">err</span>&nbsp;<span class="op" id="3524353">:=</span>&nbsp;<span class="ident" id="3524356">ff</span><span class="op" id="3524358">.</span><span class="ident" id="3524359">Stat</span><span class="op" id="3524363">(</span><span class="op" id="3524364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524369">if</span>&nbsp;<span class="ident" id="3524372">err</span>&nbsp;<span class="op" id="3524376">==</span>&nbsp;<span class="ident" id="3524379">nil</span>&nbsp;<span class="op" id="3524383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524389">name</span>&nbsp;<span class="op" id="3524394">=</span>&nbsp;<span class="ident" id="3524396">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524406">d</span>&nbsp;<span class="op" id="3524408">=</span>&nbsp;<span class="ident" id="3524410">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524417">f</span>&nbsp;<span class="op" id="3524419">=</span>&nbsp;<span class="ident" id="3524421">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524434">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524438">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524497">if</span>&nbsp;<span class="ident" id="3524500">d</span><span class="op" id="3524501">.</span><span class="ident" id="3524502">IsDir</span><span class="op" id="3524507">(</span><span class="op" id="3524508">)</span>&nbsp;<span class="op" id="3524510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524514">if</span>&nbsp;<span class="ident" id="3524517">checkLastModified</span><span class="op" id="3524534">(</span><span class="ident" id="3524535">w</span><span class="op" id="3524536">,</span>&nbsp;<span class="ident" id="3524538">r</span><span class="op" id="3524539">,</span>&nbsp;<span class="ident" id="3524541">d</span><span class="op" id="3524542">.</span><span class="ident" id="3524543">ModTime</span><span class="op" id="3524550">(</span><span class="op" id="3524551">)</span><span class="op" id="3524552">)</span>&nbsp;<span class="op" id="3524554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524559">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524572">dirList</span><span class="op" id="3524579">(</span><span class="ident" id="3524580">w</span><span class="op" id="3524581">,</span>&nbsp;<span class="ident" id="3524583">f</span><span class="op" id="3524584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524588">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3524600">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524646">sizeFunc</span>&nbsp;<span class="op" id="3524655">:=</span>&nbsp;<span class="keyword" id="3524658">func</span><span class="op" id="3524662">(</span><span class="op" id="3524663">)</span>&nbsp;<span class="op" id="3524665">(</span><span class="ident" id="3524666">int64</span><span class="op" id="3524671">,</span>&nbsp;<span class="builtintype" id="3524673">error</span><span class="op" id="3524678">)</span>&nbsp;<span class="op" id="3524680">{</span>&nbsp;<span class="keyword" id="3524682">return</span>&nbsp;<span class="ident" id="3524689">d</span><span class="op" id="3524690">.</span><span class="ident" id="3524691">Size</span><span class="op" id="3524695">(</span><span class="op" id="3524696">)</span><span class="op" id="3524697">,</span>&nbsp;<span class="ident" id="3524699">nil</span>&nbsp;<span class="op" id="3524703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524706">serveContent</span><span class="op" id="3524718">(</span><span class="ident" id="3524719">w</span><span class="op" id="3524720">,</span>&nbsp;<span class="ident" id="3524722">r</span><span class="op" id="3524723">,</span>&nbsp;<span class="ident" id="3524725">d</span><span class="op" id="3524726">.</span><span class="ident" id="3524727">Name</span><span class="op" id="3524731">(</span><span class="op" id="3524732">)</span><span class="op" id="3524733">,</span>&nbsp;<span class="ident" id="3524735">d</span><span class="op" id="3524736">.</span><span class="ident" id="3524737">ModTime</span><span class="op" id="3524744">(</span><span class="op" id="3524745">)</span><span class="op" id="3524746">,</span>&nbsp;<span class="ident" id="3524748">sizeFunc</span><span class="op" id="3524756">,</span>&nbsp;<span class="ident" id="3524758">f</span><span class="op" id="3524759">)</span><br>
<span class="lineno"></span><span class="op" id="3524761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3524764">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3524817">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3524893">func</span>&nbsp;<span class="ident" id="3524898">localRedirect</span><span class="op" id="3524911">(</span><span class="ident" id="3524912">w</span>&nbsp;<span class="ident" id="3524914">ResponseWriter</span><span class="op" id="3524928">,</span>&nbsp;<span class="ident" id="3524930">r</span>&nbsp;<span class="op" id="3524932">*</span><span class="ident" id="3524933">Request</span><span class="op" id="3524940">,</span>&nbsp;<span class="ident" id="3524942">newPath</span>&nbsp;<span class="builtintype" id="3524950">string</span><span class="op" id="3524956">)</span>&nbsp;<span class="op" id="3524958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524961">if</span>&nbsp;<span class="ident" id="3524964">q</span>&nbsp;<span class="op" id="3524966">:=</span>&nbsp;<span class="ident" id="3524969">r</span><span class="op" id="3524970">.</span><span class="ident" id="3524971">URL</span><span class="op" id="3524974">.</span><span class="ident" id="3524975">RawQuery</span><span class="op" id="3524983">;</span>&nbsp;<span class="ident" id="3524985">q</span>&nbsp;<span class="op" id="3524987">!=</span>&nbsp;<span class="string" id="3524990">&#34;&#34;</span>&nbsp;<span class="op" id="3524993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524997">newPath</span>&nbsp;<span class="op" id="3525005">+=</span>&nbsp;<span class="string" id="3525008">&#34;?&#34;</span>&nbsp;<span class="op" id="3525012">+</span>&nbsp;<span class="ident" id="3525014">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525020">w</span><span class="op" id="3525021">.</span><span class="ident" id="3525022">Header</span><span class="op" id="3525028">(</span><span class="op" id="3525029">)</span><span class="op" id="3525030">.</span><span class="ident" id="3525031">Set</span><span class="op" id="3525034">(</span><span class="string" id="3525035">&#34;Location&#34;</span><span class="op" id="3525045">,</span>&nbsp;<span class="ident" id="3525047">newPath</span><span class="op" id="3525054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525057">w</span><span class="op" id="3525058">.</span><span class="ident" id="3525059">WriteHeader</span><span class="op" id="3525070">(</span><span class="ident" id="3525071">StatusMovedPermanently</span><span class="op" id="3525093">)</span><br>
<span class="lineno"></span><span class="op" id="3525095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3525098">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3525184">func</span>&nbsp;<span class="ident" id="3525189">ServeFile</span><span class="op" id="3525198">(</span><span class="ident" id="3525199">w</span>&nbsp;<span class="ident" id="3525201">ResponseWriter</span><span class="op" id="3525215">,</span>&nbsp;<span class="ident" id="3525217">r</span>&nbsp;<span class="op" id="3525219">*</span><span class="ident" id="3525220">Request</span><span class="op" id="3525227">,</span>&nbsp;<span class="ident" id="3525229">name</span>&nbsp;<span class="builtintype" id="3525234">string</span><span class="op" id="3525240">)</span>&nbsp;<span class="op" id="3525242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525245">dir</span><span class="op" id="3525248">,</span>&nbsp;<span class="ident" id="3525250">file</span>&nbsp;<span class="op" id="3525255">:=</span>&nbsp;<span class="ident" id="3525258">filepath</span><span class="op" id="3525266">.</span><span class="ident" id="3525267">Split</span><span class="op" id="3525272">(</span><span class="ident" id="3525273">name</span><span class="op" id="3525277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525280">serveFile</span><span class="op" id="3525289">(</span><span class="ident" id="3525290">w</span><span class="op" id="3525291">,</span>&nbsp;<span class="ident" id="3525293">r</span><span class="op" id="3525294">,</span>&nbsp;<span class="ident" id="3525296">Dir</span><span class="op" id="3525299">(</span><span class="ident" id="3525300">dir</span><span class="op" id="3525303">)</span><span class="op" id="3525304">,</span>&nbsp;<span class="ident" id="3525306">file</span><span class="op" id="3525310">,</span>&nbsp;<span class="ident" id="3525312">false</span><span class="op" id="3525317">)</span><br>
<span class="lineno"></span><span class="op" id="3525319">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3525322">type</span>&nbsp;<span class="ident" id="3525327">fileHandler</span>&nbsp;<span class="keyword" id="3525339">struct</span>&nbsp;<span class="op" id="3525346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525349">root</span>&nbsp;<span class="ident" id="3525354">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3525365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3525368">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3525426">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3525482">//</span><br>
<span class="lineno"></span><span class="comment" id="3525485">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3525546">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3525563">//</span><br>
<span class="lineno"></span><span class="comment" id="3525566">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3525625">func</span>&nbsp;<span class="ident" id="3525630">FileServer</span><span class="op" id="3525640">(</span><span class="ident" id="3525641">root</span>&nbsp;<span class="ident" id="3525646">FileSystem</span><span class="op" id="3525656">)</span>&nbsp;<span class="ident" id="3525658">Handler</span>&nbsp;<span class="op" id="3525666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525669">return</span>&nbsp;<span class="op" id="3525676">&amp;</span><span class="ident" id="3525677">fileHandler</span><span class="op" id="3525688">{</span><span class="ident" id="3525689">root</span><span class="op" id="3525693">}</span><br>
<span class="lineno"></span><span class="op" id="3525695">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3525698">func</span>&nbsp;<span class="op" id="3525703">(</span><span class="ident" id="3525704">f</span>&nbsp;<span class="op" id="3525706">*</span><span class="ident" id="3525707">fileHandler</span><span class="op" id="3525718">)</span>&nbsp;<span class="ident" id="3525720">ServeHTTP</span><span class="op" id="3525729">(</span><span class="ident" id="3525730">w</span>&nbsp;<span class="ident" id="3525732">ResponseWriter</span><span class="op" id="3525746">,</span>&nbsp;<span class="ident" id="3525748">r</span>&nbsp;<span class="op" id="3525750">*</span><span class="ident" id="3525751">Request</span><span class="op" id="3525758">)</span>&nbsp;<span class="op" id="3525760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525763">upath</span>&nbsp;<span class="op" id="3525769">:=</span>&nbsp;<span class="ident" id="3525772">r</span><span class="op" id="3525773">.</span><span class="ident" id="3525774">URL</span><span class="op" id="3525777">.</span><span class="ident" id="3525778">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3525784">if</span>&nbsp;<span class="op" id="3525787">!</span><span class="ident" id="3525788">strings</span><span class="op" id="3525795">.</span><span class="ident" id="3525796">HasPrefix</span><span class="op" id="3525805">(</span><span class="ident" id="3525806">upath</span><span class="op" id="3525811">,</span>&nbsp;<span class="string" id="3525813">&#34;/&#34;</span><span class="op" id="3525816">)</span>&nbsp;<span class="op" id="3525818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525822">upath</span>&nbsp;<span class="op" id="3525828">=</span>&nbsp;<span class="string" id="3525830">&#34;/&#34;</span>&nbsp;<span class="op" id="3525834">+</span>&nbsp;<span class="ident" id="3525836">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525844">r</span><span class="op" id="3525845">.</span><span class="ident" id="3525846">URL</span><span class="op" id="3525849">.</span><span class="ident" id="3525850">Path</span>&nbsp;<span class="op" id="3525855">=</span>&nbsp;<span class="ident" id="3525857">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525867">serveFile</span><span class="op" id="3525876">(</span><span class="ident" id="3525877">w</span><span class="op" id="3525878">,</span>&nbsp;<span class="ident" id="3525880">r</span><span class="op" id="3525881">,</span>&nbsp;<span class="ident" id="3525883">f</span><span class="op" id="3525884">.</span><span class="ident" id="3525885">root</span><span class="op" id="3525889">,</span>&nbsp;<span class="ident" id="3525891">path</span><span class="op" id="3525895">.</span><span class="ident" id="3525896">Clean</span><span class="op" id="3525901">(</span><span class="ident" id="3525902">upath</span><span class="op" id="3525907">)</span><span class="op" id="3525908">,</span>&nbsp;<span class="ident" id="3525910">true</span><span class="op" id="3525914">)</span><br>
<span class="lineno"></span><span class="op" id="3525916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3525919">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3525983">type</span>&nbsp;<span class="ident" id="3525988">httpRange</span>&nbsp;<span class="keyword" id="3525998">struct</span>&nbsp;<span class="op" id="3526005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526008">start</span><span class="op" id="3526013">,</span>&nbsp;<span class="ident" id="3526015">length</span>&nbsp;<span class="ident" id="3526022">int64</span><br>
<span class="lineno"></span><span class="op" id="3526028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3526031">func</span>&nbsp;<span class="op" id="3526036">(</span><span class="ident" id="3526037">r</span>&nbsp;<span class="ident" id="3526039">httpRange</span><span class="op" id="3526048">)</span>&nbsp;<span class="ident" id="3526050">contentRange</span><span class="op" id="3526062">(</span><span class="ident" id="3526063">size</span>&nbsp;<span class="ident" id="3526068">int64</span><span class="op" id="3526073">)</span>&nbsp;<span class="builtintype" id="3526075">string</span>&nbsp;<span class="op" id="3526082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526085">return</span>&nbsp;<span class="ident" id="3526092">fmt</span><span class="op" id="3526095">.</span><span class="ident" id="3526096">Sprintf</span><span class="op" id="3526103">(</span><span class="string" id="3526104">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3526120">,</span>&nbsp;<span class="ident" id="3526122">r</span><span class="op" id="3526123">.</span><span class="ident" id="3526124">start</span><span class="op" id="3526129">,</span>&nbsp;<span class="ident" id="3526131">r</span><span class="op" id="3526132">.</span><span class="ident" id="3526133">start</span><span class="op" id="3526138">+</span><span class="ident" id="3526139">r</span><span class="op" id="3526140">.</span><span class="ident" id="3526141">length</span><span class="op" id="3526147">-</span><span class="num" id="3526148">1</span><span class="op" id="3526149">,</span>&nbsp;<span class="ident" id="3526151">size</span><span class="op" id="3526155">)</span><br>
<span class="lineno"></span><span class="op" id="3526157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3526160">func</span>&nbsp;<span class="op" id="3526165">(</span><span class="ident" id="3526166">r</span>&nbsp;<span class="ident" id="3526168">httpRange</span><span class="op" id="3526177">)</span>&nbsp;<span class="ident" id="3526179">mimeHeader</span><span class="op" id="3526189">(</span><span class="ident" id="3526190">contentType</span>&nbsp;<span class="builtintype" id="3526202">string</span><span class="op" id="3526208">,</span>&nbsp;<span class="ident" id="3526210">size</span>&nbsp;<span class="ident" id="3526215">int64</span><span class="op" id="3526220">)</span>&nbsp;<span class="ident" id="3526222">textproto</span><span class="op" id="3526231">.</span><span class="ident" id="3526232">MIMEHeader</span>&nbsp;<span class="op" id="3526243">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526246">return</span>&nbsp;<span class="ident" id="3526253">textproto</span><span class="op" id="3526262">.</span><span class="ident" id="3526263">MIMEHeader</span><span class="op" id="3526273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3526277">&#34;Content-Range&#34;</span><span class="op" id="3526292">:</span>&nbsp;<span class="op" id="3526294">{</span><span class="ident" id="3526295">r</span><span class="op" id="3526296">.</span><span class="ident" id="3526297">contentRange</span><span class="op" id="3526309">(</span><span class="ident" id="3526310">size</span><span class="op" id="3526314">)</span><span class="op" id="3526315">}</span><span class="op" id="3526316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3526320">&#34;Content-Type&#34;</span><span class="op" id="3526334">:</span>&nbsp;&nbsp;<span class="op" id="3526337">{</span><span class="ident" id="3526338">contentType</span><span class="op" id="3526349">}</span><span class="op" id="3526350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526353">}</span><br>
<span class="lineno"></span><span class="op" id="3526355">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3526358">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3526418">func</span>&nbsp;<span class="ident" id="3526423">parseRange</span><span class="op" id="3526433">(</span><span class="ident" id="3526434">s</span>&nbsp;<span class="builtintype" id="3526436">string</span><span class="op" id="3526442">,</span>&nbsp;<span class="ident" id="3526444">size</span>&nbsp;<span class="ident" id="3526449">int64</span><span class="op" id="3526454">)</span>&nbsp;<span class="op" id="3526456">(</span><span class="op" id="3526457">[</span><span class="op" id="3526458">]</span><span class="ident" id="3526459">httpRange</span><span class="op" id="3526468">,</span>&nbsp;<span class="builtintype" id="3526470">error</span><span class="op" id="3526475">)</span>&nbsp;<span class="op" id="3526477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526480">if</span>&nbsp;<span class="ident" id="3526483">s</span>&nbsp;<span class="op" id="3526485">==</span>&nbsp;<span class="string" id="3526488">&#34;&#34;</span>&nbsp;<span class="op" id="3526491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526495">return</span>&nbsp;<span class="ident" id="3526502">nil</span><span class="op" id="3526505">,</span>&nbsp;<span class="ident" id="3526507">nil</span>&nbsp;<span class="comment" id="3526511">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526537">const</span>&nbsp;<span class="ident" id="3526543">b</span>&nbsp;<span class="op" id="3526545">=</span>&nbsp;<span class="string" id="3526547">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526557">if</span>&nbsp;<span class="op" id="3526560">!</span><span class="ident" id="3526561">strings</span><span class="op" id="3526568">.</span><span class="ident" id="3526569">HasPrefix</span><span class="op" id="3526578">(</span><span class="ident" id="3526579">s</span><span class="op" id="3526580">,</span>&nbsp;<span class="ident" id="3526582">b</span><span class="op" id="3526583">)</span>&nbsp;<span class="op" id="3526585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526589">return</span>&nbsp;<span class="ident" id="3526596">nil</span><span class="op" id="3526599">,</span>&nbsp;<span class="ident" id="3526601">errors</span><span class="op" id="3526607">.</span><span class="ident" id="3526608">New</span><span class="op" id="3526611">(</span><span class="string" id="3526612">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3526627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526630">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526633">var</span>&nbsp;<span class="ident" id="3526637">ranges</span>&nbsp;<span class="op" id="3526644">[</span><span class="op" id="3526645">]</span><span class="ident" id="3526646">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526657">for</span>&nbsp;<span class="ident" id="3526661">_</span><span class="op" id="3526662">,</span>&nbsp;<span class="ident" id="3526664">ra</span>&nbsp;<span class="op" id="3526667">:=</span>&nbsp;<span class="keyword" id="3526670">range</span>&nbsp;<span class="ident" id="3526676">strings</span><span class="op" id="3526683">.</span><span class="ident" id="3526684">Split</span><span class="op" id="3526689">(</span><span class="ident" id="3526690">s</span><span class="op" id="3526691">[</span><span class="builtinfunc" id="3526692">len</span><span class="op" id="3526695">(</span><span class="ident" id="3526696">b</span><span class="op" id="3526697">)</span><span class="op" id="3526698">:</span><span class="op" id="3526699">]</span><span class="op" id="3526700">,</span>&nbsp;<span class="string" id="3526702">&#34;,&#34;</span><span class="op" id="3526705">)</span>&nbsp;<span class="op" id="3526707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526711">ra</span>&nbsp;<span class="op" id="3526714">=</span>&nbsp;<span class="ident" id="3526716">strings</span><span class="op" id="3526723">.</span><span class="ident" id="3526724">TrimSpace</span><span class="op" id="3526733">(</span><span class="ident" id="3526734">ra</span><span class="op" id="3526736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526740">if</span>&nbsp;<span class="ident" id="3526743">ra</span>&nbsp;<span class="op" id="3526746">==</span>&nbsp;<span class="string" id="3526749">&#34;&#34;</span>&nbsp;<span class="op" id="3526752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526757">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526772">i</span>&nbsp;<span class="op" id="3526774">:=</span>&nbsp;<span class="ident" id="3526777">strings</span><span class="op" id="3526784">.</span><span class="ident" id="3526785">Index</span><span class="op" id="3526790">(</span><span class="ident" id="3526791">ra</span><span class="op" id="3526793">,</span>&nbsp;<span class="string" id="3526795">&#34;-&#34;</span><span class="op" id="3526798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526802">if</span>&nbsp;<span class="ident" id="3526805">i</span>&nbsp;<span class="op" id="3526807">&lt;</span>&nbsp;<span class="num" id="3526809">0</span>&nbsp;<span class="op" id="3526811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526816">return</span>&nbsp;<span class="ident" id="3526823">nil</span><span class="op" id="3526826">,</span>&nbsp;<span class="ident" id="3526828">errors</span><span class="op" id="3526834">.</span><span class="ident" id="3526835">New</span><span class="op" id="3526838">(</span><span class="string" id="3526839">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3526854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3526858">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526862">start</span><span class="op" id="3526867">,</span>&nbsp;<span class="ident" id="3526869">end</span>&nbsp;<span class="op" id="3526873">:=</span>&nbsp;<span class="ident" id="3526876">strings</span><span class="op" id="3526883">.</span><span class="ident" id="3526884">TrimSpace</span><span class="op" id="3526893">(</span><span class="ident" id="3526894">ra</span><span class="op" id="3526896">[</span><span class="op" id="3526897">:</span><span class="ident" id="3526898">i</span><span class="op" id="3526899">]</span><span class="op" id="3526900">)</span><span class="op" id="3526901">,</span>&nbsp;<span class="ident" id="3526903">strings</span><span class="op" id="3526910">.</span><span class="ident" id="3526911">TrimSpace</span><span class="op" id="3526920">(</span><span class="ident" id="3526921">ra</span><span class="op" id="3526923">[</span><span class="ident" id="3526924">i</span><span class="op" id="3526925">+</span><span class="num" id="3526926">1</span><span class="op" id="3526927">:</span><span class="op" id="3526928">]</span><span class="op" id="3526929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526933">var</span>&nbsp;<span class="ident" id="3526937">r</span>&nbsp;<span class="ident" id="3526939">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3526951">if</span>&nbsp;<span class="ident" id="3526954">start</span>&nbsp;<span class="op" id="3526960">==</span>&nbsp;<span class="string" id="3526963">&#34;&#34;</span>&nbsp;<span class="op" id="3526966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526971">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527021">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527072">i</span><span class="op" id="3527073">,</span>&nbsp;<span class="ident" id="3527075">err</span>&nbsp;<span class="op" id="3527079">:=</span>&nbsp;<span class="ident" id="3527082">strconv</span><span class="op" id="3527089">.</span><span class="ident" id="3527090">ParseInt</span><span class="op" id="3527098">(</span><span class="ident" id="3527099">end</span><span class="op" id="3527102">,</span>&nbsp;<span class="num" id="3527104">10</span><span class="op" id="3527106">,</span>&nbsp;<span class="num" id="3527108">64</span><span class="op" id="3527110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527115">if</span>&nbsp;<span class="ident" id="3527118">err</span>&nbsp;<span class="op" id="3527122">!=</span>&nbsp;<span class="ident" id="3527125">nil</span>&nbsp;<span class="op" id="3527129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527135">return</span>&nbsp;<span class="ident" id="3527142">nil</span><span class="op" id="3527145">,</span>&nbsp;<span class="ident" id="3527147">errors</span><span class="op" id="3527153">.</span><span class="ident" id="3527154">New</span><span class="op" id="3527157">(</span><span class="string" id="3527158">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3527173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527183">if</span>&nbsp;<span class="ident" id="3527186">i</span>&nbsp;<span class="op" id="3527188">&gt;</span>&nbsp;<span class="ident" id="3527190">size</span>&nbsp;<span class="op" id="3527195">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527201">i</span>&nbsp;<span class="op" id="3527203">=</span>&nbsp;<span class="ident" id="3527205">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527218">r</span><span class="op" id="3527219">.</span><span class="ident" id="3527220">start</span>&nbsp;<span class="op" id="3527226">=</span>&nbsp;<span class="ident" id="3527228">size</span>&nbsp;<span class="op" id="3527233">-</span>&nbsp;<span class="ident" id="3527235">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527240">r</span><span class="op" id="3527241">.</span><span class="ident" id="3527242">length</span>&nbsp;<span class="op" id="3527249">=</span>&nbsp;<span class="ident" id="3527251">size</span>&nbsp;<span class="op" id="3527256">-</span>&nbsp;<span class="ident" id="3527258">r</span><span class="op" id="3527259">.</span><span class="ident" id="3527260">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527268">}</span>&nbsp;<span class="keyword" id="3527270">else</span>&nbsp;<span class="op" id="3527275">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527280">i</span><span class="op" id="3527281">,</span>&nbsp;<span class="ident" id="3527283">err</span>&nbsp;<span class="op" id="3527287">:=</span>&nbsp;<span class="ident" id="3527290">strconv</span><span class="op" id="3527297">.</span><span class="ident" id="3527298">ParseInt</span><span class="op" id="3527306">(</span><span class="ident" id="3527307">start</span><span class="op" id="3527312">,</span>&nbsp;<span class="num" id="3527314">10</span><span class="op" id="3527316">,</span>&nbsp;<span class="num" id="3527318">64</span><span class="op" id="3527320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527325">if</span>&nbsp;<span class="ident" id="3527328">err</span>&nbsp;<span class="op" id="3527332">!=</span>&nbsp;<span class="ident" id="3527335">nil</span>&nbsp;<span class="op" id="3527339">||</span>&nbsp;<span class="ident" id="3527342">i</span>&nbsp;<span class="op" id="3527344">&gt;</span>&nbsp;<span class="ident" id="3527346">size</span>&nbsp;<span class="op" id="3527351">||</span>&nbsp;<span class="ident" id="3527354">i</span>&nbsp;<span class="op" id="3527356">&lt;</span>&nbsp;<span class="num" id="3527358">0</span>&nbsp;<span class="op" id="3527360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527366">return</span>&nbsp;<span class="ident" id="3527373">nil</span><span class="op" id="3527376">,</span>&nbsp;<span class="ident" id="3527378">errors</span><span class="op" id="3527384">.</span><span class="ident" id="3527385">New</span><span class="op" id="3527388">(</span><span class="string" id="3527389">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3527404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527414">r</span><span class="op" id="3527415">.</span><span class="ident" id="3527416">start</span>&nbsp;<span class="op" id="3527422">=</span>&nbsp;<span class="ident" id="3527424">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527429">if</span>&nbsp;<span class="ident" id="3527432">end</span>&nbsp;<span class="op" id="3527436">==</span>&nbsp;<span class="string" id="3527439">&#34;&#34;</span>&nbsp;<span class="op" id="3527442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527448">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527513">r</span><span class="op" id="3527514">.</span><span class="ident" id="3527515">length</span>&nbsp;<span class="op" id="3527522">=</span>&nbsp;<span class="ident" id="3527524">size</span>&nbsp;<span class="op" id="3527529">-</span>&nbsp;<span class="ident" id="3527531">r</span><span class="op" id="3527532">.</span><span class="ident" id="3527533">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527542">}</span>&nbsp;<span class="keyword" id="3527544">else</span>&nbsp;<span class="op" id="3527549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527555">i</span><span class="op" id="3527556">,</span>&nbsp;<span class="ident" id="3527558">err</span>&nbsp;<span class="op" id="3527562">:=</span>&nbsp;<span class="ident" id="3527565">strconv</span><span class="op" id="3527572">.</span><span class="ident" id="3527573">ParseInt</span><span class="op" id="3527581">(</span><span class="ident" id="3527582">end</span><span class="op" id="3527585">,</span>&nbsp;<span class="num" id="3527587">10</span><span class="op" id="3527589">,</span>&nbsp;<span class="num" id="3527591">64</span><span class="op" id="3527593">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527599">if</span>&nbsp;<span class="ident" id="3527602">err</span>&nbsp;<span class="op" id="3527606">!=</span>&nbsp;<span class="ident" id="3527609">nil</span>&nbsp;<span class="op" id="3527613">||</span>&nbsp;<span class="ident" id="3527616">r</span><span class="op" id="3527617">.</span><span class="ident" id="3527618">start</span>&nbsp;<span class="op" id="3527624">&gt;</span>&nbsp;<span class="ident" id="3527626">i</span>&nbsp;<span class="op" id="3527628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527635">return</span>&nbsp;<span class="ident" id="3527642">nil</span><span class="op" id="3527645">,</span>&nbsp;<span class="ident" id="3527647">errors</span><span class="op" id="3527653">.</span><span class="ident" id="3527654">New</span><span class="op" id="3527657">(</span><span class="string" id="3527658">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3527673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527685">if</span>&nbsp;<span class="ident" id="3527688">i</span>&nbsp;<span class="op" id="3527690">&gt;=</span>&nbsp;<span class="ident" id="3527693">size</span>&nbsp;<span class="op" id="3527698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527705">i</span>&nbsp;<span class="op" id="3527707">=</span>&nbsp;<span class="ident" id="3527709">size</span>&nbsp;<span class="op" id="3527714">-</span>&nbsp;<span class="num" id="3527716">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527728">r</span><span class="op" id="3527729">.</span><span class="ident" id="3527730">length</span>&nbsp;<span class="op" id="3527737">=</span>&nbsp;<span class="ident" id="3527739">i</span>&nbsp;<span class="op" id="3527741">-</span>&nbsp;<span class="ident" id="3527743">r</span><span class="op" id="3527744">.</span><span class="ident" id="3527745">start</span>&nbsp;<span class="op" id="3527751">+</span>&nbsp;<span class="num" id="3527753">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527766">ranges</span>&nbsp;<span class="op" id="3527773">=</span>&nbsp;<span class="builtinfunc" id="3527775">append</span><span class="op" id="3527781">(</span><span class="ident" id="3527782">ranges</span><span class="op" id="3527788">,</span>&nbsp;<span class="ident" id="3527790">r</span><span class="op" id="3527791">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3527797">return</span>&nbsp;<span class="ident" id="3527804">ranges</span><span class="op" id="3527810">,</span>&nbsp;<span class="ident" id="3527812">nil</span><br>
<span class="lineno"></span><span class="op" id="3527816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3527819">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3527884">type</span>&nbsp;<span class="ident" id="3527889">countingWriter</span>&nbsp;<span class="ident" id="3527904">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3527911">func</span>&nbsp;<span class="op" id="3527916">(</span><span class="ident" id="3527917">w</span>&nbsp;<span class="op" id="3527919">*</span><span class="ident" id="3527920">countingWriter</span><span class="op" id="3527934">)</span>&nbsp;<span class="ident" id="3527936">Write</span><span class="op" id="3527941">(</span><span class="ident" id="3527942">p</span>&nbsp;<span class="op" id="3527944">[</span><span class="op" id="3527945">]</span><span class="builtintype" id="3527946">byte</span><span class="op" id="3527950">)</span>&nbsp;<span class="op" id="3527952">(</span><span class="ident" id="3527953">n</span>&nbsp;<span class="builtintype" id="3527955">int</span><span class="op" id="3527958">,</span>&nbsp;<span class="ident" id="3527960">err</span>&nbsp;<span class="builtintype" id="3527964">error</span><span class="op" id="3527969">)</span>&nbsp;<span class="op" id="3527971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3527974">*</span><span class="ident" id="3527975">w</span>&nbsp;<span class="op" id="3527977">+=</span>&nbsp;<span class="ident" id="3527980">countingWriter</span><span class="op" id="3527994">(</span><span class="builtinfunc" id="3527995">len</span><span class="op" id="3527998">(</span><span class="ident" id="3527999">p</span><span class="op" id="3528000">)</span><span class="op" id="3528001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528004">return</span>&nbsp;<span class="builtinfunc" id="3528011">len</span><span class="op" id="3528014">(</span><span class="ident" id="3528015">p</span><span class="op" id="3528016">)</span><span class="op" id="3528017">,</span>&nbsp;<span class="ident" id="3528019">nil</span><br>
<span class="lineno">535</span><span class="op" id="3528023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3528026">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3528095">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3528139">func</span>&nbsp;<span class="ident" id="3528144">rangesMIMESize</span><span class="op" id="3528158">(</span><span class="ident" id="3528159">ranges</span>&nbsp;<span class="op" id="3528166">[</span><span class="op" id="3528167">]</span><span class="ident" id="3528168">httpRange</span><span class="op" id="3528177">,</span>&nbsp;<span class="ident" id="3528179">contentType</span>&nbsp;<span class="builtintype" id="3528191">string</span><span class="op" id="3528197">,</span>&nbsp;<span class="ident" id="3528199">contentSize</span>&nbsp;<span class="ident" id="3528211">int64</span><span class="op" id="3528216">)</span>&nbsp;<span class="op" id="3528218">(</span><span class="ident" id="3528219">encSize</span>&nbsp;<span class="ident" id="3528227">int64</span><span class="op" id="3528232">)</span>&nbsp;<span class="op" id="3528234">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528237">var</span>&nbsp;<span class="ident" id="3528241">w</span>&nbsp;<span class="ident" id="3528243">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528259">mw</span>&nbsp;<span class="op" id="3528262">:=</span>&nbsp;<span class="ident" id="3528265">multipart</span><span class="op" id="3528274">.</span><span class="ident" id="3528275">NewWriter</span><span class="op" id="3528284">(</span><span class="op" id="3528285">&amp;</span><span class="ident" id="3528286">w</span><span class="op" id="3528287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528290">for</span>&nbsp;<span class="ident" id="3528294">_</span><span class="op" id="3528295">,</span>&nbsp;<span class="ident" id="3528297">ra</span>&nbsp;<span class="op" id="3528300">:=</span>&nbsp;<span class="keyword" id="3528303">range</span>&nbsp;<span class="ident" id="3528309">ranges</span>&nbsp;<span class="op" id="3528316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528320">mw</span><span class="op" id="3528322">.</span><span class="ident" id="3528323">CreatePart</span><span class="op" id="3528333">(</span><span class="ident" id="3528334">ra</span><span class="op" id="3528336">.</span><span class="ident" id="3528337">mimeHeader</span><span class="op" id="3528347">(</span><span class="ident" id="3528348">contentType</span><span class="op" id="3528359">,</span>&nbsp;<span class="ident" id="3528361">contentSize</span><span class="op" id="3528372">)</span><span class="op" id="3528373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528377">encSize</span>&nbsp;<span class="op" id="3528385">+=</span>&nbsp;<span class="ident" id="3528388">ra</span><span class="op" id="3528390">.</span><span class="ident" id="3528391">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528402">mw</span><span class="op" id="3528404">.</span><span class="ident" id="3528405">Close</span><span class="op" id="3528410">(</span><span class="op" id="3528411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528414">encSize</span>&nbsp;<span class="op" id="3528422">+=</span>&nbsp;<span class="ident" id="3528425">int64</span><span class="op" id="3528430">(</span><span class="ident" id="3528431">w</span><span class="op" id="3528432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528435">return</span><br>
<span class="lineno"></span><span class="op" id="3528442">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3528445">func</span>&nbsp;<span class="ident" id="3528450">sumRangesSize</span><span class="op" id="3528463">(</span><span class="ident" id="3528464">ranges</span>&nbsp;<span class="op" id="3528471">[</span><span class="op" id="3528472">]</span><span class="ident" id="3528473">httpRange</span><span class="op" id="3528482">)</span>&nbsp;<span class="op" id="3528484">(</span><span class="ident" id="3528485">size</span>&nbsp;<span class="ident" id="3528490">int64</span><span class="op" id="3528495">)</span>&nbsp;<span class="op" id="3528497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528500">for</span>&nbsp;<span class="ident" id="3528504">_</span><span class="op" id="3528505">,</span>&nbsp;<span class="ident" id="3528507">ra</span>&nbsp;<span class="op" id="3528510">:=</span>&nbsp;<span class="keyword" id="3528513">range</span>&nbsp;<span class="ident" id="3528519">ranges</span>&nbsp;<span class="op" id="3528526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528530">size</span>&nbsp;<span class="op" id="3528535">+=</span>&nbsp;<span class="ident" id="3528538">ra</span><span class="op" id="3528540">.</span><span class="ident" id="3528541">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3528549">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3528552">return</span><br>
<span class="lineno"></span><span class="op" id="3528559">}</span>
</div>
</body>
</html>
