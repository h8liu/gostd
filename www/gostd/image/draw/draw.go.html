<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5626119">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5626175">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5626229">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5626280">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5626334">//</span><br>
<span class="lineno"></span><span class="comment" id="5626337">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5626409">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5626459">package</span>&nbsp;<span class="ident" id="5626467">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5626473">import</span>&nbsp;<span class="op" id="5626480">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5626483">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5626492">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5626506">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5626509">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5626571">const</span>&nbsp;<span class="ident" id="5626577">m</span>&nbsp;<span class="op" id="5626579">=</span>&nbsp;<span class="num" id="5626581">1</span><span class="op" id="5626582">&lt;&lt;</span><span class="num" id="5626584">16</span>&nbsp;<span class="op" id="5626587">-</span>&nbsp;<span class="num" id="5626589">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5626592">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5626663">type</span>&nbsp;<span class="ident" id="5626668">Image</span>&nbsp;<span class="keyword" id="5626674">interface</span>&nbsp;<span class="op" id="5626684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626687">image</span><span class="op" id="5626692">.</span><span class="ident" id="5626693">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626700">Set</span><span class="op" id="5626703">(</span><span class="ident" id="5626704">x</span><span class="op" id="5626705">,</span>&nbsp;<span class="ident" id="5626707">y</span>&nbsp;<span class="builtintype" id="5626709">int</span><span class="op" id="5626712">,</span>&nbsp;<span class="ident" id="5626714">c</span>&nbsp;<span class="ident" id="5626716">color</span><span class="op" id="5626721">.</span><span class="ident" id="5626722">Color</span><span class="op" id="5626727">)</span><br>
<span class="lineno"></span><span class="op" id="5626729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5626732">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5626778">type</span>&nbsp;<span class="ident" id="5626783">Quantizer</span>&nbsp;<span class="keyword" id="5626793">interface</span>&nbsp;<span class="op" id="5626803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5626806">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5626877">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5626944">Quantize</span><span class="op" id="5626952">(</span><span class="ident" id="5626953">p</span>&nbsp;<span class="ident" id="5626955">color</span><span class="op" id="5626960">.</span><span class="ident" id="5626961">Palette</span><span class="op" id="5626968">,</span>&nbsp;<span class="ident" id="5626970">m</span>&nbsp;<span class="ident" id="5626972">image</span><span class="op" id="5626977">.</span><span class="ident" id="5626978">Image</span><span class="op" id="5626983">)</span>&nbsp;<span class="ident" id="5626985">color</span><span class="op" id="5626990">.</span><span class="ident" id="5626991">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5626999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5627002">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5627047">type</span>&nbsp;<span class="ident" id="5627052">Op</span>&nbsp;<span class="builtintype" id="5627055">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5627060">const</span>&nbsp;<span class="op" id="5627066">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5627069">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627116">Over</span>&nbsp;<span class="ident" id="5627121">Op</span>&nbsp;<span class="op" id="5627124">=</span>&nbsp;<span class="ident" id="5627126">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5627132">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627167">Src</span><br>
<span class="lineno">40</span><span class="op" id="5627171">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5627174">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5627253">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5627260">func</span>&nbsp;<span class="op" id="5627265">(</span><span class="ident" id="5627266">op</span>&nbsp;<span class="ident" id="5627269">Op</span><span class="op" id="5627271">)</span>&nbsp;<span class="ident" id="5627273">Draw</span><span class="op" id="5627277">(</span><span class="ident" id="5627278">dst</span>&nbsp;<span class="ident" id="5627282">Image</span><span class="op" id="5627287">,</span>&nbsp;<span class="ident" id="5627289">r</span>&nbsp;<span class="ident" id="5627291">image</span><span class="op" id="5627296">.</span><span class="ident" id="5627297">Rectangle</span><span class="op" id="5627306">,</span>&nbsp;<span class="ident" id="5627308">src</span>&nbsp;<span class="ident" id="5627312">image</span><span class="op" id="5627317">.</span><span class="ident" id="5627318">Image</span><span class="op" id="5627323">,</span>&nbsp;<span class="ident" id="5627325">sp</span>&nbsp;<span class="ident" id="5627328">image</span><span class="op" id="5627333">.</span><span class="ident" id="5627334">Point</span><span class="op" id="5627339">)</span>&nbsp;<span class="op" id="5627341">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627344">DrawMask</span><span class="op" id="5627352">(</span><span class="ident" id="5627353">dst</span><span class="op" id="5627356">,</span>&nbsp;<span class="ident" id="5627358">r</span><span class="op" id="5627359">,</span>&nbsp;<span class="ident" id="5627361">src</span><span class="op" id="5627364">,</span>&nbsp;<span class="ident" id="5627366">sp</span><span class="op" id="5627368">,</span>&nbsp;<span class="ident" id="5627370">nil</span><span class="op" id="5627373">,</span>&nbsp;<span class="ident" id="5627375">image</span><span class="op" id="5627380">.</span><span class="ident" id="5627381">Point</span><span class="op" id="5627386">{</span><span class="op" id="5627387">}</span><span class="op" id="5627388">,</span>&nbsp;<span class="ident" id="5627390">op</span><span class="op" id="5627392">)</span><br>
<span class="lineno"></span><span class="op" id="5627394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5627397">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5627433">type</span>&nbsp;<span class="ident" id="5627438">Drawer</span>&nbsp;<span class="keyword" id="5627445">interface</span>&nbsp;<span class="op" id="5627455">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5627458">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5627524">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627586">Draw</span><span class="op" id="5627590">(</span><span class="ident" id="5627591">dst</span>&nbsp;<span class="ident" id="5627595">Image</span><span class="op" id="5627600">,</span>&nbsp;<span class="ident" id="5627602">r</span>&nbsp;<span class="ident" id="5627604">image</span><span class="op" id="5627609">.</span><span class="ident" id="5627610">Rectangle</span><span class="op" id="5627619">,</span>&nbsp;<span class="ident" id="5627621">src</span>&nbsp;<span class="ident" id="5627625">image</span><span class="op" id="5627630">.</span><span class="ident" id="5627631">Image</span><span class="op" id="5627636">,</span>&nbsp;<span class="ident" id="5627638">sp</span>&nbsp;<span class="ident" id="5627641">image</span><span class="op" id="5627646">.</span><span class="ident" id="5627647">Point</span><span class="op" id="5627652">)</span><br>
<span class="lineno"></span><span class="op" id="5627654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5627657">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5627733">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5627747">var</span>&nbsp;<span class="ident" id="5627751">FloydSteinberg</span>&nbsp;<span class="ident" id="5627766">Drawer</span>&nbsp;<span class="op" id="5627773">=</span>&nbsp;<span class="ident" id="5627775">floydSteinberg</span><span class="op" id="5627789">{</span><span class="op" id="5627790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5627793">type</span>&nbsp;<span class="ident" id="5627798">floydSteinberg</span>&nbsp;<span class="keyword" id="5627813">struct</span><span class="op" id="5627819">{</span><span class="op" id="5627820">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5627823">func</span>&nbsp;<span class="op" id="5627828">(</span><span class="ident" id="5627829">floydSteinberg</span><span class="op" id="5627843">)</span>&nbsp;<span class="ident" id="5627845">Draw</span><span class="op" id="5627849">(</span><span class="ident" id="5627850">dst</span>&nbsp;<span class="ident" id="5627854">Image</span><span class="op" id="5627859">,</span>&nbsp;<span class="ident" id="5627861">r</span>&nbsp;<span class="ident" id="5627863">image</span><span class="op" id="5627868">.</span><span class="ident" id="5627869">Rectangle</span><span class="op" id="5627878">,</span>&nbsp;<span class="ident" id="5627880">src</span>&nbsp;<span class="ident" id="5627884">image</span><span class="op" id="5627889">.</span><span class="ident" id="5627890">Image</span><span class="op" id="5627895">,</span>&nbsp;<span class="ident" id="5627897">sp</span>&nbsp;<span class="ident" id="5627900">image</span><span class="op" id="5627905">.</span><span class="ident" id="5627906">Point</span><span class="op" id="5627911">)</span>&nbsp;<span class="op" id="5627913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627916">clip</span><span class="op" id="5627920">(</span><span class="ident" id="5627921">dst</span><span class="op" id="5627924">,</span>&nbsp;<span class="op" id="5627926">&amp;</span><span class="ident" id="5627927">r</span><span class="op" id="5627928">,</span>&nbsp;<span class="ident" id="5627930">src</span><span class="op" id="5627933">,</span>&nbsp;<span class="op" id="5627935">&amp;</span><span class="ident" id="5627936">sp</span><span class="op" id="5627938">,</span>&nbsp;<span class="ident" id="5627940">nil</span><span class="op" id="5627943">,</span>&nbsp;<span class="ident" id="5627945">nil</span><span class="op" id="5627948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5627951">if</span>&nbsp;<span class="ident" id="5627954">r</span><span class="op" id="5627955">.</span><span class="ident" id="5627956">Empty</span><span class="op" id="5627961">(</span><span class="op" id="5627962">)</span>&nbsp;<span class="op" id="5627964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5627968">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5627976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5627979">drawPaletted</span><span class="op" id="5627991">(</span><span class="ident" id="5627992">dst</span><span class="op" id="5627995">,</span>&nbsp;<span class="ident" id="5627997">r</span><span class="op" id="5627998">,</span>&nbsp;<span class="ident" id="5628000">src</span><span class="op" id="5628003">,</span>&nbsp;<span class="ident" id="5628005">sp</span><span class="op" id="5628007">,</span>&nbsp;<span class="builtintype" id="5628009">true</span><span class="op" id="5628013">)</span><br>
<span class="lineno"></span><span class="op" id="5628015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5628018">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5628090">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5628167">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5628210">func</span>&nbsp;<span class="ident" id="5628215">clip</span><span class="op" id="5628219">(</span><span class="ident" id="5628220">dst</span>&nbsp;<span class="ident" id="5628224">Image</span><span class="op" id="5628229">,</span>&nbsp;<span class="ident" id="5628231">r</span>&nbsp;<span class="op" id="5628233">*</span><span class="ident" id="5628234">image</span><span class="op" id="5628239">.</span><span class="ident" id="5628240">Rectangle</span><span class="op" id="5628249">,</span>&nbsp;<span class="ident" id="5628251">src</span>&nbsp;<span class="ident" id="5628255">image</span><span class="op" id="5628260">.</span><span class="ident" id="5628261">Image</span><span class="op" id="5628266">,</span>&nbsp;<span class="ident" id="5628268">sp</span>&nbsp;<span class="op" id="5628271">*</span><span class="ident" id="5628272">image</span><span class="op" id="5628277">.</span><span class="ident" id="5628278">Point</span><span class="op" id="5628283">,</span>&nbsp;<span class="ident" id="5628285">mask</span>&nbsp;<span class="ident" id="5628290">image</span><span class="op" id="5628295">.</span><span class="ident" id="5628296">Image</span><span class="op" id="5628301">,</span>&nbsp;<span class="ident" id="5628303">mp</span>&nbsp;<span class="op" id="5628306">*</span><span class="ident" id="5628307">image</span><span class="op" id="5628312">.</span><span class="ident" id="5628313">Point</span><span class="op" id="5628318">)</span>&nbsp;<span class="op" id="5628320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5628323">orig</span>&nbsp;<span class="op" id="5628328">:=</span>&nbsp;<span class="ident" id="5628331">r</span><span class="op" id="5628332">.</span><span class="ident" id="5628333">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628338">*</span><span class="ident" id="5628339">r</span>&nbsp;<span class="op" id="5628341">=</span>&nbsp;<span class="ident" id="5628343">r</span><span class="op" id="5628344">.</span><span class="ident" id="5628345">Intersect</span><span class="op" id="5628354">(</span><span class="ident" id="5628355">dst</span><span class="op" id="5628358">.</span><span class="ident" id="5628359">Bounds</span><span class="op" id="5628365">(</span><span class="op" id="5628366">)</span><span class="op" id="5628367">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628370">*</span><span class="ident" id="5628371">r</span>&nbsp;<span class="op" id="5628373">=</span>&nbsp;<span class="ident" id="5628375">r</span><span class="op" id="5628376">.</span><span class="ident" id="5628377">Intersect</span><span class="op" id="5628386">(</span><span class="ident" id="5628387">src</span><span class="op" id="5628390">.</span><span class="ident" id="5628391">Bounds</span><span class="op" id="5628397">(</span><span class="op" id="5628398">)</span><span class="op" id="5628399">.</span><span class="ident" id="5628400">Add</span><span class="op" id="5628403">(</span><span class="ident" id="5628404">orig</span><span class="op" id="5628408">.</span><span class="ident" id="5628409">Sub</span><span class="op" id="5628412">(</span><span class="op" id="5628413">*</span><span class="ident" id="5628414">sp</span><span class="op" id="5628416">)</span><span class="op" id="5628417">)</span><span class="op" id="5628418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5628421">if</span>&nbsp;<span class="ident" id="5628424">mask</span>&nbsp;<span class="op" id="5628429">!=</span>&nbsp;<span class="ident" id="5628432">nil</span>&nbsp;<span class="op" id="5628436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628440">*</span><span class="ident" id="5628441">r</span>&nbsp;<span class="op" id="5628443">=</span>&nbsp;<span class="ident" id="5628445">r</span><span class="op" id="5628446">.</span><span class="ident" id="5628447">Intersect</span><span class="op" id="5628456">(</span><span class="ident" id="5628457">mask</span><span class="op" id="5628461">.</span><span class="ident" id="5628462">Bounds</span><span class="op" id="5628468">(</span><span class="op" id="5628469">)</span><span class="op" id="5628470">.</span><span class="ident" id="5628471">Add</span><span class="op" id="5628474">(</span><span class="ident" id="5628475">orig</span><span class="op" id="5628479">.</span><span class="ident" id="5628480">Sub</span><span class="op" id="5628483">(</span><span class="op" id="5628484">*</span><span class="ident" id="5628485">mp</span><span class="op" id="5628487">)</span><span class="op" id="5628488">)</span><span class="op" id="5628489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5628495">dx</span>&nbsp;<span class="op" id="5628498">:=</span>&nbsp;<span class="ident" id="5628501">r</span><span class="op" id="5628502">.</span><span class="ident" id="5628503">Min</span><span class="op" id="5628506">.</span><span class="ident" id="5628507">X</span>&nbsp;<span class="op" id="5628509">-</span>&nbsp;<span class="ident" id="5628511">orig</span><span class="op" id="5628515">.</span><span class="ident" id="5628516">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5628519">dy</span>&nbsp;<span class="op" id="5628522">:=</span>&nbsp;<span class="ident" id="5628525">r</span><span class="op" id="5628526">.</span><span class="ident" id="5628527">Min</span><span class="op" id="5628530">.</span><span class="ident" id="5628531">Y</span>&nbsp;<span class="op" id="5628533">-</span>&nbsp;<span class="ident" id="5628535">orig</span><span class="op" id="5628539">.</span><span class="ident" id="5628540">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5628543">if</span>&nbsp;<span class="ident" id="5628546">dx</span>&nbsp;<span class="op" id="5628549">==</span>&nbsp;<span class="num" id="5628552">0</span>&nbsp;<span class="op" id="5628554">&amp;&amp;</span>&nbsp;<span class="ident" id="5628557">dy</span>&nbsp;<span class="op" id="5628560">==</span>&nbsp;<span class="num" id="5628563">0</span>&nbsp;<span class="op" id="5628565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5628569">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628580">(</span><span class="op" id="5628581">*</span><span class="ident" id="5628582">sp</span><span class="op" id="5628584">)</span><span class="op" id="5628585">.</span><span class="ident" id="5628586">X</span>&nbsp;<span class="op" id="5628588">+=</span>&nbsp;<span class="ident" id="5628591">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628595">(</span><span class="op" id="5628596">*</span><span class="ident" id="5628597">sp</span><span class="op" id="5628599">)</span><span class="op" id="5628600">.</span><span class="ident" id="5628601">Y</span>&nbsp;<span class="op" id="5628603">+=</span>&nbsp;<span class="ident" id="5628606">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628610">(</span><span class="op" id="5628611">*</span><span class="ident" id="5628612">mp</span><span class="op" id="5628614">)</span><span class="op" id="5628615">.</span><span class="ident" id="5628616">X</span>&nbsp;<span class="op" id="5628618">+=</span>&nbsp;<span class="ident" id="5628621">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628625">(</span><span class="op" id="5628626">*</span><span class="ident" id="5628627">mp</span><span class="op" id="5628629">)</span><span class="op" id="5628630">.</span><span class="ident" id="5628631">Y</span>&nbsp;<span class="op" id="5628633">+=</span>&nbsp;<span class="ident" id="5628636">dy</span><br>
<span class="lineno"></span><span class="op" id="5628639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5628642">func</span>&nbsp;<span class="ident" id="5628647">processBackward</span><span class="op" id="5628662">(</span><span class="ident" id="5628663">dst</span>&nbsp;<span class="ident" id="5628667">Image</span><span class="op" id="5628672">,</span>&nbsp;<span class="ident" id="5628674">r</span>&nbsp;<span class="ident" id="5628676">image</span><span class="op" id="5628681">.</span><span class="ident" id="5628682">Rectangle</span><span class="op" id="5628691">,</span>&nbsp;<span class="ident" id="5628693">src</span>&nbsp;<span class="ident" id="5628697">image</span><span class="op" id="5628702">.</span><span class="ident" id="5628703">Image</span><span class="op" id="5628708">,</span>&nbsp;<span class="ident" id="5628710">sp</span>&nbsp;<span class="ident" id="5628713">image</span><span class="op" id="5628718">.</span><span class="ident" id="5628719">Point</span><span class="op" id="5628724">)</span>&nbsp;<span class="builtintype" id="5628726">bool</span>&nbsp;<span class="op" id="5628731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5628734">return</span>&nbsp;<span class="ident" id="5628741">image</span><span class="op" id="5628746">.</span><span class="ident" id="5628747">Image</span><span class="op" id="5628752">(</span><span class="ident" id="5628753">dst</span><span class="op" id="5628756">)</span>&nbsp;<span class="op" id="5628758">==</span>&nbsp;<span class="ident" id="5628761">src</span>&nbsp;<span class="op" id="5628765">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5628770">r</span><span class="op" id="5628771">.</span><span class="ident" id="5628772">Overlaps</span><span class="op" id="5628780">(</span><span class="ident" id="5628781">r</span><span class="op" id="5628782">.</span><span class="ident" id="5628783">Add</span><span class="op" id="5628786">(</span><span class="ident" id="5628787">sp</span><span class="op" id="5628789">.</span><span class="ident" id="5628790">Sub</span><span class="op" id="5628793">(</span><span class="ident" id="5628794">r</span><span class="op" id="5628795">.</span><span class="ident" id="5628796">Min</span><span class="op" id="5628799">)</span><span class="op" id="5628800">)</span><span class="op" id="5628801">)</span>&nbsp;<span class="op" id="5628803">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5628808">(</span><span class="ident" id="5628809">sp</span><span class="op" id="5628811">.</span><span class="ident" id="5628812">Y</span>&nbsp;<span class="op" id="5628814">&lt;</span>&nbsp;<span class="ident" id="5628816">r</span><span class="op" id="5628817">.</span><span class="ident" id="5628818">Min</span><span class="op" id="5628821">.</span><span class="ident" id="5628822">Y</span>&nbsp;<span class="op" id="5628824">||</span>&nbsp;<span class="op" id="5628827">(</span><span class="ident" id="5628828">sp</span><span class="op" id="5628830">.</span><span class="ident" id="5628831">Y</span>&nbsp;<span class="op" id="5628833">==</span>&nbsp;<span class="ident" id="5628836">r</span><span class="op" id="5628837">.</span><span class="ident" id="5628838">Min</span><span class="op" id="5628841">.</span><span class="ident" id="5628842">Y</span>&nbsp;<span class="op" id="5628844">&amp;&amp;</span>&nbsp;<span class="ident" id="5628847">sp</span><span class="op" id="5628849">.</span><span class="ident" id="5628850">X</span>&nbsp;<span class="op" id="5628852">&lt;</span>&nbsp;<span class="ident" id="5628854">r</span><span class="op" id="5628855">.</span><span class="ident" id="5628856">Min</span><span class="op" id="5628859">.</span><span class="ident" id="5628860">X</span><span class="op" id="5628861">)</span><span class="op" id="5628862">)</span><br>
<span class="lineno"></span><span class="op" id="5628864">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5628867">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5628907">func</span>&nbsp;<span class="ident" id="5628912">Draw</span><span class="op" id="5628916">(</span><span class="ident" id="5628917">dst</span>&nbsp;<span class="ident" id="5628921">Image</span><span class="op" id="5628926">,</span>&nbsp;<span class="ident" id="5628928">r</span>&nbsp;<span class="ident" id="5628930">image</span><span class="op" id="5628935">.</span><span class="ident" id="5628936">Rectangle</span><span class="op" id="5628945">,</span>&nbsp;<span class="ident" id="5628947">src</span>&nbsp;<span class="ident" id="5628951">image</span><span class="op" id="5628956">.</span><span class="ident" id="5628957">Image</span><span class="op" id="5628962">,</span>&nbsp;<span class="ident" id="5628964">sp</span>&nbsp;<span class="ident" id="5628967">image</span><span class="op" id="5628972">.</span><span class="ident" id="5628973">Point</span><span class="op" id="5628978">,</span>&nbsp;<span class="ident" id="5628980">op</span>&nbsp;<span class="ident" id="5628983">Op</span><span class="op" id="5628985">)</span>&nbsp;<span class="op" id="5628987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5628990">DrawMask</span><span class="op" id="5628998">(</span><span class="ident" id="5628999">dst</span><span class="op" id="5629002">,</span>&nbsp;<span class="ident" id="5629004">r</span><span class="op" id="5629005">,</span>&nbsp;<span class="ident" id="5629007">src</span><span class="op" id="5629010">,</span>&nbsp;<span class="ident" id="5629012">sp</span><span class="op" id="5629014">,</span>&nbsp;<span class="ident" id="5629016">nil</span><span class="op" id="5629019">,</span>&nbsp;<span class="ident" id="5629021">image</span><span class="op" id="5629026">.</span><span class="ident" id="5629027">Point</span><span class="op" id="5629032">{</span><span class="op" id="5629033">}</span><span class="op" id="5629034">,</span>&nbsp;<span class="ident" id="5629036">op</span><span class="op" id="5629038">)</span><br>
<span class="lineno"></span><span class="op" id="5629040">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5629043">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5629139">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5629228">func</span>&nbsp;<span class="ident" id="5629233">DrawMask</span><span class="op" id="5629241">(</span><span class="ident" id="5629242">dst</span>&nbsp;<span class="ident" id="5629246">Image</span><span class="op" id="5629251">,</span>&nbsp;<span class="ident" id="5629253">r</span>&nbsp;<span class="ident" id="5629255">image</span><span class="op" id="5629260">.</span><span class="ident" id="5629261">Rectangle</span><span class="op" id="5629270">,</span>&nbsp;<span class="ident" id="5629272">src</span>&nbsp;<span class="ident" id="5629276">image</span><span class="op" id="5629281">.</span><span class="ident" id="5629282">Image</span><span class="op" id="5629287">,</span>&nbsp;<span class="ident" id="5629289">sp</span>&nbsp;<span class="ident" id="5629292">image</span><span class="op" id="5629297">.</span><span class="ident" id="5629298">Point</span><span class="op" id="5629303">,</span>&nbsp;<span class="ident" id="5629305">mask</span>&nbsp;<span class="ident" id="5629310">image</span><span class="op" id="5629315">.</span><span class="ident" id="5629316">Image</span><span class="op" id="5629321">,</span>&nbsp;<span class="ident" id="5629323">mp</span>&nbsp;<span class="ident" id="5629326">image</span><span class="op" id="5629331">.</span><span class="ident" id="5629332">Point</span><span class="op" id="5629337">,</span>&nbsp;<span class="ident" id="5629339">op</span>&nbsp;<span class="ident" id="5629342">Op</span><span class="op" id="5629344">)</span>&nbsp;<span class="op" id="5629346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5629349">clip</span><span class="op" id="5629353">(</span><span class="ident" id="5629354">dst</span><span class="op" id="5629357">,</span>&nbsp;<span class="op" id="5629359">&amp;</span><span class="ident" id="5629360">r</span><span class="op" id="5629361">,</span>&nbsp;<span class="ident" id="5629363">src</span><span class="op" id="5629366">,</span>&nbsp;<span class="op" id="5629368">&amp;</span><span class="ident" id="5629369">sp</span><span class="op" id="5629371">,</span>&nbsp;<span class="ident" id="5629373">mask</span><span class="op" id="5629377">,</span>&nbsp;<span class="op" id="5629379">&amp;</span><span class="ident" id="5629380">mp</span><span class="op" id="5629382">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629385">if</span>&nbsp;<span class="ident" id="5629388">r</span><span class="op" id="5629389">.</span><span class="ident" id="5629390">Empty</span><span class="op" id="5629395">(</span><span class="op" id="5629396">)</span>&nbsp;<span class="op" id="5629398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629402">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5629410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5629414">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629527">switch</span>&nbsp;<span class="ident" id="5629534">dst0</span>&nbsp;<span class="op" id="5629539">:=</span>&nbsp;<span class="ident" id="5629542">dst</span><span class="op" id="5629545">.</span><span class="op" id="5629546">(</span><span class="keyword" id="5629547">type</span><span class="op" id="5629551">)</span>&nbsp;<span class="op" id="5629553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629556">case</span>&nbsp;<span class="op" id="5629561">*</span><span class="ident" id="5629562">image</span><span class="op" id="5629567">.</span><span class="ident" id="5629568">RGBA</span><span class="op" id="5629572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629576">if</span>&nbsp;<span class="ident" id="5629579">op</span>&nbsp;<span class="op" id="5629582">==</span>&nbsp;<span class="ident" id="5629585">Over</span>&nbsp;<span class="op" id="5629590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629595">if</span>&nbsp;<span class="ident" id="5629598">mask</span>&nbsp;<span class="op" id="5629603">==</span>&nbsp;<span class="ident" id="5629606">nil</span>&nbsp;<span class="op" id="5629610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629616">switch</span>&nbsp;<span class="ident" id="5629623">src0</span>&nbsp;<span class="op" id="5629628">:=</span>&nbsp;<span class="ident" id="5629631">src</span><span class="op" id="5629634">.</span><span class="op" id="5629635">(</span><span class="keyword" id="5629636">type</span><span class="op" id="5629640">)</span>&nbsp;<span class="op" id="5629642">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629648">case</span>&nbsp;<span class="op" id="5629653">*</span><span class="ident" id="5629654">image</span><span class="op" id="5629659">.</span><span class="ident" id="5629660">Uniform</span><span class="op" id="5629667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5629674">drawFillOver</span><span class="op" id="5629686">(</span><span class="ident" id="5629687">dst0</span><span class="op" id="5629691">,</span>&nbsp;<span class="ident" id="5629693">r</span><span class="op" id="5629694">,</span>&nbsp;<span class="ident" id="5629696">src0</span><span class="op" id="5629700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629707">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629718">case</span>&nbsp;<span class="op" id="5629723">*</span><span class="ident" id="5629724">image</span><span class="op" id="5629729">.</span><span class="ident" id="5629730">RGBA</span><span class="op" id="5629734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5629741">drawCopyOver</span><span class="op" id="5629753">(</span><span class="ident" id="5629754">dst0</span><span class="op" id="5629758">,</span>&nbsp;<span class="ident" id="5629760">r</span><span class="op" id="5629761">,</span>&nbsp;<span class="ident" id="5629763">src0</span><span class="op" id="5629767">,</span>&nbsp;<span class="ident" id="5629769">sp</span><span class="op" id="5629771">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629778">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629789">case</span>&nbsp;<span class="op" id="5629794">*</span><span class="ident" id="5629795">image</span><span class="op" id="5629800">.</span><span class="ident" id="5629801">NRGBA</span><span class="op" id="5629806">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5629813">drawNRGBAOver</span><span class="op" id="5629826">(</span><span class="ident" id="5629827">dst0</span><span class="op" id="5629831">,</span>&nbsp;<span class="ident" id="5629833">r</span><span class="op" id="5629834">,</span>&nbsp;<span class="ident" id="5629836">src0</span><span class="op" id="5629840">,</span>&nbsp;<span class="ident" id="5629842">sp</span><span class="op" id="5629844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629851">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629862">case</span>&nbsp;<span class="op" id="5629867">*</span><span class="ident" id="5629868">image</span><span class="op" id="5629873">.</span><span class="ident" id="5629874">YCbCr</span><span class="op" id="5629879">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629886">if</span>&nbsp;<span class="ident" id="5629889">drawYCbCr</span><span class="op" id="5629898">(</span><span class="ident" id="5629899">dst0</span><span class="op" id="5629903">,</span>&nbsp;<span class="ident" id="5629905">r</span><span class="op" id="5629906">,</span>&nbsp;<span class="ident" id="5629908">src0</span><span class="op" id="5629912">,</span>&nbsp;<span class="ident" id="5629914">sp</span><span class="op" id="5629916">)</span>&nbsp;<span class="op" id="5629918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5629926">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5629938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5629944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5629949">}</span>&nbsp;<span class="keyword" id="5629951">else</span>&nbsp;<span class="keyword" id="5629956">if</span>&nbsp;<span class="ident" id="5629959">mask0</span><span class="op" id="5629964">,</span>&nbsp;<span class="ident" id="5629966">ok</span>&nbsp;<span class="op" id="5629969">:=</span>&nbsp;<span class="ident" id="5629972">mask</span><span class="op" id="5629976">.</span><span class="op" id="5629977">(</span><span class="op" id="5629978">*</span><span class="ident" id="5629979">image</span><span class="op" id="5629984">.</span><span class="ident" id="5629985">Alpha</span><span class="op" id="5629990">)</span><span class="op" id="5629991">;</span>&nbsp;<span class="ident" id="5629993">ok</span>&nbsp;<span class="op" id="5629996">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630002">switch</span>&nbsp;<span class="ident" id="5630009">src0</span>&nbsp;<span class="op" id="5630014">:=</span>&nbsp;<span class="ident" id="5630017">src</span><span class="op" id="5630020">.</span><span class="op" id="5630021">(</span><span class="keyword" id="5630022">type</span><span class="op" id="5630026">)</span>&nbsp;<span class="op" id="5630028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630034">case</span>&nbsp;<span class="op" id="5630039">*</span><span class="ident" id="5630040">image</span><span class="op" id="5630045">.</span><span class="ident" id="5630046">Uniform</span><span class="op" id="5630053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630060">drawGlyphOver</span><span class="op" id="5630073">(</span><span class="ident" id="5630074">dst0</span><span class="op" id="5630078">,</span>&nbsp;<span class="ident" id="5630080">r</span><span class="op" id="5630081">,</span>&nbsp;<span class="ident" id="5630083">src0</span><span class="op" id="5630087">,</span>&nbsp;<span class="ident" id="5630089">mask0</span><span class="op" id="5630094">,</span>&nbsp;<span class="ident" id="5630096">mp</span><span class="op" id="5630098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630105">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630116">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630125">}</span>&nbsp;<span class="keyword" id="5630127">else</span>&nbsp;<span class="op" id="5630132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630137">if</span>&nbsp;<span class="ident" id="5630140">mask</span>&nbsp;<span class="op" id="5630145">==</span>&nbsp;<span class="ident" id="5630148">nil</span>&nbsp;<span class="op" id="5630152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630158">switch</span>&nbsp;<span class="ident" id="5630165">src0</span>&nbsp;<span class="op" id="5630170">:=</span>&nbsp;<span class="ident" id="5630173">src</span><span class="op" id="5630176">.</span><span class="op" id="5630177">(</span><span class="keyword" id="5630178">type</span><span class="op" id="5630182">)</span>&nbsp;<span class="op" id="5630184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630190">case</span>&nbsp;<span class="op" id="5630195">*</span><span class="ident" id="5630196">image</span><span class="op" id="5630201">.</span><span class="ident" id="5630202">Uniform</span><span class="op" id="5630209">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630216">drawFillSrc</span><span class="op" id="5630227">(</span><span class="ident" id="5630228">dst0</span><span class="op" id="5630232">,</span>&nbsp;<span class="ident" id="5630234">r</span><span class="op" id="5630235">,</span>&nbsp;<span class="ident" id="5630237">src0</span><span class="op" id="5630241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630259">case</span>&nbsp;<span class="op" id="5630264">*</span><span class="ident" id="5630265">image</span><span class="op" id="5630270">.</span><span class="ident" id="5630271">RGBA</span><span class="op" id="5630275">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630282">drawCopySrc</span><span class="op" id="5630293">(</span><span class="ident" id="5630294">dst0</span><span class="op" id="5630298">,</span>&nbsp;<span class="ident" id="5630300">r</span><span class="op" id="5630301">,</span>&nbsp;<span class="ident" id="5630303">src0</span><span class="op" id="5630307">,</span>&nbsp;<span class="ident" id="5630309">sp</span><span class="op" id="5630311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630318">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630329">case</span>&nbsp;<span class="op" id="5630334">*</span><span class="ident" id="5630335">image</span><span class="op" id="5630340">.</span><span class="ident" id="5630341">NRGBA</span><span class="op" id="5630346">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630353">drawNRGBASrc</span><span class="op" id="5630365">(</span><span class="ident" id="5630366">dst0</span><span class="op" id="5630370">,</span>&nbsp;<span class="ident" id="5630372">r</span><span class="op" id="5630373">,</span>&nbsp;<span class="ident" id="5630375">src0</span><span class="op" id="5630379">,</span>&nbsp;<span class="ident" id="5630381">sp</span><span class="op" id="5630383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630390">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630401">case</span>&nbsp;<span class="op" id="5630406">*</span><span class="ident" id="5630407">image</span><span class="op" id="5630412">.</span><span class="ident" id="5630413">YCbCr</span><span class="op" id="5630418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630425">if</span>&nbsp;<span class="ident" id="5630428">drawYCbCr</span><span class="op" id="5630437">(</span><span class="ident" id="5630438">dst0</span><span class="op" id="5630442">,</span>&nbsp;<span class="ident" id="5630444">r</span><span class="op" id="5630445">,</span>&nbsp;<span class="ident" id="5630447">src0</span><span class="op" id="5630451">,</span>&nbsp;<span class="ident" id="5630453">sp</span><span class="op" id="5630455">)</span>&nbsp;<span class="op" id="5630457">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630465">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630492">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630496">drawRGBA</span><span class="op" id="5630504">(</span><span class="ident" id="5630505">dst0</span><span class="op" id="5630509">,</span>&nbsp;<span class="ident" id="5630511">r</span><span class="op" id="5630512">,</span>&nbsp;<span class="ident" id="5630514">src</span><span class="op" id="5630517">,</span>&nbsp;<span class="ident" id="5630519">sp</span><span class="op" id="5630521">,</span>&nbsp;<span class="ident" id="5630523">mask</span><span class="op" id="5630527">,</span>&nbsp;<span class="ident" id="5630529">mp</span><span class="op" id="5630531">,</span>&nbsp;<span class="ident" id="5630533">op</span><span class="op" id="5630535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630539">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630547">case</span>&nbsp;<span class="op" id="5630552">*</span><span class="ident" id="5630553">image</span><span class="op" id="5630558">.</span><span class="ident" id="5630559">Paletted</span><span class="op" id="5630567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630571">if</span>&nbsp;<span class="ident" id="5630574">op</span>&nbsp;<span class="op" id="5630577">==</span>&nbsp;<span class="ident" id="5630580">Src</span>&nbsp;<span class="op" id="5630584">&amp;&amp;</span>&nbsp;<span class="ident" id="5630587">mask</span>&nbsp;<span class="op" id="5630592">==</span>&nbsp;<span class="ident" id="5630595">nil</span>&nbsp;<span class="op" id="5630599">&amp;&amp;</span>&nbsp;<span class="op" id="5630602">!</span><span class="ident" id="5630603">processBackward</span><span class="op" id="5630618">(</span><span class="ident" id="5630619">dst</span><span class="op" id="5630622">,</span>&nbsp;<span class="ident" id="5630624">r</span><span class="op" id="5630625">,</span>&nbsp;<span class="ident" id="5630627">src</span><span class="op" id="5630630">,</span>&nbsp;<span class="ident" id="5630632">sp</span><span class="op" id="5630634">)</span>&nbsp;<span class="op" id="5630636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630641">drawPaletted</span><span class="op" id="5630653">(</span><span class="ident" id="5630654">dst0</span><span class="op" id="5630658">,</span>&nbsp;<span class="ident" id="5630660">r</span><span class="op" id="5630661">,</span>&nbsp;<span class="ident" id="5630663">src</span><span class="op" id="5630666">,</span>&nbsp;<span class="ident" id="5630668">sp</span><span class="op" id="5630670">,</span>&nbsp;<span class="builtintype" id="5630672">false</span><span class="op" id="5630677">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630688">x0</span><span class="op" id="5630690">,</span>&nbsp;<span class="ident" id="5630692">x1</span><span class="op" id="5630694">,</span>&nbsp;<span class="ident" id="5630696">dx</span>&nbsp;<span class="op" id="5630699">:=</span>&nbsp;<span class="ident" id="5630702">r</span><span class="op" id="5630703">.</span><span class="ident" id="5630704">Min</span><span class="op" id="5630707">.</span><span class="ident" id="5630708">X</span><span class="op" id="5630709">,</span>&nbsp;<span class="ident" id="5630711">r</span><span class="op" id="5630712">.</span><span class="ident" id="5630713">Max</span><span class="op" id="5630716">.</span><span class="ident" id="5630717">X</span><span class="op" id="5630718">,</span>&nbsp;<span class="num" id="5630720">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630723">y0</span><span class="op" id="5630725">,</span>&nbsp;<span class="ident" id="5630727">y1</span><span class="op" id="5630729">,</span>&nbsp;<span class="ident" id="5630731">dy</span>&nbsp;<span class="op" id="5630734">:=</span>&nbsp;<span class="ident" id="5630737">r</span><span class="op" id="5630738">.</span><span class="ident" id="5630739">Min</span><span class="op" id="5630742">.</span><span class="ident" id="5630743">Y</span><span class="op" id="5630744">,</span>&nbsp;<span class="ident" id="5630746">r</span><span class="op" id="5630747">.</span><span class="ident" id="5630748">Max</span><span class="op" id="5630751">.</span><span class="ident" id="5630752">Y</span><span class="op" id="5630753">,</span>&nbsp;<span class="num" id="5630755">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630758">if</span>&nbsp;<span class="ident" id="5630761">processBackward</span><span class="op" id="5630776">(</span><span class="ident" id="5630777">dst</span><span class="op" id="5630780">,</span>&nbsp;<span class="ident" id="5630782">r</span><span class="op" id="5630783">,</span>&nbsp;<span class="ident" id="5630785">src</span><span class="op" id="5630788">,</span>&nbsp;<span class="ident" id="5630790">sp</span><span class="op" id="5630792">)</span>&nbsp;<span class="op" id="5630794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630798">x0</span><span class="op" id="5630800">,</span>&nbsp;<span class="ident" id="5630802">x1</span><span class="op" id="5630804">,</span>&nbsp;<span class="ident" id="5630806">dx</span>&nbsp;<span class="op" id="5630809">=</span>&nbsp;<span class="ident" id="5630811">x1</span><span class="op" id="5630813">-</span><span class="num" id="5630814">1</span><span class="op" id="5630815">,</span>&nbsp;<span class="ident" id="5630817">x0</span><span class="op" id="5630819">-</span><span class="num" id="5630820">1</span><span class="op" id="5630821">,</span>&nbsp;<span class="op" id="5630823">-</span><span class="num" id="5630824">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630828">y0</span><span class="op" id="5630830">,</span>&nbsp;<span class="ident" id="5630832">y1</span><span class="op" id="5630834">,</span>&nbsp;<span class="ident" id="5630836">dy</span>&nbsp;<span class="op" id="5630839">=</span>&nbsp;<span class="ident" id="5630841">y1</span><span class="op" id="5630843">-</span><span class="num" id="5630844">1</span><span class="op" id="5630845">,</span>&nbsp;<span class="ident" id="5630847">y0</span><span class="op" id="5630849">-</span><span class="num" id="5630850">1</span><span class="op" id="5630851">,</span>&nbsp;<span class="op" id="5630853">-</span><span class="num" id="5630854">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5630857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630861">var</span>&nbsp;<span class="ident" id="5630865">out</span>&nbsp;<span class="ident" id="5630869">color</span><span class="op" id="5630874">.</span><span class="ident" id="5630875">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630883">sy</span>&nbsp;<span class="op" id="5630886">:=</span>&nbsp;<span class="ident" id="5630889">sp</span><span class="op" id="5630891">.</span><span class="ident" id="5630892">Y</span>&nbsp;<span class="op" id="5630894">+</span>&nbsp;<span class="ident" id="5630896">y0</span>&nbsp;<span class="op" id="5630899">-</span>&nbsp;<span class="ident" id="5630901">r</span><span class="op" id="5630902">.</span><span class="ident" id="5630903">Min</span><span class="op" id="5630906">.</span><span class="ident" id="5630907">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630910">my</span>&nbsp;<span class="op" id="5630913">:=</span>&nbsp;<span class="ident" id="5630916">mp</span><span class="op" id="5630918">.</span><span class="ident" id="5630919">Y</span>&nbsp;<span class="op" id="5630921">+</span>&nbsp;<span class="ident" id="5630923">y0</span>&nbsp;<span class="op" id="5630926">-</span>&nbsp;<span class="ident" id="5630928">r</span><span class="op" id="5630929">.</span><span class="ident" id="5630930">Min</span><span class="op" id="5630933">.</span><span class="ident" id="5630934">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5630937">for</span>&nbsp;<span class="ident" id="5630941">y</span>&nbsp;<span class="op" id="5630943">:=</span>&nbsp;<span class="ident" id="5630946">y0</span><span class="op" id="5630948">;</span>&nbsp;<span class="ident" id="5630950">y</span>&nbsp;<span class="op" id="5630952">!=</span>&nbsp;<span class="ident" id="5630955">y1</span><span class="op" id="5630957">;</span>&nbsp;<span class="ident" id="5630959">y</span><span class="op" id="5630960">,</span>&nbsp;<span class="ident" id="5630962">sy</span><span class="op" id="5630964">,</span>&nbsp;<span class="ident" id="5630966">my</span>&nbsp;<span class="op" id="5630969">=</span>&nbsp;<span class="ident" id="5630971">y</span><span class="op" id="5630972">+</span><span class="ident" id="5630973">dy</span><span class="op" id="5630975">,</span>&nbsp;<span class="ident" id="5630977">sy</span><span class="op" id="5630979">+</span><span class="ident" id="5630980">dy</span><span class="op" id="5630982">,</span>&nbsp;<span class="ident" id="5630984">my</span><span class="op" id="5630986">+</span><span class="ident" id="5630987">dy</span>&nbsp;<span class="op" id="5630990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5630994">sx</span>&nbsp;<span class="op" id="5630997">:=</span>&nbsp;<span class="ident" id="5631000">sp</span><span class="op" id="5631002">.</span><span class="ident" id="5631003">X</span>&nbsp;<span class="op" id="5631005">+</span>&nbsp;<span class="ident" id="5631007">x0</span>&nbsp;<span class="op" id="5631010">-</span>&nbsp;<span class="ident" id="5631012">r</span><span class="op" id="5631013">.</span><span class="ident" id="5631014">Min</span><span class="op" id="5631017">.</span><span class="ident" id="5631018">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631022">mx</span>&nbsp;<span class="op" id="5631025">:=</span>&nbsp;<span class="ident" id="5631028">mp</span><span class="op" id="5631030">.</span><span class="ident" id="5631031">X</span>&nbsp;<span class="op" id="5631033">+</span>&nbsp;<span class="ident" id="5631035">x0</span>&nbsp;<span class="op" id="5631038">-</span>&nbsp;<span class="ident" id="5631040">r</span><span class="op" id="5631041">.</span><span class="ident" id="5631042">Min</span><span class="op" id="5631045">.</span><span class="ident" id="5631046">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631050">for</span>&nbsp;<span class="ident" id="5631054">x</span>&nbsp;<span class="op" id="5631056">:=</span>&nbsp;<span class="ident" id="5631059">x0</span><span class="op" id="5631061">;</span>&nbsp;<span class="ident" id="5631063">x</span>&nbsp;<span class="op" id="5631065">!=</span>&nbsp;<span class="ident" id="5631068">x1</span><span class="op" id="5631070">;</span>&nbsp;<span class="ident" id="5631072">x</span><span class="op" id="5631073">,</span>&nbsp;<span class="ident" id="5631075">sx</span><span class="op" id="5631077">,</span>&nbsp;<span class="ident" id="5631079">mx</span>&nbsp;<span class="op" id="5631082">=</span>&nbsp;<span class="ident" id="5631084">x</span><span class="op" id="5631085">+</span><span class="ident" id="5631086">dx</span><span class="op" id="5631088">,</span>&nbsp;<span class="ident" id="5631090">sx</span><span class="op" id="5631092">+</span><span class="ident" id="5631093">dx</span><span class="op" id="5631095">,</span>&nbsp;<span class="ident" id="5631097">mx</span><span class="op" id="5631099">+</span><span class="ident" id="5631100">dx</span>&nbsp;<span class="op" id="5631103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631108">ma</span>&nbsp;<span class="op" id="5631111">:=</span>&nbsp;<span class="builtintype" id="5631114">uint32</span><span class="op" id="5631120">(</span><span class="ident" id="5631121">m</span><span class="op" id="5631122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631127">if</span>&nbsp;<span class="ident" id="5631130">mask</span>&nbsp;<span class="op" id="5631135">!=</span>&nbsp;<span class="ident" id="5631138">nil</span>&nbsp;<span class="op" id="5631142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631148">_</span><span class="op" id="5631149">,</span>&nbsp;<span class="ident" id="5631151">_</span><span class="op" id="5631152">,</span>&nbsp;<span class="ident" id="5631154">_</span><span class="op" id="5631155">,</span>&nbsp;<span class="ident" id="5631157">ma</span>&nbsp;<span class="op" id="5631160">=</span>&nbsp;<span class="ident" id="5631162">mask</span><span class="op" id="5631166">.</span><span class="ident" id="5631167">At</span><span class="op" id="5631169">(</span><span class="ident" id="5631170">mx</span><span class="op" id="5631172">,</span>&nbsp;<span class="ident" id="5631174">my</span><span class="op" id="5631176">)</span><span class="op" id="5631177">.</span><span class="ident" id="5631178">RGBA</span><span class="op" id="5631182">(</span><span class="op" id="5631183">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5631188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631193">switch</span>&nbsp;<span class="op" id="5631200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631205">case</span>&nbsp;<span class="ident" id="5631210">ma</span>&nbsp;<span class="op" id="5631213">==</span>&nbsp;<span class="num" id="5631216">0</span><span class="op" id="5631217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631223">if</span>&nbsp;<span class="ident" id="5631226">op</span>&nbsp;<span class="op" id="5631229">==</span>&nbsp;<span class="ident" id="5631232">Over</span>&nbsp;<span class="op" id="5631237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5631244">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5631258">}</span>&nbsp;<span class="keyword" id="5631260">else</span>&nbsp;<span class="op" id="5631265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631272">dst</span><span class="op" id="5631275">.</span><span class="ident" id="5631276">Set</span><span class="op" id="5631279">(</span><span class="ident" id="5631280">x</span><span class="op" id="5631281">,</span>&nbsp;<span class="ident" id="5631283">y</span><span class="op" id="5631284">,</span>&nbsp;<span class="ident" id="5631286">color</span><span class="op" id="5631291">.</span><span class="ident" id="5631292">Transparent</span><span class="op" id="5631303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5631309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631314">case</span>&nbsp;<span class="ident" id="5631319">ma</span>&nbsp;<span class="op" id="5631322">==</span>&nbsp;<span class="ident" id="5631325">m</span>&nbsp;<span class="op" id="5631327">&amp;&amp;</span>&nbsp;<span class="ident" id="5631330">op</span>&nbsp;<span class="op" id="5631333">==</span>&nbsp;<span class="ident" id="5631336">Src</span><span class="op" id="5631339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631345">dst</span><span class="op" id="5631348">.</span><span class="ident" id="5631349">Set</span><span class="op" id="5631352">(</span><span class="ident" id="5631353">x</span><span class="op" id="5631354">,</span>&nbsp;<span class="ident" id="5631356">y</span><span class="op" id="5631357">,</span>&nbsp;<span class="ident" id="5631359">src</span><span class="op" id="5631362">.</span><span class="ident" id="5631363">At</span><span class="op" id="5631365">(</span><span class="ident" id="5631366">sx</span><span class="op" id="5631368">,</span>&nbsp;<span class="ident" id="5631370">sy</span><span class="op" id="5631372">)</span><span class="op" id="5631373">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631378">default</span><span class="op" id="5631385">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631391">sr</span><span class="op" id="5631393">,</span>&nbsp;<span class="ident" id="5631395">sg</span><span class="op" id="5631397">,</span>&nbsp;<span class="ident" id="5631399">sb</span><span class="op" id="5631401">,</span>&nbsp;<span class="ident" id="5631403">sa</span>&nbsp;<span class="op" id="5631406">:=</span>&nbsp;<span class="ident" id="5631409">src</span><span class="op" id="5631412">.</span><span class="ident" id="5631413">At</span><span class="op" id="5631415">(</span><span class="ident" id="5631416">sx</span><span class="op" id="5631418">,</span>&nbsp;<span class="ident" id="5631420">sy</span><span class="op" id="5631422">)</span><span class="op" id="5631423">.</span><span class="ident" id="5631424">RGBA</span><span class="op" id="5631428">(</span><span class="op" id="5631429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5631435">if</span>&nbsp;<span class="ident" id="5631438">op</span>&nbsp;<span class="op" id="5631441">==</span>&nbsp;<span class="ident" id="5631444">Over</span>&nbsp;<span class="op" id="5631449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631456">dr</span><span class="op" id="5631458">,</span>&nbsp;<span class="ident" id="5631460">dg</span><span class="op" id="5631462">,</span>&nbsp;<span class="ident" id="5631464">db</span><span class="op" id="5631466">,</span>&nbsp;<span class="ident" id="5631468">da</span>&nbsp;<span class="op" id="5631471">:=</span>&nbsp;<span class="ident" id="5631474">dst</span><span class="op" id="5631477">.</span><span class="ident" id="5631478">At</span><span class="op" id="5631480">(</span><span class="ident" id="5631481">x</span><span class="op" id="5631482">,</span>&nbsp;<span class="ident" id="5631484">y</span><span class="op" id="5631485">)</span><span class="op" id="5631486">.</span><span class="ident" id="5631487">RGBA</span><span class="op" id="5631491">(</span><span class="op" id="5631492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631499">a</span>&nbsp;<span class="op" id="5631501">:=</span>&nbsp;<span class="ident" id="5631504">m</span>&nbsp;<span class="op" id="5631506">-</span>&nbsp;<span class="op" id="5631508">(</span><span class="ident" id="5631509">sa</span>&nbsp;<span class="op" id="5631512">*</span>&nbsp;<span class="ident" id="5631514">ma</span>&nbsp;<span class="op" id="5631517">/</span>&nbsp;<span class="ident" id="5631519">m</span><span class="op" id="5631520">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631527">out</span><span class="op" id="5631530">.</span><span class="ident" id="5631531">R</span>&nbsp;<span class="op" id="5631533">=</span>&nbsp;<span class="builtintype" id="5631535">uint16</span><span class="op" id="5631541">(</span><span class="op" id="5631542">(</span><span class="ident" id="5631543">dr</span><span class="op" id="5631545">*</span><span class="ident" id="5631546">a</span>&nbsp;<span class="op" id="5631548">+</span>&nbsp;<span class="ident" id="5631550">sr</span><span class="op" id="5631552">*</span><span class="ident" id="5631553">ma</span><span class="op" id="5631555">)</span>&nbsp;<span class="op" id="5631557">/</span>&nbsp;<span class="ident" id="5631559">m</span><span class="op" id="5631560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631567">out</span><span class="op" id="5631570">.</span><span class="ident" id="5631571">G</span>&nbsp;<span class="op" id="5631573">=</span>&nbsp;<span class="builtintype" id="5631575">uint16</span><span class="op" id="5631581">(</span><span class="op" id="5631582">(</span><span class="ident" id="5631583">dg</span><span class="op" id="5631585">*</span><span class="ident" id="5631586">a</span>&nbsp;<span class="op" id="5631588">+</span>&nbsp;<span class="ident" id="5631590">sg</span><span class="op" id="5631592">*</span><span class="ident" id="5631593">ma</span><span class="op" id="5631595">)</span>&nbsp;<span class="op" id="5631597">/</span>&nbsp;<span class="ident" id="5631599">m</span><span class="op" id="5631600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631607">out</span><span class="op" id="5631610">.</span><span class="ident" id="5631611">B</span>&nbsp;<span class="op" id="5631613">=</span>&nbsp;<span class="builtintype" id="5631615">uint16</span><span class="op" id="5631621">(</span><span class="op" id="5631622">(</span><span class="ident" id="5631623">db</span><span class="op" id="5631625">*</span><span class="ident" id="5631626">a</span>&nbsp;<span class="op" id="5631628">+</span>&nbsp;<span class="ident" id="5631630">sb</span><span class="op" id="5631632">*</span><span class="ident" id="5631633">ma</span><span class="op" id="5631635">)</span>&nbsp;<span class="op" id="5631637">/</span>&nbsp;<span class="ident" id="5631639">m</span><span class="op" id="5631640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631647">out</span><span class="op" id="5631650">.</span><span class="ident" id="5631651">A</span>&nbsp;<span class="op" id="5631653">=</span>&nbsp;<span class="builtintype" id="5631655">uint16</span><span class="op" id="5631661">(</span><span class="op" id="5631662">(</span><span class="ident" id="5631663">da</span><span class="op" id="5631665">*</span><span class="ident" id="5631666">a</span>&nbsp;<span class="op" id="5631668">+</span>&nbsp;<span class="ident" id="5631670">sa</span><span class="op" id="5631672">*</span><span class="ident" id="5631673">ma</span><span class="op" id="5631675">)</span>&nbsp;<span class="op" id="5631677">/</span>&nbsp;<span class="ident" id="5631679">m</span><span class="op" id="5631680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5631686">}</span>&nbsp;<span class="keyword" id="5631688">else</span>&nbsp;<span class="op" id="5631693">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631700">out</span><span class="op" id="5631703">.</span><span class="ident" id="5631704">R</span>&nbsp;<span class="op" id="5631706">=</span>&nbsp;<span class="builtintype" id="5631708">uint16</span><span class="op" id="5631714">(</span><span class="ident" id="5631715">sr</span>&nbsp;<span class="op" id="5631718">*</span>&nbsp;<span class="ident" id="5631720">ma</span>&nbsp;<span class="op" id="5631723">/</span>&nbsp;<span class="ident" id="5631725">m</span><span class="op" id="5631726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631733">out</span><span class="op" id="5631736">.</span><span class="ident" id="5631737">G</span>&nbsp;<span class="op" id="5631739">=</span>&nbsp;<span class="builtintype" id="5631741">uint16</span><span class="op" id="5631747">(</span><span class="ident" id="5631748">sg</span>&nbsp;<span class="op" id="5631751">*</span>&nbsp;<span class="ident" id="5631753">ma</span>&nbsp;<span class="op" id="5631756">/</span>&nbsp;<span class="ident" id="5631758">m</span><span class="op" id="5631759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631766">out</span><span class="op" id="5631769">.</span><span class="ident" id="5631770">B</span>&nbsp;<span class="op" id="5631772">=</span>&nbsp;<span class="builtintype" id="5631774">uint16</span><span class="op" id="5631780">(</span><span class="ident" id="5631781">sb</span>&nbsp;<span class="op" id="5631784">*</span>&nbsp;<span class="ident" id="5631786">ma</span>&nbsp;<span class="op" id="5631789">/</span>&nbsp;<span class="ident" id="5631791">m</span><span class="op" id="5631792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5631799">out</span><span class="op" id="5631802">.</span><span class="ident" id="5631803">A</span>&nbsp;<span class="op" id="5631805">=</span>&nbsp;<span class="builtintype" id="5631807">uint16</span><span class="op" id="5631813">(</span><span class="ident" id="5631814">sa</span>&nbsp;<span class="op" id="5631817">*</span>&nbsp;<span class="ident" id="5631819">ma</span>&nbsp;<span class="op" id="5631822">/</span>&nbsp;<span class="ident" id="5631824">m</span><span class="op" id="5631825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5631831">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5631837">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5631898">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5631963">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5632026">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632087">dst</span><span class="op" id="5632090">.</span><span class="ident" id="5632091">Set</span><span class="op" id="5632094">(</span><span class="ident" id="5632095">x</span><span class="op" id="5632096">,</span>&nbsp;<span class="ident" id="5632098">y</span><span class="op" id="5632099">,</span>&nbsp;<span class="op" id="5632101">&amp;</span><span class="ident" id="5632102">out</span><span class="op" id="5632105">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5632110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5632114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5632117">}</span><br>
<span class="lineno"></span><span class="op" id="5632119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5632122">func</span>&nbsp;<span class="ident" id="5632127">drawFillOver</span><span class="op" id="5632139">(</span><span class="ident" id="5632140">dst</span>&nbsp;<span class="op" id="5632144">*</span><span class="ident" id="5632145">image</span><span class="op" id="5632150">.</span><span class="ident" id="5632151">RGBA</span><span class="op" id="5632155">,</span>&nbsp;<span class="ident" id="5632157">r</span>&nbsp;<span class="ident" id="5632159">image</span><span class="op" id="5632164">.</span><span class="ident" id="5632165">Rectangle</span><span class="op" id="5632174">,</span>&nbsp;<span class="ident" id="5632176">src</span>&nbsp;<span class="op" id="5632180">*</span><span class="ident" id="5632181">image</span><span class="op" id="5632186">.</span><span class="ident" id="5632187">Uniform</span><span class="op" id="5632194">)</span>&nbsp;<span class="op" id="5632196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632199">sr</span><span class="op" id="5632201">,</span>&nbsp;<span class="ident" id="5632203">sg</span><span class="op" id="5632205">,</span>&nbsp;<span class="ident" id="5632207">sb</span><span class="op" id="5632209">,</span>&nbsp;<span class="ident" id="5632211">sa</span>&nbsp;<span class="op" id="5632214">:=</span>&nbsp;<span class="ident" id="5632217">src</span><span class="op" id="5632220">.</span><span class="ident" id="5632221">RGBA</span><span class="op" id="5632225">(</span><span class="op" id="5632226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5632229">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632287">a</span>&nbsp;<span class="op" id="5632289">:=</span>&nbsp;<span class="op" id="5632292">(</span><span class="ident" id="5632293">m</span>&nbsp;<span class="op" id="5632295">-</span>&nbsp;<span class="ident" id="5632297">sa</span><span class="op" id="5632299">)</span>&nbsp;<span class="op" id="5632301">*</span>&nbsp;<span class="num" id="5632303">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632310">i0</span>&nbsp;<span class="op" id="5632313">:=</span>&nbsp;<span class="ident" id="5632316">dst</span><span class="op" id="5632319">.</span><span class="ident" id="5632320">PixOffset</span><span class="op" id="5632329">(</span><span class="ident" id="5632330">r</span><span class="op" id="5632331">.</span><span class="ident" id="5632332">Min</span><span class="op" id="5632335">.</span><span class="ident" id="5632336">X</span><span class="op" id="5632337">,</span>&nbsp;<span class="ident" id="5632339">r</span><span class="op" id="5632340">.</span><span class="ident" id="5632341">Min</span><span class="op" id="5632344">.</span><span class="ident" id="5632345">Y</span><span class="op" id="5632346">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632349">i1</span>&nbsp;<span class="op" id="5632352">:=</span>&nbsp;<span class="ident" id="5632355">i0</span>&nbsp;<span class="op" id="5632358">+</span>&nbsp;<span class="ident" id="5632360">r</span><span class="op" id="5632361">.</span><span class="ident" id="5632362">Dx</span><span class="op" id="5632364">(</span><span class="op" id="5632365">)</span><span class="op" id="5632366">*</span><span class="num" id="5632367">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5632370">for</span>&nbsp;<span class="ident" id="5632374">y</span>&nbsp;<span class="op" id="5632376">:=</span>&nbsp;<span class="ident" id="5632379">r</span><span class="op" id="5632380">.</span><span class="ident" id="5632381">Min</span><span class="op" id="5632384">.</span><span class="ident" id="5632385">Y</span><span class="op" id="5632386">;</span>&nbsp;<span class="ident" id="5632388">y</span>&nbsp;<span class="op" id="5632390">!=</span>&nbsp;<span class="ident" id="5632393">r</span><span class="op" id="5632394">.</span><span class="ident" id="5632395">Max</span><span class="op" id="5632398">.</span><span class="ident" id="5632399">Y</span><span class="op" id="5632400">;</span>&nbsp;<span class="ident" id="5632402">y</span><span class="op" id="5632403">++</span>&nbsp;<span class="op" id="5632406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5632410">for</span>&nbsp;<span class="ident" id="5632414">i</span>&nbsp;<span class="op" id="5632416">:=</span>&nbsp;<span class="ident" id="5632419">i0</span><span class="op" id="5632421">;</span>&nbsp;<span class="ident" id="5632423">i</span>&nbsp;<span class="op" id="5632425">&lt;</span>&nbsp;<span class="ident" id="5632427">i1</span><span class="op" id="5632429">;</span>&nbsp;<span class="ident" id="5632431">i</span>&nbsp;<span class="op" id="5632433">+=</span>&nbsp;<span class="num" id="5632436">4</span>&nbsp;<span class="op" id="5632438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632443">dr</span>&nbsp;<span class="op" id="5632446">:=</span>&nbsp;<span class="builtintype" id="5632449">uint32</span><span class="op" id="5632455">(</span><span class="ident" id="5632456">dst</span><span class="op" id="5632459">.</span><span class="ident" id="5632460">Pix</span><span class="op" id="5632463">[</span><span class="ident" id="5632464">i</span><span class="op" id="5632465">+</span><span class="num" id="5632466">0</span><span class="op" id="5632467">]</span><span class="op" id="5632468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632473">dg</span>&nbsp;<span class="op" id="5632476">:=</span>&nbsp;<span class="builtintype" id="5632479">uint32</span><span class="op" id="5632485">(</span><span class="ident" id="5632486">dst</span><span class="op" id="5632489">.</span><span class="ident" id="5632490">Pix</span><span class="op" id="5632493">[</span><span class="ident" id="5632494">i</span><span class="op" id="5632495">+</span><span class="num" id="5632496">1</span><span class="op" id="5632497">]</span><span class="op" id="5632498">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632503">db</span>&nbsp;<span class="op" id="5632506">:=</span>&nbsp;<span class="builtintype" id="5632509">uint32</span><span class="op" id="5632515">(</span><span class="ident" id="5632516">dst</span><span class="op" id="5632519">.</span><span class="ident" id="5632520">Pix</span><span class="op" id="5632523">[</span><span class="ident" id="5632524">i</span><span class="op" id="5632525">+</span><span class="num" id="5632526">2</span><span class="op" id="5632527">]</span><span class="op" id="5632528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632533">da</span>&nbsp;<span class="op" id="5632536">:=</span>&nbsp;<span class="builtintype" id="5632539">uint32</span><span class="op" id="5632545">(</span><span class="ident" id="5632546">dst</span><span class="op" id="5632549">.</span><span class="ident" id="5632550">Pix</span><span class="op" id="5632553">[</span><span class="ident" id="5632554">i</span><span class="op" id="5632555">+</span><span class="num" id="5632556">3</span><span class="op" id="5632557">]</span><span class="op" id="5632558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632564">dst</span><span class="op" id="5632567">.</span><span class="ident" id="5632568">Pix</span><span class="op" id="5632571">[</span><span class="ident" id="5632572">i</span><span class="op" id="5632573">+</span><span class="num" id="5632574">0</span><span class="op" id="5632575">]</span>&nbsp;<span class="op" id="5632577">=</span>&nbsp;<span class="builtintype" id="5632579">uint8</span><span class="op" id="5632584">(</span><span class="op" id="5632585">(</span><span class="ident" id="5632586">dr</span><span class="op" id="5632588">*</span><span class="ident" id="5632589">a</span><span class="op" id="5632590">/</span><span class="ident" id="5632591">m</span>&nbsp;<span class="op" id="5632593">+</span>&nbsp;<span class="ident" id="5632595">sr</span><span class="op" id="5632597">)</span>&nbsp;<span class="op" id="5632599">&gt;&gt;</span>&nbsp;<span class="num" id="5632602">8</span><span class="op" id="5632603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632608">dst</span><span class="op" id="5632611">.</span><span class="ident" id="5632612">Pix</span><span class="op" id="5632615">[</span><span class="ident" id="5632616">i</span><span class="op" id="5632617">+</span><span class="num" id="5632618">1</span><span class="op" id="5632619">]</span>&nbsp;<span class="op" id="5632621">=</span>&nbsp;<span class="builtintype" id="5632623">uint8</span><span class="op" id="5632628">(</span><span class="op" id="5632629">(</span><span class="ident" id="5632630">dg</span><span class="op" id="5632632">*</span><span class="ident" id="5632633">a</span><span class="op" id="5632634">/</span><span class="ident" id="5632635">m</span>&nbsp;<span class="op" id="5632637">+</span>&nbsp;<span class="ident" id="5632639">sg</span><span class="op" id="5632641">)</span>&nbsp;<span class="op" id="5632643">&gt;&gt;</span>&nbsp;<span class="num" id="5632646">8</span><span class="op" id="5632647">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632652">dst</span><span class="op" id="5632655">.</span><span class="ident" id="5632656">Pix</span><span class="op" id="5632659">[</span><span class="ident" id="5632660">i</span><span class="op" id="5632661">+</span><span class="num" id="5632662">2</span><span class="op" id="5632663">]</span>&nbsp;<span class="op" id="5632665">=</span>&nbsp;<span class="builtintype" id="5632667">uint8</span><span class="op" id="5632672">(</span><span class="op" id="5632673">(</span><span class="ident" id="5632674">db</span><span class="op" id="5632676">*</span><span class="ident" id="5632677">a</span><span class="op" id="5632678">/</span><span class="ident" id="5632679">m</span>&nbsp;<span class="op" id="5632681">+</span>&nbsp;<span class="ident" id="5632683">sb</span><span class="op" id="5632685">)</span>&nbsp;<span class="op" id="5632687">&gt;&gt;</span>&nbsp;<span class="num" id="5632690">8</span><span class="op" id="5632691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632696">dst</span><span class="op" id="5632699">.</span><span class="ident" id="5632700">Pix</span><span class="op" id="5632703">[</span><span class="ident" id="5632704">i</span><span class="op" id="5632705">+</span><span class="num" id="5632706">3</span><span class="op" id="5632707">]</span>&nbsp;<span class="op" id="5632709">=</span>&nbsp;<span class="builtintype" id="5632711">uint8</span><span class="op" id="5632716">(</span><span class="op" id="5632717">(</span><span class="ident" id="5632718">da</span><span class="op" id="5632720">*</span><span class="ident" id="5632721">a</span><span class="op" id="5632722">/</span><span class="ident" id="5632723">m</span>&nbsp;<span class="op" id="5632725">+</span>&nbsp;<span class="ident" id="5632727">sa</span><span class="op" id="5632729">)</span>&nbsp;<span class="op" id="5632731">&gt;&gt;</span>&nbsp;<span class="num" id="5632734">8</span><span class="op" id="5632735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5632739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632743">i0</span>&nbsp;<span class="op" id="5632746">+=</span>&nbsp;<span class="ident" id="5632749">dst</span><span class="op" id="5632752">.</span><span class="ident" id="5632753">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632762">i1</span>&nbsp;<span class="op" id="5632765">+=</span>&nbsp;<span class="ident" id="5632768">dst</span><span class="op" id="5632771">.</span><span class="ident" id="5632772">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5632780">}</span><br>
<span class="lineno"></span><span class="op" id="5632782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5632785">func</span>&nbsp;<span class="ident" id="5632790">drawFillSrc</span><span class="op" id="5632801">(</span><span class="ident" id="5632802">dst</span>&nbsp;<span class="op" id="5632806">*</span><span class="ident" id="5632807">image</span><span class="op" id="5632812">.</span><span class="ident" id="5632813">RGBA</span><span class="op" id="5632817">,</span>&nbsp;<span class="ident" id="5632819">r</span>&nbsp;<span class="ident" id="5632821">image</span><span class="op" id="5632826">.</span><span class="ident" id="5632827">Rectangle</span><span class="op" id="5632836">,</span>&nbsp;<span class="ident" id="5632838">src</span>&nbsp;<span class="op" id="5632842">*</span><span class="ident" id="5632843">image</span><span class="op" id="5632848">.</span><span class="ident" id="5632849">Uniform</span><span class="op" id="5632856">)</span>&nbsp;<span class="op" id="5632858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5632861">sr</span><span class="op" id="5632863">,</span>&nbsp;<span class="ident" id="5632865">sg</span><span class="op" id="5632867">,</span>&nbsp;<span class="ident" id="5632869">sb</span><span class="op" id="5632871">,</span>&nbsp;<span class="ident" id="5632873">sa</span>&nbsp;<span class="op" id="5632876">:=</span>&nbsp;<span class="ident" id="5632879">src</span><span class="op" id="5632882">.</span><span class="ident" id="5632883">RGBA</span><span class="op" id="5632887">(</span><span class="op" id="5632888">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5632891">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5632993">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5633097">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633168">i0</span>&nbsp;<span class="op" id="5633171">:=</span>&nbsp;<span class="ident" id="5633174">dst</span><span class="op" id="5633177">.</span><span class="ident" id="5633178">PixOffset</span><span class="op" id="5633187">(</span><span class="ident" id="5633188">r</span><span class="op" id="5633189">.</span><span class="ident" id="5633190">Min</span><span class="op" id="5633193">.</span><span class="ident" id="5633194">X</span><span class="op" id="5633195">,</span>&nbsp;<span class="ident" id="5633197">r</span><span class="op" id="5633198">.</span><span class="ident" id="5633199">Min</span><span class="op" id="5633202">.</span><span class="ident" id="5633203">Y</span><span class="op" id="5633204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633207">i1</span>&nbsp;<span class="op" id="5633210">:=</span>&nbsp;<span class="ident" id="5633213">i0</span>&nbsp;<span class="op" id="5633216">+</span>&nbsp;<span class="ident" id="5633218">r</span><span class="op" id="5633219">.</span><span class="ident" id="5633220">Dx</span><span class="op" id="5633222">(</span><span class="op" id="5633223">)</span><span class="op" id="5633224">*</span><span class="num" id="5633225">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5633228">for</span>&nbsp;<span class="ident" id="5633232">i</span>&nbsp;<span class="op" id="5633234">:=</span>&nbsp;<span class="ident" id="5633237">i0</span><span class="op" id="5633239">;</span>&nbsp;<span class="ident" id="5633241">i</span>&nbsp;<span class="op" id="5633243">&lt;</span>&nbsp;<span class="ident" id="5633245">i1</span><span class="op" id="5633247">;</span>&nbsp;<span class="ident" id="5633249">i</span>&nbsp;<span class="op" id="5633251">+=</span>&nbsp;<span class="num" id="5633254">4</span>&nbsp;<span class="op" id="5633256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633260">dst</span><span class="op" id="5633263">.</span><span class="ident" id="5633264">Pix</span><span class="op" id="5633267">[</span><span class="ident" id="5633268">i</span><span class="op" id="5633269">+</span><span class="num" id="5633270">0</span><span class="op" id="5633271">]</span>&nbsp;<span class="op" id="5633273">=</span>&nbsp;<span class="builtintype" id="5633275">uint8</span><span class="op" id="5633280">(</span><span class="ident" id="5633281">sr</span>&nbsp;<span class="op" id="5633284">&gt;&gt;</span>&nbsp;<span class="num" id="5633287">8</span><span class="op" id="5633288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633292">dst</span><span class="op" id="5633295">.</span><span class="ident" id="5633296">Pix</span><span class="op" id="5633299">[</span><span class="ident" id="5633300">i</span><span class="op" id="5633301">+</span><span class="num" id="5633302">1</span><span class="op" id="5633303">]</span>&nbsp;<span class="op" id="5633305">=</span>&nbsp;<span class="builtintype" id="5633307">uint8</span><span class="op" id="5633312">(</span><span class="ident" id="5633313">sg</span>&nbsp;<span class="op" id="5633316">&gt;&gt;</span>&nbsp;<span class="num" id="5633319">8</span><span class="op" id="5633320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633324">dst</span><span class="op" id="5633327">.</span><span class="ident" id="5633328">Pix</span><span class="op" id="5633331">[</span><span class="ident" id="5633332">i</span><span class="op" id="5633333">+</span><span class="num" id="5633334">2</span><span class="op" id="5633335">]</span>&nbsp;<span class="op" id="5633337">=</span>&nbsp;<span class="builtintype" id="5633339">uint8</span><span class="op" id="5633344">(</span><span class="ident" id="5633345">sb</span>&nbsp;<span class="op" id="5633348">&gt;&gt;</span>&nbsp;<span class="num" id="5633351">8</span><span class="op" id="5633352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633356">dst</span><span class="op" id="5633359">.</span><span class="ident" id="5633360">Pix</span><span class="op" id="5633363">[</span><span class="ident" id="5633364">i</span><span class="op" id="5633365">+</span><span class="num" id="5633366">3</span><span class="op" id="5633367">]</span>&nbsp;<span class="op" id="5633369">=</span>&nbsp;<span class="builtintype" id="5633371">uint8</span><span class="op" id="5633376">(</span><span class="ident" id="5633377">sa</span>&nbsp;<span class="op" id="5633380">&gt;&gt;</span>&nbsp;<span class="num" id="5633383">8</span><span class="op" id="5633384">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5633387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633390">firstRow</span>&nbsp;<span class="op" id="5633399">:=</span>&nbsp;<span class="ident" id="5633402">dst</span><span class="op" id="5633405">.</span><span class="ident" id="5633406">Pix</span><span class="op" id="5633409">[</span><span class="ident" id="5633410">i0</span><span class="op" id="5633412">:</span><span class="ident" id="5633413">i1</span><span class="op" id="5633415">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5633418">for</span>&nbsp;<span class="ident" id="5633422">y</span>&nbsp;<span class="op" id="5633424">:=</span>&nbsp;<span class="ident" id="5633427">r</span><span class="op" id="5633428">.</span><span class="ident" id="5633429">Min</span><span class="op" id="5633432">.</span><span class="ident" id="5633433">Y</span>&nbsp;<span class="op" id="5633435">+</span>&nbsp;<span class="num" id="5633437">1</span><span class="op" id="5633438">;</span>&nbsp;<span class="ident" id="5633440">y</span>&nbsp;<span class="op" id="5633442">&lt;</span>&nbsp;<span class="ident" id="5633444">r</span><span class="op" id="5633445">.</span><span class="ident" id="5633446">Max</span><span class="op" id="5633449">.</span><span class="ident" id="5633450">Y</span><span class="op" id="5633451">;</span>&nbsp;<span class="ident" id="5633453">y</span><span class="op" id="5633454">++</span>&nbsp;<span class="op" id="5633457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633461">i0</span>&nbsp;<span class="op" id="5633464">+=</span>&nbsp;<span class="ident" id="5633467">dst</span><span class="op" id="5633470">.</span><span class="ident" id="5633471">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633480">i1</span>&nbsp;<span class="op" id="5633483">+=</span>&nbsp;<span class="ident" id="5633486">dst</span><span class="op" id="5633489">.</span><span class="ident" id="5633490">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5633499">copy</span><span class="op" id="5633503">(</span><span class="ident" id="5633504">dst</span><span class="op" id="5633507">.</span><span class="ident" id="5633508">Pix</span><span class="op" id="5633511">[</span><span class="ident" id="5633512">i0</span><span class="op" id="5633514">:</span><span class="ident" id="5633515">i1</span><span class="op" id="5633517">]</span><span class="op" id="5633518">,</span>&nbsp;<span class="ident" id="5633520">firstRow</span><span class="op" id="5633528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5633531">}</span><br>
<span class="lineno"></span><span class="op" id="5633533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5633536">func</span>&nbsp;<span class="ident" id="5633541">drawCopyOver</span><span class="op" id="5633553">(</span><span class="ident" id="5633554">dst</span>&nbsp;<span class="op" id="5633558">*</span><span class="ident" id="5633559">image</span><span class="op" id="5633564">.</span><span class="ident" id="5633565">RGBA</span><span class="op" id="5633569">,</span>&nbsp;<span class="ident" id="5633571">r</span>&nbsp;<span class="ident" id="5633573">image</span><span class="op" id="5633578">.</span><span class="ident" id="5633579">Rectangle</span><span class="op" id="5633588">,</span>&nbsp;<span class="ident" id="5633590">src</span>&nbsp;<span class="op" id="5633594">*</span><span class="ident" id="5633595">image</span><span class="op" id="5633600">.</span><span class="ident" id="5633601">RGBA</span><span class="op" id="5633605">,</span>&nbsp;<span class="ident" id="5633607">sp</span>&nbsp;<span class="ident" id="5633610">image</span><span class="op" id="5633615">.</span><span class="ident" id="5633616">Point</span><span class="op" id="5633621">)</span>&nbsp;<span class="op" id="5633623">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633626">dx</span><span class="op" id="5633628">,</span>&nbsp;<span class="ident" id="5633630">dy</span>&nbsp;<span class="op" id="5633633">:=</span>&nbsp;<span class="ident" id="5633636">r</span><span class="op" id="5633637">.</span><span class="ident" id="5633638">Dx</span><span class="op" id="5633640">(</span><span class="op" id="5633641">)</span><span class="op" id="5633642">,</span>&nbsp;<span class="ident" id="5633644">r</span><span class="op" id="5633645">.</span><span class="ident" id="5633646">Dy</span><span class="op" id="5633648">(</span><span class="op" id="5633649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633652">d0</span>&nbsp;<span class="op" id="5633655">:=</span>&nbsp;<span class="ident" id="5633658">dst</span><span class="op" id="5633661">.</span><span class="ident" id="5633662">PixOffset</span><span class="op" id="5633671">(</span><span class="ident" id="5633672">r</span><span class="op" id="5633673">.</span><span class="ident" id="5633674">Min</span><span class="op" id="5633677">.</span><span class="ident" id="5633678">X</span><span class="op" id="5633679">,</span>&nbsp;<span class="ident" id="5633681">r</span><span class="op" id="5633682">.</span><span class="ident" id="5633683">Min</span><span class="op" id="5633686">.</span><span class="ident" id="5633687">Y</span><span class="op" id="5633688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633691">s0</span>&nbsp;<span class="op" id="5633694">:=</span>&nbsp;<span class="ident" id="5633697">src</span><span class="op" id="5633700">.</span><span class="ident" id="5633701">PixOffset</span><span class="op" id="5633710">(</span><span class="ident" id="5633711">sp</span><span class="op" id="5633713">.</span><span class="ident" id="5633714">X</span><span class="op" id="5633715">,</span>&nbsp;<span class="ident" id="5633717">sp</span><span class="op" id="5633719">.</span><span class="ident" id="5633720">Y</span><span class="op" id="5633721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5633724">var</span>&nbsp;<span class="op" id="5633728">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633732">ddelta</span><span class="op" id="5633738">,</span>&nbsp;<span class="ident" id="5633740">sdelta</span>&nbsp;<span class="builtintype" id="5633747">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633753">i0</span><span class="op" id="5633755">,</span>&nbsp;<span class="ident" id="5633757">i1</span><span class="op" id="5633759">,</span>&nbsp;<span class="ident" id="5633761">idelta</span>&nbsp;<span class="builtintype" id="5633768">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5633773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5633776">if</span>&nbsp;<span class="ident" id="5633779">r</span><span class="op" id="5633780">.</span><span class="ident" id="5633781">Min</span><span class="op" id="5633784">.</span><span class="ident" id="5633785">Y</span>&nbsp;<span class="op" id="5633787">&lt;</span>&nbsp;<span class="ident" id="5633789">sp</span><span class="op" id="5633791">.</span><span class="ident" id="5633792">Y</span>&nbsp;<span class="op" id="5633794">||</span>&nbsp;<span class="ident" id="5633797">r</span><span class="op" id="5633798">.</span><span class="ident" id="5633799">Min</span><span class="op" id="5633802">.</span><span class="ident" id="5633803">Y</span>&nbsp;<span class="op" id="5633805">==</span>&nbsp;<span class="ident" id="5633808">sp</span><span class="op" id="5633810">.</span><span class="ident" id="5633811">Y</span>&nbsp;<span class="op" id="5633813">&amp;&amp;</span>&nbsp;<span class="ident" id="5633816">r</span><span class="op" id="5633817">.</span><span class="ident" id="5633818">Min</span><span class="op" id="5633821">.</span><span class="ident" id="5633822">X</span>&nbsp;<span class="op" id="5633824">&lt;=</span>&nbsp;<span class="ident" id="5633827">sp</span><span class="op" id="5633829">.</span><span class="ident" id="5633830">X</span>&nbsp;<span class="op" id="5633832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633836">ddelta</span>&nbsp;<span class="op" id="5633843">=</span>&nbsp;<span class="ident" id="5633845">dst</span><span class="op" id="5633848">.</span><span class="ident" id="5633849">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633858">sdelta</span>&nbsp;<span class="op" id="5633865">=</span>&nbsp;<span class="ident" id="5633867">src</span><span class="op" id="5633870">.</span><span class="ident" id="5633871">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5633880">i0</span><span class="op" id="5633882">,</span>&nbsp;<span class="ident" id="5633884">i1</span><span class="op" id="5633886">,</span>&nbsp;<span class="ident" id="5633888">idelta</span>&nbsp;<span class="op" id="5633895">=</span>&nbsp;<span class="num" id="5633897">0</span><span class="op" id="5633898">,</span>&nbsp;<span class="ident" id="5633900">dx</span><span class="op" id="5633902">*</span><span class="num" id="5633903">4</span><span class="op" id="5633904">,</span>&nbsp;<span class="op" id="5633906">+</span><span class="num" id="5633907">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5633910">}</span>&nbsp;<span class="keyword" id="5633912">else</span>&nbsp;<span class="op" id="5633917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5633921">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634029">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634129">d0</span>&nbsp;<span class="op" id="5634132">+=</span>&nbsp;<span class="op" id="5634135">(</span><span class="ident" id="5634136">dy</span>&nbsp;<span class="op" id="5634139">-</span>&nbsp;<span class="num" id="5634141">1</span><span class="op" id="5634142">)</span>&nbsp;<span class="op" id="5634144">*</span>&nbsp;<span class="ident" id="5634146">dst</span><span class="op" id="5634149">.</span><span class="ident" id="5634150">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634159">s0</span>&nbsp;<span class="op" id="5634162">+=</span>&nbsp;<span class="op" id="5634165">(</span><span class="ident" id="5634166">dy</span>&nbsp;<span class="op" id="5634169">-</span>&nbsp;<span class="num" id="5634171">1</span><span class="op" id="5634172">)</span>&nbsp;<span class="op" id="5634174">*</span>&nbsp;<span class="ident" id="5634176">src</span><span class="op" id="5634179">.</span><span class="ident" id="5634180">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634189">ddelta</span>&nbsp;<span class="op" id="5634196">=</span>&nbsp;<span class="op" id="5634198">-</span><span class="ident" id="5634199">dst</span><span class="op" id="5634202">.</span><span class="ident" id="5634203">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634212">sdelta</span>&nbsp;<span class="op" id="5634219">=</span>&nbsp;<span class="op" id="5634221">-</span><span class="ident" id="5634222">src</span><span class="op" id="5634225">.</span><span class="ident" id="5634226">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634235">i0</span><span class="op" id="5634237">,</span>&nbsp;<span class="ident" id="5634239">i1</span><span class="op" id="5634241">,</span>&nbsp;<span class="ident" id="5634243">idelta</span>&nbsp;<span class="op" id="5634250">=</span>&nbsp;<span class="op" id="5634252">(</span><span class="ident" id="5634253">dx</span><span class="op" id="5634255">-</span><span class="num" id="5634256">1</span><span class="op" id="5634257">)</span><span class="op" id="5634258">*</span><span class="num" id="5634259">4</span><span class="op" id="5634260">,</span>&nbsp;<span class="op" id="5634262">-</span><span class="num" id="5634263">4</span><span class="op" id="5634264">,</span>&nbsp;<span class="op" id="5634266">-</span><span class="num" id="5634267">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634270">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5634273">for</span>&nbsp;<span class="op" id="5634277">;</span>&nbsp;<span class="ident" id="5634279">dy</span>&nbsp;<span class="op" id="5634282">&gt;</span>&nbsp;<span class="num" id="5634284">0</span><span class="op" id="5634285">;</span>&nbsp;<span class="ident" id="5634287">dy</span><span class="op" id="5634289">--</span>&nbsp;<span class="op" id="5634292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634296">dpix</span>&nbsp;<span class="op" id="5634301">:=</span>&nbsp;<span class="ident" id="5634304">dst</span><span class="op" id="5634307">.</span><span class="ident" id="5634308">Pix</span><span class="op" id="5634311">[</span><span class="ident" id="5634312">d0</span><span class="op" id="5634314">:</span><span class="op" id="5634315">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634319">spix</span>&nbsp;<span class="op" id="5634324">:=</span>&nbsp;<span class="ident" id="5634327">src</span><span class="op" id="5634330">.</span><span class="ident" id="5634331">Pix</span><span class="op" id="5634334">[</span><span class="ident" id="5634335">s0</span><span class="op" id="5634337">:</span><span class="op" id="5634338">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5634342">for</span>&nbsp;<span class="ident" id="5634346">i</span>&nbsp;<span class="op" id="5634348">:=</span>&nbsp;<span class="ident" id="5634351">i0</span><span class="op" id="5634353">;</span>&nbsp;<span class="ident" id="5634355">i</span>&nbsp;<span class="op" id="5634357">!=</span>&nbsp;<span class="ident" id="5634360">i1</span><span class="op" id="5634362">;</span>&nbsp;<span class="ident" id="5634364">i</span>&nbsp;<span class="op" id="5634366">+=</span>&nbsp;<span class="ident" id="5634369">idelta</span>&nbsp;<span class="op" id="5634376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634381">sr</span>&nbsp;<span class="op" id="5634384">:=</span>&nbsp;<span class="builtintype" id="5634387">uint32</span><span class="op" id="5634393">(</span><span class="ident" id="5634394">spix</span><span class="op" id="5634398">[</span><span class="ident" id="5634399">i</span><span class="op" id="5634400">+</span><span class="num" id="5634401">0</span><span class="op" id="5634402">]</span><span class="op" id="5634403">)</span>&nbsp;<span class="op" id="5634405">*</span>&nbsp;<span class="num" id="5634407">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634416">sg</span>&nbsp;<span class="op" id="5634419">:=</span>&nbsp;<span class="builtintype" id="5634422">uint32</span><span class="op" id="5634428">(</span><span class="ident" id="5634429">spix</span><span class="op" id="5634433">[</span><span class="ident" id="5634434">i</span><span class="op" id="5634435">+</span><span class="num" id="5634436">1</span><span class="op" id="5634437">]</span><span class="op" id="5634438">)</span>&nbsp;<span class="op" id="5634440">*</span>&nbsp;<span class="num" id="5634442">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634451">sb</span>&nbsp;<span class="op" id="5634454">:=</span>&nbsp;<span class="builtintype" id="5634457">uint32</span><span class="op" id="5634463">(</span><span class="ident" id="5634464">spix</span><span class="op" id="5634468">[</span><span class="ident" id="5634469">i</span><span class="op" id="5634470">+</span><span class="num" id="5634471">2</span><span class="op" id="5634472">]</span><span class="op" id="5634473">)</span>&nbsp;<span class="op" id="5634475">*</span>&nbsp;<span class="num" id="5634477">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634486">sa</span>&nbsp;<span class="op" id="5634489">:=</span>&nbsp;<span class="builtintype" id="5634492">uint32</span><span class="op" id="5634498">(</span><span class="ident" id="5634499">spix</span><span class="op" id="5634503">[</span><span class="ident" id="5634504">i</span><span class="op" id="5634505">+</span><span class="num" id="5634506">3</span><span class="op" id="5634507">]</span><span class="op" id="5634508">)</span>&nbsp;<span class="op" id="5634510">*</span>&nbsp;<span class="num" id="5634512">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634522">dr</span>&nbsp;<span class="op" id="5634525">:=</span>&nbsp;<span class="builtintype" id="5634528">uint32</span><span class="op" id="5634534">(</span><span class="ident" id="5634535">dpix</span><span class="op" id="5634539">[</span><span class="ident" id="5634540">i</span><span class="op" id="5634541">+</span><span class="num" id="5634542">0</span><span class="op" id="5634543">]</span><span class="op" id="5634544">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634549">dg</span>&nbsp;<span class="op" id="5634552">:=</span>&nbsp;<span class="builtintype" id="5634555">uint32</span><span class="op" id="5634561">(</span><span class="ident" id="5634562">dpix</span><span class="op" id="5634566">[</span><span class="ident" id="5634567">i</span><span class="op" id="5634568">+</span><span class="num" id="5634569">1</span><span class="op" id="5634570">]</span><span class="op" id="5634571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634576">db</span>&nbsp;<span class="op" id="5634579">:=</span>&nbsp;<span class="builtintype" id="5634582">uint32</span><span class="op" id="5634588">(</span><span class="ident" id="5634589">dpix</span><span class="op" id="5634593">[</span><span class="ident" id="5634594">i</span><span class="op" id="5634595">+</span><span class="num" id="5634596">2</span><span class="op" id="5634597">]</span><span class="op" id="5634598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634603">da</span>&nbsp;<span class="op" id="5634606">:=</span>&nbsp;<span class="builtintype" id="5634609">uint32</span><span class="op" id="5634615">(</span><span class="ident" id="5634616">dpix</span><span class="op" id="5634620">[</span><span class="ident" id="5634621">i</span><span class="op" id="5634622">+</span><span class="num" id="5634623">3</span><span class="op" id="5634624">]</span><span class="op" id="5634625">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5634631">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634691">a</span>&nbsp;<span class="op" id="5634693">:=</span>&nbsp;<span class="op" id="5634696">(</span><span class="ident" id="5634697">m</span>&nbsp;<span class="op" id="5634699">-</span>&nbsp;<span class="ident" id="5634701">sa</span><span class="op" id="5634703">)</span>&nbsp;<span class="op" id="5634705">*</span>&nbsp;<span class="num" id="5634707">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634717">dpix</span><span class="op" id="5634721">[</span><span class="ident" id="5634722">i</span><span class="op" id="5634723">+</span><span class="num" id="5634724">0</span><span class="op" id="5634725">]</span>&nbsp;<span class="op" id="5634727">=</span>&nbsp;<span class="builtintype" id="5634729">uint8</span><span class="op" id="5634734">(</span><span class="op" id="5634735">(</span><span class="ident" id="5634736">dr</span><span class="op" id="5634738">*</span><span class="ident" id="5634739">a</span><span class="op" id="5634740">/</span><span class="ident" id="5634741">m</span>&nbsp;<span class="op" id="5634743">+</span>&nbsp;<span class="ident" id="5634745">sr</span><span class="op" id="5634747">)</span>&nbsp;<span class="op" id="5634749">&gt;&gt;</span>&nbsp;<span class="num" id="5634752">8</span><span class="op" id="5634753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634758">dpix</span><span class="op" id="5634762">[</span><span class="ident" id="5634763">i</span><span class="op" id="5634764">+</span><span class="num" id="5634765">1</span><span class="op" id="5634766">]</span>&nbsp;<span class="op" id="5634768">=</span>&nbsp;<span class="builtintype" id="5634770">uint8</span><span class="op" id="5634775">(</span><span class="op" id="5634776">(</span><span class="ident" id="5634777">dg</span><span class="op" id="5634779">*</span><span class="ident" id="5634780">a</span><span class="op" id="5634781">/</span><span class="ident" id="5634782">m</span>&nbsp;<span class="op" id="5634784">+</span>&nbsp;<span class="ident" id="5634786">sg</span><span class="op" id="5634788">)</span>&nbsp;<span class="op" id="5634790">&gt;&gt;</span>&nbsp;<span class="num" id="5634793">8</span><span class="op" id="5634794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634799">dpix</span><span class="op" id="5634803">[</span><span class="ident" id="5634804">i</span><span class="op" id="5634805">+</span><span class="num" id="5634806">2</span><span class="op" id="5634807">]</span>&nbsp;<span class="op" id="5634809">=</span>&nbsp;<span class="builtintype" id="5634811">uint8</span><span class="op" id="5634816">(</span><span class="op" id="5634817">(</span><span class="ident" id="5634818">db</span><span class="op" id="5634820">*</span><span class="ident" id="5634821">a</span><span class="op" id="5634822">/</span><span class="ident" id="5634823">m</span>&nbsp;<span class="op" id="5634825">+</span>&nbsp;<span class="ident" id="5634827">sb</span><span class="op" id="5634829">)</span>&nbsp;<span class="op" id="5634831">&gt;&gt;</span>&nbsp;<span class="num" id="5634834">8</span><span class="op" id="5634835">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634840">dpix</span><span class="op" id="5634844">[</span><span class="ident" id="5634845">i</span><span class="op" id="5634846">+</span><span class="num" id="5634847">3</span><span class="op" id="5634848">]</span>&nbsp;<span class="op" id="5634850">=</span>&nbsp;<span class="builtintype" id="5634852">uint8</span><span class="op" id="5634857">(</span><span class="op" id="5634858">(</span><span class="ident" id="5634859">da</span><span class="op" id="5634861">*</span><span class="ident" id="5634862">a</span><span class="op" id="5634863">/</span><span class="ident" id="5634864">m</span>&nbsp;<span class="op" id="5634866">+</span>&nbsp;<span class="ident" id="5634868">sa</span><span class="op" id="5634870">)</span>&nbsp;<span class="op" id="5634872">&gt;&gt;</span>&nbsp;<span class="num" id="5634875">8</span><span class="op" id="5634876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634884">d0</span>&nbsp;<span class="op" id="5634887">+=</span>&nbsp;<span class="ident" id="5634890">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5634899">s0</span>&nbsp;<span class="op" id="5634902">+=</span>&nbsp;<span class="ident" id="5634905">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5634913">}</span><br>
<span class="lineno">305</span><span class="op" id="5634915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5634918">func</span>&nbsp;<span class="ident" id="5634923">drawCopySrc</span><span class="op" id="5634934">(</span><span class="ident" id="5634935">dst</span>&nbsp;<span class="op" id="5634939">*</span><span class="ident" id="5634940">image</span><span class="op" id="5634945">.</span><span class="ident" id="5634946">RGBA</span><span class="op" id="5634950">,</span>&nbsp;<span class="ident" id="5634952">r</span>&nbsp;<span class="ident" id="5634954">image</span><span class="op" id="5634959">.</span><span class="ident" id="5634960">Rectangle</span><span class="op" id="5634969">,</span>&nbsp;<span class="ident" id="5634971">src</span>&nbsp;<span class="op" id="5634975">*</span><span class="ident" id="5634976">image</span><span class="op" id="5634981">.</span><span class="ident" id="5634982">RGBA</span><span class="op" id="5634986">,</span>&nbsp;<span class="ident" id="5634988">sp</span>&nbsp;<span class="ident" id="5634991">image</span><span class="op" id="5634996">.</span><span class="ident" id="5634997">Point</span><span class="op" id="5635002">)</span>&nbsp;<span class="op" id="5635004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635007">n</span><span class="op" id="5635008">,</span>&nbsp;<span class="ident" id="5635010">dy</span>&nbsp;<span class="op" id="5635013">:=</span>&nbsp;<span class="num" id="5635016">4</span><span class="op" id="5635017">*</span><span class="ident" id="5635018">r</span><span class="op" id="5635019">.</span><span class="ident" id="5635020">Dx</span><span class="op" id="5635022">(</span><span class="op" id="5635023">)</span><span class="op" id="5635024">,</span>&nbsp;<span class="ident" id="5635026">r</span><span class="op" id="5635027">.</span><span class="ident" id="5635028">Dy</span><span class="op" id="5635030">(</span><span class="op" id="5635031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635034">d0</span>&nbsp;<span class="op" id="5635037">:=</span>&nbsp;<span class="ident" id="5635040">dst</span><span class="op" id="5635043">.</span><span class="ident" id="5635044">PixOffset</span><span class="op" id="5635053">(</span><span class="ident" id="5635054">r</span><span class="op" id="5635055">.</span><span class="ident" id="5635056">Min</span><span class="op" id="5635059">.</span><span class="ident" id="5635060">X</span><span class="op" id="5635061">,</span>&nbsp;<span class="ident" id="5635063">r</span><span class="op" id="5635064">.</span><span class="ident" id="5635065">Min</span><span class="op" id="5635068">.</span><span class="ident" id="5635069">Y</span><span class="op" id="5635070">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635073">s0</span>&nbsp;<span class="op" id="5635076">:=</span>&nbsp;<span class="ident" id="5635079">src</span><span class="op" id="5635082">.</span><span class="ident" id="5635083">PixOffset</span><span class="op" id="5635092">(</span><span class="ident" id="5635093">sp</span><span class="op" id="5635095">.</span><span class="ident" id="5635096">X</span><span class="op" id="5635097">,</span>&nbsp;<span class="ident" id="5635099">sp</span><span class="op" id="5635101">.</span><span class="ident" id="5635102">Y</span><span class="op" id="5635103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635106">var</span>&nbsp;<span class="ident" id="5635110">ddelta</span><span class="op" id="5635116">,</span>&nbsp;<span class="ident" id="5635118">sdelta</span>&nbsp;<span class="builtintype" id="5635125">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635130">if</span>&nbsp;<span class="ident" id="5635133">r</span><span class="op" id="5635134">.</span><span class="ident" id="5635135">Min</span><span class="op" id="5635138">.</span><span class="ident" id="5635139">Y</span>&nbsp;<span class="op" id="5635141">&lt;=</span>&nbsp;<span class="ident" id="5635144">sp</span><span class="op" id="5635146">.</span><span class="ident" id="5635147">Y</span>&nbsp;<span class="op" id="5635149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635153">ddelta</span>&nbsp;<span class="op" id="5635160">=</span>&nbsp;<span class="ident" id="5635162">dst</span><span class="op" id="5635165">.</span><span class="ident" id="5635166">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635175">sdelta</span>&nbsp;<span class="op" id="5635182">=</span>&nbsp;<span class="ident" id="5635184">src</span><span class="op" id="5635187">.</span><span class="ident" id="5635188">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635196">}</span>&nbsp;<span class="keyword" id="5635198">else</span>&nbsp;<span class="op" id="5635203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5635207">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5635307">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5635403">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635499">d0</span>&nbsp;<span class="op" id="5635502">+=</span>&nbsp;<span class="op" id="5635505">(</span><span class="ident" id="5635506">dy</span>&nbsp;<span class="op" id="5635509">-</span>&nbsp;<span class="num" id="5635511">1</span><span class="op" id="5635512">)</span>&nbsp;<span class="op" id="5635514">*</span>&nbsp;<span class="ident" id="5635516">dst</span><span class="op" id="5635519">.</span><span class="ident" id="5635520">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635529">s0</span>&nbsp;<span class="op" id="5635532">+=</span>&nbsp;<span class="op" id="5635535">(</span><span class="ident" id="5635536">dy</span>&nbsp;<span class="op" id="5635539">-</span>&nbsp;<span class="num" id="5635541">1</span><span class="op" id="5635542">)</span>&nbsp;<span class="op" id="5635544">*</span>&nbsp;<span class="ident" id="5635546">src</span><span class="op" id="5635549">.</span><span class="ident" id="5635550">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635559">ddelta</span>&nbsp;<span class="op" id="5635566">=</span>&nbsp;<span class="op" id="5635568">-</span><span class="ident" id="5635569">dst</span><span class="op" id="5635572">.</span><span class="ident" id="5635573">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635582">sdelta</span>&nbsp;<span class="op" id="5635589">=</span>&nbsp;<span class="op" id="5635591">-</span><span class="ident" id="5635592">src</span><span class="op" id="5635595">.</span><span class="ident" id="5635596">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5635607">for</span>&nbsp;<span class="op" id="5635611">;</span>&nbsp;<span class="ident" id="5635613">dy</span>&nbsp;<span class="op" id="5635616">&gt;</span>&nbsp;<span class="num" id="5635618">0</span><span class="op" id="5635619">;</span>&nbsp;<span class="ident" id="5635621">dy</span><span class="op" id="5635623">--</span>&nbsp;<span class="op" id="5635626">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5635630">copy</span><span class="op" id="5635634">(</span><span class="ident" id="5635635">dst</span><span class="op" id="5635638">.</span><span class="ident" id="5635639">Pix</span><span class="op" id="5635642">[</span><span class="ident" id="5635643">d0</span><span class="op" id="5635645">:</span><span class="ident" id="5635646">d0</span><span class="op" id="5635648">+</span><span class="ident" id="5635649">n</span><span class="op" id="5635650">]</span><span class="op" id="5635651">,</span>&nbsp;<span class="ident" id="5635653">src</span><span class="op" id="5635656">.</span><span class="ident" id="5635657">Pix</span><span class="op" id="5635660">[</span><span class="ident" id="5635661">s0</span><span class="op" id="5635663">:</span><span class="ident" id="5635664">s0</span><span class="op" id="5635666">+</span><span class="ident" id="5635667">n</span><span class="op" id="5635668">]</span><span class="op" id="5635669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635673">d0</span>&nbsp;<span class="op" id="5635676">+=</span>&nbsp;<span class="ident" id="5635679">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635688">s0</span>&nbsp;<span class="op" id="5635691">+=</span>&nbsp;<span class="ident" id="5635694">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5635702">}</span><br>
<span class="lineno"></span><span class="op" id="5635704">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5635707">func</span>&nbsp;<span class="ident" id="5635712">drawNRGBAOver</span><span class="op" id="5635725">(</span><span class="ident" id="5635726">dst</span>&nbsp;<span class="op" id="5635730">*</span><span class="ident" id="5635731">image</span><span class="op" id="5635736">.</span><span class="ident" id="5635737">RGBA</span><span class="op" id="5635741">,</span>&nbsp;<span class="ident" id="5635743">r</span>&nbsp;<span class="ident" id="5635745">image</span><span class="op" id="5635750">.</span><span class="ident" id="5635751">Rectangle</span><span class="op" id="5635760">,</span>&nbsp;<span class="ident" id="5635762">src</span>&nbsp;<span class="op" id="5635766">*</span><span class="ident" id="5635767">image</span><span class="op" id="5635772">.</span><span class="ident" id="5635773">NRGBA</span><span class="op" id="5635778">,</span>&nbsp;<span class="ident" id="5635780">sp</span>&nbsp;<span class="ident" id="5635783">image</span><span class="op" id="5635788">.</span><span class="ident" id="5635789">Point</span><span class="op" id="5635794">)</span>&nbsp;<span class="op" id="5635796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635799">i0</span>&nbsp;<span class="op" id="5635802">:=</span>&nbsp;<span class="op" id="5635805">(</span><span class="ident" id="5635806">r</span><span class="op" id="5635807">.</span><span class="ident" id="5635808">Min</span><span class="op" id="5635811">.</span><span class="ident" id="5635812">X</span>&nbsp;<span class="op" id="5635814">-</span>&nbsp;<span class="ident" id="5635816">dst</span><span class="op" id="5635819">.</span><span class="ident" id="5635820">Rect</span><span class="op" id="5635824">.</span><span class="ident" id="5635825">Min</span><span class="op" id="5635828">.</span><span class="ident" id="5635829">X</span><span class="op" id="5635830">)</span>&nbsp;<span class="op" id="5635832">*</span>&nbsp;<span class="num" id="5635834">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635837">i1</span>&nbsp;<span class="op" id="5635840">:=</span>&nbsp;<span class="op" id="5635843">(</span><span class="ident" id="5635844">r</span><span class="op" id="5635845">.</span><span class="ident" id="5635846">Max</span><span class="op" id="5635849">.</span><span class="ident" id="5635850">X</span>&nbsp;<span class="op" id="5635852">-</span>&nbsp;<span class="ident" id="5635854">dst</span><span class="op" id="5635857">.</span><span class="ident" id="5635858">Rect</span><span class="op" id="5635862">.</span><span class="ident" id="5635863">Min</span><span class="op" id="5635866">.</span><span class="ident" id="5635867">X</span><span class="op" id="5635868">)</span>&nbsp;<span class="op" id="5635870">*</span>&nbsp;<span class="num" id="5635872">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635875">si0</span>&nbsp;<span class="op" id="5635879">:=</span>&nbsp;<span class="op" id="5635882">(</span><span class="ident" id="5635883">sp</span><span class="op" id="5635885">.</span><span class="ident" id="5635886">X</span>&nbsp;<span class="op" id="5635888">-</span>&nbsp;<span class="ident" id="5635890">src</span><span class="op" id="5635893">.</span><span class="ident" id="5635894">Rect</span><span class="op" id="5635898">.</span><span class="ident" id="5635899">Min</span><span class="op" id="5635902">.</span><span class="ident" id="5635903">X</span><span class="op" id="5635904">)</span>&nbsp;<span class="op" id="5635906">*</span>&nbsp;<span class="num" id="5635908">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635911">yMax</span>&nbsp;<span class="op" id="5635916">:=</span>&nbsp;<span class="ident" id="5635919">r</span><span class="op" id="5635920">.</span><span class="ident" id="5635921">Max</span><span class="op" id="5635924">.</span><span class="ident" id="5635925">Y</span>&nbsp;<span class="op" id="5635927">-</span>&nbsp;<span class="ident" id="5635929">dst</span><span class="op" id="5635932">.</span><span class="ident" id="5635933">Rect</span><span class="op" id="5635937">.</span><span class="ident" id="5635938">Min</span><span class="op" id="5635941">.</span><span class="ident" id="5635942">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635946">y</span>&nbsp;<span class="op" id="5635948">:=</span>&nbsp;<span class="ident" id="5635951">r</span><span class="op" id="5635952">.</span><span class="ident" id="5635953">Min</span><span class="op" id="5635956">.</span><span class="ident" id="5635957">Y</span>&nbsp;<span class="op" id="5635959">-</span>&nbsp;<span class="ident" id="5635961">dst</span><span class="op" id="5635964">.</span><span class="ident" id="5635965">Rect</span><span class="op" id="5635969">.</span><span class="ident" id="5635970">Min</span><span class="op" id="5635973">.</span><span class="ident" id="5635974">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5635977">sy</span>&nbsp;<span class="op" id="5635980">:=</span>&nbsp;<span class="ident" id="5635983">sp</span><span class="op" id="5635985">.</span><span class="ident" id="5635986">Y</span>&nbsp;<span class="op" id="5635988">-</span>&nbsp;<span class="ident" id="5635990">src</span><span class="op" id="5635993">.</span><span class="ident" id="5635994">Rect</span><span class="op" id="5635998">.</span><span class="ident" id="5635999">Min</span><span class="op" id="5636002">.</span><span class="ident" id="5636003">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636006">for</span>&nbsp;<span class="op" id="5636010">;</span>&nbsp;<span class="ident" id="5636012">y</span>&nbsp;<span class="op" id="5636014">!=</span>&nbsp;<span class="ident" id="5636017">yMax</span><span class="op" id="5636021">;</span>&nbsp;<span class="ident" id="5636023">y</span><span class="op" id="5636024">,</span>&nbsp;<span class="ident" id="5636026">sy</span>&nbsp;<span class="op" id="5636029">=</span>&nbsp;<span class="ident" id="5636031">y</span><span class="op" id="5636032">+</span><span class="num" id="5636033">1</span><span class="op" id="5636034">,</span>&nbsp;<span class="ident" id="5636036">sy</span><span class="op" id="5636038">+</span><span class="num" id="5636039">1</span>&nbsp;<span class="op" id="5636041">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636045">dpix</span>&nbsp;<span class="op" id="5636050">:=</span>&nbsp;<span class="ident" id="5636053">dst</span><span class="op" id="5636056">.</span><span class="ident" id="5636057">Pix</span><span class="op" id="5636060">[</span><span class="ident" id="5636061">y</span><span class="op" id="5636062">*</span><span class="ident" id="5636063">dst</span><span class="op" id="5636066">.</span><span class="ident" id="5636067">Stride</span><span class="op" id="5636073">:</span><span class="op" id="5636074">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636078">spix</span>&nbsp;<span class="op" id="5636083">:=</span>&nbsp;<span class="ident" id="5636086">src</span><span class="op" id="5636089">.</span><span class="ident" id="5636090">Pix</span><span class="op" id="5636093">[</span><span class="ident" id="5636094">sy</span><span class="op" id="5636096">*</span><span class="ident" id="5636097">src</span><span class="op" id="5636100">.</span><span class="ident" id="5636101">Stride</span><span class="op" id="5636107">:</span><span class="op" id="5636108">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5636113">for</span>&nbsp;<span class="ident" id="5636117">i</span><span class="op" id="5636118">,</span>&nbsp;<span class="ident" id="5636120">si</span>&nbsp;<span class="op" id="5636123">:=</span>&nbsp;<span class="ident" id="5636126">i0</span><span class="op" id="5636128">,</span>&nbsp;<span class="ident" id="5636130">si0</span><span class="op" id="5636133">;</span>&nbsp;<span class="ident" id="5636135">i</span>&nbsp;<span class="op" id="5636137">&lt;</span>&nbsp;<span class="ident" id="5636139">i1</span><span class="op" id="5636141">;</span>&nbsp;<span class="ident" id="5636143">i</span><span class="op" id="5636144">,</span>&nbsp;<span class="ident" id="5636146">si</span>&nbsp;<span class="op" id="5636149">=</span>&nbsp;<span class="ident" id="5636151">i</span><span class="op" id="5636152">+</span><span class="num" id="5636153">4</span><span class="op" id="5636154">,</span>&nbsp;<span class="ident" id="5636156">si</span><span class="op" id="5636158">+</span><span class="num" id="5636159">4</span>&nbsp;<span class="op" id="5636161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636166">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636234">sa</span>&nbsp;<span class="op" id="5636237">:=</span>&nbsp;<span class="builtintype" id="5636240">uint32</span><span class="op" id="5636246">(</span><span class="ident" id="5636247">spix</span><span class="op" id="5636251">[</span><span class="ident" id="5636252">si</span><span class="op" id="5636254">+</span><span class="num" id="5636255">3</span><span class="op" id="5636256">]</span><span class="op" id="5636257">)</span>&nbsp;<span class="op" id="5636259">*</span>&nbsp;<span class="num" id="5636261">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636270">sr</span>&nbsp;<span class="op" id="5636273">:=</span>&nbsp;<span class="builtintype" id="5636276">uint32</span><span class="op" id="5636282">(</span><span class="ident" id="5636283">spix</span><span class="op" id="5636287">[</span><span class="ident" id="5636288">si</span><span class="op" id="5636290">+</span><span class="num" id="5636291">0</span><span class="op" id="5636292">]</span><span class="op" id="5636293">)</span>&nbsp;<span class="op" id="5636295">*</span>&nbsp;<span class="ident" id="5636297">sa</span>&nbsp;<span class="op" id="5636300">/</span>&nbsp;<span class="num" id="5636302">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636310">sg</span>&nbsp;<span class="op" id="5636313">:=</span>&nbsp;<span class="builtintype" id="5636316">uint32</span><span class="op" id="5636322">(</span><span class="ident" id="5636323">spix</span><span class="op" id="5636327">[</span><span class="ident" id="5636328">si</span><span class="op" id="5636330">+</span><span class="num" id="5636331">1</span><span class="op" id="5636332">]</span><span class="op" id="5636333">)</span>&nbsp;<span class="op" id="5636335">*</span>&nbsp;<span class="ident" id="5636337">sa</span>&nbsp;<span class="op" id="5636340">/</span>&nbsp;<span class="num" id="5636342">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636350">sb</span>&nbsp;<span class="op" id="5636353">:=</span>&nbsp;<span class="builtintype" id="5636356">uint32</span><span class="op" id="5636362">(</span><span class="ident" id="5636363">spix</span><span class="op" id="5636367">[</span><span class="ident" id="5636368">si</span><span class="op" id="5636370">+</span><span class="num" id="5636371">2</span><span class="op" id="5636372">]</span><span class="op" id="5636373">)</span>&nbsp;<span class="op" id="5636375">*</span>&nbsp;<span class="ident" id="5636377">sa</span>&nbsp;<span class="op" id="5636380">/</span>&nbsp;<span class="num" id="5636382">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636391">dr</span>&nbsp;<span class="op" id="5636394">:=</span>&nbsp;<span class="builtintype" id="5636397">uint32</span><span class="op" id="5636403">(</span><span class="ident" id="5636404">dpix</span><span class="op" id="5636408">[</span><span class="ident" id="5636409">i</span><span class="op" id="5636410">+</span><span class="num" id="5636411">0</span><span class="op" id="5636412">]</span><span class="op" id="5636413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636418">dg</span>&nbsp;<span class="op" id="5636421">:=</span>&nbsp;<span class="builtintype" id="5636424">uint32</span><span class="op" id="5636430">(</span><span class="ident" id="5636431">dpix</span><span class="op" id="5636435">[</span><span class="ident" id="5636436">i</span><span class="op" id="5636437">+</span><span class="num" id="5636438">1</span><span class="op" id="5636439">]</span><span class="op" id="5636440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636445">db</span>&nbsp;<span class="op" id="5636448">:=</span>&nbsp;<span class="builtintype" id="5636451">uint32</span><span class="op" id="5636457">(</span><span class="ident" id="5636458">dpix</span><span class="op" id="5636462">[</span><span class="ident" id="5636463">i</span><span class="op" id="5636464">+</span><span class="num" id="5636465">2</span><span class="op" id="5636466">]</span><span class="op" id="5636467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636472">da</span>&nbsp;<span class="op" id="5636475">:=</span>&nbsp;<span class="builtintype" id="5636478">uint32</span><span class="op" id="5636484">(</span><span class="ident" id="5636485">dpix</span><span class="op" id="5636489">[</span><span class="ident" id="5636490">i</span><span class="op" id="5636491">+</span><span class="num" id="5636492">3</span><span class="op" id="5636493">]</span><span class="op" id="5636494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5636500">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636560">a</span>&nbsp;<span class="op" id="5636562">:=</span>&nbsp;<span class="op" id="5636565">(</span><span class="ident" id="5636566">m</span>&nbsp;<span class="op" id="5636568">-</span>&nbsp;<span class="ident" id="5636570">sa</span><span class="op" id="5636572">)</span>&nbsp;<span class="op" id="5636574">*</span>&nbsp;<span class="num" id="5636576">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636586">dpix</span><span class="op" id="5636590">[</span><span class="ident" id="5636591">i</span><span class="op" id="5636592">+</span><span class="num" id="5636593">0</span><span class="op" id="5636594">]</span>&nbsp;<span class="op" id="5636596">=</span>&nbsp;<span class="builtintype" id="5636598">uint8</span><span class="op" id="5636603">(</span><span class="op" id="5636604">(</span><span class="ident" id="5636605">dr</span><span class="op" id="5636607">*</span><span class="ident" id="5636608">a</span><span class="op" id="5636609">/</span><span class="ident" id="5636610">m</span>&nbsp;<span class="op" id="5636612">+</span>&nbsp;<span class="ident" id="5636614">sr</span><span class="op" id="5636616">)</span>&nbsp;<span class="op" id="5636618">&gt;&gt;</span>&nbsp;<span class="num" id="5636621">8</span><span class="op" id="5636622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636627">dpix</span><span class="op" id="5636631">[</span><span class="ident" id="5636632">i</span><span class="op" id="5636633">+</span><span class="num" id="5636634">1</span><span class="op" id="5636635">]</span>&nbsp;<span class="op" id="5636637">=</span>&nbsp;<span class="builtintype" id="5636639">uint8</span><span class="op" id="5636644">(</span><span class="op" id="5636645">(</span><span class="ident" id="5636646">dg</span><span class="op" id="5636648">*</span><span class="ident" id="5636649">a</span><span class="op" id="5636650">/</span><span class="ident" id="5636651">m</span>&nbsp;<span class="op" id="5636653">+</span>&nbsp;<span class="ident" id="5636655">sg</span><span class="op" id="5636657">)</span>&nbsp;<span class="op" id="5636659">&gt;&gt;</span>&nbsp;<span class="num" id="5636662">8</span><span class="op" id="5636663">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636668">dpix</span><span class="op" id="5636672">[</span><span class="ident" id="5636673">i</span><span class="op" id="5636674">+</span><span class="num" id="5636675">2</span><span class="op" id="5636676">]</span>&nbsp;<span class="op" id="5636678">=</span>&nbsp;<span class="builtintype" id="5636680">uint8</span><span class="op" id="5636685">(</span><span class="op" id="5636686">(</span><span class="ident" id="5636687">db</span><span class="op" id="5636689">*</span><span class="ident" id="5636690">a</span><span class="op" id="5636691">/</span><span class="ident" id="5636692">m</span>&nbsp;<span class="op" id="5636694">+</span>&nbsp;<span class="ident" id="5636696">sb</span><span class="op" id="5636698">)</span>&nbsp;<span class="op" id="5636700">&gt;&gt;</span>&nbsp;<span class="num" id="5636703">8</span><span class="op" id="5636704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636709">dpix</span><span class="op" id="5636713">[</span><span class="ident" id="5636714">i</span><span class="op" id="5636715">+</span><span class="num" id="5636716">3</span><span class="op" id="5636717">]</span>&nbsp;<span class="op" id="5636719">=</span>&nbsp;<span class="builtintype" id="5636721">uint8</span><span class="op" id="5636726">(</span><span class="op" id="5636727">(</span><span class="ident" id="5636728">da</span><span class="op" id="5636730">*</span><span class="ident" id="5636731">a</span><span class="op" id="5636732">/</span><span class="ident" id="5636733">m</span>&nbsp;<span class="op" id="5636735">+</span>&nbsp;<span class="ident" id="5636737">sa</span><span class="op" id="5636739">)</span>&nbsp;<span class="op" id="5636741">&gt;&gt;</span>&nbsp;<span class="num" id="5636744">8</span><span class="op" id="5636745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5636752">}</span><br>
<span class="lineno"></span><span class="op" id="5636754">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5636757">func</span>&nbsp;<span class="ident" id="5636762">drawNRGBASrc</span><span class="op" id="5636774">(</span><span class="ident" id="5636775">dst</span>&nbsp;<span class="op" id="5636779">*</span><span class="ident" id="5636780">image</span><span class="op" id="5636785">.</span><span class="ident" id="5636786">RGBA</span><span class="op" id="5636790">,</span>&nbsp;<span class="ident" id="5636792">r</span>&nbsp;<span class="ident" id="5636794">image</span><span class="op" id="5636799">.</span><span class="ident" id="5636800">Rectangle</span><span class="op" id="5636809">,</span>&nbsp;<span class="ident" id="5636811">src</span>&nbsp;<span class="op" id="5636815">*</span><span class="ident" id="5636816">image</span><span class="op" id="5636821">.</span><span class="ident" id="5636822">NRGBA</span><span class="op" id="5636827">,</span>&nbsp;<span class="ident" id="5636829">sp</span>&nbsp;<span class="ident" id="5636832">image</span><span class="op" id="5636837">.</span><span class="ident" id="5636838">Point</span><span class="op" id="5636843">)</span>&nbsp;<span class="op" id="5636845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636848">i0</span>&nbsp;<span class="op" id="5636851">:=</span>&nbsp;<span class="op" id="5636854">(</span><span class="ident" id="5636855">r</span><span class="op" id="5636856">.</span><span class="ident" id="5636857">Min</span><span class="op" id="5636860">.</span><span class="ident" id="5636861">X</span>&nbsp;<span class="op" id="5636863">-</span>&nbsp;<span class="ident" id="5636865">dst</span><span class="op" id="5636868">.</span><span class="ident" id="5636869">Rect</span><span class="op" id="5636873">.</span><span class="ident" id="5636874">Min</span><span class="op" id="5636877">.</span><span class="ident" id="5636878">X</span><span class="op" id="5636879">)</span>&nbsp;<span class="op" id="5636881">*</span>&nbsp;<span class="num" id="5636883">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636886">i1</span>&nbsp;<span class="op" id="5636889">:=</span>&nbsp;<span class="op" id="5636892">(</span><span class="ident" id="5636893">r</span><span class="op" id="5636894">.</span><span class="ident" id="5636895">Max</span><span class="op" id="5636898">.</span><span class="ident" id="5636899">X</span>&nbsp;<span class="op" id="5636901">-</span>&nbsp;<span class="ident" id="5636903">dst</span><span class="op" id="5636906">.</span><span class="ident" id="5636907">Rect</span><span class="op" id="5636911">.</span><span class="ident" id="5636912">Min</span><span class="op" id="5636915">.</span><span class="ident" id="5636916">X</span><span class="op" id="5636917">)</span>&nbsp;<span class="op" id="5636919">*</span>&nbsp;<span class="num" id="5636921">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636924">si0</span>&nbsp;<span class="op" id="5636928">:=</span>&nbsp;<span class="op" id="5636931">(</span><span class="ident" id="5636932">sp</span><span class="op" id="5636934">.</span><span class="ident" id="5636935">X</span>&nbsp;<span class="op" id="5636937">-</span>&nbsp;<span class="ident" id="5636939">src</span><span class="op" id="5636942">.</span><span class="ident" id="5636943">Rect</span><span class="op" id="5636947">.</span><span class="ident" id="5636948">Min</span><span class="op" id="5636951">.</span><span class="ident" id="5636952">X</span><span class="op" id="5636953">)</span>&nbsp;<span class="op" id="5636955">*</span>&nbsp;<span class="num" id="5636957">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636960">yMax</span>&nbsp;<span class="op" id="5636965">:=</span>&nbsp;<span class="ident" id="5636968">r</span><span class="op" id="5636969">.</span><span class="ident" id="5636970">Max</span><span class="op" id="5636973">.</span><span class="ident" id="5636974">Y</span>&nbsp;<span class="op" id="5636976">-</span>&nbsp;<span class="ident" id="5636978">dst</span><span class="op" id="5636981">.</span><span class="ident" id="5636982">Rect</span><span class="op" id="5636986">.</span><span class="ident" id="5636987">Min</span><span class="op" id="5636990">.</span><span class="ident" id="5636991">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5636995">y</span>&nbsp;<span class="op" id="5636997">:=</span>&nbsp;<span class="ident" id="5637000">r</span><span class="op" id="5637001">.</span><span class="ident" id="5637002">Min</span><span class="op" id="5637005">.</span><span class="ident" id="5637006">Y</span>&nbsp;<span class="op" id="5637008">-</span>&nbsp;<span class="ident" id="5637010">dst</span><span class="op" id="5637013">.</span><span class="ident" id="5637014">Rect</span><span class="op" id="5637018">.</span><span class="ident" id="5637019">Min</span><span class="op" id="5637022">.</span><span class="ident" id="5637023">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637026">sy</span>&nbsp;<span class="op" id="5637029">:=</span>&nbsp;<span class="ident" id="5637032">sp</span><span class="op" id="5637034">.</span><span class="ident" id="5637035">Y</span>&nbsp;<span class="op" id="5637037">-</span>&nbsp;<span class="ident" id="5637039">src</span><span class="op" id="5637042">.</span><span class="ident" id="5637043">Rect</span><span class="op" id="5637047">.</span><span class="ident" id="5637048">Min</span><span class="op" id="5637051">.</span><span class="ident" id="5637052">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637055">for</span>&nbsp;<span class="op" id="5637059">;</span>&nbsp;<span class="ident" id="5637061">y</span>&nbsp;<span class="op" id="5637063">!=</span>&nbsp;<span class="ident" id="5637066">yMax</span><span class="op" id="5637070">;</span>&nbsp;<span class="ident" id="5637072">y</span><span class="op" id="5637073">,</span>&nbsp;<span class="ident" id="5637075">sy</span>&nbsp;<span class="op" id="5637078">=</span>&nbsp;<span class="ident" id="5637080">y</span><span class="op" id="5637081">+</span><span class="num" id="5637082">1</span><span class="op" id="5637083">,</span>&nbsp;<span class="ident" id="5637085">sy</span><span class="op" id="5637087">+</span><span class="num" id="5637088">1</span>&nbsp;<span class="op" id="5637090">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637094">dpix</span>&nbsp;<span class="op" id="5637099">:=</span>&nbsp;<span class="ident" id="5637102">dst</span><span class="op" id="5637105">.</span><span class="ident" id="5637106">Pix</span><span class="op" id="5637109">[</span><span class="ident" id="5637110">y</span><span class="op" id="5637111">*</span><span class="ident" id="5637112">dst</span><span class="op" id="5637115">.</span><span class="ident" id="5637116">Stride</span><span class="op" id="5637122">:</span><span class="op" id="5637123">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637127">spix</span>&nbsp;<span class="op" id="5637132">:=</span>&nbsp;<span class="ident" id="5637135">src</span><span class="op" id="5637138">.</span><span class="ident" id="5637139">Pix</span><span class="op" id="5637142">[</span><span class="ident" id="5637143">sy</span><span class="op" id="5637145">*</span><span class="ident" id="5637146">src</span><span class="op" id="5637149">.</span><span class="ident" id="5637150">Stride</span><span class="op" id="5637156">:</span><span class="op" id="5637157">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637162">for</span>&nbsp;<span class="ident" id="5637166">i</span><span class="op" id="5637167">,</span>&nbsp;<span class="ident" id="5637169">si</span>&nbsp;<span class="op" id="5637172">:=</span>&nbsp;<span class="ident" id="5637175">i0</span><span class="op" id="5637177">,</span>&nbsp;<span class="ident" id="5637179">si0</span><span class="op" id="5637182">;</span>&nbsp;<span class="ident" id="5637184">i</span>&nbsp;<span class="op" id="5637186">&lt;</span>&nbsp;<span class="ident" id="5637188">i1</span><span class="op" id="5637190">;</span>&nbsp;<span class="ident" id="5637192">i</span><span class="op" id="5637193">,</span>&nbsp;<span class="ident" id="5637195">si</span>&nbsp;<span class="op" id="5637198">=</span>&nbsp;<span class="ident" id="5637200">i</span><span class="op" id="5637201">+</span><span class="num" id="5637202">4</span><span class="op" id="5637203">,</span>&nbsp;<span class="ident" id="5637205">si</span><span class="op" id="5637207">+</span><span class="num" id="5637208">4</span>&nbsp;<span class="op" id="5637210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637215">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637283">sa</span>&nbsp;<span class="op" id="5637286">:=</span>&nbsp;<span class="builtintype" id="5637289">uint32</span><span class="op" id="5637295">(</span><span class="ident" id="5637296">spix</span><span class="op" id="5637300">[</span><span class="ident" id="5637301">si</span><span class="op" id="5637303">+</span><span class="num" id="5637304">3</span><span class="op" id="5637305">]</span><span class="op" id="5637306">)</span>&nbsp;<span class="op" id="5637308">*</span>&nbsp;<span class="num" id="5637310">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637319">sr</span>&nbsp;<span class="op" id="5637322">:=</span>&nbsp;<span class="builtintype" id="5637325">uint32</span><span class="op" id="5637331">(</span><span class="ident" id="5637332">spix</span><span class="op" id="5637336">[</span><span class="ident" id="5637337">si</span><span class="op" id="5637339">+</span><span class="num" id="5637340">0</span><span class="op" id="5637341">]</span><span class="op" id="5637342">)</span>&nbsp;<span class="op" id="5637344">*</span>&nbsp;<span class="ident" id="5637346">sa</span>&nbsp;<span class="op" id="5637349">/</span>&nbsp;<span class="num" id="5637351">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637359">sg</span>&nbsp;<span class="op" id="5637362">:=</span>&nbsp;<span class="builtintype" id="5637365">uint32</span><span class="op" id="5637371">(</span><span class="ident" id="5637372">spix</span><span class="op" id="5637376">[</span><span class="ident" id="5637377">si</span><span class="op" id="5637379">+</span><span class="num" id="5637380">1</span><span class="op" id="5637381">]</span><span class="op" id="5637382">)</span>&nbsp;<span class="op" id="5637384">*</span>&nbsp;<span class="ident" id="5637386">sa</span>&nbsp;<span class="op" id="5637389">/</span>&nbsp;<span class="num" id="5637391">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637399">sb</span>&nbsp;<span class="op" id="5637402">:=</span>&nbsp;<span class="builtintype" id="5637405">uint32</span><span class="op" id="5637411">(</span><span class="ident" id="5637412">spix</span><span class="op" id="5637416">[</span><span class="ident" id="5637417">si</span><span class="op" id="5637419">+</span><span class="num" id="5637420">2</span><span class="op" id="5637421">]</span><span class="op" id="5637422">)</span>&nbsp;<span class="op" id="5637424">*</span>&nbsp;<span class="ident" id="5637426">sa</span>&nbsp;<span class="op" id="5637429">/</span>&nbsp;<span class="num" id="5637431">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637440">dpix</span><span class="op" id="5637444">[</span><span class="ident" id="5637445">i</span><span class="op" id="5637446">+</span><span class="num" id="5637447">0</span><span class="op" id="5637448">]</span>&nbsp;<span class="op" id="5637450">=</span>&nbsp;<span class="builtintype" id="5637452">uint8</span><span class="op" id="5637457">(</span><span class="ident" id="5637458">sr</span>&nbsp;<span class="op" id="5637461">&gt;&gt;</span>&nbsp;<span class="num" id="5637464">8</span><span class="op" id="5637465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637470">dpix</span><span class="op" id="5637474">[</span><span class="ident" id="5637475">i</span><span class="op" id="5637476">+</span><span class="num" id="5637477">1</span><span class="op" id="5637478">]</span>&nbsp;<span class="op" id="5637480">=</span>&nbsp;<span class="builtintype" id="5637482">uint8</span><span class="op" id="5637487">(</span><span class="ident" id="5637488">sg</span>&nbsp;<span class="op" id="5637491">&gt;&gt;</span>&nbsp;<span class="num" id="5637494">8</span><span class="op" id="5637495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637500">dpix</span><span class="op" id="5637504">[</span><span class="ident" id="5637505">i</span><span class="op" id="5637506">+</span><span class="num" id="5637507">2</span><span class="op" id="5637508">]</span>&nbsp;<span class="op" id="5637510">=</span>&nbsp;<span class="builtintype" id="5637512">uint8</span><span class="op" id="5637517">(</span><span class="ident" id="5637518">sb</span>&nbsp;<span class="op" id="5637521">&gt;&gt;</span>&nbsp;<span class="num" id="5637524">8</span><span class="op" id="5637525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637530">dpix</span><span class="op" id="5637534">[</span><span class="ident" id="5637535">i</span><span class="op" id="5637536">+</span><span class="num" id="5637537">3</span><span class="op" id="5637538">]</span>&nbsp;<span class="op" id="5637540">=</span>&nbsp;<span class="builtintype" id="5637542">uint8</span><span class="op" id="5637547">(</span><span class="ident" id="5637548">sa</span>&nbsp;<span class="op" id="5637551">&gt;&gt;</span>&nbsp;<span class="num" id="5637554">8</span><span class="op" id="5637555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637559">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637562">}</span><br>
<span class="lineno"></span><span class="op" id="5637564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637567">func</span>&nbsp;<span class="ident" id="5637572">drawYCbCr</span><span class="op" id="5637581">(</span><span class="ident" id="5637582">dst</span>&nbsp;<span class="op" id="5637586">*</span><span class="ident" id="5637587">image</span><span class="op" id="5637592">.</span><span class="ident" id="5637593">RGBA</span><span class="op" id="5637597">,</span>&nbsp;<span class="ident" id="5637599">r</span>&nbsp;<span class="ident" id="5637601">image</span><span class="op" id="5637606">.</span><span class="ident" id="5637607">Rectangle</span><span class="op" id="5637616">,</span>&nbsp;<span class="ident" id="5637618">src</span>&nbsp;<span class="op" id="5637622">*</span><span class="ident" id="5637623">image</span><span class="op" id="5637628">.</span><span class="ident" id="5637629">YCbCr</span><span class="op" id="5637634">,</span>&nbsp;<span class="ident" id="5637636">sp</span>&nbsp;<span class="ident" id="5637639">image</span><span class="op" id="5637644">.</span><span class="ident" id="5637645">Point</span><span class="op" id="5637650">)</span>&nbsp;<span class="op" id="5637652">(</span><span class="ident" id="5637653">ok</span>&nbsp;<span class="builtintype" id="5637656">bool</span><span class="op" id="5637660">)</span>&nbsp;<span class="op" id="5637662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637665">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637745">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637808">x0</span>&nbsp;<span class="op" id="5637811">:=</span>&nbsp;<span class="op" id="5637814">(</span><span class="ident" id="5637815">r</span><span class="op" id="5637816">.</span><span class="ident" id="5637817">Min</span><span class="op" id="5637820">.</span><span class="ident" id="5637821">X</span>&nbsp;<span class="op" id="5637823">-</span>&nbsp;<span class="ident" id="5637825">dst</span><span class="op" id="5637828">.</span><span class="ident" id="5637829">Rect</span><span class="op" id="5637833">.</span><span class="ident" id="5637834">Min</span><span class="op" id="5637837">.</span><span class="ident" id="5637838">X</span><span class="op" id="5637839">)</span>&nbsp;<span class="op" id="5637841">*</span>&nbsp;<span class="num" id="5637843">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637846">x1</span>&nbsp;<span class="op" id="5637849">:=</span>&nbsp;<span class="op" id="5637852">(</span><span class="ident" id="5637853">r</span><span class="op" id="5637854">.</span><span class="ident" id="5637855">Max</span><span class="op" id="5637858">.</span><span class="ident" id="5637859">X</span>&nbsp;<span class="op" id="5637861">-</span>&nbsp;<span class="ident" id="5637863">dst</span><span class="op" id="5637866">.</span><span class="ident" id="5637867">Rect</span><span class="op" id="5637871">.</span><span class="ident" id="5637872">Min</span><span class="op" id="5637875">.</span><span class="ident" id="5637876">X</span><span class="op" id="5637877">)</span>&nbsp;<span class="op" id="5637879">*</span>&nbsp;<span class="num" id="5637881">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637884">y0</span>&nbsp;<span class="op" id="5637887">:=</span>&nbsp;<span class="ident" id="5637890">r</span><span class="op" id="5637891">.</span><span class="ident" id="5637892">Min</span><span class="op" id="5637895">.</span><span class="ident" id="5637896">Y</span>&nbsp;<span class="op" id="5637898">-</span>&nbsp;<span class="ident" id="5637900">dst</span><span class="op" id="5637903">.</span><span class="ident" id="5637904">Rect</span><span class="op" id="5637908">.</span><span class="ident" id="5637909">Min</span><span class="op" id="5637912">.</span><span class="ident" id="5637913">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637916">y1</span>&nbsp;<span class="op" id="5637919">:=</span>&nbsp;<span class="ident" id="5637922">r</span><span class="op" id="5637923">.</span><span class="ident" id="5637924">Max</span><span class="op" id="5637927">.</span><span class="ident" id="5637928">Y</span>&nbsp;<span class="op" id="5637930">-</span>&nbsp;<span class="ident" id="5637932">dst</span><span class="op" id="5637935">.</span><span class="ident" id="5637936">Rect</span><span class="op" id="5637940">.</span><span class="ident" id="5637941">Min</span><span class="op" id="5637944">.</span><span class="ident" id="5637945">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637948">switch</span>&nbsp;<span class="ident" id="5637955">src</span><span class="op" id="5637958">.</span><span class="ident" id="5637959">SubsampleRatio</span>&nbsp;<span class="op" id="5637974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637977">case</span>&nbsp;<span class="ident" id="5637982">image</span><span class="op" id="5637987">.</span><span class="ident" id="5637988">YCbCrSubsampleRatio444</span><span class="op" id="5638010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638014">for</span>&nbsp;<span class="ident" id="5638018">y</span><span class="op" id="5638019">,</span>&nbsp;<span class="ident" id="5638021">sy</span>&nbsp;<span class="op" id="5638024">:=</span>&nbsp;<span class="ident" id="5638027">y0</span><span class="op" id="5638029">,</span>&nbsp;<span class="ident" id="5638031">sp</span><span class="op" id="5638033">.</span><span class="ident" id="5638034">Y</span><span class="op" id="5638035">;</span>&nbsp;<span class="ident" id="5638037">y</span>&nbsp;<span class="op" id="5638039">!=</span>&nbsp;<span class="ident" id="5638042">y1</span><span class="op" id="5638044">;</span>&nbsp;<span class="ident" id="5638046">y</span><span class="op" id="5638047">,</span>&nbsp;<span class="ident" id="5638049">sy</span>&nbsp;<span class="op" id="5638052">=</span>&nbsp;<span class="ident" id="5638054">y</span><span class="op" id="5638055">+</span><span class="num" id="5638056">1</span><span class="op" id="5638057">,</span>&nbsp;<span class="ident" id="5638059">sy</span><span class="op" id="5638061">+</span><span class="num" id="5638062">1</span>&nbsp;<span class="op" id="5638064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638069">dpix</span>&nbsp;<span class="op" id="5638074">:=</span>&nbsp;<span class="ident" id="5638077">dst</span><span class="op" id="5638080">.</span><span class="ident" id="5638081">Pix</span><span class="op" id="5638084">[</span><span class="ident" id="5638085">y</span><span class="op" id="5638086">*</span><span class="ident" id="5638087">dst</span><span class="op" id="5638090">.</span><span class="ident" id="5638091">Stride</span><span class="op" id="5638097">:</span><span class="op" id="5638098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638103">yi</span>&nbsp;<span class="op" id="5638106">:=</span>&nbsp;<span class="op" id="5638109">(</span><span class="ident" id="5638110">sy</span><span class="op" id="5638112">-</span><span class="ident" id="5638113">src</span><span class="op" id="5638116">.</span><span class="ident" id="5638117">Rect</span><span class="op" id="5638121">.</span><span class="ident" id="5638122">Min</span><span class="op" id="5638125">.</span><span class="ident" id="5638126">Y</span><span class="op" id="5638127">)</span><span class="op" id="5638128">*</span><span class="ident" id="5638129">src</span><span class="op" id="5638132">.</span><span class="ident" id="5638133">YStride</span>&nbsp;<span class="op" id="5638141">+</span>&nbsp;<span class="op" id="5638143">(</span><span class="ident" id="5638144">sp</span><span class="op" id="5638146">.</span><span class="ident" id="5638147">X</span>&nbsp;<span class="op" id="5638149">-</span>&nbsp;<span class="ident" id="5638151">src</span><span class="op" id="5638154">.</span><span class="ident" id="5638155">Rect</span><span class="op" id="5638159">.</span><span class="ident" id="5638160">Min</span><span class="op" id="5638163">.</span><span class="ident" id="5638164">X</span><span class="op" id="5638165">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638170">ci</span>&nbsp;<span class="op" id="5638173">:=</span>&nbsp;<span class="op" id="5638176">(</span><span class="ident" id="5638177">sy</span><span class="op" id="5638179">-</span><span class="ident" id="5638180">src</span><span class="op" id="5638183">.</span><span class="ident" id="5638184">Rect</span><span class="op" id="5638188">.</span><span class="ident" id="5638189">Min</span><span class="op" id="5638192">.</span><span class="ident" id="5638193">Y</span><span class="op" id="5638194">)</span><span class="op" id="5638195">*</span><span class="ident" id="5638196">src</span><span class="op" id="5638199">.</span><span class="ident" id="5638200">CStride</span>&nbsp;<span class="op" id="5638208">+</span>&nbsp;<span class="op" id="5638210">(</span><span class="ident" id="5638211">sp</span><span class="op" id="5638213">.</span><span class="ident" id="5638214">X</span>&nbsp;<span class="op" id="5638216">-</span>&nbsp;<span class="ident" id="5638218">src</span><span class="op" id="5638221">.</span><span class="ident" id="5638222">Rect</span><span class="op" id="5638226">.</span><span class="ident" id="5638227">Min</span><span class="op" id="5638230">.</span><span class="ident" id="5638231">X</span><span class="op" id="5638232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638237">for</span>&nbsp;<span class="ident" id="5638241">x</span>&nbsp;<span class="op" id="5638243">:=</span>&nbsp;<span class="ident" id="5638246">x0</span><span class="op" id="5638248">;</span>&nbsp;<span class="ident" id="5638250">x</span>&nbsp;<span class="op" id="5638252">!=</span>&nbsp;<span class="ident" id="5638255">x1</span><span class="op" id="5638257">;</span>&nbsp;<span class="ident" id="5638259">x</span><span class="op" id="5638260">,</span>&nbsp;<span class="ident" id="5638262">yi</span><span class="op" id="5638264">,</span>&nbsp;<span class="ident" id="5638266">ci</span>&nbsp;<span class="op" id="5638269">=</span>&nbsp;<span class="ident" id="5638271">x</span><span class="op" id="5638272">+</span><span class="num" id="5638273">4</span><span class="op" id="5638274">,</span>&nbsp;<span class="ident" id="5638276">yi</span><span class="op" id="5638278">+</span><span class="num" id="5638279">1</span><span class="op" id="5638280">,</span>&nbsp;<span class="ident" id="5638282">ci</span><span class="op" id="5638284">+</span><span class="num" id="5638285">1</span>&nbsp;<span class="op" id="5638287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638293">rr</span><span class="op" id="5638295">,</span>&nbsp;<span class="ident" id="5638297">gg</span><span class="op" id="5638299">,</span>&nbsp;<span class="ident" id="5638301">bb</span>&nbsp;<span class="op" id="5638304">:=</span>&nbsp;<span class="ident" id="5638307">color</span><span class="op" id="5638312">.</span><span class="ident" id="5638313">YCbCrToRGB</span><span class="op" id="5638323">(</span><span class="ident" id="5638324">src</span><span class="op" id="5638327">.</span><span class="ident" id="5638328">Y</span><span class="op" id="5638329">[</span><span class="ident" id="5638330">yi</span><span class="op" id="5638332">]</span><span class="op" id="5638333">,</span>&nbsp;<span class="ident" id="5638335">src</span><span class="op" id="5638338">.</span><span class="ident" id="5638339">Cb</span><span class="op" id="5638341">[</span><span class="ident" id="5638342">ci</span><span class="op" id="5638344">]</span><span class="op" id="5638345">,</span>&nbsp;<span class="ident" id="5638347">src</span><span class="op" id="5638350">.</span><span class="ident" id="5638351">Cr</span><span class="op" id="5638353">[</span><span class="ident" id="5638354">ci</span><span class="op" id="5638356">]</span><span class="op" id="5638357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638363">dpix</span><span class="op" id="5638367">[</span><span class="ident" id="5638368">x</span><span class="op" id="5638369">+</span><span class="num" id="5638370">0</span><span class="op" id="5638371">]</span>&nbsp;<span class="op" id="5638373">=</span>&nbsp;<span class="ident" id="5638375">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638382">dpix</span><span class="op" id="5638386">[</span><span class="ident" id="5638387">x</span><span class="op" id="5638388">+</span><span class="num" id="5638389">1</span><span class="op" id="5638390">]</span>&nbsp;<span class="op" id="5638392">=</span>&nbsp;<span class="ident" id="5638394">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638401">dpix</span><span class="op" id="5638405">[</span><span class="ident" id="5638406">x</span><span class="op" id="5638407">+</span><span class="num" id="5638408">2</span><span class="op" id="5638409">]</span>&nbsp;<span class="op" id="5638411">=</span>&nbsp;<span class="ident" id="5638413">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638420">dpix</span><span class="op" id="5638424">[</span><span class="ident" id="5638425">x</span><span class="op" id="5638426">+</span><span class="num" id="5638427">3</span><span class="op" id="5638428">]</span>&nbsp;<span class="op" id="5638430">=</span>&nbsp;<span class="num" id="5638432">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638446">case</span>&nbsp;<span class="ident" id="5638451">image</span><span class="op" id="5638456">.</span><span class="ident" id="5638457">YCbCrSubsampleRatio422</span><span class="op" id="5638479">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638483">for</span>&nbsp;<span class="ident" id="5638487">y</span><span class="op" id="5638488">,</span>&nbsp;<span class="ident" id="5638490">sy</span>&nbsp;<span class="op" id="5638493">:=</span>&nbsp;<span class="ident" id="5638496">y0</span><span class="op" id="5638498">,</span>&nbsp;<span class="ident" id="5638500">sp</span><span class="op" id="5638502">.</span><span class="ident" id="5638503">Y</span><span class="op" id="5638504">;</span>&nbsp;<span class="ident" id="5638506">y</span>&nbsp;<span class="op" id="5638508">!=</span>&nbsp;<span class="ident" id="5638511">y1</span><span class="op" id="5638513">;</span>&nbsp;<span class="ident" id="5638515">y</span><span class="op" id="5638516">,</span>&nbsp;<span class="ident" id="5638518">sy</span>&nbsp;<span class="op" id="5638521">=</span>&nbsp;<span class="ident" id="5638523">y</span><span class="op" id="5638524">+</span><span class="num" id="5638525">1</span><span class="op" id="5638526">,</span>&nbsp;<span class="ident" id="5638528">sy</span><span class="op" id="5638530">+</span><span class="num" id="5638531">1</span>&nbsp;<span class="op" id="5638533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638538">dpix</span>&nbsp;<span class="op" id="5638543">:=</span>&nbsp;<span class="ident" id="5638546">dst</span><span class="op" id="5638549">.</span><span class="ident" id="5638550">Pix</span><span class="op" id="5638553">[</span><span class="ident" id="5638554">y</span><span class="op" id="5638555">*</span><span class="ident" id="5638556">dst</span><span class="op" id="5638559">.</span><span class="ident" id="5638560">Stride</span><span class="op" id="5638566">:</span><span class="op" id="5638567">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638572">yi</span>&nbsp;<span class="op" id="5638575">:=</span>&nbsp;<span class="op" id="5638578">(</span><span class="ident" id="5638579">sy</span><span class="op" id="5638581">-</span><span class="ident" id="5638582">src</span><span class="op" id="5638585">.</span><span class="ident" id="5638586">Rect</span><span class="op" id="5638590">.</span><span class="ident" id="5638591">Min</span><span class="op" id="5638594">.</span><span class="ident" id="5638595">Y</span><span class="op" id="5638596">)</span><span class="op" id="5638597">*</span><span class="ident" id="5638598">src</span><span class="op" id="5638601">.</span><span class="ident" id="5638602">YStride</span>&nbsp;<span class="op" id="5638610">+</span>&nbsp;<span class="op" id="5638612">(</span><span class="ident" id="5638613">sp</span><span class="op" id="5638615">.</span><span class="ident" id="5638616">X</span>&nbsp;<span class="op" id="5638618">-</span>&nbsp;<span class="ident" id="5638620">src</span><span class="op" id="5638623">.</span><span class="ident" id="5638624">Rect</span><span class="op" id="5638628">.</span><span class="ident" id="5638629">Min</span><span class="op" id="5638632">.</span><span class="ident" id="5638633">X</span><span class="op" id="5638634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638639">ciBase</span>&nbsp;<span class="op" id="5638646">:=</span>&nbsp;<span class="op" id="5638649">(</span><span class="ident" id="5638650">sy</span><span class="op" id="5638652">-</span><span class="ident" id="5638653">src</span><span class="op" id="5638656">.</span><span class="ident" id="5638657">Rect</span><span class="op" id="5638661">.</span><span class="ident" id="5638662">Min</span><span class="op" id="5638665">.</span><span class="ident" id="5638666">Y</span><span class="op" id="5638667">)</span><span class="op" id="5638668">*</span><span class="ident" id="5638669">src</span><span class="op" id="5638672">.</span><span class="ident" id="5638673">CStride</span>&nbsp;<span class="op" id="5638681">-</span>&nbsp;<span class="ident" id="5638683">src</span><span class="op" id="5638686">.</span><span class="ident" id="5638687">Rect</span><span class="op" id="5638691">.</span><span class="ident" id="5638692">Min</span><span class="op" id="5638695">.</span><span class="ident" id="5638696">X</span><span class="op" id="5638697">/</span><span class="num" id="5638698">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638703">for</span>&nbsp;<span class="ident" id="5638707">x</span><span class="op" id="5638708">,</span>&nbsp;<span class="ident" id="5638710">sx</span>&nbsp;<span class="op" id="5638713">:=</span>&nbsp;<span class="ident" id="5638716">x0</span><span class="op" id="5638718">,</span>&nbsp;<span class="ident" id="5638720">sp</span><span class="op" id="5638722">.</span><span class="ident" id="5638723">X</span><span class="op" id="5638724">;</span>&nbsp;<span class="ident" id="5638726">x</span>&nbsp;<span class="op" id="5638728">!=</span>&nbsp;<span class="ident" id="5638731">x1</span><span class="op" id="5638733">;</span>&nbsp;<span class="ident" id="5638735">x</span><span class="op" id="5638736">,</span>&nbsp;<span class="ident" id="5638738">sx</span><span class="op" id="5638740">,</span>&nbsp;<span class="ident" id="5638742">yi</span>&nbsp;<span class="op" id="5638745">=</span>&nbsp;<span class="ident" id="5638747">x</span><span class="op" id="5638748">+</span><span class="num" id="5638749">4</span><span class="op" id="5638750">,</span>&nbsp;<span class="ident" id="5638752">sx</span><span class="op" id="5638754">+</span><span class="num" id="5638755">1</span><span class="op" id="5638756">,</span>&nbsp;<span class="ident" id="5638758">yi</span><span class="op" id="5638760">+</span><span class="num" id="5638761">1</span>&nbsp;<span class="op" id="5638763">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638769">ci</span>&nbsp;<span class="op" id="5638772">:=</span>&nbsp;<span class="ident" id="5638775">ciBase</span>&nbsp;<span class="op" id="5638782">+</span>&nbsp;<span class="ident" id="5638784">sx</span><span class="op" id="5638786">/</span><span class="num" id="5638787">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638793">rr</span><span class="op" id="5638795">,</span>&nbsp;<span class="ident" id="5638797">gg</span><span class="op" id="5638799">,</span>&nbsp;<span class="ident" id="5638801">bb</span>&nbsp;<span class="op" id="5638804">:=</span>&nbsp;<span class="ident" id="5638807">color</span><span class="op" id="5638812">.</span><span class="ident" id="5638813">YCbCrToRGB</span><span class="op" id="5638823">(</span><span class="ident" id="5638824">src</span><span class="op" id="5638827">.</span><span class="ident" id="5638828">Y</span><span class="op" id="5638829">[</span><span class="ident" id="5638830">yi</span><span class="op" id="5638832">]</span><span class="op" id="5638833">,</span>&nbsp;<span class="ident" id="5638835">src</span><span class="op" id="5638838">.</span><span class="ident" id="5638839">Cb</span><span class="op" id="5638841">[</span><span class="ident" id="5638842">ci</span><span class="op" id="5638844">]</span><span class="op" id="5638845">,</span>&nbsp;<span class="ident" id="5638847">src</span><span class="op" id="5638850">.</span><span class="ident" id="5638851">Cr</span><span class="op" id="5638853">[</span><span class="ident" id="5638854">ci</span><span class="op" id="5638856">]</span><span class="op" id="5638857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638863">dpix</span><span class="op" id="5638867">[</span><span class="ident" id="5638868">x</span><span class="op" id="5638869">+</span><span class="num" id="5638870">0</span><span class="op" id="5638871">]</span>&nbsp;<span class="op" id="5638873">=</span>&nbsp;<span class="ident" id="5638875">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638882">dpix</span><span class="op" id="5638886">[</span><span class="ident" id="5638887">x</span><span class="op" id="5638888">+</span><span class="num" id="5638889">1</span><span class="op" id="5638890">]</span>&nbsp;<span class="op" id="5638892">=</span>&nbsp;<span class="ident" id="5638894">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638901">dpix</span><span class="op" id="5638905">[</span><span class="ident" id="5638906">x</span><span class="op" id="5638907">+</span><span class="num" id="5638908">2</span><span class="op" id="5638909">]</span>&nbsp;<span class="op" id="5638911">=</span>&nbsp;<span class="ident" id="5638913">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638920">dpix</span><span class="op" id="5638924">[</span><span class="ident" id="5638925">x</span><span class="op" id="5638926">+</span><span class="num" id="5638927">3</span><span class="op" id="5638928">]</span>&nbsp;<span class="op" id="5638930">=</span>&nbsp;<span class="num" id="5638932">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638946">case</span>&nbsp;<span class="ident" id="5638951">image</span><span class="op" id="5638956">.</span><span class="ident" id="5638957">YCbCrSubsampleRatio420</span><span class="op" id="5638979">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638983">for</span>&nbsp;<span class="ident" id="5638987">y</span><span class="op" id="5638988">,</span>&nbsp;<span class="ident" id="5638990">sy</span>&nbsp;<span class="op" id="5638993">:=</span>&nbsp;<span class="ident" id="5638996">y0</span><span class="op" id="5638998">,</span>&nbsp;<span class="ident" id="5639000">sp</span><span class="op" id="5639002">.</span><span class="ident" id="5639003">Y</span><span class="op" id="5639004">;</span>&nbsp;<span class="ident" id="5639006">y</span>&nbsp;<span class="op" id="5639008">!=</span>&nbsp;<span class="ident" id="5639011">y1</span><span class="op" id="5639013">;</span>&nbsp;<span class="ident" id="5639015">y</span><span class="op" id="5639016">,</span>&nbsp;<span class="ident" id="5639018">sy</span>&nbsp;<span class="op" id="5639021">=</span>&nbsp;<span class="ident" id="5639023">y</span><span class="op" id="5639024">+</span><span class="num" id="5639025">1</span><span class="op" id="5639026">,</span>&nbsp;<span class="ident" id="5639028">sy</span><span class="op" id="5639030">+</span><span class="num" id="5639031">1</span>&nbsp;<span class="op" id="5639033">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639038">dpix</span>&nbsp;<span class="op" id="5639043">:=</span>&nbsp;<span class="ident" id="5639046">dst</span><span class="op" id="5639049">.</span><span class="ident" id="5639050">Pix</span><span class="op" id="5639053">[</span><span class="ident" id="5639054">y</span><span class="op" id="5639055">*</span><span class="ident" id="5639056">dst</span><span class="op" id="5639059">.</span><span class="ident" id="5639060">Stride</span><span class="op" id="5639066">:</span><span class="op" id="5639067">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639072">yi</span>&nbsp;<span class="op" id="5639075">:=</span>&nbsp;<span class="op" id="5639078">(</span><span class="ident" id="5639079">sy</span><span class="op" id="5639081">-</span><span class="ident" id="5639082">src</span><span class="op" id="5639085">.</span><span class="ident" id="5639086">Rect</span><span class="op" id="5639090">.</span><span class="ident" id="5639091">Min</span><span class="op" id="5639094">.</span><span class="ident" id="5639095">Y</span><span class="op" id="5639096">)</span><span class="op" id="5639097">*</span><span class="ident" id="5639098">src</span><span class="op" id="5639101">.</span><span class="ident" id="5639102">YStride</span>&nbsp;<span class="op" id="5639110">+</span>&nbsp;<span class="op" id="5639112">(</span><span class="ident" id="5639113">sp</span><span class="op" id="5639115">.</span><span class="ident" id="5639116">X</span>&nbsp;<span class="op" id="5639118">-</span>&nbsp;<span class="ident" id="5639120">src</span><span class="op" id="5639123">.</span><span class="ident" id="5639124">Rect</span><span class="op" id="5639128">.</span><span class="ident" id="5639129">Min</span><span class="op" id="5639132">.</span><span class="ident" id="5639133">X</span><span class="op" id="5639134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639139">ciBase</span>&nbsp;<span class="op" id="5639146">:=</span>&nbsp;<span class="op" id="5639149">(</span><span class="ident" id="5639150">sy</span><span class="op" id="5639152">/</span><span class="num" id="5639153">2</span><span class="op" id="5639154">-</span><span class="ident" id="5639155">src</span><span class="op" id="5639158">.</span><span class="ident" id="5639159">Rect</span><span class="op" id="5639163">.</span><span class="ident" id="5639164">Min</span><span class="op" id="5639167">.</span><span class="ident" id="5639168">Y</span><span class="op" id="5639169">/</span><span class="num" id="5639170">2</span><span class="op" id="5639171">)</span><span class="op" id="5639172">*</span><span class="ident" id="5639173">src</span><span class="op" id="5639176">.</span><span class="ident" id="5639177">CStride</span>&nbsp;<span class="op" id="5639185">-</span>&nbsp;<span class="ident" id="5639187">src</span><span class="op" id="5639190">.</span><span class="ident" id="5639191">Rect</span><span class="op" id="5639195">.</span><span class="ident" id="5639196">Min</span><span class="op" id="5639199">.</span><span class="ident" id="5639200">X</span><span class="op" id="5639201">/</span><span class="num" id="5639202">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639207">for</span>&nbsp;<span class="ident" id="5639211">x</span><span class="op" id="5639212">,</span>&nbsp;<span class="ident" id="5639214">sx</span>&nbsp;<span class="op" id="5639217">:=</span>&nbsp;<span class="ident" id="5639220">x0</span><span class="op" id="5639222">,</span>&nbsp;<span class="ident" id="5639224">sp</span><span class="op" id="5639226">.</span><span class="ident" id="5639227">X</span><span class="op" id="5639228">;</span>&nbsp;<span class="ident" id="5639230">x</span>&nbsp;<span class="op" id="5639232">!=</span>&nbsp;<span class="ident" id="5639235">x1</span><span class="op" id="5639237">;</span>&nbsp;<span class="ident" id="5639239">x</span><span class="op" id="5639240">,</span>&nbsp;<span class="ident" id="5639242">sx</span><span class="op" id="5639244">,</span>&nbsp;<span class="ident" id="5639246">yi</span>&nbsp;<span class="op" id="5639249">=</span>&nbsp;<span class="ident" id="5639251">x</span><span class="op" id="5639252">+</span><span class="num" id="5639253">4</span><span class="op" id="5639254">,</span>&nbsp;<span class="ident" id="5639256">sx</span><span class="op" id="5639258">+</span><span class="num" id="5639259">1</span><span class="op" id="5639260">,</span>&nbsp;<span class="ident" id="5639262">yi</span><span class="op" id="5639264">+</span><span class="num" id="5639265">1</span>&nbsp;<span class="op" id="5639267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639273">ci</span>&nbsp;<span class="op" id="5639276">:=</span>&nbsp;<span class="ident" id="5639279">ciBase</span>&nbsp;<span class="op" id="5639286">+</span>&nbsp;<span class="ident" id="5639288">sx</span><span class="op" id="5639290">/</span><span class="num" id="5639291">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639297">rr</span><span class="op" id="5639299">,</span>&nbsp;<span class="ident" id="5639301">gg</span><span class="op" id="5639303">,</span>&nbsp;<span class="ident" id="5639305">bb</span>&nbsp;<span class="op" id="5639308">:=</span>&nbsp;<span class="ident" id="5639311">color</span><span class="op" id="5639316">.</span><span class="ident" id="5639317">YCbCrToRGB</span><span class="op" id="5639327">(</span><span class="ident" id="5639328">src</span><span class="op" id="5639331">.</span><span class="ident" id="5639332">Y</span><span class="op" id="5639333">[</span><span class="ident" id="5639334">yi</span><span class="op" id="5639336">]</span><span class="op" id="5639337">,</span>&nbsp;<span class="ident" id="5639339">src</span><span class="op" id="5639342">.</span><span class="ident" id="5639343">Cb</span><span class="op" id="5639345">[</span><span class="ident" id="5639346">ci</span><span class="op" id="5639348">]</span><span class="op" id="5639349">,</span>&nbsp;<span class="ident" id="5639351">src</span><span class="op" id="5639354">.</span><span class="ident" id="5639355">Cr</span><span class="op" id="5639357">[</span><span class="ident" id="5639358">ci</span><span class="op" id="5639360">]</span><span class="op" id="5639361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639367">dpix</span><span class="op" id="5639371">[</span><span class="ident" id="5639372">x</span><span class="op" id="5639373">+</span><span class="num" id="5639374">0</span><span class="op" id="5639375">]</span>&nbsp;<span class="op" id="5639377">=</span>&nbsp;<span class="ident" id="5639379">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639386">dpix</span><span class="op" id="5639390">[</span><span class="ident" id="5639391">x</span><span class="op" id="5639392">+</span><span class="num" id="5639393">1</span><span class="op" id="5639394">]</span>&nbsp;<span class="op" id="5639396">=</span>&nbsp;<span class="ident" id="5639398">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639405">dpix</span><span class="op" id="5639409">[</span><span class="ident" id="5639410">x</span><span class="op" id="5639411">+</span><span class="num" id="5639412">2</span><span class="op" id="5639413">]</span>&nbsp;<span class="op" id="5639415">=</span>&nbsp;<span class="ident" id="5639417">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639424">dpix</span><span class="op" id="5639428">[</span><span class="ident" id="5639429">x</span><span class="op" id="5639430">+</span><span class="num" id="5639431">3</span><span class="op" id="5639432">]</span>&nbsp;<span class="op" id="5639434">=</span>&nbsp;<span class="num" id="5639436">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639450">case</span>&nbsp;<span class="ident" id="5639455">image</span><span class="op" id="5639460">.</span><span class="ident" id="5639461">YCbCrSubsampleRatio440</span><span class="op" id="5639483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639487">for</span>&nbsp;<span class="ident" id="5639491">y</span><span class="op" id="5639492">,</span>&nbsp;<span class="ident" id="5639494">sy</span>&nbsp;<span class="op" id="5639497">:=</span>&nbsp;<span class="ident" id="5639500">y0</span><span class="op" id="5639502">,</span>&nbsp;<span class="ident" id="5639504">sp</span><span class="op" id="5639506">.</span><span class="ident" id="5639507">Y</span><span class="op" id="5639508">;</span>&nbsp;<span class="ident" id="5639510">y</span>&nbsp;<span class="op" id="5639512">!=</span>&nbsp;<span class="ident" id="5639515">y1</span><span class="op" id="5639517">;</span>&nbsp;<span class="ident" id="5639519">y</span><span class="op" id="5639520">,</span>&nbsp;<span class="ident" id="5639522">sy</span>&nbsp;<span class="op" id="5639525">=</span>&nbsp;<span class="ident" id="5639527">y</span><span class="op" id="5639528">+</span><span class="num" id="5639529">1</span><span class="op" id="5639530">,</span>&nbsp;<span class="ident" id="5639532">sy</span><span class="op" id="5639534">+</span><span class="num" id="5639535">1</span>&nbsp;<span class="op" id="5639537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639542">dpix</span>&nbsp;<span class="op" id="5639547">:=</span>&nbsp;<span class="ident" id="5639550">dst</span><span class="op" id="5639553">.</span><span class="ident" id="5639554">Pix</span><span class="op" id="5639557">[</span><span class="ident" id="5639558">y</span><span class="op" id="5639559">*</span><span class="ident" id="5639560">dst</span><span class="op" id="5639563">.</span><span class="ident" id="5639564">Stride</span><span class="op" id="5639570">:</span><span class="op" id="5639571">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639576">yi</span>&nbsp;<span class="op" id="5639579">:=</span>&nbsp;<span class="op" id="5639582">(</span><span class="ident" id="5639583">sy</span><span class="op" id="5639585">-</span><span class="ident" id="5639586">src</span><span class="op" id="5639589">.</span><span class="ident" id="5639590">Rect</span><span class="op" id="5639594">.</span><span class="ident" id="5639595">Min</span><span class="op" id="5639598">.</span><span class="ident" id="5639599">Y</span><span class="op" id="5639600">)</span><span class="op" id="5639601">*</span><span class="ident" id="5639602">src</span><span class="op" id="5639605">.</span><span class="ident" id="5639606">YStride</span>&nbsp;<span class="op" id="5639614">+</span>&nbsp;<span class="op" id="5639616">(</span><span class="ident" id="5639617">sp</span><span class="op" id="5639619">.</span><span class="ident" id="5639620">X</span>&nbsp;<span class="op" id="5639622">-</span>&nbsp;<span class="ident" id="5639624">src</span><span class="op" id="5639627">.</span><span class="ident" id="5639628">Rect</span><span class="op" id="5639632">.</span><span class="ident" id="5639633">Min</span><span class="op" id="5639636">.</span><span class="ident" id="5639637">X</span><span class="op" id="5639638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639643">ci</span>&nbsp;<span class="op" id="5639646">:=</span>&nbsp;<span class="op" id="5639649">(</span><span class="ident" id="5639650">sy</span><span class="op" id="5639652">/</span><span class="num" id="5639653">2</span><span class="op" id="5639654">-</span><span class="ident" id="5639655">src</span><span class="op" id="5639658">.</span><span class="ident" id="5639659">Rect</span><span class="op" id="5639663">.</span><span class="ident" id="5639664">Min</span><span class="op" id="5639667">.</span><span class="ident" id="5639668">Y</span><span class="op" id="5639669">/</span><span class="num" id="5639670">2</span><span class="op" id="5639671">)</span><span class="op" id="5639672">*</span><span class="ident" id="5639673">src</span><span class="op" id="5639676">.</span><span class="ident" id="5639677">CStride</span>&nbsp;<span class="op" id="5639685">+</span>&nbsp;<span class="op" id="5639687">(</span><span class="ident" id="5639688">sp</span><span class="op" id="5639690">.</span><span class="ident" id="5639691">X</span>&nbsp;<span class="op" id="5639693">-</span>&nbsp;<span class="ident" id="5639695">src</span><span class="op" id="5639698">.</span><span class="ident" id="5639699">Rect</span><span class="op" id="5639703">.</span><span class="ident" id="5639704">Min</span><span class="op" id="5639707">.</span><span class="ident" id="5639708">X</span><span class="op" id="5639709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639714">for</span>&nbsp;<span class="ident" id="5639718">x</span>&nbsp;<span class="op" id="5639720">:=</span>&nbsp;<span class="ident" id="5639723">x0</span><span class="op" id="5639725">;</span>&nbsp;<span class="ident" id="5639727">x</span>&nbsp;<span class="op" id="5639729">!=</span>&nbsp;<span class="ident" id="5639732">x1</span><span class="op" id="5639734">;</span>&nbsp;<span class="ident" id="5639736">x</span><span class="op" id="5639737">,</span>&nbsp;<span class="ident" id="5639739">yi</span><span class="op" id="5639741">,</span>&nbsp;<span class="ident" id="5639743">ci</span>&nbsp;<span class="op" id="5639746">=</span>&nbsp;<span class="ident" id="5639748">x</span><span class="op" id="5639749">+</span><span class="num" id="5639750">4</span><span class="op" id="5639751">,</span>&nbsp;<span class="ident" id="5639753">yi</span><span class="op" id="5639755">+</span><span class="num" id="5639756">1</span><span class="op" id="5639757">,</span>&nbsp;<span class="ident" id="5639759">ci</span><span class="op" id="5639761">+</span><span class="num" id="5639762">1</span>&nbsp;<span class="op" id="5639764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639770">rr</span><span class="op" id="5639772">,</span>&nbsp;<span class="ident" id="5639774">gg</span><span class="op" id="5639776">,</span>&nbsp;<span class="ident" id="5639778">bb</span>&nbsp;<span class="op" id="5639781">:=</span>&nbsp;<span class="ident" id="5639784">color</span><span class="op" id="5639789">.</span><span class="ident" id="5639790">YCbCrToRGB</span><span class="op" id="5639800">(</span><span class="ident" id="5639801">src</span><span class="op" id="5639804">.</span><span class="ident" id="5639805">Y</span><span class="op" id="5639806">[</span><span class="ident" id="5639807">yi</span><span class="op" id="5639809">]</span><span class="op" id="5639810">,</span>&nbsp;<span class="ident" id="5639812">src</span><span class="op" id="5639815">.</span><span class="ident" id="5639816">Cb</span><span class="op" id="5639818">[</span><span class="ident" id="5639819">ci</span><span class="op" id="5639821">]</span><span class="op" id="5639822">,</span>&nbsp;<span class="ident" id="5639824">src</span><span class="op" id="5639827">.</span><span class="ident" id="5639828">Cr</span><span class="op" id="5639830">[</span><span class="ident" id="5639831">ci</span><span class="op" id="5639833">]</span><span class="op" id="5639834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639840">dpix</span><span class="op" id="5639844">[</span><span class="ident" id="5639845">x</span><span class="op" id="5639846">+</span><span class="num" id="5639847">0</span><span class="op" id="5639848">]</span>&nbsp;<span class="op" id="5639850">=</span>&nbsp;<span class="ident" id="5639852">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639859">dpix</span><span class="op" id="5639863">[</span><span class="ident" id="5639864">x</span><span class="op" id="5639865">+</span><span class="num" id="5639866">1</span><span class="op" id="5639867">]</span>&nbsp;<span class="op" id="5639869">=</span>&nbsp;<span class="ident" id="5639871">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639878">dpix</span><span class="op" id="5639882">[</span><span class="ident" id="5639883">x</span><span class="op" id="5639884">+</span><span class="num" id="5639885">2</span><span class="op" id="5639886">]</span>&nbsp;<span class="op" id="5639888">=</span>&nbsp;<span class="ident" id="5639890">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639897">dpix</span><span class="op" id="5639901">[</span><span class="ident" id="5639902">x</span><span class="op" id="5639903">+</span><span class="num" id="5639904">3</span><span class="op" id="5639905">]</span>&nbsp;<span class="op" id="5639907">=</span>&nbsp;<span class="num" id="5639909">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639920">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639923">default</span><span class="op" id="5639930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639934">return</span>&nbsp;<span class="builtintype" id="5639941">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639951">return</span>&nbsp;<span class="builtintype" id="5639958">true</span><br>
<span class="lineno"></span><span class="op" id="5639963">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5639966">func</span>&nbsp;<span class="ident" id="5639971">drawGlyphOver</span><span class="op" id="5639984">(</span><span class="ident" id="5639985">dst</span>&nbsp;<span class="op" id="5639989">*</span><span class="ident" id="5639990">image</span><span class="op" id="5639995">.</span><span class="ident" id="5639996">RGBA</span><span class="op" id="5640000">,</span>&nbsp;<span class="ident" id="5640002">r</span>&nbsp;<span class="ident" id="5640004">image</span><span class="op" id="5640009">.</span><span class="ident" id="5640010">Rectangle</span><span class="op" id="5640019">,</span>&nbsp;<span class="ident" id="5640021">src</span>&nbsp;<span class="op" id="5640025">*</span><span class="ident" id="5640026">image</span><span class="op" id="5640031">.</span><span class="ident" id="5640032">Uniform</span><span class="op" id="5640039">,</span>&nbsp;<span class="ident" id="5640041">mask</span>&nbsp;<span class="op" id="5640046">*</span><span class="ident" id="5640047">image</span><span class="op" id="5640052">.</span><span class="ident" id="5640053">Alpha</span><span class="op" id="5640058">,</span>&nbsp;<span class="ident" id="5640060">mp</span>&nbsp;<span class="ident" id="5640063">image</span><span class="op" id="5640068">.</span><span class="ident" id="5640069">Point</span><span class="op" id="5640074">)</span>&nbsp;<span class="op" id="5640076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640079">i0</span>&nbsp;<span class="op" id="5640082">:=</span>&nbsp;<span class="ident" id="5640085">dst</span><span class="op" id="5640088">.</span><span class="ident" id="5640089">PixOffset</span><span class="op" id="5640098">(</span><span class="ident" id="5640099">r</span><span class="op" id="5640100">.</span><span class="ident" id="5640101">Min</span><span class="op" id="5640104">.</span><span class="ident" id="5640105">X</span><span class="op" id="5640106">,</span>&nbsp;<span class="ident" id="5640108">r</span><span class="op" id="5640109">.</span><span class="ident" id="5640110">Min</span><span class="op" id="5640113">.</span><span class="ident" id="5640114">Y</span><span class="op" id="5640115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640118">i1</span>&nbsp;<span class="op" id="5640121">:=</span>&nbsp;<span class="ident" id="5640124">i0</span>&nbsp;<span class="op" id="5640127">+</span>&nbsp;<span class="ident" id="5640129">r</span><span class="op" id="5640130">.</span><span class="ident" id="5640131">Dx</span><span class="op" id="5640133">(</span><span class="op" id="5640134">)</span><span class="op" id="5640135">*</span><span class="num" id="5640136">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640139">mi0</span>&nbsp;<span class="op" id="5640143">:=</span>&nbsp;<span class="ident" id="5640146">mask</span><span class="op" id="5640150">.</span><span class="ident" id="5640151">PixOffset</span><span class="op" id="5640160">(</span><span class="ident" id="5640161">mp</span><span class="op" id="5640163">.</span><span class="ident" id="5640164">X</span><span class="op" id="5640165">,</span>&nbsp;<span class="ident" id="5640167">mp</span><span class="op" id="5640169">.</span><span class="ident" id="5640170">Y</span><span class="op" id="5640171">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640174">sr</span><span class="op" id="5640176">,</span>&nbsp;<span class="ident" id="5640178">sg</span><span class="op" id="5640180">,</span>&nbsp;<span class="ident" id="5640182">sb</span><span class="op" id="5640184">,</span>&nbsp;<span class="ident" id="5640186">sa</span>&nbsp;<span class="op" id="5640189">:=</span>&nbsp;<span class="ident" id="5640192">src</span><span class="op" id="5640195">.</span><span class="ident" id="5640196">RGBA</span><span class="op" id="5640200">(</span><span class="op" id="5640201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640204">for</span>&nbsp;<span class="ident" id="5640208">y</span><span class="op" id="5640209">,</span>&nbsp;<span class="ident" id="5640211">my</span>&nbsp;<span class="op" id="5640214">:=</span>&nbsp;<span class="ident" id="5640217">r</span><span class="op" id="5640218">.</span><span class="ident" id="5640219">Min</span><span class="op" id="5640222">.</span><span class="ident" id="5640223">Y</span><span class="op" id="5640224">,</span>&nbsp;<span class="ident" id="5640226">mp</span><span class="op" id="5640228">.</span><span class="ident" id="5640229">Y</span><span class="op" id="5640230">;</span>&nbsp;<span class="ident" id="5640232">y</span>&nbsp;<span class="op" id="5640234">!=</span>&nbsp;<span class="ident" id="5640237">r</span><span class="op" id="5640238">.</span><span class="ident" id="5640239">Max</span><span class="op" id="5640242">.</span><span class="ident" id="5640243">Y</span><span class="op" id="5640244">;</span>&nbsp;<span class="ident" id="5640246">y</span><span class="op" id="5640247">,</span>&nbsp;<span class="ident" id="5640249">my</span>&nbsp;<span class="op" id="5640252">=</span>&nbsp;<span class="ident" id="5640254">y</span><span class="op" id="5640255">+</span><span class="num" id="5640256">1</span><span class="op" id="5640257">,</span>&nbsp;<span class="ident" id="5640259">my</span><span class="op" id="5640261">+</span><span class="num" id="5640262">1</span>&nbsp;<span class="op" id="5640264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640268">for</span>&nbsp;<span class="ident" id="5640272">i</span><span class="op" id="5640273">,</span>&nbsp;<span class="ident" id="5640275">mi</span>&nbsp;<span class="op" id="5640278">:=</span>&nbsp;<span class="ident" id="5640281">i0</span><span class="op" id="5640283">,</span>&nbsp;<span class="ident" id="5640285">mi0</span><span class="op" id="5640288">;</span>&nbsp;<span class="ident" id="5640290">i</span>&nbsp;<span class="op" id="5640292">&lt;</span>&nbsp;<span class="ident" id="5640294">i1</span><span class="op" id="5640296">;</span>&nbsp;<span class="ident" id="5640298">i</span><span class="op" id="5640299">,</span>&nbsp;<span class="ident" id="5640301">mi</span>&nbsp;<span class="op" id="5640304">=</span>&nbsp;<span class="ident" id="5640306">i</span><span class="op" id="5640307">+</span><span class="num" id="5640308">4</span><span class="op" id="5640309">,</span>&nbsp;<span class="ident" id="5640311">mi</span><span class="op" id="5640313">+</span><span class="num" id="5640314">1</span>&nbsp;<span class="op" id="5640316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640321">ma</span>&nbsp;<span class="op" id="5640324">:=</span>&nbsp;<span class="builtintype" id="5640327">uint32</span><span class="op" id="5640333">(</span><span class="ident" id="5640334">mask</span><span class="op" id="5640338">.</span><span class="ident" id="5640339">Pix</span><span class="op" id="5640342">[</span><span class="ident" id="5640343">mi</span><span class="op" id="5640345">]</span><span class="op" id="5640346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640351">if</span>&nbsp;<span class="ident" id="5640354">ma</span>&nbsp;<span class="op" id="5640357">==</span>&nbsp;<span class="num" id="5640360">0</span>&nbsp;<span class="op" id="5640362">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640368">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640385">ma</span>&nbsp;<span class="op" id="5640388">|=</span>&nbsp;<span class="ident" id="5640391">ma</span>&nbsp;<span class="op" id="5640394">&lt;&lt;</span>&nbsp;<span class="num" id="5640397">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640403">dr</span>&nbsp;<span class="op" id="5640406">:=</span>&nbsp;<span class="builtintype" id="5640409">uint32</span><span class="op" id="5640415">(</span><span class="ident" id="5640416">dst</span><span class="op" id="5640419">.</span><span class="ident" id="5640420">Pix</span><span class="op" id="5640423">[</span><span class="ident" id="5640424">i</span><span class="op" id="5640425">+</span><span class="num" id="5640426">0</span><span class="op" id="5640427">]</span><span class="op" id="5640428">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640433">dg</span>&nbsp;<span class="op" id="5640436">:=</span>&nbsp;<span class="builtintype" id="5640439">uint32</span><span class="op" id="5640445">(</span><span class="ident" id="5640446">dst</span><span class="op" id="5640449">.</span><span class="ident" id="5640450">Pix</span><span class="op" id="5640453">[</span><span class="ident" id="5640454">i</span><span class="op" id="5640455">+</span><span class="num" id="5640456">1</span><span class="op" id="5640457">]</span><span class="op" id="5640458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640463">db</span>&nbsp;<span class="op" id="5640466">:=</span>&nbsp;<span class="builtintype" id="5640469">uint32</span><span class="op" id="5640475">(</span><span class="ident" id="5640476">dst</span><span class="op" id="5640479">.</span><span class="ident" id="5640480">Pix</span><span class="op" id="5640483">[</span><span class="ident" id="5640484">i</span><span class="op" id="5640485">+</span><span class="num" id="5640486">2</span><span class="op" id="5640487">]</span><span class="op" id="5640488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640493">da</span>&nbsp;<span class="op" id="5640496">:=</span>&nbsp;<span class="builtintype" id="5640499">uint32</span><span class="op" id="5640505">(</span><span class="ident" id="5640506">dst</span><span class="op" id="5640509">.</span><span class="ident" id="5640510">Pix</span><span class="op" id="5640513">[</span><span class="ident" id="5640514">i</span><span class="op" id="5640515">+</span><span class="num" id="5640516">3</span><span class="op" id="5640517">]</span><span class="op" id="5640518">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5640524">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640584">a</span>&nbsp;<span class="op" id="5640586">:=</span>&nbsp;<span class="op" id="5640589">(</span><span class="ident" id="5640590">m</span>&nbsp;<span class="op" id="5640592">-</span>&nbsp;<span class="op" id="5640594">(</span><span class="ident" id="5640595">sa</span>&nbsp;<span class="op" id="5640598">*</span>&nbsp;<span class="ident" id="5640600">ma</span>&nbsp;<span class="op" id="5640603">/</span>&nbsp;<span class="ident" id="5640605">m</span><span class="op" id="5640606">)</span><span class="op" id="5640607">)</span>&nbsp;<span class="op" id="5640609">*</span>&nbsp;<span class="num" id="5640611">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640621">dst</span><span class="op" id="5640624">.</span><span class="ident" id="5640625">Pix</span><span class="op" id="5640628">[</span><span class="ident" id="5640629">i</span><span class="op" id="5640630">+</span><span class="num" id="5640631">0</span><span class="op" id="5640632">]</span>&nbsp;<span class="op" id="5640634">=</span>&nbsp;<span class="builtintype" id="5640636">uint8</span><span class="op" id="5640641">(</span><span class="op" id="5640642">(</span><span class="ident" id="5640643">dr</span><span class="op" id="5640645">*</span><span class="ident" id="5640646">a</span>&nbsp;<span class="op" id="5640648">+</span>&nbsp;<span class="ident" id="5640650">sr</span><span class="op" id="5640652">*</span><span class="ident" id="5640653">ma</span><span class="op" id="5640655">)</span>&nbsp;<span class="op" id="5640657">/</span>&nbsp;<span class="ident" id="5640659">m</span>&nbsp;<span class="op" id="5640661">&gt;&gt;</span>&nbsp;<span class="num" id="5640664">8</span><span class="op" id="5640665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640670">dst</span><span class="op" id="5640673">.</span><span class="ident" id="5640674">Pix</span><span class="op" id="5640677">[</span><span class="ident" id="5640678">i</span><span class="op" id="5640679">+</span><span class="num" id="5640680">1</span><span class="op" id="5640681">]</span>&nbsp;<span class="op" id="5640683">=</span>&nbsp;<span class="builtintype" id="5640685">uint8</span><span class="op" id="5640690">(</span><span class="op" id="5640691">(</span><span class="ident" id="5640692">dg</span><span class="op" id="5640694">*</span><span class="ident" id="5640695">a</span>&nbsp;<span class="op" id="5640697">+</span>&nbsp;<span class="ident" id="5640699">sg</span><span class="op" id="5640701">*</span><span class="ident" id="5640702">ma</span><span class="op" id="5640704">)</span>&nbsp;<span class="op" id="5640706">/</span>&nbsp;<span class="ident" id="5640708">m</span>&nbsp;<span class="op" id="5640710">&gt;&gt;</span>&nbsp;<span class="num" id="5640713">8</span><span class="op" id="5640714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640719">dst</span><span class="op" id="5640722">.</span><span class="ident" id="5640723">Pix</span><span class="op" id="5640726">[</span><span class="ident" id="5640727">i</span><span class="op" id="5640728">+</span><span class="num" id="5640729">2</span><span class="op" id="5640730">]</span>&nbsp;<span class="op" id="5640732">=</span>&nbsp;<span class="builtintype" id="5640734">uint8</span><span class="op" id="5640739">(</span><span class="op" id="5640740">(</span><span class="ident" id="5640741">db</span><span class="op" id="5640743">*</span><span class="ident" id="5640744">a</span>&nbsp;<span class="op" id="5640746">+</span>&nbsp;<span class="ident" id="5640748">sb</span><span class="op" id="5640750">*</span><span class="ident" id="5640751">ma</span><span class="op" id="5640753">)</span>&nbsp;<span class="op" id="5640755">/</span>&nbsp;<span class="ident" id="5640757">m</span>&nbsp;<span class="op" id="5640759">&gt;&gt;</span>&nbsp;<span class="num" id="5640762">8</span><span class="op" id="5640763">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640768">dst</span><span class="op" id="5640771">.</span><span class="ident" id="5640772">Pix</span><span class="op" id="5640775">[</span><span class="ident" id="5640776">i</span><span class="op" id="5640777">+</span><span class="num" id="5640778">3</span><span class="op" id="5640779">]</span>&nbsp;<span class="op" id="5640781">=</span>&nbsp;<span class="builtintype" id="5640783">uint8</span><span class="op" id="5640788">(</span><span class="op" id="5640789">(</span><span class="ident" id="5640790">da</span><span class="op" id="5640792">*</span><span class="ident" id="5640793">a</span>&nbsp;<span class="op" id="5640795">+</span>&nbsp;<span class="ident" id="5640797">sa</span><span class="op" id="5640799">*</span><span class="ident" id="5640800">ma</span><span class="op" id="5640802">)</span>&nbsp;<span class="op" id="5640804">/</span>&nbsp;<span class="ident" id="5640806">m</span>&nbsp;<span class="op" id="5640808">&gt;&gt;</span>&nbsp;<span class="num" id="5640811">8</span><span class="op" id="5640812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640820">i0</span>&nbsp;<span class="op" id="5640823">+=</span>&nbsp;<span class="ident" id="5640826">dst</span><span class="op" id="5640829">.</span><span class="ident" id="5640830">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640839">i1</span>&nbsp;<span class="op" id="5640842">+=</span>&nbsp;<span class="ident" id="5640845">dst</span><span class="op" id="5640848">.</span><span class="ident" id="5640849">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640858">mi0</span>&nbsp;<span class="op" id="5640862">+=</span>&nbsp;<span class="ident" id="5640865">mask</span><span class="op" id="5640869">.</span><span class="ident" id="5640870">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640878">}</span><br>
<span class="lineno"></span><span class="op" id="5640880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5640883">func</span>&nbsp;<span class="ident" id="5640888">drawRGBA</span><span class="op" id="5640896">(</span><span class="ident" id="5640897">dst</span>&nbsp;<span class="op" id="5640901">*</span><span class="ident" id="5640902">image</span><span class="op" id="5640907">.</span><span class="ident" id="5640908">RGBA</span><span class="op" id="5640912">,</span>&nbsp;<span class="ident" id="5640914">r</span>&nbsp;<span class="ident" id="5640916">image</span><span class="op" id="5640921">.</span><span class="ident" id="5640922">Rectangle</span><span class="op" id="5640931">,</span>&nbsp;<span class="ident" id="5640933">src</span>&nbsp;<span class="ident" id="5640937">image</span><span class="op" id="5640942">.</span><span class="ident" id="5640943">Image</span><span class="op" id="5640948">,</span>&nbsp;<span class="ident" id="5640950">sp</span>&nbsp;<span class="ident" id="5640953">image</span><span class="op" id="5640958">.</span><span class="ident" id="5640959">Point</span><span class="op" id="5640964">,</span>&nbsp;<span class="ident" id="5640966">mask</span>&nbsp;<span class="ident" id="5640971">image</span><span class="op" id="5640976">.</span><span class="ident" id="5640977">Image</span><span class="op" id="5640982">,</span>&nbsp;<span class="ident" id="5640984">mp</span>&nbsp;<span class="ident" id="5640987">image</span><span class="op" id="5640992">.</span><span class="ident" id="5640993">Point</span><span class="op" id="5640998">,</span>&nbsp;<span class="ident" id="5641000">op</span>&nbsp;<span class="ident" id="5641003">Op</span><span class="op" id="5641005">)</span>&nbsp;<span class="op" id="5641007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641010">x0</span><span class="op" id="5641012">,</span>&nbsp;<span class="ident" id="5641014">x1</span><span class="op" id="5641016">,</span>&nbsp;<span class="ident" id="5641018">dx</span>&nbsp;<span class="op" id="5641021">:=</span>&nbsp;<span class="ident" id="5641024">r</span><span class="op" id="5641025">.</span><span class="ident" id="5641026">Min</span><span class="op" id="5641029">.</span><span class="ident" id="5641030">X</span><span class="op" id="5641031">,</span>&nbsp;<span class="ident" id="5641033">r</span><span class="op" id="5641034">.</span><span class="ident" id="5641035">Max</span><span class="op" id="5641038">.</span><span class="ident" id="5641039">X</span><span class="op" id="5641040">,</span>&nbsp;<span class="num" id="5641042">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641045">y0</span><span class="op" id="5641047">,</span>&nbsp;<span class="ident" id="5641049">y1</span><span class="op" id="5641051">,</span>&nbsp;<span class="ident" id="5641053">dy</span>&nbsp;<span class="op" id="5641056">:=</span>&nbsp;<span class="ident" id="5641059">r</span><span class="op" id="5641060">.</span><span class="ident" id="5641061">Min</span><span class="op" id="5641064">.</span><span class="ident" id="5641065">Y</span><span class="op" id="5641066">,</span>&nbsp;<span class="ident" id="5641068">r</span><span class="op" id="5641069">.</span><span class="ident" id="5641070">Max</span><span class="op" id="5641073">.</span><span class="ident" id="5641074">Y</span><span class="op" id="5641075">,</span>&nbsp;<span class="num" id="5641077">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641080">if</span>&nbsp;<span class="ident" id="5641083">image</span><span class="op" id="5641088">.</span><span class="ident" id="5641089">Image</span><span class="op" id="5641094">(</span><span class="ident" id="5641095">dst</span><span class="op" id="5641098">)</span>&nbsp;<span class="op" id="5641100">==</span>&nbsp;<span class="ident" id="5641103">src</span>&nbsp;<span class="op" id="5641107">&amp;&amp;</span>&nbsp;<span class="ident" id="5641110">r</span><span class="op" id="5641111">.</span><span class="ident" id="5641112">Overlaps</span><span class="op" id="5641120">(</span><span class="ident" id="5641121">r</span><span class="op" id="5641122">.</span><span class="ident" id="5641123">Add</span><span class="op" id="5641126">(</span><span class="ident" id="5641127">sp</span><span class="op" id="5641129">.</span><span class="ident" id="5641130">Sub</span><span class="op" id="5641133">(</span><span class="ident" id="5641134">r</span><span class="op" id="5641135">.</span><span class="ident" id="5641136">Min</span><span class="op" id="5641139">)</span><span class="op" id="5641140">)</span><span class="op" id="5641141">)</span>&nbsp;<span class="op" id="5641143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641147">if</span>&nbsp;<span class="ident" id="5641150">sp</span><span class="op" id="5641152">.</span><span class="ident" id="5641153">Y</span>&nbsp;<span class="op" id="5641155">&lt;</span>&nbsp;<span class="ident" id="5641157">r</span><span class="op" id="5641158">.</span><span class="ident" id="5641159">Min</span><span class="op" id="5641162">.</span><span class="ident" id="5641163">Y</span>&nbsp;<span class="op" id="5641165">||</span>&nbsp;<span class="ident" id="5641168">sp</span><span class="op" id="5641170">.</span><span class="ident" id="5641171">Y</span>&nbsp;<span class="op" id="5641173">==</span>&nbsp;<span class="ident" id="5641176">r</span><span class="op" id="5641177">.</span><span class="ident" id="5641178">Min</span><span class="op" id="5641181">.</span><span class="ident" id="5641182">Y</span>&nbsp;<span class="op" id="5641184">&amp;&amp;</span>&nbsp;<span class="ident" id="5641187">sp</span><span class="op" id="5641189">.</span><span class="ident" id="5641190">X</span>&nbsp;<span class="op" id="5641192">&lt;</span>&nbsp;<span class="ident" id="5641194">r</span><span class="op" id="5641195">.</span><span class="ident" id="5641196">Min</span><span class="op" id="5641199">.</span><span class="ident" id="5641200">X</span>&nbsp;<span class="op" id="5641202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641207">x0</span><span class="op" id="5641209">,</span>&nbsp;<span class="ident" id="5641211">x1</span><span class="op" id="5641213">,</span>&nbsp;<span class="ident" id="5641215">dx</span>&nbsp;<span class="op" id="5641218">=</span>&nbsp;<span class="ident" id="5641220">x1</span><span class="op" id="5641222">-</span><span class="num" id="5641223">1</span><span class="op" id="5641224">,</span>&nbsp;<span class="ident" id="5641226">x0</span><span class="op" id="5641228">-</span><span class="num" id="5641229">1</span><span class="op" id="5641230">,</span>&nbsp;<span class="op" id="5641232">-</span><span class="num" id="5641233">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641238">y0</span><span class="op" id="5641240">,</span>&nbsp;<span class="ident" id="5641242">y1</span><span class="op" id="5641244">,</span>&nbsp;<span class="ident" id="5641246">dy</span>&nbsp;<span class="op" id="5641249">=</span>&nbsp;<span class="ident" id="5641251">y1</span><span class="op" id="5641253">-</span><span class="num" id="5641254">1</span><span class="op" id="5641255">,</span>&nbsp;<span class="ident" id="5641257">y0</span><span class="op" id="5641259">-</span><span class="num" id="5641260">1</span><span class="op" id="5641261">,</span>&nbsp;<span class="op" id="5641263">-</span><span class="num" id="5641264">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641275">sy</span>&nbsp;<span class="op" id="5641278">:=</span>&nbsp;<span class="ident" id="5641281">sp</span><span class="op" id="5641283">.</span><span class="ident" id="5641284">Y</span>&nbsp;<span class="op" id="5641286">+</span>&nbsp;<span class="ident" id="5641288">y0</span>&nbsp;<span class="op" id="5641291">-</span>&nbsp;<span class="ident" id="5641293">r</span><span class="op" id="5641294">.</span><span class="ident" id="5641295">Min</span><span class="op" id="5641298">.</span><span class="ident" id="5641299">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641302">my</span>&nbsp;<span class="op" id="5641305">:=</span>&nbsp;<span class="ident" id="5641308">mp</span><span class="op" id="5641310">.</span><span class="ident" id="5641311">Y</span>&nbsp;<span class="op" id="5641313">+</span>&nbsp;<span class="ident" id="5641315">y0</span>&nbsp;<span class="op" id="5641318">-</span>&nbsp;<span class="ident" id="5641320">r</span><span class="op" id="5641321">.</span><span class="ident" id="5641322">Min</span><span class="op" id="5641325">.</span><span class="ident" id="5641326">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641329">sx0</span>&nbsp;<span class="op" id="5641333">:=</span>&nbsp;<span class="ident" id="5641336">sp</span><span class="op" id="5641338">.</span><span class="ident" id="5641339">X</span>&nbsp;<span class="op" id="5641341">+</span>&nbsp;<span class="ident" id="5641343">x0</span>&nbsp;<span class="op" id="5641346">-</span>&nbsp;<span class="ident" id="5641348">r</span><span class="op" id="5641349">.</span><span class="ident" id="5641350">Min</span><span class="op" id="5641353">.</span><span class="ident" id="5641354">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641357">mx0</span>&nbsp;<span class="op" id="5641361">:=</span>&nbsp;<span class="ident" id="5641364">mp</span><span class="op" id="5641366">.</span><span class="ident" id="5641367">X</span>&nbsp;<span class="op" id="5641369">+</span>&nbsp;<span class="ident" id="5641371">x0</span>&nbsp;<span class="op" id="5641374">-</span>&nbsp;<span class="ident" id="5641376">r</span><span class="op" id="5641377">.</span><span class="ident" id="5641378">Min</span><span class="op" id="5641381">.</span><span class="ident" id="5641382">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641385">sx1</span>&nbsp;<span class="op" id="5641389">:=</span>&nbsp;<span class="ident" id="5641392">sx0</span>&nbsp;<span class="op" id="5641396">+</span>&nbsp;<span class="op" id="5641398">(</span><span class="ident" id="5641399">x1</span>&nbsp;<span class="op" id="5641402">-</span>&nbsp;<span class="ident" id="5641404">x0</span><span class="op" id="5641406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641409">i0</span>&nbsp;<span class="op" id="5641412">:=</span>&nbsp;<span class="ident" id="5641415">dst</span><span class="op" id="5641418">.</span><span class="ident" id="5641419">PixOffset</span><span class="op" id="5641428">(</span><span class="ident" id="5641429">x0</span><span class="op" id="5641431">,</span>&nbsp;<span class="ident" id="5641433">y0</span><span class="op" id="5641435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641438">di</span>&nbsp;<span class="op" id="5641441">:=</span>&nbsp;<span class="ident" id="5641444">dx</span>&nbsp;<span class="op" id="5641447">*</span>&nbsp;<span class="num" id="5641449">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641452">for</span>&nbsp;<span class="ident" id="5641456">y</span>&nbsp;<span class="op" id="5641458">:=</span>&nbsp;<span class="ident" id="5641461">y0</span><span class="op" id="5641463">;</span>&nbsp;<span class="ident" id="5641465">y</span>&nbsp;<span class="op" id="5641467">!=</span>&nbsp;<span class="ident" id="5641470">y1</span><span class="op" id="5641472">;</span>&nbsp;<span class="ident" id="5641474">y</span><span class="op" id="5641475">,</span>&nbsp;<span class="ident" id="5641477">sy</span><span class="op" id="5641479">,</span>&nbsp;<span class="ident" id="5641481">my</span>&nbsp;<span class="op" id="5641484">=</span>&nbsp;<span class="ident" id="5641486">y</span><span class="op" id="5641487">+</span><span class="ident" id="5641488">dy</span><span class="op" id="5641490">,</span>&nbsp;<span class="ident" id="5641492">sy</span><span class="op" id="5641494">+</span><span class="ident" id="5641495">dy</span><span class="op" id="5641497">,</span>&nbsp;<span class="ident" id="5641499">my</span><span class="op" id="5641501">+</span><span class="ident" id="5641502">dy</span>&nbsp;<span class="op" id="5641505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641509">for</span>&nbsp;<span class="ident" id="5641513">i</span><span class="op" id="5641514">,</span>&nbsp;<span class="ident" id="5641516">sx</span><span class="op" id="5641518">,</span>&nbsp;<span class="ident" id="5641520">mx</span>&nbsp;<span class="op" id="5641523">:=</span>&nbsp;<span class="ident" id="5641526">i0</span><span class="op" id="5641528">,</span>&nbsp;<span class="ident" id="5641530">sx0</span><span class="op" id="5641533">,</span>&nbsp;<span class="ident" id="5641535">mx0</span><span class="op" id="5641538">;</span>&nbsp;<span class="ident" id="5641540">sx</span>&nbsp;<span class="op" id="5641543">!=</span>&nbsp;<span class="ident" id="5641546">sx1</span><span class="op" id="5641549">;</span>&nbsp;<span class="ident" id="5641551">i</span><span class="op" id="5641552">,</span>&nbsp;<span class="ident" id="5641554">sx</span><span class="op" id="5641556">,</span>&nbsp;<span class="ident" id="5641558">mx</span>&nbsp;<span class="op" id="5641561">=</span>&nbsp;<span class="ident" id="5641563">i</span><span class="op" id="5641564">+</span><span class="ident" id="5641565">di</span><span class="op" id="5641567">,</span>&nbsp;<span class="ident" id="5641569">sx</span><span class="op" id="5641571">+</span><span class="ident" id="5641572">dx</span><span class="op" id="5641574">,</span>&nbsp;<span class="ident" id="5641576">mx</span><span class="op" id="5641578">+</span><span class="ident" id="5641579">dx</span>&nbsp;<span class="op" id="5641582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641587">ma</span>&nbsp;<span class="op" id="5641590">:=</span>&nbsp;<span class="builtintype" id="5641593">uint32</span><span class="op" id="5641599">(</span><span class="ident" id="5641600">m</span><span class="op" id="5641601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641606">if</span>&nbsp;<span class="ident" id="5641609">mask</span>&nbsp;<span class="op" id="5641614">!=</span>&nbsp;<span class="ident" id="5641617">nil</span>&nbsp;<span class="op" id="5641621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641627">_</span><span class="op" id="5641628">,</span>&nbsp;<span class="ident" id="5641630">_</span><span class="op" id="5641631">,</span>&nbsp;<span class="ident" id="5641633">_</span><span class="op" id="5641634">,</span>&nbsp;<span class="ident" id="5641636">ma</span>&nbsp;<span class="op" id="5641639">=</span>&nbsp;<span class="ident" id="5641641">mask</span><span class="op" id="5641645">.</span><span class="ident" id="5641646">At</span><span class="op" id="5641648">(</span><span class="ident" id="5641649">mx</span><span class="op" id="5641651">,</span>&nbsp;<span class="ident" id="5641653">my</span><span class="op" id="5641655">)</span><span class="op" id="5641656">.</span><span class="ident" id="5641657">RGBA</span><span class="op" id="5641661">(</span><span class="op" id="5641662">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641672">sr</span><span class="op" id="5641674">,</span>&nbsp;<span class="ident" id="5641676">sg</span><span class="op" id="5641678">,</span>&nbsp;<span class="ident" id="5641680">sb</span><span class="op" id="5641682">,</span>&nbsp;<span class="ident" id="5641684">sa</span>&nbsp;<span class="op" id="5641687">:=</span>&nbsp;<span class="ident" id="5641690">src</span><span class="op" id="5641693">.</span><span class="ident" id="5641694">At</span><span class="op" id="5641696">(</span><span class="ident" id="5641697">sx</span><span class="op" id="5641699">,</span>&nbsp;<span class="ident" id="5641701">sy</span><span class="op" id="5641703">)</span><span class="op" id="5641704">.</span><span class="ident" id="5641705">RGBA</span><span class="op" id="5641709">(</span><span class="op" id="5641710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641715">if</span>&nbsp;<span class="ident" id="5641718">op</span>&nbsp;<span class="op" id="5641721">==</span>&nbsp;<span class="ident" id="5641724">Over</span>&nbsp;<span class="op" id="5641729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641735">dr</span>&nbsp;<span class="op" id="5641738">:=</span>&nbsp;<span class="builtintype" id="5641741">uint32</span><span class="op" id="5641747">(</span><span class="ident" id="5641748">dst</span><span class="op" id="5641751">.</span><span class="ident" id="5641752">Pix</span><span class="op" id="5641755">[</span><span class="ident" id="5641756">i</span><span class="op" id="5641757">+</span><span class="num" id="5641758">0</span><span class="op" id="5641759">]</span><span class="op" id="5641760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641766">dg</span>&nbsp;<span class="op" id="5641769">:=</span>&nbsp;<span class="builtintype" id="5641772">uint32</span><span class="op" id="5641778">(</span><span class="ident" id="5641779">dst</span><span class="op" id="5641782">.</span><span class="ident" id="5641783">Pix</span><span class="op" id="5641786">[</span><span class="ident" id="5641787">i</span><span class="op" id="5641788">+</span><span class="num" id="5641789">1</span><span class="op" id="5641790">]</span><span class="op" id="5641791">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641797">db</span>&nbsp;<span class="op" id="5641800">:=</span>&nbsp;<span class="builtintype" id="5641803">uint32</span><span class="op" id="5641809">(</span><span class="ident" id="5641810">dst</span><span class="op" id="5641813">.</span><span class="ident" id="5641814">Pix</span><span class="op" id="5641817">[</span><span class="ident" id="5641818">i</span><span class="op" id="5641819">+</span><span class="num" id="5641820">2</span><span class="op" id="5641821">]</span><span class="op" id="5641822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641828">da</span>&nbsp;<span class="op" id="5641831">:=</span>&nbsp;<span class="builtintype" id="5641834">uint32</span><span class="op" id="5641840">(</span><span class="ident" id="5641841">dst</span><span class="op" id="5641844">.</span><span class="ident" id="5641845">Pix</span><span class="op" id="5641848">[</span><span class="ident" id="5641849">i</span><span class="op" id="5641850">+</span><span class="num" id="5641851">3</span><span class="op" id="5641852">]</span><span class="op" id="5641853">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641860">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641940">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5641998">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642019">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642085">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642150">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642222">a</span>&nbsp;<span class="op" id="5642224">:=</span>&nbsp;<span class="op" id="5642227">(</span><span class="ident" id="5642228">m</span>&nbsp;<span class="op" id="5642230">-</span>&nbsp;<span class="op" id="5642232">(</span><span class="ident" id="5642233">sa</span>&nbsp;<span class="op" id="5642236">*</span>&nbsp;<span class="ident" id="5642238">ma</span>&nbsp;<span class="op" id="5642241">/</span>&nbsp;<span class="ident" id="5642243">m</span><span class="op" id="5642244">)</span><span class="op" id="5642245">)</span>&nbsp;<span class="op" id="5642247">*</span>&nbsp;<span class="num" id="5642249">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642260">dst</span><span class="op" id="5642263">.</span><span class="ident" id="5642264">Pix</span><span class="op" id="5642267">[</span><span class="ident" id="5642268">i</span><span class="op" id="5642269">+</span><span class="num" id="5642270">0</span><span class="op" id="5642271">]</span>&nbsp;<span class="op" id="5642273">=</span>&nbsp;<span class="builtintype" id="5642275">uint8</span><span class="op" id="5642280">(</span><span class="op" id="5642281">(</span><span class="ident" id="5642282">dr</span><span class="op" id="5642284">*</span><span class="ident" id="5642285">a</span>&nbsp;<span class="op" id="5642287">+</span>&nbsp;<span class="ident" id="5642289">sr</span><span class="op" id="5642291">*</span><span class="ident" id="5642292">ma</span><span class="op" id="5642294">)</span>&nbsp;<span class="op" id="5642296">/</span>&nbsp;<span class="ident" id="5642298">m</span>&nbsp;<span class="op" id="5642300">&gt;&gt;</span>&nbsp;<span class="num" id="5642303">8</span><span class="op" id="5642304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642310">dst</span><span class="op" id="5642313">.</span><span class="ident" id="5642314">Pix</span><span class="op" id="5642317">[</span><span class="ident" id="5642318">i</span><span class="op" id="5642319">+</span><span class="num" id="5642320">1</span><span class="op" id="5642321">]</span>&nbsp;<span class="op" id="5642323">=</span>&nbsp;<span class="builtintype" id="5642325">uint8</span><span class="op" id="5642330">(</span><span class="op" id="5642331">(</span><span class="ident" id="5642332">dg</span><span class="op" id="5642334">*</span><span class="ident" id="5642335">a</span>&nbsp;<span class="op" id="5642337">+</span>&nbsp;<span class="ident" id="5642339">sg</span><span class="op" id="5642341">*</span><span class="ident" id="5642342">ma</span><span class="op" id="5642344">)</span>&nbsp;<span class="op" id="5642346">/</span>&nbsp;<span class="ident" id="5642348">m</span>&nbsp;<span class="op" id="5642350">&gt;&gt;</span>&nbsp;<span class="num" id="5642353">8</span><span class="op" id="5642354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642360">dst</span><span class="op" id="5642363">.</span><span class="ident" id="5642364">Pix</span><span class="op" id="5642367">[</span><span class="ident" id="5642368">i</span><span class="op" id="5642369">+</span><span class="num" id="5642370">2</span><span class="op" id="5642371">]</span>&nbsp;<span class="op" id="5642373">=</span>&nbsp;<span class="builtintype" id="5642375">uint8</span><span class="op" id="5642380">(</span><span class="op" id="5642381">(</span><span class="ident" id="5642382">db</span><span class="op" id="5642384">*</span><span class="ident" id="5642385">a</span>&nbsp;<span class="op" id="5642387">+</span>&nbsp;<span class="ident" id="5642389">sb</span><span class="op" id="5642391">*</span><span class="ident" id="5642392">ma</span><span class="op" id="5642394">)</span>&nbsp;<span class="op" id="5642396">/</span>&nbsp;<span class="ident" id="5642398">m</span>&nbsp;<span class="op" id="5642400">&gt;&gt;</span>&nbsp;<span class="num" id="5642403">8</span><span class="op" id="5642404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642410">dst</span><span class="op" id="5642413">.</span><span class="ident" id="5642414">Pix</span><span class="op" id="5642417">[</span><span class="ident" id="5642418">i</span><span class="op" id="5642419">+</span><span class="num" id="5642420">3</span><span class="op" id="5642421">]</span>&nbsp;<span class="op" id="5642423">=</span>&nbsp;<span class="builtintype" id="5642425">uint8</span><span class="op" id="5642430">(</span><span class="op" id="5642431">(</span><span class="ident" id="5642432">da</span><span class="op" id="5642434">*</span><span class="ident" id="5642435">a</span>&nbsp;<span class="op" id="5642437">+</span>&nbsp;<span class="ident" id="5642439">sa</span><span class="op" id="5642441">*</span><span class="ident" id="5642442">ma</span><span class="op" id="5642444">)</span>&nbsp;<span class="op" id="5642446">/</span>&nbsp;<span class="ident" id="5642448">m</span>&nbsp;<span class="op" id="5642450">&gt;&gt;</span>&nbsp;<span class="num" id="5642453">8</span><span class="op" id="5642454">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642460">}</span>&nbsp;<span class="keyword" id="5642462">else</span>&nbsp;<span class="op" id="5642467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642473">dst</span><span class="op" id="5642476">.</span><span class="ident" id="5642477">Pix</span><span class="op" id="5642480">[</span><span class="ident" id="5642481">i</span><span class="op" id="5642482">+</span><span class="num" id="5642483">0</span><span class="op" id="5642484">]</span>&nbsp;<span class="op" id="5642486">=</span>&nbsp;<span class="builtintype" id="5642488">uint8</span><span class="op" id="5642493">(</span><span class="ident" id="5642494">sr</span>&nbsp;<span class="op" id="5642497">*</span>&nbsp;<span class="ident" id="5642499">ma</span>&nbsp;<span class="op" id="5642502">/</span>&nbsp;<span class="ident" id="5642504">m</span>&nbsp;<span class="op" id="5642506">&gt;&gt;</span>&nbsp;<span class="num" id="5642509">8</span><span class="op" id="5642510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642516">dst</span><span class="op" id="5642519">.</span><span class="ident" id="5642520">Pix</span><span class="op" id="5642523">[</span><span class="ident" id="5642524">i</span><span class="op" id="5642525">+</span><span class="num" id="5642526">1</span><span class="op" id="5642527">]</span>&nbsp;<span class="op" id="5642529">=</span>&nbsp;<span class="builtintype" id="5642531">uint8</span><span class="op" id="5642536">(</span><span class="ident" id="5642537">sg</span>&nbsp;<span class="op" id="5642540">*</span>&nbsp;<span class="ident" id="5642542">ma</span>&nbsp;<span class="op" id="5642545">/</span>&nbsp;<span class="ident" id="5642547">m</span>&nbsp;<span class="op" id="5642549">&gt;&gt;</span>&nbsp;<span class="num" id="5642552">8</span><span class="op" id="5642553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642559">dst</span><span class="op" id="5642562">.</span><span class="ident" id="5642563">Pix</span><span class="op" id="5642566">[</span><span class="ident" id="5642567">i</span><span class="op" id="5642568">+</span><span class="num" id="5642569">2</span><span class="op" id="5642570">]</span>&nbsp;<span class="op" id="5642572">=</span>&nbsp;<span class="builtintype" id="5642574">uint8</span><span class="op" id="5642579">(</span><span class="ident" id="5642580">sb</span>&nbsp;<span class="op" id="5642583">*</span>&nbsp;<span class="ident" id="5642585">ma</span>&nbsp;<span class="op" id="5642588">/</span>&nbsp;<span class="ident" id="5642590">m</span>&nbsp;<span class="op" id="5642592">&gt;&gt;</span>&nbsp;<span class="num" id="5642595">8</span><span class="op" id="5642596">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642602">dst</span><span class="op" id="5642605">.</span><span class="ident" id="5642606">Pix</span><span class="op" id="5642609">[</span><span class="ident" id="5642610">i</span><span class="op" id="5642611">+</span><span class="num" id="5642612">3</span><span class="op" id="5642613">]</span>&nbsp;<span class="op" id="5642615">=</span>&nbsp;<span class="builtintype" id="5642617">uint8</span><span class="op" id="5642622">(</span><span class="ident" id="5642623">sa</span>&nbsp;<span class="op" id="5642626">*</span>&nbsp;<span class="ident" id="5642628">ma</span>&nbsp;<span class="op" id="5642631">/</span>&nbsp;<span class="ident" id="5642633">m</span>&nbsp;<span class="op" id="5642635">&gt;&gt;</span>&nbsp;<span class="num" id="5642638">8</span><span class="op" id="5642639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642652">i0</span>&nbsp;<span class="op" id="5642655">+=</span>&nbsp;<span class="ident" id="5642658">dy</span>&nbsp;<span class="op" id="5642661">*</span>&nbsp;<span class="ident" id="5642663">dst</span><span class="op" id="5642666">.</span><span class="ident" id="5642667">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642675">}</span><br>
<span class="lineno">545</span><span class="op" id="5642677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5642680">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5642727">func</span>&nbsp;<span class="ident" id="5642732">clamp</span><span class="op" id="5642737">(</span><span class="ident" id="5642738">i</span>&nbsp;<span class="builtintype" id="5642740">int32</span><span class="op" id="5642745">)</span>&nbsp;<span class="builtintype" id="5642747">int32</span>&nbsp;<span class="op" id="5642753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642756">if</span>&nbsp;<span class="ident" id="5642759">i</span>&nbsp;<span class="op" id="5642761">&lt;</span>&nbsp;<span class="num" id="5642763">0</span>&nbsp;<span class="op" id="5642765">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642769">return</span>&nbsp;<span class="num" id="5642776">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642782">if</span>&nbsp;<span class="ident" id="5642785">i</span>&nbsp;<span class="op" id="5642787">&gt;</span>&nbsp;<span class="num" id="5642789">0xffff</span>&nbsp;<span class="op" id="5642796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642800">return</span>&nbsp;<span class="num" id="5642807">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642815">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642818">return</span>&nbsp;<span class="ident" id="5642825">i</span><br>
<span class="lineno"></span><span class="op" id="5642827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5642830">func</span>&nbsp;<span class="ident" id="5642835">drawPaletted</span><span class="op" id="5642847">(</span><span class="ident" id="5642848">dst</span>&nbsp;<span class="ident" id="5642852">Image</span><span class="op" id="5642857">,</span>&nbsp;<span class="ident" id="5642859">r</span>&nbsp;<span class="ident" id="5642861">image</span><span class="op" id="5642866">.</span><span class="ident" id="5642867">Rectangle</span><span class="op" id="5642876">,</span>&nbsp;<span class="ident" id="5642878">src</span>&nbsp;<span class="ident" id="5642882">image</span><span class="op" id="5642887">.</span><span class="ident" id="5642888">Image</span><span class="op" id="5642893">,</span>&nbsp;<span class="ident" id="5642895">sp</span>&nbsp;<span class="ident" id="5642898">image</span><span class="op" id="5642903">.</span><span class="ident" id="5642904">Point</span><span class="op" id="5642909">,</span>&nbsp;<span class="ident" id="5642911">floydSteinberg</span>&nbsp;<span class="builtintype" id="5642926">bool</span><span class="op" id="5642930">)</span>&nbsp;<span class="op" id="5642932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5642935">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643002">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643067">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643130">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643200">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643271">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643342">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643388">palette</span><span class="op" id="5643395">,</span>&nbsp;<span class="ident" id="5643397">pix</span><span class="op" id="5643400">,</span>&nbsp;<span class="ident" id="5643402">stride</span>&nbsp;<span class="op" id="5643409">:=</span>&nbsp;<span class="op" id="5643412">[</span><span class="op" id="5643413">]</span><span class="op" id="5643414">[</span><span class="num" id="5643415">3</span><span class="op" id="5643416">]</span><span class="builtintype" id="5643417">int32</span><span class="op" id="5643422">(</span><span class="ident" id="5643423">nil</span><span class="op" id="5643426">)</span><span class="op" id="5643427">,</span>&nbsp;<span class="op" id="5643429">[</span><span class="op" id="5643430">]</span><span class="builtintype" id="5643431">byte</span><span class="op" id="5643435">(</span><span class="ident" id="5643436">nil</span><span class="op" id="5643439">)</span><span class="op" id="5643440">,</span>&nbsp;<span class="num" id="5643442">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643445">if</span>&nbsp;<span class="ident" id="5643448">p</span><span class="op" id="5643449">,</span>&nbsp;<span class="ident" id="5643451">ok</span>&nbsp;<span class="op" id="5643454">:=</span>&nbsp;<span class="ident" id="5643457">dst</span><span class="op" id="5643460">.</span><span class="op" id="5643461">(</span><span class="op" id="5643462">*</span><span class="ident" id="5643463">image</span><span class="op" id="5643468">.</span><span class="ident" id="5643469">Paletted</span><span class="op" id="5643477">)</span><span class="op" id="5643478">;</span>&nbsp;<span class="ident" id="5643480">ok</span>&nbsp;<span class="op" id="5643483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643487">palette</span>&nbsp;<span class="op" id="5643495">=</span>&nbsp;<span class="builtinfunc" id="5643497">make</span><span class="op" id="5643501">(</span><span class="op" id="5643502">[</span><span class="op" id="5643503">]</span><span class="op" id="5643504">[</span><span class="num" id="5643505">3</span><span class="op" id="5643506">]</span><span class="builtintype" id="5643507">int32</span><span class="op" id="5643512">,</span>&nbsp;<span class="builtinfunc" id="5643514">len</span><span class="op" id="5643517">(</span><span class="ident" id="5643518">p</span><span class="op" id="5643519">.</span><span class="ident" id="5643520">Palette</span><span class="op" id="5643527">)</span><span class="op" id="5643528">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643532">for</span>&nbsp;<span class="ident" id="5643536">i</span><span class="op" id="5643537">,</span>&nbsp;<span class="ident" id="5643539">col</span>&nbsp;<span class="op" id="5643543">:=</span>&nbsp;<span class="keyword" id="5643546">range</span>&nbsp;<span class="ident" id="5643552">p</span><span class="op" id="5643553">.</span><span class="ident" id="5643554">Palette</span>&nbsp;<span class="op" id="5643562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643567">r</span><span class="op" id="5643568">,</span>&nbsp;<span class="ident" id="5643570">g</span><span class="op" id="5643571">,</span>&nbsp;<span class="ident" id="5643573">b</span><span class="op" id="5643574">,</span>&nbsp;<span class="ident" id="5643576">_</span>&nbsp;<span class="op" id="5643578">:=</span>&nbsp;<span class="ident" id="5643581">col</span><span class="op" id="5643584">.</span><span class="ident" id="5643585">RGBA</span><span class="op" id="5643589">(</span><span class="op" id="5643590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643595">palette</span><span class="op" id="5643602">[</span><span class="ident" id="5643603">i</span><span class="op" id="5643604">]</span><span class="op" id="5643605">[</span><span class="num" id="5643606">0</span><span class="op" id="5643607">]</span>&nbsp;<span class="op" id="5643609">=</span>&nbsp;<span class="builtintype" id="5643611">int32</span><span class="op" id="5643616">(</span><span class="ident" id="5643617">r</span><span class="op" id="5643618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643623">palette</span><span class="op" id="5643630">[</span><span class="ident" id="5643631">i</span><span class="op" id="5643632">]</span><span class="op" id="5643633">[</span><span class="num" id="5643634">1</span><span class="op" id="5643635">]</span>&nbsp;<span class="op" id="5643637">=</span>&nbsp;<span class="builtintype" id="5643639">int32</span><span class="op" id="5643644">(</span><span class="ident" id="5643645">g</span><span class="op" id="5643646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643651">palette</span><span class="op" id="5643658">[</span><span class="ident" id="5643659">i</span><span class="op" id="5643660">]</span><span class="op" id="5643661">[</span><span class="num" id="5643662">2</span><span class="op" id="5643663">]</span>&nbsp;<span class="op" id="5643665">=</span>&nbsp;<span class="builtintype" id="5643667">int32</span><span class="op" id="5643672">(</span><span class="ident" id="5643673">b</span><span class="op" id="5643674">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643682">pix</span><span class="op" id="5643685">,</span>&nbsp;<span class="ident" id="5643687">stride</span>&nbsp;<span class="op" id="5643694">=</span>&nbsp;<span class="ident" id="5643696">p</span><span class="op" id="5643697">.</span><span class="ident" id="5643698">Pix</span><span class="op" id="5643701">[</span><span class="ident" id="5643702">p</span><span class="op" id="5643703">.</span><span class="ident" id="5643704">PixOffset</span><span class="op" id="5643713">(</span><span class="ident" id="5643714">r</span><span class="op" id="5643715">.</span><span class="ident" id="5643716">Min</span><span class="op" id="5643719">.</span><span class="ident" id="5643720">X</span><span class="op" id="5643721">,</span>&nbsp;<span class="ident" id="5643723">r</span><span class="op" id="5643724">.</span><span class="ident" id="5643725">Min</span><span class="op" id="5643728">.</span><span class="ident" id="5643729">Y</span><span class="op" id="5643730">)</span><span class="op" id="5643731">:</span><span class="op" id="5643732">]</span><span class="op" id="5643733">,</span>&nbsp;<span class="ident" id="5643735">p</span><span class="op" id="5643736">.</span><span class="ident" id="5643737">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643749">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643824">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5643899">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643955">var</span>&nbsp;<span class="ident" id="5643959">quantErrorCurr</span><span class="op" id="5643973">,</span>&nbsp;<span class="ident" id="5643975">quantErrorNext</span>&nbsp;<span class="op" id="5643990">[</span><span class="op" id="5643991">]</span><span class="op" id="5643992">[</span><span class="num" id="5643993">3</span><span class="op" id="5643994">]</span><span class="builtintype" id="5643995">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644002">if</span>&nbsp;<span class="ident" id="5644005">floydSteinberg</span>&nbsp;<span class="op" id="5644020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644024">quantErrorCurr</span>&nbsp;<span class="op" id="5644039">=</span>&nbsp;<span class="builtinfunc" id="5644041">make</span><span class="op" id="5644045">(</span><span class="op" id="5644046">[</span><span class="op" id="5644047">]</span><span class="op" id="5644048">[</span><span class="num" id="5644049">3</span><span class="op" id="5644050">]</span><span class="builtintype" id="5644051">int32</span><span class="op" id="5644056">,</span>&nbsp;<span class="ident" id="5644058">r</span><span class="op" id="5644059">.</span><span class="ident" id="5644060">Dx</span><span class="op" id="5644062">(</span><span class="op" id="5644063">)</span><span class="op" id="5644064">+</span><span class="num" id="5644065">2</span><span class="op" id="5644066">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644070">quantErrorNext</span>&nbsp;<span class="op" id="5644085">=</span>&nbsp;<span class="builtinfunc" id="5644087">make</span><span class="op" id="5644091">(</span><span class="op" id="5644092">[</span><span class="op" id="5644093">]</span><span class="op" id="5644094">[</span><span class="num" id="5644095">3</span><span class="op" id="5644096">]</span><span class="builtintype" id="5644097">int32</span><span class="op" id="5644102">,</span>&nbsp;<span class="ident" id="5644104">r</span><span class="op" id="5644105">.</span><span class="ident" id="5644106">Dx</span><span class="op" id="5644108">(</span><span class="op" id="5644109">)</span><span class="op" id="5644110">+</span><span class="num" id="5644111">2</span><span class="op" id="5644112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644119">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644152">out</span>&nbsp;<span class="op" id="5644156">:=</span>&nbsp;<span class="ident" id="5644159">color</span><span class="op" id="5644164">.</span><span class="ident" id="5644165">RGBA64</span><span class="op" id="5644171">{</span><span class="ident" id="5644172">A</span><span class="op" id="5644173">:</span>&nbsp;<span class="num" id="5644175">0xffff</span><span class="op" id="5644181">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644184">for</span>&nbsp;<span class="ident" id="5644188">y</span>&nbsp;<span class="op" id="5644190">:=</span>&nbsp;<span class="num" id="5644193">0</span><span class="op" id="5644194">;</span>&nbsp;<span class="ident" id="5644196">y</span>&nbsp;<span class="op" id="5644198">!=</span>&nbsp;<span class="ident" id="5644201">r</span><span class="op" id="5644202">.</span><span class="ident" id="5644203">Dy</span><span class="op" id="5644205">(</span><span class="op" id="5644206">)</span><span class="op" id="5644207">;</span>&nbsp;<span class="ident" id="5644209">y</span><span class="op" id="5644210">++</span>&nbsp;<span class="op" id="5644213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644217">for</span>&nbsp;<span class="ident" id="5644221">x</span>&nbsp;<span class="op" id="5644223">:=</span>&nbsp;<span class="num" id="5644226">0</span><span class="op" id="5644227">;</span>&nbsp;<span class="ident" id="5644229">x</span>&nbsp;<span class="op" id="5644231">!=</span>&nbsp;<span class="ident" id="5644234">r</span><span class="op" id="5644235">.</span><span class="ident" id="5644236">Dx</span><span class="op" id="5644238">(</span><span class="op" id="5644239">)</span><span class="op" id="5644240">;</span>&nbsp;<span class="ident" id="5644242">x</span><span class="op" id="5644243">++</span>&nbsp;<span class="op" id="5644246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644251">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644309">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644347">sr</span><span class="op" id="5644349">,</span>&nbsp;<span class="ident" id="5644351">sg</span><span class="op" id="5644353">,</span>&nbsp;<span class="ident" id="5644355">sb</span><span class="op" id="5644357">,</span>&nbsp;<span class="ident" id="5644359">_</span>&nbsp;<span class="op" id="5644361">:=</span>&nbsp;<span class="ident" id="5644364">src</span><span class="op" id="5644367">.</span><span class="ident" id="5644368">At</span><span class="op" id="5644370">(</span><span class="ident" id="5644371">sp</span><span class="op" id="5644373">.</span><span class="ident" id="5644374">X</span><span class="op" id="5644375">+</span><span class="ident" id="5644376">x</span><span class="op" id="5644377">,</span>&nbsp;<span class="ident" id="5644379">sp</span><span class="op" id="5644381">.</span><span class="ident" id="5644382">Y</span><span class="op" id="5644383">+</span><span class="ident" id="5644384">y</span><span class="op" id="5644385">)</span><span class="op" id="5644386">.</span><span class="ident" id="5644387">RGBA</span><span class="op" id="5644391">(</span><span class="op" id="5644392">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644397">er</span><span class="op" id="5644399">,</span>&nbsp;<span class="ident" id="5644401">eg</span><span class="op" id="5644403">,</span>&nbsp;<span class="ident" id="5644405">eb</span>&nbsp;<span class="op" id="5644408">:=</span>&nbsp;<span class="builtintype" id="5644411">int32</span><span class="op" id="5644416">(</span><span class="ident" id="5644417">sr</span><span class="op" id="5644419">)</span><span class="op" id="5644420">,</span>&nbsp;<span class="builtintype" id="5644422">int32</span><span class="op" id="5644427">(</span><span class="ident" id="5644428">sg</span><span class="op" id="5644430">)</span><span class="op" id="5644431">,</span>&nbsp;<span class="builtintype" id="5644433">int32</span><span class="op" id="5644438">(</span><span class="ident" id="5644439">sb</span><span class="op" id="5644441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644446">if</span>&nbsp;<span class="ident" id="5644449">floydSteinberg</span>&nbsp;<span class="op" id="5644464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644470">er</span>&nbsp;<span class="op" id="5644473">=</span>&nbsp;<span class="ident" id="5644475">clamp</span><span class="op" id="5644480">(</span><span class="ident" id="5644481">er</span>&nbsp;<span class="op" id="5644484">+</span>&nbsp;<span class="ident" id="5644486">quantErrorCurr</span><span class="op" id="5644500">[</span><span class="ident" id="5644501">x</span><span class="op" id="5644502">+</span><span class="num" id="5644503">1</span><span class="op" id="5644504">]</span><span class="op" id="5644505">[</span><span class="num" id="5644506">0</span><span class="op" id="5644507">]</span><span class="op" id="5644508">/</span><span class="num" id="5644509">16</span><span class="op" id="5644511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644517">eg</span>&nbsp;<span class="op" id="5644520">=</span>&nbsp;<span class="ident" id="5644522">clamp</span><span class="op" id="5644527">(</span><span class="ident" id="5644528">eg</span>&nbsp;<span class="op" id="5644531">+</span>&nbsp;<span class="ident" id="5644533">quantErrorCurr</span><span class="op" id="5644547">[</span><span class="ident" id="5644548">x</span><span class="op" id="5644549">+</span><span class="num" id="5644550">1</span><span class="op" id="5644551">]</span><span class="op" id="5644552">[</span><span class="num" id="5644553">1</span><span class="op" id="5644554">]</span><span class="op" id="5644555">/</span><span class="num" id="5644556">16</span><span class="op" id="5644558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644564">eb</span>&nbsp;<span class="op" id="5644567">=</span>&nbsp;<span class="ident" id="5644569">clamp</span><span class="op" id="5644574">(</span><span class="ident" id="5644575">eb</span>&nbsp;<span class="op" id="5644578">+</span>&nbsp;<span class="ident" id="5644580">quantErrorCurr</span><span class="op" id="5644594">[</span><span class="ident" id="5644595">x</span><span class="op" id="5644596">+</span><span class="num" id="5644597">1</span><span class="op" id="5644598">]</span><span class="op" id="5644599">[</span><span class="num" id="5644600">2</span><span class="op" id="5644601">]</span><span class="op" id="5644602">/</span><span class="num" id="5644603">16</span><span class="op" id="5644605">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644616">if</span>&nbsp;<span class="ident" id="5644619">palette</span>&nbsp;<span class="op" id="5644627">!=</span>&nbsp;<span class="ident" id="5644630">nil</span>&nbsp;<span class="op" id="5644634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644640">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644708">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644776">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644845">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644897">bestIndex</span><span class="op" id="5644906">,</span>&nbsp;<span class="ident" id="5644908">bestSSD</span>&nbsp;<span class="op" id="5644916">:=</span>&nbsp;<span class="num" id="5644919">0</span><span class="op" id="5644920">,</span>&nbsp;<span class="builtintype" id="5644922">uint32</span><span class="op" id="5644928">(</span><span class="num" id="5644929">1</span><span class="op" id="5644930">&lt;&lt;</span><span class="num" id="5644932">32</span><span class="op" id="5644934">-</span><span class="num" id="5644935">1</span><span class="op" id="5644936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644942">for</span>&nbsp;<span class="ident" id="5644946">index</span><span class="op" id="5644951">,</span>&nbsp;<span class="ident" id="5644953">p</span>&nbsp;<span class="op" id="5644955">:=</span>&nbsp;<span class="keyword" id="5644958">range</span>&nbsp;<span class="ident" id="5644964">palette</span>&nbsp;<span class="op" id="5644972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644979">delta</span>&nbsp;<span class="op" id="5644985">:=</span>&nbsp;<span class="op" id="5644988">(</span><span class="ident" id="5644989">er</span>&nbsp;<span class="op" id="5644992">-</span>&nbsp;<span class="ident" id="5644994">p</span><span class="op" id="5644995">[</span><span class="num" id="5644996">0</span><span class="op" id="5644997">]</span><span class="op" id="5644998">)</span>&nbsp;<span class="op" id="5645000">&gt;&gt;</span>&nbsp;<span class="num" id="5645003">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645010">ssd</span>&nbsp;<span class="op" id="5645014">:=</span>&nbsp;<span class="builtintype" id="5645017">uint32</span><span class="op" id="5645023">(</span><span class="ident" id="5645024">delta</span>&nbsp;<span class="op" id="5645030">*</span>&nbsp;<span class="ident" id="5645032">delta</span><span class="op" id="5645037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645044">delta</span>&nbsp;<span class="op" id="5645050">=</span>&nbsp;<span class="op" id="5645052">(</span><span class="ident" id="5645053">eg</span>&nbsp;<span class="op" id="5645056">-</span>&nbsp;<span class="ident" id="5645058">p</span><span class="op" id="5645059">[</span><span class="num" id="5645060">1</span><span class="op" id="5645061">]</span><span class="op" id="5645062">)</span>&nbsp;<span class="op" id="5645064">&gt;&gt;</span>&nbsp;<span class="num" id="5645067">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645074">ssd</span>&nbsp;<span class="op" id="5645078">+=</span>&nbsp;<span class="builtintype" id="5645081">uint32</span><span class="op" id="5645087">(</span><span class="ident" id="5645088">delta</span>&nbsp;<span class="op" id="5645094">*</span>&nbsp;<span class="ident" id="5645096">delta</span><span class="op" id="5645101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645108">delta</span>&nbsp;<span class="op" id="5645114">=</span>&nbsp;<span class="op" id="5645116">(</span><span class="ident" id="5645117">eb</span>&nbsp;<span class="op" id="5645120">-</span>&nbsp;<span class="ident" id="5645122">p</span><span class="op" id="5645123">[</span><span class="num" id="5645124">2</span><span class="op" id="5645125">]</span><span class="op" id="5645126">)</span>&nbsp;<span class="op" id="5645128">&gt;&gt;</span>&nbsp;<span class="num" id="5645131">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645138">ssd</span>&nbsp;<span class="op" id="5645142">+=</span>&nbsp;<span class="builtintype" id="5645145">uint32</span><span class="op" id="5645151">(</span><span class="ident" id="5645152">delta</span>&nbsp;<span class="op" id="5645158">*</span>&nbsp;<span class="ident" id="5645160">delta</span><span class="op" id="5645165">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645172">if</span>&nbsp;<span class="ident" id="5645175">ssd</span>&nbsp;<span class="op" id="5645179">&lt;</span>&nbsp;<span class="ident" id="5645181">bestSSD</span>&nbsp;<span class="op" id="5645189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645197">bestIndex</span><span class="op" id="5645206">,</span>&nbsp;<span class="ident" id="5645208">bestSSD</span>&nbsp;<span class="op" id="5645216">=</span>&nbsp;<span class="ident" id="5645218">index</span><span class="op" id="5645223">,</span>&nbsp;<span class="ident" id="5645225">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645235">if</span>&nbsp;<span class="ident" id="5645238">ssd</span>&nbsp;<span class="op" id="5645242">==</span>&nbsp;<span class="num" id="5645245">0</span>&nbsp;<span class="op" id="5645247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645256">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645268">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645287">pix</span><span class="op" id="5645290">[</span><span class="ident" id="5645291">y</span><span class="op" id="5645292">*</span><span class="ident" id="5645293">stride</span><span class="op" id="5645299">+</span><span class="ident" id="5645300">x</span><span class="op" id="5645301">]</span>&nbsp;<span class="op" id="5645303">=</span>&nbsp;<span class="builtintype" id="5645305">byte</span><span class="op" id="5645309">(</span><span class="ident" id="5645310">bestIndex</span><span class="op" id="5645319">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645326">if</span>&nbsp;<span class="op" id="5645329">!</span><span class="ident" id="5645330">floydSteinberg</span>&nbsp;<span class="op" id="5645345">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645352">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645371">er</span>&nbsp;<span class="op" id="5645374">-=</span>&nbsp;<span class="builtintype" id="5645377">int32</span><span class="op" id="5645382">(</span><span class="ident" id="5645383">palette</span><span class="op" id="5645390">[</span><span class="ident" id="5645391">bestIndex</span><span class="op" id="5645400">]</span><span class="op" id="5645401">[</span><span class="num" id="5645402">0</span><span class="op" id="5645403">]</span><span class="op" id="5645404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645410">eg</span>&nbsp;<span class="op" id="5645413">-=</span>&nbsp;<span class="builtintype" id="5645416">int32</span><span class="op" id="5645421">(</span><span class="ident" id="5645422">palette</span><span class="op" id="5645429">[</span><span class="ident" id="5645430">bestIndex</span><span class="op" id="5645439">]</span><span class="op" id="5645440">[</span><span class="num" id="5645441">1</span><span class="op" id="5645442">]</span><span class="op" id="5645443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645449">eb</span>&nbsp;<span class="op" id="5645452">-=</span>&nbsp;<span class="builtintype" id="5645455">int32</span><span class="op" id="5645460">(</span><span class="ident" id="5645461">palette</span><span class="op" id="5645468">[</span><span class="ident" id="5645469">bestIndex</span><span class="op" id="5645478">]</span><span class="op" id="5645479">[</span><span class="num" id="5645480">2</span><span class="op" id="5645481">]</span><span class="op" id="5645482">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645488">}</span>&nbsp;<span class="keyword" id="5645490">else</span>&nbsp;<span class="op" id="5645495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645501">out</span><span class="op" id="5645504">.</span><span class="ident" id="5645505">R</span>&nbsp;<span class="op" id="5645507">=</span>&nbsp;<span class="builtintype" id="5645509">uint16</span><span class="op" id="5645515">(</span><span class="ident" id="5645516">er</span><span class="op" id="5645518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645524">out</span><span class="op" id="5645527">.</span><span class="ident" id="5645528">G</span>&nbsp;<span class="op" id="5645530">=</span>&nbsp;<span class="builtintype" id="5645532">uint16</span><span class="op" id="5645538">(</span><span class="ident" id="5645539">eg</span><span class="op" id="5645541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645547">out</span><span class="op" id="5645550">.</span><span class="ident" id="5645551">B</span>&nbsp;<span class="op" id="5645553">=</span>&nbsp;<span class="builtintype" id="5645555">uint16</span><span class="op" id="5645561">(</span><span class="ident" id="5645562">eb</span><span class="op" id="5645564">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645570">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645631">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645696">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645759">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645820">dst</span><span class="op" id="5645823">.</span><span class="ident" id="5645824">Set</span><span class="op" id="5645827">(</span><span class="ident" id="5645828">r</span><span class="op" id="5645829">.</span><span class="ident" id="5645830">Min</span><span class="op" id="5645833">.</span><span class="ident" id="5645834">X</span><span class="op" id="5645835">+</span><span class="ident" id="5645836">x</span><span class="op" id="5645837">,</span>&nbsp;<span class="ident" id="5645839">r</span><span class="op" id="5645840">.</span><span class="ident" id="5645841">Min</span><span class="op" id="5645844">.</span><span class="ident" id="5645845">Y</span><span class="op" id="5645846">+</span><span class="ident" id="5645847">y</span><span class="op" id="5645848">,</span>&nbsp;<span class="op" id="5645850">&amp;</span><span class="ident" id="5645851">out</span><span class="op" id="5645854">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645861">if</span>&nbsp;<span class="op" id="5645864">!</span><span class="ident" id="5645865">floydSteinberg</span>&nbsp;<span class="op" id="5645880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645887">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645906">sr</span><span class="op" id="5645908">,</span>&nbsp;<span class="ident" id="5645910">sg</span><span class="op" id="5645912">,</span>&nbsp;<span class="ident" id="5645914">sb</span><span class="op" id="5645916">,</span>&nbsp;<span class="ident" id="5645918">_</span>&nbsp;<span class="op" id="5645920">=</span>&nbsp;<span class="ident" id="5645922">dst</span><span class="op" id="5645925">.</span><span class="ident" id="5645926">At</span><span class="op" id="5645928">(</span><span class="ident" id="5645929">r</span><span class="op" id="5645930">.</span><span class="ident" id="5645931">Min</span><span class="op" id="5645934">.</span><span class="ident" id="5645935">X</span><span class="op" id="5645936">+</span><span class="ident" id="5645937">x</span><span class="op" id="5645938">,</span>&nbsp;<span class="ident" id="5645940">r</span><span class="op" id="5645941">.</span><span class="ident" id="5645942">Min</span><span class="op" id="5645945">.</span><span class="ident" id="5645946">Y</span><span class="op" id="5645947">+</span><span class="ident" id="5645948">y</span><span class="op" id="5645949">)</span><span class="op" id="5645950">.</span><span class="ident" id="5645951">RGBA</span><span class="op" id="5645955">(</span><span class="op" id="5645956">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645962">er</span>&nbsp;<span class="op" id="5645965">-=</span>&nbsp;<span class="builtintype" id="5645968">int32</span><span class="op" id="5645973">(</span><span class="ident" id="5645974">sr</span><span class="op" id="5645976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645982">eg</span>&nbsp;<span class="op" id="5645985">-=</span>&nbsp;<span class="builtintype" id="5645988">int32</span><span class="op" id="5645993">(</span><span class="ident" id="5645994">sg</span><span class="op" id="5645996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646002">eb</span>&nbsp;<span class="op" id="5646005">-=</span>&nbsp;<span class="builtintype" id="5646008">int32</span><span class="op" id="5646013">(</span><span class="ident" id="5646014">sb</span><span class="op" id="5646016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5646027">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646083">quantErrorNext</span><span class="op" id="5646097">[</span><span class="ident" id="5646098">x</span><span class="op" id="5646099">+</span><span class="num" id="5646100">0</span><span class="op" id="5646101">]</span><span class="op" id="5646102">[</span><span class="num" id="5646103">0</span><span class="op" id="5646104">]</span>&nbsp;<span class="op" id="5646106">+=</span>&nbsp;<span class="ident" id="5646109">er</span>&nbsp;<span class="op" id="5646112">*</span>&nbsp;<span class="num" id="5646114">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646119">quantErrorNext</span><span class="op" id="5646133">[</span><span class="ident" id="5646134">x</span><span class="op" id="5646135">+</span><span class="num" id="5646136">0</span><span class="op" id="5646137">]</span><span class="op" id="5646138">[</span><span class="num" id="5646139">1</span><span class="op" id="5646140">]</span>&nbsp;<span class="op" id="5646142">+=</span>&nbsp;<span class="ident" id="5646145">eg</span>&nbsp;<span class="op" id="5646148">*</span>&nbsp;<span class="num" id="5646150">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646155">quantErrorNext</span><span class="op" id="5646169">[</span><span class="ident" id="5646170">x</span><span class="op" id="5646171">+</span><span class="num" id="5646172">0</span><span class="op" id="5646173">]</span><span class="op" id="5646174">[</span><span class="num" id="5646175">2</span><span class="op" id="5646176">]</span>&nbsp;<span class="op" id="5646178">+=</span>&nbsp;<span class="ident" id="5646181">eb</span>&nbsp;<span class="op" id="5646184">*</span>&nbsp;<span class="num" id="5646186">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646191">quantErrorNext</span><span class="op" id="5646205">[</span><span class="ident" id="5646206">x</span><span class="op" id="5646207">+</span><span class="num" id="5646208">1</span><span class="op" id="5646209">]</span><span class="op" id="5646210">[</span><span class="num" id="5646211">0</span><span class="op" id="5646212">]</span>&nbsp;<span class="op" id="5646214">+=</span>&nbsp;<span class="ident" id="5646217">er</span>&nbsp;<span class="op" id="5646220">*</span>&nbsp;<span class="num" id="5646222">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646227">quantErrorNext</span><span class="op" id="5646241">[</span><span class="ident" id="5646242">x</span><span class="op" id="5646243">+</span><span class="num" id="5646244">1</span><span class="op" id="5646245">]</span><span class="op" id="5646246">[</span><span class="num" id="5646247">1</span><span class="op" id="5646248">]</span>&nbsp;<span class="op" id="5646250">+=</span>&nbsp;<span class="ident" id="5646253">eg</span>&nbsp;<span class="op" id="5646256">*</span>&nbsp;<span class="num" id="5646258">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646263">quantErrorNext</span><span class="op" id="5646277">[</span><span class="ident" id="5646278">x</span><span class="op" id="5646279">+</span><span class="num" id="5646280">1</span><span class="op" id="5646281">]</span><span class="op" id="5646282">[</span><span class="num" id="5646283">2</span><span class="op" id="5646284">]</span>&nbsp;<span class="op" id="5646286">+=</span>&nbsp;<span class="ident" id="5646289">eb</span>&nbsp;<span class="op" id="5646292">*</span>&nbsp;<span class="num" id="5646294">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646299">quantErrorNext</span><span class="op" id="5646313">[</span><span class="ident" id="5646314">x</span><span class="op" id="5646315">+</span><span class="num" id="5646316">2</span><span class="op" id="5646317">]</span><span class="op" id="5646318">[</span><span class="num" id="5646319">0</span><span class="op" id="5646320">]</span>&nbsp;<span class="op" id="5646322">+=</span>&nbsp;<span class="ident" id="5646325">er</span>&nbsp;<span class="op" id="5646328">*</span>&nbsp;<span class="num" id="5646330">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646335">quantErrorNext</span><span class="op" id="5646349">[</span><span class="ident" id="5646350">x</span><span class="op" id="5646351">+</span><span class="num" id="5646352">2</span><span class="op" id="5646353">]</span><span class="op" id="5646354">[</span><span class="num" id="5646355">1</span><span class="op" id="5646356">]</span>&nbsp;<span class="op" id="5646358">+=</span>&nbsp;<span class="ident" id="5646361">eg</span>&nbsp;<span class="op" id="5646364">*</span>&nbsp;<span class="num" id="5646366">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646371">quantErrorNext</span><span class="op" id="5646385">[</span><span class="ident" id="5646386">x</span><span class="op" id="5646387">+</span><span class="num" id="5646388">2</span><span class="op" id="5646389">]</span><span class="op" id="5646390">[</span><span class="num" id="5646391">2</span><span class="op" id="5646392">]</span>&nbsp;<span class="op" id="5646394">+=</span>&nbsp;<span class="ident" id="5646397">eb</span>&nbsp;<span class="op" id="5646400">*</span>&nbsp;<span class="num" id="5646402">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646407">quantErrorCurr</span><span class="op" id="5646421">[</span><span class="ident" id="5646422">x</span><span class="op" id="5646423">+</span><span class="num" id="5646424">2</span><span class="op" id="5646425">]</span><span class="op" id="5646426">[</span><span class="num" id="5646427">0</span><span class="op" id="5646428">]</span>&nbsp;<span class="op" id="5646430">+=</span>&nbsp;<span class="ident" id="5646433">er</span>&nbsp;<span class="op" id="5646436">*</span>&nbsp;<span class="num" id="5646438">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646443">quantErrorCurr</span><span class="op" id="5646457">[</span><span class="ident" id="5646458">x</span><span class="op" id="5646459">+</span><span class="num" id="5646460">2</span><span class="op" id="5646461">]</span><span class="op" id="5646462">[</span><span class="num" id="5646463">1</span><span class="op" id="5646464">]</span>&nbsp;<span class="op" id="5646466">+=</span>&nbsp;<span class="ident" id="5646469">eg</span>&nbsp;<span class="op" id="5646472">*</span>&nbsp;<span class="num" id="5646474">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646479">quantErrorCurr</span><span class="op" id="5646493">[</span><span class="ident" id="5646494">x</span><span class="op" id="5646495">+</span><span class="num" id="5646496">2</span><span class="op" id="5646497">]</span><span class="op" id="5646498">[</span><span class="num" id="5646499">2</span><span class="op" id="5646500">]</span>&nbsp;<span class="op" id="5646502">+=</span>&nbsp;<span class="ident" id="5646505">eb</span>&nbsp;<span class="op" id="5646508">*</span>&nbsp;<span class="num" id="5646510">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5646519">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646564">if</span>&nbsp;<span class="ident" id="5646567">floydSteinberg</span>&nbsp;<span class="op" id="5646582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646587">quantErrorCurr</span><span class="op" id="5646601">,</span>&nbsp;<span class="ident" id="5646603">quantErrorNext</span>&nbsp;<span class="op" id="5646618">=</span>&nbsp;<span class="ident" id="5646620">quantErrorNext</span><span class="op" id="5646634">,</span>&nbsp;<span class="ident" id="5646636">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646654">for</span>&nbsp;<span class="ident" id="5646658">i</span>&nbsp;<span class="op" id="5646660">:=</span>&nbsp;<span class="keyword" id="5646663">range</span>&nbsp;<span class="ident" id="5646669">quantErrorNext</span>&nbsp;<span class="op" id="5646684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646690">quantErrorNext</span><span class="op" id="5646704">[</span><span class="ident" id="5646705">i</span><span class="op" id="5646706">]</span>&nbsp;<span class="op" id="5646708">=</span>&nbsp;<span class="op" id="5646710">[</span><span class="num" id="5646711">3</span><span class="op" id="5646712">]</span><span class="builtintype" id="5646713">int32</span><span class="op" id="5646718">{</span><span class="op" id="5646719">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646731">}</span><br>
<span class="lineno"></span><span class="op" id="5646733">}</span>
</div>
</body>
</html>
