<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1496643">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1496698">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1496752">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1496803">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496838">package</span>&nbsp;<span class="ident" id="1496846">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1496855">import</span>&nbsp;<span class="string" id="1496862">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1496872">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1496937">//</span><br>
<span class="lineno"></span><span class="comment" id="1496940">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1496999">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Atomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1497015">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1497043">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Might&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1497093">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Don&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1497147">//</span><br>
<span class="lineno"></span><span class="comment" id="1497150">//&nbsp;&nbsp;&nbsp;&nbsp;runtime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1497200">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1497261">const</span>&nbsp;<span class="op" id="1497267">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497270">mutex_unlocked</span>&nbsp;<span class="op" id="1497285">=</span>&nbsp;<span class="num" id="1497287">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497290">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1497305">=</span>&nbsp;<span class="num" id="1497307">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497310">mutex_sleeping</span>&nbsp;<span class="op" id="1497325">=</span>&nbsp;<span class="num" id="1497327">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497331">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497347">=</span>&nbsp;<span class="num" id="1497349">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497352">active_spin_cnt</span>&nbsp;<span class="op" id="1497368">=</span>&nbsp;<span class="num" id="1497370">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497374">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497390">=</span>&nbsp;<span class="num" id="1497392">1</span><br>
<span class="lineno">30</span><span class="op" id="1497394">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1497397">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1497474">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1497553">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1497628">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1497654">func</span>&nbsp;<span class="ident" id="1497659">futexsleep</span><span class="op" id="1497669">(</span><span class="ident" id="1497670">addr</span>&nbsp;<span class="op" id="1497675">*</span><span class="builtintype" id="1497676">uint32</span><span class="op" id="1497682">,</span>&nbsp;<span class="ident" id="1497684">val</span>&nbsp;<span class="builtintype" id="1497688">uint32</span><span class="op" id="1497694">,</span>&nbsp;<span class="ident" id="1497696">ns</span>&nbsp;<span class="builtintype" id="1497699">int64</span><span class="op" id="1497704">)</span><br>
<span class="lineno"></span><span class="keyword" id="1497706">func</span>&nbsp;<span class="ident" id="1497711">futexwakeup</span><span class="op" id="1497722">(</span><span class="ident" id="1497723">addr</span>&nbsp;<span class="op" id="1497728">*</span><span class="builtintype" id="1497729">uint32</span><span class="op" id="1497735">,</span>&nbsp;<span class="ident" id="1497737">cnt</span>&nbsp;<span class="builtintype" id="1497741">uint32</span><span class="op" id="1497747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1497750">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1497808">func</span>&nbsp;<span class="ident" id="1497813">key32</span><span class="op" id="1497818">(</span><span class="ident" id="1497819">p</span>&nbsp;<span class="op" id="1497821">*</span><span class="builtintype" id="1497822">uintptr</span><span class="op" id="1497829">)</span>&nbsp;<span class="op" id="1497831">*</span><span class="builtintype" id="1497832">uint32</span>&nbsp;<span class="op" id="1497839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497842">return</span>&nbsp;<span class="op" id="1497849">(</span><span class="op" id="1497850">*</span><span class="builtintype" id="1497851">uint32</span><span class="op" id="1497857">)</span><span class="op" id="1497858">(</span><span class="ident" id="1497859">unsafe</span><span class="op" id="1497865">.</span><span class="ident" id="1497866">Pointer</span><span class="op" id="1497873">(</span><span class="ident" id="1497874">p</span><span class="op" id="1497875">)</span><span class="op" id="1497876">)</span><br>
<span class="lineno"></span><span class="op" id="1497878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1497881">func</span>&nbsp;<span class="ident" id="1497886">lock</span><span class="op" id="1497890">(</span><span class="ident" id="1497891">l</span>&nbsp;<span class="op" id="1497893">*</span><span class="ident" id="1497894">mutex</span><span class="op" id="1497899">)</span>&nbsp;<span class="op" id="1497901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497904">gp</span>&nbsp;<span class="op" id="1497907">:=</span>&nbsp;<span class="ident" id="1497910">getg</span><span class="op" id="1497914">(</span><span class="op" id="1497915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1497919">if</span>&nbsp;<span class="ident" id="1497922">gp</span><span class="op" id="1497924">.</span><span class="ident" id="1497925">m</span><span class="op" id="1497926">.</span><span class="ident" id="1497927">locks</span>&nbsp;<span class="op" id="1497933">&lt;</span>&nbsp;<span class="num" id="1497935">0</span>&nbsp;<span class="op" id="1497937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497941">gothrow</span><span class="op" id="1497948">(</span><span class="string" id="1497949">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1497976">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1497979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1497982">gp</span><span class="op" id="1497984">.</span><span class="ident" id="1497985">m</span><span class="op" id="1497986">.</span><span class="ident" id="1497987">locks</span><span class="op" id="1497992">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1497997">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498028">v</span>&nbsp;<span class="op" id="1498030">:=</span>&nbsp;<span class="ident" id="1498033">xchg</span><span class="op" id="1498037">(</span><span class="ident" id="1498038">key32</span><span class="op" id="1498043">(</span><span class="op" id="1498044">&amp;</span><span class="ident" id="1498045">l</span><span class="op" id="1498046">.</span><span class="ident" id="1498047">key</span><span class="op" id="1498050">)</span><span class="op" id="1498051">,</span>&nbsp;<span class="ident" id="1498053">mutex_locked</span><span class="op" id="1498065">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498068">if</span>&nbsp;<span class="ident" id="1498071">v</span>&nbsp;<span class="op" id="1498073">==</span>&nbsp;<span class="ident" id="1498076">mutex_unlocked</span>&nbsp;<span class="op" id="1498091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498107">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498157">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498209">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498259">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498310">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498365">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498420">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498441">wait</span>&nbsp;<span class="op" id="1498446">:=</span>&nbsp;<span class="ident" id="1498449">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498453">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498494">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498549">spin</span>&nbsp;<span class="op" id="1498554">:=</span>&nbsp;<span class="num" id="1498557">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498560">if</span>&nbsp;<span class="ident" id="1498563">ncpu</span>&nbsp;<span class="op" id="1498568">&gt;</span>&nbsp;<span class="num" id="1498570">1</span>&nbsp;<span class="op" id="1498572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498576">spin</span>&nbsp;<span class="op" id="1498581">=</span>&nbsp;<span class="ident" id="1498583">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498599">for</span>&nbsp;<span class="op" id="1498603">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498607">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498636">for</span>&nbsp;<span class="ident" id="1498640">i</span>&nbsp;<span class="op" id="1498642">:=</span>&nbsp;<span class="num" id="1498645">0</span><span class="op" id="1498646">;</span>&nbsp;<span class="ident" id="1498648">i</span>&nbsp;<span class="op" id="1498650">&lt;</span>&nbsp;<span class="ident" id="1498652">spin</span><span class="op" id="1498656">;</span>&nbsp;<span class="ident" id="1498658">i</span><span class="op" id="1498659">++</span>&nbsp;<span class="op" id="1498662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498667">for</span>&nbsp;<span class="ident" id="1498671">l</span><span class="op" id="1498672">.</span><span class="ident" id="1498673">key</span>&nbsp;<span class="op" id="1498677">==</span>&nbsp;<span class="ident" id="1498680">mutex_unlocked</span>&nbsp;<span class="op" id="1498695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498701">if</span>&nbsp;<span class="ident" id="1498704">cas</span><span class="op" id="1498707">(</span><span class="ident" id="1498708">key32</span><span class="op" id="1498713">(</span><span class="op" id="1498714">&amp;</span><span class="ident" id="1498715">l</span><span class="op" id="1498716">.</span><span class="ident" id="1498717">key</span><span class="op" id="1498720">)</span><span class="op" id="1498721">,</span>&nbsp;<span class="ident" id="1498723">mutex_unlocked</span><span class="op" id="1498737">,</span>&nbsp;<span class="ident" id="1498739">wait</span><span class="op" id="1498743">)</span>&nbsp;<span class="op" id="1498745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498752">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498773">procyield</span><span class="op" id="1498782">(</span><span class="ident" id="1498783">active_spin_cnt</span><span class="op" id="1498798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1498807">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498840">for</span>&nbsp;<span class="ident" id="1498844">i</span>&nbsp;<span class="op" id="1498846">:=</span>&nbsp;<span class="num" id="1498849">0</span><span class="op" id="1498850">;</span>&nbsp;<span class="ident" id="1498852">i</span>&nbsp;<span class="op" id="1498854">&lt;</span>&nbsp;<span class="ident" id="1498856">passive_spin</span><span class="op" id="1498868">;</span>&nbsp;<span class="ident" id="1498870">i</span><span class="op" id="1498871">++</span>&nbsp;<span class="op" id="1498874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498879">for</span>&nbsp;<span class="ident" id="1498883">l</span><span class="op" id="1498884">.</span><span class="ident" id="1498885">key</span>&nbsp;<span class="op" id="1498889">==</span>&nbsp;<span class="ident" id="1498892">mutex_unlocked</span>&nbsp;<span class="op" id="1498907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498913">if</span>&nbsp;<span class="ident" id="1498916">cas</span><span class="op" id="1498919">(</span><span class="ident" id="1498920">key32</span><span class="op" id="1498925">(</span><span class="op" id="1498926">&amp;</span><span class="ident" id="1498927">l</span><span class="op" id="1498928">.</span><span class="ident" id="1498929">key</span><span class="op" id="1498932">)</span><span class="op" id="1498933">,</span>&nbsp;<span class="ident" id="1498935">mutex_unlocked</span><span class="op" id="1498949">,</span>&nbsp;<span class="ident" id="1498951">wait</span><span class="op" id="1498955">)</span>&nbsp;<span class="op" id="1498957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1498964">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1498985">osyield</span><span class="op" id="1498992">(</span><span class="op" id="1498993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1498997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1499002">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499014">v</span>&nbsp;<span class="op" id="1499016">=</span>&nbsp;<span class="ident" id="1499018">xchg</span><span class="op" id="1499022">(</span><span class="ident" id="1499023">key32</span><span class="op" id="1499028">(</span><span class="op" id="1499029">&amp;</span><span class="ident" id="1499030">l</span><span class="op" id="1499031">.</span><span class="ident" id="1499032">key</span><span class="op" id="1499035">)</span><span class="op" id="1499036">,</span>&nbsp;<span class="ident" id="1499038">mutex_sleeping</span><span class="op" id="1499052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499056">if</span>&nbsp;<span class="ident" id="1499059">v</span>&nbsp;<span class="op" id="1499061">==</span>&nbsp;<span class="ident" id="1499064">mutex_unlocked</span>&nbsp;<span class="op" id="1499079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499084">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499093">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499097">wait</span>&nbsp;<span class="op" id="1499102">=</span>&nbsp;<span class="ident" id="1499104">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499121">futexsleep</span><span class="op" id="1499131">(</span><span class="ident" id="1499132">key32</span><span class="op" id="1499137">(</span><span class="op" id="1499138">&amp;</span><span class="ident" id="1499139">l</span><span class="op" id="1499140">.</span><span class="ident" id="1499141">key</span><span class="op" id="1499144">)</span><span class="op" id="1499145">,</span>&nbsp;<span class="ident" id="1499147">mutex_sleeping</span><span class="op" id="1499161">,</span>&nbsp;<span class="op" id="1499163">-</span><span class="num" id="1499164">1</span><span class="op" id="1499165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499168">}</span><br>
<span class="lineno"></span><span class="op" id="1499170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1499173">func</span>&nbsp;<span class="ident" id="1499178">unlock</span><span class="op" id="1499184">(</span><span class="ident" id="1499185">l</span>&nbsp;<span class="op" id="1499187">*</span><span class="ident" id="1499188">mutex</span><span class="op" id="1499193">)</span>&nbsp;<span class="op" id="1499195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499198">v</span>&nbsp;<span class="op" id="1499200">:=</span>&nbsp;<span class="ident" id="1499203">xchg</span><span class="op" id="1499207">(</span><span class="ident" id="1499208">key32</span><span class="op" id="1499213">(</span><span class="op" id="1499214">&amp;</span><span class="ident" id="1499215">l</span><span class="op" id="1499216">.</span><span class="ident" id="1499217">key</span><span class="op" id="1499220">)</span><span class="op" id="1499221">,</span>&nbsp;<span class="ident" id="1499223">mutex_unlocked</span><span class="op" id="1499237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499240">if</span>&nbsp;<span class="ident" id="1499243">v</span>&nbsp;<span class="op" id="1499245">==</span>&nbsp;<span class="ident" id="1499248">mutex_unlocked</span>&nbsp;<span class="op" id="1499263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499267">gothrow</span><span class="op" id="1499274">(</span><span class="string" id="1499275">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1499300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499303">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499306">if</span>&nbsp;<span class="ident" id="1499309">v</span>&nbsp;<span class="op" id="1499311">==</span>&nbsp;<span class="ident" id="1499314">mutex_sleeping</span>&nbsp;<span class="op" id="1499329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499333">futexwakeup</span><span class="op" id="1499344">(</span><span class="ident" id="1499345">key32</span><span class="op" id="1499350">(</span><span class="op" id="1499351">&amp;</span><span class="ident" id="1499352">l</span><span class="op" id="1499353">.</span><span class="ident" id="1499354">key</span><span class="op" id="1499357">)</span><span class="op" id="1499358">,</span>&nbsp;<span class="num" id="1499360">1</span><span class="op" id="1499361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499368">gp</span>&nbsp;<span class="op" id="1499371">:=</span>&nbsp;<span class="ident" id="1499374">getg</span><span class="op" id="1499378">(</span><span class="op" id="1499379">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499382">gp</span><span class="op" id="1499384">.</span><span class="ident" id="1499385">m</span><span class="op" id="1499386">.</span><span class="ident" id="1499387">locks</span><span class="op" id="1499392">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499396">if</span>&nbsp;<span class="ident" id="1499399">gp</span><span class="op" id="1499401">.</span><span class="ident" id="1499402">m</span><span class="op" id="1499403">.</span><span class="ident" id="1499404">locks</span>&nbsp;<span class="op" id="1499410">&lt;</span>&nbsp;<span class="num" id="1499412">0</span>&nbsp;<span class="op" id="1499414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499418">gothrow</span><span class="op" id="1499425">(</span><span class="string" id="1499426">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1499455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499461">if</span>&nbsp;<span class="ident" id="1499464">gp</span><span class="op" id="1499466">.</span><span class="ident" id="1499467">m</span><span class="op" id="1499468">.</span><span class="ident" id="1499469">locks</span>&nbsp;<span class="op" id="1499475">==</span>&nbsp;<span class="num" id="1499478">0</span>&nbsp;<span class="op" id="1499480">&amp;&amp;</span>&nbsp;<span class="ident" id="1499483">gp</span><span class="op" id="1499485">.</span><span class="ident" id="1499486">preempt</span>&nbsp;<span class="op" id="1499494">{</span>&nbsp;<span class="comment" id="1499496">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499569">gp</span><span class="op" id="1499571">.</span><span class="ident" id="1499572">stackguard0</span>&nbsp;<span class="op" id="1499584">=</span>&nbsp;<span class="ident" id="1499586">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499600">}</span><br>
<span class="lineno"></span><span class="op" id="1499602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1499605">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1499632">func</span>&nbsp;<span class="ident" id="1499637">noteclear</span><span class="op" id="1499646">(</span><span class="ident" id="1499647">n</span>&nbsp;<span class="op" id="1499649">*</span><span class="ident" id="1499650">note</span><span class="op" id="1499654">)</span>&nbsp;<span class="op" id="1499656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499659">n</span><span class="op" id="1499660">.</span><span class="ident" id="1499661">key</span>&nbsp;<span class="op" id="1499665">=</span>&nbsp;<span class="num" id="1499667">0</span><br>
<span class="lineno"></span><span class="op" id="1499669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499672">func</span>&nbsp;<span class="ident" id="1499677">notewakeup</span><span class="op" id="1499687">(</span><span class="ident" id="1499688">n</span>&nbsp;<span class="op" id="1499690">*</span><span class="ident" id="1499691">note</span><span class="op" id="1499695">)</span>&nbsp;<span class="op" id="1499697">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499700">old</span>&nbsp;<span class="op" id="1499704">:=</span>&nbsp;<span class="ident" id="1499707">xchg</span><span class="op" id="1499711">(</span><span class="ident" id="1499712">key32</span><span class="op" id="1499717">(</span><span class="op" id="1499718">&amp;</span><span class="ident" id="1499719">n</span><span class="op" id="1499720">.</span><span class="ident" id="1499721">key</span><span class="op" id="1499724">)</span><span class="op" id="1499725">,</span>&nbsp;<span class="num" id="1499727">1</span><span class="op" id="1499728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499731">if</span>&nbsp;<span class="ident" id="1499734">old</span>&nbsp;<span class="op" id="1499738">!=</span>&nbsp;<span class="num" id="1499741">0</span>&nbsp;<span class="op" id="1499743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1499747">print</span><span class="op" id="1499752">(</span><span class="string" id="1499753">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1499783">,</span>&nbsp;<span class="ident" id="1499785">old</span><span class="op" id="1499788">,</span>&nbsp;<span class="string" id="1499790">&#34;)\n&#34;</span><span class="op" id="1499795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499799">gothrow</span><span class="op" id="1499806">(</span><span class="string" id="1499807">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1499835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499838">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499841">futexwakeup</span><span class="op" id="1499852">(</span><span class="ident" id="1499853">key32</span><span class="op" id="1499858">(</span><span class="op" id="1499859">&amp;</span><span class="ident" id="1499860">n</span><span class="op" id="1499861">.</span><span class="ident" id="1499862">key</span><span class="op" id="1499865">)</span><span class="op" id="1499866">,</span>&nbsp;<span class="num" id="1499868">1</span><span class="op" id="1499869">)</span><br>
<span class="lineno"></span><span class="op" id="1499871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1499874">func</span>&nbsp;<span class="ident" id="1499879">notesleep</span><span class="op" id="1499888">(</span><span class="ident" id="1499889">n</span>&nbsp;<span class="op" id="1499891">*</span><span class="ident" id="1499892">note</span><span class="op" id="1499896">)</span>&nbsp;<span class="op" id="1499898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499901">gp</span>&nbsp;<span class="op" id="1499904">:=</span>&nbsp;<span class="ident" id="1499907">getg</span><span class="op" id="1499911">(</span><span class="op" id="1499912">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499915">if</span>&nbsp;<span class="ident" id="1499918">gp</span>&nbsp;<span class="op" id="1499921">!=</span>&nbsp;<span class="ident" id="1499924">gp</span><span class="op" id="1499926">.</span><span class="ident" id="1499927">m</span><span class="op" id="1499928">.</span><span class="ident" id="1499929">g0</span>&nbsp;<span class="op" id="1499932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1499936">gothrow</span><span class="op" id="1499943">(</span><span class="string" id="1499944">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1499965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1499968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1499971">for</span>&nbsp;<span class="ident" id="1499975">atomicload</span><span class="op" id="1499985">(</span><span class="ident" id="1499986">key32</span><span class="op" id="1499991">(</span><span class="op" id="1499992">&amp;</span><span class="ident" id="1499993">n</span><span class="op" id="1499994">.</span><span class="ident" id="1499995">key</span><span class="op" id="1499998">)</span><span class="op" id="1499999">)</span>&nbsp;<span class="op" id="1500001">==</span>&nbsp;<span class="num" id="1500004">0</span>&nbsp;<span class="op" id="1500006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500010">gp</span><span class="op" id="1500012">.</span><span class="ident" id="1500013">m</span><span class="op" id="1500014">.</span><span class="ident" id="1500015">blocked</span>&nbsp;<span class="op" id="1500023">=</span>&nbsp;<span class="builtintype" id="1500025">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500032">futexsleep</span><span class="op" id="1500042">(</span><span class="ident" id="1500043">key32</span><span class="op" id="1500048">(</span><span class="op" id="1500049">&amp;</span><span class="ident" id="1500050">n</span><span class="op" id="1500051">.</span><span class="ident" id="1500052">key</span><span class="op" id="1500055">)</span><span class="op" id="1500056">,</span>&nbsp;<span class="num" id="1500058">0</span><span class="op" id="1500059">,</span>&nbsp;<span class="op" id="1500061">-</span><span class="num" id="1500062">1</span><span class="op" id="1500063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500067">gp</span><span class="op" id="1500069">.</span><span class="ident" id="1500070">m</span><span class="op" id="1500071">.</span><span class="ident" id="1500072">blocked</span>&nbsp;<span class="op" id="1500080">=</span>&nbsp;<span class="builtintype" id="1500082">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500089">}</span><br>
<span class="lineno"></span><span class="op" id="1500091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1500094">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1500107">func</span>&nbsp;<span class="ident" id="1500112">notetsleep_internal</span><span class="op" id="1500131">(</span><span class="ident" id="1500132">n</span>&nbsp;<span class="op" id="1500134">*</span><span class="ident" id="1500135">note</span><span class="op" id="1500139">,</span>&nbsp;<span class="ident" id="1500141">ns</span>&nbsp;<span class="builtintype" id="1500144">int64</span><span class="op" id="1500149">)</span>&nbsp;<span class="builtintype" id="1500151">bool</span>&nbsp;<span class="op" id="1500156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500159">gp</span>&nbsp;<span class="op" id="1500162">:=</span>&nbsp;<span class="ident" id="1500165">getg</span><span class="op" id="1500169">(</span><span class="op" id="1500170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500174">if</span>&nbsp;<span class="ident" id="1500177">ns</span>&nbsp;<span class="op" id="1500180">&lt;</span>&nbsp;<span class="num" id="1500182">0</span>&nbsp;<span class="op" id="1500184">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500188">for</span>&nbsp;<span class="ident" id="1500192">atomicload</span><span class="op" id="1500202">(</span><span class="ident" id="1500203">key32</span><span class="op" id="1500208">(</span><span class="op" id="1500209">&amp;</span><span class="ident" id="1500210">n</span><span class="op" id="1500211">.</span><span class="ident" id="1500212">key</span><span class="op" id="1500215">)</span><span class="op" id="1500216">)</span>&nbsp;<span class="op" id="1500218">==</span>&nbsp;<span class="num" id="1500221">0</span>&nbsp;<span class="op" id="1500223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500228">gp</span><span class="op" id="1500230">.</span><span class="ident" id="1500231">m</span><span class="op" id="1500232">.</span><span class="ident" id="1500233">blocked</span>&nbsp;<span class="op" id="1500241">=</span>&nbsp;<span class="builtintype" id="1500243">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500251">futexsleep</span><span class="op" id="1500261">(</span><span class="ident" id="1500262">key32</span><span class="op" id="1500267">(</span><span class="op" id="1500268">&amp;</span><span class="ident" id="1500269">n</span><span class="op" id="1500270">.</span><span class="ident" id="1500271">key</span><span class="op" id="1500274">)</span><span class="op" id="1500275">,</span>&nbsp;<span class="num" id="1500277">0</span><span class="op" id="1500278">,</span>&nbsp;<span class="op" id="1500280">-</span><span class="num" id="1500281">1</span><span class="op" id="1500282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500287">gp</span><span class="op" id="1500289">.</span><span class="ident" id="1500290">m</span><span class="op" id="1500291">.</span><span class="ident" id="1500292">blocked</span>&nbsp;<span class="op" id="1500300">=</span>&nbsp;<span class="builtintype" id="1500302">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500310">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500314">return</span>&nbsp;<span class="builtintype" id="1500321">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500331">if</span>&nbsp;<span class="ident" id="1500334">atomicload</span><span class="op" id="1500344">(</span><span class="ident" id="1500345">key32</span><span class="op" id="1500350">(</span><span class="op" id="1500351">&amp;</span><span class="ident" id="1500352">n</span><span class="op" id="1500353">.</span><span class="ident" id="1500354">key</span><span class="op" id="1500357">)</span><span class="op" id="1500358">)</span>&nbsp;<span class="op" id="1500360">!=</span>&nbsp;<span class="num" id="1500363">0</span>&nbsp;<span class="op" id="1500365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500369">return</span>&nbsp;<span class="builtintype" id="1500376">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500386">deadline</span>&nbsp;<span class="op" id="1500395">:=</span>&nbsp;<span class="ident" id="1500398">nanotime</span><span class="op" id="1500406">(</span><span class="op" id="1500407">)</span>&nbsp;<span class="op" id="1500409">+</span>&nbsp;<span class="ident" id="1500411">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500415">for</span>&nbsp;<span class="op" id="1500419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500423">gp</span><span class="op" id="1500425">.</span><span class="ident" id="1500426">m</span><span class="op" id="1500427">.</span><span class="ident" id="1500428">blocked</span>&nbsp;<span class="op" id="1500436">=</span>&nbsp;<span class="builtintype" id="1500438">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500445">futexsleep</span><span class="op" id="1500455">(</span><span class="ident" id="1500456">key32</span><span class="op" id="1500461">(</span><span class="op" id="1500462">&amp;</span><span class="ident" id="1500463">n</span><span class="op" id="1500464">.</span><span class="ident" id="1500465">key</span><span class="op" id="1500468">)</span><span class="op" id="1500469">,</span>&nbsp;<span class="num" id="1500471">0</span><span class="op" id="1500472">,</span>&nbsp;<span class="ident" id="1500474">ns</span><span class="op" id="1500476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500480">gp</span><span class="op" id="1500482">.</span><span class="ident" id="1500483">m</span><span class="op" id="1500484">.</span><span class="ident" id="1500485">blocked</span>&nbsp;<span class="op" id="1500493">=</span>&nbsp;<span class="builtintype" id="1500495">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500503">if</span>&nbsp;<span class="ident" id="1500506">atomicload</span><span class="op" id="1500516">(</span><span class="ident" id="1500517">key32</span><span class="op" id="1500522">(</span><span class="op" id="1500523">&amp;</span><span class="ident" id="1500524">n</span><span class="op" id="1500525">.</span><span class="ident" id="1500526">key</span><span class="op" id="1500529">)</span><span class="op" id="1500530">)</span>&nbsp;<span class="op" id="1500532">!=</span>&nbsp;<span class="num" id="1500535">0</span>&nbsp;<span class="op" id="1500537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500542">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500550">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500554">now</span>&nbsp;<span class="op" id="1500558">:=</span>&nbsp;<span class="ident" id="1500561">nanotime</span><span class="op" id="1500569">(</span><span class="op" id="1500570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500574">if</span>&nbsp;<span class="ident" id="1500577">now</span>&nbsp;<span class="op" id="1500581">&gt;=</span>&nbsp;<span class="ident" id="1500584">deadline</span>&nbsp;<span class="op" id="1500593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500598">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500610">ns</span>&nbsp;<span class="op" id="1500613">=</span>&nbsp;<span class="ident" id="1500615">deadline</span>&nbsp;<span class="op" id="1500624">-</span>&nbsp;<span class="ident" id="1500626">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500634">return</span>&nbsp;<span class="ident" id="1500641">atomicload</span><span class="op" id="1500651">(</span><span class="ident" id="1500652">key32</span><span class="op" id="1500657">(</span><span class="op" id="1500658">&amp;</span><span class="ident" id="1500659">n</span><span class="op" id="1500660">.</span><span class="ident" id="1500661">key</span><span class="op" id="1500664">)</span><span class="op" id="1500665">)</span>&nbsp;<span class="op" id="1500667">!=</span>&nbsp;<span class="num" id="1500670">0</span><br>
<span class="lineno"></span><span class="op" id="1500672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1500675">func</span>&nbsp;<span class="ident" id="1500680">notetsleep</span><span class="op" id="1500690">(</span><span class="ident" id="1500691">n</span>&nbsp;<span class="op" id="1500693">*</span><span class="ident" id="1500694">note</span><span class="op" id="1500698">,</span>&nbsp;<span class="ident" id="1500700">ns</span>&nbsp;<span class="builtintype" id="1500703">int64</span><span class="op" id="1500708">)</span>&nbsp;<span class="builtintype" id="1500710">bool</span>&nbsp;<span class="op" id="1500715">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500718">gp</span>&nbsp;<span class="op" id="1500721">:=</span>&nbsp;<span class="ident" id="1500724">getg</span><span class="op" id="1500728">(</span><span class="op" id="1500729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500732">if</span>&nbsp;<span class="ident" id="1500735">gp</span>&nbsp;<span class="op" id="1500738">!=</span>&nbsp;<span class="ident" id="1500741">gp</span><span class="op" id="1500743">.</span><span class="ident" id="1500744">m</span><span class="op" id="1500745">.</span><span class="ident" id="1500746">g0</span>&nbsp;<span class="op" id="1500749">&amp;&amp;</span>&nbsp;<span class="ident" id="1500752">gp</span><span class="op" id="1500754">.</span><span class="ident" id="1500755">m</span><span class="op" id="1500756">.</span><span class="ident" id="1500757">gcing</span>&nbsp;<span class="op" id="1500763">==</span>&nbsp;<span class="num" id="1500766">0</span>&nbsp;<span class="op" id="1500768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1500772">gothrow</span><span class="op" id="1500779">(</span><span class="string" id="1500780">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1500802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1500805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1500809">return</span>&nbsp;<span class="ident" id="1500816">notetsleep_internal</span><span class="op" id="1500835">(</span><span class="ident" id="1500836">n</span><span class="op" id="1500837">,</span>&nbsp;<span class="ident" id="1500839">ns</span><span class="op" id="1500841">)</span><br>
<span class="lineno"></span><span class="op" id="1500843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500846">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1500908">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1500978">func</span>&nbsp;<span class="ident" id="1500983">notetsleepg</span><span class="op" id="1500994">(</span><span class="ident" id="1500995">n</span>&nbsp;<span class="op" id="1500997">*</span><span class="ident" id="1500998">note</span><span class="op" id="1501002">,</span>&nbsp;<span class="ident" id="1501004">ns</span>&nbsp;<span class="builtintype" id="1501007">int64</span><span class="op" id="1501012">)</span>&nbsp;<span class="builtintype" id="1501014">bool</span>&nbsp;<span class="op" id="1501019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501022">gp</span>&nbsp;<span class="op" id="1501025">:=</span>&nbsp;<span class="ident" id="1501028">getg</span><span class="op" id="1501032">(</span><span class="op" id="1501033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501036">if</span>&nbsp;<span class="ident" id="1501039">gp</span>&nbsp;<span class="op" id="1501042">==</span>&nbsp;<span class="ident" id="1501045">gp</span><span class="op" id="1501047">.</span><span class="ident" id="1501048">m</span><span class="op" id="1501049">.</span><span class="ident" id="1501050">g0</span>&nbsp;<span class="op" id="1501053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501057">gothrow</span><span class="op" id="1501064">(</span><span class="string" id="1501065">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1501084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501087">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501091">entersyscallblock</span><span class="op" id="1501108">(</span><span class="op" id="1501109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501112">ok</span>&nbsp;<span class="op" id="1501115">:=</span>&nbsp;<span class="ident" id="1501118">notetsleep_internal</span><span class="op" id="1501137">(</span><span class="ident" id="1501138">n</span><span class="op" id="1501139">,</span>&nbsp;<span class="ident" id="1501141">ns</span><span class="op" id="1501143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501146">exitsyscall</span><span class="op" id="1501157">(</span><span class="op" id="1501158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1501161">return</span>&nbsp;<span class="ident" id="1501168">ok</span><br>
<span class="lineno">205</span><span class="op" id="1501171">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
