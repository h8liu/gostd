<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6276990">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6277046">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6277100">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6277151">package</span>&nbsp;<span class="ident" id="6277159">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6277168">import</span>&nbsp;<span class="op" id="6277175">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6277178">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6277195">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6277205">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6277211">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6277222">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6277229">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6277232">var</span>&nbsp;<span class="ident" id="6277236">errMissingParams</span>&nbsp;<span class="op" id="6277253">=</span>&nbsp;<span class="ident" id="6277255"><a href="/net/rpc/jsonrpc/server.go.html#6277195">errors</a></span><span class="op" id="6277261">.</span><span class="ident" id="6277262">New</span><span class="op" id="6277265">(</span><span class="string" id="6277266">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="6277304">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6277307">type</span>&nbsp;<span class="ident" id="6277312">serverCodec</span>&nbsp;<span class="keyword" id="6277324">struct</span>&nbsp;<span class="op" id="6277331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277334">dec</span>&nbsp;<span class="op" id="6277338">*</span><span class="ident" id="6277339"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6277343">.</span><span class="ident" id="6277344">Decoder</span>&nbsp;<span class="comment" id="6277352">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277380">enc</span>&nbsp;<span class="op" id="6277384">*</span><span class="ident" id="6277385"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6277389">.</span><span class="ident" id="6277390">Encoder</span>&nbsp;<span class="comment" id="6277398">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277426">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6277430"><a href="/net/rpc/jsonrpc/server.go.html#6277205">io</a></span><span class="op" id="6277432">.</span><span class="ident" id="6277433">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277442">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277467">req</span>&nbsp;<span class="ident" id="6277471"><a href="/net/rpc/jsonrpc/server.go.html#6278216">serverRequest</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277487">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277554">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277598">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277657">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277714">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6277767">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277817">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6277825"><a href="/net/rpc/jsonrpc/server.go.html#6277222">sync</a></span><span class="op" id="6277829">.</span><span class="ident" id="6277830">Mutex</span>&nbsp;<span class="comment" id="6277836">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277862">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6277870">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6277878">pending</span>&nbsp;<span class="keyword" id="6277886">map</span><span class="op" id="6277889">[</span><span class="ident" id="6277890">uint64</span><span class="op" id="6277896">]</span><span class="op" id="6277897">*</span><span class="ident" id="6277898"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6277902">.</span><span class="ident" id="6277903">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="6277914">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6277917">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="6277989">func</span>&nbsp;<span class="ident" id="6277994">NewServerCodec</span><span class="op" id="6278008">(</span><span class="ident" id="6278009">conn</span>&nbsp;<span class="ident" id="6278014"><a href="/net/rpc/jsonrpc/server.go.html#6277205">io</a></span><span class="op" id="6278016">.</span><span class="ident" id="6278017">ReadWriteCloser</span><span class="op" id="6278032">)</span>&nbsp;<span class="ident" id="6278034"><a href="/net/rpc/jsonrpc/server.go.html#6277211">rpc</a></span><span class="op" id="6278037">.</span><span class="ident" id="6278038">ServerCodec</span>&nbsp;<span class="op" id="6278050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278053">return</span>&nbsp;<span class="op" id="6278060">&amp;</span><span class="ident" id="6278061"><a href="/net/rpc/jsonrpc/server.go.html#6277312">serverCodec</a></span><span class="op" id="6278072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278076">dec</span><span class="op" id="6278079">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6278085"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278089">.</span><span class="ident" id="6278090">NewDecoder</span><span class="op" id="6278100">(</span><span class="ident" id="6278101"><a href="/net/rpc/jsonrpc/server.go.html#6278009">conn</a></span><span class="op" id="6278105">)</span><span class="op" id="6278106">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278110">enc</span><span class="op" id="6278113">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6278119"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278123">.</span><span class="ident" id="6278124">NewEncoder</span><span class="op" id="6278134">(</span><span class="ident" id="6278135"><a href="/net/rpc/jsonrpc/server.go.html#6278009">conn</a></span><span class="op" id="6278139">)</span><span class="op" id="6278140">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278144">c</span><span class="op" id="6278145">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6278153"><a href="/net/rpc/jsonrpc/server.go.html#6278009">conn</a></span><span class="op" id="6278157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278161">pending</span><span class="op" id="6278168">:</span>&nbsp;<span class="builtinfunc" id="6278170">make</span><span class="op" id="6278174">(</span><span class="keyword" id="6278175">map</span><span class="op" id="6278178">[</span><span class="ident" id="6278179">uint64</span><span class="op" id="6278185">]</span><span class="op" id="6278186">*</span><span class="ident" id="6278187"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278191">.</span><span class="ident" id="6278192">RawMessage</span><span class="op" id="6278202">)</span><span class="op" id="6278203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278206">}</span><br>
<span class="lineno"></span><span class="op" id="6278208">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="6278211">type</span>&nbsp;<span class="ident" id="6278216">serverRequest</span>&nbsp;<span class="keyword" id="6278230">struct</span>&nbsp;<span class="op" id="6278237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278240">Method</span>&nbsp;<span class="builtintype" id="6278247">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6278264">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278281">Params</span>&nbsp;<span class="op" id="6278288">*</span><span class="ident" id="6278289"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278293">.</span><span class="ident" id="6278294">RawMessage</span>&nbsp;<span class="string" id="6278305">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278322">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6278329">*</span><span class="ident" id="6278330"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278334">.</span><span class="ident" id="6278335">RawMessage</span>&nbsp;<span class="string" id="6278346">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="6278358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278361">func</span>&nbsp;<span class="op" id="6278366">(</span><span class="ident" id="6278367">r</span>&nbsp;<span class="op" id="6278369">*</span><span class="ident" id="6278370"><a href="/net/rpc/jsonrpc/server.go.html#6278216">serverRequest</a></span><span class="op" id="6278383">)</span>&nbsp;<span class="ident" id="6278385">reset</span><span class="op" id="6278390">(</span><span class="op" id="6278391">)</span>&nbsp;<span class="op" id="6278393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278396"><a href="/net/rpc/jsonrpc/server.go.html#6278367">r</a></span><span class="op" id="6278397">.</span><span class="ident" id="6278398">Method</span>&nbsp;<span class="op" id="6278405">=</span>&nbsp;<span class="string" id="6278407">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278411"><a href="/net/rpc/jsonrpc/server.go.html#6278367">r</a></span><span class="op" id="6278412">.</span><span class="ident" id="6278413">Params</span>&nbsp;<span class="op" id="6278420">=</span>&nbsp;<span class="ident" id="6278422">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278427"><a href="/net/rpc/jsonrpc/server.go.html#6278367">r</a></span><span class="op" id="6278428">.</span><span class="ident" id="6278429">Id</span>&nbsp;<span class="op" id="6278432">=</span>&nbsp;<span class="ident" id="6278434">nil</span><br>
<span class="lineno"></span><span class="op" id="6278438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278441">type</span>&nbsp;<span class="ident" id="6278446">serverResponse</span>&nbsp;<span class="keyword" id="6278461">struct</span>&nbsp;<span class="op" id="6278468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278471">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6278478">*</span><span class="ident" id="6278479"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6278483">.</span><span class="ident" id="6278484">RawMessage</span>&nbsp;<span class="string" id="6278495">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278508">Result</span>&nbsp;<span class="keyword" id="6278515">interface</span><span class="op" id="6278524">{</span><span class="op" id="6278525">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6278532">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278549">Error</span>&nbsp;&nbsp;<span class="keyword" id="6278556">interface</span><span class="op" id="6278565">{</span><span class="op" id="6278566">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6278573">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="6278588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6278591">func</span>&nbsp;<span class="op" id="6278596">(</span><span class="ident" id="6278597">c</span>&nbsp;<span class="op" id="6278599">*</span><span class="ident" id="6278600"><a href="/net/rpc/jsonrpc/server.go.html#6277312">serverCodec</a></span><span class="op" id="6278611">)</span>&nbsp;<span class="ident" id="6278613">ReadRequestHeader</span><span class="op" id="6278630">(</span><span class="ident" id="6278631">r</span>&nbsp;<span class="op" id="6278633">*</span><span class="ident" id="6278634"><a href="/net/rpc/jsonrpc/server.go.html#6277211">rpc</a></span><span class="op" id="6278637">.</span><span class="ident" id="6278638">Request</span><span class="op" id="6278645">)</span>&nbsp;<span class="builtintype" id="6278647">error</span>&nbsp;<span class="op" id="6278653">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278656"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278657">.</span><span class="ident" id="6278658">req</span><span class="op" id="6278661">.</span><span class="ident" id="6278662">reset</span><span class="op" id="6278667">(</span><span class="op" id="6278668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278671">if</span>&nbsp;<span class="ident" id="6278674">err</span>&nbsp;<span class="op" id="6278678">:=</span>&nbsp;<span class="ident" id="6278681"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278682">.</span><span class="ident" id="6278683">dec</span><span class="op" id="6278686">.</span><span class="ident" id="6278687">Decode</span><span class="op" id="6278693">(</span><span class="op" id="6278694">&amp;</span><span class="ident" id="6278695"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278696">.</span><span class="ident" id="6278697">req</span><span class="op" id="6278700">)</span><span class="op" id="6278701">;</span>&nbsp;<span class="ident" id="6278703"><a href="/net/rpc/jsonrpc/server.go.html#6278674">err</a></span>&nbsp;<span class="op" id="6278707">!=</span>&nbsp;<span class="ident" id="6278710">nil</span>&nbsp;<span class="op" id="6278714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6278718">return</span>&nbsp;<span class="ident" id="6278725"><a href="/net/rpc/jsonrpc/server.go.html#6278674">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6278730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278733"><a href="/net/rpc/jsonrpc/server.go.html#6278631">r</a></span><span class="op" id="6278734">.</span><span class="ident" id="6278735">ServiceMethod</span>&nbsp;<span class="op" id="6278749">=</span>&nbsp;<span class="ident" id="6278751"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278752">.</span><span class="ident" id="6278753">req</span><span class="op" id="6278756">.</span><span class="ident" id="6278757">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6278766">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6278809">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6278855">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278902"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278903">.</span><span class="ident" id="6278904">mutex</span><span class="op" id="6278909">.</span><span class="ident" id="6278910">Lock</span><span class="op" id="6278914">(</span><span class="op" id="6278915">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278918"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278919">.</span><span class="ident" id="6278920">seq</span><span class="op" id="6278923">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278927"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278928">.</span><span class="ident" id="6278929">pending</span><span class="op" id="6278936">[</span><span class="ident" id="6278937"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278938">.</span><span class="ident" id="6278939">seq</span><span class="op" id="6278942">]</span>&nbsp;<span class="op" id="6278944">=</span>&nbsp;<span class="ident" id="6278946"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278947">.</span><span class="ident" id="6278948">req</span><span class="op" id="6278951">.</span><span class="ident" id="6278952">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278956"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278957">.</span><span class="ident" id="6278958">req</span><span class="op" id="6278961">.</span><span class="ident" id="6278962">Id</span>&nbsp;<span class="op" id="6278965">=</span>&nbsp;<span class="ident" id="6278967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278972"><a href="/net/rpc/jsonrpc/server.go.html#6278631">r</a></span><span class="op" id="6278973">.</span><span class="ident" id="6278974">Seq</span>&nbsp;<span class="op" id="6278978">=</span>&nbsp;<span class="ident" id="6278980"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278981">.</span><span class="ident" id="6278982">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6278987"><a href="/net/rpc/jsonrpc/server.go.html#6278597">c</a></span><span class="op" id="6278988">.</span><span class="ident" id="6278989">mutex</span><span class="op" id="6278994">.</span><span class="ident" id="6278995">Unlock</span><span class="op" id="6279001">(</span><span class="op" id="6279002">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279006">return</span>&nbsp;<span class="ident" id="6279013">nil</span><br>
<span class="lineno"></span><span class="op" id="6279017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6279020">func</span>&nbsp;<span class="op" id="6279025">(</span><span class="ident" id="6279026">c</span>&nbsp;<span class="op" id="6279028">*</span><span class="ident" id="6279029"><a href="/net/rpc/jsonrpc/server.go.html#6277312">serverCodec</a></span><span class="op" id="6279040">)</span>&nbsp;<span class="ident" id="6279042">ReadRequestBody</span><span class="op" id="6279057">(</span><span class="ident" id="6279058">x</span>&nbsp;<span class="keyword" id="6279060">interface</span><span class="op" id="6279069">{</span><span class="op" id="6279070">}</span><span class="op" id="6279071">)</span>&nbsp;<span class="builtintype" id="6279073">error</span>&nbsp;<span class="op" id="6279079">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279082">if</span>&nbsp;<span class="ident" id="6279085"><a href="/net/rpc/jsonrpc/server.go.html#6279058">x</a></span>&nbsp;<span class="op" id="6279087">==</span>&nbsp;<span class="ident" id="6279090">nil</span>&nbsp;<span class="op" id="6279094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279098">return</span>&nbsp;<span class="ident" id="6279105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279113">if</span>&nbsp;<span class="ident" id="6279116"><a href="/net/rpc/jsonrpc/server.go.html#6279026">c</a></span><span class="op" id="6279117">.</span><span class="ident" id="6279118">req</span><span class="op" id="6279121">.</span><span class="ident" id="6279122">Params</span>&nbsp;<span class="op" id="6279129">==</span>&nbsp;<span class="ident" id="6279132">nil</span>&nbsp;<span class="op" id="6279136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279140">return</span>&nbsp;<span class="ident" id="6279147"><a href="/net/rpc/jsonrpc/server.go.html#6277236">errMissingParams</a></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279168">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279200">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279226">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279278">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279326">var</span>&nbsp;<span class="ident" id="6279330">params</span>&nbsp;<span class="op" id="6279337">[</span><span class="num" id="6279338">1</span><span class="op" id="6279339">]</span><span class="keyword" id="6279340">interface</span><span class="op" id="6279349">{</span><span class="op" id="6279350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279353"><a href="/net/rpc/jsonrpc/server.go.html#6279330">params</a></span><span class="op" id="6279359">[</span><span class="num" id="6279360">0</span><span class="op" id="6279361">]</span>&nbsp;<span class="op" id="6279363">=</span>&nbsp;<span class="ident" id="6279365"><a href="/net/rpc/jsonrpc/server.go.html#6279058">x</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279368">return</span>&nbsp;<span class="ident" id="6279375"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6279379">.</span><span class="ident" id="6279380">Unmarshal</span><span class="op" id="6279389">(</span><span class="op" id="6279390">*</span><span class="ident" id="6279391"><a href="/net/rpc/jsonrpc/server.go.html#6279026">c</a></span><span class="op" id="6279392">.</span><span class="ident" id="6279393">req</span><span class="op" id="6279396">.</span><span class="ident" id="6279397">Params</span><span class="op" id="6279403">,</span>&nbsp;<span class="op" id="6279405">&amp;</span><span class="ident" id="6279406"><a href="/net/rpc/jsonrpc/server.go.html#6279330">params</a></span><span class="op" id="6279412">)</span><br>
<span class="lineno"></span><span class="op" id="6279414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="6279417">var</span>&nbsp;<span class="ident" id="6279421">null</span>&nbsp;<span class="op" id="6279426">=</span>&nbsp;<span class="ident" id="6279428"><a href="/net/rpc/jsonrpc/server.go.html#6277178">json</a></span><span class="op" id="6279432">.</span><span class="ident" id="6279433">RawMessage</span><span class="op" id="6279443">(</span><span class="op" id="6279444">[</span><span class="op" id="6279445">]</span><span class="builtintype" id="6279446">byte</span><span class="op" id="6279450">(</span><span class="string" id="6279451">&#34;null&#34;</span><span class="op" id="6279457">)</span><span class="op" id="6279458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6279461">func</span>&nbsp;<span class="op" id="6279466">(</span><span class="ident" id="6279467">c</span>&nbsp;<span class="op" id="6279469">*</span><span class="ident" id="6279470"><a href="/net/rpc/jsonrpc/server.go.html#6277312">serverCodec</a></span><span class="op" id="6279481">)</span>&nbsp;<span class="ident" id="6279483">WriteResponse</span><span class="op" id="6279496">(</span><span class="ident" id="6279497">r</span>&nbsp;<span class="op" id="6279499">*</span><span class="ident" id="6279500"><a href="/net/rpc/jsonrpc/server.go.html#6277211">rpc</a></span><span class="op" id="6279503">.</span><span class="ident" id="6279504">Response</span><span class="op" id="6279512">,</span>&nbsp;<span class="ident" id="6279514">x</span>&nbsp;<span class="keyword" id="6279516">interface</span><span class="op" id="6279525">{</span><span class="op" id="6279526">}</span><span class="op" id="6279527">)</span>&nbsp;<span class="builtintype" id="6279529">error</span>&nbsp;<span class="op" id="6279535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279538"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279539">.</span><span class="ident" id="6279540">mutex</span><span class="op" id="6279545">.</span><span class="ident" id="6279546">Lock</span><span class="op" id="6279550">(</span><span class="op" id="6279551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279554">b</span><span class="op" id="6279555">,</span>&nbsp;<span class="ident" id="6279557">ok</span>&nbsp;<span class="op" id="6279560">:=</span>&nbsp;<span class="ident" id="6279563"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279564">.</span><span class="ident" id="6279565">pending</span><span class="op" id="6279572">[</span><span class="ident" id="6279573"><a href="/net/rpc/jsonrpc/server.go.html#6279497">r</a></span><span class="op" id="6279574">.</span><span class="ident" id="6279575">Seq</span><span class="op" id="6279578">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279581">if</span>&nbsp;<span class="op" id="6279584">!</span><span class="ident" id="6279585"><a href="/net/rpc/jsonrpc/server.go.html#6279557">ok</a></span>&nbsp;<span class="op" id="6279588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279592"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279593">.</span><span class="ident" id="6279594">mutex</span><span class="op" id="6279599">.</span><span class="ident" id="6279600">Unlock</span><span class="op" id="6279606">(</span><span class="op" id="6279607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279611">return</span>&nbsp;<span class="ident" id="6279618"><a href="/net/rpc/jsonrpc/server.go.html#6277195">errors</a></span><span class="op" id="6279624">.</span><span class="ident" id="6279625">New</span><span class="op" id="6279628">(</span><span class="string" id="6279629">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="6279666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6279672">delete</span><span class="op" id="6279678">(</span><span class="ident" id="6279679"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279680">.</span><span class="ident" id="6279681">pending</span><span class="op" id="6279688">,</span>&nbsp;<span class="ident" id="6279690"><a href="/net/rpc/jsonrpc/server.go.html#6279497">r</a></span><span class="op" id="6279691">.</span><span class="ident" id="6279692">Seq</span><span class="op" id="6279695">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279698"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279699">.</span><span class="ident" id="6279700">mutex</span><span class="op" id="6279705">.</span><span class="ident" id="6279706">Unlock</span><span class="op" id="6279712">(</span><span class="op" id="6279713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279717">if</span>&nbsp;<span class="ident" id="6279720"><a href="/net/rpc/jsonrpc/server.go.html#6279554">b</a></span>&nbsp;<span class="op" id="6279722">==</span>&nbsp;<span class="ident" id="6279725">nil</span>&nbsp;<span class="op" id="6279729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6279733">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279780"><a href="/net/rpc/jsonrpc/server.go.html#6279554">b</a></span>&nbsp;<span class="op" id="6279782">=</span>&nbsp;<span class="op" id="6279784">&amp;</span><span class="ident" id="6279785"><a href="/net/rpc/jsonrpc/server.go.html#6279421">null</a></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279794">resp</span>&nbsp;<span class="op" id="6279799">:=</span>&nbsp;<span class="ident" id="6279802"><a href="/net/rpc/jsonrpc/server.go.html#6278446">serverResponse</a></span><span class="op" id="6279816">{</span><span class="ident" id="6279817">Id</span><span class="op" id="6279819">:</span>&nbsp;<span class="ident" id="6279821"><a href="/net/rpc/jsonrpc/server.go.html#6279554">b</a></span><span class="op" id="6279822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279825">if</span>&nbsp;<span class="ident" id="6279828"><a href="/net/rpc/jsonrpc/server.go.html#6279497">r</a></span><span class="op" id="6279829">.</span><span class="ident" id="6279830">Error</span>&nbsp;<span class="op" id="6279836">==</span>&nbsp;<span class="string" id="6279839">&#34;&#34;</span>&nbsp;<span class="op" id="6279842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279846"><a href="/net/rpc/jsonrpc/server.go.html#6279794">resp</a></span><span class="op" id="6279850">.</span><span class="ident" id="6279851">Result</span>&nbsp;<span class="op" id="6279858">=</span>&nbsp;<span class="ident" id="6279860"><a href="/net/rpc/jsonrpc/server.go.html#6279514">x</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279863">}</span>&nbsp;<span class="keyword" id="6279865">else</span>&nbsp;<span class="op" id="6279870">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6279874"><a href="/net/rpc/jsonrpc/server.go.html#6279794">resp</a></span><span class="op" id="6279878">.</span><span class="ident" id="6279879">Error</span>&nbsp;<span class="op" id="6279885">=</span>&nbsp;<span class="ident" id="6279887"><a href="/net/rpc/jsonrpc/server.go.html#6279497">r</a></span><span class="op" id="6279888">.</span><span class="ident" id="6279889">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6279896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279899">return</span>&nbsp;<span class="ident" id="6279906"><a href="/net/rpc/jsonrpc/server.go.html#6279467">c</a></span><span class="op" id="6279907">.</span><span class="ident" id="6279908">enc</span><span class="op" id="6279911">.</span><span class="ident" id="6279912">Encode</span><span class="op" id="6279918">(</span><span class="ident" id="6279919"><a href="/net/rpc/jsonrpc/server.go.html#6279794">resp</a></span><span class="op" id="6279923">)</span><br>
<span class="lineno"></span><span class="op" id="6279925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="6279928">func</span>&nbsp;<span class="op" id="6279933">(</span><span class="ident" id="6279934">c</span>&nbsp;<span class="op" id="6279936">*</span><span class="ident" id="6279937"><a href="/net/rpc/jsonrpc/server.go.html#6277312">serverCodec</a></span><span class="op" id="6279948">)</span>&nbsp;<span class="ident" id="6279950">Close</span><span class="op" id="6279955">(</span><span class="op" id="6279956">)</span>&nbsp;<span class="builtintype" id="6279958">error</span>&nbsp;<span class="op" id="6279964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6279967">return</span>&nbsp;<span class="ident" id="6279974"><a href="/net/rpc/jsonrpc/server.go.html#6279934">c</a></span><span class="op" id="6279975">.</span><span class="ident" id="6279976">c</span><span class="op" id="6279977">.</span><span class="ident" id="6279978">Close</span><span class="op" id="6279983">(</span><span class="op" id="6279984">)</span><br>
<span class="lineno"></span><span class="op" id="6279986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6279989">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="6280051">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="6280122">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6280183">func</span>&nbsp;<span class="ident" id="6280188">ServeConn</span><span class="op" id="6280197">(</span><span class="ident" id="6280198">conn</span>&nbsp;<span class="ident" id="6280203"><a href="/net/rpc/jsonrpc/server.go.html#6277205">io</a></span><span class="op" id="6280205">.</span><span class="ident" id="6280206">ReadWriteCloser</span><span class="op" id="6280221">)</span>&nbsp;<span class="op" id="6280223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6280226"><a href="/net/rpc/jsonrpc/server.go.html#6277211">rpc</a></span><span class="op" id="6280229">.</span><span class="ident" id="6280230">ServeCodec</span><span class="op" id="6280240">(</span><span class="ident" id="6280241"><a href="/net/rpc/jsonrpc/server.go.html#6277994">NewServerCodec</a></span><span class="op" id="6280255">(</span><span class="ident" id="6280256"><a href="/net/rpc/jsonrpc/server.go.html#6280198">conn</a></span><span class="op" id="6280260">)</span><span class="op" id="6280261">)</span><br>
<span class="lineno"></span><span class="op" id="6280263">}</span>
</div>
</body>
</html>
