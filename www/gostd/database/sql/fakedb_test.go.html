<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8360274">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8360329">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8360383">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8360434">package</span>&nbsp;<span class="ident" id="8360442">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8360447">import</span>&nbsp;<span class="op" id="8360454">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360457">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360480">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360490">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360497">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360503">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360510">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360518">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360529">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360540">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360548">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8360559">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8360566">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8360569">var</span>&nbsp;<span class="ident" id="8360573">_</span>&nbsp;<span class="op" id="8360575">=</span>&nbsp;<span class="ident" id="8360577">log</span><span class="op" id="8360580">.</span><span class="ident" id="8360581">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8360589">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="8360657">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="8360689">//</span><br>
<span class="lineno"></span><span class="comment" id="8360692">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="8360757">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="8360824">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="8360836">//</span><br>
<span class="lineno">30</span><span class="comment" id="8360839">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="8360849">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="8360903">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="8360964">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="8361013">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="8361086">//</span><br>
<span class="lineno"></span><span class="comment" id="8361089">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="8361154">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="8361213">type</span>&nbsp;<span class="ident" id="8361218">fakeDriver</span>&nbsp;<span class="keyword" id="8361229">struct</span>&nbsp;<span class="op" id="8361236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361239">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361250">sync</span><span class="op" id="8361254">.</span><span class="ident" id="8361255">Mutex</span>&nbsp;<span class="comment" id="8361261">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361291">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="8361302">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8361313">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361328">closeCount</span>&nbsp;<span class="builtintype" id="8361339">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8361350">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361366">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361377">chan</span>&nbsp;<span class="keyword" id="8361382">struct</span><span class="op" id="8361388">{</span><span class="op" id="8361389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361392">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="8361403">chan</span>&nbsp;<span class="keyword" id="8361408">struct</span><span class="op" id="8361414">{</span><span class="op" id="8361415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361418">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8361429">map</span><span class="op" id="8361432">[</span><span class="builtintype" id="8361433">string</span><span class="op" id="8361439">]</span><span class="op" id="8361440">*</span><span class="ident" id="8361441">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="8361448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8361451">type</span>&nbsp;<span class="ident" id="8361456">fakeDB</span>&nbsp;<span class="keyword" id="8361463">struct</span>&nbsp;<span class="op" id="8361470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361473">name</span>&nbsp;<span class="builtintype" id="8361478">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361487">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361495">sync</span><span class="op" id="8361499">.</span><span class="ident" id="8361500">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361507">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361515">[</span><span class="op" id="8361516">]</span><span class="op" id="8361517">*</span><span class="ident" id="8361518">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361528">tables</span>&nbsp;&nbsp;<span class="keyword" id="8361536">map</span><span class="op" id="8361539">[</span><span class="builtintype" id="8361540">string</span><span class="op" id="8361546">]</span><span class="op" id="8361547">*</span><span class="ident" id="8361548">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361555">badConn</span>&nbsp;<span class="builtintype" id="8361563">bool</span><br>
<span class="lineno"></span><span class="op" id="8361568">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8361571">type</span>&nbsp;<span class="ident" id="8361576">table</span>&nbsp;<span class="keyword" id="8361582">struct</span>&nbsp;<span class="op" id="8361589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361592">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8361600">sync</span><span class="op" id="8361604">.</span><span class="ident" id="8361605">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361612">colname</span>&nbsp;<span class="op" id="8361620">[</span><span class="op" id="8361621">]</span><span class="builtintype" id="8361622">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361630">coltype</span>&nbsp;<span class="op" id="8361638">[</span><span class="op" id="8361639">]</span><span class="builtintype" id="8361640">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361648">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8361656">[</span><span class="op" id="8361657">]</span><span class="op" id="8361658">*</span><span class="ident" id="8361659">row</span><br>
<span class="lineno"></span><span class="op" id="8361663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8361666">func</span>&nbsp;<span class="op" id="8361671">(</span><span class="ident" id="8361672">t</span>&nbsp;<span class="op" id="8361674">*</span><span class="ident" id="8361675">table</span><span class="op" id="8361680">)</span>&nbsp;<span class="ident" id="8361682">columnIndex</span><span class="op" id="8361693">(</span><span class="ident" id="8361694">name</span>&nbsp;<span class="builtintype" id="8361699">string</span><span class="op" id="8361705">)</span>&nbsp;<span class="builtintype" id="8361707">int</span>&nbsp;<span class="op" id="8361711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8361714">for</span>&nbsp;<span class="ident" id="8361718">n</span><span class="op" id="8361719">,</span>&nbsp;<span class="ident" id="8361721">nname</span>&nbsp;<span class="op" id="8361727">:=</span>&nbsp;<span class="keyword" id="8361730">range</span>&nbsp;<span class="ident" id="8361736">t</span><span class="op" id="8361737">.</span><span class="ident" id="8361738">colname</span>&nbsp;<span class="op" id="8361746">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8361750">if</span>&nbsp;<span class="ident" id="8361753">name</span>&nbsp;<span class="op" id="8361758">==</span>&nbsp;<span class="ident" id="8361761">nname</span>&nbsp;<span class="op" id="8361767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8361772">return</span>&nbsp;<span class="ident" id="8361779">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8361783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8361786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8361789">return</span>&nbsp;<span class="op" id="8361796">-</span><span class="num" id="8361797">1</span><br>
<span class="lineno">70</span><span class="op" id="8361799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8361802">type</span>&nbsp;<span class="ident" id="8361807">row</span>&nbsp;<span class="keyword" id="8361811">struct</span>&nbsp;<span class="op" id="8361818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361821">cols</span>&nbsp;<span class="op" id="8361826">[</span><span class="op" id="8361827">]</span><span class="keyword" id="8361828">interface</span><span class="op" id="8361837">{</span><span class="op" id="8361838">}</span>&nbsp;<span class="comment" id="8361840">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="8361892">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="8361895">func</span>&nbsp;<span class="op" id="8361900">(</span><span class="ident" id="8361901">r</span>&nbsp;<span class="op" id="8361903">*</span><span class="ident" id="8361904">row</span><span class="op" id="8361907">)</span>&nbsp;<span class="ident" id="8361909">clone</span><span class="op" id="8361914">(</span><span class="op" id="8361915">)</span>&nbsp;<span class="op" id="8361917">*</span><span class="ident" id="8361918">row</span>&nbsp;<span class="op" id="8361922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8361925">nrow</span>&nbsp;<span class="op" id="8361930">:=</span>&nbsp;<span class="op" id="8361933">&amp;</span><span class="ident" id="8361934">row</span><span class="op" id="8361937">{</span><span class="ident" id="8361938">cols</span><span class="op" id="8361942">:</span>&nbsp;<span class="builtinfunc" id="8361944">make</span><span class="op" id="8361948">(</span><span class="op" id="8361949">[</span><span class="op" id="8361950">]</span><span class="keyword" id="8361951">interface</span><span class="op" id="8361960">{</span><span class="op" id="8361961">}</span><span class="op" id="8361962">,</span>&nbsp;<span class="builtinfunc" id="8361964">len</span><span class="op" id="8361967">(</span><span class="ident" id="8361968">r</span><span class="op" id="8361969">.</span><span class="ident" id="8361970">cols</span><span class="op" id="8361974">)</span><span class="op" id="8361975">)</span><span class="op" id="8361976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8361979">copy</span><span class="op" id="8361983">(</span><span class="ident" id="8361984">nrow</span><span class="op" id="8361988">.</span><span class="ident" id="8361989">cols</span><span class="op" id="8361993">,</span>&nbsp;<span class="ident" id="8361995">r</span><span class="op" id="8361996">.</span><span class="ident" id="8361997">cols</span><span class="op" id="8362001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362004">return</span>&nbsp;<span class="ident" id="8362011">nrow</span><br>
<span class="lineno">80</span><span class="op" id="8362016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362019">type</span>&nbsp;<span class="ident" id="8362024">fakeConn</span>&nbsp;<span class="keyword" id="8362033">struct</span>&nbsp;<span class="op" id="8362040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362043">db</span>&nbsp;<span class="op" id="8362046">*</span><span class="ident" id="8362047">fakeDB</span>&nbsp;<span class="comment" id="8362054">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362088">currTx</span>&nbsp;<span class="op" id="8362095">*</span><span class="ident" id="8362096">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8362105">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362126">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8362138">sync</span><span class="op" id="8362142">.</span><span class="ident" id="8362143">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362150">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362162">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362167">stmtsClosed</span>&nbsp;<span class="builtintype" id="8362179">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362184">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="8362196">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362201">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362213">bool</span><br>
<span class="lineno"></span><span class="op" id="8362218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8362221">func</span>&nbsp;<span class="op" id="8362226">(</span><span class="ident" id="8362227">c</span>&nbsp;<span class="op" id="8362229">*</span><span class="ident" id="8362230">fakeConn</span><span class="op" id="8362238">)</span>&nbsp;<span class="ident" id="8362240">incrStat</span><span class="op" id="8362248">(</span><span class="ident" id="8362249">v</span>&nbsp;<span class="op" id="8362251">*</span><span class="builtintype" id="8362252">int</span><span class="op" id="8362255">)</span>&nbsp;<span class="op" id="8362257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362260">c</span><span class="op" id="8362261">.</span><span class="ident" id="8362262">mu</span><span class="op" id="8362264">.</span><span class="ident" id="8362265">Lock</span><span class="op" id="8362269">(</span><span class="op" id="8362270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8362273">*</span><span class="ident" id="8362274">v</span><span class="op" id="8362275">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362279">c</span><span class="op" id="8362280">.</span><span class="ident" id="8362281">mu</span><span class="op" id="8362283">.</span><span class="ident" id="8362284">Unlock</span><span class="op" id="8362290">(</span><span class="op" id="8362291">)</span><br>
<span class="lineno"></span><span class="op" id="8362293">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8362296">type</span>&nbsp;<span class="ident" id="8362301">fakeTx</span>&nbsp;<span class="keyword" id="8362308">struct</span>&nbsp;<span class="op" id="8362315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362318">c</span>&nbsp;<span class="op" id="8362320">*</span><span class="ident" id="8362321">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="8362330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="8362333">type</span>&nbsp;<span class="ident" id="8362338">fakeStmt</span>&nbsp;<span class="keyword" id="8362347">struct</span>&nbsp;<span class="op" id="8362354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362357">c</span>&nbsp;<span class="op" id="8362359">*</span><span class="ident" id="8362360">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362370">q</span>&nbsp;<span class="builtintype" id="8362372">string</span>&nbsp;<span class="comment" id="8362379">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362403">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8362409">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362417">table</span>&nbsp;<span class="builtintype" id="8362423">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362432">closed</span>&nbsp;<span class="builtintype" id="8362439">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362446">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362459">[</span><span class="op" id="8362460">]</span><span class="builtintype" id="8362461">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8362473">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362527">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362540">[</span><span class="op" id="8362541">]</span><span class="builtintype" id="8362542">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8362554">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362573">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8362586">[</span><span class="op" id="8362587">]</span><span class="keyword" id="8362588">interface</span><span class="op" id="8362597">{</span><span class="op" id="8362598">}</span>&nbsp;<span class="comment" id="8362600">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362661">placeholders</span>&nbsp;<span class="builtintype" id="8362674">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8362688">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362735">whereCol</span>&nbsp;<span class="op" id="8362744">[</span><span class="op" id="8362745">]</span><span class="builtintype" id="8362746">string</span>&nbsp;<span class="comment" id="8362753">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362792">placeholderConverter</span>&nbsp;<span class="op" id="8362813">[</span><span class="op" id="8362814">]</span><span class="ident" id="8362815">driver</span><span class="op" id="8362821">.</span><span class="ident" id="8362822">ValueConverter</span>&nbsp;<span class="comment" id="8362837">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="8362855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8362858">var</span>&nbsp;<span class="ident" id="8362862">fdriver</span>&nbsp;<span class="ident" id="8362870">driver</span><span class="op" id="8362876">.</span><span class="ident" id="8362877">Driver</span>&nbsp;<span class="op" id="8362884">=</span>&nbsp;<span class="op" id="8362886">&amp;</span><span class="ident" id="8362887">fakeDriver</span><span class="op" id="8362897">{</span><span class="op" id="8362898">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="8362901">func</span>&nbsp;<span class="ident" id="8362906">init</span><span class="op" id="8362910">(</span><span class="op" id="8362911">)</span>&nbsp;<span class="op" id="8362913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8362916">Register</span><span class="op" id="8362924">(</span><span class="string" id="8362925">&#34;test&#34;</span><span class="op" id="8362931">,</span>&nbsp;<span class="ident" id="8362933">fdriver</span><span class="op" id="8362940">)</span><br>
<span class="lineno"></span><span class="op" id="8362942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="8362945">func</span>&nbsp;<span class="ident" id="8362950">contains</span><span class="op" id="8362958">(</span><span class="ident" id="8362959">list</span>&nbsp;<span class="op" id="8362964">[</span><span class="op" id="8362965">]</span><span class="builtintype" id="8362966">string</span><span class="op" id="8362972">,</span>&nbsp;<span class="ident" id="8362974">y</span>&nbsp;<span class="builtintype" id="8362976">string</span><span class="op" id="8362982">)</span>&nbsp;<span class="builtintype" id="8362984">bool</span>&nbsp;<span class="op" id="8362989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8362992">for</span>&nbsp;<span class="ident" id="8362996">_</span><span class="op" id="8362997">,</span>&nbsp;<span class="ident" id="8362999">x</span>&nbsp;<span class="op" id="8363001">:=</span>&nbsp;<span class="keyword" id="8363004">range</span>&nbsp;<span class="ident" id="8363010">list</span>&nbsp;<span class="op" id="8363015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363019">if</span>&nbsp;<span class="ident" id="8363022">x</span>&nbsp;<span class="op" id="8363024">==</span>&nbsp;<span class="ident" id="8363027">y</span>&nbsp;<span class="op" id="8363029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363034">return</span>&nbsp;<span class="builtintype" id="8363041">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363048">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363054">return</span>&nbsp;<span class="builtintype" id="8363061">false</span><br>
<span class="lineno"></span><span class="op" id="8363067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8363070">type</span>&nbsp;<span class="ident" id="8363075">Dummy</span>&nbsp;<span class="keyword" id="8363081">struct</span>&nbsp;<span class="op" id="8363088">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363091">driver</span><span class="op" id="8363097">.</span><span class="ident" id="8363098">Driver</span><br>
<span class="lineno"></span><span class="op" id="8363105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8363108">func</span>&nbsp;<span class="ident" id="8363113">TestDrivers</span><span class="op" id="8363124">(</span><span class="ident" id="8363125">t</span>&nbsp;<span class="op" id="8363127">*</span><span class="ident" id="8363128">testing</span><span class="op" id="8363135">.</span><span class="ident" id="8363136">T</span><span class="op" id="8363137">)</span>&nbsp;<span class="op" id="8363139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363142">unregisterAllDrivers</span><span class="op" id="8363162">(</span><span class="op" id="8363163">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363166">Register</span><span class="op" id="8363174">(</span><span class="string" id="8363175">&#34;test&#34;</span><span class="op" id="8363181">,</span>&nbsp;<span class="ident" id="8363183">fdriver</span><span class="op" id="8363190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363193">Register</span><span class="op" id="8363201">(</span><span class="string" id="8363202">&#34;invalid&#34;</span><span class="op" id="8363211">,</span>&nbsp;<span class="ident" id="8363213">Dummy</span><span class="op" id="8363218">{</span><span class="op" id="8363219">}</span><span class="op" id="8363220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363223">all</span>&nbsp;<span class="op" id="8363227">:=</span>&nbsp;<span class="ident" id="8363230">Drivers</span><span class="op" id="8363237">(</span><span class="op" id="8363238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363241">if</span>&nbsp;<span class="builtinfunc" id="8363244">len</span><span class="op" id="8363247">(</span><span class="ident" id="8363248">all</span><span class="op" id="8363251">)</span>&nbsp;<span class="op" id="8363253">&lt;</span>&nbsp;<span class="num" id="8363255">2</span>&nbsp;<span class="op" id="8363257">||</span>&nbsp;<span class="op" id="8363260">!</span><span class="ident" id="8363261">sort</span><span class="op" id="8363265">.</span><span class="ident" id="8363266">StringsAreSorted</span><span class="op" id="8363282">(</span><span class="ident" id="8363283">all</span><span class="op" id="8363286">)</span>&nbsp;<span class="op" id="8363288">||</span>&nbsp;<span class="op" id="8363291">!</span><span class="ident" id="8363292">contains</span><span class="op" id="8363300">(</span><span class="ident" id="8363301">all</span><span class="op" id="8363304">,</span>&nbsp;<span class="string" id="8363306">&#34;test&#34;</span><span class="op" id="8363312">)</span>&nbsp;<span class="op" id="8363314">||</span>&nbsp;<span class="op" id="8363317">!</span><span class="ident" id="8363318">contains</span><span class="op" id="8363326">(</span><span class="ident" id="8363327">all</span><span class="op" id="8363330">,</span>&nbsp;<span class="string" id="8363332">&#34;invalid&#34;</span><span class="op" id="8363341">)</span>&nbsp;<span class="op" id="8363343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363347">t</span><span class="op" id="8363348">.</span><span class="ident" id="8363349">Fatalf</span><span class="op" id="8363355">(</span><span class="string" id="8363356">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="8363418">,</span>&nbsp;<span class="ident" id="8363420">all</span><span class="op" id="8363423">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363426">}</span><br>
<span class="lineno"></span><span class="op" id="8363428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8363431">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="8363454">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="8363469">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="8363539">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="8363612">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="8363662">func</span>&nbsp;<span class="op" id="8363667">(</span><span class="ident" id="8363668">d</span>&nbsp;<span class="op" id="8363670">*</span><span class="ident" id="8363671">fakeDriver</span><span class="op" id="8363681">)</span>&nbsp;<span class="ident" id="8363683">Open</span><span class="op" id="8363687">(</span><span class="ident" id="8363688">dsn</span>&nbsp;<span class="builtintype" id="8363692">string</span><span class="op" id="8363698">)</span>&nbsp;<span class="op" id="8363700">(</span><span class="ident" id="8363701">driver</span><span class="op" id="8363707">.</span><span class="ident" id="8363708">Conn</span><span class="op" id="8363712">,</span>&nbsp;<span class="builtintype" id="8363714">error</span><span class="op" id="8363719">)</span>&nbsp;<span class="op" id="8363721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363724">parts</span>&nbsp;<span class="op" id="8363730">:=</span>&nbsp;<span class="ident" id="8363733">strings</span><span class="op" id="8363740">.</span><span class="ident" id="8363741">Split</span><span class="op" id="8363746">(</span><span class="ident" id="8363747">dsn</span><span class="op" id="8363750">,</span>&nbsp;<span class="string" id="8363752">&#34;;&#34;</span><span class="op" id="8363755">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363758">if</span>&nbsp;<span class="builtinfunc" id="8363761">len</span><span class="op" id="8363764">(</span><span class="ident" id="8363765">parts</span><span class="op" id="8363770">)</span>&nbsp;<span class="op" id="8363772">&lt;</span>&nbsp;<span class="num" id="8363774">1</span>&nbsp;<span class="op" id="8363776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363780">return</span>&nbsp;<span class="ident" id="8363787">nil</span><span class="op" id="8363790">,</span>&nbsp;<span class="ident" id="8363792">errors</span><span class="op" id="8363798">.</span><span class="ident" id="8363799">New</span><span class="op" id="8363802">(</span><span class="string" id="8363803">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="8363829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8363832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363835">name</span>&nbsp;<span class="op" id="8363840">:=</span>&nbsp;<span class="ident" id="8363843">parts</span><span class="op" id="8363848">[</span><span class="num" id="8363849">0</span><span class="op" id="8363850">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363854">db</span>&nbsp;<span class="op" id="8363857">:=</span>&nbsp;<span class="ident" id="8363860">d</span><span class="op" id="8363861">.</span><span class="ident" id="8363862">getDB</span><span class="op" id="8363867">(</span><span class="ident" id="8363868">name</span><span class="op" id="8363872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363876">d</span><span class="op" id="8363877">.</span><span class="ident" id="8363878">mu</span><span class="op" id="8363880">.</span><span class="ident" id="8363881">Lock</span><span class="op" id="8363885">(</span><span class="op" id="8363886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363889">d</span><span class="op" id="8363890">.</span><span class="ident" id="8363891">openCount</span><span class="op" id="8363900">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363904">d</span><span class="op" id="8363905">.</span><span class="ident" id="8363906">mu</span><span class="op" id="8363908">.</span><span class="ident" id="8363909">Unlock</span><span class="op" id="8363915">(</span><span class="op" id="8363916">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363919">conn</span>&nbsp;<span class="op" id="8363924">:=</span>&nbsp;<span class="op" id="8363927">&amp;</span><span class="ident" id="8363928">fakeConn</span><span class="op" id="8363936">{</span><span class="ident" id="8363937">db</span><span class="op" id="8363939">:</span>&nbsp;<span class="ident" id="8363941">db</span><span class="op" id="8363943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8363947">if</span>&nbsp;<span class="builtinfunc" id="8363950">len</span><span class="op" id="8363953">(</span><span class="ident" id="8363954">parts</span><span class="op" id="8363959">)</span>&nbsp;<span class="op" id="8363961">&gt;=</span>&nbsp;<span class="num" id="8363964">2</span>&nbsp;<span class="op" id="8363966">&amp;&amp;</span>&nbsp;<span class="ident" id="8363969">parts</span><span class="op" id="8363974">[</span><span class="num" id="8363975">1</span><span class="op" id="8363976">]</span>&nbsp;<span class="op" id="8363978">==</span>&nbsp;<span class="string" id="8363981">&#34;badConn&#34;</span>&nbsp;<span class="op" id="8363991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8363995">conn</span><span class="op" id="8363999">.</span><span class="ident" id="8364000">bad</span>&nbsp;<span class="op" id="8364004">=</span>&nbsp;<span class="builtintype" id="8364006">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364012">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364015">if</span>&nbsp;<span class="ident" id="8364018">d</span><span class="op" id="8364019">.</span><span class="ident" id="8364020">waitCh</span>&nbsp;<span class="op" id="8364027">!=</span>&nbsp;<span class="ident" id="8364030">nil</span>&nbsp;<span class="op" id="8364034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364038">d</span><span class="op" id="8364039">.</span><span class="ident" id="8364040">waitingCh</span>&nbsp;<span class="op" id="8364050">&lt;-</span>&nbsp;<span class="keyword" id="8364053">struct</span><span class="op" id="8364059">{</span><span class="op" id="8364060">}</span><span class="op" id="8364061">{</span><span class="op" id="8364062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364066">&lt;-</span><span class="ident" id="8364068">d</span><span class="op" id="8364069">.</span><span class="ident" id="8364070">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364079">d</span><span class="op" id="8364080">.</span><span class="ident" id="8364081">waitCh</span>&nbsp;<span class="op" id="8364088">=</span>&nbsp;<span class="ident" id="8364090">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364096">d</span><span class="op" id="8364097">.</span><span class="ident" id="8364098">waitingCh</span>&nbsp;<span class="op" id="8364108">=</span>&nbsp;<span class="ident" id="8364110">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364118">return</span>&nbsp;<span class="ident" id="8364125">conn</span><span class="op" id="8364129">,</span>&nbsp;<span class="ident" id="8364131">nil</span><br>
<span class="lineno"></span><span class="op" id="8364135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364138">func</span>&nbsp;<span class="op" id="8364143">(</span><span class="ident" id="8364144">d</span>&nbsp;<span class="op" id="8364146">*</span><span class="ident" id="8364147">fakeDriver</span><span class="op" id="8364157">)</span>&nbsp;<span class="ident" id="8364159">getDB</span><span class="op" id="8364164">(</span><span class="ident" id="8364165">name</span>&nbsp;<span class="builtintype" id="8364170">string</span><span class="op" id="8364176">)</span>&nbsp;<span class="op" id="8364178">*</span><span class="ident" id="8364179">fakeDB</span>&nbsp;<span class="op" id="8364186">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364189">d</span><span class="op" id="8364190">.</span><span class="ident" id="8364191">mu</span><span class="op" id="8364193">.</span><span class="ident" id="8364194">Lock</span><span class="op" id="8364198">(</span><span class="op" id="8364199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364202">defer</span>&nbsp;<span class="ident" id="8364208">d</span><span class="op" id="8364209">.</span><span class="ident" id="8364210">mu</span><span class="op" id="8364212">.</span><span class="ident" id="8364213">Unlock</span><span class="op" id="8364219">(</span><span class="op" id="8364220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364223">if</span>&nbsp;<span class="ident" id="8364226">d</span><span class="op" id="8364227">.</span><span class="ident" id="8364228">dbs</span>&nbsp;<span class="op" id="8364232">==</span>&nbsp;<span class="ident" id="8364235">nil</span>&nbsp;<span class="op" id="8364239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364243">d</span><span class="op" id="8364244">.</span><span class="ident" id="8364245">dbs</span>&nbsp;<span class="op" id="8364249">=</span>&nbsp;<span class="builtinfunc" id="8364251">make</span><span class="op" id="8364255">(</span><span class="keyword" id="8364256">map</span><span class="op" id="8364259">[</span><span class="builtintype" id="8364260">string</span><span class="op" id="8364266">]</span><span class="op" id="8364267">*</span><span class="ident" id="8364268">fakeDB</span><span class="op" id="8364274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364277">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364280">db</span><span class="op" id="8364282">,</span>&nbsp;<span class="ident" id="8364284">ok</span>&nbsp;<span class="op" id="8364287">:=</span>&nbsp;<span class="ident" id="8364290">d</span><span class="op" id="8364291">.</span><span class="ident" id="8364292">dbs</span><span class="op" id="8364295">[</span><span class="ident" id="8364296">name</span><span class="op" id="8364300">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364303">if</span>&nbsp;<span class="op" id="8364306">!</span><span class="ident" id="8364307">ok</span>&nbsp;<span class="op" id="8364310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364314">db</span>&nbsp;<span class="op" id="8364317">=</span>&nbsp;<span class="op" id="8364319">&amp;</span><span class="ident" id="8364320">fakeDB</span><span class="op" id="8364326">{</span><span class="ident" id="8364327">name</span><span class="op" id="8364331">:</span>&nbsp;<span class="ident" id="8364333">name</span><span class="op" id="8364337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364341">d</span><span class="op" id="8364342">.</span><span class="ident" id="8364343">dbs</span><span class="op" id="8364346">[</span><span class="ident" id="8364347">name</span><span class="op" id="8364351">]</span>&nbsp;<span class="op" id="8364353">=</span>&nbsp;<span class="ident" id="8364355">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364359">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364362">return</span>&nbsp;<span class="ident" id="8364369">db</span><br>
<span class="lineno"></span><span class="op" id="8364372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364375">func</span>&nbsp;<span class="op" id="8364380">(</span><span class="ident" id="8364381">db</span>&nbsp;<span class="op" id="8364384">*</span><span class="ident" id="8364385">fakeDB</span><span class="op" id="8364391">)</span>&nbsp;<span class="ident" id="8364393">wipe</span><span class="op" id="8364397">(</span><span class="op" id="8364398">)</span>&nbsp;<span class="op" id="8364400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364403">db</span><span class="op" id="8364405">.</span><span class="ident" id="8364406">mu</span><span class="op" id="8364408">.</span><span class="ident" id="8364409">Lock</span><span class="op" id="8364413">(</span><span class="op" id="8364414">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364417">defer</span>&nbsp;<span class="ident" id="8364423">db</span><span class="op" id="8364425">.</span><span class="ident" id="8364426">mu</span><span class="op" id="8364428">.</span><span class="ident" id="8364429">Unlock</span><span class="op" id="8364435">(</span><span class="op" id="8364436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364439">db</span><span class="op" id="8364441">.</span><span class="ident" id="8364442">tables</span>&nbsp;<span class="op" id="8364449">=</span>&nbsp;<span class="ident" id="8364451">nil</span><br>
<span class="lineno"></span><span class="op" id="8364455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8364458">func</span>&nbsp;<span class="op" id="8364463">(</span><span class="ident" id="8364464">db</span>&nbsp;<span class="op" id="8364467">*</span><span class="ident" id="8364468">fakeDB</span><span class="op" id="8364474">)</span>&nbsp;<span class="ident" id="8364476">createTable</span><span class="op" id="8364487">(</span><span class="ident" id="8364488">name</span>&nbsp;<span class="builtintype" id="8364493">string</span><span class="op" id="8364499">,</span>&nbsp;<span class="ident" id="8364501">columnNames</span><span class="op" id="8364512">,</span>&nbsp;<span class="ident" id="8364514">columnTypes</span>&nbsp;<span class="op" id="8364526">[</span><span class="op" id="8364527">]</span><span class="builtintype" id="8364528">string</span><span class="op" id="8364534">)</span>&nbsp;<span class="builtintype" id="8364536">error</span>&nbsp;<span class="op" id="8364542">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364545">db</span><span class="op" id="8364547">.</span><span class="ident" id="8364548">mu</span><span class="op" id="8364550">.</span><span class="ident" id="8364551">Lock</span><span class="op" id="8364555">(</span><span class="op" id="8364556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364559">defer</span>&nbsp;<span class="ident" id="8364565">db</span><span class="op" id="8364567">.</span><span class="ident" id="8364568">mu</span><span class="op" id="8364570">.</span><span class="ident" id="8364571">Unlock</span><span class="op" id="8364577">(</span><span class="op" id="8364578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364581">if</span>&nbsp;<span class="ident" id="8364584">db</span><span class="op" id="8364586">.</span><span class="ident" id="8364587">tables</span>&nbsp;<span class="op" id="8364594">==</span>&nbsp;<span class="ident" id="8364597">nil</span>&nbsp;<span class="op" id="8364601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364605">db</span><span class="op" id="8364607">.</span><span class="ident" id="8364608">tables</span>&nbsp;<span class="op" id="8364615">=</span>&nbsp;<span class="builtinfunc" id="8364617">make</span><span class="op" id="8364621">(</span><span class="keyword" id="8364622">map</span><span class="op" id="8364625">[</span><span class="builtintype" id="8364626">string</span><span class="op" id="8364632">]</span><span class="op" id="8364633">*</span><span class="ident" id="8364634">table</span><span class="op" id="8364639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364642">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364645">if</span>&nbsp;<span class="ident" id="8364648">_</span><span class="op" id="8364649">,</span>&nbsp;<span class="ident" id="8364651">exist</span>&nbsp;<span class="op" id="8364657">:=</span>&nbsp;<span class="ident" id="8364660">db</span><span class="op" id="8364662">.</span><span class="ident" id="8364663">tables</span><span class="op" id="8364669">[</span><span class="ident" id="8364670">name</span><span class="op" id="8364674">]</span><span class="op" id="8364675">;</span>&nbsp;<span class="ident" id="8364677">exist</span>&nbsp;<span class="op" id="8364683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364687">return</span>&nbsp;<span class="ident" id="8364694">fmt</span><span class="op" id="8364697">.</span><span class="ident" id="8364698">Errorf</span><span class="op" id="8364704">(</span><span class="string" id="8364705">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="8364730">,</span>&nbsp;<span class="ident" id="8364732">name</span><span class="op" id="8364736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364742">if</span>&nbsp;<span class="builtinfunc" id="8364745">len</span><span class="op" id="8364748">(</span><span class="ident" id="8364749">columnNames</span><span class="op" id="8364760">)</span>&nbsp;<span class="op" id="8364762">!=</span>&nbsp;<span class="builtinfunc" id="8364765">len</span><span class="op" id="8364768">(</span><span class="ident" id="8364769">columnTypes</span><span class="op" id="8364780">)</span>&nbsp;<span class="op" id="8364782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364786">return</span>&nbsp;<span class="ident" id="8364793">fmt</span><span class="op" id="8364796">.</span><span class="ident" id="8364797">Errorf</span><span class="op" id="8364803">(</span><span class="string" id="8364804">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="8364859">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364864">name</span><span class="op" id="8364868">,</span>&nbsp;<span class="builtinfunc" id="8364870">len</span><span class="op" id="8364873">(</span><span class="ident" id="8364874">columnNames</span><span class="op" id="8364885">)</span><span class="op" id="8364886">,</span>&nbsp;<span class="builtinfunc" id="8364888">len</span><span class="op" id="8364891">(</span><span class="ident" id="8364892">columnTypes</span><span class="op" id="8364903">)</span><span class="op" id="8364904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8364907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8364910">db</span><span class="op" id="8364912">.</span><span class="ident" id="8364913">tables</span><span class="op" id="8364919">[</span><span class="ident" id="8364920">name</span><span class="op" id="8364924">]</span>&nbsp;<span class="op" id="8364926">=</span>&nbsp;<span class="op" id="8364928">&amp;</span><span class="ident" id="8364929">table</span><span class="op" id="8364934">{</span><span class="ident" id="8364935">colname</span><span class="op" id="8364942">:</span>&nbsp;<span class="ident" id="8364944">columnNames</span><span class="op" id="8364955">,</span>&nbsp;<span class="ident" id="8364957">coltype</span><span class="op" id="8364964">:</span>&nbsp;<span class="ident" id="8364966">columnTypes</span><span class="op" id="8364977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8364980">return</span>&nbsp;<span class="ident" id="8364987">nil</span><br>
<span class="lineno"></span><span class="op" id="8364991">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="8364994">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="8365033">func</span>&nbsp;<span class="op" id="8365038">(</span><span class="ident" id="8365039">db</span>&nbsp;<span class="op" id="8365042">*</span><span class="ident" id="8365043">fakeDB</span><span class="op" id="8365049">)</span>&nbsp;<span class="ident" id="8365051">table</span><span class="op" id="8365056">(</span><span class="ident" id="8365057">table</span>&nbsp;<span class="builtintype" id="8365063">string</span><span class="op" id="8365069">)</span>&nbsp;<span class="op" id="8365071">(</span><span class="op" id="8365072">*</span><span class="ident" id="8365073">table</span><span class="op" id="8365078">,</span>&nbsp;<span class="builtintype" id="8365080">bool</span><span class="op" id="8365084">)</span>&nbsp;<span class="op" id="8365086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365089">if</span>&nbsp;<span class="ident" id="8365092">db</span><span class="op" id="8365094">.</span><span class="ident" id="8365095">tables</span>&nbsp;<span class="op" id="8365102">==</span>&nbsp;<span class="ident" id="8365105">nil</span>&nbsp;<span class="op" id="8365109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365113">return</span>&nbsp;<span class="ident" id="8365120">nil</span><span class="op" id="8365123">,</span>&nbsp;<span class="builtintype" id="8365125">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365135">t</span><span class="op" id="8365136">,</span>&nbsp;<span class="ident" id="8365138">ok</span>&nbsp;<span class="op" id="8365141">:=</span>&nbsp;<span class="ident" id="8365144">db</span><span class="op" id="8365146">.</span><span class="ident" id="8365147">tables</span><span class="op" id="8365153">[</span><span class="ident" id="8365154">table</span><span class="op" id="8365159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365162">return</span>&nbsp;<span class="ident" id="8365169">t</span><span class="op" id="8365170">,</span>&nbsp;<span class="ident" id="8365172">ok</span><br>
<span class="lineno"></span><span class="op" id="8365175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="8365178">func</span>&nbsp;<span class="op" id="8365183">(</span><span class="ident" id="8365184">db</span>&nbsp;<span class="op" id="8365187">*</span><span class="ident" id="8365188">fakeDB</span><span class="op" id="8365194">)</span>&nbsp;<span class="ident" id="8365196">columnType</span><span class="op" id="8365206">(</span><span class="ident" id="8365207">table</span><span class="op" id="8365212">,</span>&nbsp;<span class="ident" id="8365214">column</span>&nbsp;<span class="builtintype" id="8365221">string</span><span class="op" id="8365227">)</span>&nbsp;<span class="op" id="8365229">(</span><span class="ident" id="8365230">typ</span>&nbsp;<span class="builtintype" id="8365234">string</span><span class="op" id="8365240">,</span>&nbsp;<span class="ident" id="8365242">ok</span>&nbsp;<span class="builtintype" id="8365245">bool</span><span class="op" id="8365249">)</span>&nbsp;<span class="op" id="8365251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365254">db</span><span class="op" id="8365256">.</span><span class="ident" id="8365257">mu</span><span class="op" id="8365259">.</span><span class="ident" id="8365260">Lock</span><span class="op" id="8365264">(</span><span class="op" id="8365265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365268">defer</span>&nbsp;<span class="ident" id="8365274">db</span><span class="op" id="8365276">.</span><span class="ident" id="8365277">mu</span><span class="op" id="8365279">.</span><span class="ident" id="8365280">Unlock</span><span class="op" id="8365286">(</span><span class="op" id="8365287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365290">t</span><span class="op" id="8365291">,</span>&nbsp;<span class="ident" id="8365293">ok</span>&nbsp;<span class="op" id="8365296">:=</span>&nbsp;<span class="ident" id="8365299">db</span><span class="op" id="8365301">.</span><span class="ident" id="8365302">table</span><span class="op" id="8365307">(</span><span class="ident" id="8365308">table</span><span class="op" id="8365313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365316">if</span>&nbsp;<span class="op" id="8365319">!</span><span class="ident" id="8365320">ok</span>&nbsp;<span class="op" id="8365323">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365327">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365338">for</span>&nbsp;<span class="ident" id="8365342">n</span><span class="op" id="8365343">,</span>&nbsp;<span class="ident" id="8365345">cname</span>&nbsp;<span class="op" id="8365351">:=</span>&nbsp;<span class="keyword" id="8365354">range</span>&nbsp;<span class="ident" id="8365360">t</span><span class="op" id="8365361">.</span><span class="ident" id="8365362">colname</span>&nbsp;<span class="op" id="8365370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365374">if</span>&nbsp;<span class="ident" id="8365377">cname</span>&nbsp;<span class="op" id="8365383">==</span>&nbsp;<span class="ident" id="8365386">column</span>&nbsp;<span class="op" id="8365393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365398">return</span>&nbsp;<span class="ident" id="8365405">t</span><span class="op" id="8365406">.</span><span class="ident" id="8365407">coltype</span><span class="op" id="8365414">[</span><span class="ident" id="8365415">n</span><span class="op" id="8365416">]</span><span class="op" id="8365417">,</span>&nbsp;<span class="builtintype" id="8365419">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365432">return</span>&nbsp;<span class="string" id="8365439">&#34;&#34;</span><span class="op" id="8365441">,</span>&nbsp;<span class="builtintype" id="8365443">false</span><br>
<span class="lineno"></span><span class="op" id="8365449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="8365452">func</span>&nbsp;<span class="op" id="8365457">(</span><span class="ident" id="8365458">c</span>&nbsp;<span class="op" id="8365460">*</span><span class="ident" id="8365461">fakeConn</span><span class="op" id="8365469">)</span>&nbsp;<span class="ident" id="8365471">isBad</span><span class="op" id="8365476">(</span><span class="op" id="8365477">)</span>&nbsp;<span class="builtintype" id="8365479">bool</span>&nbsp;<span class="op" id="8365484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8365487">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365530">if</span>&nbsp;<span class="op" id="8365533">!</span><span class="ident" id="8365534">c</span><span class="op" id="8365535">.</span><span class="ident" id="8365536">bad</span>&nbsp;<span class="op" id="8365540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365544">return</span>&nbsp;<span class="builtintype" id="8365551">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365558">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8365561">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365609">c</span><span class="op" id="8365610">.</span><span class="ident" id="8365611">db</span><span class="op" id="8365613">.</span><span class="ident" id="8365614">badConn</span>&nbsp;<span class="op" id="8365622">=</span>&nbsp;<span class="op" id="8365624">!</span><span class="ident" id="8365625">c</span><span class="op" id="8365626">.</span><span class="ident" id="8365627">db</span><span class="op" id="8365629">.</span><span class="ident" id="8365630">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365639">return</span>&nbsp;<span class="ident" id="8365646">c</span><span class="op" id="8365647">.</span><span class="ident" id="8365648">db</span><span class="op" id="8365650">.</span><span class="ident" id="8365651">badConn</span><br>
<span class="lineno"></span><span class="op" id="8365659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="8365662">func</span>&nbsp;<span class="op" id="8365667">(</span><span class="ident" id="8365668">c</span>&nbsp;<span class="op" id="8365670">*</span><span class="ident" id="8365671">fakeConn</span><span class="op" id="8365679">)</span>&nbsp;<span class="ident" id="8365681">Begin</span><span class="op" id="8365686">(</span><span class="op" id="8365687">)</span>&nbsp;<span class="op" id="8365689">(</span><span class="ident" id="8365690">driver</span><span class="op" id="8365696">.</span><span class="ident" id="8365697">Tx</span><span class="op" id="8365699">,</span>&nbsp;<span class="builtintype" id="8365701">error</span><span class="op" id="8365706">)</span>&nbsp;<span class="op" id="8365708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365711">if</span>&nbsp;<span class="ident" id="8365714">c</span><span class="op" id="8365715">.</span><span class="ident" id="8365716">isBad</span><span class="op" id="8365721">(</span><span class="op" id="8365722">)</span>&nbsp;<span class="op" id="8365724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365728">return</span>&nbsp;<span class="ident" id="8365735">nil</span><span class="op" id="8365738">,</span>&nbsp;<span class="ident" id="8365740">driver</span><span class="op" id="8365746">.</span><span class="ident" id="8365747">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365762">if</span>&nbsp;<span class="ident" id="8365765">c</span><span class="op" id="8365766">.</span><span class="ident" id="8365767">currTx</span>&nbsp;<span class="op" id="8365774">!=</span>&nbsp;<span class="ident" id="8365777">nil</span>&nbsp;<span class="op" id="8365781">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365785">return</span>&nbsp;<span class="ident" id="8365792">nil</span><span class="op" id="8365795">,</span>&nbsp;<span class="ident" id="8365797">errors</span><span class="op" id="8365803">.</span><span class="ident" id="8365804">New</span><span class="op" id="8365807">(</span><span class="string" id="8365808">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="8365834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8365837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365840">c</span><span class="op" id="8365841">.</span><span class="ident" id="8365842">currTx</span>&nbsp;<span class="op" id="8365849">=</span>&nbsp;<span class="op" id="8365851">&amp;</span><span class="ident" id="8365852">fakeTx</span><span class="op" id="8365858">{</span><span class="ident" id="8365859">c</span><span class="op" id="8365860">:</span>&nbsp;<span class="ident" id="8365862">c</span><span class="op" id="8365863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8365866">return</span>&nbsp;<span class="ident" id="8365873">c</span><span class="op" id="8365874">.</span><span class="ident" id="8365875">currTx</span><span class="op" id="8365881">,</span>&nbsp;<span class="ident" id="8365883">nil</span><br>
<span class="lineno"></span><span class="op" id="8365887">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8365890">var</span>&nbsp;<span class="ident" id="8365894">hookPostCloseConn</span>&nbsp;<span class="keyword" id="8365912">struct</span>&nbsp;<span class="op" id="8365919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365922">sync</span><span class="op" id="8365926">.</span><span class="ident" id="8365927">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8365934">fn</span>&nbsp;<span class="keyword" id="8365937">func</span><span class="op" id="8365941">(</span><span class="op" id="8365942">*</span><span class="ident" id="8365943">fakeConn</span><span class="op" id="8365951">,</span>&nbsp;<span class="builtintype" id="8365953">error</span><span class="op" id="8365958">)</span><br>
<span class="lineno"></span><span class="op" id="8365960">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="8365963">func</span>&nbsp;<span class="ident" id="8365968">setHookpostCloseConn</span><span class="op" id="8365988">(</span><span class="ident" id="8365989">fn</span>&nbsp;<span class="keyword" id="8365992">func</span><span class="op" id="8365996">(</span><span class="op" id="8365997">*</span><span class="ident" id="8365998">fakeConn</span><span class="op" id="8366006">,</span>&nbsp;<span class="builtintype" id="8366008">error</span><span class="op" id="8366013">)</span><span class="op" id="8366014">)</span>&nbsp;<span class="op" id="8366016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366019">hookPostCloseConn</span><span class="op" id="8366036">.</span><span class="ident" id="8366037">Lock</span><span class="op" id="8366041">(</span><span class="op" id="8366042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366045">defer</span>&nbsp;<span class="ident" id="8366051">hookPostCloseConn</span><span class="op" id="8366068">.</span><span class="ident" id="8366069">Unlock</span><span class="op" id="8366075">(</span><span class="op" id="8366076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366079">hookPostCloseConn</span><span class="op" id="8366096">.</span><span class="ident" id="8366097">fn</span>&nbsp;<span class="op" id="8366100">=</span>&nbsp;<span class="ident" id="8366102">fn</span><br>
<span class="lineno">275</span><span class="op" id="8366105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8366108">var</span>&nbsp;<span class="ident" id="8366112">testStrictClose</span>&nbsp;<span class="op" id="8366128">*</span><span class="ident" id="8366129">testing</span><span class="op" id="8366136">.</span><span class="ident" id="8366137">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8366140">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="8366210">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="8366260">func</span>&nbsp;<span class="ident" id="8366265">setStrictFakeConnClose</span><span class="op" id="8366287">(</span><span class="ident" id="8366288">t</span>&nbsp;<span class="op" id="8366290">*</span><span class="ident" id="8366291">testing</span><span class="op" id="8366298">.</span><span class="ident" id="8366299">T</span><span class="op" id="8366300">)</span>&nbsp;<span class="op" id="8366302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366305">testStrictClose</span>&nbsp;<span class="op" id="8366321">=</span>&nbsp;<span class="ident" id="8366323">t</span><br>
<span class="lineno"></span><span class="op" id="8366325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="8366328">func</span>&nbsp;<span class="op" id="8366333">(</span><span class="ident" id="8366334">c</span>&nbsp;<span class="op" id="8366336">*</span><span class="ident" id="8366337">fakeConn</span><span class="op" id="8366345">)</span>&nbsp;<span class="ident" id="8366347">Close</span><span class="op" id="8366352">(</span><span class="op" id="8366353">)</span>&nbsp;<span class="op" id="8366355">(</span><span class="ident" id="8366356">err</span>&nbsp;<span class="builtintype" id="8366360">error</span><span class="op" id="8366365">)</span>&nbsp;<span class="op" id="8366367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366370">drv</span>&nbsp;<span class="op" id="8366374">:=</span>&nbsp;<span class="ident" id="8366377">fdriver</span><span class="op" id="8366384">.</span><span class="op" id="8366385">(</span><span class="op" id="8366386">*</span><span class="ident" id="8366387">fakeDriver</span><span class="op" id="8366397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366400">defer</span>&nbsp;<span class="keyword" id="8366406">func</span><span class="op" id="8366410">(</span><span class="op" id="8366411">)</span>&nbsp;<span class="op" id="8366413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366417">if</span>&nbsp;<span class="ident" id="8366420">err</span>&nbsp;<span class="op" id="8366424">!=</span>&nbsp;<span class="ident" id="8366427">nil</span>&nbsp;<span class="op" id="8366431">&amp;&amp;</span>&nbsp;<span class="ident" id="8366434">testStrictClose</span>&nbsp;<span class="op" id="8366450">!=</span>&nbsp;<span class="ident" id="8366453">nil</span>&nbsp;<span class="op" id="8366457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366462">testStrictClose</span><span class="op" id="8366477">.</span><span class="ident" id="8366478">Errorf</span><span class="op" id="8366484">(</span><span class="string" id="8366485">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8366522">,</span>&nbsp;<span class="ident" id="8366524">err</span><span class="op" id="8366527">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366535">hookPostCloseConn</span><span class="op" id="8366552">.</span><span class="ident" id="8366553">Lock</span><span class="op" id="8366557">(</span><span class="op" id="8366558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366562">fn</span>&nbsp;<span class="op" id="8366565">:=</span>&nbsp;<span class="ident" id="8366568">hookPostCloseConn</span><span class="op" id="8366585">.</span><span class="ident" id="8366586">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366591">hookPostCloseConn</span><span class="op" id="8366608">.</span><span class="ident" id="8366609">Unlock</span><span class="op" id="8366615">(</span><span class="op" id="8366616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366620">if</span>&nbsp;<span class="ident" id="8366623">fn</span>&nbsp;<span class="op" id="8366626">!=</span>&nbsp;<span class="ident" id="8366629">nil</span>&nbsp;<span class="op" id="8366633">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366638">fn</span><span class="op" id="8366640">(</span><span class="ident" id="8366641">c</span><span class="op" id="8366642">,</span>&nbsp;<span class="ident" id="8366644">err</span><span class="op" id="8366647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366655">if</span>&nbsp;<span class="ident" id="8366658">err</span>&nbsp;<span class="op" id="8366662">==</span>&nbsp;<span class="ident" id="8366665">nil</span>&nbsp;<span class="op" id="8366669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366674">drv</span><span class="op" id="8366677">.</span><span class="ident" id="8366678">mu</span><span class="op" id="8366680">.</span><span class="ident" id="8366681">Lock</span><span class="op" id="8366685">(</span><span class="op" id="8366686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366691">drv</span><span class="op" id="8366694">.</span><span class="ident" id="8366695">closeCount</span><span class="op" id="8366705">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8366711">drv</span><span class="op" id="8366714">.</span><span class="ident" id="8366715">mu</span><span class="op" id="8366717">.</span><span class="ident" id="8366718">Unlock</span><span class="op" id="8366724">(</span><span class="op" id="8366725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366732">}</span><span class="op" id="8366733">(</span><span class="op" id="8366734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366737">if</span>&nbsp;<span class="ident" id="8366740">c</span><span class="op" id="8366741">.</span><span class="ident" id="8366742">currTx</span>&nbsp;<span class="op" id="8366749">!=</span>&nbsp;<span class="ident" id="8366752">nil</span>&nbsp;<span class="op" id="8366756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366760">return</span>&nbsp;<span class="ident" id="8366767">errors</span><span class="op" id="8366773">.</span><span class="ident" id="8366774">New</span><span class="op" id="8366777">(</span><span class="string" id="8366778">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="8366818">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366824">if</span>&nbsp;<span class="ident" id="8366827">c</span><span class="op" id="8366828">.</span><span class="ident" id="8366829">db</span>&nbsp;<span class="op" id="8366832">==</span>&nbsp;<span class="ident" id="8366835">nil</span>&nbsp;<span class="op" id="8366839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366843">return</span>&nbsp;<span class="ident" id="8366850">errors</span><span class="op" id="8366856">.</span><span class="ident" id="8366857">New</span><span class="op" id="8366860">(</span><span class="string" id="8366861">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="8366899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366905">if</span>&nbsp;<span class="ident" id="8366908">c</span><span class="op" id="8366909">.</span><span class="ident" id="8366910">stmtsMade</span>&nbsp;<span class="op" id="8366920">&gt;</span>&nbsp;<span class="ident" id="8366922">c</span><span class="op" id="8366923">.</span><span class="ident" id="8366924">stmtsClosed</span>&nbsp;<span class="op" id="8366936">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8366940">return</span>&nbsp;<span class="ident" id="8366947">errors</span><span class="op" id="8366953">.</span><span class="ident" id="8366954">New</span><span class="op" id="8366957">(</span><span class="string" id="8366958">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="8366994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8366997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367000">c</span><span class="op" id="8367001">.</span><span class="ident" id="8367002">db</span>&nbsp;<span class="op" id="8367005">=</span>&nbsp;<span class="ident" id="8367007">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367012">return</span>&nbsp;<span class="ident" id="8367019">nil</span><br>
<span class="lineno"></span><span class="op" id="8367023">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8367026">func</span>&nbsp;<span class="ident" id="8367031">checkSubsetTypes</span><span class="op" id="8367047">(</span><span class="ident" id="8367048">args</span>&nbsp;<span class="op" id="8367053">[</span><span class="op" id="8367054">]</span><span class="ident" id="8367055">driver</span><span class="op" id="8367061">.</span><span class="ident" id="8367062">Value</span><span class="op" id="8367067">)</span>&nbsp;<span class="builtintype" id="8367069">error</span>&nbsp;<span class="op" id="8367075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367078">for</span>&nbsp;<span class="ident" id="8367082">n</span><span class="op" id="8367083">,</span>&nbsp;<span class="ident" id="8367085">arg</span>&nbsp;<span class="op" id="8367089">:=</span>&nbsp;<span class="keyword" id="8367092">range</span>&nbsp;<span class="ident" id="8367098">args</span>&nbsp;<span class="op" id="8367103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367107">switch</span>&nbsp;<span class="ident" id="8367114">arg</span><span class="op" id="8367117">.</span><span class="op" id="8367118">(</span><span class="keyword" id="8367119">type</span><span class="op" id="8367123">)</span>&nbsp;<span class="op" id="8367125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367129">case</span>&nbsp;<span class="ident" id="8367134">int64</span><span class="op" id="8367139">,</span>&nbsp;<span class="builtintype" id="8367141">float64</span><span class="op" id="8367148">,</span>&nbsp;<span class="builtintype" id="8367150">bool</span><span class="op" id="8367154">,</span>&nbsp;<span class="ident" id="8367156">nil</span><span class="op" id="8367159">,</span>&nbsp;<span class="op" id="8367161">[</span><span class="op" id="8367162">]</span><span class="builtintype" id="8367163">byte</span><span class="op" id="8367167">,</span>&nbsp;<span class="builtintype" id="8367169">string</span><span class="op" id="8367175">,</span>&nbsp;<span class="ident" id="8367177">time</span><span class="op" id="8367181">.</span><span class="ident" id="8367182">Time</span><span class="op" id="8367186">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367190">default</span><span class="op" id="8367197">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367202">return</span>&nbsp;<span class="ident" id="8367209">fmt</span><span class="op" id="8367212">.</span><span class="ident" id="8367213">Errorf</span><span class="op" id="8367219">(</span><span class="string" id="8367220">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="8367268">,</span>&nbsp;<span class="ident" id="8367270">n</span><span class="op" id="8367271">+</span><span class="num" id="8367272">1</span><span class="op" id="8367273">,</span>&nbsp;<span class="ident" id="8367275">arg</span><span class="op" id="8367278">,</span>&nbsp;<span class="ident" id="8367280">arg</span><span class="op" id="8367283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367293">return</span>&nbsp;<span class="ident" id="8367300">nil</span><br>
<span class="lineno">325</span><span class="op" id="8367304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8367307">func</span>&nbsp;<span class="op" id="8367312">(</span><span class="ident" id="8367313">c</span>&nbsp;<span class="op" id="8367315">*</span><span class="ident" id="8367316">fakeConn</span><span class="op" id="8367324">)</span>&nbsp;<span class="ident" id="8367326">Exec</span><span class="op" id="8367330">(</span><span class="ident" id="8367331">query</span>&nbsp;<span class="builtintype" id="8367337">string</span><span class="op" id="8367343">,</span>&nbsp;<span class="ident" id="8367345">args</span>&nbsp;<span class="op" id="8367350">[</span><span class="op" id="8367351">]</span><span class="ident" id="8367352">driver</span><span class="op" id="8367358">.</span><span class="ident" id="8367359">Value</span><span class="op" id="8367364">)</span>&nbsp;<span class="op" id="8367366">(</span><span class="ident" id="8367367">driver</span><span class="op" id="8367373">.</span><span class="ident" id="8367374">Result</span><span class="op" id="8367380">,</span>&nbsp;<span class="builtintype" id="8367382">error</span><span class="op" id="8367387">)</span>&nbsp;<span class="op" id="8367389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367392">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367453">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367514">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367573">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367600">err</span>&nbsp;<span class="op" id="8367604">:=</span>&nbsp;<span class="ident" id="8367607">checkSubsetTypes</span><span class="op" id="8367623">(</span><span class="ident" id="8367624">args</span><span class="op" id="8367628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367631">if</span>&nbsp;<span class="ident" id="8367634">err</span>&nbsp;<span class="op" id="8367638">!=</span>&nbsp;<span class="ident" id="8367641">nil</span>&nbsp;<span class="op" id="8367645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367649">return</span>&nbsp;<span class="ident" id="8367656">nil</span><span class="op" id="8367659">,</span>&nbsp;<span class="ident" id="8367661">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8367666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8367669">return</span>&nbsp;<span class="ident" id="8367676">nil</span><span class="op" id="8367679">,</span>&nbsp;<span class="ident" id="8367681">driver</span><span class="op" id="8367687">.</span><span class="ident" id="8367688">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="8367696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8367699">func</span>&nbsp;<span class="op" id="8367704">(</span><span class="ident" id="8367705">c</span>&nbsp;<span class="op" id="8367707">*</span><span class="ident" id="8367708">fakeConn</span><span class="op" id="8367716">)</span>&nbsp;<span class="ident" id="8367718">Query</span><span class="op" id="8367723">(</span><span class="ident" id="8367724">query</span>&nbsp;<span class="builtintype" id="8367730">string</span><span class="op" id="8367736">,</span>&nbsp;<span class="ident" id="8367738">args</span>&nbsp;<span class="op" id="8367743">[</span><span class="op" id="8367744">]</span><span class="ident" id="8367745">driver</span><span class="op" id="8367751">.</span><span class="ident" id="8367752">Value</span><span class="op" id="8367757">)</span>&nbsp;<span class="op" id="8367759">(</span><span class="ident" id="8367760">driver</span><span class="op" id="8367766">.</span><span class="ident" id="8367767">Rows</span><span class="op" id="8367771">,</span>&nbsp;<span class="builtintype" id="8367773">error</span><span class="op" id="8367778">)</span>&nbsp;<span class="op" id="8367780">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367783">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367844">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367905">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8367964">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8367991">err</span>&nbsp;<span class="op" id="8367995">:=</span>&nbsp;<span class="ident" id="8367998">checkSubsetTypes</span><span class="op" id="8368014">(</span><span class="ident" id="8368015">args</span><span class="op" id="8368019">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368022">if</span>&nbsp;<span class="ident" id="8368025">err</span>&nbsp;<span class="op" id="8368029">!=</span>&nbsp;<span class="ident" id="8368032">nil</span>&nbsp;<span class="op" id="8368036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368040">return</span>&nbsp;<span class="ident" id="8368047">nil</span><span class="op" id="8368050">,</span>&nbsp;<span class="ident" id="8368052">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8368057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368060">return</span>&nbsp;<span class="ident" id="8368067">nil</span><span class="op" id="8368070">,</span>&nbsp;<span class="ident" id="8368072">driver</span><span class="op" id="8368078">.</span><span class="ident" id="8368079">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="8368087">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="8368090">func</span>&nbsp;<span class="ident" id="8368095">errf</span><span class="op" id="8368099">(</span><span class="ident" id="8368100">msg</span>&nbsp;<span class="builtintype" id="8368104">string</span><span class="op" id="8368110">,</span>&nbsp;<span class="ident" id="8368112">args</span>&nbsp;<span class="op" id="8368117">...</span><span class="keyword" id="8368120">interface</span><span class="op" id="8368129">{</span><span class="op" id="8368130">}</span><span class="op" id="8368131">)</span>&nbsp;<span class="builtintype" id="8368133">error</span>&nbsp;<span class="op" id="8368139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368142">return</span>&nbsp;<span class="ident" id="8368149">errors</span><span class="op" id="8368155">.</span><span class="ident" id="8368156">New</span><span class="op" id="8368159">(</span><span class="string" id="8368160">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="8368171">+</span>&nbsp;<span class="ident" id="8368173">fmt</span><span class="op" id="8368176">.</span><span class="ident" id="8368177">Sprintf</span><span class="op" id="8368184">(</span><span class="ident" id="8368185">msg</span><span class="op" id="8368188">,</span>&nbsp;<span class="ident" id="8368190">args</span><span class="op" id="8368194">...</span><span class="op" id="8368197">)</span><span class="op" id="8368198">)</span><br>
<span class="lineno"></span><span class="op" id="8368200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="8368203">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="8368267">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="8368324">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="8368358">func</span>&nbsp;<span class="op" id="8368363">(</span><span class="ident" id="8368364">c</span>&nbsp;<span class="op" id="8368366">*</span><span class="ident" id="8368367">fakeConn</span><span class="op" id="8368375">)</span>&nbsp;<span class="ident" id="8368377">prepareSelect</span><span class="op" id="8368390">(</span><span class="ident" id="8368391">stmt</span>&nbsp;<span class="op" id="8368396">*</span><span class="ident" id="8368397">fakeStmt</span><span class="op" id="8368405">,</span>&nbsp;<span class="ident" id="8368407">parts</span>&nbsp;<span class="op" id="8368413">[</span><span class="op" id="8368414">]</span><span class="builtintype" id="8368415">string</span><span class="op" id="8368421">)</span>&nbsp;<span class="op" id="8368423">(</span><span class="ident" id="8368424">driver</span><span class="op" id="8368430">.</span><span class="ident" id="8368431">Stmt</span><span class="op" id="8368435">,</span>&nbsp;<span class="builtintype" id="8368437">error</span><span class="op" id="8368442">)</span>&nbsp;<span class="op" id="8368444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368447">if</span>&nbsp;<span class="builtinfunc" id="8368450">len</span><span class="op" id="8368453">(</span><span class="ident" id="8368454">parts</span><span class="op" id="8368459">)</span>&nbsp;<span class="op" id="8368461">!=</span>&nbsp;<span class="num" id="8368464">3</span>&nbsp;<span class="op" id="8368466">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368470">stmt</span><span class="op" id="8368474">.</span><span class="ident" id="8368475">Close</span><span class="op" id="8368480">(</span><span class="op" id="8368481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368485">return</span>&nbsp;<span class="ident" id="8368492">nil</span><span class="op" id="8368495">,</span>&nbsp;<span class="ident" id="8368497">errf</span><span class="op" id="8368501">(</span><span class="string" id="8368502">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="8368547">,</span>&nbsp;<span class="builtinfunc" id="8368549">len</span><span class="op" id="8368552">(</span><span class="ident" id="8368553">parts</span><span class="op" id="8368558">)</span><span class="op" id="8368559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8368562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368565">stmt</span><span class="op" id="8368569">.</span><span class="ident" id="8368570">table</span>&nbsp;<span class="op" id="8368576">=</span>&nbsp;<span class="ident" id="8368578">parts</span><span class="op" id="8368583">[</span><span class="num" id="8368584">0</span><span class="op" id="8368585">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368588">stmt</span><span class="op" id="8368592">.</span><span class="ident" id="8368593">colName</span>&nbsp;<span class="op" id="8368601">=</span>&nbsp;<span class="ident" id="8368603">strings</span><span class="op" id="8368610">.</span><span class="ident" id="8368611">Split</span><span class="op" id="8368616">(</span><span class="ident" id="8368617">parts</span><span class="op" id="8368622">[</span><span class="num" id="8368623">1</span><span class="op" id="8368624">]</span><span class="op" id="8368625">,</span>&nbsp;<span class="string" id="8368627">&#34;,&#34;</span><span class="op" id="8368630">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368633">for</span>&nbsp;<span class="ident" id="8368637">n</span><span class="op" id="8368638">,</span>&nbsp;<span class="ident" id="8368640">colspec</span>&nbsp;<span class="op" id="8368648">:=</span>&nbsp;<span class="keyword" id="8368651">range</span>&nbsp;<span class="ident" id="8368657">strings</span><span class="op" id="8368664">.</span><span class="ident" id="8368665">Split</span><span class="op" id="8368670">(</span><span class="ident" id="8368671">parts</span><span class="op" id="8368676">[</span><span class="num" id="8368677">2</span><span class="op" id="8368678">]</span><span class="op" id="8368679">,</span>&nbsp;<span class="string" id="8368681">&#34;,&#34;</span><span class="op" id="8368684">)</span>&nbsp;<span class="op" id="8368686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368690">if</span>&nbsp;<span class="ident" id="8368693">colspec</span>&nbsp;<span class="op" id="8368701">==</span>&nbsp;<span class="string" id="8368704">&#34;&#34;</span>&nbsp;<span class="op" id="8368707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368712">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8368723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368727">nameVal</span>&nbsp;<span class="op" id="8368735">:=</span>&nbsp;<span class="ident" id="8368738">strings</span><span class="op" id="8368745">.</span><span class="ident" id="8368746">Split</span><span class="op" id="8368751">(</span><span class="ident" id="8368752">colspec</span><span class="op" id="8368759">,</span>&nbsp;<span class="string" id="8368761">&#34;=&#34;</span><span class="op" id="8368764">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368768">if</span>&nbsp;<span class="builtinfunc" id="8368771">len</span><span class="op" id="8368774">(</span><span class="ident" id="8368775">nameVal</span><span class="op" id="8368782">)</span>&nbsp;<span class="op" id="8368784">!=</span>&nbsp;<span class="num" id="8368787">2</span>&nbsp;<span class="op" id="8368789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368794">stmt</span><span class="op" id="8368798">.</span><span class="ident" id="8368799">Close</span><span class="op" id="8368804">(</span><span class="op" id="8368805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8368810">return</span>&nbsp;<span class="ident" id="8368817">nil</span><span class="op" id="8368820">,</span>&nbsp;<span class="ident" id="8368822">errf</span><span class="op" id="8368826">(</span><span class="string" id="8368827">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8368888">,</span>&nbsp;<span class="ident" id="8368890">stmt</span><span class="op" id="8368894">.</span><span class="ident" id="8368895">table</span><span class="op" id="8368900">,</span>&nbsp;<span class="ident" id="8368902">colspec</span><span class="op" id="8368909">,</span>&nbsp;<span class="ident" id="8368911">n</span><span class="op" id="8368912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8368916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368920">column</span><span class="op" id="8368926">,</span>&nbsp;<span class="ident" id="8368928">value</span>&nbsp;<span class="op" id="8368934">:=</span>&nbsp;<span class="ident" id="8368937">nameVal</span><span class="op" id="8368944">[</span><span class="num" id="8368945">0</span><span class="op" id="8368946">]</span><span class="op" id="8368947">,</span>&nbsp;<span class="ident" id="8368949">nameVal</span><span class="op" id="8368956">[</span><span class="num" id="8368957">1</span><span class="op" id="8368958">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8368962">_</span><span class="op" id="8368963">,</span>&nbsp;<span class="ident" id="8368965">ok</span>&nbsp;<span class="op" id="8368968">:=</span>&nbsp;<span class="ident" id="8368971">c</span><span class="op" id="8368972">.</span><span class="ident" id="8368973">db</span><span class="op" id="8368975">.</span><span class="ident" id="8368976">columnType</span><span class="op" id="8368986">(</span><span class="ident" id="8368987">stmt</span><span class="op" id="8368991">.</span><span class="ident" id="8368992">table</span><span class="op" id="8368997">,</span>&nbsp;<span class="ident" id="8368999">column</span><span class="op" id="8369005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369009">if</span>&nbsp;<span class="op" id="8369012">!</span><span class="ident" id="8369013">ok</span>&nbsp;<span class="op" id="8369016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369021">stmt</span><span class="op" id="8369025">.</span><span class="ident" id="8369026">Close</span><span class="op" id="8369031">(</span><span class="op" id="8369032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369037">return</span>&nbsp;<span class="ident" id="8369044">nil</span><span class="op" id="8369047">,</span>&nbsp;<span class="ident" id="8369049">errf</span><span class="op" id="8369053">(</span><span class="string" id="8369054">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8369108">,</span>&nbsp;<span class="ident" id="8369110">stmt</span><span class="op" id="8369114">.</span><span class="ident" id="8369115">table</span><span class="op" id="8369120">,</span>&nbsp;<span class="ident" id="8369122">column</span><span class="op" id="8369128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8369132">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369136">if</span>&nbsp;<span class="ident" id="8369139">value</span>&nbsp;<span class="op" id="8369145">!=</span>&nbsp;<span class="string" id="8369148">&#34;?&#34;</span>&nbsp;<span class="op" id="8369152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369157">stmt</span><span class="op" id="8369161">.</span><span class="ident" id="8369162">Close</span><span class="op" id="8369167">(</span><span class="op" id="8369168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369173">return</span>&nbsp;<span class="ident" id="8369180">nil</span><span class="op" id="8369183">,</span>&nbsp;<span class="ident" id="8369185">errf</span><span class="op" id="8369189">(</span><span class="string" id="8369190">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="8369272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369278">stmt</span><span class="op" id="8369282">.</span><span class="ident" id="8369283">table</span><span class="op" id="8369288">,</span>&nbsp;<span class="ident" id="8369290">column</span><span class="op" id="8369296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8369300">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369304">stmt</span><span class="op" id="8369308">.</span><span class="ident" id="8369309">whereCol</span>&nbsp;<span class="op" id="8369318">=</span>&nbsp;<span class="builtinfunc" id="8369320">append</span><span class="op" id="8369326">(</span><span class="ident" id="8369327">stmt</span><span class="op" id="8369331">.</span><span class="ident" id="8369332">whereCol</span><span class="op" id="8369340">,</span>&nbsp;<span class="ident" id="8369342">column</span><span class="op" id="8369348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369352">stmt</span><span class="op" id="8369356">.</span><span class="ident" id="8369357">placeholders</span><span class="op" id="8369369">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8369373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369376">return</span>&nbsp;<span class="ident" id="8369383">stmt</span><span class="op" id="8369387">,</span>&nbsp;<span class="ident" id="8369389">nil</span><br>
<span class="lineno"></span><span class="op" id="8369393">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="8369396">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="8369435">func</span>&nbsp;<span class="op" id="8369440">(</span><span class="ident" id="8369441">c</span>&nbsp;<span class="op" id="8369443">*</span><span class="ident" id="8369444">fakeConn</span><span class="op" id="8369452">)</span>&nbsp;<span class="ident" id="8369454">prepareCreate</span><span class="op" id="8369467">(</span><span class="ident" id="8369468">stmt</span>&nbsp;<span class="op" id="8369473">*</span><span class="ident" id="8369474">fakeStmt</span><span class="op" id="8369482">,</span>&nbsp;<span class="ident" id="8369484">parts</span>&nbsp;<span class="op" id="8369490">[</span><span class="op" id="8369491">]</span><span class="builtintype" id="8369492">string</span><span class="op" id="8369498">)</span>&nbsp;<span class="op" id="8369500">(</span><span class="ident" id="8369501">driver</span><span class="op" id="8369507">.</span><span class="ident" id="8369508">Stmt</span><span class="op" id="8369512">,</span>&nbsp;<span class="builtintype" id="8369514">error</span><span class="op" id="8369519">)</span>&nbsp;<span class="op" id="8369521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369524">if</span>&nbsp;<span class="builtinfunc" id="8369527">len</span><span class="op" id="8369530">(</span><span class="ident" id="8369531">parts</span><span class="op" id="8369536">)</span>&nbsp;<span class="op" id="8369538">!=</span>&nbsp;<span class="num" id="8369541">2</span>&nbsp;<span class="op" id="8369543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369547">stmt</span><span class="op" id="8369551">.</span><span class="ident" id="8369552">Close</span><span class="op" id="8369557">(</span><span class="op" id="8369558">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369562">return</span>&nbsp;<span class="ident" id="8369569">nil</span><span class="op" id="8369572">,</span>&nbsp;<span class="ident" id="8369574">errf</span><span class="op" id="8369578">(</span><span class="string" id="8369579">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="8369624">,</span>&nbsp;<span class="builtinfunc" id="8369626">len</span><span class="op" id="8369629">(</span><span class="ident" id="8369630">parts</span><span class="op" id="8369635">)</span><span class="op" id="8369636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8369639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369642">stmt</span><span class="op" id="8369646">.</span><span class="ident" id="8369647">table</span>&nbsp;<span class="op" id="8369653">=</span>&nbsp;<span class="ident" id="8369655">parts</span><span class="op" id="8369660">[</span><span class="num" id="8369661">0</span><span class="op" id="8369662">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369665">for</span>&nbsp;<span class="ident" id="8369669">n</span><span class="op" id="8369670">,</span>&nbsp;<span class="ident" id="8369672">colspec</span>&nbsp;<span class="op" id="8369680">:=</span>&nbsp;<span class="keyword" id="8369683">range</span>&nbsp;<span class="ident" id="8369689">strings</span><span class="op" id="8369696">.</span><span class="ident" id="8369697">Split</span><span class="op" id="8369702">(</span><span class="ident" id="8369703">parts</span><span class="op" id="8369708">[</span><span class="num" id="8369709">1</span><span class="op" id="8369710">]</span><span class="op" id="8369711">,</span>&nbsp;<span class="string" id="8369713">&#34;,&#34;</span><span class="op" id="8369716">)</span>&nbsp;<span class="op" id="8369718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369722">nameType</span>&nbsp;<span class="op" id="8369731">:=</span>&nbsp;<span class="ident" id="8369734">strings</span><span class="op" id="8369741">.</span><span class="ident" id="8369742">Split</span><span class="op" id="8369747">(</span><span class="ident" id="8369748">colspec</span><span class="op" id="8369755">,</span>&nbsp;<span class="string" id="8369757">&#34;=&#34;</span><span class="op" id="8369760">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369764">if</span>&nbsp;<span class="builtinfunc" id="8369767">len</span><span class="op" id="8369770">(</span><span class="ident" id="8369771">nameType</span><span class="op" id="8369779">)</span>&nbsp;<span class="op" id="8369781">!=</span>&nbsp;<span class="num" id="8369784">2</span>&nbsp;<span class="op" id="8369786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369791">stmt</span><span class="op" id="8369795">.</span><span class="ident" id="8369796">Close</span><span class="op" id="8369801">(</span><span class="op" id="8369802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8369807">return</span>&nbsp;<span class="ident" id="8369814">nil</span><span class="op" id="8369817">,</span>&nbsp;<span class="ident" id="8369819">errf</span><span class="op" id="8369823">(</span><span class="string" id="8369824">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8369882">,</span>&nbsp;<span class="ident" id="8369884">stmt</span><span class="op" id="8369888">.</span><span class="ident" id="8369889">table</span><span class="op" id="8369894">,</span>&nbsp;<span class="ident" id="8369896">colspec</span><span class="op" id="8369903">,</span>&nbsp;<span class="ident" id="8369905">n</span><span class="op" id="8369906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8369910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369914">stmt</span><span class="op" id="8369918">.</span><span class="ident" id="8369919">colName</span>&nbsp;<span class="op" id="8369927">=</span>&nbsp;<span class="builtinfunc" id="8369929">append</span><span class="op" id="8369935">(</span><span class="ident" id="8369936">stmt</span><span class="op" id="8369940">.</span><span class="ident" id="8369941">colName</span><span class="op" id="8369948">,</span>&nbsp;<span class="ident" id="8369950">nameType</span><span class="op" id="8369958">[</span><span class="num" id="8369959">0</span><span class="op" id="8369960">]</span><span class="op" id="8369961">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8369965">stmt</span><span class="op" id="8369969">.</span><span class="ident" id="8369970">colType</span>&nbsp;<span class="op" id="8369978">=</span>&nbsp;<span class="builtinfunc" id="8369980">append</span><span class="op" id="8369986">(</span><span class="ident" id="8369987">stmt</span><span class="op" id="8369991">.</span><span class="ident" id="8369992">colType</span><span class="op" id="8369999">,</span>&nbsp;<span class="ident" id="8370001">nameType</span><span class="op" id="8370009">[</span><span class="num" id="8370010">1</span><span class="op" id="8370011">]</span><span class="op" id="8370012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8370015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370018">return</span>&nbsp;<span class="ident" id="8370025">stmt</span><span class="op" id="8370029">,</span>&nbsp;<span class="ident" id="8370031">nil</span><br>
<span class="lineno"></span><span class="op" id="8370035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="8370038">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="8370072">func</span>&nbsp;<span class="op" id="8370077">(</span><span class="ident" id="8370078">c</span>&nbsp;<span class="op" id="8370080">*</span><span class="ident" id="8370081">fakeConn</span><span class="op" id="8370089">)</span>&nbsp;<span class="ident" id="8370091">prepareInsert</span><span class="op" id="8370104">(</span><span class="ident" id="8370105">stmt</span>&nbsp;<span class="op" id="8370110">*</span><span class="ident" id="8370111">fakeStmt</span><span class="op" id="8370119">,</span>&nbsp;<span class="ident" id="8370121">parts</span>&nbsp;<span class="op" id="8370127">[</span><span class="op" id="8370128">]</span><span class="builtintype" id="8370129">string</span><span class="op" id="8370135">)</span>&nbsp;<span class="op" id="8370137">(</span><span class="ident" id="8370138">driver</span><span class="op" id="8370144">.</span><span class="ident" id="8370145">Stmt</span><span class="op" id="8370149">,</span>&nbsp;<span class="builtintype" id="8370151">error</span><span class="op" id="8370156">)</span>&nbsp;<span class="op" id="8370158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370161">if</span>&nbsp;<span class="builtinfunc" id="8370164">len</span><span class="op" id="8370167">(</span><span class="ident" id="8370168">parts</span><span class="op" id="8370173">)</span>&nbsp;<span class="op" id="8370175">!=</span>&nbsp;<span class="num" id="8370178">2</span>&nbsp;<span class="op" id="8370180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370184">stmt</span><span class="op" id="8370188">.</span><span class="ident" id="8370189">Close</span><span class="op" id="8370194">(</span><span class="op" id="8370195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370199">return</span>&nbsp;<span class="ident" id="8370206">nil</span><span class="op" id="8370209">,</span>&nbsp;<span class="ident" id="8370211">errf</span><span class="op" id="8370215">(</span><span class="string" id="8370216">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="8370261">,</span>&nbsp;<span class="builtinfunc" id="8370263">len</span><span class="op" id="8370266">(</span><span class="ident" id="8370267">parts</span><span class="op" id="8370272">)</span><span class="op" id="8370273">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8370276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370279">stmt</span><span class="op" id="8370283">.</span><span class="ident" id="8370284">table</span>&nbsp;<span class="op" id="8370290">=</span>&nbsp;<span class="ident" id="8370292">parts</span><span class="op" id="8370297">[</span><span class="num" id="8370298">0</span><span class="op" id="8370299">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370302">for</span>&nbsp;<span class="ident" id="8370306">n</span><span class="op" id="8370307">,</span>&nbsp;<span class="ident" id="8370309">colspec</span>&nbsp;<span class="op" id="8370317">:=</span>&nbsp;<span class="keyword" id="8370320">range</span>&nbsp;<span class="ident" id="8370326">strings</span><span class="op" id="8370333">.</span><span class="ident" id="8370334">Split</span><span class="op" id="8370339">(</span><span class="ident" id="8370340">parts</span><span class="op" id="8370345">[</span><span class="num" id="8370346">1</span><span class="op" id="8370347">]</span><span class="op" id="8370348">,</span>&nbsp;<span class="string" id="8370350">&#34;,&#34;</span><span class="op" id="8370353">)</span>&nbsp;<span class="op" id="8370355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370359">nameVal</span>&nbsp;<span class="op" id="8370367">:=</span>&nbsp;<span class="ident" id="8370370">strings</span><span class="op" id="8370377">.</span><span class="ident" id="8370378">Split</span><span class="op" id="8370383">(</span><span class="ident" id="8370384">colspec</span><span class="op" id="8370391">,</span>&nbsp;<span class="string" id="8370393">&#34;=&#34;</span><span class="op" id="8370396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370400">if</span>&nbsp;<span class="builtinfunc" id="8370403">len</span><span class="op" id="8370406">(</span><span class="ident" id="8370407">nameVal</span><span class="op" id="8370414">)</span>&nbsp;<span class="op" id="8370416">!=</span>&nbsp;<span class="num" id="8370419">2</span>&nbsp;<span class="op" id="8370421">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370426">stmt</span><span class="op" id="8370430">.</span><span class="ident" id="8370431">Close</span><span class="op" id="8370436">(</span><span class="op" id="8370437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370442">return</span>&nbsp;<span class="ident" id="8370449">nil</span><span class="op" id="8370452">,</span>&nbsp;<span class="ident" id="8370454">errf</span><span class="op" id="8370458">(</span><span class="string" id="8370459">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="8370517">,</span>&nbsp;<span class="ident" id="8370519">stmt</span><span class="op" id="8370523">.</span><span class="ident" id="8370524">table</span><span class="op" id="8370529">,</span>&nbsp;<span class="ident" id="8370531">colspec</span><span class="op" id="8370538">,</span>&nbsp;<span class="ident" id="8370540">n</span><span class="op" id="8370541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8370545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370549">column</span><span class="op" id="8370555">,</span>&nbsp;<span class="ident" id="8370557">value</span>&nbsp;<span class="op" id="8370563">:=</span>&nbsp;<span class="ident" id="8370566">nameVal</span><span class="op" id="8370573">[</span><span class="num" id="8370574">0</span><span class="op" id="8370575">]</span><span class="op" id="8370576">,</span>&nbsp;<span class="ident" id="8370578">nameVal</span><span class="op" id="8370585">[</span><span class="num" id="8370586">1</span><span class="op" id="8370587">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370591">ctype</span><span class="op" id="8370596">,</span>&nbsp;<span class="ident" id="8370598">ok</span>&nbsp;<span class="op" id="8370601">:=</span>&nbsp;<span class="ident" id="8370604">c</span><span class="op" id="8370605">.</span><span class="ident" id="8370606">db</span><span class="op" id="8370608">.</span><span class="ident" id="8370609">columnType</span><span class="op" id="8370619">(</span><span class="ident" id="8370620">stmt</span><span class="op" id="8370624">.</span><span class="ident" id="8370625">table</span><span class="op" id="8370630">,</span>&nbsp;<span class="ident" id="8370632">column</span><span class="op" id="8370638">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370642">if</span>&nbsp;<span class="op" id="8370645">!</span><span class="ident" id="8370646">ok</span>&nbsp;<span class="op" id="8370649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370654">stmt</span><span class="op" id="8370658">.</span><span class="ident" id="8370659">Close</span><span class="op" id="8370664">(</span><span class="op" id="8370665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370670">return</span>&nbsp;<span class="ident" id="8370677">nil</span><span class="op" id="8370680">,</span>&nbsp;<span class="ident" id="8370682">errf</span><span class="op" id="8370686">(</span><span class="string" id="8370687">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8370738">,</span>&nbsp;<span class="ident" id="8370740">stmt</span><span class="op" id="8370744">.</span><span class="ident" id="8370745">table</span><span class="op" id="8370750">,</span>&nbsp;<span class="ident" id="8370752">column</span><span class="op" id="8370758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8370762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370766">stmt</span><span class="op" id="8370770">.</span><span class="ident" id="8370771">colName</span>&nbsp;<span class="op" id="8370779">=</span>&nbsp;<span class="builtinfunc" id="8370781">append</span><span class="op" id="8370787">(</span><span class="ident" id="8370788">stmt</span><span class="op" id="8370792">.</span><span class="ident" id="8370793">colName</span><span class="op" id="8370800">,</span>&nbsp;<span class="ident" id="8370802">column</span><span class="op" id="8370808">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370813">if</span>&nbsp;<span class="ident" id="8370816">value</span>&nbsp;<span class="op" id="8370822">!=</span>&nbsp;<span class="string" id="8370825">&#34;?&#34;</span>&nbsp;<span class="op" id="8370829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370834">var</span>&nbsp;<span class="ident" id="8370838">subsetVal</span>&nbsp;<span class="keyword" id="8370848">interface</span><span class="op" id="8370857">{</span><span class="op" id="8370858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8370863">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370899">switch</span>&nbsp;<span class="ident" id="8370906">ctype</span>&nbsp;<span class="op" id="8370912">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370917">case</span>&nbsp;<span class="string" id="8370922">&#34;string&#34;</span><span class="op" id="8370930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370936">subsetVal</span>&nbsp;<span class="op" id="8370946">=</span>&nbsp;<span class="op" id="8370948">[</span><span class="op" id="8370949">]</span><span class="builtintype" id="8370950">byte</span><span class="op" id="8370954">(</span><span class="ident" id="8370955">value</span><span class="op" id="8370960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8370965">case</span>&nbsp;<span class="string" id="8370970">&#34;blob&#34;</span><span class="op" id="8370976">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8370982">subsetVal</span>&nbsp;<span class="op" id="8370992">=</span>&nbsp;<span class="op" id="8370994">[</span><span class="op" id="8370995">]</span><span class="builtintype" id="8370996">byte</span><span class="op" id="8371000">(</span><span class="ident" id="8371001">value</span><span class="op" id="8371006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371011">case</span>&nbsp;<span class="string" id="8371016">&#34;int32&#34;</span><span class="op" id="8371023">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371029">i</span><span class="op" id="8371030">,</span>&nbsp;<span class="ident" id="8371032">err</span>&nbsp;<span class="op" id="8371036">:=</span>&nbsp;<span class="ident" id="8371039">strconv</span><span class="op" id="8371046">.</span><span class="ident" id="8371047">Atoi</span><span class="op" id="8371051">(</span><span class="ident" id="8371052">value</span><span class="op" id="8371057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371063">if</span>&nbsp;<span class="ident" id="8371066">err</span>&nbsp;<span class="op" id="8371070">!=</span>&nbsp;<span class="ident" id="8371073">nil</span>&nbsp;<span class="op" id="8371077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371084">stmt</span><span class="op" id="8371088">.</span><span class="ident" id="8371089">Close</span><span class="op" id="8371094">(</span><span class="op" id="8371095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371102">return</span>&nbsp;<span class="ident" id="8371109">nil</span><span class="op" id="8371112">,</span>&nbsp;<span class="ident" id="8371114">errf</span><span class="op" id="8371118">(</span><span class="string" id="8371119">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="8371156">,</span>&nbsp;<span class="ident" id="8371158">value</span><span class="op" id="8371163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371169">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371175">subsetVal</span>&nbsp;<span class="op" id="8371185">=</span>&nbsp;<span class="ident" id="8371187">int64</span><span class="op" id="8371192">(</span><span class="ident" id="8371193">i</span><span class="op" id="8371194">)</span>&nbsp;<span class="comment" id="8371196">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371240">default</span><span class="op" id="8371247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371253">stmt</span><span class="op" id="8371257">.</span><span class="ident" id="8371258">Close</span><span class="op" id="8371263">(</span><span class="op" id="8371264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371270">return</span>&nbsp;<span class="ident" id="8371277">nil</span><span class="op" id="8371280">,</span>&nbsp;<span class="ident" id="8371282">errf</span><span class="op" id="8371286">(</span><span class="string" id="8371287">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="8371349">,</span>&nbsp;<span class="ident" id="8371351">value</span><span class="op" id="8371356">,</span>&nbsp;<span class="ident" id="8371358">ctype</span><span class="op" id="8371363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371368">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371373">stmt</span><span class="op" id="8371377">.</span><span class="ident" id="8371378">colValue</span>&nbsp;<span class="op" id="8371387">=</span>&nbsp;<span class="builtinfunc" id="8371389">append</span><span class="op" id="8371395">(</span><span class="ident" id="8371396">stmt</span><span class="op" id="8371400">.</span><span class="ident" id="8371401">colValue</span><span class="op" id="8371409">,</span>&nbsp;<span class="ident" id="8371411">subsetVal</span><span class="op" id="8371420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371424">}</span>&nbsp;<span class="keyword" id="8371426">else</span>&nbsp;<span class="op" id="8371431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371436">stmt</span><span class="op" id="8371440">.</span><span class="ident" id="8371441">placeholders</span><span class="op" id="8371453">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371459">stmt</span><span class="op" id="8371463">.</span><span class="ident" id="8371464">placeholderConverter</span>&nbsp;<span class="op" id="8371485">=</span>&nbsp;<span class="builtinfunc" id="8371487">append</span><span class="op" id="8371493">(</span><span class="ident" id="8371494">stmt</span><span class="op" id="8371498">.</span><span class="ident" id="8371499">placeholderConverter</span><span class="op" id="8371519">,</span>&nbsp;<span class="ident" id="8371521">converterForType</span><span class="op" id="8371537">(</span><span class="ident" id="8371538">ctype</span><span class="op" id="8371543">)</span><span class="op" id="8371544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371549">stmt</span><span class="op" id="8371553">.</span><span class="ident" id="8371554">colValue</span>&nbsp;<span class="op" id="8371563">=</span>&nbsp;<span class="builtinfunc" id="8371565">append</span><span class="op" id="8371571">(</span><span class="ident" id="8371572">stmt</span><span class="op" id="8371576">.</span><span class="ident" id="8371577">colValue</span><span class="op" id="8371585">,</span>&nbsp;<span class="string" id="8371587">&#34;?&#34;</span><span class="op" id="8371590">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371600">return</span>&nbsp;<span class="ident" id="8371607">stmt</span><span class="op" id="8371611">,</span>&nbsp;<span class="ident" id="8371613">nil</span><br>
<span class="lineno"></span><span class="op" id="8371617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="8371620">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="8371659">var</span>&nbsp;<span class="ident" id="8371663">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="8371682">func</span><span class="op" id="8371686">(</span><span class="op" id="8371687">)</span>&nbsp;<span class="builtintype" id="8371689">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8371695">func</span>&nbsp;<span class="op" id="8371700">(</span><span class="ident" id="8371701">c</span>&nbsp;<span class="op" id="8371703">*</span><span class="ident" id="8371704">fakeConn</span><span class="op" id="8371712">)</span>&nbsp;<span class="ident" id="8371714">Prepare</span><span class="op" id="8371721">(</span><span class="ident" id="8371722">query</span>&nbsp;<span class="builtintype" id="8371728">string</span><span class="op" id="8371734">)</span>&nbsp;<span class="op" id="8371736">(</span><span class="ident" id="8371737">driver</span><span class="op" id="8371743">.</span><span class="ident" id="8371744">Stmt</span><span class="op" id="8371748">,</span>&nbsp;<span class="builtintype" id="8371750">error</span><span class="op" id="8371755">)</span>&nbsp;<span class="op" id="8371757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371760">c</span><span class="op" id="8371761">.</span><span class="ident" id="8371762">numPrepare</span><span class="op" id="8371772">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371776">if</span>&nbsp;<span class="ident" id="8371779">c</span><span class="op" id="8371780">.</span><span class="ident" id="8371781">db</span>&nbsp;<span class="op" id="8371784">==</span>&nbsp;<span class="ident" id="8371787">nil</span>&nbsp;<span class="op" id="8371791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8371795">panic</span><span class="op" id="8371800">(</span><span class="string" id="8371801">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="8371821">+</span>&nbsp;<span class="ident" id="8371823">fmt</span><span class="op" id="8371826">.</span><span class="ident" id="8371827">Sprintf</span><span class="op" id="8371834">(</span><span class="string" id="8371835">&#34;%#v&#34;</span><span class="op" id="8371840">,</span>&nbsp;<span class="ident" id="8371842">c</span><span class="op" id="8371843">)</span><span class="op" id="8371844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371851">if</span>&nbsp;<span class="ident" id="8371854">hookPrepareBadConn</span>&nbsp;<span class="op" id="8371873">!=</span>&nbsp;<span class="ident" id="8371876">nil</span>&nbsp;<span class="op" id="8371880">&amp;&amp;</span>&nbsp;<span class="ident" id="8371883">hookPrepareBadConn</span><span class="op" id="8371901">(</span><span class="op" id="8371902">)</span>&nbsp;<span class="op" id="8371904">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371908">return</span>&nbsp;<span class="ident" id="8371915">nil</span><span class="op" id="8371918">,</span>&nbsp;<span class="ident" id="8371920">driver</span><span class="op" id="8371926">.</span><span class="ident" id="8371927">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8371939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8371943">parts</span>&nbsp;<span class="op" id="8371949">:=</span>&nbsp;<span class="ident" id="8371952">strings</span><span class="op" id="8371959">.</span><span class="ident" id="8371960">Split</span><span class="op" id="8371965">(</span><span class="ident" id="8371966">query</span><span class="op" id="8371971">,</span>&nbsp;<span class="string" id="8371973">&#34;|&#34;</span><span class="op" id="8371976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8371979">if</span>&nbsp;<span class="builtinfunc" id="8371982">len</span><span class="op" id="8371985">(</span><span class="ident" id="8371986">parts</span><span class="op" id="8371991">)</span>&nbsp;<span class="op" id="8371993">&lt;</span>&nbsp;<span class="num" id="8371995">1</span>&nbsp;<span class="op" id="8371997">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372001">return</span>&nbsp;<span class="ident" id="8372008">nil</span><span class="op" id="8372011">,</span>&nbsp;<span class="ident" id="8372013">errf</span><span class="op" id="8372017">(</span><span class="string" id="8372018">&#34;empty&nbsp;query&#34;</span><span class="op" id="8372031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8372034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8372037">cmd</span>&nbsp;<span class="op" id="8372041">:=</span>&nbsp;<span class="ident" id="8372044">parts</span><span class="op" id="8372049">[</span><span class="num" id="8372050">0</span><span class="op" id="8372051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8372054">parts</span>&nbsp;<span class="op" id="8372060">=</span>&nbsp;<span class="ident" id="8372062">parts</span><span class="op" id="8372067">[</span><span class="num" id="8372068">1</span><span class="op" id="8372069">:</span><span class="op" id="8372070">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8372073">stmt</span>&nbsp;<span class="op" id="8372078">:=</span>&nbsp;<span class="op" id="8372081">&amp;</span><span class="ident" id="8372082">fakeStmt</span><span class="op" id="8372090">{</span><span class="ident" id="8372091">q</span><span class="op" id="8372092">:</span>&nbsp;<span class="ident" id="8372094">query</span><span class="op" id="8372099">,</span>&nbsp;<span class="ident" id="8372101">c</span><span class="op" id="8372102">:</span>&nbsp;<span class="ident" id="8372104">c</span><span class="op" id="8372105">,</span>&nbsp;<span class="ident" id="8372107">cmd</span><span class="op" id="8372110">:</span>&nbsp;<span class="ident" id="8372112">cmd</span><span class="op" id="8372115">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8372118">c</span><span class="op" id="8372119">.</span><span class="ident" id="8372120">incrStat</span><span class="op" id="8372128">(</span><span class="op" id="8372129">&amp;</span><span class="ident" id="8372130">c</span><span class="op" id="8372131">.</span><span class="ident" id="8372132">stmtsMade</span><span class="op" id="8372141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372144">switch</span>&nbsp;<span class="ident" id="8372151">cmd</span>&nbsp;<span class="op" id="8372155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372158">case</span>&nbsp;<span class="string" id="8372163">&#34;WIPE&#34;</span><span class="op" id="8372169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8372173">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372185">case</span>&nbsp;<span class="string" id="8372190">&#34;SELECT&#34;</span><span class="op" id="8372198">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372202">return</span>&nbsp;<span class="ident" id="8372209">c</span><span class="op" id="8372210">.</span><span class="ident" id="8372211">prepareSelect</span><span class="op" id="8372224">(</span><span class="ident" id="8372225">stmt</span><span class="op" id="8372229">,</span>&nbsp;<span class="ident" id="8372231">parts</span><span class="op" id="8372236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372239">case</span>&nbsp;<span class="string" id="8372244">&#34;CREATE&#34;</span><span class="op" id="8372252">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372256">return</span>&nbsp;<span class="ident" id="8372263">c</span><span class="op" id="8372264">.</span><span class="ident" id="8372265">prepareCreate</span><span class="op" id="8372278">(</span><span class="ident" id="8372279">stmt</span><span class="op" id="8372283">,</span>&nbsp;<span class="ident" id="8372285">parts</span><span class="op" id="8372290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372293">case</span>&nbsp;<span class="string" id="8372298">&#34;INSERT&#34;</span><span class="op" id="8372306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372310">return</span>&nbsp;<span class="ident" id="8372317">c</span><span class="op" id="8372318">.</span><span class="ident" id="8372319">prepareInsert</span><span class="op" id="8372332">(</span><span class="ident" id="8372333">stmt</span><span class="op" id="8372337">,</span>&nbsp;<span class="ident" id="8372339">parts</span><span class="op" id="8372344">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372347">case</span>&nbsp;<span class="string" id="8372352">&#34;NOSERT&#34;</span><span class="op" id="8372360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8372364">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8372444">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372488">return</span>&nbsp;<span class="ident" id="8372495">c</span><span class="op" id="8372496">.</span><span class="ident" id="8372497">prepareInsert</span><span class="op" id="8372510">(</span><span class="ident" id="8372511">stmt</span><span class="op" id="8372515">,</span>&nbsp;<span class="ident" id="8372517">parts</span><span class="op" id="8372522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372525">default</span><span class="op" id="8372532">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8372536">stmt</span><span class="op" id="8372540">.</span><span class="ident" id="8372541">Close</span><span class="op" id="8372546">(</span><span class="op" id="8372547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372551">return</span>&nbsp;<span class="ident" id="8372558">nil</span><span class="op" id="8372561">,</span>&nbsp;<span class="ident" id="8372563">errf</span><span class="op" id="8372567">(</span><span class="string" id="8372568">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="8372597">,</span>&nbsp;<span class="ident" id="8372599">cmd</span><span class="op" id="8372602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8372605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372608">return</span>&nbsp;<span class="ident" id="8372615">stmt</span><span class="op" id="8372619">,</span>&nbsp;<span class="ident" id="8372621">nil</span><br>
<span class="lineno"></span><span class="op" id="8372625">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="8372628">func</span>&nbsp;<span class="op" id="8372633">(</span><span class="ident" id="8372634">s</span>&nbsp;<span class="op" id="8372636">*</span><span class="ident" id="8372637">fakeStmt</span><span class="op" id="8372645">)</span>&nbsp;<span class="ident" id="8372647">ColumnConverter</span><span class="op" id="8372662">(</span><span class="ident" id="8372663">idx</span>&nbsp;<span class="builtintype" id="8372667">int</span><span class="op" id="8372670">)</span>&nbsp;<span class="ident" id="8372672">driver</span><span class="op" id="8372678">.</span><span class="ident" id="8372679">ValueConverter</span>&nbsp;<span class="op" id="8372694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372697">if</span>&nbsp;<span class="builtinfunc" id="8372700">len</span><span class="op" id="8372703">(</span><span class="ident" id="8372704">s</span><span class="op" id="8372705">.</span><span class="ident" id="8372706">placeholderConverter</span><span class="op" id="8372726">)</span>&nbsp;<span class="op" id="8372728">==</span>&nbsp;<span class="num" id="8372731">0</span>&nbsp;<span class="op" id="8372733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372737">return</span>&nbsp;<span class="ident" id="8372744">driver</span><span class="op" id="8372750">.</span><span class="ident" id="8372751">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8372778">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372781">return</span>&nbsp;<span class="ident" id="8372788">s</span><span class="op" id="8372789">.</span><span class="ident" id="8372790">placeholderConverter</span><span class="op" id="8372810">[</span><span class="ident" id="8372811">idx</span><span class="op" id="8372814">]</span><br>
<span class="lineno"></span><span class="op" id="8372816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8372819">func</span>&nbsp;<span class="op" id="8372824">(</span><span class="ident" id="8372825">s</span>&nbsp;<span class="op" id="8372827">*</span><span class="ident" id="8372828">fakeStmt</span><span class="op" id="8372836">)</span>&nbsp;<span class="ident" id="8372838">Close</span><span class="op" id="8372843">(</span><span class="op" id="8372844">)</span>&nbsp;<span class="builtintype" id="8372846">error</span>&nbsp;<span class="op" id="8372852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372855">if</span>&nbsp;<span class="ident" id="8372858">s</span><span class="op" id="8372859">.</span><span class="ident" id="8372860">c</span>&nbsp;<span class="op" id="8372862">==</span>&nbsp;<span class="ident" id="8372865">nil</span>&nbsp;<span class="op" id="8372869">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8372873">panic</span><span class="op" id="8372878">(</span><span class="string" id="8372879">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="8372907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8372910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8372913">if</span>&nbsp;<span class="ident" id="8372916">s</span><span class="op" id="8372917">.</span><span class="ident" id="8372918">c</span><span class="op" id="8372919">.</span><span class="ident" id="8372920">db</span>&nbsp;<span class="op" id="8372923">==</span>&nbsp;<span class="ident" id="8372926">nil</span>&nbsp;<span class="op" id="8372930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8372934">panic</span><span class="op" id="8372939">(</span><span class="string" id="8372940">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="8372994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8372997">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373000">if</span>&nbsp;<span class="op" id="8373003">!</span><span class="ident" id="8373004">s</span><span class="op" id="8373005">.</span><span class="ident" id="8373006">closed</span>&nbsp;<span class="op" id="8373013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373017">s</span><span class="op" id="8373018">.</span><span class="ident" id="8373019">c</span><span class="op" id="8373020">.</span><span class="ident" id="8373021">incrStat</span><span class="op" id="8373029">(</span><span class="op" id="8373030">&amp;</span><span class="ident" id="8373031">s</span><span class="op" id="8373032">.</span><span class="ident" id="8373033">c</span><span class="op" id="8373034">.</span><span class="ident" id="8373035">stmtsClosed</span><span class="op" id="8373046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373050">s</span><span class="op" id="8373051">.</span><span class="ident" id="8373052">closed</span>&nbsp;<span class="op" id="8373059">=</span>&nbsp;<span class="builtintype" id="8373061">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373070">return</span>&nbsp;<span class="ident" id="8373077">nil</span><br>
<span class="lineno">520</span><span class="op" id="8373081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8373084">var</span>&nbsp;<span class="ident" id="8373088">errClosed</span>&nbsp;<span class="op" id="8373098">=</span>&nbsp;<span class="ident" id="8373100">errors</span><span class="op" id="8373106">.</span><span class="ident" id="8373107">New</span><span class="op" id="8373110">(</span><span class="string" id="8373111">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="8373146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8373149">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="8373188">var</span>&nbsp;<span class="ident" id="8373192">hookExecBadConn</span>&nbsp;<span class="keyword" id="8373208">func</span><span class="op" id="8373212">(</span><span class="op" id="8373213">)</span>&nbsp;<span class="builtintype" id="8373215">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8373221">func</span>&nbsp;<span class="op" id="8373226">(</span><span class="ident" id="8373227">s</span>&nbsp;<span class="op" id="8373229">*</span><span class="ident" id="8373230">fakeStmt</span><span class="op" id="8373238">)</span>&nbsp;<span class="ident" id="8373240">Exec</span><span class="op" id="8373244">(</span><span class="ident" id="8373245">args</span>&nbsp;<span class="op" id="8373250">[</span><span class="op" id="8373251">]</span><span class="ident" id="8373252">driver</span><span class="op" id="8373258">.</span><span class="ident" id="8373259">Value</span><span class="op" id="8373264">)</span>&nbsp;<span class="op" id="8373266">(</span><span class="ident" id="8373267">driver</span><span class="op" id="8373273">.</span><span class="ident" id="8373274">Result</span><span class="op" id="8373280">,</span>&nbsp;<span class="builtintype" id="8373282">error</span><span class="op" id="8373287">)</span>&nbsp;<span class="op" id="8373289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373292">if</span>&nbsp;<span class="ident" id="8373295">s</span><span class="op" id="8373296">.</span><span class="ident" id="8373297">closed</span>&nbsp;<span class="op" id="8373304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373308">return</span>&nbsp;<span class="ident" id="8373315">nil</span><span class="op" id="8373318">,</span>&nbsp;<span class="ident" id="8373320">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373335">if</span>&nbsp;<span class="ident" id="8373338">hookExecBadConn</span>&nbsp;<span class="op" id="8373354">!=</span>&nbsp;<span class="ident" id="8373357">nil</span>&nbsp;<span class="op" id="8373361">&amp;&amp;</span>&nbsp;<span class="ident" id="8373364">hookExecBadConn</span><span class="op" id="8373379">(</span><span class="op" id="8373380">)</span>&nbsp;<span class="op" id="8373382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373386">return</span>&nbsp;<span class="ident" id="8373393">nil</span><span class="op" id="8373396">,</span>&nbsp;<span class="ident" id="8373398">driver</span><span class="op" id="8373404">.</span><span class="ident" id="8373405">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373417">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373421">err</span>&nbsp;<span class="op" id="8373425">:=</span>&nbsp;<span class="ident" id="8373428">checkSubsetTypes</span><span class="op" id="8373444">(</span><span class="ident" id="8373445">args</span><span class="op" id="8373449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373452">if</span>&nbsp;<span class="ident" id="8373455">err</span>&nbsp;<span class="op" id="8373459">!=</span>&nbsp;<span class="ident" id="8373462">nil</span>&nbsp;<span class="op" id="8373466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373470">return</span>&nbsp;<span class="ident" id="8373477">nil</span><span class="op" id="8373480">,</span>&nbsp;<span class="ident" id="8373482">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373487">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373491">db</span>&nbsp;<span class="op" id="8373494">:=</span>&nbsp;<span class="ident" id="8373497">s</span><span class="op" id="8373498">.</span><span class="ident" id="8373499">c</span><span class="op" id="8373500">.</span><span class="ident" id="8373501">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373505">switch</span>&nbsp;<span class="ident" id="8373512">s</span><span class="op" id="8373513">.</span><span class="ident" id="8373514">cmd</span>&nbsp;<span class="op" id="8373518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373521">case</span>&nbsp;<span class="string" id="8373526">&#34;WIPE&#34;</span><span class="op" id="8373532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373536">db</span><span class="op" id="8373538">.</span><span class="ident" id="8373539">wipe</span><span class="op" id="8373543">(</span><span class="op" id="8373544">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373548">return</span>&nbsp;<span class="ident" id="8373555">driver</span><span class="op" id="8373561">.</span><span class="ident" id="8373562">ResultNoRows</span><span class="op" id="8373574">,</span>&nbsp;<span class="ident" id="8373576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373581">case</span>&nbsp;<span class="string" id="8373586">&#34;CREATE&#34;</span><span class="op" id="8373594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373598">if</span>&nbsp;<span class="ident" id="8373601">err</span>&nbsp;<span class="op" id="8373605">:=</span>&nbsp;<span class="ident" id="8373608">db</span><span class="op" id="8373610">.</span><span class="ident" id="8373611">createTable</span><span class="op" id="8373622">(</span><span class="ident" id="8373623">s</span><span class="op" id="8373624">.</span><span class="ident" id="8373625">table</span><span class="op" id="8373630">,</span>&nbsp;<span class="ident" id="8373632">s</span><span class="op" id="8373633">.</span><span class="ident" id="8373634">colName</span><span class="op" id="8373641">,</span>&nbsp;<span class="ident" id="8373643">s</span><span class="op" id="8373644">.</span><span class="ident" id="8373645">colType</span><span class="op" id="8373652">)</span><span class="op" id="8373653">;</span>&nbsp;<span class="ident" id="8373655">err</span>&nbsp;<span class="op" id="8373659">!=</span>&nbsp;<span class="ident" id="8373662">nil</span>&nbsp;<span class="op" id="8373666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373671">return</span>&nbsp;<span class="ident" id="8373678">nil</span><span class="op" id="8373681">,</span>&nbsp;<span class="ident" id="8373683">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373689">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373693">return</span>&nbsp;<span class="ident" id="8373700">driver</span><span class="op" id="8373706">.</span><span class="ident" id="8373707">ResultNoRows</span><span class="op" id="8373719">,</span>&nbsp;<span class="ident" id="8373721">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373726">case</span>&nbsp;<span class="string" id="8373731">&#34;INSERT&#34;</span><span class="op" id="8373739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373743">return</span>&nbsp;<span class="ident" id="8373750">s</span><span class="op" id="8373751">.</span><span class="ident" id="8373752">execInsert</span><span class="op" id="8373762">(</span><span class="ident" id="8373763">args</span><span class="op" id="8373767">,</span>&nbsp;<span class="builtintype" id="8373769">true</span><span class="op" id="8373773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373776">case</span>&nbsp;<span class="string" id="8373781">&#34;NOSERT&#34;</span><span class="op" id="8373789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8373793">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8373873">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8373917">return</span>&nbsp;<span class="ident" id="8373924">s</span><span class="op" id="8373925">.</span><span class="ident" id="8373926">execInsert</span><span class="op" id="8373936">(</span><span class="ident" id="8373937">args</span><span class="op" id="8373941">,</span>&nbsp;<span class="builtintype" id="8373943">false</span><span class="op" id="8373948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8373951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8373954">fmt</span><span class="op" id="8373957">.</span><span class="ident" id="8373958">Printf</span><span class="op" id="8373964">(</span><span class="string" id="8373965">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="8373996">,</span>&nbsp;<span class="ident" id="8373998">s</span><span class="op" id="8373999">.</span><span class="ident" id="8374000">cmd</span><span class="op" id="8374003">,</span>&nbsp;<span class="ident" id="8374005">s</span><span class="op" id="8374006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374009">return</span>&nbsp;<span class="ident" id="8374016">nil</span><span class="op" id="8374019">,</span>&nbsp;<span class="ident" id="8374021">fmt</span><span class="op" id="8374024">.</span><span class="ident" id="8374025">Errorf</span><span class="op" id="8374031">(</span><span class="string" id="8374032">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="8374081">,</span>&nbsp;<span class="ident" id="8374083">s</span><span class="op" id="8374084">.</span><span class="ident" id="8374085">cmd</span><span class="op" id="8374088">)</span><br>
<span class="lineno">560</span><span class="op" id="8374090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8374093">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="8374145">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="8374214">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="8374252">func</span>&nbsp;<span class="op" id="8374257">(</span><span class="ident" id="8374258">s</span>&nbsp;<span class="op" id="8374260">*</span><span class="ident" id="8374261">fakeStmt</span><span class="op" id="8374269">)</span>&nbsp;<span class="ident" id="8374271">execInsert</span><span class="op" id="8374281">(</span><span class="ident" id="8374282">args</span>&nbsp;<span class="op" id="8374287">[</span><span class="op" id="8374288">]</span><span class="ident" id="8374289">driver</span><span class="op" id="8374295">.</span><span class="ident" id="8374296">Value</span><span class="op" id="8374301">,</span>&nbsp;<span class="ident" id="8374303">doInsert</span>&nbsp;<span class="builtintype" id="8374312">bool</span><span class="op" id="8374316">)</span>&nbsp;<span class="op" id="8374318">(</span><span class="ident" id="8374319">driver</span><span class="op" id="8374325">.</span><span class="ident" id="8374326">Result</span><span class="op" id="8374332">,</span>&nbsp;<span class="builtintype" id="8374334">error</span><span class="op" id="8374339">)</span>&nbsp;<span class="op" id="8374341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374344">db</span>&nbsp;<span class="op" id="8374347">:=</span>&nbsp;<span class="ident" id="8374350">s</span><span class="op" id="8374351">.</span><span class="ident" id="8374352">c</span><span class="op" id="8374353">.</span><span class="ident" id="8374354">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374358">if</span>&nbsp;<span class="builtinfunc" id="8374361">len</span><span class="op" id="8374364">(</span><span class="ident" id="8374365">args</span><span class="op" id="8374369">)</span>&nbsp;<span class="op" id="8374371">!=</span>&nbsp;<span class="ident" id="8374374">s</span><span class="op" id="8374375">.</span><span class="ident" id="8374376">placeholders</span>&nbsp;<span class="op" id="8374389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8374393">panic</span><span class="op" id="8374398">(</span><span class="string" id="8374399">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="8374457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8374460">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374463">db</span><span class="op" id="8374465">.</span><span class="ident" id="8374466">mu</span><span class="op" id="8374468">.</span><span class="ident" id="8374469">Lock</span><span class="op" id="8374473">(</span><span class="op" id="8374474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374477">t</span><span class="op" id="8374478">,</span>&nbsp;<span class="ident" id="8374480">ok</span>&nbsp;<span class="op" id="8374483">:=</span>&nbsp;<span class="ident" id="8374486">db</span><span class="op" id="8374488">.</span><span class="ident" id="8374489">table</span><span class="op" id="8374494">(</span><span class="ident" id="8374495">s</span><span class="op" id="8374496">.</span><span class="ident" id="8374497">table</span><span class="op" id="8374502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374505">db</span><span class="op" id="8374507">.</span><span class="ident" id="8374508">mu</span><span class="op" id="8374510">.</span><span class="ident" id="8374511">Unlock</span><span class="op" id="8374517">(</span><span class="op" id="8374518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374521">if</span>&nbsp;<span class="op" id="8374524">!</span><span class="ident" id="8374525">ok</span>&nbsp;<span class="op" id="8374528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374532">return</span>&nbsp;<span class="ident" id="8374539">nil</span><span class="op" id="8374542">,</span>&nbsp;<span class="ident" id="8374544">fmt</span><span class="op" id="8374547">.</span><span class="ident" id="8374548">Errorf</span><span class="op" id="8374554">(</span><span class="string" id="8374555">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="8374587">,</span>&nbsp;<span class="ident" id="8374589">s</span><span class="op" id="8374590">.</span><span class="ident" id="8374591">table</span><span class="op" id="8374596">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8374599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374603">t</span><span class="op" id="8374604">.</span><span class="ident" id="8374605">mu</span><span class="op" id="8374607">.</span><span class="ident" id="8374608">Lock</span><span class="op" id="8374612">(</span><span class="op" id="8374613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374616">defer</span>&nbsp;<span class="ident" id="8374622">t</span><span class="op" id="8374623">.</span><span class="ident" id="8374624">mu</span><span class="op" id="8374626">.</span><span class="ident" id="8374627">Unlock</span><span class="op" id="8374633">(</span><span class="op" id="8374634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374638">var</span>&nbsp;<span class="ident" id="8374642">cols</span>&nbsp;<span class="op" id="8374647">[</span><span class="op" id="8374648">]</span><span class="keyword" id="8374649">interface</span><span class="op" id="8374658">{</span><span class="op" id="8374659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374662">if</span>&nbsp;<span class="ident" id="8374665">doInsert</span>&nbsp;<span class="op" id="8374674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374678">cols</span>&nbsp;<span class="op" id="8374683">=</span>&nbsp;<span class="builtinfunc" id="8374685">make</span><span class="op" id="8374689">(</span><span class="op" id="8374690">[</span><span class="op" id="8374691">]</span><span class="keyword" id="8374692">interface</span><span class="op" id="8374701">{</span><span class="op" id="8374702">}</span><span class="op" id="8374703">,</span>&nbsp;<span class="builtinfunc" id="8374705">len</span><span class="op" id="8374708">(</span><span class="ident" id="8374709">t</span><span class="op" id="8374710">.</span><span class="ident" id="8374711">colname</span><span class="op" id="8374718">)</span><span class="op" id="8374719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8374722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374725">argPos</span>&nbsp;<span class="op" id="8374732">:=</span>&nbsp;<span class="num" id="8374735">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374738">for</span>&nbsp;<span class="ident" id="8374742">n</span><span class="op" id="8374743">,</span>&nbsp;<span class="ident" id="8374745">colname</span>&nbsp;<span class="op" id="8374753">:=</span>&nbsp;<span class="keyword" id="8374756">range</span>&nbsp;<span class="ident" id="8374762">s</span><span class="op" id="8374763">.</span><span class="ident" id="8374764">colName</span>&nbsp;<span class="op" id="8374772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8374776">colidx</span>&nbsp;<span class="op" id="8374783">:=</span>&nbsp;<span class="ident" id="8374786">t</span><span class="op" id="8374787">.</span><span class="ident" id="8374788">columnIndex</span><span class="op" id="8374799">(</span><span class="ident" id="8374800">colname</span><span class="op" id="8374807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374811">if</span>&nbsp;<span class="ident" id="8374814">colidx</span>&nbsp;<span class="op" id="8374821">==</span>&nbsp;<span class="op" id="8374824">-</span><span class="num" id="8374825">1</span>&nbsp;<span class="op" id="8374827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374832">return</span>&nbsp;<span class="ident" id="8374839">nil</span><span class="op" id="8374842">,</span>&nbsp;<span class="ident" id="8374844">fmt</span><span class="op" id="8374847">.</span><span class="ident" id="8374848">Errorf</span><span class="op" id="8374854">(</span><span class="string" id="8374855">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="8374936">,</span>&nbsp;<span class="ident" id="8374938">colname</span><span class="op" id="8374945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8374949">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374953">var</span>&nbsp;<span class="ident" id="8374957">val</span>&nbsp;<span class="keyword" id="8374961">interface</span><span class="op" id="8374970">{</span><span class="op" id="8374971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8374975">if</span>&nbsp;<span class="ident" id="8374978">strvalue</span><span class="op" id="8374986">,</span>&nbsp;<span class="ident" id="8374988">ok</span>&nbsp;<span class="op" id="8374991">:=</span>&nbsp;<span class="ident" id="8374994">s</span><span class="op" id="8374995">.</span><span class="ident" id="8374996">colValue</span><span class="op" id="8375004">[</span><span class="ident" id="8375005">n</span><span class="op" id="8375006">]</span><span class="op" id="8375007">.</span><span class="op" id="8375008">(</span><span class="builtintype" id="8375009">string</span><span class="op" id="8375015">)</span><span class="op" id="8375016">;</span>&nbsp;<span class="ident" id="8375018">ok</span>&nbsp;<span class="op" id="8375021">&amp;&amp;</span>&nbsp;<span class="ident" id="8375024">strvalue</span>&nbsp;<span class="op" id="8375033">==</span>&nbsp;<span class="string" id="8375036">&#34;?&#34;</span>&nbsp;<span class="op" id="8375040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375045">val</span>&nbsp;<span class="op" id="8375049">=</span>&nbsp;<span class="ident" id="8375051">args</span><span class="op" id="8375055">[</span><span class="ident" id="8375056">argPos</span><span class="op" id="8375062">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375067">argPos</span><span class="op" id="8375073">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375078">}</span>&nbsp;<span class="keyword" id="8375080">else</span>&nbsp;<span class="op" id="8375085">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375090">val</span>&nbsp;<span class="op" id="8375094">=</span>&nbsp;<span class="ident" id="8375096">s</span><span class="op" id="8375097">.</span><span class="ident" id="8375098">colValue</span><span class="op" id="8375106">[</span><span class="ident" id="8375107">n</span><span class="op" id="8375108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375116">if</span>&nbsp;<span class="ident" id="8375119">doInsert</span>&nbsp;<span class="op" id="8375128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375133">cols</span><span class="op" id="8375137">[</span><span class="ident" id="8375138">colidx</span><span class="op" id="8375144">]</span>&nbsp;<span class="op" id="8375146">=</span>&nbsp;<span class="ident" id="8375148">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375154">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375161">if</span>&nbsp;<span class="ident" id="8375164">doInsert</span>&nbsp;<span class="op" id="8375173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375177">t</span><span class="op" id="8375178">.</span><span class="ident" id="8375179">rows</span>&nbsp;<span class="op" id="8375184">=</span>&nbsp;<span class="builtinfunc" id="8375186">append</span><span class="op" id="8375192">(</span><span class="ident" id="8375193">t</span><span class="op" id="8375194">.</span><span class="ident" id="8375195">rows</span><span class="op" id="8375199">,</span>&nbsp;<span class="op" id="8375201">&amp;</span><span class="ident" id="8375202">row</span><span class="op" id="8375205">{</span><span class="ident" id="8375206">cols</span><span class="op" id="8375210">:</span>&nbsp;<span class="ident" id="8375212">cols</span><span class="op" id="8375216">}</span><span class="op" id="8375217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375220">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375223">return</span>&nbsp;<span class="ident" id="8375230">driver</span><span class="op" id="8375236">.</span><span class="ident" id="8375237">RowsAffected</span><span class="op" id="8375249">(</span><span class="num" id="8375250">1</span><span class="op" id="8375251">)</span><span class="op" id="8375252">,</span>&nbsp;<span class="ident" id="8375254">nil</span><br>
<span class="lineno"></span><span class="op" id="8375258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8375261">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="8375300">var</span>&nbsp;<span class="ident" id="8375304">hookQueryBadConn</span>&nbsp;<span class="keyword" id="8375321">func</span><span class="op" id="8375325">(</span><span class="op" id="8375326">)</span>&nbsp;<span class="builtintype" id="8375328">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="8375334">func</span>&nbsp;<span class="op" id="8375339">(</span><span class="ident" id="8375340">s</span>&nbsp;<span class="op" id="8375342">*</span><span class="ident" id="8375343">fakeStmt</span><span class="op" id="8375351">)</span>&nbsp;<span class="ident" id="8375353">Query</span><span class="op" id="8375358">(</span><span class="ident" id="8375359">args</span>&nbsp;<span class="op" id="8375364">[</span><span class="op" id="8375365">]</span><span class="ident" id="8375366">driver</span><span class="op" id="8375372">.</span><span class="ident" id="8375373">Value</span><span class="op" id="8375378">)</span>&nbsp;<span class="op" id="8375380">(</span><span class="ident" id="8375381">driver</span><span class="op" id="8375387">.</span><span class="ident" id="8375388">Rows</span><span class="op" id="8375392">,</span>&nbsp;<span class="builtintype" id="8375394">error</span><span class="op" id="8375399">)</span>&nbsp;<span class="op" id="8375401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375404">if</span>&nbsp;<span class="ident" id="8375407">s</span><span class="op" id="8375408">.</span><span class="ident" id="8375409">closed</span>&nbsp;<span class="op" id="8375416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375420">return</span>&nbsp;<span class="ident" id="8375427">nil</span><span class="op" id="8375430">,</span>&nbsp;<span class="ident" id="8375432">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375443">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375447">if</span>&nbsp;<span class="ident" id="8375450">hookQueryBadConn</span>&nbsp;<span class="op" id="8375467">!=</span>&nbsp;<span class="ident" id="8375470">nil</span>&nbsp;<span class="op" id="8375474">&amp;&amp;</span>&nbsp;<span class="ident" id="8375477">hookQueryBadConn</span><span class="op" id="8375493">(</span><span class="op" id="8375494">)</span>&nbsp;<span class="op" id="8375496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375500">return</span>&nbsp;<span class="ident" id="8375507">nil</span><span class="op" id="8375510">,</span>&nbsp;<span class="ident" id="8375512">driver</span><span class="op" id="8375518">.</span><span class="ident" id="8375519">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375535">err</span>&nbsp;<span class="op" id="8375539">:=</span>&nbsp;<span class="ident" id="8375542">checkSubsetTypes</span><span class="op" id="8375558">(</span><span class="ident" id="8375559">args</span><span class="op" id="8375563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375566">if</span>&nbsp;<span class="ident" id="8375569">err</span>&nbsp;<span class="op" id="8375573">!=</span>&nbsp;<span class="ident" id="8375576">nil</span>&nbsp;<span class="op" id="8375580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375584">return</span>&nbsp;<span class="ident" id="8375591">nil</span><span class="op" id="8375594">,</span>&nbsp;<span class="ident" id="8375596">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375605">db</span>&nbsp;<span class="op" id="8375608">:=</span>&nbsp;<span class="ident" id="8375611">s</span><span class="op" id="8375612">.</span><span class="ident" id="8375613">c</span><span class="op" id="8375614">.</span><span class="ident" id="8375615">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375619">if</span>&nbsp;<span class="builtinfunc" id="8375622">len</span><span class="op" id="8375625">(</span><span class="ident" id="8375626">args</span><span class="op" id="8375630">)</span>&nbsp;<span class="op" id="8375632">!=</span>&nbsp;<span class="ident" id="8375635">s</span><span class="op" id="8375636">.</span><span class="ident" id="8375637">placeholders</span>&nbsp;<span class="op" id="8375650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8375654">panic</span><span class="op" id="8375659">(</span><span class="string" id="8375660">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="8375718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375725">db</span><span class="op" id="8375727">.</span><span class="ident" id="8375728">mu</span><span class="op" id="8375730">.</span><span class="ident" id="8375731">Lock</span><span class="op" id="8375735">(</span><span class="op" id="8375736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375739">t</span><span class="op" id="8375740">,</span>&nbsp;<span class="ident" id="8375742">ok</span>&nbsp;<span class="op" id="8375745">:=</span>&nbsp;<span class="ident" id="8375748">db</span><span class="op" id="8375750">.</span><span class="ident" id="8375751">table</span><span class="op" id="8375756">(</span><span class="ident" id="8375757">s</span><span class="op" id="8375758">.</span><span class="ident" id="8375759">table</span><span class="op" id="8375764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8375767">db</span><span class="op" id="8375769">.</span><span class="ident" id="8375770">mu</span><span class="op" id="8375772">.</span><span class="ident" id="8375773">Unlock</span><span class="op" id="8375779">(</span><span class="op" id="8375780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375783">if</span>&nbsp;<span class="op" id="8375786">!</span><span class="ident" id="8375787">ok</span>&nbsp;<span class="op" id="8375790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375794">return</span>&nbsp;<span class="ident" id="8375801">nil</span><span class="op" id="8375804">,</span>&nbsp;<span class="ident" id="8375806">fmt</span><span class="op" id="8375809">.</span><span class="ident" id="8375810">Errorf</span><span class="op" id="8375816">(</span><span class="string" id="8375817">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="8375849">,</span>&nbsp;<span class="ident" id="8375851">s</span><span class="op" id="8375852">.</span><span class="ident" id="8375853">table</span><span class="op" id="8375858">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8375861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375865">if</span>&nbsp;<span class="ident" id="8375868">s</span><span class="op" id="8375869">.</span><span class="ident" id="8375870">table</span>&nbsp;<span class="op" id="8375876">==</span>&nbsp;<span class="string" id="8375879">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8375892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375896">if</span>&nbsp;<span class="builtinfunc" id="8375899">len</span><span class="op" id="8375902">(</span><span class="ident" id="8375903">s</span><span class="op" id="8375904">.</span><span class="ident" id="8375905">whereCol</span><span class="op" id="8375913">)</span>&nbsp;<span class="op" id="8375915">==</span>&nbsp;<span class="num" id="8375918">2</span>&nbsp;<span class="op" id="8375920">&amp;&amp;</span>&nbsp;<span class="ident" id="8375923">s</span><span class="op" id="8375924">.</span><span class="ident" id="8375925">whereCol</span><span class="op" id="8375933">[</span><span class="num" id="8375934">0</span><span class="op" id="8375935">]</span>&nbsp;<span class="op" id="8375937">==</span>&nbsp;<span class="string" id="8375940">&#34;op&#34;</span>&nbsp;<span class="op" id="8375945">&amp;&amp;</span>&nbsp;<span class="ident" id="8375948">s</span><span class="op" id="8375949">.</span><span class="ident" id="8375950">whereCol</span><span class="op" id="8375958">[</span><span class="num" id="8375959">1</span><span class="op" id="8375960">]</span>&nbsp;<span class="op" id="8375962">==</span>&nbsp;<span class="string" id="8375965">&#34;millis&#34;</span>&nbsp;<span class="op" id="8375974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8375979">if</span>&nbsp;<span class="ident" id="8375982">args</span><span class="op" id="8375986">[</span><span class="num" id="8375987">0</span><span class="op" id="8375988">]</span>&nbsp;<span class="op" id="8375990">==</span>&nbsp;<span class="string" id="8375993">&#34;sleep&#34;</span>&nbsp;<span class="op" id="8376001">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376007">time</span><span class="op" id="8376011">.</span><span class="ident" id="8376012">Sleep</span><span class="op" id="8376017">(</span><span class="ident" id="8376018">time</span><span class="op" id="8376022">.</span><span class="ident" id="8376023">Duration</span><span class="op" id="8376031">(</span><span class="ident" id="8376032">args</span><span class="op" id="8376036">[</span><span class="num" id="8376037">1</span><span class="op" id="8376038">]</span><span class="op" id="8376039">.</span><span class="op" id="8376040">(</span><span class="ident" id="8376041">int64</span><span class="op" id="8376046">)</span><span class="op" id="8376047">)</span>&nbsp;<span class="op" id="8376049">*</span>&nbsp;<span class="ident" id="8376051">time</span><span class="op" id="8376055">.</span><span class="ident" id="8376056">Millisecond</span><span class="op" id="8376067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376083">t</span><span class="op" id="8376084">.</span><span class="ident" id="8376085">mu</span><span class="op" id="8376087">.</span><span class="ident" id="8376088">Lock</span><span class="op" id="8376092">(</span><span class="op" id="8376093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376096">defer</span>&nbsp;<span class="ident" id="8376102">t</span><span class="op" id="8376103">.</span><span class="ident" id="8376104">mu</span><span class="op" id="8376106">.</span><span class="ident" id="8376107">Unlock</span><span class="op" id="8376113">(</span><span class="op" id="8376114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376118">colIdx</span>&nbsp;<span class="op" id="8376125">:=</span>&nbsp;<span class="builtinfunc" id="8376128">make</span><span class="op" id="8376132">(</span><span class="keyword" id="8376133">map</span><span class="op" id="8376136">[</span><span class="builtintype" id="8376137">string</span><span class="op" id="8376143">]</span><span class="builtintype" id="8376144">int</span><span class="op" id="8376147">)</span>&nbsp;<span class="comment" id="8376149">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376197">for</span>&nbsp;<span class="ident" id="8376201">_</span><span class="op" id="8376202">,</span>&nbsp;<span class="ident" id="8376204">name</span>&nbsp;<span class="op" id="8376209">:=</span>&nbsp;<span class="keyword" id="8376212">range</span>&nbsp;<span class="ident" id="8376218">s</span><span class="op" id="8376219">.</span><span class="ident" id="8376220">colName</span>&nbsp;<span class="op" id="8376228">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376232">idx</span>&nbsp;<span class="op" id="8376236">:=</span>&nbsp;<span class="ident" id="8376239">t</span><span class="op" id="8376240">.</span><span class="ident" id="8376241">columnIndex</span><span class="op" id="8376252">(</span><span class="ident" id="8376253">name</span><span class="op" id="8376257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376261">if</span>&nbsp;<span class="ident" id="8376264">idx</span>&nbsp;<span class="op" id="8376268">==</span>&nbsp;<span class="op" id="8376271">-</span><span class="num" id="8376272">1</span>&nbsp;<span class="op" id="8376274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376279">return</span>&nbsp;<span class="ident" id="8376286">nil</span><span class="op" id="8376289">,</span>&nbsp;<span class="ident" id="8376291">fmt</span><span class="op" id="8376294">.</span><span class="ident" id="8376295">Errorf</span><span class="op" id="8376301">(</span><span class="string" id="8376302">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="8376334">,</span>&nbsp;<span class="ident" id="8376336">name</span><span class="op" id="8376340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376348">colIdx</span><span class="op" id="8376354">[</span><span class="ident" id="8376355">name</span><span class="op" id="8376359">]</span>&nbsp;<span class="op" id="8376361">=</span>&nbsp;<span class="ident" id="8376363">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376372">mrows</span>&nbsp;<span class="op" id="8376378">:=</span>&nbsp;<span class="op" id="8376381">[</span><span class="op" id="8376382">]</span><span class="op" id="8376383">*</span><span class="ident" id="8376384">row</span><span class="op" id="8376387">{</span><span class="op" id="8376388">}</span><br>
<span class="lineno"></span><span class="ident" id="8376390">rows</span><span class="op" id="8376394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376397">for</span>&nbsp;<span class="ident" id="8376401">_</span><span class="op" id="8376402">,</span>&nbsp;<span class="ident" id="8376404">trow</span>&nbsp;<span class="op" id="8376409">:=</span>&nbsp;<span class="keyword" id="8376412">range</span>&nbsp;<span class="ident" id="8376418">t</span><span class="op" id="8376419">.</span><span class="ident" id="8376420">rows</span>&nbsp;<span class="op" id="8376425">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8376429">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8376498">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8376566">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376586">for</span>&nbsp;<span class="ident" id="8376590">widx</span><span class="op" id="8376594">,</span>&nbsp;<span class="ident" id="8376596">wcol</span>&nbsp;<span class="op" id="8376601">:=</span>&nbsp;<span class="keyword" id="8376604">range</span>&nbsp;<span class="ident" id="8376610">s</span><span class="op" id="8376611">.</span><span class="ident" id="8376612">whereCol</span>&nbsp;<span class="op" id="8376621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376626">idx</span>&nbsp;<span class="op" id="8376630">:=</span>&nbsp;<span class="ident" id="8376633">t</span><span class="op" id="8376634">.</span><span class="ident" id="8376635">columnIndex</span><span class="op" id="8376646">(</span><span class="ident" id="8376647">wcol</span><span class="op" id="8376651">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376656">if</span>&nbsp;<span class="ident" id="8376659">idx</span>&nbsp;<span class="op" id="8376663">==</span>&nbsp;<span class="op" id="8376666">-</span><span class="num" id="8376667">1</span>&nbsp;<span class="op" id="8376669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376675">return</span>&nbsp;<span class="ident" id="8376682">nil</span><span class="op" id="8376685">,</span>&nbsp;<span class="ident" id="8376687">fmt</span><span class="op" id="8376690">.</span><span class="ident" id="8376691">Errorf</span><span class="op" id="8376697">(</span><span class="string" id="8376698">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="8376734">,</span>&nbsp;<span class="ident" id="8376736">wcol</span><span class="op" id="8376740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376750">tcol</span>&nbsp;<span class="op" id="8376755">:=</span>&nbsp;<span class="ident" id="8376758">trow</span><span class="op" id="8376762">.</span><span class="ident" id="8376763">cols</span><span class="op" id="8376767">[</span><span class="ident" id="8376768">idx</span><span class="op" id="8376771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376776">if</span>&nbsp;<span class="ident" id="8376779">bs</span><span class="op" id="8376781">,</span>&nbsp;<span class="ident" id="8376783">ok</span>&nbsp;<span class="op" id="8376786">:=</span>&nbsp;<span class="ident" id="8376789">tcol</span><span class="op" id="8376793">.</span><span class="op" id="8376794">(</span><span class="op" id="8376795">[</span><span class="op" id="8376796">]</span><span class="builtintype" id="8376797">byte</span><span class="op" id="8376801">)</span><span class="op" id="8376802">;</span>&nbsp;<span class="ident" id="8376804">ok</span>&nbsp;<span class="op" id="8376807">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8376813">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376862">tcol</span>&nbsp;<span class="op" id="8376867">=</span>&nbsp;<span class="builtintype" id="8376869">string</span><span class="op" id="8376875">(</span><span class="ident" id="8376876">bs</span><span class="op" id="8376878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376888">if</span>&nbsp;<span class="ident" id="8376891">fmt</span><span class="op" id="8376894">.</span><span class="ident" id="8376895">Sprintf</span><span class="op" id="8376902">(</span><span class="string" id="8376903">&#34;%v&#34;</span><span class="op" id="8376907">,</span>&nbsp;<span class="ident" id="8376909">tcol</span><span class="op" id="8376913">)</span>&nbsp;<span class="op" id="8376915">!=</span>&nbsp;<span class="ident" id="8376918">fmt</span><span class="op" id="8376921">.</span><span class="ident" id="8376922">Sprintf</span><span class="op" id="8376929">(</span><span class="string" id="8376930">&#34;%v&#34;</span><span class="op" id="8376934">,</span>&nbsp;<span class="ident" id="8376936">args</span><span class="op" id="8376940">[</span><span class="ident" id="8376941">widx</span><span class="op" id="8376945">]</span><span class="op" id="8376946">)</span>&nbsp;<span class="op" id="8376948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8376954">continue</span>&nbsp;<span class="ident" id="8376963">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8376975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8376979">mrow</span>&nbsp;<span class="op" id="8376984">:=</span>&nbsp;<span class="op" id="8376987">&amp;</span><span class="ident" id="8376988">row</span><span class="op" id="8376991">{</span><span class="ident" id="8376992">cols</span><span class="op" id="8376996">:</span>&nbsp;<span class="builtinfunc" id="8376998">make</span><span class="op" id="8377002">(</span><span class="op" id="8377003">[</span><span class="op" id="8377004">]</span><span class="keyword" id="8377005">interface</span><span class="op" id="8377014">{</span><span class="op" id="8377015">}</span><span class="op" id="8377016">,</span>&nbsp;<span class="builtinfunc" id="8377018">len</span><span class="op" id="8377021">(</span><span class="ident" id="8377022">s</span><span class="op" id="8377023">.</span><span class="ident" id="8377024">colName</span><span class="op" id="8377031">)</span><span class="op" id="8377032">)</span><span class="op" id="8377033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377037">for</span>&nbsp;<span class="ident" id="8377041">seli</span><span class="op" id="8377045">,</span>&nbsp;<span class="ident" id="8377047">name</span>&nbsp;<span class="op" id="8377052">:=</span>&nbsp;<span class="keyword" id="8377055">range</span>&nbsp;<span class="ident" id="8377061">s</span><span class="op" id="8377062">.</span><span class="ident" id="8377063">colName</span>&nbsp;<span class="op" id="8377071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377076">mrow</span><span class="op" id="8377080">.</span><span class="ident" id="8377081">cols</span><span class="op" id="8377085">[</span><span class="ident" id="8377086">seli</span><span class="op" id="8377090">]</span>&nbsp;<span class="op" id="8377092">=</span>&nbsp;<span class="ident" id="8377094">trow</span><span class="op" id="8377098">.</span><span class="ident" id="8377099">cols</span><span class="op" id="8377103">[</span><span class="ident" id="8377104">colIdx</span><span class="op" id="8377110">[</span><span class="ident" id="8377111">name</span><span class="op" id="8377115">]</span><span class="op" id="8377116">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8377120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377124">mrows</span>&nbsp;<span class="op" id="8377130">=</span>&nbsp;<span class="builtinfunc" id="8377132">append</span><span class="op" id="8377138">(</span><span class="ident" id="8377139">mrows</span><span class="op" id="8377144">,</span>&nbsp;<span class="ident" id="8377146">mrow</span><span class="op" id="8377150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8377153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377157">cursor</span>&nbsp;<span class="op" id="8377164">:=</span>&nbsp;<span class="op" id="8377167">&amp;</span><span class="ident" id="8377168">rowsCursor</span><span class="op" id="8377178">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377182">pos</span><span class="op" id="8377185">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8377190">-</span><span class="num" id="8377191">1</span><span class="op" id="8377192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377196">rows</span><span class="op" id="8377200">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8377204">mrows</span><span class="op" id="8377209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377213">cols</span><span class="op" id="8377217">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8377221">s</span><span class="op" id="8377222">.</span><span class="ident" id="8377223">colName</span><span class="op" id="8377230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377234">errPos</span><span class="op" id="8377240">:</span>&nbsp;<span class="op" id="8377242">-</span><span class="num" id="8377243">1</span><span class="op" id="8377244">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8377247">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377250">return</span>&nbsp;<span class="ident" id="8377257">cursor</span><span class="op" id="8377263">,</span>&nbsp;<span class="ident" id="8377265">nil</span><br>
<span class="lineno"></span><span class="op" id="8377269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377272">func</span>&nbsp;<span class="op" id="8377277">(</span><span class="ident" id="8377278">s</span>&nbsp;<span class="op" id="8377280">*</span><span class="ident" id="8377281">fakeStmt</span><span class="op" id="8377289">)</span>&nbsp;<span class="ident" id="8377291">NumInput</span><span class="op" id="8377299">(</span><span class="op" id="8377300">)</span>&nbsp;<span class="builtintype" id="8377302">int</span>&nbsp;<span class="op" id="8377306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377309">return</span>&nbsp;<span class="ident" id="8377316">s</span><span class="op" id="8377317">.</span><span class="ident" id="8377318">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="8377331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377334">func</span>&nbsp;<span class="op" id="8377339">(</span><span class="ident" id="8377340">tx</span>&nbsp;<span class="op" id="8377343">*</span><span class="ident" id="8377344">fakeTx</span><span class="op" id="8377350">)</span>&nbsp;<span class="ident" id="8377352">Commit</span><span class="op" id="8377358">(</span><span class="op" id="8377359">)</span>&nbsp;<span class="builtintype" id="8377361">error</span>&nbsp;<span class="op" id="8377367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377370">tx</span><span class="op" id="8377372">.</span><span class="ident" id="8377373">c</span><span class="op" id="8377374">.</span><span class="ident" id="8377375">currTx</span>&nbsp;<span class="op" id="8377382">=</span>&nbsp;<span class="ident" id="8377384">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377389">return</span>&nbsp;<span class="ident" id="8377396">nil</span><br>
<span class="lineno">700</span><span class="op" id="8377400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377403">func</span>&nbsp;<span class="op" id="8377408">(</span><span class="ident" id="8377409">tx</span>&nbsp;<span class="op" id="8377412">*</span><span class="ident" id="8377413">fakeTx</span><span class="op" id="8377419">)</span>&nbsp;<span class="ident" id="8377421">Rollback</span><span class="op" id="8377429">(</span><span class="op" id="8377430">)</span>&nbsp;<span class="builtintype" id="8377432">error</span>&nbsp;<span class="op" id="8377438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377441">tx</span><span class="op" id="8377443">.</span><span class="ident" id="8377444">c</span><span class="op" id="8377445">.</span><span class="ident" id="8377446">currTx</span>&nbsp;<span class="op" id="8377453">=</span>&nbsp;<span class="ident" id="8377455">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377460">return</span>&nbsp;<span class="ident" id="8377467">nil</span><br>
<span class="lineno">705</span><span class="op" id="8377471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377474">type</span>&nbsp;<span class="ident" id="8377479">rowsCursor</span>&nbsp;<span class="keyword" id="8377490">struct</span>&nbsp;<span class="op" id="8377497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377500">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8377507">[</span><span class="op" id="8377508">]</span><span class="builtintype" id="8377509">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377517">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8377524">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377529">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8377536">[</span><span class="op" id="8377537">]</span><span class="op" id="8377538">*</span><span class="ident" id="8377539">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377544">closed</span>&nbsp;<span class="builtintype" id="8377551">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8377558">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377622">errPos</span>&nbsp;<span class="builtintype" id="8377629">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377634">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8377641">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8377649">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8377710">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8377770">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377819">bytesClone</span>&nbsp;<span class="keyword" id="8377830">map</span><span class="op" id="8377833">[</span><span class="op" id="8377834">*</span><span class="builtintype" id="8377835">byte</span><span class="op" id="8377839">]</span><span class="op" id="8377840">[</span><span class="op" id="8377841">]</span><span class="builtintype" id="8377842">byte</span><br>
<span class="lineno"></span><span class="op" id="8377847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8377850">func</span>&nbsp;<span class="op" id="8377855">(</span><span class="ident" id="8377856">rc</span>&nbsp;<span class="op" id="8377859">*</span><span class="ident" id="8377860">rowsCursor</span><span class="op" id="8377870">)</span>&nbsp;<span class="ident" id="8377872">Close</span><span class="op" id="8377877">(</span><span class="op" id="8377878">)</span>&nbsp;<span class="builtintype" id="8377880">error</span>&nbsp;<span class="op" id="8377886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377889">if</span>&nbsp;<span class="op" id="8377892">!</span><span class="ident" id="8377893">rc</span><span class="op" id="8377895">.</span><span class="ident" id="8377896">closed</span>&nbsp;<span class="op" id="8377903">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8377907">for</span>&nbsp;<span class="ident" id="8377911">_</span><span class="op" id="8377912">,</span>&nbsp;<span class="ident" id="8377914">bs</span>&nbsp;<span class="op" id="8377917">:=</span>&nbsp;<span class="keyword" id="8377920">range</span>&nbsp;<span class="ident" id="8377926">rc</span><span class="op" id="8377928">.</span><span class="ident" id="8377929">bytesClone</span>&nbsp;<span class="op" id="8377940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377945">bs</span><span class="op" id="8377947">[</span><span class="num" id="8377948">0</span><span class="op" id="8377949">]</span>&nbsp;<span class="op" id="8377951">=</span>&nbsp;<span class="num" id="8377953">255</span>&nbsp;<span class="comment" id="8377957">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8377983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8377986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8377989">rc</span><span class="op" id="8377991">.</span><span class="ident" id="8377992">closed</span>&nbsp;<span class="op" id="8377999">=</span>&nbsp;<span class="builtintype" id="8378001">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378007">return</span>&nbsp;<span class="ident" id="8378014">nil</span><br>
<span class="lineno"></span><span class="op" id="8378018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8378021">func</span>&nbsp;<span class="op" id="8378026">(</span><span class="ident" id="8378027">rc</span>&nbsp;<span class="op" id="8378030">*</span><span class="ident" id="8378031">rowsCursor</span><span class="op" id="8378041">)</span>&nbsp;<span class="ident" id="8378043">Columns</span><span class="op" id="8378050">(</span><span class="op" id="8378051">)</span>&nbsp;<span class="op" id="8378053">[</span><span class="op" id="8378054">]</span><span class="builtintype" id="8378055">string</span>&nbsp;<span class="op" id="8378062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378065">return</span>&nbsp;<span class="ident" id="8378072">rc</span><span class="op" id="8378074">.</span><span class="ident" id="8378075">cols</span><br>
<span class="lineno">735</span><span class="op" id="8378080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8378083">var</span>&nbsp;<span class="ident" id="8378087">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="8378106">func</span><span class="op" id="8378110">(</span><span class="ident" id="8378111">dest</span>&nbsp;<span class="op" id="8378116">[</span><span class="op" id="8378117">]</span><span class="ident" id="8378118">driver</span><span class="op" id="8378124">.</span><span class="ident" id="8378125">Value</span><span class="op" id="8378130">)</span>&nbsp;<span class="builtintype" id="8378132">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8378139">func</span>&nbsp;<span class="op" id="8378144">(</span><span class="ident" id="8378145">rc</span>&nbsp;<span class="op" id="8378148">*</span><span class="ident" id="8378149">rowsCursor</span><span class="op" id="8378159">)</span>&nbsp;<span class="ident" id="8378161">Next</span><span class="op" id="8378165">(</span><span class="ident" id="8378166">dest</span>&nbsp;<span class="op" id="8378171">[</span><span class="op" id="8378172">]</span><span class="ident" id="8378173">driver</span><span class="op" id="8378179">.</span><span class="ident" id="8378180">Value</span><span class="op" id="8378185">)</span>&nbsp;<span class="builtintype" id="8378187">error</span>&nbsp;<span class="op" id="8378193">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378196">if</span>&nbsp;<span class="ident" id="8378199">rowsCursorNextHook</span>&nbsp;<span class="op" id="8378218">!=</span>&nbsp;<span class="ident" id="8378221">nil</span>&nbsp;<span class="op" id="8378225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378229">return</span>&nbsp;<span class="ident" id="8378236">rowsCursorNextHook</span><span class="op" id="8378254">(</span><span class="ident" id="8378255">dest</span><span class="op" id="8378259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8378262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378266">if</span>&nbsp;<span class="ident" id="8378269">rc</span><span class="op" id="8378271">.</span><span class="ident" id="8378272">closed</span>&nbsp;<span class="op" id="8378279">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378283">return</span>&nbsp;<span class="ident" id="8378290">errors</span><span class="op" id="8378296">.</span><span class="ident" id="8378297">New</span><span class="op" id="8378300">(</span><span class="string" id="8378301">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="8378327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8378330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8378333">rc</span><span class="op" id="8378335">.</span><span class="ident" id="8378336">pos</span><span class="op" id="8378339">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378343">if</span>&nbsp;<span class="ident" id="8378346">rc</span><span class="op" id="8378348">.</span><span class="ident" id="8378349">pos</span>&nbsp;<span class="op" id="8378353">==</span>&nbsp;<span class="ident" id="8378356">rc</span><span class="op" id="8378358">.</span><span class="ident" id="8378359">errPos</span>&nbsp;<span class="op" id="8378366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378370">return</span>&nbsp;<span class="ident" id="8378377">rc</span><span class="op" id="8378379">.</span><span class="ident" id="8378380">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8378385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378388">if</span>&nbsp;<span class="ident" id="8378391">rc</span><span class="op" id="8378393">.</span><span class="ident" id="8378394">pos</span>&nbsp;<span class="op" id="8378398">&gt;=</span>&nbsp;<span class="builtinfunc" id="8378401">len</span><span class="op" id="8378404">(</span><span class="ident" id="8378405">rc</span><span class="op" id="8378407">.</span><span class="ident" id="8378408">rows</span><span class="op" id="8378412">)</span>&nbsp;<span class="op" id="8378414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378418">return</span>&nbsp;<span class="ident" id="8378425">io</span><span class="op" id="8378427">.</span><span class="ident" id="8378428">EOF</span>&nbsp;<span class="comment" id="8378432">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8378455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378458">for</span>&nbsp;<span class="ident" id="8378462">i</span><span class="op" id="8378463">,</span>&nbsp;<span class="ident" id="8378465">v</span>&nbsp;<span class="op" id="8378467">:=</span>&nbsp;<span class="keyword" id="8378470">range</span>&nbsp;<span class="ident" id="8378476">rc</span><span class="op" id="8378478">.</span><span class="ident" id="8378479">rows</span><span class="op" id="8378483">[</span><span class="ident" id="8378484">rc</span><span class="op" id="8378486">.</span><span class="ident" id="8378487">pos</span><span class="op" id="8378490">]</span><span class="op" id="8378491">.</span><span class="ident" id="8378492">cols</span>&nbsp;<span class="op" id="8378497">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378501">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378555">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378607">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378665">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378720">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8378774">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8378829">dest</span><span class="op" id="8378833">[</span><span class="ident" id="8378834">i</span><span class="op" id="8378835">]</span>&nbsp;<span class="op" id="8378837">=</span>&nbsp;<span class="ident" id="8378839">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378844">if</span>&nbsp;<span class="ident" id="8378847">bs</span><span class="op" id="8378849">,</span>&nbsp;<span class="ident" id="8378851">ok</span>&nbsp;<span class="op" id="8378854">:=</span>&nbsp;<span class="ident" id="8378857">v</span><span class="op" id="8378858">.</span><span class="op" id="8378859">(</span><span class="op" id="8378860">[</span><span class="op" id="8378861">]</span><span class="builtintype" id="8378862">byte</span><span class="op" id="8378866">)</span><span class="op" id="8378867">;</span>&nbsp;<span class="ident" id="8378869">ok</span>&nbsp;<span class="op" id="8378872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378877">if</span>&nbsp;<span class="ident" id="8378880">rc</span><span class="op" id="8378882">.</span><span class="ident" id="8378883">bytesClone</span>&nbsp;<span class="op" id="8378894">==</span>&nbsp;<span class="ident" id="8378897">nil</span>&nbsp;<span class="op" id="8378901">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8378907">rc</span><span class="op" id="8378909">.</span><span class="ident" id="8378910">bytesClone</span>&nbsp;<span class="op" id="8378921">=</span>&nbsp;<span class="builtinfunc" id="8378923">make</span><span class="op" id="8378927">(</span><span class="keyword" id="8378928">map</span><span class="op" id="8378931">[</span><span class="op" id="8378932">*</span><span class="builtintype" id="8378933">byte</span><span class="op" id="8378937">]</span><span class="op" id="8378938">[</span><span class="op" id="8378939">]</span><span class="builtintype" id="8378940">byte</span><span class="op" id="8378944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8378949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8378954">clone</span><span class="op" id="8378959">,</span>&nbsp;<span class="ident" id="8378961">ok</span>&nbsp;<span class="op" id="8378964">:=</span>&nbsp;<span class="ident" id="8378967">rc</span><span class="op" id="8378969">.</span><span class="ident" id="8378970">bytesClone</span><span class="op" id="8378980">[</span><span class="op" id="8378981">&amp;</span><span class="ident" id="8378982">bs</span><span class="op" id="8378984">[</span><span class="num" id="8378985">0</span><span class="op" id="8378986">]</span><span class="op" id="8378987">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8378992">if</span>&nbsp;<span class="op" id="8378995">!</span><span class="ident" id="8378996">ok</span>&nbsp;<span class="op" id="8378999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8379005">clone</span>&nbsp;<span class="op" id="8379011">=</span>&nbsp;<span class="builtinfunc" id="8379013">make</span><span class="op" id="8379017">(</span><span class="op" id="8379018">[</span><span class="op" id="8379019">]</span><span class="builtintype" id="8379020">byte</span><span class="op" id="8379024">,</span>&nbsp;<span class="builtinfunc" id="8379026">len</span><span class="op" id="8379029">(</span><span class="ident" id="8379030">bs</span><span class="op" id="8379032">)</span><span class="op" id="8379033">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8379039">copy</span><span class="op" id="8379043">(</span><span class="ident" id="8379044">clone</span><span class="op" id="8379049">,</span>&nbsp;<span class="ident" id="8379051">bs</span><span class="op" id="8379053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8379059">rc</span><span class="op" id="8379061">.</span><span class="ident" id="8379062">bytesClone</span><span class="op" id="8379072">[</span><span class="op" id="8379073">&amp;</span><span class="ident" id="8379074">bs</span><span class="op" id="8379076">[</span><span class="num" id="8379077">0</span><span class="op" id="8379078">]</span><span class="op" id="8379079">]</span>&nbsp;<span class="op" id="8379081">=</span>&nbsp;<span class="ident" id="8379083">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8379092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8379097">dest</span><span class="op" id="8379101">[</span><span class="ident" id="8379102">i</span><span class="op" id="8379103">]</span>&nbsp;<span class="op" id="8379105">=</span>&nbsp;<span class="ident" id="8379107">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8379115">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8379118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379121">return</span>&nbsp;<span class="ident" id="8379128">nil</span><br>
<span class="lineno"></span><span class="op" id="8379132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8379135">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="8379206">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="8379232">//</span><br>
<span class="lineno"></span><span class="comment" id="8379235">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="8379298">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8379363">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="8379397">//</span><br>
<span class="lineno"></span><span class="keyword" id="8379400">type</span>&nbsp;<span class="ident" id="8379405">fakeDriverString</span>&nbsp;<span class="keyword" id="8379422">struct</span><span class="op" id="8379428">{</span><span class="op" id="8379429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8379432">func</span>&nbsp;<span class="op" id="8379437">(</span><span class="ident" id="8379438">fakeDriverString</span><span class="op" id="8379454">)</span>&nbsp;<span class="ident" id="8379456">ConvertValue</span><span class="op" id="8379468">(</span><span class="ident" id="8379469">v</span>&nbsp;<span class="keyword" id="8379471">interface</span><span class="op" id="8379480">{</span><span class="op" id="8379481">}</span><span class="op" id="8379482">)</span>&nbsp;<span class="op" id="8379484">(</span><span class="ident" id="8379485">driver</span><span class="op" id="8379491">.</span><span class="ident" id="8379492">Value</span><span class="op" id="8379497">,</span>&nbsp;<span class="builtintype" id="8379499">error</span><span class="op" id="8379504">)</span>&nbsp;<span class="op" id="8379506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379509">switch</span>&nbsp;<span class="ident" id="8379516">c</span>&nbsp;<span class="op" id="8379518">:=</span>&nbsp;<span class="ident" id="8379521">v</span><span class="op" id="8379522">.</span><span class="op" id="8379523">(</span><span class="keyword" id="8379524">type</span><span class="op" id="8379528">)</span>&nbsp;<span class="op" id="8379530">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379533">case</span>&nbsp;<span class="builtintype" id="8379538">string</span><span class="op" id="8379544">,</span>&nbsp;<span class="op" id="8379546">[</span><span class="op" id="8379547">]</span><span class="builtintype" id="8379548">byte</span><span class="op" id="8379552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379556">return</span>&nbsp;<span class="ident" id="8379563">v</span><span class="op" id="8379564">,</span>&nbsp;<span class="ident" id="8379566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379571">case</span>&nbsp;<span class="op" id="8379576">*</span><span class="builtintype" id="8379577">string</span><span class="op" id="8379583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379587">if</span>&nbsp;<span class="ident" id="8379590">c</span>&nbsp;<span class="op" id="8379592">==</span>&nbsp;<span class="ident" id="8379595">nil</span>&nbsp;<span class="op" id="8379599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379604">return</span>&nbsp;<span class="ident" id="8379611">nil</span><span class="op" id="8379614">,</span>&nbsp;<span class="ident" id="8379616">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8379622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379626">return</span>&nbsp;<span class="op" id="8379633">*</span><span class="ident" id="8379634">c</span><span class="op" id="8379635">,</span>&nbsp;<span class="ident" id="8379637">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8379642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379645">return</span>&nbsp;<span class="ident" id="8379652">fmt</span><span class="op" id="8379655">.</span><span class="ident" id="8379656">Sprintf</span><span class="op" id="8379663">(</span><span class="string" id="8379664">&#34;%v&#34;</span><span class="op" id="8379668">,</span>&nbsp;<span class="ident" id="8379670">v</span><span class="op" id="8379671">)</span><span class="op" id="8379672">,</span>&nbsp;<span class="ident" id="8379674">nil</span><br>
<span class="lineno"></span><span class="op" id="8379678">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="8379681">func</span>&nbsp;<span class="ident" id="8379686">converterForType</span><span class="op" id="8379702">(</span><span class="ident" id="8379703">typ</span>&nbsp;<span class="builtintype" id="8379707">string</span><span class="op" id="8379713">)</span>&nbsp;<span class="ident" id="8379715">driver</span><span class="op" id="8379721">.</span><span class="ident" id="8379722">ValueConverter</span>&nbsp;<span class="op" id="8379737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379740">switch</span>&nbsp;<span class="ident" id="8379747">typ</span>&nbsp;<span class="op" id="8379751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379754">case</span>&nbsp;<span class="string" id="8379759">&#34;bool&#34;</span><span class="op" id="8379765">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379769">return</span>&nbsp;<span class="ident" id="8379776">driver</span><span class="op" id="8379782">.</span><span class="ident" id="8379783">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379789">case</span>&nbsp;<span class="string" id="8379794">&#34;nullbool&#34;</span><span class="op" id="8379804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379808">return</span>&nbsp;<span class="ident" id="8379815">driver</span><span class="op" id="8379821">.</span><span class="ident" id="8379822">Null</span><span class="op" id="8379826">{</span><span class="ident" id="8379827">Converter</span><span class="op" id="8379836">:</span>&nbsp;<span class="ident" id="8379838">driver</span><span class="op" id="8379844">.</span><span class="ident" id="8379845">Bool</span><span class="op" id="8379849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379852">case</span>&nbsp;<span class="string" id="8379857">&#34;int32&#34;</span><span class="op" id="8379864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379868">return</span>&nbsp;<span class="ident" id="8379875">driver</span><span class="op" id="8379881">.</span><span class="ident" id="8379882">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379889">case</span>&nbsp;<span class="string" id="8379894">&#34;string&#34;</span><span class="op" id="8379902">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379906">return</span>&nbsp;<span class="ident" id="8379913">driver</span><span class="op" id="8379919">.</span><span class="ident" id="8379920">NotNull</span><span class="op" id="8379927">{</span><span class="ident" id="8379928">Converter</span><span class="op" id="8379937">:</span>&nbsp;<span class="ident" id="8379939">fakeDriverString</span><span class="op" id="8379955">{</span><span class="op" id="8379956">}</span><span class="op" id="8379957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379960">case</span>&nbsp;<span class="string" id="8379965">&#34;nullstring&#34;</span><span class="op" id="8379977">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8379981">return</span>&nbsp;<span class="ident" id="8379988">driver</span><span class="op" id="8379994">.</span><span class="ident" id="8379995">Null</span><span class="op" id="8379999">{</span><span class="ident" id="8380000">Converter</span><span class="op" id="8380009">:</span>&nbsp;<span class="ident" id="8380011">fakeDriverString</span><span class="op" id="8380027">{</span><span class="op" id="8380028">}</span><span class="op" id="8380029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380032">case</span>&nbsp;<span class="string" id="8380037">&#34;int64&#34;</span><span class="op" id="8380044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8380048">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380100">return</span>&nbsp;<span class="ident" id="8380107">driver</span><span class="op" id="8380113">.</span><span class="ident" id="8380114">NotNull</span><span class="op" id="8380121">{</span><span class="ident" id="8380122">Converter</span><span class="op" id="8380131">:</span>&nbsp;<span class="ident" id="8380133">driver</span><span class="op" id="8380139">.</span><span class="ident" id="8380140">DefaultParameterConverter</span><span class="op" id="8380165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380168">case</span>&nbsp;<span class="string" id="8380173">&#34;nullint64&#34;</span><span class="op" id="8380184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8380188">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380240">return</span>&nbsp;<span class="ident" id="8380247">driver</span><span class="op" id="8380253">.</span><span class="ident" id="8380254">Null</span><span class="op" id="8380258">{</span><span class="ident" id="8380259">Converter</span><span class="op" id="8380268">:</span>&nbsp;<span class="ident" id="8380270">driver</span><span class="op" id="8380276">.</span><span class="ident" id="8380277">DefaultParameterConverter</span><span class="op" id="8380302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380305">case</span>&nbsp;<span class="string" id="8380310">&#34;float64&#34;</span><span class="op" id="8380319">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8380323">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380375">return</span>&nbsp;<span class="ident" id="8380382">driver</span><span class="op" id="8380388">.</span><span class="ident" id="8380389">NotNull</span><span class="op" id="8380396">{</span><span class="ident" id="8380397">Converter</span><span class="op" id="8380406">:</span>&nbsp;<span class="ident" id="8380408">driver</span><span class="op" id="8380414">.</span><span class="ident" id="8380415">DefaultParameterConverter</span><span class="op" id="8380440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380443">case</span>&nbsp;<span class="string" id="8380448">&#34;nullfloat64&#34;</span><span class="op" id="8380461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8380465">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380517">return</span>&nbsp;<span class="ident" id="8380524">driver</span><span class="op" id="8380530">.</span><span class="ident" id="8380531">Null</span><span class="op" id="8380535">{</span><span class="ident" id="8380536">Converter</span><span class="op" id="8380545">:</span>&nbsp;<span class="ident" id="8380547">driver</span><span class="op" id="8380553">.</span><span class="ident" id="8380554">DefaultParameterConverter</span><span class="op" id="8380579">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380582">case</span>&nbsp;<span class="string" id="8380587">&#34;datetime&#34;</span><span class="op" id="8380597">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8380601">return</span>&nbsp;<span class="ident" id="8380608">driver</span><span class="op" id="8380614">.</span><span class="ident" id="8380615">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8380642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8380645">panic</span><span class="op" id="8380650">(</span><span class="string" id="8380651">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="8380684">+</span>&nbsp;<span class="ident" id="8380686">typ</span><span class="op" id="8380689">)</span><br>
<span class="lineno"></span><span class="op" id="8380691">}</span>
</div>
</body>
</html>
