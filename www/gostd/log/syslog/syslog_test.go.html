<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6931610">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6931665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6931719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6931770">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6931803">package</span>&nbsp;<span class="ident" id="6931811">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6931819">import</span>&nbsp;<span class="op" id="6931826">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931829">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931838">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931845">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931851">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931864">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931871">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931878">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931884">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931892">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6931903">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6931910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6931913">func</span>&nbsp;<span class="ident" id="6931918">runPktSyslog</span><span class="op" id="6931930">(</span><span class="ident" id="6931931">c</span>&nbsp;<span class="ident" id="6931933">net</span><span class="op" id="6931936">.</span><span class="ident" id="6931937">PacketConn</span><span class="op" id="6931947">,</span>&nbsp;<span class="ident" id="6931949">done</span>&nbsp;<span class="keyword" id="6931954">chan</span><span class="op" id="6931958">&lt;-</span>&nbsp;<span class="builtintype" id="6931961">string</span><span class="op" id="6931967">)</span>&nbsp;<span class="op" id="6931969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931972">var</span>&nbsp;<span class="ident" id="6931976">buf</span>&nbsp;<span class="op" id="6931980">[</span><span class="num" id="6931981">4096</span><span class="op" id="6931985">]</span><span class="builtintype" id="6931986">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6931992">var</span>&nbsp;<span class="ident" id="6931996">rcvd</span>&nbsp;<span class="builtintype" id="6932001">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932009">ct</span>&nbsp;<span class="op" id="6932012">:=</span>&nbsp;<span class="num" id="6932015">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932018">for</span>&nbsp;<span class="op" id="6932022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932026">var</span>&nbsp;<span class="ident" id="6932030">n</span>&nbsp;<span class="builtintype" id="6932032">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932038">var</span>&nbsp;<span class="ident" id="6932042">err</span>&nbsp;<span class="builtintype" id="6932046">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932055">c</span><span class="op" id="6932056">.</span><span class="ident" id="6932057">SetReadDeadline</span><span class="op" id="6932072">(</span><span class="ident" id="6932073">time</span><span class="op" id="6932077">.</span><span class="ident" id="6932078">Now</span><span class="op" id="6932081">(</span><span class="op" id="6932082">)</span><span class="op" id="6932083">.</span><span class="ident" id="6932084">Add</span><span class="op" id="6932087">(</span><span class="num" id="6932088">100</span>&nbsp;<span class="op" id="6932092">*</span>&nbsp;<span class="ident" id="6932094">time</span><span class="op" id="6932098">.</span><span class="ident" id="6932099">Millisecond</span><span class="op" id="6932110">)</span><span class="op" id="6932111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932115">n</span><span class="op" id="6932116">,</span>&nbsp;<span class="ident" id="6932118">_</span><span class="op" id="6932119">,</span>&nbsp;<span class="ident" id="6932121">err</span>&nbsp;<span class="op" id="6932125">=</span>&nbsp;<span class="ident" id="6932127">c</span><span class="op" id="6932128">.</span><span class="ident" id="6932129">ReadFrom</span><span class="op" id="6932137">(</span><span class="ident" id="6932138">buf</span><span class="op" id="6932141">[</span><span class="op" id="6932142">:</span><span class="op" id="6932143">]</span><span class="op" id="6932144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932148">rcvd</span>&nbsp;<span class="op" id="6932153">+=</span>&nbsp;<span class="builtintype" id="6932156">string</span><span class="op" id="6932162">(</span><span class="ident" id="6932163">buf</span><span class="op" id="6932166">[</span><span class="op" id="6932167">:</span><span class="ident" id="6932168">n</span><span class="op" id="6932169">]</span><span class="op" id="6932170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932174">if</span>&nbsp;<span class="ident" id="6932177">err</span>&nbsp;<span class="op" id="6932181">!=</span>&nbsp;<span class="ident" id="6932184">nil</span>&nbsp;<span class="op" id="6932188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932193">if</span>&nbsp;<span class="ident" id="6932196">oe</span><span class="op" id="6932198">,</span>&nbsp;<span class="ident" id="6932200">ok</span>&nbsp;<span class="op" id="6932203">:=</span>&nbsp;<span class="ident" id="6932206">err</span><span class="op" id="6932209">.</span><span class="op" id="6932210">(</span><span class="op" id="6932211">*</span><span class="ident" id="6932212">net</span><span class="op" id="6932215">.</span><span class="ident" id="6932216">OpError</span><span class="op" id="6932223">)</span><span class="op" id="6932224">;</span>&nbsp;<span class="ident" id="6932226">ok</span>&nbsp;<span class="op" id="6932229">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932235">if</span>&nbsp;<span class="ident" id="6932238">ct</span>&nbsp;<span class="op" id="6932241">&lt;</span>&nbsp;<span class="num" id="6932243">3</span>&nbsp;<span class="op" id="6932245">&amp;&amp;</span>&nbsp;<span class="ident" id="6932248">oe</span><span class="op" id="6932250">.</span><span class="ident" id="6932251">Temporary</span><span class="op" id="6932260">(</span><span class="op" id="6932261">)</span>&nbsp;<span class="op" id="6932263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932270">ct</span><span class="op" id="6932272">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932280">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932298">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932303">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932317">c</span><span class="op" id="6932318">.</span><span class="ident" id="6932319">Close</span><span class="op" id="6932324">(</span><span class="op" id="6932325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932328">done</span>&nbsp;<span class="op" id="6932333">&lt;-</span>&nbsp;<span class="ident" id="6932336">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="6932341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932344">var</span>&nbsp;<span class="ident" id="6932348">crashy</span>&nbsp;<span class="op" id="6932355">=</span>&nbsp;<span class="builtintype" id="6932357">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932364">func</span>&nbsp;<span class="ident" id="6932369">runStreamSyslog</span><span class="op" id="6932384">(</span><span class="ident" id="6932385">l</span>&nbsp;<span class="ident" id="6932387">net</span><span class="op" id="6932390">.</span><span class="ident" id="6932391">Listener</span><span class="op" id="6932399">,</span>&nbsp;<span class="ident" id="6932401">done</span>&nbsp;<span class="keyword" id="6932406">chan</span><span class="op" id="6932410">&lt;-</span>&nbsp;<span class="builtintype" id="6932413">string</span><span class="op" id="6932419">,</span>&nbsp;<span class="ident" id="6932421">wg</span>&nbsp;<span class="op" id="6932424">*</span><span class="ident" id="6932425">sync</span><span class="op" id="6932429">.</span><span class="ident" id="6932430">WaitGroup</span><span class="op" id="6932439">)</span>&nbsp;<span class="op" id="6932441">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932444">for</span>&nbsp;<span class="op" id="6932448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932452">var</span>&nbsp;<span class="ident" id="6932456">c</span>&nbsp;<span class="ident" id="6932458">net</span><span class="op" id="6932461">.</span><span class="ident" id="6932462">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932469">var</span>&nbsp;<span class="ident" id="6932473">err</span>&nbsp;<span class="builtintype" id="6932477">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932485">if</span>&nbsp;<span class="ident" id="6932488">c</span><span class="op" id="6932489">,</span>&nbsp;<span class="ident" id="6932491">err</span>&nbsp;<span class="op" id="6932495">=</span>&nbsp;<span class="ident" id="6932497">l</span><span class="op" id="6932498">.</span><span class="ident" id="6932499">Accept</span><span class="op" id="6932505">(</span><span class="op" id="6932506">)</span><span class="op" id="6932507">;</span>&nbsp;<span class="ident" id="6932509">err</span>&nbsp;<span class="op" id="6932513">!=</span>&nbsp;<span class="ident" id="6932516">nil</span>&nbsp;<span class="op" id="6932520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932525">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932538">wg</span><span class="op" id="6932540">.</span><span class="ident" id="6932541">Add</span><span class="op" id="6932544">(</span><span class="num" id="6932545">1</span><span class="op" id="6932546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932550">go</span>&nbsp;<span class="keyword" id="6932553">func</span><span class="op" id="6932557">(</span><span class="ident" id="6932558">c</span>&nbsp;<span class="ident" id="6932560">net</span><span class="op" id="6932563">.</span><span class="ident" id="6932564">Conn</span><span class="op" id="6932568">)</span>&nbsp;<span class="op" id="6932570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932575">defer</span>&nbsp;<span class="ident" id="6932581">wg</span><span class="op" id="6932583">.</span><span class="ident" id="6932584">Done</span><span class="op" id="6932588">(</span><span class="op" id="6932589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932594">c</span><span class="op" id="6932595">.</span><span class="ident" id="6932596">SetReadDeadline</span><span class="op" id="6932611">(</span><span class="ident" id="6932612">time</span><span class="op" id="6932616">.</span><span class="ident" id="6932617">Now</span><span class="op" id="6932620">(</span><span class="op" id="6932621">)</span><span class="op" id="6932622">.</span><span class="ident" id="6932623">Add</span><span class="op" id="6932626">(</span><span class="num" id="6932627">5</span>&nbsp;<span class="op" id="6932629">*</span>&nbsp;<span class="ident" id="6932631">time</span><span class="op" id="6932635">.</span><span class="ident" id="6932636">Second</span><span class="op" id="6932642">)</span><span class="op" id="6932643">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932648">b</span>&nbsp;<span class="op" id="6932650">:=</span>&nbsp;<span class="ident" id="6932653">bufio</span><span class="op" id="6932658">.</span><span class="ident" id="6932659">NewReader</span><span class="op" id="6932668">(</span><span class="ident" id="6932669">c</span><span class="op" id="6932670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932675">for</span>&nbsp;<span class="ident" id="6932679">ct</span>&nbsp;<span class="op" id="6932682">:=</span>&nbsp;<span class="num" id="6932685">1</span><span class="op" id="6932686">;</span>&nbsp;<span class="op" id="6932688">!</span><span class="ident" id="6932689">crashy</span>&nbsp;<span class="op" id="6932696">||</span>&nbsp;<span class="ident" id="6932699">ct</span><span class="op" id="6932701">&amp;</span><span class="num" id="6932702">7</span>&nbsp;<span class="op" id="6932704">!=</span>&nbsp;<span class="num" id="6932707">0</span><span class="op" id="6932708">;</span>&nbsp;<span class="ident" id="6932710">ct</span><span class="op" id="6932712">++</span>&nbsp;<span class="op" id="6932715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932721">s</span><span class="op" id="6932722">,</span>&nbsp;<span class="ident" id="6932724">err</span>&nbsp;<span class="op" id="6932728">:=</span>&nbsp;<span class="ident" id="6932731">b</span><span class="op" id="6932732">.</span><span class="ident" id="6932733">ReadString</span><span class="op" id="6932743">(</span><span class="string" id="6932744">&#39;\n&#39;</span><span class="op" id="6932748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932754">if</span>&nbsp;<span class="ident" id="6932757">err</span>&nbsp;<span class="op" id="6932761">!=</span>&nbsp;<span class="ident" id="6932764">nil</span>&nbsp;<span class="op" id="6932768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932775">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932791">done</span>&nbsp;<span class="op" id="6932796">&lt;-</span>&nbsp;<span class="ident" id="6932799">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932809">c</span><span class="op" id="6932810">.</span><span class="ident" id="6932811">Close</span><span class="op" id="6932816">(</span><span class="op" id="6932817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932821">}</span><span class="op" id="6932822">(</span><span class="ident" id="6932823">c</span><span class="op" id="6932824">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932827">}</span><br>
<span class="lineno"></span><span class="op" id="6932829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6932832">func</span>&nbsp;<span class="ident" id="6932837">startServer</span><span class="op" id="6932848">(</span><span class="ident" id="6932849">n</span><span class="op" id="6932850">,</span>&nbsp;<span class="ident" id="6932852">la</span>&nbsp;<span class="builtintype" id="6932855">string</span><span class="op" id="6932861">,</span>&nbsp;<span class="ident" id="6932863">done</span>&nbsp;<span class="keyword" id="6932868">chan</span><span class="op" id="6932872">&lt;-</span>&nbsp;<span class="builtintype" id="6932875">string</span><span class="op" id="6932881">)</span>&nbsp;<span class="op" id="6932883">(</span><span class="ident" id="6932884">addr</span>&nbsp;<span class="builtintype" id="6932889">string</span><span class="op" id="6932895">,</span>&nbsp;<span class="ident" id="6932897">sock</span>&nbsp;<span class="ident" id="6932902">io</span><span class="op" id="6932904">.</span><span class="ident" id="6932905">Closer</span><span class="op" id="6932911">,</span>&nbsp;<span class="ident" id="6932913">wg</span>&nbsp;<span class="op" id="6932916">*</span><span class="ident" id="6932917">sync</span><span class="op" id="6932921">.</span><span class="ident" id="6932922">WaitGroup</span><span class="op" id="6932931">)</span>&nbsp;<span class="op" id="6932933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6932936">if</span>&nbsp;<span class="ident" id="6932939">n</span>&nbsp;<span class="op" id="6932941">==</span>&nbsp;<span class="string" id="6932944">&#34;udp&#34;</span>&nbsp;<span class="op" id="6932950">||</span>&nbsp;<span class="ident" id="6932953">n</span>&nbsp;<span class="op" id="6932955">==</span>&nbsp;<span class="string" id="6932958">&#34;tcp&#34;</span>&nbsp;<span class="op" id="6932964">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6932968">la</span>&nbsp;<span class="op" id="6932971">=</span>&nbsp;<span class="string" id="6932973">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6932988">}</span>&nbsp;<span class="keyword" id="6932990">else</span>&nbsp;<span class="op" id="6932995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6932999">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933055">if</span>&nbsp;<span class="ident" id="6933058">la</span>&nbsp;<span class="op" id="6933061">==</span>&nbsp;<span class="string" id="6933064">&#34;&#34;</span>&nbsp;<span class="op" id="6933067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6933072">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933127">f</span><span class="op" id="6933128">,</span>&nbsp;<span class="ident" id="6933130">err</span>&nbsp;<span class="op" id="6933134">:=</span>&nbsp;<span class="ident" id="6933137">ioutil</span><span class="op" id="6933143">.</span><span class="ident" id="6933144">TempFile</span><span class="op" id="6933152">(</span><span class="string" id="6933153">&#34;&#34;</span><span class="op" id="6933155">,</span>&nbsp;<span class="string" id="6933157">&#34;syslogtest&#34;</span><span class="op" id="6933169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933174">if</span>&nbsp;<span class="ident" id="6933177">err</span>&nbsp;<span class="op" id="6933181">!=</span>&nbsp;<span class="ident" id="6933184">nil</span>&nbsp;<span class="op" id="6933188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933194">log</span><span class="op" id="6933197">.</span><span class="ident" id="6933198">Fatal</span><span class="op" id="6933203">(</span><span class="string" id="6933204">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="6933216">,</span>&nbsp;<span class="ident" id="6933218">err</span><span class="op" id="6933221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933231">f</span><span class="op" id="6933232">.</span><span class="ident" id="6933233">Close</span><span class="op" id="6933238">(</span><span class="op" id="6933239">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933244">la</span>&nbsp;<span class="op" id="6933247">=</span>&nbsp;<span class="ident" id="6933249">f</span><span class="op" id="6933250">.</span><span class="ident" id="6933251">Name</span><span class="op" id="6933255">(</span><span class="op" id="6933256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933264">os</span><span class="op" id="6933266">.</span><span class="ident" id="6933267">Remove</span><span class="op" id="6933273">(</span><span class="ident" id="6933274">la</span><span class="op" id="6933276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933283">wg</span>&nbsp;<span class="op" id="6933286">=</span>&nbsp;<span class="builtinfunc" id="6933288">new</span><span class="op" id="6933291">(</span><span class="ident" id="6933292">sync</span><span class="op" id="6933296">.</span><span class="ident" id="6933297">WaitGroup</span><span class="op" id="6933306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933309">if</span>&nbsp;<span class="ident" id="6933312">n</span>&nbsp;<span class="op" id="6933314">==</span>&nbsp;<span class="string" id="6933317">&#34;udp&#34;</span>&nbsp;<span class="op" id="6933323">||</span>&nbsp;<span class="ident" id="6933326">n</span>&nbsp;<span class="op" id="6933328">==</span>&nbsp;<span class="string" id="6933331">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="6933342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933346">l</span><span class="op" id="6933347">,</span>&nbsp;<span class="ident" id="6933349">e</span>&nbsp;<span class="op" id="6933351">:=</span>&nbsp;<span class="ident" id="6933354">net</span><span class="op" id="6933357">.</span><span class="ident" id="6933358">ListenPacket</span><span class="op" id="6933370">(</span><span class="ident" id="6933371">n</span><span class="op" id="6933372">,</span>&nbsp;<span class="ident" id="6933374">la</span><span class="op" id="6933376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933380">if</span>&nbsp;<span class="ident" id="6933383">e</span>&nbsp;<span class="op" id="6933385">!=</span>&nbsp;<span class="ident" id="6933388">nil</span>&nbsp;<span class="op" id="6933392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933397">log</span><span class="op" id="6933400">.</span><span class="ident" id="6933401">Fatalf</span><span class="op" id="6933407">(</span><span class="string" id="6933408">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6933432">,</span>&nbsp;<span class="ident" id="6933434">e</span><span class="op" id="6933435">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933443">addr</span>&nbsp;<span class="op" id="6933448">=</span>&nbsp;<span class="ident" id="6933450">l</span><span class="op" id="6933451">.</span><span class="ident" id="6933452">LocalAddr</span><span class="op" id="6933461">(</span><span class="op" id="6933462">)</span><span class="op" id="6933463">.</span><span class="ident" id="6933464">String</span><span class="op" id="6933470">(</span><span class="op" id="6933471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933475">sock</span>&nbsp;<span class="op" id="6933480">=</span>&nbsp;<span class="ident" id="6933482">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933486">wg</span><span class="op" id="6933488">.</span><span class="ident" id="6933489">Add</span><span class="op" id="6933492">(</span><span class="num" id="6933493">1</span><span class="op" id="6933494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933498">go</span>&nbsp;<span class="keyword" id="6933501">func</span><span class="op" id="6933505">(</span><span class="op" id="6933506">)</span>&nbsp;<span class="op" id="6933508">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933513">defer</span>&nbsp;<span class="ident" id="6933519">wg</span><span class="op" id="6933521">.</span><span class="ident" id="6933522">Done</span><span class="op" id="6933526">(</span><span class="op" id="6933527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933532">runPktSyslog</span><span class="op" id="6933544">(</span><span class="ident" id="6933545">l</span><span class="op" id="6933546">,</span>&nbsp;<span class="ident" id="6933548">done</span><span class="op" id="6933552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933556">}</span><span class="op" id="6933557">(</span><span class="op" id="6933558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933561">}</span>&nbsp;<span class="keyword" id="6933563">else</span>&nbsp;<span class="op" id="6933568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933572">l</span><span class="op" id="6933573">,</span>&nbsp;<span class="ident" id="6933575">e</span>&nbsp;<span class="op" id="6933577">:=</span>&nbsp;<span class="ident" id="6933580">net</span><span class="op" id="6933583">.</span><span class="ident" id="6933584">Listen</span><span class="op" id="6933590">(</span><span class="ident" id="6933591">n</span><span class="op" id="6933592">,</span>&nbsp;<span class="ident" id="6933594">la</span><span class="op" id="6933596">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933600">if</span>&nbsp;<span class="ident" id="6933603">e</span>&nbsp;<span class="op" id="6933605">!=</span>&nbsp;<span class="ident" id="6933608">nil</span>&nbsp;<span class="op" id="6933612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933617">log</span><span class="op" id="6933620">.</span><span class="ident" id="6933621">Fatalf</span><span class="op" id="6933627">(</span><span class="string" id="6933628">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6933652">,</span>&nbsp;<span class="ident" id="6933654">e</span><span class="op" id="6933655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933663">addr</span>&nbsp;<span class="op" id="6933668">=</span>&nbsp;<span class="ident" id="6933670">l</span><span class="op" id="6933671">.</span><span class="ident" id="6933672">Addr</span><span class="op" id="6933676">(</span><span class="op" id="6933677">)</span><span class="op" id="6933678">.</span><span class="ident" id="6933679">String</span><span class="op" id="6933685">(</span><span class="op" id="6933686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933690">sock</span>&nbsp;<span class="op" id="6933695">=</span>&nbsp;<span class="ident" id="6933697">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933701">wg</span><span class="op" id="6933703">.</span><span class="ident" id="6933704">Add</span><span class="op" id="6933707">(</span><span class="num" id="6933708">1</span><span class="op" id="6933709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933713">go</span>&nbsp;<span class="keyword" id="6933716">func</span><span class="op" id="6933720">(</span><span class="op" id="6933721">)</span>&nbsp;<span class="op" id="6933723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933728">defer</span>&nbsp;<span class="ident" id="6933734">wg</span><span class="op" id="6933736">.</span><span class="ident" id="6933737">Done</span><span class="op" id="6933741">(</span><span class="op" id="6933742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933747">runStreamSyslog</span><span class="op" id="6933762">(</span><span class="ident" id="6933763">l</span><span class="op" id="6933764">,</span>&nbsp;<span class="ident" id="6933766">done</span><span class="op" id="6933770">,</span>&nbsp;<span class="ident" id="6933772">wg</span><span class="op" id="6933774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933778">}</span><span class="op" id="6933779">(</span><span class="op" id="6933780">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6933783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933786">return</span><br>
<span class="lineno"></span><span class="op" id="6933793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6933796">func</span>&nbsp;<span class="ident" id="6933801">TestWithSimulated</span><span class="op" id="6933818">(</span><span class="ident" id="6933819">t</span>&nbsp;<span class="op" id="6933821">*</span><span class="ident" id="6933822">testing</span><span class="op" id="6933829">.</span><span class="ident" id="6933830">T</span><span class="op" id="6933831">)</span>&nbsp;<span class="op" id="6933833">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933836">msg</span>&nbsp;<span class="op" id="6933840">:=</span>&nbsp;<span class="string" id="6933843">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933855">transport</span>&nbsp;<span class="op" id="6933865">:=</span>&nbsp;<span class="op" id="6933868">[</span><span class="op" id="6933869">]</span><span class="builtintype" id="6933870">string</span><span class="op" id="6933876">{</span><span class="string" id="6933877">&#34;unix&#34;</span><span class="op" id="6933883">,</span>&nbsp;<span class="string" id="6933885">&#34;unixgram&#34;</span><span class="op" id="6933895">,</span>&nbsp;<span class="string" id="6933897">&#34;udp&#34;</span><span class="op" id="6933902">,</span>&nbsp;<span class="string" id="6933904">&#34;tcp&#34;</span><span class="op" id="6933909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6933913">for</span>&nbsp;<span class="ident" id="6933917">_</span><span class="op" id="6933918">,</span>&nbsp;<span class="ident" id="6933920">tr</span>&nbsp;<span class="op" id="6933923">:=</span>&nbsp;<span class="keyword" id="6933926">range</span>&nbsp;<span class="ident" id="6933932">transport</span>&nbsp;<span class="op" id="6933942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933946">done</span>&nbsp;<span class="op" id="6933951">:=</span>&nbsp;<span class="builtinfunc" id="6933954">make</span><span class="op" id="6933958">(</span><span class="keyword" id="6933959">chan</span>&nbsp;<span class="builtintype" id="6933964">string</span><span class="op" id="6933970">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6933974">addr</span><span class="op" id="6933978">,</span>&nbsp;<span class="ident" id="6933980">sock</span><span class="op" id="6933984">,</span>&nbsp;<span class="ident" id="6933986">srvWG</span>&nbsp;<span class="op" id="6933992">:=</span>&nbsp;<span class="ident" id="6933995">startServer</span><span class="op" id="6934006">(</span><span class="ident" id="6934007">tr</span><span class="op" id="6934009">,</span>&nbsp;<span class="string" id="6934011">&#34;&#34;</span><span class="op" id="6934013">,</span>&nbsp;<span class="ident" id="6934015">done</span><span class="op" id="6934019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934023">defer</span>&nbsp;<span class="ident" id="6934029">srvWG</span><span class="op" id="6934034">.</span><span class="ident" id="6934035">Wait</span><span class="op" id="6934039">(</span><span class="op" id="6934040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934044">defer</span>&nbsp;<span class="ident" id="6934050">sock</span><span class="op" id="6934054">.</span><span class="ident" id="6934055">Close</span><span class="op" id="6934060">(</span><span class="op" id="6934061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934065">if</span>&nbsp;<span class="ident" id="6934068">tr</span>&nbsp;<span class="op" id="6934071">==</span>&nbsp;<span class="string" id="6934074">&#34;unix&#34;</span>&nbsp;<span class="op" id="6934081">||</span>&nbsp;<span class="ident" id="6934084">tr</span>&nbsp;<span class="op" id="6934087">==</span>&nbsp;<span class="string" id="6934090">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="6934101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934106">defer</span>&nbsp;<span class="ident" id="6934112">os</span><span class="op" id="6934114">.</span><span class="ident" id="6934115">Remove</span><span class="op" id="6934121">(</span><span class="ident" id="6934122">addr</span><span class="op" id="6934126">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934134">s</span><span class="op" id="6934135">,</span>&nbsp;<span class="ident" id="6934137">err</span>&nbsp;<span class="op" id="6934141">:=</span>&nbsp;<span class="ident" id="6934144">Dial</span><span class="op" id="6934148">(</span><span class="ident" id="6934149">tr</span><span class="op" id="6934151">,</span>&nbsp;<span class="ident" id="6934153">addr</span><span class="op" id="6934157">,</span>&nbsp;<span class="ident" id="6934159">LOG_INFO</span><span class="op" id="6934167">|</span><span class="ident" id="6934168">LOG_USER</span><span class="op" id="6934176">,</span>&nbsp;<span class="string" id="6934178">&#34;syslog_test&#34;</span><span class="op" id="6934191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934195">if</span>&nbsp;<span class="ident" id="6934198">err</span>&nbsp;<span class="op" id="6934202">!=</span>&nbsp;<span class="ident" id="6934205">nil</span>&nbsp;<span class="op" id="6934209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934214">t</span><span class="op" id="6934215">.</span><span class="ident" id="6934216">Fatalf</span><span class="op" id="6934222">(</span><span class="string" id="6934223">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6934242">,</span>&nbsp;<span class="ident" id="6934244">err</span><span class="op" id="6934247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934251">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934255">err</span>&nbsp;<span class="op" id="6934259">=</span>&nbsp;<span class="ident" id="6934261">s</span><span class="op" id="6934262">.</span><span class="ident" id="6934263">Info</span><span class="op" id="6934267">(</span><span class="ident" id="6934268">msg</span><span class="op" id="6934271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934275">if</span>&nbsp;<span class="ident" id="6934278">err</span>&nbsp;<span class="op" id="6934282">!=</span>&nbsp;<span class="ident" id="6934285">nil</span>&nbsp;<span class="op" id="6934289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934294">t</span><span class="op" id="6934295">.</span><span class="ident" id="6934296">Fatalf</span><span class="op" id="6934302">(</span><span class="string" id="6934303">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6934319">,</span>&nbsp;<span class="ident" id="6934321">err</span><span class="op" id="6934324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934332">check</span><span class="op" id="6934337">(</span><span class="ident" id="6934338">t</span><span class="op" id="6934339">,</span>&nbsp;<span class="ident" id="6934341">msg</span><span class="op" id="6934344">,</span>&nbsp;<span class="op" id="6934346">&lt;-</span><span class="ident" id="6934348">done</span><span class="op" id="6934352">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934356">s</span><span class="op" id="6934357">.</span><span class="ident" id="6934358">Close</span><span class="op" id="6934363">(</span><span class="op" id="6934364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934367">}</span><br>
<span class="lineno"></span><span class="op" id="6934369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6934372">func</span>&nbsp;<span class="ident" id="6934377">TestFlap</span><span class="op" id="6934385">(</span><span class="ident" id="6934386">t</span>&nbsp;<span class="op" id="6934388">*</span><span class="ident" id="6934389">testing</span><span class="op" id="6934396">.</span><span class="ident" id="6934397">T</span><span class="op" id="6934398">)</span>&nbsp;<span class="op" id="6934400">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934403">net</span>&nbsp;<span class="op" id="6934407">:=</span>&nbsp;<span class="string" id="6934410">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934418">done</span>&nbsp;<span class="op" id="6934423">:=</span>&nbsp;<span class="builtinfunc" id="6934426">make</span><span class="op" id="6934430">(</span><span class="keyword" id="6934431">chan</span>&nbsp;<span class="builtintype" id="6934436">string</span><span class="op" id="6934442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934445">addr</span><span class="op" id="6934449">,</span>&nbsp;<span class="ident" id="6934451">sock</span><span class="op" id="6934455">,</span>&nbsp;<span class="ident" id="6934457">srvWG</span>&nbsp;<span class="op" id="6934463">:=</span>&nbsp;<span class="ident" id="6934466">startServer</span><span class="op" id="6934477">(</span><span class="ident" id="6934478">net</span><span class="op" id="6934481">,</span>&nbsp;<span class="string" id="6934483">&#34;&#34;</span><span class="op" id="6934485">,</span>&nbsp;<span class="ident" id="6934487">done</span><span class="op" id="6934491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934494">defer</span>&nbsp;<span class="ident" id="6934500">srvWG</span><span class="op" id="6934505">.</span><span class="ident" id="6934506">Wait</span><span class="op" id="6934510">(</span><span class="op" id="6934511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934514">defer</span>&nbsp;<span class="ident" id="6934520">os</span><span class="op" id="6934522">.</span><span class="ident" id="6934523">Remove</span><span class="op" id="6934529">(</span><span class="ident" id="6934530">addr</span><span class="op" id="6934534">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934537">defer</span>&nbsp;<span class="ident" id="6934543">sock</span><span class="op" id="6934547">.</span><span class="ident" id="6934548">Close</span><span class="op" id="6934553">(</span><span class="op" id="6934554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934558">s</span><span class="op" id="6934559">,</span>&nbsp;<span class="ident" id="6934561">err</span>&nbsp;<span class="op" id="6934565">:=</span>&nbsp;<span class="ident" id="6934568">Dial</span><span class="op" id="6934572">(</span><span class="ident" id="6934573">net</span><span class="op" id="6934576">,</span>&nbsp;<span class="ident" id="6934578">addr</span><span class="op" id="6934582">,</span>&nbsp;<span class="ident" id="6934584">LOG_INFO</span><span class="op" id="6934592">|</span><span class="ident" id="6934593">LOG_USER</span><span class="op" id="6934601">,</span>&nbsp;<span class="string" id="6934603">&#34;syslog_test&#34;</span><span class="op" id="6934616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934619">if</span>&nbsp;<span class="ident" id="6934622">err</span>&nbsp;<span class="op" id="6934626">!=</span>&nbsp;<span class="ident" id="6934629">nil</span>&nbsp;<span class="op" id="6934633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934637">t</span><span class="op" id="6934638">.</span><span class="ident" id="6934639">Fatalf</span><span class="op" id="6934645">(</span><span class="string" id="6934646">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6934665">,</span>&nbsp;<span class="ident" id="6934667">err</span><span class="op" id="6934670">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934676">msg</span>&nbsp;<span class="op" id="6934680">:=</span>&nbsp;<span class="string" id="6934683">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934692">err</span>&nbsp;<span class="op" id="6934696">=</span>&nbsp;<span class="ident" id="6934698">s</span><span class="op" id="6934699">.</span><span class="ident" id="6934700">Info</span><span class="op" id="6934704">(</span><span class="ident" id="6934705">msg</span><span class="op" id="6934708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934711">if</span>&nbsp;<span class="ident" id="6934714">err</span>&nbsp;<span class="op" id="6934718">!=</span>&nbsp;<span class="ident" id="6934721">nil</span>&nbsp;<span class="op" id="6934725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934729">t</span><span class="op" id="6934730">.</span><span class="ident" id="6934731">Fatalf</span><span class="op" id="6934737">(</span><span class="string" id="6934738">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6934754">,</span>&nbsp;<span class="ident" id="6934756">err</span><span class="op" id="6934759">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6934762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934765">check</span><span class="op" id="6934770">(</span><span class="ident" id="6934771">t</span><span class="op" id="6934772">,</span>&nbsp;<span class="ident" id="6934774">msg</span><span class="op" id="6934777">,</span>&nbsp;<span class="op" id="6934779">&lt;-</span><span class="ident" id="6934781">done</span><span class="op" id="6934785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6934789">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934812">_</span><span class="op" id="6934813">,</span>&nbsp;<span class="ident" id="6934815">sock2</span><span class="op" id="6934820">,</span>&nbsp;<span class="ident" id="6934822">srvWG2</span>&nbsp;<span class="op" id="6934829">:=</span>&nbsp;<span class="ident" id="6934832">startServer</span><span class="op" id="6934843">(</span><span class="ident" id="6934844">net</span><span class="op" id="6934847">,</span>&nbsp;<span class="ident" id="6934849">addr</span><span class="op" id="6934853">,</span>&nbsp;<span class="ident" id="6934855">done</span><span class="op" id="6934859">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934862">defer</span>&nbsp;<span class="ident" id="6934868">srvWG2</span><span class="op" id="6934874">.</span><span class="ident" id="6934875">Wait</span><span class="op" id="6934879">(</span><span class="op" id="6934880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934883">defer</span>&nbsp;<span class="ident" id="6934889">sock2</span><span class="op" id="6934894">.</span><span class="ident" id="6934895">Close</span><span class="op" id="6934900">(</span><span class="op" id="6934901">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6934905">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934932">msg</span>&nbsp;<span class="op" id="6934936">=</span>&nbsp;<span class="string" id="6934938">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934947">err</span>&nbsp;<span class="op" id="6934951">=</span>&nbsp;<span class="ident" id="6934953">s</span><span class="op" id="6934954">.</span><span class="ident" id="6934955">Info</span><span class="op" id="6934959">(</span><span class="ident" id="6934960">msg</span><span class="op" id="6934963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6934966">if</span>&nbsp;<span class="ident" id="6934969">err</span>&nbsp;<span class="op" id="6934973">!=</span>&nbsp;<span class="ident" id="6934976">nil</span>&nbsp;<span class="op" id="6934980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6934984">t</span><span class="op" id="6934985">.</span><span class="ident" id="6934986">Fatalf</span><span class="op" id="6934992">(</span><span class="string" id="6934993">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6935009">,</span>&nbsp;<span class="ident" id="6935011">err</span><span class="op" id="6935014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935020">check</span><span class="op" id="6935025">(</span><span class="ident" id="6935026">t</span><span class="op" id="6935027">,</span>&nbsp;<span class="ident" id="6935029">msg</span><span class="op" id="6935032">,</span>&nbsp;<span class="op" id="6935034">&lt;-</span><span class="ident" id="6935036">done</span><span class="op" id="6935040">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935044">s</span><span class="op" id="6935045">.</span><span class="ident" id="6935046">Close</span><span class="op" id="6935051">(</span><span class="op" id="6935052">)</span><br>
<span class="lineno"></span><span class="op" id="6935054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6935057">func</span>&nbsp;<span class="ident" id="6935062">TestNew</span><span class="op" id="6935069">(</span><span class="ident" id="6935070">t</span>&nbsp;<span class="op" id="6935072">*</span><span class="ident" id="6935073">testing</span><span class="op" id="6935080">.</span><span class="ident" id="6935081">T</span><span class="op" id="6935082">)</span>&nbsp;<span class="op" id="6935084">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935087">if</span>&nbsp;<span class="ident" id="6935090">LOG_LOCAL7</span>&nbsp;<span class="op" id="6935101">!=</span>&nbsp;<span class="num" id="6935104">23</span><span class="op" id="6935106">&lt;&lt;</span><span class="num" id="6935108">3</span>&nbsp;<span class="op" id="6935110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935114">t</span><span class="op" id="6935115">.</span><span class="ident" id="6935116">Fatalf</span><span class="op" id="6935122">(</span><span class="string" id="6935123">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="6935151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935157">if</span>&nbsp;<span class="ident" id="6935160">testing</span><span class="op" id="6935167">.</span><span class="ident" id="6935168">Short</span><span class="op" id="6935173">(</span><span class="op" id="6935174">)</span>&nbsp;<span class="op" id="6935176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6935180">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935243">t</span><span class="op" id="6935244">.</span><span class="ident" id="6935245">Skip</span><span class="op" id="6935249">(</span><span class="string" id="6935250">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6935286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935293">s</span><span class="op" id="6935294">,</span>&nbsp;<span class="ident" id="6935296">err</span>&nbsp;<span class="op" id="6935300">:=</span>&nbsp;<span class="ident" id="6935303">New</span><span class="op" id="6935306">(</span><span class="ident" id="6935307">LOG_INFO</span><span class="op" id="6935315">|</span><span class="ident" id="6935316">LOG_USER</span><span class="op" id="6935324">,</span>&nbsp;<span class="string" id="6935326">&#34;the_tag&#34;</span><span class="op" id="6935335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935338">if</span>&nbsp;<span class="ident" id="6935341">err</span>&nbsp;<span class="op" id="6935345">!=</span>&nbsp;<span class="ident" id="6935348">nil</span>&nbsp;<span class="op" id="6935352">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935356">t</span><span class="op" id="6935357">.</span><span class="ident" id="6935358">Fatalf</span><span class="op" id="6935364">(</span><span class="string" id="6935365">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6935383">,</span>&nbsp;<span class="ident" id="6935385">err</span><span class="op" id="6935388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6935394">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935423">s</span><span class="op" id="6935424">.</span><span class="ident" id="6935425">Close</span><span class="op" id="6935430">(</span><span class="op" id="6935431">)</span><br>
<span class="lineno"></span><span class="op" id="6935433">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="6935436">func</span>&nbsp;<span class="ident" id="6935441">TestNewLogger</span><span class="op" id="6935454">(</span><span class="ident" id="6935455">t</span>&nbsp;<span class="op" id="6935457">*</span><span class="ident" id="6935458">testing</span><span class="op" id="6935465">.</span><span class="ident" id="6935466">T</span><span class="op" id="6935467">)</span>&nbsp;<span class="op" id="6935469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935472">if</span>&nbsp;<span class="ident" id="6935475">testing</span><span class="op" id="6935482">.</span><span class="ident" id="6935483">Short</span><span class="op" id="6935488">(</span><span class="op" id="6935489">)</span>&nbsp;<span class="op" id="6935491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935495">t</span><span class="op" id="6935496">.</span><span class="ident" id="6935497">Skip</span><span class="op" id="6935501">(</span><span class="string" id="6935502">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6935538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935541">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935544">f</span><span class="op" id="6935545">,</span>&nbsp;<span class="ident" id="6935547">err</span>&nbsp;<span class="op" id="6935551">:=</span>&nbsp;<span class="ident" id="6935554">NewLogger</span><span class="op" id="6935563">(</span><span class="ident" id="6935564">LOG_USER</span><span class="op" id="6935572">|</span><span class="ident" id="6935573">LOG_INFO</span><span class="op" id="6935581">,</span>&nbsp;<span class="num" id="6935583">0</span><span class="op" id="6935584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935587">if</span>&nbsp;<span class="ident" id="6935590">f</span>&nbsp;<span class="op" id="6935592">==</span>&nbsp;<span class="ident" id="6935595">nil</span>&nbsp;<span class="op" id="6935599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935603">t</span><span class="op" id="6935604">.</span><span class="ident" id="6935605">Error</span><span class="op" id="6935610">(</span><span class="ident" id="6935611">err</span><span class="op" id="6935614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935617">}</span><br>
<span class="lineno"></span><span class="op" id="6935619">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6935622">func</span>&nbsp;<span class="ident" id="6935627">TestDial</span><span class="op" id="6935635">(</span><span class="ident" id="6935636">t</span>&nbsp;<span class="op" id="6935638">*</span><span class="ident" id="6935639">testing</span><span class="op" id="6935646">.</span><span class="ident" id="6935647">T</span><span class="op" id="6935648">)</span>&nbsp;<span class="op" id="6935650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935653">if</span>&nbsp;<span class="ident" id="6935656">testing</span><span class="op" id="6935663">.</span><span class="ident" id="6935664">Short</span><span class="op" id="6935669">(</span><span class="op" id="6935670">)</span>&nbsp;<span class="op" id="6935672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935676">t</span><span class="op" id="6935677">.</span><span class="ident" id="6935678">Skip</span><span class="op" id="6935682">(</span><span class="string" id="6935683">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="6935719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935722">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935725">f</span><span class="op" id="6935726">,</span>&nbsp;<span class="ident" id="6935728">err</span>&nbsp;<span class="op" id="6935732">:=</span>&nbsp;<span class="ident" id="6935735">Dial</span><span class="op" id="6935739">(</span><span class="string" id="6935740">&#34;&#34;</span><span class="op" id="6935742">,</span>&nbsp;<span class="string" id="6935744">&#34;&#34;</span><span class="op" id="6935746">,</span>&nbsp;<span class="op" id="6935748">(</span><span class="ident" id="6935749">LOG_LOCAL7</span><span class="op" id="6935759">|</span><span class="ident" id="6935760">LOG_DEBUG</span><span class="op" id="6935769">)</span><span class="op" id="6935770">+</span><span class="num" id="6935771">1</span><span class="op" id="6935772">,</span>&nbsp;<span class="string" id="6935774">&#34;syslog_test&#34;</span><span class="op" id="6935787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935790">if</span>&nbsp;<span class="ident" id="6935793">f</span>&nbsp;<span class="op" id="6935795">!=</span>&nbsp;<span class="ident" id="6935798">nil</span>&nbsp;<span class="op" id="6935802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935806">t</span><span class="op" id="6935807">.</span><span class="ident" id="6935808">Fatalf</span><span class="op" id="6935814">(</span><span class="string" id="6935815">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="6935849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935855">f</span><span class="op" id="6935856">,</span>&nbsp;<span class="ident" id="6935858">err</span>&nbsp;<span class="op" id="6935862">=</span>&nbsp;<span class="ident" id="6935864">Dial</span><span class="op" id="6935868">(</span><span class="string" id="6935869">&#34;&#34;</span><span class="op" id="6935871">,</span>&nbsp;<span class="string" id="6935873">&#34;&#34;</span><span class="op" id="6935875">,</span>&nbsp;<span class="op" id="6935877">-</span><span class="num" id="6935878">1</span><span class="op" id="6935879">,</span>&nbsp;<span class="string" id="6935881">&#34;syslog_test&#34;</span><span class="op" id="6935894">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6935897">if</span>&nbsp;<span class="ident" id="6935900">f</span>&nbsp;<span class="op" id="6935902">!=</span>&nbsp;<span class="ident" id="6935905">nil</span>&nbsp;<span class="op" id="6935909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935913">t</span><span class="op" id="6935914">.</span><span class="ident" id="6935915">Fatalf</span><span class="op" id="6935921">(</span><span class="string" id="6935922">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="6935956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6935959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6935962">l</span><span class="op" id="6935963">,</span>&nbsp;<span class="ident" id="6935965">err</span>&nbsp;<span class="op" id="6935969">:=</span>&nbsp;<span class="ident" id="6935972">Dial</span><span class="op" id="6935976">(</span><span class="string" id="6935977">&#34;&#34;</span><span class="op" id="6935979">,</span>&nbsp;<span class="string" id="6935981">&#34;&#34;</span><span class="op" id="6935983">,</span>&nbsp;<span class="ident" id="6935985">LOG_USER</span><span class="op" id="6935993">|</span><span class="ident" id="6935994">LOG_ERR</span><span class="op" id="6936001">,</span>&nbsp;<span class="string" id="6936003">&#34;syslog_test&#34;</span><span class="op" id="6936016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936019">if</span>&nbsp;<span class="ident" id="6936022">err</span>&nbsp;<span class="op" id="6936026">!=</span>&nbsp;<span class="ident" id="6936029">nil</span>&nbsp;<span class="op" id="6936033">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936037">t</span><span class="op" id="6936038">.</span><span class="ident" id="6936039">Fatalf</span><span class="op" id="6936045">(</span><span class="string" id="6936046">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6936065">,</span>&nbsp;<span class="ident" id="6936067">err</span><span class="op" id="6936070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936076">l</span><span class="op" id="6936077">.</span><span class="ident" id="6936078">Close</span><span class="op" id="6936083">(</span><span class="op" id="6936084">)</span><br>
<span class="lineno"></span><span class="op" id="6936086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6936089">func</span>&nbsp;<span class="ident" id="6936094">check</span><span class="op" id="6936099">(</span><span class="ident" id="6936100">t</span>&nbsp;<span class="op" id="6936102">*</span><span class="ident" id="6936103">testing</span><span class="op" id="6936110">.</span><span class="ident" id="6936111">T</span><span class="op" id="6936112">,</span>&nbsp;<span class="ident" id="6936114">in</span><span class="op" id="6936116">,</span>&nbsp;<span class="ident" id="6936118">out</span>&nbsp;<span class="builtintype" id="6936122">string</span><span class="op" id="6936128">)</span>&nbsp;<span class="op" id="6936130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936133">tmpl</span>&nbsp;<span class="op" id="6936138">:=</span>&nbsp;<span class="ident" id="6936141">fmt</span><span class="op" id="6936144">.</span><span class="ident" id="6936145">Sprintf</span><span class="op" id="6936152">(</span><span class="string" id="6936153">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="6936189">,</span>&nbsp;<span class="ident" id="6936191">LOG_USER</span><span class="op" id="6936199">+</span><span class="ident" id="6936200">LOG_INFO</span><span class="op" id="6936208">,</span>&nbsp;<span class="ident" id="6936210">in</span><span class="op" id="6936212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936215">if</span>&nbsp;<span class="ident" id="6936218">hostname</span><span class="op" id="6936226">,</span>&nbsp;<span class="ident" id="6936228">err</span>&nbsp;<span class="op" id="6936232">:=</span>&nbsp;<span class="ident" id="6936235">os</span><span class="op" id="6936237">.</span><span class="ident" id="6936238">Hostname</span><span class="op" id="6936246">(</span><span class="op" id="6936247">)</span><span class="op" id="6936248">;</span>&nbsp;<span class="ident" id="6936250">err</span>&nbsp;<span class="op" id="6936254">!=</span>&nbsp;<span class="ident" id="6936257">nil</span>&nbsp;<span class="op" id="6936261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936265">t</span><span class="op" id="6936266">.</span><span class="ident" id="6936267">Error</span><span class="op" id="6936272">(</span><span class="string" id="6936273">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="6936300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936303">}</span>&nbsp;<span class="keyword" id="6936305">else</span>&nbsp;<span class="op" id="6936310">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936314">var</span>&nbsp;<span class="ident" id="6936318">parsedHostname</span><span class="op" id="6936332">,</span>&nbsp;<span class="ident" id="6936334">timestamp</span>&nbsp;<span class="builtintype" id="6936344">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936353">var</span>&nbsp;<span class="ident" id="6936357">pid</span>&nbsp;<span class="builtintype" id="6936361">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936367">if</span>&nbsp;<span class="ident" id="6936370">n</span><span class="op" id="6936371">,</span>&nbsp;<span class="ident" id="6936373">err</span>&nbsp;<span class="op" id="6936377">:=</span>&nbsp;<span class="ident" id="6936380">fmt</span><span class="op" id="6936383">.</span><span class="ident" id="6936384">Sscanf</span><span class="op" id="6936390">(</span><span class="ident" id="6936391">out</span><span class="op" id="6936394">,</span>&nbsp;<span class="ident" id="6936396">tmpl</span><span class="op" id="6936400">,</span>&nbsp;<span class="op" id="6936402">&amp;</span><span class="ident" id="6936403">timestamp</span><span class="op" id="6936412">,</span>&nbsp;<span class="op" id="6936414">&amp;</span><span class="ident" id="6936415">parsedHostname</span><span class="op" id="6936429">,</span>&nbsp;<span class="op" id="6936431">&amp;</span><span class="ident" id="6936432">pid</span><span class="op" id="6936435">)</span><span class="op" id="6936436">;</span>&nbsp;<span class="ident" id="6936438">n</span>&nbsp;<span class="op" id="6936440">!=</span>&nbsp;<span class="num" id="6936443">3</span>&nbsp;<span class="op" id="6936445">||</span>&nbsp;<span class="ident" id="6936448">err</span>&nbsp;<span class="op" id="6936452">!=</span>&nbsp;<span class="ident" id="6936455">nil</span>&nbsp;<span class="op" id="6936459">||</span>&nbsp;<span class="ident" id="6936462">hostname</span>&nbsp;<span class="op" id="6936471">!=</span>&nbsp;<span class="ident" id="6936474">parsedHostname</span>&nbsp;<span class="op" id="6936489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936494">t</span><span class="op" id="6936495">.</span><span class="ident" id="6936496">Errorf</span><span class="op" id="6936502">(</span><span class="string" id="6936503">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="6936547">,</span>&nbsp;<span class="ident" id="6936549">out</span><span class="op" id="6936552">,</span>&nbsp;<span class="ident" id="6936554">tmpl</span><span class="op" id="6936558">,</span>&nbsp;<span class="ident" id="6936560">n</span><span class="op" id="6936561">,</span>&nbsp;<span class="ident" id="6936563">err</span><span class="op" id="6936566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936570">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936573">}</span><br>
<span class="lineno"></span><span class="op" id="6936575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6936578">func</span>&nbsp;<span class="ident" id="6936583">TestWrite</span><span class="op" id="6936592">(</span><span class="ident" id="6936593">t</span>&nbsp;<span class="op" id="6936595">*</span><span class="ident" id="6936596">testing</span><span class="op" id="6936603">.</span><span class="ident" id="6936604">T</span><span class="op" id="6936605">)</span>&nbsp;<span class="op" id="6936607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936610">tests</span>&nbsp;<span class="op" id="6936616">:=</span>&nbsp;<span class="op" id="6936619">[</span><span class="op" id="6936620">]</span><span class="keyword" id="6936621">struct</span>&nbsp;<span class="op" id="6936628">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936632">pri</span>&nbsp;<span class="ident" id="6936636">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936647">pre</span>&nbsp;<span class="builtintype" id="6936651">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936660">msg</span>&nbsp;<span class="builtintype" id="6936664">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936673">exp</span>&nbsp;<span class="builtintype" id="6936677">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936685">}</span><span class="op" id="6936686">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936690">{</span><span class="ident" id="6936691">LOG_USER</span>&nbsp;<span class="op" id="6936700">|</span>&nbsp;<span class="ident" id="6936702">LOG_ERR</span><span class="op" id="6936709">,</span>&nbsp;<span class="string" id="6936711">&#34;syslog_test&#34;</span><span class="op" id="6936724">,</span>&nbsp;<span class="string" id="6936726">&#34;&#34;</span><span class="op" id="6936728">,</span>&nbsp;<span class="string" id="6936730">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="6936757">}</span><span class="op" id="6936758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936762">{</span><span class="ident" id="6936763">LOG_USER</span>&nbsp;<span class="op" id="6936772">|</span>&nbsp;<span class="ident" id="6936774">LOG_ERR</span><span class="op" id="6936781">,</span>&nbsp;<span class="string" id="6936783">&#34;syslog_test&#34;</span><span class="op" id="6936796">,</span>&nbsp;<span class="string" id="6936798">&#34;write&nbsp;test&#34;</span><span class="op" id="6936810">,</span>&nbsp;<span class="string" id="6936812">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="6936849">}</span><span class="op" id="6936850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6936854">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936907">{</span><span class="ident" id="6936908">LOG_USER</span>&nbsp;<span class="op" id="6936917">|</span>&nbsp;<span class="ident" id="6936919">LOG_ERR</span><span class="op" id="6936926">,</span>&nbsp;<span class="string" id="6936928">&#34;syslog_test&#34;</span><span class="op" id="6936941">,</span>&nbsp;<span class="string" id="6936943">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="6936959">,</span>&nbsp;<span class="string" id="6936961">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="6937000">}</span><span class="op" id="6937001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937004">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937008">if</span>&nbsp;<span class="ident" id="6937011">hostname</span><span class="op" id="6937019">,</span>&nbsp;<span class="ident" id="6937021">err</span>&nbsp;<span class="op" id="6937025">:=</span>&nbsp;<span class="ident" id="6937028">os</span><span class="op" id="6937030">.</span><span class="ident" id="6937031">Hostname</span><span class="op" id="6937039">(</span><span class="op" id="6937040">)</span><span class="op" id="6937041">;</span>&nbsp;<span class="ident" id="6937043">err</span>&nbsp;<span class="op" id="6937047">!=</span>&nbsp;<span class="ident" id="6937050">nil</span>&nbsp;<span class="op" id="6937054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937058">t</span><span class="op" id="6937059">.</span><span class="ident" id="6937060">Fatalf</span><span class="op" id="6937066">(</span><span class="string" id="6937067">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="6937094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937097">}</span>&nbsp;<span class="keyword" id="6937099">else</span>&nbsp;<span class="op" id="6937104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937108">for</span>&nbsp;<span class="ident" id="6937112">_</span><span class="op" id="6937113">,</span>&nbsp;<span class="ident" id="6937115">test</span>&nbsp;<span class="op" id="6937120">:=</span>&nbsp;<span class="keyword" id="6937123">range</span>&nbsp;<span class="ident" id="6937129">tests</span>&nbsp;<span class="op" id="6937135">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937140">done</span>&nbsp;<span class="op" id="6937145">:=</span>&nbsp;<span class="builtinfunc" id="6937148">make</span><span class="op" id="6937152">(</span><span class="keyword" id="6937153">chan</span>&nbsp;<span class="builtintype" id="6937158">string</span><span class="op" id="6937164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937169">addr</span><span class="op" id="6937173">,</span>&nbsp;<span class="ident" id="6937175">sock</span><span class="op" id="6937179">,</span>&nbsp;<span class="ident" id="6937181">srvWG</span>&nbsp;<span class="op" id="6937187">:=</span>&nbsp;<span class="ident" id="6937190">startServer</span><span class="op" id="6937201">(</span><span class="string" id="6937202">&#34;udp&#34;</span><span class="op" id="6937207">,</span>&nbsp;<span class="string" id="6937209">&#34;&#34;</span><span class="op" id="6937211">,</span>&nbsp;<span class="ident" id="6937213">done</span><span class="op" id="6937217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937222">defer</span>&nbsp;<span class="ident" id="6937228">srvWG</span><span class="op" id="6937233">.</span><span class="ident" id="6937234">Wait</span><span class="op" id="6937238">(</span><span class="op" id="6937239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937244">defer</span>&nbsp;<span class="ident" id="6937250">sock</span><span class="op" id="6937254">.</span><span class="ident" id="6937255">Close</span><span class="op" id="6937260">(</span><span class="op" id="6937261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937266">l</span><span class="op" id="6937267">,</span>&nbsp;<span class="ident" id="6937269">err</span>&nbsp;<span class="op" id="6937273">:=</span>&nbsp;<span class="ident" id="6937276">Dial</span><span class="op" id="6937280">(</span><span class="string" id="6937281">&#34;udp&#34;</span><span class="op" id="6937286">,</span>&nbsp;<span class="ident" id="6937288">addr</span><span class="op" id="6937292">,</span>&nbsp;<span class="ident" id="6937294">test</span><span class="op" id="6937298">.</span><span class="ident" id="6937299">pri</span><span class="op" id="6937302">,</span>&nbsp;<span class="ident" id="6937304">test</span><span class="op" id="6937308">.</span><span class="ident" id="6937309">pre</span><span class="op" id="6937312">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937317">if</span>&nbsp;<span class="ident" id="6937320">err</span>&nbsp;<span class="op" id="6937324">!=</span>&nbsp;<span class="ident" id="6937327">nil</span>&nbsp;<span class="op" id="6937331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937337">t</span><span class="op" id="6937338">.</span><span class="ident" id="6937339">Fatalf</span><span class="op" id="6937345">(</span><span class="string" id="6937346">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6937372">,</span>&nbsp;<span class="ident" id="6937374">err</span><span class="op" id="6937377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937387">defer</span>&nbsp;<span class="ident" id="6937393">l</span><span class="op" id="6937394">.</span><span class="ident" id="6937395">Close</span><span class="op" id="6937400">(</span><span class="op" id="6937401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937406">_</span><span class="op" id="6937407">,</span>&nbsp;<span class="ident" id="6937409">err</span>&nbsp;<span class="op" id="6937413">=</span>&nbsp;<span class="ident" id="6937415">io</span><span class="op" id="6937417">.</span><span class="ident" id="6937418">WriteString</span><span class="op" id="6937429">(</span><span class="ident" id="6937430">l</span><span class="op" id="6937431">,</span>&nbsp;<span class="ident" id="6937433">test</span><span class="op" id="6937437">.</span><span class="ident" id="6937438">msg</span><span class="op" id="6937441">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937446">if</span>&nbsp;<span class="ident" id="6937449">err</span>&nbsp;<span class="op" id="6937453">!=</span>&nbsp;<span class="ident" id="6937456">nil</span>&nbsp;<span class="op" id="6937460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937466">t</span><span class="op" id="6937467">.</span><span class="ident" id="6937468">Fatalf</span><span class="op" id="6937474">(</span><span class="string" id="6937475">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6937501">,</span>&nbsp;<span class="ident" id="6937503">err</span><span class="op" id="6937506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937516">rcvd</span>&nbsp;<span class="op" id="6937521">:=</span>&nbsp;<span class="op" id="6937524">&lt;-</span><span class="ident" id="6937526">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937534">test</span><span class="op" id="6937538">.</span><span class="ident" id="6937539">exp</span>&nbsp;<span class="op" id="6937543">=</span>&nbsp;<span class="ident" id="6937545">fmt</span><span class="op" id="6937548">.</span><span class="ident" id="6937549">Sprintf</span><span class="op" id="6937556">(</span><span class="string" id="6937557">&#34;&lt;%d&gt;&#34;</span><span class="op" id="6937563">,</span>&nbsp;<span class="ident" id="6937565">test</span><span class="op" id="6937569">.</span><span class="ident" id="6937570">pri</span><span class="op" id="6937573">)</span>&nbsp;<span class="op" id="6937575">+</span>&nbsp;<span class="ident" id="6937577">test</span><span class="op" id="6937581">.</span><span class="ident" id="6937582">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937589">var</span>&nbsp;<span class="ident" id="6937593">parsedHostname</span><span class="op" id="6937607">,</span>&nbsp;<span class="ident" id="6937609">timestamp</span>&nbsp;<span class="builtintype" id="6937619">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937629">var</span>&nbsp;<span class="ident" id="6937633">pid</span>&nbsp;<span class="builtintype" id="6937637">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937644">if</span>&nbsp;<span class="ident" id="6937647">n</span><span class="op" id="6937648">,</span>&nbsp;<span class="ident" id="6937650">err</span>&nbsp;<span class="op" id="6937654">:=</span>&nbsp;<span class="ident" id="6937657">fmt</span><span class="op" id="6937660">.</span><span class="ident" id="6937661">Sscanf</span><span class="op" id="6937667">(</span><span class="ident" id="6937668">rcvd</span><span class="op" id="6937672">,</span>&nbsp;<span class="ident" id="6937674">test</span><span class="op" id="6937678">.</span><span class="ident" id="6937679">exp</span><span class="op" id="6937682">,</span>&nbsp;<span class="op" id="6937684">&amp;</span><span class="ident" id="6937685">timestamp</span><span class="op" id="6937694">,</span>&nbsp;<span class="op" id="6937696">&amp;</span><span class="ident" id="6937697">parsedHostname</span><span class="op" id="6937711">,</span>&nbsp;<span class="op" id="6937713">&amp;</span><span class="ident" id="6937714">pid</span><span class="op" id="6937717">)</span><span class="op" id="6937718">;</span>&nbsp;<span class="ident" id="6937720">n</span>&nbsp;<span class="op" id="6937722">!=</span>&nbsp;<span class="num" id="6937725">3</span>&nbsp;<span class="op" id="6937727">||</span>&nbsp;<span class="ident" id="6937730">err</span>&nbsp;<span class="op" id="6937734">!=</span>&nbsp;<span class="ident" id="6937737">nil</span>&nbsp;<span class="op" id="6937741">||</span>&nbsp;<span class="ident" id="6937744">hostname</span>&nbsp;<span class="op" id="6937753">!=</span>&nbsp;<span class="ident" id="6937756">parsedHostname</span>&nbsp;<span class="op" id="6937771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937777">t</span><span class="op" id="6937778">.</span><span class="ident" id="6937779">Errorf</span><span class="op" id="6937785">(</span><span class="string" id="6937786">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="6937830">,</span>&nbsp;<span class="ident" id="6937832">rcvd</span><span class="op" id="6937836">,</span>&nbsp;<span class="ident" id="6937838">test</span><span class="op" id="6937842">.</span><span class="ident" id="6937843">exp</span><span class="op" id="6937846">,</span>&nbsp;<span class="ident" id="6937848">n</span><span class="op" id="6937849">,</span>&nbsp;<span class="ident" id="6937851">err</span><span class="op" id="6937854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937859">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937866">}</span><br>
<span class="lineno"></span><span class="op" id="6937868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6937871">func</span>&nbsp;<span class="ident" id="6937876">TestConcurrentWrite</span><span class="op" id="6937895">(</span><span class="ident" id="6937896">t</span>&nbsp;<span class="op" id="6937898">*</span><span class="ident" id="6937899">testing</span><span class="op" id="6937906">.</span><span class="ident" id="6937907">T</span><span class="op" id="6937908">)</span>&nbsp;<span class="op" id="6937910">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937913">addr</span><span class="op" id="6937917">,</span>&nbsp;<span class="ident" id="6937919">sock</span><span class="op" id="6937923">,</span>&nbsp;<span class="ident" id="6937925">srvWG</span>&nbsp;<span class="op" id="6937931">:=</span>&nbsp;<span class="ident" id="6937934">startServer</span><span class="op" id="6937945">(</span><span class="string" id="6937946">&#34;udp&#34;</span><span class="op" id="6937951">,</span>&nbsp;<span class="string" id="6937953">&#34;&#34;</span><span class="op" id="6937955">,</span>&nbsp;<span class="builtinfunc" id="6937957">make</span><span class="op" id="6937961">(</span><span class="keyword" id="6937962">chan</span>&nbsp;<span class="builtintype" id="6937967">string</span><span class="op" id="6937973">,</span>&nbsp;<span class="num" id="6937975">1</span><span class="op" id="6937976">)</span><span class="op" id="6937977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937980">defer</span>&nbsp;<span class="ident" id="6937986">srvWG</span><span class="op" id="6937991">.</span><span class="ident" id="6937992">Wait</span><span class="op" id="6937996">(</span><span class="op" id="6937997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938000">defer</span>&nbsp;<span class="ident" id="6938006">sock</span><span class="op" id="6938010">.</span><span class="ident" id="6938011">Close</span><span class="op" id="6938016">(</span><span class="op" id="6938017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938020">w</span><span class="op" id="6938021">,</span>&nbsp;<span class="ident" id="6938023">err</span>&nbsp;<span class="op" id="6938027">:=</span>&nbsp;<span class="ident" id="6938030">Dial</span><span class="op" id="6938034">(</span><span class="string" id="6938035">&#34;udp&#34;</span><span class="op" id="6938040">,</span>&nbsp;<span class="ident" id="6938042">addr</span><span class="op" id="6938046">,</span>&nbsp;<span class="ident" id="6938048">LOG_USER</span><span class="op" id="6938056">|</span><span class="ident" id="6938057">LOG_ERR</span><span class="op" id="6938064">,</span>&nbsp;<span class="string" id="6938066">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="6938083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938086">if</span>&nbsp;<span class="ident" id="6938089">err</span>&nbsp;<span class="op" id="6938093">!=</span>&nbsp;<span class="ident" id="6938096">nil</span>&nbsp;<span class="op" id="6938100">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938104">t</span><span class="op" id="6938105">.</span><span class="ident" id="6938106">Fatalf</span><span class="op" id="6938112">(</span><span class="string" id="6938113">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6938139">,</span>&nbsp;<span class="ident" id="6938141">err</span><span class="op" id="6938144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938150">var</span>&nbsp;<span class="ident" id="6938154">wg</span>&nbsp;<span class="ident" id="6938157">sync</span><span class="op" id="6938161">.</span><span class="ident" id="6938162">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938173">for</span>&nbsp;<span class="ident" id="6938177">i</span>&nbsp;<span class="op" id="6938179">:=</span>&nbsp;<span class="num" id="6938182">0</span><span class="op" id="6938183">;</span>&nbsp;<span class="ident" id="6938185">i</span>&nbsp;<span class="op" id="6938187">&lt;</span>&nbsp;<span class="num" id="6938189">10</span><span class="op" id="6938191">;</span>&nbsp;<span class="ident" id="6938193">i</span><span class="op" id="6938194">++</span>&nbsp;<span class="op" id="6938197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938201">wg</span><span class="op" id="6938203">.</span><span class="ident" id="6938204">Add</span><span class="op" id="6938207">(</span><span class="num" id="6938208">1</span><span class="op" id="6938209">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938213">go</span>&nbsp;<span class="keyword" id="6938216">func</span><span class="op" id="6938220">(</span><span class="op" id="6938221">)</span>&nbsp;<span class="op" id="6938223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938228">defer</span>&nbsp;<span class="ident" id="6938234">wg</span><span class="op" id="6938236">.</span><span class="ident" id="6938237">Done</span><span class="op" id="6938241">(</span><span class="op" id="6938242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938247">err</span>&nbsp;<span class="op" id="6938251">:=</span>&nbsp;<span class="ident" id="6938254">w</span><span class="op" id="6938255">.</span><span class="ident" id="6938256">Info</span><span class="op" id="6938260">(</span><span class="string" id="6938261">&#34;test&#34;</span><span class="op" id="6938267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938272">if</span>&nbsp;<span class="ident" id="6938275">err</span>&nbsp;<span class="op" id="6938279">!=</span>&nbsp;<span class="ident" id="6938282">nil</span>&nbsp;<span class="op" id="6938286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938292">t</span><span class="op" id="6938293">.</span><span class="ident" id="6938294">Errorf</span><span class="op" id="6938300">(</span><span class="string" id="6938301">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6938320">,</span>&nbsp;<span class="ident" id="6938322">err</span><span class="op" id="6938325">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938345">}</span><span class="op" id="6938346">(</span><span class="op" id="6938347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938353">wg</span><span class="op" id="6938355">.</span><span class="ident" id="6938356">Wait</span><span class="op" id="6938360">(</span><span class="op" id="6938361">)</span><br>
<span class="lineno">300</span><span class="op" id="6938363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6938366">func</span>&nbsp;<span class="ident" id="6938371">TestConcurrentReconnect</span><span class="op" id="6938394">(</span><span class="ident" id="6938395">t</span>&nbsp;<span class="op" id="6938397">*</span><span class="ident" id="6938398">testing</span><span class="op" id="6938405">.</span><span class="ident" id="6938406">T</span><span class="op" id="6938407">)</span>&nbsp;<span class="op" id="6938409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938412">crashy</span>&nbsp;<span class="op" id="6938419">=</span>&nbsp;<span class="builtintype" id="6938421">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938427">defer</span>&nbsp;<span class="keyword" id="6938433">func</span><span class="op" id="6938437">(</span><span class="op" id="6938438">)</span>&nbsp;<span class="op" id="6938440">{</span>&nbsp;<span class="ident" id="6938442">crashy</span>&nbsp;<span class="op" id="6938449">=</span>&nbsp;<span class="builtintype" id="6938451">false</span>&nbsp;<span class="op" id="6938457">}</span><span class="op" id="6938458">(</span><span class="op" id="6938459">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938463">const</span>&nbsp;<span class="ident" id="6938469">N</span>&nbsp;<span class="op" id="6938471">=</span>&nbsp;<span class="num" id="6938473">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938477">const</span>&nbsp;<span class="ident" id="6938483">M</span>&nbsp;<span class="op" id="6938485">=</span>&nbsp;<span class="num" id="6938487">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938492">net</span>&nbsp;<span class="op" id="6938496">:=</span>&nbsp;<span class="string" id="6938499">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938507">done</span>&nbsp;<span class="op" id="6938512">:=</span>&nbsp;<span class="builtinfunc" id="6938515">make</span><span class="op" id="6938519">(</span><span class="keyword" id="6938520">chan</span>&nbsp;<span class="builtintype" id="6938525">string</span><span class="op" id="6938531">,</span>&nbsp;<span class="ident" id="6938533">N</span><span class="op" id="6938534">*</span><span class="ident" id="6938535">M</span><span class="op" id="6938536">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938539">addr</span><span class="op" id="6938543">,</span>&nbsp;<span class="ident" id="6938545">sock</span><span class="op" id="6938549">,</span>&nbsp;<span class="ident" id="6938551">srvWG</span>&nbsp;<span class="op" id="6938557">:=</span>&nbsp;<span class="ident" id="6938560">startServer</span><span class="op" id="6938571">(</span><span class="ident" id="6938572">net</span><span class="op" id="6938575">,</span>&nbsp;<span class="string" id="6938577">&#34;&#34;</span><span class="op" id="6938579">,</span>&nbsp;<span class="ident" id="6938581">done</span><span class="op" id="6938585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938588">defer</span>&nbsp;<span class="ident" id="6938594">os</span><span class="op" id="6938596">.</span><span class="ident" id="6938597">Remove</span><span class="op" id="6938603">(</span><span class="ident" id="6938604">addr</span><span class="op" id="6938608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938612">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938648">count</span>&nbsp;<span class="op" id="6938654">:=</span>&nbsp;<span class="builtinfunc" id="6938657">make</span><span class="op" id="6938661">(</span><span class="keyword" id="6938662">chan</span>&nbsp;<span class="builtintype" id="6938667">int</span><span class="op" id="6938670">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938673">go</span>&nbsp;<span class="keyword" id="6938676">func</span><span class="op" id="6938680">(</span><span class="op" id="6938681">)</span>&nbsp;<span class="op" id="6938683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938687">ct</span>&nbsp;<span class="op" id="6938690">:=</span>&nbsp;<span class="num" id="6938693">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938697">for</span>&nbsp;<span class="keyword" id="6938701">range</span>&nbsp;<span class="ident" id="6938707">done</span>&nbsp;<span class="op" id="6938712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938717">ct</span><span class="op" id="6938719">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938725">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938773">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938822">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938861">if</span>&nbsp;<span class="ident" id="6938864">ct</span>&nbsp;<span class="op" id="6938867">&gt;</span>&nbsp;<span class="ident" id="6938869">N</span><span class="op" id="6938870">*</span><span class="ident" id="6938871">M</span><span class="op" id="6938872">/</span><span class="num" id="6938873">2</span>&nbsp;<span class="op" id="6938875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938881">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938890">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938898">count</span>&nbsp;<span class="op" id="6938904">&lt;-</span>&nbsp;<span class="ident" id="6938907">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938911">}</span><span class="op" id="6938912">(</span><span class="op" id="6938913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938917">var</span>&nbsp;<span class="ident" id="6938921">wg</span>&nbsp;<span class="ident" id="6938924">sync</span><span class="op" id="6938928">.</span><span class="ident" id="6938929">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938940">wg</span><span class="op" id="6938942">.</span><span class="ident" id="6938943">Add</span><span class="op" id="6938946">(</span><span class="ident" id="6938947">N</span><span class="op" id="6938948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938951">for</span>&nbsp;<span class="ident" id="6938955">i</span>&nbsp;<span class="op" id="6938957">:=</span>&nbsp;<span class="num" id="6938960">0</span><span class="op" id="6938961">;</span>&nbsp;<span class="ident" id="6938963">i</span>&nbsp;<span class="op" id="6938965">&lt;</span>&nbsp;<span class="ident" id="6938967">N</span><span class="op" id="6938968">;</span>&nbsp;<span class="ident" id="6938970">i</span><span class="op" id="6938971">++</span>&nbsp;<span class="op" id="6938974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938978">go</span>&nbsp;<span class="keyword" id="6938981">func</span><span class="op" id="6938985">(</span><span class="op" id="6938986">)</span>&nbsp;<span class="op" id="6938988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938993">defer</span>&nbsp;<span class="ident" id="6938999">wg</span><span class="op" id="6939001">.</span><span class="ident" id="6939002">Done</span><span class="op" id="6939006">(</span><span class="op" id="6939007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939012">w</span><span class="op" id="6939013">,</span>&nbsp;<span class="ident" id="6939015">err</span>&nbsp;<span class="op" id="6939019">:=</span>&nbsp;<span class="ident" id="6939022">Dial</span><span class="op" id="6939026">(</span><span class="ident" id="6939027">net</span><span class="op" id="6939030">,</span>&nbsp;<span class="ident" id="6939032">addr</span><span class="op" id="6939036">,</span>&nbsp;<span class="ident" id="6939038">LOG_USER</span><span class="op" id="6939046">|</span><span class="ident" id="6939047">LOG_ERR</span><span class="op" id="6939054">,</span>&nbsp;<span class="string" id="6939056">&#34;tag&#34;</span><span class="op" id="6939061">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939066">if</span>&nbsp;<span class="ident" id="6939069">err</span>&nbsp;<span class="op" id="6939073">!=</span>&nbsp;<span class="ident" id="6939076">nil</span>&nbsp;<span class="op" id="6939080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939086">t</span><span class="op" id="6939087">.</span><span class="ident" id="6939088">Fatalf</span><span class="op" id="6939094">(</span><span class="string" id="6939095">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6939121">,</span>&nbsp;<span class="ident" id="6939123">err</span><span class="op" id="6939126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939136">defer</span>&nbsp;<span class="ident" id="6939142">w</span><span class="op" id="6939143">.</span><span class="ident" id="6939144">Close</span><span class="op" id="6939149">(</span><span class="op" id="6939150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939155">for</span>&nbsp;<span class="ident" id="6939159">i</span>&nbsp;<span class="op" id="6939161">:=</span>&nbsp;<span class="num" id="6939164">0</span><span class="op" id="6939165">;</span>&nbsp;<span class="ident" id="6939167">i</span>&nbsp;<span class="op" id="6939169">&lt;</span>&nbsp;<span class="ident" id="6939171">M</span><span class="op" id="6939172">;</span>&nbsp;<span class="ident" id="6939174">i</span><span class="op" id="6939175">++</span>&nbsp;<span class="op" id="6939178">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939184">err</span>&nbsp;<span class="op" id="6939188">:=</span>&nbsp;<span class="ident" id="6939191">w</span><span class="op" id="6939192">.</span><span class="ident" id="6939193">Info</span><span class="op" id="6939197">(</span><span class="string" id="6939198">&#34;test&#34;</span><span class="op" id="6939204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939210">if</span>&nbsp;<span class="ident" id="6939213">err</span>&nbsp;<span class="op" id="6939217">!=</span>&nbsp;<span class="ident" id="6939220">nil</span>&nbsp;<span class="op" id="6939224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939231">t</span><span class="op" id="6939232">.</span><span class="ident" id="6939233">Errorf</span><span class="op" id="6939239">(</span><span class="string" id="6939240">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6939259">,</span>&nbsp;<span class="ident" id="6939261">err</span><span class="op" id="6939264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939271">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939282">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939291">}</span><span class="op" id="6939292">(</span><span class="op" id="6939293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939299">wg</span><span class="op" id="6939301">.</span><span class="ident" id="6939302">Wait</span><span class="op" id="6939306">(</span><span class="op" id="6939307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939310">sock</span><span class="op" id="6939314">.</span><span class="ident" id="6939315">Close</span><span class="op" id="6939320">(</span><span class="op" id="6939321">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939324">srvWG</span><span class="op" id="6939329">.</span><span class="ident" id="6939330">Wait</span><span class="op" id="6939334">(</span><span class="op" id="6939335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6939338">close</span><span class="op" id="6939343">(</span><span class="ident" id="6939344">done</span><span class="op" id="6939348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939352">select</span>&nbsp;<span class="op" id="6939359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939362">case</span>&nbsp;<span class="op" id="6939367">&lt;-</span><span class="ident" id="6939369">count</span><span class="op" id="6939374">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939377">case</span>&nbsp;<span class="op" id="6939382">&lt;-</span><span class="ident" id="6939384">time</span><span class="op" id="6939388">.</span><span class="ident" id="6939389">After</span><span class="op" id="6939394">(</span><span class="num" id="6939395">100</span>&nbsp;<span class="op" id="6939399">*</span>&nbsp;<span class="ident" id="6939401">time</span><span class="op" id="6939405">.</span><span class="ident" id="6939406">Millisecond</span><span class="op" id="6939417">)</span><span class="op" id="6939418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939422">t</span><span class="op" id="6939423">.</span><span class="ident" id="6939424">Error</span><span class="op" id="6939429">(</span><span class="string" id="6939430">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="6939463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939466">}</span><br>
<span class="lineno"></span><span class="op" id="6939468">}</span>
</div>
</body>
</html>
