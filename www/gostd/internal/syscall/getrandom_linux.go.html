<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>internal/syscall</h2>
<ul>
<li><a href="/gostd/internal/syscall/getrandom_linux.go.html" class="current">getrandom_linux.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4321948">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4322004">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4322058">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4322109">package</span>&nbsp;<span class="ident" id="4322117">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4322126">import</span>&nbsp;<span class="op" id="4322133">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322136">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322147">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322162">stdsyscall</span>&nbsp;<span class="string" id="4322173">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322184">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="4322193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4322196">var</span>&nbsp;<span class="ident" id="4322200">randomTrap</span>&nbsp;<span class="op" id="4322211">=</span>&nbsp;<span class="keyword" id="4322213">map</span><span class="op" id="4322216">[</span><span class="builtintype" id="4322217">string</span><span class="op" id="4322223">]</span><span class="builtintype" id="4322224">uintptr</span><span class="op" id="4322231">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322234">&#34;386&#34;</span><span class="op" id="4322239">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="4322243">355</span><span class="op" id="4322246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322249">&#34;amd64&#34;</span><span class="op" id="4322256">:</span>&nbsp;<span class="num" id="4322258">318</span><span class="op" id="4322261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4322264">&#34;arm&#34;</span><span class="op" id="4322269">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="4322273">384</span><span class="op" id="4322276">,</span><br>
<span class="lineno"></span><span class="op" id="4322278">}</span><span class="op" id="4322279">[</span><span class="ident" id="4322280">runtime</span><span class="op" id="4322287">.</span><span class="ident" id="4322288">GOARCH</span><span class="op" id="4322294">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="4322297">var</span>&nbsp;<span class="ident" id="4322301">randomUnsupported</span>&nbsp;<span class="builtintype" id="4322319">int32</span>&nbsp;<span class="comment" id="4322325">//&nbsp;atomic</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4322336">//&nbsp;GetRandomFlag&nbsp;is&nbsp;a&nbsp;flag&nbsp;supported&nbsp;by&nbsp;the&nbsp;getrandom&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="4322403">type</span>&nbsp;<span class="ident" id="4322408">GetRandomFlag</span>&nbsp;<span class="builtintype" id="4322422">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4322431">const</span>&nbsp;<span class="op" id="4322437">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322440">//&nbsp;GRND_NONBLOCK&nbsp;means&nbsp;return&nbsp;EAGAIN&nbsp;rather&nbsp;than&nbsp;blocking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322500">GRND_NONBLOCK</span>&nbsp;<span class="ident" id="4322514">GetRandomFlag</span>&nbsp;<span class="op" id="4322528">=</span>&nbsp;<span class="num" id="4322530">0x0001</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322539">//&nbsp;GRND_RANDOM&nbsp;means&nbsp;use&nbsp;the&nbsp;/dev/random&nbsp;pool&nbsp;instead&nbsp;of&nbsp;/dev/urandom.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322611">GRND_RANDOM</span>&nbsp;<span class="ident" id="4322623">GetRandomFlag</span>&nbsp;<span class="op" id="4322637">=</span>&nbsp;<span class="num" id="4322639">0x0002</span><br>
<span class="lineno"></span><span class="op" id="4322646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4322649">//&nbsp;GetRandom&nbsp;calls&nbsp;the&nbsp;Linux&nbsp;getrandom&nbsp;system&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="4322701">//&nbsp;See&nbsp;https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=c6e9d6f38894798696f23c8084ca7edbf16ee895</span><br>
<span class="lineno">35</span><span class="keyword" id="4322824">func</span>&nbsp;<span class="ident" id="4322829">GetRandom</span><span class="op" id="4322838">(</span><span class="ident" id="4322839">p</span>&nbsp;<span class="op" id="4322841">[</span><span class="op" id="4322842">]</span><span class="builtintype" id="4322843">byte</span><span class="op" id="4322847">,</span>&nbsp;<span class="ident" id="4322849">flags</span>&nbsp;<span class="ident" id="4322855">GetRandomFlag</span><span class="op" id="4322868">)</span>&nbsp;<span class="op" id="4322870">(</span><span class="ident" id="4322871">n</span>&nbsp;<span class="builtintype" id="4322873">int</span><span class="op" id="4322876">,</span>&nbsp;<span class="ident" id="4322878">err</span>&nbsp;<span class="builtintype" id="4322882">error</span><span class="op" id="4322887">)</span>&nbsp;<span class="op" id="4322889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322892">if</span>&nbsp;<span class="ident" id="4322895">randomTrap</span>&nbsp;<span class="op" id="4322906">==</span>&nbsp;<span class="num" id="4322909">0</span>&nbsp;<span class="op" id="4322911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322915">return</span>&nbsp;<span class="num" id="4322922">0</span><span class="op" id="4322923">,</span>&nbsp;<span class="ident" id="4322925">stdsyscall</span><span class="op" id="4322935">.</span><span class="ident" id="4322936">ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322947">if</span>&nbsp;<span class="builtinfunc" id="4322950">len</span><span class="op" id="4322953">(</span><span class="ident" id="4322954">p</span><span class="op" id="4322955">)</span>&nbsp;<span class="op" id="4322957">==</span>&nbsp;<span class="num" id="4322960">0</span>&nbsp;<span class="op" id="4322962">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322966">return</span>&nbsp;<span class="num" id="4322973">0</span><span class="op" id="4322974">,</span>&nbsp;<span class="ident" id="4322976">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322984">if</span>&nbsp;<span class="ident" id="4322987">atomic</span><span class="op" id="4322993">.</span><span class="ident" id="4322994">LoadInt32</span><span class="op" id="4323003">(</span><span class="op" id="4323004">&amp;</span><span class="ident" id="4323005">randomUnsupported</span><span class="op" id="4323022">)</span>&nbsp;<span class="op" id="4323024">!=</span>&nbsp;<span class="num" id="4323027">0</span>&nbsp;<span class="op" id="4323029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323033">return</span>&nbsp;<span class="num" id="4323040">0</span><span class="op" id="4323041">,</span>&nbsp;<span class="ident" id="4323043">stdsyscall</span><span class="op" id="4323053">.</span><span class="ident" id="4323054">ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323062">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323065">r1</span><span class="op" id="4323067">,</span>&nbsp;<span class="ident" id="4323069">_</span><span class="op" id="4323070">,</span>&nbsp;<span class="ident" id="4323072">errno</span>&nbsp;<span class="op" id="4323078">:=</span>&nbsp;<span class="ident" id="4323081">stdsyscall</span><span class="op" id="4323091">.</span><span class="ident" id="4323092">Syscall</span><span class="op" id="4323099">(</span><span class="ident" id="4323100">randomTrap</span><span class="op" id="4323110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4323114">uintptr</span><span class="op" id="4323121">(</span><span class="ident" id="4323122">unsafe</span><span class="op" id="4323128">.</span><span class="ident" id="4323129">Pointer</span><span class="op" id="4323136">(</span><span class="op" id="4323137">&amp;</span><span class="ident" id="4323138">p</span><span class="op" id="4323139">[</span><span class="num" id="4323140">0</span><span class="op" id="4323141">]</span><span class="op" id="4323142">)</span><span class="op" id="4323143">)</span><span class="op" id="4323144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4323148">uintptr</span><span class="op" id="4323155">(</span><span class="builtinfunc" id="4323156">len</span><span class="op" id="4323159">(</span><span class="ident" id="4323160">p</span><span class="op" id="4323161">)</span><span class="op" id="4323162">)</span><span class="op" id="4323163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4323167">uintptr</span><span class="op" id="4323174">(</span><span class="ident" id="4323175">flags</span><span class="op" id="4323180">)</span><span class="op" id="4323181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323184">if</span>&nbsp;<span class="ident" id="4323187">errno</span>&nbsp;<span class="op" id="4323193">!=</span>&nbsp;<span class="num" id="4323196">0</span>&nbsp;<span class="op" id="4323198">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323202">if</span>&nbsp;<span class="ident" id="4323205">errno</span>&nbsp;<span class="op" id="4323211">==</span>&nbsp;<span class="ident" id="4323214">stdsyscall</span><span class="op" id="4323224">.</span><span class="ident" id="4323225">ENOSYS</span>&nbsp;<span class="op" id="4323232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323237">atomic</span><span class="op" id="4323243">.</span><span class="ident" id="4323244">StoreInt32</span><span class="op" id="4323254">(</span><span class="op" id="4323255">&amp;</span><span class="ident" id="4323256">randomUnsupported</span><span class="op" id="4323273">,</span>&nbsp;<span class="num" id="4323275">1</span><span class="op" id="4323276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323284">return</span>&nbsp;<span class="num" id="4323291">0</span><span class="op" id="4323292">,</span>&nbsp;<span class="ident" id="4323294">errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323301">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323304">return</span>&nbsp;<span class="builtintype" id="4323311">int</span><span class="op" id="4323314">(</span><span class="ident" id="4323315">r1</span><span class="op" id="4323317">)</span><span class="op" id="4323318">,</span>&nbsp;<span class="ident" id="4323320">nil</span><br>
<span class="lineno"></span><span class="op" id="4323324">}</span>
</div>
</body>
</html>
