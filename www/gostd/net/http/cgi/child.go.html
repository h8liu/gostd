<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4823541">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4823596">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4823650">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4823701">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="4823761">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4823774">package</span>&nbsp;<span class="ident" id="4823782">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4823787">import</span>&nbsp;<span class="op" id="4823794">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823797">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823806">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823820">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823830">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823837">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823843">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823856">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823863">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823875">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823886">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823892">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4823903">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4823913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4823916">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="4823982">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="4824044">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="4824085">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="4824145">func</span>&nbsp;<span class="ident" id="4824150">Request</span><span class="op" id="4824157">(</span><span class="op" id="4824158">)</span>&nbsp;<span class="op" id="4824160">(</span><span class="op" id="4824161">*</span><span class="ident" id="4824162">http</span><span class="op" id="4824166">.</span><span class="ident" id="4824167">Request</span><span class="op" id="4824174">,</span>&nbsp;<span class="builtintype" id="4824176">error</span><span class="op" id="4824181">)</span>&nbsp;<span class="op" id="4824183">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824186">r</span><span class="op" id="4824187">,</span>&nbsp;<span class="ident" id="4824189">err</span>&nbsp;<span class="op" id="4824193">:=</span>&nbsp;<span class="ident" id="4824196">RequestFromMap</span><span class="op" id="4824210">(</span><span class="ident" id="4824211">envMap</span><span class="op" id="4824217">(</span><span class="ident" id="4824218">os</span><span class="op" id="4824220">.</span><span class="ident" id="4824221">Environ</span><span class="op" id="4824228">(</span><span class="op" id="4824229">)</span><span class="op" id="4824230">)</span><span class="op" id="4824231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824234">if</span>&nbsp;<span class="ident" id="4824237">err</span>&nbsp;<span class="op" id="4824241">!=</span>&nbsp;<span class="ident" id="4824244">nil</span>&nbsp;<span class="op" id="4824248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824252">return</span>&nbsp;<span class="ident" id="4824259">nil</span><span class="op" id="4824262">,</span>&nbsp;<span class="ident" id="4824264">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824272">if</span>&nbsp;<span class="ident" id="4824275">r</span><span class="op" id="4824276">.</span><span class="ident" id="4824277">ContentLength</span>&nbsp;<span class="op" id="4824291">&gt;</span>&nbsp;<span class="num" id="4824293">0</span>&nbsp;<span class="op" id="4824295">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824299">r</span><span class="op" id="4824300">.</span><span class="ident" id="4824301">Body</span>&nbsp;<span class="op" id="4824306">=</span>&nbsp;<span class="ident" id="4824308">ioutil</span><span class="op" id="4824314">.</span><span class="ident" id="4824315">NopCloser</span><span class="op" id="4824324">(</span><span class="ident" id="4824325">io</span><span class="op" id="4824327">.</span><span class="ident" id="4824328">LimitReader</span><span class="op" id="4824339">(</span><span class="ident" id="4824340">os</span><span class="op" id="4824342">.</span><span class="ident" id="4824343">Stdin</span><span class="op" id="4824348">,</span>&nbsp;<span class="ident" id="4824350">r</span><span class="op" id="4824351">.</span><span class="ident" id="4824352">ContentLength</span><span class="op" id="4824365">)</span><span class="op" id="4824366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824372">return</span>&nbsp;<span class="ident" id="4824379">r</span><span class="op" id="4824380">,</span>&nbsp;<span class="ident" id="4824382">nil</span><br>
<span class="lineno"></span><span class="op" id="4824386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4824389">func</span>&nbsp;<span class="ident" id="4824394">envMap</span><span class="op" id="4824400">(</span><span class="ident" id="4824401">env</span>&nbsp;<span class="op" id="4824405">[</span><span class="op" id="4824406">]</span><span class="builtintype" id="4824407">string</span><span class="op" id="4824413">)</span>&nbsp;<span class="keyword" id="4824415">map</span><span class="op" id="4824418">[</span><span class="builtintype" id="4824419">string</span><span class="op" id="4824425">]</span><span class="builtintype" id="4824426">string</span>&nbsp;<span class="op" id="4824433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824436">m</span>&nbsp;<span class="op" id="4824438">:=</span>&nbsp;<span class="builtinfunc" id="4824441">make</span><span class="op" id="4824445">(</span><span class="keyword" id="4824446">map</span><span class="op" id="4824449">[</span><span class="builtintype" id="4824450">string</span><span class="op" id="4824456">]</span><span class="builtintype" id="4824457">string</span><span class="op" id="4824463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824466">for</span>&nbsp;<span class="ident" id="4824470">_</span><span class="op" id="4824471">,</span>&nbsp;<span class="ident" id="4824473">kv</span>&nbsp;<span class="op" id="4824476">:=</span>&nbsp;<span class="keyword" id="4824479">range</span>&nbsp;<span class="ident" id="4824485">env</span>&nbsp;<span class="op" id="4824489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824493">if</span>&nbsp;<span class="ident" id="4824496">idx</span>&nbsp;<span class="op" id="4824500">:=</span>&nbsp;<span class="ident" id="4824503">strings</span><span class="op" id="4824510">.</span><span class="ident" id="4824511">Index</span><span class="op" id="4824516">(</span><span class="ident" id="4824517">kv</span><span class="op" id="4824519">,</span>&nbsp;<span class="string" id="4824521">&#34;=&#34;</span><span class="op" id="4824524">)</span><span class="op" id="4824525">;</span>&nbsp;<span class="ident" id="4824527">idx</span>&nbsp;<span class="op" id="4824531">!=</span>&nbsp;<span class="op" id="4824534">-</span><span class="num" id="4824535">1</span>&nbsp;<span class="op" id="4824537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824542">m</span><span class="op" id="4824543">[</span><span class="ident" id="4824544">kv</span><span class="op" id="4824546">[</span><span class="op" id="4824547">:</span><span class="ident" id="4824548">idx</span><span class="op" id="4824551">]</span><span class="op" id="4824552">]</span>&nbsp;<span class="op" id="4824554">=</span>&nbsp;<span class="ident" id="4824556">kv</span><span class="op" id="4824558">[</span><span class="ident" id="4824559">idx</span><span class="op" id="4824562">+</span><span class="num" id="4824563">1</span><span class="op" id="4824564">:</span><span class="op" id="4824565">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824575">return</span>&nbsp;<span class="ident" id="4824582">m</span><br>
<span class="lineno"></span><span class="op" id="4824584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4824587">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="4824649">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="4824704">func</span>&nbsp;<span class="ident" id="4824709">RequestFromMap</span><span class="op" id="4824723">(</span><span class="ident" id="4824724">params</span>&nbsp;<span class="keyword" id="4824731">map</span><span class="op" id="4824734">[</span><span class="builtintype" id="4824735">string</span><span class="op" id="4824741">]</span><span class="builtintype" id="4824742">string</span><span class="op" id="4824748">)</span>&nbsp;<span class="op" id="4824750">(</span><span class="op" id="4824751">*</span><span class="ident" id="4824752">http</span><span class="op" id="4824756">.</span><span class="ident" id="4824757">Request</span><span class="op" id="4824764">,</span>&nbsp;<span class="builtintype" id="4824766">error</span><span class="op" id="4824771">)</span>&nbsp;<span class="op" id="4824773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824776">r</span>&nbsp;<span class="op" id="4824778">:=</span>&nbsp;<span class="builtinfunc" id="4824781">new</span><span class="op" id="4824784">(</span><span class="ident" id="4824785">http</span><span class="op" id="4824789">.</span><span class="ident" id="4824790">Request</span><span class="op" id="4824797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824800">r</span><span class="op" id="4824801">.</span><span class="ident" id="4824802">Method</span>&nbsp;<span class="op" id="4824809">=</span>&nbsp;<span class="ident" id="4824811">params</span><span class="op" id="4824817">[</span><span class="string" id="4824818">&#34;REQUEST_METHOD&#34;</span><span class="op" id="4824834">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824837">if</span>&nbsp;<span class="ident" id="4824840">r</span><span class="op" id="4824841">.</span><span class="ident" id="4824842">Method</span>&nbsp;<span class="op" id="4824849">==</span>&nbsp;<span class="string" id="4824852">&#34;&#34;</span>&nbsp;<span class="op" id="4824855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824859">return</span>&nbsp;<span class="ident" id="4824866">nil</span><span class="op" id="4824869">,</span>&nbsp;<span class="ident" id="4824871">errors</span><span class="op" id="4824877">.</span><span class="ident" id="4824878">New</span><span class="op" id="4824881">(</span><span class="string" id="4824882">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="4824921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824928">r</span><span class="op" id="4824929">.</span><span class="ident" id="4824930">Proto</span>&nbsp;<span class="op" id="4824936">=</span>&nbsp;<span class="ident" id="4824938">params</span><span class="op" id="4824944">[</span><span class="string" id="4824945">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="4824962">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824965">var</span>&nbsp;<span class="ident" id="4824969">ok</span>&nbsp;<span class="builtintype" id="4824972">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824978">r</span><span class="op" id="4824979">.</span><span class="ident" id="4824980">ProtoMajor</span><span class="op" id="4824990">,</span>&nbsp;<span class="ident" id="4824992">r</span><span class="op" id="4824993">.</span><span class="ident" id="4824994">ProtoMinor</span><span class="op" id="4825004">,</span>&nbsp;<span class="ident" id="4825006">ok</span>&nbsp;<span class="op" id="4825009">=</span>&nbsp;<span class="ident" id="4825011">http</span><span class="op" id="4825015">.</span><span class="ident" id="4825016">ParseHTTPVersion</span><span class="op" id="4825032">(</span><span class="ident" id="4825033">r</span><span class="op" id="4825034">.</span><span class="ident" id="4825035">Proto</span><span class="op" id="4825040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825043">if</span>&nbsp;<span class="op" id="4825046">!</span><span class="ident" id="4825047">ok</span>&nbsp;<span class="op" id="4825050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825054">return</span>&nbsp;<span class="ident" id="4825061">nil</span><span class="op" id="4825064">,</span>&nbsp;<span class="ident" id="4825066">errors</span><span class="op" id="4825072">.</span><span class="ident" id="4825073">New</span><span class="op" id="4825076">(</span><span class="string" id="4825077">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="4825115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825118">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825122">r</span><span class="op" id="4825123">.</span><span class="ident" id="4825124">Close</span>&nbsp;<span class="op" id="4825130">=</span>&nbsp;<span class="builtintype" id="4825132">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825138">r</span><span class="op" id="4825139">.</span><span class="ident" id="4825140">Trailer</span>&nbsp;<span class="op" id="4825148">=</span>&nbsp;<span class="ident" id="4825150">http</span><span class="op" id="4825154">.</span><span class="ident" id="4825155">Header</span><span class="op" id="4825161">{</span><span class="op" id="4825162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825165">r</span><span class="op" id="4825166">.</span><span class="ident" id="4825167">Header</span>&nbsp;<span class="op" id="4825174">=</span>&nbsp;<span class="ident" id="4825176">http</span><span class="op" id="4825180">.</span><span class="ident" id="4825181">Header</span><span class="op" id="4825187">{</span><span class="op" id="4825188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825192">r</span><span class="op" id="4825193">.</span><span class="ident" id="4825194">Host</span>&nbsp;<span class="op" id="4825199">=</span>&nbsp;<span class="ident" id="4825201">params</span><span class="op" id="4825207">[</span><span class="string" id="4825208">&#34;HTTP_HOST&#34;</span><span class="op" id="4825219">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825223">if</span>&nbsp;<span class="ident" id="4825226">lenstr</span>&nbsp;<span class="op" id="4825233">:=</span>&nbsp;<span class="ident" id="4825236">params</span><span class="op" id="4825242">[</span><span class="string" id="4825243">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="4825259">]</span><span class="op" id="4825260">;</span>&nbsp;<span class="ident" id="4825262">lenstr</span>&nbsp;<span class="op" id="4825269">!=</span>&nbsp;<span class="string" id="4825272">&#34;&#34;</span>&nbsp;<span class="op" id="4825275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825279">clen</span><span class="op" id="4825283">,</span>&nbsp;<span class="ident" id="4825285">err</span>&nbsp;<span class="op" id="4825289">:=</span>&nbsp;<span class="ident" id="4825292">strconv</span><span class="op" id="4825299">.</span><span class="ident" id="4825300">ParseInt</span><span class="op" id="4825308">(</span><span class="ident" id="4825309">lenstr</span><span class="op" id="4825315">,</span>&nbsp;<span class="num" id="4825317">10</span><span class="op" id="4825319">,</span>&nbsp;<span class="num" id="4825321">64</span><span class="op" id="4825323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825327">if</span>&nbsp;<span class="ident" id="4825330">err</span>&nbsp;<span class="op" id="4825334">!=</span>&nbsp;<span class="ident" id="4825337">nil</span>&nbsp;<span class="op" id="4825341">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825346">return</span>&nbsp;<span class="ident" id="4825353">nil</span><span class="op" id="4825356">,</span>&nbsp;<span class="ident" id="4825358">errors</span><span class="op" id="4825364">.</span><span class="ident" id="4825365">New</span><span class="op" id="4825368">(</span><span class="string" id="4825369">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="4825412">+</span>&nbsp;<span class="ident" id="4825414">lenstr</span><span class="op" id="4825420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825428">r</span><span class="op" id="4825429">.</span><span class="ident" id="4825430">ContentLength</span>&nbsp;<span class="op" id="4825444">=</span>&nbsp;<span class="ident" id="4825446">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825456">if</span>&nbsp;<span class="ident" id="4825459">ct</span>&nbsp;<span class="op" id="4825462">:=</span>&nbsp;<span class="ident" id="4825465">params</span><span class="op" id="4825471">[</span><span class="string" id="4825472">&#34;CONTENT_TYPE&#34;</span><span class="op" id="4825486">]</span><span class="op" id="4825487">;</span>&nbsp;<span class="ident" id="4825489">ct</span>&nbsp;<span class="op" id="4825492">!=</span>&nbsp;<span class="string" id="4825495">&#34;&#34;</span>&nbsp;<span class="op" id="4825498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825502">r</span><span class="op" id="4825503">.</span><span class="ident" id="4825504">Header</span><span class="op" id="4825510">.</span><span class="ident" id="4825511">Set</span><span class="op" id="4825514">(</span><span class="string" id="4825515">&#34;Content-Type&#34;</span><span class="op" id="4825529">,</span>&nbsp;<span class="ident" id="4825531">ct</span><span class="op" id="4825533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4825540">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825595">for</span>&nbsp;<span class="ident" id="4825599">k</span><span class="op" id="4825600">,</span>&nbsp;<span class="ident" id="4825602">v</span>&nbsp;<span class="op" id="4825604">:=</span>&nbsp;<span class="keyword" id="4825607">range</span>&nbsp;<span class="ident" id="4825613">params</span>&nbsp;<span class="op" id="4825620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825624">if</span>&nbsp;<span class="op" id="4825627">!</span><span class="ident" id="4825628">strings</span><span class="op" id="4825635">.</span><span class="ident" id="4825636">HasPrefix</span><span class="op" id="4825645">(</span><span class="ident" id="4825646">k</span><span class="op" id="4825647">,</span>&nbsp;<span class="string" id="4825649">&#34;HTTP_&#34;</span><span class="op" id="4825656">)</span>&nbsp;<span class="op" id="4825658">||</span>&nbsp;<span class="ident" id="4825661">k</span>&nbsp;<span class="op" id="4825663">==</span>&nbsp;<span class="string" id="4825666">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="4825678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825683">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825698">r</span><span class="op" id="4825699">.</span><span class="ident" id="4825700">Header</span><span class="op" id="4825706">.</span><span class="ident" id="4825707">Add</span><span class="op" id="4825710">(</span><span class="ident" id="4825711">strings</span><span class="op" id="4825718">.</span><span class="ident" id="4825719">Replace</span><span class="op" id="4825726">(</span><span class="ident" id="4825727">k</span><span class="op" id="4825728">[</span><span class="num" id="4825729">5</span><span class="op" id="4825730">:</span><span class="op" id="4825731">]</span><span class="op" id="4825732">,</span>&nbsp;<span class="string" id="4825734">&#34;_&#34;</span><span class="op" id="4825737">,</span>&nbsp;<span class="string" id="4825739">&#34;-&#34;</span><span class="op" id="4825742">,</span>&nbsp;<span class="op" id="4825744">-</span><span class="num" id="4825745">1</span><span class="op" id="4825746">)</span><span class="op" id="4825747">,</span>&nbsp;<span class="ident" id="4825749">v</span><span class="op" id="4825750">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4825757">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825815">uriStr</span>&nbsp;<span class="op" id="4825822">:=</span>&nbsp;<span class="ident" id="4825825">params</span><span class="op" id="4825831">[</span><span class="string" id="4825832">&#34;REQUEST_URI&#34;</span><span class="op" id="4825845">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825848">if</span>&nbsp;<span class="ident" id="4825851">uriStr</span>&nbsp;<span class="op" id="4825858">==</span>&nbsp;<span class="string" id="4825861">&#34;&#34;</span>&nbsp;<span class="op" id="4825864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4825868">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825926">uriStr</span>&nbsp;<span class="op" id="4825933">=</span>&nbsp;<span class="ident" id="4825935">params</span><span class="op" id="4825941">[</span><span class="string" id="4825942">&#34;SCRIPT_NAME&#34;</span><span class="op" id="4825955">]</span>&nbsp;<span class="op" id="4825957">+</span>&nbsp;<span class="ident" id="4825959">params</span><span class="op" id="4825965">[</span><span class="string" id="4825966">&#34;PATH_INFO&#34;</span><span class="op" id="4825977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825981">s</span>&nbsp;<span class="op" id="4825983">:=</span>&nbsp;<span class="ident" id="4825986">params</span><span class="op" id="4825992">[</span><span class="string" id="4825993">&#34;QUERY_STRING&#34;</span><span class="op" id="4826007">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826011">if</span>&nbsp;<span class="ident" id="4826014">s</span>&nbsp;<span class="op" id="4826016">!=</span>&nbsp;<span class="string" id="4826019">&#34;&#34;</span>&nbsp;<span class="op" id="4826022">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826027">uriStr</span>&nbsp;<span class="op" id="4826034">+=</span>&nbsp;<span class="string" id="4826037">&#34;?&#34;</span>&nbsp;<span class="op" id="4826041">+</span>&nbsp;<span class="ident" id="4826043">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826054">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826107">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826174">if</span>&nbsp;<span class="ident" id="4826177">s</span>&nbsp;<span class="op" id="4826179">:=</span>&nbsp;<span class="ident" id="4826182">params</span><span class="op" id="4826188">[</span><span class="string" id="4826189">&#34;HTTPS&#34;</span><span class="op" id="4826196">]</span><span class="op" id="4826197">;</span>&nbsp;<span class="ident" id="4826199">s</span>&nbsp;<span class="op" id="4826201">==</span>&nbsp;<span class="string" id="4826204">&#34;on&#34;</span>&nbsp;<span class="op" id="4826209">||</span>&nbsp;<span class="ident" id="4826212">s</span>&nbsp;<span class="op" id="4826214">==</span>&nbsp;<span class="string" id="4826217">&#34;ON&#34;</span>&nbsp;<span class="op" id="4826222">||</span>&nbsp;<span class="ident" id="4826225">s</span>&nbsp;<span class="op" id="4826227">==</span>&nbsp;<span class="string" id="4826230">&#34;1&#34;</span>&nbsp;<span class="op" id="4826234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826238">r</span><span class="op" id="4826239">.</span><span class="ident" id="4826240">TLS</span>&nbsp;<span class="op" id="4826244">=</span>&nbsp;<span class="op" id="4826246">&amp;</span><span class="ident" id="4826247">tls</span><span class="op" id="4826250">.</span><span class="ident" id="4826251">ConnectionState</span><span class="op" id="4826266">{</span><span class="ident" id="4826267">HandshakeComplete</span><span class="op" id="4826284">:</span>&nbsp;<span class="builtintype" id="4826286">true</span><span class="op" id="4826290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826297">if</span>&nbsp;<span class="ident" id="4826300">r</span><span class="op" id="4826301">.</span><span class="ident" id="4826302">Host</span>&nbsp;<span class="op" id="4826307">!=</span>&nbsp;<span class="string" id="4826310">&#34;&#34;</span>&nbsp;<span class="op" id="4826313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826317">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826382">rawurl</span>&nbsp;<span class="op" id="4826389">:=</span>&nbsp;<span class="ident" id="4826392">r</span><span class="op" id="4826393">.</span><span class="ident" id="4826394">Host</span>&nbsp;<span class="op" id="4826399">+</span>&nbsp;<span class="ident" id="4826401">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826410">if</span>&nbsp;<span class="ident" id="4826413">r</span><span class="op" id="4826414">.</span><span class="ident" id="4826415">TLS</span>&nbsp;<span class="op" id="4826419">==</span>&nbsp;<span class="ident" id="4826422">nil</span>&nbsp;<span class="op" id="4826426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826431">rawurl</span>&nbsp;<span class="op" id="4826438">=</span>&nbsp;<span class="string" id="4826440">&#34;http://&#34;</span>&nbsp;<span class="op" id="4826450">+</span>&nbsp;<span class="ident" id="4826452">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826461">}</span>&nbsp;<span class="keyword" id="4826463">else</span>&nbsp;<span class="op" id="4826468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826473">rawurl</span>&nbsp;<span class="op" id="4826480">=</span>&nbsp;<span class="string" id="4826482">&#34;https://&#34;</span>&nbsp;<span class="op" id="4826493">+</span>&nbsp;<span class="ident" id="4826495">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826508">url</span><span class="op" id="4826511">,</span>&nbsp;<span class="ident" id="4826513">err</span>&nbsp;<span class="op" id="4826517">:=</span>&nbsp;<span class="ident" id="4826520">url</span><span class="op" id="4826523">.</span><span class="ident" id="4826524">Parse</span><span class="op" id="4826529">(</span><span class="ident" id="4826530">rawurl</span><span class="op" id="4826536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826540">if</span>&nbsp;<span class="ident" id="4826543">err</span>&nbsp;<span class="op" id="4826547">!=</span>&nbsp;<span class="ident" id="4826550">nil</span>&nbsp;<span class="op" id="4826554">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826559">return</span>&nbsp;<span class="ident" id="4826566">nil</span><span class="op" id="4826569">,</span>&nbsp;<span class="ident" id="4826571">errors</span><span class="op" id="4826577">.</span><span class="ident" id="4826578">New</span><span class="op" id="4826581">(</span><span class="string" id="4826582">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="4826639">+</span>&nbsp;<span class="ident" id="4826641">rawurl</span><span class="op" id="4826647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826655">r</span><span class="op" id="4826656">.</span><span class="ident" id="4826657">URL</span>&nbsp;<span class="op" id="4826661">=</span>&nbsp;<span class="ident" id="4826663">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826671">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826732">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826752">if</span>&nbsp;<span class="ident" id="4826755">r</span><span class="op" id="4826756">.</span><span class="ident" id="4826757">URL</span>&nbsp;<span class="op" id="4826761">==</span>&nbsp;<span class="ident" id="4826764">nil</span>&nbsp;<span class="op" id="4826768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826772">url</span><span class="op" id="4826775">,</span>&nbsp;<span class="ident" id="4826777">err</span>&nbsp;<span class="op" id="4826781">:=</span>&nbsp;<span class="ident" id="4826784">url</span><span class="op" id="4826787">.</span><span class="ident" id="4826788">Parse</span><span class="op" id="4826793">(</span><span class="ident" id="4826794">uriStr</span><span class="op" id="4826800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826804">if</span>&nbsp;<span class="ident" id="4826807">err</span>&nbsp;<span class="op" id="4826811">!=</span>&nbsp;<span class="ident" id="4826814">nil</span>&nbsp;<span class="op" id="4826818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4826823">return</span>&nbsp;<span class="ident" id="4826830">nil</span><span class="op" id="4826833">,</span>&nbsp;<span class="ident" id="4826835">errors</span><span class="op" id="4826841">.</span><span class="ident" id="4826842">New</span><span class="op" id="4826845">(</span><span class="string" id="4826846">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="4826894">+</span>&nbsp;<span class="ident" id="4826896">uriStr</span><span class="op" id="4826902">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826910">r</span><span class="op" id="4826911">.</span><span class="ident" id="4826912">URL</span>&nbsp;<span class="op" id="4826916">=</span>&nbsp;<span class="ident" id="4826918">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4826923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826927">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826989">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827053">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827074">r</span><span class="op" id="4827075">.</span><span class="ident" id="4827076">RemoteAddr</span>&nbsp;<span class="op" id="4827087">=</span>&nbsp;<span class="ident" id="4827089">net</span><span class="op" id="4827092">.</span><span class="ident" id="4827093">JoinHostPort</span><span class="op" id="4827105">(</span><span class="ident" id="4827106">params</span><span class="op" id="4827112">[</span><span class="string" id="4827113">&#34;REMOTE_ADDR&#34;</span><span class="op" id="4827126">]</span><span class="op" id="4827127">,</span>&nbsp;<span class="string" id="4827129">&#34;0&#34;</span><span class="op" id="4827132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827136">return</span>&nbsp;<span class="ident" id="4827143">r</span><span class="op" id="4827144">,</span>&nbsp;<span class="ident" id="4827146">nil</span><br>
<span class="lineno">140</span><span class="op" id="4827150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4827153">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="4827220">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="4827278">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="4827342">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4827367">func</span>&nbsp;<span class="ident" id="4827372">Serve</span><span class="op" id="4827377">(</span><span class="ident" id="4827378">handler</span>&nbsp;<span class="ident" id="4827386">http</span><span class="op" id="4827390">.</span><span class="ident" id="4827391">Handler</span><span class="op" id="4827398">)</span>&nbsp;<span class="builtintype" id="4827400">error</span>&nbsp;<span class="op" id="4827406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827409">req</span><span class="op" id="4827412">,</span>&nbsp;<span class="ident" id="4827414">err</span>&nbsp;<span class="op" id="4827418">:=</span>&nbsp;<span class="ident" id="4827421">Request</span><span class="op" id="4827428">(</span><span class="op" id="4827429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827432">if</span>&nbsp;<span class="ident" id="4827435">err</span>&nbsp;<span class="op" id="4827439">!=</span>&nbsp;<span class="ident" id="4827442">nil</span>&nbsp;<span class="op" id="4827446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827450">return</span>&nbsp;<span class="ident" id="4827457">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827465">if</span>&nbsp;<span class="ident" id="4827468">handler</span>&nbsp;<span class="op" id="4827476">==</span>&nbsp;<span class="ident" id="4827479">nil</span>&nbsp;<span class="op" id="4827483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827487">handler</span>&nbsp;<span class="op" id="4827495">=</span>&nbsp;<span class="ident" id="4827497">http</span><span class="op" id="4827501">.</span><span class="ident" id="4827502">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827522">rw</span>&nbsp;<span class="op" id="4827525">:=</span>&nbsp;<span class="op" id="4827528">&amp;</span><span class="ident" id="4827529">response</span><span class="op" id="4827537">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827541">req</span><span class="op" id="4827544">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4827549">req</span><span class="op" id="4827552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827556">header</span><span class="op" id="4827562">:</span>&nbsp;<span class="builtinfunc" id="4827564">make</span><span class="op" id="4827568">(</span><span class="ident" id="4827569">http</span><span class="op" id="4827573">.</span><span class="ident" id="4827574">Header</span><span class="op" id="4827580">)</span><span class="op" id="4827581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827585">bufw</span><span class="op" id="4827589">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4827593">bufio</span><span class="op" id="4827598">.</span><span class="ident" id="4827599">NewWriter</span><span class="op" id="4827608">(</span><span class="ident" id="4827609">os</span><span class="op" id="4827611">.</span><span class="ident" id="4827612">Stdout</span><span class="op" id="4827618">)</span><span class="op" id="4827619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827625">handler</span><span class="op" id="4827632">.</span><span class="ident" id="4827633">ServeHTTP</span><span class="op" id="4827642">(</span><span class="ident" id="4827643">rw</span><span class="op" id="4827645">,</span>&nbsp;<span class="ident" id="4827647">req</span><span class="op" id="4827650">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827653">rw</span><span class="op" id="4827655">.</span><span class="ident" id="4827656">Write</span><span class="op" id="4827661">(</span><span class="ident" id="4827662">nil</span><span class="op" id="4827665">)</span>&nbsp;<span class="comment" id="4827667">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827700">if</span>&nbsp;<span class="ident" id="4827703">err</span>&nbsp;<span class="op" id="4827707">=</span>&nbsp;<span class="ident" id="4827709">rw</span><span class="op" id="4827711">.</span><span class="ident" id="4827712">bufw</span><span class="op" id="4827716">.</span><span class="ident" id="4827717">Flush</span><span class="op" id="4827722">(</span><span class="op" id="4827723">)</span><span class="op" id="4827724">;</span>&nbsp;<span class="ident" id="4827726">err</span>&nbsp;<span class="op" id="4827730">!=</span>&nbsp;<span class="ident" id="4827733">nil</span>&nbsp;<span class="op" id="4827737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827741">return</span>&nbsp;<span class="ident" id="4827748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827756">return</span>&nbsp;<span class="ident" id="4827763">nil</span><br>
<span class="lineno">165</span><span class="op" id="4827767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827770">type</span>&nbsp;<span class="ident" id="4827775">response</span>&nbsp;<span class="keyword" id="4827784">struct</span>&nbsp;<span class="op" id="4827791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827794">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4827805">*</span><span class="ident" id="4827806">http</span><span class="op" id="4827810">.</span><span class="ident" id="4827811">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827820">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4827831">http</span><span class="op" id="4827835">.</span><span class="ident" id="4827836">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827844">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4827855">*</span><span class="ident" id="4827856">bufio</span><span class="op" id="4827861">.</span><span class="ident" id="4827862">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827870">headerSent</span>&nbsp;<span class="builtintype" id="4827881">bool</span><br>
<span class="lineno"></span><span class="op" id="4827886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827889">func</span>&nbsp;<span class="op" id="4827894">(</span><span class="ident" id="4827895">r</span>&nbsp;<span class="op" id="4827897">*</span><span class="ident" id="4827898">response</span><span class="op" id="4827906">)</span>&nbsp;<span class="ident" id="4827908">Flush</span><span class="op" id="4827913">(</span><span class="op" id="4827914">)</span>&nbsp;<span class="op" id="4827916">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827919">r</span><span class="op" id="4827920">.</span><span class="ident" id="4827921">bufw</span><span class="op" id="4827925">.</span><span class="ident" id="4827926">Flush</span><span class="op" id="4827931">(</span><span class="op" id="4827932">)</span><br>
<span class="lineno"></span><span class="op" id="4827934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827937">func</span>&nbsp;<span class="op" id="4827942">(</span><span class="ident" id="4827943">r</span>&nbsp;<span class="op" id="4827945">*</span><span class="ident" id="4827946">response</span><span class="op" id="4827954">)</span>&nbsp;<span class="ident" id="4827956">Header</span><span class="op" id="4827962">(</span><span class="op" id="4827963">)</span>&nbsp;<span class="ident" id="4827965">http</span><span class="op" id="4827969">.</span><span class="ident" id="4827970">Header</span>&nbsp;<span class="op" id="4827977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827980">return</span>&nbsp;<span class="ident" id="4827987">r</span><span class="op" id="4827988">.</span><span class="ident" id="4827989">header</span><br>
<span class="lineno">180</span><span class="op" id="4827996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827999">func</span>&nbsp;<span class="op" id="4828004">(</span><span class="ident" id="4828005">r</span>&nbsp;<span class="op" id="4828007">*</span><span class="ident" id="4828008">response</span><span class="op" id="4828016">)</span>&nbsp;<span class="ident" id="4828018">Write</span><span class="op" id="4828023">(</span><span class="ident" id="4828024">p</span>&nbsp;<span class="op" id="4828026">[</span><span class="op" id="4828027">]</span><span class="builtintype" id="4828028">byte</span><span class="op" id="4828032">)</span>&nbsp;<span class="op" id="4828034">(</span><span class="ident" id="4828035">n</span>&nbsp;<span class="builtintype" id="4828037">int</span><span class="op" id="4828040">,</span>&nbsp;<span class="ident" id="4828042">err</span>&nbsp;<span class="builtintype" id="4828046">error</span><span class="op" id="4828051">)</span>&nbsp;<span class="op" id="4828053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828056">if</span>&nbsp;<span class="op" id="4828059">!</span><span class="ident" id="4828060">r</span><span class="op" id="4828061">.</span><span class="ident" id="4828062">headerSent</span>&nbsp;<span class="op" id="4828073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828077">r</span><span class="op" id="4828078">.</span><span class="ident" id="4828079">WriteHeader</span><span class="op" id="4828090">(</span><span class="ident" id="4828091">http</span><span class="op" id="4828095">.</span><span class="ident" id="4828096">StatusOK</span><span class="op" id="4828104">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828110">return</span>&nbsp;<span class="ident" id="4828117">r</span><span class="op" id="4828118">.</span><span class="ident" id="4828119">bufw</span><span class="op" id="4828123">.</span><span class="ident" id="4828124">Write</span><span class="op" id="4828129">(</span><span class="ident" id="4828130">p</span><span class="op" id="4828131">)</span><br>
<span class="lineno"></span><span class="op" id="4828133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4828136">func</span>&nbsp;<span class="op" id="4828141">(</span><span class="ident" id="4828142">r</span>&nbsp;<span class="op" id="4828144">*</span><span class="ident" id="4828145">response</span><span class="op" id="4828153">)</span>&nbsp;<span class="ident" id="4828155">WriteHeader</span><span class="op" id="4828166">(</span><span class="ident" id="4828167">code</span>&nbsp;<span class="builtintype" id="4828172">int</span><span class="op" id="4828175">)</span>&nbsp;<span class="op" id="4828177">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828180">if</span>&nbsp;<span class="ident" id="4828183">r</span><span class="op" id="4828184">.</span><span class="ident" id="4828185">headerSent</span>&nbsp;<span class="op" id="4828196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828200">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828266">fmt</span><span class="op" id="4828269">.</span><span class="ident" id="4828270">Fprintf</span><span class="op" id="4828277">(</span><span class="ident" id="4828278">os</span><span class="op" id="4828280">.</span><span class="ident" id="4828281">Stderr</span><span class="op" id="4828287">,</span>&nbsp;<span class="string" id="4828289">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4828344">,</span>&nbsp;<span class="ident" id="4828346">r</span><span class="op" id="4828347">.</span><span class="ident" id="4828348">req</span><span class="op" id="4828351">.</span><span class="ident" id="4828352">URL</span><span class="op" id="4828355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828359">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828367">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828370">r</span><span class="op" id="4828371">.</span><span class="ident" id="4828372">headerSent</span>&nbsp;<span class="op" id="4828383">=</span>&nbsp;<span class="builtintype" id="4828385">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828391">fmt</span><span class="op" id="4828394">.</span><span class="ident" id="4828395">Fprintf</span><span class="op" id="4828402">(</span><span class="ident" id="4828403">r</span><span class="op" id="4828404">.</span><span class="ident" id="4828405">bufw</span><span class="op" id="4828409">,</span>&nbsp;<span class="string" id="4828411">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="4828430">,</span>&nbsp;<span class="ident" id="4828432">code</span><span class="op" id="4828436">,</span>&nbsp;<span class="ident" id="4828438">http</span><span class="op" id="4828442">.</span><span class="ident" id="4828443">StatusText</span><span class="op" id="4828453">(</span><span class="ident" id="4828454">code</span><span class="op" id="4828458">)</span><span class="op" id="4828459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828463">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4828494">if</span>&nbsp;<span class="ident" id="4828497">_</span><span class="op" id="4828498">,</span>&nbsp;<span class="ident" id="4828500">hasType</span>&nbsp;<span class="op" id="4828508">:=</span>&nbsp;<span class="ident" id="4828511">r</span><span class="op" id="4828512">.</span><span class="ident" id="4828513">header</span><span class="op" id="4828519">[</span><span class="string" id="4828520">&#34;Content-Type&#34;</span><span class="op" id="4828534">]</span><span class="op" id="4828535">;</span>&nbsp;<span class="op" id="4828537">!</span><span class="ident" id="4828538">hasType</span>&nbsp;<span class="op" id="4828546">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828550">r</span><span class="op" id="4828551">.</span><span class="ident" id="4828552">header</span><span class="op" id="4828558">.</span><span class="ident" id="4828559">Add</span><span class="op" id="4828562">(</span><span class="string" id="4828563">&#34;Content-Type&#34;</span><span class="op" id="4828577">,</span>&nbsp;<span class="string" id="4828579">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="4828605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4828608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828612">r</span><span class="op" id="4828613">.</span><span class="ident" id="4828614">header</span><span class="op" id="4828620">.</span><span class="ident" id="4828621">Write</span><span class="op" id="4828626">(</span><span class="ident" id="4828627">r</span><span class="op" id="4828628">.</span><span class="ident" id="4828629">bufw</span><span class="op" id="4828633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828636">r</span><span class="op" id="4828637">.</span><span class="ident" id="4828638">bufw</span><span class="op" id="4828642">.</span><span class="ident" id="4828643">WriteString</span><span class="op" id="4828654">(</span><span class="string" id="4828655">&#34;\r\n&#34;</span><span class="op" id="4828661">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828664">r</span><span class="op" id="4828665">.</span><span class="ident" id="4828666">bufw</span><span class="op" id="4828670">.</span><span class="ident" id="4828671">Flush</span><span class="op" id="4828676">(</span><span class="op" id="4828677">)</span><br>
<span class="lineno"></span><span class="op" id="4828679">}</span>
</div>
</body>
</html>
