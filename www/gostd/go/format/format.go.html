<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html" class="current">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4451751">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4451806">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4451860">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4451911">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="4451974">package</span>&nbsp;<span class="ident" id="4451982">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4451990">import</span>&nbsp;<span class="op" id="4451997">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452000">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452009">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452016">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452026">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452039">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452053">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452065">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4452071">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4452081">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4452084">var</span>&nbsp;<span class="ident" id="4452088">config</span>&nbsp;<span class="op" id="4452095">=</span>&nbsp;<span class="ident" id="4452097">printer</span><span class="op" id="4452104">.</span><span class="ident" id="4452105">Config</span><span class="op" id="4452111">{</span><span class="ident" id="4452112">Mode</span><span class="op" id="4452116">:</span>&nbsp;<span class="ident" id="4452118">printer</span><span class="op" id="4452125">.</span><span class="ident" id="4452126">UseSpaces</span>&nbsp;<span class="op" id="4452136">|</span>&nbsp;<span class="ident" id="4452138">printer</span><span class="op" id="4452145">.</span><span class="ident" id="4452146">TabIndent</span><span class="op" id="4452155">,</span>&nbsp;<span class="ident" id="4452157">Tabwidth</span><span class="op" id="4452165">:</span>&nbsp;<span class="num" id="4452167">8</span><span class="op" id="4452168">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4452171">const</span>&nbsp;<span class="ident" id="4452177">parserMode</span>&nbsp;<span class="op" id="4452188">=</span>&nbsp;<span class="ident" id="4452190">parser</span><span class="op" id="4452196">.</span><span class="ident" id="4452197">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4452212">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="4452288">//</span><br>
<span class="lineno">25</span><span class="comment" id="4452291">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="4452363">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="4452436">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4452506">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4452578">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="4452647">//</span><br>
<span class="lineno"></span><span class="comment" id="4452650">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="4452721">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="4452793">//</span><br>
<span class="lineno"></span><span class="keyword" id="4452796">func</span>&nbsp;<span class="ident" id="4452801">Node</span><span class="op" id="4452805">(</span><span class="ident" id="4452806">dst</span>&nbsp;<span class="ident" id="4452810">io</span><span class="op" id="4452812">.</span><span class="ident" id="4452813">Writer</span><span class="op" id="4452819">,</span>&nbsp;<span class="ident" id="4452821">fset</span>&nbsp;<span class="op" id="4452826">*</span><span class="ident" id="4452827">token</span><span class="op" id="4452832">.</span><span class="ident" id="4452833">FileSet</span><span class="op" id="4452840">,</span>&nbsp;<span class="ident" id="4452842">node</span>&nbsp;<span class="keyword" id="4452847">interface</span><span class="op" id="4452856">{</span><span class="op" id="4452857">}</span><span class="op" id="4452858">)</span>&nbsp;<span class="builtintype" id="4452860">error</span>&nbsp;<span class="op" id="4452866">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4452869">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452932">var</span>&nbsp;<span class="ident" id="4452936">file</span>&nbsp;<span class="op" id="4452941">*</span><span class="ident" id="4452942">ast</span><span class="op" id="4452945">.</span><span class="ident" id="4452946">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452952">var</span>&nbsp;<span class="ident" id="4452956">cnode</span>&nbsp;<span class="op" id="4452962">*</span><span class="ident" id="4452963">printer</span><span class="op" id="4452970">.</span><span class="ident" id="4452971">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4452986">switch</span>&nbsp;<span class="ident" id="4452993">n</span>&nbsp;<span class="op" id="4452995">:=</span>&nbsp;<span class="ident" id="4452998">node</span><span class="op" id="4453002">.</span><span class="op" id="4453003">(</span><span class="keyword" id="4453004">type</span><span class="op" id="4453008">)</span>&nbsp;<span class="op" id="4453010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453013">case</span>&nbsp;<span class="op" id="4453018">*</span><span class="ident" id="4453019">ast</span><span class="op" id="4453022">.</span><span class="ident" id="4453023">File</span><span class="op" id="4453027">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453031">file</span>&nbsp;<span class="op" id="4453036">=</span>&nbsp;<span class="ident" id="4453038">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453041">case</span>&nbsp;<span class="op" id="4453046">*</span><span class="ident" id="4453047">printer</span><span class="op" id="4453054">.</span><span class="ident" id="4453055">CommentedNode</span><span class="op" id="4453068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453072">if</span>&nbsp;<span class="ident" id="4453075">f</span><span class="op" id="4453076">,</span>&nbsp;<span class="ident" id="4453078">ok</span>&nbsp;<span class="op" id="4453081">:=</span>&nbsp;<span class="ident" id="4453084">n</span><span class="op" id="4453085">.</span><span class="ident" id="4453086">Node</span><span class="op" id="4453090">.</span><span class="op" id="4453091">(</span><span class="op" id="4453092">*</span><span class="ident" id="4453093">ast</span><span class="op" id="4453096">.</span><span class="ident" id="4453097">File</span><span class="op" id="4453101">)</span><span class="op" id="4453102">;</span>&nbsp;<span class="ident" id="4453104">ok</span>&nbsp;<span class="op" id="4453107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453112">file</span>&nbsp;<span class="op" id="4453117">=</span>&nbsp;<span class="ident" id="4453119">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453124">cnode</span>&nbsp;<span class="op" id="4453130">=</span>&nbsp;<span class="ident" id="4453132">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4453143">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453174">if</span>&nbsp;<span class="ident" id="4453177">file</span>&nbsp;<span class="op" id="4453182">!=</span>&nbsp;<span class="ident" id="4453185">nil</span>&nbsp;<span class="op" id="4453189">&amp;&amp;</span>&nbsp;<span class="ident" id="4453192">hasUnsortedImports</span><span class="op" id="4453210">(</span><span class="ident" id="4453211">file</span><span class="op" id="4453215">)</span>&nbsp;<span class="op" id="4453217">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4453221">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4453289">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453330">var</span>&nbsp;<span class="ident" id="4453334">buf</span>&nbsp;<span class="ident" id="4453338">bytes</span><span class="op" id="4453343">.</span><span class="ident" id="4453344">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453353">err</span>&nbsp;<span class="op" id="4453357">:=</span>&nbsp;<span class="ident" id="4453360">config</span><span class="op" id="4453366">.</span><span class="ident" id="4453367">Fprint</span><span class="op" id="4453373">(</span><span class="op" id="4453374">&amp;</span><span class="ident" id="4453375">buf</span><span class="op" id="4453378">,</span>&nbsp;<span class="ident" id="4453380">fset</span><span class="op" id="4453384">,</span>&nbsp;<span class="ident" id="4453386">file</span><span class="op" id="4453390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453394">if</span>&nbsp;<span class="ident" id="4453397">err</span>&nbsp;<span class="op" id="4453401">!=</span>&nbsp;<span class="ident" id="4453404">nil</span>&nbsp;<span class="op" id="4453408">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453413">return</span>&nbsp;<span class="ident" id="4453420">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453430">file</span><span class="op" id="4453434">,</span>&nbsp;<span class="ident" id="4453436">err</span>&nbsp;<span class="op" id="4453440">=</span>&nbsp;<span class="ident" id="4453442">parser</span><span class="op" id="4453448">.</span><span class="ident" id="4453449">ParseFile</span><span class="op" id="4453458">(</span><span class="ident" id="4453459">fset</span><span class="op" id="4453463">,</span>&nbsp;<span class="string" id="4453465">&#34;&#34;</span><span class="op" id="4453467">,</span>&nbsp;<span class="ident" id="4453469">buf</span><span class="op" id="4453472">.</span><span class="ident" id="4453473">Bytes</span><span class="op" id="4453478">(</span><span class="op" id="4453479">)</span><span class="op" id="4453480">,</span>&nbsp;<span class="ident" id="4453482">parserMode</span><span class="op" id="4453492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453496">if</span>&nbsp;<span class="ident" id="4453499">err</span>&nbsp;<span class="op" id="4453503">!=</span>&nbsp;<span class="ident" id="4453506">nil</span>&nbsp;<span class="op" id="4453510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4453515">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453582">return</span>&nbsp;<span class="ident" id="4453589">fmt</span><span class="op" id="4453592">.</span><span class="ident" id="4453593">Errorf</span><span class="op" id="4453599">(</span><span class="string" id="4453600">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="4453633">,</span>&nbsp;<span class="ident" id="4453635">err</span><span class="op" id="4453638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453646">ast</span><span class="op" id="4453649">.</span><span class="ident" id="4453650">SortImports</span><span class="op" id="4453661">(</span><span class="ident" id="4453662">fset</span><span class="op" id="4453666">,</span>&nbsp;<span class="ident" id="4453668">file</span><span class="op" id="4453672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4453677">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453716">node</span>&nbsp;<span class="op" id="4453721">=</span>&nbsp;<span class="ident" id="4453723">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453730">if</span>&nbsp;<span class="ident" id="4453733">cnode</span>&nbsp;<span class="op" id="4453739">!=</span>&nbsp;<span class="ident" id="4453742">nil</span>&nbsp;<span class="op" id="4453746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4453751">node</span>&nbsp;<span class="op" id="4453756">=</span>&nbsp;<span class="op" id="4453758">&amp;</span><span class="ident" id="4453759">printer</span><span class="op" id="4453766">.</span><span class="ident" id="4453767">CommentedNode</span><span class="op" id="4453780">{</span><span class="ident" id="4453781">Node</span><span class="op" id="4453785">:</span>&nbsp;<span class="ident" id="4453787">file</span><span class="op" id="4453791">,</span>&nbsp;<span class="ident" id="4453793">Comments</span><span class="op" id="4453801">:</span>&nbsp;<span class="ident" id="4453803">cnode</span><span class="op" id="4453808">.</span><span class="ident" id="4453809">Comments</span><span class="op" id="4453817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4453824">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4453828">return</span>&nbsp;<span class="ident" id="4453835">config</span><span class="op" id="4453841">.</span><span class="ident" id="4453842">Fprint</span><span class="op" id="4453848">(</span><span class="ident" id="4453849">dst</span><span class="op" id="4453852">,</span>&nbsp;<span class="ident" id="4453854">fset</span><span class="op" id="4453858">,</span>&nbsp;<span class="ident" id="4453860">node</span><span class="op" id="4453864">)</span><br>
<span class="lineno"></span><span class="op" id="4453866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4453869">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="4453939">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="4454009">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="4454080">//</span><br>
<span class="lineno"></span><span class="comment" id="4454083">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="4454157">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="4454233">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4454310">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4454391">//</span><br>
<span class="lineno"></span><span class="keyword" id="4454394">func</span>&nbsp;<span class="ident" id="4454399">Source</span><span class="op" id="4454405">(</span><span class="ident" id="4454406">src</span>&nbsp;<span class="op" id="4454410">[</span><span class="op" id="4454411">]</span><span class="builtintype" id="4454412">byte</span><span class="op" id="4454416">)</span>&nbsp;<span class="op" id="4454418">(</span><span class="op" id="4454419">[</span><span class="op" id="4454420">]</span><span class="builtintype" id="4454421">byte</span><span class="op" id="4454425">,</span>&nbsp;<span class="builtintype" id="4454427">error</span><span class="op" id="4454432">)</span>&nbsp;<span class="op" id="4454434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4454437">fset</span>&nbsp;<span class="op" id="4454442">:=</span>&nbsp;<span class="ident" id="4454445">token</span><span class="op" id="4454450">.</span><span class="ident" id="4454451">NewFileSet</span><span class="op" id="4454461">(</span><span class="op" id="4454462">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4454465">file</span><span class="op" id="4454469">,</span>&nbsp;<span class="ident" id="4454471">sourceAdj</span><span class="op" id="4454480">,</span>&nbsp;<span class="ident" id="4454482">indentAdj</span><span class="op" id="4454491">,</span>&nbsp;<span class="ident" id="4454493">err</span>&nbsp;<span class="op" id="4454497">:=</span>&nbsp;<span class="ident" id="4454500">parse</span><span class="op" id="4454505">(</span><span class="ident" id="4454506">fset</span><span class="op" id="4454510">,</span>&nbsp;<span class="string" id="4454512">&#34;&#34;</span><span class="op" id="4454514">,</span>&nbsp;<span class="ident" id="4454516">src</span><span class="op" id="4454519">,</span>&nbsp;<span class="builtintype" id="4454521">true</span><span class="op" id="4454525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454528">if</span>&nbsp;<span class="ident" id="4454531">err</span>&nbsp;<span class="op" id="4454535">!=</span>&nbsp;<span class="ident" id="4454538">nil</span>&nbsp;<span class="op" id="4454542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454546">return</span>&nbsp;<span class="ident" id="4454553">nil</span><span class="op" id="4454556">,</span>&nbsp;<span class="ident" id="4454558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4454563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454567">if</span>&nbsp;<span class="ident" id="4454570">sourceAdj</span>&nbsp;<span class="op" id="4454580">==</span>&nbsp;<span class="ident" id="4454583">nil</span>&nbsp;<span class="op" id="4454587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4454591">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4454618">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4454661">ast</span><span class="op" id="4454664">.</span><span class="ident" id="4454665">SortImports</span><span class="op" id="4454676">(</span><span class="ident" id="4454677">fset</span><span class="op" id="4454681">,</span>&nbsp;<span class="ident" id="4454683">file</span><span class="op" id="4454687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4454690">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454694">return</span>&nbsp;<span class="ident" id="4454701">format</span><span class="op" id="4454707">(</span><span class="ident" id="4454708">fset</span><span class="op" id="4454712">,</span>&nbsp;<span class="ident" id="4454714">file</span><span class="op" id="4454718">,</span>&nbsp;<span class="ident" id="4454720">sourceAdj</span><span class="op" id="4454729">,</span>&nbsp;<span class="ident" id="4454731">indentAdj</span><span class="op" id="4454740">,</span>&nbsp;<span class="ident" id="4454742">src</span><span class="op" id="4454745">,</span>&nbsp;<span class="ident" id="4454747">config</span><span class="op" id="4454753">)</span><br>
<span class="lineno"></span><span class="op" id="4454755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4454758">func</span>&nbsp;<span class="ident" id="4454763">hasUnsortedImports</span><span class="op" id="4454781">(</span><span class="ident" id="4454782">file</span>&nbsp;<span class="op" id="4454787">*</span><span class="ident" id="4454788">ast</span><span class="op" id="4454791">.</span><span class="ident" id="4454792">File</span><span class="op" id="4454796">)</span>&nbsp;<span class="builtintype" id="4454798">bool</span>&nbsp;<span class="op" id="4454803">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454806">for</span>&nbsp;<span class="ident" id="4454810">_</span><span class="op" id="4454811">,</span>&nbsp;<span class="ident" id="4454813">d</span>&nbsp;<span class="op" id="4454815">:=</span>&nbsp;<span class="keyword" id="4454818">range</span>&nbsp;<span class="ident" id="4454824">file</span><span class="op" id="4454828">.</span><span class="ident" id="4454829">Decls</span>&nbsp;<span class="op" id="4454835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4454839">d</span><span class="op" id="4454840">,</span>&nbsp;<span class="ident" id="4454842">ok</span>&nbsp;<span class="op" id="4454845">:=</span>&nbsp;<span class="ident" id="4454848">d</span><span class="op" id="4454849">.</span><span class="op" id="4454850">(</span><span class="op" id="4454851">*</span><span class="ident" id="4454852">ast</span><span class="op" id="4454855">.</span><span class="ident" id="4454856">GenDecl</span><span class="op" id="4454863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454867">if</span>&nbsp;<span class="op" id="4454870">!</span><span class="ident" id="4454871">ok</span>&nbsp;<span class="op" id="4454874">||</span>&nbsp;<span class="ident" id="4454877">d</span><span class="op" id="4454878">.</span><span class="ident" id="4454879">Tok</span>&nbsp;<span class="op" id="4454883">!=</span>&nbsp;<span class="ident" id="4454886">token</span><span class="op" id="4454891">.</span><span class="ident" id="4454892">IMPORT</span>&nbsp;<span class="op" id="4454899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4454904">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4454952">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4454984">return</span>&nbsp;<span class="builtintype" id="4454991">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4454999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4455003">if</span>&nbsp;<span class="ident" id="4455006">d</span><span class="op" id="4455007">.</span><span class="ident" id="4455008">Lparen</span><span class="op" id="4455014">.</span><span class="ident" id="4455015">IsValid</span><span class="op" id="4455022">(</span><span class="op" id="4455023">)</span>&nbsp;<span class="op" id="4455025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4455030">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4455085">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4455142">return</span>&nbsp;<span class="builtintype" id="4455149">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4455156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4455160">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4455205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4455208">return</span>&nbsp;<span class="builtintype" id="4455215">false</span><br>
<span class="lineno">115</span><span class="op" id="4455221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4455224">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="4455304">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="4455325">//</span><br>
<span class="lineno">120</span><span class="comment" id="4455328">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4455399">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="4455466">//</span><br>
<span class="lineno"></span><span class="comment" id="4455469">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4455526">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="4455583">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="4455639">func</span>&nbsp;<span class="ident" id="4455644">parse</span><span class="op" id="4455649">(</span><span class="ident" id="4455650">fset</span>&nbsp;<span class="op" id="4455655">*</span><span class="ident" id="4455656">token</span><span class="op" id="4455661">.</span><span class="ident" id="4455662">FileSet</span><span class="op" id="4455669">,</span>&nbsp;<span class="ident" id="4455671">filename</span>&nbsp;<span class="builtintype" id="4455680">string</span><span class="op" id="4455686">,</span>&nbsp;<span class="ident" id="4455688">src</span>&nbsp;<span class="op" id="4455692">[</span><span class="op" id="4455693">]</span><span class="builtintype" id="4455694">byte</span><span class="op" id="4455698">,</span>&nbsp;<span class="ident" id="4455700">fragmentOk</span>&nbsp;<span class="builtintype" id="4455711">bool</span><span class="op" id="4455715">)</span>&nbsp;<span class="op" id="4455717">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4455720">file</span>&nbsp;<span class="op" id="4455725">*</span><span class="ident" id="4455726">ast</span><span class="op" id="4455729">.</span><span class="ident" id="4455730">File</span><span class="op" id="4455734">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4455737">sourceAdj</span>&nbsp;<span class="keyword" id="4455747">func</span><span class="op" id="4455751">(</span><span class="ident" id="4455752">src</span>&nbsp;<span class="op" id="4455756">[</span><span class="op" id="4455757">]</span><span class="builtintype" id="4455758">byte</span><span class="op" id="4455762">,</span>&nbsp;<span class="ident" id="4455764">indent</span>&nbsp;<span class="builtintype" id="4455771">int</span><span class="op" id="4455774">)</span>&nbsp;<span class="op" id="4455776">[</span><span class="op" id="4455777">]</span><span class="builtintype" id="4455778">byte</span><span class="op" id="4455782">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4455785">indentAdj</span>&nbsp;<span class="builtintype" id="4455795">int</span><span class="op" id="4455798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4455801">err</span>&nbsp;<span class="builtintype" id="4455805">error</span><span class="op" id="4455810">,</span><br>
<span class="lineno"></span><span class="op" id="4455812">)</span>&nbsp;<span class="op" id="4455814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4455817">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4455847">file</span><span class="op" id="4455851">,</span>&nbsp;<span class="ident" id="4455853">err</span>&nbsp;<span class="op" id="4455857">=</span>&nbsp;<span class="ident" id="4455859">parser</span><span class="op" id="4455865">.</span><span class="ident" id="4455866">ParseFile</span><span class="op" id="4455875">(</span><span class="ident" id="4455876">fset</span><span class="op" id="4455880">,</span>&nbsp;<span class="ident" id="4455882">filename</span><span class="op" id="4455890">,</span>&nbsp;<span class="ident" id="4455892">src</span><span class="op" id="4455895">,</span>&nbsp;<span class="ident" id="4455897">parserMode</span><span class="op" id="4455907">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4455910">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456001">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456063">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456130">if</span>&nbsp;<span class="ident" id="4456133">err</span>&nbsp;<span class="op" id="4456137">==</span>&nbsp;<span class="ident" id="4456140">nil</span>&nbsp;<span class="op" id="4456144">||</span>&nbsp;<span class="op" id="4456147">!</span><span class="ident" id="4456148">fragmentOk</span>&nbsp;<span class="op" id="4456159">||</span>&nbsp;<span class="op" id="4456162">!</span><span class="ident" id="4456163">strings</span><span class="op" id="4456170">.</span><span class="ident" id="4456171">Contains</span><span class="op" id="4456179">(</span><span class="ident" id="4456180">err</span><span class="op" id="4456183">.</span><span class="ident" id="4456184">Error</span><span class="op" id="4456189">(</span><span class="op" id="4456190">)</span><span class="op" id="4456191">,</span>&nbsp;<span class="string" id="4456193">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="4456213">)</span>&nbsp;<span class="op" id="4456215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456219">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4456227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456231">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456288">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456323">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456385">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4456420">psrc</span>&nbsp;<span class="op" id="4456425">:=</span>&nbsp;<span class="builtinfunc" id="4456428">append</span><span class="op" id="4456434">(</span><span class="op" id="4456435">[</span><span class="op" id="4456436">]</span><span class="builtintype" id="4456437">byte</span><span class="op" id="4456441">(</span><span class="string" id="4456442">&#34;package&nbsp;p;&#34;</span><span class="op" id="4456454">)</span><span class="op" id="4456455">,</span>&nbsp;<span class="ident" id="4456457">src</span><span class="op" id="4456460">...</span><span class="op" id="4456463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4456466">file</span><span class="op" id="4456470">,</span>&nbsp;<span class="ident" id="4456472">err</span>&nbsp;<span class="op" id="4456476">=</span>&nbsp;<span class="ident" id="4456478">parser</span><span class="op" id="4456484">.</span><span class="ident" id="4456485">ParseFile</span><span class="op" id="4456494">(</span><span class="ident" id="4456495">fset</span><span class="op" id="4456499">,</span>&nbsp;<span class="ident" id="4456501">filename</span><span class="op" id="4456509">,</span>&nbsp;<span class="ident" id="4456511">psrc</span><span class="op" id="4456515">,</span>&nbsp;<span class="ident" id="4456517">parserMode</span><span class="op" id="4456527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456530">if</span>&nbsp;<span class="ident" id="4456533">err</span>&nbsp;<span class="op" id="4456537">==</span>&nbsp;<span class="ident" id="4456540">nil</span>&nbsp;<span class="op" id="4456544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4456548">sourceAdj</span>&nbsp;<span class="op" id="4456558">=</span>&nbsp;<span class="keyword" id="4456560">func</span><span class="op" id="4456564">(</span><span class="ident" id="4456565">src</span>&nbsp;<span class="op" id="4456569">[</span><span class="op" id="4456570">]</span><span class="builtintype" id="4456571">byte</span><span class="op" id="4456575">,</span>&nbsp;<span class="ident" id="4456577">indent</span>&nbsp;<span class="builtintype" id="4456584">int</span><span class="op" id="4456587">)</span>&nbsp;<span class="op" id="4456589">[</span><span class="op" id="4456590">]</span><span class="builtintype" id="4456591">byte</span>&nbsp;<span class="op" id="4456596">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456601">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456634">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4456674">src</span>&nbsp;<span class="op" id="4456678">=</span>&nbsp;<span class="ident" id="4456680">src</span><span class="op" id="4456683">[</span><span class="ident" id="4456684">indent</span><span class="op" id="4456690">+</span><span class="builtinfunc" id="4456691">len</span><span class="op" id="4456694">(</span><span class="string" id="4456695">&#34;package&nbsp;p\n&#34;</span><span class="op" id="4456708">)</span><span class="op" id="4456709">:</span><span class="op" id="4456710">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456715">return</span>&nbsp;<span class="ident" id="4456722">bytes</span><span class="op" id="4456727">.</span><span class="ident" id="4456728">TrimSpace</span><span class="op" id="4456737">(</span><span class="ident" id="4456738">src</span><span class="op" id="4456741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4456745">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456749">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4456757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456760">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456821">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456879">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456919">if</span>&nbsp;<span class="op" id="4456922">!</span><span class="ident" id="4456923">strings</span><span class="op" id="4456930">.</span><span class="ident" id="4456931">Contains</span><span class="op" id="4456939">(</span><span class="ident" id="4456940">err</span><span class="op" id="4456943">.</span><span class="ident" id="4456944">Error</span><span class="op" id="4456949">(</span><span class="op" id="4456950">)</span><span class="op" id="4456951">,</span>&nbsp;<span class="string" id="4456953">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="4456975">)</span>&nbsp;<span class="op" id="4456977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4456981">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4456989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4456993">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457048">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457103">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457160">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457222">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457257">fsrc</span>&nbsp;<span class="op" id="4457262">:=</span>&nbsp;<span class="builtinfunc" id="4457265">append</span><span class="op" id="4457271">(</span><span class="builtinfunc" id="4457272">append</span><span class="op" id="4457278">(</span><span class="op" id="4457279">[</span><span class="op" id="4457280">]</span><span class="builtintype" id="4457281">byte</span><span class="op" id="4457285">(</span><span class="string" id="4457286">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="4457309">)</span><span class="op" id="4457310">,</span>&nbsp;<span class="ident" id="4457312">src</span><span class="op" id="4457315">...</span><span class="op" id="4457318">)</span><span class="op" id="4457319">,</span>&nbsp;<span class="string" id="4457321">&#39;\n&#39;</span><span class="op" id="4457325">,</span>&nbsp;<span class="string" id="4457327">&#39;}&#39;</span><span class="op" id="4457330">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457333">file</span><span class="op" id="4457337">,</span>&nbsp;<span class="ident" id="4457339">err</span>&nbsp;<span class="op" id="4457343">=</span>&nbsp;<span class="ident" id="4457345">parser</span><span class="op" id="4457351">.</span><span class="ident" id="4457352">ParseFile</span><span class="op" id="4457361">(</span><span class="ident" id="4457362">fset</span><span class="op" id="4457366">,</span>&nbsp;<span class="ident" id="4457368">filename</span><span class="op" id="4457376">,</span>&nbsp;<span class="ident" id="4457378">fsrc</span><span class="op" id="4457382">,</span>&nbsp;<span class="ident" id="4457384">parserMode</span><span class="op" id="4457394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4457397">if</span>&nbsp;<span class="ident" id="4457400">err</span>&nbsp;<span class="op" id="4457404">==</span>&nbsp;<span class="ident" id="4457407">nil</span>&nbsp;<span class="op" id="4457411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457415">sourceAdj</span>&nbsp;<span class="op" id="4457425">=</span>&nbsp;<span class="keyword" id="4457427">func</span><span class="op" id="4457431">(</span><span class="ident" id="4457432">src</span>&nbsp;<span class="op" id="4457436">[</span><span class="op" id="4457437">]</span><span class="builtintype" id="4457438">byte</span><span class="op" id="4457442">,</span>&nbsp;<span class="ident" id="4457444">indent</span>&nbsp;<span class="builtintype" id="4457451">int</span><span class="op" id="4457454">)</span>&nbsp;<span class="op" id="4457456">[</span><span class="op" id="4457457">]</span><span class="builtintype" id="4457458">byte</span>&nbsp;<span class="op" id="4457463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457468">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4457503">if</span>&nbsp;<span class="ident" id="4457506">indent</span>&nbsp;<span class="op" id="4457513">&lt;</span>&nbsp;<span class="num" id="4457515">0</span>&nbsp;<span class="op" id="4457517">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457523">indent</span>&nbsp;<span class="op" id="4457530">=</span>&nbsp;<span class="num" id="4457532">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4457537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457542">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457569">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457611">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457680">src</span>&nbsp;<span class="op" id="4457684">=</span>&nbsp;<span class="ident" id="4457686">src</span><span class="op" id="4457689">[</span><span class="num" id="4457690">2</span><span class="op" id="4457691">*</span><span class="ident" id="4457692">indent</span><span class="op" id="4457698">+</span><span class="builtinfunc" id="4457699">len</span><span class="op" id="4457702">(</span><span class="string" id="4457703">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="4457728">)</span><span class="op" id="4457729">:</span><span class="op" id="4457730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457735">src</span>&nbsp;<span class="op" id="4457739">=</span>&nbsp;<span class="ident" id="4457741">src</span><span class="op" id="4457744">[</span><span class="op" id="4457745">:</span><span class="builtinfunc" id="4457746">len</span><span class="op" id="4457749">(</span><span class="ident" id="4457750">src</span><span class="op" id="4457753">)</span><span class="op" id="4457754">-</span><span class="op" id="4457755">(</span><span class="ident" id="4457756">indent</span><span class="op" id="4457762">+</span><span class="builtinfunc" id="4457763">len</span><span class="op" id="4457766">(</span><span class="string" id="4457767">&#34;\n}\n&#34;</span><span class="op" id="4457774">)</span><span class="op" id="4457775">)</span><span class="op" id="4457776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4457781">return</span>&nbsp;<span class="ident" id="4457788">bytes</span><span class="op" id="4457793">.</span><span class="ident" id="4457794">TrimSpace</span><span class="op" id="4457803">(</span><span class="ident" id="4457804">src</span><span class="op" id="4457807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4457811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457815">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457873">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4457906">indentAdj</span>&nbsp;<span class="op" id="4457916">=</span>&nbsp;<span class="op" id="4457918">-</span><span class="num" id="4457919">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4457922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4457926">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4457960">return</span><br>
<span class="lineno"></span><span class="op" id="4457967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4457970">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="4458040">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="4458109">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="4458127">func</span>&nbsp;<span class="ident" id="4458132">format</span><span class="op" id="4458138">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458141">fset</span>&nbsp;<span class="op" id="4458146">*</span><span class="ident" id="4458147">token</span><span class="op" id="4458152">.</span><span class="ident" id="4458153">FileSet</span><span class="op" id="4458160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458163">file</span>&nbsp;<span class="op" id="4458168">*</span><span class="ident" id="4458169">ast</span><span class="op" id="4458172">.</span><span class="ident" id="4458173">File</span><span class="op" id="4458177">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458180">sourceAdj</span>&nbsp;<span class="keyword" id="4458190">func</span><span class="op" id="4458194">(</span><span class="ident" id="4458195">src</span>&nbsp;<span class="op" id="4458199">[</span><span class="op" id="4458200">]</span><span class="builtintype" id="4458201">byte</span><span class="op" id="4458205">,</span>&nbsp;<span class="ident" id="4458207">indent</span>&nbsp;<span class="builtintype" id="4458214">int</span><span class="op" id="4458217">)</span>&nbsp;<span class="op" id="4458219">[</span><span class="op" id="4458220">]</span><span class="builtintype" id="4458221">byte</span><span class="op" id="4458225">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458228">indentAdj</span>&nbsp;<span class="builtintype" id="4458238">int</span><span class="op" id="4458241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458244">src</span>&nbsp;<span class="op" id="4458248">[</span><span class="op" id="4458249">]</span><span class="builtintype" id="4458250">byte</span><span class="op" id="4458254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458257">cfg</span>&nbsp;<span class="ident" id="4458261">printer</span><span class="op" id="4458268">.</span><span class="ident" id="4458269">Config</span><span class="op" id="4458275">,</span><br>
<span class="lineno"></span><span class="op" id="4458277">)</span>&nbsp;<span class="op" id="4458279">(</span><span class="op" id="4458280">[</span><span class="op" id="4458281">]</span><span class="builtintype" id="4458282">byte</span><span class="op" id="4458286">,</span>&nbsp;<span class="builtintype" id="4458288">error</span><span class="op" id="4458293">)</span>&nbsp;<span class="op" id="4458295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458298">if</span>&nbsp;<span class="ident" id="4458301">sourceAdj</span>&nbsp;<span class="op" id="4458311">==</span>&nbsp;<span class="ident" id="4458314">nil</span>&nbsp;<span class="op" id="4458318">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458322">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458349">var</span>&nbsp;<span class="ident" id="4458353">buf</span>&nbsp;<span class="ident" id="4458357">bytes</span><span class="op" id="4458362">.</span><span class="ident" id="4458363">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458372">err</span>&nbsp;<span class="op" id="4458376">:=</span>&nbsp;<span class="ident" id="4458379">cfg</span><span class="op" id="4458382">.</span><span class="ident" id="4458383">Fprint</span><span class="op" id="4458389">(</span><span class="op" id="4458390">&amp;</span><span class="ident" id="4458391">buf</span><span class="op" id="4458394">,</span>&nbsp;<span class="ident" id="4458396">fset</span><span class="op" id="4458400">,</span>&nbsp;<span class="ident" id="4458402">file</span><span class="op" id="4458406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458410">if</span>&nbsp;<span class="ident" id="4458413">err</span>&nbsp;<span class="op" id="4458417">!=</span>&nbsp;<span class="ident" id="4458420">nil</span>&nbsp;<span class="op" id="4458424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458429">return</span>&nbsp;<span class="ident" id="4458436">nil</span><span class="op" id="4458439">,</span>&nbsp;<span class="ident" id="4458441">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4458447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458451">return</span>&nbsp;<span class="ident" id="4458458">buf</span><span class="op" id="4458461">.</span><span class="ident" id="4458462">Bytes</span><span class="op" id="4458467">(</span><span class="op" id="4458468">)</span><span class="op" id="4458469">,</span>&nbsp;<span class="ident" id="4458471">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4458476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458480">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458505">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458546">i</span><span class="op" id="4458547">,</span>&nbsp;<span class="ident" id="4458549">j</span>&nbsp;<span class="op" id="4458551">:=</span>&nbsp;<span class="num" id="4458554">0</span><span class="op" id="4458555">,</span>&nbsp;<span class="num" id="4458557">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458560">for</span>&nbsp;<span class="ident" id="4458564">j</span>&nbsp;<span class="op" id="4458566">&lt;</span>&nbsp;<span class="builtinfunc" id="4458568">len</span><span class="op" id="4458571">(</span><span class="ident" id="4458572">src</span><span class="op" id="4458575">)</span>&nbsp;<span class="op" id="4458577">&amp;&amp;</span>&nbsp;<span class="ident" id="4458580">isSpace</span><span class="op" id="4458587">(</span><span class="ident" id="4458588">src</span><span class="op" id="4458591">[</span><span class="ident" id="4458592">j</span><span class="op" id="4458593">]</span><span class="op" id="4458594">)</span>&nbsp;<span class="op" id="4458596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458600">if</span>&nbsp;<span class="ident" id="4458603">src</span><span class="op" id="4458606">[</span><span class="ident" id="4458607">j</span><span class="op" id="4458608">]</span>&nbsp;<span class="op" id="4458610">==</span>&nbsp;<span class="string" id="4458613">&#39;\n&#39;</span>&nbsp;<span class="op" id="4458618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458623">i</span>&nbsp;<span class="op" id="4458625">=</span>&nbsp;<span class="ident" id="4458627">j</span>&nbsp;<span class="op" id="4458629">+</span>&nbsp;<span class="num" id="4458631">1</span>&nbsp;<span class="comment" id="4458633">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4458680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458684">j</span><span class="op" id="4458685">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4458689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458692">var</span>&nbsp;<span class="ident" id="4458696">res</span>&nbsp;<span class="op" id="4458700">[</span><span class="op" id="4458701">]</span><span class="builtintype" id="4458702">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458708">res</span>&nbsp;<span class="op" id="4458712">=</span>&nbsp;<span class="builtinfunc" id="4458714">append</span><span class="op" id="4458720">(</span><span class="ident" id="4458721">res</span><span class="op" id="4458724">,</span>&nbsp;<span class="ident" id="4458726">src</span><span class="op" id="4458729">[</span><span class="op" id="4458730">:</span><span class="ident" id="4458731">i</span><span class="op" id="4458732">]</span><span class="op" id="4458733">...</span><span class="op" id="4458736">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458740">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458798">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4458847">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458890">indent</span>&nbsp;<span class="op" id="4458897">:=</span>&nbsp;<span class="num" id="4458900">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458903">hasSpace</span>&nbsp;<span class="op" id="4458912">:=</span>&nbsp;<span class="builtintype" id="4458915">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458922">for</span>&nbsp;<span class="ident" id="4458926">_</span><span class="op" id="4458927">,</span>&nbsp;<span class="ident" id="4458929">b</span>&nbsp;<span class="op" id="4458931">:=</span>&nbsp;<span class="keyword" id="4458934">range</span>&nbsp;<span class="ident" id="4458940">src</span><span class="op" id="4458943">[</span><span class="ident" id="4458944">i</span><span class="op" id="4458945">:</span><span class="ident" id="4458946">j</span><span class="op" id="4458947">]</span>&nbsp;<span class="op" id="4458949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458953">switch</span>&nbsp;<span class="ident" id="4458960">b</span>&nbsp;<span class="op" id="4458962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458966">case</span>&nbsp;<span class="string" id="4458971">&#39;&nbsp;&#39;</span><span class="op" id="4458974">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4458979">hasSpace</span>&nbsp;<span class="op" id="4458988">=</span>&nbsp;<span class="builtintype" id="4458990">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4458997">case</span>&nbsp;<span class="string" id="4459002">&#39;\t&#39;</span><span class="op" id="4459006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459011">indent</span><span class="op" id="4459017">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459028">if</span>&nbsp;<span class="ident" id="4459031">indent</span>&nbsp;<span class="op" id="4459038">==</span>&nbsp;<span class="num" id="4459041">0</span>&nbsp;<span class="op" id="4459043">&amp;&amp;</span>&nbsp;<span class="ident" id="4459046">hasSpace</span>&nbsp;<span class="op" id="4459055">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459059">indent</span>&nbsp;<span class="op" id="4459066">=</span>&nbsp;<span class="num" id="4459068">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459074">for</span>&nbsp;<span class="ident" id="4459078">i</span>&nbsp;<span class="op" id="4459080">:=</span>&nbsp;<span class="num" id="4459083">0</span><span class="op" id="4459084">;</span>&nbsp;<span class="ident" id="4459086">i</span>&nbsp;<span class="op" id="4459088">&lt;</span>&nbsp;<span class="ident" id="4459090">indent</span><span class="op" id="4459096">;</span>&nbsp;<span class="ident" id="4459098">i</span><span class="op" id="4459099">++</span>&nbsp;<span class="op" id="4459102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459106">res</span>&nbsp;<span class="op" id="4459110">=</span>&nbsp;<span class="builtinfunc" id="4459112">append</span><span class="op" id="4459118">(</span><span class="ident" id="4459119">res</span><span class="op" id="4459122">,</span>&nbsp;<span class="string" id="4459124">&#39;\t&#39;</span><span class="op" id="4459128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459131">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4459135">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4459158">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459211">cfg</span><span class="op" id="4459214">.</span><span class="ident" id="4459215">Indent</span>&nbsp;<span class="op" id="4459222">=</span>&nbsp;<span class="ident" id="4459224">indent</span>&nbsp;<span class="op" id="4459231">+</span>&nbsp;<span class="ident" id="4459233">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459244">var</span>&nbsp;<span class="ident" id="4459248">buf</span>&nbsp;<span class="ident" id="4459252">bytes</span><span class="op" id="4459257">.</span><span class="ident" id="4459258">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459266">err</span>&nbsp;<span class="op" id="4459270">:=</span>&nbsp;<span class="ident" id="4459273">cfg</span><span class="op" id="4459276">.</span><span class="ident" id="4459277">Fprint</span><span class="op" id="4459283">(</span><span class="op" id="4459284">&amp;</span><span class="ident" id="4459285">buf</span><span class="op" id="4459288">,</span>&nbsp;<span class="ident" id="4459290">fset</span><span class="op" id="4459294">,</span>&nbsp;<span class="ident" id="4459296">file</span><span class="op" id="4459300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459303">if</span>&nbsp;<span class="ident" id="4459306">err</span>&nbsp;<span class="op" id="4459310">!=</span>&nbsp;<span class="ident" id="4459313">nil</span>&nbsp;<span class="op" id="4459317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459321">return</span>&nbsp;<span class="ident" id="4459328">nil</span><span class="op" id="4459331">,</span>&nbsp;<span class="ident" id="4459333">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459341">res</span>&nbsp;<span class="op" id="4459345">=</span>&nbsp;<span class="builtinfunc" id="4459347">append</span><span class="op" id="4459353">(</span><span class="ident" id="4459354">res</span><span class="op" id="4459357">,</span>&nbsp;<span class="ident" id="4459359">sourceAdj</span><span class="op" id="4459368">(</span><span class="ident" id="4459369">buf</span><span class="op" id="4459372">.</span><span class="ident" id="4459373">Bytes</span><span class="op" id="4459378">(</span><span class="op" id="4459379">)</span><span class="op" id="4459380">,</span>&nbsp;<span class="ident" id="4459382">cfg</span><span class="op" id="4459385">.</span><span class="ident" id="4459386">Indent</span><span class="op" id="4459392">)</span><span class="op" id="4459393">...</span><span class="op" id="4459396">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4459400">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459441">i</span>&nbsp;<span class="op" id="4459443">=</span>&nbsp;<span class="builtinfunc" id="4459445">len</span><span class="op" id="4459448">(</span><span class="ident" id="4459449">src</span><span class="op" id="4459452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459455">for</span>&nbsp;<span class="ident" id="4459459">i</span>&nbsp;<span class="op" id="4459461">&gt;</span>&nbsp;<span class="num" id="4459463">0</span>&nbsp;<span class="op" id="4459465">&amp;&amp;</span>&nbsp;<span class="ident" id="4459468">isSpace</span><span class="op" id="4459475">(</span><span class="ident" id="4459476">src</span><span class="op" id="4459479">[</span><span class="ident" id="4459480">i</span><span class="op" id="4459481">-</span><span class="num" id="4459482">1</span><span class="op" id="4459483">]</span><span class="op" id="4459484">)</span>&nbsp;<span class="op" id="4459486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459490">i</span><span class="op" id="4459491">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459498">return</span>&nbsp;<span class="builtinfunc" id="4459505">append</span><span class="op" id="4459511">(</span><span class="ident" id="4459512">res</span><span class="op" id="4459515">,</span>&nbsp;<span class="ident" id="4459517">src</span><span class="op" id="4459520">[</span><span class="ident" id="4459521">i</span><span class="op" id="4459522">:</span><span class="op" id="4459523">]</span><span class="op" id="4459524">...</span><span class="op" id="4459527">)</span><span class="op" id="4459528">,</span>&nbsp;<span class="ident" id="4459530">nil</span><br>
<span class="lineno"></span><span class="op" id="4459534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4459537">func</span>&nbsp;<span class="ident" id="4459542">isSpace</span><span class="op" id="4459549">(</span><span class="ident" id="4459550">b</span>&nbsp;<span class="builtintype" id="4459552">byte</span><span class="op" id="4459556">)</span>&nbsp;<span class="builtintype" id="4459558">bool</span>&nbsp;<span class="op" id="4459563">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459566">return</span>&nbsp;<span class="ident" id="4459573">b</span>&nbsp;<span class="op" id="4459575">==</span>&nbsp;<span class="string" id="4459578">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4459582">||</span>&nbsp;<span class="ident" id="4459585">b</span>&nbsp;<span class="op" id="4459587">==</span>&nbsp;<span class="string" id="4459590">&#39;\t&#39;</span>&nbsp;<span class="op" id="4459595">||</span>&nbsp;<span class="ident" id="4459598">b</span>&nbsp;<span class="op" id="4459600">==</span>&nbsp;<span class="string" id="4459603">&#39;\n&#39;</span>&nbsp;<span class="op" id="4459608">||</span>&nbsp;<span class="ident" id="4459611">b</span>&nbsp;<span class="op" id="4459613">==</span>&nbsp;<span class="string" id="4459616">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="4459621">}</span>
</div>
</body>
</html>
