<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>reflect</h2>
<ul>
<li><a href="/gostd/reflect/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/reflect/deepequal.go.html">deepequal.go</a></li>
<li><a href="/gostd/reflect/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/reflect/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/reflect/makefunc.go.html" class="current">makefunc.go</a></li>
<li><a href="/gostd/reflect/set_test.go.html">set_test.go</a></li>
<li><a href="/gostd/reflect/tostring_test.go.html">tostring_test.go</a></li>
<li><a href="/gostd/reflect/type.go.html">type.go</a></li>
<li><a href="/gostd/reflect/value.go.html">value.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2766512">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2766568">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2766622">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2766673">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2766702">package</span>&nbsp;<span class="ident" id="2766710">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2766719">import</span>&nbsp;<span class="op" id="2766726">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2766729">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2766738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2766741">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2766804">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword" id="2766829">type</span>&nbsp;<span class="ident" id="2766834">makeFuncImpl</span>&nbsp;<span class="keyword" id="2766847">struct</span>&nbsp;<span class="op" id="2766854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2766857">code</span>&nbsp;&nbsp;<span class="builtintype" id="2766863">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2766872">stack</span>&nbsp;<span class="op" id="2766878">*</span><span class="ident" id="2766879">bitVector</span>&nbsp;<span class="comment" id="2766889">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2766941">typ</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2766947">*</span><span class="ident" id="2766948">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2766958">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2766964">func</span><span class="op" id="2766968">(</span><span class="op" id="2766969">[</span><span class="op" id="2766970">]</span><span class="ident" id="2766971">Value</span><span class="op" id="2766976">)</span>&nbsp;<span class="op" id="2766978">[</span><span class="op" id="2766979">]</span><span class="ident" id="2766980">Value</span><br>
<span class="lineno">20</span><span class="op" id="2766986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2766989">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment" id="2767042">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2767104">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment" id="2767127">//</span><br>
<span class="lineno"></span><span class="comment" id="2767130">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment" id="2767180">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment" id="2767211">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment" id="2767281">//</span><br>
<span class="lineno">30</span><span class="comment" id="2767284">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="2767350">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2767404">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2767471">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2767529">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment" id="2767599">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment" id="2767657">//</span><br>
<span class="lineno"></span><span class="comment" id="2767660">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="2767730">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment" id="2767806">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment" id="2767846">//</span><br>
<span class="lineno"></span><span class="comment" id="2767849">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment" id="2767919">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment" id="2767991">//</span><br>
<span class="lineno"></span><span class="keyword" id="2767994">func</span>&nbsp;<span class="ident" id="2767999">MakeFunc</span><span class="op" id="2768007">(</span><span class="ident" id="2768008">typ</span>&nbsp;<span class="ident" id="2768012">Type</span><span class="op" id="2768016">,</span>&nbsp;<span class="ident" id="2768018">fn</span>&nbsp;<span class="keyword" id="2768021">func</span><span class="op" id="2768025">(</span><span class="ident" id="2768026">args</span>&nbsp;<span class="op" id="2768031">[</span><span class="op" id="2768032">]</span><span class="ident" id="2768033">Value</span><span class="op" id="2768038">)</span>&nbsp;<span class="op" id="2768040">(</span><span class="ident" id="2768041">results</span>&nbsp;<span class="op" id="2768049">[</span><span class="op" id="2768050">]</span><span class="ident" id="2768051">Value</span><span class="op" id="2768056">)</span><span class="op" id="2768057">)</span>&nbsp;<span class="ident" id="2768059">Value</span>&nbsp;<span class="op" id="2768065">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2768068">if</span>&nbsp;<span class="ident" id="2768071">typ</span><span class="op" id="2768074">.</span><span class="ident" id="2768075">Kind</span><span class="op" id="2768079">(</span><span class="op" id="2768080">)</span>&nbsp;<span class="op" id="2768082">!=</span>&nbsp;<span class="ident" id="2768085">Func</span>&nbsp;<span class="op" id="2768090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2768094">panic</span><span class="op" id="2768099">(</span><span class="string" id="2768100">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op" id="2768146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2768149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768153">t</span>&nbsp;<span class="op" id="2768155">:=</span>&nbsp;<span class="ident" id="2768158">typ</span><span class="op" id="2768161">.</span><span class="ident" id="2768162">common</span><span class="op" id="2768168">(</span><span class="op" id="2768169">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768172">ftyp</span>&nbsp;<span class="op" id="2768177">:=</span>&nbsp;<span class="op" id="2768180">(</span><span class="op" id="2768181">*</span><span class="ident" id="2768182">funcType</span><span class="op" id="2768190">)</span><span class="op" id="2768191">(</span><span class="ident" id="2768192">unsafe</span><span class="op" id="2768198">.</span><span class="ident" id="2768199">Pointer</span><span class="op" id="2768206">(</span><span class="ident" id="2768207">t</span><span class="op" id="2768208">)</span><span class="op" id="2768209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2768213">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2768258">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2768313">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768373">dummy</span>&nbsp;<span class="op" id="2768379">:=</span>&nbsp;<span class="ident" id="2768382">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768396">code</span>&nbsp;<span class="op" id="2768401">:=</span>&nbsp;<span class="op" id="2768404">*</span><span class="op" id="2768405">*</span><span class="op" id="2768406">(</span><span class="op" id="2768407">*</span><span class="op" id="2768408">*</span><span class="builtintype" id="2768409">uintptr</span><span class="op" id="2768416">)</span><span class="op" id="2768417">(</span><span class="ident" id="2768418">unsafe</span><span class="op" id="2768424">.</span><span class="ident" id="2768425">Pointer</span><span class="op" id="2768432">(</span><span class="op" id="2768433">&amp;</span><span class="ident" id="2768434">dummy</span><span class="op" id="2768439">)</span><span class="op" id="2768440">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2768444">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768505">_</span><span class="op" id="2768506">,</span>&nbsp;<span class="ident" id="2768508">_</span><span class="op" id="2768509">,</span>&nbsp;<span class="ident" id="2768511">_</span><span class="op" id="2768512">,</span>&nbsp;<span class="ident" id="2768514">stack</span>&nbsp;<span class="op" id="2768520">:=</span>&nbsp;<span class="ident" id="2768523">funcLayout</span><span class="op" id="2768533">(</span><span class="ident" id="2768534">t</span><span class="op" id="2768535">,</span>&nbsp;<span class="builtintype" id="2768537">nil</span><span class="op" id="2768540">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2768544">impl</span>&nbsp;<span class="op" id="2768549">:=</span>&nbsp;<span class="op" id="2768552">&amp;</span><span class="ident" id="2768553">makeFuncImpl</span><span class="op" id="2768565">{</span><span class="ident" id="2768566">code</span><span class="op" id="2768570">:</span>&nbsp;<span class="ident" id="2768572">code</span><span class="op" id="2768576">,</span>&nbsp;<span class="ident" id="2768578">stack</span><span class="op" id="2768583">:</span>&nbsp;<span class="ident" id="2768585">stack</span><span class="op" id="2768590">,</span>&nbsp;<span class="ident" id="2768592">typ</span><span class="op" id="2768595">:</span>&nbsp;<span class="ident" id="2768597">ftyp</span><span class="op" id="2768601">,</span>&nbsp;<span class="ident" id="2768603">fn</span><span class="op" id="2768605">:</span>&nbsp;<span class="ident" id="2768607">fn</span><span class="op" id="2768609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2768613">return</span>&nbsp;<span class="ident" id="2768620">Value</span><span class="op" id="2768625">{</span><span class="ident" id="2768626">t</span><span class="op" id="2768627">,</span>&nbsp;<span class="ident" id="2768629">unsafe</span><span class="op" id="2768635">.</span><span class="ident" id="2768636">Pointer</span><span class="op" id="2768643">(</span><span class="ident" id="2768644">impl</span><span class="op" id="2768648">)</span><span class="op" id="2768649">,</span>&nbsp;<span class="ident" id="2768651">flag</span><span class="op" id="2768655">(</span><span class="ident" id="2768656">Func</span><span class="op" id="2768660">)</span><span class="op" id="2768661">}</span><br>
<span class="lineno"></span><span class="op" id="2768663">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2768666">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2768731">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment" id="2768801">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2768879">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment" id="2768953">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2768994">func</span>&nbsp;<span class="ident" id="2768999">makeFuncStub</span><span class="op" id="2769011">(</span><span class="op" id="2769012">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2769015">type</span>&nbsp;<span class="ident" id="2769020">methodValue</span>&nbsp;<span class="keyword" id="2769032">struct</span>&nbsp;<span class="op" id="2769039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769042">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2769049">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769058">stack</span>&nbsp;&nbsp;<span class="op" id="2769065">*</span><span class="ident" id="2769066">bitVector</span>&nbsp;<span class="comment" id="2769076">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769128">method</span>&nbsp;<span class="builtintype" id="2769135">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769140">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2769147">Value</span><br>
<span class="lineno"></span><span class="op" id="2769153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2769156">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment" id="2769228">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2769290">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="2769358">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2769420">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment" id="2769490">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment" id="2769559">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword" id="2769609">func</span>&nbsp;<span class="ident" id="2769614">makeMethodValue</span><span class="op" id="2769629">(</span><span class="ident" id="2769630">op</span>&nbsp;<span class="builtintype" id="2769633">string</span><span class="op" id="2769639">,</span>&nbsp;<span class="ident" id="2769641">v</span>&nbsp;<span class="ident" id="2769643">Value</span><span class="op" id="2769648">)</span>&nbsp;<span class="ident" id="2769650">Value</span>&nbsp;<span class="op" id="2769656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2769659">if</span>&nbsp;<span class="ident" id="2769662">v</span><span class="op" id="2769663">.</span><span class="ident" id="2769664">flag</span><span class="op" id="2769668">&amp;</span><span class="ident" id="2769669">flagMethod</span>&nbsp;<span class="op" id="2769680">==</span>&nbsp;<span class="num" id="2769683">0</span>&nbsp;<span class="op" id="2769685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2769689">panic</span><span class="op" id="2769694">(</span><span class="string" id="2769695">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op" id="2769752">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2769755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2769759">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769839">fl</span>&nbsp;<span class="op" id="2769842">:=</span>&nbsp;<span class="ident" id="2769845">v</span><span class="op" id="2769846">.</span><span class="ident" id="2769847">flag</span>&nbsp;<span class="op" id="2769852">&amp;</span>&nbsp;<span class="op" id="2769854">(</span><span class="ident" id="2769855">flagRO</span>&nbsp;<span class="op" id="2769862">|</span>&nbsp;<span class="ident" id="2769864">flagAddr</span>&nbsp;<span class="op" id="2769873">|</span>&nbsp;<span class="ident" id="2769875">flagIndir</span><span class="op" id="2769884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769887">fl</span>&nbsp;<span class="op" id="2769890">|=</span>&nbsp;<span class="ident" id="2769893">flag</span><span class="op" id="2769897">(</span><span class="ident" id="2769898">v</span><span class="op" id="2769899">.</span><span class="ident" id="2769900">typ</span><span class="op" id="2769903">.</span><span class="ident" id="2769904">Kind</span><span class="op" id="2769908">(</span><span class="op" id="2769909">)</span><span class="op" id="2769910">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2769913">rcvr</span>&nbsp;<span class="op" id="2769918">:=</span>&nbsp;<span class="ident" id="2769921">Value</span><span class="op" id="2769926">{</span><span class="ident" id="2769927">v</span><span class="op" id="2769928">.</span><span class="ident" id="2769929">typ</span><span class="op" id="2769932">,</span>&nbsp;<span class="ident" id="2769934">v</span><span class="op" id="2769935">.</span><span class="ident" id="2769936">ptr</span><span class="op" id="2769939">,</span>&nbsp;<span class="ident" id="2769941">fl</span><span class="op" id="2769943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2769947">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770003">funcType</span>&nbsp;<span class="op" id="2770012">:=</span>&nbsp;<span class="ident" id="2770015">v</span><span class="op" id="2770016">.</span><span class="ident" id="2770017">Type</span><span class="op" id="2770021">(</span><span class="op" id="2770022">)</span><span class="op" id="2770023">.</span><span class="op" id="2770024">(</span><span class="op" id="2770025">*</span><span class="ident" id="2770026">rtype</span><span class="op" id="2770031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770035">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770080">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770135">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770195">dummy</span>&nbsp;<span class="op" id="2770201">:=</span>&nbsp;<span class="ident" id="2770204">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770221">code</span>&nbsp;<span class="op" id="2770226">:=</span>&nbsp;<span class="op" id="2770229">*</span><span class="op" id="2770230">*</span><span class="op" id="2770231">(</span><span class="op" id="2770232">*</span><span class="op" id="2770233">*</span><span class="builtintype" id="2770234">uintptr</span><span class="op" id="2770241">)</span><span class="op" id="2770242">(</span><span class="ident" id="2770243">unsafe</span><span class="op" id="2770249">.</span><span class="ident" id="2770250">Pointer</span><span class="op" id="2770257">(</span><span class="op" id="2770258">&amp;</span><span class="ident" id="2770259">dummy</span><span class="op" id="2770264">)</span><span class="op" id="2770265">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770269">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770329">_</span><span class="op" id="2770330">,</span>&nbsp;<span class="ident" id="2770332">_</span><span class="op" id="2770333">,</span>&nbsp;<span class="ident" id="2770335">_</span><span class="op" id="2770336">,</span>&nbsp;<span class="ident" id="2770338">stack</span>&nbsp;<span class="op" id="2770344">:=</span>&nbsp;<span class="ident" id="2770347">funcLayout</span><span class="op" id="2770357">(</span><span class="ident" id="2770358">funcType</span><span class="op" id="2770366">,</span>&nbsp;<span class="builtintype" id="2770368">nil</span><span class="op" id="2770371">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770375">fv</span>&nbsp;<span class="op" id="2770378">:=</span>&nbsp;<span class="op" id="2770381">&amp;</span><span class="ident" id="2770382">methodValue</span><span class="op" id="2770393">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770397">fn</span><span class="op" id="2770399">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770405">code</span><span class="op" id="2770409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770413">stack</span><span class="op" id="2770418">:</span>&nbsp;&nbsp;<span class="ident" id="2770421">stack</span><span class="op" id="2770426">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770430">method</span><span class="op" id="2770436">:</span>&nbsp;<span class="builtintype" id="2770438">int</span><span class="op" id="2770441">(</span><span class="ident" id="2770442">v</span><span class="op" id="2770443">.</span><span class="ident" id="2770444">flag</span><span class="op" id="2770448">)</span>&nbsp;<span class="op" id="2770450">&gt;&gt;</span>&nbsp;<span class="ident" id="2770453">flagMethodShift</span><span class="op" id="2770468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770472">rcvr</span><span class="op" id="2770476">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2770480">rcvr</span><span class="op" id="2770484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2770487">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770491">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770537">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2770603">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2770667">methodReceiver</span><span class="op" id="2770681">(</span><span class="ident" id="2770682">op</span><span class="op" id="2770684">,</span>&nbsp;<span class="ident" id="2770686">fv</span><span class="op" id="2770688">.</span><span class="ident" id="2770689">rcvr</span><span class="op" id="2770693">,</span>&nbsp;<span class="ident" id="2770695">fv</span><span class="op" id="2770697">.</span><span class="ident" id="2770698">method</span><span class="op" id="2770704">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2770708">return</span>&nbsp;<span class="ident" id="2770715">Value</span><span class="op" id="2770720">{</span><span class="ident" id="2770721">funcType</span><span class="op" id="2770729">,</span>&nbsp;<span class="ident" id="2770731">unsafe</span><span class="op" id="2770737">.</span><span class="ident" id="2770738">Pointer</span><span class="op" id="2770745">(</span><span class="ident" id="2770746">fv</span><span class="op" id="2770748">)</span><span class="op" id="2770749">,</span>&nbsp;<span class="ident" id="2770751">v</span><span class="op" id="2770752">.</span><span class="ident" id="2770753">flag</span><span class="op" id="2770757">&amp;</span><span class="ident" id="2770758">flagRO</span>&nbsp;<span class="op" id="2770765">|</span>&nbsp;<span class="ident" id="2770767">flag</span><span class="op" id="2770771">(</span><span class="ident" id="2770772">Func</span><span class="op" id="2770776">)</span><span class="op" id="2770777">}</span><br>
<span class="lineno"></span><span class="op" id="2770779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2770782">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment" id="2770850">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment" id="2770923">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment" id="2771000">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2771074">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword" id="2771115">func</span>&nbsp;<span class="ident" id="2771120">methodValueCall</span><span class="op" id="2771135">(</span><span class="op" id="2771136">)</span>
</div>
</body>
</html>
