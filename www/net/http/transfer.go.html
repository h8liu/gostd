<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3643384">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3643439">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3643493">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3643544">package</span>&nbsp;<span class="ident" id="3643552">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3643558">import</span>&nbsp;<span class="op" id="3643565">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643568">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643577">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643586">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643596">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643603">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643609">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643622">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643643">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643660">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643668">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643679">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3643690">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3643697">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643700">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3643770">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3643806">var</span>&nbsp;<span class="ident" id="3643810">ErrLineTooLong</span>&nbsp;<span class="op" id="3643825">=</span>&nbsp;<span class="ident" id="3643827">internal</span><span class="op" id="3643835">.</span><span class="ident" id="3643836">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3643852">type</span>&nbsp;<span class="ident" id="3643857">errorReader</span>&nbsp;<span class="keyword" id="3643869">struct</span>&nbsp;<span class="op" id="3643876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3643879">err</span>&nbsp;<span class="builtintype" id="3643883">error</span><br>
<span class="lineno"></span><span class="op" id="3643889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3643892">func</span>&nbsp;<span class="op" id="3643897">(</span><span class="ident" id="3643898">r</span>&nbsp;<span class="op" id="3643900">*</span><span class="ident" id="3643901">errorReader</span><span class="op" id="3643912">)</span>&nbsp;<span class="ident" id="3643914">Read</span><span class="op" id="3643918">(</span><span class="ident" id="3643919">p</span>&nbsp;<span class="op" id="3643921">[</span><span class="op" id="3643922">]</span><span class="builtintype" id="3643923">byte</span><span class="op" id="3643927">)</span>&nbsp;<span class="op" id="3643929">(</span><span class="ident" id="3643930">n</span>&nbsp;<span class="builtintype" id="3643932">int</span><span class="op" id="3643935">,</span>&nbsp;<span class="ident" id="3643937">err</span>&nbsp;<span class="builtintype" id="3643941">error</span><span class="op" id="3643946">)</span>&nbsp;<span class="op" id="3643948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3643951">return</span>&nbsp;<span class="num" id="3643958">0</span><span class="op" id="3643959">,</span>&nbsp;<span class="ident" id="3643961">r</span><span class="op" id="3643962">.</span><span class="ident" id="3643963">err</span><br>
<span class="lineno"></span><span class="op" id="3643967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3643970">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3644048">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3644124">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3644191">type</span>&nbsp;<span class="ident" id="3644196">transferWriter</span>&nbsp;<span class="keyword" id="3644211">struct</span>&nbsp;<span class="op" id="3644218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644221">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3644238">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644246">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644263">io</span><span class="op" id="3644265">.</span><span class="ident" id="3644266">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644274">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644291">io</span><span class="op" id="3644293">.</span><span class="ident" id="3644294">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644302">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3644319">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644325">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644342">int64</span>&nbsp;<span class="comment" id="3644348">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644391">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3644408">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644414">TransferEncoding</span>&nbsp;<span class="op" id="3644431">[</span><span class="op" id="3644432">]</span><span class="builtintype" id="3644433">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644441">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644458">Header</span><br>
<span class="lineno"></span><span class="op" id="3644465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3644468">func</span>&nbsp;<span class="ident" id="3644473">newTransferWriter</span><span class="op" id="3644490">(</span><span class="ident" id="3644491">r</span>&nbsp;<span class="keyword" id="3644493">interface</span><span class="op" id="3644502">{</span><span class="op" id="3644503">}</span><span class="op" id="3644504">)</span>&nbsp;<span class="op" id="3644506">(</span><span class="ident" id="3644507">t</span>&nbsp;<span class="op" id="3644509">*</span><span class="ident" id="3644510">transferWriter</span><span class="op" id="3644524">,</span>&nbsp;<span class="ident" id="3644526">err</span>&nbsp;<span class="builtintype" id="3644530">error</span><span class="op" id="3644535">)</span>&nbsp;<span class="op" id="3644537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644540">t</span>&nbsp;<span class="op" id="3644542">=</span>&nbsp;<span class="op" id="3644544">&amp;</span><span class="ident" id="3644545">transferWriter</span><span class="op" id="3644559">{</span><span class="op" id="3644560">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3644564">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644592">atLeastHTTP11</span>&nbsp;<span class="op" id="3644606">:=</span>&nbsp;<span class="ident" id="3644609">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644616">switch</span>&nbsp;<span class="ident" id="3644623">rr</span>&nbsp;<span class="op" id="3644626">:=</span>&nbsp;<span class="ident" id="3644629">r</span><span class="op" id="3644630">.</span><span class="op" id="3644631">(</span><span class="keyword" id="3644632">type</span><span class="op" id="3644636">)</span>&nbsp;<span class="op" id="3644638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644641">case</span>&nbsp;<span class="op" id="3644646">*</span><span class="ident" id="3644647">Request</span><span class="op" id="3644654">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644658">if</span>&nbsp;<span class="ident" id="3644661">rr</span><span class="op" id="3644663">.</span><span class="ident" id="3644664">ContentLength</span>&nbsp;<span class="op" id="3644678">!=</span>&nbsp;<span class="num" id="3644681">0</span>&nbsp;<span class="op" id="3644683">&amp;&amp;</span>&nbsp;<span class="ident" id="3644686">rr</span><span class="op" id="3644688">.</span><span class="ident" id="3644689">Body</span>&nbsp;<span class="op" id="3644694">==</span>&nbsp;<span class="ident" id="3644697">nil</span>&nbsp;<span class="op" id="3644701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3644706">return</span>&nbsp;<span class="ident" id="3644713">nil</span><span class="op" id="3644716">,</span>&nbsp;<span class="ident" id="3644718">fmt</span><span class="op" id="3644721">.</span><span class="ident" id="3644722">Errorf</span><span class="op" id="3644728">(</span><span class="string" id="3644729">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3644775">,</span>&nbsp;<span class="ident" id="3644777">rr</span><span class="op" id="3644779">.</span><span class="ident" id="3644780">ContentLength</span><span class="op" id="3644793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3644797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644801">t</span><span class="op" id="3644802">.</span><span class="ident" id="3644803">Method</span>&nbsp;<span class="op" id="3644810">=</span>&nbsp;<span class="ident" id="3644812">rr</span><span class="op" id="3644814">.</span><span class="ident" id="3644815">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644824">t</span><span class="op" id="3644825">.</span><span class="ident" id="3644826">Body</span>&nbsp;<span class="op" id="3644831">=</span>&nbsp;<span class="ident" id="3644833">rr</span><span class="op" id="3644835">.</span><span class="ident" id="3644836">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644843">t</span><span class="op" id="3644844">.</span><span class="ident" id="3644845">BodyCloser</span>&nbsp;<span class="op" id="3644856">=</span>&nbsp;<span class="ident" id="3644858">rr</span><span class="op" id="3644860">.</span><span class="ident" id="3644861">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644868">t</span><span class="op" id="3644869">.</span><span class="ident" id="3644870">ContentLength</span>&nbsp;<span class="op" id="3644884">=</span>&nbsp;<span class="ident" id="3644886">rr</span><span class="op" id="3644888">.</span><span class="ident" id="3644889">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644905">t</span><span class="op" id="3644906">.</span><span class="ident" id="3644907">Close</span>&nbsp;<span class="op" id="3644913">=</span>&nbsp;<span class="ident" id="3644915">rr</span><span class="op" id="3644917">.</span><span class="ident" id="3644918">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644926">t</span><span class="op" id="3644927">.</span><span class="ident" id="3644928">TransferEncoding</span>&nbsp;<span class="op" id="3644945">=</span>&nbsp;<span class="ident" id="3644947">rr</span><span class="op" id="3644949">.</span><span class="ident" id="3644950">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644969">t</span><span class="op" id="3644970">.</span><span class="ident" id="3644971">Trailer</span>&nbsp;<span class="op" id="3644979">=</span>&nbsp;<span class="ident" id="3644981">rr</span><span class="op" id="3644983">.</span><span class="ident" id="3644984">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3644994">atLeastHTTP11</span>&nbsp;<span class="op" id="3645008">=</span>&nbsp;<span class="ident" id="3645010">rr</span><span class="op" id="3645012">.</span><span class="ident" id="3645013">ProtoAtLeast</span><span class="op" id="3645025">(</span><span class="num" id="3645026">1</span><span class="op" id="3645027">,</span>&nbsp;<span class="num" id="3645029">1</span><span class="op" id="3645030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645034">if</span>&nbsp;<span class="ident" id="3645037">t</span><span class="op" id="3645038">.</span><span class="ident" id="3645039">Body</span>&nbsp;<span class="op" id="3645044">!=</span>&nbsp;<span class="ident" id="3645047">nil</span>&nbsp;<span class="op" id="3645051">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3645054">len</span><span class="op" id="3645057">(</span><span class="ident" id="3645058">t</span><span class="op" id="3645059">.</span><span class="ident" id="3645060">TransferEncoding</span><span class="op" id="3645076">)</span>&nbsp;<span class="op" id="3645078">==</span>&nbsp;<span class="num" id="3645081">0</span>&nbsp;<span class="op" id="3645083">&amp;&amp;</span>&nbsp;<span class="ident" id="3645086">atLeastHTTP11</span>&nbsp;<span class="op" id="3645100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645105">if</span>&nbsp;<span class="ident" id="3645108">t</span><span class="op" id="3645109">.</span><span class="ident" id="3645110">ContentLength</span>&nbsp;<span class="op" id="3645124">==</span>&nbsp;<span class="num" id="3645127">0</span>&nbsp;<span class="op" id="3645129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645135">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645191">var</span>&nbsp;<span class="ident" id="3645195">buf</span>&nbsp;<span class="op" id="3645199">[</span><span class="num" id="3645200">1</span><span class="op" id="3645201">]</span><span class="builtintype" id="3645202">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645211">n</span><span class="op" id="3645212">,</span>&nbsp;<span class="ident" id="3645214">rerr</span>&nbsp;<span class="op" id="3645219">:=</span>&nbsp;<span class="ident" id="3645222">io</span><span class="op" id="3645224">.</span><span class="ident" id="3645225">ReadFull</span><span class="op" id="3645233">(</span><span class="ident" id="3645234">t</span><span class="op" id="3645235">.</span><span class="ident" id="3645236">Body</span><span class="op" id="3645240">,</span>&nbsp;<span class="ident" id="3645242">buf</span><span class="op" id="3645245">[</span><span class="op" id="3645246">:</span><span class="op" id="3645247">]</span><span class="op" id="3645248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645254">if</span>&nbsp;<span class="ident" id="3645257">rerr</span>&nbsp;<span class="op" id="3645262">!=</span>&nbsp;<span class="ident" id="3645265">nil</span>&nbsp;<span class="op" id="3645269">&amp;&amp;</span>&nbsp;<span class="ident" id="3645272">rerr</span>&nbsp;<span class="op" id="3645277">!=</span>&nbsp;<span class="ident" id="3645280">io</span><span class="op" id="3645282">.</span><span class="ident" id="3645283">EOF</span>&nbsp;<span class="op" id="3645287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645294">t</span><span class="op" id="3645295">.</span><span class="ident" id="3645296">ContentLength</span>&nbsp;<span class="op" id="3645310">=</span>&nbsp;<span class="op" id="3645312">-</span><span class="num" id="3645313">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645320">t</span><span class="op" id="3645321">.</span><span class="ident" id="3645322">Body</span>&nbsp;<span class="op" id="3645327">=</span>&nbsp;<span class="op" id="3645329">&amp;</span><span class="ident" id="3645330">errorReader</span><span class="op" id="3645341">{</span><span class="ident" id="3645342">rerr</span><span class="op" id="3645346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645352">}</span>&nbsp;<span class="keyword" id="3645354">else</span>&nbsp;<span class="keyword" id="3645359">if</span>&nbsp;<span class="ident" id="3645362">n</span>&nbsp;<span class="op" id="3645364">==</span>&nbsp;<span class="num" id="3645367">1</span>&nbsp;<span class="op" id="3645369">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645376">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645439">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645488">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645549">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645572">t</span><span class="op" id="3645573">.</span><span class="ident" id="3645574">ContentLength</span>&nbsp;<span class="op" id="3645588">=</span>&nbsp;<span class="op" id="3645590">-</span><span class="num" id="3645591">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645598">t</span><span class="op" id="3645599">.</span><span class="ident" id="3645600">Body</span>&nbsp;<span class="op" id="3645605">=</span>&nbsp;<span class="ident" id="3645607">io</span><span class="op" id="3645609">.</span><span class="ident" id="3645610">MultiReader</span><span class="op" id="3645621">(</span><span class="ident" id="3645622">bytes</span><span class="op" id="3645627">.</span><span class="ident" id="3645628">NewReader</span><span class="op" id="3645637">(</span><span class="ident" id="3645638">buf</span><span class="op" id="3645641">[</span><span class="op" id="3645642">:</span><span class="op" id="3645643">]</span><span class="op" id="3645644">)</span><span class="op" id="3645645">,</span>&nbsp;<span class="ident" id="3645647">t</span><span class="op" id="3645648">.</span><span class="ident" id="3645649">Body</span><span class="op" id="3645653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645659">}</span>&nbsp;<span class="keyword" id="3645661">else</span>&nbsp;<span class="op" id="3645666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3645673">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645705">t</span><span class="op" id="3645706">.</span><span class="ident" id="3645707">Body</span>&nbsp;<span class="op" id="3645712">=</span>&nbsp;<span class="ident" id="3645714">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645723">t</span><span class="op" id="3645724">.</span><span class="ident" id="3645725">BodyCloser</span>&nbsp;<span class="op" id="3645736">=</span>&nbsp;<span class="ident" id="3645738">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645756">if</span>&nbsp;<span class="ident" id="3645759">t</span><span class="op" id="3645760">.</span><span class="ident" id="3645761">ContentLength</span>&nbsp;<span class="op" id="3645775">&lt;</span>&nbsp;<span class="num" id="3645777">0</span>&nbsp;<span class="op" id="3645779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645785">t</span><span class="op" id="3645786">.</span><span class="ident" id="3645787">TransferEncoding</span>&nbsp;<span class="op" id="3645804">=</span>&nbsp;<span class="op" id="3645806">[</span><span class="op" id="3645807">]</span><span class="builtintype" id="3645808">string</span><span class="op" id="3645814">{</span><span class="string" id="3645815">&#34;chunked&#34;</span><span class="op" id="3645824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645829">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645836">case</span>&nbsp;<span class="op" id="3645841">*</span><span class="ident" id="3645842">Response</span><span class="op" id="3645850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3645854">if</span>&nbsp;<span class="ident" id="3645857">rr</span><span class="op" id="3645859">.</span><span class="ident" id="3645860">Request</span>&nbsp;<span class="op" id="3645868">!=</span>&nbsp;<span class="ident" id="3645871">nil</span>&nbsp;<span class="op" id="3645875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645880">t</span><span class="op" id="3645881">.</span><span class="ident" id="3645882">Method</span>&nbsp;<span class="op" id="3645889">=</span>&nbsp;<span class="ident" id="3645891">rr</span><span class="op" id="3645893">.</span><span class="ident" id="3645894">Request</span><span class="op" id="3645901">.</span><span class="ident" id="3645902">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3645911">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645915">t</span><span class="op" id="3645916">.</span><span class="ident" id="3645917">Body</span>&nbsp;<span class="op" id="3645922">=</span>&nbsp;<span class="ident" id="3645924">rr</span><span class="op" id="3645926">.</span><span class="ident" id="3645927">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645934">t</span><span class="op" id="3645935">.</span><span class="ident" id="3645936">BodyCloser</span>&nbsp;<span class="op" id="3645947">=</span>&nbsp;<span class="ident" id="3645949">rr</span><span class="op" id="3645951">.</span><span class="ident" id="3645952">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645959">t</span><span class="op" id="3645960">.</span><span class="ident" id="3645961">ContentLength</span>&nbsp;<span class="op" id="3645975">=</span>&nbsp;<span class="ident" id="3645977">rr</span><span class="op" id="3645979">.</span><span class="ident" id="3645980">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3645996">t</span><span class="op" id="3645997">.</span><span class="ident" id="3645998">Close</span>&nbsp;<span class="op" id="3646004">=</span>&nbsp;<span class="ident" id="3646006">rr</span><span class="op" id="3646008">.</span><span class="ident" id="3646009">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646017">t</span><span class="op" id="3646018">.</span><span class="ident" id="3646019">TransferEncoding</span>&nbsp;<span class="op" id="3646036">=</span>&nbsp;<span class="ident" id="3646038">rr</span><span class="op" id="3646040">.</span><span class="ident" id="3646041">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646060">t</span><span class="op" id="3646061">.</span><span class="ident" id="3646062">Trailer</span>&nbsp;<span class="op" id="3646070">=</span>&nbsp;<span class="ident" id="3646072">rr</span><span class="op" id="3646074">.</span><span class="ident" id="3646075">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646085">atLeastHTTP11</span>&nbsp;<span class="op" id="3646099">=</span>&nbsp;<span class="ident" id="3646101">rr</span><span class="op" id="3646103">.</span><span class="ident" id="3646104">ProtoAtLeast</span><span class="op" id="3646116">(</span><span class="num" id="3646117">1</span><span class="op" id="3646118">,</span>&nbsp;<span class="num" id="3646120">1</span><span class="op" id="3646121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646125">t</span><span class="op" id="3646126">.</span><span class="ident" id="3646127">ResponseToHEAD</span>&nbsp;<span class="op" id="3646142">=</span>&nbsp;<span class="ident" id="3646144">noBodyExpected</span><span class="op" id="3646158">(</span><span class="ident" id="3646159">t</span><span class="op" id="3646160">.</span><span class="ident" id="3646161">Method</span><span class="op" id="3646167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646174">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646223">if</span>&nbsp;<span class="ident" id="3646226">t</span><span class="op" id="3646227">.</span><span class="ident" id="3646228">ResponseToHEAD</span>&nbsp;<span class="op" id="3646243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646247">t</span><span class="op" id="3646248">.</span><span class="ident" id="3646249">Body</span>&nbsp;<span class="op" id="3646254">=</span>&nbsp;<span class="ident" id="3646256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646262">if</span>&nbsp;<span class="ident" id="3646265">chunked</span><span class="op" id="3646272">(</span><span class="ident" id="3646273">t</span><span class="op" id="3646274">.</span><span class="ident" id="3646275">TransferEncoding</span><span class="op" id="3646291">)</span>&nbsp;<span class="op" id="3646293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646298">t</span><span class="op" id="3646299">.</span><span class="ident" id="3646300">ContentLength</span>&nbsp;<span class="op" id="3646314">=</span>&nbsp;<span class="op" id="3646316">-</span><span class="num" id="3646317">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646324">}</span>&nbsp;<span class="keyword" id="3646326">else</span>&nbsp;<span class="op" id="3646331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646335">if</span>&nbsp;<span class="op" id="3646338">!</span><span class="ident" id="3646339">atLeastHTTP11</span>&nbsp;<span class="op" id="3646353">||</span>&nbsp;<span class="ident" id="3646356">t</span><span class="op" id="3646357">.</span><span class="ident" id="3646358">Body</span>&nbsp;<span class="op" id="3646363">==</span>&nbsp;<span class="ident" id="3646366">nil</span>&nbsp;<span class="op" id="3646370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646375">t</span><span class="op" id="3646376">.</span><span class="ident" id="3646377">TransferEncoding</span>&nbsp;<span class="op" id="3646394">=</span>&nbsp;<span class="ident" id="3646396">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646402">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646406">if</span>&nbsp;<span class="ident" id="3646409">chunked</span><span class="op" id="3646416">(</span><span class="ident" id="3646417">t</span><span class="op" id="3646418">.</span><span class="ident" id="3646419">TransferEncoding</span><span class="op" id="3646435">)</span>&nbsp;<span class="op" id="3646437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646442">t</span><span class="op" id="3646443">.</span><span class="ident" id="3646444">ContentLength</span>&nbsp;<span class="op" id="3646458">=</span>&nbsp;<span class="op" id="3646460">-</span><span class="num" id="3646461">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646465">}</span>&nbsp;<span class="keyword" id="3646467">else</span>&nbsp;<span class="keyword" id="3646472">if</span>&nbsp;<span class="ident" id="3646475">t</span><span class="op" id="3646476">.</span><span class="ident" id="3646477">Body</span>&nbsp;<span class="op" id="3646482">==</span>&nbsp;<span class="ident" id="3646485">nil</span>&nbsp;<span class="op" id="3646489">{</span>&nbsp;<span class="comment" id="3646491">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646518">t</span><span class="op" id="3646519">.</span><span class="ident" id="3646520">ContentLength</span>&nbsp;<span class="op" id="3646534">=</span>&nbsp;<span class="num" id="3646536">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646540">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646547">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646568">if</span>&nbsp;<span class="op" id="3646571">!</span><span class="ident" id="3646572">chunked</span><span class="op" id="3646579">(</span><span class="ident" id="3646580">t</span><span class="op" id="3646581">.</span><span class="ident" id="3646582">TransferEncoding</span><span class="op" id="3646598">)</span>&nbsp;<span class="op" id="3646600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3646604">t</span><span class="op" id="3646605">.</span><span class="ident" id="3646606">Trailer</span>&nbsp;<span class="op" id="3646614">=</span>&nbsp;<span class="ident" id="3646616">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646625">return</span>&nbsp;<span class="ident" id="3646632">t</span><span class="op" id="3646633">,</span>&nbsp;<span class="ident" id="3646635">nil</span><br>
<span class="lineno"></span><span class="op" id="3646639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3646642">func</span>&nbsp;<span class="ident" id="3646647">noBodyExpected</span><span class="op" id="3646661">(</span><span class="ident" id="3646662">requestMethod</span>&nbsp;<span class="builtintype" id="3646676">string</span><span class="op" id="3646682">)</span>&nbsp;<span class="builtintype" id="3646684">bool</span>&nbsp;<span class="op" id="3646689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646692">return</span>&nbsp;<span class="ident" id="3646699">requestMethod</span>&nbsp;<span class="op" id="3646713">==</span>&nbsp;<span class="string" id="3646716">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3646723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3646726">func</span>&nbsp;<span class="op" id="3646731">(</span><span class="ident" id="3646732">t</span>&nbsp;<span class="op" id="3646734">*</span><span class="ident" id="3646735">transferWriter</span><span class="op" id="3646749">)</span>&nbsp;<span class="ident" id="3646751">shouldSendContentLength</span><span class="op" id="3646774">(</span><span class="op" id="3646775">)</span>&nbsp;<span class="builtintype" id="3646777">bool</span>&nbsp;<span class="op" id="3646782">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646785">if</span>&nbsp;<span class="ident" id="3646788">chunked</span><span class="op" id="3646795">(</span><span class="ident" id="3646796">t</span><span class="op" id="3646797">.</span><span class="ident" id="3646798">TransferEncoding</span><span class="op" id="3646814">)</span>&nbsp;<span class="op" id="3646816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646820">return</span>&nbsp;<span class="ident" id="3646827">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646837">if</span>&nbsp;<span class="ident" id="3646840">t</span><span class="op" id="3646841">.</span><span class="ident" id="3646842">ContentLength</span>&nbsp;<span class="op" id="3646856">&gt;</span>&nbsp;<span class="num" id="3646858">0</span>&nbsp;<span class="op" id="3646860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646864">return</span>&nbsp;<span class="ident" id="3646871">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3646880">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646939">if</span>&nbsp;<span class="ident" id="3646942">t</span><span class="op" id="3646943">.</span><span class="ident" id="3646944">Method</span>&nbsp;<span class="op" id="3646951">==</span>&nbsp;<span class="string" id="3646954">&#34;POST&#34;</span>&nbsp;<span class="op" id="3646961">||</span>&nbsp;<span class="ident" id="3646964">t</span><span class="op" id="3646965">.</span><span class="ident" id="3646966">Method</span>&nbsp;<span class="op" id="3646973">==</span>&nbsp;<span class="string" id="3646976">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3646982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3646986">return</span>&nbsp;<span class="ident" id="3646993">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3646999">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647002">if</span>&nbsp;<span class="ident" id="3647005">t</span><span class="op" id="3647006">.</span><span class="ident" id="3647007">ContentLength</span>&nbsp;<span class="op" id="3647021">==</span>&nbsp;<span class="num" id="3647024">0</span>&nbsp;<span class="op" id="3647026">&amp;&amp;</span>&nbsp;<span class="ident" id="3647029">isIdentity</span><span class="op" id="3647039">(</span><span class="ident" id="3647040">t</span><span class="op" id="3647041">.</span><span class="ident" id="3647042">TransferEncoding</span><span class="op" id="3647058">)</span>&nbsp;<span class="op" id="3647060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647064">return</span>&nbsp;<span class="ident" id="3647071">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647081">return</span>&nbsp;<span class="ident" id="3647088">false</span><br>
<span class="lineno">150</span><span class="op" id="3647094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3647097">func</span>&nbsp;<span class="op" id="3647102">(</span><span class="ident" id="3647103">t</span>&nbsp;<span class="op" id="3647105">*</span><span class="ident" id="3647106">transferWriter</span><span class="op" id="3647120">)</span>&nbsp;<span class="ident" id="3647122">WriteHeader</span><span class="op" id="3647133">(</span><span class="ident" id="3647134">w</span>&nbsp;<span class="ident" id="3647136">io</span><span class="op" id="3647138">.</span><span class="ident" id="3647139">Writer</span><span class="op" id="3647145">)</span>&nbsp;<span class="builtintype" id="3647147">error</span>&nbsp;<span class="op" id="3647153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647156">if</span>&nbsp;<span class="ident" id="3647159">t</span><span class="op" id="3647160">.</span><span class="ident" id="3647161">Close</span>&nbsp;<span class="op" id="3647167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647171">if</span>&nbsp;<span class="ident" id="3647174">_</span><span class="op" id="3647175">,</span>&nbsp;<span class="ident" id="3647177">err</span>&nbsp;<span class="op" id="3647181">:=</span>&nbsp;<span class="ident" id="3647184">io</span><span class="op" id="3647186">.</span><span class="ident" id="3647187">WriteString</span><span class="op" id="3647198">(</span><span class="ident" id="3647199">w</span><span class="op" id="3647200">,</span>&nbsp;<span class="string" id="3647202">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3647225">)</span><span class="op" id="3647226">;</span>&nbsp;<span class="ident" id="3647228">err</span>&nbsp;<span class="op" id="3647232">!=</span>&nbsp;<span class="ident" id="3647235">nil</span>&nbsp;<span class="op" id="3647239">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647244">return</span>&nbsp;<span class="ident" id="3647251">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647264">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647333">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647398">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647420">if</span>&nbsp;<span class="ident" id="3647423">t</span><span class="op" id="3647424">.</span><span class="ident" id="3647425">shouldSendContentLength</span><span class="op" id="3647448">(</span><span class="op" id="3647449">)</span>&nbsp;<span class="op" id="3647451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647455">if</span>&nbsp;<span class="ident" id="3647458">_</span><span class="op" id="3647459">,</span>&nbsp;<span class="ident" id="3647461">err</span>&nbsp;<span class="op" id="3647465">:=</span>&nbsp;<span class="ident" id="3647468">io</span><span class="op" id="3647470">.</span><span class="ident" id="3647471">WriteString</span><span class="op" id="3647482">(</span><span class="ident" id="3647483">w</span><span class="op" id="3647484">,</span>&nbsp;<span class="string" id="3647486">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3647504">)</span><span class="op" id="3647505">;</span>&nbsp;<span class="ident" id="3647507">err</span>&nbsp;<span class="op" id="3647511">!=</span>&nbsp;<span class="ident" id="3647514">nil</span>&nbsp;<span class="op" id="3647518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647523">return</span>&nbsp;<span class="ident" id="3647530">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647540">if</span>&nbsp;<span class="ident" id="3647543">_</span><span class="op" id="3647544">,</span>&nbsp;<span class="ident" id="3647546">err</span>&nbsp;<span class="op" id="3647550">:=</span>&nbsp;<span class="ident" id="3647553">io</span><span class="op" id="3647555">.</span><span class="ident" id="3647556">WriteString</span><span class="op" id="3647567">(</span><span class="ident" id="3647568">w</span><span class="op" id="3647569">,</span>&nbsp;<span class="ident" id="3647571">strconv</span><span class="op" id="3647578">.</span><span class="ident" id="3647579">FormatInt</span><span class="op" id="3647588">(</span><span class="ident" id="3647589">t</span><span class="op" id="3647590">.</span><span class="ident" id="3647591">ContentLength</span><span class="op" id="3647604">,</span>&nbsp;<span class="num" id="3647606">10</span><span class="op" id="3647608">)</span><span class="op" id="3647609">+</span><span class="string" id="3647610">&#34;\r\n&#34;</span><span class="op" id="3647616">)</span><span class="op" id="3647617">;</span>&nbsp;<span class="ident" id="3647619">err</span>&nbsp;<span class="op" id="3647623">!=</span>&nbsp;<span class="ident" id="3647626">nil</span>&nbsp;<span class="op" id="3647630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647635">return</span>&nbsp;<span class="ident" id="3647642">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647651">}</span>&nbsp;<span class="keyword" id="3647653">else</span>&nbsp;<span class="keyword" id="3647658">if</span>&nbsp;<span class="ident" id="3647661">chunked</span><span class="op" id="3647668">(</span><span class="ident" id="3647669">t</span><span class="op" id="3647670">.</span><span class="ident" id="3647671">TransferEncoding</span><span class="op" id="3647687">)</span>&nbsp;<span class="op" id="3647689">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647693">if</span>&nbsp;<span class="ident" id="3647696">_</span><span class="op" id="3647697">,</span>&nbsp;<span class="ident" id="3647699">err</span>&nbsp;<span class="op" id="3647703">:=</span>&nbsp;<span class="ident" id="3647706">io</span><span class="op" id="3647708">.</span><span class="ident" id="3647709">WriteString</span><span class="op" id="3647720">(</span><span class="ident" id="3647721">w</span><span class="op" id="3647722">,</span>&nbsp;<span class="string" id="3647724">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3647756">)</span><span class="op" id="3647757">;</span>&nbsp;<span class="ident" id="3647759">err</span>&nbsp;<span class="op" id="3647763">!=</span>&nbsp;<span class="ident" id="3647766">nil</span>&nbsp;<span class="op" id="3647770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647775">return</span>&nbsp;<span class="ident" id="3647782">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3647791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3647795">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647820">if</span>&nbsp;<span class="ident" id="3647823">t</span><span class="op" id="3647824">.</span><span class="ident" id="3647825">Trailer</span>&nbsp;<span class="op" id="3647833">!=</span>&nbsp;<span class="ident" id="3647836">nil</span>&nbsp;<span class="op" id="3647840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647844">keys</span>&nbsp;<span class="op" id="3647849">:=</span>&nbsp;<span class="builtinfunc" id="3647852">make</span><span class="op" id="3647856">(</span><span class="op" id="3647857">[</span><span class="op" id="3647858">]</span><span class="builtintype" id="3647859">string</span><span class="op" id="3647865">,</span>&nbsp;<span class="num" id="3647867">0</span><span class="op" id="3647868">,</span>&nbsp;<span class="builtinfunc" id="3647870">len</span><span class="op" id="3647873">(</span><span class="ident" id="3647874">t</span><span class="op" id="3647875">.</span><span class="ident" id="3647876">Trailer</span><span class="op" id="3647883">)</span><span class="op" id="3647884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647888">for</span>&nbsp;<span class="ident" id="3647892">k</span>&nbsp;<span class="op" id="3647894">:=</span>&nbsp;<span class="keyword" id="3647897">range</span>&nbsp;<span class="ident" id="3647903">t</span><span class="op" id="3647904">.</span><span class="ident" id="3647905">Trailer</span>&nbsp;<span class="op" id="3647913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3647918">k</span>&nbsp;<span class="op" id="3647920">=</span>&nbsp;<span class="ident" id="3647922">CanonicalHeaderKey</span><span class="op" id="3647940">(</span><span class="ident" id="3647941">k</span><span class="op" id="3647942">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647947">switch</span>&nbsp;<span class="ident" id="3647954">k</span>&nbsp;<span class="op" id="3647956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3647961">case</span>&nbsp;<span class="string" id="3647966">&#34;Transfer-Encoding&#34;</span><span class="op" id="3647985">,</span>&nbsp;<span class="string" id="3647987">&#34;Trailer&#34;</span><span class="op" id="3647996">,</span>&nbsp;<span class="string" id="3647998">&#34;Content-Length&#34;</span><span class="op" id="3648014">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648020">return</span>&nbsp;<span class="op" id="3648027">&amp;</span><span class="ident" id="3648028">badStringError</span><span class="op" id="3648042">{</span><span class="string" id="3648043">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3648064">,</span>&nbsp;<span class="ident" id="3648066">k</span><span class="op" id="3648067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648077">keys</span>&nbsp;<span class="op" id="3648082">=</span>&nbsp;<span class="builtinfunc" id="3648084">append</span><span class="op" id="3648090">(</span><span class="ident" id="3648091">keys</span><span class="op" id="3648095">,</span>&nbsp;<span class="ident" id="3648097">k</span><span class="op" id="3648098">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648106">if</span>&nbsp;<span class="builtinfunc" id="3648109">len</span><span class="op" id="3648112">(</span><span class="ident" id="3648113">keys</span><span class="op" id="3648117">)</span>&nbsp;<span class="op" id="3648119">&gt;</span>&nbsp;<span class="num" id="3648121">0</span>&nbsp;<span class="op" id="3648123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648128">sort</span><span class="op" id="3648132">.</span><span class="ident" id="3648133">Strings</span><span class="op" id="3648140">(</span><span class="ident" id="3648141">keys</span><span class="op" id="3648145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3648150">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3648223">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648252">if</span>&nbsp;<span class="ident" id="3648255">_</span><span class="op" id="3648256">,</span>&nbsp;<span class="ident" id="3648258">err</span>&nbsp;<span class="op" id="3648262">:=</span>&nbsp;<span class="ident" id="3648265">io</span><span class="op" id="3648267">.</span><span class="ident" id="3648268">WriteString</span><span class="op" id="3648279">(</span><span class="ident" id="3648280">w</span><span class="op" id="3648281">,</span>&nbsp;<span class="string" id="3648283">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3648294">+</span><span class="ident" id="3648295">strings</span><span class="op" id="3648302">.</span><span class="ident" id="3648303">Join</span><span class="op" id="3648307">(</span><span class="ident" id="3648308">keys</span><span class="op" id="3648312">,</span>&nbsp;<span class="string" id="3648314">&#34;,&#34;</span><span class="op" id="3648317">)</span><span class="op" id="3648318">+</span><span class="string" id="3648319">&#34;\r\n&#34;</span><span class="op" id="3648325">)</span><span class="op" id="3648326">;</span>&nbsp;<span class="ident" id="3648328">err</span>&nbsp;<span class="op" id="3648332">!=</span>&nbsp;<span class="ident" id="3648335">nil</span>&nbsp;<span class="op" id="3648339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648345">return</span>&nbsp;<span class="ident" id="3648352">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648366">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648370">return</span>&nbsp;<span class="ident" id="3648377">nil</span><br>
<span class="lineno"></span><span class="op" id="3648381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3648384">func</span>&nbsp;<span class="op" id="3648389">(</span><span class="ident" id="3648390">t</span>&nbsp;<span class="op" id="3648392">*</span><span class="ident" id="3648393">transferWriter</span><span class="op" id="3648407">)</span>&nbsp;<span class="ident" id="3648409">WriteBody</span><span class="op" id="3648418">(</span><span class="ident" id="3648419">w</span>&nbsp;<span class="ident" id="3648421">io</span><span class="op" id="3648423">.</span><span class="ident" id="3648424">Writer</span><span class="op" id="3648430">)</span>&nbsp;<span class="builtintype" id="3648432">error</span>&nbsp;<span class="op" id="3648438">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648441">var</span>&nbsp;<span class="ident" id="3648445">err</span>&nbsp;<span class="builtintype" id="3648449">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648456">var</span>&nbsp;<span class="ident" id="3648460">ncopy</span>&nbsp;<span class="ident" id="3648466">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3648474">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648489">if</span>&nbsp;<span class="ident" id="3648492">t</span><span class="op" id="3648493">.</span><span class="ident" id="3648494">Body</span>&nbsp;<span class="op" id="3648499">!=</span>&nbsp;<span class="ident" id="3648502">nil</span>&nbsp;<span class="op" id="3648506">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648510">if</span>&nbsp;<span class="ident" id="3648513">chunked</span><span class="op" id="3648520">(</span><span class="ident" id="3648521">t</span><span class="op" id="3648522">.</span><span class="ident" id="3648523">TransferEncoding</span><span class="op" id="3648539">)</span>&nbsp;<span class="op" id="3648541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648546">cw</span>&nbsp;<span class="op" id="3648549">:=</span>&nbsp;<span class="ident" id="3648552">internal</span><span class="op" id="3648560">.</span><span class="ident" id="3648561">NewChunkedWriter</span><span class="op" id="3648577">(</span><span class="ident" id="3648578">w</span><span class="op" id="3648579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648584">_</span><span class="op" id="3648585">,</span>&nbsp;<span class="ident" id="3648587">err</span>&nbsp;<span class="op" id="3648591">=</span>&nbsp;<span class="ident" id="3648593">io</span><span class="op" id="3648595">.</span><span class="ident" id="3648596">Copy</span><span class="op" id="3648600">(</span><span class="ident" id="3648601">cw</span><span class="op" id="3648603">,</span>&nbsp;<span class="ident" id="3648605">t</span><span class="op" id="3648606">.</span><span class="ident" id="3648607">Body</span><span class="op" id="3648611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648616">if</span>&nbsp;<span class="ident" id="3648619">err</span>&nbsp;<span class="op" id="3648623">==</span>&nbsp;<span class="ident" id="3648626">nil</span>&nbsp;<span class="op" id="3648630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648636">err</span>&nbsp;<span class="op" id="3648640">=</span>&nbsp;<span class="ident" id="3648642">cw</span><span class="op" id="3648644">.</span><span class="ident" id="3648645">Close</span><span class="op" id="3648650">(</span><span class="op" id="3648651">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648660">}</span>&nbsp;<span class="keyword" id="3648662">else</span>&nbsp;<span class="keyword" id="3648667">if</span>&nbsp;<span class="ident" id="3648670">t</span><span class="op" id="3648671">.</span><span class="ident" id="3648672">ContentLength</span>&nbsp;<span class="op" id="3648686">==</span>&nbsp;<span class="op" id="3648689">-</span><span class="num" id="3648690">1</span>&nbsp;<span class="op" id="3648692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648697">ncopy</span><span class="op" id="3648702">,</span>&nbsp;<span class="ident" id="3648704">err</span>&nbsp;<span class="op" id="3648708">=</span>&nbsp;<span class="ident" id="3648710">io</span><span class="op" id="3648712">.</span><span class="ident" id="3648713">Copy</span><span class="op" id="3648717">(</span><span class="ident" id="3648718">w</span><span class="op" id="3648719">,</span>&nbsp;<span class="ident" id="3648721">t</span><span class="op" id="3648722">.</span><span class="ident" id="3648723">Body</span><span class="op" id="3648727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648731">}</span>&nbsp;<span class="keyword" id="3648733">else</span>&nbsp;<span class="op" id="3648738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648743">ncopy</span><span class="op" id="3648748">,</span>&nbsp;<span class="ident" id="3648750">err</span>&nbsp;<span class="op" id="3648754">=</span>&nbsp;<span class="ident" id="3648756">io</span><span class="op" id="3648758">.</span><span class="ident" id="3648759">Copy</span><span class="op" id="3648763">(</span><span class="ident" id="3648764">w</span><span class="op" id="3648765">,</span>&nbsp;<span class="ident" id="3648767">io</span><span class="op" id="3648769">.</span><span class="ident" id="3648770">LimitReader</span><span class="op" id="3648781">(</span><span class="ident" id="3648782">t</span><span class="op" id="3648783">.</span><span class="ident" id="3648784">Body</span><span class="op" id="3648788">,</span>&nbsp;<span class="ident" id="3648790">t</span><span class="op" id="3648791">.</span><span class="ident" id="3648792">ContentLength</span><span class="op" id="3648805">)</span><span class="op" id="3648806">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648811">if</span>&nbsp;<span class="ident" id="3648814">err</span>&nbsp;<span class="op" id="3648818">!=</span>&nbsp;<span class="ident" id="3648821">nil</span>&nbsp;<span class="op" id="3648825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648831">return</span>&nbsp;<span class="ident" id="3648838">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648850">var</span>&nbsp;<span class="ident" id="3648854">nextra</span>&nbsp;<span class="ident" id="3648861">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648870">nextra</span><span class="op" id="3648876">,</span>&nbsp;<span class="ident" id="3648878">err</span>&nbsp;<span class="op" id="3648882">=</span>&nbsp;<span class="ident" id="3648884">io</span><span class="op" id="3648886">.</span><span class="ident" id="3648887">Copy</span><span class="op" id="3648891">(</span><span class="ident" id="3648892">ioutil</span><span class="op" id="3648898">.</span><span class="ident" id="3648899">Discard</span><span class="op" id="3648906">,</span>&nbsp;<span class="ident" id="3648908">t</span><span class="op" id="3648909">.</span><span class="ident" id="3648910">Body</span><span class="op" id="3648914">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3648919">ncopy</span>&nbsp;<span class="op" id="3648925">+=</span>&nbsp;<span class="ident" id="3648928">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648941">if</span>&nbsp;<span class="ident" id="3648944">err</span>&nbsp;<span class="op" id="3648948">!=</span>&nbsp;<span class="ident" id="3648951">nil</span>&nbsp;<span class="op" id="3648955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648960">return</span>&nbsp;<span class="ident" id="3648967">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3648973">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3648977">if</span>&nbsp;<span class="ident" id="3648980">err</span>&nbsp;<span class="op" id="3648984">=</span>&nbsp;<span class="ident" id="3648986">t</span><span class="op" id="3648987">.</span><span class="ident" id="3648988">BodyCloser</span><span class="op" id="3648998">.</span><span class="ident" id="3648999">Close</span><span class="op" id="3649004">(</span><span class="op" id="3649005">)</span><span class="op" id="3649006">;</span>&nbsp;<span class="ident" id="3649008">err</span>&nbsp;<span class="op" id="3649012">!=</span>&nbsp;<span class="ident" id="3649015">nil</span>&nbsp;<span class="op" id="3649019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649024">return</span>&nbsp;<span class="ident" id="3649031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649044">if</span>&nbsp;<span class="op" id="3649047">!</span><span class="ident" id="3649048">t</span><span class="op" id="3649049">.</span><span class="ident" id="3649050">ResponseToHEAD</span>&nbsp;<span class="op" id="3649065">&amp;&amp;</span>&nbsp;<span class="ident" id="3649068">t</span><span class="op" id="3649069">.</span><span class="ident" id="3649070">ContentLength</span>&nbsp;<span class="op" id="3649084">!=</span>&nbsp;<span class="op" id="3649087">-</span><span class="num" id="3649088">1</span>&nbsp;<span class="op" id="3649090">&amp;&amp;</span>&nbsp;<span class="ident" id="3649093">t</span><span class="op" id="3649094">.</span><span class="ident" id="3649095">ContentLength</span>&nbsp;<span class="op" id="3649109">!=</span>&nbsp;<span class="ident" id="3649112">ncopy</span>&nbsp;<span class="op" id="3649118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649122">return</span>&nbsp;<span class="ident" id="3649129">fmt</span><span class="op" id="3649132">.</span><span class="ident" id="3649133">Errorf</span><span class="op" id="3649139">(</span><span class="string" id="3649140">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3649184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649189">t</span><span class="op" id="3649190">.</span><span class="ident" id="3649191">ContentLength</span><span class="op" id="3649204">,</span>&nbsp;<span class="ident" id="3649206">ncopy</span><span class="op" id="3649211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649218">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649267">if</span>&nbsp;<span class="ident" id="3649270">chunked</span><span class="op" id="3649277">(</span><span class="ident" id="3649278">t</span><span class="op" id="3649279">.</span><span class="ident" id="3649280">TransferEncoding</span><span class="op" id="3649296">)</span>&nbsp;<span class="op" id="3649298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649302">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649328">if</span>&nbsp;<span class="ident" id="3649331">t</span><span class="op" id="3649332">.</span><span class="ident" id="3649333">Trailer</span>&nbsp;<span class="op" id="3649341">!=</span>&nbsp;<span class="ident" id="3649344">nil</span>&nbsp;<span class="op" id="3649348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649353">if</span>&nbsp;<span class="ident" id="3649356">err</span>&nbsp;<span class="op" id="3649360">:=</span>&nbsp;<span class="ident" id="3649363">t</span><span class="op" id="3649364">.</span><span class="ident" id="3649365">Trailer</span><span class="op" id="3649372">.</span><span class="ident" id="3649373">Write</span><span class="op" id="3649378">(</span><span class="ident" id="3649379">w</span><span class="op" id="3649380">)</span><span class="op" id="3649381">;</span>&nbsp;<span class="ident" id="3649383">err</span>&nbsp;<span class="op" id="3649387">!=</span>&nbsp;<span class="ident" id="3649390">nil</span>&nbsp;<span class="op" id="3649394">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649400">return</span>&nbsp;<span class="ident" id="3649407">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649422">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649453">_</span><span class="op" id="3649454">,</span>&nbsp;<span class="ident" id="3649456">err</span>&nbsp;<span class="op" id="3649460">=</span>&nbsp;<span class="ident" id="3649462">io</span><span class="op" id="3649464">.</span><span class="ident" id="3649465">WriteString</span><span class="op" id="3649476">(</span><span class="ident" id="3649477">w</span><span class="op" id="3649478">,</span>&nbsp;<span class="string" id="3649480">&#34;\r\n&#34;</span><span class="op" id="3649486">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3649489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649492">return</span>&nbsp;<span class="ident" id="3649499">err</span><br>
<span class="lineno"></span><span class="op" id="3649503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3649506">type</span>&nbsp;<span class="ident" id="3649511">transferReader</span>&nbsp;<span class="keyword" id="3649526">struct</span>&nbsp;<span class="op" id="3649533">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649536">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649546">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649560">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649568">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3649582">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649587">RequestMethod</span>&nbsp;<span class="builtintype" id="3649601">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649609">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3649623">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649628">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3649642">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3649647">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649658">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649675">io</span><span class="op" id="3649677">.</span><span class="ident" id="3649678">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649690">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649707">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649714">TransferEncoding</span>&nbsp;<span class="op" id="3649731">[</span><span class="op" id="3649732">]</span><span class="builtintype" id="3649733">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649741">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3649758">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3649764">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649781">Header</span><br>
<span class="lineno"></span><span class="op" id="3649788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3649791">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3649860">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3649906">func</span>&nbsp;<span class="ident" id="3649911">bodyAllowedForStatus</span><span class="op" id="3649931">(</span><span class="ident" id="3649932">status</span>&nbsp;<span class="builtintype" id="3649939">int</span><span class="op" id="3649942">)</span>&nbsp;<span class="builtintype" id="3649944">bool</span>&nbsp;<span class="op" id="3649949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649952">switch</span>&nbsp;<span class="op" id="3649959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3649962">case</span>&nbsp;<span class="ident" id="3649967">status</span>&nbsp;<span class="op" id="3649974">&gt;=</span>&nbsp;<span class="num" id="3649977">100</span>&nbsp;<span class="op" id="3649981">&amp;&amp;</span>&nbsp;<span class="ident" id="3649984">status</span>&nbsp;<span class="op" id="3649991">&lt;=</span>&nbsp;<span class="num" id="3649994">199</span><span class="op" id="3649997">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650001">return</span>&nbsp;<span class="ident" id="3650008">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650015">case</span>&nbsp;<span class="ident" id="3650020">status</span>&nbsp;<span class="op" id="3650027">==</span>&nbsp;<span class="num" id="3650030">204</span><span class="op" id="3650033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650037">return</span>&nbsp;<span class="ident" id="3650044">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650051">case</span>&nbsp;<span class="ident" id="3650056">status</span>&nbsp;<span class="op" id="3650063">==</span>&nbsp;<span class="num" id="3650066">304</span><span class="op" id="3650069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650073">return</span>&nbsp;<span class="ident" id="3650080">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3650087">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650090">return</span>&nbsp;<span class="ident" id="3650097">true</span><br>
<span class="lineno"></span><span class="op" id="3650102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3650105">var</span>&nbsp;<span class="op" id="3650109">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650112">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650136">=</span>&nbsp;<span class="op" id="3650138">[</span><span class="op" id="3650139">]</span><span class="builtintype" id="3650140">string</span><span class="op" id="3650146">{</span><span class="string" id="3650147">&#34;Content-Type&#34;</span><span class="op" id="3650161">,</span>&nbsp;<span class="string" id="3650163">&#34;Content-Length&#34;</span><span class="op" id="3650179">,</span>&nbsp;<span class="string" id="3650181">&#34;Transfer-Encoding&#34;</span><span class="op" id="3650200">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650203">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3650227">=</span>&nbsp;<span class="op" id="3650229">[</span><span class="op" id="3650230">]</span><span class="builtintype" id="3650231">string</span><span class="op" id="3650237">{</span><span class="string" id="3650238">&#34;Content-Length&#34;</span><span class="op" id="3650254">,</span>&nbsp;<span class="string" id="3650256">&#34;Transfer-Encoding&#34;</span><span class="op" id="3650275">}</span><br>
<span class="lineno"></span><span class="op" id="3650277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3650280">func</span>&nbsp;<span class="ident" id="3650285">suppressedHeaders</span><span class="op" id="3650302">(</span><span class="ident" id="3650303">status</span>&nbsp;<span class="builtintype" id="3650310">int</span><span class="op" id="3650313">)</span>&nbsp;<span class="op" id="3650315">[</span><span class="op" id="3650316">]</span><span class="builtintype" id="3650317">string</span>&nbsp;<span class="op" id="3650324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650327">switch</span>&nbsp;<span class="op" id="3650334">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650337">case</span>&nbsp;<span class="ident" id="3650342">status</span>&nbsp;<span class="op" id="3650349">==</span>&nbsp;<span class="num" id="3650352">304</span><span class="op" id="3650355">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3650359">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650442">return</span>&nbsp;<span class="ident" id="3650449">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650471">case</span>&nbsp;<span class="op" id="3650476">!</span><span class="ident" id="3650477">bodyAllowedForStatus</span><span class="op" id="3650497">(</span><span class="ident" id="3650498">status</span><span class="op" id="3650504">)</span><span class="op" id="3650505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650509">return</span>&nbsp;<span class="ident" id="3650516">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3650541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650544">return</span>&nbsp;<span class="ident" id="3650551">nil</span><br>
<span class="lineno"></span><span class="op" id="3650555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3650558">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3650591">func</span>&nbsp;<span class="ident" id="3650596">readTransfer</span><span class="op" id="3650608">(</span><span class="ident" id="3650609">msg</span>&nbsp;<span class="keyword" id="3650613">interface</span><span class="op" id="3650622">{</span><span class="op" id="3650623">}</span><span class="op" id="3650624">,</span>&nbsp;<span class="ident" id="3650626">r</span>&nbsp;<span class="op" id="3650628">*</span><span class="ident" id="3650629">bufio</span><span class="op" id="3650634">.</span><span class="ident" id="3650635">Reader</span><span class="op" id="3650641">)</span>&nbsp;<span class="op" id="3650643">(</span><span class="ident" id="3650644">err</span>&nbsp;<span class="builtintype" id="3650648">error</span><span class="op" id="3650653">)</span>&nbsp;<span class="op" id="3650655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650658">t</span>&nbsp;<span class="op" id="3650660">:=</span>&nbsp;<span class="op" id="3650663">&amp;</span><span class="ident" id="3650664">transferReader</span><span class="op" id="3650678">{</span><span class="ident" id="3650679">RequestMethod</span><span class="op" id="3650692">:</span>&nbsp;<span class="string" id="3650694">&#34;GET&#34;</span><span class="op" id="3650699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3650703">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650719">isResponse</span>&nbsp;<span class="op" id="3650730">:=</span>&nbsp;<span class="ident" id="3650733">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650740">switch</span>&nbsp;<span class="ident" id="3650747">rr</span>&nbsp;<span class="op" id="3650750">:=</span>&nbsp;<span class="ident" id="3650753">msg</span><span class="op" id="3650756">.</span><span class="op" id="3650757">(</span><span class="keyword" id="3650758">type</span><span class="op" id="3650762">)</span>&nbsp;<span class="op" id="3650764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650767">case</span>&nbsp;<span class="op" id="3650772">*</span><span class="ident" id="3650773">Response</span><span class="op" id="3650781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650785">t</span><span class="op" id="3650786">.</span><span class="ident" id="3650787">Header</span>&nbsp;<span class="op" id="3650794">=</span>&nbsp;<span class="ident" id="3650796">rr</span><span class="op" id="3650798">.</span><span class="ident" id="3650799">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650808">t</span><span class="op" id="3650809">.</span><span class="ident" id="3650810">StatusCode</span>&nbsp;<span class="op" id="3650821">=</span>&nbsp;<span class="ident" id="3650823">rr</span><span class="op" id="3650825">.</span><span class="ident" id="3650826">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650839">t</span><span class="op" id="3650840">.</span><span class="ident" id="3650841">ProtoMajor</span>&nbsp;<span class="op" id="3650852">=</span>&nbsp;<span class="ident" id="3650854">rr</span><span class="op" id="3650856">.</span><span class="ident" id="3650857">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650870">t</span><span class="op" id="3650871">.</span><span class="ident" id="3650872">ProtoMinor</span>&nbsp;<span class="op" id="3650883">=</span>&nbsp;<span class="ident" id="3650885">rr</span><span class="op" id="3650887">.</span><span class="ident" id="3650888">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650901">t</span><span class="op" id="3650902">.</span><span class="ident" id="3650903">Close</span>&nbsp;<span class="op" id="3650909">=</span>&nbsp;<span class="ident" id="3650911">shouldClose</span><span class="op" id="3650922">(</span><span class="ident" id="3650923">t</span><span class="op" id="3650924">.</span><span class="ident" id="3650925">ProtoMajor</span><span class="op" id="3650935">,</span>&nbsp;<span class="ident" id="3650937">t</span><span class="op" id="3650938">.</span><span class="ident" id="3650939">ProtoMinor</span><span class="op" id="3650949">,</span>&nbsp;<span class="ident" id="3650951">t</span><span class="op" id="3650952">.</span><span class="ident" id="3650953">Header</span><span class="op" id="3650959">,</span>&nbsp;<span class="ident" id="3650961">true</span><span class="op" id="3650965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3650969">isResponse</span>&nbsp;<span class="op" id="3650980">=</span>&nbsp;<span class="ident" id="3650982">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3650989">if</span>&nbsp;<span class="ident" id="3650992">rr</span><span class="op" id="3650994">.</span><span class="ident" id="3650995">Request</span>&nbsp;<span class="op" id="3651003">!=</span>&nbsp;<span class="ident" id="3651006">nil</span>&nbsp;<span class="op" id="3651010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651015">t</span><span class="op" id="3651016">.</span><span class="ident" id="3651017">RequestMethod</span>&nbsp;<span class="op" id="3651031">=</span>&nbsp;<span class="ident" id="3651033">rr</span><span class="op" id="3651035">.</span><span class="ident" id="3651036">Request</span><span class="op" id="3651043">.</span><span class="ident" id="3651044">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651056">case</span>&nbsp;<span class="op" id="3651061">*</span><span class="ident" id="3651062">Request</span><span class="op" id="3651069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651073">t</span><span class="op" id="3651074">.</span><span class="ident" id="3651075">Header</span>&nbsp;<span class="op" id="3651082">=</span>&nbsp;<span class="ident" id="3651084">rr</span><span class="op" id="3651086">.</span><span class="ident" id="3651087">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651096">t</span><span class="op" id="3651097">.</span><span class="ident" id="3651098">ProtoMajor</span>&nbsp;<span class="op" id="3651109">=</span>&nbsp;<span class="ident" id="3651111">rr</span><span class="op" id="3651113">.</span><span class="ident" id="3651114">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651127">t</span><span class="op" id="3651128">.</span><span class="ident" id="3651129">ProtoMinor</span>&nbsp;<span class="op" id="3651140">=</span>&nbsp;<span class="ident" id="3651142">rr</span><span class="op" id="3651144">.</span><span class="ident" id="3651145">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651158">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651222">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651286">t</span><span class="op" id="3651287">.</span><span class="ident" id="3651288">StatusCode</span>&nbsp;<span class="op" id="3651299">=</span>&nbsp;<span class="num" id="3651301">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651306">default</span><span class="op" id="3651313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3651317">panic</span><span class="op" id="3651322">(</span><span class="string" id="3651323">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3651340">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651347">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651371">if</span>&nbsp;<span class="ident" id="3651374">t</span><span class="op" id="3651375">.</span><span class="ident" id="3651376">ProtoMajor</span>&nbsp;<span class="op" id="3651387">==</span>&nbsp;<span class="num" id="3651390">0</span>&nbsp;<span class="op" id="3651392">&amp;&amp;</span>&nbsp;<span class="ident" id="3651395">t</span><span class="op" id="3651396">.</span><span class="ident" id="3651397">ProtoMinor</span>&nbsp;<span class="op" id="3651408">==</span>&nbsp;<span class="num" id="3651411">0</span>&nbsp;<span class="op" id="3651413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651417">t</span><span class="op" id="3651418">.</span><span class="ident" id="3651419">ProtoMajor</span><span class="op" id="3651429">,</span>&nbsp;<span class="ident" id="3651431">t</span><span class="op" id="3651432">.</span><span class="ident" id="3651433">ProtoMinor</span>&nbsp;<span class="op" id="3651444">=</span>&nbsp;<span class="num" id="3651446">1</span><span class="op" id="3651447">,</span>&nbsp;<span class="num" id="3651449">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651456">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651494">t</span><span class="op" id="3651495">.</span><span class="ident" id="3651496">TransferEncoding</span><span class="op" id="3651512">,</span>&nbsp;<span class="ident" id="3651514">err</span>&nbsp;<span class="op" id="3651518">=</span>&nbsp;<span class="ident" id="3651520">fixTransferEncoding</span><span class="op" id="3651539">(</span><span class="ident" id="3651540">t</span><span class="op" id="3651541">.</span><span class="ident" id="3651542">RequestMethod</span><span class="op" id="3651555">,</span>&nbsp;<span class="ident" id="3651557">t</span><span class="op" id="3651558">.</span><span class="ident" id="3651559">Header</span><span class="op" id="3651565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651568">if</span>&nbsp;<span class="ident" id="3651571">err</span>&nbsp;<span class="op" id="3651575">!=</span>&nbsp;<span class="ident" id="3651578">nil</span>&nbsp;<span class="op" id="3651582">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651586">return</span>&nbsp;<span class="ident" id="3651593">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651602">realLength</span><span class="op" id="3651612">,</span>&nbsp;<span class="ident" id="3651614">err</span>&nbsp;<span class="op" id="3651618">:=</span>&nbsp;<span class="ident" id="3651621">fixLength</span><span class="op" id="3651630">(</span><span class="ident" id="3651631">isResponse</span><span class="op" id="3651641">,</span>&nbsp;<span class="ident" id="3651643">t</span><span class="op" id="3651644">.</span><span class="ident" id="3651645">StatusCode</span><span class="op" id="3651655">,</span>&nbsp;<span class="ident" id="3651657">t</span><span class="op" id="3651658">.</span><span class="ident" id="3651659">RequestMethod</span><span class="op" id="3651672">,</span>&nbsp;<span class="ident" id="3651674">t</span><span class="op" id="3651675">.</span><span class="ident" id="3651676">Header</span><span class="op" id="3651682">,</span>&nbsp;<span class="ident" id="3651684">t</span><span class="op" id="3651685">.</span><span class="ident" id="3651686">TransferEncoding</span><span class="op" id="3651702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651705">if</span>&nbsp;<span class="ident" id="3651708">err</span>&nbsp;<span class="op" id="3651712">!=</span>&nbsp;<span class="ident" id="3651715">nil</span>&nbsp;<span class="op" id="3651719">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651723">return</span>&nbsp;<span class="ident" id="3651730">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651738">if</span>&nbsp;<span class="ident" id="3651741">isResponse</span>&nbsp;<span class="op" id="3651752">&amp;&amp;</span>&nbsp;<span class="ident" id="3651755">t</span><span class="op" id="3651756">.</span><span class="ident" id="3651757">RequestMethod</span>&nbsp;<span class="op" id="3651771">==</span>&nbsp;<span class="string" id="3651774">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3651781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651785">if</span>&nbsp;<span class="ident" id="3651788">n</span><span class="op" id="3651789">,</span>&nbsp;<span class="ident" id="3651791">err</span>&nbsp;<span class="op" id="3651795">:=</span>&nbsp;<span class="ident" id="3651798">parseContentLength</span><span class="op" id="3651816">(</span><span class="ident" id="3651817">t</span><span class="op" id="3651818">.</span><span class="ident" id="3651819">Header</span><span class="op" id="3651825">.</span><span class="ident" id="3651826">get</span><span class="op" id="3651829">(</span><span class="string" id="3651830">&#34;Content-Length&#34;</span><span class="op" id="3651846">)</span><span class="op" id="3651847">)</span><span class="op" id="3651848">;</span>&nbsp;<span class="ident" id="3651850">err</span>&nbsp;<span class="op" id="3651854">!=</span>&nbsp;<span class="ident" id="3651857">nil</span>&nbsp;<span class="op" id="3651861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3651866">return</span>&nbsp;<span class="ident" id="3651873">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651879">}</span>&nbsp;<span class="keyword" id="3651881">else</span>&nbsp;<span class="op" id="3651886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651891">t</span><span class="op" id="3651892">.</span><span class="ident" id="3651893">ContentLength</span>&nbsp;<span class="op" id="3651907">=</span>&nbsp;<span class="ident" id="3651909">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651916">}</span>&nbsp;<span class="keyword" id="3651918">else</span>&nbsp;<span class="op" id="3651923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651927">t</span><span class="op" id="3651928">.</span><span class="ident" id="3651929">ContentLength</span>&nbsp;<span class="op" id="3651943">=</span>&nbsp;<span class="ident" id="3651945">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3651957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3651961">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3651973">t</span><span class="op" id="3651974">.</span><span class="ident" id="3651975">Trailer</span><span class="op" id="3651982">,</span>&nbsp;<span class="ident" id="3651984">err</span>&nbsp;<span class="op" id="3651988">=</span>&nbsp;<span class="ident" id="3651990">fixTrailer</span><span class="op" id="3652000">(</span><span class="ident" id="3652001">t</span><span class="op" id="3652002">.</span><span class="ident" id="3652003">Header</span><span class="op" id="3652009">,</span>&nbsp;<span class="ident" id="3652011">t</span><span class="op" id="3652012">.</span><span class="ident" id="3652013">TransferEncoding</span><span class="op" id="3652029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652032">if</span>&nbsp;<span class="ident" id="3652035">err</span>&nbsp;<span class="op" id="3652039">!=</span>&nbsp;<span class="ident" id="3652042">nil</span>&nbsp;<span class="op" id="3652046">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652050">return</span>&nbsp;<span class="ident" id="3652057">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652066">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652144">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652215">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652245">switch</span>&nbsp;<span class="ident" id="3652252">msg</span><span class="op" id="3652255">.</span><span class="op" id="3652256">(</span><span class="keyword" id="3652257">type</span><span class="op" id="3652261">)</span>&nbsp;<span class="op" id="3652263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652266">case</span>&nbsp;<span class="op" id="3652271">*</span><span class="ident" id="3652272">Response</span><span class="op" id="3652280">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652284">if</span>&nbsp;<span class="ident" id="3652287">realLength</span>&nbsp;<span class="op" id="3652298">==</span>&nbsp;<span class="op" id="3652301">-</span><span class="num" id="3652302">1</span>&nbsp;<span class="op" id="3652304">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652310">!</span><span class="ident" id="3652311">chunked</span><span class="op" id="3652318">(</span><span class="ident" id="3652319">t</span><span class="op" id="3652320">.</span><span class="ident" id="3652321">TransferEncoding</span><span class="op" id="3652337">)</span>&nbsp;<span class="op" id="3652339">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652345">bodyAllowedForStatus</span><span class="op" id="3652365">(</span><span class="ident" id="3652366">t</span><span class="op" id="3652367">.</span><span class="ident" id="3652368">StatusCode</span><span class="op" id="3652378">)</span>&nbsp;<span class="op" id="3652380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652385">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652407">t</span><span class="op" id="3652408">.</span><span class="ident" id="3652409">Close</span>&nbsp;<span class="op" id="3652415">=</span>&nbsp;<span class="ident" id="3652417">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652427">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652431">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652498">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652574">switch</span>&nbsp;<span class="op" id="3652581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652584">case</span>&nbsp;<span class="ident" id="3652589">chunked</span><span class="op" id="3652596">(</span><span class="ident" id="3652597">t</span><span class="op" id="3652598">.</span><span class="ident" id="3652599">TransferEncoding</span><span class="op" id="3652615">)</span><span class="op" id="3652616">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652620">if</span>&nbsp;<span class="ident" id="3652623">noBodyExpected</span><span class="op" id="3652637">(</span><span class="ident" id="3652638">t</span><span class="op" id="3652639">.</span><span class="ident" id="3652640">RequestMethod</span><span class="op" id="3652653">)</span>&nbsp;<span class="op" id="3652655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652660">t</span><span class="op" id="3652661">.</span><span class="ident" id="3652662">Body</span>&nbsp;<span class="op" id="3652667">=</span>&nbsp;<span class="ident" id="3652669">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652681">}</span>&nbsp;<span class="keyword" id="3652683">else</span>&nbsp;<span class="op" id="3652688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652693">t</span><span class="op" id="3652694">.</span><span class="ident" id="3652695">Body</span>&nbsp;<span class="op" id="3652700">=</span>&nbsp;<span class="op" id="3652702">&amp;</span><span class="ident" id="3652703">body</span><span class="op" id="3652707">{</span><span class="ident" id="3652708">src</span><span class="op" id="3652711">:</span>&nbsp;<span class="ident" id="3652713">internal</span><span class="op" id="3652721">.</span><span class="ident" id="3652722">NewChunkedReader</span><span class="op" id="3652738">(</span><span class="ident" id="3652739">r</span><span class="op" id="3652740">)</span><span class="op" id="3652741">,</span>&nbsp;<span class="ident" id="3652743">hdr</span><span class="op" id="3652746">:</span>&nbsp;<span class="ident" id="3652748">msg</span><span class="op" id="3652751">,</span>&nbsp;<span class="ident" id="3652753">r</span><span class="op" id="3652754">:</span>&nbsp;<span class="ident" id="3652756">r</span><span class="op" id="3652757">,</span>&nbsp;<span class="ident" id="3652759">closing</span><span class="op" id="3652766">:</span>&nbsp;<span class="ident" id="3652768">t</span><span class="op" id="3652769">.</span><span class="ident" id="3652770">Close</span><span class="op" id="3652775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3652779">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652782">case</span>&nbsp;<span class="ident" id="3652787">realLength</span>&nbsp;<span class="op" id="3652798">==</span>&nbsp;<span class="num" id="3652801">0</span><span class="op" id="3652802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652806">t</span><span class="op" id="3652807">.</span><span class="ident" id="3652808">Body</span>&nbsp;<span class="op" id="3652813">=</span>&nbsp;<span class="ident" id="3652815">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652826">case</span>&nbsp;<span class="ident" id="3652831">realLength</span>&nbsp;<span class="op" id="3652842">&gt;</span>&nbsp;<span class="num" id="3652844">0</span><span class="op" id="3652845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3652849">t</span><span class="op" id="3652850">.</span><span class="ident" id="3652851">Body</span>&nbsp;<span class="op" id="3652856">=</span>&nbsp;<span class="op" id="3652858">&amp;</span><span class="ident" id="3652859">body</span><span class="op" id="3652863">{</span><span class="ident" id="3652864">src</span><span class="op" id="3652867">:</span>&nbsp;<span class="ident" id="3652869">io</span><span class="op" id="3652871">.</span><span class="ident" id="3652872">LimitReader</span><span class="op" id="3652883">(</span><span class="ident" id="3652884">r</span><span class="op" id="3652885">,</span>&nbsp;<span class="ident" id="3652887">realLength</span><span class="op" id="3652897">)</span><span class="op" id="3652898">,</span>&nbsp;<span class="ident" id="3652900">closing</span><span class="op" id="3652907">:</span>&nbsp;<span class="ident" id="3652909">t</span><span class="op" id="3652910">.</span><span class="ident" id="3652911">Close</span><span class="op" id="3652916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652919">default</span><span class="op" id="3652926">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3652930">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3652997">if</span>&nbsp;<span class="ident" id="3653000">t</span><span class="op" id="3653001">.</span><span class="ident" id="3653002">Close</span>&nbsp;<span class="op" id="3653008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653013">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653051">t</span><span class="op" id="3653052">.</span><span class="ident" id="3653053">Body</span>&nbsp;<span class="op" id="3653058">=</span>&nbsp;<span class="op" id="3653060">&amp;</span><span class="ident" id="3653061">body</span><span class="op" id="3653065">{</span><span class="ident" id="3653066">src</span><span class="op" id="3653069">:</span>&nbsp;<span class="ident" id="3653071">r</span><span class="op" id="3653072">,</span>&nbsp;<span class="ident" id="3653074">closing</span><span class="op" id="3653081">:</span>&nbsp;<span class="ident" id="3653083">t</span><span class="op" id="3653084">.</span><span class="ident" id="3653085">Close</span><span class="op" id="3653090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653094">}</span>&nbsp;<span class="keyword" id="3653096">else</span>&nbsp;<span class="op" id="3653101">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653106">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653150">t</span><span class="op" id="3653151">.</span><span class="ident" id="3653152">Body</span>&nbsp;<span class="op" id="3653157">=</span>&nbsp;<span class="ident" id="3653159">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3653178">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653195">switch</span>&nbsp;<span class="ident" id="3653202">rr</span>&nbsp;<span class="op" id="3653205">:=</span>&nbsp;<span class="ident" id="3653208">msg</span><span class="op" id="3653211">.</span><span class="op" id="3653212">(</span><span class="keyword" id="3653213">type</span><span class="op" id="3653217">)</span>&nbsp;<span class="op" id="3653219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653222">case</span>&nbsp;<span class="op" id="3653227">*</span><span class="ident" id="3653228">Request</span><span class="op" id="3653235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653239">rr</span><span class="op" id="3653241">.</span><span class="ident" id="3653242">Body</span>&nbsp;<span class="op" id="3653247">=</span>&nbsp;<span class="ident" id="3653249">t</span><span class="op" id="3653250">.</span><span class="ident" id="3653251">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653258">rr</span><span class="op" id="3653260">.</span><span class="ident" id="3653261">ContentLength</span>&nbsp;<span class="op" id="3653275">=</span>&nbsp;<span class="ident" id="3653277">t</span><span class="op" id="3653278">.</span><span class="ident" id="3653279">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653295">rr</span><span class="op" id="3653297">.</span><span class="ident" id="3653298">TransferEncoding</span>&nbsp;<span class="op" id="3653315">=</span>&nbsp;<span class="ident" id="3653317">t</span><span class="op" id="3653318">.</span><span class="ident" id="3653319">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653338">rr</span><span class="op" id="3653340">.</span><span class="ident" id="3653341">Close</span>&nbsp;<span class="op" id="3653347">=</span>&nbsp;<span class="ident" id="3653349">t</span><span class="op" id="3653350">.</span><span class="ident" id="3653351">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653359">rr</span><span class="op" id="3653361">.</span><span class="ident" id="3653362">Trailer</span>&nbsp;<span class="op" id="3653370">=</span>&nbsp;<span class="ident" id="3653372">t</span><span class="op" id="3653373">.</span><span class="ident" id="3653374">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653383">case</span>&nbsp;<span class="op" id="3653388">*</span><span class="ident" id="3653389">Response</span><span class="op" id="3653397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653401">rr</span><span class="op" id="3653403">.</span><span class="ident" id="3653404">Body</span>&nbsp;<span class="op" id="3653409">=</span>&nbsp;<span class="ident" id="3653411">t</span><span class="op" id="3653412">.</span><span class="ident" id="3653413">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653420">rr</span><span class="op" id="3653422">.</span><span class="ident" id="3653423">ContentLength</span>&nbsp;<span class="op" id="3653437">=</span>&nbsp;<span class="ident" id="3653439">t</span><span class="op" id="3653440">.</span><span class="ident" id="3653441">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653457">rr</span><span class="op" id="3653459">.</span><span class="ident" id="3653460">TransferEncoding</span>&nbsp;<span class="op" id="3653477">=</span>&nbsp;<span class="ident" id="3653479">t</span><span class="op" id="3653480">.</span><span class="ident" id="3653481">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653500">rr</span><span class="op" id="3653502">.</span><span class="ident" id="3653503">Close</span>&nbsp;<span class="op" id="3653509">=</span>&nbsp;<span class="ident" id="3653511">t</span><span class="op" id="3653512">.</span><span class="ident" id="3653513">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653521">rr</span><span class="op" id="3653523">.</span><span class="ident" id="3653524">Trailer</span>&nbsp;<span class="op" id="3653532">=</span>&nbsp;<span class="ident" id="3653534">t</span><span class="op" id="3653535">.</span><span class="ident" id="3653536">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3653545">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653549">return</span>&nbsp;<span class="ident" id="3653556">nil</span><br>
<span class="lineno"></span><span class="op" id="3653560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3653563">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3653620">func</span>&nbsp;<span class="ident" id="3653625">chunked</span><span class="op" id="3653632">(</span><span class="ident" id="3653633">te</span>&nbsp;<span class="op" id="3653636">[</span><span class="op" id="3653637">]</span><span class="builtintype" id="3653638">string</span><span class="op" id="3653644">)</span>&nbsp;<span class="builtintype" id="3653646">bool</span>&nbsp;<span class="op" id="3653651">{</span>&nbsp;<span class="keyword" id="3653653">return</span>&nbsp;<span class="builtinfunc" id="3653660">len</span><span class="op" id="3653663">(</span><span class="ident" id="3653664">te</span><span class="op" id="3653666">)</span>&nbsp;<span class="op" id="3653668">&gt;</span>&nbsp;<span class="num" id="3653670">0</span>&nbsp;<span class="op" id="3653672">&amp;&amp;</span>&nbsp;<span class="ident" id="3653675">te</span><span class="op" id="3653677">[</span><span class="num" id="3653678">0</span><span class="op" id="3653679">]</span>&nbsp;<span class="op" id="3653681">==</span>&nbsp;<span class="string" id="3653684">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3653694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3653697">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3653754">func</span>&nbsp;<span class="ident" id="3653759">isIdentity</span><span class="op" id="3653769">(</span><span class="ident" id="3653770">te</span>&nbsp;<span class="op" id="3653773">[</span><span class="op" id="3653774">]</span><span class="builtintype" id="3653775">string</span><span class="op" id="3653781">)</span>&nbsp;<span class="builtintype" id="3653783">bool</span>&nbsp;<span class="op" id="3653788">{</span>&nbsp;<span class="keyword" id="3653790">return</span>&nbsp;<span class="builtinfunc" id="3653797">len</span><span class="op" id="3653800">(</span><span class="ident" id="3653801">te</span><span class="op" id="3653803">)</span>&nbsp;<span class="op" id="3653805">==</span>&nbsp;<span class="num" id="3653808">1</span>&nbsp;<span class="op" id="3653810">&amp;&amp;</span>&nbsp;<span class="ident" id="3653813">te</span><span class="op" id="3653815">[</span><span class="num" id="3653816">0</span><span class="op" id="3653817">]</span>&nbsp;<span class="op" id="3653819">==</span>&nbsp;<span class="string" id="3653822">&#34;identity&#34;</span>&nbsp;<span class="op" id="3653833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3653836">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3653866">func</span>&nbsp;<span class="ident" id="3653871">fixTransferEncoding</span><span class="op" id="3653890">(</span><span class="ident" id="3653891">requestMethod</span>&nbsp;<span class="builtintype" id="3653905">string</span><span class="op" id="3653911">,</span>&nbsp;<span class="ident" id="3653913">header</span>&nbsp;<span class="ident" id="3653920">Header</span><span class="op" id="3653926">)</span>&nbsp;<span class="op" id="3653928">(</span><span class="op" id="3653929">[</span><span class="op" id="3653930">]</span><span class="builtintype" id="3653931">string</span><span class="op" id="3653937">,</span>&nbsp;<span class="builtintype" id="3653939">error</span><span class="op" id="3653944">)</span>&nbsp;<span class="op" id="3653946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3653949">raw</span><span class="op" id="3653952">,</span>&nbsp;<span class="ident" id="3653954">present</span>&nbsp;<span class="op" id="3653962">:=</span>&nbsp;<span class="ident" id="3653965">header</span><span class="op" id="3653971">[</span><span class="string" id="3653972">&#34;Transfer-Encoding&#34;</span><span class="op" id="3653991">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3653994">if</span>&nbsp;<span class="op" id="3653997">!</span><span class="ident" id="3653998">present</span>&nbsp;<span class="op" id="3654006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654010">return</span>&nbsp;<span class="ident" id="3654017">nil</span><span class="op" id="3654020">,</span>&nbsp;<span class="ident" id="3654022">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3654031">delete</span><span class="op" id="3654037">(</span><span class="ident" id="3654038">header</span><span class="op" id="3654044">,</span>&nbsp;<span class="string" id="3654046">&#34;Transfer-Encoding&#34;</span><span class="op" id="3654065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654069">encodings</span>&nbsp;<span class="op" id="3654079">:=</span>&nbsp;<span class="ident" id="3654082">strings</span><span class="op" id="3654089">.</span><span class="ident" id="3654090">Split</span><span class="op" id="3654095">(</span><span class="ident" id="3654096">raw</span><span class="op" id="3654099">[</span><span class="num" id="3654100">0</span><span class="op" id="3654101">]</span><span class="op" id="3654102">,</span>&nbsp;<span class="string" id="3654104">&#34;,&#34;</span><span class="op" id="3654107">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654110">te</span>&nbsp;<span class="op" id="3654113">:=</span>&nbsp;<span class="builtinfunc" id="3654116">make</span><span class="op" id="3654120">(</span><span class="op" id="3654121">[</span><span class="op" id="3654122">]</span><span class="builtintype" id="3654123">string</span><span class="op" id="3654129">,</span>&nbsp;<span class="num" id="3654131">0</span><span class="op" id="3654132">,</span>&nbsp;<span class="builtinfunc" id="3654134">len</span><span class="op" id="3654137">(</span><span class="ident" id="3654138">encodings</span><span class="op" id="3654147">)</span><span class="op" id="3654148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654151">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654214">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654276">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654335">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654380">for</span>&nbsp;<span class="ident" id="3654384">_</span><span class="op" id="3654385">,</span>&nbsp;<span class="ident" id="3654387">encoding</span>&nbsp;<span class="op" id="3654396">:=</span>&nbsp;<span class="keyword" id="3654399">range</span>&nbsp;<span class="ident" id="3654405">encodings</span>&nbsp;<span class="op" id="3654415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654419">encoding</span>&nbsp;<span class="op" id="3654428">=</span>&nbsp;<span class="ident" id="3654430">strings</span><span class="op" id="3654437">.</span><span class="ident" id="3654438">ToLower</span><span class="op" id="3654445">(</span><span class="ident" id="3654446">strings</span><span class="op" id="3654453">.</span><span class="ident" id="3654454">TrimSpace</span><span class="op" id="3654463">(</span><span class="ident" id="3654464">encoding</span><span class="op" id="3654472">)</span><span class="op" id="3654473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654477">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654518">if</span>&nbsp;<span class="ident" id="3654521">encoding</span>&nbsp;<span class="op" id="3654530">==</span>&nbsp;<span class="string" id="3654533">&#34;identity&#34;</span>&nbsp;<span class="op" id="3654544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654549">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654561">if</span>&nbsp;<span class="ident" id="3654564">encoding</span>&nbsp;<span class="op" id="3654573">!=</span>&nbsp;<span class="string" id="3654576">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3654586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654591">return</span>&nbsp;<span class="ident" id="3654598">nil</span><span class="op" id="3654601">,</span>&nbsp;<span class="op" id="3654603">&amp;</span><span class="ident" id="3654604">badStringError</span><span class="op" id="3654618">{</span><span class="string" id="3654619">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3654650">,</span>&nbsp;<span class="ident" id="3654652">encoding</span><span class="op" id="3654660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654668">te</span>&nbsp;<span class="op" id="3654671">=</span>&nbsp;<span class="ident" id="3654673">te</span><span class="op" id="3654675">[</span><span class="num" id="3654676">0</span>&nbsp;<span class="op" id="3654678">:</span>&nbsp;<span class="builtinfunc" id="3654680">len</span><span class="op" id="3654683">(</span><span class="ident" id="3654684">te</span><span class="op" id="3654686">)</span><span class="op" id="3654687">+</span><span class="num" id="3654688">1</span><span class="op" id="3654689">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3654693">te</span><span class="op" id="3654695">[</span><span class="builtinfunc" id="3654696">len</span><span class="op" id="3654699">(</span><span class="ident" id="3654700">te</span><span class="op" id="3654702">)</span><span class="op" id="3654703">-</span><span class="num" id="3654704">1</span><span class="op" id="3654705">]</span>&nbsp;<span class="op" id="3654707">=</span>&nbsp;<span class="ident" id="3654709">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654722">if</span>&nbsp;<span class="builtinfunc" id="3654725">len</span><span class="op" id="3654728">(</span><span class="ident" id="3654729">te</span><span class="op" id="3654731">)</span>&nbsp;<span class="op" id="3654733">&gt;</span>&nbsp;<span class="num" id="3654735">1</span>&nbsp;<span class="op" id="3654737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654741">return</span>&nbsp;<span class="ident" id="3654748">nil</span><span class="op" id="3654751">,</span>&nbsp;<span class="op" id="3654753">&amp;</span><span class="ident" id="3654754">badStringError</span><span class="op" id="3654768">{</span><span class="string" id="3654769">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3654798">,</span>&nbsp;<span class="ident" id="3654800">strings</span><span class="op" id="3654807">.</span><span class="ident" id="3654808">Join</span><span class="op" id="3654812">(</span><span class="ident" id="3654813">te</span><span class="op" id="3654815">,</span>&nbsp;<span class="string" id="3654817">&#34;,&#34;</span><span class="op" id="3654820">)</span><span class="op" id="3654821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3654824">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3654827">if</span>&nbsp;<span class="builtinfunc" id="3654830">len</span><span class="op" id="3654833">(</span><span class="ident" id="3654834">te</span><span class="op" id="3654836">)</span>&nbsp;<span class="op" id="3654838">&gt;</span>&nbsp;<span class="num" id="3654840">0</span>&nbsp;<span class="op" id="3654842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654846">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654904">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3654960">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3654975">delete</span><span class="op" id="3654981">(</span><span class="ident" id="3654982">header</span><span class="op" id="3654988">,</span>&nbsp;<span class="string" id="3654990">&#34;Content-Length&#34;</span><span class="op" id="3655006">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655010">return</span>&nbsp;<span class="ident" id="3655017">te</span><span class="op" id="3655019">,</span>&nbsp;<span class="ident" id="3655021">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655030">return</span>&nbsp;<span class="ident" id="3655037">nil</span><span class="op" id="3655040">,</span>&nbsp;<span class="ident" id="3655042">nil</span><br>
<span class="lineno"></span><span class="op" id="3655046">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3655049">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3655121">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3655192">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3655225">func</span>&nbsp;<span class="ident" id="3655230">fixLength</span><span class="op" id="3655239">(</span><span class="ident" id="3655240">isResponse</span>&nbsp;<span class="builtintype" id="3655251">bool</span><span class="op" id="3655255">,</span>&nbsp;<span class="ident" id="3655257">status</span>&nbsp;<span class="builtintype" id="3655264">int</span><span class="op" id="3655267">,</span>&nbsp;<span class="ident" id="3655269">requestMethod</span>&nbsp;<span class="builtintype" id="3655283">string</span><span class="op" id="3655289">,</span>&nbsp;<span class="ident" id="3655291">header</span>&nbsp;<span class="ident" id="3655298">Header</span><span class="op" id="3655304">,</span>&nbsp;<span class="ident" id="3655306">te</span>&nbsp;<span class="op" id="3655309">[</span><span class="op" id="3655310">]</span><span class="builtintype" id="3655311">string</span><span class="op" id="3655317">)</span>&nbsp;<span class="op" id="3655319">(</span><span class="ident" id="3655320">int64</span><span class="op" id="3655325">,</span>&nbsp;<span class="builtintype" id="3655327">error</span><span class="op" id="3655332">)</span>&nbsp;<span class="op" id="3655334">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655338">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655381">if</span>&nbsp;<span class="ident" id="3655384">noBodyExpected</span><span class="op" id="3655398">(</span><span class="ident" id="3655399">requestMethod</span><span class="op" id="3655412">)</span>&nbsp;<span class="op" id="3655414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655418">return</span>&nbsp;<span class="num" id="3655425">0</span><span class="op" id="3655426">,</span>&nbsp;<span class="ident" id="3655428">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655433">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655436">if</span>&nbsp;<span class="ident" id="3655439">status</span><span class="op" id="3655445">/</span><span class="num" id="3655446">100</span>&nbsp;<span class="op" id="3655450">==</span>&nbsp;<span class="num" id="3655453">1</span>&nbsp;<span class="op" id="3655455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655459">return</span>&nbsp;<span class="num" id="3655466">0</span><span class="op" id="3655467">,</span>&nbsp;<span class="ident" id="3655469">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655477">switch</span>&nbsp;<span class="ident" id="3655484">status</span>&nbsp;<span class="op" id="3655491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655494">case</span>&nbsp;<span class="num" id="3655499">204</span><span class="op" id="3655502">,</span>&nbsp;<span class="num" id="3655504">304</span><span class="op" id="3655507">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655511">return</span>&nbsp;<span class="num" id="3655518">0</span><span class="op" id="3655519">,</span>&nbsp;<span class="ident" id="3655521">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655530">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655567">if</span>&nbsp;<span class="ident" id="3655570">chunked</span><span class="op" id="3655577">(</span><span class="ident" id="3655578">te</span><span class="op" id="3655580">)</span>&nbsp;<span class="op" id="3655582">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655586">return</span>&nbsp;<span class="op" id="3655593">-</span><span class="num" id="3655594">1</span><span class="op" id="3655595">,</span>&nbsp;<span class="ident" id="3655597">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655606">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655640">cl</span>&nbsp;<span class="op" id="3655643">:=</span>&nbsp;<span class="ident" id="3655646">strings</span><span class="op" id="3655653">.</span><span class="ident" id="3655654">TrimSpace</span><span class="op" id="3655663">(</span><span class="ident" id="3655664">header</span><span class="op" id="3655670">.</span><span class="ident" id="3655671">get</span><span class="op" id="3655674">(</span><span class="string" id="3655675">&#34;Content-Length&#34;</span><span class="op" id="3655691">)</span><span class="op" id="3655692">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655695">if</span>&nbsp;<span class="ident" id="3655698">cl</span>&nbsp;<span class="op" id="3655701">!=</span>&nbsp;<span class="string" id="3655704">&#34;&#34;</span>&nbsp;<span class="op" id="3655707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655711">n</span><span class="op" id="3655712">,</span>&nbsp;<span class="ident" id="3655714">err</span>&nbsp;<span class="op" id="3655718">:=</span>&nbsp;<span class="ident" id="3655721">parseContentLength</span><span class="op" id="3655739">(</span><span class="ident" id="3655740">cl</span><span class="op" id="3655742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655746">if</span>&nbsp;<span class="ident" id="3655749">err</span>&nbsp;<span class="op" id="3655753">!=</span>&nbsp;<span class="ident" id="3655756">nil</span>&nbsp;<span class="op" id="3655760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655765">return</span>&nbsp;<span class="op" id="3655772">-</span><span class="num" id="3655773">1</span><span class="op" id="3655774">,</span>&nbsp;<span class="ident" id="3655776">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655782">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655786">return</span>&nbsp;<span class="ident" id="3655793">n</span><span class="op" id="3655794">,</span>&nbsp;<span class="ident" id="3655796">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655801">}</span>&nbsp;<span class="keyword" id="3655803">else</span>&nbsp;<span class="op" id="3655808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3655812">header</span><span class="op" id="3655818">.</span><span class="ident" id="3655819">Del</span><span class="op" id="3655822">(</span><span class="string" id="3655823">&#34;Content-Length&#34;</span><span class="op" id="3655839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3655842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3655846">if</span>&nbsp;<span class="op" id="3655849">!</span><span class="ident" id="3655850">isResponse</span>&nbsp;<span class="op" id="3655861">&amp;&amp;</span>&nbsp;<span class="ident" id="3655864">requestMethod</span>&nbsp;<span class="op" id="3655878">==</span>&nbsp;<span class="string" id="3655881">&#34;GET&#34;</span>&nbsp;<span class="op" id="3655887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655891">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655945">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3655999">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656054">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656092">return</span>&nbsp;<span class="num" id="3656099">0</span><span class="op" id="3656100">,</span>&nbsp;<span class="ident" id="3656102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656111">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656187">return</span>&nbsp;<span class="op" id="3656194">-</span><span class="num" id="3656195">1</span><span class="op" id="3656196">,</span>&nbsp;<span class="ident" id="3656198">nil</span><br>
<span class="lineno">500</span><span class="op" id="3656202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3656205">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3656274">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3656307">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3656342">func</span>&nbsp;<span class="ident" id="3656347">shouldClose</span><span class="op" id="3656358">(</span><span class="ident" id="3656359">major</span><span class="op" id="3656364">,</span>&nbsp;<span class="ident" id="3656366">minor</span>&nbsp;<span class="builtintype" id="3656372">int</span><span class="op" id="3656375">,</span>&nbsp;<span class="ident" id="3656377">header</span>&nbsp;<span class="ident" id="3656384">Header</span><span class="op" id="3656390">,</span>&nbsp;<span class="ident" id="3656392">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3656410">bool</span><span class="op" id="3656414">)</span>&nbsp;<span class="builtintype" id="3656416">bool</span>&nbsp;<span class="op" id="3656421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656424">if</span>&nbsp;<span class="ident" id="3656427">major</span>&nbsp;<span class="op" id="3656433">&lt;</span>&nbsp;<span class="num" id="3656435">1</span>&nbsp;<span class="op" id="3656437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656441">return</span>&nbsp;<span class="ident" id="3656448">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656454">}</span>&nbsp;<span class="keyword" id="3656456">else</span>&nbsp;<span class="keyword" id="3656461">if</span>&nbsp;<span class="ident" id="3656464">major</span>&nbsp;<span class="op" id="3656470">==</span>&nbsp;<span class="num" id="3656473">1</span>&nbsp;<span class="op" id="3656475">&amp;&amp;</span>&nbsp;<span class="ident" id="3656478">minor</span>&nbsp;<span class="op" id="3656484">==</span>&nbsp;<span class="num" id="3656487">0</span>&nbsp;<span class="op" id="3656489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656493">if</span>&nbsp;<span class="op" id="3656496">!</span><span class="ident" id="3656497">strings</span><span class="op" id="3656504">.</span><span class="ident" id="3656505">Contains</span><span class="op" id="3656513">(</span><span class="ident" id="3656514">strings</span><span class="op" id="3656521">.</span><span class="ident" id="3656522">ToLower</span><span class="op" id="3656529">(</span><span class="ident" id="3656530">header</span><span class="op" id="3656536">.</span><span class="ident" id="3656537">get</span><span class="op" id="3656540">(</span><span class="string" id="3656541">&#34;Connection&#34;</span><span class="op" id="3656553">)</span><span class="op" id="3656554">)</span><span class="op" id="3656555">,</span>&nbsp;<span class="string" id="3656557">&#34;keep-alive&#34;</span><span class="op" id="3656569">)</span>&nbsp;<span class="op" id="3656571">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656576">return</span>&nbsp;<span class="ident" id="3656583">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656594">return</span>&nbsp;<span class="ident" id="3656601">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656608">}</span>&nbsp;<span class="keyword" id="3656610">else</span>&nbsp;<span class="op" id="3656615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656619">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3656684">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656711">if</span>&nbsp;<span class="ident" id="3656714">strings</span><span class="op" id="3656721">.</span><span class="ident" id="3656722">ToLower</span><span class="op" id="3656729">(</span><span class="ident" id="3656730">header</span><span class="op" id="3656736">.</span><span class="ident" id="3656737">get</span><span class="op" id="3656740">(</span><span class="string" id="3656741">&#34;Connection&#34;</span><span class="op" id="3656753">)</span><span class="op" id="3656754">)</span>&nbsp;<span class="op" id="3656756">==</span>&nbsp;<span class="string" id="3656759">&#34;close&#34;</span>&nbsp;<span class="op" id="3656767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656772">if</span>&nbsp;<span class="ident" id="3656775">removeCloseHeader</span>&nbsp;<span class="op" id="3656793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656799">header</span><span class="op" id="3656805">.</span><span class="ident" id="3656806">Del</span><span class="op" id="3656809">(</span><span class="string" id="3656810">&#34;Connection&#34;</span><span class="op" id="3656822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656827">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656832">return</span>&nbsp;<span class="ident" id="3656839">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3656849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656852">return</span>&nbsp;<span class="ident" id="3656859">false</span><br>
<span class="lineno"></span><span class="op" id="3656865">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3656868">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3656896">func</span>&nbsp;<span class="ident" id="3656901">fixTrailer</span><span class="op" id="3656911">(</span><span class="ident" id="3656912">header</span>&nbsp;<span class="ident" id="3656919">Header</span><span class="op" id="3656925">,</span>&nbsp;<span class="ident" id="3656927">te</span>&nbsp;<span class="op" id="3656930">[</span><span class="op" id="3656931">]</span><span class="builtintype" id="3656932">string</span><span class="op" id="3656938">)</span>&nbsp;<span class="op" id="3656940">(</span><span class="ident" id="3656941">Header</span><span class="op" id="3656947">,</span>&nbsp;<span class="builtintype" id="3656949">error</span><span class="op" id="3656954">)</span>&nbsp;<span class="op" id="3656956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3656959">raw</span>&nbsp;<span class="op" id="3656963">:=</span>&nbsp;<span class="ident" id="3656966">header</span><span class="op" id="3656972">.</span><span class="ident" id="3656973">get</span><span class="op" id="3656976">(</span><span class="string" id="3656977">&#34;Trailer&#34;</span><span class="op" id="3656986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3656989">if</span>&nbsp;<span class="ident" id="3656992">raw</span>&nbsp;<span class="op" id="3656996">==</span>&nbsp;<span class="string" id="3656999">&#34;&#34;</span>&nbsp;<span class="op" id="3657002">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657006">return</span>&nbsp;<span class="ident" id="3657013">nil</span><span class="op" id="3657016">,</span>&nbsp;<span class="ident" id="3657018">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657027">header</span><span class="op" id="3657033">.</span><span class="ident" id="3657034">Del</span><span class="op" id="3657037">(</span><span class="string" id="3657038">&#34;Trailer&#34;</span><span class="op" id="3657047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657050">trailer</span>&nbsp;<span class="op" id="3657058">:=</span>&nbsp;<span class="builtinfunc" id="3657061">make</span><span class="op" id="3657065">(</span><span class="ident" id="3657066">Header</span><span class="op" id="3657072">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657075">keys</span>&nbsp;<span class="op" id="3657080">:=</span>&nbsp;<span class="ident" id="3657083">strings</span><span class="op" id="3657090">.</span><span class="ident" id="3657091">Split</span><span class="op" id="3657096">(</span><span class="ident" id="3657097">raw</span><span class="op" id="3657100">,</span>&nbsp;<span class="string" id="3657102">&#34;,&#34;</span><span class="op" id="3657105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657108">for</span>&nbsp;<span class="ident" id="3657112">_</span><span class="op" id="3657113">,</span>&nbsp;<span class="ident" id="3657115">key</span>&nbsp;<span class="op" id="3657119">:=</span>&nbsp;<span class="keyword" id="3657122">range</span>&nbsp;<span class="ident" id="3657128">keys</span>&nbsp;<span class="op" id="3657133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657137">key</span>&nbsp;<span class="op" id="3657141">=</span>&nbsp;<span class="ident" id="3657143">CanonicalHeaderKey</span><span class="op" id="3657161">(</span><span class="ident" id="3657162">strings</span><span class="op" id="3657169">.</span><span class="ident" id="3657170">TrimSpace</span><span class="op" id="3657179">(</span><span class="ident" id="3657180">key</span><span class="op" id="3657183">)</span><span class="op" id="3657184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657188">switch</span>&nbsp;<span class="ident" id="3657195">key</span>&nbsp;<span class="op" id="3657199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657203">case</span>&nbsp;<span class="string" id="3657208">&#34;Transfer-Encoding&#34;</span><span class="op" id="3657227">,</span>&nbsp;<span class="string" id="3657229">&#34;Trailer&#34;</span><span class="op" id="3657238">,</span>&nbsp;<span class="string" id="3657240">&#34;Content-Length&#34;</span><span class="op" id="3657256">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657261">return</span>&nbsp;<span class="ident" id="3657268">nil</span><span class="op" id="3657271">,</span>&nbsp;<span class="op" id="3657273">&amp;</span><span class="ident" id="3657274">badStringError</span><span class="op" id="3657288">{</span><span class="string" id="3657289">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3657306">,</span>&nbsp;<span class="ident" id="3657308">key</span><span class="op" id="3657311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657319">trailer</span><span class="op" id="3657326">[</span><span class="ident" id="3657327">key</span><span class="op" id="3657330">]</span>&nbsp;<span class="op" id="3657332">=</span>&nbsp;<span class="ident" id="3657334">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657342">if</span>&nbsp;<span class="builtinfunc" id="3657345">len</span><span class="op" id="3657348">(</span><span class="ident" id="3657349">trailer</span><span class="op" id="3657356">)</span>&nbsp;<span class="op" id="3657358">==</span>&nbsp;<span class="num" id="3657361">0</span>&nbsp;<span class="op" id="3657363">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657367">return</span>&nbsp;<span class="ident" id="3657374">nil</span><span class="op" id="3657377">,</span>&nbsp;<span class="ident" id="3657379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657387">if</span>&nbsp;<span class="op" id="3657390">!</span><span class="ident" id="3657391">chunked</span><span class="op" id="3657398">(</span><span class="ident" id="3657399">te</span><span class="op" id="3657401">)</span>&nbsp;<span class="op" id="3657403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3657407">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657436">return</span>&nbsp;<span class="ident" id="3657443">nil</span><span class="op" id="3657446">,</span>&nbsp;<span class="ident" id="3657448">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3657470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3657473">return</span>&nbsp;<span class="ident" id="3657480">trailer</span><span class="op" id="3657487">,</span>&nbsp;<span class="ident" id="3657489">nil</span><br>
<span class="lineno"></span><span class="op" id="3657493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3657496">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3657538">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3657589">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3657633">type</span>&nbsp;<span class="ident" id="3657638">body</span>&nbsp;<span class="keyword" id="3657643">struct</span>&nbsp;<span class="op" id="3657650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657653">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657661">io</span><span class="op" id="3657663">.</span><span class="ident" id="3657664">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657672">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657680">interface</span><span class="op" id="3657689">{</span><span class="op" id="3657690">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3657694">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657753">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657761">*</span><span class="ident" id="3657762">bufio</span><span class="op" id="3657767">.</span><span class="ident" id="3657768">Reader</span>&nbsp;<span class="comment" id="3657775">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657825">closing</span>&nbsp;<span class="builtintype" id="3657833">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3657847">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657903">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657910">sync</span><span class="op" id="3657914">.</span><span class="ident" id="3657915">Mutex</span>&nbsp;<span class="comment" id="3657921">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3657968">closed</span>&nbsp;<span class="builtintype" id="3657975">bool</span><br>
<span class="lineno">565</span><span class="op" id="3657980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3657983">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3658055">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3658135">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3658199">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3658218">var</span>&nbsp;<span class="ident" id="3658222">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3658244">=</span>&nbsp;<span class="ident" id="3658246">errors</span><span class="op" id="3658252">.</span><span class="ident" id="3658253">New</span><span class="op" id="3658256">(</span><span class="string" id="3658257">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3658292">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3658295">func</span>&nbsp;<span class="op" id="3658300">(</span><span class="ident" id="3658301">b</span>&nbsp;<span class="op" id="3658303">*</span><span class="ident" id="3658304">body</span><span class="op" id="3658308">)</span>&nbsp;<span class="ident" id="3658310">Read</span><span class="op" id="3658314">(</span><span class="ident" id="3658315">p</span>&nbsp;<span class="op" id="3658317">[</span><span class="op" id="3658318">]</span><span class="builtintype" id="3658319">byte</span><span class="op" id="3658323">)</span>&nbsp;<span class="op" id="3658325">(</span><span class="ident" id="3658326">n</span>&nbsp;<span class="builtintype" id="3658328">int</span><span class="op" id="3658331">,</span>&nbsp;<span class="ident" id="3658333">err</span>&nbsp;<span class="builtintype" id="3658337">error</span><span class="op" id="3658342">)</span>&nbsp;<span class="op" id="3658344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658347">b</span><span class="op" id="3658348">.</span><span class="ident" id="3658349">mu</span><span class="op" id="3658351">.</span><span class="ident" id="3658352">Lock</span><span class="op" id="3658356">(</span><span class="op" id="3658357">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658360">defer</span>&nbsp;<span class="ident" id="3658366">b</span><span class="op" id="3658367">.</span><span class="ident" id="3658368">mu</span><span class="op" id="3658370">.</span><span class="ident" id="3658371">Unlock</span><span class="op" id="3658377">(</span><span class="op" id="3658378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658381">if</span>&nbsp;<span class="ident" id="3658384">b</span><span class="op" id="3658385">.</span><span class="ident" id="3658386">closed</span>&nbsp;<span class="op" id="3658393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658397">return</span>&nbsp;<span class="num" id="3658404">0</span><span class="op" id="3658405">,</span>&nbsp;<span class="ident" id="3658407">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658433">return</span>&nbsp;<span class="ident" id="3658440">b</span><span class="op" id="3658441">.</span><span class="ident" id="3658442">readLocked</span><span class="op" id="3658452">(</span><span class="ident" id="3658453">p</span><span class="op" id="3658454">)</span><br>
<span class="lineno">580</span><span class="op" id="3658456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3658459">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3658478">func</span>&nbsp;<span class="op" id="3658483">(</span><span class="ident" id="3658484">b</span>&nbsp;<span class="op" id="3658486">*</span><span class="ident" id="3658487">body</span><span class="op" id="3658491">)</span>&nbsp;<span class="ident" id="3658493">readLocked</span><span class="op" id="3658503">(</span><span class="ident" id="3658504">p</span>&nbsp;<span class="op" id="3658506">[</span><span class="op" id="3658507">]</span><span class="builtintype" id="3658508">byte</span><span class="op" id="3658512">)</span>&nbsp;<span class="op" id="3658514">(</span><span class="ident" id="3658515">n</span>&nbsp;<span class="builtintype" id="3658517">int</span><span class="op" id="3658520">,</span>&nbsp;<span class="ident" id="3658522">err</span>&nbsp;<span class="builtintype" id="3658526">error</span><span class="op" id="3658531">)</span>&nbsp;<span class="op" id="3658533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658536">n</span><span class="op" id="3658537">,</span>&nbsp;<span class="ident" id="3658539">err</span>&nbsp;<span class="op" id="3658543">=</span>&nbsp;<span class="ident" id="3658545">b</span><span class="op" id="3658546">.</span><span class="ident" id="3658547">src</span><span class="op" id="3658550">.</span><span class="ident" id="3658551">Read</span><span class="op" id="3658555">(</span><span class="ident" id="3658556">p</span><span class="op" id="3658557">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658561">if</span>&nbsp;<span class="ident" id="3658564">err</span>&nbsp;<span class="op" id="3658568">==</span>&nbsp;<span class="ident" id="3658571">io</span><span class="op" id="3658573">.</span><span class="ident" id="3658574">EOF</span>&nbsp;<span class="op" id="3658578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3658582">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658619">if</span>&nbsp;<span class="ident" id="3658622">b</span><span class="op" id="3658623">.</span><span class="ident" id="3658624">hdr</span>&nbsp;<span class="op" id="3658628">!=</span>&nbsp;<span class="ident" id="3658631">nil</span>&nbsp;<span class="op" id="3658635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658640">if</span>&nbsp;<span class="ident" id="3658643">e</span>&nbsp;<span class="op" id="3658645">:=</span>&nbsp;<span class="ident" id="3658648">b</span><span class="op" id="3658649">.</span><span class="ident" id="3658650">readTrailer</span><span class="op" id="3658661">(</span><span class="op" id="3658662">)</span><span class="op" id="3658663">;</span>&nbsp;<span class="ident" id="3658665">e</span>&nbsp;<span class="op" id="3658667">!=</span>&nbsp;<span class="ident" id="3658670">nil</span>&nbsp;<span class="op" id="3658674">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658680">err</span>&nbsp;<span class="op" id="3658684">=</span>&nbsp;<span class="ident" id="3658686">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658696">b</span><span class="op" id="3658697">.</span><span class="ident" id="3658698">hdr</span>&nbsp;<span class="op" id="3658702">=</span>&nbsp;<span class="ident" id="3658704">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658710">}</span>&nbsp;<span class="keyword" id="3658712">else</span>&nbsp;<span class="op" id="3658717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3658722">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3658799">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3658858">if</span>&nbsp;<span class="ident" id="3658861">lr</span><span class="op" id="3658863">,</span>&nbsp;<span class="ident" id="3658865">ok</span>&nbsp;<span class="op" id="3658868">:=</span>&nbsp;<span class="ident" id="3658871">b</span><span class="op" id="3658872">.</span><span class="ident" id="3658873">src</span><span class="op" id="3658876">.</span><span class="op" id="3658877">(</span><span class="op" id="3658878">*</span><span class="ident" id="3658879">io</span><span class="op" id="3658881">.</span><span class="ident" id="3658882">LimitedReader</span><span class="op" id="3658895">)</span><span class="op" id="3658896">;</span>&nbsp;<span class="ident" id="3658898">ok</span>&nbsp;<span class="op" id="3658901">&amp;&amp;</span>&nbsp;<span class="ident" id="3658904">lr</span><span class="op" id="3658906">.</span><span class="ident" id="3658907">N</span>&nbsp;<span class="op" id="3658909">&gt;</span>&nbsp;<span class="num" id="3658911">0</span>&nbsp;<span class="op" id="3658913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3658919">err</span>&nbsp;<span class="op" id="3658923">=</span>&nbsp;<span class="ident" id="3658925">io</span><span class="op" id="3658927">.</span><span class="ident" id="3658928">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658952">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3658955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3658959">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659021">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659084">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659144">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659205">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659250">if</span>&nbsp;<span class="ident" id="3659253">err</span>&nbsp;<span class="op" id="3659257">==</span>&nbsp;<span class="ident" id="3659260">nil</span>&nbsp;<span class="op" id="3659264">&amp;&amp;</span>&nbsp;<span class="ident" id="3659267">n</span>&nbsp;<span class="op" id="3659269">&gt;</span>&nbsp;<span class="num" id="3659271">0</span>&nbsp;<span class="op" id="3659273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659277">if</span>&nbsp;<span class="ident" id="3659280">lr</span><span class="op" id="3659282">,</span>&nbsp;<span class="ident" id="3659284">ok</span>&nbsp;<span class="op" id="3659287">:=</span>&nbsp;<span class="ident" id="3659290">b</span><span class="op" id="3659291">.</span><span class="ident" id="3659292">src</span><span class="op" id="3659295">.</span><span class="op" id="3659296">(</span><span class="op" id="3659297">*</span><span class="ident" id="3659298">io</span><span class="op" id="3659300">.</span><span class="ident" id="3659301">LimitedReader</span><span class="op" id="3659314">)</span><span class="op" id="3659315">;</span>&nbsp;<span class="ident" id="3659317">ok</span>&nbsp;<span class="op" id="3659320">&amp;&amp;</span>&nbsp;<span class="ident" id="3659323">lr</span><span class="op" id="3659325">.</span><span class="ident" id="3659326">N</span>&nbsp;<span class="op" id="3659328">==</span>&nbsp;<span class="num" id="3659331">0</span>&nbsp;<span class="op" id="3659333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659338">err</span>&nbsp;<span class="op" id="3659342">=</span>&nbsp;<span class="ident" id="3659344">io</span><span class="op" id="3659346">.</span><span class="ident" id="3659347">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659360">return</span>&nbsp;<span class="ident" id="3659367">n</span><span class="op" id="3659368">,</span>&nbsp;<span class="ident" id="3659370">err</span><br>
<span class="lineno"></span><span class="op" id="3659374">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3659377">var</span>&nbsp;<span class="op" id="3659381">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659384">singleCRLF</span>&nbsp;<span class="op" id="3659395">=</span>&nbsp;<span class="op" id="3659397">[</span><span class="op" id="3659398">]</span><span class="builtintype" id="3659399">byte</span><span class="op" id="3659403">(</span><span class="string" id="3659404">&#34;\r\n&#34;</span><span class="op" id="3659410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659413">doubleCRLF</span>&nbsp;<span class="op" id="3659424">=</span>&nbsp;<span class="op" id="3659426">[</span><span class="op" id="3659427">]</span><span class="builtintype" id="3659428">byte</span><span class="op" id="3659432">(</span><span class="string" id="3659433">&#34;\r\n\r\n&#34;</span><span class="op" id="3659443">)</span><br>
<span class="lineno"></span><span class="op" id="3659445">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3659448">func</span>&nbsp;<span class="ident" id="3659453">seeUpcomingDoubleCRLF</span><span class="op" id="3659474">(</span><span class="ident" id="3659475">r</span>&nbsp;<span class="op" id="3659477">*</span><span class="ident" id="3659478">bufio</span><span class="op" id="3659483">.</span><span class="ident" id="3659484">Reader</span><span class="op" id="3659490">)</span>&nbsp;<span class="builtintype" id="3659492">bool</span>&nbsp;<span class="op" id="3659497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659500">for</span>&nbsp;<span class="ident" id="3659504">peekSize</span>&nbsp;<span class="op" id="3659513">:=</span>&nbsp;<span class="num" id="3659516">4</span><span class="op" id="3659517">;</span>&nbsp;<span class="op" id="3659519">;</span>&nbsp;<span class="ident" id="3659521">peekSize</span><span class="op" id="3659529">++</span>&nbsp;<span class="op" id="3659532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659536">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659585">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659637">buf</span><span class="op" id="3659640">,</span>&nbsp;<span class="ident" id="3659642">err</span>&nbsp;<span class="op" id="3659646">:=</span>&nbsp;<span class="ident" id="3659649">r</span><span class="op" id="3659650">.</span><span class="ident" id="3659651">Peek</span><span class="op" id="3659655">(</span><span class="ident" id="3659656">peekSize</span><span class="op" id="3659664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659668">if</span>&nbsp;<span class="ident" id="3659671">bytes</span><span class="op" id="3659676">.</span><span class="ident" id="3659677">HasSuffix</span><span class="op" id="3659686">(</span><span class="ident" id="3659687">buf</span><span class="op" id="3659690">,</span>&nbsp;<span class="ident" id="3659692">doubleCRLF</span><span class="op" id="3659702">)</span>&nbsp;<span class="op" id="3659704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659709">return</span>&nbsp;<span class="ident" id="3659716">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659727">if</span>&nbsp;<span class="ident" id="3659730">err</span>&nbsp;<span class="op" id="3659734">!=</span>&nbsp;<span class="ident" id="3659737">nil</span>&nbsp;<span class="op" id="3659741">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659746">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3659757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659760">return</span>&nbsp;<span class="ident" id="3659767">false</span><br>
<span class="lineno"></span><span class="op" id="3659773">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3659776">var</span>&nbsp;<span class="ident" id="3659780">errTrailerEOF</span>&nbsp;<span class="op" id="3659794">=</span>&nbsp;<span class="ident" id="3659796">errors</span><span class="op" id="3659802">.</span><span class="ident" id="3659803">New</span><span class="op" id="3659806">(</span><span class="string" id="3659807">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3659845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3659848">func</span>&nbsp;<span class="op" id="3659853">(</span><span class="ident" id="3659854">b</span>&nbsp;<span class="op" id="3659856">*</span><span class="ident" id="3659857">body</span><span class="op" id="3659861">)</span>&nbsp;<span class="ident" id="3659863">readTrailer</span><span class="op" id="3659874">(</span><span class="op" id="3659875">)</span>&nbsp;<span class="builtintype" id="3659877">error</span>&nbsp;<span class="op" id="3659883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3659886">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659935">buf</span><span class="op" id="3659938">,</span>&nbsp;<span class="ident" id="3659940">err</span>&nbsp;<span class="op" id="3659944">:=</span>&nbsp;<span class="ident" id="3659947">b</span><span class="op" id="3659948">.</span><span class="ident" id="3659949">r</span><span class="op" id="3659950">.</span><span class="ident" id="3659951">Peek</span><span class="op" id="3659955">(</span><span class="num" id="3659956">2</span><span class="op" id="3659957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3659960">if</span>&nbsp;<span class="ident" id="3659963">bytes</span><span class="op" id="3659968">.</span><span class="ident" id="3659969">Equal</span><span class="op" id="3659974">(</span><span class="ident" id="3659975">buf</span><span class="op" id="3659978">,</span>&nbsp;<span class="ident" id="3659980">singleCRLF</span><span class="op" id="3659990">)</span>&nbsp;<span class="op" id="3659992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3659996">b</span><span class="op" id="3659997">.</span><span class="ident" id="3659998">r</span><span class="op" id="3659999">.</span><span class="ident" id="3660000">ReadByte</span><span class="op" id="3660008">(</span><span class="op" id="3660009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660013">b</span><span class="op" id="3660014">.</span><span class="ident" id="3660015">r</span><span class="op" id="3660016">.</span><span class="ident" id="3660017">ReadByte</span><span class="op" id="3660025">(</span><span class="op" id="3660026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660030">return</span>&nbsp;<span class="ident" id="3660037">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660045">if</span>&nbsp;<span class="builtinfunc" id="3660048">len</span><span class="op" id="3660051">(</span><span class="ident" id="3660052">buf</span><span class="op" id="3660055">)</span>&nbsp;<span class="op" id="3660057">&lt;</span>&nbsp;<span class="num" id="3660059">2</span>&nbsp;<span class="op" id="3660061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660065">return</span>&nbsp;<span class="ident" id="3660072">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660090">if</span>&nbsp;<span class="ident" id="3660093">err</span>&nbsp;<span class="op" id="3660097">!=</span>&nbsp;<span class="ident" id="3660100">nil</span>&nbsp;<span class="op" id="3660104">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660108">return</span>&nbsp;<span class="ident" id="3660115">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660124">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660188">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660248">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660312">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660374">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660438">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660502">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3660565">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660639">if</span>&nbsp;<span class="op" id="3660642">!</span><span class="ident" id="3660643">seeUpcomingDoubleCRLF</span><span class="op" id="3660664">(</span><span class="ident" id="3660665">b</span><span class="op" id="3660666">.</span><span class="ident" id="3660667">r</span><span class="op" id="3660668">)</span>&nbsp;<span class="op" id="3660670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660674">return</span>&nbsp;<span class="ident" id="3660681">errors</span><span class="op" id="3660687">.</span><span class="ident" id="3660688">New</span><span class="op" id="3660691">(</span><span class="string" id="3660692">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3660744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660751">hdr</span><span class="op" id="3660754">,</span>&nbsp;<span class="ident" id="3660756">err</span>&nbsp;<span class="op" id="3660760">:=</span>&nbsp;<span class="ident" id="3660763">textproto</span><span class="op" id="3660772">.</span><span class="ident" id="3660773">NewReader</span><span class="op" id="3660782">(</span><span class="ident" id="3660783">b</span><span class="op" id="3660784">.</span><span class="ident" id="3660785">r</span><span class="op" id="3660786">)</span><span class="op" id="3660787">.</span><span class="ident" id="3660788">ReadMIMEHeader</span><span class="op" id="3660802">(</span><span class="op" id="3660803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660806">if</span>&nbsp;<span class="ident" id="3660809">err</span>&nbsp;<span class="op" id="3660813">!=</span>&nbsp;<span class="ident" id="3660816">nil</span>&nbsp;<span class="op" id="3660820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660824">if</span>&nbsp;<span class="ident" id="3660827">err</span>&nbsp;<span class="op" id="3660831">==</span>&nbsp;<span class="ident" id="3660834">io</span><span class="op" id="3660836">.</span><span class="ident" id="3660837">EOF</span>&nbsp;<span class="op" id="3660841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660846">return</span>&nbsp;<span class="ident" id="3660853">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660869">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660873">return</span>&nbsp;<span class="ident" id="3660880">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3660885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660888">switch</span>&nbsp;<span class="ident" id="3660895">rr</span>&nbsp;<span class="op" id="3660898">:=</span>&nbsp;<span class="ident" id="3660901">b</span><span class="op" id="3660902">.</span><span class="ident" id="3660903">hdr</span><span class="op" id="3660906">.</span><span class="op" id="3660907">(</span><span class="keyword" id="3660908">type</span><span class="op" id="3660912">)</span>&nbsp;<span class="op" id="3660914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660917">case</span>&nbsp;<span class="op" id="3660922">*</span><span class="ident" id="3660923">Request</span><span class="op" id="3660930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660934">mergeSetHeader</span><span class="op" id="3660948">(</span><span class="op" id="3660949">&amp;</span><span class="ident" id="3660950">rr</span><span class="op" id="3660952">.</span><span class="ident" id="3660953">Trailer</span><span class="op" id="3660960">,</span>&nbsp;<span class="ident" id="3660962">Header</span><span class="op" id="3660968">(</span><span class="ident" id="3660969">hdr</span><span class="op" id="3660972">)</span><span class="op" id="3660973">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3660976">case</span>&nbsp;<span class="op" id="3660981">*</span><span class="ident" id="3660982">Response</span><span class="op" id="3660990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3660994">mergeSetHeader</span><span class="op" id="3661008">(</span><span class="op" id="3661009">&amp;</span><span class="ident" id="3661010">rr</span><span class="op" id="3661012">.</span><span class="ident" id="3661013">Trailer</span><span class="op" id="3661020">,</span>&nbsp;<span class="ident" id="3661022">Header</span><span class="op" id="3661028">(</span><span class="ident" id="3661029">hdr</span><span class="op" id="3661032">)</span><span class="op" id="3661033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661039">return</span>&nbsp;<span class="ident" id="3661046">nil</span><br>
<span class="lineno"></span><span class="op" id="3661050">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3661053">func</span>&nbsp;<span class="ident" id="3661058">mergeSetHeader</span><span class="op" id="3661072">(</span><span class="ident" id="3661073">dst</span>&nbsp;<span class="op" id="3661077">*</span><span class="ident" id="3661078">Header</span><span class="op" id="3661084">,</span>&nbsp;<span class="ident" id="3661086">src</span>&nbsp;<span class="ident" id="3661090">Header</span><span class="op" id="3661096">)</span>&nbsp;<span class="op" id="3661098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661101">if</span>&nbsp;<span class="op" id="3661104">*</span><span class="ident" id="3661105">dst</span>&nbsp;<span class="op" id="3661109">==</span>&nbsp;<span class="ident" id="3661112">nil</span>&nbsp;<span class="op" id="3661116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661120">*</span><span class="ident" id="3661121">dst</span>&nbsp;<span class="op" id="3661125">=</span>&nbsp;<span class="ident" id="3661127">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661133">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661144">for</span>&nbsp;<span class="ident" id="3661148">k</span><span class="op" id="3661149">,</span>&nbsp;<span class="ident" id="3661151">vv</span>&nbsp;<span class="op" id="3661154">:=</span>&nbsp;<span class="keyword" id="3661157">range</span>&nbsp;<span class="ident" id="3661163">src</span>&nbsp;<span class="op" id="3661167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661171">(</span><span class="op" id="3661172">*</span><span class="ident" id="3661173">dst</span><span class="op" id="3661176">)</span><span class="op" id="3661177">[</span><span class="ident" id="3661178">k</span><span class="op" id="3661179">]</span>&nbsp;<span class="op" id="3661181">=</span>&nbsp;<span class="ident" id="3661183">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661187">}</span><br>
<span class="lineno"></span><span class="op" id="3661189">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3661192">func</span>&nbsp;<span class="op" id="3661197">(</span><span class="ident" id="3661198">b</span>&nbsp;<span class="op" id="3661200">*</span><span class="ident" id="3661201">body</span><span class="op" id="3661205">)</span>&nbsp;<span class="ident" id="3661207">Close</span><span class="op" id="3661212">(</span><span class="op" id="3661213">)</span>&nbsp;<span class="builtintype" id="3661215">error</span>&nbsp;<span class="op" id="3661221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661224">b</span><span class="op" id="3661225">.</span><span class="ident" id="3661226">mu</span><span class="op" id="3661228">.</span><span class="ident" id="3661229">Lock</span><span class="op" id="3661233">(</span><span class="op" id="3661234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661237">defer</span>&nbsp;<span class="ident" id="3661243">b</span><span class="op" id="3661244">.</span><span class="ident" id="3661245">mu</span><span class="op" id="3661247">.</span><span class="ident" id="3661248">Unlock</span><span class="op" id="3661254">(</span><span class="op" id="3661255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661258">if</span>&nbsp;<span class="ident" id="3661261">b</span><span class="op" id="3661262">.</span><span class="ident" id="3661263">closed</span>&nbsp;<span class="op" id="3661270">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661274">return</span>&nbsp;<span class="ident" id="3661281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661289">var</span>&nbsp;<span class="ident" id="3661293">err</span>&nbsp;<span class="builtintype" id="3661297">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661304">switch</span>&nbsp;<span class="op" id="3661311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661314">case</span>&nbsp;<span class="ident" id="3661319">b</span><span class="op" id="3661320">.</span><span class="ident" id="3661321">hdr</span>&nbsp;<span class="op" id="3661325">==</span>&nbsp;<span class="ident" id="3661328">nil</span>&nbsp;<span class="op" id="3661332">&amp;&amp;</span>&nbsp;<span class="ident" id="3661335">b</span><span class="op" id="3661336">.</span><span class="ident" id="3661337">closing</span><span class="op" id="3661344">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661348">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661397">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661429">default</span><span class="op" id="3661436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661440">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3661504">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661557">_</span><span class="op" id="3661558">,</span>&nbsp;<span class="ident" id="3661560">err</span>&nbsp;<span class="op" id="3661564">=</span>&nbsp;<span class="ident" id="3661566">io</span><span class="op" id="3661568">.</span><span class="ident" id="3661569">Copy</span><span class="op" id="3661573">(</span><span class="ident" id="3661574">ioutil</span><span class="op" id="3661580">.</span><span class="ident" id="3661581">Discard</span><span class="op" id="3661588">,</span>&nbsp;<span class="ident" id="3661590">bodyLocked</span><span class="op" id="3661600">{</span><span class="ident" id="3661601">b</span><span class="op" id="3661602">}</span><span class="op" id="3661603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661609">b</span><span class="op" id="3661610">.</span><span class="ident" id="3661611">closed</span>&nbsp;<span class="op" id="3661618">=</span>&nbsp;<span class="ident" id="3661620">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661626">return</span>&nbsp;<span class="ident" id="3661633">err</span><br>
<span class="lineno"></span><span class="op" id="3661637">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3661640">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3661708">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3661725">type</span>&nbsp;<span class="ident" id="3661730">bodyLocked</span>&nbsp;<span class="keyword" id="3661741">struct</span>&nbsp;<span class="op" id="3661748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3661751">b</span>&nbsp;<span class="op" id="3661753">*</span><span class="ident" id="3661754">body</span><br>
<span class="lineno">715</span><span class="op" id="3661759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3661762">func</span>&nbsp;<span class="op" id="3661767">(</span><span class="ident" id="3661768">bl</span>&nbsp;<span class="ident" id="3661771">bodyLocked</span><span class="op" id="3661781">)</span>&nbsp;<span class="ident" id="3661783">Read</span><span class="op" id="3661787">(</span><span class="ident" id="3661788">p</span>&nbsp;<span class="op" id="3661790">[</span><span class="op" id="3661791">]</span><span class="builtintype" id="3661792">byte</span><span class="op" id="3661796">)</span>&nbsp;<span class="op" id="3661798">(</span><span class="ident" id="3661799">n</span>&nbsp;<span class="builtintype" id="3661801">int</span><span class="op" id="3661804">,</span>&nbsp;<span class="ident" id="3661806">err</span>&nbsp;<span class="builtintype" id="3661810">error</span><span class="op" id="3661815">)</span>&nbsp;<span class="op" id="3661817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661820">if</span>&nbsp;<span class="ident" id="3661823">bl</span><span class="op" id="3661825">.</span><span class="ident" id="3661826">b</span><span class="op" id="3661827">.</span><span class="ident" id="3661828">closed</span>&nbsp;<span class="op" id="3661835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661839">return</span>&nbsp;<span class="num" id="3661846">0</span><span class="op" id="3661847">,</span>&nbsp;<span class="ident" id="3661849">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3661872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3661875">return</span>&nbsp;<span class="ident" id="3661882">bl</span><span class="op" id="3661884">.</span><span class="ident" id="3661885">b</span><span class="op" id="3661886">.</span><span class="ident" id="3661887">readLocked</span><span class="op" id="3661897">(</span><span class="ident" id="3661898">p</span><span class="op" id="3661899">)</span><br>
<span class="lineno"></span><span class="op" id="3661901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3661904">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3661977">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3662015">func</span>&nbsp;<span class="ident" id="3662020">parseContentLength</span><span class="op" id="3662038">(</span><span class="ident" id="3662039">cl</span>&nbsp;<span class="builtintype" id="3662042">string</span><span class="op" id="3662048">)</span>&nbsp;<span class="op" id="3662050">(</span><span class="ident" id="3662051">int64</span><span class="op" id="3662056">,</span>&nbsp;<span class="builtintype" id="3662058">error</span><span class="op" id="3662063">)</span>&nbsp;<span class="op" id="3662065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662068">cl</span>&nbsp;<span class="op" id="3662071">=</span>&nbsp;<span class="ident" id="3662073">strings</span><span class="op" id="3662080">.</span><span class="ident" id="3662081">TrimSpace</span><span class="op" id="3662090">(</span><span class="ident" id="3662091">cl</span><span class="op" id="3662093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662096">if</span>&nbsp;<span class="ident" id="3662099">cl</span>&nbsp;<span class="op" id="3662102">==</span>&nbsp;<span class="string" id="3662105">&#34;&#34;</span>&nbsp;<span class="op" id="3662108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662112">return</span>&nbsp;<span class="op" id="3662119">-</span><span class="num" id="3662120">1</span><span class="op" id="3662121">,</span>&nbsp;<span class="ident" id="3662123">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3662131">n</span><span class="op" id="3662132">,</span>&nbsp;<span class="ident" id="3662134">err</span>&nbsp;<span class="op" id="3662138">:=</span>&nbsp;<span class="ident" id="3662141">strconv</span><span class="op" id="3662148">.</span><span class="ident" id="3662149">ParseInt</span><span class="op" id="3662157">(</span><span class="ident" id="3662158">cl</span><span class="op" id="3662160">,</span>&nbsp;<span class="num" id="3662162">10</span><span class="op" id="3662164">,</span>&nbsp;<span class="num" id="3662166">64</span><span class="op" id="3662168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662171">if</span>&nbsp;<span class="ident" id="3662174">err</span>&nbsp;<span class="op" id="3662178">!=</span>&nbsp;<span class="ident" id="3662181">nil</span>&nbsp;<span class="op" id="3662185">||</span>&nbsp;<span class="ident" id="3662188">n</span>&nbsp;<span class="op" id="3662190">&lt;</span>&nbsp;<span class="num" id="3662192">0</span>&nbsp;<span class="op" id="3662194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662198">return</span>&nbsp;<span class="num" id="3662205">0</span><span class="op" id="3662206">,</span>&nbsp;<span class="op" id="3662208">&amp;</span><span class="ident" id="3662209">badStringError</span><span class="op" id="3662223">{</span><span class="string" id="3662224">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3662244">,</span>&nbsp;<span class="ident" id="3662246">cl</span><span class="op" id="3662248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3662251">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3662254">return</span>&nbsp;<span class="ident" id="3662261">n</span><span class="op" id="3662262">,</span>&nbsp;<span class="ident" id="3662264">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3662269">}</span>
</div>
</body>
</html>
