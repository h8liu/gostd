<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4210612">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4210667">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4210721">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4210772">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4210843">package</span>&nbsp;<span class="ident" id="4210851">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4210856">import</span>&nbsp;<span class="op" id="4210863">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210866">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210876">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210892">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210906">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210921">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210937">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210947">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210960">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210967">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4210978">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4210985">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4210988">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4211039">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4211082">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4211140">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4211169">func</span>&nbsp;<span class="ident" id="4211174">Server</span><span class="op" id="4211180">(</span><span class="ident" id="4211181">conn</span>&nbsp;<span class="ident" id="4211186">net</span><span class="op" id="4211189">.</span><span class="ident" id="4211190">Conn</span><span class="op" id="4211194">,</span>&nbsp;<span class="ident" id="4211196">config</span>&nbsp;<span class="op" id="4211203">*</span><span class="ident" id="4211204">Config</span><span class="op" id="4211210">)</span>&nbsp;<span class="op" id="4211212">*</span><span class="ident" id="4211213">Conn</span>&nbsp;<span class="op" id="4211218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211221">return</span>&nbsp;<span class="op" id="4211228">&amp;</span><span class="ident" id="4211229">Conn</span><span class="op" id="4211233">{</span><span class="ident" id="4211234">conn</span><span class="op" id="4211238">:</span>&nbsp;<span class="ident" id="4211240">conn</span><span class="op" id="4211244">,</span>&nbsp;<span class="ident" id="4211246">config</span><span class="op" id="4211252">:</span>&nbsp;<span class="ident" id="4211254">config</span><span class="op" id="4211260">}</span><br>
<span class="lineno"></span><span class="op" id="4211262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211265">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4211316">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4211359">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4211424">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4211461">func</span>&nbsp;<span class="ident" id="4211466">Client</span><span class="op" id="4211472">(</span><span class="ident" id="4211473">conn</span>&nbsp;<span class="ident" id="4211478">net</span><span class="op" id="4211481">.</span><span class="ident" id="4211482">Conn</span><span class="op" id="4211486">,</span>&nbsp;<span class="ident" id="4211488">config</span>&nbsp;<span class="op" id="4211495">*</span><span class="ident" id="4211496">Config</span><span class="op" id="4211502">)</span>&nbsp;<span class="op" id="4211504">*</span><span class="ident" id="4211505">Conn</span>&nbsp;<span class="op" id="4211510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211513">return</span>&nbsp;<span class="op" id="4211520">&amp;</span><span class="ident" id="4211521">Conn</span><span class="op" id="4211525">{</span><span class="ident" id="4211526">conn</span><span class="op" id="4211530">:</span>&nbsp;<span class="ident" id="4211532">conn</span><span class="op" id="4211536">,</span>&nbsp;<span class="ident" id="4211538">config</span><span class="op" id="4211544">:</span>&nbsp;<span class="ident" id="4211546">config</span><span class="op" id="4211552">,</span>&nbsp;<span class="ident" id="4211554">isClient</span><span class="op" id="4211562">:</span>&nbsp;<span class="builtintype" id="4211564">true</span><span class="op" id="4211568">}</span><br>
<span class="lineno">35</span><span class="op" id="4211570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211573">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4211653">type</span>&nbsp;<span class="ident" id="4211658">listener</span>&nbsp;<span class="keyword" id="4211667">struct</span>&nbsp;<span class="op" id="4211674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211677">net</span><span class="op" id="4211680">.</span><span class="ident" id="4211681">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211691">config</span>&nbsp;<span class="op" id="4211698">*</span><span class="ident" id="4211699">Config</span><br>
<span class="lineno"></span><span class="op" id="4211706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211709">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4211775">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4211820">func</span>&nbsp;<span class="op" id="4211825">(</span><span class="ident" id="4211826">l</span>&nbsp;<span class="op" id="4211828">*</span><span class="ident" id="4211829">listener</span><span class="op" id="4211837">)</span>&nbsp;<span class="ident" id="4211839">Accept</span><span class="op" id="4211845">(</span><span class="op" id="4211846">)</span>&nbsp;<span class="op" id="4211848">(</span><span class="ident" id="4211849">c</span>&nbsp;<span class="ident" id="4211851">net</span><span class="op" id="4211854">.</span><span class="ident" id="4211855">Conn</span><span class="op" id="4211859">,</span>&nbsp;<span class="ident" id="4211861">err</span>&nbsp;<span class="builtintype" id="4211865">error</span><span class="op" id="4211870">)</span>&nbsp;<span class="op" id="4211872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211875">c</span><span class="op" id="4211876">,</span>&nbsp;<span class="ident" id="4211878">err</span>&nbsp;<span class="op" id="4211882">=</span>&nbsp;<span class="ident" id="4211884">l</span><span class="op" id="4211885">.</span><span class="ident" id="4211886">Listener</span><span class="op" id="4211894">.</span><span class="ident" id="4211895">Accept</span><span class="op" id="4211901">(</span><span class="op" id="4211902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211905">if</span>&nbsp;<span class="ident" id="4211908">err</span>&nbsp;<span class="op" id="4211912">!=</span>&nbsp;<span class="ident" id="4211915">nil</span>&nbsp;<span class="op" id="4211919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211923">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4211931">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4211934">c</span>&nbsp;<span class="op" id="4211936">=</span>&nbsp;<span class="ident" id="4211938">Server</span><span class="op" id="4211944">(</span><span class="ident" id="4211945">c</span><span class="op" id="4211946">,</span>&nbsp;<span class="ident" id="4211948">l</span><span class="op" id="4211949">.</span><span class="ident" id="4211950">config</span><span class="op" id="4211956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4211959">return</span><br>
<span class="lineno"></span><span class="op" id="4211966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211969">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4212043">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4212094">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4212152">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4212181">func</span>&nbsp;<span class="ident" id="4212186">NewListener</span><span class="op" id="4212197">(</span><span class="ident" id="4212198">inner</span>&nbsp;<span class="ident" id="4212204">net</span><span class="op" id="4212207">.</span><span class="ident" id="4212208">Listener</span><span class="op" id="4212216">,</span>&nbsp;<span class="ident" id="4212218">config</span>&nbsp;<span class="op" id="4212225">*</span><span class="ident" id="4212226">Config</span><span class="op" id="4212232">)</span>&nbsp;<span class="ident" id="4212234">net</span><span class="op" id="4212237">.</span><span class="ident" id="4212238">Listener</span>&nbsp;<span class="op" id="4212247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212250">l</span>&nbsp;<span class="op" id="4212252">:=</span>&nbsp;<span class="builtinfunc" id="4212255">new</span><span class="op" id="4212258">(</span><span class="ident" id="4212259">listener</span><span class="op" id="4212267">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212270">l</span><span class="op" id="4212271">.</span><span class="ident" id="4212272">Listener</span>&nbsp;<span class="op" id="4212281">=</span>&nbsp;<span class="ident" id="4212283">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212290">l</span><span class="op" id="4212291">.</span><span class="ident" id="4212292">config</span>&nbsp;<span class="op" id="4212299">=</span>&nbsp;<span class="ident" id="4212301">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212309">return</span>&nbsp;<span class="ident" id="4212316">l</span><br>
<span class="lineno"></span><span class="op" id="4212318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4212321">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4212383">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4212426">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4212484">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4212513">func</span>&nbsp;<span class="ident" id="4212518">Listen</span><span class="op" id="4212524">(</span><span class="ident" id="4212525">network</span><span class="op" id="4212532">,</span>&nbsp;<span class="ident" id="4212534">laddr</span>&nbsp;<span class="builtintype" id="4212540">string</span><span class="op" id="4212546">,</span>&nbsp;<span class="ident" id="4212548">config</span>&nbsp;<span class="op" id="4212555">*</span><span class="ident" id="4212556">Config</span><span class="op" id="4212562">)</span>&nbsp;<span class="op" id="4212564">(</span><span class="ident" id="4212565">net</span><span class="op" id="4212568">.</span><span class="ident" id="4212569">Listener</span><span class="op" id="4212577">,</span>&nbsp;<span class="builtintype" id="4212579">error</span><span class="op" id="4212584">)</span>&nbsp;<span class="op" id="4212586">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212589">if</span>&nbsp;<span class="ident" id="4212592">config</span>&nbsp;<span class="op" id="4212599">==</span>&nbsp;<span class="ident" id="4212602">nil</span>&nbsp;<span class="op" id="4212606">||</span>&nbsp;<span class="builtinfunc" id="4212609">len</span><span class="op" id="4212612">(</span><span class="ident" id="4212613">config</span><span class="op" id="4212619">.</span><span class="ident" id="4212620">Certificates</span><span class="op" id="4212632">)</span>&nbsp;<span class="op" id="4212634">==</span>&nbsp;<span class="num" id="4212637">0</span>&nbsp;<span class="op" id="4212639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212643">return</span>&nbsp;<span class="ident" id="4212650">nil</span><span class="op" id="4212653">,</span>&nbsp;<span class="ident" id="4212655">errors</span><span class="op" id="4212661">.</span><span class="ident" id="4212662">New</span><span class="op" id="4212665">(</span><span class="string" id="4212666">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4212712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4212718">l</span><span class="op" id="4212719">,</span>&nbsp;<span class="ident" id="4212721">err</span>&nbsp;<span class="op" id="4212725">:=</span>&nbsp;<span class="ident" id="4212728">net</span><span class="op" id="4212731">.</span><span class="ident" id="4212732">Listen</span><span class="op" id="4212738">(</span><span class="ident" id="4212739">network</span><span class="op" id="4212746">,</span>&nbsp;<span class="ident" id="4212748">laddr</span><span class="op" id="4212753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212756">if</span>&nbsp;<span class="ident" id="4212759">err</span>&nbsp;<span class="op" id="4212763">!=</span>&nbsp;<span class="ident" id="4212766">nil</span>&nbsp;<span class="op" id="4212770">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212774">return</span>&nbsp;<span class="ident" id="4212781">nil</span><span class="op" id="4212784">,</span>&nbsp;<span class="ident" id="4212786">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4212791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4212794">return</span>&nbsp;<span class="ident" id="4212801">NewListener</span><span class="op" id="4212812">(</span><span class="ident" id="4212813">l</span><span class="op" id="4212814">,</span>&nbsp;<span class="ident" id="4212816">config</span><span class="op" id="4212822">)</span><span class="op" id="4212823">,</span>&nbsp;<span class="ident" id="4212825">nil</span><br>
<span class="lineno"></span><span class="op" id="4212829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4212832">type</span>&nbsp;<span class="ident" id="4212837">timeoutError</span>&nbsp;<span class="keyword" id="4212850">struct</span><span class="op" id="4212856">{</span><span class="op" id="4212857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4212860">func</span>&nbsp;<span class="op" id="4212865">(</span><span class="ident" id="4212866">timeoutError</span><span class="op" id="4212878">)</span>&nbsp;<span class="ident" id="4212880">Error</span><span class="op" id="4212885">(</span><span class="op" id="4212886">)</span>&nbsp;<span class="builtintype" id="4212888">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4212897">{</span>&nbsp;<span class="keyword" id="4212899">return</span>&nbsp;<span class="string" id="4212906">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4212938">}</span><br>
<span class="lineno"></span><span class="keyword" id="4212940">func</span>&nbsp;<span class="op" id="4212945">(</span><span class="ident" id="4212946">timeoutError</span><span class="op" id="4212958">)</span>&nbsp;<span class="ident" id="4212960">Timeout</span><span class="op" id="4212967">(</span><span class="op" id="4212968">)</span>&nbsp;<span class="builtintype" id="4212970">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4212977">{</span>&nbsp;<span class="keyword" id="4212979">return</span>&nbsp;<span class="builtintype" id="4212986">true</span>&nbsp;<span class="op" id="4212991">}</span><br>
<span class="lineno"></span><span class="keyword" id="4212993">func</span>&nbsp;<span class="op" id="4212998">(</span><span class="ident" id="4212999">timeoutError</span><span class="op" id="4213011">)</span>&nbsp;<span class="ident" id="4213013">Temporary</span><span class="op" id="4213022">(</span><span class="op" id="4213023">)</span>&nbsp;<span class="builtintype" id="4213025">bool</span>&nbsp;<span class="op" id="4213030">{</span>&nbsp;<span class="keyword" id="4213032">return</span>&nbsp;<span class="builtintype" id="4213039">true</span>&nbsp;<span class="op" id="4213044">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4213047">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4213125">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4213204">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4213275">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4213300">//</span><br>
<span class="lineno"></span><span class="comment" id="4213303">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4213378">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4213446">func</span>&nbsp;<span class="ident" id="4213451">DialWithDialer</span><span class="op" id="4213465">(</span><span class="ident" id="4213466">dialer</span>&nbsp;<span class="op" id="4213473">*</span><span class="ident" id="4213474">net</span><span class="op" id="4213477">.</span><span class="ident" id="4213478">Dialer</span><span class="op" id="4213484">,</span>&nbsp;<span class="ident" id="4213486">network</span><span class="op" id="4213493">,</span>&nbsp;<span class="ident" id="4213495">addr</span>&nbsp;<span class="builtintype" id="4213500">string</span><span class="op" id="4213506">,</span>&nbsp;<span class="ident" id="4213508">config</span>&nbsp;<span class="op" id="4213515">*</span><span class="ident" id="4213516">Config</span><span class="op" id="4213522">)</span>&nbsp;<span class="op" id="4213524">(</span><span class="op" id="4213525">*</span><span class="ident" id="4213526">Conn</span><span class="op" id="4213530">,</span>&nbsp;<span class="builtintype" id="4213532">error</span><span class="op" id="4213537">)</span>&nbsp;<span class="op" id="4213539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4213542">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4213611">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4213683">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213726">timeout</span>&nbsp;<span class="op" id="4213734">:=</span>&nbsp;<span class="ident" id="4213737">dialer</span><span class="op" id="4213743">.</span><span class="ident" id="4213744">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213754">if</span>&nbsp;<span class="op" id="4213757">!</span><span class="ident" id="4213758">dialer</span><span class="op" id="4213764">.</span><span class="ident" id="4213765">Deadline</span><span class="op" id="4213773">.</span><span class="ident" id="4213774">IsZero</span><span class="op" id="4213780">(</span><span class="op" id="4213781">)</span>&nbsp;<span class="op" id="4213783">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213787">deadlineTimeout</span>&nbsp;<span class="op" id="4213803">:=</span>&nbsp;<span class="ident" id="4213806">dialer</span><span class="op" id="4213812">.</span><span class="ident" id="4213813">Deadline</span><span class="op" id="4213821">.</span><span class="ident" id="4213822">Sub</span><span class="op" id="4213825">(</span><span class="ident" id="4213826">time</span><span class="op" id="4213830">.</span><span class="ident" id="4213831">Now</span><span class="op" id="4213834">(</span><span class="op" id="4213835">)</span><span class="op" id="4213836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213840">if</span>&nbsp;<span class="ident" id="4213843">timeout</span>&nbsp;<span class="op" id="4213851">==</span>&nbsp;<span class="num" id="4213854">0</span>&nbsp;<span class="op" id="4213856">||</span>&nbsp;<span class="ident" id="4213859">deadlineTimeout</span>&nbsp;<span class="op" id="4213875">&lt;</span>&nbsp;<span class="ident" id="4213877">timeout</span>&nbsp;<span class="op" id="4213885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213890">timeout</span>&nbsp;<span class="op" id="4213898">=</span>&nbsp;<span class="ident" id="4213900">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4213918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4213921">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213925">var</span>&nbsp;<span class="ident" id="4213929">errChannel</span>&nbsp;<span class="keyword" id="4213940">chan</span>&nbsp;<span class="builtintype" id="4213945">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4213953">if</span>&nbsp;<span class="ident" id="4213956">timeout</span>&nbsp;<span class="op" id="4213964">!=</span>&nbsp;<span class="num" id="4213967">0</span>&nbsp;<span class="op" id="4213969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4213973">errChannel</span>&nbsp;<span class="op" id="4213984">=</span>&nbsp;<span class="builtinfunc" id="4213986">make</span><span class="op" id="4213990">(</span><span class="keyword" id="4213991">chan</span>&nbsp;<span class="builtintype" id="4213996">error</span><span class="op" id="4214001">,</span>&nbsp;<span class="num" id="4214003">2</span><span class="op" id="4214004">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214008">time</span><span class="op" id="4214012">.</span><span class="ident" id="4214013">AfterFunc</span><span class="op" id="4214022">(</span><span class="ident" id="4214023">timeout</span><span class="op" id="4214030">,</span>&nbsp;<span class="keyword" id="4214032">func</span><span class="op" id="4214036">(</span><span class="op" id="4214037">)</span>&nbsp;<span class="op" id="4214039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214044">errChannel</span>&nbsp;<span class="op" id="4214055">&lt;-</span>&nbsp;<span class="ident" id="4214058">timeoutError</span><span class="op" id="4214070">{</span><span class="op" id="4214071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214075">}</span><span class="op" id="4214076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214083">rawConn</span><span class="op" id="4214090">,</span>&nbsp;<span class="ident" id="4214092">err</span>&nbsp;<span class="op" id="4214096">:=</span>&nbsp;<span class="ident" id="4214099">dialer</span><span class="op" id="4214105">.</span><span class="ident" id="4214106">Dial</span><span class="op" id="4214110">(</span><span class="ident" id="4214111">network</span><span class="op" id="4214118">,</span>&nbsp;<span class="ident" id="4214120">addr</span><span class="op" id="4214124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214127">if</span>&nbsp;<span class="ident" id="4214130">err</span>&nbsp;<span class="op" id="4214134">!=</span>&nbsp;<span class="ident" id="4214137">nil</span>&nbsp;<span class="op" id="4214141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214145">return</span>&nbsp;<span class="ident" id="4214152">nil</span><span class="op" id="4214155">,</span>&nbsp;<span class="ident" id="4214157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214166">colonPos</span>&nbsp;<span class="op" id="4214175">:=</span>&nbsp;<span class="ident" id="4214178">strings</span><span class="op" id="4214185">.</span><span class="ident" id="4214186">LastIndex</span><span class="op" id="4214195">(</span><span class="ident" id="4214196">addr</span><span class="op" id="4214200">,</span>&nbsp;<span class="string" id="4214202">&#34;:&#34;</span><span class="op" id="4214205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214208">if</span>&nbsp;<span class="ident" id="4214211">colonPos</span>&nbsp;<span class="op" id="4214220">==</span>&nbsp;<span class="op" id="4214223">-</span><span class="num" id="4214224">1</span>&nbsp;<span class="op" id="4214226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214230">colonPos</span>&nbsp;<span class="op" id="4214239">=</span>&nbsp;<span class="builtinfunc" id="4214241">len</span><span class="op" id="4214244">(</span><span class="ident" id="4214245">addr</span><span class="op" id="4214249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214255">hostname</span>&nbsp;<span class="op" id="4214264">:=</span>&nbsp;<span class="ident" id="4214267">addr</span><span class="op" id="4214271">[</span><span class="op" id="4214272">:</span><span class="ident" id="4214273">colonPos</span><span class="op" id="4214281">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214285">if</span>&nbsp;<span class="ident" id="4214288">config</span>&nbsp;<span class="op" id="4214295">==</span>&nbsp;<span class="ident" id="4214298">nil</span>&nbsp;<span class="op" id="4214302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214306">config</span>&nbsp;<span class="op" id="4214313">=</span>&nbsp;<span class="ident" id="4214315">defaultConfig</span><span class="op" id="4214328">(</span><span class="op" id="4214329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214335">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214385">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214428">if</span>&nbsp;<span class="ident" id="4214431">config</span><span class="op" id="4214437">.</span><span class="ident" id="4214438">ServerName</span>&nbsp;<span class="op" id="4214449">==</span>&nbsp;<span class="string" id="4214452">&#34;&#34;</span>&nbsp;<span class="op" id="4214455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4214459">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214516">c</span>&nbsp;<span class="op" id="4214518">:=</span>&nbsp;<span class="op" id="4214521">*</span><span class="ident" id="4214522">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214531">c</span><span class="op" id="4214532">.</span><span class="ident" id="4214533">ServerName</span>&nbsp;<span class="op" id="4214544">=</span>&nbsp;<span class="ident" id="4214546">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214557">config</span>&nbsp;<span class="op" id="4214564">=</span>&nbsp;<span class="op" id="4214566">&amp;</span><span class="ident" id="4214567">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214574">conn</span>&nbsp;<span class="op" id="4214579">:=</span>&nbsp;<span class="ident" id="4214582">Client</span><span class="op" id="4214588">(</span><span class="ident" id="4214589">rawConn</span><span class="op" id="4214596">,</span>&nbsp;<span class="ident" id="4214598">config</span><span class="op" id="4214604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214608">if</span>&nbsp;<span class="ident" id="4214611">timeout</span>&nbsp;<span class="op" id="4214619">==</span>&nbsp;<span class="num" id="4214622">0</span>&nbsp;<span class="op" id="4214624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214628">err</span>&nbsp;<span class="op" id="4214632">=</span>&nbsp;<span class="ident" id="4214634">conn</span><span class="op" id="4214638">.</span><span class="ident" id="4214639">Handshake</span><span class="op" id="4214648">(</span><span class="op" id="4214649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214652">}</span>&nbsp;<span class="keyword" id="4214654">else</span>&nbsp;<span class="op" id="4214659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214663">go</span>&nbsp;<span class="keyword" id="4214666">func</span><span class="op" id="4214670">(</span><span class="op" id="4214671">)</span>&nbsp;<span class="op" id="4214673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214678">errChannel</span>&nbsp;<span class="op" id="4214689">&lt;-</span>&nbsp;<span class="ident" id="4214692">conn</span><span class="op" id="4214696">.</span><span class="ident" id="4214697">Handshake</span><span class="op" id="4214706">(</span><span class="op" id="4214707">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214711">}</span><span class="op" id="4214712">(</span><span class="op" id="4214713">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214718">err</span>&nbsp;<span class="op" id="4214722">=</span>&nbsp;<span class="op" id="4214724">&lt;-</span><span class="ident" id="4214726">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214742">if</span>&nbsp;<span class="ident" id="4214745">err</span>&nbsp;<span class="op" id="4214749">!=</span>&nbsp;<span class="ident" id="4214752">nil</span>&nbsp;<span class="op" id="4214756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4214760">rawConn</span><span class="op" id="4214767">.</span><span class="ident" id="4214768">Close</span><span class="op" id="4214773">(</span><span class="op" id="4214774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214778">return</span>&nbsp;<span class="ident" id="4214785">nil</span><span class="op" id="4214788">,</span>&nbsp;<span class="ident" id="4214790">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4214795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4214799">return</span>&nbsp;<span class="ident" id="4214806">conn</span><span class="op" id="4214810">,</span>&nbsp;<span class="ident" id="4214812">nil</span><br>
<span class="lineno"></span><span class="op" id="4214816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4214819">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4214880">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4214943">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4214962">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4215018">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4215077">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4215098">func</span>&nbsp;<span class="ident" id="4215103">Dial</span><span class="op" id="4215107">(</span><span class="ident" id="4215108">network</span><span class="op" id="4215115">,</span>&nbsp;<span class="ident" id="4215117">addr</span>&nbsp;<span class="builtintype" id="4215122">string</span><span class="op" id="4215128">,</span>&nbsp;<span class="ident" id="4215130">config</span>&nbsp;<span class="op" id="4215137">*</span><span class="ident" id="4215138">Config</span><span class="op" id="4215144">)</span>&nbsp;<span class="op" id="4215146">(</span><span class="op" id="4215147">*</span><span class="ident" id="4215148">Conn</span><span class="op" id="4215152">,</span>&nbsp;<span class="builtintype" id="4215154">error</span><span class="op" id="4215159">)</span>&nbsp;<span class="op" id="4215161">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215164">return</span>&nbsp;<span class="ident" id="4215171">DialWithDialer</span><span class="op" id="4215185">(</span><span class="builtinfunc" id="4215186">new</span><span class="op" id="4215189">(</span><span class="ident" id="4215190">net</span><span class="op" id="4215193">.</span><span class="ident" id="4215194">Dialer</span><span class="op" id="4215200">)</span><span class="op" id="4215201">,</span>&nbsp;<span class="ident" id="4215203">network</span><span class="op" id="4215210">,</span>&nbsp;<span class="ident" id="4215212">addr</span><span class="op" id="4215216">,</span>&nbsp;<span class="ident" id="4215218">config</span><span class="op" id="4215224">)</span><br>
<span class="lineno"></span><span class="op" id="4215226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215229">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4215306">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4215357">func</span>&nbsp;<span class="ident" id="4215362">LoadX509KeyPair</span><span class="op" id="4215377">(</span><span class="ident" id="4215378">certFile</span><span class="op" id="4215386">,</span>&nbsp;<span class="ident" id="4215388">keyFile</span>&nbsp;<span class="builtintype" id="4215396">string</span><span class="op" id="4215402">)</span>&nbsp;<span class="op" id="4215404">(</span><span class="ident" id="4215405">cert</span>&nbsp;<span class="ident" id="4215410">Certificate</span><span class="op" id="4215421">,</span>&nbsp;<span class="ident" id="4215423">err</span>&nbsp;<span class="builtintype" id="4215427">error</span><span class="op" id="4215432">)</span>&nbsp;<span class="op" id="4215434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215437">certPEMBlock</span><span class="op" id="4215449">,</span>&nbsp;<span class="ident" id="4215451">err</span>&nbsp;<span class="op" id="4215455">:=</span>&nbsp;<span class="ident" id="4215458">ioutil</span><span class="op" id="4215464">.</span><span class="ident" id="4215465">ReadFile</span><span class="op" id="4215473">(</span><span class="ident" id="4215474">certFile</span><span class="op" id="4215482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215485">if</span>&nbsp;<span class="ident" id="4215488">err</span>&nbsp;<span class="op" id="4215492">!=</span>&nbsp;<span class="ident" id="4215495">nil</span>&nbsp;<span class="op" id="4215499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215503">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215511">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215514">keyPEMBlock</span><span class="op" id="4215525">,</span>&nbsp;<span class="ident" id="4215527">err</span>&nbsp;<span class="op" id="4215531">:=</span>&nbsp;<span class="ident" id="4215534">ioutil</span><span class="op" id="4215540">.</span><span class="ident" id="4215541">ReadFile</span><span class="op" id="4215549">(</span><span class="ident" id="4215550">keyFile</span><span class="op" id="4215557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215560">if</span>&nbsp;<span class="ident" id="4215563">err</span>&nbsp;<span class="op" id="4215567">!=</span>&nbsp;<span class="ident" id="4215570">nil</span>&nbsp;<span class="op" id="4215574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215578">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215589">return</span>&nbsp;<span class="ident" id="4215596">X509KeyPair</span><span class="op" id="4215607">(</span><span class="ident" id="4215608">certPEMBlock</span><span class="op" id="4215620">,</span>&nbsp;<span class="ident" id="4215622">keyPEMBlock</span><span class="op" id="4215633">)</span><br>
<span class="lineno">180</span><span class="op" id="4215635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215638">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4215701">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4215722">func</span>&nbsp;<span class="ident" id="4215727">X509KeyPair</span><span class="op" id="4215738">(</span><span class="ident" id="4215739">certPEMBlock</span><span class="op" id="4215751">,</span>&nbsp;<span class="ident" id="4215753">keyPEMBlock</span>&nbsp;<span class="op" id="4215765">[</span><span class="op" id="4215766">]</span><span class="builtintype" id="4215767">byte</span><span class="op" id="4215771">)</span>&nbsp;<span class="op" id="4215773">(</span><span class="ident" id="4215774">cert</span>&nbsp;<span class="ident" id="4215779">Certificate</span><span class="op" id="4215790">,</span>&nbsp;<span class="ident" id="4215792">err</span>&nbsp;<span class="builtintype" id="4215796">error</span><span class="op" id="4215801">)</span>&nbsp;<span class="op" id="4215803">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215806">var</span>&nbsp;<span class="ident" id="4215810">certDERBlock</span>&nbsp;<span class="op" id="4215823">*</span><span class="ident" id="4215824">pem</span><span class="op" id="4215827">.</span><span class="ident" id="4215828">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215835">for</span>&nbsp;<span class="op" id="4215839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215843">certDERBlock</span><span class="op" id="4215855">,</span>&nbsp;<span class="ident" id="4215857">certPEMBlock</span>&nbsp;<span class="op" id="4215870">=</span>&nbsp;<span class="ident" id="4215872">pem</span><span class="op" id="4215875">.</span><span class="ident" id="4215876">Decode</span><span class="op" id="4215882">(</span><span class="ident" id="4215883">certPEMBlock</span><span class="op" id="4215895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215899">if</span>&nbsp;<span class="ident" id="4215902">certDERBlock</span>&nbsp;<span class="op" id="4215915">==</span>&nbsp;<span class="ident" id="4215918">nil</span>&nbsp;<span class="op" id="4215922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215927">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4215935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4215939">if</span>&nbsp;<span class="ident" id="4215942">certDERBlock</span><span class="op" id="4215954">.</span><span class="ident" id="4215955">Type</span>&nbsp;<span class="op" id="4215960">==</span>&nbsp;<span class="string" id="4215963">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4215977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4215982">cert</span><span class="op" id="4215986">.</span><span class="ident" id="4215987">Certificate</span>&nbsp;<span class="op" id="4215999">=</span>&nbsp;<span class="builtinfunc" id="4216001">append</span><span class="op" id="4216007">(</span><span class="ident" id="4216008">cert</span><span class="op" id="4216012">.</span><span class="ident" id="4216013">Certificate</span><span class="op" id="4216024">,</span>&nbsp;<span class="ident" id="4216026">certDERBlock</span><span class="op" id="4216038">.</span><span class="ident" id="4216039">Bytes</span><span class="op" id="4216044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216051">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216055">if</span>&nbsp;<span class="builtinfunc" id="4216058">len</span><span class="op" id="4216061">(</span><span class="ident" id="4216062">cert</span><span class="op" id="4216066">.</span><span class="ident" id="4216067">Certificate</span><span class="op" id="4216078">)</span>&nbsp;<span class="op" id="4216080">==</span>&nbsp;<span class="num" id="4216083">0</span>&nbsp;<span class="op" id="4216085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216089">err</span>&nbsp;<span class="op" id="4216093">=</span>&nbsp;<span class="ident" id="4216095">errors</span><span class="op" id="4216101">.</span><span class="ident" id="4216102">New</span><span class="op" id="4216105">(</span><span class="string" id="4216106">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4216156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216168">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216172">var</span>&nbsp;<span class="ident" id="4216176">keyDERBlock</span>&nbsp;<span class="op" id="4216188">*</span><span class="ident" id="4216189">pem</span><span class="op" id="4216192">.</span><span class="ident" id="4216193">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216200">for</span>&nbsp;<span class="op" id="4216204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216208">keyDERBlock</span><span class="op" id="4216219">,</span>&nbsp;<span class="ident" id="4216221">keyPEMBlock</span>&nbsp;<span class="op" id="4216233">=</span>&nbsp;<span class="ident" id="4216235">pem</span><span class="op" id="4216238">.</span><span class="ident" id="4216239">Decode</span><span class="op" id="4216245">(</span><span class="ident" id="4216246">keyPEMBlock</span><span class="op" id="4216257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216261">if</span>&nbsp;<span class="ident" id="4216264">keyDERBlock</span>&nbsp;<span class="op" id="4216276">==</span>&nbsp;<span class="ident" id="4216279">nil</span>&nbsp;<span class="op" id="4216283">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216288">err</span>&nbsp;<span class="op" id="4216292">=</span>&nbsp;<span class="ident" id="4216294">errors</span><span class="op" id="4216300">.</span><span class="ident" id="4216301">New</span><span class="op" id="4216304">(</span><span class="string" id="4216305">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4216347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216352">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216365">if</span>&nbsp;<span class="ident" id="4216368">keyDERBlock</span><span class="op" id="4216379">.</span><span class="ident" id="4216380">Type</span>&nbsp;<span class="op" id="4216385">==</span>&nbsp;<span class="string" id="4216388">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4216402">||</span>&nbsp;<span class="ident" id="4216405">strings</span><span class="op" id="4216412">.</span><span class="ident" id="4216413">HasSuffix</span><span class="op" id="4216422">(</span><span class="ident" id="4216423">keyDERBlock</span><span class="op" id="4216434">.</span><span class="ident" id="4216435">Type</span><span class="op" id="4216439">,</span>&nbsp;<span class="string" id="4216441">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4216455">)</span>&nbsp;<span class="op" id="4216457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216462">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216477">cert</span><span class="op" id="4216481">.</span><span class="ident" id="4216482">PrivateKey</span><span class="op" id="4216492">,</span>&nbsp;<span class="ident" id="4216494">err</span>&nbsp;<span class="op" id="4216498">=</span>&nbsp;<span class="ident" id="4216500">parsePrivateKey</span><span class="op" id="4216515">(</span><span class="ident" id="4216516">keyDERBlock</span><span class="op" id="4216527">.</span><span class="ident" id="4216528">Bytes</span><span class="op" id="4216533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216536">if</span>&nbsp;<span class="ident" id="4216539">err</span>&nbsp;<span class="op" id="4216543">!=</span>&nbsp;<span class="ident" id="4216546">nil</span>&nbsp;<span class="op" id="4216550">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216554">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216566">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4216637">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216698">x509Cert</span><span class="op" id="4216706">,</span>&nbsp;<span class="ident" id="4216708">err</span>&nbsp;<span class="op" id="4216712">:=</span>&nbsp;<span class="ident" id="4216715">x509</span><span class="op" id="4216719">.</span><span class="ident" id="4216720">ParseCertificate</span><span class="op" id="4216736">(</span><span class="ident" id="4216737">cert</span><span class="op" id="4216741">.</span><span class="ident" id="4216742">Certificate</span><span class="op" id="4216753">[</span><span class="num" id="4216754">0</span><span class="op" id="4216755">]</span><span class="op" id="4216756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216759">if</span>&nbsp;<span class="ident" id="4216762">err</span>&nbsp;<span class="op" id="4216766">!=</span>&nbsp;<span class="ident" id="4216769">nil</span>&nbsp;<span class="op" id="4216773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216777">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4216785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216789">switch</span>&nbsp;<span class="ident" id="4216796">pub</span>&nbsp;<span class="op" id="4216800">:=</span>&nbsp;<span class="ident" id="4216803">x509Cert</span><span class="op" id="4216811">.</span><span class="ident" id="4216812">PublicKey</span><span class="op" id="4216821">.</span><span class="op" id="4216822">(</span><span class="keyword" id="4216823">type</span><span class="op" id="4216827">)</span>&nbsp;<span class="op" id="4216829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216832">case</span>&nbsp;<span class="op" id="4216837">*</span><span class="ident" id="4216838">rsa</span><span class="op" id="4216841">.</span><span class="ident" id="4216842">PublicKey</span><span class="op" id="4216851">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216855">priv</span><span class="op" id="4216859">,</span>&nbsp;<span class="ident" id="4216861">ok</span>&nbsp;<span class="op" id="4216864">:=</span>&nbsp;<span class="ident" id="4216867">cert</span><span class="op" id="4216871">.</span><span class="ident" id="4216872">PrivateKey</span><span class="op" id="4216882">.</span><span class="op" id="4216883">(</span><span class="op" id="4216884">*</span><span class="ident" id="4216885">rsa</span><span class="op" id="4216888">.</span><span class="ident" id="4216889">PrivateKey</span><span class="op" id="4216899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216903">if</span>&nbsp;<span class="op" id="4216906">!</span><span class="ident" id="4216907">ok</span>&nbsp;<span class="op" id="4216910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4216915">err</span>&nbsp;<span class="op" id="4216919">=</span>&nbsp;<span class="ident" id="4216921">errors</span><span class="op" id="4216927">.</span><span class="ident" id="4216928">New</span><span class="op" id="4216931">(</span><span class="string" id="4216932">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4216993">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4216998">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217011">if</span>&nbsp;<span class="ident" id="4217014">pub</span><span class="op" id="4217017">.</span><span class="ident" id="4217018">N</span><span class="op" id="4217019">.</span><span class="ident" id="4217020">Cmp</span><span class="op" id="4217023">(</span><span class="ident" id="4217024">priv</span><span class="op" id="4217028">.</span><span class="ident" id="4217029">N</span><span class="op" id="4217030">)</span>&nbsp;<span class="op" id="4217032">!=</span>&nbsp;<span class="num" id="4217035">0</span>&nbsp;<span class="op" id="4217037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217042">err</span>&nbsp;<span class="op" id="4217046">=</span>&nbsp;<span class="ident" id="4217048">errors</span><span class="op" id="4217054">.</span><span class="ident" id="4217055">New</span><span class="op" id="4217058">(</span><span class="string" id="4217059">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4217110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217115">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217127">case</span>&nbsp;<span class="op" id="4217132">*</span><span class="ident" id="4217133">ecdsa</span><span class="op" id="4217138">.</span><span class="ident" id="4217139">PublicKey</span><span class="op" id="4217148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217152">priv</span><span class="op" id="4217156">,</span>&nbsp;<span class="ident" id="4217158">ok</span>&nbsp;<span class="op" id="4217161">:=</span>&nbsp;<span class="ident" id="4217164">cert</span><span class="op" id="4217168">.</span><span class="ident" id="4217169">PrivateKey</span><span class="op" id="4217179">.</span><span class="op" id="4217180">(</span><span class="op" id="4217181">*</span><span class="ident" id="4217182">ecdsa</span><span class="op" id="4217187">.</span><span class="ident" id="4217188">PrivateKey</span><span class="op" id="4217198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217202">if</span>&nbsp;<span class="op" id="4217205">!</span><span class="ident" id="4217206">ok</span>&nbsp;<span class="op" id="4217209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217214">err</span>&nbsp;<span class="op" id="4217218">=</span>&nbsp;<span class="ident" id="4217220">errors</span><span class="op" id="4217226">.</span><span class="ident" id="4217227">New</span><span class="op" id="4217230">(</span><span class="string" id="4217231">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4217292">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217297">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217311">if</span>&nbsp;<span class="ident" id="4217314">pub</span><span class="op" id="4217317">.</span><span class="ident" id="4217318">X</span><span class="op" id="4217319">.</span><span class="ident" id="4217320">Cmp</span><span class="op" id="4217323">(</span><span class="ident" id="4217324">priv</span><span class="op" id="4217328">.</span><span class="ident" id="4217329">X</span><span class="op" id="4217330">)</span>&nbsp;<span class="op" id="4217332">!=</span>&nbsp;<span class="num" id="4217335">0</span>&nbsp;<span class="op" id="4217337">||</span>&nbsp;<span class="ident" id="4217340">pub</span><span class="op" id="4217343">.</span><span class="ident" id="4217344">Y</span><span class="op" id="4217345">.</span><span class="ident" id="4217346">Cmp</span><span class="op" id="4217349">(</span><span class="ident" id="4217350">priv</span><span class="op" id="4217354">.</span><span class="ident" id="4217355">Y</span><span class="op" id="4217356">)</span>&nbsp;<span class="op" id="4217358">!=</span>&nbsp;<span class="num" id="4217361">0</span>&nbsp;<span class="op" id="4217363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217368">err</span>&nbsp;<span class="op" id="4217372">=</span>&nbsp;<span class="ident" id="4217374">errors</span><span class="op" id="4217380">.</span><span class="ident" id="4217381">New</span><span class="op" id="4217384">(</span><span class="string" id="4217385">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4217436">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217453">default</span><span class="op" id="4217460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4217464">err</span>&nbsp;<span class="op" id="4217468">=</span>&nbsp;<span class="ident" id="4217470">errors</span><span class="op" id="4217476">.</span><span class="ident" id="4217477">New</span><span class="op" id="4217480">(</span><span class="string" id="4217481">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4217523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217527">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217539">return</span><br>
<span class="lineno"></span><span class="op" id="4217546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4217549">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4217626">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4217704">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4217783">func</span>&nbsp;<span class="ident" id="4217788">parsePrivateKey</span><span class="op" id="4217803">(</span><span class="ident" id="4217804">der</span>&nbsp;<span class="op" id="4217808">[</span><span class="op" id="4217809">]</span><span class="builtintype" id="4217810">byte</span><span class="op" id="4217814">)</span>&nbsp;<span class="op" id="4217816">(</span><span class="ident" id="4217817">crypto</span><span class="op" id="4217823">.</span><span class="ident" id="4217824">PrivateKey</span><span class="op" id="4217834">,</span>&nbsp;<span class="builtintype" id="4217836">error</span><span class="op" id="4217841">)</span>&nbsp;<span class="op" id="4217843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217846">if</span>&nbsp;<span class="ident" id="4217849">key</span><span class="op" id="4217852">,</span>&nbsp;<span class="ident" id="4217854">err</span>&nbsp;<span class="op" id="4217858">:=</span>&nbsp;<span class="ident" id="4217861">x509</span><span class="op" id="4217865">.</span><span class="ident" id="4217866">ParsePKCS1PrivateKey</span><span class="op" id="4217886">(</span><span class="ident" id="4217887">der</span><span class="op" id="4217890">)</span><span class="op" id="4217891">;</span>&nbsp;<span class="ident" id="4217893">err</span>&nbsp;<span class="op" id="4217897">==</span>&nbsp;<span class="ident" id="4217900">nil</span>&nbsp;<span class="op" id="4217904">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217908">return</span>&nbsp;<span class="ident" id="4217915">key</span><span class="op" id="4217918">,</span>&nbsp;<span class="ident" id="4217920">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4217925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217928">if</span>&nbsp;<span class="ident" id="4217931">key</span><span class="op" id="4217934">,</span>&nbsp;<span class="ident" id="4217936">err</span>&nbsp;<span class="op" id="4217940">:=</span>&nbsp;<span class="ident" id="4217943">x509</span><span class="op" id="4217947">.</span><span class="ident" id="4217948">ParsePKCS8PrivateKey</span><span class="op" id="4217968">(</span><span class="ident" id="4217969">der</span><span class="op" id="4217972">)</span><span class="op" id="4217973">;</span>&nbsp;<span class="ident" id="4217975">err</span>&nbsp;<span class="op" id="4217979">==</span>&nbsp;<span class="ident" id="4217982">nil</span>&nbsp;<span class="op" id="4217986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4217990">switch</span>&nbsp;<span class="ident" id="4217997">key</span>&nbsp;<span class="op" id="4218001">:=</span>&nbsp;<span class="ident" id="4218004">key</span><span class="op" id="4218007">.</span><span class="op" id="4218008">(</span><span class="keyword" id="4218009">type</span><span class="op" id="4218013">)</span>&nbsp;<span class="op" id="4218015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218019">case</span>&nbsp;<span class="op" id="4218024">*</span><span class="ident" id="4218025">rsa</span><span class="op" id="4218028">.</span><span class="ident" id="4218029">PrivateKey</span><span class="op" id="4218039">,</span>&nbsp;<span class="op" id="4218041">*</span><span class="ident" id="4218042">ecdsa</span><span class="op" id="4218047">.</span><span class="ident" id="4218048">PrivateKey</span><span class="op" id="4218058">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218063">return</span>&nbsp;<span class="ident" id="4218070">key</span><span class="op" id="4218073">,</span>&nbsp;<span class="ident" id="4218075">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218081">default</span><span class="op" id="4218088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218093">return</span>&nbsp;<span class="ident" id="4218100">nil</span><span class="op" id="4218103">,</span>&nbsp;<span class="ident" id="4218105">errors</span><span class="op" id="4218111">.</span><span class="ident" id="4218112">New</span><span class="op" id="4218115">(</span><span class="string" id="4218116">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4218179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218186">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218189">if</span>&nbsp;<span class="ident" id="4218192">key</span><span class="op" id="4218195">,</span>&nbsp;<span class="ident" id="4218197">err</span>&nbsp;<span class="op" id="4218201">:=</span>&nbsp;<span class="ident" id="4218204">x509</span><span class="op" id="4218208">.</span><span class="ident" id="4218209">ParseECPrivateKey</span><span class="op" id="4218226">(</span><span class="ident" id="4218227">der</span><span class="op" id="4218230">)</span><span class="op" id="4218231">;</span>&nbsp;<span class="ident" id="4218233">err</span>&nbsp;<span class="op" id="4218237">==</span>&nbsp;<span class="ident" id="4218240">nil</span>&nbsp;<span class="op" id="4218244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218248">return</span>&nbsp;<span class="ident" id="4218255">key</span><span class="op" id="4218258">,</span>&nbsp;<span class="ident" id="4218260">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4218265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4218269">return</span>&nbsp;<span class="ident" id="4218276">nil</span><span class="op" id="4218279">,</span>&nbsp;<span class="ident" id="4218281">errors</span><span class="op" id="4218287">.</span><span class="ident" id="4218288">New</span><span class="op" id="4218291">(</span><span class="string" id="4218292">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4218333">)</span><br>
<span class="lineno">275</span><span class="op" id="4218335">}</span>
</div>
</body>
</html>
