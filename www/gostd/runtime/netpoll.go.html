<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1549429">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1549484">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1549538">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1549589">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549667">package</span>&nbsp;<span class="ident" id="1549675">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1549684">import</span>&nbsp;<span class="string" id="1549691">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1549701">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1549759">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1549842">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1549894">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1549985">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1550014">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1550100">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1550157">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1550236">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1550310">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1550361">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1550442">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1550521">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1550599">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1550685">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1550767">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1550825">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1550920">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1550962">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1550993">const</span>&nbsp;<span class="op" id="1550999">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551002">pdReady</span>&nbsp;<span class="builtintype" id="1551010">uintptr</span>&nbsp;<span class="op" id="1551018">=</span>&nbsp;<span class="num" id="1551020">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551023">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1551031">uintptr</span>&nbsp;<span class="op" id="1551039">=</span>&nbsp;<span class="num" id="1551041">2</span><br>
<span class="lineno"></span><span class="op" id="1551043">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1551046">const</span>&nbsp;<span class="ident" id="1551052">pollBlockSize</span>&nbsp;<span class="op" id="1551066">=</span>&nbsp;<span class="num" id="1551068">4</span>&nbsp;<span class="op" id="1551070">*</span>&nbsp;<span class="num" id="1551072">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1551078">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1551108">type</span>&nbsp;<span class="ident" id="1551113">pollDesc</span>&nbsp;<span class="keyword" id="1551122">struct</span>&nbsp;<span class="op" id="1551129">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551132">link</span>&nbsp;<span class="op" id="1551137">*</span><span class="ident" id="1551138">pollDesc</span>&nbsp;<span class="comment" id="1551147">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551194">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551284">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551381">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtime·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551477">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551556">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551598">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551670">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551723">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551731">mutex</span>&nbsp;<span class="comment" id="1551737">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551772">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1551780">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551789">closing</span>&nbsp;<span class="builtintype" id="1551797">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551803">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1551811">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551826">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551881">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1551889">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551904">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551951">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551959">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551974">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552019">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552027">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552042">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552060">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552068">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552083">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552131">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552139">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552154">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552179">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552187">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552202">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552221">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552229">unsafe</span><span class="op" id="1552235">.</span><span class="ident" id="1552236">Pointer</span>&nbsp;<span class="comment" id="1552244">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1552268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552271">type</span>&nbsp;<span class="ident" id="1552276">pollCache</span>&nbsp;<span class="keyword" id="1552286">struct</span>&nbsp;<span class="op" id="1552293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552296">lock</span>&nbsp;&nbsp;<span class="ident" id="1552302">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552309">first</span>&nbsp;<span class="op" id="1552315">*</span><span class="ident" id="1552316">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552326">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552368">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552428">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552471">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552528">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1552602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552605">var</span>&nbsp;<span class="ident" id="1552609">pollcache</span>&nbsp;<span class="ident" id="1552619">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552630">func</span>&nbsp;<span class="ident" id="1552635">netpollServerInit</span><span class="op" id="1552652">(</span><span class="op" id="1552653">)</span>&nbsp;<span class="op" id="1552655">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552658">onM</span><span class="op" id="1552661">(</span><span class="ident" id="1552662">netpollinit</span><span class="op" id="1552673">)</span><br>
<span class="lineno"></span><span class="op" id="1552675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1552678">func</span>&nbsp;<span class="ident" id="1552683">netpollOpen</span><span class="op" id="1552694">(</span><span class="ident" id="1552695">fd</span>&nbsp;<span class="builtintype" id="1552698">uintptr</span><span class="op" id="1552705">)</span>&nbsp;<span class="op" id="1552707">(</span><span class="op" id="1552708">*</span><span class="ident" id="1552709">pollDesc</span><span class="op" id="1552717">,</span>&nbsp;<span class="builtintype" id="1552719">int</span><span class="op" id="1552722">)</span>&nbsp;<span class="op" id="1552724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552727">pd</span>&nbsp;<span class="op" id="1552730">:=</span>&nbsp;<span class="ident" id="1552733">pollcache</span><span class="op" id="1552742">.</span><span class="ident" id="1552743">alloc</span><span class="op" id="1552748">(</span><span class="op" id="1552749">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552752">lock</span><span class="op" id="1552756">(</span><span class="op" id="1552757">&amp;</span><span class="ident" id="1552758">pd</span><span class="op" id="1552760">.</span><span class="ident" id="1552761">lock</span><span class="op" id="1552765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552768">if</span>&nbsp;<span class="ident" id="1552771">pd</span><span class="op" id="1552773">.</span><span class="ident" id="1552774">wg</span>&nbsp;<span class="op" id="1552777">!=</span>&nbsp;<span class="num" id="1552780">0</span>&nbsp;<span class="op" id="1552782">&amp;&amp;</span>&nbsp;<span class="ident" id="1552785">pd</span><span class="op" id="1552787">.</span><span class="ident" id="1552788">wg</span>&nbsp;<span class="op" id="1552791">!=</span>&nbsp;<span class="ident" id="1552794">pdReady</span>&nbsp;<span class="op" id="1552802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552806">gothrow</span><span class="op" id="1552813">(</span><span class="string" id="1552814">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1552861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552867">if</span>&nbsp;<span class="ident" id="1552870">pd</span><span class="op" id="1552872">.</span><span class="ident" id="1552873">rg</span>&nbsp;<span class="op" id="1552876">!=</span>&nbsp;<span class="num" id="1552879">0</span>&nbsp;<span class="op" id="1552881">&amp;&amp;</span>&nbsp;<span class="ident" id="1552884">pd</span><span class="op" id="1552886">.</span><span class="ident" id="1552887">rg</span>&nbsp;<span class="op" id="1552890">!=</span>&nbsp;<span class="ident" id="1552893">pdReady</span>&nbsp;<span class="op" id="1552901">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552905">gothrow</span><span class="op" id="1552912">(</span><span class="string" id="1552913">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1552959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552965">pd</span><span class="op" id="1552967">.</span><span class="ident" id="1552968">fd</span>&nbsp;<span class="op" id="1552971">=</span>&nbsp;<span class="ident" id="1552973">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552977">pd</span><span class="op" id="1552979">.</span><span class="ident" id="1552980">closing</span>&nbsp;<span class="op" id="1552988">=</span>&nbsp;<span class="builtintype" id="1552990">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552997">pd</span><span class="op" id="1552999">.</span><span class="ident" id="1553000">seq</span><span class="op" id="1553003">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553007">pd</span><span class="op" id="1553009">.</span><span class="ident" id="1553010">rg</span>&nbsp;<span class="op" id="1553013">=</span>&nbsp;<span class="num" id="1553015">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553018">pd</span><span class="op" id="1553020">.</span><span class="ident" id="1553021">rd</span>&nbsp;<span class="op" id="1553024">=</span>&nbsp;<span class="num" id="1553026">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553029">pd</span><span class="op" id="1553031">.</span><span class="ident" id="1553032">wg</span>&nbsp;<span class="op" id="1553035">=</span>&nbsp;<span class="num" id="1553037">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553040">pd</span><span class="op" id="1553042">.</span><span class="ident" id="1553043">wd</span>&nbsp;<span class="op" id="1553046">=</span>&nbsp;<span class="num" id="1553048">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553051">unlock</span><span class="op" id="1553057">(</span><span class="op" id="1553058">&amp;</span><span class="ident" id="1553059">pd</span><span class="op" id="1553061">.</span><span class="ident" id="1553062">lock</span><span class="op" id="1553066">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553070">var</span>&nbsp;<span class="ident" id="1553074">errno</span>&nbsp;<span class="builtintype" id="1553080">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553087">onM</span><span class="op" id="1553090">(</span><span class="keyword" id="1553091">func</span><span class="op" id="1553095">(</span><span class="op" id="1553096">)</span>&nbsp;<span class="op" id="1553098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553102">errno</span>&nbsp;<span class="op" id="1553108">=</span>&nbsp;<span class="ident" id="1553110">netpollopen</span><span class="op" id="1553121">(</span><span class="ident" id="1553122">fd</span><span class="op" id="1553124">,</span>&nbsp;<span class="ident" id="1553126">pd</span><span class="op" id="1553128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553131">}</span><span class="op" id="1553132">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553135">return</span>&nbsp;<span class="ident" id="1553142">pd</span><span class="op" id="1553144">,</span>&nbsp;<span class="builtintype" id="1553146">int</span><span class="op" id="1553149">(</span><span class="ident" id="1553150">errno</span><span class="op" id="1553155">)</span><br>
<span class="lineno"></span><span class="op" id="1553157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553160">func</span>&nbsp;<span class="ident" id="1553165">netpollClose</span><span class="op" id="1553177">(</span><span class="ident" id="1553178">pd</span>&nbsp;<span class="op" id="1553181">*</span><span class="ident" id="1553182">pollDesc</span><span class="op" id="1553190">)</span>&nbsp;<span class="op" id="1553192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553195">if</span>&nbsp;<span class="op" id="1553198">!</span><span class="ident" id="1553199">pd</span><span class="op" id="1553201">.</span><span class="ident" id="1553202">closing</span>&nbsp;<span class="op" id="1553210">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553214">gothrow</span><span class="op" id="1553221">(</span><span class="string" id="1553222">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1553255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553261">if</span>&nbsp;<span class="ident" id="1553264">pd</span><span class="op" id="1553266">.</span><span class="ident" id="1553267">wg</span>&nbsp;<span class="op" id="1553270">!=</span>&nbsp;<span class="num" id="1553273">0</span>&nbsp;<span class="op" id="1553275">&amp;&amp;</span>&nbsp;<span class="ident" id="1553278">pd</span><span class="op" id="1553280">.</span><span class="ident" id="1553281">wg</span>&nbsp;<span class="op" id="1553284">!=</span>&nbsp;<span class="ident" id="1553287">pdReady</span>&nbsp;<span class="op" id="1553295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553299">gothrow</span><span class="op" id="1553306">(</span><span class="string" id="1553307">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1553358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553361">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553364">if</span>&nbsp;<span class="ident" id="1553367">pd</span><span class="op" id="1553369">.</span><span class="ident" id="1553370">rg</span>&nbsp;<span class="op" id="1553373">!=</span>&nbsp;<span class="num" id="1553376">0</span>&nbsp;<span class="op" id="1553378">&amp;&amp;</span>&nbsp;<span class="ident" id="1553381">pd</span><span class="op" id="1553383">.</span><span class="ident" id="1553384">rg</span>&nbsp;<span class="op" id="1553387">!=</span>&nbsp;<span class="ident" id="1553390">pdReady</span>&nbsp;<span class="op" id="1553398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553402">gothrow</span><span class="op" id="1553409">(</span><span class="string" id="1553410">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1553460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553466">onM</span><span class="op" id="1553469">(</span><span class="keyword" id="1553470">func</span><span class="op" id="1553474">(</span><span class="op" id="1553475">)</span>&nbsp;<span class="op" id="1553477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553481">netpollclose</span><span class="op" id="1553493">(</span><span class="builtintype" id="1553494">uintptr</span><span class="op" id="1553501">(</span><span class="ident" id="1553502">pd</span><span class="op" id="1553504">.</span><span class="ident" id="1553505">fd</span><span class="op" id="1553507">)</span><span class="op" id="1553508">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553511">}</span><span class="op" id="1553512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553515">pollcache</span><span class="op" id="1553524">.</span><span class="ident" id="1553525">free</span><span class="op" id="1553529">(</span><span class="ident" id="1553530">pd</span><span class="op" id="1553532">)</span><br>
<span class="lineno"></span><span class="op" id="1553534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553537">func</span>&nbsp;<span class="op" id="1553542">(</span><span class="ident" id="1553543">c</span>&nbsp;<span class="op" id="1553545">*</span><span class="ident" id="1553546">pollCache</span><span class="op" id="1553555">)</span>&nbsp;<span class="ident" id="1553557">free</span><span class="op" id="1553561">(</span><span class="ident" id="1553562">pd</span>&nbsp;<span class="op" id="1553565">*</span><span class="ident" id="1553566">pollDesc</span><span class="op" id="1553574">)</span>&nbsp;<span class="op" id="1553576">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553579">lock</span><span class="op" id="1553583">(</span><span class="op" id="1553584">&amp;</span><span class="ident" id="1553585">c</span><span class="op" id="1553586">.</span><span class="ident" id="1553587">lock</span><span class="op" id="1553591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553594">pd</span><span class="op" id="1553596">.</span><span class="ident" id="1553597">link</span>&nbsp;<span class="op" id="1553602">=</span>&nbsp;<span class="ident" id="1553604">c</span><span class="op" id="1553605">.</span><span class="ident" id="1553606">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553613">c</span><span class="op" id="1553614">.</span><span class="ident" id="1553615">first</span>&nbsp;<span class="op" id="1553621">=</span>&nbsp;<span class="ident" id="1553623">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553627">unlock</span><span class="op" id="1553633">(</span><span class="op" id="1553634">&amp;</span><span class="ident" id="1553635">c</span><span class="op" id="1553636">.</span><span class="ident" id="1553637">lock</span><span class="op" id="1553641">)</span><br>
<span class="lineno"></span><span class="op" id="1553643">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1553646">func</span>&nbsp;<span class="ident" id="1553651">netpollReset</span><span class="op" id="1553663">(</span><span class="ident" id="1553664">pd</span>&nbsp;<span class="op" id="1553667">*</span><span class="ident" id="1553668">pollDesc</span><span class="op" id="1553676">,</span>&nbsp;<span class="ident" id="1553678">mode</span>&nbsp;<span class="builtintype" id="1553683">int</span><span class="op" id="1553686">)</span>&nbsp;<span class="builtintype" id="1553688">int</span>&nbsp;<span class="op" id="1553692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553695">err</span>&nbsp;<span class="op" id="1553699">:=</span>&nbsp;<span class="ident" id="1553702">netpollcheckerr</span><span class="op" id="1553717">(</span><span class="ident" id="1553718">pd</span><span class="op" id="1553720">,</span>&nbsp;<span class="builtintype" id="1553722">int32</span><span class="op" id="1553727">(</span><span class="ident" id="1553728">mode</span><span class="op" id="1553732">)</span><span class="op" id="1553733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553736">if</span>&nbsp;<span class="ident" id="1553739">err</span>&nbsp;<span class="op" id="1553743">!=</span>&nbsp;<span class="num" id="1553746">0</span>&nbsp;<span class="op" id="1553748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553752">return</span>&nbsp;<span class="ident" id="1553759">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553767">if</span>&nbsp;<span class="ident" id="1553770">mode</span>&nbsp;<span class="op" id="1553775">==</span>&nbsp;<span class="string" id="1553778">&#39;r&#39;</span>&nbsp;<span class="op" id="1553782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553786">pd</span><span class="op" id="1553788">.</span><span class="ident" id="1553789">rg</span>&nbsp;<span class="op" id="1553792">=</span>&nbsp;<span class="num" id="1553794">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553797">}</span>&nbsp;<span class="keyword" id="1553799">else</span>&nbsp;<span class="keyword" id="1553804">if</span>&nbsp;<span class="ident" id="1553807">mode</span>&nbsp;<span class="op" id="1553812">==</span>&nbsp;<span class="string" id="1553815">&#39;w&#39;</span>&nbsp;<span class="op" id="1553819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553823">pd</span><span class="op" id="1553825">.</span><span class="ident" id="1553826">wg</span>&nbsp;<span class="op" id="1553829">=</span>&nbsp;<span class="num" id="1553831">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553837">return</span>&nbsp;<span class="num" id="1553844">0</span><br>
<span class="lineno"></span><span class="op" id="1553846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1553849">func</span>&nbsp;<span class="ident" id="1553854">netpollWait</span><span class="op" id="1553865">(</span><span class="ident" id="1553866">pd</span>&nbsp;<span class="op" id="1553869">*</span><span class="ident" id="1553870">pollDesc</span><span class="op" id="1553878">,</span>&nbsp;<span class="ident" id="1553880">mode</span>&nbsp;<span class="builtintype" id="1553885">int</span><span class="op" id="1553888">)</span>&nbsp;<span class="builtintype" id="1553890">int</span>&nbsp;<span class="op" id="1553894">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553897">err</span>&nbsp;<span class="op" id="1553901">:=</span>&nbsp;<span class="ident" id="1553904">netpollcheckerr</span><span class="op" id="1553919">(</span><span class="ident" id="1553920">pd</span><span class="op" id="1553922">,</span>&nbsp;<span class="builtintype" id="1553924">int32</span><span class="op" id="1553929">(</span><span class="ident" id="1553930">mode</span><span class="op" id="1553934">)</span><span class="op" id="1553935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553938">if</span>&nbsp;<span class="ident" id="1553941">err</span>&nbsp;<span class="op" id="1553945">!=</span>&nbsp;<span class="num" id="1553948">0</span>&nbsp;<span class="op" id="1553950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553954">return</span>&nbsp;<span class="ident" id="1553961">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1553969">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554022">if</span>&nbsp;<span class="ident" id="1554025">GOOS</span>&nbsp;<span class="op" id="1554030">==</span>&nbsp;<span class="string" id="1554033">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1554043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554047">onM</span><span class="op" id="1554050">(</span><span class="keyword" id="1554051">func</span><span class="op" id="1554055">(</span><span class="op" id="1554056">)</span>&nbsp;<span class="op" id="1554058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554063">netpollarm</span><span class="op" id="1554073">(</span><span class="ident" id="1554074">pd</span><span class="op" id="1554076">,</span>&nbsp;<span class="ident" id="1554078">mode</span><span class="op" id="1554082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554086">}</span><span class="op" id="1554087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554090">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554093">for</span>&nbsp;<span class="op" id="1554097">!</span><span class="ident" id="1554098">netpollblock</span><span class="op" id="1554110">(</span><span class="ident" id="1554111">pd</span><span class="op" id="1554113">,</span>&nbsp;<span class="builtintype" id="1554115">int32</span><span class="op" id="1554120">(</span><span class="ident" id="1554121">mode</span><span class="op" id="1554125">)</span><span class="op" id="1554126">,</span>&nbsp;<span class="builtintype" id="1554128">false</span><span class="op" id="1554133">)</span>&nbsp;<span class="op" id="1554135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554139">err</span>&nbsp;<span class="op" id="1554143">=</span>&nbsp;<span class="ident" id="1554145">netpollcheckerr</span><span class="op" id="1554160">(</span><span class="ident" id="1554161">pd</span><span class="op" id="1554163">,</span>&nbsp;<span class="builtintype" id="1554165">int32</span><span class="op" id="1554170">(</span><span class="ident" id="1554171">mode</span><span class="op" id="1554175">)</span><span class="op" id="1554176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554180">if</span>&nbsp;<span class="ident" id="1554183">err</span>&nbsp;<span class="op" id="1554187">!=</span>&nbsp;<span class="num" id="1554190">0</span>&nbsp;<span class="op" id="1554192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554197">return</span>&nbsp;<span class="ident" id="1554204">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554210">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554214">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554269">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554333">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554379">return</span>&nbsp;<span class="num" id="1554386">0</span><br>
<span class="lineno">160</span><span class="op" id="1554388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1554391">func</span>&nbsp;<span class="ident" id="1554396">netpollWaitCanceled</span><span class="op" id="1554415">(</span><span class="ident" id="1554416">pd</span>&nbsp;<span class="op" id="1554419">*</span><span class="ident" id="1554420">pollDesc</span><span class="op" id="1554428">,</span>&nbsp;<span class="ident" id="1554430">mode</span>&nbsp;<span class="builtintype" id="1554435">int</span><span class="op" id="1554438">)</span>&nbsp;<span class="op" id="1554440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554443">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554518">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554598">for</span>&nbsp;<span class="op" id="1554602">!</span><span class="ident" id="1554603">netpollblock</span><span class="op" id="1554615">(</span><span class="ident" id="1554616">pd</span><span class="op" id="1554618">,</span>&nbsp;<span class="builtintype" id="1554620">int32</span><span class="op" id="1554625">(</span><span class="ident" id="1554626">mode</span><span class="op" id="1554630">)</span><span class="op" id="1554631">,</span>&nbsp;<span class="builtintype" id="1554633">true</span><span class="op" id="1554637">)</span>&nbsp;<span class="op" id="1554639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554642">}</span><br>
<span class="lineno"></span><span class="op" id="1554644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1554647">func</span>&nbsp;<span class="ident" id="1554652">netpollSetDeadline</span><span class="op" id="1554670">(</span><span class="ident" id="1554671">pd</span>&nbsp;<span class="op" id="1554674">*</span><span class="ident" id="1554675">pollDesc</span><span class="op" id="1554683">,</span>&nbsp;<span class="ident" id="1554685">d</span>&nbsp;<span class="builtintype" id="1554687">int64</span><span class="op" id="1554692">,</span>&nbsp;<span class="ident" id="1554694">mode</span>&nbsp;<span class="builtintype" id="1554699">int</span><span class="op" id="1554702">)</span>&nbsp;<span class="op" id="1554704">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554707">lock</span><span class="op" id="1554711">(</span><span class="op" id="1554712">&amp;</span><span class="ident" id="1554713">pd</span><span class="op" id="1554715">.</span><span class="ident" id="1554716">lock</span><span class="op" id="1554720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554723">if</span>&nbsp;<span class="ident" id="1554726">pd</span><span class="op" id="1554728">.</span><span class="ident" id="1554729">closing</span>&nbsp;<span class="op" id="1554737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554741">unlock</span><span class="op" id="1554747">(</span><span class="op" id="1554748">&amp;</span><span class="ident" id="1554749">pd</span><span class="op" id="1554751">.</span><span class="ident" id="1554752">lock</span><span class="op" id="1554756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554760">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554768">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554771">pd</span><span class="op" id="1554773">.</span><span class="ident" id="1554774">seq</span><span class="op" id="1554777">++</span>&nbsp;<span class="comment" id="1554780">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554810">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554836">if</span>&nbsp;<span class="ident" id="1554839">pd</span><span class="op" id="1554841">.</span><span class="ident" id="1554842">rt</span><span class="op" id="1554844">.</span><span class="ident" id="1554845">f</span>&nbsp;<span class="op" id="1554847">!=</span>&nbsp;<span class="builtintype" id="1554850">nil</span>&nbsp;<span class="op" id="1554854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554858">deltimer</span><span class="op" id="1554866">(</span><span class="op" id="1554867">&amp;</span><span class="ident" id="1554868">pd</span><span class="op" id="1554870">.</span><span class="ident" id="1554871">rt</span><span class="op" id="1554873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554877">pd</span><span class="op" id="1554879">.</span><span class="ident" id="1554880">rt</span><span class="op" id="1554882">.</span><span class="ident" id="1554883">f</span>&nbsp;<span class="op" id="1554885">=</span>&nbsp;<span class="builtintype" id="1554887">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554895">if</span>&nbsp;<span class="ident" id="1554898">pd</span><span class="op" id="1554900">.</span><span class="ident" id="1554901">wt</span><span class="op" id="1554903">.</span><span class="ident" id="1554904">f</span>&nbsp;<span class="op" id="1554906">!=</span>&nbsp;<span class="builtintype" id="1554909">nil</span>&nbsp;<span class="op" id="1554913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554917">deltimer</span><span class="op" id="1554925">(</span><span class="op" id="1554926">&amp;</span><span class="ident" id="1554927">pd</span><span class="op" id="1554929">.</span><span class="ident" id="1554930">wt</span><span class="op" id="1554932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554936">pd</span><span class="op" id="1554938">.</span><span class="ident" id="1554939">wt</span><span class="op" id="1554941">.</span><span class="ident" id="1554942">f</span>&nbsp;<span class="op" id="1554944">=</span>&nbsp;<span class="builtintype" id="1554946">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554951">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554954">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554976">if</span>&nbsp;<span class="ident" id="1554979">d</span>&nbsp;<span class="op" id="1554981">!=</span>&nbsp;<span class="num" id="1554984">0</span>&nbsp;<span class="op" id="1554986">&amp;&amp;</span>&nbsp;<span class="ident" id="1554989">d</span>&nbsp;<span class="op" id="1554991">&lt;=</span>&nbsp;<span class="ident" id="1554994">nanotime</span><span class="op" id="1555002">(</span><span class="op" id="1555003">)</span>&nbsp;<span class="op" id="1555005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555009">d</span>&nbsp;<span class="op" id="1555011">=</span>&nbsp;<span class="op" id="1555013">-</span><span class="num" id="1555014">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555020">if</span>&nbsp;<span class="ident" id="1555023">mode</span>&nbsp;<span class="op" id="1555028">==</span>&nbsp;<span class="string" id="1555031">&#39;r&#39;</span>&nbsp;<span class="op" id="1555035">||</span>&nbsp;<span class="ident" id="1555038">mode</span>&nbsp;<span class="op" id="1555043">==</span>&nbsp;<span class="string" id="1555046">&#39;r&#39;</span><span class="op" id="1555049">+</span><span class="string" id="1555050">&#39;w&#39;</span>&nbsp;<span class="op" id="1555054">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555058">pd</span><span class="op" id="1555060">.</span><span class="ident" id="1555061">rd</span>&nbsp;<span class="op" id="1555064">=</span>&nbsp;<span class="ident" id="1555066">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555072">if</span>&nbsp;<span class="ident" id="1555075">mode</span>&nbsp;<span class="op" id="1555080">==</span>&nbsp;<span class="string" id="1555083">&#39;w&#39;</span>&nbsp;<span class="op" id="1555087">||</span>&nbsp;<span class="ident" id="1555090">mode</span>&nbsp;<span class="op" id="1555095">==</span>&nbsp;<span class="string" id="1555098">&#39;r&#39;</span><span class="op" id="1555101">+</span><span class="string" id="1555102">&#39;w&#39;</span>&nbsp;<span class="op" id="1555106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555110">pd</span><span class="op" id="1555112">.</span><span class="ident" id="1555113">wd</span>&nbsp;<span class="op" id="1555116">=</span>&nbsp;<span class="ident" id="1555118">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555121">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555124">if</span>&nbsp;<span class="ident" id="1555127">pd</span><span class="op" id="1555129">.</span><span class="ident" id="1555130">rd</span>&nbsp;<span class="op" id="1555133">&gt;</span>&nbsp;<span class="num" id="1555135">0</span>&nbsp;<span class="op" id="1555137">&amp;&amp;</span>&nbsp;<span class="ident" id="1555140">pd</span><span class="op" id="1555142">.</span><span class="ident" id="1555143">rd</span>&nbsp;<span class="op" id="1555146">==</span>&nbsp;<span class="ident" id="1555149">pd</span><span class="op" id="1555151">.</span><span class="ident" id="1555152">wd</span>&nbsp;<span class="op" id="1555155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555159">pd</span><span class="op" id="1555161">.</span><span class="ident" id="1555162">rt</span><span class="op" id="1555164">.</span><span class="ident" id="1555165">f</span>&nbsp;<span class="op" id="1555167">=</span>&nbsp;<span class="ident" id="1555169">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555187">pd</span><span class="op" id="1555189">.</span><span class="ident" id="1555190">rt</span><span class="op" id="1555192">.</span><span class="ident" id="1555193">when</span>&nbsp;<span class="op" id="1555198">=</span>&nbsp;<span class="ident" id="1555200">pd</span><span class="op" id="1555202">.</span><span class="ident" id="1555203">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555208">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555250">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555317">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555385">pd</span><span class="op" id="1555387">.</span><span class="ident" id="1555388">rt</span><span class="op" id="1555390">.</span><span class="ident" id="1555391">arg</span>&nbsp;<span class="op" id="1555395">=</span>&nbsp;<span class="ident" id="1555397">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555402">pd</span><span class="op" id="1555404">.</span><span class="ident" id="1555405">rt</span><span class="op" id="1555407">.</span><span class="ident" id="1555408">seq</span>&nbsp;<span class="op" id="1555412">=</span>&nbsp;<span class="ident" id="1555414">pd</span><span class="op" id="1555416">.</span><span class="ident" id="1555417">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555423">addtimer</span><span class="op" id="1555431">(</span><span class="op" id="1555432">&amp;</span><span class="ident" id="1555433">pd</span><span class="op" id="1555435">.</span><span class="ident" id="1555436">rt</span><span class="op" id="1555438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555441">}</span>&nbsp;<span class="keyword" id="1555443">else</span>&nbsp;<span class="op" id="1555448">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555452">if</span>&nbsp;<span class="ident" id="1555455">pd</span><span class="op" id="1555457">.</span><span class="ident" id="1555458">rd</span>&nbsp;<span class="op" id="1555461">&gt;</span>&nbsp;<span class="num" id="1555463">0</span>&nbsp;<span class="op" id="1555465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555470">pd</span><span class="op" id="1555472">.</span><span class="ident" id="1555473">rt</span><span class="op" id="1555475">.</span><span class="ident" id="1555476">f</span>&nbsp;<span class="op" id="1555478">=</span>&nbsp;<span class="ident" id="1555480">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555503">pd</span><span class="op" id="1555505">.</span><span class="ident" id="1555506">rt</span><span class="op" id="1555508">.</span><span class="ident" id="1555509">when</span>&nbsp;<span class="op" id="1555514">=</span>&nbsp;<span class="ident" id="1555516">pd</span><span class="op" id="1555518">.</span><span class="ident" id="1555519">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555525">pd</span><span class="op" id="1555527">.</span><span class="ident" id="1555528">rt</span><span class="op" id="1555530">.</span><span class="ident" id="1555531">arg</span>&nbsp;<span class="op" id="1555535">=</span>&nbsp;<span class="ident" id="1555537">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555543">pd</span><span class="op" id="1555545">.</span><span class="ident" id="1555546">rt</span><span class="op" id="1555548">.</span><span class="ident" id="1555549">seq</span>&nbsp;<span class="op" id="1555553">=</span>&nbsp;<span class="ident" id="1555555">pd</span><span class="op" id="1555557">.</span><span class="ident" id="1555558">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555565">addtimer</span><span class="op" id="1555573">(</span><span class="op" id="1555574">&amp;</span><span class="ident" id="1555575">pd</span><span class="op" id="1555577">.</span><span class="ident" id="1555578">rt</span><span class="op" id="1555580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555588">if</span>&nbsp;<span class="ident" id="1555591">pd</span><span class="op" id="1555593">.</span><span class="ident" id="1555594">wd</span>&nbsp;<span class="op" id="1555597">&gt;</span>&nbsp;<span class="num" id="1555599">0</span>&nbsp;<span class="op" id="1555601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555606">pd</span><span class="op" id="1555608">.</span><span class="ident" id="1555609">wt</span><span class="op" id="1555611">.</span><span class="ident" id="1555612">f</span>&nbsp;<span class="op" id="1555614">=</span>&nbsp;<span class="ident" id="1555616">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555640">pd</span><span class="op" id="1555642">.</span><span class="ident" id="1555643">wt</span><span class="op" id="1555645">.</span><span class="ident" id="1555646">when</span>&nbsp;<span class="op" id="1555651">=</span>&nbsp;<span class="ident" id="1555653">pd</span><span class="op" id="1555655">.</span><span class="ident" id="1555656">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555662">pd</span><span class="op" id="1555664">.</span><span class="ident" id="1555665">wt</span><span class="op" id="1555667">.</span><span class="ident" id="1555668">arg</span>&nbsp;<span class="op" id="1555672">=</span>&nbsp;<span class="ident" id="1555674">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555680">pd</span><span class="op" id="1555682">.</span><span class="ident" id="1555683">wt</span><span class="op" id="1555685">.</span><span class="ident" id="1555686">seq</span>&nbsp;<span class="op" id="1555690">=</span>&nbsp;<span class="ident" id="1555692">pd</span><span class="op" id="1555694">.</span><span class="ident" id="1555695">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555702">addtimer</span><span class="op" id="1555710">(</span><span class="op" id="1555711">&amp;</span><span class="ident" id="1555712">pd</span><span class="op" id="1555714">.</span><span class="ident" id="1555715">wt</span><span class="op" id="1555717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555724">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555727">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555808">var</span>&nbsp;<span class="ident" id="1555812">rg</span><span class="op" id="1555814">,</span>&nbsp;<span class="ident" id="1555816">wg</span>&nbsp;<span class="op" id="1555819">*</span><span class="ident" id="1555820">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555823">atomicstorep</span><span class="op" id="1555835">(</span><span class="ident" id="1555836">unsafe</span><span class="op" id="1555842">.</span><span class="ident" id="1555843">Pointer</span><span class="op" id="1555850">(</span><span class="op" id="1555851">&amp;</span><span class="ident" id="1555852">wg</span><span class="op" id="1555854">)</span><span class="op" id="1555855">,</span>&nbsp;<span class="builtintype" id="1555857">nil</span><span class="op" id="1555860">)</span>&nbsp;<span class="comment" id="1555862">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555946">if</span>&nbsp;<span class="ident" id="1555949">pd</span><span class="op" id="1555951">.</span><span class="ident" id="1555952">rd</span>&nbsp;<span class="op" id="1555955">&lt;</span>&nbsp;<span class="num" id="1555957">0</span>&nbsp;<span class="op" id="1555959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555963">rg</span>&nbsp;<span class="op" id="1555966">=</span>&nbsp;<span class="ident" id="1555968">netpollunblock</span><span class="op" id="1555982">(</span><span class="ident" id="1555983">pd</span><span class="op" id="1555985">,</span>&nbsp;<span class="string" id="1555987">&#39;r&#39;</span><span class="op" id="1555990">,</span>&nbsp;<span class="builtintype" id="1555992">false</span><span class="op" id="1555997">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556003">if</span>&nbsp;<span class="ident" id="1556006">pd</span><span class="op" id="1556008">.</span><span class="ident" id="1556009">wd</span>&nbsp;<span class="op" id="1556012">&lt;</span>&nbsp;<span class="num" id="1556014">0</span>&nbsp;<span class="op" id="1556016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556020">wg</span>&nbsp;<span class="op" id="1556023">=</span>&nbsp;<span class="ident" id="1556025">netpollunblock</span><span class="op" id="1556039">(</span><span class="ident" id="1556040">pd</span><span class="op" id="1556042">,</span>&nbsp;<span class="string" id="1556044">&#39;w&#39;</span><span class="op" id="1556047">,</span>&nbsp;<span class="builtintype" id="1556049">false</span><span class="op" id="1556054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556060">unlock</span><span class="op" id="1556066">(</span><span class="op" id="1556067">&amp;</span><span class="ident" id="1556068">pd</span><span class="op" id="1556070">.</span><span class="ident" id="1556071">lock</span><span class="op" id="1556075">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556078">if</span>&nbsp;<span class="ident" id="1556081">rg</span>&nbsp;<span class="op" id="1556084">!=</span>&nbsp;<span class="builtintype" id="1556087">nil</span>&nbsp;<span class="op" id="1556091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556095">goready</span><span class="op" id="1556102">(</span><span class="ident" id="1556103">rg</span><span class="op" id="1556105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556111">if</span>&nbsp;<span class="ident" id="1556114">wg</span>&nbsp;<span class="op" id="1556117">!=</span>&nbsp;<span class="builtintype" id="1556120">nil</span>&nbsp;<span class="op" id="1556124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556128">goready</span><span class="op" id="1556135">(</span><span class="ident" id="1556136">wg</span><span class="op" id="1556138">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556141">}</span><br>
<span class="lineno"></span><span class="op" id="1556143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556146">func</span>&nbsp;<span class="ident" id="1556151">netpollUnblock</span><span class="op" id="1556165">(</span><span class="ident" id="1556166">pd</span>&nbsp;<span class="op" id="1556169">*</span><span class="ident" id="1556170">pollDesc</span><span class="op" id="1556178">)</span>&nbsp;<span class="op" id="1556180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556183">lock</span><span class="op" id="1556187">(</span><span class="op" id="1556188">&amp;</span><span class="ident" id="1556189">pd</span><span class="op" id="1556191">.</span><span class="ident" id="1556192">lock</span><span class="op" id="1556196">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556199">if</span>&nbsp;<span class="ident" id="1556202">pd</span><span class="op" id="1556204">.</span><span class="ident" id="1556205">closing</span>&nbsp;<span class="op" id="1556213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556217">gothrow</span><span class="op" id="1556224">(</span><span class="string" id="1556225">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1556258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556264">pd</span><span class="op" id="1556266">.</span><span class="ident" id="1556267">closing</span>&nbsp;<span class="op" id="1556275">=</span>&nbsp;<span class="builtintype" id="1556277">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556283">pd</span><span class="op" id="1556285">.</span><span class="ident" id="1556286">seq</span><span class="op" id="1556289">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556293">var</span>&nbsp;<span class="ident" id="1556297">rg</span><span class="op" id="1556299">,</span>&nbsp;<span class="ident" id="1556301">wg</span>&nbsp;<span class="op" id="1556304">*</span><span class="ident" id="1556305">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556308">atomicstorep</span><span class="op" id="1556320">(</span><span class="ident" id="1556321">unsafe</span><span class="op" id="1556327">.</span><span class="ident" id="1556328">Pointer</span><span class="op" id="1556335">(</span><span class="op" id="1556336">&amp;</span><span class="ident" id="1556337">rg</span><span class="op" id="1556339">)</span><span class="op" id="1556340">,</span>&nbsp;<span class="builtintype" id="1556342">nil</span><span class="op" id="1556345">)</span>&nbsp;<span class="comment" id="1556347">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556432">rg</span>&nbsp;<span class="op" id="1556435">=</span>&nbsp;<span class="ident" id="1556437">netpollunblock</span><span class="op" id="1556451">(</span><span class="ident" id="1556452">pd</span><span class="op" id="1556454">,</span>&nbsp;<span class="string" id="1556456">&#39;r&#39;</span><span class="op" id="1556459">,</span>&nbsp;<span class="builtintype" id="1556461">false</span><span class="op" id="1556466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556469">wg</span>&nbsp;<span class="op" id="1556472">=</span>&nbsp;<span class="ident" id="1556474">netpollunblock</span><span class="op" id="1556488">(</span><span class="ident" id="1556489">pd</span><span class="op" id="1556491">,</span>&nbsp;<span class="string" id="1556493">&#39;w&#39;</span><span class="op" id="1556496">,</span>&nbsp;<span class="builtintype" id="1556498">false</span><span class="op" id="1556503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556506">if</span>&nbsp;<span class="ident" id="1556509">pd</span><span class="op" id="1556511">.</span><span class="ident" id="1556512">rt</span><span class="op" id="1556514">.</span><span class="ident" id="1556515">f</span>&nbsp;<span class="op" id="1556517">!=</span>&nbsp;<span class="builtintype" id="1556520">nil</span>&nbsp;<span class="op" id="1556524">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556528">deltimer</span><span class="op" id="1556536">(</span><span class="op" id="1556537">&amp;</span><span class="ident" id="1556538">pd</span><span class="op" id="1556540">.</span><span class="ident" id="1556541">rt</span><span class="op" id="1556543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556547">pd</span><span class="op" id="1556549">.</span><span class="ident" id="1556550">rt</span><span class="op" id="1556552">.</span><span class="ident" id="1556553">f</span>&nbsp;<span class="op" id="1556555">=</span>&nbsp;<span class="builtintype" id="1556557">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556565">if</span>&nbsp;<span class="ident" id="1556568">pd</span><span class="op" id="1556570">.</span><span class="ident" id="1556571">wt</span><span class="op" id="1556573">.</span><span class="ident" id="1556574">f</span>&nbsp;<span class="op" id="1556576">!=</span>&nbsp;<span class="builtintype" id="1556579">nil</span>&nbsp;<span class="op" id="1556583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556587">deltimer</span><span class="op" id="1556595">(</span><span class="op" id="1556596">&amp;</span><span class="ident" id="1556597">pd</span><span class="op" id="1556599">.</span><span class="ident" id="1556600">wt</span><span class="op" id="1556602">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556606">pd</span><span class="op" id="1556608">.</span><span class="ident" id="1556609">wt</span><span class="op" id="1556611">.</span><span class="ident" id="1556612">f</span>&nbsp;<span class="op" id="1556614">=</span>&nbsp;<span class="builtintype" id="1556616">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556624">unlock</span><span class="op" id="1556630">(</span><span class="op" id="1556631">&amp;</span><span class="ident" id="1556632">pd</span><span class="op" id="1556634">.</span><span class="ident" id="1556635">lock</span><span class="op" id="1556639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556642">if</span>&nbsp;<span class="ident" id="1556645">rg</span>&nbsp;<span class="op" id="1556648">!=</span>&nbsp;<span class="builtintype" id="1556651">nil</span>&nbsp;<span class="op" id="1556655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556659">goready</span><span class="op" id="1556666">(</span><span class="ident" id="1556667">rg</span><span class="op" id="1556669">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556675">if</span>&nbsp;<span class="ident" id="1556678">wg</span>&nbsp;<span class="op" id="1556681">!=</span>&nbsp;<span class="builtintype" id="1556684">nil</span>&nbsp;<span class="op" id="1556688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556692">goready</span><span class="op" id="1556699">(</span><span class="ident" id="1556700">wg</span><span class="op" id="1556702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556705">}</span><br>
<span class="lineno"></span><span class="op" id="1556707">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1556710">func</span>&nbsp;<span class="ident" id="1556715">netpollfd</span><span class="op" id="1556724">(</span><span class="ident" id="1556725">pd</span>&nbsp;<span class="op" id="1556728">*</span><span class="ident" id="1556729">pollDesc</span><span class="op" id="1556737">)</span>&nbsp;<span class="builtintype" id="1556739">uintptr</span>&nbsp;<span class="op" id="1556747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556750">return</span>&nbsp;<span class="ident" id="1556757">pd</span><span class="op" id="1556759">.</span><span class="ident" id="1556760">fd</span><br>
<span class="lineno"></span><span class="op" id="1556763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1556766">func</span>&nbsp;<span class="ident" id="1556771">netpolluser</span><span class="op" id="1556782">(</span><span class="ident" id="1556783">pd</span>&nbsp;<span class="op" id="1556786">*</span><span class="ident" id="1556787">pollDesc</span><span class="op" id="1556795">)</span>&nbsp;<span class="op" id="1556797">*</span><span class="ident" id="1556798">unsafe</span><span class="op" id="1556804">.</span><span class="ident" id="1556805">Pointer</span>&nbsp;<span class="op" id="1556813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556816">return</span>&nbsp;<span class="op" id="1556823">&amp;</span><span class="ident" id="1556824">pd</span><span class="op" id="1556826">.</span><span class="ident" id="1556827">user</span><br>
<span class="lineno"></span><span class="op" id="1556832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556835">func</span>&nbsp;<span class="ident" id="1556840">netpollclosing</span><span class="op" id="1556854">(</span><span class="ident" id="1556855">pd</span>&nbsp;<span class="op" id="1556858">*</span><span class="ident" id="1556859">pollDesc</span><span class="op" id="1556867">)</span>&nbsp;<span class="builtintype" id="1556869">bool</span>&nbsp;<span class="op" id="1556874">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556877">return</span>&nbsp;<span class="ident" id="1556884">pd</span><span class="op" id="1556886">.</span><span class="ident" id="1556887">closing</span><br>
<span class="lineno"></span><span class="op" id="1556895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556898">func</span>&nbsp;<span class="ident" id="1556903">netpolllock</span><span class="op" id="1556914">(</span><span class="ident" id="1556915">pd</span>&nbsp;<span class="op" id="1556918">*</span><span class="ident" id="1556919">pollDesc</span><span class="op" id="1556927">)</span>&nbsp;<span class="op" id="1556929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556932">lock</span><span class="op" id="1556936">(</span><span class="op" id="1556937">&amp;</span><span class="ident" id="1556938">pd</span><span class="op" id="1556940">.</span><span class="ident" id="1556941">lock</span><span class="op" id="1556945">)</span><br>
<span class="lineno">280</span><span class="op" id="1556947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556950">func</span>&nbsp;<span class="ident" id="1556955">netpollunlock</span><span class="op" id="1556968">(</span><span class="ident" id="1556969">pd</span>&nbsp;<span class="op" id="1556972">*</span><span class="ident" id="1556973">pollDesc</span><span class="op" id="1556981">)</span>&nbsp;<span class="op" id="1556983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556986">unlock</span><span class="op" id="1556992">(</span><span class="op" id="1556993">&amp;</span><span class="ident" id="1556994">pd</span><span class="op" id="1556996">.</span><span class="ident" id="1556997">lock</span><span class="op" id="1557001">)</span><br>
<span class="lineno"></span><span class="op" id="1557003">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1557006">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1557081">func</span>&nbsp;<span class="ident" id="1557086">netpollready</span><span class="op" id="1557098">(</span><span class="ident" id="1557099">gpp</span>&nbsp;<span class="op" id="1557103">*</span><span class="op" id="1557104">*</span><span class="ident" id="1557105">g</span><span class="op" id="1557106">,</span>&nbsp;<span class="ident" id="1557108">pd</span>&nbsp;<span class="op" id="1557111">*</span><span class="ident" id="1557112">pollDesc</span><span class="op" id="1557120">,</span>&nbsp;<span class="ident" id="1557122">mode</span>&nbsp;<span class="builtintype" id="1557127">int32</span><span class="op" id="1557132">)</span>&nbsp;<span class="op" id="1557134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557137">var</span>&nbsp;<span class="ident" id="1557141">rg</span><span class="op" id="1557143">,</span>&nbsp;<span class="ident" id="1557145">wg</span>&nbsp;<span class="op" id="1557148">*</span><span class="ident" id="1557149">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557152">if</span>&nbsp;<span class="ident" id="1557155">mode</span>&nbsp;<span class="op" id="1557160">==</span>&nbsp;<span class="string" id="1557163">&#39;r&#39;</span>&nbsp;<span class="op" id="1557167">||</span>&nbsp;<span class="ident" id="1557170">mode</span>&nbsp;<span class="op" id="1557175">==</span>&nbsp;<span class="string" id="1557178">&#39;r&#39;</span><span class="op" id="1557181">+</span><span class="string" id="1557182">&#39;w&#39;</span>&nbsp;<span class="op" id="1557186">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557190">rg</span>&nbsp;<span class="op" id="1557193">=</span>&nbsp;<span class="ident" id="1557195">netpollunblock</span><span class="op" id="1557209">(</span><span class="ident" id="1557210">pd</span><span class="op" id="1557212">,</span>&nbsp;<span class="string" id="1557214">&#39;r&#39;</span><span class="op" id="1557217">,</span>&nbsp;<span class="builtintype" id="1557219">true</span><span class="op" id="1557223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557229">if</span>&nbsp;<span class="ident" id="1557232">mode</span>&nbsp;<span class="op" id="1557237">==</span>&nbsp;<span class="string" id="1557240">&#39;w&#39;</span>&nbsp;<span class="op" id="1557244">||</span>&nbsp;<span class="ident" id="1557247">mode</span>&nbsp;<span class="op" id="1557252">==</span>&nbsp;<span class="string" id="1557255">&#39;r&#39;</span><span class="op" id="1557258">+</span><span class="string" id="1557259">&#39;w&#39;</span>&nbsp;<span class="op" id="1557263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557267">wg</span>&nbsp;<span class="op" id="1557270">=</span>&nbsp;<span class="ident" id="1557272">netpollunblock</span><span class="op" id="1557286">(</span><span class="ident" id="1557287">pd</span><span class="op" id="1557289">,</span>&nbsp;<span class="string" id="1557291">&#39;w&#39;</span><span class="op" id="1557294">,</span>&nbsp;<span class="builtintype" id="1557296">true</span><span class="op" id="1557300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557303">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557306">if</span>&nbsp;<span class="ident" id="1557309">rg</span>&nbsp;<span class="op" id="1557312">!=</span>&nbsp;<span class="builtintype" id="1557315">nil</span>&nbsp;<span class="op" id="1557319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557323">rg</span><span class="op" id="1557325">.</span><span class="ident" id="1557326">schedlink</span>&nbsp;<span class="op" id="1557336">=</span>&nbsp;<span class="op" id="1557338">*</span><span class="ident" id="1557339">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557345">*</span><span class="ident" id="1557346">gpp</span>&nbsp;<span class="op" id="1557350">=</span>&nbsp;<span class="ident" id="1557352">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557359">if</span>&nbsp;<span class="ident" id="1557362">wg</span>&nbsp;<span class="op" id="1557365">!=</span>&nbsp;<span class="builtintype" id="1557368">nil</span>&nbsp;<span class="op" id="1557372">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557376">wg</span><span class="op" id="1557378">.</span><span class="ident" id="1557379">schedlink</span>&nbsp;<span class="op" id="1557389">=</span>&nbsp;<span class="op" id="1557391">*</span><span class="ident" id="1557392">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557398">*</span><span class="ident" id="1557399">gpp</span>&nbsp;<span class="op" id="1557403">=</span>&nbsp;<span class="ident" id="1557405">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557409">}</span><br>
<span class="lineno"></span><span class="op" id="1557411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1557414">func</span>&nbsp;<span class="ident" id="1557419">netpollcheckerr</span><span class="op" id="1557434">(</span><span class="ident" id="1557435">pd</span>&nbsp;<span class="op" id="1557438">*</span><span class="ident" id="1557439">pollDesc</span><span class="op" id="1557447">,</span>&nbsp;<span class="ident" id="1557449">mode</span>&nbsp;<span class="builtintype" id="1557454">int32</span><span class="op" id="1557459">)</span>&nbsp;<span class="builtintype" id="1557461">int</span>&nbsp;<span class="op" id="1557465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557468">if</span>&nbsp;<span class="ident" id="1557471">pd</span><span class="op" id="1557473">.</span><span class="ident" id="1557474">closing</span>&nbsp;<span class="op" id="1557482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557486">return</span>&nbsp;<span class="num" id="1557493">1</span>&nbsp;<span class="comment" id="1557495">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557513">if</span>&nbsp;<span class="op" id="1557516">(</span><span class="ident" id="1557517">mode</span>&nbsp;<span class="op" id="1557522">==</span>&nbsp;<span class="string" id="1557525">&#39;r&#39;</span>&nbsp;<span class="op" id="1557529">&amp;&amp;</span>&nbsp;<span class="ident" id="1557532">pd</span><span class="op" id="1557534">.</span><span class="ident" id="1557535">rd</span>&nbsp;<span class="op" id="1557538">&lt;</span>&nbsp;<span class="num" id="1557540">0</span><span class="op" id="1557541">)</span>&nbsp;<span class="op" id="1557543">||</span>&nbsp;<span class="op" id="1557546">(</span><span class="ident" id="1557547">mode</span>&nbsp;<span class="op" id="1557552">==</span>&nbsp;<span class="string" id="1557555">&#39;w&#39;</span>&nbsp;<span class="op" id="1557559">&amp;&amp;</span>&nbsp;<span class="ident" id="1557562">pd</span><span class="op" id="1557564">.</span><span class="ident" id="1557565">wd</span>&nbsp;<span class="op" id="1557568">&lt;</span>&nbsp;<span class="num" id="1557570">0</span><span class="op" id="1557571">)</span>&nbsp;<span class="op" id="1557573">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557577">return</span>&nbsp;<span class="num" id="1557584">2</span>&nbsp;<span class="comment" id="1557586">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557604">return</span>&nbsp;<span class="num" id="1557611">0</span><br>
<span class="lineno"></span><span class="op" id="1557613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1557616">func</span>&nbsp;<span class="ident" id="1557621">netpollblockcommit</span><span class="op" id="1557639">(</span><span class="ident" id="1557640">gp</span>&nbsp;<span class="op" id="1557643">*</span><span class="ident" id="1557644">g</span><span class="op" id="1557645">,</span>&nbsp;<span class="ident" id="1557647">gpp</span>&nbsp;<span class="ident" id="1557651">unsafe</span><span class="op" id="1557657">.</span><span class="ident" id="1557658">Pointer</span><span class="op" id="1557665">)</span>&nbsp;<span class="builtintype" id="1557667">bool</span>&nbsp;<span class="op" id="1557672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557675">return</span>&nbsp;<span class="ident" id="1557682">casuintptr</span><span class="op" id="1557692">(</span><span class="op" id="1557693">(</span><span class="op" id="1557694">*</span><span class="builtintype" id="1557695">uintptr</span><span class="op" id="1557702">)</span><span class="op" id="1557703">(</span><span class="ident" id="1557704">gpp</span><span class="op" id="1557707">)</span><span class="op" id="1557708">,</span>&nbsp;<span class="ident" id="1557710">pdWait</span><span class="op" id="1557716">,</span>&nbsp;<span class="builtintype" id="1557718">uintptr</span><span class="op" id="1557725">(</span><span class="ident" id="1557726">unsafe</span><span class="op" id="1557732">.</span><span class="ident" id="1557733">Pointer</span><span class="op" id="1557740">(</span><span class="ident" id="1557741">gp</span><span class="op" id="1557743">)</span><span class="op" id="1557744">)</span><span class="op" id="1557745">)</span><br>
<span class="lineno"></span><span class="op" id="1557747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1557750">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1557813">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1557867">func</span>&nbsp;<span class="ident" id="1557872">netpollblock</span><span class="op" id="1557884">(</span><span class="ident" id="1557885">pd</span>&nbsp;<span class="op" id="1557888">*</span><span class="ident" id="1557889">pollDesc</span><span class="op" id="1557897">,</span>&nbsp;<span class="ident" id="1557899">mode</span>&nbsp;<span class="builtintype" id="1557904">int32</span><span class="op" id="1557909">,</span>&nbsp;<span class="ident" id="1557911">waitio</span>&nbsp;<span class="builtintype" id="1557918">bool</span><span class="op" id="1557922">)</span>&nbsp;<span class="builtintype" id="1557924">bool</span>&nbsp;<span class="op" id="1557929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557932">gpp</span>&nbsp;<span class="op" id="1557936">:=</span>&nbsp;<span class="op" id="1557939">&amp;</span><span class="ident" id="1557940">pd</span><span class="op" id="1557942">.</span><span class="ident" id="1557943">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557947">if</span>&nbsp;<span class="ident" id="1557950">mode</span>&nbsp;<span class="op" id="1557955">==</span>&nbsp;<span class="string" id="1557958">&#39;w&#39;</span>&nbsp;<span class="op" id="1557962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557966">gpp</span>&nbsp;<span class="op" id="1557970">=</span>&nbsp;<span class="op" id="1557972">&amp;</span><span class="ident" id="1557973">pd</span><span class="op" id="1557975">.</span><span class="ident" id="1557976">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557984">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558018">for</span>&nbsp;<span class="op" id="1558022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558026">old</span>&nbsp;<span class="op" id="1558030">:=</span>&nbsp;<span class="op" id="1558033">*</span><span class="ident" id="1558034">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558040">if</span>&nbsp;<span class="ident" id="1558043">old</span>&nbsp;<span class="op" id="1558047">==</span>&nbsp;<span class="ident" id="1558050">pdReady</span>&nbsp;<span class="op" id="1558058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558063">*</span><span class="ident" id="1558064">gpp</span>&nbsp;<span class="op" id="1558068">=</span>&nbsp;<span class="num" id="1558070">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558075">return</span>&nbsp;<span class="builtintype" id="1558082">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558093">if</span>&nbsp;<span class="ident" id="1558096">old</span>&nbsp;<span class="op" id="1558100">!=</span>&nbsp;<span class="num" id="1558103">0</span>&nbsp;<span class="op" id="1558105">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558110">gothrow</span><span class="op" id="1558117">(</span><span class="string" id="1558118">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1558145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558153">if</span>&nbsp;<span class="ident" id="1558156">casuintptr</span><span class="op" id="1558166">(</span><span class="ident" id="1558167">gpp</span><span class="op" id="1558170">,</span>&nbsp;<span class="num" id="1558172">0</span><span class="op" id="1558173">,</span>&nbsp;<span class="ident" id="1558175">pdWait</span><span class="op" id="1558181">)</span>&nbsp;<span class="op" id="1558183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558196">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558203">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558262">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558349">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558420">if</span>&nbsp;<span class="ident" id="1558423">waitio</span>&nbsp;<span class="op" id="1558430">||</span>&nbsp;<span class="ident" id="1558433">netpollcheckerr</span><span class="op" id="1558448">(</span><span class="ident" id="1558449">pd</span><span class="op" id="1558451">,</span>&nbsp;<span class="ident" id="1558453">mode</span><span class="op" id="1558457">)</span>&nbsp;<span class="op" id="1558459">==</span>&nbsp;<span class="num" id="1558462">0</span>&nbsp;<span class="op" id="1558464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558468">f</span>&nbsp;<span class="op" id="1558470">:=</span>&nbsp;<span class="ident" id="1558473">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558494">gopark</span><span class="op" id="1558500">(</span><span class="op" id="1558501">*</span><span class="op" id="1558502">*</span><span class="op" id="1558503">(</span><span class="op" id="1558504">*</span><span class="op" id="1558505">*</span><span class="ident" id="1558506">unsafe</span><span class="op" id="1558512">.</span><span class="ident" id="1558513">Pointer</span><span class="op" id="1558520">)</span><span class="op" id="1558521">(</span><span class="ident" id="1558522">unsafe</span><span class="op" id="1558528">.</span><span class="ident" id="1558529">Pointer</span><span class="op" id="1558536">(</span><span class="op" id="1558537">&amp;</span><span class="ident" id="1558538">f</span><span class="op" id="1558539">)</span><span class="op" id="1558540">)</span><span class="op" id="1558541">,</span>&nbsp;<span class="ident" id="1558543">unsafe</span><span class="op" id="1558549">.</span><span class="ident" id="1558550">Pointer</span><span class="op" id="1558557">(</span><span class="ident" id="1558558">gpp</span><span class="op" id="1558561">)</span><span class="op" id="1558562">,</span>&nbsp;<span class="string" id="1558564">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1558573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558579">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558636">old</span>&nbsp;<span class="op" id="1558640">:=</span>&nbsp;<span class="ident" id="1558643">xchguintptr</span><span class="op" id="1558654">(</span><span class="ident" id="1558655">gpp</span><span class="op" id="1558658">,</span>&nbsp;<span class="num" id="1558660">0</span><span class="op" id="1558661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558664">if</span>&nbsp;<span class="ident" id="1558667">old</span>&nbsp;<span class="op" id="1558671">&gt;</span>&nbsp;<span class="ident" id="1558673">pdWait</span>&nbsp;<span class="op" id="1558680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558684">gothrow</span><span class="op" id="1558691">(</span><span class="string" id="1558692">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1558723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558729">return</span>&nbsp;<span class="ident" id="1558736">old</span>&nbsp;<span class="op" id="1558740">==</span>&nbsp;<span class="ident" id="1558743">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1558751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558754">func</span>&nbsp;<span class="ident" id="1558759">netpollunblock</span><span class="op" id="1558773">(</span><span class="ident" id="1558774">pd</span>&nbsp;<span class="op" id="1558777">*</span><span class="ident" id="1558778">pollDesc</span><span class="op" id="1558786">,</span>&nbsp;<span class="ident" id="1558788">mode</span>&nbsp;<span class="builtintype" id="1558793">int32</span><span class="op" id="1558798">,</span>&nbsp;<span class="ident" id="1558800">ioready</span>&nbsp;<span class="builtintype" id="1558808">bool</span><span class="op" id="1558812">)</span>&nbsp;<span class="op" id="1558814">*</span><span class="ident" id="1558815">g</span>&nbsp;<span class="op" id="1558817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558820">gpp</span>&nbsp;<span class="op" id="1558824">:=</span>&nbsp;<span class="op" id="1558827">&amp;</span><span class="ident" id="1558828">pd</span><span class="op" id="1558830">.</span><span class="ident" id="1558831">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558835">if</span>&nbsp;<span class="ident" id="1558838">mode</span>&nbsp;<span class="op" id="1558843">==</span>&nbsp;<span class="string" id="1558846">&#39;w&#39;</span>&nbsp;<span class="op" id="1558850">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558854">gpp</span>&nbsp;<span class="op" id="1558858">=</span>&nbsp;<span class="op" id="1558860">&amp;</span><span class="ident" id="1558861">pd</span><span class="op" id="1558863">.</span><span class="ident" id="1558864">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558872">for</span>&nbsp;<span class="op" id="1558876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558880">old</span>&nbsp;<span class="op" id="1558884">:=</span>&nbsp;<span class="op" id="1558887">*</span><span class="ident" id="1558888">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558894">if</span>&nbsp;<span class="ident" id="1558897">old</span>&nbsp;<span class="op" id="1558901">==</span>&nbsp;<span class="ident" id="1558904">pdReady</span>&nbsp;<span class="op" id="1558912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558917">return</span>&nbsp;<span class="builtintype" id="1558924">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558934">if</span>&nbsp;<span class="ident" id="1558937">old</span>&nbsp;<span class="op" id="1558941">==</span>&nbsp;<span class="num" id="1558944">0</span>&nbsp;<span class="op" id="1558946">&amp;&amp;</span>&nbsp;<span class="op" id="1558949">!</span><span class="ident" id="1558950">ioready</span>&nbsp;<span class="op" id="1558958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558963">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559014">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559066">return</span>&nbsp;<span class="builtintype" id="1559073">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559083">var</span>&nbsp;<span class="builtinfunc" id="1559087">new</span>&nbsp;<span class="builtintype" id="1559091">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559101">if</span>&nbsp;<span class="ident" id="1559104">ioready</span>&nbsp;<span class="op" id="1559112">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1559117">new</span>&nbsp;<span class="op" id="1559121">=</span>&nbsp;<span class="ident" id="1559123">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559137">if</span>&nbsp;<span class="ident" id="1559140">casuintptr</span><span class="op" id="1559150">(</span><span class="ident" id="1559151">gpp</span><span class="op" id="1559154">,</span>&nbsp;<span class="ident" id="1559156">old</span><span class="op" id="1559159">,</span>&nbsp;<span class="builtinfunc" id="1559161">new</span><span class="op" id="1559164">)</span>&nbsp;<span class="op" id="1559166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559171">if</span>&nbsp;<span class="ident" id="1559174">old</span>&nbsp;<span class="op" id="1559178">==</span>&nbsp;<span class="ident" id="1559181">pdReady</span>&nbsp;<span class="op" id="1559189">||</span>&nbsp;<span class="ident" id="1559192">old</span>&nbsp;<span class="op" id="1559196">==</span>&nbsp;<span class="ident" id="1559199">pdWait</span>&nbsp;<span class="op" id="1559206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559212">old</span>&nbsp;<span class="op" id="1559216">=</span>&nbsp;<span class="num" id="1559218">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559228">return</span>&nbsp;<span class="op" id="1559235">(</span><span class="op" id="1559236">*</span><span class="ident" id="1559237">g</span><span class="op" id="1559238">)</span><span class="op" id="1559239">(</span><span class="ident" id="1559240">unsafe</span><span class="op" id="1559246">.</span><span class="ident" id="1559247">Pointer</span><span class="op" id="1559254">(</span><span class="ident" id="1559255">old</span><span class="op" id="1559258">)</span><span class="op" id="1559259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559266">}</span><br>
<span class="lineno"></span><span class="op" id="1559268">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1559271">func</span>&nbsp;<span class="ident" id="1559276">netpolldeadlineimpl</span><span class="op" id="1559295">(</span><span class="ident" id="1559296">pd</span>&nbsp;<span class="op" id="1559299">*</span><span class="ident" id="1559300">pollDesc</span><span class="op" id="1559308">,</span>&nbsp;<span class="ident" id="1559310">seq</span>&nbsp;<span class="builtintype" id="1559314">uintptr</span><span class="op" id="1559321">,</span>&nbsp;<span class="ident" id="1559323">read</span><span class="op" id="1559327">,</span>&nbsp;<span class="ident" id="1559329">write</span>&nbsp;<span class="builtintype" id="1559335">bool</span><span class="op" id="1559339">)</span>&nbsp;<span class="op" id="1559341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559344">lock</span><span class="op" id="1559348">(</span><span class="op" id="1559349">&amp;</span><span class="ident" id="1559350">pd</span><span class="op" id="1559352">.</span><span class="ident" id="1559353">lock</span><span class="op" id="1559357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559360">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559403">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559446">if</span>&nbsp;<span class="ident" id="1559449">seq</span>&nbsp;<span class="op" id="1559453">!=</span>&nbsp;<span class="ident" id="1559456">pd</span><span class="op" id="1559458">.</span><span class="ident" id="1559459">seq</span>&nbsp;<span class="op" id="1559463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1559467">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559520">unlock</span><span class="op" id="1559526">(</span><span class="op" id="1559527">&amp;</span><span class="ident" id="1559528">pd</span><span class="op" id="1559530">.</span><span class="ident" id="1559531">lock</span><span class="op" id="1559535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559539">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559547">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559550">var</span>&nbsp;<span class="ident" id="1559554">rg</span>&nbsp;<span class="op" id="1559557">*</span><span class="ident" id="1559558">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559561">if</span>&nbsp;<span class="ident" id="1559564">read</span>&nbsp;<span class="op" id="1559569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559573">if</span>&nbsp;<span class="ident" id="1559576">pd</span><span class="op" id="1559578">.</span><span class="ident" id="1559579">rd</span>&nbsp;<span class="op" id="1559582">&lt;=</span>&nbsp;<span class="num" id="1559585">0</span>&nbsp;<span class="op" id="1559587">||</span>&nbsp;<span class="ident" id="1559590">pd</span><span class="op" id="1559592">.</span><span class="ident" id="1559593">rt</span><span class="op" id="1559595">.</span><span class="ident" id="1559596">f</span>&nbsp;<span class="op" id="1559598">==</span>&nbsp;<span class="builtintype" id="1559601">nil</span>&nbsp;<span class="op" id="1559605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559610">gothrow</span><span class="op" id="1559617">(</span><span class="string" id="1559618">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1559667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559671">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559675">pd</span><span class="op" id="1559677">.</span><span class="ident" id="1559678">rd</span>&nbsp;<span class="op" id="1559681">=</span>&nbsp;<span class="op" id="1559683">-</span><span class="num" id="1559684">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559688">atomicstorep</span><span class="op" id="1559700">(</span><span class="ident" id="1559701">unsafe</span><span class="op" id="1559707">.</span><span class="ident" id="1559708">Pointer</span><span class="op" id="1559715">(</span><span class="op" id="1559716">&amp;</span><span class="ident" id="1559717">pd</span><span class="op" id="1559719">.</span><span class="ident" id="1559720">rt</span><span class="op" id="1559722">.</span><span class="ident" id="1559723">f</span><span class="op" id="1559724">)</span><span class="op" id="1559725">,</span>&nbsp;<span class="builtintype" id="1559727">nil</span><span class="op" id="1559730">)</span>&nbsp;<span class="comment" id="1559732">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559810">rg</span>&nbsp;<span class="op" id="1559813">=</span>&nbsp;<span class="ident" id="1559815">netpollunblock</span><span class="op" id="1559829">(</span><span class="ident" id="1559830">pd</span><span class="op" id="1559832">,</span>&nbsp;<span class="string" id="1559834">&#39;r&#39;</span><span class="op" id="1559837">,</span>&nbsp;<span class="builtintype" id="1559839">false</span><span class="op" id="1559844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559850">var</span>&nbsp;<span class="ident" id="1559854">wg</span>&nbsp;<span class="op" id="1559857">*</span><span class="ident" id="1559858">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559861">if</span>&nbsp;<span class="ident" id="1559864">write</span>&nbsp;<span class="op" id="1559870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559874">if</span>&nbsp;<span class="ident" id="1559877">pd</span><span class="op" id="1559879">.</span><span class="ident" id="1559880">wd</span>&nbsp;<span class="op" id="1559883">&lt;=</span>&nbsp;<span class="num" id="1559886">0</span>&nbsp;<span class="op" id="1559888">||</span>&nbsp;<span class="ident" id="1559891">pd</span><span class="op" id="1559893">.</span><span class="ident" id="1559894">wt</span><span class="op" id="1559896">.</span><span class="ident" id="1559897">f</span>&nbsp;<span class="op" id="1559899">==</span>&nbsp;<span class="builtintype" id="1559902">nil</span>&nbsp;<span class="op" id="1559906">&amp;&amp;</span>&nbsp;<span class="op" id="1559909">!</span><span class="ident" id="1559910">read</span>&nbsp;<span class="op" id="1559915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559920">gothrow</span><span class="op" id="1559927">(</span><span class="string" id="1559928">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1559978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559986">pd</span><span class="op" id="1559988">.</span><span class="ident" id="1559989">wd</span>&nbsp;<span class="op" id="1559992">=</span>&nbsp;<span class="op" id="1559994">-</span><span class="num" id="1559995">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559999">atomicstorep</span><span class="op" id="1560011">(</span><span class="ident" id="1560012">unsafe</span><span class="op" id="1560018">.</span><span class="ident" id="1560019">Pointer</span><span class="op" id="1560026">(</span><span class="op" id="1560027">&amp;</span><span class="ident" id="1560028">pd</span><span class="op" id="1560030">.</span><span class="ident" id="1560031">wt</span><span class="op" id="1560033">.</span><span class="ident" id="1560034">f</span><span class="op" id="1560035">)</span><span class="op" id="1560036">,</span>&nbsp;<span class="builtintype" id="1560038">nil</span><span class="op" id="1560041">)</span>&nbsp;<span class="comment" id="1560043">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560121">wg</span>&nbsp;<span class="op" id="1560124">=</span>&nbsp;<span class="ident" id="1560126">netpollunblock</span><span class="op" id="1560140">(</span><span class="ident" id="1560141">pd</span><span class="op" id="1560143">,</span>&nbsp;<span class="string" id="1560145">&#39;w&#39;</span><span class="op" id="1560148">,</span>&nbsp;<span class="builtintype" id="1560150">false</span><span class="op" id="1560155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560161">unlock</span><span class="op" id="1560167">(</span><span class="op" id="1560168">&amp;</span><span class="ident" id="1560169">pd</span><span class="op" id="1560171">.</span><span class="ident" id="1560172">lock</span><span class="op" id="1560176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560179">if</span>&nbsp;<span class="ident" id="1560182">rg</span>&nbsp;<span class="op" id="1560185">!=</span>&nbsp;<span class="builtintype" id="1560188">nil</span>&nbsp;<span class="op" id="1560192">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560196">goready</span><span class="op" id="1560203">(</span><span class="ident" id="1560204">rg</span><span class="op" id="1560206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560212">if</span>&nbsp;<span class="ident" id="1560215">wg</span>&nbsp;<span class="op" id="1560218">!=</span>&nbsp;<span class="builtintype" id="1560221">nil</span>&nbsp;<span class="op" id="1560225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560229">goready</span><span class="op" id="1560236">(</span><span class="ident" id="1560237">wg</span><span class="op" id="1560239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560242">}</span><br>
<span class="lineno">420</span><span class="op" id="1560244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1560247">func</span>&nbsp;<span class="ident" id="1560252">netpollDeadline</span><span class="op" id="1560267">(</span><span class="ident" id="1560268">arg</span>&nbsp;<span class="keyword" id="1560272">interface</span><span class="op" id="1560281">{</span><span class="op" id="1560282">}</span><span class="op" id="1560283">,</span>&nbsp;<span class="ident" id="1560285">seq</span>&nbsp;<span class="builtintype" id="1560289">uintptr</span><span class="op" id="1560296">)</span>&nbsp;<span class="op" id="1560298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560301">netpolldeadlineimpl</span><span class="op" id="1560320">(</span><span class="ident" id="1560321">arg</span><span class="op" id="1560324">.</span><span class="op" id="1560325">(</span><span class="op" id="1560326">*</span><span class="ident" id="1560327">pollDesc</span><span class="op" id="1560335">)</span><span class="op" id="1560336">,</span>&nbsp;<span class="ident" id="1560338">seq</span><span class="op" id="1560341">,</span>&nbsp;<span class="builtintype" id="1560343">true</span><span class="op" id="1560347">,</span>&nbsp;<span class="builtintype" id="1560349">true</span><span class="op" id="1560353">)</span><br>
<span class="lineno"></span><span class="op" id="1560355">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1560358">func</span>&nbsp;<span class="ident" id="1560363">netpollReadDeadline</span><span class="op" id="1560382">(</span><span class="ident" id="1560383">arg</span>&nbsp;<span class="keyword" id="1560387">interface</span><span class="op" id="1560396">{</span><span class="op" id="1560397">}</span><span class="op" id="1560398">,</span>&nbsp;<span class="ident" id="1560400">seq</span>&nbsp;<span class="builtintype" id="1560404">uintptr</span><span class="op" id="1560411">)</span>&nbsp;<span class="op" id="1560413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560416">netpolldeadlineimpl</span><span class="op" id="1560435">(</span><span class="ident" id="1560436">arg</span><span class="op" id="1560439">.</span><span class="op" id="1560440">(</span><span class="op" id="1560441">*</span><span class="ident" id="1560442">pollDesc</span><span class="op" id="1560450">)</span><span class="op" id="1560451">,</span>&nbsp;<span class="ident" id="1560453">seq</span><span class="op" id="1560456">,</span>&nbsp;<span class="builtintype" id="1560458">true</span><span class="op" id="1560462">,</span>&nbsp;<span class="builtintype" id="1560464">false</span><span class="op" id="1560469">)</span><br>
<span class="lineno"></span><span class="op" id="1560471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1560474">func</span>&nbsp;<span class="ident" id="1560479">netpollWriteDeadline</span><span class="op" id="1560499">(</span><span class="ident" id="1560500">arg</span>&nbsp;<span class="keyword" id="1560504">interface</span><span class="op" id="1560513">{</span><span class="op" id="1560514">}</span><span class="op" id="1560515">,</span>&nbsp;<span class="ident" id="1560517">seq</span>&nbsp;<span class="builtintype" id="1560521">uintptr</span><span class="op" id="1560528">)</span>&nbsp;<span class="op" id="1560530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560533">netpolldeadlineimpl</span><span class="op" id="1560552">(</span><span class="ident" id="1560553">arg</span><span class="op" id="1560556">.</span><span class="op" id="1560557">(</span><span class="op" id="1560558">*</span><span class="ident" id="1560559">pollDesc</span><span class="op" id="1560567">)</span><span class="op" id="1560568">,</span>&nbsp;<span class="ident" id="1560570">seq</span><span class="op" id="1560573">,</span>&nbsp;<span class="builtintype" id="1560575">false</span><span class="op" id="1560580">,</span>&nbsp;<span class="builtintype" id="1560582">true</span><span class="op" id="1560586">)</span><br>
<span class="lineno"></span><span class="op" id="1560588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1560591">func</span>&nbsp;<span class="op" id="1560596">(</span><span class="ident" id="1560597">c</span>&nbsp;<span class="op" id="1560599">*</span><span class="ident" id="1560600">pollCache</span><span class="op" id="1560609">)</span>&nbsp;<span class="ident" id="1560611">alloc</span><span class="op" id="1560616">(</span><span class="op" id="1560617">)</span>&nbsp;<span class="op" id="1560619">*</span><span class="ident" id="1560620">pollDesc</span>&nbsp;<span class="op" id="1560629">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560632">lock</span><span class="op" id="1560636">(</span><span class="op" id="1560637">&amp;</span><span class="ident" id="1560638">c</span><span class="op" id="1560639">.</span><span class="ident" id="1560640">lock</span><span class="op" id="1560644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560647">if</span>&nbsp;<span class="ident" id="1560650">c</span><span class="op" id="1560651">.</span><span class="ident" id="1560652">first</span>&nbsp;<span class="op" id="1560658">==</span>&nbsp;<span class="builtintype" id="1560661">nil</span>&nbsp;<span class="op" id="1560665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560669">const</span>&nbsp;<span class="ident" id="1560675">pdSize</span>&nbsp;<span class="op" id="1560682">=</span>&nbsp;<span class="ident" id="1560684">unsafe</span><span class="op" id="1560690">.</span><span class="ident" id="1560691">Sizeof</span><span class="op" id="1560697">(</span><span class="ident" id="1560698">pollDesc</span><span class="op" id="1560706">{</span><span class="op" id="1560707">}</span><span class="op" id="1560708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560712">n</span>&nbsp;<span class="op" id="1560714">:=</span>&nbsp;<span class="ident" id="1560717">pollBlockSize</span>&nbsp;<span class="op" id="1560731">/</span>&nbsp;<span class="ident" id="1560733">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560742">if</span>&nbsp;<span class="ident" id="1560745">n</span>&nbsp;<span class="op" id="1560747">==</span>&nbsp;<span class="num" id="1560750">0</span>&nbsp;<span class="op" id="1560752">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560757">n</span>&nbsp;<span class="op" id="1560759">=</span>&nbsp;<span class="num" id="1560761">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1560765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560769">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560825">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560864">mem</span>&nbsp;<span class="op" id="1560868">:=</span>&nbsp;<span class="ident" id="1560871">persistentalloc</span><span class="op" id="1560886">(</span><span class="ident" id="1560887">n</span><span class="op" id="1560888">*</span><span class="ident" id="1560889">pdSize</span><span class="op" id="1560895">,</span>&nbsp;<span class="num" id="1560897">0</span><span class="op" id="1560898">,</span>&nbsp;<span class="op" id="1560900">&amp;</span><span class="ident" id="1560901">memstats</span><span class="op" id="1560909">.</span><span class="ident" id="1560910">other_sys</span><span class="op" id="1560919">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1560923">for</span>&nbsp;<span class="ident" id="1560927">i</span>&nbsp;<span class="op" id="1560929">:=</span>&nbsp;<span class="builtintype" id="1560932">uintptr</span><span class="op" id="1560939">(</span><span class="num" id="1560940">0</span><span class="op" id="1560941">)</span><span class="op" id="1560942">;</span>&nbsp;<span class="ident" id="1560944">i</span>&nbsp;<span class="op" id="1560946">&lt;</span>&nbsp;<span class="ident" id="1560948">n</span><span class="op" id="1560949">;</span>&nbsp;<span class="ident" id="1560951">i</span><span class="op" id="1560952">++</span>&nbsp;<span class="op" id="1560955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560960">pd</span>&nbsp;<span class="op" id="1560963">:=</span>&nbsp;<span class="op" id="1560966">(</span><span class="op" id="1560967">*</span><span class="ident" id="1560968">pollDesc</span><span class="op" id="1560976">)</span><span class="op" id="1560977">(</span><span class="ident" id="1560978">add</span><span class="op" id="1560981">(</span><span class="ident" id="1560982">mem</span><span class="op" id="1560985">,</span>&nbsp;<span class="ident" id="1560987">i</span><span class="op" id="1560988">*</span><span class="ident" id="1560989">pdSize</span><span class="op" id="1560995">)</span><span class="op" id="1560996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561001">pd</span><span class="op" id="1561003">.</span><span class="ident" id="1561004">link</span>&nbsp;<span class="op" id="1561009">=</span>&nbsp;<span class="ident" id="1561011">c</span><span class="op" id="1561012">.</span><span class="ident" id="1561013">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561022">c</span><span class="op" id="1561023">.</span><span class="ident" id="1561024">first</span>&nbsp;<span class="op" id="1561030">=</span>&nbsp;<span class="ident" id="1561032">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561037">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1561040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561043">pd</span>&nbsp;<span class="op" id="1561046">:=</span>&nbsp;<span class="ident" id="1561049">c</span><span class="op" id="1561050">.</span><span class="ident" id="1561051">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561058">c</span><span class="op" id="1561059">.</span><span class="ident" id="1561060">first</span>&nbsp;<span class="op" id="1561066">=</span>&nbsp;<span class="ident" id="1561068">pd</span><span class="op" id="1561070">.</span><span class="ident" id="1561071">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561077">unlock</span><span class="op" id="1561083">(</span><span class="op" id="1561084">&amp;</span><span class="ident" id="1561085">c</span><span class="op" id="1561086">.</span><span class="ident" id="1561087">lock</span><span class="op" id="1561091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1561094">return</span>&nbsp;<span class="ident" id="1561101">pd</span><br>
<span class="lineno">455</span><span class="op" id="1561104">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
