<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5970230">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5970285">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5970339">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5970390">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5970445">package</span>&nbsp;<span class="ident" id="5970453">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5970458">import</span>&nbsp;<span class="op" id="5970465">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970468">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970480">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5970488">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5970498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5970501">const</span>&nbsp;<span class="ident" id="5970507">uint64Size</span>&nbsp;<span class="op" id="5970518">=</span>&nbsp;<span class="num" id="5970520">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5970523">type</span>&nbsp;<span class="ident" id="5970528">encHelper</span>&nbsp;<span class="keyword" id="5970538">func</span><span class="op" id="5970542">(</span><span class="ident" id="5970543">state</span>&nbsp;<span class="op" id="5970549">*</span><span class="ident" id="5970550">encoderState</span><span class="op" id="5970562">,</span>&nbsp;<span class="ident" id="5970564">v</span>&nbsp;<span class="ident" id="5970566">reflect</span><span class="op" id="5970573">.</span><span class="ident" id="5970574">Value</span><span class="op" id="5970579">)</span>&nbsp;<span class="builtintype" id="5970581">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5970587">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5970664">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5970730">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5970800">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5970831">type</span>&nbsp;<span class="ident" id="5970836">encoderState</span>&nbsp;<span class="keyword" id="5970849">struct</span>&nbsp;<span class="op" id="5970856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5970859">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970868">*</span><span class="ident" id="5970869">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5970878">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970887">*</span><span class="ident" id="5970888">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5970899">sendZero</span>&nbsp;<span class="builtintype" id="5970908">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970929">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5970999">fieldnum</span>&nbsp;<span class="builtintype" id="5971008">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971029">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971064">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971073">[</span><span class="num" id="5971074">1</span>&nbsp;<span class="op" id="5971076">+</span>&nbsp;<span class="ident" id="5971078">uint64Size</span><span class="op" id="5971088">]</span><span class="builtintype" id="5971089">byte</span>&nbsp;<span class="comment" id="5971094">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971152">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971161">*</span><span class="ident" id="5971162">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971182">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5971199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5971202">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5971288">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5971383">type</span>&nbsp;<span class="ident" id="5971388">encBuffer</span>&nbsp;<span class="keyword" id="5971398">struct</span>&nbsp;<span class="op" id="5971405">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971408">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971416">[</span><span class="op" id="5971417">]</span><span class="builtintype" id="5971418">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971424">scratch</span>&nbsp;<span class="op" id="5971432">[</span><span class="num" id="5971433">64</span><span class="op" id="5971435">]</span><span class="builtintype" id="5971436">byte</span><br>
<span class="lineno"></span><span class="op" id="5971441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971444">func</span>&nbsp;<span class="op" id="5971449">(</span><span class="ident" id="5971450">e</span>&nbsp;<span class="op" id="5971452">*</span><span class="ident" id="5971453">encBuffer</span><span class="op" id="5971462">)</span>&nbsp;<span class="ident" id="5971464">WriteByte</span><span class="op" id="5971473">(</span><span class="ident" id="5971474">c</span>&nbsp;<span class="builtintype" id="5971476">byte</span><span class="op" id="5971480">)</span>&nbsp;<span class="op" id="5971482">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971485">e</span><span class="op" id="5971486">.</span><span class="ident" id="5971487">data</span>&nbsp;<span class="op" id="5971492">=</span>&nbsp;<span class="builtinfunc" id="5971494">append</span><span class="op" id="5971500">(</span><span class="ident" id="5971501">e</span><span class="op" id="5971502">.</span><span class="ident" id="5971503">data</span><span class="op" id="5971507">,</span>&nbsp;<span class="ident" id="5971509">c</span><span class="op" id="5971510">)</span><br>
<span class="lineno"></span><span class="op" id="5971512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971515">func</span>&nbsp;<span class="op" id="5971520">(</span><span class="ident" id="5971521">e</span>&nbsp;<span class="op" id="5971523">*</span><span class="ident" id="5971524">encBuffer</span><span class="op" id="5971533">)</span>&nbsp;<span class="ident" id="5971535">Write</span><span class="op" id="5971540">(</span><span class="ident" id="5971541">p</span>&nbsp;<span class="op" id="5971543">[</span><span class="op" id="5971544">]</span><span class="builtintype" id="5971545">byte</span><span class="op" id="5971549">)</span>&nbsp;<span class="op" id="5971551">(</span><span class="builtintype" id="5971552">int</span><span class="op" id="5971555">,</span>&nbsp;<span class="builtintype" id="5971557">error</span><span class="op" id="5971562">)</span>&nbsp;<span class="op" id="5971564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971567">e</span><span class="op" id="5971568">.</span><span class="ident" id="5971569">data</span>&nbsp;<span class="op" id="5971574">=</span>&nbsp;<span class="builtinfunc" id="5971576">append</span><span class="op" id="5971582">(</span><span class="ident" id="5971583">e</span><span class="op" id="5971584">.</span><span class="ident" id="5971585">data</span><span class="op" id="5971589">,</span>&nbsp;<span class="ident" id="5971591">p</span><span class="op" id="5971592">...</span><span class="op" id="5971595">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971598">return</span>&nbsp;<span class="builtinfunc" id="5971605">len</span><span class="op" id="5971608">(</span><span class="ident" id="5971609">p</span><span class="op" id="5971610">)</span><span class="op" id="5971611">,</span>&nbsp;<span class="ident" id="5971613">nil</span><br>
<span class="lineno"></span><span class="op" id="5971617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971620">func</span>&nbsp;<span class="op" id="5971625">(</span><span class="ident" id="5971626">e</span>&nbsp;<span class="op" id="5971628">*</span><span class="ident" id="5971629">encBuffer</span><span class="op" id="5971638">)</span>&nbsp;<span class="ident" id="5971640">WriteString</span><span class="op" id="5971651">(</span><span class="ident" id="5971652">s</span>&nbsp;<span class="builtintype" id="5971654">string</span><span class="op" id="5971660">)</span>&nbsp;<span class="op" id="5971662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971665">e</span><span class="op" id="5971666">.</span><span class="ident" id="5971667">data</span>&nbsp;<span class="op" id="5971672">=</span>&nbsp;<span class="builtinfunc" id="5971674">append</span><span class="op" id="5971680">(</span><span class="ident" id="5971681">e</span><span class="op" id="5971682">.</span><span class="ident" id="5971683">data</span><span class="op" id="5971687">,</span>&nbsp;<span class="ident" id="5971689">s</span><span class="op" id="5971690">...</span><span class="op" id="5971693">)</span><br>
<span class="lineno">50</span><span class="op" id="5971695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971698">func</span>&nbsp;<span class="op" id="5971703">(</span><span class="ident" id="5971704">e</span>&nbsp;<span class="op" id="5971706">*</span><span class="ident" id="5971707">encBuffer</span><span class="op" id="5971716">)</span>&nbsp;<span class="ident" id="5971718">Len</span><span class="op" id="5971721">(</span><span class="op" id="5971722">)</span>&nbsp;<span class="builtintype" id="5971724">int</span>&nbsp;<span class="op" id="5971728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971731">return</span>&nbsp;<span class="builtinfunc" id="5971738">len</span><span class="op" id="5971741">(</span><span class="ident" id="5971742">e</span><span class="op" id="5971743">.</span><span class="ident" id="5971744">data</span><span class="op" id="5971748">)</span><br>
<span class="lineno"></span><span class="op" id="5971750">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5971753">func</span>&nbsp;<span class="op" id="5971758">(</span><span class="ident" id="5971759">e</span>&nbsp;<span class="op" id="5971761">*</span><span class="ident" id="5971762">encBuffer</span><span class="op" id="5971771">)</span>&nbsp;<span class="ident" id="5971773">Bytes</span><span class="op" id="5971778">(</span><span class="op" id="5971779">)</span>&nbsp;<span class="op" id="5971781">[</span><span class="op" id="5971782">]</span><span class="builtintype" id="5971783">byte</span>&nbsp;<span class="op" id="5971788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971791">return</span>&nbsp;<span class="ident" id="5971798">e</span><span class="op" id="5971799">.</span><span class="ident" id="5971800">data</span><br>
<span class="lineno"></span><span class="op" id="5971805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5971808">func</span>&nbsp;<span class="op" id="5971813">(</span><span class="ident" id="5971814">e</span>&nbsp;<span class="op" id="5971816">*</span><span class="ident" id="5971817">encBuffer</span><span class="op" id="5971826">)</span>&nbsp;<span class="ident" id="5971828">Reset</span><span class="op" id="5971833">(</span><span class="op" id="5971834">)</span>&nbsp;<span class="op" id="5971836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971839">e</span><span class="op" id="5971840">.</span><span class="ident" id="5971841">data</span>&nbsp;<span class="op" id="5971846">=</span>&nbsp;<span class="ident" id="5971848">e</span><span class="op" id="5971849">.</span><span class="ident" id="5971850">data</span><span class="op" id="5971854">[</span><span class="num" id="5971855">0</span><span class="op" id="5971856">:</span><span class="num" id="5971857">0</span><span class="op" id="5971858">]</span><br>
<span class="lineno"></span><span class="op" id="5971860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971863">func</span>&nbsp;<span class="op" id="5971868">(</span><span class="ident" id="5971869">enc</span>&nbsp;<span class="op" id="5971873">*</span><span class="ident" id="5971874">Encoder</span><span class="op" id="5971881">)</span>&nbsp;<span class="ident" id="5971883">newEncoderState</span><span class="op" id="5971898">(</span><span class="ident" id="5971899">b</span>&nbsp;<span class="op" id="5971901">*</span><span class="ident" id="5971902">encBuffer</span><span class="op" id="5971911">)</span>&nbsp;<span class="op" id="5971913">*</span><span class="ident" id="5971914">encoderState</span>&nbsp;<span class="op" id="5971927">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971930">e</span>&nbsp;<span class="op" id="5971932">:=</span>&nbsp;<span class="ident" id="5971935">enc</span><span class="op" id="5971938">.</span><span class="ident" id="5971939">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5971949">if</span>&nbsp;<span class="ident" id="5971952">e</span>&nbsp;<span class="op" id="5971954">==</span>&nbsp;<span class="ident" id="5971957">nil</span>&nbsp;<span class="op" id="5971961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971965">e</span>&nbsp;<span class="op" id="5971967">=</span>&nbsp;<span class="builtinfunc" id="5971969">new</span><span class="op" id="5971972">(</span><span class="ident" id="5971973">encoderState</span><span class="op" id="5971985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5971989">e</span><span class="op" id="5971990">.</span><span class="ident" id="5971991">enc</span>&nbsp;<span class="op" id="5971995">=</span>&nbsp;<span class="ident" id="5971997">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972002">}</span>&nbsp;<span class="keyword" id="5972004">else</span>&nbsp;<span class="op" id="5972009">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972013">enc</span><span class="op" id="5972016">.</span><span class="ident" id="5972017">freeList</span>&nbsp;<span class="op" id="5972026">=</span>&nbsp;<span class="ident" id="5972028">e</span><span class="op" id="5972029">.</span><span class="ident" id="5972030">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972039">e</span><span class="op" id="5972040">.</span><span class="ident" id="5972041">sendZero</span>&nbsp;<span class="op" id="5972050">=</span>&nbsp;<span class="builtintype" id="5972052">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972059">e</span><span class="op" id="5972060">.</span><span class="ident" id="5972061">fieldnum</span>&nbsp;<span class="op" id="5972070">=</span>&nbsp;<span class="num" id="5972072">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972075">e</span><span class="op" id="5972076">.</span><span class="ident" id="5972077">b</span>&nbsp;<span class="op" id="5972079">=</span>&nbsp;<span class="ident" id="5972081">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972084">if</span>&nbsp;<span class="builtinfunc" id="5972087">len</span><span class="op" id="5972090">(</span><span class="ident" id="5972091">b</span><span class="op" id="5972092">.</span><span class="ident" id="5972093">data</span><span class="op" id="5972097">)</span>&nbsp;<span class="op" id="5972099">==</span>&nbsp;<span class="num" id="5972102">0</span>&nbsp;<span class="op" id="5972104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972108">b</span><span class="op" id="5972109">.</span><span class="ident" id="5972110">data</span>&nbsp;<span class="op" id="5972115">=</span>&nbsp;<span class="ident" id="5972117">b</span><span class="op" id="5972118">.</span><span class="ident" id="5972119">scratch</span><span class="op" id="5972126">[</span><span class="num" id="5972127">0</span><span class="op" id="5972128">:</span><span class="num" id="5972129">0</span><span class="op" id="5972130">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972136">return</span>&nbsp;<span class="ident" id="5972143">e</span><br>
<span class="lineno"></span><span class="op" id="5972145">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5972148">func</span>&nbsp;<span class="op" id="5972153">(</span><span class="ident" id="5972154">enc</span>&nbsp;<span class="op" id="5972158">*</span><span class="ident" id="5972159">Encoder</span><span class="op" id="5972166">)</span>&nbsp;<span class="ident" id="5972168">freeEncoderState</span><span class="op" id="5972184">(</span><span class="ident" id="5972185">e</span>&nbsp;<span class="op" id="5972187">*</span><span class="ident" id="5972188">encoderState</span><span class="op" id="5972200">)</span>&nbsp;<span class="op" id="5972202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972205">e</span><span class="op" id="5972206">.</span><span class="ident" id="5972207">next</span>&nbsp;<span class="op" id="5972212">=</span>&nbsp;<span class="ident" id="5972214">enc</span><span class="op" id="5972217">.</span><span class="ident" id="5972218">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972228">enc</span><span class="op" id="5972231">.</span><span class="ident" id="5972232">freeList</span>&nbsp;<span class="op" id="5972241">=</span>&nbsp;<span class="ident" id="5972243">e</span><br>
<span class="lineno"></span><span class="op" id="5972245">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5972248">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5972319">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5972380">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5972448">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5972481">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5972542">func</span>&nbsp;<span class="op" id="5972547">(</span><span class="ident" id="5972548">state</span>&nbsp;<span class="op" id="5972554">*</span><span class="ident" id="5972555">encoderState</span><span class="op" id="5972567">)</span>&nbsp;<span class="ident" id="5972569">encodeUint</span><span class="op" id="5972579">(</span><span class="ident" id="5972580">x</span>&nbsp;<span class="ident" id="5972582">uint64</span><span class="op" id="5972588">)</span>&nbsp;<span class="op" id="5972590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972593">if</span>&nbsp;<span class="ident" id="5972596">x</span>&nbsp;<span class="op" id="5972598">&lt;=</span>&nbsp;<span class="num" id="5972601">0x7F</span>&nbsp;<span class="op" id="5972606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972610">state</span><span class="op" id="5972615">.</span><span class="ident" id="5972616">b</span><span class="op" id="5972617">.</span><span class="ident" id="5972618">WriteByte</span><span class="op" id="5972627">(</span><span class="builtintype" id="5972628">uint8</span><span class="op" id="5972633">(</span><span class="ident" id="5972634">x</span><span class="op" id="5972635">)</span><span class="op" id="5972636">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972640">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972651">i</span>&nbsp;<span class="op" id="5972653">:=</span>&nbsp;<span class="ident" id="5972656">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5972668">for</span>&nbsp;<span class="ident" id="5972672">x</span>&nbsp;<span class="op" id="5972674">&gt;</span>&nbsp;<span class="num" id="5972676">0</span>&nbsp;<span class="op" id="5972678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972682">state</span><span class="op" id="5972687">.</span><span class="ident" id="5972688">buf</span><span class="op" id="5972691">[</span><span class="ident" id="5972692">i</span><span class="op" id="5972693">]</span>&nbsp;<span class="op" id="5972695">=</span>&nbsp;<span class="builtintype" id="5972697">uint8</span><span class="op" id="5972702">(</span><span class="ident" id="5972703">x</span><span class="op" id="5972704">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972708">x</span>&nbsp;<span class="op" id="5972710">&gt;&gt;=</span>&nbsp;<span class="num" id="5972714">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972718">i</span><span class="op" id="5972719">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5972723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972726">state</span><span class="op" id="5972731">.</span><span class="ident" id="5972732">buf</span><span class="op" id="5972735">[</span><span class="ident" id="5972736">i</span><span class="op" id="5972737">]</span>&nbsp;<span class="op" id="5972739">=</span>&nbsp;<span class="builtintype" id="5972741">uint8</span><span class="op" id="5972746">(</span><span class="ident" id="5972747">i</span>&nbsp;<span class="op" id="5972749">-</span>&nbsp;<span class="ident" id="5972751">uint64Size</span><span class="op" id="5972761">)</span>&nbsp;<span class="comment" id="5972763">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5972789">state</span><span class="op" id="5972794">.</span><span class="ident" id="5972795">b</span><span class="op" id="5972796">.</span><span class="ident" id="5972797">Write</span><span class="op" id="5972802">(</span><span class="ident" id="5972803">state</span><span class="op" id="5972808">.</span><span class="ident" id="5972809">buf</span><span class="op" id="5972812">[</span><span class="ident" id="5972813">i</span>&nbsp;<span class="op" id="5972815">:</span>&nbsp;<span class="ident" id="5972817">uint64Size</span><span class="op" id="5972827">+</span><span class="num" id="5972828">1</span><span class="op" id="5972829">]</span><span class="op" id="5972830">)</span><br>
<span class="lineno">105</span><span class="op" id="5972832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5972835">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5972893">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5972979">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5973007">func</span>&nbsp;<span class="op" id="5973012">(</span><span class="ident" id="5973013">state</span>&nbsp;<span class="op" id="5973019">*</span><span class="ident" id="5973020">encoderState</span><span class="op" id="5973032">)</span>&nbsp;<span class="ident" id="5973034">encodeInt</span><span class="op" id="5973043">(</span><span class="ident" id="5973044">i</span>&nbsp;<span class="ident" id="5973046">int64</span><span class="op" id="5973051">)</span>&nbsp;<span class="op" id="5973053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973056">var</span>&nbsp;<span class="ident" id="5973060">x</span>&nbsp;<span class="ident" id="5973062">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973070">if</span>&nbsp;<span class="ident" id="5973073">i</span>&nbsp;<span class="op" id="5973075">&lt;</span>&nbsp;<span class="num" id="5973077">0</span>&nbsp;<span class="op" id="5973079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973083">x</span>&nbsp;<span class="op" id="5973085">=</span>&nbsp;<span class="ident" id="5973087">uint64</span><span class="op" id="5973093">(</span><span class="op" id="5973094">^</span><span class="ident" id="5973095">i</span><span class="op" id="5973096">&lt;&lt;</span><span class="num" id="5973098">1</span><span class="op" id="5973099">)</span>&nbsp;<span class="op" id="5973101">|</span>&nbsp;<span class="num" id="5973103">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973106">}</span>&nbsp;<span class="keyword" id="5973108">else</span>&nbsp;<span class="op" id="5973113">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973117">x</span>&nbsp;<span class="op" id="5973119">=</span>&nbsp;<span class="ident" id="5973121">uint64</span><span class="op" id="5973127">(</span><span class="ident" id="5973128">i</span>&nbsp;<span class="op" id="5973130">&lt;&lt;</span>&nbsp;<span class="num" id="5973133">1</span><span class="op" id="5973134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973140">state</span><span class="op" id="5973145">.</span><span class="ident" id="5973146">encodeUint</span><span class="op" id="5973156">(</span><span class="ident" id="5973157">uint64</span><span class="op" id="5973163">(</span><span class="ident" id="5973164">x</span><span class="op" id="5973165">)</span><span class="op" id="5973166">)</span><br>
<span class="lineno"></span><span class="op" id="5973168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5973171">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5973239">type</span>&nbsp;<span class="ident" id="5973244">encOp</span>&nbsp;<span class="keyword" id="5973250">func</span><span class="op" id="5973254">(</span><span class="ident" id="5973255">i</span>&nbsp;<span class="op" id="5973257">*</span><span class="ident" id="5973258">encInstr</span><span class="op" id="5973266">,</span>&nbsp;<span class="ident" id="5973268">state</span>&nbsp;<span class="op" id="5973274">*</span><span class="ident" id="5973275">encoderState</span><span class="op" id="5973287">,</span>&nbsp;<span class="ident" id="5973289">v</span>&nbsp;<span class="ident" id="5973291">reflect</span><span class="op" id="5973298">.</span><span class="ident" id="5973299">Value</span><span class="op" id="5973304">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5973307">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5973353">type</span>&nbsp;<span class="ident" id="5973358">encInstr</span>&nbsp;<span class="keyword" id="5973367">struct</span>&nbsp;<span class="op" id="5973374">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973377">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973383">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973390">field</span>&nbsp;<span class="builtintype" id="5973396">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5973402">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973428">index</span>&nbsp;<span class="op" id="5973434">[</span><span class="op" id="5973435">]</span><span class="builtintype" id="5973436">int</span>&nbsp;<span class="comment" id="5973440">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973457">indir</span>&nbsp;<span class="builtintype" id="5973463">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5973469">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5973535">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5973538">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5973631">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5973685">func</span>&nbsp;<span class="op" id="5973690">(</span><span class="ident" id="5973691">state</span>&nbsp;<span class="op" id="5973697">*</span><span class="ident" id="5973698">encoderState</span><span class="op" id="5973710">)</span>&nbsp;<span class="ident" id="5973712">update</span><span class="op" id="5973718">(</span><span class="ident" id="5973719">instr</span>&nbsp;<span class="op" id="5973725">*</span><span class="ident" id="5973726">encInstr</span><span class="op" id="5973734">)</span>&nbsp;<span class="op" id="5973736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5973739">if</span>&nbsp;<span class="ident" id="5973742">instr</span>&nbsp;<span class="op" id="5973748">!=</span>&nbsp;<span class="ident" id="5973751">nil</span>&nbsp;<span class="op" id="5973755">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973759">state</span><span class="op" id="5973764">.</span><span class="ident" id="5973765">encodeUint</span><span class="op" id="5973775">(</span><span class="ident" id="5973776">uint64</span><span class="op" id="5973782">(</span><span class="ident" id="5973783">instr</span><span class="op" id="5973788">.</span><span class="ident" id="5973789">field</span>&nbsp;<span class="op" id="5973795">-</span>&nbsp;<span class="ident" id="5973797">state</span><span class="op" id="5973802">.</span><span class="ident" id="5973803">fieldnum</span><span class="op" id="5973811">)</span><span class="op" id="5973812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5973816">state</span><span class="op" id="5973821">.</span><span class="ident" id="5973822">fieldnum</span>&nbsp;<span class="op" id="5973831">=</span>&nbsp;<span class="ident" id="5973833">instr</span><span class="op" id="5973838">.</span><span class="ident" id="5973839">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5973846">}</span><br>
<span class="lineno"></span><span class="op" id="5973848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5973851">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5973915">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5973983">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5974050">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5974117">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5974181">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5974248">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5974314">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5974326">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5974393">func</span>&nbsp;<span class="ident" id="5974398">encIndirect</span><span class="op" id="5974409">(</span><span class="ident" id="5974410">pv</span>&nbsp;<span class="ident" id="5974413">reflect</span><span class="op" id="5974420">.</span><span class="ident" id="5974421">Value</span><span class="op" id="5974426">,</span>&nbsp;<span class="ident" id="5974428">indir</span>&nbsp;<span class="builtintype" id="5974434">int</span><span class="op" id="5974437">)</span>&nbsp;<span class="ident" id="5974439">reflect</span><span class="op" id="5974446">.</span><span class="ident" id="5974447">Value</span>&nbsp;<span class="op" id="5974453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974456">for</span>&nbsp;<span class="op" id="5974460">;</span>&nbsp;<span class="ident" id="5974462">indir</span>&nbsp;<span class="op" id="5974468">&gt;</span>&nbsp;<span class="num" id="5974470">0</span><span class="op" id="5974471">;</span>&nbsp;<span class="ident" id="5974473">indir</span><span class="op" id="5974478">--</span>&nbsp;<span class="op" id="5974481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974485">if</span>&nbsp;<span class="ident" id="5974488">pv</span><span class="op" id="5974490">.</span><span class="ident" id="5974491">IsNil</span><span class="op" id="5974496">(</span><span class="op" id="5974497">)</span>&nbsp;<span class="op" id="5974499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974504">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974512">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974516">pv</span>&nbsp;<span class="op" id="5974519">=</span>&nbsp;<span class="ident" id="5974521">pv</span><span class="op" id="5974523">.</span><span class="ident" id="5974524">Elem</span><span class="op" id="5974528">(</span><span class="op" id="5974529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974535">return</span>&nbsp;<span class="ident" id="5974542">pv</span><br>
<span class="lineno"></span><span class="op" id="5974545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5974548">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5974615">func</span>&nbsp;<span class="ident" id="5974620">encBool</span><span class="op" id="5974627">(</span><span class="ident" id="5974628">i</span>&nbsp;<span class="op" id="5974630">*</span><span class="ident" id="5974631">encInstr</span><span class="op" id="5974639">,</span>&nbsp;<span class="ident" id="5974641">state</span>&nbsp;<span class="op" id="5974647">*</span><span class="ident" id="5974648">encoderState</span><span class="op" id="5974660">,</span>&nbsp;<span class="ident" id="5974662">v</span>&nbsp;<span class="ident" id="5974664">reflect</span><span class="op" id="5974671">.</span><span class="ident" id="5974672">Value</span><span class="op" id="5974677">)</span>&nbsp;<span class="op" id="5974679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974682">b</span>&nbsp;<span class="op" id="5974684">:=</span>&nbsp;<span class="ident" id="5974687">v</span><span class="op" id="5974688">.</span><span class="ident" id="5974689">Bool</span><span class="op" id="5974693">(</span><span class="op" id="5974694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974697">if</span>&nbsp;<span class="ident" id="5974700">b</span>&nbsp;<span class="op" id="5974702">||</span>&nbsp;<span class="ident" id="5974705">state</span><span class="op" id="5974710">.</span><span class="ident" id="5974711">sendZero</span>&nbsp;<span class="op" id="5974720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974724">state</span><span class="op" id="5974729">.</span><span class="ident" id="5974730">update</span><span class="op" id="5974736">(</span><span class="ident" id="5974737">i</span><span class="op" id="5974738">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974742">if</span>&nbsp;<span class="ident" id="5974745">b</span>&nbsp;<span class="op" id="5974747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974752">state</span><span class="op" id="5974757">.</span><span class="ident" id="5974758">encodeUint</span><span class="op" id="5974768">(</span><span class="num" id="5974769">1</span><span class="op" id="5974770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974774">}</span>&nbsp;<span class="keyword" id="5974776">else</span>&nbsp;<span class="op" id="5974781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974786">state</span><span class="op" id="5974791">.</span><span class="ident" id="5974792">encodeUint</span><span class="op" id="5974802">(</span><span class="num" id="5974803">0</span><span class="op" id="5974804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974808">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5974811">}</span><br>
<span class="lineno"></span><span class="op" id="5974813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5974816">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5974899">func</span>&nbsp;<span class="ident" id="5974904">encInt</span><span class="op" id="5974910">(</span><span class="ident" id="5974911">i</span>&nbsp;<span class="op" id="5974913">*</span><span class="ident" id="5974914">encInstr</span><span class="op" id="5974922">,</span>&nbsp;<span class="ident" id="5974924">state</span>&nbsp;<span class="op" id="5974930">*</span><span class="ident" id="5974931">encoderState</span><span class="op" id="5974943">,</span>&nbsp;<span class="ident" id="5974945">v</span>&nbsp;<span class="ident" id="5974947">reflect</span><span class="op" id="5974954">.</span><span class="ident" id="5974955">Value</span><span class="op" id="5974960">)</span>&nbsp;<span class="op" id="5974962">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5974965">value</span>&nbsp;<span class="op" id="5974971">:=</span>&nbsp;<span class="ident" id="5974974">v</span><span class="op" id="5974975">.</span><span class="ident" id="5974976">Int</span><span class="op" id="5974979">(</span><span class="op" id="5974980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5974983">if</span>&nbsp;<span class="ident" id="5974986">value</span>&nbsp;<span class="op" id="5974992">!=</span>&nbsp;<span class="num" id="5974995">0</span>&nbsp;<span class="op" id="5974997">||</span>&nbsp;<span class="ident" id="5975000">state</span><span class="op" id="5975005">.</span><span class="ident" id="5975006">sendZero</span>&nbsp;<span class="op" id="5975015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975019">state</span><span class="op" id="5975024">.</span><span class="ident" id="5975025">update</span><span class="op" id="5975031">(</span><span class="ident" id="5975032">i</span><span class="op" id="5975033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975037">state</span><span class="op" id="5975042">.</span><span class="ident" id="5975043">encodeInt</span><span class="op" id="5975052">(</span><span class="ident" id="5975053">value</span><span class="op" id="5975058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975061">}</span><br>
<span class="lineno">180</span><span class="op" id="5975063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5975066">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5975165">func</span>&nbsp;<span class="ident" id="5975170">encUint</span><span class="op" id="5975177">(</span><span class="ident" id="5975178">i</span>&nbsp;<span class="op" id="5975180">*</span><span class="ident" id="5975181">encInstr</span><span class="op" id="5975189">,</span>&nbsp;<span class="ident" id="5975191">state</span>&nbsp;<span class="op" id="5975197">*</span><span class="ident" id="5975198">encoderState</span><span class="op" id="5975210">,</span>&nbsp;<span class="ident" id="5975212">v</span>&nbsp;<span class="ident" id="5975214">reflect</span><span class="op" id="5975221">.</span><span class="ident" id="5975222">Value</span><span class="op" id="5975227">)</span>&nbsp;<span class="op" id="5975229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975232">value</span>&nbsp;<span class="op" id="5975238">:=</span>&nbsp;<span class="ident" id="5975241">v</span><span class="op" id="5975242">.</span><span class="ident" id="5975243">Uint</span><span class="op" id="5975247">(</span><span class="op" id="5975248">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975251">if</span>&nbsp;<span class="ident" id="5975254">value</span>&nbsp;<span class="op" id="5975260">!=</span>&nbsp;<span class="num" id="5975263">0</span>&nbsp;<span class="op" id="5975265">||</span>&nbsp;<span class="ident" id="5975268">state</span><span class="op" id="5975273">.</span><span class="ident" id="5975274">sendZero</span>&nbsp;<span class="op" id="5975283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975287">state</span><span class="op" id="5975292">.</span><span class="ident" id="5975293">update</span><span class="op" id="5975299">(</span><span class="ident" id="5975300">i</span><span class="op" id="5975301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975305">state</span><span class="op" id="5975310">.</span><span class="ident" id="5975311">encodeUint</span><span class="op" id="5975321">(</span><span class="ident" id="5975322">value</span><span class="op" id="5975327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975330">}</span><br>
<span class="lineno"></span><span class="op" id="5975332">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5975335">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5975410">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5975480">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5975552">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5975624">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5975689">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5975703">func</span>&nbsp;<span class="ident" id="5975708">floatBits</span><span class="op" id="5975717">(</span><span class="ident" id="5975718">f</span>&nbsp;<span class="builtintype" id="5975720">float64</span><span class="op" id="5975727">)</span>&nbsp;<span class="ident" id="5975729">uint64</span>&nbsp;<span class="op" id="5975736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975739">u</span>&nbsp;<span class="op" id="5975741">:=</span>&nbsp;<span class="ident" id="5975744">math</span><span class="op" id="5975748">.</span><span class="ident" id="5975749">Float64bits</span><span class="op" id="5975760">(</span><span class="ident" id="5975761">f</span><span class="op" id="5975762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975765">var</span>&nbsp;<span class="ident" id="5975769">v</span>&nbsp;<span class="ident" id="5975771">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975779">for</span>&nbsp;<span class="ident" id="5975783">i</span>&nbsp;<span class="op" id="5975785">:=</span>&nbsp;<span class="num" id="5975788">0</span><span class="op" id="5975789">;</span>&nbsp;<span class="ident" id="5975791">i</span>&nbsp;<span class="op" id="5975793">&lt;</span>&nbsp;<span class="num" id="5975795">8</span><span class="op" id="5975796">;</span>&nbsp;<span class="ident" id="5975798">i</span><span class="op" id="5975799">++</span>&nbsp;<span class="op" id="5975802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975806">v</span>&nbsp;<span class="op" id="5975808">&lt;&lt;=</span>&nbsp;<span class="num" id="5975812">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975816">v</span>&nbsp;<span class="op" id="5975818">|=</span>&nbsp;<span class="ident" id="5975821">u</span>&nbsp;<span class="op" id="5975823">&amp;</span>&nbsp;<span class="num" id="5975825">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5975832">u</span>&nbsp;<span class="op" id="5975834">&gt;&gt;=</span>&nbsp;<span class="num" id="5975838">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5975841">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5975844">return</span>&nbsp;<span class="ident" id="5975851">v</span><br>
<span class="lineno"></span><span class="op" id="5975853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5975856">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5975936">func</span>&nbsp;<span class="ident" id="5975941">encFloat</span><span class="op" id="5975949">(</span><span class="ident" id="5975950">i</span>&nbsp;<span class="op" id="5975952">*</span><span class="ident" id="5975953">encInstr</span><span class="op" id="5975961">,</span>&nbsp;<span class="ident" id="5975963">state</span>&nbsp;<span class="op" id="5975969">*</span><span class="ident" id="5975970">encoderState</span><span class="op" id="5975982">,</span>&nbsp;<span class="ident" id="5975984">v</span>&nbsp;<span class="ident" id="5975986">reflect</span><span class="op" id="5975993">.</span><span class="ident" id="5975994">Value</span><span class="op" id="5975999">)</span>&nbsp;<span class="op" id="5976001">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976004">f</span>&nbsp;<span class="op" id="5976006">:=</span>&nbsp;<span class="ident" id="5976009">v</span><span class="op" id="5976010">.</span><span class="ident" id="5976011">Float</span><span class="op" id="5976016">(</span><span class="op" id="5976017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976020">if</span>&nbsp;<span class="ident" id="5976023">f</span>&nbsp;<span class="op" id="5976025">!=</span>&nbsp;<span class="num" id="5976028">0</span>&nbsp;<span class="op" id="5976030">||</span>&nbsp;<span class="ident" id="5976033">state</span><span class="op" id="5976038">.</span><span class="ident" id="5976039">sendZero</span>&nbsp;<span class="op" id="5976048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976052">bits</span>&nbsp;<span class="op" id="5976057">:=</span>&nbsp;<span class="ident" id="5976060">floatBits</span><span class="op" id="5976069">(</span><span class="ident" id="5976070">f</span><span class="op" id="5976071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976075">state</span><span class="op" id="5976080">.</span><span class="ident" id="5976081">update</span><span class="op" id="5976087">(</span><span class="ident" id="5976088">i</span><span class="op" id="5976089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976093">state</span><span class="op" id="5976098">.</span><span class="ident" id="5976099">encodeUint</span><span class="op" id="5976109">(</span><span class="ident" id="5976110">bits</span><span class="op" id="5976114">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976117">}</span><br>
<span class="lineno"></span><span class="op" id="5976119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5976122">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5976202">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5976281">func</span>&nbsp;<span class="ident" id="5976286">encComplex</span><span class="op" id="5976296">(</span><span class="ident" id="5976297">i</span>&nbsp;<span class="op" id="5976299">*</span><span class="ident" id="5976300">encInstr</span><span class="op" id="5976308">,</span>&nbsp;<span class="ident" id="5976310">state</span>&nbsp;<span class="op" id="5976316">*</span><span class="ident" id="5976317">encoderState</span><span class="op" id="5976329">,</span>&nbsp;<span class="ident" id="5976331">v</span>&nbsp;<span class="ident" id="5976333">reflect</span><span class="op" id="5976340">.</span><span class="ident" id="5976341">Value</span><span class="op" id="5976346">)</span>&nbsp;<span class="op" id="5976348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976351">c</span>&nbsp;<span class="op" id="5976353">:=</span>&nbsp;<span class="ident" id="5976356">v</span><span class="op" id="5976357">.</span><span class="ident" id="5976358">Complex</span><span class="op" id="5976365">(</span><span class="op" id="5976366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976369">if</span>&nbsp;<span class="ident" id="5976372">c</span>&nbsp;<span class="op" id="5976374">!=</span>&nbsp;<span class="num" id="5976377">0</span><span class="op" id="5976378">+</span><span class="num" id="5976379">0i</span>&nbsp;<span class="op" id="5976382">||</span>&nbsp;<span class="ident" id="5976385">state</span><span class="op" id="5976390">.</span><span class="ident" id="5976391">sendZero</span>&nbsp;<span class="op" id="5976400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976404">rpart</span>&nbsp;<span class="op" id="5976410">:=</span>&nbsp;<span class="ident" id="5976413">floatBits</span><span class="op" id="5976422">(</span><span class="builtinfunc" id="5976423">real</span><span class="op" id="5976427">(</span><span class="ident" id="5976428">c</span><span class="op" id="5976429">)</span><span class="op" id="5976430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976434">ipart</span>&nbsp;<span class="op" id="5976440">:=</span>&nbsp;<span class="ident" id="5976443">floatBits</span><span class="op" id="5976452">(</span><span class="builtinfunc" id="5976453">imag</span><span class="op" id="5976457">(</span><span class="ident" id="5976458">c</span><span class="op" id="5976459">)</span><span class="op" id="5976460">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976464">state</span><span class="op" id="5976469">.</span><span class="ident" id="5976470">update</span><span class="op" id="5976476">(</span><span class="ident" id="5976477">i</span><span class="op" id="5976478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976482">state</span><span class="op" id="5976487">.</span><span class="ident" id="5976488">encodeUint</span><span class="op" id="5976498">(</span><span class="ident" id="5976499">rpart</span><span class="op" id="5976504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976508">state</span><span class="op" id="5976513">.</span><span class="ident" id="5976514">encodeUint</span><span class="op" id="5976524">(</span><span class="ident" id="5976525">ipart</span><span class="op" id="5976530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976533">}</span><br>
<span class="lineno"></span><span class="op" id="5976535">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5976538">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5976595">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5976670">func</span>&nbsp;<span class="ident" id="5976675">encUint8Array</span><span class="op" id="5976688">(</span><span class="ident" id="5976689">i</span>&nbsp;<span class="op" id="5976691">*</span><span class="ident" id="5976692">encInstr</span><span class="op" id="5976700">,</span>&nbsp;<span class="ident" id="5976702">state</span>&nbsp;<span class="op" id="5976708">*</span><span class="ident" id="5976709">encoderState</span><span class="op" id="5976721">,</span>&nbsp;<span class="ident" id="5976723">v</span>&nbsp;<span class="ident" id="5976725">reflect</span><span class="op" id="5976732">.</span><span class="ident" id="5976733">Value</span><span class="op" id="5976738">)</span>&nbsp;<span class="op" id="5976740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976743">b</span>&nbsp;<span class="op" id="5976745">:=</span>&nbsp;<span class="ident" id="5976748">v</span><span class="op" id="5976749">.</span><span class="ident" id="5976750">Bytes</span><span class="op" id="5976755">(</span><span class="op" id="5976756">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5976759">if</span>&nbsp;<span class="builtinfunc" id="5976762">len</span><span class="op" id="5976765">(</span><span class="ident" id="5976766">b</span><span class="op" id="5976767">)</span>&nbsp;<span class="op" id="5976769">&gt;</span>&nbsp;<span class="num" id="5976771">0</span>&nbsp;<span class="op" id="5976773">||</span>&nbsp;<span class="ident" id="5976776">state</span><span class="op" id="5976781">.</span><span class="ident" id="5976782">sendZero</span>&nbsp;<span class="op" id="5976791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976795">state</span><span class="op" id="5976800">.</span><span class="ident" id="5976801">update</span><span class="op" id="5976807">(</span><span class="ident" id="5976808">i</span><span class="op" id="5976809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976813">state</span><span class="op" id="5976818">.</span><span class="ident" id="5976819">encodeUint</span><span class="op" id="5976829">(</span><span class="ident" id="5976830">uint64</span><span class="op" id="5976836">(</span><span class="builtinfunc" id="5976837">len</span><span class="op" id="5976840">(</span><span class="ident" id="5976841">b</span><span class="op" id="5976842">)</span><span class="op" id="5976843">)</span><span class="op" id="5976844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5976848">state</span><span class="op" id="5976853">.</span><span class="ident" id="5976854">b</span><span class="op" id="5976855">.</span><span class="ident" id="5976856">Write</span><span class="op" id="5976861">(</span><span class="ident" id="5976862">b</span><span class="op" id="5976863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5976866">}</span><br>
<span class="lineno">240</span><span class="op" id="5976868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5976871">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5976920">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5976991">func</span>&nbsp;<span class="ident" id="5976996">encString</span><span class="op" id="5977005">(</span><span class="ident" id="5977006">i</span>&nbsp;<span class="op" id="5977008">*</span><span class="ident" id="5977009">encInstr</span><span class="op" id="5977017">,</span>&nbsp;<span class="ident" id="5977019">state</span>&nbsp;<span class="op" id="5977025">*</span><span class="ident" id="5977026">encoderState</span><span class="op" id="5977038">,</span>&nbsp;<span class="ident" id="5977040">v</span>&nbsp;<span class="ident" id="5977042">reflect</span><span class="op" id="5977049">.</span><span class="ident" id="5977050">Value</span><span class="op" id="5977055">)</span>&nbsp;<span class="op" id="5977057">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977060">s</span>&nbsp;<span class="op" id="5977062">:=</span>&nbsp;<span class="ident" id="5977065">v</span><span class="op" id="5977066">.</span><span class="ident" id="5977067">String</span><span class="op" id="5977073">(</span><span class="op" id="5977074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977077">if</span>&nbsp;<span class="builtinfunc" id="5977080">len</span><span class="op" id="5977083">(</span><span class="ident" id="5977084">s</span><span class="op" id="5977085">)</span>&nbsp;<span class="op" id="5977087">&gt;</span>&nbsp;<span class="num" id="5977089">0</span>&nbsp;<span class="op" id="5977091">||</span>&nbsp;<span class="ident" id="5977094">state</span><span class="op" id="5977099">.</span><span class="ident" id="5977100">sendZero</span>&nbsp;<span class="op" id="5977109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977113">state</span><span class="op" id="5977118">.</span><span class="ident" id="5977119">update</span><span class="op" id="5977125">(</span><span class="ident" id="5977126">i</span><span class="op" id="5977127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977131">state</span><span class="op" id="5977136">.</span><span class="ident" id="5977137">encodeUint</span><span class="op" id="5977147">(</span><span class="ident" id="5977148">uint64</span><span class="op" id="5977154">(</span><span class="builtinfunc" id="5977155">len</span><span class="op" id="5977158">(</span><span class="ident" id="5977159">s</span><span class="op" id="5977160">)</span><span class="op" id="5977161">)</span><span class="op" id="5977162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977166">state</span><span class="op" id="5977171">.</span><span class="ident" id="5977172">b</span><span class="op" id="5977173">.</span><span class="ident" id="5977174">WriteString</span><span class="op" id="5977185">(</span><span class="ident" id="5977186">s</span><span class="op" id="5977187">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977190">}</span><br>
<span class="lineno"></span><span class="op" id="5977192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5977195">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5977255">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5977286">func</span>&nbsp;<span class="ident" id="5977291">encStructTerminator</span><span class="op" id="5977310">(</span><span class="ident" id="5977311">i</span>&nbsp;<span class="op" id="5977313">*</span><span class="ident" id="5977314">encInstr</span><span class="op" id="5977322">,</span>&nbsp;<span class="ident" id="5977324">state</span>&nbsp;<span class="op" id="5977330">*</span><span class="ident" id="5977331">encoderState</span><span class="op" id="5977343">,</span>&nbsp;<span class="ident" id="5977345">v</span>&nbsp;<span class="ident" id="5977347">reflect</span><span class="op" id="5977354">.</span><span class="ident" id="5977355">Value</span><span class="op" id="5977360">)</span>&nbsp;<span class="op" id="5977362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977365">state</span><span class="op" id="5977370">.</span><span class="ident" id="5977371">encodeUint</span><span class="op" id="5977381">(</span><span class="num" id="5977382">0</span><span class="op" id="5977383">)</span><br>
<span class="lineno"></span><span class="op" id="5977385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5977388">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5977409">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5977487">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5977567">type</span>&nbsp;<span class="ident" id="5977572">encEngine</span>&nbsp;<span class="keyword" id="5977582">struct</span>&nbsp;<span class="op" id="5977589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5977592">instr</span>&nbsp;<span class="op" id="5977598">[</span><span class="op" id="5977599">]</span><span class="ident" id="5977600">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5977609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5977612">const</span>&nbsp;<span class="ident" id="5977618">singletonField</span>&nbsp;<span class="op" id="5977633">=</span>&nbsp;<span class="num" id="5977635">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5977638">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5977705">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5977759">func</span>&nbsp;<span class="ident" id="5977764">valid</span><span class="op" id="5977769">(</span><span class="ident" id="5977770">v</span>&nbsp;<span class="ident" id="5977772">reflect</span><span class="op" id="5977779">.</span><span class="ident" id="5977780">Value</span><span class="op" id="5977785">)</span>&nbsp;<span class="builtintype" id="5977787">bool</span>&nbsp;<span class="op" id="5977792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977795">switch</span>&nbsp;<span class="ident" id="5977802">v</span><span class="op" id="5977803">.</span><span class="ident" id="5977804">Kind</span><span class="op" id="5977808">(</span><span class="op" id="5977809">)</span>&nbsp;<span class="op" id="5977811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977814">case</span>&nbsp;<span class="ident" id="5977819">reflect</span><span class="op" id="5977826">.</span><span class="ident" id="5977827">Invalid</span><span class="op" id="5977834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977838">return</span>&nbsp;<span class="builtintype" id="5977845">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977852">case</span>&nbsp;<span class="ident" id="5977857">reflect</span><span class="op" id="5977864">.</span><span class="ident" id="5977865">Ptr</span><span class="op" id="5977868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977872">return</span>&nbsp;<span class="op" id="5977879">!</span><span class="ident" id="5977880">v</span><span class="op" id="5977881">.</span><span class="ident" id="5977882">IsNil</span><span class="op" id="5977887">(</span><span class="op" id="5977888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5977891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5977894">return</span>&nbsp;<span class="builtintype" id="5977901">true</span><br>
<span class="lineno"></span><span class="op" id="5977906">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5977909">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5977970">func</span>&nbsp;<span class="op" id="5977975">(</span><span class="ident" id="5977976">enc</span>&nbsp;<span class="op" id="5977980">*</span><span class="ident" id="5977981">Encoder</span><span class="op" id="5977988">)</span>&nbsp;<span class="ident" id="5977990">encodeSingle</span><span class="op" id="5978002">(</span><span class="ident" id="5978003">b</span>&nbsp;<span class="op" id="5978005">*</span><span class="ident" id="5978006">encBuffer</span><span class="op" id="5978015">,</span>&nbsp;<span class="ident" id="5978017">engine</span>&nbsp;<span class="op" id="5978024">*</span><span class="ident" id="5978025">encEngine</span><span class="op" id="5978034">,</span>&nbsp;<span class="ident" id="5978036">value</span>&nbsp;<span class="ident" id="5978042">reflect</span><span class="op" id="5978049">.</span><span class="ident" id="5978050">Value</span><span class="op" id="5978055">)</span>&nbsp;<span class="op" id="5978057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978060">state</span>&nbsp;<span class="op" id="5978066">:=</span>&nbsp;<span class="ident" id="5978069">enc</span><span class="op" id="5978072">.</span><span class="ident" id="5978073">newEncoderState</span><span class="op" id="5978088">(</span><span class="ident" id="5978089">b</span><span class="op" id="5978090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978093">defer</span>&nbsp;<span class="ident" id="5978099">enc</span><span class="op" id="5978102">.</span><span class="ident" id="5978103">freeEncoderState</span><span class="op" id="5978119">(</span><span class="ident" id="5978120">state</span><span class="op" id="5978125">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978128">state</span><span class="op" id="5978133">.</span><span class="ident" id="5978134">fieldnum</span>&nbsp;<span class="op" id="5978143">=</span>&nbsp;<span class="ident" id="5978145">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5978161">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5978234">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978305">state</span><span class="op" id="5978310">.</span><span class="ident" id="5978311">sendZero</span>&nbsp;<span class="op" id="5978320">=</span>&nbsp;<span class="builtintype" id="5978322">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978328">instr</span>&nbsp;<span class="op" id="5978334">:=</span>&nbsp;<span class="op" id="5978337">&amp;</span><span class="ident" id="5978338">engine</span><span class="op" id="5978344">.</span><span class="ident" id="5978345">instr</span><span class="op" id="5978350">[</span><span class="ident" id="5978351">singletonField</span><span class="op" id="5978365">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978368">if</span>&nbsp;<span class="ident" id="5978371">instr</span><span class="op" id="5978376">.</span><span class="ident" id="5978377">indir</span>&nbsp;<span class="op" id="5978383">&gt;</span>&nbsp;<span class="num" id="5978385">0</span>&nbsp;<span class="op" id="5978387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978391">value</span>&nbsp;<span class="op" id="5978397">=</span>&nbsp;<span class="ident" id="5978399">encIndirect</span><span class="op" id="5978410">(</span><span class="ident" id="5978411">value</span><span class="op" id="5978416">,</span>&nbsp;<span class="ident" id="5978418">instr</span><span class="op" id="5978423">.</span><span class="ident" id="5978424">indir</span><span class="op" id="5978429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978435">if</span>&nbsp;<span class="ident" id="5978438">valid</span><span class="op" id="5978443">(</span><span class="ident" id="5978444">value</span><span class="op" id="5978449">)</span>&nbsp;<span class="op" id="5978451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978455">instr</span><span class="op" id="5978460">.</span><span class="ident" id="5978461">op</span><span class="op" id="5978463">(</span><span class="ident" id="5978464">instr</span><span class="op" id="5978469">,</span>&nbsp;<span class="ident" id="5978471">state</span><span class="op" id="5978476">,</span>&nbsp;<span class="ident" id="5978478">value</span><span class="op" id="5978483">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978486">}</span><br>
<span class="lineno"></span><span class="op" id="5978488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5978491">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5978538">func</span>&nbsp;<span class="op" id="5978543">(</span><span class="ident" id="5978544">enc</span>&nbsp;<span class="op" id="5978548">*</span><span class="ident" id="5978549">Encoder</span><span class="op" id="5978556">)</span>&nbsp;<span class="ident" id="5978558">encodeStruct</span><span class="op" id="5978570">(</span><span class="ident" id="5978571">b</span>&nbsp;<span class="op" id="5978573">*</span><span class="ident" id="5978574">encBuffer</span><span class="op" id="5978583">,</span>&nbsp;<span class="ident" id="5978585">engine</span>&nbsp;<span class="op" id="5978592">*</span><span class="ident" id="5978593">encEngine</span><span class="op" id="5978602">,</span>&nbsp;<span class="ident" id="5978604">value</span>&nbsp;<span class="ident" id="5978610">reflect</span><span class="op" id="5978617">.</span><span class="ident" id="5978618">Value</span><span class="op" id="5978623">)</span>&nbsp;<span class="op" id="5978625">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978628">if</span>&nbsp;<span class="op" id="5978631">!</span><span class="ident" id="5978632">valid</span><span class="op" id="5978637">(</span><span class="ident" id="5978638">value</span><span class="op" id="5978643">)</span>&nbsp;<span class="op" id="5978645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978649">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978660">state</span>&nbsp;<span class="op" id="5978666">:=</span>&nbsp;<span class="ident" id="5978669">enc</span><span class="op" id="5978672">.</span><span class="ident" id="5978673">newEncoderState</span><span class="op" id="5978688">(</span><span class="ident" id="5978689">b</span><span class="op" id="5978690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978693">defer</span>&nbsp;<span class="ident" id="5978699">enc</span><span class="op" id="5978702">.</span><span class="ident" id="5978703">freeEncoderState</span><span class="op" id="5978719">(</span><span class="ident" id="5978720">state</span><span class="op" id="5978725">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978728">state</span><span class="op" id="5978733">.</span><span class="ident" id="5978734">fieldnum</span>&nbsp;<span class="op" id="5978743">=</span>&nbsp;<span class="op" id="5978745">-</span><span class="num" id="5978746">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978749">for</span>&nbsp;<span class="ident" id="5978753">i</span>&nbsp;<span class="op" id="5978755">:=</span>&nbsp;<span class="num" id="5978758">0</span><span class="op" id="5978759">;</span>&nbsp;<span class="ident" id="5978761">i</span>&nbsp;<span class="op" id="5978763">&lt;</span>&nbsp;<span class="builtinfunc" id="5978765">len</span><span class="op" id="5978768">(</span><span class="ident" id="5978769">engine</span><span class="op" id="5978775">.</span><span class="ident" id="5978776">instr</span><span class="op" id="5978781">)</span><span class="op" id="5978782">;</span>&nbsp;<span class="ident" id="5978784">i</span><span class="op" id="5978785">++</span>&nbsp;<span class="op" id="5978788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978792">instr</span>&nbsp;<span class="op" id="5978798">:=</span>&nbsp;<span class="op" id="5978801">&amp;</span><span class="ident" id="5978802">engine</span><span class="op" id="5978808">.</span><span class="ident" id="5978809">instr</span><span class="op" id="5978814">[</span><span class="ident" id="5978815">i</span><span class="op" id="5978816">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978820">if</span>&nbsp;<span class="ident" id="5978823">i</span>&nbsp;<span class="op" id="5978825">&gt;=</span>&nbsp;<span class="ident" id="5978828">value</span><span class="op" id="5978833">.</span><span class="ident" id="5978834">NumField</span><span class="op" id="5978842">(</span><span class="op" id="5978843">)</span>&nbsp;<span class="op" id="5978845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5978850">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978876">instr</span><span class="op" id="5978881">.</span><span class="ident" id="5978882">op</span><span class="op" id="5978884">(</span><span class="ident" id="5978885">instr</span><span class="op" id="5978890">,</span>&nbsp;<span class="ident" id="5978892">state</span><span class="op" id="5978897">,</span>&nbsp;<span class="ident" id="5978899">reflect</span><span class="op" id="5978906">.</span><span class="ident" id="5978907">Value</span><span class="op" id="5978912">{</span><span class="op" id="5978913">}</span><span class="op" id="5978914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978919">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5978927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978931">field</span>&nbsp;<span class="op" id="5978937">:=</span>&nbsp;<span class="ident" id="5978940">value</span><span class="op" id="5978945">.</span><span class="ident" id="5978946">FieldByIndex</span><span class="op" id="5978958">(</span><span class="ident" id="5978959">instr</span><span class="op" id="5978964">.</span><span class="ident" id="5978965">index</span><span class="op" id="5978970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5978974">if</span>&nbsp;<span class="ident" id="5978977">instr</span><span class="op" id="5978982">.</span><span class="ident" id="5978983">indir</span>&nbsp;<span class="op" id="5978989">&gt;</span>&nbsp;<span class="num" id="5978991">0</span>&nbsp;<span class="op" id="5978993">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5978998">field</span>&nbsp;<span class="op" id="5979004">=</span>&nbsp;<span class="ident" id="5979006">encIndirect</span><span class="op" id="5979017">(</span><span class="ident" id="5979018">field</span><span class="op" id="5979023">,</span>&nbsp;<span class="ident" id="5979025">instr</span><span class="op" id="5979030">.</span><span class="ident" id="5979031">indir</span><span class="op" id="5979036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5979041">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979113">if</span>&nbsp;<span class="op" id="5979116">!</span><span class="ident" id="5979117">valid</span><span class="op" id="5979122">(</span><span class="ident" id="5979123">field</span><span class="op" id="5979128">)</span>&nbsp;<span class="op" id="5979130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979136">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979148">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979156">instr</span><span class="op" id="5979161">.</span><span class="ident" id="5979162">op</span><span class="op" id="5979164">(</span><span class="ident" id="5979165">instr</span><span class="op" id="5979170">,</span>&nbsp;<span class="ident" id="5979172">state</span><span class="op" id="5979177">,</span>&nbsp;<span class="ident" id="5979179">field</span><span class="op" id="5979184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979187">}</span><br>
<span class="lineno"></span><span class="op" id="5979189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5979192">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5979225">func</span>&nbsp;<span class="op" id="5979230">(</span><span class="ident" id="5979231">enc</span>&nbsp;<span class="op" id="5979235">*</span><span class="ident" id="5979236">Encoder</span><span class="op" id="5979243">)</span>&nbsp;<span class="ident" id="5979245">encodeArray</span><span class="op" id="5979256">(</span><span class="ident" id="5979257">b</span>&nbsp;<span class="op" id="5979259">*</span><span class="ident" id="5979260">encBuffer</span><span class="op" id="5979269">,</span>&nbsp;<span class="ident" id="5979271">value</span>&nbsp;<span class="ident" id="5979277">reflect</span><span class="op" id="5979284">.</span><span class="ident" id="5979285">Value</span><span class="op" id="5979290">,</span>&nbsp;<span class="ident" id="5979292">op</span>&nbsp;<span class="ident" id="5979295">encOp</span><span class="op" id="5979300">,</span>&nbsp;<span class="ident" id="5979302">elemIndir</span>&nbsp;<span class="builtintype" id="5979312">int</span><span class="op" id="5979315">,</span>&nbsp;<span class="ident" id="5979317">length</span>&nbsp;<span class="builtintype" id="5979324">int</span><span class="op" id="5979327">,</span>&nbsp;<span class="ident" id="5979329">helper</span>&nbsp;<span class="ident" id="5979336">encHelper</span><span class="op" id="5979345">)</span>&nbsp;<span class="op" id="5979347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979350">state</span>&nbsp;<span class="op" id="5979356">:=</span>&nbsp;<span class="ident" id="5979359">enc</span><span class="op" id="5979362">.</span><span class="ident" id="5979363">newEncoderState</span><span class="op" id="5979378">(</span><span class="ident" id="5979379">b</span><span class="op" id="5979380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979383">defer</span>&nbsp;<span class="ident" id="5979389">enc</span><span class="op" id="5979392">.</span><span class="ident" id="5979393">freeEncoderState</span><span class="op" id="5979409">(</span><span class="ident" id="5979410">state</span><span class="op" id="5979415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979418">state</span><span class="op" id="5979423">.</span><span class="ident" id="5979424">fieldnum</span>&nbsp;<span class="op" id="5979433">=</span>&nbsp;<span class="op" id="5979435">-</span><span class="num" id="5979436">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979439">state</span><span class="op" id="5979444">.</span><span class="ident" id="5979445">sendZero</span>&nbsp;<span class="op" id="5979454">=</span>&nbsp;<span class="builtintype" id="5979456">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979462">state</span><span class="op" id="5979467">.</span><span class="ident" id="5979468">encodeUint</span><span class="op" id="5979478">(</span><span class="ident" id="5979479">uint64</span><span class="op" id="5979485">(</span><span class="ident" id="5979486">length</span><span class="op" id="5979492">)</span><span class="op" id="5979493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979496">if</span>&nbsp;<span class="ident" id="5979499">helper</span>&nbsp;<span class="op" id="5979506">!=</span>&nbsp;<span class="ident" id="5979509">nil</span>&nbsp;<span class="op" id="5979513">&amp;&amp;</span>&nbsp;<span class="ident" id="5979516">helper</span><span class="op" id="5979522">(</span><span class="ident" id="5979523">state</span><span class="op" id="5979528">,</span>&nbsp;<span class="ident" id="5979530">value</span><span class="op" id="5979535">)</span>&nbsp;<span class="op" id="5979537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979541">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979549">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979552">for</span>&nbsp;<span class="ident" id="5979556">i</span>&nbsp;<span class="op" id="5979558">:=</span>&nbsp;<span class="num" id="5979561">0</span><span class="op" id="5979562">;</span>&nbsp;<span class="ident" id="5979564">i</span>&nbsp;<span class="op" id="5979566">&lt;</span>&nbsp;<span class="ident" id="5979568">length</span><span class="op" id="5979574">;</span>&nbsp;<span class="ident" id="5979576">i</span><span class="op" id="5979577">++</span>&nbsp;<span class="op" id="5979580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979584">elem</span>&nbsp;<span class="op" id="5979589">:=</span>&nbsp;<span class="ident" id="5979592">value</span><span class="op" id="5979597">.</span><span class="ident" id="5979598">Index</span><span class="op" id="5979603">(</span><span class="ident" id="5979604">i</span><span class="op" id="5979605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979609">if</span>&nbsp;<span class="ident" id="5979612">elemIndir</span>&nbsp;<span class="op" id="5979622">&gt;</span>&nbsp;<span class="num" id="5979624">0</span>&nbsp;<span class="op" id="5979626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979631">elem</span>&nbsp;<span class="op" id="5979636">=</span>&nbsp;<span class="ident" id="5979638">encIndirect</span><span class="op" id="5979649">(</span><span class="ident" id="5979650">elem</span><span class="op" id="5979654">,</span>&nbsp;<span class="ident" id="5979656">elemIndir</span><span class="op" id="5979665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5979670">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979741">if</span>&nbsp;<span class="op" id="5979744">!</span><span class="ident" id="5979745">valid</span><span class="op" id="5979750">(</span><span class="ident" id="5979751">elem</span><span class="op" id="5979755">)</span>&nbsp;<span class="op" id="5979757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979763">errorf</span><span class="op" id="5979769">(</span><span class="string" id="5979770">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5979796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5979809">op</span><span class="op" id="5979811">(</span><span class="ident" id="5979812">nil</span><span class="op" id="5979815">,</span>&nbsp;<span class="ident" id="5979817">state</span><span class="op" id="5979822">,</span>&nbsp;<span class="ident" id="5979824">elem</span><span class="op" id="5979828">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5979831">}</span><br>
<span class="lineno"></span><span class="op" id="5979833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5979836">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5979904">func</span>&nbsp;<span class="ident" id="5979909">encodeReflectValue</span><span class="op" id="5979927">(</span><span class="ident" id="5979928">state</span>&nbsp;<span class="op" id="5979934">*</span><span class="ident" id="5979935">encoderState</span><span class="op" id="5979947">,</span>&nbsp;<span class="ident" id="5979949">v</span>&nbsp;<span class="ident" id="5979951">reflect</span><span class="op" id="5979958">.</span><span class="ident" id="5979959">Value</span><span class="op" id="5979964">,</span>&nbsp;<span class="ident" id="5979966">op</span>&nbsp;<span class="ident" id="5979969">encOp</span><span class="op" id="5979974">,</span>&nbsp;<span class="ident" id="5979976">indir</span>&nbsp;<span class="builtintype" id="5979982">int</span><span class="op" id="5979985">)</span>&nbsp;<span class="op" id="5979987">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5979990">for</span>&nbsp;<span class="ident" id="5979994">i</span>&nbsp;<span class="op" id="5979996">:=</span>&nbsp;<span class="num" id="5979999">0</span><span class="op" id="5980000">;</span>&nbsp;<span class="ident" id="5980002">i</span>&nbsp;<span class="op" id="5980004">&lt;</span>&nbsp;<span class="ident" id="5980006">indir</span>&nbsp;<span class="op" id="5980012">&amp;&amp;</span>&nbsp;<span class="ident" id="5980015">v</span><span class="op" id="5980016">.</span><span class="ident" id="5980017">IsValid</span><span class="op" id="5980024">(</span><span class="op" id="5980025">)</span><span class="op" id="5980026">;</span>&nbsp;<span class="ident" id="5980028">i</span><span class="op" id="5980029">++</span>&nbsp;<span class="op" id="5980032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980036">v</span>&nbsp;<span class="op" id="5980038">=</span>&nbsp;<span class="ident" id="5980040">reflect</span><span class="op" id="5980047">.</span><span class="ident" id="5980048">Indirect</span><span class="op" id="5980056">(</span><span class="ident" id="5980057">v</span><span class="op" id="5980058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980064">if</span>&nbsp;<span class="op" id="5980067">!</span><span class="ident" id="5980068">v</span><span class="op" id="5980069">.</span><span class="ident" id="5980070">IsValid</span><span class="op" id="5980077">(</span><span class="op" id="5980078">)</span>&nbsp;<span class="op" id="5980080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980084">errorf</span><span class="op" id="5980090">(</span><span class="string" id="5980091">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5980124">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980130">op</span><span class="op" id="5980132">(</span><span class="ident" id="5980133">nil</span><span class="op" id="5980136">,</span>&nbsp;<span class="ident" id="5980138">state</span><span class="op" id="5980143">,</span>&nbsp;<span class="ident" id="5980145">v</span><span class="op" id="5980146">)</span><br>
<span class="lineno"></span><span class="op" id="5980148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5980151">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5980225">func</span>&nbsp;<span class="op" id="5980230">(</span><span class="ident" id="5980231">enc</span>&nbsp;<span class="op" id="5980235">*</span><span class="ident" id="5980236">Encoder</span><span class="op" id="5980243">)</span>&nbsp;<span class="ident" id="5980245">encodeMap</span><span class="op" id="5980254">(</span><span class="ident" id="5980255">b</span>&nbsp;<span class="op" id="5980257">*</span><span class="ident" id="5980258">encBuffer</span><span class="op" id="5980267">,</span>&nbsp;<span class="ident" id="5980269">mv</span>&nbsp;<span class="ident" id="5980272">reflect</span><span class="op" id="5980279">.</span><span class="ident" id="5980280">Value</span><span class="op" id="5980285">,</span>&nbsp;<span class="ident" id="5980287">keyOp</span><span class="op" id="5980292">,</span>&nbsp;<span class="ident" id="5980294">elemOp</span>&nbsp;<span class="ident" id="5980301">encOp</span><span class="op" id="5980306">,</span>&nbsp;<span class="ident" id="5980308">keyIndir</span><span class="op" id="5980316">,</span>&nbsp;<span class="ident" id="5980318">elemIndir</span>&nbsp;<span class="builtintype" id="5980328">int</span><span class="op" id="5980331">)</span>&nbsp;<span class="op" id="5980333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980336">state</span>&nbsp;<span class="op" id="5980342">:=</span>&nbsp;<span class="ident" id="5980345">enc</span><span class="op" id="5980348">.</span><span class="ident" id="5980349">newEncoderState</span><span class="op" id="5980364">(</span><span class="ident" id="5980365">b</span><span class="op" id="5980366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980369">state</span><span class="op" id="5980374">.</span><span class="ident" id="5980375">fieldnum</span>&nbsp;<span class="op" id="5980384">=</span>&nbsp;<span class="op" id="5980386">-</span><span class="num" id="5980387">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980390">state</span><span class="op" id="5980395">.</span><span class="ident" id="5980396">sendZero</span>&nbsp;<span class="op" id="5980405">=</span>&nbsp;<span class="builtintype" id="5980407">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980413">keys</span>&nbsp;<span class="op" id="5980418">:=</span>&nbsp;<span class="ident" id="5980421">mv</span><span class="op" id="5980423">.</span><span class="ident" id="5980424">MapKeys</span><span class="op" id="5980431">(</span><span class="op" id="5980432">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980435">state</span><span class="op" id="5980440">.</span><span class="ident" id="5980441">encodeUint</span><span class="op" id="5980451">(</span><span class="ident" id="5980452">uint64</span><span class="op" id="5980458">(</span><span class="builtinfunc" id="5980459">len</span><span class="op" id="5980462">(</span><span class="ident" id="5980463">keys</span><span class="op" id="5980467">)</span><span class="op" id="5980468">)</span><span class="op" id="5980469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5980472">for</span>&nbsp;<span class="ident" id="5980476">_</span><span class="op" id="5980477">,</span>&nbsp;<span class="ident" id="5980479">key</span>&nbsp;<span class="op" id="5980483">:=</span>&nbsp;<span class="keyword" id="5980486">range</span>&nbsp;<span class="ident" id="5980492">keys</span>&nbsp;<span class="op" id="5980497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980501">encodeReflectValue</span><span class="op" id="5980519">(</span><span class="ident" id="5980520">state</span><span class="op" id="5980525">,</span>&nbsp;<span class="ident" id="5980527">key</span><span class="op" id="5980530">,</span>&nbsp;<span class="ident" id="5980532">keyOp</span><span class="op" id="5980537">,</span>&nbsp;<span class="ident" id="5980539">keyIndir</span><span class="op" id="5980547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980551">encodeReflectValue</span><span class="op" id="5980569">(</span><span class="ident" id="5980570">state</span><span class="op" id="5980575">,</span>&nbsp;<span class="ident" id="5980577">mv</span><span class="op" id="5980579">.</span><span class="ident" id="5980580">MapIndex</span><span class="op" id="5980588">(</span><span class="ident" id="5980589">key</span><span class="op" id="5980592">)</span><span class="op" id="5980593">,</span>&nbsp;<span class="ident" id="5980595">elemOp</span><span class="op" id="5980601">,</span>&nbsp;<span class="ident" id="5980603">elemIndir</span><span class="op" id="5980612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5980615">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5980618">enc</span><span class="op" id="5980621">.</span><span class="ident" id="5980622">freeEncoderState</span><span class="op" id="5980638">(</span><span class="ident" id="5980639">state</span><span class="op" id="5980644">)</span><br>
<span class="lineno"></span><span class="op" id="5980646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5980649">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5980700">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5980782">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5980869">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5980952">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5980977">func</span>&nbsp;<span class="op" id="5980982">(</span><span class="ident" id="5980983">enc</span>&nbsp;<span class="op" id="5980987">*</span><span class="ident" id="5980988">Encoder</span><span class="op" id="5980995">)</span>&nbsp;<span class="ident" id="5980997">encodeInterface</span><span class="op" id="5981012">(</span><span class="ident" id="5981013">b</span>&nbsp;<span class="op" id="5981015">*</span><span class="ident" id="5981016">encBuffer</span><span class="op" id="5981025">,</span>&nbsp;<span class="ident" id="5981027">iv</span>&nbsp;<span class="ident" id="5981030">reflect</span><span class="op" id="5981037">.</span><span class="ident" id="5981038">Value</span><span class="op" id="5981043">)</span>&nbsp;<span class="op" id="5981045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981048">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981113">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981184">elem</span>&nbsp;<span class="op" id="5981189">:=</span>&nbsp;<span class="ident" id="5981192">iv</span><span class="op" id="5981194">.</span><span class="ident" id="5981195">Elem</span><span class="op" id="5981199">(</span><span class="op" id="5981200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981203">if</span>&nbsp;<span class="ident" id="5981206">elem</span><span class="op" id="5981210">.</span><span class="ident" id="5981211">Kind</span><span class="op" id="5981215">(</span><span class="op" id="5981216">)</span>&nbsp;<span class="op" id="5981218">==</span>&nbsp;<span class="ident" id="5981221">reflect</span><span class="op" id="5981228">.</span><span class="ident" id="5981229">Ptr</span>&nbsp;<span class="op" id="5981233">&amp;&amp;</span>&nbsp;<span class="ident" id="5981236">elem</span><span class="op" id="5981240">.</span><span class="ident" id="5981241">IsNil</span><span class="op" id="5981246">(</span><span class="op" id="5981247">)</span>&nbsp;<span class="op" id="5981249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981253">errorf</span><span class="op" id="5981259">(</span><span class="string" id="5981260">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5981320">,</span>&nbsp;<span class="ident" id="5981322">iv</span><span class="op" id="5981324">.</span><span class="ident" id="5981325">Elem</span><span class="op" id="5981329">(</span><span class="op" id="5981330">)</span><span class="op" id="5981331">.</span><span class="ident" id="5981332">Type</span><span class="op" id="5981336">(</span><span class="op" id="5981337">)</span><span class="op" id="5981338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981341">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981344">state</span>&nbsp;<span class="op" id="5981350">:=</span>&nbsp;<span class="ident" id="5981353">enc</span><span class="op" id="5981356">.</span><span class="ident" id="5981357">newEncoderState</span><span class="op" id="5981372">(</span><span class="ident" id="5981373">b</span><span class="op" id="5981374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981377">state</span><span class="op" id="5981382">.</span><span class="ident" id="5981383">fieldnum</span>&nbsp;<span class="op" id="5981392">=</span>&nbsp;<span class="op" id="5981394">-</span><span class="num" id="5981395">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981398">state</span><span class="op" id="5981403">.</span><span class="ident" id="5981404">sendZero</span>&nbsp;<span class="op" id="5981413">=</span>&nbsp;<span class="builtintype" id="5981415">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981421">if</span>&nbsp;<span class="ident" id="5981424">iv</span><span class="op" id="5981426">.</span><span class="ident" id="5981427">IsNil</span><span class="op" id="5981432">(</span><span class="op" id="5981433">)</span>&nbsp;<span class="op" id="5981435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981439">state</span><span class="op" id="5981444">.</span><span class="ident" id="5981445">encodeUint</span><span class="op" id="5981455">(</span><span class="num" id="5981456">0</span><span class="op" id="5981457">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981473">ut</span>&nbsp;<span class="op" id="5981476">:=</span>&nbsp;<span class="ident" id="5981479">userType</span><span class="op" id="5981487">(</span><span class="ident" id="5981488">iv</span><span class="op" id="5981490">.</span><span class="ident" id="5981491">Elem</span><span class="op" id="5981495">(</span><span class="op" id="5981496">)</span><span class="op" id="5981497">.</span><span class="ident" id="5981498">Type</span><span class="op" id="5981502">(</span><span class="op" id="5981503">)</span><span class="op" id="5981504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981507">registerLock</span><span class="op" id="5981519">.</span><span class="ident" id="5981520">RLock</span><span class="op" id="5981525">(</span><span class="op" id="5981526">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981529">name</span><span class="op" id="5981533">,</span>&nbsp;<span class="ident" id="5981535">ok</span>&nbsp;<span class="op" id="5981538">:=</span>&nbsp;<span class="ident" id="5981541">concreteTypeToName</span><span class="op" id="5981559">[</span><span class="ident" id="5981560">ut</span><span class="op" id="5981562">.</span><span class="ident" id="5981563">base</span><span class="op" id="5981567">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981570">registerLock</span><span class="op" id="5981582">.</span><span class="ident" id="5981583">RUnlock</span><span class="op" id="5981590">(</span><span class="op" id="5981591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5981594">if</span>&nbsp;<span class="op" id="5981597">!</span><span class="ident" id="5981598">ok</span>&nbsp;<span class="op" id="5981601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981605">errorf</span><span class="op" id="5981611">(</span><span class="string" id="5981612">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5981651">,</span>&nbsp;<span class="ident" id="5981653">ut</span><span class="op" id="5981655">.</span><span class="ident" id="5981656">base</span><span class="op" id="5981660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5981663">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981666">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981685">state</span><span class="op" id="5981690">.</span><span class="ident" id="5981691">encodeUint</span><span class="op" id="5981701">(</span><span class="ident" id="5981702">uint64</span><span class="op" id="5981708">(</span><span class="builtinfunc" id="5981709">len</span><span class="op" id="5981712">(</span><span class="ident" id="5981713">name</span><span class="op" id="5981717">)</span><span class="op" id="5981718">)</span><span class="op" id="5981719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981722">state</span><span class="op" id="5981727">.</span><span class="ident" id="5981728">b</span><span class="op" id="5981729">.</span><span class="ident" id="5981730">WriteString</span><span class="op" id="5981741">(</span><span class="ident" id="5981742">name</span><span class="op" id="5981746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981749">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981786">enc</span><span class="op" id="5981789">.</span><span class="ident" id="5981790">sendTypeDescriptor</span><span class="op" id="5981808">(</span><span class="ident" id="5981809">enc</span><span class="op" id="5981812">.</span><span class="ident" id="5981813">writer</span><span class="op" id="5981819">(</span><span class="op" id="5981820">)</span><span class="op" id="5981821">,</span>&nbsp;<span class="ident" id="5981823">state</span><span class="op" id="5981828">,</span>&nbsp;<span class="ident" id="5981830">ut</span><span class="op" id="5981832">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981835">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5981857">enc</span><span class="op" id="5981860">.</span><span class="ident" id="5981861">sendTypeId</span><span class="op" id="5981871">(</span><span class="ident" id="5981872">state</span><span class="op" id="5981877">,</span>&nbsp;<span class="ident" id="5981879">ut</span><span class="op" id="5981881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981884">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5981953">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982007">enc</span><span class="op" id="5982010">.</span><span class="ident" id="5982011">pushWriter</span><span class="op" id="5982021">(</span><span class="ident" id="5982022">b</span><span class="op" id="5982023">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982026">data</span>&nbsp;<span class="op" id="5982031">:=</span>&nbsp;<span class="builtinfunc" id="5982034">new</span><span class="op" id="5982037">(</span><span class="ident" id="5982038">encBuffer</span><span class="op" id="5982047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982050">data</span><span class="op" id="5982054">.</span><span class="ident" id="5982055">Write</span><span class="op" id="5982060">(</span><span class="ident" id="5982061">spaceForLength</span><span class="op" id="5982075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982078">enc</span><span class="op" id="5982081">.</span><span class="ident" id="5982082">encode</span><span class="op" id="5982088">(</span><span class="ident" id="5982089">data</span><span class="op" id="5982093">,</span>&nbsp;<span class="ident" id="5982095">elem</span><span class="op" id="5982099">,</span>&nbsp;<span class="ident" id="5982101">ut</span><span class="op" id="5982103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982106">if</span>&nbsp;<span class="ident" id="5982109">enc</span><span class="op" id="5982112">.</span><span class="ident" id="5982113">err</span>&nbsp;<span class="op" id="5982117">!=</span>&nbsp;<span class="ident" id="5982120">nil</span>&nbsp;<span class="op" id="5982124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982128">error_</span><span class="op" id="5982134">(</span><span class="ident" id="5982135">enc</span><span class="op" id="5982138">.</span><span class="ident" id="5982139">err</span><span class="op" id="5982142">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982148">enc</span><span class="op" id="5982151">.</span><span class="ident" id="5982152">popWriter</span><span class="op" id="5982161">(</span><span class="op" id="5982162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982165">enc</span><span class="op" id="5982168">.</span><span class="ident" id="5982169">writeMessage</span><span class="op" id="5982181">(</span><span class="ident" id="5982182">b</span><span class="op" id="5982183">,</span>&nbsp;<span class="ident" id="5982185">data</span><span class="op" id="5982189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982192">if</span>&nbsp;<span class="ident" id="5982195">enc</span><span class="op" id="5982198">.</span><span class="ident" id="5982199">err</span>&nbsp;<span class="op" id="5982203">!=</span>&nbsp;<span class="ident" id="5982206">nil</span>&nbsp;<span class="op" id="5982210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982214">error_</span><span class="op" id="5982220">(</span><span class="ident" id="5982221">enc</span><span class="op" id="5982224">.</span><span class="ident" id="5982225">err</span><span class="op" id="5982228">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5982234">enc</span><span class="op" id="5982237">.</span><span class="ident" id="5982238">freeEncoderState</span><span class="op" id="5982254">(</span><span class="ident" id="5982255">state</span><span class="op" id="5982260">)</span><br>
<span class="lineno"></span><span class="op" id="5982262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5982265">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5982326">func</span>&nbsp;<span class="ident" id="5982331">isZero</span><span class="op" id="5982337">(</span><span class="ident" id="5982338">val</span>&nbsp;<span class="ident" id="5982342">reflect</span><span class="op" id="5982349">.</span><span class="ident" id="5982350">Value</span><span class="op" id="5982355">)</span>&nbsp;<span class="builtintype" id="5982357">bool</span>&nbsp;<span class="op" id="5982362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982365">switch</span>&nbsp;<span class="ident" id="5982372">val</span><span class="op" id="5982375">.</span><span class="ident" id="5982376">Kind</span><span class="op" id="5982380">(</span><span class="op" id="5982381">)</span>&nbsp;<span class="op" id="5982383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982386">case</span>&nbsp;<span class="ident" id="5982391">reflect</span><span class="op" id="5982398">.</span><span class="ident" id="5982399">Array</span><span class="op" id="5982404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982408">for</span>&nbsp;<span class="ident" id="5982412">i</span>&nbsp;<span class="op" id="5982414">:=</span>&nbsp;<span class="num" id="5982417">0</span><span class="op" id="5982418">;</span>&nbsp;<span class="ident" id="5982420">i</span>&nbsp;<span class="op" id="5982422">&lt;</span>&nbsp;<span class="ident" id="5982424">val</span><span class="op" id="5982427">.</span><span class="ident" id="5982428">Len</span><span class="op" id="5982431">(</span><span class="op" id="5982432">)</span><span class="op" id="5982433">;</span>&nbsp;<span class="ident" id="5982435">i</span><span class="op" id="5982436">++</span>&nbsp;<span class="op" id="5982439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982444">if</span>&nbsp;<span class="op" id="5982447">!</span><span class="ident" id="5982448">isZero</span><span class="op" id="5982454">(</span><span class="ident" id="5982455">val</span><span class="op" id="5982458">.</span><span class="ident" id="5982459">Index</span><span class="op" id="5982464">(</span><span class="ident" id="5982465">i</span><span class="op" id="5982466">)</span><span class="op" id="5982467">)</span>&nbsp;<span class="op" id="5982469">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982475">return</span>&nbsp;<span class="builtintype" id="5982482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5982495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982499">return</span>&nbsp;<span class="builtintype" id="5982506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982512">case</span>&nbsp;<span class="ident" id="5982517">reflect</span><span class="op" id="5982524">.</span><span class="ident" id="5982525">Map</span><span class="op" id="5982528">,</span>&nbsp;<span class="ident" id="5982530">reflect</span><span class="op" id="5982537">.</span><span class="ident" id="5982538">Slice</span><span class="op" id="5982543">,</span>&nbsp;<span class="ident" id="5982545">reflect</span><span class="op" id="5982552">.</span><span class="ident" id="5982553">String</span><span class="op" id="5982559">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982563">return</span>&nbsp;<span class="ident" id="5982570">val</span><span class="op" id="5982573">.</span><span class="ident" id="5982574">Len</span><span class="op" id="5982577">(</span><span class="op" id="5982578">)</span>&nbsp;<span class="op" id="5982580">==</span>&nbsp;<span class="num" id="5982583">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982586">case</span>&nbsp;<span class="ident" id="5982591">reflect</span><span class="op" id="5982598">.</span><span class="ident" id="5982599">Bool</span><span class="op" id="5982603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982607">return</span>&nbsp;<span class="op" id="5982614">!</span><span class="ident" id="5982615">val</span><span class="op" id="5982618">.</span><span class="ident" id="5982619">Bool</span><span class="op" id="5982623">(</span><span class="op" id="5982624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982627">case</span>&nbsp;<span class="ident" id="5982632">reflect</span><span class="op" id="5982639">.</span><span class="ident" id="5982640">Complex64</span><span class="op" id="5982649">,</span>&nbsp;<span class="ident" id="5982651">reflect</span><span class="op" id="5982658">.</span><span class="ident" id="5982659">Complex128</span><span class="op" id="5982669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982673">return</span>&nbsp;<span class="ident" id="5982680">val</span><span class="op" id="5982683">.</span><span class="ident" id="5982684">Complex</span><span class="op" id="5982691">(</span><span class="op" id="5982692">)</span>&nbsp;<span class="op" id="5982694">==</span>&nbsp;<span class="num" id="5982697">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982700">case</span>&nbsp;<span class="ident" id="5982705">reflect</span><span class="op" id="5982712">.</span><span class="ident" id="5982713">Chan</span><span class="op" id="5982717">,</span>&nbsp;<span class="ident" id="5982719">reflect</span><span class="op" id="5982726">.</span><span class="ident" id="5982727">Func</span><span class="op" id="5982731">,</span>&nbsp;<span class="ident" id="5982733">reflect</span><span class="op" id="5982740">.</span><span class="ident" id="5982741">Interface</span><span class="op" id="5982750">,</span>&nbsp;<span class="ident" id="5982752">reflect</span><span class="op" id="5982759">.</span><span class="ident" id="5982760">Ptr</span><span class="op" id="5982763">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982767">return</span>&nbsp;<span class="ident" id="5982774">val</span><span class="op" id="5982777">.</span><span class="ident" id="5982778">IsNil</span><span class="op" id="5982783">(</span><span class="op" id="5982784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982787">case</span>&nbsp;<span class="ident" id="5982792">reflect</span><span class="op" id="5982799">.</span><span class="ident" id="5982800">Int</span><span class="op" id="5982803">,</span>&nbsp;<span class="ident" id="5982805">reflect</span><span class="op" id="5982812">.</span><span class="ident" id="5982813">Int8</span><span class="op" id="5982817">,</span>&nbsp;<span class="ident" id="5982819">reflect</span><span class="op" id="5982826">.</span><span class="ident" id="5982827">Int16</span><span class="op" id="5982832">,</span>&nbsp;<span class="ident" id="5982834">reflect</span><span class="op" id="5982841">.</span><span class="ident" id="5982842">Int32</span><span class="op" id="5982847">,</span>&nbsp;<span class="ident" id="5982849">reflect</span><span class="op" id="5982856">.</span><span class="ident" id="5982857">Int64</span><span class="op" id="5982862">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982866">return</span>&nbsp;<span class="ident" id="5982873">val</span><span class="op" id="5982876">.</span><span class="ident" id="5982877">Int</span><span class="op" id="5982880">(</span><span class="op" id="5982881">)</span>&nbsp;<span class="op" id="5982883">==</span>&nbsp;<span class="num" id="5982886">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982889">case</span>&nbsp;<span class="ident" id="5982894">reflect</span><span class="op" id="5982901">.</span><span class="ident" id="5982902">Float32</span><span class="op" id="5982909">,</span>&nbsp;<span class="ident" id="5982911">reflect</span><span class="op" id="5982918">.</span><span class="ident" id="5982919">Float64</span><span class="op" id="5982926">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982930">return</span>&nbsp;<span class="ident" id="5982937">val</span><span class="op" id="5982940">.</span><span class="ident" id="5982941">Float</span><span class="op" id="5982946">(</span><span class="op" id="5982947">)</span>&nbsp;<span class="op" id="5982949">==</span>&nbsp;<span class="num" id="5982952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5982955">case</span>&nbsp;<span class="ident" id="5982960">reflect</span><span class="op" id="5982967">.</span><span class="ident" id="5982968">Uint</span><span class="op" id="5982972">,</span>&nbsp;<span class="ident" id="5982974">reflect</span><span class="op" id="5982981">.</span><span class="ident" id="5982982">Uint8</span><span class="op" id="5982987">,</span>&nbsp;<span class="ident" id="5982989">reflect</span><span class="op" id="5982996">.</span><span class="ident" id="5982997">Uint16</span><span class="op" id="5983003">,</span>&nbsp;<span class="ident" id="5983005">reflect</span><span class="op" id="5983012">.</span><span class="ident" id="5983013">Uint32</span><span class="op" id="5983019">,</span>&nbsp;<span class="ident" id="5983021">reflect</span><span class="op" id="5983028">.</span><span class="ident" id="5983029">Uint64</span><span class="op" id="5983035">,</span>&nbsp;<span class="ident" id="5983037">reflect</span><span class="op" id="5983044">.</span><span class="ident" id="5983045">Uintptr</span><span class="op" id="5983052">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983056">return</span>&nbsp;<span class="ident" id="5983063">val</span><span class="op" id="5983066">.</span><span class="ident" id="5983067">Uint</span><span class="op" id="5983071">(</span><span class="op" id="5983072">)</span>&nbsp;<span class="op" id="5983074">==</span>&nbsp;<span class="num" id="5983077">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983080">case</span>&nbsp;<span class="ident" id="5983085">reflect</span><span class="op" id="5983092">.</span><span class="ident" id="5983093">Struct</span><span class="op" id="5983099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983103">for</span>&nbsp;<span class="ident" id="5983107">i</span>&nbsp;<span class="op" id="5983109">:=</span>&nbsp;<span class="num" id="5983112">0</span><span class="op" id="5983113">;</span>&nbsp;<span class="ident" id="5983115">i</span>&nbsp;<span class="op" id="5983117">&lt;</span>&nbsp;<span class="ident" id="5983119">val</span><span class="op" id="5983122">.</span><span class="ident" id="5983123">NumField</span><span class="op" id="5983131">(</span><span class="op" id="5983132">)</span><span class="op" id="5983133">;</span>&nbsp;<span class="ident" id="5983135">i</span><span class="op" id="5983136">++</span>&nbsp;<span class="op" id="5983139">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983144">if</span>&nbsp;<span class="op" id="5983147">!</span><span class="ident" id="5983148">isZero</span><span class="op" id="5983154">(</span><span class="ident" id="5983155">val</span><span class="op" id="5983158">.</span><span class="ident" id="5983159">Field</span><span class="op" id="5983164">(</span><span class="ident" id="5983165">i</span><span class="op" id="5983166">)</span><span class="op" id="5983167">)</span>&nbsp;<span class="op" id="5983169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983175">return</span>&nbsp;<span class="builtintype" id="5983182">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983199">return</span>&nbsp;<span class="builtintype" id="5983206">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5983215">panic</span><span class="op" id="5983220">(</span><span class="string" id="5983221">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5983247">+</span>&nbsp;<span class="ident" id="5983249">val</span><span class="op" id="5983252">.</span><span class="ident" id="5983253">Type</span><span class="op" id="5983257">(</span><span class="op" id="5983258">)</span><span class="op" id="5983259">.</span><span class="ident" id="5983260">String</span><span class="op" id="5983266">(</span><span class="op" id="5983267">)</span><span class="op" id="5983268">)</span><br>
<span class="lineno"></span><span class="op" id="5983270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5983273">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5983348">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5983385">func</span>&nbsp;<span class="op" id="5983390">(</span><span class="ident" id="5983391">enc</span>&nbsp;<span class="op" id="5983395">*</span><span class="ident" id="5983396">Encoder</span><span class="op" id="5983403">)</span>&nbsp;<span class="ident" id="5983405">encodeGobEncoder</span><span class="op" id="5983421">(</span><span class="ident" id="5983422">b</span>&nbsp;<span class="op" id="5983424">*</span><span class="ident" id="5983425">encBuffer</span><span class="op" id="5983434">,</span>&nbsp;<span class="ident" id="5983436">ut</span>&nbsp;<span class="op" id="5983439">*</span><span class="ident" id="5983440">userTypeInfo</span><span class="op" id="5983452">,</span>&nbsp;<span class="ident" id="5983454">v</span>&nbsp;<span class="ident" id="5983456">reflect</span><span class="op" id="5983463">.</span><span class="ident" id="5983464">Value</span><span class="op" id="5983469">)</span>&nbsp;<span class="op" id="5983471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5983474">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983532">var</span>&nbsp;<span class="ident" id="5983536">data</span>&nbsp;<span class="op" id="5983541">[</span><span class="op" id="5983542">]</span><span class="builtintype" id="5983543">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983549">var</span>&nbsp;<span class="ident" id="5983553">err</span>&nbsp;<span class="builtintype" id="5983557">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5983564">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983595">switch</span>&nbsp;<span class="ident" id="5983602">ut</span><span class="op" id="5983604">.</span><span class="ident" id="5983605">externalEnc</span>&nbsp;<span class="op" id="5983617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983620">case</span>&nbsp;<span class="ident" id="5983625">xGob</span><span class="op" id="5983629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983633">data</span><span class="op" id="5983637">,</span>&nbsp;<span class="ident" id="5983639">err</span>&nbsp;<span class="op" id="5983643">=</span>&nbsp;<span class="ident" id="5983645">v</span><span class="op" id="5983646">.</span><span class="ident" id="5983647">Interface</span><span class="op" id="5983656">(</span><span class="op" id="5983657">)</span><span class="op" id="5983658">.</span><span class="op" id="5983659">(</span><span class="ident" id="5983660">GobEncoder</span><span class="op" id="5983670">)</span><span class="op" id="5983671">.</span><span class="ident" id="5983672">GobEncode</span><span class="op" id="5983681">(</span><span class="op" id="5983682">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983685">case</span>&nbsp;<span class="ident" id="5983690">xBinary</span><span class="op" id="5983697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983701">data</span><span class="op" id="5983705">,</span>&nbsp;<span class="ident" id="5983707">err</span>&nbsp;<span class="op" id="5983711">=</span>&nbsp;<span class="ident" id="5983713">v</span><span class="op" id="5983714">.</span><span class="ident" id="5983715">Interface</span><span class="op" id="5983724">(</span><span class="op" id="5983725">)</span><span class="op" id="5983726">.</span><span class="op" id="5983727">(</span><span class="ident" id="5983728">encoding</span><span class="op" id="5983736">.</span><span class="ident" id="5983737">BinaryMarshaler</span><span class="op" id="5983752">)</span><span class="op" id="5983753">.</span><span class="ident" id="5983754">MarshalBinary</span><span class="op" id="5983767">(</span><span class="op" id="5983768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983771">case</span>&nbsp;<span class="ident" id="5983776">xText</span><span class="op" id="5983781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983785">data</span><span class="op" id="5983789">,</span>&nbsp;<span class="ident" id="5983791">err</span>&nbsp;<span class="op" id="5983795">=</span>&nbsp;<span class="ident" id="5983797">v</span><span class="op" id="5983798">.</span><span class="ident" id="5983799">Interface</span><span class="op" id="5983808">(</span><span class="op" id="5983809">)</span><span class="op" id="5983810">.</span><span class="op" id="5983811">(</span><span class="ident" id="5983812">encoding</span><span class="op" id="5983820">.</span><span class="ident" id="5983821">TextMarshaler</span><span class="op" id="5983834">)</span><span class="op" id="5983835">.</span><span class="ident" id="5983836">MarshalText</span><span class="op" id="5983847">(</span><span class="op" id="5983848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983851">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5983854">if</span>&nbsp;<span class="ident" id="5983857">err</span>&nbsp;<span class="op" id="5983861">!=</span>&nbsp;<span class="ident" id="5983864">nil</span>&nbsp;<span class="op" id="5983868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983872">error_</span><span class="op" id="5983878">(</span><span class="ident" id="5983879">err</span><span class="op" id="5983882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5983885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983888">state</span>&nbsp;<span class="op" id="5983894">:=</span>&nbsp;<span class="ident" id="5983897">enc</span><span class="op" id="5983900">.</span><span class="ident" id="5983901">newEncoderState</span><span class="op" id="5983916">(</span><span class="ident" id="5983917">b</span><span class="op" id="5983918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983921">state</span><span class="op" id="5983926">.</span><span class="ident" id="5983927">fieldnum</span>&nbsp;<span class="op" id="5983936">=</span>&nbsp;<span class="op" id="5983938">-</span><span class="num" id="5983939">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983942">state</span><span class="op" id="5983947">.</span><span class="ident" id="5983948">encodeUint</span><span class="op" id="5983958">(</span><span class="ident" id="5983959">uint64</span><span class="op" id="5983965">(</span><span class="builtinfunc" id="5983966">len</span><span class="op" id="5983969">(</span><span class="ident" id="5983970">data</span><span class="op" id="5983974">)</span><span class="op" id="5983975">)</span><span class="op" id="5983976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5983979">state</span><span class="op" id="5983984">.</span><span class="ident" id="5983985">b</span><span class="op" id="5983986">.</span><span class="ident" id="5983987">Write</span><span class="op" id="5983992">(</span><span class="ident" id="5983993">data</span><span class="op" id="5983997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984000">enc</span><span class="op" id="5984003">.</span><span class="ident" id="5984004">freeEncoderState</span><span class="op" id="5984020">(</span><span class="ident" id="5984021">state</span><span class="op" id="5984026">)</span><br>
<span class="lineno"></span><span class="op" id="5984028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5984031">var</span>&nbsp;<span class="ident" id="5984035">encOpTable</span>&nbsp;<span class="op" id="5984046">=</span>&nbsp;<span class="op" id="5984048">[</span><span class="op" id="5984049">...</span><span class="op" id="5984052">]</span><span class="ident" id="5984053">encOp</span><span class="op" id="5984058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984061">reflect</span><span class="op" id="5984068">.</span><span class="ident" id="5984069">Bool</span><span class="op" id="5984073">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984081">encBool</span><span class="op" id="5984088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984091">reflect</span><span class="op" id="5984098">.</span><span class="ident" id="5984099">Int</span><span class="op" id="5984102">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984111">encInt</span><span class="op" id="5984117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984120">reflect</span><span class="op" id="5984127">.</span><span class="ident" id="5984128">Int8</span><span class="op" id="5984132">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984140">encInt</span><span class="op" id="5984146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984149">reflect</span><span class="op" id="5984156">.</span><span class="ident" id="5984157">Int16</span><span class="op" id="5984162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984169">encInt</span><span class="op" id="5984175">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984178">reflect</span><span class="op" id="5984185">.</span><span class="ident" id="5984186">Int32</span><span class="op" id="5984191">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984198">encInt</span><span class="op" id="5984204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984207">reflect</span><span class="op" id="5984214">.</span><span class="ident" id="5984215">Int64</span><span class="op" id="5984220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984227">encInt</span><span class="op" id="5984233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984236">reflect</span><span class="op" id="5984243">.</span><span class="ident" id="5984244">Uint</span><span class="op" id="5984248">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984256">encUint</span><span class="op" id="5984263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984266">reflect</span><span class="op" id="5984273">.</span><span class="ident" id="5984274">Uint8</span><span class="op" id="5984279">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984286">encUint</span><span class="op" id="5984293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984296">reflect</span><span class="op" id="5984303">.</span><span class="ident" id="5984304">Uint16</span><span class="op" id="5984310">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984316">encUint</span><span class="op" id="5984323">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984326">reflect</span><span class="op" id="5984333">.</span><span class="ident" id="5984334">Uint32</span><span class="op" id="5984340">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984346">encUint</span><span class="op" id="5984353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984356">reflect</span><span class="op" id="5984363">.</span><span class="ident" id="5984364">Uint64</span><span class="op" id="5984370">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984376">encUint</span><span class="op" id="5984383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984386">reflect</span><span class="op" id="5984393">.</span><span class="ident" id="5984394">Uintptr</span><span class="op" id="5984401">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984406">encUint</span><span class="op" id="5984413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984416">reflect</span><span class="op" id="5984423">.</span><span class="ident" id="5984424">Float32</span><span class="op" id="5984431">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984436">encFloat</span><span class="op" id="5984444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984447">reflect</span><span class="op" id="5984454">.</span><span class="ident" id="5984455">Float64</span><span class="op" id="5984462">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984467">encFloat</span><span class="op" id="5984475">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984478">reflect</span><span class="op" id="5984485">.</span><span class="ident" id="5984486">Complex64</span><span class="op" id="5984495">:</span>&nbsp;&nbsp;<span class="ident" id="5984498">encComplex</span><span class="op" id="5984508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984511">reflect</span><span class="op" id="5984518">.</span><span class="ident" id="5984519">Complex128</span><span class="op" id="5984529">:</span>&nbsp;<span class="ident" id="5984531">encComplex</span><span class="op" id="5984541">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984544">reflect</span><span class="op" id="5984551">.</span><span class="ident" id="5984552">String</span><span class="op" id="5984558">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5984564">encString</span><span class="op" id="5984573">,</span><br>
<span class="lineno"></span><span class="op" id="5984575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5984578">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5984660">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5984698">func</span>&nbsp;<span class="ident" id="5984703">encOpFor</span><span class="op" id="5984711">(</span><span class="ident" id="5984712">rt</span>&nbsp;<span class="ident" id="5984715">reflect</span><span class="op" id="5984722">.</span><span class="ident" id="5984723">Type</span><span class="op" id="5984727">,</span>&nbsp;<span class="ident" id="5984729">inProgress</span>&nbsp;<span class="keyword" id="5984740">map</span><span class="op" id="5984743">[</span><span class="ident" id="5984744">reflect</span><span class="op" id="5984751">.</span><span class="ident" id="5984752">Type</span><span class="op" id="5984756">]</span><span class="op" id="5984757">*</span><span class="ident" id="5984758">encOp</span><span class="op" id="5984763">,</span>&nbsp;<span class="ident" id="5984765">building</span>&nbsp;<span class="keyword" id="5984774">map</span><span class="op" id="5984777">[</span><span class="op" id="5984778">*</span><span class="ident" id="5984779">typeInfo</span><span class="op" id="5984787">]</span><span class="builtintype" id="5984788">bool</span><span class="op" id="5984792">)</span>&nbsp;<span class="op" id="5984794">(</span><span class="op" id="5984795">*</span><span class="ident" id="5984796">encOp</span><span class="op" id="5984801">,</span>&nbsp;<span class="builtintype" id="5984803">int</span><span class="op" id="5984806">)</span>&nbsp;<span class="op" id="5984808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5984811">ut</span>&nbsp;<span class="op" id="5984814">:=</span>&nbsp;<span class="ident" id="5984817">userType</span><span class="op" id="5984825">(</span><span class="ident" id="5984826">rt</span><span class="op" id="5984828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5984831">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5984911">if</span>&nbsp;<span class="ident" id="5984914">ut</span><span class="op" id="5984916">.</span><span class="ident" id="5984917">externalEnc</span>&nbsp;<span class="op" id="5984929">!=</span>&nbsp;<span class="num" id="5984932">0</span>&nbsp;<span class="op" id="5984934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5984938">return</span>&nbsp;<span class="ident" id="5984945">gobEncodeOpFor</span><span class="op" id="5984959">(</span><span class="ident" id="5984960">ut</span><span class="op" id="5984962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5984965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5984968">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5985053">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985110">if</span>&nbsp;<span class="ident" id="5985113">opPtr</span>&nbsp;<span class="op" id="5985119">:=</span>&nbsp;<span class="ident" id="5985122">inProgress</span><span class="op" id="5985132">[</span><span class="ident" id="5985133">rt</span><span class="op" id="5985135">]</span><span class="op" id="5985136">;</span>&nbsp;<span class="ident" id="5985138">opPtr</span>&nbsp;<span class="op" id="5985144">!=</span>&nbsp;<span class="ident" id="5985147">nil</span>&nbsp;<span class="op" id="5985151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985155">return</span>&nbsp;<span class="ident" id="5985162">opPtr</span><span class="op" id="5985167">,</span>&nbsp;<span class="ident" id="5985169">ut</span><span class="op" id="5985171">.</span><span class="ident" id="5985172">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5985179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985182">typ</span>&nbsp;<span class="op" id="5985186">:=</span>&nbsp;<span class="ident" id="5985189">ut</span><span class="op" id="5985191">.</span><span class="ident" id="5985192">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985198">indir</span>&nbsp;<span class="op" id="5985204">:=</span>&nbsp;<span class="ident" id="5985207">ut</span><span class="op" id="5985209">.</span><span class="ident" id="5985210">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985217">k</span>&nbsp;<span class="op" id="5985219">:=</span>&nbsp;<span class="ident" id="5985222">typ</span><span class="op" id="5985225">.</span><span class="ident" id="5985226">Kind</span><span class="op" id="5985230">(</span><span class="op" id="5985231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985234">var</span>&nbsp;<span class="ident" id="5985238">op</span>&nbsp;<span class="ident" id="5985241">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985248">if</span>&nbsp;<span class="builtintype" id="5985251">int</span><span class="op" id="5985254">(</span><span class="ident" id="5985255">k</span><span class="op" id="5985256">)</span>&nbsp;<span class="op" id="5985258">&lt;</span>&nbsp;<span class="builtinfunc" id="5985260">len</span><span class="op" id="5985263">(</span><span class="ident" id="5985264">encOpTable</span><span class="op" id="5985274">)</span>&nbsp;<span class="op" id="5985276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985280">op</span>&nbsp;<span class="op" id="5985283">=</span>&nbsp;<span class="ident" id="5985285">encOpTable</span><span class="op" id="5985295">[</span><span class="ident" id="5985296">k</span><span class="op" id="5985297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5985300">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985303">if</span>&nbsp;<span class="ident" id="5985306">op</span>&nbsp;<span class="op" id="5985309">==</span>&nbsp;<span class="ident" id="5985312">nil</span>&nbsp;<span class="op" id="5985316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985320">inProgress</span><span class="op" id="5985330">[</span><span class="ident" id="5985331">rt</span><span class="op" id="5985333">]</span>&nbsp;<span class="op" id="5985335">=</span>&nbsp;<span class="op" id="5985337">&amp;</span><span class="ident" id="5985338">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5985343">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985362">switch</span>&nbsp;<span class="ident" id="5985369">t</span>&nbsp;<span class="op" id="5985371">:=</span>&nbsp;<span class="ident" id="5985374">typ</span><span class="op" id="5985377">;</span>&nbsp;<span class="ident" id="5985379">t</span><span class="op" id="5985380">.</span><span class="ident" id="5985381">Kind</span><span class="op" id="5985385">(</span><span class="op" id="5985386">)</span>&nbsp;<span class="op" id="5985388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985392">case</span>&nbsp;<span class="ident" id="5985397">reflect</span><span class="op" id="5985404">.</span><span class="ident" id="5985405">Slice</span><span class="op" id="5985410">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985415">if</span>&nbsp;<span class="ident" id="5985418">t</span><span class="op" id="5985419">.</span><span class="ident" id="5985420">Elem</span><span class="op" id="5985424">(</span><span class="op" id="5985425">)</span><span class="op" id="5985426">.</span><span class="ident" id="5985427">Kind</span><span class="op" id="5985431">(</span><span class="op" id="5985432">)</span>&nbsp;<span class="op" id="5985434">==</span>&nbsp;<span class="ident" id="5985437">reflect</span><span class="op" id="5985444">.</span><span class="ident" id="5985445">Uint8</span>&nbsp;<span class="op" id="5985451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985457">op</span>&nbsp;<span class="op" id="5985460">=</span>&nbsp;<span class="ident" id="5985462">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985480">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5985489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5985494">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985565">elemOp</span><span class="op" id="5985571">,</span>&nbsp;<span class="ident" id="5985573">elemIndir</span>&nbsp;<span class="op" id="5985583">:=</span>&nbsp;<span class="ident" id="5985586">encOpFor</span><span class="op" id="5985594">(</span><span class="ident" id="5985595">t</span><span class="op" id="5985596">.</span><span class="ident" id="5985597">Elem</span><span class="op" id="5985601">(</span><span class="op" id="5985602">)</span><span class="op" id="5985603">,</span>&nbsp;<span class="ident" id="5985605">inProgress</span><span class="op" id="5985615">,</span>&nbsp;<span class="ident" id="5985617">building</span><span class="op" id="5985625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985630">helper</span>&nbsp;<span class="op" id="5985637">:=</span>&nbsp;<span class="ident" id="5985640">encSliceHelper</span><span class="op" id="5985654">[</span><span class="ident" id="5985655">t</span><span class="op" id="5985656">.</span><span class="ident" id="5985657">Elem</span><span class="op" id="5985661">(</span><span class="op" id="5985662">)</span><span class="op" id="5985663">.</span><span class="ident" id="5985664">Kind</span><span class="op" id="5985668">(</span><span class="op" id="5985669">)</span><span class="op" id="5985670">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985675">op</span>&nbsp;<span class="op" id="5985678">=</span>&nbsp;<span class="keyword" id="5985680">func</span><span class="op" id="5985684">(</span><span class="ident" id="5985685">i</span>&nbsp;<span class="op" id="5985687">*</span><span class="ident" id="5985688">encInstr</span><span class="op" id="5985696">,</span>&nbsp;<span class="ident" id="5985698">state</span>&nbsp;<span class="op" id="5985704">*</span><span class="ident" id="5985705">encoderState</span><span class="op" id="5985717">,</span>&nbsp;<span class="ident" id="5985719">slice</span>&nbsp;<span class="ident" id="5985725">reflect</span><span class="op" id="5985732">.</span><span class="ident" id="5985733">Value</span><span class="op" id="5985738">)</span>&nbsp;<span class="op" id="5985740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985746">if</span>&nbsp;<span class="op" id="5985749">!</span><span class="ident" id="5985750">state</span><span class="op" id="5985755">.</span><span class="ident" id="5985756">sendZero</span>&nbsp;<span class="op" id="5985765">&amp;&amp;</span>&nbsp;<span class="ident" id="5985768">slice</span><span class="op" id="5985773">.</span><span class="ident" id="5985774">Len</span><span class="op" id="5985777">(</span><span class="op" id="5985778">)</span>&nbsp;<span class="op" id="5985780">==</span>&nbsp;<span class="num" id="5985783">0</span>&nbsp;<span class="op" id="5985785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985792">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5985803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985809">state</span><span class="op" id="5985814">.</span><span class="ident" id="5985815">update</span><span class="op" id="5985821">(</span><span class="ident" id="5985822">i</span><span class="op" id="5985823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985829">state</span><span class="op" id="5985834">.</span><span class="ident" id="5985835">enc</span><span class="op" id="5985838">.</span><span class="ident" id="5985839">encodeArray</span><span class="op" id="5985850">(</span><span class="ident" id="5985851">state</span><span class="op" id="5985856">.</span><span class="ident" id="5985857">b</span><span class="op" id="5985858">,</span>&nbsp;<span class="ident" id="5985860">slice</span><span class="op" id="5985865">,</span>&nbsp;<span class="op" id="5985867">*</span><span class="ident" id="5985868">elemOp</span><span class="op" id="5985874">,</span>&nbsp;<span class="ident" id="5985876">elemIndir</span><span class="op" id="5985885">,</span>&nbsp;<span class="ident" id="5985887">slice</span><span class="op" id="5985892">.</span><span class="ident" id="5985893">Len</span><span class="op" id="5985896">(</span><span class="op" id="5985897">)</span><span class="op" id="5985898">,</span>&nbsp;<span class="ident" id="5985900">helper</span><span class="op" id="5985906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5985911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5985915">case</span>&nbsp;<span class="ident" id="5985920">reflect</span><span class="op" id="5985927">.</span><span class="ident" id="5985928">Array</span><span class="op" id="5985933">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5985938">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5985979">elemOp</span><span class="op" id="5985985">,</span>&nbsp;<span class="ident" id="5985987">elemIndir</span>&nbsp;<span class="op" id="5985997">:=</span>&nbsp;<span class="ident" id="5986000">encOpFor</span><span class="op" id="5986008">(</span><span class="ident" id="5986009">t</span><span class="op" id="5986010">.</span><span class="ident" id="5986011">Elem</span><span class="op" id="5986015">(</span><span class="op" id="5986016">)</span><span class="op" id="5986017">,</span>&nbsp;<span class="ident" id="5986019">inProgress</span><span class="op" id="5986029">,</span>&nbsp;<span class="ident" id="5986031">building</span><span class="op" id="5986039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986044">helper</span>&nbsp;<span class="op" id="5986051">:=</span>&nbsp;<span class="ident" id="5986054">encArrayHelper</span><span class="op" id="5986068">[</span><span class="ident" id="5986069">t</span><span class="op" id="5986070">.</span><span class="ident" id="5986071">Elem</span><span class="op" id="5986075">(</span><span class="op" id="5986076">)</span><span class="op" id="5986077">.</span><span class="ident" id="5986078">Kind</span><span class="op" id="5986082">(</span><span class="op" id="5986083">)</span><span class="op" id="5986084">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986089">op</span>&nbsp;<span class="op" id="5986092">=</span>&nbsp;<span class="keyword" id="5986094">func</span><span class="op" id="5986098">(</span><span class="ident" id="5986099">i</span>&nbsp;<span class="op" id="5986101">*</span><span class="ident" id="5986102">encInstr</span><span class="op" id="5986110">,</span>&nbsp;<span class="ident" id="5986112">state</span>&nbsp;<span class="op" id="5986118">*</span><span class="ident" id="5986119">encoderState</span><span class="op" id="5986131">,</span>&nbsp;<span class="ident" id="5986133">array</span>&nbsp;<span class="ident" id="5986139">reflect</span><span class="op" id="5986146">.</span><span class="ident" id="5986147">Value</span><span class="op" id="5986152">)</span>&nbsp;<span class="op" id="5986154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986160">state</span><span class="op" id="5986165">.</span><span class="ident" id="5986166">update</span><span class="op" id="5986172">(</span><span class="ident" id="5986173">i</span><span class="op" id="5986174">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986180">state</span><span class="op" id="5986185">.</span><span class="ident" id="5986186">enc</span><span class="op" id="5986189">.</span><span class="ident" id="5986190">encodeArray</span><span class="op" id="5986201">(</span><span class="ident" id="5986202">state</span><span class="op" id="5986207">.</span><span class="ident" id="5986208">b</span><span class="op" id="5986209">,</span>&nbsp;<span class="ident" id="5986211">array</span><span class="op" id="5986216">,</span>&nbsp;<span class="op" id="5986218">*</span><span class="ident" id="5986219">elemOp</span><span class="op" id="5986225">,</span>&nbsp;<span class="ident" id="5986227">elemIndir</span><span class="op" id="5986236">,</span>&nbsp;<span class="ident" id="5986238">array</span><span class="op" id="5986243">.</span><span class="ident" id="5986244">Len</span><span class="op" id="5986247">(</span><span class="op" id="5986248">)</span><span class="op" id="5986249">,</span>&nbsp;<span class="ident" id="5986251">helper</span><span class="op" id="5986257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5986262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5986266">case</span>&nbsp;<span class="ident" id="5986271">reflect</span><span class="op" id="5986278">.</span><span class="ident" id="5986279">Map</span><span class="op" id="5986282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986287">keyOp</span><span class="op" id="5986292">,</span>&nbsp;<span class="ident" id="5986294">keyIndir</span>&nbsp;<span class="op" id="5986303">:=</span>&nbsp;<span class="ident" id="5986306">encOpFor</span><span class="op" id="5986314">(</span><span class="ident" id="5986315">t</span><span class="op" id="5986316">.</span><span class="ident" id="5986317">Key</span><span class="op" id="5986320">(</span><span class="op" id="5986321">)</span><span class="op" id="5986322">,</span>&nbsp;<span class="ident" id="5986324">inProgress</span><span class="op" id="5986334">,</span>&nbsp;<span class="ident" id="5986336">building</span><span class="op" id="5986344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986349">elemOp</span><span class="op" id="5986355">,</span>&nbsp;<span class="ident" id="5986357">elemIndir</span>&nbsp;<span class="op" id="5986367">:=</span>&nbsp;<span class="ident" id="5986370">encOpFor</span><span class="op" id="5986378">(</span><span class="ident" id="5986379">t</span><span class="op" id="5986380">.</span><span class="ident" id="5986381">Elem</span><span class="op" id="5986385">(</span><span class="op" id="5986386">)</span><span class="op" id="5986387">,</span>&nbsp;<span class="ident" id="5986389">inProgress</span><span class="op" id="5986399">,</span>&nbsp;<span class="ident" id="5986401">building</span><span class="op" id="5986409">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986414">op</span>&nbsp;<span class="op" id="5986417">=</span>&nbsp;<span class="keyword" id="5986419">func</span><span class="op" id="5986423">(</span><span class="ident" id="5986424">i</span>&nbsp;<span class="op" id="5986426">*</span><span class="ident" id="5986427">encInstr</span><span class="op" id="5986435">,</span>&nbsp;<span class="ident" id="5986437">state</span>&nbsp;<span class="op" id="5986443">*</span><span class="ident" id="5986444">encoderState</span><span class="op" id="5986456">,</span>&nbsp;<span class="ident" id="5986458">mv</span>&nbsp;<span class="ident" id="5986461">reflect</span><span class="op" id="5986468">.</span><span class="ident" id="5986469">Value</span><span class="op" id="5986474">)</span>&nbsp;<span class="op" id="5986476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5986482">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5986540">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5986609">if</span>&nbsp;<span class="op" id="5986612">!</span><span class="ident" id="5986613">state</span><span class="op" id="5986618">.</span><span class="ident" id="5986619">sendZero</span>&nbsp;<span class="op" id="5986628">&amp;&amp;</span>&nbsp;<span class="ident" id="5986631">mv</span><span class="op" id="5986633">.</span><span class="ident" id="5986634">IsNil</span><span class="op" id="5986639">(</span><span class="op" id="5986640">)</span>&nbsp;<span class="op" id="5986642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5986649">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5986660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986666">state</span><span class="op" id="5986671">.</span><span class="ident" id="5986672">update</span><span class="op" id="5986678">(</span><span class="ident" id="5986679">i</span><span class="op" id="5986680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986686">state</span><span class="op" id="5986691">.</span><span class="ident" id="5986692">enc</span><span class="op" id="5986695">.</span><span class="ident" id="5986696">encodeMap</span><span class="op" id="5986705">(</span><span class="ident" id="5986706">state</span><span class="op" id="5986711">.</span><span class="ident" id="5986712">b</span><span class="op" id="5986713">,</span>&nbsp;<span class="ident" id="5986715">mv</span><span class="op" id="5986717">,</span>&nbsp;<span class="op" id="5986719">*</span><span class="ident" id="5986720">keyOp</span><span class="op" id="5986725">,</span>&nbsp;<span class="op" id="5986727">*</span><span class="ident" id="5986728">elemOp</span><span class="op" id="5986734">,</span>&nbsp;<span class="ident" id="5986736">keyIndir</span><span class="op" id="5986744">,</span>&nbsp;<span class="ident" id="5986746">elemIndir</span><span class="op" id="5986755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5986760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5986764">case</span>&nbsp;<span class="ident" id="5986769">reflect</span><span class="op" id="5986776">.</span><span class="ident" id="5986777">Struct</span><span class="op" id="5986783">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5986788">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986863">getEncEngine</span><span class="op" id="5986875">(</span><span class="ident" id="5986876">userType</span><span class="op" id="5986884">(</span><span class="ident" id="5986885">typ</span><span class="op" id="5986888">)</span><span class="op" id="5986889">,</span>&nbsp;<span class="ident" id="5986891">building</span><span class="op" id="5986899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986904">info</span>&nbsp;<span class="op" id="5986909">:=</span>&nbsp;<span class="ident" id="5986912">mustGetTypeInfo</span><span class="op" id="5986927">(</span><span class="ident" id="5986928">typ</span><span class="op" id="5986931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5986936">op</span>&nbsp;<span class="op" id="5986939">=</span>&nbsp;<span class="keyword" id="5986941">func</span><span class="op" id="5986945">(</span><span class="ident" id="5986946">i</span>&nbsp;<span class="op" id="5986948">*</span><span class="ident" id="5986949">encInstr</span><span class="op" id="5986957">,</span>&nbsp;<span class="ident" id="5986959">state</span>&nbsp;<span class="op" id="5986965">*</span><span class="ident" id="5986966">encoderState</span><span class="op" id="5986978">,</span>&nbsp;<span class="ident" id="5986980">sv</span>&nbsp;<span class="ident" id="5986983">reflect</span><span class="op" id="5986990">.</span><span class="ident" id="5986991">Value</span><span class="op" id="5986996">)</span>&nbsp;<span class="op" id="5986998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987004">state</span><span class="op" id="5987009">.</span><span class="ident" id="5987010">update</span><span class="op" id="5987016">(</span><span class="ident" id="5987017">i</span><span class="op" id="5987018">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5987024">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987095">enc</span>&nbsp;<span class="op" id="5987099">:=</span>&nbsp;<span class="ident" id="5987102">info</span><span class="op" id="5987106">.</span><span class="ident" id="5987107">encoder</span><span class="op" id="5987114">.</span><span class="ident" id="5987115">Load</span><span class="op" id="5987119">(</span><span class="op" id="5987120">)</span><span class="op" id="5987121">.</span><span class="op" id="5987122">(</span><span class="op" id="5987123">*</span><span class="ident" id="5987124">encEngine</span><span class="op" id="5987133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987139">state</span><span class="op" id="5987144">.</span><span class="ident" id="5987145">enc</span><span class="op" id="5987148">.</span><span class="ident" id="5987149">encodeStruct</span><span class="op" id="5987161">(</span><span class="ident" id="5987162">state</span><span class="op" id="5987167">.</span><span class="ident" id="5987168">b</span><span class="op" id="5987169">,</span>&nbsp;<span class="ident" id="5987171">enc</span><span class="op" id="5987174">,</span>&nbsp;<span class="ident" id="5987176">sv</span><span class="op" id="5987178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987187">case</span>&nbsp;<span class="ident" id="5987192">reflect</span><span class="op" id="5987199">.</span><span class="ident" id="5987200">Interface</span><span class="op" id="5987209">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987214">op</span>&nbsp;<span class="op" id="5987217">=</span>&nbsp;<span class="keyword" id="5987219">func</span><span class="op" id="5987223">(</span><span class="ident" id="5987224">i</span>&nbsp;<span class="op" id="5987226">*</span><span class="ident" id="5987227">encInstr</span><span class="op" id="5987235">,</span>&nbsp;<span class="ident" id="5987237">state</span>&nbsp;<span class="op" id="5987243">*</span><span class="ident" id="5987244">encoderState</span><span class="op" id="5987256">,</span>&nbsp;<span class="ident" id="5987258">iv</span>&nbsp;<span class="ident" id="5987261">reflect</span><span class="op" id="5987268">.</span><span class="ident" id="5987269">Value</span><span class="op" id="5987274">)</span>&nbsp;<span class="op" id="5987276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987282">if</span>&nbsp;<span class="op" id="5987285">!</span><span class="ident" id="5987286">state</span><span class="op" id="5987291">.</span><span class="ident" id="5987292">sendZero</span>&nbsp;<span class="op" id="5987301">&amp;&amp;</span>&nbsp;<span class="op" id="5987304">(</span><span class="op" id="5987305">!</span><span class="ident" id="5987306">iv</span><span class="op" id="5987308">.</span><span class="ident" id="5987309">IsValid</span><span class="op" id="5987316">(</span><span class="op" id="5987317">)</span>&nbsp;<span class="op" id="5987319">||</span>&nbsp;<span class="ident" id="5987322">iv</span><span class="op" id="5987324">.</span><span class="ident" id="5987325">IsNil</span><span class="op" id="5987330">(</span><span class="op" id="5987331">)</span><span class="op" id="5987332">)</span>&nbsp;<span class="op" id="5987334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987341">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987358">state</span><span class="op" id="5987363">.</span><span class="ident" id="5987364">update</span><span class="op" id="5987370">(</span><span class="ident" id="5987371">i</span><span class="op" id="5987372">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987378">state</span><span class="op" id="5987383">.</span><span class="ident" id="5987384">enc</span><span class="op" id="5987387">.</span><span class="ident" id="5987388">encodeInterface</span><span class="op" id="5987403">(</span><span class="ident" id="5987404">state</span><span class="op" id="5987409">.</span><span class="ident" id="5987410">b</span><span class="op" id="5987411">,</span>&nbsp;<span class="ident" id="5987413">iv</span><span class="op" id="5987415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987430">if</span>&nbsp;<span class="ident" id="5987433">op</span>&nbsp;<span class="op" id="5987436">==</span>&nbsp;<span class="ident" id="5987439">nil</span>&nbsp;<span class="op" id="5987443">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987447">errorf</span><span class="op" id="5987453">(</span><span class="string" id="5987454">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5987484">,</span>&nbsp;<span class="ident" id="5987486">rt</span><span class="op" id="5987488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987494">return</span>&nbsp;<span class="op" id="5987501">&amp;</span><span class="ident" id="5987502">op</span><span class="op" id="5987504">,</span>&nbsp;<span class="ident" id="5987506">indir</span><br>
<span class="lineno"></span><span class="op" id="5987512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5987515">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5987598">func</span>&nbsp;<span class="ident" id="5987603">gobEncodeOpFor</span><span class="op" id="5987617">(</span><span class="ident" id="5987618">ut</span>&nbsp;<span class="op" id="5987621">*</span><span class="ident" id="5987622">userTypeInfo</span><span class="op" id="5987634">)</span>&nbsp;<span class="op" id="5987636">(</span><span class="op" id="5987637">*</span><span class="ident" id="5987638">encOp</span><span class="op" id="5987643">,</span>&nbsp;<span class="builtintype" id="5987645">int</span><span class="op" id="5987648">)</span>&nbsp;<span class="op" id="5987650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987653">rt</span>&nbsp;<span class="op" id="5987656">:=</span>&nbsp;<span class="ident" id="5987659">ut</span><span class="op" id="5987661">.</span><span class="ident" id="5987662">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987668">if</span>&nbsp;<span class="ident" id="5987671">ut</span><span class="op" id="5987673">.</span><span class="ident" id="5987674">encIndir</span>&nbsp;<span class="op" id="5987683">==</span>&nbsp;<span class="op" id="5987686">-</span><span class="num" id="5987687">1</span>&nbsp;<span class="op" id="5987689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987693">rt</span>&nbsp;<span class="op" id="5987696">=</span>&nbsp;<span class="ident" id="5987698">reflect</span><span class="op" id="5987705">.</span><span class="ident" id="5987706">PtrTo</span><span class="op" id="5987711">(</span><span class="ident" id="5987712">rt</span><span class="op" id="5987714">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987717">}</span>&nbsp;<span class="keyword" id="5987719">else</span>&nbsp;<span class="keyword" id="5987724">if</span>&nbsp;<span class="ident" id="5987727">ut</span><span class="op" id="5987729">.</span><span class="ident" id="5987730">encIndir</span>&nbsp;<span class="op" id="5987739">&gt;</span>&nbsp;<span class="num" id="5987741">0</span>&nbsp;<span class="op" id="5987743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987747">for</span>&nbsp;<span class="ident" id="5987751">i</span>&nbsp;<span class="op" id="5987753">:=</span>&nbsp;<span class="builtintype" id="5987756">int8</span><span class="op" id="5987760">(</span><span class="num" id="5987761">0</span><span class="op" id="5987762">)</span><span class="op" id="5987763">;</span>&nbsp;<span class="ident" id="5987765">i</span>&nbsp;<span class="op" id="5987767">&lt;</span>&nbsp;<span class="ident" id="5987769">ut</span><span class="op" id="5987771">.</span><span class="ident" id="5987772">encIndir</span><span class="op" id="5987780">;</span>&nbsp;<span class="ident" id="5987782">i</span><span class="op" id="5987783">++</span>&nbsp;<span class="op" id="5987786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987791">rt</span>&nbsp;<span class="op" id="5987794">=</span>&nbsp;<span class="ident" id="5987796">rt</span><span class="op" id="5987798">.</span><span class="ident" id="5987799">Elem</span><span class="op" id="5987803">(</span><span class="op" id="5987804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5987811">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987814">var</span>&nbsp;<span class="ident" id="5987818">op</span>&nbsp;<span class="ident" id="5987821">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5987828">op</span>&nbsp;<span class="op" id="5987831">=</span>&nbsp;<span class="keyword" id="5987833">func</span><span class="op" id="5987837">(</span><span class="ident" id="5987838">i</span>&nbsp;<span class="op" id="5987840">*</span><span class="ident" id="5987841">encInstr</span><span class="op" id="5987849">,</span>&nbsp;<span class="ident" id="5987851">state</span>&nbsp;<span class="op" id="5987857">*</span><span class="ident" id="5987858">encoderState</span><span class="op" id="5987870">,</span>&nbsp;<span class="ident" id="5987872">v</span>&nbsp;<span class="ident" id="5987874">reflect</span><span class="op" id="5987881">.</span><span class="ident" id="5987882">Value</span><span class="op" id="5987887">)</span>&nbsp;<span class="op" id="5987889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987893">if</span>&nbsp;<span class="ident" id="5987896">ut</span><span class="op" id="5987898">.</span><span class="ident" id="5987899">encIndir</span>&nbsp;<span class="op" id="5987908">==</span>&nbsp;<span class="op" id="5987911">-</span><span class="num" id="5987912">1</span>&nbsp;<span class="op" id="5987914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5987919">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5987980">if</span>&nbsp;<span class="op" id="5987983">!</span><span class="ident" id="5987984">v</span><span class="op" id="5987985">.</span><span class="ident" id="5987986">CanAddr</span><span class="op" id="5987993">(</span><span class="op" id="5987994">)</span>&nbsp;<span class="op" id="5987996">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988002">errorf</span><span class="op" id="5988008">(</span><span class="string" id="5988009">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5988041">,</span>&nbsp;<span class="ident" id="5988043">rt</span><span class="op" id="5988045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988055">v</span>&nbsp;<span class="op" id="5988057">=</span>&nbsp;<span class="ident" id="5988059">v</span><span class="op" id="5988060">.</span><span class="ident" id="5988061">Addr</span><span class="op" id="5988065">(</span><span class="op" id="5988066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988074">if</span>&nbsp;<span class="op" id="5988077">!</span><span class="ident" id="5988078">state</span><span class="op" id="5988083">.</span><span class="ident" id="5988084">sendZero</span>&nbsp;<span class="op" id="5988093">&amp;&amp;</span>&nbsp;<span class="ident" id="5988096">isZero</span><span class="op" id="5988102">(</span><span class="ident" id="5988103">v</span><span class="op" id="5988104">)</span>&nbsp;<span class="op" id="5988106">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988111">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988124">state</span><span class="op" id="5988129">.</span><span class="ident" id="5988130">update</span><span class="op" id="5988136">(</span><span class="ident" id="5988137">i</span><span class="op" id="5988138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988142">state</span><span class="op" id="5988147">.</span><span class="ident" id="5988148">enc</span><span class="op" id="5988151">.</span><span class="ident" id="5988152">encodeGobEncoder</span><span class="op" id="5988168">(</span><span class="ident" id="5988169">state</span><span class="op" id="5988174">.</span><span class="ident" id="5988175">b</span><span class="op" id="5988176">,</span>&nbsp;<span class="ident" id="5988178">ut</span><span class="op" id="5988180">,</span>&nbsp;<span class="ident" id="5988182">v</span><span class="op" id="5988183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988186">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988189">return</span>&nbsp;<span class="op" id="5988196">&amp;</span><span class="ident" id="5988197">op</span><span class="op" id="5988199">,</span>&nbsp;<span class="builtintype" id="5988201">int</span><span class="op" id="5988204">(</span><span class="ident" id="5988205">ut</span><span class="op" id="5988207">.</span><span class="ident" id="5988208">encIndir</span><span class="op" id="5988216">)</span>&nbsp;<span class="comment" id="5988218">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5988281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5988284">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5988338">func</span>&nbsp;<span class="ident" id="5988343">compileEnc</span><span class="op" id="5988353">(</span><span class="ident" id="5988354">ut</span>&nbsp;<span class="op" id="5988357">*</span><span class="ident" id="5988358">userTypeInfo</span><span class="op" id="5988370">,</span>&nbsp;<span class="ident" id="5988372">building</span>&nbsp;<span class="keyword" id="5988381">map</span><span class="op" id="5988384">[</span><span class="op" id="5988385">*</span><span class="ident" id="5988386">typeInfo</span><span class="op" id="5988394">]</span><span class="builtintype" id="5988395">bool</span><span class="op" id="5988399">)</span>&nbsp;<span class="op" id="5988401">*</span><span class="ident" id="5988402">encEngine</span>&nbsp;<span class="op" id="5988412">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988415">srt</span>&nbsp;<span class="op" id="5988419">:=</span>&nbsp;<span class="ident" id="5988422">ut</span><span class="op" id="5988424">.</span><span class="ident" id="5988425">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988431">engine</span>&nbsp;<span class="op" id="5988438">:=</span>&nbsp;<span class="builtinfunc" id="5988441">new</span><span class="op" id="5988444">(</span><span class="ident" id="5988445">encEngine</span><span class="op" id="5988454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988457">seen</span>&nbsp;<span class="op" id="5988462">:=</span>&nbsp;<span class="builtinfunc" id="5988465">make</span><span class="op" id="5988469">(</span><span class="keyword" id="5988470">map</span><span class="op" id="5988473">[</span><span class="ident" id="5988474">reflect</span><span class="op" id="5988481">.</span><span class="ident" id="5988482">Type</span><span class="op" id="5988486">]</span><span class="op" id="5988487">*</span><span class="ident" id="5988488">encOp</span><span class="op" id="5988493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988496">rt</span>&nbsp;<span class="op" id="5988499">:=</span>&nbsp;<span class="ident" id="5988502">ut</span><span class="op" id="5988504">.</span><span class="ident" id="5988505">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988511">if</span>&nbsp;<span class="ident" id="5988514">ut</span><span class="op" id="5988516">.</span><span class="ident" id="5988517">externalEnc</span>&nbsp;<span class="op" id="5988529">!=</span>&nbsp;<span class="num" id="5988532">0</span>&nbsp;<span class="op" id="5988534">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988538">rt</span>&nbsp;<span class="op" id="5988541">=</span>&nbsp;<span class="ident" id="5988543">ut</span><span class="op" id="5988545">.</span><span class="ident" id="5988546">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988555">if</span>&nbsp;<span class="ident" id="5988558">ut</span><span class="op" id="5988560">.</span><span class="ident" id="5988561">externalEnc</span>&nbsp;<span class="op" id="5988573">==</span>&nbsp;<span class="num" id="5988576">0</span>&nbsp;<span class="op" id="5988578">&amp;&amp;</span>&nbsp;<span class="ident" id="5988581">srt</span><span class="op" id="5988584">.</span><span class="ident" id="5988585">Kind</span><span class="op" id="5988589">(</span><span class="op" id="5988590">)</span>&nbsp;<span class="op" id="5988592">==</span>&nbsp;<span class="ident" id="5988595">reflect</span><span class="op" id="5988602">.</span><span class="ident" id="5988603">Struct</span>&nbsp;<span class="op" id="5988610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988614">for</span>&nbsp;<span class="ident" id="5988618">fieldNum</span><span class="op" id="5988626">,</span>&nbsp;<span class="ident" id="5988628">wireFieldNum</span>&nbsp;<span class="op" id="5988641">:=</span>&nbsp;<span class="num" id="5988644">0</span><span class="op" id="5988645">,</span>&nbsp;<span class="num" id="5988647">0</span><span class="op" id="5988648">;</span>&nbsp;<span class="ident" id="5988650">fieldNum</span>&nbsp;<span class="op" id="5988659">&lt;</span>&nbsp;<span class="ident" id="5988661">srt</span><span class="op" id="5988664">.</span><span class="ident" id="5988665">NumField</span><span class="op" id="5988673">(</span><span class="op" id="5988674">)</span><span class="op" id="5988675">;</span>&nbsp;<span class="ident" id="5988677">fieldNum</span><span class="op" id="5988685">++</span>&nbsp;<span class="op" id="5988688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988693">f</span>&nbsp;<span class="op" id="5988695">:=</span>&nbsp;<span class="ident" id="5988698">srt</span><span class="op" id="5988701">.</span><span class="ident" id="5988702">Field</span><span class="op" id="5988707">(</span><span class="ident" id="5988708">fieldNum</span><span class="op" id="5988716">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988721">if</span>&nbsp;<span class="op" id="5988724">!</span><span class="ident" id="5988725">isSent</span><span class="op" id="5988731">(</span><span class="op" id="5988732">&amp;</span><span class="ident" id="5988733">f</span><span class="op" id="5988734">)</span>&nbsp;<span class="op" id="5988736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988742">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988759">op</span><span class="op" id="5988761">,</span>&nbsp;<span class="ident" id="5988763">indir</span>&nbsp;<span class="op" id="5988769">:=</span>&nbsp;<span class="ident" id="5988772">encOpFor</span><span class="op" id="5988780">(</span><span class="ident" id="5988781">f</span><span class="op" id="5988782">.</span><span class="ident" id="5988783">Type</span><span class="op" id="5988787">,</span>&nbsp;<span class="ident" id="5988789">seen</span><span class="op" id="5988793">,</span>&nbsp;<span class="ident" id="5988795">building</span><span class="op" id="5988803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988808">engine</span><span class="op" id="5988814">.</span><span class="ident" id="5988815">instr</span>&nbsp;<span class="op" id="5988821">=</span>&nbsp;<span class="builtinfunc" id="5988823">append</span><span class="op" id="5988829">(</span><span class="ident" id="5988830">engine</span><span class="op" id="5988836">.</span><span class="ident" id="5988837">instr</span><span class="op" id="5988842">,</span>&nbsp;<span class="ident" id="5988844">encInstr</span><span class="op" id="5988852">{</span><span class="op" id="5988853">*</span><span class="ident" id="5988854">op</span><span class="op" id="5988856">,</span>&nbsp;<span class="ident" id="5988858">wireFieldNum</span><span class="op" id="5988870">,</span>&nbsp;<span class="ident" id="5988872">f</span><span class="op" id="5988873">.</span><span class="ident" id="5988874">Index</span><span class="op" id="5988879">,</span>&nbsp;<span class="ident" id="5988881">indir</span><span class="op" id="5988886">}</span><span class="op" id="5988887">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988892">wireFieldNum</span><span class="op" id="5988904">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5988909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5988913">if</span>&nbsp;<span class="ident" id="5988916">srt</span><span class="op" id="5988919">.</span><span class="ident" id="5988920">NumField</span><span class="op" id="5988928">(</span><span class="op" id="5988929">)</span>&nbsp;<span class="op" id="5988931">&gt;</span>&nbsp;<span class="num" id="5988933">0</span>&nbsp;<span class="op" id="5988935">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5988938">len</span><span class="op" id="5988941">(</span><span class="ident" id="5988942">engine</span><span class="op" id="5988948">.</span><span class="ident" id="5988949">instr</span><span class="op" id="5988954">)</span>&nbsp;<span class="op" id="5988956">==</span>&nbsp;<span class="num" id="5988959">0</span>&nbsp;<span class="op" id="5988961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5988966">errorf</span><span class="op" id="5988972">(</span><span class="string" id="5988973">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5989005">,</span>&nbsp;<span class="ident" id="5989007">rt</span><span class="op" id="5989009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989013">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989017">engine</span><span class="op" id="5989023">.</span><span class="ident" id="5989024">instr</span>&nbsp;<span class="op" id="5989030">=</span>&nbsp;<span class="builtinfunc" id="5989032">append</span><span class="op" id="5989038">(</span><span class="ident" id="5989039">engine</span><span class="op" id="5989045">.</span><span class="ident" id="5989046">instr</span><span class="op" id="5989051">,</span>&nbsp;<span class="ident" id="5989053">encInstr</span><span class="op" id="5989061">{</span><span class="ident" id="5989062">encStructTerminator</span><span class="op" id="5989081">,</span>&nbsp;<span class="num" id="5989083">0</span><span class="op" id="5989084">,</span>&nbsp;<span class="ident" id="5989086">nil</span><span class="op" id="5989089">,</span>&nbsp;<span class="num" id="5989091">0</span><span class="op" id="5989092">}</span><span class="op" id="5989093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989096">}</span>&nbsp;<span class="keyword" id="5989098">else</span>&nbsp;<span class="op" id="5989103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989107">engine</span><span class="op" id="5989113">.</span><span class="ident" id="5989114">instr</span>&nbsp;<span class="op" id="5989120">=</span>&nbsp;<span class="builtinfunc" id="5989122">make</span><span class="op" id="5989126">(</span><span class="op" id="5989127">[</span><span class="op" id="5989128">]</span><span class="ident" id="5989129">encInstr</span><span class="op" id="5989137">,</span>&nbsp;<span class="num" id="5989139">1</span><span class="op" id="5989140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989144">op</span><span class="op" id="5989146">,</span>&nbsp;<span class="ident" id="5989148">indir</span>&nbsp;<span class="op" id="5989154">:=</span>&nbsp;<span class="ident" id="5989157">encOpFor</span><span class="op" id="5989165">(</span><span class="ident" id="5989166">rt</span><span class="op" id="5989168">,</span>&nbsp;<span class="ident" id="5989170">seen</span><span class="op" id="5989174">,</span>&nbsp;<span class="ident" id="5989176">building</span><span class="op" id="5989184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989188">engine</span><span class="op" id="5989194">.</span><span class="ident" id="5989195">instr</span><span class="op" id="5989200">[</span><span class="num" id="5989201">0</span><span class="op" id="5989202">]</span>&nbsp;<span class="op" id="5989204">=</span>&nbsp;<span class="ident" id="5989206">encInstr</span><span class="op" id="5989214">{</span><span class="op" id="5989215">*</span><span class="ident" id="5989216">op</span><span class="op" id="5989218">,</span>&nbsp;<span class="ident" id="5989220">singletonField</span><span class="op" id="5989234">,</span>&nbsp;<span class="ident" id="5989236">nil</span><span class="op" id="5989239">,</span>&nbsp;<span class="ident" id="5989241">indir</span><span class="op" id="5989246">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989252">return</span>&nbsp;<span class="ident" id="5989259">engine</span><br>
<span class="lineno"></span><span class="op" id="5989266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5989269">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5989325">func</span>&nbsp;<span class="ident" id="5989330">getEncEngine</span><span class="op" id="5989342">(</span><span class="ident" id="5989343">ut</span>&nbsp;<span class="op" id="5989346">*</span><span class="ident" id="5989347">userTypeInfo</span><span class="op" id="5989359">,</span>&nbsp;<span class="ident" id="5989361">building</span>&nbsp;<span class="keyword" id="5989370">map</span><span class="op" id="5989373">[</span><span class="op" id="5989374">*</span><span class="ident" id="5989375">typeInfo</span><span class="op" id="5989383">]</span><span class="builtintype" id="5989384">bool</span><span class="op" id="5989388">)</span>&nbsp;<span class="op" id="5989390">*</span><span class="ident" id="5989391">encEngine</span>&nbsp;<span class="op" id="5989401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989404">info</span><span class="op" id="5989408">,</span>&nbsp;<span class="ident" id="5989410">err</span>&nbsp;<span class="op" id="5989414">:=</span>&nbsp;<span class="ident" id="5989417">getTypeInfo</span><span class="op" id="5989428">(</span><span class="ident" id="5989429">ut</span><span class="op" id="5989431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989434">if</span>&nbsp;<span class="ident" id="5989437">err</span>&nbsp;<span class="op" id="5989441">!=</span>&nbsp;<span class="ident" id="5989444">nil</span>&nbsp;<span class="op" id="5989448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989452">error_</span><span class="op" id="5989458">(</span><span class="ident" id="5989459">err</span><span class="op" id="5989462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989465">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989468">enc</span><span class="op" id="5989471">,</span>&nbsp;<span class="ident" id="5989473">ok</span>&nbsp;<span class="op" id="5989476">:=</span>&nbsp;<span class="ident" id="5989479">info</span><span class="op" id="5989483">.</span><span class="ident" id="5989484">encoder</span><span class="op" id="5989491">.</span><span class="ident" id="5989492">Load</span><span class="op" id="5989496">(</span><span class="op" id="5989497">)</span><span class="op" id="5989498">.</span><span class="op" id="5989499">(</span><span class="op" id="5989500">*</span><span class="ident" id="5989501">encEngine</span><span class="op" id="5989510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989513">if</span>&nbsp;<span class="op" id="5989516">!</span><span class="ident" id="5989517">ok</span>&nbsp;<span class="op" id="5989520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989524">enc</span>&nbsp;<span class="op" id="5989528">=</span>&nbsp;<span class="ident" id="5989530">buildEncEngine</span><span class="op" id="5989544">(</span><span class="ident" id="5989545">info</span><span class="op" id="5989549">,</span>&nbsp;<span class="ident" id="5989551">ut</span><span class="op" id="5989553">,</span>&nbsp;<span class="ident" id="5989555">building</span><span class="op" id="5989563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989569">return</span>&nbsp;<span class="ident" id="5989576">enc</span><br>
<span class="lineno">660</span><span class="op" id="5989580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5989583">func</span>&nbsp;<span class="ident" id="5989588">buildEncEngine</span><span class="op" id="5989602">(</span><span class="ident" id="5989603">info</span>&nbsp;<span class="op" id="5989608">*</span><span class="ident" id="5989609">typeInfo</span><span class="op" id="5989617">,</span>&nbsp;<span class="ident" id="5989619">ut</span>&nbsp;<span class="op" id="5989622">*</span><span class="ident" id="5989623">userTypeInfo</span><span class="op" id="5989635">,</span>&nbsp;<span class="ident" id="5989637">building</span>&nbsp;<span class="keyword" id="5989646">map</span><span class="op" id="5989649">[</span><span class="op" id="5989650">*</span><span class="ident" id="5989651">typeInfo</span><span class="op" id="5989659">]</span><span class="builtintype" id="5989660">bool</span><span class="op" id="5989664">)</span>&nbsp;<span class="op" id="5989666">*</span><span class="ident" id="5989667">encEngine</span>&nbsp;<span class="op" id="5989677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5989680">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989711">if</span>&nbsp;<span class="ident" id="5989714">building</span>&nbsp;<span class="op" id="5989723">!=</span>&nbsp;<span class="ident" id="5989726">nil</span>&nbsp;<span class="op" id="5989730">&amp;&amp;</span>&nbsp;<span class="ident" id="5989733">building</span><span class="op" id="5989741">[</span><span class="ident" id="5989742">info</span><span class="op" id="5989746">]</span>&nbsp;<span class="op" id="5989748">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989752">return</span>&nbsp;<span class="ident" id="5989759">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989767">info</span><span class="op" id="5989771">.</span><span class="ident" id="5989772">encInit</span><span class="op" id="5989779">.</span><span class="ident" id="5989780">Lock</span><span class="op" id="5989784">(</span><span class="op" id="5989785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989788">defer</span>&nbsp;<span class="ident" id="5989794">info</span><span class="op" id="5989798">.</span><span class="ident" id="5989799">encInit</span><span class="op" id="5989806">.</span><span class="ident" id="5989807">Unlock</span><span class="op" id="5989813">(</span><span class="op" id="5989814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989817">enc</span><span class="op" id="5989820">,</span>&nbsp;<span class="ident" id="5989822">ok</span>&nbsp;<span class="op" id="5989825">:=</span>&nbsp;<span class="ident" id="5989828">info</span><span class="op" id="5989832">.</span><span class="ident" id="5989833">encoder</span><span class="op" id="5989840">.</span><span class="ident" id="5989841">Load</span><span class="op" id="5989845">(</span><span class="op" id="5989846">)</span><span class="op" id="5989847">.</span><span class="op" id="5989848">(</span><span class="op" id="5989849">*</span><span class="ident" id="5989850">encEngine</span><span class="op" id="5989859">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989862">if</span>&nbsp;<span class="op" id="5989865">!</span><span class="ident" id="5989866">ok</span>&nbsp;<span class="op" id="5989869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5989873">if</span>&nbsp;<span class="ident" id="5989876">building</span>&nbsp;<span class="op" id="5989885">==</span>&nbsp;<span class="ident" id="5989888">nil</span>&nbsp;<span class="op" id="5989892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989897">building</span>&nbsp;<span class="op" id="5989906">=</span>&nbsp;<span class="builtinfunc" id="5989908">make</span><span class="op" id="5989912">(</span><span class="keyword" id="5989913">map</span><span class="op" id="5989916">[</span><span class="op" id="5989917">*</span><span class="ident" id="5989918">typeInfo</span><span class="op" id="5989926">]</span><span class="builtintype" id="5989927">bool</span><span class="op" id="5989931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5989935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989939">building</span><span class="op" id="5989947">[</span><span class="ident" id="5989948">info</span><span class="op" id="5989952">]</span>&nbsp;<span class="op" id="5989954">=</span>&nbsp;<span class="builtintype" id="5989956">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989963">enc</span>&nbsp;<span class="op" id="5989967">=</span>&nbsp;<span class="ident" id="5989969">compileEnc</span><span class="op" id="5989979">(</span><span class="ident" id="5989980">ut</span><span class="op" id="5989982">,</span>&nbsp;<span class="ident" id="5989984">building</span><span class="op" id="5989992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5989996">info</span><span class="op" id="5990000">.</span><span class="ident" id="5990001">encoder</span><span class="op" id="5990008">.</span><span class="ident" id="5990009">Store</span><span class="op" id="5990014">(</span><span class="ident" id="5990015">enc</span><span class="op" id="5990018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5990021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5990024">return</span>&nbsp;<span class="ident" id="5990031">enc</span><br>
<span class="lineno"></span><span class="op" id="5990035">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5990038">func</span>&nbsp;<span class="op" id="5990043">(</span><span class="ident" id="5990044">enc</span>&nbsp;<span class="op" id="5990048">*</span><span class="ident" id="5990049">Encoder</span><span class="op" id="5990056">)</span>&nbsp;<span class="ident" id="5990058">encode</span><span class="op" id="5990064">(</span><span class="ident" id="5990065">b</span>&nbsp;<span class="op" id="5990067">*</span><span class="ident" id="5990068">encBuffer</span><span class="op" id="5990077">,</span>&nbsp;<span class="ident" id="5990079">value</span>&nbsp;<span class="ident" id="5990085">reflect</span><span class="op" id="5990092">.</span><span class="ident" id="5990093">Value</span><span class="op" id="5990098">,</span>&nbsp;<span class="ident" id="5990100">ut</span>&nbsp;<span class="op" id="5990103">*</span><span class="ident" id="5990104">userTypeInfo</span><span class="op" id="5990116">)</span>&nbsp;<span class="op" id="5990118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5990121">defer</span>&nbsp;<span class="ident" id="5990127">catchError</span><span class="op" id="5990137">(</span><span class="op" id="5990138">&amp;</span><span class="ident" id="5990139">enc</span><span class="op" id="5990142">.</span><span class="ident" id="5990143">err</span><span class="op" id="5990146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990149">engine</span>&nbsp;<span class="op" id="5990156">:=</span>&nbsp;<span class="ident" id="5990159">getEncEngine</span><span class="op" id="5990171">(</span><span class="ident" id="5990172">ut</span><span class="op" id="5990174">,</span>&nbsp;<span class="ident" id="5990176">nil</span><span class="op" id="5990179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990182">indir</span>&nbsp;<span class="op" id="5990188">:=</span>&nbsp;<span class="ident" id="5990191">ut</span><span class="op" id="5990193">.</span><span class="ident" id="5990194">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5990201">if</span>&nbsp;<span class="ident" id="5990204">ut</span><span class="op" id="5990206">.</span><span class="ident" id="5990207">externalEnc</span>&nbsp;<span class="op" id="5990219">!=</span>&nbsp;<span class="num" id="5990222">0</span>&nbsp;<span class="op" id="5990224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990228">indir</span>&nbsp;<span class="op" id="5990234">=</span>&nbsp;<span class="builtintype" id="5990236">int</span><span class="op" id="5990239">(</span><span class="ident" id="5990240">ut</span><span class="op" id="5990242">.</span><span class="ident" id="5990243">encIndir</span><span class="op" id="5990251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5990254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5990257">for</span>&nbsp;<span class="ident" id="5990261">i</span>&nbsp;<span class="op" id="5990263">:=</span>&nbsp;<span class="num" id="5990266">0</span><span class="op" id="5990267">;</span>&nbsp;<span class="ident" id="5990269">i</span>&nbsp;<span class="op" id="5990271">&lt;</span>&nbsp;<span class="ident" id="5990273">indir</span><span class="op" id="5990278">;</span>&nbsp;<span class="ident" id="5990280">i</span><span class="op" id="5990281">++</span>&nbsp;<span class="op" id="5990284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990288">value</span>&nbsp;<span class="op" id="5990294">=</span>&nbsp;<span class="ident" id="5990296">reflect</span><span class="op" id="5990303">.</span><span class="ident" id="5990304">Indirect</span><span class="op" id="5990312">(</span><span class="ident" id="5990313">value</span><span class="op" id="5990318">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5990321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5990324">if</span>&nbsp;<span class="ident" id="5990327">ut</span><span class="op" id="5990329">.</span><span class="ident" id="5990330">externalEnc</span>&nbsp;<span class="op" id="5990342">==</span>&nbsp;<span class="num" id="5990345">0</span>&nbsp;<span class="op" id="5990347">&amp;&amp;</span>&nbsp;<span class="ident" id="5990350">value</span><span class="op" id="5990355">.</span><span class="ident" id="5990356">Type</span><span class="op" id="5990360">(</span><span class="op" id="5990361">)</span><span class="op" id="5990362">.</span><span class="ident" id="5990363">Kind</span><span class="op" id="5990367">(</span><span class="op" id="5990368">)</span>&nbsp;<span class="op" id="5990370">==</span>&nbsp;<span class="ident" id="5990373">reflect</span><span class="op" id="5990380">.</span><span class="ident" id="5990381">Struct</span>&nbsp;<span class="op" id="5990388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990392">enc</span><span class="op" id="5990395">.</span><span class="ident" id="5990396">encodeStruct</span><span class="op" id="5990408">(</span><span class="ident" id="5990409">b</span><span class="op" id="5990410">,</span>&nbsp;<span class="ident" id="5990412">engine</span><span class="op" id="5990418">,</span>&nbsp;<span class="ident" id="5990420">value</span><span class="op" id="5990425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5990428">}</span>&nbsp;<span class="keyword" id="5990430">else</span>&nbsp;<span class="op" id="5990435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990439">enc</span><span class="op" id="5990442">.</span><span class="ident" id="5990443">encodeSingle</span><span class="op" id="5990455">(</span><span class="ident" id="5990456">b</span><span class="op" id="5990457">,</span>&nbsp;<span class="ident" id="5990459">engine</span><span class="op" id="5990465">,</span>&nbsp;<span class="ident" id="5990467">value</span><span class="op" id="5990472">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5990475">}</span><br>
<span class="lineno"></span><span class="op" id="5990477">}</span>
</div>
</body>
</html>
