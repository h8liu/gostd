<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5844606">package</span>&nbsp;<span class="ident" id="5844614">link8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5844621">import</span>&nbsp;<span class="op" id="5844628">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5844631">&#34;math&#34;</span><br>
<span class="lineno">5</span><span class="op" id="5844638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5844641">//&nbsp;link&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;linking&nbsp;information&nbsp;for&nbsp;an&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5844702">//&nbsp;in&nbsp;a&nbsp;code&nbsp;section&nbsp;at&nbsp;a&nbsp;particular&nbsp;offset.</span><br>
<span class="lineno"></span><span class="comment" id="5844747">//&nbsp;it&nbsp;uses&nbsp;the&nbsp;indices&nbsp;in&nbsp;the&nbsp;package&nbsp;for&nbsp;symbol&nbsp;lookup</span><br>
<span class="lineno">10</span><span class="keyword" id="5844803">type</span>&nbsp;<span class="ident" id="5844808">link</span>&nbsp;<span class="keyword" id="5844813">struct</span>&nbsp;<span class="op" id="5844820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844823">offset</span>&nbsp;<span class="builtintype" id="5844830">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844838">pkg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5844845">uint32</span>&nbsp;<span class="comment" id="5844852">//&nbsp;relative&nbsp;package&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844879">sym</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5844886">uint32</span><br>
<span class="lineno"></span><span class="op" id="5844893">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5844896">//&nbsp;Func&nbsp;is&nbsp;a&nbsp;relocatable&nbsp;code&nbsp;section</span><br>
<span class="lineno"></span><span class="keyword" id="5844934">type</span>&nbsp;<span class="ident" id="5844939">Func</span>&nbsp;<span class="keyword" id="5844944">struct</span>&nbsp;<span class="op" id="5844951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844954">insts</span>&nbsp;<span class="op" id="5844960">[</span><span class="op" id="5844961">]</span><span class="builtintype" id="5844962">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844970">links</span>&nbsp;<span class="op" id="5844976">[</span><span class="op" id="5844977">]</span><span class="op" id="5844978">*</span><span class="ident" id="5844979">link</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5844986">addr</span>&nbsp;<span class="builtintype" id="5844991">uint32</span><br>
<span class="lineno"></span><span class="op" id="5844998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5845001">//&nbsp;NewFunc&nbsp;creates&nbsp;a&nbsp;new&nbsp;relocatable&nbsp;code&nbsp;section.</span><br>
<span class="lineno">25</span><span class="keyword" id="5845052">func</span>&nbsp;<span class="ident" id="5845057">NewFunc</span><span class="op" id="5845064">(</span><span class="op" id="5845065">)</span>&nbsp;<span class="op" id="5845067">*</span><span class="ident" id="5845068">Func</span>&nbsp;<span class="op" id="5845073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5845076">return</span>&nbsp;<span class="builtinfunc" id="5845083">new</span><span class="op" id="5845086">(</span><span class="ident" id="5845087">Func</span><span class="op" id="5845091">)</span><br>
<span class="lineno"></span><span class="op" id="5845093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5845096">//&nbsp;AddInst&nbsp;appends&nbsp;an&nbsp;instruction&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">30</span><span class="keyword" id="5845158">func</span>&nbsp;<span class="op" id="5845163">(</span><span class="ident" id="5845164">f</span>&nbsp;<span class="op" id="5845166">*</span><span class="ident" id="5845167">Func</span><span class="op" id="5845171">)</span>&nbsp;<span class="ident" id="5845173">AddInst</span><span class="op" id="5845180">(</span><span class="ident" id="5845181">i</span>&nbsp;<span class="builtintype" id="5845183">uint32</span><span class="op" id="5845189">)</span>&nbsp;<span class="op" id="5845191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5845194">f</span><span class="op" id="5845195">.</span><span class="ident" id="5845196">insts</span>&nbsp;<span class="op" id="5845202">=</span>&nbsp;<span class="builtinfunc" id="5845204">append</span><span class="op" id="5845210">(</span><span class="ident" id="5845211">f</span><span class="op" id="5845212">.</span><span class="ident" id="5845213">insts</span><span class="op" id="5845218">,</span>&nbsp;<span class="ident" id="5845220">i</span><span class="op" id="5845221">)</span><br>
<span class="lineno"></span><span class="op" id="5845223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5845226">//&nbsp;TooLarge&nbsp;checks&nbsp;if&nbsp;the&nbsp;function&nbsp;size&nbsp;is&nbsp;larger&nbsp;than&nbsp;4GB.</span><br>
<span class="lineno">35</span><span class="keyword" id="5845286">func</span>&nbsp;<span class="op" id="5845291">(</span><span class="ident" id="5845292">f</span>&nbsp;<span class="op" id="5845294">*</span><span class="ident" id="5845295">Func</span><span class="op" id="5845299">)</span>&nbsp;<span class="ident" id="5845301">TooLarge</span><span class="op" id="5845309">(</span><span class="op" id="5845310">)</span>&nbsp;<span class="builtintype" id="5845312">bool</span>&nbsp;<span class="op" id="5845317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5845320">return</span>&nbsp;<span class="builtinfunc" id="5845327">len</span><span class="op" id="5845330">(</span><span class="ident" id="5845331">f</span><span class="op" id="5845332">.</span><span class="ident" id="5845333">insts</span><span class="op" id="5845338">)</span><span class="op" id="5845339">*</span><span class="num" id="5845340">4</span>&nbsp;<span class="op" id="5845342">&gt;=</span>&nbsp;<span class="ident" id="5845345">math</span><span class="op" id="5845349">.</span><span class="ident" id="5845350">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="5845359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5845362">//&nbsp;Size&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">40</span><span class="keyword" id="5845404">func</span>&nbsp;<span class="op" id="5845409">(</span><span class="ident" id="5845410">f</span>&nbsp;<span class="op" id="5845412">*</span><span class="ident" id="5845413">Func</span><span class="op" id="5845417">)</span>&nbsp;<span class="ident" id="5845419">Size</span><span class="op" id="5845423">(</span><span class="op" id="5845424">)</span>&nbsp;<span class="builtintype" id="5845426">uint32</span>&nbsp;<span class="op" id="5845433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5845436">return</span>&nbsp;<span class="builtintype" id="5845443">uint32</span><span class="op" id="5845449">(</span><span class="builtinfunc" id="5845450">len</span><span class="op" id="5845453">(</span><span class="ident" id="5845454">f</span><span class="op" id="5845455">.</span><span class="ident" id="5845456">insts</span><span class="op" id="5845461">)</span>&nbsp;<span class="op" id="5845463">*</span>&nbsp;<span class="num" id="5845465">4</span><span class="op" id="5845466">)</span><br>
<span class="lineno"></span><span class="op" id="5845468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5845471">//&nbsp;AddLink&nbsp;links&nbsp;the&nbsp;last&nbsp;instruction&nbsp;in&nbsp;inst&nbsp;to</span><br>
<span class="lineno">45</span><span class="comment" id="5845520">//&nbsp;the&nbsp;symbol&nbsp;pkg.sym,&nbsp;where&nbsp;pkg&nbsp;and&nbsp;sym&nbsp;are&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5845575">//&nbsp;indexing&nbsp;of&nbsp;the&nbsp;object&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="5845607">//&nbsp;fill&nbsp;field&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;4&nbsp;so&nbsp;that&nbsp;it&nbsp;fits&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5845664">//&nbsp;lowest&nbsp;2&nbsp;bits&nbsp;in&nbsp;the&nbsp;offset&nbsp;field.&nbsp;The&nbsp;other&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5845717">//&nbsp;of&nbsp;the&nbsp;offset&nbsp;fields&nbsp;will&nbsp;be&nbsp;automatically&nbsp;calculated</span><br>
<span class="lineno">50</span><span class="comment" id="5845774">//&nbsp;based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;instructions&nbsp;in&nbsp;insts.</span><br>
<span class="lineno"></span><span class="keyword" id="5845823">func</span>&nbsp;<span class="op" id="5845828">(</span><span class="ident" id="5845829">f</span>&nbsp;<span class="op" id="5845831">*</span><span class="ident" id="5845832">Func</span><span class="op" id="5845836">)</span>&nbsp;<span class="ident" id="5845838">AddLink</span><span class="op" id="5845845">(</span><span class="ident" id="5845846">fill</span>&nbsp;<span class="builtintype" id="5845851">int</span><span class="op" id="5845854">,</span>&nbsp;<span class="ident" id="5845856">pkg</span><span class="op" id="5845859">,</span>&nbsp;<span class="ident" id="5845861">sym</span>&nbsp;<span class="builtintype" id="5845865">uint32</span><span class="op" id="5845871">)</span>&nbsp;<span class="op" id="5845873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5845876">if</span>&nbsp;<span class="builtinfunc" id="5845879">len</span><span class="op" id="5845882">(</span><span class="ident" id="5845883">f</span><span class="op" id="5845884">.</span><span class="ident" id="5845885">insts</span><span class="op" id="5845890">)</span>&nbsp;<span class="op" id="5845892">==</span>&nbsp;<span class="num" id="5845895">0</span>&nbsp;<span class="op" id="5845897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5845901">panic</span><span class="op" id="5845906">(</span><span class="string" id="5845907">&#34;no&nbsp;inst&nbsp;to&nbsp;link&#34;</span><span class="op" id="5845924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5845927">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5845930">if</span>&nbsp;<span class="op" id="5845933">!</span><span class="op" id="5845934">(</span><span class="ident" id="5845935">fill</span>&nbsp;<span class="op" id="5845940">&gt;</span>&nbsp;<span class="num" id="5845942">0</span>&nbsp;<span class="op" id="5845944">&amp;&amp;</span>&nbsp;<span class="ident" id="5845947">fill</span>&nbsp;<span class="op" id="5845952">&lt;=</span>&nbsp;<span class="num" id="5845955">3</span><span class="op" id="5845956">)</span>&nbsp;<span class="op" id="5845958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5845962">panic</span><span class="op" id="5845967">(</span><span class="string" id="5845968">&#34;invalid&nbsp;fill&#34;</span><span class="op" id="5845982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5845985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5845989">offset</span>&nbsp;<span class="op" id="5845996">:=</span>&nbsp;<span class="builtintype" id="5845999">uint32</span><span class="op" id="5846005">(</span><span class="builtinfunc" id="5846006">len</span><span class="op" id="5846009">(</span><span class="ident" id="5846010">f</span><span class="op" id="5846011">.</span><span class="ident" id="5846012">insts</span><span class="op" id="5846017">)</span><span class="op" id="5846018">)</span><span class="op" id="5846019">*</span><span class="num" id="5846020">4</span>&nbsp;<span class="op" id="5846022">-</span>&nbsp;<span class="num" id="5846024">4</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846027">offset</span>&nbsp;<span class="op" id="5846034">|=</span>&nbsp;<span class="builtintype" id="5846037">uint32</span><span class="op" id="5846043">(</span><span class="ident" id="5846044">fill</span><span class="op" id="5846048">)</span>&nbsp;<span class="op" id="5846050">&amp;</span>&nbsp;<span class="num" id="5846052">0x3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846057">link</span>&nbsp;<span class="op" id="5846062">:=</span>&nbsp;<span class="op" id="5846065">&amp;</span><span class="ident" id="5846066">link</span><span class="op" id="5846070">{</span><span class="ident" id="5846071">offset</span><span class="op" id="5846077">:</span>&nbsp;<span class="ident" id="5846079">offset</span><span class="op" id="5846085">,</span>&nbsp;<span class="ident" id="5846087">pkg</span><span class="op" id="5846090">:</span>&nbsp;<span class="ident" id="5846092">pkg</span><span class="op" id="5846095">,</span>&nbsp;<span class="ident" id="5846097">sym</span><span class="op" id="5846100">:</span>&nbsp;<span class="ident" id="5846102">sym</span><span class="op" id="5846105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846108">f</span><span class="op" id="5846109">.</span><span class="ident" id="5846110">links</span>&nbsp;<span class="op" id="5846116">=</span>&nbsp;<span class="builtinfunc" id="5846118">append</span><span class="op" id="5846124">(</span><span class="ident" id="5846125">f</span><span class="op" id="5846126">.</span><span class="ident" id="5846127">links</span><span class="op" id="5846132">,</span>&nbsp;<span class="ident" id="5846134">link</span><span class="op" id="5846138">)</span><br>
<span class="lineno"></span><span class="op" id="5846140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5846143">//&nbsp;Constant&nbsp;fill-later&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="5846175">const</span>&nbsp;<span class="op" id="5846181">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846184">FillNone</span>&nbsp;<span class="op" id="5846193">=</span>&nbsp;<span class="ident" id="5846195">iota</span>&nbsp;<span class="comment" id="5846200">//&nbsp;no&nbsp;fill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846212">FillLink</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5846228">//&nbsp;fill&nbsp;as&nbsp;linking&nbsp;offset&nbsp;for&nbsp;jump&nbsp;instructions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846277">FillLow</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5846293">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5846325">FillHigh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5846341">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;higher&nbsp;16&nbsp;bits</span><br>
<span class="lineno"></span><span class="op" id="5846373">)</span>
</div>
</body>
</html>
