<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sort&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GCStats&nbsp;collect&nbsp;information&nbsp;about&nbsp;recent&nbsp;garbage&nbsp;collections.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">GCStats</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">LastGC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Time</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;time&nbsp;of&nbsp;last&nbsp;collection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">NumGC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;garbage&nbsp;collections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PauseTotal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;total&nbsp;pause&nbsp;for&nbsp;all&nbsp;collections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pause</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span>&nbsp;<span class="comment">//&nbsp;pause&nbsp;history,&nbsp;most&nbsp;recent&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PauseEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Time</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;pause&nbsp;end&nbsp;times&nbsp;history,&nbsp;most&nbsp;recent&nbsp;first</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PauseQuantiles</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadGCStats&nbsp;reads&nbsp;statistics&nbsp;about&nbsp;garbage&nbsp;collection&nbsp;into&nbsp;stats.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the&nbsp;pause&nbsp;history&nbsp;is&nbsp;system-dependent;</span><br>
<span class="lineno">25</span><span class="comment">//&nbsp;stats.Pause&nbsp;slice&nbsp;will&nbsp;be&nbsp;reused&nbsp;if&nbsp;large&nbsp;enough,&nbsp;reallocated&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ReadGCStats&nbsp;may&nbsp;use&nbsp;the&nbsp;full&nbsp;capacity&nbsp;of&nbsp;the&nbsp;stats.Pause&nbsp;slice.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;stats.PauseQuantiles&nbsp;is&nbsp;non-empty,&nbsp;ReadGCStats&nbsp;fills&nbsp;it&nbsp;with&nbsp;quantiles</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;summarizing&nbsp;the&nbsp;distribution&nbsp;of&nbsp;pause&nbsp;time.&nbsp;For&nbsp;example,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;len(stats.PauseQuantiles)&nbsp;is&nbsp;5,&nbsp;it&nbsp;will&nbsp;be&nbsp;filled&nbsp;with&nbsp;the&nbsp;minimum,</span><br>
<span class="lineno">30</span><span class="comment">//&nbsp;25%,&nbsp;50%,&nbsp;75%,&nbsp;and&nbsp;maximum&nbsp;pause&nbsp;times.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">ReadGCStats</span><span class="op">(</span><span class="ident">stats</span>&nbsp;<span class="op">*</span><span class="ident">GCStats</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Create&nbsp;a&nbsp;buffer&nbsp;with&nbsp;space&nbsp;for&nbsp;at&nbsp;least&nbsp;two&nbsp;copies&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;pause&nbsp;history&nbsp;tracked&nbsp;by&nbsp;the&nbsp;runtime.&nbsp;One&nbsp;will&nbsp;be&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;the&nbsp;caller&nbsp;and&nbsp;the&nbsp;other&nbsp;will&nbsp;be&nbsp;used&nbsp;as&nbsp;transfer&nbsp;buffer</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;for&nbsp;end&nbsp;times&nbsp;history&nbsp;and&nbsp;as&nbsp;a&nbsp;temporary&nbsp;buffer&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;computing&nbsp;quantiles.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">maxPause</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">runtime</span><span class="op">.</span><span class="ident">MemStats</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">PauseNs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="ident">maxPause</span><span class="op">+</span><span class="num">3</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="ident">maxPause</span><span class="op">+</span><span class="num">3</span><span class="op">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;readGCStats&nbsp;fills&nbsp;in&nbsp;the&nbsp;pause&nbsp;and&nbsp;end&nbsp;times&nbsp;histories&nbsp;(up&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;maxPause&nbsp;entries)&nbsp;and&nbsp;then&nbsp;three&nbsp;more:&nbsp;Unix&nbsp;ns&nbsp;time&nbsp;of&nbsp;last&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;number&nbsp;of&nbsp;GC,&nbsp;and&nbsp;total&nbsp;pause&nbsp;time&nbsp;in&nbsp;nanoseconds.&nbsp;Here&nbsp;we</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;depend&nbsp;on&nbsp;the&nbsp;fact&nbsp;that&nbsp;time.Duration&#39;s&nbsp;native&nbsp;unit&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;nanoseconds,&nbsp;so&nbsp;the&nbsp;pauses&nbsp;and&nbsp;the&nbsp;total&nbsp;pause&nbsp;time&nbsp;do&nbsp;not&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;any&nbsp;conversion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">readGCStats</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">3</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">LastGC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Unix</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">NumGC</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="ident">n</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseTotal</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="ident">n</span><span class="op">+</span><span class="num">2</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">/=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="comment">//&nbsp;buffer&nbsp;holds&nbsp;pauses&nbsp;and&nbsp;end&nbsp;times</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">cap</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">maxPause</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Time</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">maxPause</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ns</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="ident">n</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">PauseEnd</span><span class="op">,</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Unix</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">ns</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;There&#39;s&nbsp;room&nbsp;for&nbsp;a&nbsp;second&nbsp;copy&nbsp;of&nbsp;the&nbsp;data&nbsp;in&nbsp;stats.Pause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;the&nbsp;allocation&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sorted</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">[</span><span class="ident">n</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">sorted</span><span class="op">,</span>&nbsp;<span class="ident">stats</span><span class="op">.</span><span class="ident">Pause</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">byDuration</span><span class="op">(</span><span class="ident">sorted</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nq</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">nq</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">sorted</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">sorted</span><span class="op">)</span><span class="op">*</span><span class="ident">i</span><span class="op">/</span><span class="ident">nq</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stats</span><span class="op">.</span><span class="ident">PauseQuantiles</span><span class="op">[</span><span class="ident">nq</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">sorted</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">sorted</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">byDuration</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">time</span><span class="op">.</span><span class="ident">Duration</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">byDuration</span><span class="op">)</span>&nbsp;<span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">byDuration</span><span class="op">)</span>&nbsp;<span class="ident">Swap</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">{</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">byDuration</span><span class="op">)</span>&nbsp;<span class="ident">Less</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">x</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment">//&nbsp;SetGCPercent&nbsp;sets&nbsp;the&nbsp;garbage&nbsp;collection&nbsp;target&nbsp;percentage:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;collection&nbsp;is&nbsp;triggered&nbsp;when&nbsp;the&nbsp;ratio&nbsp;of&nbsp;freshly&nbsp;allocated&nbsp;data</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;live&nbsp;data&nbsp;remaining&nbsp;after&nbsp;the&nbsp;previous&nbsp;collection&nbsp;reaches&nbsp;this&nbsp;percentage.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetGCPercent&nbsp;returns&nbsp;the&nbsp;previous&nbsp;setting.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;initial&nbsp;setting&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;GOGC&nbsp;environment&nbsp;variable</span><br>
<span class="lineno">95</span><span class="comment">//&nbsp;at&nbsp;startup,&nbsp;or&nbsp;100&nbsp;if&nbsp;the&nbsp;variable&nbsp;is&nbsp;not&nbsp;set.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;negative&nbsp;percentage&nbsp;disables&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">SetGCPercent</span><span class="op">(</span><span class="ident">percent</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">old</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">setGCPercent</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">percent</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runtime</span><span class="op">.</span><span class="ident">GC</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">old</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FreeOSMemory&nbsp;forces&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;followed&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;attempt&nbsp;to&nbsp;return&nbsp;as&nbsp;much&nbsp;memory&nbsp;to&nbsp;the&nbsp;operating&nbsp;system</span><br>
<span class="lineno">105</span><span class="comment">//&nbsp;as&nbsp;possible.&nbsp;(Even&nbsp;if&nbsp;this&nbsp;is&nbsp;not&nbsp;called,&nbsp;the&nbsp;runtime&nbsp;gradually</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returns&nbsp;memory&nbsp;to&nbsp;the&nbsp;operating&nbsp;system&nbsp;in&nbsp;a&nbsp;background&nbsp;task.)</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">FreeOSMemory</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">freeOSMemory</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetMaxStack&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;memory&nbsp;that</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;any&nbsp;goroutine&nbsp;exceeds&nbsp;this&nbsp;limit&nbsp;while&nbsp;growing&nbsp;its&nbsp;stack,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno">115</span><span class="comment">//&nbsp;SetMaxStack&nbsp;returns&nbsp;the&nbsp;previous&nbsp;setting.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;initial&nbsp;setting&nbsp;is&nbsp;1&nbsp;GB&nbsp;on&nbsp;64-bit&nbsp;systems,&nbsp;250&nbsp;MB&nbsp;on&nbsp;32-bit&nbsp;systems.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetMaxStack&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;limiting&nbsp;the&nbsp;damage&nbsp;done&nbsp;by</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;goroutines&nbsp;that&nbsp;enter&nbsp;an&nbsp;infinite&nbsp;recursion.&nbsp;It&nbsp;only&nbsp;limits&nbsp;future</span><br>
<span class="lineno">120</span><span class="comment">//&nbsp;stack&nbsp;growth.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">SetMaxStack</span><span class="op">(</span><span class="ident">bytes</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">setMaxStack</span><span class="op">(</span><span class="ident">bytes</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment">//&nbsp;SetMaxThreads&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;operating&nbsp;system</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;threads&nbsp;that&nbsp;the&nbsp;Go&nbsp;program&nbsp;can&nbsp;use.&nbsp;If&nbsp;it&nbsp;attempts&nbsp;to&nbsp;use&nbsp;more&nbsp;than</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;this&nbsp;many,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetMaxThreads&nbsp;returns&nbsp;the&nbsp;previous&nbsp;setting.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;initial&nbsp;setting&nbsp;is&nbsp;10,000&nbsp;threads.</span><br>
<span class="lineno">130</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;limit&nbsp;controls&nbsp;the&nbsp;number&nbsp;of&nbsp;operating&nbsp;system&nbsp;threads,&nbsp;not&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;goroutines.&nbsp;A&nbsp;Go&nbsp;program&nbsp;creates&nbsp;a&nbsp;new&nbsp;thread&nbsp;only&nbsp;when&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;run&nbsp;but&nbsp;all&nbsp;the&nbsp;existing&nbsp;threads&nbsp;are&nbsp;blocked&nbsp;in&nbsp;system&nbsp;calls,&nbsp;cgo&nbsp;calls,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;or&nbsp;are&nbsp;locked&nbsp;to&nbsp;other&nbsp;goroutines&nbsp;due&nbsp;to&nbsp;use&nbsp;of&nbsp;runtime.LockOSThread.</span><br>
<span class="lineno">135</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetMaxThreads&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;limiting&nbsp;the&nbsp;damage&nbsp;done&nbsp;by</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;programs&nbsp;that&nbsp;create&nbsp;an&nbsp;unbounded&nbsp;number&nbsp;of&nbsp;threads.&nbsp;The&nbsp;idea&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;take&nbsp;down&nbsp;the&nbsp;program&nbsp;before&nbsp;it&nbsp;takes&nbsp;down&nbsp;the&nbsp;operating&nbsp;system.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">SetMaxThreads</span><span class="op">(</span><span class="ident">threads</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">setMaxThreads</span><span class="op">(</span><span class="ident">threads</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetPanicOnFault&nbsp;controls&nbsp;the&nbsp;runtime&#39;s&nbsp;behavior&nbsp;when&nbsp;a&nbsp;program&nbsp;faults</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;at&nbsp;an&nbsp;unexpected&nbsp;(non-nil)&nbsp;address.&nbsp;Such&nbsp;faults&nbsp;are&nbsp;typically&nbsp;caused&nbsp;by</span><br>
<span class="lineno">145</span><span class="comment">//&nbsp;bugs&nbsp;such&nbsp;as&nbsp;runtime&nbsp;memory&nbsp;corruption,&nbsp;so&nbsp;the&nbsp;default&nbsp;response&nbsp;is&nbsp;to&nbsp;crash</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;program.&nbsp;Programs&nbsp;working&nbsp;with&nbsp;memory-mapped&nbsp;files&nbsp;or&nbsp;unsafe</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;manipulation&nbsp;of&nbsp;memory&nbsp;may&nbsp;cause&nbsp;faults&nbsp;at&nbsp;non-nil&nbsp;addresses&nbsp;in&nbsp;less</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;dramatic&nbsp;situations;&nbsp;SetPanicOnFault&nbsp;allows&nbsp;such&nbsp;programs&nbsp;to&nbsp;request</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;the&nbsp;runtime&nbsp;trigger&nbsp;only&nbsp;a&nbsp;panic,&nbsp;not&nbsp;a&nbsp;crash.</span><br>
<span class="lineno">150</span><span class="comment">//&nbsp;SetPanicOnFault&nbsp;applies&nbsp;only&nbsp;to&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;previous&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">SetPanicOnFault</span><span class="op">(</span><span class="ident">enabled</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">setPanicOnFault</span><span class="op">(</span><span class="ident">enabled</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;WriteHeapDump&nbsp;writes&nbsp;a&nbsp;description&nbsp;of&nbsp;the&nbsp;heap&nbsp;and&nbsp;the&nbsp;objects&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;it&nbsp;to&nbsp;the&nbsp;given&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;heap&nbsp;dump&nbsp;format&nbsp;is&nbsp;defined&nbsp;at&nbsp;http://golang.org/s/go13heapdump.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">WriteHeapDump</span><span class="op">(</span><span class="ident">fd</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">)</span>
</div>
</body>
</html>
