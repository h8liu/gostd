<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8510314">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8510369">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8510423">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8510474">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8510500">package</span>&nbsp;<span class="ident" id="8510508">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8510513">import</span>&nbsp;<span class="op" id="8510520">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510523">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510532">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510539">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510545">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510552">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510564">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510585">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510591">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510602">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510619">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510630">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510641">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510652">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8510663">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8510670">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="8510673">func</span>&nbsp;<span class="ident" id="8510678">newRequest</span><span class="op" id="8510688">(</span><span class="ident" id="8510689">httpreq</span>&nbsp;<span class="builtintype" id="8510697">string</span><span class="op" id="8510703">)</span>&nbsp;<span class="op" id="8510705">*</span><span class="ident" id="8510706">http</span><span class="op" id="8510710">.</span><span class="ident" id="8510711">Request</span>&nbsp;<span class="op" id="8510719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510722">buf</span>&nbsp;<span class="op" id="8510726">:=</span>&nbsp;<span class="ident" id="8510729">bufio</span><span class="op" id="8510734">.</span><span class="ident" id="8510735">NewReader</span><span class="op" id="8510744">(</span><span class="ident" id="8510745">strings</span><span class="op" id="8510752">.</span><span class="ident" id="8510753">NewReader</span><span class="op" id="8510762">(</span><span class="ident" id="8510763">httpreq</span><span class="op" id="8510770">)</span><span class="op" id="8510771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510774">req</span><span class="op" id="8510777">,</span>&nbsp;<span class="ident" id="8510779">err</span>&nbsp;<span class="op" id="8510783">:=</span>&nbsp;<span class="ident" id="8510786">http</span><span class="op" id="8510790">.</span><span class="ident" id="8510791">ReadRequest</span><span class="op" id="8510802">(</span><span class="ident" id="8510803">buf</span><span class="op" id="8510806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510809">if</span>&nbsp;<span class="ident" id="8510812">err</span>&nbsp;<span class="op" id="8510816">!=</span>&nbsp;<span class="ident" id="8510819">nil</span>&nbsp;<span class="op" id="8510823">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8510827">panic</span><span class="op" id="8510832">(</span><span class="string" id="8510833">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="8510869">+</span>&nbsp;<span class="ident" id="8510871">httpreq</span><span class="op" id="8510878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510884">req</span><span class="op" id="8510887">.</span><span class="ident" id="8510888">RemoteAddr</span>&nbsp;<span class="op" id="8510899">=</span>&nbsp;<span class="string" id="8510901">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510912">return</span>&nbsp;<span class="ident" id="8510919">req</span><br>
<span class="lineno"></span><span class="op" id="8510923">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="8510926">func</span>&nbsp;<span class="ident" id="8510931">runCgiTest</span><span class="op" id="8510941">(</span><span class="ident" id="8510942">t</span>&nbsp;<span class="op" id="8510944">*</span><span class="ident" id="8510945">testing</span><span class="op" id="8510952">.</span><span class="ident" id="8510953">T</span><span class="op" id="8510954">,</span>&nbsp;<span class="ident" id="8510956">h</span>&nbsp;<span class="op" id="8510958">*</span><span class="ident" id="8510959">Handler</span><span class="op" id="8510966">,</span>&nbsp;<span class="ident" id="8510968">httpreq</span>&nbsp;<span class="builtintype" id="8510976">string</span><span class="op" id="8510982">,</span>&nbsp;<span class="ident" id="8510984">expectedMap</span>&nbsp;<span class="keyword" id="8510996">map</span><span class="op" id="8510999">[</span><span class="builtintype" id="8511000">string</span><span class="op" id="8511006">]</span><span class="builtintype" id="8511007">string</span><span class="op" id="8511013">)</span>&nbsp;<span class="op" id="8511015">*</span><span class="ident" id="8511016">httptest</span><span class="op" id="8511024">.</span><span class="ident" id="8511025">ResponseRecorder</span>&nbsp;<span class="op" id="8511042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511045">rw</span>&nbsp;<span class="op" id="8511048">:=</span>&nbsp;<span class="ident" id="8511051">httptest</span><span class="op" id="8511059">.</span><span class="ident" id="8511060">NewRecorder</span><span class="op" id="8511071">(</span><span class="op" id="8511072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511075">req</span>&nbsp;<span class="op" id="8511079">:=</span>&nbsp;<span class="ident" id="8511082">newRequest</span><span class="op" id="8511092">(</span><span class="ident" id="8511093">httpreq</span><span class="op" id="8511100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511103">h</span><span class="op" id="8511104">.</span><span class="ident" id="8511105">ServeHTTP</span><span class="op" id="8511114">(</span><span class="ident" id="8511115">rw</span><span class="op" id="8511117">,</span>&nbsp;<span class="ident" id="8511119">req</span><span class="op" id="8511122">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8511126">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511184">m</span>&nbsp;<span class="op" id="8511186">:=</span>&nbsp;<span class="builtinfunc" id="8511189">make</span><span class="op" id="8511193">(</span><span class="keyword" id="8511194">map</span><span class="op" id="8511197">[</span><span class="builtintype" id="8511198">string</span><span class="op" id="8511204">]</span><span class="builtintype" id="8511205">string</span><span class="op" id="8511211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511214">m</span><span class="op" id="8511215">[</span><span class="string" id="8511216">&#34;_body&#34;</span><span class="op" id="8511223">]</span>&nbsp;<span class="op" id="8511225">=</span>&nbsp;<span class="ident" id="8511227">rw</span><span class="op" id="8511229">.</span><span class="ident" id="8511230">Body</span><span class="op" id="8511234">.</span><span class="ident" id="8511235">String</span><span class="op" id="8511241">(</span><span class="op" id="8511242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511245">linesRead</span>&nbsp;<span class="op" id="8511255">:=</span>&nbsp;<span class="num" id="8511258">0</span><br>
<span class="lineno">45</span><span class="ident" id="8511260">readlines</span><span class="op" id="8511269">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511272">for</span>&nbsp;<span class="op" id="8511276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511280">line</span><span class="op" id="8511284">,</span>&nbsp;<span class="ident" id="8511286">err</span>&nbsp;<span class="op" id="8511290">:=</span>&nbsp;<span class="ident" id="8511293">rw</span><span class="op" id="8511295">.</span><span class="ident" id="8511296">Body</span><span class="op" id="8511300">.</span><span class="ident" id="8511301">ReadString</span><span class="op" id="8511311">(</span><span class="string" id="8511312">&#39;\n&#39;</span><span class="op" id="8511316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511320">switch</span>&nbsp;<span class="op" id="8511327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511331">case</span>&nbsp;<span class="ident" id="8511336">err</span>&nbsp;<span class="op" id="8511340">==</span>&nbsp;<span class="ident" id="8511343">io</span><span class="op" id="8511345">.</span><span class="ident" id="8511346">EOF</span><span class="op" id="8511349">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511354">break</span>&nbsp;<span class="ident" id="8511360">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511372">case</span>&nbsp;<span class="ident" id="8511377">err</span>&nbsp;<span class="op" id="8511381">!=</span>&nbsp;<span class="ident" id="8511384">nil</span><span class="op" id="8511387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511392">t</span><span class="op" id="8511393">.</span><span class="ident" id="8511394">Fatalf</span><span class="op" id="8511400">(</span><span class="string" id="8511401">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="8511440">,</span>&nbsp;<span class="ident" id="8511442">err</span><span class="op" id="8511445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511453">linesRead</span><span class="op" id="8511462">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511467">trimmedLine</span>&nbsp;<span class="op" id="8511479">:=</span>&nbsp;<span class="ident" id="8511482">strings</span><span class="op" id="8511489">.</span><span class="ident" id="8511490">TrimRight</span><span class="op" id="8511499">(</span><span class="ident" id="8511500">line</span><span class="op" id="8511504">,</span>&nbsp;<span class="string" id="8511506">&#34;\r\n&#34;</span><span class="op" id="8511512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511516">split</span>&nbsp;<span class="op" id="8511522">:=</span>&nbsp;<span class="ident" id="8511525">strings</span><span class="op" id="8511532">.</span><span class="ident" id="8511533">SplitN</span><span class="op" id="8511539">(</span><span class="ident" id="8511540">trimmedLine</span><span class="op" id="8511551">,</span>&nbsp;<span class="string" id="8511553">&#34;=&#34;</span><span class="op" id="8511556">,</span>&nbsp;<span class="num" id="8511558">2</span><span class="op" id="8511559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511563">if</span>&nbsp;<span class="builtinfunc" id="8511566">len</span><span class="op" id="8511569">(</span><span class="ident" id="8511570">split</span><span class="op" id="8511575">)</span>&nbsp;<span class="op" id="8511577">!=</span>&nbsp;<span class="num" id="8511580">2</span>&nbsp;<span class="op" id="8511582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511587">t</span><span class="op" id="8511588">.</span><span class="ident" id="8511589">Fatalf</span><span class="op" id="8511595">(</span><span class="string" id="8511596">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="8511666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8511672">len</span><span class="op" id="8511675">(</span><span class="ident" id="8511676">split</span><span class="op" id="8511681">)</span><span class="op" id="8511682">,</span>&nbsp;<span class="ident" id="8511684">linesRead</span><span class="op" id="8511693">,</span>&nbsp;<span class="ident" id="8511695">line</span><span class="op" id="8511699">,</span>&nbsp;<span class="ident" id="8511701">m</span><span class="op" id="8511702">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511710">m</span><span class="op" id="8511711">[</span><span class="ident" id="8511712">split</span><span class="op" id="8511717">[</span><span class="num" id="8511718">0</span><span class="op" id="8511719">]</span><span class="op" id="8511720">]</span>&nbsp;<span class="op" id="8511722">=</span>&nbsp;<span class="ident" id="8511724">split</span><span class="op" id="8511729">[</span><span class="num" id="8511730">1</span><span class="op" id="8511731">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511738">for</span>&nbsp;<span class="ident" id="8511742">key</span><span class="op" id="8511745">,</span>&nbsp;<span class="ident" id="8511747">expected</span>&nbsp;<span class="op" id="8511756">:=</span>&nbsp;<span class="keyword" id="8511759">range</span>&nbsp;<span class="ident" id="8511765">expectedMap</span>&nbsp;<span class="op" id="8511777">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511781">got</span>&nbsp;<span class="op" id="8511785">:=</span>&nbsp;<span class="ident" id="8511788">m</span><span class="op" id="8511789">[</span><span class="ident" id="8511790">key</span><span class="op" id="8511793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511797">if</span>&nbsp;<span class="ident" id="8511800">key</span>&nbsp;<span class="op" id="8511804">==</span>&nbsp;<span class="string" id="8511807">&#34;cwd&#34;</span>&nbsp;<span class="op" id="8511813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8511818">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511860">fi1</span><span class="op" id="8511863">,</span>&nbsp;<span class="ident" id="8511865">_</span>&nbsp;<span class="op" id="8511867">:=</span>&nbsp;<span class="ident" id="8511870">os</span><span class="op" id="8511872">.</span><span class="ident" id="8511873">Stat</span><span class="op" id="8511877">(</span><span class="ident" id="8511878">got</span><span class="op" id="8511881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511886">fi2</span><span class="op" id="8511889">,</span>&nbsp;<span class="ident" id="8511891">_</span>&nbsp;<span class="op" id="8511893">:=</span>&nbsp;<span class="ident" id="8511896">os</span><span class="op" id="8511898">.</span><span class="ident" id="8511899">Stat</span><span class="op" id="8511903">(</span><span class="ident" id="8511904">expected</span><span class="op" id="8511912">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511917">if</span>&nbsp;<span class="ident" id="8511920">os</span><span class="op" id="8511922">.</span><span class="ident" id="8511923">SameFile</span><span class="op" id="8511931">(</span><span class="ident" id="8511932">fi1</span><span class="op" id="8511935">,</span>&nbsp;<span class="ident" id="8511937">fi2</span><span class="op" id="8511940">)</span>&nbsp;<span class="op" id="8511942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511948">got</span>&nbsp;<span class="op" id="8511952">=</span>&nbsp;<span class="ident" id="8511954">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511974">if</span>&nbsp;<span class="ident" id="8511977">got</span>&nbsp;<span class="op" id="8511981">!=</span>&nbsp;<span class="ident" id="8511984">expected</span>&nbsp;<span class="op" id="8511993">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511998">t</span><span class="op" id="8511999">.</span><span class="ident" id="8512000">Errorf</span><span class="op" id="8512006">(</span><span class="string" id="8512007">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8512039">,</span>&nbsp;<span class="ident" id="8512041">key</span><span class="op" id="8512044">,</span>&nbsp;<span class="ident" id="8512046">got</span><span class="op" id="8512049">,</span>&nbsp;<span class="ident" id="8512051">expected</span><span class="op" id="8512059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512069">return</span>&nbsp;<span class="ident" id="8512076">rw</span><br>
<span class="lineno"></span><span class="op" id="8512079">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="8512082">var</span>&nbsp;<span class="ident" id="8512086">cgiTested</span><span class="op" id="8512095">,</span>&nbsp;<span class="ident" id="8512097">cgiWorks</span>&nbsp;<span class="builtintype" id="8512106">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8512112">func</span>&nbsp;<span class="ident" id="8512117">check</span><span class="op" id="8512122">(</span><span class="ident" id="8512123">t</span>&nbsp;<span class="op" id="8512125">*</span><span class="ident" id="8512126">testing</span><span class="op" id="8512133">.</span><span class="ident" id="8512134">T</span><span class="op" id="8512135">)</span>&nbsp;<span class="op" id="8512137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512140">if</span>&nbsp;<span class="op" id="8512143">!</span><span class="ident" id="8512144">cgiTested</span>&nbsp;<span class="op" id="8512154">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512158">cgiTested</span>&nbsp;<span class="op" id="8512168">=</span>&nbsp;<span class="builtintype" id="8512170">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512177">cgiWorks</span>&nbsp;<span class="op" id="8512186">=</span>&nbsp;<span class="ident" id="8512188">exec</span><span class="op" id="8512192">.</span><span class="ident" id="8512193">Command</span><span class="op" id="8512200">(</span><span class="string" id="8512201">&#34;./testdata/test.cgi&#34;</span><span class="op" id="8512222">)</span><span class="op" id="8512223">.</span><span class="ident" id="8512224">Run</span><span class="op" id="8512227">(</span><span class="op" id="8512228">)</span>&nbsp;<span class="op" id="8512230">==</span>&nbsp;<span class="ident" id="8512233">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512241">if</span>&nbsp;<span class="op" id="8512244">!</span><span class="ident" id="8512245">cgiWorks</span>&nbsp;<span class="op" id="8512254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8512258">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8512302">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512353">t</span><span class="op" id="8512354">.</span><span class="ident" id="8512355">Skip</span><span class="op" id="8512359">(</span><span class="string" id="8512360">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="8512393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512396">}</span><br>
<span class="lineno"></span><span class="op" id="8512398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8512401">func</span>&nbsp;<span class="ident" id="8512406">TestCGIBasicGet</span><span class="op" id="8512421">(</span><span class="ident" id="8512422">t</span>&nbsp;<span class="op" id="8512424">*</span><span class="ident" id="8512425">testing</span><span class="op" id="8512432">.</span><span class="ident" id="8512433">T</span><span class="op" id="8512434">)</span>&nbsp;<span class="op" id="8512436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512439">check</span><span class="op" id="8512444">(</span><span class="ident" id="8512445">t</span><span class="op" id="8512446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512449">h</span>&nbsp;<span class="op" id="8512451">:=</span>&nbsp;<span class="op" id="8512454">&amp;</span><span class="ident" id="8512455">Handler</span><span class="op" id="8512462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512466">Path</span><span class="op" id="8512470">:</span>&nbsp;<span class="string" id="8512472">&#34;testdata/test.cgi&#34;</span><span class="op" id="8512491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512495">Root</span><span class="op" id="8512499">:</span>&nbsp;<span class="string" id="8512501">&#34;/test.cgi&#34;</span><span class="op" id="8512512">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512518">expectedMap</span>&nbsp;<span class="op" id="8512530">:=</span>&nbsp;<span class="keyword" id="8512533">map</span><span class="op" id="8512536">[</span><span class="builtintype" id="8512537">string</span><span class="op" id="8512543">]</span><span class="builtintype" id="8512544">string</span><span class="op" id="8512550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512554">&#34;test&#34;</span><span class="op" id="8512560">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512579">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8512590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512594">&#34;param-a&#34;</span><span class="op" id="8512603">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512619">&#34;b&#34;</span><span class="op" id="8512622">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512626">&#34;param-foo&#34;</span><span class="op" id="8512637">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512651">&#34;bar&#34;</span><span class="op" id="8512656">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512660">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8512683">:</span>&nbsp;<span class="string" id="8512685">&#34;CGI/1.1&#34;</span><span class="op" id="8512694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512698">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8512713">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512723">&#34;example.com&#34;</span><span class="op" id="8512736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512740">&#34;env-PATH_INFO&#34;</span><span class="op" id="8512755">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512765">&#34;&#34;</span><span class="op" id="8512767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512771">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8512789">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512796">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8512809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512813">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8512830">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512838">&#34;1.2.3.4&#34;</span><span class="op" id="8512847">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512851">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8512868">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512876">&#34;1.2.3.4&#34;</span><span class="op" id="8512885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512889">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8512909">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512914">&#34;GET&#34;</span><span class="op" id="8512919">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512923">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8512940">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8512948">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8512971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8512975">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8512996">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8513000">&#34;testdata/test.cgi&#34;</span><span class="op" id="8513019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513023">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8513040">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8513048">&#34;/test.cgi&#34;</span><span class="op" id="8513059">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513063">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8513080">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8513088">&#34;example.com&#34;</span><span class="op" id="8513101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513105">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8513122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8513130">&#34;80&#34;</span><span class="op" id="8513134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513138">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8513159">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8513163">&#34;go&#34;</span><span class="op" id="8513167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513173">replay</span>&nbsp;<span class="op" id="8513180">:=</span>&nbsp;<span class="ident" id="8513183">runCgiTest</span><span class="op" id="8513193">(</span><span class="ident" id="8513194">t</span><span class="op" id="8513195">,</span>&nbsp;<span class="ident" id="8513197">h</span><span class="op" id="8513198">,</span>&nbsp;<span class="string" id="8513200">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8513259">,</span>&nbsp;<span class="ident" id="8513261">expectedMap</span><span class="op" id="8513272">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513276">if</span>&nbsp;<span class="ident" id="8513279">expected</span><span class="op" id="8513287">,</span>&nbsp;<span class="ident" id="8513289">got</span>&nbsp;<span class="op" id="8513293">:=</span>&nbsp;<span class="string" id="8513296">&#34;text/html&#34;</span><span class="op" id="8513307">,</span>&nbsp;<span class="ident" id="8513309">replay</span><span class="op" id="8513315">.</span><span class="ident" id="8513316">Header</span><span class="op" id="8513322">(</span><span class="op" id="8513323">)</span><span class="op" id="8513324">.</span><span class="ident" id="8513325">Get</span><span class="op" id="8513328">(</span><span class="string" id="8513329">&#34;Content-Type&#34;</span><span class="op" id="8513343">)</span><span class="op" id="8513344">;</span>&nbsp;<span class="ident" id="8513346">got</span>&nbsp;<span class="op" id="8513350">!=</span>&nbsp;<span class="ident" id="8513353">expected</span>&nbsp;<span class="op" id="8513362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513366">t</span><span class="op" id="8513367">.</span><span class="ident" id="8513368">Errorf</span><span class="op" id="8513374">(</span><span class="string" id="8513375">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8513414">,</span>&nbsp;<span class="ident" id="8513416">got</span><span class="op" id="8513419">,</span>&nbsp;<span class="ident" id="8513421">expected</span><span class="op" id="8513429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513435">if</span>&nbsp;<span class="ident" id="8513438">expected</span><span class="op" id="8513446">,</span>&nbsp;<span class="ident" id="8513448">got</span>&nbsp;<span class="op" id="8513452">:=</span>&nbsp;<span class="string" id="8513455">&#34;X-Test-Value&#34;</span><span class="op" id="8513469">,</span>&nbsp;<span class="ident" id="8513471">replay</span><span class="op" id="8513477">.</span><span class="ident" id="8513478">Header</span><span class="op" id="8513484">(</span><span class="op" id="8513485">)</span><span class="op" id="8513486">.</span><span class="ident" id="8513487">Get</span><span class="op" id="8513490">(</span><span class="string" id="8513491">&#34;X-Test-Header&#34;</span><span class="op" id="8513506">)</span><span class="op" id="8513507">;</span>&nbsp;<span class="ident" id="8513509">got</span>&nbsp;<span class="op" id="8513513">!=</span>&nbsp;<span class="ident" id="8513516">expected</span>&nbsp;<span class="op" id="8513525">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513529">t</span><span class="op" id="8513530">.</span><span class="ident" id="8513531">Errorf</span><span class="op" id="8513537">(</span><span class="string" id="8513538">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8513578">,</span>&nbsp;<span class="ident" id="8513580">got</span><span class="op" id="8513583">,</span>&nbsp;<span class="ident" id="8513585">expected</span><span class="op" id="8513593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513596">}</span><br>
<span class="lineno"></span><span class="op" id="8513598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8513601">func</span>&nbsp;<span class="ident" id="8513606">TestCGIBasicGetAbsPath</span><span class="op" id="8513628">(</span><span class="ident" id="8513629">t</span>&nbsp;<span class="op" id="8513631">*</span><span class="ident" id="8513632">testing</span><span class="op" id="8513639">.</span><span class="ident" id="8513640">T</span><span class="op" id="8513641">)</span>&nbsp;<span class="op" id="8513643">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513646">check</span><span class="op" id="8513651">(</span><span class="ident" id="8513652">t</span><span class="op" id="8513653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513656">pwd</span><span class="op" id="8513659">,</span>&nbsp;<span class="ident" id="8513661">err</span>&nbsp;<span class="op" id="8513665">:=</span>&nbsp;<span class="ident" id="8513668">os</span><span class="op" id="8513670">.</span><span class="ident" id="8513671">Getwd</span><span class="op" id="8513676">(</span><span class="op" id="8513677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513680">if</span>&nbsp;<span class="ident" id="8513683">err</span>&nbsp;<span class="op" id="8513687">!=</span>&nbsp;<span class="ident" id="8513690">nil</span>&nbsp;<span class="op" id="8513694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513698">t</span><span class="op" id="8513699">.</span><span class="ident" id="8513700">Fatalf</span><span class="op" id="8513706">(</span><span class="string" id="8513707">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8513724">,</span>&nbsp;<span class="ident" id="8513726">err</span><span class="op" id="8513729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513732">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513735">h</span>&nbsp;<span class="op" id="8513737">:=</span>&nbsp;<span class="op" id="8513740">&amp;</span><span class="ident" id="8513741">Handler</span><span class="op" id="8513748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513752">Path</span><span class="op" id="8513756">:</span>&nbsp;<span class="ident" id="8513758">pwd</span>&nbsp;<span class="op" id="8513762">+</span>&nbsp;<span class="string" id="8513764">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8513784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513788">Root</span><span class="op" id="8513792">:</span>&nbsp;<span class="string" id="8513794">&#34;/test.cgi&#34;</span><span class="op" id="8513805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513811">expectedMap</span>&nbsp;<span class="op" id="8513823">:=</span>&nbsp;<span class="keyword" id="8513826">map</span><span class="op" id="8513829">[</span><span class="builtintype" id="8513830">string</span><span class="op" id="8513836">]</span><span class="builtintype" id="8513837">string</span><span class="op" id="8513843">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513847">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8513864">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8513870">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="8513893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513897">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8513918">:</span>&nbsp;<span class="ident" id="8513920">pwd</span>&nbsp;<span class="op" id="8513924">+</span>&nbsp;<span class="string" id="8513926">&#34;/testdata/test.cgi&#34;</span><span class="op" id="8513946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8513950">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8513967">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8513973">&#34;/test.cgi&#34;</span><span class="op" id="8513984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513990">runCgiTest</span><span class="op" id="8514000">(</span><span class="ident" id="8514001">t</span><span class="op" id="8514002">,</span>&nbsp;<span class="ident" id="8514004">h</span><span class="op" id="8514005">,</span>&nbsp;<span class="string" id="8514007">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8514066">,</span>&nbsp;<span class="ident" id="8514068">expectedMap</span><span class="op" id="8514079">)</span><br>
<span class="lineno">145</span><span class="op" id="8514081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8514084">func</span>&nbsp;<span class="ident" id="8514089">TestPathInfo</span><span class="op" id="8514101">(</span><span class="ident" id="8514102">t</span>&nbsp;<span class="op" id="8514104">*</span><span class="ident" id="8514105">testing</span><span class="op" id="8514112">.</span><span class="ident" id="8514113">T</span><span class="op" id="8514114">)</span>&nbsp;<span class="op" id="8514116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514119">check</span><span class="op" id="8514124">(</span><span class="ident" id="8514125">t</span><span class="op" id="8514126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514129">h</span>&nbsp;<span class="op" id="8514131">:=</span>&nbsp;<span class="op" id="8514134">&amp;</span><span class="ident" id="8514135">Handler</span><span class="op" id="8514142">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514146">Path</span><span class="op" id="8514150">:</span>&nbsp;<span class="string" id="8514152">&#34;testdata/test.cgi&#34;</span><span class="op" id="8514171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514175">Root</span><span class="op" id="8514179">:</span>&nbsp;<span class="string" id="8514181">&#34;/test.cgi&#34;</span><span class="op" id="8514192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514198">expectedMap</span>&nbsp;<span class="op" id="8514210">:=</span>&nbsp;<span class="keyword" id="8514213">map</span><span class="op" id="8514216">[</span><span class="builtintype" id="8514217">string</span><span class="op" id="8514223">]</span><span class="builtintype" id="8514224">string</span><span class="op" id="8514230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514234">&#34;param-a&#34;</span><span class="op" id="8514243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514257">&#34;b&#34;</span><span class="op" id="8514260">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514264">&#34;env-PATH_INFO&#34;</span><span class="op" id="8514279">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514287">&#34;/extrapath&#34;</span><span class="op" id="8514299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514303">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8514321">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514326">&#34;a=b&#34;</span><span class="op" id="8514331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514335">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8514352">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514358">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="8514383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514387">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8514408">:</span>&nbsp;<span class="string" id="8514410">&#34;testdata/test.cgi&#34;</span><span class="op" id="8514429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514433">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8514450">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514456">&#34;/test.cgi&#34;</span><span class="op" id="8514467">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514473">runCgiTest</span><span class="op" id="8514483">(</span><span class="ident" id="8514484">t</span><span class="op" id="8514485">,</span>&nbsp;<span class="ident" id="8514487">h</span><span class="op" id="8514488">,</span>&nbsp;<span class="string" id="8514490">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8514551">,</span>&nbsp;<span class="ident" id="8514553">expectedMap</span><span class="op" id="8514564">)</span><br>
<span class="lineno"></span><span class="op" id="8514566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8514569">func</span>&nbsp;<span class="ident" id="8514574">TestPathInfoDirRoot</span><span class="op" id="8514593">(</span><span class="ident" id="8514594">t</span>&nbsp;<span class="op" id="8514596">*</span><span class="ident" id="8514597">testing</span><span class="op" id="8514604">.</span><span class="ident" id="8514605">T</span><span class="op" id="8514606">)</span>&nbsp;<span class="op" id="8514608">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514611">check</span><span class="op" id="8514616">(</span><span class="ident" id="8514617">t</span><span class="op" id="8514618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514621">h</span>&nbsp;<span class="op" id="8514623">:=</span>&nbsp;<span class="op" id="8514626">&amp;</span><span class="ident" id="8514627">Handler</span><span class="op" id="8514634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514638">Path</span><span class="op" id="8514642">:</span>&nbsp;<span class="string" id="8514644">&#34;testdata/test.cgi&#34;</span><span class="op" id="8514663">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514667">Root</span><span class="op" id="8514671">:</span>&nbsp;<span class="string" id="8514673">&#34;/myscript/&#34;</span><span class="op" id="8514685">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514688">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514691">expectedMap</span>&nbsp;<span class="op" id="8514703">:=</span>&nbsp;<span class="keyword" id="8514706">map</span><span class="op" id="8514709">[</span><span class="builtintype" id="8514710">string</span><span class="op" id="8514716">]</span><span class="builtintype" id="8514717">string</span><span class="op" id="8514723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514727">&#34;env-PATH_INFO&#34;</span><span class="op" id="8514742">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514750">&#34;bar&#34;</span><span class="op" id="8514755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514759">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8514777">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514782">&#34;a=b&#34;</span><span class="op" id="8514787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514791">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8514808">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514814">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8514833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514837">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8514858">:</span>&nbsp;<span class="string" id="8514860">&#34;testdata/test.cgi&#34;</span><span class="op" id="8514879">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8514883">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8514900">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8514906">&#34;/myscript/&#34;</span><span class="op" id="8514918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514924">runCgiTest</span><span class="op" id="8514934">(</span><span class="ident" id="8514935">t</span><span class="op" id="8514936">,</span>&nbsp;<span class="ident" id="8514938">h</span><span class="op" id="8514939">,</span>&nbsp;<span class="string" id="8514941">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8514996">,</span>&nbsp;<span class="ident" id="8514998">expectedMap</span><span class="op" id="8515009">)</span><br>
<span class="lineno"></span><span class="op" id="8515011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8515014">func</span>&nbsp;<span class="ident" id="8515019">TestDupHeaders</span><span class="op" id="8515033">(</span><span class="ident" id="8515034">t</span>&nbsp;<span class="op" id="8515036">*</span><span class="ident" id="8515037">testing</span><span class="op" id="8515044">.</span><span class="ident" id="8515045">T</span><span class="op" id="8515046">)</span>&nbsp;<span class="op" id="8515048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515051">check</span><span class="op" id="8515056">(</span><span class="ident" id="8515057">t</span><span class="op" id="8515058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515061">h</span>&nbsp;<span class="op" id="8515063">:=</span>&nbsp;<span class="op" id="8515066">&amp;</span><span class="ident" id="8515067">Handler</span><span class="op" id="8515074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515078">Path</span><span class="op" id="8515082">:</span>&nbsp;<span class="string" id="8515084">&#34;testdata/test.cgi&#34;</span><span class="op" id="8515103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515106">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515109">expectedMap</span>&nbsp;<span class="op" id="8515121">:=</span>&nbsp;<span class="keyword" id="8515124">map</span><span class="op" id="8515127">[</span><span class="builtintype" id="8515128">string</span><span class="op" id="8515134">]</span><span class="builtintype" id="8515135">string</span><span class="op" id="8515141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515145">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8515162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515168">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="8515187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515191">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8515212">:</span>&nbsp;<span class="string" id="8515214">&#34;testdata/test.cgi&#34;</span><span class="op" id="8515233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515237">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="8515254">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515260">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="8515278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515282">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="8515298">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515305">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="8515317">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515323">runCgiTest</span><span class="op" id="8515333">(</span><span class="ident" id="8515334">t</span><span class="op" id="8515335">,</span>&nbsp;<span class="ident" id="8515337">h</span><span class="op" id="8515338">,</span>&nbsp;<span class="string" id="8515340">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="8515374">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515378">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="8515397">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515401">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="8515420">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515424">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="8515439">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515443">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="8515458">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515462">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="8515485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515489">expectedMap</span><span class="op" id="8515500">)</span><br>
<span class="lineno"></span><span class="op" id="8515502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="8515505">func</span>&nbsp;<span class="ident" id="8515510">TestPathInfoNoRoot</span><span class="op" id="8515528">(</span><span class="ident" id="8515529">t</span>&nbsp;<span class="op" id="8515531">*</span><span class="ident" id="8515532">testing</span><span class="op" id="8515539">.</span><span class="ident" id="8515540">T</span><span class="op" id="8515541">)</span>&nbsp;<span class="op" id="8515543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515546">check</span><span class="op" id="8515551">(</span><span class="ident" id="8515552">t</span><span class="op" id="8515553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515556">h</span>&nbsp;<span class="op" id="8515558">:=</span>&nbsp;<span class="op" id="8515561">&amp;</span><span class="ident" id="8515562">Handler</span><span class="op" id="8515569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515573">Path</span><span class="op" id="8515577">:</span>&nbsp;<span class="string" id="8515579">&#34;testdata/test.cgi&#34;</span><span class="op" id="8515598">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515602">Root</span><span class="op" id="8515606">:</span>&nbsp;<span class="string" id="8515608">&#34;&#34;</span><span class="op" id="8515610">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515616">expectedMap</span>&nbsp;<span class="op" id="8515628">:=</span>&nbsp;<span class="keyword" id="8515631">map</span><span class="op" id="8515634">[</span><span class="builtintype" id="8515635">string</span><span class="op" id="8515641">]</span><span class="builtintype" id="8515642">string</span><span class="op" id="8515648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515652">&#34;env-PATH_INFO&#34;</span><span class="op" id="8515667">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515675">&#34;/bar&#34;</span><span class="op" id="8515681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515685">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8515703">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515708">&#34;a=b&#34;</span><span class="op" id="8515713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515717">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8515734">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515740">&#34;/bar?a=b&#34;</span><span class="op" id="8515750">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515754">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8515775">:</span>&nbsp;<span class="string" id="8515777">&#34;testdata/test.cgi&#34;</span><span class="op" id="8515796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515800">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8515817">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8515823">&#34;/&#34;</span><span class="op" id="8515826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515832">runCgiTest</span><span class="op" id="8515842">(</span><span class="ident" id="8515843">t</span><span class="op" id="8515844">,</span>&nbsp;<span class="ident" id="8515846">h</span><span class="op" id="8515847">,</span>&nbsp;<span class="string" id="8515849">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8515895">,</span>&nbsp;<span class="ident" id="8515897">expectedMap</span><span class="op" id="8515908">)</span><br>
<span class="lineno"></span><span class="op" id="8515910">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8515913">func</span>&nbsp;<span class="ident" id="8515918">TestCGIBasicPost</span><span class="op" id="8515934">(</span><span class="ident" id="8515935">t</span>&nbsp;<span class="op" id="8515937">*</span><span class="ident" id="8515938">testing</span><span class="op" id="8515945">.</span><span class="ident" id="8515946">T</span><span class="op" id="8515947">)</span>&nbsp;<span class="op" id="8515949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515952">check</span><span class="op" id="8515957">(</span><span class="ident" id="8515958">t</span><span class="op" id="8515959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515962">postReq</span>&nbsp;<span class="op" id="8515970">:=</span>&nbsp;<span class="string" id="8515973">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516106">h</span>&nbsp;<span class="op" id="8516108">:=</span>&nbsp;<span class="op" id="8516111">&amp;</span><span class="ident" id="8516112">Handler</span><span class="op" id="8516119">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516123">Path</span><span class="op" id="8516127">:</span>&nbsp;<span class="string" id="8516129">&#34;testdata/test.cgi&#34;</span><span class="op" id="8516148">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516152">Root</span><span class="op" id="8516156">:</span>&nbsp;<span class="string" id="8516158">&#34;/test.cgi&#34;</span><span class="op" id="8516169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8516172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516175">expectedMap</span>&nbsp;<span class="op" id="8516187">:=</span>&nbsp;<span class="keyword" id="8516190">map</span><span class="op" id="8516193">[</span><span class="builtintype" id="8516194">string</span><span class="op" id="8516200">]</span><span class="builtintype" id="8516201">string</span><span class="op" id="8516207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516211">&#34;test&#34;</span><span class="op" id="8516217">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8516233">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="8516244">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516248">&#34;param-postfoo&#34;</span><span class="op" id="8516263">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8516270">&#34;postbar&#34;</span><span class="op" id="8516279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516283">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8516303">:</span>&nbsp;<span class="string" id="8516305">&#34;POST&#34;</span><span class="op" id="8516311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516315">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="8516335">:</span>&nbsp;<span class="string" id="8516337">&#34;15&#34;</span><span class="op" id="8516341">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516345">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8516362">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8516367">&#34;/test.cgi?a=b&#34;</span><span class="op" id="8516382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8516385">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516388">runCgiTest</span><span class="op" id="8516398">(</span><span class="ident" id="8516399">t</span><span class="op" id="8516400">,</span>&nbsp;<span class="ident" id="8516402">h</span><span class="op" id="8516403">,</span>&nbsp;<span class="ident" id="8516405">postReq</span><span class="op" id="8516412">,</span>&nbsp;<span class="ident" id="8516414">expectedMap</span><span class="op" id="8516425">)</span><br>
<span class="lineno"></span><span class="op" id="8516427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8516430">func</span>&nbsp;<span class="ident" id="8516435">chunk</span><span class="op" id="8516440">(</span><span class="ident" id="8516441">s</span>&nbsp;<span class="builtintype" id="8516443">string</span><span class="op" id="8516449">)</span>&nbsp;<span class="builtintype" id="8516451">string</span>&nbsp;<span class="op" id="8516458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516461">return</span>&nbsp;<span class="ident" id="8516468">fmt</span><span class="op" id="8516471">.</span><span class="ident" id="8516472">Sprintf</span><span class="op" id="8516479">(</span><span class="string" id="8516480">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="8516494">,</span>&nbsp;<span class="builtinfunc" id="8516496">len</span><span class="op" id="8516499">(</span><span class="ident" id="8516500">s</span><span class="op" id="8516501">)</span><span class="op" id="8516502">,</span>&nbsp;<span class="ident" id="8516504">s</span><span class="op" id="8516505">)</span><br>
<span class="lineno">240</span><span class="op" id="8516507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8516510">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="8516558">func</span>&nbsp;<span class="ident" id="8516563">TestCGIPostChunked</span><span class="op" id="8516581">(</span><span class="ident" id="8516582">t</span>&nbsp;<span class="op" id="8516584">*</span><span class="ident" id="8516585">testing</span><span class="op" id="8516592">.</span><span class="ident" id="8516593">T</span><span class="op" id="8516594">)</span>&nbsp;<span class="op" id="8516596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516599">check</span><span class="op" id="8516604">(</span><span class="ident" id="8516605">t</span><span class="op" id="8516606">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516609">postReq</span>&nbsp;<span class="op" id="8516617">:=</span>&nbsp;<span class="string" id="8516620">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="8516745">+</span>&nbsp;<span class="ident" id="8516747">chunk</span><span class="op" id="8516752">(</span><span class="string" id="8516753">&#34;postfoo&#34;</span><span class="op" id="8516762">)</span>&nbsp;<span class="op" id="8516764">+</span>&nbsp;<span class="ident" id="8516766">chunk</span><span class="op" id="8516771">(</span><span class="string" id="8516772">&#34;=&#34;</span><span class="op" id="8516775">)</span>&nbsp;<span class="op" id="8516777">+</span>&nbsp;<span class="ident" id="8516779">chunk</span><span class="op" id="8516784">(</span><span class="string" id="8516785">&#34;postbar&#34;</span><span class="op" id="8516794">)</span>&nbsp;<span class="op" id="8516796">+</span>&nbsp;<span class="ident" id="8516798">chunk</span><span class="op" id="8516803">(</span><span class="string" id="8516804">&#34;&#34;</span><span class="op" id="8516806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516810">h</span>&nbsp;<span class="op" id="8516812">:=</span>&nbsp;<span class="op" id="8516815">&amp;</span><span class="ident" id="8516816">Handler</span><span class="op" id="8516823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516827">Path</span><span class="op" id="8516831">:</span>&nbsp;<span class="string" id="8516833">&#34;testdata/test.cgi&#34;</span><span class="op" id="8516852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516856">Root</span><span class="op" id="8516860">:</span>&nbsp;<span class="string" id="8516862">&#34;/test.cgi&#34;</span><span class="op" id="8516873">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8516876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516879">expectedMap</span>&nbsp;<span class="op" id="8516891">:=</span>&nbsp;<span class="keyword" id="8516894">map</span><span class="op" id="8516897">[</span><span class="builtintype" id="8516898">string</span><span class="op" id="8516904">]</span><span class="builtintype" id="8516905">string</span><span class="op" id="8516911">{</span><span class="op" id="8516912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516915">resp</span>&nbsp;<span class="op" id="8516920">:=</span>&nbsp;<span class="ident" id="8516923">runCgiTest</span><span class="op" id="8516933">(</span><span class="ident" id="8516934">t</span><span class="op" id="8516935">,</span>&nbsp;<span class="ident" id="8516937">h</span><span class="op" id="8516938">,</span>&nbsp;<span class="ident" id="8516940">postReq</span><span class="op" id="8516947">,</span>&nbsp;<span class="ident" id="8516949">expectedMap</span><span class="op" id="8516960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516963">if</span>&nbsp;<span class="ident" id="8516966">got</span><span class="op" id="8516969">,</span>&nbsp;<span class="ident" id="8516971">expected</span>&nbsp;<span class="op" id="8516980">:=</span>&nbsp;<span class="ident" id="8516983">resp</span><span class="op" id="8516987">.</span><span class="ident" id="8516988">Code</span><span class="op" id="8516992">,</span>&nbsp;<span class="ident" id="8516994">http</span><span class="op" id="8516998">.</span><span class="ident" id="8516999">StatusBadRequest</span><span class="op" id="8517015">;</span>&nbsp;<span class="ident" id="8517017">got</span>&nbsp;<span class="op" id="8517021">!=</span>&nbsp;<span class="ident" id="8517024">expected</span>&nbsp;<span class="op" id="8517033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517037">t</span><span class="op" id="8517038">.</span><span class="ident" id="8517039">Fatalf</span><span class="op" id="8517045">(</span><span class="string" id="8517046">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8517107">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517112">expected</span><span class="op" id="8517120">,</span>&nbsp;<span class="ident" id="8517122">got</span><span class="op" id="8517125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517128">}</span><br>
<span class="lineno"></span><span class="op" id="8517130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8517133">func</span>&nbsp;<span class="ident" id="8517138">TestRedirect</span><span class="op" id="8517150">(</span><span class="ident" id="8517151">t</span>&nbsp;<span class="op" id="8517153">*</span><span class="ident" id="8517154">testing</span><span class="op" id="8517161">.</span><span class="ident" id="8517162">T</span><span class="op" id="8517163">)</span>&nbsp;<span class="op" id="8517165">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517168">check</span><span class="op" id="8517173">(</span><span class="ident" id="8517174">t</span><span class="op" id="8517175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517178">h</span>&nbsp;<span class="op" id="8517180">:=</span>&nbsp;<span class="op" id="8517183">&amp;</span><span class="ident" id="8517184">Handler</span><span class="op" id="8517191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517195">Path</span><span class="op" id="8517199">:</span>&nbsp;<span class="string" id="8517201">&#34;testdata/test.cgi&#34;</span><span class="op" id="8517220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517224">Root</span><span class="op" id="8517228">:</span>&nbsp;<span class="string" id="8517230">&#34;/test.cgi&#34;</span><span class="op" id="8517241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517244">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517247">rec</span>&nbsp;<span class="op" id="8517251">:=</span>&nbsp;<span class="ident" id="8517254">runCgiTest</span><span class="op" id="8517264">(</span><span class="ident" id="8517265">t</span><span class="op" id="8517266">,</span>&nbsp;<span class="ident" id="8517268">h</span><span class="op" id="8517269">,</span>&nbsp;<span class="string" id="8517271">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8517338">,</span>&nbsp;<span class="ident" id="8517340">nil</span><span class="op" id="8517343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517346">if</span>&nbsp;<span class="ident" id="8517349">e</span><span class="op" id="8517350">,</span>&nbsp;<span class="ident" id="8517352">g</span>&nbsp;<span class="op" id="8517354">:=</span>&nbsp;<span class="num" id="8517357">302</span><span class="op" id="8517360">,</span>&nbsp;<span class="ident" id="8517362">rec</span><span class="op" id="8517365">.</span><span class="ident" id="8517366">Code</span><span class="op" id="8517370">;</span>&nbsp;<span class="ident" id="8517372">e</span>&nbsp;<span class="op" id="8517374">!=</span>&nbsp;<span class="ident" id="8517377">g</span>&nbsp;<span class="op" id="8517379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517383">t</span><span class="op" id="8517384">.</span><span class="ident" id="8517385">Errorf</span><span class="op" id="8517391">(</span><span class="string" id="8517392">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8517425">,</span>&nbsp;<span class="ident" id="8517427">e</span><span class="op" id="8517428">,</span>&nbsp;<span class="ident" id="8517430">g</span><span class="op" id="8517431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517437">if</span>&nbsp;<span class="ident" id="8517440">e</span><span class="op" id="8517441">,</span>&nbsp;<span class="ident" id="8517443">g</span>&nbsp;<span class="op" id="8517445">:=</span>&nbsp;<span class="string" id="8517448">&#34;http://foo.com/&#34;</span><span class="op" id="8517465">,</span>&nbsp;<span class="ident" id="8517467">rec</span><span class="op" id="8517470">.</span><span class="ident" id="8517471">Header</span><span class="op" id="8517477">(</span><span class="op" id="8517478">)</span><span class="op" id="8517479">.</span><span class="ident" id="8517480">Get</span><span class="op" id="8517483">(</span><span class="string" id="8517484">&#34;Location&#34;</span><span class="op" id="8517494">)</span><span class="op" id="8517495">;</span>&nbsp;<span class="ident" id="8517497">e</span>&nbsp;<span class="op" id="8517499">!=</span>&nbsp;<span class="ident" id="8517502">g</span>&nbsp;<span class="op" id="8517504">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517508">t</span><span class="op" id="8517509">.</span><span class="ident" id="8517510">Errorf</span><span class="op" id="8517516">(</span><span class="string" id="8517517">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8517557">,</span>&nbsp;<span class="ident" id="8517559">e</span><span class="op" id="8517560">,</span>&nbsp;<span class="ident" id="8517562">g</span><span class="op" id="8517563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517566">}</span><br>
<span class="lineno"></span><span class="op" id="8517568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8517571">func</span>&nbsp;<span class="ident" id="8517576">TestInternalRedirect</span><span class="op" id="8517596">(</span><span class="ident" id="8517597">t</span>&nbsp;<span class="op" id="8517599">*</span><span class="ident" id="8517600">testing</span><span class="op" id="8517607">.</span><span class="ident" id="8517608">T</span><span class="op" id="8517609">)</span>&nbsp;<span class="op" id="8517611">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517614">check</span><span class="op" id="8517619">(</span><span class="ident" id="8517620">t</span><span class="op" id="8517621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517624">baseHandler</span>&nbsp;<span class="op" id="8517636">:=</span>&nbsp;<span class="ident" id="8517639">http</span><span class="op" id="8517643">.</span><span class="ident" id="8517644">HandlerFunc</span><span class="op" id="8517655">(</span><span class="keyword" id="8517656">func</span><span class="op" id="8517660">(</span><span class="ident" id="8517661">rw</span>&nbsp;<span class="ident" id="8517664">http</span><span class="op" id="8517668">.</span><span class="ident" id="8517669">ResponseWriter</span><span class="op" id="8517683">,</span>&nbsp;<span class="ident" id="8517685">req</span>&nbsp;<span class="op" id="8517689">*</span><span class="ident" id="8517690">http</span><span class="op" id="8517694">.</span><span class="ident" id="8517695">Request</span><span class="op" id="8517702">)</span>&nbsp;<span class="op" id="8517704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517708">fmt</span><span class="op" id="8517711">.</span><span class="ident" id="8517712">Fprintf</span><span class="op" id="8517719">(</span><span class="ident" id="8517720">rw</span><span class="op" id="8517722">,</span>&nbsp;<span class="string" id="8517724">&#34;basepath=%s\n&#34;</span><span class="op" id="8517739">,</span>&nbsp;<span class="ident" id="8517741">req</span><span class="op" id="8517744">.</span><span class="ident" id="8517745">URL</span><span class="op" id="8517748">.</span><span class="ident" id="8517749">Path</span><span class="op" id="8517753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517757">fmt</span><span class="op" id="8517760">.</span><span class="ident" id="8517761">Fprintf</span><span class="op" id="8517768">(</span><span class="ident" id="8517769">rw</span><span class="op" id="8517771">,</span>&nbsp;<span class="string" id="8517773">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="8517790">,</span>&nbsp;<span class="ident" id="8517792">req</span><span class="op" id="8517795">.</span><span class="ident" id="8517796">RemoteAddr</span><span class="op" id="8517806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517809">}</span><span class="op" id="8517810">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517813">h</span>&nbsp;<span class="op" id="8517815">:=</span>&nbsp;<span class="op" id="8517818">&amp;</span><span class="ident" id="8517819">Handler</span><span class="op" id="8517826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517830">Path</span><span class="op" id="8517834">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8517851">&#34;testdata/test.cgi&#34;</span><span class="op" id="8517870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517874">Root</span><span class="op" id="8517878">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8517895">&#34;/test.cgi&#34;</span><span class="op" id="8517906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517910">PathLocationHandler</span><span class="op" id="8517929">:</span>&nbsp;<span class="ident" id="8517931">baseHandler</span><span class="op" id="8517942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517945">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517948">expectedMap</span>&nbsp;<span class="op" id="8517960">:=</span>&nbsp;<span class="keyword" id="8517963">map</span><span class="op" id="8517966">[</span><span class="builtintype" id="8517967">string</span><span class="op" id="8517973">]</span><span class="builtintype" id="8517974">string</span><span class="op" id="8517980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8517984">&#34;basepath&#34;</span><span class="op" id="8517994">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8517998">&#34;/foo&#34;</span><span class="op" id="8518004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8518008">&#34;remoteaddr&#34;</span><span class="op" id="8518020">:</span>&nbsp;<span class="string" id="8518022">&#34;1.2.3.4&#34;</span><span class="op" id="8518031">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518037">runCgiTest</span><span class="op" id="8518047">(</span><span class="ident" id="8518048">t</span><span class="op" id="8518049">,</span>&nbsp;<span class="ident" id="8518051">h</span><span class="op" id="8518052">,</span>&nbsp;<span class="string" id="8518054">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8518110">,</span>&nbsp;<span class="ident" id="8518112">expectedMap</span><span class="op" id="8518123">)</span><br>
<span class="lineno">295</span><span class="op" id="8518125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8518128">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="8518204">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="8518267">func</span>&nbsp;<span class="ident" id="8518272">TestCopyError</span><span class="op" id="8518285">(</span><span class="ident" id="8518286">t</span>&nbsp;<span class="op" id="8518288">*</span><span class="ident" id="8518289">testing</span><span class="op" id="8518296">.</span><span class="ident" id="8518297">T</span><span class="op" id="8518298">)</span>&nbsp;<span class="op" id="8518300">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518303">check</span><span class="op" id="8518308">(</span><span class="ident" id="8518309">t</span><span class="op" id="8518310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518313">if</span>&nbsp;<span class="ident" id="8518316">runtime</span><span class="op" id="8518323">.</span><span class="ident" id="8518324">GOOS</span>&nbsp;<span class="op" id="8518329">==</span>&nbsp;<span class="string" id="8518332">&#34;windows&#34;</span>&nbsp;<span class="op" id="8518342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518346">t</span><span class="op" id="8518347">.</span><span class="ident" id="8518348">Skipf</span><span class="op" id="8518353">(</span><span class="string" id="8518354">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8518375">,</span>&nbsp;<span class="ident" id="8518377">runtime</span><span class="op" id="8518384">.</span><span class="ident" id="8518385">GOOS</span><span class="op" id="8518389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518395">h</span>&nbsp;<span class="op" id="8518397">:=</span>&nbsp;<span class="op" id="8518400">&amp;</span><span class="ident" id="8518401">Handler</span><span class="op" id="8518408">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518412">Path</span><span class="op" id="8518416">:</span>&nbsp;<span class="string" id="8518418">&#34;testdata/test.cgi&#34;</span><span class="op" id="8518437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518441">Root</span><span class="op" id="8518445">:</span>&nbsp;<span class="string" id="8518447">&#34;/test.cgi&#34;</span><span class="op" id="8518458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518464">ts</span>&nbsp;<span class="op" id="8518467">:=</span>&nbsp;<span class="ident" id="8518470">httptest</span><span class="op" id="8518478">.</span><span class="ident" id="8518479">NewServer</span><span class="op" id="8518488">(</span><span class="ident" id="8518489">h</span><span class="op" id="8518490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518493">defer</span>&nbsp;<span class="ident" id="8518499">ts</span><span class="op" id="8518501">.</span><span class="ident" id="8518502">Close</span><span class="op" id="8518507">(</span><span class="op" id="8518508">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518512">conn</span><span class="op" id="8518516">,</span>&nbsp;<span class="ident" id="8518518">err</span>&nbsp;<span class="op" id="8518522">:=</span>&nbsp;<span class="ident" id="8518525">net</span><span class="op" id="8518528">.</span><span class="ident" id="8518529">Dial</span><span class="op" id="8518533">(</span><span class="string" id="8518534">&#34;tcp&#34;</span><span class="op" id="8518539">,</span>&nbsp;<span class="ident" id="8518541">ts</span><span class="op" id="8518543">.</span><span class="ident" id="8518544">Listener</span><span class="op" id="8518552">.</span><span class="ident" id="8518553">Addr</span><span class="op" id="8518557">(</span><span class="op" id="8518558">)</span><span class="op" id="8518559">.</span><span class="ident" id="8518560">String</span><span class="op" id="8518566">(</span><span class="op" id="8518567">)</span><span class="op" id="8518568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518571">if</span>&nbsp;<span class="ident" id="8518574">err</span>&nbsp;<span class="op" id="8518578">!=</span>&nbsp;<span class="ident" id="8518581">nil</span>&nbsp;<span class="op" id="8518585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518589">t</span><span class="op" id="8518590">.</span><span class="ident" id="8518591">Fatal</span><span class="op" id="8518596">(</span><span class="ident" id="8518597">err</span><span class="op" id="8518600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518603">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518606">req</span><span class="op" id="8518609">,</span>&nbsp;<span class="ident" id="8518611">_</span>&nbsp;<span class="op" id="8518613">:=</span>&nbsp;<span class="ident" id="8518616">http</span><span class="op" id="8518620">.</span><span class="ident" id="8518621">NewRequest</span><span class="op" id="8518631">(</span><span class="string" id="8518632">&#34;GET&#34;</span><span class="op" id="8518637">,</span>&nbsp;<span class="string" id="8518639">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="8518682">,</span>&nbsp;<span class="ident" id="8518684">nil</span><span class="op" id="8518687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518690">err</span>&nbsp;<span class="op" id="8518694">=</span>&nbsp;<span class="ident" id="8518696">req</span><span class="op" id="8518699">.</span><span class="ident" id="8518700">Write</span><span class="op" id="8518705">(</span><span class="ident" id="8518706">conn</span><span class="op" id="8518710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518713">if</span>&nbsp;<span class="ident" id="8518716">err</span>&nbsp;<span class="op" id="8518720">!=</span>&nbsp;<span class="ident" id="8518723">nil</span>&nbsp;<span class="op" id="8518727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518731">t</span><span class="op" id="8518732">.</span><span class="ident" id="8518733">Fatalf</span><span class="op" id="8518739">(</span><span class="string" id="8518740">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="8518751">,</span>&nbsp;<span class="ident" id="8518753">err</span><span class="op" id="8518756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518759">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518763">res</span><span class="op" id="8518766">,</span>&nbsp;<span class="ident" id="8518768">err</span>&nbsp;<span class="op" id="8518772">:=</span>&nbsp;<span class="ident" id="8518775">http</span><span class="op" id="8518779">.</span><span class="ident" id="8518780">ReadResponse</span><span class="op" id="8518792">(</span><span class="ident" id="8518793">bufio</span><span class="op" id="8518798">.</span><span class="ident" id="8518799">NewReader</span><span class="op" id="8518808">(</span><span class="ident" id="8518809">conn</span><span class="op" id="8518813">)</span><span class="op" id="8518814">,</span>&nbsp;<span class="ident" id="8518816">req</span><span class="op" id="8518819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518822">if</span>&nbsp;<span class="ident" id="8518825">err</span>&nbsp;<span class="op" id="8518829">!=</span>&nbsp;<span class="ident" id="8518832">nil</span>&nbsp;<span class="op" id="8518836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518840">t</span><span class="op" id="8518841">.</span><span class="ident" id="8518842">Fatalf</span><span class="op" id="8518848">(</span><span class="string" id="8518849">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="8518867">,</span>&nbsp;<span class="ident" id="8518869">err</span><span class="op" id="8518872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518875">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518879">pidstr</span>&nbsp;<span class="op" id="8518886">:=</span>&nbsp;<span class="ident" id="8518889">res</span><span class="op" id="8518892">.</span><span class="ident" id="8518893">Header</span><span class="op" id="8518899">.</span><span class="ident" id="8518900">Get</span><span class="op" id="8518903">(</span><span class="string" id="8518904">&#34;X-CGI-Pid&#34;</span><span class="op" id="8518915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518918">if</span>&nbsp;<span class="ident" id="8518921">pidstr</span>&nbsp;<span class="op" id="8518928">==</span>&nbsp;<span class="string" id="8518931">&#34;&#34;</span>&nbsp;<span class="op" id="8518934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518938">t</span><span class="op" id="8518939">.</span><span class="ident" id="8518940">Fatalf</span><span class="op" id="8518946">(</span><span class="string" id="8518947">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="8518989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518992">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518995">pid</span><span class="op" id="8518998">,</span>&nbsp;<span class="ident" id="8519000">err</span>&nbsp;<span class="op" id="8519004">:=</span>&nbsp;<span class="ident" id="8519007">strconv</span><span class="op" id="8519014">.</span><span class="ident" id="8519015">Atoi</span><span class="op" id="8519019">(</span><span class="ident" id="8519020">pidstr</span><span class="op" id="8519026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519029">if</span>&nbsp;<span class="ident" id="8519032">err</span>&nbsp;<span class="op" id="8519036">!=</span>&nbsp;<span class="ident" id="8519039">nil</span>&nbsp;<span class="op" id="8519043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519047">t</span><span class="op" id="8519048">.</span><span class="ident" id="8519049">Fatalf</span><span class="op" id="8519055">(</span><span class="string" id="8519056">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="8519081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519088">var</span>&nbsp;<span class="ident" id="8519092">buf</span>&nbsp;<span class="op" id="8519096">[</span><span class="num" id="8519097">5000</span><span class="op" id="8519101">]</span><span class="builtintype" id="8519102">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519108">n</span><span class="op" id="8519109">,</span>&nbsp;<span class="ident" id="8519111">err</span>&nbsp;<span class="op" id="8519115">:=</span>&nbsp;<span class="ident" id="8519118">io</span><span class="op" id="8519120">.</span><span class="ident" id="8519121">ReadFull</span><span class="op" id="8519129">(</span><span class="ident" id="8519130">res</span><span class="op" id="8519133">.</span><span class="ident" id="8519134">Body</span><span class="op" id="8519138">,</span>&nbsp;<span class="ident" id="8519140">buf</span><span class="op" id="8519143">[</span><span class="op" id="8519144">:</span><span class="op" id="8519145">]</span><span class="op" id="8519146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519149">if</span>&nbsp;<span class="ident" id="8519152">err</span>&nbsp;<span class="op" id="8519156">!=</span>&nbsp;<span class="ident" id="8519159">nil</span>&nbsp;<span class="op" id="8519163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519167">t</span><span class="op" id="8519168">.</span><span class="ident" id="8519169">Fatalf</span><span class="op" id="8519175">(</span><span class="string" id="8519176">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="8519200">,</span>&nbsp;<span class="ident" id="8519202">n</span><span class="op" id="8519203">,</span>&nbsp;<span class="ident" id="8519205">err</span><span class="op" id="8519208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519211">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519215">childRunning</span>&nbsp;<span class="op" id="8519228">:=</span>&nbsp;<span class="keyword" id="8519231">func</span><span class="op" id="8519235">(</span><span class="op" id="8519236">)</span>&nbsp;<span class="builtintype" id="8519238">bool</span>&nbsp;<span class="op" id="8519243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519247">return</span>&nbsp;<span class="ident" id="8519254">isProcessRunning</span><span class="op" id="8519270">(</span><span class="ident" id="8519271">t</span><span class="op" id="8519272">,</span>&nbsp;<span class="ident" id="8519274">pid</span><span class="op" id="8519277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519284">if</span>&nbsp;<span class="op" id="8519287">!</span><span class="ident" id="8519288">childRunning</span><span class="op" id="8519300">(</span><span class="op" id="8519301">)</span>&nbsp;<span class="op" id="8519303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519307">t</span><span class="op" id="8519308">.</span><span class="ident" id="8519309">Fatalf</span><span class="op" id="8519315">(</span><span class="string" id="8519316">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="8519362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519368">conn</span><span class="op" id="8519372">.</span><span class="ident" id="8519373">Close</span><span class="op" id="8519378">(</span><span class="op" id="8519379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519383">tries</span>&nbsp;<span class="op" id="8519389">:=</span>&nbsp;<span class="num" id="8519392">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519395">for</span>&nbsp;<span class="ident" id="8519399">tries</span>&nbsp;<span class="op" id="8519405">&lt;</span>&nbsp;<span class="num" id="8519407">25</span>&nbsp;<span class="op" id="8519410">&amp;&amp;</span>&nbsp;<span class="ident" id="8519413">childRunning</span><span class="op" id="8519425">(</span><span class="op" id="8519426">)</span>&nbsp;<span class="op" id="8519428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519432">time</span><span class="op" id="8519436">.</span><span class="ident" id="8519437">Sleep</span><span class="op" id="8519442">(</span><span class="num" id="8519443">50</span>&nbsp;<span class="op" id="8519446">*</span>&nbsp;<span class="ident" id="8519448">time</span><span class="op" id="8519452">.</span><span class="ident" id="8519453">Millisecond</span>&nbsp;<span class="op" id="8519465">*</span>&nbsp;<span class="ident" id="8519467">time</span><span class="op" id="8519471">.</span><span class="ident" id="8519472">Duration</span><span class="op" id="8519480">(</span><span class="ident" id="8519481">tries</span><span class="op" id="8519486">)</span><span class="op" id="8519487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519491">tries</span><span class="op" id="8519496">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519500">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519503">if</span>&nbsp;<span class="ident" id="8519506">childRunning</span><span class="op" id="8519518">(</span><span class="op" id="8519519">)</span>&nbsp;<span class="op" id="8519521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519525">t</span><span class="op" id="8519526">.</span><span class="ident" id="8519527">Fatalf</span><span class="op" id="8519533">(</span><span class="string" id="8519534">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="8519578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519581">}</span><br>
<span class="lineno"></span><span class="op" id="8519583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="8519586">func</span>&nbsp;<span class="ident" id="8519591">TestDirUnix</span><span class="op" id="8519602">(</span><span class="ident" id="8519603">t</span>&nbsp;<span class="op" id="8519605">*</span><span class="ident" id="8519606">testing</span><span class="op" id="8519613">.</span><span class="ident" id="8519614">T</span><span class="op" id="8519615">)</span>&nbsp;<span class="op" id="8519617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519620">check</span><span class="op" id="8519625">(</span><span class="ident" id="8519626">t</span><span class="op" id="8519627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519630">if</span>&nbsp;<span class="ident" id="8519633">runtime</span><span class="op" id="8519640">.</span><span class="ident" id="8519641">GOOS</span>&nbsp;<span class="op" id="8519646">==</span>&nbsp;<span class="string" id="8519649">&#34;windows&#34;</span>&nbsp;<span class="op" id="8519659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519663">t</span><span class="op" id="8519664">.</span><span class="ident" id="8519665">Skipf</span><span class="op" id="8519670">(</span><span class="string" id="8519671">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8519692">,</span>&nbsp;<span class="ident" id="8519694">runtime</span><span class="op" id="8519701">.</span><span class="ident" id="8519702">GOOS</span><span class="op" id="8519706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519709">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519712">cwd</span><span class="op" id="8519715">,</span>&nbsp;<span class="ident" id="8519717">_</span>&nbsp;<span class="op" id="8519719">:=</span>&nbsp;<span class="ident" id="8519722">os</span><span class="op" id="8519724">.</span><span class="ident" id="8519725">Getwd</span><span class="op" id="8519730">(</span><span class="op" id="8519731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519734">h</span>&nbsp;<span class="op" id="8519736">:=</span>&nbsp;<span class="op" id="8519739">&amp;</span><span class="ident" id="8519740">Handler</span><span class="op" id="8519747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519751">Path</span><span class="op" id="8519755">:</span>&nbsp;<span class="string" id="8519757">&#34;testdata/test.cgi&#34;</span><span class="op" id="8519776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519780">Root</span><span class="op" id="8519784">:</span>&nbsp;<span class="string" id="8519786">&#34;/test.cgi&#34;</span><span class="op" id="8519797">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519801">Dir</span><span class="op" id="8519804">:</span>&nbsp;&nbsp;<span class="ident" id="8519807">cwd</span><span class="op" id="8519810">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519816">expectedMap</span>&nbsp;<span class="op" id="8519828">:=</span>&nbsp;<span class="keyword" id="8519831">map</span><span class="op" id="8519834">[</span><span class="builtintype" id="8519835">string</span><span class="op" id="8519841">]</span><span class="builtintype" id="8519842">string</span><span class="op" id="8519848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8519852">&#34;cwd&#34;</span><span class="op" id="8519857">:</span>&nbsp;<span class="ident" id="8519859">cwd</span><span class="op" id="8519862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519868">runCgiTest</span><span class="op" id="8519878">(</span><span class="ident" id="8519879">t</span><span class="op" id="8519880">,</span>&nbsp;<span class="ident" id="8519882">h</span><span class="op" id="8519883">,</span>&nbsp;<span class="string" id="8519885">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8519932">,</span>&nbsp;<span class="ident" id="8519934">expectedMap</span><span class="op" id="8519945">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519949">cwd</span><span class="op" id="8519952">,</span>&nbsp;<span class="ident" id="8519954">_</span>&nbsp;<span class="op" id="8519956">=</span>&nbsp;<span class="ident" id="8519958">os</span><span class="op" id="8519960">.</span><span class="ident" id="8519961">Getwd</span><span class="op" id="8519966">(</span><span class="op" id="8519967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519970">cwd</span>&nbsp;<span class="op" id="8519974">=</span>&nbsp;<span class="ident" id="8519976">filepath</span><span class="op" id="8519984">.</span><span class="ident" id="8519985">Join</span><span class="op" id="8519989">(</span><span class="ident" id="8519990">cwd</span><span class="op" id="8519993">,</span>&nbsp;<span class="string" id="8519995">&#34;testdata&#34;</span><span class="op" id="8520005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520008">h</span>&nbsp;<span class="op" id="8520010">=</span>&nbsp;<span class="op" id="8520012">&amp;</span><span class="ident" id="8520013">Handler</span><span class="op" id="8520020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520024">Path</span><span class="op" id="8520028">:</span>&nbsp;<span class="string" id="8520030">&#34;testdata/test.cgi&#34;</span><span class="op" id="8520049">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520053">Root</span><span class="op" id="8520057">:</span>&nbsp;<span class="string" id="8520059">&#34;/test.cgi&#34;</span><span class="op" id="8520070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520076">expectedMap</span>&nbsp;<span class="op" id="8520088">=</span>&nbsp;<span class="keyword" id="8520090">map</span><span class="op" id="8520093">[</span><span class="builtintype" id="8520094">string</span><span class="op" id="8520100">]</span><span class="builtintype" id="8520101">string</span><span class="op" id="8520107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8520111">&#34;cwd&#34;</span><span class="op" id="8520116">:</span>&nbsp;<span class="ident" id="8520118">cwd</span><span class="op" id="8520121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520124">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520127">runCgiTest</span><span class="op" id="8520137">(</span><span class="ident" id="8520138">t</span><span class="op" id="8520139">,</span>&nbsp;<span class="ident" id="8520141">h</span><span class="op" id="8520142">,</span>&nbsp;<span class="string" id="8520144">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8520191">,</span>&nbsp;<span class="ident" id="8520193">expectedMap</span><span class="op" id="8520204">)</span><br>
<span class="lineno"></span><span class="op" id="8520206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8520209">func</span>&nbsp;<span class="ident" id="8520214">TestDirWindows</span><span class="op" id="8520228">(</span><span class="ident" id="8520229">t</span>&nbsp;<span class="op" id="8520231">*</span><span class="ident" id="8520232">testing</span><span class="op" id="8520239">.</span><span class="ident" id="8520240">T</span><span class="op" id="8520241">)</span>&nbsp;<span class="op" id="8520243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520246">if</span>&nbsp;<span class="ident" id="8520249">runtime</span><span class="op" id="8520256">.</span><span class="ident" id="8520257">GOOS</span>&nbsp;<span class="op" id="8520262">!=</span>&nbsp;<span class="string" id="8520265">&#34;windows&#34;</span>&nbsp;<span class="op" id="8520275">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520279">t</span><span class="op" id="8520280">.</span><span class="ident" id="8520281">Skip</span><span class="op" id="8520285">(</span><span class="string" id="8520286">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="8520319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520326">cgifile</span><span class="op" id="8520333">,</span>&nbsp;<span class="ident" id="8520335">_</span>&nbsp;<span class="op" id="8520337">:=</span>&nbsp;<span class="ident" id="8520340">filepath</span><span class="op" id="8520348">.</span><span class="ident" id="8520349">Abs</span><span class="op" id="8520352">(</span><span class="string" id="8520353">&#34;testdata/test.cgi&#34;</span><span class="op" id="8520372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520376">var</span>&nbsp;<span class="ident" id="8520380">perl</span>&nbsp;<span class="builtintype" id="8520385">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520393">var</span>&nbsp;<span class="ident" id="8520397">err</span>&nbsp;<span class="builtintype" id="8520401">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520408">perl</span><span class="op" id="8520412">,</span>&nbsp;<span class="ident" id="8520414">err</span>&nbsp;<span class="op" id="8520418">=</span>&nbsp;<span class="ident" id="8520420">exec</span><span class="op" id="8520424">.</span><span class="ident" id="8520425">LookPath</span><span class="op" id="8520433">(</span><span class="string" id="8520434">&#34;perl&#34;</span><span class="op" id="8520440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520443">if</span>&nbsp;<span class="ident" id="8520446">err</span>&nbsp;<span class="op" id="8520450">!=</span>&nbsp;<span class="ident" id="8520453">nil</span>&nbsp;<span class="op" id="8520457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520461">t</span><span class="op" id="8520462">.</span><span class="ident" id="8520463">Skip</span><span class="op" id="8520467">(</span><span class="string" id="8520468">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8520500">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520506">perl</span><span class="op" id="8520510">,</span>&nbsp;<span class="ident" id="8520512">_</span>&nbsp;<span class="op" id="8520514">=</span>&nbsp;<span class="ident" id="8520516">filepath</span><span class="op" id="8520524">.</span><span class="ident" id="8520525">Abs</span><span class="op" id="8520528">(</span><span class="ident" id="8520529">perl</span><span class="op" id="8520533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520537">cwd</span><span class="op" id="8520540">,</span>&nbsp;<span class="ident" id="8520542">_</span>&nbsp;<span class="op" id="8520544">:=</span>&nbsp;<span class="ident" id="8520547">os</span><span class="op" id="8520549">.</span><span class="ident" id="8520550">Getwd</span><span class="op" id="8520555">(</span><span class="op" id="8520556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520559">h</span>&nbsp;<span class="op" id="8520561">:=</span>&nbsp;<span class="op" id="8520564">&amp;</span><span class="ident" id="8520565">Handler</span><span class="op" id="8520572">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520576">Path</span><span class="op" id="8520580">:</span>&nbsp;<span class="ident" id="8520582">perl</span><span class="op" id="8520586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520590">Root</span><span class="op" id="8520594">:</span>&nbsp;<span class="string" id="8520596">&#34;/test.cgi&#34;</span><span class="op" id="8520607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520611">Dir</span><span class="op" id="8520614">:</span>&nbsp;&nbsp;<span class="ident" id="8520617">cwd</span><span class="op" id="8520620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520624">Args</span><span class="op" id="8520628">:</span>&nbsp;<span class="op" id="8520630">[</span><span class="op" id="8520631">]</span><span class="builtintype" id="8520632">string</span><span class="op" id="8520638">{</span><span class="ident" id="8520639">cgifile</span><span class="op" id="8520646">}</span><span class="op" id="8520647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520651">Env</span><span class="op" id="8520654">:</span>&nbsp;&nbsp;<span class="op" id="8520657">[</span><span class="op" id="8520658">]</span><span class="builtintype" id="8520659">string</span><span class="op" id="8520665">{</span><span class="string" id="8520666">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8520685">+</span>&nbsp;<span class="ident" id="8520687">cgifile</span><span class="op" id="8520694">}</span><span class="op" id="8520695">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520701">expectedMap</span>&nbsp;<span class="op" id="8520713">:=</span>&nbsp;<span class="keyword" id="8520716">map</span><span class="op" id="8520719">[</span><span class="builtintype" id="8520720">string</span><span class="op" id="8520726">]</span><span class="builtintype" id="8520727">string</span><span class="op" id="8520733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8520737">&#34;cwd&#34;</span><span class="op" id="8520742">:</span>&nbsp;<span class="ident" id="8520744">cwd</span><span class="op" id="8520747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520753">runCgiTest</span><span class="op" id="8520763">(</span><span class="ident" id="8520764">t</span><span class="op" id="8520765">,</span>&nbsp;<span class="ident" id="8520767">h</span><span class="op" id="8520768">,</span>&nbsp;<span class="string" id="8520770">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8520817">,</span>&nbsp;<span class="ident" id="8520819">expectedMap</span><span class="op" id="8520830">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520834">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8520897">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520925">cwd</span><span class="op" id="8520928">,</span>&nbsp;<span class="ident" id="8520930">_</span>&nbsp;<span class="op" id="8520932">=</span>&nbsp;<span class="ident" id="8520934">filepath</span><span class="op" id="8520942">.</span><span class="ident" id="8520943">Split</span><span class="op" id="8520948">(</span><span class="ident" id="8520949">perl</span><span class="op" id="8520953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520956">if</span>&nbsp;<span class="ident" id="8520959">cwd</span>&nbsp;<span class="op" id="8520963">!=</span>&nbsp;<span class="string" id="8520966">&#34;&#34;</span>&nbsp;<span class="op" id="8520969">&amp;&amp;</span>&nbsp;<span class="ident" id="8520972">cwd</span><span class="op" id="8520975">[</span><span class="builtinfunc" id="8520976">len</span><span class="op" id="8520979">(</span><span class="ident" id="8520980">cwd</span><span class="op" id="8520983">)</span><span class="op" id="8520984">-</span><span class="num" id="8520985">1</span><span class="op" id="8520986">]</span>&nbsp;<span class="op" id="8520988">==</span>&nbsp;<span class="ident" id="8520991">filepath</span><span class="op" id="8520999">.</span><span class="ident" id="8521000">Separator</span>&nbsp;<span class="op" id="8521010">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521014">cwd</span>&nbsp;<span class="op" id="8521018">=</span>&nbsp;<span class="ident" id="8521020">cwd</span><span class="op" id="8521023">[</span><span class="op" id="8521024">:</span><span class="builtinfunc" id="8521025">len</span><span class="op" id="8521028">(</span><span class="ident" id="8521029">cwd</span><span class="op" id="8521032">)</span><span class="op" id="8521033">-</span><span class="num" id="8521034">1</span><span class="op" id="8521035">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521041">h</span>&nbsp;<span class="op" id="8521043">=</span>&nbsp;<span class="op" id="8521045">&amp;</span><span class="ident" id="8521046">Handler</span><span class="op" id="8521053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521057">Path</span><span class="op" id="8521061">:</span>&nbsp;<span class="ident" id="8521063">perl</span><span class="op" id="8521067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521071">Root</span><span class="op" id="8521075">:</span>&nbsp;<span class="string" id="8521077">&#34;/test.cgi&#34;</span><span class="op" id="8521088">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521092">Args</span><span class="op" id="8521096">:</span>&nbsp;<span class="op" id="8521098">[</span><span class="op" id="8521099">]</span><span class="builtintype" id="8521100">string</span><span class="op" id="8521106">{</span><span class="ident" id="8521107">cgifile</span><span class="op" id="8521114">}</span><span class="op" id="8521115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521119">Env</span><span class="op" id="8521122">:</span>&nbsp;&nbsp;<span class="op" id="8521125">[</span><span class="op" id="8521126">]</span><span class="builtintype" id="8521127">string</span><span class="op" id="8521133">{</span><span class="string" id="8521134">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8521153">+</span>&nbsp;<span class="ident" id="8521155">cgifile</span><span class="op" id="8521162">}</span><span class="op" id="8521163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521169">expectedMap</span>&nbsp;<span class="op" id="8521181">=</span>&nbsp;<span class="keyword" id="8521183">map</span><span class="op" id="8521186">[</span><span class="builtintype" id="8521187">string</span><span class="op" id="8521193">]</span><span class="builtintype" id="8521194">string</span><span class="op" id="8521200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521204">&#34;cwd&#34;</span><span class="op" id="8521209">:</span>&nbsp;<span class="ident" id="8521211">cwd</span><span class="op" id="8521214">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521220">runCgiTest</span><span class="op" id="8521230">(</span><span class="ident" id="8521231">t</span><span class="op" id="8521232">,</span>&nbsp;<span class="ident" id="8521234">h</span><span class="op" id="8521235">,</span>&nbsp;<span class="string" id="8521237">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8521284">,</span>&nbsp;<span class="ident" id="8521286">expectedMap</span><span class="op" id="8521297">)</span><br>
<span class="lineno"></span><span class="op" id="8521299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8521302">func</span>&nbsp;<span class="ident" id="8521307">TestEnvOverride</span><span class="op" id="8521322">(</span><span class="ident" id="8521323">t</span>&nbsp;<span class="op" id="8521325">*</span><span class="ident" id="8521326">testing</span><span class="op" id="8521333">.</span><span class="ident" id="8521334">T</span><span class="op" id="8521335">)</span>&nbsp;<span class="op" id="8521337">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521340">cgifile</span><span class="op" id="8521347">,</span>&nbsp;<span class="ident" id="8521349">_</span>&nbsp;<span class="op" id="8521351">:=</span>&nbsp;<span class="ident" id="8521354">filepath</span><span class="op" id="8521362">.</span><span class="ident" id="8521363">Abs</span><span class="op" id="8521366">(</span><span class="string" id="8521367">&#34;testdata/test.cgi&#34;</span><span class="op" id="8521386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521390">var</span>&nbsp;<span class="ident" id="8521394">perl</span>&nbsp;<span class="builtintype" id="8521399">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521407">var</span>&nbsp;<span class="ident" id="8521411">err</span>&nbsp;<span class="builtintype" id="8521415">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521422">perl</span><span class="op" id="8521426">,</span>&nbsp;<span class="ident" id="8521428">err</span>&nbsp;<span class="op" id="8521432">=</span>&nbsp;<span class="ident" id="8521434">exec</span><span class="op" id="8521438">.</span><span class="ident" id="8521439">LookPath</span><span class="op" id="8521447">(</span><span class="string" id="8521448">&#34;perl&#34;</span><span class="op" id="8521454">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521457">if</span>&nbsp;<span class="ident" id="8521460">err</span>&nbsp;<span class="op" id="8521464">!=</span>&nbsp;<span class="ident" id="8521467">nil</span>&nbsp;<span class="op" id="8521471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521475">t</span><span class="op" id="8521476">.</span><span class="ident" id="8521477">Skipf</span><span class="op" id="8521482">(</span><span class="string" id="8521483">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="8521515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521521">perl</span><span class="op" id="8521525">,</span>&nbsp;<span class="ident" id="8521527">_</span>&nbsp;<span class="op" id="8521529">=</span>&nbsp;<span class="ident" id="8521531">filepath</span><span class="op" id="8521539">.</span><span class="ident" id="8521540">Abs</span><span class="op" id="8521543">(</span><span class="ident" id="8521544">perl</span><span class="op" id="8521548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521552">cwd</span><span class="op" id="8521555">,</span>&nbsp;<span class="ident" id="8521557">_</span>&nbsp;<span class="op" id="8521559">:=</span>&nbsp;<span class="ident" id="8521562">os</span><span class="op" id="8521564">.</span><span class="ident" id="8521565">Getwd</span><span class="op" id="8521570">(</span><span class="op" id="8521571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521574">h</span>&nbsp;<span class="op" id="8521576">:=</span>&nbsp;<span class="op" id="8521579">&amp;</span><span class="ident" id="8521580">Handler</span><span class="op" id="8521587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521591">Path</span><span class="op" id="8521595">:</span>&nbsp;<span class="ident" id="8521597">perl</span><span class="op" id="8521601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521605">Root</span><span class="op" id="8521609">:</span>&nbsp;<span class="string" id="8521611">&#34;/test.cgi&#34;</span><span class="op" id="8521622">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521626">Dir</span><span class="op" id="8521629">:</span>&nbsp;&nbsp;<span class="ident" id="8521632">cwd</span><span class="op" id="8521635">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521639">Args</span><span class="op" id="8521643">:</span>&nbsp;<span class="op" id="8521645">[</span><span class="op" id="8521646">]</span><span class="builtintype" id="8521647">string</span><span class="op" id="8521653">{</span><span class="ident" id="8521654">cgifile</span><span class="op" id="8521661">}</span><span class="op" id="8521662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521666">Env</span><span class="op" id="8521669">:</span>&nbsp;<span class="op" id="8521671">[</span><span class="op" id="8521672">]</span><span class="builtintype" id="8521673">string</span><span class="op" id="8521679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521684">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="8521703">+</span>&nbsp;<span class="ident" id="8521705">cgifile</span><span class="op" id="8521712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521717">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="8521739">}</span><span class="op" id="8521740">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521743">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521746">expectedMap</span>&nbsp;<span class="op" id="8521758">:=</span>&nbsp;<span class="keyword" id="8521761">map</span><span class="op" id="8521764">[</span><span class="builtintype" id="8521765">string</span><span class="op" id="8521771">]</span><span class="builtintype" id="8521772">string</span><span class="op" id="8521778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521782">&#34;cwd&#34;</span><span class="op" id="8521787">:</span>&nbsp;<span class="ident" id="8521789">cwd</span><span class="op" id="8521792">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521796">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8521817">:</span>&nbsp;<span class="ident" id="8521819">cgifile</span><span class="op" id="8521826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8521830">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8521847">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8521853">&#34;/foo/bar&#34;</span><span class="op" id="8521863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521866">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521869">runCgiTest</span><span class="op" id="8521879">(</span><span class="ident" id="8521880">t</span><span class="op" id="8521881">,</span>&nbsp;<span class="ident" id="8521883">h</span><span class="op" id="8521884">,</span>&nbsp;<span class="string" id="8521886">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8521933">,</span>&nbsp;<span class="ident" id="8521935">expectedMap</span><span class="op" id="8521946">)</span><br>
<span class="lineno"></span><span class="op" id="8521948">}</span>
</div>
</body>
</html>
