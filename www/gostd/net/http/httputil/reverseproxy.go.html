<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6040681">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6040736">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6040790">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6040841">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6040872">package</span>&nbsp;<span class="ident" id="6040880">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6040890">import</span>&nbsp;<span class="op" id="6040897">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040900">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040906">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040913">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040920">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040932">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040943">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040954">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040962">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6040969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6040972">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6041045">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6041071">var</span>&nbsp;<span class="ident" id="6041075">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6041091">func</span><span class="op" id="6041095">(</span><span class="op" id="6041096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6041099">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6041169">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6041234">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6041245">type</span>&nbsp;<span class="ident" id="6041250">ReverseProxy</span>&nbsp;<span class="keyword" id="6041263">struct</span>&nbsp;<span class="op" id="6041270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041273">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041320">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041366">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041415">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041459">Director</span>&nbsp;<span class="keyword" id="6041468">func</span><span class="op" id="6041472">(</span><span class="op" id="6041473">*</span><span class="ident" id="6041474">http</span><span class="op" id="6041478">.</span><span class="ident" id="6041479">Request</span><span class="op" id="6041486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041490">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041540">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041583">Transport</span>&nbsp;<span class="ident" id="6041593">http</span><span class="op" id="6041597">.</span><span class="ident" id="6041598">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041613">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041660">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041705">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041724">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041767">FlushInterval</span>&nbsp;<span class="ident" id="6041781">time</span><span class="op" id="6041785">.</span><span class="ident" id="6041786">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041797">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041850">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041903">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6041963">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041984">ErrorLog</span>&nbsp;<span class="op" id="6041993">*</span><span class="ident" id="6041994">log</span><span class="op" id="6041997">.</span><span class="ident" id="6041998">Logger</span><br>
<span class="lineno"></span><span class="op" id="6042005">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6042008">func</span>&nbsp;<span class="ident" id="6042013">singleJoiningSlash</span><span class="op" id="6042031">(</span><span class="ident" id="6042032">a</span><span class="op" id="6042033">,</span>&nbsp;<span class="ident" id="6042035">b</span>&nbsp;<span class="builtintype" id="6042037">string</span><span class="op" id="6042043">)</span>&nbsp;<span class="builtintype" id="6042045">string</span>&nbsp;<span class="op" id="6042052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042055">aslash</span>&nbsp;<span class="op" id="6042062">:=</span>&nbsp;<span class="ident" id="6042065">strings</span><span class="op" id="6042072">.</span><span class="ident" id="6042073">HasSuffix</span><span class="op" id="6042082">(</span><span class="ident" id="6042083">a</span><span class="op" id="6042084">,</span>&nbsp;<span class="string" id="6042086">&#34;/&#34;</span><span class="op" id="6042089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042092">bslash</span>&nbsp;<span class="op" id="6042099">:=</span>&nbsp;<span class="ident" id="6042102">strings</span><span class="op" id="6042109">.</span><span class="ident" id="6042110">HasPrefix</span><span class="op" id="6042119">(</span><span class="ident" id="6042120">b</span><span class="op" id="6042121">,</span>&nbsp;<span class="string" id="6042123">&#34;/&#34;</span><span class="op" id="6042126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042129">switch</span>&nbsp;<span class="op" id="6042136">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042139">case</span>&nbsp;<span class="ident" id="6042144">aslash</span>&nbsp;<span class="op" id="6042151">&amp;&amp;</span>&nbsp;<span class="ident" id="6042154">bslash</span><span class="op" id="6042160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042164">return</span>&nbsp;<span class="ident" id="6042171">a</span>&nbsp;<span class="op" id="6042173">+</span>&nbsp;<span class="ident" id="6042175">b</span><span class="op" id="6042176">[</span><span class="num" id="6042177">1</span><span class="op" id="6042178">:</span><span class="op" id="6042179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042182">case</span>&nbsp;<span class="op" id="6042187">!</span><span class="ident" id="6042188">aslash</span>&nbsp;<span class="op" id="6042195">&amp;&amp;</span>&nbsp;<span class="op" id="6042198">!</span><span class="ident" id="6042199">bslash</span><span class="op" id="6042205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042209">return</span>&nbsp;<span class="ident" id="6042216">a</span>&nbsp;<span class="op" id="6042218">+</span>&nbsp;<span class="string" id="6042220">&#34;/&#34;</span>&nbsp;<span class="op" id="6042224">+</span>&nbsp;<span class="ident" id="6042226">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042229">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042232">return</span>&nbsp;<span class="ident" id="6042239">a</span>&nbsp;<span class="op" id="6042241">+</span>&nbsp;<span class="ident" id="6042243">b</span><br>
<span class="lineno"></span><span class="op" id="6042245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6042248">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6042318">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6042388">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6042457">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6042502">func</span>&nbsp;<span class="ident" id="6042507">NewSingleHostReverseProxy</span><span class="op" id="6042532">(</span><span class="ident" id="6042533">target</span>&nbsp;<span class="op" id="6042540">*</span><span class="ident" id="6042541">url</span><span class="op" id="6042544">.</span><span class="ident" id="6042545">URL</span><span class="op" id="6042548">)</span>&nbsp;<span class="op" id="6042550">*</span><span class="ident" id="6042551">ReverseProxy</span>&nbsp;<span class="op" id="6042564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042567">targetQuery</span>&nbsp;<span class="op" id="6042579">:=</span>&nbsp;<span class="ident" id="6042582">target</span><span class="op" id="6042588">.</span><span class="ident" id="6042589">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042599">director</span>&nbsp;<span class="op" id="6042608">:=</span>&nbsp;<span class="keyword" id="6042611">func</span><span class="op" id="6042615">(</span><span class="ident" id="6042616">req</span>&nbsp;<span class="op" id="6042620">*</span><span class="ident" id="6042621">http</span><span class="op" id="6042625">.</span><span class="ident" id="6042626">Request</span><span class="op" id="6042633">)</span>&nbsp;<span class="op" id="6042635">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042639">req</span><span class="op" id="6042642">.</span><span class="ident" id="6042643">URL</span><span class="op" id="6042646">.</span><span class="ident" id="6042647">Scheme</span>&nbsp;<span class="op" id="6042654">=</span>&nbsp;<span class="ident" id="6042656">target</span><span class="op" id="6042662">.</span><span class="ident" id="6042663">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042672">req</span><span class="op" id="6042675">.</span><span class="ident" id="6042676">URL</span><span class="op" id="6042679">.</span><span class="ident" id="6042680">Host</span>&nbsp;<span class="op" id="6042685">=</span>&nbsp;<span class="ident" id="6042687">target</span><span class="op" id="6042693">.</span><span class="ident" id="6042694">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042701">req</span><span class="op" id="6042704">.</span><span class="ident" id="6042705">URL</span><span class="op" id="6042708">.</span><span class="ident" id="6042709">Path</span>&nbsp;<span class="op" id="6042714">=</span>&nbsp;<span class="ident" id="6042716">singleJoiningSlash</span><span class="op" id="6042734">(</span><span class="ident" id="6042735">target</span><span class="op" id="6042741">.</span><span class="ident" id="6042742">Path</span><span class="op" id="6042746">,</span>&nbsp;<span class="ident" id="6042748">req</span><span class="op" id="6042751">.</span><span class="ident" id="6042752">URL</span><span class="op" id="6042755">.</span><span class="ident" id="6042756">Path</span><span class="op" id="6042760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042764">if</span>&nbsp;<span class="ident" id="6042767">targetQuery</span>&nbsp;<span class="op" id="6042779">==</span>&nbsp;<span class="string" id="6042782">&#34;&#34;</span>&nbsp;<span class="op" id="6042785">||</span>&nbsp;<span class="ident" id="6042788">req</span><span class="op" id="6042791">.</span><span class="ident" id="6042792">URL</span><span class="op" id="6042795">.</span><span class="ident" id="6042796">RawQuery</span>&nbsp;<span class="op" id="6042805">==</span>&nbsp;<span class="string" id="6042808">&#34;&#34;</span>&nbsp;<span class="op" id="6042811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042816">req</span><span class="op" id="6042819">.</span><span class="ident" id="6042820">URL</span><span class="op" id="6042823">.</span><span class="ident" id="6042824">RawQuery</span>&nbsp;<span class="op" id="6042833">=</span>&nbsp;<span class="ident" id="6042835">targetQuery</span>&nbsp;<span class="op" id="6042847">+</span>&nbsp;<span class="ident" id="6042849">req</span><span class="op" id="6042852">.</span><span class="ident" id="6042853">URL</span><span class="op" id="6042856">.</span><span class="ident" id="6042857">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042868">}</span>&nbsp;<span class="keyword" id="6042870">else</span>&nbsp;<span class="op" id="6042875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042880">req</span><span class="op" id="6042883">.</span><span class="ident" id="6042884">URL</span><span class="op" id="6042887">.</span><span class="ident" id="6042888">RawQuery</span>&nbsp;<span class="op" id="6042897">=</span>&nbsp;<span class="ident" id="6042899">targetQuery</span>&nbsp;<span class="op" id="6042911">+</span>&nbsp;<span class="string" id="6042913">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6042917">+</span>&nbsp;<span class="ident" id="6042919">req</span><span class="op" id="6042922">.</span><span class="ident" id="6042923">URL</span><span class="op" id="6042926">.</span><span class="ident" id="6042927">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042944">return</span>&nbsp;<span class="op" id="6042951">&amp;</span><span class="ident" id="6042952">ReverseProxy</span><span class="op" id="6042964">{</span><span class="ident" id="6042965">Director</span><span class="op" id="6042973">:</span>&nbsp;<span class="ident" id="6042975">director</span><span class="op" id="6042983">}</span><br>
<span class="lineno">80</span><span class="op" id="6042985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6042988">func</span>&nbsp;<span class="ident" id="6042993">copyHeader</span><span class="op" id="6043003">(</span><span class="ident" id="6043004">dst</span><span class="op" id="6043007">,</span>&nbsp;<span class="ident" id="6043009">src</span>&nbsp;<span class="ident" id="6043013">http</span><span class="op" id="6043017">.</span><span class="ident" id="6043018">Header</span><span class="op" id="6043024">)</span>&nbsp;<span class="op" id="6043026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043029">for</span>&nbsp;<span class="ident" id="6043033">k</span><span class="op" id="6043034">,</span>&nbsp;<span class="ident" id="6043036">vv</span>&nbsp;<span class="op" id="6043039">:=</span>&nbsp;<span class="keyword" id="6043042">range</span>&nbsp;<span class="ident" id="6043048">src</span>&nbsp;<span class="op" id="6043052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043056">for</span>&nbsp;<span class="ident" id="6043060">_</span><span class="op" id="6043061">,</span>&nbsp;<span class="ident" id="6043063">v</span>&nbsp;<span class="op" id="6043065">:=</span>&nbsp;<span class="keyword" id="6043068">range</span>&nbsp;<span class="ident" id="6043074">vv</span>&nbsp;<span class="op" id="6043077">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043082">dst</span><span class="op" id="6043085">.</span><span class="ident" id="6043086">Add</span><span class="op" id="6043089">(</span><span class="ident" id="6043090">k</span><span class="op" id="6043091">,</span>&nbsp;<span class="ident" id="6043093">v</span><span class="op" id="6043094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043101">}</span><br>
<span class="lineno"></span><span class="op" id="6043103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6043106">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6043173">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6043231">var</span>&nbsp;<span class="ident" id="6043235">hopHeaders</span>&nbsp;<span class="op" id="6043246">=</span>&nbsp;<span class="op" id="6043248">[</span><span class="op" id="6043249">]</span><span class="builtintype" id="6043250">string</span><span class="op" id="6043256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043259">&#34;Connection&#34;</span><span class="op" id="6043271">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043274">&#34;Keep-Alive&#34;</span><span class="op" id="6043286">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043289">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6043309">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043312">&#34;Proxy-Authorization&#34;</span><span class="op" id="6043333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043336">&#34;Te&#34;</span><span class="op" id="6043340">,</span>&nbsp;<span class="comment" id="6043342">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043376">&#34;Trailers&#34;</span><span class="op" id="6043386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043389">&#34;Transfer-Encoding&#34;</span><span class="op" id="6043408">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6043411">&#34;Upgrade&#34;</span><span class="op" id="6043420">,</span><br>
<span class="lineno"></span><span class="op" id="6043422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6043425">func</span>&nbsp;<span class="op" id="6043430">(</span><span class="ident" id="6043431">p</span>&nbsp;<span class="op" id="6043433">*</span><span class="ident" id="6043434">ReverseProxy</span><span class="op" id="6043446">)</span>&nbsp;<span class="ident" id="6043448">ServeHTTP</span><span class="op" id="6043457">(</span><span class="ident" id="6043458">rw</span>&nbsp;<span class="ident" id="6043461">http</span><span class="op" id="6043465">.</span><span class="ident" id="6043466">ResponseWriter</span><span class="op" id="6043480">,</span>&nbsp;<span class="ident" id="6043482">req</span>&nbsp;<span class="op" id="6043486">*</span><span class="ident" id="6043487">http</span><span class="op" id="6043491">.</span><span class="ident" id="6043492">Request</span><span class="op" id="6043499">)</span>&nbsp;<span class="op" id="6043501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043504">transport</span>&nbsp;<span class="op" id="6043514">:=</span>&nbsp;<span class="ident" id="6043517">p</span><span class="op" id="6043518">.</span><span class="ident" id="6043519">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043530">if</span>&nbsp;<span class="ident" id="6043533">transport</span>&nbsp;<span class="op" id="6043543">==</span>&nbsp;<span class="ident" id="6043546">nil</span>&nbsp;<span class="op" id="6043550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043554">transport</span>&nbsp;<span class="op" id="6043564">=</span>&nbsp;<span class="ident" id="6043566">http</span><span class="op" id="6043570">.</span><span class="ident" id="6043571">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043593">outreq</span>&nbsp;<span class="op" id="6043600">:=</span>&nbsp;<span class="builtinfunc" id="6043603">new</span><span class="op" id="6043606">(</span><span class="ident" id="6043607">http</span><span class="op" id="6043611">.</span><span class="ident" id="6043612">Request</span><span class="op" id="6043619">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043622">*</span><span class="ident" id="6043623">outreq</span>&nbsp;<span class="op" id="6043630">=</span>&nbsp;<span class="op" id="6043632">*</span><span class="ident" id="6043633">req</span>&nbsp;<span class="comment" id="6043637">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043684">p</span><span class="op" id="6043685">.</span><span class="ident" id="6043686">Director</span><span class="op" id="6043694">(</span><span class="ident" id="6043695">outreq</span><span class="op" id="6043701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043704">outreq</span><span class="op" id="6043710">.</span><span class="ident" id="6043711">Proto</span>&nbsp;<span class="op" id="6043717">=</span>&nbsp;<span class="string" id="6043719">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043731">outreq</span><span class="op" id="6043737">.</span><span class="ident" id="6043738">ProtoMajor</span>&nbsp;<span class="op" id="6043749">=</span>&nbsp;<span class="num" id="6043751">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043754">outreq</span><span class="op" id="6043760">.</span><span class="ident" id="6043761">ProtoMinor</span>&nbsp;<span class="op" id="6043772">=</span>&nbsp;<span class="num" id="6043774">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043777">outreq</span><span class="op" id="6043783">.</span><span class="ident" id="6043784">Close</span>&nbsp;<span class="op" id="6043790">=</span>&nbsp;<span class="builtintype" id="6043792">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043800">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043858">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043917">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043981">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044040">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044091">copiedHeaders</span>&nbsp;<span class="op" id="6044105">:=</span>&nbsp;<span class="builtintype" id="6044108">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044115">for</span>&nbsp;<span class="ident" id="6044119">_</span><span class="op" id="6044120">,</span>&nbsp;<span class="ident" id="6044122">h</span>&nbsp;<span class="op" id="6044124">:=</span>&nbsp;<span class="keyword" id="6044127">range</span>&nbsp;<span class="ident" id="6044133">hopHeaders</span>&nbsp;<span class="op" id="6044144">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044148">if</span>&nbsp;<span class="ident" id="6044151">outreq</span><span class="op" id="6044157">.</span><span class="ident" id="6044158">Header</span><span class="op" id="6044164">.</span><span class="ident" id="6044165">Get</span><span class="op" id="6044168">(</span><span class="ident" id="6044169">h</span><span class="op" id="6044170">)</span>&nbsp;<span class="op" id="6044172">!=</span>&nbsp;<span class="string" id="6044175">&#34;&#34;</span>&nbsp;<span class="op" id="6044178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044183">if</span>&nbsp;<span class="op" id="6044186">!</span><span class="ident" id="6044187">copiedHeaders</span>&nbsp;<span class="op" id="6044201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044207">outreq</span><span class="op" id="6044213">.</span><span class="ident" id="6044214">Header</span>&nbsp;<span class="op" id="6044221">=</span>&nbsp;<span class="builtinfunc" id="6044223">make</span><span class="op" id="6044227">(</span><span class="ident" id="6044228">http</span><span class="op" id="6044232">.</span><span class="ident" id="6044233">Header</span><span class="op" id="6044239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044245">copyHeader</span><span class="op" id="6044255">(</span><span class="ident" id="6044256">outreq</span><span class="op" id="6044262">.</span><span class="ident" id="6044263">Header</span><span class="op" id="6044269">,</span>&nbsp;<span class="ident" id="6044271">req</span><span class="op" id="6044274">.</span><span class="ident" id="6044275">Header</span><span class="op" id="6044281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044287">copiedHeaders</span>&nbsp;<span class="op" id="6044301">=</span>&nbsp;<span class="builtintype" id="6044303">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044316">outreq</span><span class="op" id="6044322">.</span><span class="ident" id="6044323">Header</span><span class="op" id="6044329">.</span><span class="ident" id="6044330">Del</span><span class="op" id="6044333">(</span><span class="ident" id="6044334">h</span><span class="op" id="6044335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044346">if</span>&nbsp;<span class="ident" id="6044349">clientIP</span><span class="op" id="6044357">,</span>&nbsp;<span class="ident" id="6044359">_</span><span class="op" id="6044360">,</span>&nbsp;<span class="ident" id="6044362">err</span>&nbsp;<span class="op" id="6044366">:=</span>&nbsp;<span class="ident" id="6044369">net</span><span class="op" id="6044372">.</span><span class="ident" id="6044373">SplitHostPort</span><span class="op" id="6044386">(</span><span class="ident" id="6044387">req</span><span class="op" id="6044390">.</span><span class="ident" id="6044391">RemoteAddr</span><span class="op" id="6044401">)</span><span class="op" id="6044402">;</span>&nbsp;<span class="ident" id="6044404">err</span>&nbsp;<span class="op" id="6044408">==</span>&nbsp;<span class="ident" id="6044411">nil</span>&nbsp;<span class="op" id="6044415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044419">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044466">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044516">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044572">if</span>&nbsp;<span class="ident" id="6044575">prior</span><span class="op" id="6044580">,</span>&nbsp;<span class="ident" id="6044582">ok</span>&nbsp;<span class="op" id="6044585">:=</span>&nbsp;<span class="ident" id="6044588">outreq</span><span class="op" id="6044594">.</span><span class="ident" id="6044595">Header</span><span class="op" id="6044601">[</span><span class="string" id="6044602">&#34;X-Forwarded-For&#34;</span><span class="op" id="6044619">]</span><span class="op" id="6044620">;</span>&nbsp;<span class="ident" id="6044622">ok</span>&nbsp;<span class="op" id="6044625">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044630">clientIP</span>&nbsp;<span class="op" id="6044639">=</span>&nbsp;<span class="ident" id="6044641">strings</span><span class="op" id="6044648">.</span><span class="ident" id="6044649">Join</span><span class="op" id="6044653">(</span><span class="ident" id="6044654">prior</span><span class="op" id="6044659">,</span>&nbsp;<span class="string" id="6044661">&#34;,&nbsp;&#34;</span><span class="op" id="6044665">)</span>&nbsp;<span class="op" id="6044667">+</span>&nbsp;<span class="string" id="6044669">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6044674">+</span>&nbsp;<span class="ident" id="6044676">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044691">outreq</span><span class="op" id="6044697">.</span><span class="ident" id="6044698">Header</span><span class="op" id="6044704">.</span><span class="ident" id="6044705">Set</span><span class="op" id="6044708">(</span><span class="string" id="6044709">&#34;X-Forwarded-For&#34;</span><span class="op" id="6044726">,</span>&nbsp;<span class="ident" id="6044728">clientIP</span><span class="op" id="6044736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044743">res</span><span class="op" id="6044746">,</span>&nbsp;<span class="ident" id="6044748">err</span>&nbsp;<span class="op" id="6044752">:=</span>&nbsp;<span class="ident" id="6044755">transport</span><span class="op" id="6044764">.</span><span class="ident" id="6044765">RoundTrip</span><span class="op" id="6044774">(</span><span class="ident" id="6044775">outreq</span><span class="op" id="6044781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044784">if</span>&nbsp;<span class="ident" id="6044787">err</span>&nbsp;<span class="op" id="6044791">!=</span>&nbsp;<span class="ident" id="6044794">nil</span>&nbsp;<span class="op" id="6044798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044802">p</span><span class="op" id="6044803">.</span><span class="ident" id="6044804">logf</span><span class="op" id="6044808">(</span><span class="string" id="6044809">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6044832">,</span>&nbsp;<span class="ident" id="6044834">err</span><span class="op" id="6044837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044841">rw</span><span class="op" id="6044843">.</span><span class="ident" id="6044844">WriteHeader</span><span class="op" id="6044855">(</span><span class="ident" id="6044856">http</span><span class="op" id="6044860">.</span><span class="ident" id="6044861">StatusInternalServerError</span><span class="op" id="6044886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044890">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044901">defer</span>&nbsp;<span class="ident" id="6044907">res</span><span class="op" id="6044910">.</span><span class="ident" id="6044911">Body</span><span class="op" id="6044915">.</span><span class="ident" id="6044916">Close</span><span class="op" id="6044921">(</span><span class="op" id="6044922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044926">for</span>&nbsp;<span class="ident" id="6044930">_</span><span class="op" id="6044931">,</span>&nbsp;<span class="ident" id="6044933">h</span>&nbsp;<span class="op" id="6044935">:=</span>&nbsp;<span class="keyword" id="6044938">range</span>&nbsp;<span class="ident" id="6044944">hopHeaders</span>&nbsp;<span class="op" id="6044955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044959">res</span><span class="op" id="6044962">.</span><span class="ident" id="6044963">Header</span><span class="op" id="6044969">.</span><span class="ident" id="6044970">Del</span><span class="op" id="6044973">(</span><span class="ident" id="6044974">h</span><span class="op" id="6044975">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044982">copyHeader</span><span class="op" id="6044992">(</span><span class="ident" id="6044993">rw</span><span class="op" id="6044995">.</span><span class="ident" id="6044996">Header</span><span class="op" id="6045002">(</span><span class="op" id="6045003">)</span><span class="op" id="6045004">,</span>&nbsp;<span class="ident" id="6045006">res</span><span class="op" id="6045009">.</span><span class="ident" id="6045010">Header</span><span class="op" id="6045016">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045020">rw</span><span class="op" id="6045022">.</span><span class="ident" id="6045023">WriteHeader</span><span class="op" id="6045034">(</span><span class="ident" id="6045035">res</span><span class="op" id="6045038">.</span><span class="ident" id="6045039">StatusCode</span><span class="op" id="6045049">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045052">p</span><span class="op" id="6045053">.</span><span class="ident" id="6045054">copyResponse</span><span class="op" id="6045066">(</span><span class="ident" id="6045067">rw</span><span class="op" id="6045069">,</span>&nbsp;<span class="ident" id="6045071">res</span><span class="op" id="6045074">.</span><span class="ident" id="6045075">Body</span><span class="op" id="6045079">)</span><br>
<span class="lineno"></span><span class="op" id="6045081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045084">func</span>&nbsp;<span class="op" id="6045089">(</span><span class="ident" id="6045090">p</span>&nbsp;<span class="op" id="6045092">*</span><span class="ident" id="6045093">ReverseProxy</span><span class="op" id="6045105">)</span>&nbsp;<span class="ident" id="6045107">copyResponse</span><span class="op" id="6045119">(</span><span class="ident" id="6045120">dst</span>&nbsp;<span class="ident" id="6045124">io</span><span class="op" id="6045126">.</span><span class="ident" id="6045127">Writer</span><span class="op" id="6045133">,</span>&nbsp;<span class="ident" id="6045135">src</span>&nbsp;<span class="ident" id="6045139">io</span><span class="op" id="6045141">.</span><span class="ident" id="6045142">Reader</span><span class="op" id="6045148">)</span>&nbsp;<span class="op" id="6045150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045153">if</span>&nbsp;<span class="ident" id="6045156">p</span><span class="op" id="6045157">.</span><span class="ident" id="6045158">FlushInterval</span>&nbsp;<span class="op" id="6045172">!=</span>&nbsp;<span class="num" id="6045175">0</span>&nbsp;<span class="op" id="6045177">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045181">if</span>&nbsp;<span class="ident" id="6045184">wf</span><span class="op" id="6045186">,</span>&nbsp;<span class="ident" id="6045188">ok</span>&nbsp;<span class="op" id="6045191">:=</span>&nbsp;<span class="ident" id="6045194">dst</span><span class="op" id="6045197">.</span><span class="op" id="6045198">(</span><span class="ident" id="6045199">writeFlusher</span><span class="op" id="6045211">)</span><span class="op" id="6045212">;</span>&nbsp;<span class="ident" id="6045214">ok</span>&nbsp;<span class="op" id="6045217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045222">mlw</span>&nbsp;<span class="op" id="6045226">:=</span>&nbsp;<span class="op" id="6045229">&amp;</span><span class="ident" id="6045230">maxLatencyWriter</span><span class="op" id="6045246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045252">dst</span><span class="op" id="6045255">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6045261">wf</span><span class="op" id="6045263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045269">latency</span><span class="op" id="6045276">:</span>&nbsp;<span class="ident" id="6045278">p</span><span class="op" id="6045279">.</span><span class="ident" id="6045280">FlushInterval</span><span class="op" id="6045293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045299">done</span><span class="op" id="6045303">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6045308">make</span><span class="op" id="6045312">(</span><span class="keyword" id="6045313">chan</span>&nbsp;<span class="builtintype" id="6045318">bool</span><span class="op" id="6045322">)</span><span class="op" id="6045323">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045333">go</span>&nbsp;<span class="ident" id="6045336">mlw</span><span class="op" id="6045339">.</span><span class="ident" id="6045340">flushLoop</span><span class="op" id="6045349">(</span><span class="op" id="6045350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045355">defer</span>&nbsp;<span class="ident" id="6045361">mlw</span><span class="op" id="6045364">.</span><span class="ident" id="6045365">stop</span><span class="op" id="6045369">(</span><span class="op" id="6045370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045375">dst</span>&nbsp;<span class="op" id="6045379">=</span>&nbsp;<span class="ident" id="6045381">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045387">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045394">io</span><span class="op" id="6045396">.</span><span class="ident" id="6045397">Copy</span><span class="op" id="6045401">(</span><span class="ident" id="6045402">dst</span><span class="op" id="6045405">,</span>&nbsp;<span class="ident" id="6045407">src</span><span class="op" id="6045410">)</span><br>
<span class="lineno"></span><span class="op" id="6045412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6045415">func</span>&nbsp;<span class="op" id="6045420">(</span><span class="ident" id="6045421">p</span>&nbsp;<span class="op" id="6045423">*</span><span class="ident" id="6045424">ReverseProxy</span><span class="op" id="6045436">)</span>&nbsp;<span class="ident" id="6045438">logf</span><span class="op" id="6045442">(</span><span class="ident" id="6045443">format</span>&nbsp;<span class="builtintype" id="6045450">string</span><span class="op" id="6045456">,</span>&nbsp;<span class="ident" id="6045458">args</span>&nbsp;<span class="op" id="6045463">...</span><span class="keyword" id="6045466">interface</span><span class="op" id="6045475">{</span><span class="op" id="6045476">}</span><span class="op" id="6045477">)</span>&nbsp;<span class="op" id="6045479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045482">if</span>&nbsp;<span class="ident" id="6045485">p</span><span class="op" id="6045486">.</span><span class="ident" id="6045487">ErrorLog</span>&nbsp;<span class="op" id="6045496">!=</span>&nbsp;<span class="ident" id="6045499">nil</span>&nbsp;<span class="op" id="6045503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045507">p</span><span class="op" id="6045508">.</span><span class="ident" id="6045509">ErrorLog</span><span class="op" id="6045517">.</span><span class="ident" id="6045518">Printf</span><span class="op" id="6045524">(</span><span class="ident" id="6045525">format</span><span class="op" id="6045531">,</span>&nbsp;<span class="ident" id="6045533">args</span><span class="op" id="6045537">...</span><span class="op" id="6045540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045543">}</span>&nbsp;<span class="keyword" id="6045545">else</span>&nbsp;<span class="op" id="6045550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045554">log</span><span class="op" id="6045557">.</span><span class="ident" id="6045558">Printf</span><span class="op" id="6045564">(</span><span class="ident" id="6045565">format</span><span class="op" id="6045571">,</span>&nbsp;<span class="ident" id="6045573">args</span><span class="op" id="6045577">...</span><span class="op" id="6045580">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045583">}</span><br>
<span class="lineno"></span><span class="op" id="6045585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045588">type</span>&nbsp;<span class="ident" id="6045593">writeFlusher</span>&nbsp;<span class="keyword" id="6045606">interface</span>&nbsp;<span class="op" id="6045616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045619">io</span><span class="op" id="6045621">.</span><span class="ident" id="6045622">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045630">http</span><span class="op" id="6045634">.</span><span class="ident" id="6045635">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6045643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045646">type</span>&nbsp;<span class="ident" id="6045651">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6045668">struct</span>&nbsp;<span class="op" id="6045675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045678">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6045686">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045700">latency</span>&nbsp;<span class="ident" id="6045708">time</span><span class="op" id="6045712">.</span><span class="ident" id="6045713">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045724">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6045729">sync</span><span class="op" id="6045733">.</span><span class="ident" id="6045734">Mutex</span>&nbsp;<span class="comment" id="6045740">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045767">done</span>&nbsp;<span class="keyword" id="6045772">chan</span>&nbsp;<span class="builtintype" id="6045777">bool</span><br>
<span class="lineno"></span><span class="op" id="6045782">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6045785">func</span>&nbsp;<span class="op" id="6045790">(</span><span class="ident" id="6045791">m</span>&nbsp;<span class="op" id="6045793">*</span><span class="ident" id="6045794">maxLatencyWriter</span><span class="op" id="6045810">)</span>&nbsp;<span class="ident" id="6045812">Write</span><span class="op" id="6045817">(</span><span class="ident" id="6045818">p</span>&nbsp;<span class="op" id="6045820">[</span><span class="op" id="6045821">]</span><span class="builtintype" id="6045822">byte</span><span class="op" id="6045826">)</span>&nbsp;<span class="op" id="6045828">(</span><span class="builtintype" id="6045829">int</span><span class="op" id="6045832">,</span>&nbsp;<span class="builtintype" id="6045834">error</span><span class="op" id="6045839">)</span>&nbsp;<span class="op" id="6045841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045844">m</span><span class="op" id="6045845">.</span><span class="ident" id="6045846">lk</span><span class="op" id="6045848">.</span><span class="ident" id="6045849">Lock</span><span class="op" id="6045853">(</span><span class="op" id="6045854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045857">defer</span>&nbsp;<span class="ident" id="6045863">m</span><span class="op" id="6045864">.</span><span class="ident" id="6045865">lk</span><span class="op" id="6045867">.</span><span class="ident" id="6045868">Unlock</span><span class="op" id="6045874">(</span><span class="op" id="6045875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045878">return</span>&nbsp;<span class="ident" id="6045885">m</span><span class="op" id="6045886">.</span><span class="ident" id="6045887">dst</span><span class="op" id="6045890">.</span><span class="ident" id="6045891">Write</span><span class="op" id="6045896">(</span><span class="ident" id="6045897">p</span><span class="op" id="6045898">)</span><br>
<span class="lineno">205</span><span class="op" id="6045900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6045903">func</span>&nbsp;<span class="op" id="6045908">(</span><span class="ident" id="6045909">m</span>&nbsp;<span class="op" id="6045911">*</span><span class="ident" id="6045912">maxLatencyWriter</span><span class="op" id="6045928">)</span>&nbsp;<span class="ident" id="6045930">flushLoop</span><span class="op" id="6045939">(</span><span class="op" id="6045940">)</span>&nbsp;<span class="op" id="6045942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045945">t</span>&nbsp;<span class="op" id="6045947">:=</span>&nbsp;<span class="ident" id="6045950">time</span><span class="op" id="6045954">.</span><span class="ident" id="6045955">NewTicker</span><span class="op" id="6045964">(</span><span class="ident" id="6045965">m</span><span class="op" id="6045966">.</span><span class="ident" id="6045967">latency</span><span class="op" id="6045974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045977">defer</span>&nbsp;<span class="ident" id="6045983">t</span><span class="op" id="6045984">.</span><span class="ident" id="6045985">Stop</span><span class="op" id="6045989">(</span><span class="op" id="6045990">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045993">for</span>&nbsp;<span class="op" id="6045997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046001">select</span>&nbsp;<span class="op" id="6046008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046012">case</span>&nbsp;<span class="op" id="6046017">&lt;-</span><span class="ident" id="6046019">m</span><span class="op" id="6046020">.</span><span class="ident" id="6046021">done</span><span class="op" id="6046025">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046030">if</span>&nbsp;<span class="ident" id="6046033">onExitFlushLoop</span>&nbsp;<span class="op" id="6046049">!=</span>&nbsp;<span class="ident" id="6046052">nil</span>&nbsp;<span class="op" id="6046056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046062">onExitFlushLoop</span><span class="op" id="6046077">(</span><span class="op" id="6046078">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6046083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046088">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046097">case</span>&nbsp;<span class="op" id="6046102">&lt;-</span><span class="ident" id="6046104">t</span><span class="op" id="6046105">.</span><span class="ident" id="6046106">C</span><span class="op" id="6046107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046112">m</span><span class="op" id="6046113">.</span><span class="ident" id="6046114">lk</span><span class="op" id="6046116">.</span><span class="ident" id="6046117">Lock</span><span class="op" id="6046121">(</span><span class="op" id="6046122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046127">m</span><span class="op" id="6046128">.</span><span class="ident" id="6046129">dst</span><span class="op" id="6046132">.</span><span class="ident" id="6046133">Flush</span><span class="op" id="6046138">(</span><span class="op" id="6046139">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046144">m</span><span class="op" id="6046145">.</span><span class="ident" id="6046146">lk</span><span class="op" id="6046148">.</span><span class="ident" id="6046149">Unlock</span><span class="op" id="6046155">(</span><span class="op" id="6046156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6046160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6046163">}</span><br>
<span class="lineno"></span><span class="op" id="6046165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6046168">func</span>&nbsp;<span class="op" id="6046173">(</span><span class="ident" id="6046174">m</span>&nbsp;<span class="op" id="6046176">*</span><span class="ident" id="6046177">maxLatencyWriter</span><span class="op" id="6046193">)</span>&nbsp;<span class="ident" id="6046195">stop</span><span class="op" id="6046199">(</span><span class="op" id="6046200">)</span>&nbsp;<span class="op" id="6046202">{</span>&nbsp;<span class="ident" id="6046204">m</span><span class="op" id="6046205">.</span><span class="ident" id="6046206">done</span>&nbsp;<span class="op" id="6046211">&lt;-</span>&nbsp;<span class="builtintype" id="6046214">true</span>&nbsp;<span class="op" id="6046219">}</span>
</div>
</body>
</html>
