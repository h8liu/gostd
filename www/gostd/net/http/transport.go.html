<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3524379">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3524434">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3524488">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3524539">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3524584">//</span><br>
<span class="lineno"></span><span class="comment" id="3524587">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3524654">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3524700">package</span>&nbsp;<span class="ident" id="3524708">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3524714">import</span>&nbsp;<span class="op" id="3524721">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524724">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524733">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524750">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524764">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524774">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524781">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524787">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524794">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524801">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524812">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524818">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524829">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3524837">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3524844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3524847">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3524917">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3524988">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3525059">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3525127">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3525164">var</span>&nbsp;<span class="ident" id="3525168">DefaultTransport</span>&nbsp;<span class="ident" id="3525185">RoundTripper</span>&nbsp;<span class="op" id="3525198">=</span>&nbsp;<span class="op" id="3525200">&amp;</span><span class="ident" id="3525201">Transport</span><span class="op" id="3525210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525213">Proxy</span><span class="op" id="3525218">:</span>&nbsp;<span class="ident" id="3525220">ProxyFromEnvironment</span><span class="op" id="3525240">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525243">Dial</span><span class="op" id="3525247">:</span>&nbsp;<span class="op" id="3525249">(</span><span class="op" id="3525250">&amp;</span><span class="ident" id="3525251">net</span><span class="op" id="3525254">.</span><span class="ident" id="3525255">Dialer</span><span class="op" id="3525261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525265">Timeout</span><span class="op" id="3525272">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3525276">30</span>&nbsp;<span class="op" id="3525279">*</span>&nbsp;<span class="ident" id="3525281">time</span><span class="op" id="3525285">.</span><span class="ident" id="3525286">Second</span><span class="op" id="3525292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525296">KeepAlive</span><span class="op" id="3525305">:</span>&nbsp;<span class="num" id="3525307">30</span>&nbsp;<span class="op" id="3525310">*</span>&nbsp;<span class="ident" id="3525312">time</span><span class="op" id="3525316">.</span><span class="ident" id="3525317">Second</span><span class="op" id="3525323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3525326">}</span><span class="op" id="3525327">)</span><span class="op" id="3525328">.</span><span class="ident" id="3525329">Dial</span><span class="op" id="3525333">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525336">TLSHandshakeTimeout</span><span class="op" id="3525355">:</span>&nbsp;<span class="num" id="3525357">10</span>&nbsp;<span class="op" id="3525360">*</span>&nbsp;<span class="ident" id="3525362">time</span><span class="op" id="3525366">.</span><span class="ident" id="3525367">Second</span><span class="op" id="3525373">,</span><br>
<span class="lineno">40</span><span class="op" id="3525375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3525378">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3525444">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3525468">const</span>&nbsp;<span class="ident" id="3525474">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3525501">=</span>&nbsp;<span class="num" id="3525503">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3525506">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3525576">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3525644">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3525703">type</span>&nbsp;<span class="ident" id="3525708">Transport</span>&nbsp;<span class="keyword" id="3525718">struct</span>&nbsp;<span class="op" id="3525725">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525728">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525739">sync</span><span class="op" id="3525743">.</span><span class="ident" id="3525744">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525751">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3525762">bool</span>&nbsp;<span class="comment" id="3525767">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525814">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3525825">map</span><span class="op" id="3525828">[</span><span class="ident" id="3525829">connectMethodKey</span><span class="op" id="3525845">]</span><span class="op" id="3525846">[</span><span class="op" id="3525847">]</span><span class="op" id="3525848">*</span><span class="ident" id="3525849">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525862">idleConnCh</span>&nbsp;<span class="keyword" id="3525873">map</span><span class="op" id="3525876">[</span><span class="ident" id="3525877">connectMethodKey</span><span class="op" id="3525893">]</span><span class="keyword" id="3525894">chan</span>&nbsp;<span class="op" id="3525899">*</span><span class="ident" id="3525900">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525914">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525926">sync</span><span class="op" id="3525930">.</span><span class="ident" id="3525931">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525938">reqCanceler</span>&nbsp;<span class="keyword" id="3525950">map</span><span class="op" id="3525953">[</span><span class="op" id="3525954">*</span><span class="ident" id="3525955">Request</span><span class="op" id="3525962">]</span><span class="keyword" id="3525963">func</span><span class="op" id="3525967">(</span><span class="op" id="3525968">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525972">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3525981">sync</span><span class="op" id="3525985">.</span><span class="ident" id="3525986">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3525995">altProto</span>&nbsp;<span class="keyword" id="3526004">map</span><span class="op" id="3526007">[</span><span class="builtintype" id="3526008">string</span><span class="op" id="3526014">]</span><span class="ident" id="3526015">RoundTripper</span>&nbsp;<span class="comment" id="3526028">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526074">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526135">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526193">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526241">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526302">Proxy</span>&nbsp;<span class="keyword" id="3526308">func</span><span class="op" id="3526312">(</span><span class="op" id="3526313">*</span><span class="ident" id="3526314">Request</span><span class="op" id="3526321">)</span>&nbsp;<span class="op" id="3526323">(</span><span class="op" id="3526324">*</span><span class="ident" id="3526325">url</span><span class="op" id="3526328">.</span><span class="ident" id="3526329">URL</span><span class="op" id="3526332">,</span>&nbsp;<span class="builtintype" id="3526334">error</span><span class="op" id="3526339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526343">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526405">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526426">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526464">Dial</span>&nbsp;<span class="keyword" id="3526469">func</span><span class="op" id="3526473">(</span><span class="ident" id="3526474">network</span><span class="op" id="3526481">,</span>&nbsp;<span class="ident" id="3526483">addr</span>&nbsp;<span class="builtintype" id="3526488">string</span><span class="op" id="3526494">)</span>&nbsp;<span class="op" id="3526496">(</span><span class="ident" id="3526497">net</span><span class="op" id="3526500">.</span><span class="ident" id="3526501">Conn</span><span class="op" id="3526505">,</span>&nbsp;<span class="builtintype" id="3526507">error</span><span class="op" id="3526512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526516">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526577">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526629">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526633">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526691">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526695">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526754">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526815">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526879">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3526907">DialTLS</span>&nbsp;<span class="keyword" id="3526915">func</span><span class="op" id="3526919">(</span><span class="ident" id="3526920">network</span><span class="op" id="3526927">,</span>&nbsp;<span class="ident" id="3526929">addr</span>&nbsp;<span class="builtintype" id="3526934">string</span><span class="op" id="3526940">)</span>&nbsp;<span class="op" id="3526942">(</span><span class="ident" id="3526943">net</span><span class="op" id="3526946">.</span><span class="ident" id="3526947">Conn</span><span class="op" id="3526951">,</span>&nbsp;<span class="builtintype" id="3526953">error</span><span class="op" id="3526958">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3526962">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527026">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527085">TLSClientConfig</span>&nbsp;<span class="op" id="3527101">*</span><span class="ident" id="3527102">tls</span><span class="op" id="3527105">.</span><span class="ident" id="3527106">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527115">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527187">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527240">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3527260">time</span><span class="op" id="3527264">.</span><span class="ident" id="3527265">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527276">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527343">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527380">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3527398">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527405">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527466">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527525">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527582">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527643">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527703">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527758">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527812">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3527830">DisableCompression</span>&nbsp;<span class="builtintype" id="3527849">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527856">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527920">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3527965">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528005">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3528025">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528031">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528095">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528156">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528215">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3528277">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3528299">time</span><span class="op" id="3528303">.</span><span class="ident" id="3528304">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528315">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3528366">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3528416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3528419">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3528485">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3528545">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3528612">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3528680">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3528693">//</span><br>
<span class="lineno"></span><span class="comment" id="3528696">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3528756">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3528818">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3528876">//</span><br>
<span class="lineno">130</span><span class="comment" id="3528879">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3528949">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3529018">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3529045">//</span><br>
<span class="lineno"></span><span class="comment" id="3529048">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3529118">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3529184">func</span>&nbsp;<span class="ident" id="3529189">ProxyFromEnvironment</span><span class="op" id="3529209">(</span><span class="ident" id="3529210">req</span>&nbsp;<span class="op" id="3529214">*</span><span class="ident" id="3529215">Request</span><span class="op" id="3529222">)</span>&nbsp;<span class="op" id="3529224">(</span><span class="op" id="3529225">*</span><span class="ident" id="3529226">url</span><span class="op" id="3529229">.</span><span class="ident" id="3529230">URL</span><span class="op" id="3529233">,</span>&nbsp;<span class="builtintype" id="3529235">error</span><span class="op" id="3529240">)</span>&nbsp;<span class="op" id="3529242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529245">var</span>&nbsp;<span class="ident" id="3529249">proxy</span>&nbsp;<span class="builtintype" id="3529255">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529263">if</span>&nbsp;<span class="ident" id="3529266">req</span><span class="op" id="3529269">.</span><span class="ident" id="3529270">URL</span><span class="op" id="3529273">.</span><span class="ident" id="3529274">Scheme</span>&nbsp;<span class="op" id="3529281">==</span>&nbsp;<span class="string" id="3529284">&#34;https&#34;</span>&nbsp;<span class="op" id="3529292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529296">proxy</span>&nbsp;<span class="op" id="3529302">=</span>&nbsp;<span class="ident" id="3529304">httpsProxyEnv</span><span class="op" id="3529317">.</span><span class="ident" id="3529318">Get</span><span class="op" id="3529321">(</span><span class="op" id="3529322">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529328">if</span>&nbsp;<span class="ident" id="3529331">proxy</span>&nbsp;<span class="op" id="3529337">==</span>&nbsp;<span class="string" id="3529340">&#34;&#34;</span>&nbsp;<span class="op" id="3529343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529347">proxy</span>&nbsp;<span class="op" id="3529353">=</span>&nbsp;<span class="ident" id="3529355">httpProxyEnv</span><span class="op" id="3529367">.</span><span class="ident" id="3529368">Get</span><span class="op" id="3529371">(</span><span class="op" id="3529372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529378">if</span>&nbsp;<span class="ident" id="3529381">proxy</span>&nbsp;<span class="op" id="3529387">==</span>&nbsp;<span class="string" id="3529390">&#34;&#34;</span>&nbsp;<span class="op" id="3529393">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529397">return</span>&nbsp;<span class="ident" id="3529404">nil</span><span class="op" id="3529407">,</span>&nbsp;<span class="ident" id="3529409">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529417">if</span>&nbsp;<span class="op" id="3529420">!</span><span class="ident" id="3529421">useProxy</span><span class="op" id="3529429">(</span><span class="ident" id="3529430">canonicalAddr</span><span class="op" id="3529443">(</span><span class="ident" id="3529444">req</span><span class="op" id="3529447">.</span><span class="ident" id="3529448">URL</span><span class="op" id="3529451">)</span><span class="op" id="3529452">)</span>&nbsp;<span class="op" id="3529454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529458">return</span>&nbsp;<span class="ident" id="3529465">nil</span><span class="op" id="3529468">,</span>&nbsp;<span class="ident" id="3529470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529475">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3529478">proxyURL</span><span class="op" id="3529486">,</span>&nbsp;<span class="ident" id="3529488">err</span>&nbsp;<span class="op" id="3529492">:=</span>&nbsp;<span class="ident" id="3529495">url</span><span class="op" id="3529498">.</span><span class="ident" id="3529499">Parse</span><span class="op" id="3529504">(</span><span class="ident" id="3529505">proxy</span><span class="op" id="3529510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529513">if</span>&nbsp;<span class="ident" id="3529516">err</span>&nbsp;<span class="op" id="3529520">!=</span>&nbsp;<span class="ident" id="3529523">nil</span>&nbsp;<span class="op" id="3529527">||</span>&nbsp;<span class="op" id="3529530">!</span><span class="ident" id="3529531">strings</span><span class="op" id="3529538">.</span><span class="ident" id="3529539">HasPrefix</span><span class="op" id="3529548">(</span><span class="ident" id="3529549">proxyURL</span><span class="op" id="3529557">.</span><span class="ident" id="3529558">Scheme</span><span class="op" id="3529564">,</span>&nbsp;<span class="string" id="3529566">&#34;http&#34;</span><span class="op" id="3529572">)</span>&nbsp;<span class="op" id="3529574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529578">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529635">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3529686">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529736">if</span>&nbsp;<span class="ident" id="3529739">proxyURL</span><span class="op" id="3529747">,</span>&nbsp;<span class="ident" id="3529749">err</span>&nbsp;<span class="op" id="3529753">:=</span>&nbsp;<span class="ident" id="3529756">url</span><span class="op" id="3529759">.</span><span class="ident" id="3529760">Parse</span><span class="op" id="3529765">(</span><span class="string" id="3529766">&#34;http://&#34;</span>&nbsp;<span class="op" id="3529776">+</span>&nbsp;<span class="ident" id="3529778">proxy</span><span class="op" id="3529783">)</span><span class="op" id="3529784">;</span>&nbsp;<span class="ident" id="3529786">err</span>&nbsp;<span class="op" id="3529790">==</span>&nbsp;<span class="ident" id="3529793">nil</span>&nbsp;<span class="op" id="3529797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529802">return</span>&nbsp;<span class="ident" id="3529809">proxyURL</span><span class="op" id="3529817">,</span>&nbsp;<span class="ident" id="3529819">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529831">if</span>&nbsp;<span class="ident" id="3529834">err</span>&nbsp;<span class="op" id="3529838">!=</span>&nbsp;<span class="ident" id="3529841">nil</span>&nbsp;<span class="op" id="3529845">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529849">return</span>&nbsp;<span class="ident" id="3529856">nil</span><span class="op" id="3529859">,</span>&nbsp;<span class="ident" id="3529861">fmt</span><span class="op" id="3529864">.</span><span class="ident" id="3529865">Errorf</span><span class="op" id="3529871">(</span><span class="string" id="3529872">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3529902">,</span>&nbsp;<span class="ident" id="3529904">proxy</span><span class="op" id="3529909">,</span>&nbsp;<span class="ident" id="3529911">err</span><span class="op" id="3529914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3529917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3529920">return</span>&nbsp;<span class="ident" id="3529927">proxyURL</span><span class="op" id="3529935">,</span>&nbsp;<span class="ident" id="3529937">nil</span><br>
<span class="lineno"></span><span class="op" id="3529941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3529944">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3530006">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3530043">func</span>&nbsp;<span class="ident" id="3530048">ProxyURL</span><span class="op" id="3530056">(</span><span class="ident" id="3530057">fixedURL</span>&nbsp;<span class="op" id="3530066">*</span><span class="ident" id="3530067">url</span><span class="op" id="3530070">.</span><span class="ident" id="3530071">URL</span><span class="op" id="3530074">)</span>&nbsp;<span class="keyword" id="3530076">func</span><span class="op" id="3530080">(</span><span class="op" id="3530081">*</span><span class="ident" id="3530082">Request</span><span class="op" id="3530089">)</span>&nbsp;<span class="op" id="3530091">(</span><span class="op" id="3530092">*</span><span class="ident" id="3530093">url</span><span class="op" id="3530096">.</span><span class="ident" id="3530097">URL</span><span class="op" id="3530100">,</span>&nbsp;<span class="builtintype" id="3530102">error</span><span class="op" id="3530107">)</span>&nbsp;<span class="op" id="3530109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530112">return</span>&nbsp;<span class="keyword" id="3530119">func</span><span class="op" id="3530123">(</span><span class="op" id="3530124">*</span><span class="ident" id="3530125">Request</span><span class="op" id="3530132">)</span>&nbsp;<span class="op" id="3530134">(</span><span class="op" id="3530135">*</span><span class="ident" id="3530136">url</span><span class="op" id="3530139">.</span><span class="ident" id="3530140">URL</span><span class="op" id="3530143">,</span>&nbsp;<span class="builtintype" id="3530145">error</span><span class="op" id="3530150">)</span>&nbsp;<span class="op" id="3530152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530156">return</span>&nbsp;<span class="ident" id="3530163">fixedURL</span><span class="op" id="3530171">,</span>&nbsp;<span class="ident" id="3530173">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530178">}</span><br>
<span class="lineno"></span><span class="op" id="3530180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3530183">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3530244">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3530280">type</span>&nbsp;<span class="ident" id="3530285">transportRequest</span>&nbsp;<span class="keyword" id="3530302">struct</span>&nbsp;<span class="op" id="3530309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530312">*</span><span class="ident" id="3530313">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3530328">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530368">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3530377">Header</span>&nbsp;<span class="comment" id="3530384">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3530418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3530421">func</span>&nbsp;<span class="op" id="3530426">(</span><span class="ident" id="3530427">tr</span>&nbsp;<span class="op" id="3530430">*</span><span class="ident" id="3530431">transportRequest</span><span class="op" id="3530447">)</span>&nbsp;<span class="ident" id="3530449">extraHeaders</span><span class="op" id="3530461">(</span><span class="op" id="3530462">)</span>&nbsp;<span class="ident" id="3530464">Header</span>&nbsp;<span class="op" id="3530471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530474">if</span>&nbsp;<span class="ident" id="3530477">tr</span><span class="op" id="3530479">.</span><span class="ident" id="3530480">extra</span>&nbsp;<span class="op" id="3530486">==</span>&nbsp;<span class="ident" id="3530489">nil</span>&nbsp;<span class="op" id="3530493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530497">tr</span><span class="op" id="3530499">.</span><span class="ident" id="3530500">extra</span>&nbsp;<span class="op" id="3530506">=</span>&nbsp;<span class="builtinfunc" id="3530508">make</span><span class="op" id="3530512">(</span><span class="ident" id="3530513">Header</span><span class="op" id="3530519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530525">return</span>&nbsp;<span class="ident" id="3530532">tr</span><span class="op" id="3530534">.</span><span class="ident" id="3530535">extra</span><br>
<span class="lineno">185</span><span class="op" id="3530541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3530544">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3530596">//</span><br>
<span class="lineno"></span><span class="comment" id="3530599">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3530668">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3530723">func</span>&nbsp;<span class="op" id="3530728">(</span><span class="ident" id="3530729">t</span>&nbsp;<span class="op" id="3530731">*</span><span class="ident" id="3530732">Transport</span><span class="op" id="3530741">)</span>&nbsp;<span class="ident" id="3530743">RoundTrip</span><span class="op" id="3530752">(</span><span class="ident" id="3530753">req</span>&nbsp;<span class="op" id="3530757">*</span><span class="ident" id="3530758">Request</span><span class="op" id="3530765">)</span>&nbsp;<span class="op" id="3530767">(</span><span class="ident" id="3530768">resp</span>&nbsp;<span class="op" id="3530773">*</span><span class="ident" id="3530774">Response</span><span class="op" id="3530782">,</span>&nbsp;<span class="ident" id="3530784">err</span>&nbsp;<span class="builtintype" id="3530788">error</span><span class="op" id="3530793">)</span>&nbsp;<span class="op" id="3530795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530798">if</span>&nbsp;<span class="ident" id="3530801">req</span><span class="op" id="3530804">.</span><span class="ident" id="3530805">URL</span>&nbsp;<span class="op" id="3530809">==</span>&nbsp;<span class="ident" id="3530812">nil</span>&nbsp;<span class="op" id="3530816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530820">req</span><span class="op" id="3530823">.</span><span class="ident" id="3530824">closeBody</span><span class="op" id="3530833">(</span><span class="op" id="3530834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530838">return</span>&nbsp;<span class="ident" id="3530845">nil</span><span class="op" id="3530848">,</span>&nbsp;<span class="ident" id="3530850">errors</span><span class="op" id="3530856">.</span><span class="ident" id="3530857">New</span><span class="op" id="3530860">(</span><span class="string" id="3530861">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3530884">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530890">if</span>&nbsp;<span class="ident" id="3530893">req</span><span class="op" id="3530896">.</span><span class="ident" id="3530897">Header</span>&nbsp;<span class="op" id="3530904">==</span>&nbsp;<span class="ident" id="3530907">nil</span>&nbsp;<span class="op" id="3530911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3530915">req</span><span class="op" id="3530918">.</span><span class="ident" id="3530919">closeBody</span><span class="op" id="3530928">(</span><span class="op" id="3530929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530933">return</span>&nbsp;<span class="ident" id="3530940">nil</span><span class="op" id="3530943">,</span>&nbsp;<span class="ident" id="3530945">errors</span><span class="op" id="3530951">.</span><span class="ident" id="3530952">New</span><span class="op" id="3530955">(</span><span class="string" id="3530956">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3530982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3530985">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3530988">if</span>&nbsp;<span class="ident" id="3530991">req</span><span class="op" id="3530994">.</span><span class="ident" id="3530995">URL</span><span class="op" id="3530998">.</span><span class="ident" id="3530999">Scheme</span>&nbsp;<span class="op" id="3531006">!=</span>&nbsp;<span class="string" id="3531009">&#34;http&#34;</span>&nbsp;<span class="op" id="3531016">&amp;&amp;</span>&nbsp;<span class="ident" id="3531019">req</span><span class="op" id="3531022">.</span><span class="ident" id="3531023">URL</span><span class="op" id="3531026">.</span><span class="ident" id="3531027">Scheme</span>&nbsp;<span class="op" id="3531034">!=</span>&nbsp;<span class="string" id="3531037">&#34;https&#34;</span>&nbsp;<span class="op" id="3531045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531049">t</span><span class="op" id="3531050">.</span><span class="ident" id="3531051">altMu</span><span class="op" id="3531056">.</span><span class="ident" id="3531057">RLock</span><span class="op" id="3531062">(</span><span class="op" id="3531063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531067">var</span>&nbsp;<span class="ident" id="3531071">rt</span>&nbsp;<span class="ident" id="3531074">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531089">if</span>&nbsp;<span class="ident" id="3531092">t</span><span class="op" id="3531093">.</span><span class="ident" id="3531094">altProto</span>&nbsp;<span class="op" id="3531103">!=</span>&nbsp;<span class="ident" id="3531106">nil</span>&nbsp;<span class="op" id="3531110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531115">rt</span>&nbsp;<span class="op" id="3531118">=</span>&nbsp;<span class="ident" id="3531120">t</span><span class="op" id="3531121">.</span><span class="ident" id="3531122">altProto</span><span class="op" id="3531130">[</span><span class="ident" id="3531131">req</span><span class="op" id="3531134">.</span><span class="ident" id="3531135">URL</span><span class="op" id="3531138">.</span><span class="ident" id="3531139">Scheme</span><span class="op" id="3531145">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531153">t</span><span class="op" id="3531154">.</span><span class="ident" id="3531155">altMu</span><span class="op" id="3531160">.</span><span class="ident" id="3531161">RUnlock</span><span class="op" id="3531168">(</span><span class="op" id="3531169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531173">if</span>&nbsp;<span class="ident" id="3531176">rt</span>&nbsp;<span class="op" id="3531179">==</span>&nbsp;<span class="ident" id="3531182">nil</span>&nbsp;<span class="op" id="3531186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531191">req</span><span class="op" id="3531194">.</span><span class="ident" id="3531195">closeBody</span><span class="op" id="3531204">(</span><span class="op" id="3531205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531210">return</span>&nbsp;<span class="ident" id="3531217">nil</span><span class="op" id="3531220">,</span>&nbsp;<span class="op" id="3531222">&amp;</span><span class="ident" id="3531223">badStringError</span><span class="op" id="3531237">{</span><span class="string" id="3531238">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3531267">,</span>&nbsp;<span class="ident" id="3531269">req</span><span class="op" id="3531272">.</span><span class="ident" id="3531273">URL</span><span class="op" id="3531276">.</span><span class="ident" id="3531277">Scheme</span><span class="op" id="3531283">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531291">return</span>&nbsp;<span class="ident" id="3531298">rt</span><span class="op" id="3531300">.</span><span class="ident" id="3531301">RoundTrip</span><span class="op" id="3531310">(</span><span class="ident" id="3531311">req</span><span class="op" id="3531314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531320">if</span>&nbsp;<span class="ident" id="3531323">req</span><span class="op" id="3531326">.</span><span class="ident" id="3531327">URL</span><span class="op" id="3531330">.</span><span class="ident" id="3531331">Host</span>&nbsp;<span class="op" id="3531336">==</span>&nbsp;<span class="string" id="3531339">&#34;&#34;</span>&nbsp;<span class="op" id="3531342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531346">req</span><span class="op" id="3531349">.</span><span class="ident" id="3531350">closeBody</span><span class="op" id="3531359">(</span><span class="op" id="3531360">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531364">return</span>&nbsp;<span class="ident" id="3531371">nil</span><span class="op" id="3531374">,</span>&nbsp;<span class="ident" id="3531376">errors</span><span class="op" id="3531382">.</span><span class="ident" id="3531383">New</span><span class="op" id="3531386">(</span><span class="string" id="3531387">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3531417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531423">treq</span>&nbsp;<span class="op" id="3531428">:=</span>&nbsp;<span class="op" id="3531431">&amp;</span><span class="ident" id="3531432">transportRequest</span><span class="op" id="3531448">{</span><span class="ident" id="3531449">Request</span><span class="op" id="3531456">:</span>&nbsp;<span class="ident" id="3531458">req</span><span class="op" id="3531461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531464">cm</span><span class="op" id="3531466">,</span>&nbsp;<span class="ident" id="3531468">err</span>&nbsp;<span class="op" id="3531472">:=</span>&nbsp;<span class="ident" id="3531475">t</span><span class="op" id="3531476">.</span><span class="ident" id="3531477">connectMethodForRequest</span><span class="op" id="3531500">(</span><span class="ident" id="3531501">treq</span><span class="op" id="3531505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531508">if</span>&nbsp;<span class="ident" id="3531511">err</span>&nbsp;<span class="op" id="3531515">!=</span>&nbsp;<span class="ident" id="3531518">nil</span>&nbsp;<span class="op" id="3531522">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531526">req</span><span class="op" id="3531529">.</span><span class="ident" id="3531530">closeBody</span><span class="op" id="3531539">(</span><span class="op" id="3531540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531544">return</span>&nbsp;<span class="ident" id="3531551">nil</span><span class="op" id="3531554">,</span>&nbsp;<span class="ident" id="3531556">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531565">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531626">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531690">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3531754">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531779">pconn</span><span class="op" id="3531784">,</span>&nbsp;<span class="ident" id="3531786">err</span>&nbsp;<span class="op" id="3531790">:=</span>&nbsp;<span class="ident" id="3531793">t</span><span class="op" id="3531794">.</span><span class="ident" id="3531795">getConn</span><span class="op" id="3531802">(</span><span class="ident" id="3531803">req</span><span class="op" id="3531806">,</span>&nbsp;<span class="ident" id="3531808">cm</span><span class="op" id="3531810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531813">if</span>&nbsp;<span class="ident" id="3531816">err</span>&nbsp;<span class="op" id="3531820">!=</span>&nbsp;<span class="ident" id="3531823">nil</span>&nbsp;<span class="op" id="3531827">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531831">t</span><span class="op" id="3531832">.</span><span class="ident" id="3531833">setReqCanceler</span><span class="op" id="3531847">(</span><span class="ident" id="3531848">req</span><span class="op" id="3531851">,</span>&nbsp;<span class="ident" id="3531853">nil</span><span class="op" id="3531856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3531860">req</span><span class="op" id="3531863">.</span><span class="ident" id="3531864">closeBody</span><span class="op" id="3531873">(</span><span class="op" id="3531874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531878">return</span>&nbsp;<span class="ident" id="3531885">nil</span><span class="op" id="3531888">,</span>&nbsp;<span class="ident" id="3531890">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3531895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3531899">return</span>&nbsp;<span class="ident" id="3531906">pconn</span><span class="op" id="3531911">.</span><span class="ident" id="3531912">roundTrip</span><span class="op" id="3531921">(</span><span class="ident" id="3531922">treq</span><span class="op" id="3531926">)</span><br>
<span class="lineno"></span><span class="op" id="3531928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3531931">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3531989">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3532055">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3532120">//</span><br>
<span class="lineno"></span><span class="comment" id="3532123">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3532184">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3532245">func</span>&nbsp;<span class="op" id="3532250">(</span><span class="ident" id="3532251">t</span>&nbsp;<span class="op" id="3532253">*</span><span class="ident" id="3532254">Transport</span><span class="op" id="3532263">)</span>&nbsp;<span class="ident" id="3532265">RegisterProtocol</span><span class="op" id="3532281">(</span><span class="ident" id="3532282">scheme</span>&nbsp;<span class="builtintype" id="3532289">string</span><span class="op" id="3532295">,</span>&nbsp;<span class="ident" id="3532297">rt</span>&nbsp;<span class="ident" id="3532300">RoundTripper</span><span class="op" id="3532312">)</span>&nbsp;<span class="op" id="3532314">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532317">if</span>&nbsp;<span class="ident" id="3532320">scheme</span>&nbsp;<span class="op" id="3532327">==</span>&nbsp;<span class="string" id="3532330">&#34;http&#34;</span>&nbsp;<span class="op" id="3532337">||</span>&nbsp;<span class="ident" id="3532340">scheme</span>&nbsp;<span class="op" id="3532347">==</span>&nbsp;<span class="string" id="3532350">&#34;https&#34;</span>&nbsp;<span class="op" id="3532358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3532362">panic</span><span class="op" id="3532367">(</span><span class="string" id="3532368">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3532380">+</span>&nbsp;<span class="ident" id="3532382">scheme</span>&nbsp;<span class="op" id="3532389">+</span>&nbsp;<span class="string" id="3532391">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3532412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532418">t</span><span class="op" id="3532419">.</span><span class="ident" id="3532420">altMu</span><span class="op" id="3532425">.</span><span class="ident" id="3532426">Lock</span><span class="op" id="3532430">(</span><span class="op" id="3532431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532434">defer</span>&nbsp;<span class="ident" id="3532440">t</span><span class="op" id="3532441">.</span><span class="ident" id="3532442">altMu</span><span class="op" id="3532447">.</span><span class="ident" id="3532448">Unlock</span><span class="op" id="3532454">(</span><span class="op" id="3532455">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532458">if</span>&nbsp;<span class="ident" id="3532461">t</span><span class="op" id="3532462">.</span><span class="ident" id="3532463">altProto</span>&nbsp;<span class="op" id="3532472">==</span>&nbsp;<span class="ident" id="3532475">nil</span>&nbsp;<span class="op" id="3532479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532483">t</span><span class="op" id="3532484">.</span><span class="ident" id="3532485">altProto</span>&nbsp;<span class="op" id="3532494">=</span>&nbsp;<span class="builtinfunc" id="3532496">make</span><span class="op" id="3532500">(</span><span class="keyword" id="3532501">map</span><span class="op" id="3532504">[</span><span class="builtintype" id="3532505">string</span><span class="op" id="3532511">]</span><span class="ident" id="3532512">RoundTripper</span><span class="op" id="3532524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3532530">if</span>&nbsp;<span class="ident" id="3532533">_</span><span class="op" id="3532534">,</span>&nbsp;<span class="ident" id="3532536">exists</span>&nbsp;<span class="op" id="3532543">:=</span>&nbsp;<span class="ident" id="3532546">t</span><span class="op" id="3532547">.</span><span class="ident" id="3532548">altProto</span><span class="op" id="3532556">[</span><span class="ident" id="3532557">scheme</span><span class="op" id="3532563">]</span><span class="op" id="3532564">;</span>&nbsp;<span class="ident" id="3532566">exists</span>&nbsp;<span class="op" id="3532573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3532577">panic</span><span class="op" id="3532582">(</span><span class="string" id="3532583">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3532595">+</span>&nbsp;<span class="ident" id="3532597">scheme</span>&nbsp;<span class="op" id="3532604">+</span>&nbsp;<span class="string" id="3532606">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3532627">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3532630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532633">t</span><span class="op" id="3532634">.</span><span class="ident" id="3532635">altProto</span><span class="op" id="3532643">[</span><span class="ident" id="3532644">scheme</span><span class="op" id="3532650">]</span>&nbsp;<span class="op" id="3532652">=</span>&nbsp;<span class="ident" id="3532654">rt</span><br>
<span class="lineno"></span><span class="op" id="3532657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3532660">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3532729">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3532793">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3532866">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3532877">func</span>&nbsp;<span class="op" id="3532882">(</span><span class="ident" id="3532883">t</span>&nbsp;<span class="op" id="3532885">*</span><span class="ident" id="3532886">Transport</span><span class="op" id="3532895">)</span>&nbsp;<span class="ident" id="3532897">CloseIdleConnections</span><span class="op" id="3532917">(</span><span class="op" id="3532918">)</span>&nbsp;<span class="op" id="3532920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532923">t</span><span class="op" id="3532924">.</span><span class="ident" id="3532925">idleMu</span><span class="op" id="3532931">.</span><span class="ident" id="3532932">Lock</span><span class="op" id="3532936">(</span><span class="op" id="3532937">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532940">m</span>&nbsp;<span class="op" id="3532942">:=</span>&nbsp;<span class="ident" id="3532945">t</span><span class="op" id="3532946">.</span><span class="ident" id="3532947">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532957">t</span><span class="op" id="3532958">.</span><span class="ident" id="3532959">idleConn</span>&nbsp;<span class="op" id="3532968">=</span>&nbsp;<span class="ident" id="3532970">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532975">t</span><span class="op" id="3532976">.</span><span class="ident" id="3532977">idleConnCh</span>&nbsp;<span class="op" id="3532988">=</span>&nbsp;<span class="ident" id="3532990">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3532995">t</span><span class="op" id="3532996">.</span><span class="ident" id="3532997">wantIdle</span>&nbsp;<span class="op" id="3533006">=</span>&nbsp;<span class="builtintype" id="3533008">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533014">t</span><span class="op" id="3533015">.</span><span class="ident" id="3533016">idleMu</span><span class="op" id="3533022">.</span><span class="ident" id="3533023">Unlock</span><span class="op" id="3533029">(</span><span class="op" id="3533030">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533033">for</span>&nbsp;<span class="ident" id="3533037">_</span><span class="op" id="3533038">,</span>&nbsp;<span class="ident" id="3533040">conns</span>&nbsp;<span class="op" id="3533046">:=</span>&nbsp;<span class="keyword" id="3533049">range</span>&nbsp;<span class="ident" id="3533055">m</span>&nbsp;<span class="op" id="3533057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533061">for</span>&nbsp;<span class="ident" id="3533065">_</span><span class="op" id="3533066">,</span>&nbsp;<span class="ident" id="3533068">pconn</span>&nbsp;<span class="op" id="3533074">:=</span>&nbsp;<span class="keyword" id="3533077">range</span>&nbsp;<span class="ident" id="3533083">conns</span>&nbsp;<span class="op" id="3533089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533094">pconn</span><span class="op" id="3533099">.</span><span class="builtinfunc" id="3533100">close</span><span class="op" id="3533105">(</span><span class="op" id="3533106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533113">}</span><br>
<span class="lineno">275</span><span class="op" id="3533115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533118">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3533179">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3533194">func</span>&nbsp;<span class="op" id="3533199">(</span><span class="ident" id="3533200">t</span>&nbsp;<span class="op" id="3533202">*</span><span class="ident" id="3533203">Transport</span><span class="op" id="3533212">)</span>&nbsp;<span class="ident" id="3533214">CancelRequest</span><span class="op" id="3533227">(</span><span class="ident" id="3533228">req</span>&nbsp;<span class="op" id="3533232">*</span><span class="ident" id="3533233">Request</span><span class="op" id="3533240">)</span>&nbsp;<span class="op" id="3533242">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533245">t</span><span class="op" id="3533246">.</span><span class="ident" id="3533247">reqMu</span><span class="op" id="3533252">.</span><span class="ident" id="3533253">Lock</span><span class="op" id="3533257">(</span><span class="op" id="3533258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533261">cancel</span>&nbsp;<span class="op" id="3533268">:=</span>&nbsp;<span class="ident" id="3533271">t</span><span class="op" id="3533272">.</span><span class="ident" id="3533273">reqCanceler</span><span class="op" id="3533284">[</span><span class="ident" id="3533285">req</span><span class="op" id="3533288">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533291">t</span><span class="op" id="3533292">.</span><span class="ident" id="3533293">reqMu</span><span class="op" id="3533298">.</span><span class="ident" id="3533299">Unlock</span><span class="op" id="3533305">(</span><span class="op" id="3533306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533309">if</span>&nbsp;<span class="ident" id="3533312">cancel</span>&nbsp;<span class="op" id="3533319">!=</span>&nbsp;<span class="ident" id="3533322">nil</span>&nbsp;<span class="op" id="3533326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533330">cancel</span><span class="op" id="3533336">(</span><span class="op" id="3533337">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533340">}</span><br>
<span class="lineno"></span><span class="op" id="3533342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533345">//</span><br>
<span class="lineno"></span><span class="comment" id="3533348">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3533391">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3533395">var</span>&nbsp;<span class="op" id="3533399">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533402">httpProxyEnv</span>&nbsp;<span class="op" id="3533415">=</span>&nbsp;<span class="op" id="3533417">&amp;</span><span class="ident" id="3533418">envOnce</span><span class="op" id="3533425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533429">names</span><span class="op" id="3533434">:</span>&nbsp;<span class="op" id="3533436">[</span><span class="op" id="3533437">]</span><span class="builtintype" id="3533438">string</span><span class="op" id="3533444">{</span><span class="string" id="3533445">&#34;HTTP_PROXY&#34;</span><span class="op" id="3533457">,</span>&nbsp;<span class="string" id="3533459">&#34;http_proxy&#34;</span><span class="op" id="3533471">}</span><span class="op" id="3533472">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533478">httpsProxyEnv</span>&nbsp;<span class="op" id="3533492">=</span>&nbsp;<span class="op" id="3533494">&amp;</span><span class="ident" id="3533495">envOnce</span><span class="op" id="3533502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533506">names</span><span class="op" id="3533511">:</span>&nbsp;<span class="op" id="3533513">[</span><span class="op" id="3533514">]</span><span class="builtintype" id="3533515">string</span><span class="op" id="3533521">{</span><span class="string" id="3533522">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3533535">,</span>&nbsp;<span class="string" id="3533537">&#34;https_proxy&#34;</span><span class="op" id="3533550">}</span><span class="op" id="3533551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533557">noProxyEnv</span>&nbsp;<span class="op" id="3533568">=</span>&nbsp;<span class="op" id="3533570">&amp;</span><span class="ident" id="3533571">envOnce</span><span class="op" id="3533578">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533582">names</span><span class="op" id="3533587">:</span>&nbsp;<span class="op" id="3533589">[</span><span class="op" id="3533590">]</span><span class="builtintype" id="3533591">string</span><span class="op" id="3533597">{</span><span class="string" id="3533598">&#34;NO_PROXY&#34;</span><span class="op" id="3533608">,</span>&nbsp;<span class="string" id="3533610">&#34;no_proxy&#34;</span><span class="op" id="3533620">}</span><span class="op" id="3533621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3533624">}</span><br>
<span class="lineno"></span><span class="op" id="3533626">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3533629">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3533697">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3533762">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3533781">type</span>&nbsp;<span class="ident" id="3533786">envOnce</span>&nbsp;<span class="keyword" id="3533794">struct</span>&nbsp;<span class="op" id="3533801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533804">names</span>&nbsp;<span class="op" id="3533810">[</span><span class="op" id="3533811">]</span><span class="builtintype" id="3533812">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533820">once</span>&nbsp;&nbsp;<span class="ident" id="3533826">sync</span><span class="op" id="3533830">.</span><span class="ident" id="3533831">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533837">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3533843">string</span><br>
<span class="lineno"></span><span class="op" id="3533850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3533853">func</span>&nbsp;<span class="op" id="3533858">(</span><span class="ident" id="3533859">e</span>&nbsp;<span class="op" id="3533861">*</span><span class="ident" id="3533862">envOnce</span><span class="op" id="3533869">)</span>&nbsp;<span class="ident" id="3533871">Get</span><span class="op" id="3533874">(</span><span class="op" id="3533875">)</span>&nbsp;<span class="builtintype" id="3533877">string</span>&nbsp;<span class="op" id="3533884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533887">e</span><span class="op" id="3533888">.</span><span class="ident" id="3533889">once</span><span class="op" id="3533893">.</span><span class="ident" id="3533894">Do</span><span class="op" id="3533896">(</span><span class="ident" id="3533897">e</span><span class="op" id="3533898">.</span><span class="ident" id="3533899">init</span><span class="op" id="3533903">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533906">return</span>&nbsp;<span class="ident" id="3533913">e</span><span class="op" id="3533914">.</span><span class="ident" id="3533915">val</span><br>
<span class="lineno"></span><span class="op" id="3533919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3533922">func</span>&nbsp;<span class="op" id="3533927">(</span><span class="ident" id="3533928">e</span>&nbsp;<span class="op" id="3533930">*</span><span class="ident" id="3533931">envOnce</span><span class="op" id="3533938">)</span>&nbsp;<span class="ident" id="3533940">init</span><span class="op" id="3533944">(</span><span class="op" id="3533945">)</span>&nbsp;<span class="op" id="3533947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3533950">for</span>&nbsp;<span class="ident" id="3533954">_</span><span class="op" id="3533955">,</span>&nbsp;<span class="ident" id="3533957">n</span>&nbsp;<span class="op" id="3533959">:=</span>&nbsp;<span class="keyword" id="3533962">range</span>&nbsp;<span class="ident" id="3533968">e</span><span class="op" id="3533969">.</span><span class="ident" id="3533970">names</span>&nbsp;<span class="op" id="3533976">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3533980">e</span><span class="op" id="3533981">.</span><span class="ident" id="3533982">val</span>&nbsp;<span class="op" id="3533986">=</span>&nbsp;<span class="ident" id="3533988">os</span><span class="op" id="3533990">.</span><span class="ident" id="3533991">Getenv</span><span class="op" id="3533997">(</span><span class="ident" id="3533998">n</span><span class="op" id="3533999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534003">if</span>&nbsp;<span class="ident" id="3534006">e</span><span class="op" id="3534007">.</span><span class="ident" id="3534008">val</span>&nbsp;<span class="op" id="3534012">!=</span>&nbsp;<span class="string" id="3534015">&#34;&#34;</span>&nbsp;<span class="op" id="3534018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534023">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534035">}</span><br>
<span class="lineno">325</span><span class="op" id="3534037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534040">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3534066">func</span>&nbsp;<span class="op" id="3534071">(</span><span class="ident" id="3534072">e</span>&nbsp;<span class="op" id="3534074">*</span><span class="ident" id="3534075">envOnce</span><span class="op" id="3534082">)</span>&nbsp;<span class="ident" id="3534084">reset</span><span class="op" id="3534089">(</span><span class="op" id="3534090">)</span>&nbsp;<span class="op" id="3534092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534095">e</span><span class="op" id="3534096">.</span><span class="ident" id="3534097">once</span>&nbsp;<span class="op" id="3534102">=</span>&nbsp;<span class="ident" id="3534104">sync</span><span class="op" id="3534108">.</span><span class="ident" id="3534109">Once</span><span class="op" id="3534113">{</span><span class="op" id="3534114">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534117">e</span><span class="op" id="3534118">.</span><span class="ident" id="3534119">val</span>&nbsp;<span class="op" id="3534123">=</span>&nbsp;<span class="string" id="3534125">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3534128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3534131">func</span>&nbsp;<span class="op" id="3534136">(</span><span class="ident" id="3534137">t</span>&nbsp;<span class="op" id="3534139">*</span><span class="ident" id="3534140">Transport</span><span class="op" id="3534149">)</span>&nbsp;<span class="ident" id="3534151">connectMethodForRequest</span><span class="op" id="3534174">(</span><span class="ident" id="3534175">treq</span>&nbsp;<span class="op" id="3534180">*</span><span class="ident" id="3534181">transportRequest</span><span class="op" id="3534197">)</span>&nbsp;<span class="op" id="3534199">(</span><span class="ident" id="3534200">cm</span>&nbsp;<span class="ident" id="3534203">connectMethod</span><span class="op" id="3534216">,</span>&nbsp;<span class="ident" id="3534218">err</span>&nbsp;<span class="builtintype" id="3534222">error</span><span class="op" id="3534227">)</span>&nbsp;<span class="op" id="3534229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534232">cm</span><span class="op" id="3534234">.</span><span class="ident" id="3534235">targetScheme</span>&nbsp;<span class="op" id="3534248">=</span>&nbsp;<span class="ident" id="3534250">treq</span><span class="op" id="3534254">.</span><span class="ident" id="3534255">URL</span><span class="op" id="3534258">.</span><span class="ident" id="3534259">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534267">cm</span><span class="op" id="3534269">.</span><span class="ident" id="3534270">targetAddr</span>&nbsp;<span class="op" id="3534281">=</span>&nbsp;<span class="ident" id="3534283">canonicalAddr</span><span class="op" id="3534296">(</span><span class="ident" id="3534297">treq</span><span class="op" id="3534301">.</span><span class="ident" id="3534302">URL</span><span class="op" id="3534305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534308">if</span>&nbsp;<span class="ident" id="3534311">t</span><span class="op" id="3534312">.</span><span class="ident" id="3534313">Proxy</span>&nbsp;<span class="op" id="3534319">!=</span>&nbsp;<span class="ident" id="3534322">nil</span>&nbsp;<span class="op" id="3534326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534330">cm</span><span class="op" id="3534332">.</span><span class="ident" id="3534333">proxyURL</span><span class="op" id="3534341">,</span>&nbsp;<span class="ident" id="3534343">err</span>&nbsp;<span class="op" id="3534347">=</span>&nbsp;<span class="ident" id="3534349">t</span><span class="op" id="3534350">.</span><span class="ident" id="3534351">Proxy</span><span class="op" id="3534356">(</span><span class="ident" id="3534357">treq</span><span class="op" id="3534361">.</span><span class="ident" id="3534362">Request</span><span class="op" id="3534369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534375">return</span>&nbsp;<span class="ident" id="3534382">cm</span><span class="op" id="3534384">,</span>&nbsp;<span class="ident" id="3534386">err</span><br>
<span class="lineno">340</span><span class="op" id="3534390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3534393">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3534452">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3534483">func</span>&nbsp;<span class="op" id="3534488">(</span><span class="ident" id="3534489">cm</span>&nbsp;<span class="op" id="3534492">*</span><span class="ident" id="3534493">connectMethod</span><span class="op" id="3534506">)</span>&nbsp;<span class="ident" id="3534508">proxyAuth</span><span class="op" id="3534517">(</span><span class="op" id="3534518">)</span>&nbsp;<span class="builtintype" id="3534520">string</span>&nbsp;<span class="op" id="3534527">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534530">if</span>&nbsp;<span class="ident" id="3534533">cm</span><span class="op" id="3534535">.</span><span class="ident" id="3534536">proxyURL</span>&nbsp;<span class="op" id="3534545">==</span>&nbsp;<span class="ident" id="3534548">nil</span>&nbsp;<span class="op" id="3534552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534556">return</span>&nbsp;<span class="string" id="3534563">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534570">if</span>&nbsp;<span class="ident" id="3534573">u</span>&nbsp;<span class="op" id="3534575">:=</span>&nbsp;<span class="ident" id="3534578">cm</span><span class="op" id="3534580">.</span><span class="ident" id="3534581">proxyURL</span><span class="op" id="3534589">.</span><span class="ident" id="3534590">User</span><span class="op" id="3534594">;</span>&nbsp;<span class="ident" id="3534596">u</span>&nbsp;<span class="op" id="3534598">!=</span>&nbsp;<span class="ident" id="3534601">nil</span>&nbsp;<span class="op" id="3534605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534609">username</span>&nbsp;<span class="op" id="3534618">:=</span>&nbsp;<span class="ident" id="3534621">u</span><span class="op" id="3534622">.</span><span class="ident" id="3534623">Username</span><span class="op" id="3534631">(</span><span class="op" id="3534632">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3534636">password</span><span class="op" id="3534644">,</span>&nbsp;<span class="ident" id="3534646">_</span>&nbsp;<span class="op" id="3534648">:=</span>&nbsp;<span class="ident" id="3534651">u</span><span class="op" id="3534652">.</span><span class="ident" id="3534653">Password</span><span class="op" id="3534661">(</span><span class="op" id="3534662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534666">return</span>&nbsp;<span class="string" id="3534673">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3534682">+</span>&nbsp;<span class="ident" id="3534684">basicAuth</span><span class="op" id="3534693">(</span><span class="ident" id="3534694">username</span><span class="op" id="3534702">,</span>&nbsp;<span class="ident" id="3534704">password</span><span class="op" id="3534712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3534715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534718">return</span>&nbsp;<span class="string" id="3534725">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3534728">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3534731">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3534809">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3534827">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3534895">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3534913">func</span>&nbsp;<span class="op" id="3534918">(</span><span class="ident" id="3534919">t</span>&nbsp;<span class="op" id="3534921">*</span><span class="ident" id="3534922">Transport</span><span class="op" id="3534931">)</span>&nbsp;<span class="ident" id="3534933">putIdleConn</span><span class="op" id="3534944">(</span><span class="ident" id="3534945">pconn</span>&nbsp;<span class="op" id="3534951">*</span><span class="ident" id="3534952">persistConn</span><span class="op" id="3534963">)</span>&nbsp;<span class="builtintype" id="3534965">bool</span>&nbsp;<span class="op" id="3534970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3534973">if</span>&nbsp;<span class="ident" id="3534976">t</span><span class="op" id="3534977">.</span><span class="ident" id="3534978">DisableKeepAlives</span>&nbsp;<span class="op" id="3534996">||</span>&nbsp;<span class="ident" id="3534999">t</span><span class="op" id="3535000">.</span><span class="ident" id="3535001">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3535021">&lt;</span>&nbsp;<span class="num" id="3535023">0</span>&nbsp;<span class="op" id="3535025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535029">pconn</span><span class="op" id="3535034">.</span><span class="builtinfunc" id="3535035">close</span><span class="op" id="3535040">(</span><span class="op" id="3535041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535045">return</span>&nbsp;<span class="builtintype" id="3535052">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535059">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535062">if</span>&nbsp;<span class="ident" id="3535065">pconn</span><span class="op" id="3535070">.</span><span class="ident" id="3535071">isBroken</span><span class="op" id="3535079">(</span><span class="op" id="3535080">)</span>&nbsp;<span class="op" id="3535082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535086">return</span>&nbsp;<span class="builtintype" id="3535093">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535103">key</span>&nbsp;<span class="op" id="3535107">:=</span>&nbsp;<span class="ident" id="3535110">pconn</span><span class="op" id="3535115">.</span><span class="ident" id="3535116">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535126">max</span>&nbsp;<span class="op" id="3535130">:=</span>&nbsp;<span class="ident" id="3535133">t</span><span class="op" id="3535134">.</span><span class="ident" id="3535135">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535156">if</span>&nbsp;<span class="ident" id="3535159">max</span>&nbsp;<span class="op" id="3535163">==</span>&nbsp;<span class="num" id="3535166">0</span>&nbsp;<span class="op" id="3535168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535172">max</span>&nbsp;<span class="op" id="3535176">=</span>&nbsp;<span class="ident" id="3535178">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535209">t</span><span class="op" id="3535210">.</span><span class="ident" id="3535211">idleMu</span><span class="op" id="3535217">.</span><span class="ident" id="3535218">Lock</span><span class="op" id="3535222">(</span><span class="op" id="3535223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535227">waitingDialer</span>&nbsp;<span class="op" id="3535241">:=</span>&nbsp;<span class="ident" id="3535244">t</span><span class="op" id="3535245">.</span><span class="ident" id="3535246">idleConnCh</span><span class="op" id="3535256">[</span><span class="ident" id="3535257">key</span><span class="op" id="3535260">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535263">select</span>&nbsp;<span class="op" id="3535270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535273">case</span>&nbsp;<span class="ident" id="3535278">waitingDialer</span>&nbsp;<span class="op" id="3535292">&lt;-</span>&nbsp;<span class="ident" id="3535295">pconn</span><span class="op" id="3535300">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535304">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535357">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535413">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535459">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535516">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535584">t</span><span class="op" id="3535585">.</span><span class="ident" id="3535586">idleMu</span><span class="op" id="3535592">.</span><span class="ident" id="3535593">Unlock</span><span class="op" id="3535599">(</span><span class="op" id="3535600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535604">return</span>&nbsp;<span class="builtintype" id="3535611">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535617">default</span><span class="op" id="3535624">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535628">if</span>&nbsp;<span class="ident" id="3535631">waitingDialer</span>&nbsp;<span class="op" id="3535645">!=</span>&nbsp;<span class="ident" id="3535648">nil</span>&nbsp;<span class="op" id="3535652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535657">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3535707">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3535755">delete</span><span class="op" id="3535761">(</span><span class="ident" id="3535762">t</span><span class="op" id="3535763">.</span><span class="ident" id="3535764">idleConnCh</span><span class="op" id="3535774">,</span>&nbsp;<span class="ident" id="3535776">key</span><span class="op" id="3535779">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535789">if</span>&nbsp;<span class="ident" id="3535792">t</span><span class="op" id="3535793">.</span><span class="ident" id="3535794">wantIdle</span>&nbsp;<span class="op" id="3535803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535807">t</span><span class="op" id="3535808">.</span><span class="ident" id="3535809">idleMu</span><span class="op" id="3535815">.</span><span class="ident" id="3535816">Unlock</span><span class="op" id="3535822">(</span><span class="op" id="3535823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535827">pconn</span><span class="op" id="3535832">.</span><span class="builtinfunc" id="3535833">close</span><span class="op" id="3535838">(</span><span class="op" id="3535839">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535843">return</span>&nbsp;<span class="builtintype" id="3535850">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535860">if</span>&nbsp;<span class="ident" id="3535863">t</span><span class="op" id="3535864">.</span><span class="ident" id="3535865">idleConn</span>&nbsp;<span class="op" id="3535874">==</span>&nbsp;<span class="ident" id="3535877">nil</span>&nbsp;<span class="op" id="3535881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535885">t</span><span class="op" id="3535886">.</span><span class="ident" id="3535887">idleConn</span>&nbsp;<span class="op" id="3535896">=</span>&nbsp;<span class="builtinfunc" id="3535898">make</span><span class="op" id="3535902">(</span><span class="keyword" id="3535903">map</span><span class="op" id="3535906">[</span><span class="ident" id="3535907">connectMethodKey</span><span class="op" id="3535923">]</span><span class="op" id="3535924">[</span><span class="op" id="3535925">]</span><span class="op" id="3535926">*</span><span class="ident" id="3535927">persistConn</span><span class="op" id="3535938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3535941">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3535944">if</span>&nbsp;<span class="builtinfunc" id="3535947">len</span><span class="op" id="3535950">(</span><span class="ident" id="3535951">t</span><span class="op" id="3535952">.</span><span class="ident" id="3535953">idleConn</span><span class="op" id="3535961">[</span><span class="ident" id="3535962">key</span><span class="op" id="3535965">]</span><span class="op" id="3535966">)</span>&nbsp;<span class="op" id="3535968">&gt;=</span>&nbsp;<span class="ident" id="3535971">max</span>&nbsp;<span class="op" id="3535975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535979">t</span><span class="op" id="3535980">.</span><span class="ident" id="3535981">idleMu</span><span class="op" id="3535987">.</span><span class="ident" id="3535988">Unlock</span><span class="op" id="3535994">(</span><span class="op" id="3535995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3535999">pconn</span><span class="op" id="3536004">.</span><span class="builtinfunc" id="3536005">close</span><span class="op" id="3536010">(</span><span class="op" id="3536011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536015">return</span>&nbsp;<span class="builtintype" id="3536022">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536029">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536032">for</span>&nbsp;<span class="ident" id="3536036">_</span><span class="op" id="3536037">,</span>&nbsp;<span class="ident" id="3536039">exist</span>&nbsp;<span class="op" id="3536045">:=</span>&nbsp;<span class="keyword" id="3536048">range</span>&nbsp;<span class="ident" id="3536054">t</span><span class="op" id="3536055">.</span><span class="ident" id="3536056">idleConn</span><span class="op" id="3536064">[</span><span class="ident" id="3536065">key</span><span class="op" id="3536068">]</span>&nbsp;<span class="op" id="3536070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536074">if</span>&nbsp;<span class="ident" id="3536077">exist</span>&nbsp;<span class="op" id="3536083">==</span>&nbsp;<span class="ident" id="3536086">pconn</span>&nbsp;<span class="op" id="3536092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536097">log</span><span class="op" id="3536100">.</span><span class="ident" id="3536101">Fatalf</span><span class="op" id="3536107">(</span><span class="string" id="3536108">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3536139">,</span>&nbsp;<span class="ident" id="3536141">pconn</span><span class="op" id="3536146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536153">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536156">t</span><span class="op" id="3536157">.</span><span class="ident" id="3536158">idleConn</span><span class="op" id="3536166">[</span><span class="ident" id="3536167">key</span><span class="op" id="3536170">]</span>&nbsp;<span class="op" id="3536172">=</span>&nbsp;<span class="builtinfunc" id="3536174">append</span><span class="op" id="3536180">(</span><span class="ident" id="3536181">t</span><span class="op" id="3536182">.</span><span class="ident" id="3536183">idleConn</span><span class="op" id="3536191">[</span><span class="ident" id="3536192">key</span><span class="op" id="3536195">]</span><span class="op" id="3536196">,</span>&nbsp;<span class="ident" id="3536198">pconn</span><span class="op" id="3536203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536206">t</span><span class="op" id="3536207">.</span><span class="ident" id="3536208">idleMu</span><span class="op" id="3536214">.</span><span class="ident" id="3536215">Unlock</span><span class="op" id="3536221">(</span><span class="op" id="3536222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536225">return</span>&nbsp;<span class="builtintype" id="3536232">true</span><br>
<span class="lineno"></span><span class="op" id="3536237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3536240">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3536302">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3536356">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3536424">func</span>&nbsp;<span class="op" id="3536429">(</span><span class="ident" id="3536430">t</span>&nbsp;<span class="op" id="3536432">*</span><span class="ident" id="3536433">Transport</span><span class="op" id="3536442">)</span>&nbsp;<span class="ident" id="3536444">getIdleConnCh</span><span class="op" id="3536457">(</span><span class="ident" id="3536458">cm</span>&nbsp;<span class="ident" id="3536461">connectMethod</span><span class="op" id="3536474">)</span>&nbsp;<span class="keyword" id="3536476">chan</span>&nbsp;<span class="op" id="3536481">*</span><span class="ident" id="3536482">persistConn</span>&nbsp;<span class="op" id="3536494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536497">if</span>&nbsp;<span class="ident" id="3536500">t</span><span class="op" id="3536501">.</span><span class="ident" id="3536502">DisableKeepAlives</span>&nbsp;<span class="op" id="3536520">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536524">return</span>&nbsp;<span class="ident" id="3536531">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536539">key</span>&nbsp;<span class="op" id="3536543">:=</span>&nbsp;<span class="ident" id="3536546">cm</span><span class="op" id="3536548">.</span><span class="ident" id="3536549">key</span><span class="op" id="3536552">(</span><span class="op" id="3536553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536556">t</span><span class="op" id="3536557">.</span><span class="ident" id="3536558">idleMu</span><span class="op" id="3536564">.</span><span class="ident" id="3536565">Lock</span><span class="op" id="3536569">(</span><span class="op" id="3536570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536573">defer</span>&nbsp;<span class="ident" id="3536579">t</span><span class="op" id="3536580">.</span><span class="ident" id="3536581">idleMu</span><span class="op" id="3536587">.</span><span class="ident" id="3536588">Unlock</span><span class="op" id="3536594">(</span><span class="op" id="3536595">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536598">t</span><span class="op" id="3536599">.</span><span class="ident" id="3536600">wantIdle</span>&nbsp;<span class="op" id="3536609">=</span>&nbsp;<span class="builtintype" id="3536611">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536618">if</span>&nbsp;<span class="ident" id="3536621">t</span><span class="op" id="3536622">.</span><span class="ident" id="3536623">idleConnCh</span>&nbsp;<span class="op" id="3536634">==</span>&nbsp;<span class="ident" id="3536637">nil</span>&nbsp;<span class="op" id="3536641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536645">t</span><span class="op" id="3536646">.</span><span class="ident" id="3536647">idleConnCh</span>&nbsp;<span class="op" id="3536658">=</span>&nbsp;<span class="builtinfunc" id="3536660">make</span><span class="op" id="3536664">(</span><span class="keyword" id="3536665">map</span><span class="op" id="3536668">[</span><span class="ident" id="3536669">connectMethodKey</span><span class="op" id="3536685">]</span><span class="keyword" id="3536686">chan</span>&nbsp;<span class="op" id="3536691">*</span><span class="ident" id="3536692">persistConn</span><span class="op" id="3536703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536709">ch</span><span class="op" id="3536711">,</span>&nbsp;<span class="ident" id="3536713">ok</span>&nbsp;<span class="op" id="3536716">:=</span>&nbsp;<span class="ident" id="3536719">t</span><span class="op" id="3536720">.</span><span class="ident" id="3536721">idleConnCh</span><span class="op" id="3536731">[</span><span class="ident" id="3536732">key</span><span class="op" id="3536735">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536738">if</span>&nbsp;<span class="op" id="3536741">!</span><span class="ident" id="3536742">ok</span>&nbsp;<span class="op" id="3536745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536749">ch</span>&nbsp;<span class="op" id="3536752">=</span>&nbsp;<span class="builtinfunc" id="3536754">make</span><span class="op" id="3536758">(</span><span class="keyword" id="3536759">chan</span>&nbsp;<span class="op" id="3536764">*</span><span class="ident" id="3536765">persistConn</span><span class="op" id="3536776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536780">t</span><span class="op" id="3536781">.</span><span class="ident" id="3536782">idleConnCh</span><span class="op" id="3536792">[</span><span class="ident" id="3536793">key</span><span class="op" id="3536796">]</span>&nbsp;<span class="op" id="3536798">=</span>&nbsp;<span class="ident" id="3536800">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536807">return</span>&nbsp;<span class="ident" id="3536814">ch</span><br>
<span class="lineno">435</span><span class="op" id="3536817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3536820">func</span>&nbsp;<span class="op" id="3536825">(</span><span class="ident" id="3536826">t</span>&nbsp;<span class="op" id="3536828">*</span><span class="ident" id="3536829">Transport</span><span class="op" id="3536838">)</span>&nbsp;<span class="ident" id="3536840">getIdleConn</span><span class="op" id="3536851">(</span><span class="ident" id="3536852">cm</span>&nbsp;<span class="ident" id="3536855">connectMethod</span><span class="op" id="3536868">)</span>&nbsp;<span class="op" id="3536870">(</span><span class="ident" id="3536871">pconn</span>&nbsp;<span class="op" id="3536877">*</span><span class="ident" id="3536878">persistConn</span><span class="op" id="3536889">)</span>&nbsp;<span class="op" id="3536891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536894">key</span>&nbsp;<span class="op" id="3536898">:=</span>&nbsp;<span class="ident" id="3536901">cm</span><span class="op" id="3536903">.</span><span class="ident" id="3536904">key</span><span class="op" id="3536907">(</span><span class="op" id="3536908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3536911">t</span><span class="op" id="3536912">.</span><span class="ident" id="3536913">idleMu</span><span class="op" id="3536919">.</span><span class="ident" id="3536920">Lock</span><span class="op" id="3536924">(</span><span class="op" id="3536925">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536928">defer</span>&nbsp;<span class="ident" id="3536934">t</span><span class="op" id="3536935">.</span><span class="ident" id="3536936">idleMu</span><span class="op" id="3536942">.</span><span class="ident" id="3536943">Unlock</span><span class="op" id="3536949">(</span><span class="op" id="3536950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536953">if</span>&nbsp;<span class="ident" id="3536956">t</span><span class="op" id="3536957">.</span><span class="ident" id="3536958">idleConn</span>&nbsp;<span class="op" id="3536967">==</span>&nbsp;<span class="ident" id="3536970">nil</span>&nbsp;<span class="op" id="3536974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536978">return</span>&nbsp;<span class="ident" id="3536985">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3536990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3536993">for</span>&nbsp;<span class="op" id="3536997">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537001">pconns</span><span class="op" id="3537007">,</span>&nbsp;<span class="ident" id="3537009">ok</span>&nbsp;<span class="op" id="3537012">:=</span>&nbsp;<span class="ident" id="3537015">t</span><span class="op" id="3537016">.</span><span class="ident" id="3537017">idleConn</span><span class="op" id="3537025">[</span><span class="ident" id="3537026">key</span><span class="op" id="3537029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537033">if</span>&nbsp;<span class="op" id="3537036">!</span><span class="ident" id="3537037">ok</span>&nbsp;<span class="op" id="3537040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537045">return</span>&nbsp;<span class="ident" id="3537052">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537062">if</span>&nbsp;<span class="builtinfunc" id="3537065">len</span><span class="op" id="3537068">(</span><span class="ident" id="3537069">pconns</span><span class="op" id="3537075">)</span>&nbsp;<span class="op" id="3537077">==</span>&nbsp;<span class="num" id="3537080">1</span>&nbsp;<span class="op" id="3537082">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537087">pconn</span>&nbsp;<span class="op" id="3537093">=</span>&nbsp;<span class="ident" id="3537095">pconns</span><span class="op" id="3537101">[</span><span class="num" id="3537102">0</span><span class="op" id="3537103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3537108">delete</span><span class="op" id="3537114">(</span><span class="ident" id="3537115">t</span><span class="op" id="3537116">.</span><span class="ident" id="3537117">idleConn</span><span class="op" id="3537125">,</span>&nbsp;<span class="ident" id="3537127">key</span><span class="op" id="3537130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537134">}</span>&nbsp;<span class="keyword" id="3537136">else</span>&nbsp;<span class="op" id="3537141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3537146">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3537191">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537210">pconn</span>&nbsp;<span class="op" id="3537216">=</span>&nbsp;<span class="ident" id="3537218">pconns</span><span class="op" id="3537224">[</span><span class="builtinfunc" id="3537225">len</span><span class="op" id="3537228">(</span><span class="ident" id="3537229">pconns</span><span class="op" id="3537235">)</span><span class="op" id="3537236">-</span><span class="num" id="3537237">1</span><span class="op" id="3537238">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537243">t</span><span class="op" id="3537244">.</span><span class="ident" id="3537245">idleConn</span><span class="op" id="3537253">[</span><span class="ident" id="3537254">key</span><span class="op" id="3537257">]</span>&nbsp;<span class="op" id="3537259">=</span>&nbsp;<span class="ident" id="3537261">pconns</span><span class="op" id="3537267">[</span><span class="op" id="3537268">:</span><span class="builtinfunc" id="3537269">len</span><span class="op" id="3537272">(</span><span class="ident" id="3537273">pconns</span><span class="op" id="3537279">)</span><span class="op" id="3537280">-</span><span class="num" id="3537281">1</span><span class="op" id="3537282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537290">if</span>&nbsp;<span class="op" id="3537293">!</span><span class="ident" id="3537294">pconn</span><span class="op" id="3537299">.</span><span class="ident" id="3537300">isBroken</span><span class="op" id="3537308">(</span><span class="op" id="3537309">)</span>&nbsp;<span class="op" id="3537311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537316">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537328">}</span><br>
<span class="lineno"></span><span class="op" id="3537330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3537333">func</span>&nbsp;<span class="op" id="3537338">(</span><span class="ident" id="3537339">t</span>&nbsp;<span class="op" id="3537341">*</span><span class="ident" id="3537342">Transport</span><span class="op" id="3537351">)</span>&nbsp;<span class="ident" id="3537353">setReqCanceler</span><span class="op" id="3537367">(</span><span class="ident" id="3537368">r</span>&nbsp;<span class="op" id="3537370">*</span><span class="ident" id="3537371">Request</span><span class="op" id="3537378">,</span>&nbsp;<span class="ident" id="3537380">fn</span>&nbsp;<span class="keyword" id="3537383">func</span><span class="op" id="3537387">(</span><span class="op" id="3537388">)</span><span class="op" id="3537389">)</span>&nbsp;<span class="op" id="3537391">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537394">t</span><span class="op" id="3537395">.</span><span class="ident" id="3537396">reqMu</span><span class="op" id="3537401">.</span><span class="ident" id="3537402">Lock</span><span class="op" id="3537406">(</span><span class="op" id="3537407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537410">defer</span>&nbsp;<span class="ident" id="3537416">t</span><span class="op" id="3537417">.</span><span class="ident" id="3537418">reqMu</span><span class="op" id="3537423">.</span><span class="ident" id="3537424">Unlock</span><span class="op" id="3537430">(</span><span class="op" id="3537431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537434">if</span>&nbsp;<span class="ident" id="3537437">t</span><span class="op" id="3537438">.</span><span class="ident" id="3537439">reqCanceler</span>&nbsp;<span class="op" id="3537451">==</span>&nbsp;<span class="ident" id="3537454">nil</span>&nbsp;<span class="op" id="3537458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537462">t</span><span class="op" id="3537463">.</span><span class="ident" id="3537464">reqCanceler</span>&nbsp;<span class="op" id="3537476">=</span>&nbsp;<span class="builtinfunc" id="3537478">make</span><span class="op" id="3537482">(</span><span class="keyword" id="3537483">map</span><span class="op" id="3537486">[</span><span class="op" id="3537487">*</span><span class="ident" id="3537488">Request</span><span class="op" id="3537495">]</span><span class="keyword" id="3537496">func</span><span class="op" id="3537500">(</span><span class="op" id="3537501">)</span><span class="op" id="3537502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537505">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537508">if</span>&nbsp;<span class="ident" id="3537511">fn</span>&nbsp;<span class="op" id="3537514">!=</span>&nbsp;<span class="ident" id="3537517">nil</span>&nbsp;<span class="op" id="3537521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3537525">t</span><span class="op" id="3537526">.</span><span class="ident" id="3537527">reqCanceler</span><span class="op" id="3537538">[</span><span class="ident" id="3537539">r</span><span class="op" id="3537540">]</span>&nbsp;<span class="op" id="3537542">=</span>&nbsp;<span class="ident" id="3537544">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537548">}</span>&nbsp;<span class="keyword" id="3537550">else</span>&nbsp;<span class="op" id="3537555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3537559">delete</span><span class="op" id="3537565">(</span><span class="ident" id="3537566">t</span><span class="op" id="3537567">.</span><span class="ident" id="3537568">reqCanceler</span><span class="op" id="3537579">,</span>&nbsp;<span class="ident" id="3537581">r</span><span class="op" id="3537582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537585">}</span><br>
<span class="lineno">475</span><span class="op" id="3537587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3537590">func</span>&nbsp;<span class="op" id="3537595">(</span><span class="ident" id="3537596">t</span>&nbsp;<span class="op" id="3537598">*</span><span class="ident" id="3537599">Transport</span><span class="op" id="3537608">)</span>&nbsp;<span class="ident" id="3537610">dial</span><span class="op" id="3537614">(</span><span class="ident" id="3537615">network</span><span class="op" id="3537622">,</span>&nbsp;<span class="ident" id="3537624">addr</span>&nbsp;<span class="builtintype" id="3537629">string</span><span class="op" id="3537635">)</span>&nbsp;<span class="op" id="3537637">(</span><span class="ident" id="3537638">c</span>&nbsp;<span class="ident" id="3537640">net</span><span class="op" id="3537643">.</span><span class="ident" id="3537644">Conn</span><span class="op" id="3537648">,</span>&nbsp;<span class="ident" id="3537650">err</span>&nbsp;<span class="builtintype" id="3537654">error</span><span class="op" id="3537659">)</span>&nbsp;<span class="op" id="3537661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537664">if</span>&nbsp;<span class="ident" id="3537667">t</span><span class="op" id="3537668">.</span><span class="ident" id="3537669">Dial</span>&nbsp;<span class="op" id="3537674">!=</span>&nbsp;<span class="ident" id="3537677">nil</span>&nbsp;<span class="op" id="3537681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537685">return</span>&nbsp;<span class="ident" id="3537692">t</span><span class="op" id="3537693">.</span><span class="ident" id="3537694">Dial</span><span class="op" id="3537698">(</span><span class="ident" id="3537699">network</span><span class="op" id="3537706">,</span>&nbsp;<span class="ident" id="3537708">addr</span><span class="op" id="3537712">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3537715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3537718">return</span>&nbsp;<span class="ident" id="3537725">net</span><span class="op" id="3537728">.</span><span class="ident" id="3537729">Dial</span><span class="op" id="3537733">(</span><span class="ident" id="3537734">network</span><span class="op" id="3537741">,</span>&nbsp;<span class="ident" id="3537743">addr</span><span class="op" id="3537747">)</span><br>
<span class="lineno"></span><span class="op" id="3537749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3537752">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3537770">var</span>&nbsp;<span class="ident" id="3537774">prePendingDial</span><span class="op" id="3537788">,</span>&nbsp;<span class="ident" id="3537790">postPendingDial</span>&nbsp;<span class="keyword" id="3537806">func</span><span class="op" id="3537810">(</span><span class="op" id="3537811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3537814">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3537878">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3537950">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3538026">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3538060">func</span>&nbsp;<span class="op" id="3538065">(</span><span class="ident" id="3538066">t</span>&nbsp;<span class="op" id="3538068">*</span><span class="ident" id="3538069">Transport</span><span class="op" id="3538078">)</span>&nbsp;<span class="ident" id="3538080">getConn</span><span class="op" id="3538087">(</span><span class="ident" id="3538088">req</span>&nbsp;<span class="op" id="3538092">*</span><span class="ident" id="3538093">Request</span><span class="op" id="3538100">,</span>&nbsp;<span class="ident" id="3538102">cm</span>&nbsp;<span class="ident" id="3538105">connectMethod</span><span class="op" id="3538118">)</span>&nbsp;<span class="op" id="3538120">(</span><span class="op" id="3538121">*</span><span class="ident" id="3538122">persistConn</span><span class="op" id="3538133">,</span>&nbsp;<span class="builtintype" id="3538135">error</span><span class="op" id="3538140">)</span>&nbsp;<span class="op" id="3538142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538145">if</span>&nbsp;<span class="ident" id="3538148">pc</span>&nbsp;<span class="op" id="3538151">:=</span>&nbsp;<span class="ident" id="3538154">t</span><span class="op" id="3538155">.</span><span class="ident" id="3538156">getIdleConn</span><span class="op" id="3538167">(</span><span class="ident" id="3538168">cm</span><span class="op" id="3538170">)</span><span class="op" id="3538171">;</span>&nbsp;<span class="ident" id="3538173">pc</span>&nbsp;<span class="op" id="3538176">!=</span>&nbsp;<span class="ident" id="3538179">nil</span>&nbsp;<span class="op" id="3538183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538187">return</span>&nbsp;<span class="ident" id="3538194">pc</span><span class="op" id="3538196">,</span>&nbsp;<span class="ident" id="3538198">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538203">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538207">type</span>&nbsp;<span class="ident" id="3538212">dialRes</span>&nbsp;<span class="keyword" id="3538220">struct</span>&nbsp;<span class="op" id="3538227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538231">pc</span>&nbsp;&nbsp;<span class="op" id="3538235">*</span><span class="ident" id="3538236">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538250">err</span>&nbsp;<span class="builtintype" id="3538254">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538261">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538264">dialc</span>&nbsp;<span class="op" id="3538270">:=</span>&nbsp;<span class="builtinfunc" id="3538273">make</span><span class="op" id="3538277">(</span><span class="keyword" id="3538278">chan</span>&nbsp;<span class="ident" id="3538283">dialRes</span><span class="op" id="3538290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538294">handlePendingDial</span>&nbsp;<span class="op" id="3538312">:=</span>&nbsp;<span class="keyword" id="3538315">func</span><span class="op" id="3538319">(</span><span class="op" id="3538320">)</span>&nbsp;<span class="op" id="3538322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538326">if</span>&nbsp;<span class="ident" id="3538329">prePendingDial</span>&nbsp;<span class="op" id="3538344">!=</span>&nbsp;<span class="ident" id="3538347">nil</span>&nbsp;<span class="op" id="3538351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538356">prePendingDial</span><span class="op" id="3538370">(</span><span class="op" id="3538371">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538379">go</span>&nbsp;<span class="keyword" id="3538382">func</span><span class="op" id="3538386">(</span><span class="op" id="3538387">)</span>&nbsp;<span class="op" id="3538389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538394">if</span>&nbsp;<span class="ident" id="3538397">v</span>&nbsp;<span class="op" id="3538399">:=</span>&nbsp;<span class="op" id="3538402">&lt;-</span><span class="ident" id="3538404">dialc</span><span class="op" id="3538409">;</span>&nbsp;<span class="ident" id="3538411">v</span><span class="op" id="3538412">.</span><span class="ident" id="3538413">err</span>&nbsp;<span class="op" id="3538417">==</span>&nbsp;<span class="ident" id="3538420">nil</span>&nbsp;<span class="op" id="3538424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538430">t</span><span class="op" id="3538431">.</span><span class="ident" id="3538432">putIdleConn</span><span class="op" id="3538443">(</span><span class="ident" id="3538444">v</span><span class="op" id="3538445">.</span><span class="ident" id="3538446">pc</span><span class="op" id="3538448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538453">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538458">if</span>&nbsp;<span class="ident" id="3538461">postPendingDial</span>&nbsp;<span class="op" id="3538477">!=</span>&nbsp;<span class="ident" id="3538480">nil</span>&nbsp;<span class="op" id="3538484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538490">postPendingDial</span><span class="op" id="3538505">(</span><span class="op" id="3538506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538515">}</span><span class="op" id="3538516">(</span><span class="op" id="3538517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538520">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538524">cancelc</span>&nbsp;<span class="op" id="3538532">:=</span>&nbsp;<span class="builtinfunc" id="3538535">make</span><span class="op" id="3538539">(</span><span class="keyword" id="3538540">chan</span>&nbsp;<span class="keyword" id="3538545">struct</span><span class="op" id="3538551">{</span><span class="op" id="3538552">}</span><span class="op" id="3538553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538556">t</span><span class="op" id="3538557">.</span><span class="ident" id="3538558">setReqCanceler</span><span class="op" id="3538572">(</span><span class="ident" id="3538573">req</span><span class="op" id="3538576">,</span>&nbsp;<span class="keyword" id="3538578">func</span><span class="op" id="3538582">(</span><span class="op" id="3538583">)</span>&nbsp;<span class="op" id="3538585">{</span>&nbsp;<span class="builtinfunc" id="3538587">close</span><span class="op" id="3538592">(</span><span class="ident" id="3538593">cancelc</span><span class="op" id="3538600">)</span>&nbsp;<span class="op" id="3538602">}</span><span class="op" id="3538603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538607">go</span>&nbsp;<span class="keyword" id="3538610">func</span><span class="op" id="3538614">(</span><span class="op" id="3538615">)</span>&nbsp;<span class="op" id="3538617">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538621">pc</span><span class="op" id="3538623">,</span>&nbsp;<span class="ident" id="3538625">err</span>&nbsp;<span class="op" id="3538629">:=</span>&nbsp;<span class="ident" id="3538632">t</span><span class="op" id="3538633">.</span><span class="ident" id="3538634">dialConn</span><span class="op" id="3538642">(</span><span class="ident" id="3538643">cm</span><span class="op" id="3538645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538649">dialc</span>&nbsp;<span class="op" id="3538655">&lt;-</span>&nbsp;<span class="ident" id="3538658">dialRes</span><span class="op" id="3538665">{</span><span class="ident" id="3538666">pc</span><span class="op" id="3538668">,</span>&nbsp;<span class="ident" id="3538670">err</span><span class="op" id="3538673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3538676">}</span><span class="op" id="3538677">(</span><span class="op" id="3538678">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3538682">idleConnCh</span>&nbsp;<span class="op" id="3538693">:=</span>&nbsp;<span class="ident" id="3538696">t</span><span class="op" id="3538697">.</span><span class="ident" id="3538698">getIdleConnCh</span><span class="op" id="3538711">(</span><span class="ident" id="3538712">cm</span><span class="op" id="3538714">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538717">select</span>&nbsp;<span class="op" id="3538724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538727">case</span>&nbsp;<span class="ident" id="3538732">v</span>&nbsp;<span class="op" id="3538734">:=</span>&nbsp;<span class="op" id="3538737">&lt;-</span><span class="ident" id="3538739">dialc</span><span class="op" id="3538744">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3538748">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538772">return</span>&nbsp;<span class="ident" id="3538779">v</span><span class="op" id="3538780">.</span><span class="ident" id="3538781">pc</span><span class="op" id="3538783">,</span>&nbsp;<span class="ident" id="3538785">v</span><span class="op" id="3538786">.</span><span class="ident" id="3538787">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3538792">case</span>&nbsp;<span class="ident" id="3538797">pc</span>&nbsp;<span class="op" id="3538800">:=</span>&nbsp;<span class="op" id="3538803">&lt;-</span><span class="ident" id="3538805">idleConnCh</span><span class="op" id="3538815">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3538819">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3538872">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3538923">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3538962">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3539012">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539035">handlePendingDial</span><span class="op" id="3539052">(</span><span class="op" id="3539053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539057">return</span>&nbsp;<span class="ident" id="3539064">pc</span><span class="op" id="3539066">,</span>&nbsp;<span class="ident" id="3539068">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539073">case</span>&nbsp;<span class="op" id="3539078">&lt;-</span><span class="ident" id="3539080">cancelc</span><span class="op" id="3539087">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539091">handlePendingDial</span><span class="op" id="3539108">(</span><span class="op" id="3539109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539113">return</span>&nbsp;<span class="ident" id="3539120">nil</span><span class="op" id="3539123">,</span>&nbsp;<span class="ident" id="3539125">errors</span><span class="op" id="3539131">.</span><span class="ident" id="3539132">New</span><span class="op" id="3539135">(</span><span class="string" id="3539136">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3539193">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539196">}</span><br>
<span class="lineno"></span><span class="op" id="3539198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3539201">func</span>&nbsp;<span class="op" id="3539206">(</span><span class="ident" id="3539207">t</span>&nbsp;<span class="op" id="3539209">*</span><span class="ident" id="3539210">Transport</span><span class="op" id="3539219">)</span>&nbsp;<span class="ident" id="3539221">dialConn</span><span class="op" id="3539229">(</span><span class="ident" id="3539230">cm</span>&nbsp;<span class="ident" id="3539233">connectMethod</span><span class="op" id="3539246">)</span>&nbsp;<span class="op" id="3539248">(</span><span class="op" id="3539249">*</span><span class="ident" id="3539250">persistConn</span><span class="op" id="3539261">,</span>&nbsp;<span class="builtintype" id="3539263">error</span><span class="op" id="3539268">)</span>&nbsp;<span class="op" id="3539270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539273">pconn</span>&nbsp;<span class="op" id="3539279">:=</span>&nbsp;<span class="op" id="3539282">&amp;</span><span class="ident" id="3539283">persistConn</span><span class="op" id="3539294">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539298">t</span><span class="op" id="3539299">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3539310">t</span><span class="op" id="3539311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539315">cacheKey</span><span class="op" id="3539323">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3539327">cm</span><span class="op" id="3539329">.</span><span class="ident" id="3539330">key</span><span class="op" id="3539333">(</span><span class="op" id="3539334">)</span><span class="op" id="3539335">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539339">reqch</span><span class="op" id="3539344">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3539351">make</span><span class="op" id="3539355">(</span><span class="keyword" id="3539356">chan</span>&nbsp;<span class="ident" id="3539361">requestAndChan</span><span class="op" id="3539375">,</span>&nbsp;<span class="num" id="3539377">1</span><span class="op" id="3539378">)</span><span class="op" id="3539379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539383">writech</span><span class="op" id="3539390">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3539395">make</span><span class="op" id="3539399">(</span><span class="keyword" id="3539400">chan</span>&nbsp;<span class="ident" id="3539405">writeRequest</span><span class="op" id="3539417">,</span>&nbsp;<span class="num" id="3539419">1</span><span class="op" id="3539420">)</span><span class="op" id="3539421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539425">closech</span><span class="op" id="3539432">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3539437">make</span><span class="op" id="3539441">(</span><span class="keyword" id="3539442">chan</span>&nbsp;<span class="keyword" id="3539447">struct</span><span class="op" id="3539453">{</span><span class="op" id="3539454">}</span><span class="op" id="3539455">)</span><span class="op" id="3539456">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539460">writeErrCh</span><span class="op" id="3539470">:</span>&nbsp;<span class="builtinfunc" id="3539472">make</span><span class="op" id="3539476">(</span><span class="keyword" id="3539477">chan</span>&nbsp;<span class="builtintype" id="3539482">error</span><span class="op" id="3539487">,</span>&nbsp;<span class="num" id="3539489">1</span><span class="op" id="3539490">)</span><span class="op" id="3539491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539497">tlsDial</span>&nbsp;<span class="op" id="3539505">:=</span>&nbsp;<span class="ident" id="3539508">t</span><span class="op" id="3539509">.</span><span class="ident" id="3539510">DialTLS</span>&nbsp;<span class="op" id="3539518">!=</span>&nbsp;<span class="ident" id="3539521">nil</span>&nbsp;<span class="op" id="3539525">&amp;&amp;</span>&nbsp;<span class="ident" id="3539528">cm</span><span class="op" id="3539530">.</span><span class="ident" id="3539531">targetScheme</span>&nbsp;<span class="op" id="3539544">==</span>&nbsp;<span class="string" id="3539547">&#34;https&#34;</span>&nbsp;<span class="op" id="3539555">&amp;&amp;</span>&nbsp;<span class="ident" id="3539558">cm</span><span class="op" id="3539560">.</span><span class="ident" id="3539561">proxyURL</span>&nbsp;<span class="op" id="3539570">==</span>&nbsp;<span class="ident" id="3539573">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539578">if</span>&nbsp;<span class="ident" id="3539581">tlsDial</span>&nbsp;<span class="op" id="3539589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539593">var</span>&nbsp;<span class="ident" id="3539597">err</span>&nbsp;<span class="builtintype" id="3539601">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539609">pconn</span><span class="op" id="3539614">.</span><span class="ident" id="3539615">conn</span><span class="op" id="3539619">,</span>&nbsp;<span class="ident" id="3539621">err</span>&nbsp;<span class="op" id="3539625">=</span>&nbsp;<span class="ident" id="3539627">t</span><span class="op" id="3539628">.</span><span class="ident" id="3539629">DialTLS</span><span class="op" id="3539636">(</span><span class="string" id="3539637">&#34;tcp&#34;</span><span class="op" id="3539642">,</span>&nbsp;<span class="ident" id="3539644">cm</span><span class="op" id="3539646">.</span><span class="ident" id="3539647">addr</span><span class="op" id="3539651">(</span><span class="op" id="3539652">)</span><span class="op" id="3539653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539657">if</span>&nbsp;<span class="ident" id="3539660">err</span>&nbsp;<span class="op" id="3539664">!=</span>&nbsp;<span class="ident" id="3539667">nil</span>&nbsp;<span class="op" id="3539671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539676">return</span>&nbsp;<span class="ident" id="3539683">nil</span><span class="op" id="3539686">,</span>&nbsp;<span class="ident" id="3539688">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539698">if</span>&nbsp;<span class="ident" id="3539701">tc</span><span class="op" id="3539703">,</span>&nbsp;<span class="ident" id="3539705">ok</span>&nbsp;<span class="op" id="3539708">:=</span>&nbsp;<span class="ident" id="3539711">pconn</span><span class="op" id="3539716">.</span><span class="ident" id="3539717">conn</span><span class="op" id="3539721">.</span><span class="op" id="3539722">(</span><span class="op" id="3539723">*</span><span class="ident" id="3539724">tls</span><span class="op" id="3539727">.</span><span class="ident" id="3539728">Conn</span><span class="op" id="3539732">)</span><span class="op" id="3539733">;</span>&nbsp;<span class="ident" id="3539735">ok</span>&nbsp;<span class="op" id="3539738">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539743">cs</span>&nbsp;<span class="op" id="3539746">:=</span>&nbsp;<span class="ident" id="3539749">tc</span><span class="op" id="3539751">.</span><span class="ident" id="3539752">ConnectionState</span><span class="op" id="3539767">(</span><span class="op" id="3539768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539773">pconn</span><span class="op" id="3539778">.</span><span class="ident" id="3539779">tlsState</span>&nbsp;<span class="op" id="3539788">=</span>&nbsp;<span class="op" id="3539790">&amp;</span><span class="ident" id="3539791">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539799">}</span>&nbsp;<span class="keyword" id="3539801">else</span>&nbsp;<span class="op" id="3539806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539810">conn</span><span class="op" id="3539814">,</span>&nbsp;<span class="ident" id="3539816">err</span>&nbsp;<span class="op" id="3539820">:=</span>&nbsp;<span class="ident" id="3539823">t</span><span class="op" id="3539824">.</span><span class="ident" id="3539825">dial</span><span class="op" id="3539829">(</span><span class="string" id="3539830">&#34;tcp&#34;</span><span class="op" id="3539835">,</span>&nbsp;<span class="ident" id="3539837">cm</span><span class="op" id="3539839">.</span><span class="ident" id="3539840">addr</span><span class="op" id="3539844">(</span><span class="op" id="3539845">)</span><span class="op" id="3539846">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539850">if</span>&nbsp;<span class="ident" id="3539853">err</span>&nbsp;<span class="op" id="3539857">!=</span>&nbsp;<span class="ident" id="3539860">nil</span>&nbsp;<span class="op" id="3539864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539869">if</span>&nbsp;<span class="ident" id="3539872">cm</span><span class="op" id="3539874">.</span><span class="ident" id="3539875">proxyURL</span>&nbsp;<span class="op" id="3539884">!=</span>&nbsp;<span class="ident" id="3539887">nil</span>&nbsp;<span class="op" id="3539891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3539897">err</span>&nbsp;<span class="op" id="3539901">=</span>&nbsp;<span class="ident" id="3539903">fmt</span><span class="op" id="3539906">.</span><span class="ident" id="3539907">Errorf</span><span class="op" id="3539913">(</span><span class="string" id="3539914">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3539954">,</span>&nbsp;<span class="ident" id="3539956">cm</span><span class="op" id="3539958">.</span><span class="ident" id="3539959">proxyURL</span><span class="op" id="3539967">,</span>&nbsp;<span class="ident" id="3539969">err</span><span class="op" id="3539972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3539977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3539982">return</span>&nbsp;<span class="ident" id="3539989">nil</span><span class="op" id="3539992">,</span>&nbsp;<span class="ident" id="3539994">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540004">pconn</span><span class="op" id="3540009">.</span><span class="ident" id="3540010">conn</span>&nbsp;<span class="op" id="3540015">=</span>&nbsp;<span class="ident" id="3540017">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3540027">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540044">switch</span>&nbsp;<span class="op" id="3540051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540054">case</span>&nbsp;<span class="ident" id="3540059">cm</span><span class="op" id="3540061">.</span><span class="ident" id="3540062">proxyURL</span>&nbsp;<span class="op" id="3540071">==</span>&nbsp;<span class="ident" id="3540074">nil</span><span class="op" id="3540077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3540081">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540116">case</span>&nbsp;<span class="ident" id="3540121">cm</span><span class="op" id="3540123">.</span><span class="ident" id="3540124">targetScheme</span>&nbsp;<span class="op" id="3540137">==</span>&nbsp;<span class="string" id="3540140">&#34;http&#34;</span><span class="op" id="3540146">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540150">pconn</span><span class="op" id="3540155">.</span><span class="ident" id="3540156">isProxy</span>&nbsp;<span class="op" id="3540164">=</span>&nbsp;<span class="builtintype" id="3540166">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540173">if</span>&nbsp;<span class="ident" id="3540176">pa</span>&nbsp;<span class="op" id="3540179">:=</span>&nbsp;<span class="ident" id="3540182">cm</span><span class="op" id="3540184">.</span><span class="ident" id="3540185">proxyAuth</span><span class="op" id="3540194">(</span><span class="op" id="3540195">)</span><span class="op" id="3540196">;</span>&nbsp;<span class="ident" id="3540198">pa</span>&nbsp;<span class="op" id="3540201">!=</span>&nbsp;<span class="string" id="3540204">&#34;&#34;</span>&nbsp;<span class="op" id="3540207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540212">pconn</span><span class="op" id="3540217">.</span><span class="ident" id="3540218">mutateHeaderFunc</span>&nbsp;<span class="op" id="3540235">=</span>&nbsp;<span class="keyword" id="3540237">func</span><span class="op" id="3540241">(</span><span class="ident" id="3540242">h</span>&nbsp;<span class="ident" id="3540244">Header</span><span class="op" id="3540250">)</span>&nbsp;<span class="op" id="3540252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540258">h</span><span class="op" id="3540259">.</span><span class="ident" id="3540260">Set</span><span class="op" id="3540263">(</span><span class="string" id="3540264">&#34;Proxy-Authorization&#34;</span><span class="op" id="3540285">,</span>&nbsp;<span class="ident" id="3540287">pa</span><span class="op" id="3540289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540298">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540301">case</span>&nbsp;<span class="ident" id="3540306">cm</span><span class="op" id="3540308">.</span><span class="ident" id="3540309">targetScheme</span>&nbsp;<span class="op" id="3540322">==</span>&nbsp;<span class="string" id="3540325">&#34;https&#34;</span><span class="op" id="3540332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540336">conn</span>&nbsp;<span class="op" id="3540341">:=</span>&nbsp;<span class="ident" id="3540344">pconn</span><span class="op" id="3540349">.</span><span class="ident" id="3540350">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540357">connectReq</span>&nbsp;<span class="op" id="3540368">:=</span>&nbsp;<span class="op" id="3540371">&amp;</span><span class="ident" id="3540372">Request</span><span class="op" id="3540379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540384">Method</span><span class="op" id="3540390">:</span>&nbsp;<span class="string" id="3540392">&#34;CONNECT&#34;</span><span class="op" id="3540401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540406">URL</span><span class="op" id="3540409">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3540414">&amp;</span><span class="ident" id="3540415">url</span><span class="op" id="3540418">.</span><span class="ident" id="3540419">URL</span><span class="op" id="3540422">{</span><span class="ident" id="3540423">Opaque</span><span class="op" id="3540429">:</span>&nbsp;<span class="ident" id="3540431">cm</span><span class="op" id="3540433">.</span><span class="ident" id="3540434">targetAddr</span><span class="op" id="3540444">}</span><span class="op" id="3540445">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540450">Host</span><span class="op" id="3540454">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3540458">cm</span><span class="op" id="3540460">.</span><span class="ident" id="3540461">targetAddr</span><span class="op" id="3540471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540476">Header</span><span class="op" id="3540482">:</span>&nbsp;<span class="builtinfunc" id="3540484">make</span><span class="op" id="3540488">(</span><span class="ident" id="3540489">Header</span><span class="op" id="3540495">)</span><span class="op" id="3540496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540504">if</span>&nbsp;<span class="ident" id="3540507">pa</span>&nbsp;<span class="op" id="3540510">:=</span>&nbsp;<span class="ident" id="3540513">cm</span><span class="op" id="3540515">.</span><span class="ident" id="3540516">proxyAuth</span><span class="op" id="3540525">(</span><span class="op" id="3540526">)</span><span class="op" id="3540527">;</span>&nbsp;<span class="ident" id="3540529">pa</span>&nbsp;<span class="op" id="3540532">!=</span>&nbsp;<span class="string" id="3540535">&#34;&#34;</span>&nbsp;<span class="op" id="3540538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540543">connectReq</span><span class="op" id="3540553">.</span><span class="ident" id="3540554">Header</span><span class="op" id="3540560">.</span><span class="ident" id="3540561">Set</span><span class="op" id="3540564">(</span><span class="string" id="3540565">&#34;Proxy-Authorization&#34;</span><span class="op" id="3540586">,</span>&nbsp;<span class="ident" id="3540588">pa</span><span class="op" id="3540590">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540598">connectReq</span><span class="op" id="3540608">.</span><span class="ident" id="3540609">Write</span><span class="op" id="3540614">(</span><span class="ident" id="3540615">conn</span><span class="op" id="3540619">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3540624">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3540644">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3540703">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540751">br</span>&nbsp;<span class="op" id="3540754">:=</span>&nbsp;<span class="ident" id="3540757">bufio</span><span class="op" id="3540762">.</span><span class="ident" id="3540763">NewReader</span><span class="op" id="3540772">(</span><span class="ident" id="3540773">conn</span><span class="op" id="3540777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540781">resp</span><span class="op" id="3540785">,</span>&nbsp;<span class="ident" id="3540787">err</span>&nbsp;<span class="op" id="3540791">:=</span>&nbsp;<span class="ident" id="3540794">ReadResponse</span><span class="op" id="3540806">(</span><span class="ident" id="3540807">br</span><span class="op" id="3540809">,</span>&nbsp;<span class="ident" id="3540811">connectReq</span><span class="op" id="3540821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540825">if</span>&nbsp;<span class="ident" id="3540828">err</span>&nbsp;<span class="op" id="3540832">!=</span>&nbsp;<span class="ident" id="3540835">nil</span>&nbsp;<span class="op" id="3540839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540844">conn</span><span class="op" id="3540848">.</span><span class="ident" id="3540849">Close</span><span class="op" id="3540854">(</span><span class="op" id="3540855">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540860">return</span>&nbsp;<span class="ident" id="3540867">nil</span><span class="op" id="3540870">,</span>&nbsp;<span class="ident" id="3540872">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3540878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540882">if</span>&nbsp;<span class="ident" id="3540885">resp</span><span class="op" id="3540889">.</span><span class="ident" id="3540890">StatusCode</span>&nbsp;<span class="op" id="3540901">!=</span>&nbsp;<span class="num" id="3540904">200</span>&nbsp;<span class="op" id="3540908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540913">f</span>&nbsp;<span class="op" id="3540915">:=</span>&nbsp;<span class="ident" id="3540918">strings</span><span class="op" id="3540925">.</span><span class="ident" id="3540926">SplitN</span><span class="op" id="3540932">(</span><span class="ident" id="3540933">resp</span><span class="op" id="3540937">.</span><span class="ident" id="3540938">Status</span><span class="op" id="3540944">,</span>&nbsp;<span class="string" id="3540946">&#34;&nbsp;&#34;</span><span class="op" id="3540949">,</span>&nbsp;<span class="num" id="3540951">2</span><span class="op" id="3540952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3540957">conn</span><span class="op" id="3540961">.</span><span class="ident" id="3540962">Close</span><span class="op" id="3540967">(</span><span class="op" id="3540968">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3540973">return</span>&nbsp;<span class="ident" id="3540980">nil</span><span class="op" id="3540983">,</span>&nbsp;<span class="ident" id="3540985">errors</span><span class="op" id="3540991">.</span><span class="ident" id="3540992">New</span><span class="op" id="3540995">(</span><span class="ident" id="3540996">f</span><span class="op" id="3540997">[</span><span class="num" id="3540998">1</span><span class="op" id="3540999">]</span><span class="op" id="3541000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541011">if</span>&nbsp;<span class="ident" id="3541014">cm</span><span class="op" id="3541016">.</span><span class="ident" id="3541017">targetScheme</span>&nbsp;<span class="op" id="3541030">==</span>&nbsp;<span class="string" id="3541033">&#34;https&#34;</span>&nbsp;<span class="op" id="3541041">&amp;&amp;</span>&nbsp;<span class="op" id="3541044">!</span><span class="ident" id="3541045">tlsDial</span>&nbsp;<span class="op" id="3541053">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3541057">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541123">cfg</span>&nbsp;<span class="op" id="3541127">:=</span>&nbsp;<span class="ident" id="3541130">t</span><span class="op" id="3541131">.</span><span class="ident" id="3541132">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541150">if</span>&nbsp;<span class="ident" id="3541153">cfg</span>&nbsp;<span class="op" id="3541157">==</span>&nbsp;<span class="ident" id="3541160">nil</span>&nbsp;<span class="op" id="3541164">||</span>&nbsp;<span class="ident" id="3541167">cfg</span><span class="op" id="3541170">.</span><span class="ident" id="3541171">ServerName</span>&nbsp;<span class="op" id="3541182">==</span>&nbsp;<span class="string" id="3541185">&#34;&#34;</span>&nbsp;<span class="op" id="3541188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541193">host</span>&nbsp;<span class="op" id="3541198">:=</span>&nbsp;<span class="ident" id="3541201">cm</span><span class="op" id="3541203">.</span><span class="ident" id="3541204">tlsHost</span><span class="op" id="3541211">(</span><span class="op" id="3541212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541217">if</span>&nbsp;<span class="ident" id="3541220">cfg</span>&nbsp;<span class="op" id="3541224">==</span>&nbsp;<span class="ident" id="3541227">nil</span>&nbsp;<span class="op" id="3541231">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541237">cfg</span>&nbsp;<span class="op" id="3541241">=</span>&nbsp;<span class="op" id="3541243">&amp;</span><span class="ident" id="3541244">tls</span><span class="op" id="3541247">.</span><span class="ident" id="3541248">Config</span><span class="op" id="3541254">{</span><span class="ident" id="3541255">ServerName</span><span class="op" id="3541265">:</span>&nbsp;<span class="ident" id="3541267">host</span><span class="op" id="3541271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541276">}</span>&nbsp;<span class="keyword" id="3541278">else</span>&nbsp;<span class="op" id="3541283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541289">clone</span>&nbsp;<span class="op" id="3541295">:=</span>&nbsp;<span class="op" id="3541298">*</span><span class="ident" id="3541299">cfg</span>&nbsp;<span class="comment" id="3541303">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541324">clone</span><span class="op" id="3541329">.</span><span class="ident" id="3541330">ServerName</span>&nbsp;<span class="op" id="3541341">=</span>&nbsp;<span class="ident" id="3541343">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541352">cfg</span>&nbsp;<span class="op" id="3541356">=</span>&nbsp;<span class="op" id="3541358">&amp;</span><span class="ident" id="3541359">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541376">plainConn</span>&nbsp;<span class="op" id="3541386">:=</span>&nbsp;<span class="ident" id="3541389">pconn</span><span class="op" id="3541394">.</span><span class="ident" id="3541395">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541402">tlsConn</span>&nbsp;<span class="op" id="3541410">:=</span>&nbsp;<span class="ident" id="3541413">tls</span><span class="op" id="3541416">.</span><span class="ident" id="3541417">Client</span><span class="op" id="3541423">(</span><span class="ident" id="3541424">plainConn</span><span class="op" id="3541433">,</span>&nbsp;<span class="ident" id="3541435">cfg</span><span class="op" id="3541438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541442">errc</span>&nbsp;<span class="op" id="3541447">:=</span>&nbsp;<span class="builtinfunc" id="3541450">make</span><span class="op" id="3541454">(</span><span class="keyword" id="3541455">chan</span>&nbsp;<span class="builtintype" id="3541460">error</span><span class="op" id="3541465">,</span>&nbsp;<span class="num" id="3541467">2</span><span class="op" id="3541468">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541472">var</span>&nbsp;<span class="ident" id="3541476">timer</span>&nbsp;<span class="op" id="3541482">*</span><span class="ident" id="3541483">time</span><span class="op" id="3541487">.</span><span class="ident" id="3541488">Timer</span>&nbsp;<span class="comment" id="3541494">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541527">if</span>&nbsp;<span class="ident" id="3541530">d</span>&nbsp;<span class="op" id="3541532">:=</span>&nbsp;<span class="ident" id="3541535">t</span><span class="op" id="3541536">.</span><span class="ident" id="3541537">TLSHandshakeTimeout</span><span class="op" id="3541556">;</span>&nbsp;<span class="ident" id="3541558">d</span>&nbsp;<span class="op" id="3541560">!=</span>&nbsp;<span class="num" id="3541563">0</span>&nbsp;<span class="op" id="3541565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541570">timer</span>&nbsp;<span class="op" id="3541576">=</span>&nbsp;<span class="ident" id="3541578">time</span><span class="op" id="3541582">.</span><span class="ident" id="3541583">AfterFunc</span><span class="op" id="3541592">(</span><span class="ident" id="3541593">d</span><span class="op" id="3541594">,</span>&nbsp;<span class="keyword" id="3541596">func</span><span class="op" id="3541600">(</span><span class="op" id="3541601">)</span>&nbsp;<span class="op" id="3541603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541609">errc</span>&nbsp;<span class="op" id="3541614">&lt;-</span>&nbsp;<span class="ident" id="3541617">tlsHandshakeTimeoutError</span><span class="op" id="3541641">{</span><span class="op" id="3541642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541647">}</span><span class="op" id="3541648">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541656">go</span>&nbsp;<span class="keyword" id="3541659">func</span><span class="op" id="3541663">(</span><span class="op" id="3541664">)</span>&nbsp;<span class="op" id="3541666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541671">err</span>&nbsp;<span class="op" id="3541675">:=</span>&nbsp;<span class="ident" id="3541678">tlsConn</span><span class="op" id="3541685">.</span><span class="ident" id="3541686">Handshake</span><span class="op" id="3541695">(</span><span class="op" id="3541696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541701">if</span>&nbsp;<span class="ident" id="3541704">timer</span>&nbsp;<span class="op" id="3541710">!=</span>&nbsp;<span class="ident" id="3541713">nil</span>&nbsp;<span class="op" id="3541717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541723">timer</span><span class="op" id="3541728">.</span><span class="ident" id="3541729">Stop</span><span class="op" id="3541733">(</span><span class="op" id="3541734">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541744">errc</span>&nbsp;<span class="op" id="3541749">&lt;-</span>&nbsp;<span class="ident" id="3541752">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541758">}</span><span class="op" id="3541759">(</span><span class="op" id="3541760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541764">if</span>&nbsp;<span class="ident" id="3541767">err</span>&nbsp;<span class="op" id="3541771">:=</span>&nbsp;<span class="op" id="3541774">&lt;-</span><span class="ident" id="3541776">errc</span><span class="op" id="3541780">;</span>&nbsp;<span class="ident" id="3541782">err</span>&nbsp;<span class="op" id="3541786">!=</span>&nbsp;<span class="ident" id="3541789">nil</span>&nbsp;<span class="op" id="3541793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541798">plainConn</span><span class="op" id="3541807">.</span><span class="ident" id="3541808">Close</span><span class="op" id="3541813">(</span><span class="op" id="3541814">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541819">return</span>&nbsp;<span class="ident" id="3541826">nil</span><span class="op" id="3541829">,</span>&nbsp;<span class="ident" id="3541831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541841">if</span>&nbsp;<span class="op" id="3541844">!</span><span class="ident" id="3541845">cfg</span><span class="op" id="3541848">.</span><span class="ident" id="3541849">InsecureSkipVerify</span>&nbsp;<span class="op" id="3541868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541873">if</span>&nbsp;<span class="ident" id="3541876">err</span>&nbsp;<span class="op" id="3541880">:=</span>&nbsp;<span class="ident" id="3541883">tlsConn</span><span class="op" id="3541890">.</span><span class="ident" id="3541891">VerifyHostname</span><span class="op" id="3541905">(</span><span class="ident" id="3541906">cfg</span><span class="op" id="3541909">.</span><span class="ident" id="3541910">ServerName</span><span class="op" id="3541920">)</span><span class="op" id="3541921">;</span>&nbsp;<span class="ident" id="3541923">err</span>&nbsp;<span class="op" id="3541927">!=</span>&nbsp;<span class="ident" id="3541930">nil</span>&nbsp;<span class="op" id="3541934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541940">plainConn</span><span class="op" id="3541949">.</span><span class="ident" id="3541950">Close</span><span class="op" id="3541955">(</span><span class="op" id="3541956">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3541962">return</span>&nbsp;<span class="ident" id="3541969">nil</span><span class="op" id="3541972">,</span>&nbsp;<span class="ident" id="3541974">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3541985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3541989">cs</span>&nbsp;<span class="op" id="3541992">:=</span>&nbsp;<span class="ident" id="3541995">tlsConn</span><span class="op" id="3542002">.</span><span class="ident" id="3542003">ConnectionState</span><span class="op" id="3542018">(</span><span class="op" id="3542019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542023">pconn</span><span class="op" id="3542028">.</span><span class="ident" id="3542029">tlsState</span>&nbsp;<span class="op" id="3542038">=</span>&nbsp;<span class="op" id="3542040">&amp;</span><span class="ident" id="3542041">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542046">pconn</span><span class="op" id="3542051">.</span><span class="ident" id="3542052">conn</span>&nbsp;<span class="op" id="3542057">=</span>&nbsp;<span class="ident" id="3542059">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542072">pconn</span><span class="op" id="3542077">.</span><span class="ident" id="3542078">br</span>&nbsp;<span class="op" id="3542081">=</span>&nbsp;<span class="ident" id="3542083">bufio</span><span class="op" id="3542088">.</span><span class="ident" id="3542089">NewReader</span><span class="op" id="3542098">(</span><span class="ident" id="3542099">noteEOFReader</span><span class="op" id="3542112">{</span><span class="ident" id="3542113">pconn</span><span class="op" id="3542118">.</span><span class="ident" id="3542119">conn</span><span class="op" id="3542123">,</span>&nbsp;<span class="op" id="3542125">&amp;</span><span class="ident" id="3542126">pconn</span><span class="op" id="3542131">.</span><span class="ident" id="3542132">sawEOF</span><span class="op" id="3542138">}</span><span class="op" id="3542139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542142">pconn</span><span class="op" id="3542147">.</span><span class="ident" id="3542148">bw</span>&nbsp;<span class="op" id="3542151">=</span>&nbsp;<span class="ident" id="3542153">bufio</span><span class="op" id="3542158">.</span><span class="ident" id="3542159">NewWriter</span><span class="op" id="3542168">(</span><span class="ident" id="3542169">pconn</span><span class="op" id="3542174">.</span><span class="ident" id="3542175">conn</span><span class="op" id="3542179">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542182">go</span>&nbsp;<span class="ident" id="3542185">pconn</span><span class="op" id="3542190">.</span><span class="ident" id="3542191">readLoop</span><span class="op" id="3542199">(</span><span class="op" id="3542200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542203">go</span>&nbsp;<span class="ident" id="3542206">pconn</span><span class="op" id="3542211">.</span><span class="ident" id="3542212">writeLoop</span><span class="op" id="3542221">(</span><span class="op" id="3542222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542225">return</span>&nbsp;<span class="ident" id="3542232">pconn</span><span class="op" id="3542237">,</span>&nbsp;<span class="ident" id="3542239">nil</span><br>
<span class="lineno"></span><span class="op" id="3542243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3542246">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3542311">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3542374">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3542430">func</span>&nbsp;<span class="ident" id="3542435">useProxy</span><span class="op" id="3542443">(</span><span class="ident" id="3542444">addr</span>&nbsp;<span class="builtintype" id="3542449">string</span><span class="op" id="3542455">)</span>&nbsp;<span class="builtintype" id="3542457">bool</span>&nbsp;<span class="op" id="3542462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542465">if</span>&nbsp;<span class="builtinfunc" id="3542468">len</span><span class="op" id="3542471">(</span><span class="ident" id="3542472">addr</span><span class="op" id="3542476">)</span>&nbsp;<span class="op" id="3542478">==</span>&nbsp;<span class="num" id="3542481">0</span>&nbsp;<span class="op" id="3542483">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542487">return</span>&nbsp;<span class="builtintype" id="3542494">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542503">host</span><span class="op" id="3542507">,</span>&nbsp;<span class="ident" id="3542509">_</span><span class="op" id="3542510">,</span>&nbsp;<span class="ident" id="3542512">err</span>&nbsp;<span class="op" id="3542516">:=</span>&nbsp;<span class="ident" id="3542519">net</span><span class="op" id="3542522">.</span><span class="ident" id="3542523">SplitHostPort</span><span class="op" id="3542536">(</span><span class="ident" id="3542537">addr</span><span class="op" id="3542541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542544">if</span>&nbsp;<span class="ident" id="3542547">err</span>&nbsp;<span class="op" id="3542551">!=</span>&nbsp;<span class="ident" id="3542554">nil</span>&nbsp;<span class="op" id="3542558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542562">return</span>&nbsp;<span class="builtintype" id="3542569">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542579">if</span>&nbsp;<span class="ident" id="3542582">host</span>&nbsp;<span class="op" id="3542587">==</span>&nbsp;<span class="string" id="3542590">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3542602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542606">return</span>&nbsp;<span class="builtintype" id="3542613">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542623">if</span>&nbsp;<span class="ident" id="3542626">ip</span>&nbsp;<span class="op" id="3542629">:=</span>&nbsp;<span class="ident" id="3542632">net</span><span class="op" id="3542635">.</span><span class="ident" id="3542636">ParseIP</span><span class="op" id="3542643">(</span><span class="ident" id="3542644">host</span><span class="op" id="3542648">)</span><span class="op" id="3542649">;</span>&nbsp;<span class="ident" id="3542651">ip</span>&nbsp;<span class="op" id="3542654">!=</span>&nbsp;<span class="ident" id="3542657">nil</span>&nbsp;<span class="op" id="3542661">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542665">if</span>&nbsp;<span class="ident" id="3542668">ip</span><span class="op" id="3542670">.</span><span class="ident" id="3542671">IsLoopback</span><span class="op" id="3542681">(</span><span class="op" id="3542682">)</span>&nbsp;<span class="op" id="3542684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542689">return</span>&nbsp;<span class="builtintype" id="3542696">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542711">no_proxy</span>&nbsp;<span class="op" id="3542720">:=</span>&nbsp;<span class="ident" id="3542723">noProxyEnv</span><span class="op" id="3542733">.</span><span class="ident" id="3542734">Get</span><span class="op" id="3542737">(</span><span class="op" id="3542738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542741">if</span>&nbsp;<span class="ident" id="3542744">no_proxy</span>&nbsp;<span class="op" id="3542753">==</span>&nbsp;<span class="string" id="3542756">&#34;*&#34;</span>&nbsp;<span class="op" id="3542760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542764">return</span>&nbsp;<span class="builtintype" id="3542771">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542782">addr</span>&nbsp;<span class="op" id="3542787">=</span>&nbsp;<span class="ident" id="3542789">strings</span><span class="op" id="3542796">.</span><span class="ident" id="3542797">ToLower</span><span class="op" id="3542804">(</span><span class="ident" id="3542805">strings</span><span class="op" id="3542812">.</span><span class="ident" id="3542813">TrimSpace</span><span class="op" id="3542822">(</span><span class="ident" id="3542823">addr</span><span class="op" id="3542827">)</span><span class="op" id="3542828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542831">if</span>&nbsp;<span class="ident" id="3542834">hasPort</span><span class="op" id="3542841">(</span><span class="ident" id="3542842">addr</span><span class="op" id="3542846">)</span>&nbsp;<span class="op" id="3542848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542852">addr</span>&nbsp;<span class="op" id="3542857">=</span>&nbsp;<span class="ident" id="3542859">addr</span><span class="op" id="3542863">[</span><span class="op" id="3542864">:</span><span class="ident" id="3542865">strings</span><span class="op" id="3542872">.</span><span class="ident" id="3542873">LastIndex</span><span class="op" id="3542882">(</span><span class="ident" id="3542883">addr</span><span class="op" id="3542887">,</span>&nbsp;<span class="string" id="3542889">&#34;:&#34;</span><span class="op" id="3542892">)</span><span class="op" id="3542893">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3542896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542900">for</span>&nbsp;<span class="ident" id="3542904">_</span><span class="op" id="3542905">,</span>&nbsp;<span class="ident" id="3542907">p</span>&nbsp;<span class="op" id="3542909">:=</span>&nbsp;<span class="keyword" id="3542912">range</span>&nbsp;<span class="ident" id="3542918">strings</span><span class="op" id="3542925">.</span><span class="ident" id="3542926">Split</span><span class="op" id="3542931">(</span><span class="ident" id="3542932">no_proxy</span><span class="op" id="3542940">,</span>&nbsp;<span class="string" id="3542942">&#34;,&#34;</span><span class="op" id="3542945">)</span>&nbsp;<span class="op" id="3542947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3542951">p</span>&nbsp;<span class="op" id="3542953">=</span>&nbsp;<span class="ident" id="3542955">strings</span><span class="op" id="3542962">.</span><span class="ident" id="3542963">ToLower</span><span class="op" id="3542970">(</span><span class="ident" id="3542971">strings</span><span class="op" id="3542978">.</span><span class="ident" id="3542979">TrimSpace</span><span class="op" id="3542988">(</span><span class="ident" id="3542989">p</span><span class="op" id="3542990">)</span><span class="op" id="3542991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3542995">if</span>&nbsp;<span class="builtinfunc" id="3542998">len</span><span class="op" id="3543001">(</span><span class="ident" id="3543002">p</span><span class="op" id="3543003">)</span>&nbsp;<span class="op" id="3543005">==</span>&nbsp;<span class="num" id="3543008">0</span>&nbsp;<span class="op" id="3543010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543015">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543026">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543030">if</span>&nbsp;<span class="ident" id="3543033">hasPort</span><span class="op" id="3543040">(</span><span class="ident" id="3543041">p</span><span class="op" id="3543042">)</span>&nbsp;<span class="op" id="3543044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3543049">p</span>&nbsp;<span class="op" id="3543051">=</span>&nbsp;<span class="ident" id="3543053">p</span><span class="op" id="3543054">[</span><span class="op" id="3543055">:</span><span class="ident" id="3543056">strings</span><span class="op" id="3543063">.</span><span class="ident" id="3543064">LastIndex</span><span class="op" id="3543073">(</span><span class="ident" id="3543074">p</span><span class="op" id="3543075">,</span>&nbsp;<span class="string" id="3543077">&#34;:&#34;</span><span class="op" id="3543080">)</span><span class="op" id="3543081">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543089">if</span>&nbsp;<span class="ident" id="3543092">addr</span>&nbsp;<span class="op" id="3543097">==</span>&nbsp;<span class="ident" id="3543100">p</span>&nbsp;<span class="op" id="3543102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543107">return</span>&nbsp;<span class="builtintype" id="3543114">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543126">if</span>&nbsp;<span class="ident" id="3543129">p</span><span class="op" id="3543130">[</span><span class="num" id="3543131">0</span><span class="op" id="3543132">]</span>&nbsp;<span class="op" id="3543134">==</span>&nbsp;<span class="string" id="3543137">&#39;.&#39;</span>&nbsp;<span class="op" id="3543141">&amp;&amp;</span>&nbsp;<span class="op" id="3543144">(</span><span class="ident" id="3543145">strings</span><span class="op" id="3543152">.</span><span class="ident" id="3543153">HasSuffix</span><span class="op" id="3543162">(</span><span class="ident" id="3543163">addr</span><span class="op" id="3543167">,</span>&nbsp;<span class="ident" id="3543169">p</span><span class="op" id="3543170">)</span>&nbsp;<span class="op" id="3543172">||</span>&nbsp;<span class="ident" id="3543175">addr</span>&nbsp;<span class="op" id="3543180">==</span>&nbsp;<span class="ident" id="3543183">p</span><span class="op" id="3543184">[</span><span class="num" id="3543185">1</span><span class="op" id="3543186">:</span><span class="op" id="3543187">]</span><span class="op" id="3543188">)</span>&nbsp;<span class="op" id="3543190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543195">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543256">return</span>&nbsp;<span class="builtintype" id="3543263">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543271">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543275">if</span>&nbsp;<span class="ident" id="3543278">p</span><span class="op" id="3543279">[</span><span class="num" id="3543280">0</span><span class="op" id="3543281">]</span>&nbsp;<span class="op" id="3543283">!=</span>&nbsp;<span class="string" id="3543286">&#39;.&#39;</span>&nbsp;<span class="op" id="3543290">&amp;&amp;</span>&nbsp;<span class="ident" id="3543293">strings</span><span class="op" id="3543300">.</span><span class="ident" id="3543301">HasSuffix</span><span class="op" id="3543310">(</span><span class="ident" id="3543311">addr</span><span class="op" id="3543315">,</span>&nbsp;<span class="ident" id="3543317">p</span><span class="op" id="3543318">)</span>&nbsp;<span class="op" id="3543320">&amp;&amp;</span>&nbsp;<span class="ident" id="3543323">addr</span><span class="op" id="3543327">[</span><span class="builtinfunc" id="3543328">len</span><span class="op" id="3543331">(</span><span class="ident" id="3543332">addr</span><span class="op" id="3543336">)</span><span class="op" id="3543337">-</span><span class="builtinfunc" id="3543338">len</span><span class="op" id="3543341">(</span><span class="ident" id="3543342">p</span><span class="op" id="3543343">)</span><span class="op" id="3543344">-</span><span class="num" id="3543345">1</span><span class="op" id="3543346">]</span>&nbsp;<span class="op" id="3543348">==</span>&nbsp;<span class="string" id="3543351">&#39;.&#39;</span>&nbsp;<span class="op" id="3543355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3543360">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543407">return</span>&nbsp;<span class="builtintype" id="3543414">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3543425">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3543428">return</span>&nbsp;<span class="builtintype" id="3543435">true</span><br>
<span class="lineno"></span><span class="op" id="3543440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3543443">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3543519">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3543574">//</span><br>
<span class="lineno"></span><span class="comment" id="3543577">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3543628">//</span><br>
<span class="lineno"></span><span class="comment" id="3543631">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3543676">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3543735">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3543802">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3543870">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3543944">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3544022">//</span><br>
<span class="lineno">730</span><span class="comment" id="3544025">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3544072">//</span><br>
<span class="lineno"></span><span class="keyword" id="3544075">type</span>&nbsp;<span class="ident" id="3544080">connectMethod</span>&nbsp;<span class="keyword" id="3544094">struct</span>&nbsp;<span class="op" id="3544101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544104">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3544117">*</span><span class="ident" id="3544118">url</span><span class="op" id="3544121">.</span><span class="ident" id="3544122">URL</span>&nbsp;<span class="comment" id="3544126">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544168">targetScheme</span>&nbsp;<span class="builtintype" id="3544181">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3544190">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544212">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3544225">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3544234">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3544298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3544301">func</span>&nbsp;<span class="op" id="3544306">(</span><span class="ident" id="3544307">cm</span>&nbsp;<span class="op" id="3544310">*</span><span class="ident" id="3544311">connectMethod</span><span class="op" id="3544324">)</span>&nbsp;<span class="ident" id="3544326">key</span><span class="op" id="3544329">(</span><span class="op" id="3544330">)</span>&nbsp;<span class="ident" id="3544332">connectMethodKey</span>&nbsp;<span class="op" id="3544349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544352">proxyStr</span>&nbsp;<span class="op" id="3544361">:=</span>&nbsp;<span class="string" id="3544364">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544368">targetAddr</span>&nbsp;<span class="op" id="3544379">:=</span>&nbsp;<span class="ident" id="3544382">cm</span><span class="op" id="3544384">.</span><span class="ident" id="3544385">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544397">if</span>&nbsp;<span class="ident" id="3544400">cm</span><span class="op" id="3544402">.</span><span class="ident" id="3544403">proxyURL</span>&nbsp;<span class="op" id="3544412">!=</span>&nbsp;<span class="ident" id="3544415">nil</span>&nbsp;<span class="op" id="3544419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544423">proxyStr</span>&nbsp;<span class="op" id="3544432">=</span>&nbsp;<span class="ident" id="3544434">cm</span><span class="op" id="3544436">.</span><span class="ident" id="3544437">proxyURL</span><span class="op" id="3544445">.</span><span class="ident" id="3544446">String</span><span class="op" id="3544452">(</span><span class="op" id="3544453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544457">if</span>&nbsp;<span class="ident" id="3544460">cm</span><span class="op" id="3544462">.</span><span class="ident" id="3544463">targetScheme</span>&nbsp;<span class="op" id="3544476">==</span>&nbsp;<span class="string" id="3544479">&#34;http&#34;</span>&nbsp;<span class="op" id="3544486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544491">targetAddr</span>&nbsp;<span class="op" id="3544502">=</span>&nbsp;<span class="string" id="3544504">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3544509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3544512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544515">return</span>&nbsp;<span class="ident" id="3544522">connectMethodKey</span><span class="op" id="3544538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544542">proxy</span><span class="op" id="3544547">:</span>&nbsp;&nbsp;<span class="ident" id="3544550">proxyStr</span><span class="op" id="3544558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544562">scheme</span><span class="op" id="3544568">:</span>&nbsp;<span class="ident" id="3544570">cm</span><span class="op" id="3544572">.</span><span class="ident" id="3544573">targetScheme</span><span class="op" id="3544585">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544589">addr</span><span class="op" id="3544593">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3544597">targetAddr</span><span class="op" id="3544607">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3544610">}</span><br>
<span class="lineno"></span><span class="op" id="3544612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3544615">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3544690">func</span>&nbsp;<span class="op" id="3544695">(</span><span class="ident" id="3544696">cm</span>&nbsp;<span class="op" id="3544699">*</span><span class="ident" id="3544700">connectMethod</span><span class="op" id="3544713">)</span>&nbsp;<span class="ident" id="3544715">addr</span><span class="op" id="3544719">(</span><span class="op" id="3544720">)</span>&nbsp;<span class="builtintype" id="3544722">string</span>&nbsp;<span class="op" id="3544729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544732">if</span>&nbsp;<span class="ident" id="3544735">cm</span><span class="op" id="3544737">.</span><span class="ident" id="3544738">proxyURL</span>&nbsp;<span class="op" id="3544747">!=</span>&nbsp;<span class="ident" id="3544750">nil</span>&nbsp;<span class="op" id="3544754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544758">return</span>&nbsp;<span class="ident" id="3544765">canonicalAddr</span><span class="op" id="3544778">(</span><span class="ident" id="3544779">cm</span><span class="op" id="3544781">.</span><span class="ident" id="3544782">proxyURL</span><span class="op" id="3544790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3544793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544796">return</span>&nbsp;<span class="ident" id="3544803">cm</span><span class="op" id="3544805">.</span><span class="ident" id="3544806">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3544817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3544820">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3544881">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3544901">func</span>&nbsp;<span class="op" id="3544906">(</span><span class="ident" id="3544907">cm</span>&nbsp;<span class="op" id="3544910">*</span><span class="ident" id="3544911">connectMethod</span><span class="op" id="3544924">)</span>&nbsp;<span class="ident" id="3544926">tlsHost</span><span class="op" id="3544933">(</span><span class="op" id="3544934">)</span>&nbsp;<span class="builtintype" id="3544936">string</span>&nbsp;<span class="op" id="3544943">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544946">h</span>&nbsp;<span class="op" id="3544948">:=</span>&nbsp;<span class="ident" id="3544951">cm</span><span class="op" id="3544953">.</span><span class="ident" id="3544954">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3544966">if</span>&nbsp;<span class="ident" id="3544969">hasPort</span><span class="op" id="3544976">(</span><span class="ident" id="3544977">h</span><span class="op" id="3544978">)</span>&nbsp;<span class="op" id="3544980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3544984">h</span>&nbsp;<span class="op" id="3544986">=</span>&nbsp;<span class="ident" id="3544988">h</span><span class="op" id="3544989">[</span><span class="op" id="3544990">:</span><span class="ident" id="3544991">strings</span><span class="op" id="3544998">.</span><span class="ident" id="3544999">LastIndex</span><span class="op" id="3545008">(</span><span class="ident" id="3545009">h</span><span class="op" id="3545010">,</span>&nbsp;<span class="string" id="3545012">&#34;:&#34;</span><span class="op" id="3545015">)</span><span class="op" id="3545016">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3545019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545022">return</span>&nbsp;<span class="ident" id="3545029">h</span><br>
<span class="lineno">770</span><span class="op" id="3545031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3545034">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3545102">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3545173">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3545183">type</span>&nbsp;<span class="ident" id="3545188">connectMethodKey</span>&nbsp;<span class="keyword" id="3545205">struct</span>&nbsp;<span class="op" id="3545212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545215">proxy</span><span class="op" id="3545220">,</span>&nbsp;<span class="ident" id="3545222">scheme</span><span class="op" id="3545228">,</span>&nbsp;<span class="ident" id="3545230">addr</span>&nbsp;<span class="builtintype" id="3545235">string</span><br>
<span class="lineno"></span><span class="op" id="3545242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3545245">func</span>&nbsp;<span class="op" id="3545250">(</span><span class="ident" id="3545251">k</span>&nbsp;<span class="ident" id="3545253">connectMethodKey</span><span class="op" id="3545269">)</span>&nbsp;<span class="ident" id="3545271">String</span><span class="op" id="3545277">(</span><span class="op" id="3545278">)</span>&nbsp;<span class="builtintype" id="3545280">string</span>&nbsp;<span class="op" id="3545287">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3545290">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3545314">return</span>&nbsp;<span class="ident" id="3545321">fmt</span><span class="op" id="3545324">.</span><span class="ident" id="3545325">Sprintf</span><span class="op" id="3545332">(</span><span class="string" id="3545333">&#34;%s|%s|%s&#34;</span><span class="op" id="3545343">,</span>&nbsp;<span class="ident" id="3545345">k</span><span class="op" id="3545346">.</span><span class="ident" id="3545347">proxy</span><span class="op" id="3545352">,</span>&nbsp;<span class="ident" id="3545354">k</span><span class="op" id="3545355">.</span><span class="ident" id="3545356">scheme</span><span class="op" id="3545362">,</span>&nbsp;<span class="ident" id="3545364">k</span><span class="op" id="3545365">.</span><span class="ident" id="3545366">addr</span><span class="op" id="3545370">)</span><br>
<span class="lineno"></span><span class="op" id="3545372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3545375">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3545435">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3545492">type</span>&nbsp;<span class="ident" id="3545497">persistConn</span>&nbsp;<span class="keyword" id="3545509">struct</span>&nbsp;<span class="op" id="3545516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545519">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3545528">*</span><span class="ident" id="3545529">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545540">cacheKey</span>&nbsp;<span class="ident" id="3545549">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545567">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3545576">net</span><span class="op" id="3545579">.</span><span class="ident" id="3545580">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545586">tlsState</span>&nbsp;<span class="op" id="3545595">*</span><span class="ident" id="3545596">tls</span><span class="op" id="3545599">.</span><span class="ident" id="3545600">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545617">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3545626">*</span><span class="ident" id="3545627">bufio</span><span class="op" id="3545632">.</span><span class="ident" id="3545633">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3545646">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545660">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3545669">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3545689">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545745">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3545754">*</span><span class="ident" id="3545755">bufio</span><span class="op" id="3545760">.</span><span class="ident" id="3545761">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3545774">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545786">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3545795">chan</span>&nbsp;<span class="ident" id="3545800">requestAndChan</span>&nbsp;<span class="comment" id="3545815">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545858">writech</span>&nbsp;&nbsp;<span class="keyword" id="3545867">chan</span>&nbsp;<span class="ident" id="3545872">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3545887">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545931">closech</span>&nbsp;&nbsp;<span class="keyword" id="3545940">chan</span>&nbsp;<span class="keyword" id="3545945">struct</span><span class="op" id="3545951">{</span><span class="op" id="3545952">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3545960">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3545988">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3545997">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546003">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546063">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546125">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546189">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546248">writeErrCh</span>&nbsp;<span class="keyword" id="3546259">chan</span>&nbsp;<span class="builtintype" id="3546264">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546272">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3546293">sync</span><span class="op" id="3546297">.</span><span class="ident" id="3546298">Mutex</span>&nbsp;<span class="comment" id="3546304">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546332">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3546353">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546358">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546379">bool</span>&nbsp;<span class="comment" id="3546384">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546417">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3546438">bool</span>&nbsp;<span class="comment" id="3546443">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546523">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546580">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3546643">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546700">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3546717">func</span><span class="op" id="3546721">(</span><span class="ident" id="3546722">Header</span><span class="op" id="3546728">)</span><br>
<span class="lineno"></span><span class="op" id="3546730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3546733">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3546805">func</span>&nbsp;<span class="op" id="3546810">(</span><span class="ident" id="3546811">pc</span>&nbsp;<span class="op" id="3546814">*</span><span class="ident" id="3546815">persistConn</span><span class="op" id="3546826">)</span>&nbsp;<span class="ident" id="3546828">isBroken</span><span class="op" id="3546836">(</span><span class="op" id="3546837">)</span>&nbsp;<span class="builtintype" id="3546839">bool</span>&nbsp;<span class="op" id="3546844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546847">pc</span><span class="op" id="3546849">.</span><span class="ident" id="3546850">lk</span><span class="op" id="3546852">.</span><span class="ident" id="3546853">Lock</span><span class="op" id="3546857">(</span><span class="op" id="3546858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546861">b</span>&nbsp;<span class="op" id="3546863">:=</span>&nbsp;<span class="ident" id="3546866">pc</span><span class="op" id="3546868">.</span><span class="ident" id="3546869">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546877">pc</span><span class="op" id="3546879">.</span><span class="ident" id="3546880">lk</span><span class="op" id="3546882">.</span><span class="ident" id="3546883">Unlock</span><span class="op" id="3546889">(</span><span class="op" id="3546890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3546893">return</span>&nbsp;<span class="ident" id="3546900">b</span><br>
<span class="lineno">820</span><span class="op" id="3546902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3546905">func</span>&nbsp;<span class="op" id="3546910">(</span><span class="ident" id="3546911">pc</span>&nbsp;<span class="op" id="3546914">*</span><span class="ident" id="3546915">persistConn</span><span class="op" id="3546926">)</span>&nbsp;<span class="ident" id="3546928">cancelRequest</span><span class="op" id="3546941">(</span><span class="op" id="3546942">)</span>&nbsp;<span class="op" id="3546944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3546947">pc</span><span class="op" id="3546949">.</span><span class="ident" id="3546950">conn</span><span class="op" id="3546954">.</span><span class="ident" id="3546955">Close</span><span class="op" id="3546960">(</span><span class="op" id="3546961">)</span><br>
<span class="lineno"></span><span class="op" id="3546963">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3546966">var</span>&nbsp;<span class="ident" id="3546970">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3546991">func</span><span class="op" id="3546995">(</span><span class="builtintype" id="3546996">error</span><span class="op" id="3547001">)</span>&nbsp;<span class="builtintype" id="3547003">bool</span>&nbsp;<span class="comment" id="3547008">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3547034">func</span>&nbsp;<span class="ident" id="3547039">remoteSideClosed</span><span class="op" id="3547055">(</span><span class="ident" id="3547056">err</span>&nbsp;<span class="builtintype" id="3547060">error</span><span class="op" id="3547065">)</span>&nbsp;<span class="builtintype" id="3547067">bool</span>&nbsp;<span class="op" id="3547072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547075">if</span>&nbsp;<span class="ident" id="3547078">err</span>&nbsp;<span class="op" id="3547082">==</span>&nbsp;<span class="ident" id="3547085">io</span><span class="op" id="3547087">.</span><span class="ident" id="3547088">EOF</span>&nbsp;<span class="op" id="3547092">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547096">return</span>&nbsp;<span class="builtintype" id="3547103">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547112">if</span>&nbsp;<span class="ident" id="3547115">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3547136">!=</span>&nbsp;<span class="ident" id="3547139">nil</span>&nbsp;<span class="op" id="3547143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547147">return</span>&nbsp;<span class="ident" id="3547154">remoteSideClosedFunc</span><span class="op" id="3547174">(</span><span class="ident" id="3547175">err</span><span class="op" id="3547178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547181">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547184">return</span>&nbsp;<span class="builtintype" id="3547191">false</span><br>
<span class="lineno"></span><span class="op" id="3547197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3547200">func</span>&nbsp;<span class="op" id="3547205">(</span><span class="ident" id="3547206">pc</span>&nbsp;<span class="op" id="3547209">*</span><span class="ident" id="3547210">persistConn</span><span class="op" id="3547221">)</span>&nbsp;<span class="ident" id="3547223">readLoop</span><span class="op" id="3547231">(</span><span class="op" id="3547232">)</span>&nbsp;<span class="op" id="3547234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547237">alive</span>&nbsp;<span class="op" id="3547243">:=</span>&nbsp;<span class="builtintype" id="3547246">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547253">for</span>&nbsp;<span class="ident" id="3547257">alive</span>&nbsp;<span class="op" id="3547263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547267">pb</span><span class="op" id="3547269">,</span>&nbsp;<span class="ident" id="3547271">err</span>&nbsp;<span class="op" id="3547275">:=</span>&nbsp;<span class="ident" id="3547278">pc</span><span class="op" id="3547280">.</span><span class="ident" id="3547281">br</span><span class="op" id="3547283">.</span><span class="ident" id="3547284">Peek</span><span class="op" id="3547288">(</span><span class="num" id="3547289">1</span><span class="op" id="3547290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547295">pc</span><span class="op" id="3547297">.</span><span class="ident" id="3547298">lk</span><span class="op" id="3547300">.</span><span class="ident" id="3547301">Lock</span><span class="op" id="3547305">(</span><span class="op" id="3547306">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547310">if</span>&nbsp;<span class="ident" id="3547313">pc</span><span class="op" id="3547315">.</span><span class="ident" id="3547316">numExpectedResponses</span>&nbsp;<span class="op" id="3547337">==</span>&nbsp;<span class="num" id="3547340">0</span>&nbsp;<span class="op" id="3547342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547347">if</span>&nbsp;<span class="op" id="3547350">!</span><span class="ident" id="3547351">pc</span><span class="op" id="3547353">.</span><span class="ident" id="3547354">closed</span>&nbsp;<span class="op" id="3547361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547367">pc</span><span class="op" id="3547369">.</span><span class="ident" id="3547370">closeLocked</span><span class="op" id="3547381">(</span><span class="op" id="3547382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547388">if</span>&nbsp;<span class="builtinfunc" id="3547391">len</span><span class="op" id="3547394">(</span><span class="ident" id="3547395">pb</span><span class="op" id="3547397">)</span>&nbsp;<span class="op" id="3547399">&gt;</span>&nbsp;<span class="num" id="3547401">0</span>&nbsp;<span class="op" id="3547403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547410">log</span><span class="op" id="3547413">.</span><span class="ident" id="3547414">Printf</span><span class="op" id="3547420">(</span><span class="string" id="3547421">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3547498">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3547506">string</span><span class="op" id="3547512">(</span><span class="ident" id="3547513">pb</span><span class="op" id="3547515">)</span><span class="op" id="3547516">,</span>&nbsp;<span class="ident" id="3547518">err</span><span class="op" id="3547521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547537">pc</span><span class="op" id="3547539">.</span><span class="ident" id="3547540">lk</span><span class="op" id="3547542">.</span><span class="ident" id="3547543">Unlock</span><span class="op" id="3547549">(</span><span class="op" id="3547550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547555">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3547564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547568">pc</span><span class="op" id="3547570">.</span><span class="ident" id="3547571">lk</span><span class="op" id="3547573">.</span><span class="ident" id="3547574">Unlock</span><span class="op" id="3547580">(</span><span class="op" id="3547581">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547586">rc</span>&nbsp;<span class="op" id="3547589">:=</span>&nbsp;<span class="op" id="3547592">&lt;-</span><span class="ident" id="3547594">pc</span><span class="op" id="3547596">.</span><span class="ident" id="3547597">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547606">var</span>&nbsp;<span class="ident" id="3547610">resp</span>&nbsp;<span class="op" id="3547615">*</span><span class="ident" id="3547616">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547627">if</span>&nbsp;<span class="ident" id="3547630">err</span>&nbsp;<span class="op" id="3547634">==</span>&nbsp;<span class="ident" id="3547637">nil</span>&nbsp;<span class="op" id="3547641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3547646">resp</span><span class="op" id="3547650">,</span>&nbsp;<span class="ident" id="3547652">err</span>&nbsp;<span class="op" id="3547656">=</span>&nbsp;<span class="ident" id="3547658">ReadResponse</span><span class="op" id="3547670">(</span><span class="ident" id="3547671">pc</span><span class="op" id="3547673">.</span><span class="ident" id="3547674">br</span><span class="op" id="3547676">,</span>&nbsp;<span class="ident" id="3547678">rc</span><span class="op" id="3547680">.</span><span class="ident" id="3547681">req</span><span class="op" id="3547684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3547689">if</span>&nbsp;<span class="ident" id="3547692">err</span>&nbsp;<span class="op" id="3547696">==</span>&nbsp;<span class="ident" id="3547699">nil</span>&nbsp;<span class="op" id="3547703">&amp;&amp;</span>&nbsp;<span class="ident" id="3547706">resp</span><span class="op" id="3547710">.</span><span class="ident" id="3547711">StatusCode</span>&nbsp;<span class="op" id="3547722">==</span>&nbsp;<span class="num" id="3547725">100</span>&nbsp;<span class="op" id="3547729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547735">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547773">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547834">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547894">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3547960">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548008">resp</span><span class="op" id="3548012">,</span>&nbsp;<span class="ident" id="3548014">err</span>&nbsp;<span class="op" id="3548018">=</span>&nbsp;<span class="ident" id="3548020">ReadResponse</span><span class="op" id="3548032">(</span><span class="ident" id="3548033">pc</span><span class="op" id="3548035">.</span><span class="ident" id="3548036">br</span><span class="op" id="3548038">,</span>&nbsp;<span class="ident" id="3548040">rc</span><span class="op" id="3548042">.</span><span class="ident" id="3548043">req</span><span class="op" id="3548046">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548060">if</span>&nbsp;<span class="ident" id="3548063">resp</span>&nbsp;<span class="op" id="3548068">!=</span>&nbsp;<span class="ident" id="3548071">nil</span>&nbsp;<span class="op" id="3548075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548080">resp</span><span class="op" id="3548084">.</span><span class="ident" id="3548085">TLS</span>&nbsp;<span class="op" id="3548089">=</span>&nbsp;<span class="ident" id="3548091">pc</span><span class="op" id="3548093">.</span><span class="ident" id="3548094">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548110">hasBody</span>&nbsp;<span class="op" id="3548118">:=</span>&nbsp;<span class="ident" id="3548121">resp</span>&nbsp;<span class="op" id="3548126">!=</span>&nbsp;<span class="ident" id="3548129">nil</span>&nbsp;<span class="op" id="3548133">&amp;&amp;</span>&nbsp;<span class="ident" id="3548136">rc</span><span class="op" id="3548138">.</span><span class="ident" id="3548139">req</span><span class="op" id="3548142">.</span><span class="ident" id="3548143">Method</span>&nbsp;<span class="op" id="3548150">!=</span>&nbsp;<span class="string" id="3548153">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3548160">&amp;&amp;</span>&nbsp;<span class="ident" id="3548163">resp</span><span class="op" id="3548167">.</span><span class="ident" id="3548168">ContentLength</span>&nbsp;<span class="op" id="3548182">!=</span>&nbsp;<span class="num" id="3548185">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548190">if</span>&nbsp;<span class="ident" id="3548193">err</span>&nbsp;<span class="op" id="3548197">!=</span>&nbsp;<span class="ident" id="3548200">nil</span>&nbsp;<span class="op" id="3548204">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548209">pc</span><span class="op" id="3548211">.</span><span class="builtinfunc" id="3548212">close</span><span class="op" id="3548217">(</span><span class="op" id="3548218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548222">}</span>&nbsp;<span class="keyword" id="3548224">else</span>&nbsp;<span class="op" id="3548229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548234">if</span>&nbsp;<span class="ident" id="3548237">rc</span><span class="op" id="3548239">.</span><span class="ident" id="3548240">addedGzip</span>&nbsp;<span class="op" id="3548250">&amp;&amp;</span>&nbsp;<span class="ident" id="3548253">hasBody</span>&nbsp;<span class="op" id="3548261">&amp;&amp;</span>&nbsp;<span class="ident" id="3548264">resp</span><span class="op" id="3548268">.</span><span class="ident" id="3548269">Header</span><span class="op" id="3548275">.</span><span class="ident" id="3548276">Get</span><span class="op" id="3548279">(</span><span class="string" id="3548280">&#34;Content-Encoding&#34;</span><span class="op" id="3548298">)</span>&nbsp;<span class="op" id="3548300">==</span>&nbsp;<span class="string" id="3548303">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3548310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548316">resp</span><span class="op" id="3548320">.</span><span class="ident" id="3548321">Header</span><span class="op" id="3548327">.</span><span class="ident" id="3548328">Del</span><span class="op" id="3548331">(</span><span class="string" id="3548332">&#34;Content-Encoding&#34;</span><span class="op" id="3548350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548356">resp</span><span class="op" id="3548360">.</span><span class="ident" id="3548361">Header</span><span class="op" id="3548367">.</span><span class="ident" id="3548368">Del</span><span class="op" id="3548371">(</span><span class="string" id="3548372">&#34;Content-Length&#34;</span><span class="op" id="3548388">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548394">resp</span><span class="op" id="3548398">.</span><span class="ident" id="3548399">ContentLength</span>&nbsp;<span class="op" id="3548413">=</span>&nbsp;<span class="op" id="3548415">-</span><span class="num" id="3548416">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548422">resp</span><span class="op" id="3548426">.</span><span class="ident" id="3548427">Body</span>&nbsp;<span class="op" id="3548432">=</span>&nbsp;<span class="op" id="3548434">&amp;</span><span class="ident" id="3548435">gzipReader</span><span class="op" id="3548445">{</span><span class="ident" id="3548446">body</span><span class="op" id="3548450">:</span>&nbsp;<span class="ident" id="3548452">resp</span><span class="op" id="3548456">.</span><span class="ident" id="3548457">Body</span><span class="op" id="3548461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548471">resp</span><span class="op" id="3548475">.</span><span class="ident" id="3548476">Body</span>&nbsp;<span class="op" id="3548481">=</span>&nbsp;<span class="op" id="3548483">&amp;</span><span class="ident" id="3548484">bodyEOFSignal</span><span class="op" id="3548497">{</span><span class="ident" id="3548498">body</span><span class="op" id="3548502">:</span>&nbsp;<span class="ident" id="3548504">resp</span><span class="op" id="3548508">.</span><span class="ident" id="3548509">Body</span><span class="op" id="3548513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548517">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548522">if</span>&nbsp;<span class="ident" id="3548525">err</span>&nbsp;<span class="op" id="3548529">!=</span>&nbsp;<span class="ident" id="3548532">nil</span>&nbsp;<span class="op" id="3548536">||</span>&nbsp;<span class="ident" id="3548539">resp</span><span class="op" id="3548543">.</span><span class="ident" id="3548544">Close</span>&nbsp;<span class="op" id="3548550">||</span>&nbsp;<span class="ident" id="3548553">rc</span><span class="op" id="3548555">.</span><span class="ident" id="3548556">req</span><span class="op" id="3548559">.</span><span class="ident" id="3548560">Close</span>&nbsp;<span class="op" id="3548566">||</span>&nbsp;<span class="ident" id="3548569">resp</span><span class="op" id="3548573">.</span><span class="ident" id="3548574">StatusCode</span>&nbsp;<span class="op" id="3548585">&lt;=</span>&nbsp;<span class="num" id="3548588">199</span>&nbsp;<span class="op" id="3548592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548597">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548666">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548726">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548773">alive</span>&nbsp;<span class="op" id="3548779">=</span>&nbsp;<span class="builtintype" id="3548781">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3548789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548794">var</span>&nbsp;<span class="ident" id="3548798">waitForBodyRead</span>&nbsp;<span class="keyword" id="3548814">chan</span>&nbsp;<span class="builtintype" id="3548819">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3548826">if</span>&nbsp;<span class="ident" id="3548829">hasBody</span>&nbsp;<span class="op" id="3548837">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548842">waitForBodyRead</span>&nbsp;<span class="op" id="3548858">=</span>&nbsp;<span class="builtinfunc" id="3548860">make</span><span class="op" id="3548864">(</span><span class="keyword" id="3548865">chan</span>&nbsp;<span class="builtintype" id="3548870">bool</span><span class="op" id="3548874">,</span>&nbsp;<span class="num" id="3548876">2</span><span class="op" id="3548877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3548882">resp</span><span class="op" id="3548886">.</span><span class="ident" id="3548887">Body</span><span class="op" id="3548891">.</span><span class="op" id="3548892">(</span><span class="op" id="3548893">*</span><span class="ident" id="3548894">bodyEOFSignal</span><span class="op" id="3548907">)</span><span class="op" id="3548908">.</span><span class="ident" id="3548909">earlyCloseFn</span>&nbsp;<span class="op" id="3548922">=</span>&nbsp;<span class="keyword" id="3548924">func</span><span class="op" id="3548928">(</span><span class="op" id="3548929">)</span>&nbsp;<span class="builtintype" id="3548931">error</span>&nbsp;<span class="op" id="3548937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548943">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3548983">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3549022">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549036">waitForBodyRead</span>&nbsp;<span class="op" id="3549052">&lt;-</span>&nbsp;<span class="builtintype" id="3549055">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549065">return</span>&nbsp;<span class="ident" id="3549072">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549084">resp</span><span class="op" id="3549088">.</span><span class="ident" id="3549089">Body</span><span class="op" id="3549093">.</span><span class="op" id="3549094">(</span><span class="op" id="3549095">*</span><span class="ident" id="3549096">bodyEOFSignal</span><span class="op" id="3549109">)</span><span class="op" id="3549110">.</span><span class="ident" id="3549111">fn</span>&nbsp;<span class="op" id="3549114">=</span>&nbsp;<span class="keyword" id="3549116">func</span><span class="op" id="3549120">(</span><span class="ident" id="3549121">err</span>&nbsp;<span class="builtintype" id="3549125">error</span><span class="op" id="3549130">)</span>&nbsp;<span class="op" id="3549132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549138">waitForBodyRead</span>&nbsp;<span class="op" id="3549154">&lt;-</span>&nbsp;<span class="ident" id="3549157">alive</span>&nbsp;<span class="op" id="3549163">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549171">err</span>&nbsp;<span class="op" id="3549175">==</span>&nbsp;<span class="ident" id="3549178">nil</span>&nbsp;<span class="op" id="3549182">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549190">!</span><span class="ident" id="3549191">pc</span><span class="op" id="3549193">.</span><span class="ident" id="3549194">sawEOF</span>&nbsp;<span class="op" id="3549201">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549209">pc</span><span class="op" id="3549211">.</span><span class="ident" id="3549212">wroteRequest</span><span class="op" id="3549224">(</span><span class="op" id="3549225">)</span>&nbsp;<span class="op" id="3549227">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549235">pc</span><span class="op" id="3549237">.</span><span class="ident" id="3549238">t</span><span class="op" id="3549239">.</span><span class="ident" id="3549240">putIdleConn</span><span class="op" id="3549251">(</span><span class="ident" id="3549252">pc</span><span class="op" id="3549254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549259">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549268">if</span>&nbsp;<span class="ident" id="3549271">alive</span>&nbsp;<span class="op" id="3549277">&amp;&amp;</span>&nbsp;<span class="op" id="3549280">!</span><span class="ident" id="3549281">hasBody</span>&nbsp;<span class="op" id="3549289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549294">alive</span>&nbsp;<span class="op" id="3549300">=</span>&nbsp;<span class="op" id="3549302">!</span><span class="ident" id="3549303">pc</span><span class="op" id="3549305">.</span><span class="ident" id="3549306">sawEOF</span>&nbsp;<span class="op" id="3549313">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549320">pc</span><span class="op" id="3549322">.</span><span class="ident" id="3549323">wroteRequest</span><span class="op" id="3549335">(</span><span class="op" id="3549336">)</span>&nbsp;<span class="op" id="3549338">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549345">pc</span><span class="op" id="3549347">.</span><span class="ident" id="3549348">t</span><span class="op" id="3549349">.</span><span class="ident" id="3549350">putIdleConn</span><span class="op" id="3549361">(</span><span class="ident" id="3549362">pc</span><span class="op" id="3549364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549373">rc</span><span class="op" id="3549375">.</span><span class="ident" id="3549376">ch</span>&nbsp;<span class="op" id="3549379">&lt;-</span>&nbsp;<span class="ident" id="3549382">responseAndError</span><span class="op" id="3549398">{</span><span class="ident" id="3549399">resp</span><span class="op" id="3549403">,</span>&nbsp;<span class="ident" id="3549405">err</span><span class="op" id="3549408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3549413">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3549480">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549541">if</span>&nbsp;<span class="ident" id="3549544">waitForBodyRead</span>&nbsp;<span class="op" id="3549560">!=</span>&nbsp;<span class="ident" id="3549563">nil</span>&nbsp;<span class="op" id="3549567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549572">select</span>&nbsp;<span class="op" id="3549579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549584">case</span>&nbsp;<span class="ident" id="3549589">alive</span>&nbsp;<span class="op" id="3549595">=</span>&nbsp;<span class="op" id="3549597">&lt;-</span><span class="ident" id="3549599">waitForBodyRead</span><span class="op" id="3549614">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549619">case</span>&nbsp;<span class="op" id="3549624">&lt;-</span><span class="ident" id="3549626">pc</span><span class="op" id="3549628">.</span><span class="ident" id="3549629">closech</span><span class="op" id="3549636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549642">alive</span>&nbsp;<span class="op" id="3549648">=</span>&nbsp;<span class="builtintype" id="3549650">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549668">pc</span><span class="op" id="3549670">.</span><span class="ident" id="3549671">t</span><span class="op" id="3549672">.</span><span class="ident" id="3549673">setReqCanceler</span><span class="op" id="3549687">(</span><span class="ident" id="3549688">rc</span><span class="op" id="3549690">.</span><span class="ident" id="3549691">req</span><span class="op" id="3549694">,</span>&nbsp;<span class="ident" id="3549696">nil</span><span class="op" id="3549699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549704">if</span>&nbsp;<span class="op" id="3549707">!</span><span class="ident" id="3549708">alive</span>&nbsp;<span class="op" id="3549714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549719">pc</span><span class="op" id="3549721">.</span><span class="builtinfunc" id="3549722">close</span><span class="op" id="3549727">(</span><span class="op" id="3549728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549732">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549735">}</span><br>
<span class="lineno"></span><span class="op" id="3549737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3549740">func</span>&nbsp;<span class="op" id="3549745">(</span><span class="ident" id="3549746">pc</span>&nbsp;<span class="op" id="3549749">*</span><span class="ident" id="3549750">persistConn</span><span class="op" id="3549761">)</span>&nbsp;<span class="ident" id="3549763">writeLoop</span><span class="op" id="3549772">(</span><span class="op" id="3549773">)</span>&nbsp;<span class="op" id="3549775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549778">for</span>&nbsp;<span class="op" id="3549782">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549786">select</span>&nbsp;<span class="op" id="3549793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549797">case</span>&nbsp;<span class="ident" id="3549802">wr</span>&nbsp;<span class="op" id="3549805">:=</span>&nbsp;<span class="op" id="3549808">&lt;-</span><span class="ident" id="3549810">pc</span><span class="op" id="3549812">.</span><span class="ident" id="3549813">writech</span><span class="op" id="3549820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549825">if</span>&nbsp;<span class="ident" id="3549828">pc</span><span class="op" id="3549830">.</span><span class="ident" id="3549831">isBroken</span><span class="op" id="3549839">(</span><span class="op" id="3549840">)</span>&nbsp;<span class="op" id="3549842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549848">wr</span><span class="op" id="3549850">.</span><span class="ident" id="3549851">ch</span>&nbsp;<span class="op" id="3549854">&lt;-</span>&nbsp;<span class="ident" id="3549857">errors</span><span class="op" id="3549863">.</span><span class="ident" id="3549864">New</span><span class="op" id="3549867">(</span><span class="string" id="3549868">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3549921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3549927">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3549939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3549944">err</span>&nbsp;<span class="op" id="3549948">:=</span>&nbsp;<span class="ident" id="3549951">wr</span><span class="op" id="3549953">.</span><span class="ident" id="3549954">req</span><span class="op" id="3549957">.</span><span class="ident" id="3549958">Request</span><span class="op" id="3549965">.</span><span class="ident" id="3549966">write</span><span class="op" id="3549971">(</span><span class="ident" id="3549972">pc</span><span class="op" id="3549974">.</span><span class="ident" id="3549975">bw</span><span class="op" id="3549977">,</span>&nbsp;<span class="ident" id="3549979">pc</span><span class="op" id="3549981">.</span><span class="ident" id="3549982">isProxy</span><span class="op" id="3549989">,</span>&nbsp;<span class="ident" id="3549991">wr</span><span class="op" id="3549993">.</span><span class="ident" id="3549994">req</span><span class="op" id="3549997">.</span><span class="ident" id="3549998">extra</span><span class="op" id="3550003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550008">if</span>&nbsp;<span class="ident" id="3550011">err</span>&nbsp;<span class="op" id="3550015">==</span>&nbsp;<span class="ident" id="3550018">nil</span>&nbsp;<span class="op" id="3550022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550028">err</span>&nbsp;<span class="op" id="3550032">=</span>&nbsp;<span class="ident" id="3550034">pc</span><span class="op" id="3550036">.</span><span class="ident" id="3550037">bw</span><span class="op" id="3550039">.</span><span class="ident" id="3550040">Flush</span><span class="op" id="3550045">(</span><span class="op" id="3550046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550051">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550056">if</span>&nbsp;<span class="ident" id="3550059">err</span>&nbsp;<span class="op" id="3550063">!=</span>&nbsp;<span class="ident" id="3550066">nil</span>&nbsp;<span class="op" id="3550070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550076">pc</span><span class="op" id="3550078">.</span><span class="ident" id="3550079">markBroken</span><span class="op" id="3550089">(</span><span class="op" id="3550090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550096">wr</span><span class="op" id="3550098">.</span><span class="ident" id="3550099">req</span><span class="op" id="3550102">.</span><span class="ident" id="3550103">Request</span><span class="op" id="3550110">.</span><span class="ident" id="3550111">closeBody</span><span class="op" id="3550120">(</span><span class="op" id="3550121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550131">pc</span><span class="op" id="3550133">.</span><span class="ident" id="3550134">writeErrCh</span>&nbsp;<span class="op" id="3550145">&lt;-</span>&nbsp;<span class="ident" id="3550148">err</span>&nbsp;<span class="comment" id="3550152">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3550201">wr</span><span class="op" id="3550203">.</span><span class="ident" id="3550204">ch</span>&nbsp;<span class="op" id="3550207">&lt;-</span>&nbsp;<span class="ident" id="3550210">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3550222">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550253">case</span>&nbsp;<span class="op" id="3550258">&lt;-</span><span class="ident" id="3550260">pc</span><span class="op" id="3550262">.</span><span class="ident" id="3550263">closech</span><span class="op" id="3550270">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3550287">}</span><br>
<span class="lineno">965</span><span class="op" id="3550289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3550292">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3550373">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3550428">func</span>&nbsp;<span class="op" id="3550433">(</span><span class="ident" id="3550434">pc</span>&nbsp;<span class="op" id="3550437">*</span><span class="ident" id="3550438">persistConn</span><span class="op" id="3550449">)</span>&nbsp;<span class="ident" id="3550451">wroteRequest</span><span class="op" id="3550463">(</span><span class="op" id="3550464">)</span>&nbsp;<span class="builtintype" id="3550466">bool</span>&nbsp;<span class="op" id="3550471">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550474">select</span>&nbsp;<span class="op" id="3550481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550484">case</span>&nbsp;<span class="ident" id="3550489">err</span>&nbsp;<span class="op" id="3550493">:=</span>&nbsp;<span class="op" id="3550496">&lt;-</span><span class="ident" id="3550498">pc</span><span class="op" id="3550500">.</span><span class="ident" id="3550501">writeErrCh</span><span class="op" id="3550511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550515">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550581">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550610">return</span>&nbsp;<span class="ident" id="3550617">err</span>&nbsp;<span class="op" id="3550621">==</span>&nbsp;<span class="ident" id="3550624">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3550629">default</span><span class="op" id="3550636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550640">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550703">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550766">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550833">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550888">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550893">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3550957">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551022">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551086">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551150">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3551181">select</span>&nbsp;<span class="op" id="3551188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3551192">case</span>&nbsp;<span class="ident" id="3551197">err</span>&nbsp;<span class="op" id="3551201">:=</span>&nbsp;<span class="op" id="3551204">&lt;-</span><span class="ident" id="3551206">pc</span><span class="op" id="3551208">.</span><span class="ident" id="3551209">writeErrCh</span><span class="op" id="3551219">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3551224">return</span>&nbsp;<span class="ident" id="3551231">err</span>&nbsp;<span class="op" id="3551235">==</span>&nbsp;<span class="ident" id="3551238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3551244">case</span>&nbsp;<span class="op" id="3551249">&lt;-</span><span class="ident" id="3551251">time</span><span class="op" id="3551255">.</span><span class="ident" id="3551256">After</span><span class="op" id="3551261">(</span><span class="num" id="3551262">50</span>&nbsp;<span class="op" id="3551265">*</span>&nbsp;<span class="ident" id="3551267">time</span><span class="op" id="3551271">.</span><span class="ident" id="3551272">Millisecond</span><span class="op" id="3551283">)</span><span class="op" id="3551284">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3551289">return</span>&nbsp;<span class="builtintype" id="3551296">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3551304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3551307">}</span><br>
<span class="lineno"></span><span class="op" id="3551309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3551312">type</span>&nbsp;<span class="ident" id="3551317">responseAndError</span>&nbsp;<span class="keyword" id="3551334">struct</span>&nbsp;<span class="op" id="3551341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551344">res</span>&nbsp;<span class="op" id="3551348">*</span><span class="ident" id="3551349">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551359">err</span>&nbsp;<span class="builtintype" id="3551363">error</span><br>
<span class="lineno"></span><span class="op" id="3551369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3551372">type</span>&nbsp;<span class="ident" id="3551377">requestAndChan</span>&nbsp;<span class="keyword" id="3551392">struct</span>&nbsp;<span class="op" id="3551399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551402">req</span>&nbsp;<span class="op" id="3551406">*</span><span class="ident" id="3551407">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551416">ch</span>&nbsp;&nbsp;<span class="keyword" id="3551420">chan</span>&nbsp;<span class="ident" id="3551425">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551444">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551505">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3551562">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551600">addedGzip</span>&nbsp;<span class="builtintype" id="3551610">bool</span><br>
<span class="lineno"></span><span class="op" id="3551615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3551618">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3551679">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3551743">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3551809">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3551819">type</span>&nbsp;<span class="ident" id="3551824">writeRequest</span>&nbsp;<span class="keyword" id="3551837">struct</span>&nbsp;<span class="op" id="3551844">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551847">req</span>&nbsp;<span class="op" id="3551851">*</span><span class="ident" id="3551852">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551870">ch</span>&nbsp;&nbsp;<span class="keyword" id="3551874">chan</span><span class="op" id="3551878">&lt;-</span>&nbsp;<span class="builtintype" id="3551881">error</span><br>
<span class="lineno"></span><span class="op" id="3551887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3551890">type</span>&nbsp;<span class="ident" id="3551895">httpError</span>&nbsp;<span class="keyword" id="3551905">struct</span>&nbsp;<span class="op" id="3551912">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551915">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3551923">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3551931">timeout</span>&nbsp;<span class="builtintype" id="3551939">bool</span><br>
<span class="lineno"></span><span class="op" id="3551944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3551947">func</span>&nbsp;<span class="op" id="3551952">(</span><span class="ident" id="3551953">e</span>&nbsp;<span class="op" id="3551955">*</span><span class="ident" id="3551956">httpError</span><span class="op" id="3551965">)</span>&nbsp;<span class="ident" id="3551967">Error</span><span class="op" id="3551972">(</span><span class="op" id="3551973">)</span>&nbsp;<span class="builtintype" id="3551975">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3551984">{</span>&nbsp;<span class="keyword" id="3551986">return</span>&nbsp;<span class="ident" id="3551993">e</span><span class="op" id="3551994">.</span><span class="ident" id="3551995">err</span>&nbsp;<span class="op" id="3551999">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3552001">func</span>&nbsp;<span class="op" id="3552006">(</span><span class="ident" id="3552007">e</span>&nbsp;<span class="op" id="3552009">*</span><span class="ident" id="3552010">httpError</span><span class="op" id="3552019">)</span>&nbsp;<span class="ident" id="3552021">Timeout</span><span class="op" id="3552028">(</span><span class="op" id="3552029">)</span>&nbsp;<span class="builtintype" id="3552031">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3552038">{</span>&nbsp;<span class="keyword" id="3552040">return</span>&nbsp;<span class="ident" id="3552047">e</span><span class="op" id="3552048">.</span><span class="ident" id="3552049">timeout</span>&nbsp;<span class="op" id="3552057">}</span><br>
<span class="lineno"></span><span class="keyword" id="3552059">func</span>&nbsp;<span class="op" id="3552064">(</span><span class="ident" id="3552065">e</span>&nbsp;<span class="op" id="3552067">*</span><span class="ident" id="3552068">httpError</span><span class="op" id="3552077">)</span>&nbsp;<span class="ident" id="3552079">Temporary</span><span class="op" id="3552088">(</span><span class="op" id="3552089">)</span>&nbsp;<span class="builtintype" id="3552091">bool</span>&nbsp;<span class="op" id="3552096">{</span>&nbsp;<span class="keyword" id="3552098">return</span>&nbsp;<span class="builtintype" id="3552105">true</span>&nbsp;<span class="op" id="3552110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3552113">var</span>&nbsp;<span class="ident" id="3552117">errTimeout</span>&nbsp;<span class="builtintype" id="3552128">error</span>&nbsp;<span class="op" id="3552134">=</span>&nbsp;<span class="op" id="3552136">&amp;</span><span class="ident" id="3552137">httpError</span><span class="op" id="3552146">{</span><span class="ident" id="3552147">err</span><span class="op" id="3552150">:</span>&nbsp;<span class="string" id="3552152">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3552197">,</span>&nbsp;<span class="ident" id="3552199">timeout</span><span class="op" id="3552206">:</span>&nbsp;<span class="builtintype" id="3552208">true</span><span class="op" id="3552212">}</span><br>
<span class="lineno"></span><span class="keyword" id="3552214">var</span>&nbsp;<span class="ident" id="3552218">errClosed</span>&nbsp;<span class="builtintype" id="3552228">error</span>&nbsp;<span class="op" id="3552234">=</span>&nbsp;<span class="op" id="3552236">&amp;</span><span class="ident" id="3552237">httpError</span><span class="op" id="3552246">{</span><span class="ident" id="3552247">err</span><span class="op" id="3552250">:</span>&nbsp;<span class="string" id="3552252">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3552309">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3552312">func</span>&nbsp;<span class="op" id="3552317">(</span><span class="ident" id="3552318">pc</span>&nbsp;<span class="op" id="3552321">*</span><span class="ident" id="3552322">persistConn</span><span class="op" id="3552333">)</span>&nbsp;<span class="ident" id="3552335">roundTrip</span><span class="op" id="3552344">(</span><span class="ident" id="3552345">req</span>&nbsp;<span class="op" id="3552349">*</span><span class="ident" id="3552350">transportRequest</span><span class="op" id="3552366">)</span>&nbsp;<span class="op" id="3552368">(</span><span class="ident" id="3552369">resp</span>&nbsp;<span class="op" id="3552374">*</span><span class="ident" id="3552375">Response</span><span class="op" id="3552383">,</span>&nbsp;<span class="ident" id="3552385">err</span>&nbsp;<span class="builtintype" id="3552389">error</span><span class="op" id="3552394">)</span>&nbsp;<span class="op" id="3552396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552399">pc</span><span class="op" id="3552401">.</span><span class="ident" id="3552402">t</span><span class="op" id="3552403">.</span><span class="ident" id="3552404">setReqCanceler</span><span class="op" id="3552418">(</span><span class="ident" id="3552419">req</span><span class="op" id="3552422">.</span><span class="ident" id="3552423">Request</span><span class="op" id="3552430">,</span>&nbsp;<span class="ident" id="3552432">pc</span><span class="op" id="3552434">.</span><span class="ident" id="3552435">cancelRequest</span><span class="op" id="3552448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552451">pc</span><span class="op" id="3552453">.</span><span class="ident" id="3552454">lk</span><span class="op" id="3552456">.</span><span class="ident" id="3552457">Lock</span><span class="op" id="3552461">(</span><span class="op" id="3552462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552465">pc</span><span class="op" id="3552467">.</span><span class="ident" id="3552468">numExpectedResponses</span><span class="op" id="3552488">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552492">headerFn</span>&nbsp;<span class="op" id="3552501">:=</span>&nbsp;<span class="ident" id="3552504">pc</span><span class="op" id="3552506">.</span><span class="ident" id="3552507">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552525">pc</span><span class="op" id="3552527">.</span><span class="ident" id="3552528">lk</span><span class="op" id="3552530">.</span><span class="ident" id="3552531">Unlock</span><span class="op" id="3552537">(</span><span class="op" id="3552538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552542">if</span>&nbsp;<span class="ident" id="3552545">headerFn</span>&nbsp;<span class="op" id="3552554">!=</span>&nbsp;<span class="ident" id="3552557">nil</span>&nbsp;<span class="op" id="3552561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552565">headerFn</span><span class="op" id="3552573">(</span><span class="ident" id="3552574">req</span><span class="op" id="3552577">.</span><span class="ident" id="3552578">extraHeaders</span><span class="op" id="3552590">(</span><span class="op" id="3552591">)</span><span class="op" id="3552592">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3552595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3552599">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3552663">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3552717">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3552774">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552792">requestedGzip</span>&nbsp;<span class="op" id="3552806">:=</span>&nbsp;<span class="builtintype" id="3552809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3552816">if</span>&nbsp;<span class="op" id="3552819">!</span><span class="ident" id="3552820">pc</span><span class="op" id="3552822">.</span><span class="ident" id="3552823">t</span><span class="op" id="3552824">.</span><span class="ident" id="3552825">DisableCompression</span>&nbsp;<span class="op" id="3552844">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552849">req</span><span class="op" id="3552852">.</span><span class="ident" id="3552853">Header</span><span class="op" id="3552859">.</span><span class="ident" id="3552860">Get</span><span class="op" id="3552863">(</span><span class="string" id="3552864">&#34;Accept-Encoding&#34;</span><span class="op" id="3552881">)</span>&nbsp;<span class="op" id="3552883">==</span>&nbsp;<span class="string" id="3552886">&#34;&#34;</span>&nbsp;<span class="op" id="3552889">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552894">req</span><span class="op" id="3552897">.</span><span class="ident" id="3552898">Header</span><span class="op" id="3552904">.</span><span class="ident" id="3552905">Get</span><span class="op" id="3552908">(</span><span class="string" id="3552909">&#34;Range&#34;</span><span class="op" id="3552916">)</span>&nbsp;<span class="op" id="3552918">==</span>&nbsp;<span class="string" id="3552921">&#34;&#34;</span>&nbsp;<span class="op" id="3552924">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3552929">req</span><span class="op" id="3552932">.</span><span class="ident" id="3552933">Method</span>&nbsp;<span class="op" id="3552940">!=</span>&nbsp;<span class="string" id="3552943">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3552950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3552954">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553016">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553058">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553113">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553118">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553174">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553202">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553248">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553284">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553289">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553353">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553419">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553465">requestedGzip</span>&nbsp;<span class="op" id="3553479">=</span>&nbsp;<span class="builtintype" id="3553481">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553488">req</span><span class="op" id="3553491">.</span><span class="ident" id="3553492">extraHeaders</span><span class="op" id="3553504">(</span><span class="op" id="3553505">)</span><span class="op" id="3553506">.</span><span class="ident" id="3553507">Set</span><span class="op" id="3553510">(</span><span class="string" id="3553511">&#34;Accept-Encoding&#34;</span><span class="op" id="3553528">,</span>&nbsp;<span class="string" id="3553530">&#34;gzip&#34;</span><span class="op" id="3553536">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3553539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553543">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553607">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3553671">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553689">writeErrCh</span>&nbsp;<span class="op" id="3553700">:=</span>&nbsp;<span class="builtinfunc" id="3553703">make</span><span class="op" id="3553707">(</span><span class="keyword" id="3553708">chan</span>&nbsp;<span class="builtintype" id="3553713">error</span><span class="op" id="3553718">,</span>&nbsp;<span class="num" id="3553720">1</span><span class="op" id="3553721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553724">pc</span><span class="op" id="3553726">.</span><span class="ident" id="3553727">writech</span>&nbsp;<span class="op" id="3553735">&lt;-</span>&nbsp;<span class="ident" id="3553738">writeRequest</span><span class="op" id="3553750">{</span><span class="ident" id="3553751">req</span><span class="op" id="3553754">,</span>&nbsp;<span class="ident" id="3553756">writeErrCh</span><span class="op" id="3553766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553770">resc</span>&nbsp;<span class="op" id="3553775">:=</span>&nbsp;<span class="builtinfunc" id="3553778">make</span><span class="op" id="3553782">(</span><span class="keyword" id="3553783">chan</span>&nbsp;<span class="ident" id="3553788">responseAndError</span><span class="op" id="3553804">,</span>&nbsp;<span class="num" id="3553806">1</span><span class="op" id="3553807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3553810">pc</span><span class="op" id="3553812">.</span><span class="ident" id="3553813">reqch</span>&nbsp;<span class="op" id="3553819">&lt;-</span>&nbsp;<span class="ident" id="3553822">requestAndChan</span><span class="op" id="3553836">{</span><span class="ident" id="3553837">req</span><span class="op" id="3553840">.</span><span class="ident" id="3553841">Request</span><span class="op" id="3553848">,</span>&nbsp;<span class="ident" id="3553850">resc</span><span class="op" id="3553854">,</span>&nbsp;<span class="ident" id="3553856">requestedGzip</span><span class="op" id="3553869">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3553873">var</span>&nbsp;<span class="ident" id="3553877">re</span>&nbsp;<span class="ident" id="3553880">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3553898">var</span>&nbsp;<span class="ident" id="3553902">pconnDeadCh</span>&nbsp;<span class="op" id="3553914">=</span>&nbsp;<span class="ident" id="3553916">pc</span><span class="op" id="3553918">.</span><span class="ident" id="3553919">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3553928">var</span>&nbsp;<span class="ident" id="3553932">failTicker</span>&nbsp;<span class="op" id="3553943">&lt;-</span><span class="keyword" id="3553945">chan</span>&nbsp;<span class="ident" id="3553950">time</span><span class="op" id="3553954">.</span><span class="ident" id="3553955">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3553961">var</span>&nbsp;<span class="ident" id="3553965">respHeaderTimer</span>&nbsp;<span class="op" id="3553981">&lt;-</span><span class="keyword" id="3553983">chan</span>&nbsp;<span class="ident" id="3553988">time</span><span class="op" id="3553992">.</span><span class="ident" id="3553993">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3553998">WaitResponse</span><span class="op" id="3554010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554013">for</span>&nbsp;<span class="op" id="3554017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554021">select</span>&nbsp;<span class="op" id="3554028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554032">case</span>&nbsp;<span class="ident" id="3554037">err</span>&nbsp;<span class="op" id="3554041">:=</span>&nbsp;<span class="op" id="3554044">&lt;-</span><span class="ident" id="3554046">writeErrCh</span><span class="op" id="3554056">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554061">if</span>&nbsp;<span class="ident" id="3554064">err</span>&nbsp;<span class="op" id="3554068">!=</span>&nbsp;<span class="ident" id="3554071">nil</span>&nbsp;<span class="op" id="3554075">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3554081">re</span>&nbsp;<span class="op" id="3554084">=</span>&nbsp;<span class="ident" id="3554086">responseAndError</span><span class="op" id="3554102">{</span><span class="ident" id="3554103">nil</span><span class="op" id="3554106">,</span>&nbsp;<span class="ident" id="3554108">err</span><span class="op" id="3554111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3554117">pc</span><span class="op" id="3554119">.</span><span class="builtinfunc" id="3554120">close</span><span class="op" id="3554125">(</span><span class="op" id="3554126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554132">break</span>&nbsp;<span class="ident" id="3554138">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3554154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554159">if</span>&nbsp;<span class="ident" id="3554162">d</span>&nbsp;<span class="op" id="3554164">:=</span>&nbsp;<span class="ident" id="3554167">pc</span><span class="op" id="3554169">.</span><span class="ident" id="3554170">t</span><span class="op" id="3554171">.</span><span class="ident" id="3554172">ResponseHeaderTimeout</span><span class="op" id="3554193">;</span>&nbsp;<span class="ident" id="3554195">d</span>&nbsp;<span class="op" id="3554197">&gt;</span>&nbsp;<span class="num" id="3554199">0</span>&nbsp;<span class="op" id="3554201">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3554207">respHeaderTimer</span>&nbsp;<span class="op" id="3554223">=</span>&nbsp;<span class="ident" id="3554225">time</span><span class="op" id="3554229">.</span><span class="ident" id="3554230">After</span><span class="op" id="3554235">(</span><span class="ident" id="3554236">d</span><span class="op" id="3554237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3554242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3554246">case</span>&nbsp;<span class="op" id="3554251">&lt;-</span><span class="ident" id="3554253">pconnDeadCh</span><span class="op" id="3554264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554269">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554322">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554382">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554439">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554493">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554552">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554610">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554667">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554701">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554707">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554772">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3554828">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3554871">pconnDeadCh</span>&nbsp;<span class="op" id="3554883">=</span>&nbsp;<span class="ident" id="3554885">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3554919">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3554940">failTicker</span>&nbsp;<span class="op" id="3554951">=</span>&nbsp;<span class="ident" id="3554953">time</span><span class="op" id="3554957">.</span><span class="ident" id="3554958">After</span><span class="op" id="3554963">(</span><span class="num" id="3554964">100</span>&nbsp;<span class="op" id="3554968">*</span>&nbsp;<span class="ident" id="3554970">time</span><span class="op" id="3554974">.</span><span class="ident" id="3554975">Millisecond</span><span class="op" id="3554986">)</span>&nbsp;<span class="comment" id="3554988">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555025">case</span>&nbsp;<span class="op" id="3555030">&lt;-</span><span class="ident" id="3555032">failTicker</span><span class="op" id="3555042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555047">re</span>&nbsp;<span class="op" id="3555050">=</span>&nbsp;<span class="ident" id="3555052">responseAndError</span><span class="op" id="3555068">{</span><span class="ident" id="3555069">err</span><span class="op" id="3555072">:</span>&nbsp;<span class="ident" id="3555074">errClosed</span><span class="op" id="3555083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555088">break</span>&nbsp;<span class="ident" id="3555094">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555109">case</span>&nbsp;<span class="op" id="3555114">&lt;-</span><span class="ident" id="3555116">respHeaderTimer</span><span class="op" id="3555131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555136">pc</span><span class="op" id="3555138">.</span><span class="builtinfunc" id="3555139">close</span><span class="op" id="3555144">(</span><span class="op" id="3555145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555150">re</span>&nbsp;<span class="op" id="3555153">=</span>&nbsp;<span class="ident" id="3555155">responseAndError</span><span class="op" id="3555171">{</span><span class="ident" id="3555172">err</span><span class="op" id="3555175">:</span>&nbsp;<span class="ident" id="3555177">errTimeout</span><span class="op" id="3555187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555192">break</span>&nbsp;<span class="ident" id="3555198">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555213">case</span>&nbsp;<span class="ident" id="3555218">re</span>&nbsp;<span class="op" id="3555221">=</span>&nbsp;<span class="op" id="3555223">&lt;-</span><span class="ident" id="3555225">resc</span><span class="op" id="3555229">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555234">break</span>&nbsp;<span class="ident" id="3555240">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3555255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3555258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555262">pc</span><span class="op" id="3555264">.</span><span class="ident" id="3555265">lk</span><span class="op" id="3555267">.</span><span class="ident" id="3555268">Lock</span><span class="op" id="3555272">(</span><span class="op" id="3555273">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555276">pc</span><span class="op" id="3555278">.</span><span class="ident" id="3555279">numExpectedResponses</span><span class="op" id="3555299">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555303">pc</span><span class="op" id="3555305">.</span><span class="ident" id="3555306">lk</span><span class="op" id="3555308">.</span><span class="ident" id="3555309">Unlock</span><span class="op" id="3555315">(</span><span class="op" id="3555316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555320">if</span>&nbsp;<span class="ident" id="3555323">re</span><span class="op" id="3555325">.</span><span class="ident" id="3555326">err</span>&nbsp;<span class="op" id="3555330">!=</span>&nbsp;<span class="ident" id="3555333">nil</span>&nbsp;<span class="op" id="3555337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555341">pc</span><span class="op" id="3555343">.</span><span class="ident" id="3555344">t</span><span class="op" id="3555345">.</span><span class="ident" id="3555346">setReqCanceler</span><span class="op" id="3555360">(</span><span class="ident" id="3555361">req</span><span class="op" id="3555364">.</span><span class="ident" id="3555365">Request</span><span class="op" id="3555372">,</span>&nbsp;<span class="ident" id="3555374">nil</span><span class="op" id="3555377">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3555380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555383">return</span>&nbsp;<span class="ident" id="3555390">re</span><span class="op" id="3555392">.</span><span class="ident" id="3555393">res</span><span class="op" id="3555396">,</span>&nbsp;<span class="ident" id="3555398">re</span><span class="op" id="3555400">.</span><span class="ident" id="3555401">err</span><br>
<span class="lineno"></span><span class="op" id="3555405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3555408">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3555473">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3555538">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3555588">func</span>&nbsp;<span class="op" id="3555593">(</span><span class="ident" id="3555594">pc</span>&nbsp;<span class="op" id="3555597">*</span><span class="ident" id="3555598">persistConn</span><span class="op" id="3555609">)</span>&nbsp;<span class="ident" id="3555611">markBroken</span><span class="op" id="3555621">(</span><span class="op" id="3555622">)</span>&nbsp;<span class="op" id="3555624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555627">pc</span><span class="op" id="3555629">.</span><span class="ident" id="3555630">lk</span><span class="op" id="3555632">.</span><span class="ident" id="3555633">Lock</span><span class="op" id="3555637">(</span><span class="op" id="3555638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555641">defer</span>&nbsp;<span class="ident" id="3555647">pc</span><span class="op" id="3555649">.</span><span class="ident" id="3555650">lk</span><span class="op" id="3555652">.</span><span class="ident" id="3555653">Unlock</span><span class="op" id="3555659">(</span><span class="op" id="3555660">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555663">pc</span><span class="op" id="3555665">.</span><span class="ident" id="3555666">broken</span>&nbsp;<span class="op" id="3555673">=</span>&nbsp;<span class="builtintype" id="3555675">true</span><br>
<span class="lineno"></span><span class="op" id="3555680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3555683">func</span>&nbsp;<span class="op" id="3555688">(</span><span class="ident" id="3555689">pc</span>&nbsp;<span class="op" id="3555692">*</span><span class="ident" id="3555693">persistConn</span><span class="op" id="3555704">)</span>&nbsp;<span class="builtinfunc" id="3555706">close</span><span class="op" id="3555711">(</span><span class="op" id="3555712">)</span>&nbsp;<span class="op" id="3555714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555717">pc</span><span class="op" id="3555719">.</span><span class="ident" id="3555720">lk</span><span class="op" id="3555722">.</span><span class="ident" id="3555723">Lock</span><span class="op" id="3555727">(</span><span class="op" id="3555728">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555731">defer</span>&nbsp;<span class="ident" id="3555737">pc</span><span class="op" id="3555739">.</span><span class="ident" id="3555740">lk</span><span class="op" id="3555742">.</span><span class="ident" id="3555743">Unlock</span><span class="op" id="3555749">(</span><span class="op" id="3555750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555753">pc</span><span class="op" id="3555755">.</span><span class="ident" id="3555756">closeLocked</span><span class="op" id="3555767">(</span><span class="op" id="3555768">)</span><br>
<span class="lineno"></span><span class="op" id="3555770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3555773">func</span>&nbsp;<span class="op" id="3555778">(</span><span class="ident" id="3555779">pc</span>&nbsp;<span class="op" id="3555782">*</span><span class="ident" id="3555783">persistConn</span><span class="op" id="3555794">)</span>&nbsp;<span class="ident" id="3555796">closeLocked</span><span class="op" id="3555807">(</span><span class="op" id="3555808">)</span>&nbsp;<span class="op" id="3555810">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555813">pc</span><span class="op" id="3555815">.</span><span class="ident" id="3555816">broken</span>&nbsp;<span class="op" id="3555823">=</span>&nbsp;<span class="builtintype" id="3555825">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3555831">if</span>&nbsp;<span class="op" id="3555834">!</span><span class="ident" id="3555835">pc</span><span class="op" id="3555837">.</span><span class="ident" id="3555838">closed</span>&nbsp;<span class="op" id="3555845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555849">pc</span><span class="op" id="3555851">.</span><span class="ident" id="3555852">conn</span><span class="op" id="3555856">.</span><span class="ident" id="3555857">Close</span><span class="op" id="3555862">(</span><span class="op" id="3555863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555867">pc</span><span class="op" id="3555869">.</span><span class="ident" id="3555870">closed</span>&nbsp;<span class="op" id="3555877">=</span>&nbsp;<span class="builtintype" id="3555879">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3555886">close</span><span class="op" id="3555891">(</span><span class="ident" id="3555892">pc</span><span class="op" id="3555894">.</span><span class="ident" id="3555895">closech</span><span class="op" id="3555902">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3555905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3555908">pc</span><span class="op" id="3555910">.</span><span class="ident" id="3555911">mutateHeaderFunc</span>&nbsp;<span class="op" id="3555928">=</span>&nbsp;<span class="ident" id="3555930">nil</span><br>
<span class="lineno"></span><span class="op" id="3555934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3555937">var</span>&nbsp;<span class="ident" id="3555941">portMap</span>&nbsp;<span class="op" id="3555949">=</span>&nbsp;<span class="keyword" id="3555951">map</span><span class="op" id="3555954">[</span><span class="builtintype" id="3555955">string</span><span class="op" id="3555961">]</span><span class="builtintype" id="3555962">string</span><span class="op" id="3555968">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3555971">&#34;http&#34;</span><span class="op" id="3555977">:</span>&nbsp;&nbsp;<span class="string" id="3555980">&#34;80&#34;</span><span class="op" id="3555984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3555987">&#34;https&#34;</span><span class="op" id="3555994">:</span>&nbsp;<span class="string" id="3555996">&#34;443&#34;</span><span class="op" id="3556001">,</span><br>
<span class="lineno"></span><span class="op" id="3556003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556006">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3556073">func</span>&nbsp;<span class="ident" id="3556078">canonicalAddr</span><span class="op" id="3556091">(</span><span class="ident" id="3556092">url</span>&nbsp;<span class="op" id="3556096">*</span><span class="ident" id="3556097">url</span><span class="op" id="3556100">.</span><span class="ident" id="3556101">URL</span><span class="op" id="3556104">)</span>&nbsp;<span class="builtintype" id="3556106">string</span>&nbsp;<span class="op" id="3556113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556116">addr</span>&nbsp;<span class="op" id="3556121">:=</span>&nbsp;<span class="ident" id="3556124">url</span><span class="op" id="3556127">.</span><span class="ident" id="3556128">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3556134">if</span>&nbsp;<span class="op" id="3556137">!</span><span class="ident" id="3556138">hasPort</span><span class="op" id="3556145">(</span><span class="ident" id="3556146">addr</span><span class="op" id="3556150">)</span>&nbsp;<span class="op" id="3556152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3556156">return</span>&nbsp;<span class="ident" id="3556163">addr</span>&nbsp;<span class="op" id="3556168">+</span>&nbsp;<span class="string" id="3556170">&#34;:&#34;</span>&nbsp;<span class="op" id="3556174">+</span>&nbsp;<span class="ident" id="3556176">portMap</span><span class="op" id="3556183">[</span><span class="ident" id="3556184">url</span><span class="op" id="3556187">.</span><span class="ident" id="3556188">Scheme</span><span class="op" id="3556194">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3556197">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3556200">return</span>&nbsp;<span class="ident" id="3556207">addr</span><br>
<span class="lineno"></span><span class="op" id="3556212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3556215">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3556284">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3556353">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3556419">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3556484">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3556532">type</span>&nbsp;<span class="ident" id="3556537">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3556551">struct</span>&nbsp;<span class="op" id="3556558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556561">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556574">io</span><span class="op" id="3556576">.</span><span class="ident" id="3556577">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556589">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3556602">sync</span><span class="op" id="3556606">.</span><span class="ident" id="3556607">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3556615">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556645">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3556658">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3556671">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556705">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3556718">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3556731">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556753">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3556766">func</span><span class="op" id="3556770">(</span><span class="builtintype" id="3556771">error</span><span class="op" id="3556776">)</span>&nbsp;&nbsp;<span class="comment" id="3556779">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556816">earlyCloseFn</span>&nbsp;<span class="keyword" id="3556829">func</span><span class="op" id="3556833">(</span><span class="op" id="3556834">)</span>&nbsp;<span class="builtintype" id="3556836">error</span>&nbsp;<span class="comment" id="3556842">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3556893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3556896">func</span>&nbsp;<span class="op" id="3556901">(</span><span class="ident" id="3556902">es</span>&nbsp;<span class="op" id="3556905">*</span><span class="ident" id="3556906">bodyEOFSignal</span><span class="op" id="3556919">)</span>&nbsp;<span class="ident" id="3556921">Read</span><span class="op" id="3556925">(</span><span class="ident" id="3556926">p</span>&nbsp;<span class="op" id="3556928">[</span><span class="op" id="3556929">]</span><span class="builtintype" id="3556930">byte</span><span class="op" id="3556934">)</span>&nbsp;<span class="op" id="3556936">(</span><span class="ident" id="3556937">n</span>&nbsp;<span class="builtintype" id="3556939">int</span><span class="op" id="3556942">,</span>&nbsp;<span class="ident" id="3556944">err</span>&nbsp;<span class="builtintype" id="3556948">error</span><span class="op" id="3556953">)</span>&nbsp;<span class="op" id="3556955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556958">es</span><span class="op" id="3556960">.</span><span class="ident" id="3556961">mu</span><span class="op" id="3556963">.</span><span class="ident" id="3556964">Lock</span><span class="op" id="3556968">(</span><span class="op" id="3556969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3556972">closed</span><span class="op" id="3556978">,</span>&nbsp;<span class="ident" id="3556980">rerr</span>&nbsp;<span class="op" id="3556985">:=</span>&nbsp;<span class="ident" id="3556988">es</span><span class="op" id="3556990">.</span><span class="ident" id="3556991">closed</span><span class="op" id="3556997">,</span>&nbsp;<span class="ident" id="3556999">es</span><span class="op" id="3557001">.</span><span class="ident" id="3557002">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557008">es</span><span class="op" id="3557010">.</span><span class="ident" id="3557011">mu</span><span class="op" id="3557013">.</span><span class="ident" id="3557014">Unlock</span><span class="op" id="3557020">(</span><span class="op" id="3557021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557024">if</span>&nbsp;<span class="ident" id="3557027">closed</span>&nbsp;<span class="op" id="3557034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557038">return</span>&nbsp;<span class="num" id="3557045">0</span><span class="op" id="3557046">,</span>&nbsp;<span class="ident" id="3557048">errors</span><span class="op" id="3557054">.</span><span class="ident" id="3557055">New</span><span class="op" id="3557058">(</span><span class="string" id="3557059">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3557095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557101">if</span>&nbsp;<span class="ident" id="3557104">rerr</span>&nbsp;<span class="op" id="3557109">!=</span>&nbsp;<span class="ident" id="3557112">nil</span>&nbsp;<span class="op" id="3557116">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557120">return</span>&nbsp;<span class="num" id="3557127">0</span><span class="op" id="3557128">,</span>&nbsp;<span class="ident" id="3557130">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557140">n</span><span class="op" id="3557141">,</span>&nbsp;<span class="ident" id="3557143">err</span>&nbsp;<span class="op" id="3557147">=</span>&nbsp;<span class="ident" id="3557149">es</span><span class="op" id="3557151">.</span><span class="ident" id="3557152">body</span><span class="op" id="3557156">.</span><span class="ident" id="3557157">Read</span><span class="op" id="3557161">(</span><span class="ident" id="3557162">p</span><span class="op" id="3557163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557166">if</span>&nbsp;<span class="ident" id="3557169">err</span>&nbsp;<span class="op" id="3557173">!=</span>&nbsp;<span class="ident" id="3557176">nil</span>&nbsp;<span class="op" id="3557180">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557184">es</span><span class="op" id="3557186">.</span><span class="ident" id="3557187">mu</span><span class="op" id="3557189">.</span><span class="ident" id="3557190">Lock</span><span class="op" id="3557194">(</span><span class="op" id="3557195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557199">defer</span>&nbsp;<span class="ident" id="3557205">es</span><span class="op" id="3557207">.</span><span class="ident" id="3557208">mu</span><span class="op" id="3557210">.</span><span class="ident" id="3557211">Unlock</span><span class="op" id="3557217">(</span><span class="op" id="3557218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557222">if</span>&nbsp;<span class="ident" id="3557225">es</span><span class="op" id="3557227">.</span><span class="ident" id="3557228">rerr</span>&nbsp;<span class="op" id="3557233">==</span>&nbsp;<span class="ident" id="3557236">nil</span>&nbsp;<span class="op" id="3557240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557245">es</span><span class="op" id="3557247">.</span><span class="ident" id="3557248">rerr</span>&nbsp;<span class="op" id="3557253">=</span>&nbsp;<span class="ident" id="3557255">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557261">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557265">es</span><span class="op" id="3557267">.</span><span class="ident" id="3557268">condfn</span><span class="op" id="3557274">(</span><span class="ident" id="3557275">err</span><span class="op" id="3557278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557284">return</span><br>
<span class="lineno"></span><span class="op" id="3557291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3557294">func</span>&nbsp;<span class="op" id="3557299">(</span><span class="ident" id="3557300">es</span>&nbsp;<span class="op" id="3557303">*</span><span class="ident" id="3557304">bodyEOFSignal</span><span class="op" id="3557317">)</span>&nbsp;<span class="ident" id="3557319">Close</span><span class="op" id="3557324">(</span><span class="op" id="3557325">)</span>&nbsp;<span class="builtintype" id="3557327">error</span>&nbsp;<span class="op" id="3557333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557336">es</span><span class="op" id="3557338">.</span><span class="ident" id="3557339">mu</span><span class="op" id="3557341">.</span><span class="ident" id="3557342">Lock</span><span class="op" id="3557346">(</span><span class="op" id="3557347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557350">defer</span>&nbsp;<span class="ident" id="3557356">es</span><span class="op" id="3557358">.</span><span class="ident" id="3557359">mu</span><span class="op" id="3557361">.</span><span class="ident" id="3557362">Unlock</span><span class="op" id="3557368">(</span><span class="op" id="3557369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557372">if</span>&nbsp;<span class="ident" id="3557375">es</span><span class="op" id="3557377">.</span><span class="ident" id="3557378">closed</span>&nbsp;<span class="op" id="3557385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557389">return</span>&nbsp;<span class="ident" id="3557396">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557404">es</span><span class="op" id="3557406">.</span><span class="ident" id="3557407">closed</span>&nbsp;<span class="op" id="3557414">=</span>&nbsp;<span class="builtintype" id="3557416">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557422">if</span>&nbsp;<span class="ident" id="3557425">es</span><span class="op" id="3557427">.</span><span class="ident" id="3557428">earlyCloseFn</span>&nbsp;<span class="op" id="3557441">!=</span>&nbsp;<span class="ident" id="3557444">nil</span>&nbsp;<span class="op" id="3557448">&amp;&amp;</span>&nbsp;<span class="ident" id="3557451">es</span><span class="op" id="3557453">.</span><span class="ident" id="3557454">rerr</span>&nbsp;<span class="op" id="3557459">!=</span>&nbsp;<span class="ident" id="3557462">io</span><span class="op" id="3557464">.</span><span class="ident" id="3557465">EOF</span>&nbsp;<span class="op" id="3557469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557473">return</span>&nbsp;<span class="ident" id="3557480">es</span><span class="op" id="3557482">.</span><span class="ident" id="3557483">earlyCloseFn</span><span class="op" id="3557495">(</span><span class="op" id="3557496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557499">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557502">err</span>&nbsp;<span class="op" id="3557506">:=</span>&nbsp;<span class="ident" id="3557509">es</span><span class="op" id="3557511">.</span><span class="ident" id="3557512">body</span><span class="op" id="3557516">.</span><span class="ident" id="3557517">Close</span><span class="op" id="3557522">(</span><span class="op" id="3557523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557526">es</span><span class="op" id="3557528">.</span><span class="ident" id="3557529">condfn</span><span class="op" id="3557535">(</span><span class="ident" id="3557536">err</span><span class="op" id="3557539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557542">return</span>&nbsp;<span class="ident" id="3557549">err</span><br>
<span class="lineno"></span><span class="op" id="3557553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3557556">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3557583">func</span>&nbsp;<span class="op" id="3557588">(</span><span class="ident" id="3557589">es</span>&nbsp;<span class="op" id="3557592">*</span><span class="ident" id="3557593">bodyEOFSignal</span><span class="op" id="3557606">)</span>&nbsp;<span class="ident" id="3557608">condfn</span><span class="op" id="3557614">(</span><span class="ident" id="3557615">err</span>&nbsp;<span class="builtintype" id="3557619">error</span><span class="op" id="3557624">)</span>&nbsp;<span class="op" id="3557626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557629">if</span>&nbsp;<span class="ident" id="3557632">es</span><span class="op" id="3557634">.</span><span class="ident" id="3557635">fn</span>&nbsp;<span class="op" id="3557638">==</span>&nbsp;<span class="ident" id="3557641">nil</span>&nbsp;<span class="op" id="3557645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557649">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557657">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3557660">if</span>&nbsp;<span class="ident" id="3557663">err</span>&nbsp;<span class="op" id="3557667">==</span>&nbsp;<span class="ident" id="3557670">io</span><span class="op" id="3557672">.</span><span class="ident" id="3557673">EOF</span>&nbsp;<span class="op" id="3557677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557681">err</span>&nbsp;<span class="op" id="3557685">=</span>&nbsp;<span class="ident" id="3557687">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3557692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557695">es</span><span class="op" id="3557697">.</span><span class="ident" id="3557698">fn</span><span class="op" id="3557700">(</span><span class="ident" id="3557701">err</span><span class="op" id="3557704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557707">es</span><span class="op" id="3557709">.</span><span class="ident" id="3557710">fn</span>&nbsp;<span class="op" id="3557713">=</span>&nbsp;<span class="ident" id="3557715">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3557719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3557722">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3557775">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3557824">type</span>&nbsp;<span class="ident" id="3557829">gzipReader</span>&nbsp;<span class="keyword" id="3557840">struct</span>&nbsp;<span class="op" id="3557847">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557850">body</span>&nbsp;<span class="ident" id="3557855">io</span><span class="op" id="3557857">.</span><span class="ident" id="3557858">ReadCloser</span>&nbsp;<span class="comment" id="3557869">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3557898">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3557903">io</span><span class="op" id="3557905">.</span><span class="ident" id="3557906">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3557917">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3557951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3557954">func</span>&nbsp;<span class="op" id="3557959">(</span><span class="ident" id="3557960">gz</span>&nbsp;<span class="op" id="3557963">*</span><span class="ident" id="3557964">gzipReader</span><span class="op" id="3557974">)</span>&nbsp;<span class="ident" id="3557976">Read</span><span class="op" id="3557980">(</span><span class="ident" id="3557981">p</span>&nbsp;<span class="op" id="3557983">[</span><span class="op" id="3557984">]</span><span class="builtintype" id="3557985">byte</span><span class="op" id="3557989">)</span>&nbsp;<span class="op" id="3557991">(</span><span class="ident" id="3557992">n</span>&nbsp;<span class="builtintype" id="3557994">int</span><span class="op" id="3557997">,</span>&nbsp;<span class="ident" id="3557999">err</span>&nbsp;<span class="builtintype" id="3558003">error</span><span class="op" id="3558008">)</span>&nbsp;<span class="op" id="3558010">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558013">if</span>&nbsp;<span class="ident" id="3558016">gz</span><span class="op" id="3558018">.</span><span class="ident" id="3558019">zr</span>&nbsp;<span class="op" id="3558022">==</span>&nbsp;<span class="ident" id="3558025">nil</span>&nbsp;<span class="op" id="3558029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558033">gz</span><span class="op" id="3558035">.</span><span class="ident" id="3558036">zr</span><span class="op" id="3558038">,</span>&nbsp;<span class="ident" id="3558040">err</span>&nbsp;<span class="op" id="3558044">=</span>&nbsp;<span class="ident" id="3558046">gzip</span><span class="op" id="3558050">.</span><span class="ident" id="3558051">NewReader</span><span class="op" id="3558060">(</span><span class="ident" id="3558061">gz</span><span class="op" id="3558063">.</span><span class="ident" id="3558064">body</span><span class="op" id="3558068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558072">if</span>&nbsp;<span class="ident" id="3558075">err</span>&nbsp;<span class="op" id="3558079">!=</span>&nbsp;<span class="ident" id="3558082">nil</span>&nbsp;<span class="op" id="3558086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558091">return</span>&nbsp;<span class="num" id="3558098">0</span><span class="op" id="3558099">,</span>&nbsp;<span class="ident" id="3558101">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3558107">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3558110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558113">return</span>&nbsp;<span class="ident" id="3558120">gz</span><span class="op" id="3558122">.</span><span class="ident" id="3558123">zr</span><span class="op" id="3558125">.</span><span class="ident" id="3558126">Read</span><span class="op" id="3558130">(</span><span class="ident" id="3558131">p</span><span class="op" id="3558132">)</span><br>
<span class="lineno"></span><span class="op" id="3558134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558137">func</span>&nbsp;<span class="op" id="3558142">(</span><span class="ident" id="3558143">gz</span>&nbsp;<span class="op" id="3558146">*</span><span class="ident" id="3558147">gzipReader</span><span class="op" id="3558157">)</span>&nbsp;<span class="ident" id="3558159">Close</span><span class="op" id="3558164">(</span><span class="op" id="3558165">)</span>&nbsp;<span class="builtintype" id="3558167">error</span>&nbsp;<span class="op" id="3558173">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558176">return</span>&nbsp;<span class="ident" id="3558183">gz</span><span class="op" id="3558185">.</span><span class="ident" id="3558186">body</span><span class="op" id="3558190">.</span><span class="ident" id="3558191">Close</span><span class="op" id="3558196">(</span><span class="op" id="3558197">)</span><br>
<span class="lineno"></span><span class="op" id="3558199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558202">type</span>&nbsp;<span class="ident" id="3558207">readerAndCloser</span>&nbsp;<span class="keyword" id="3558223">struct</span>&nbsp;<span class="op" id="3558230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558233">io</span><span class="op" id="3558235">.</span><span class="ident" id="3558236">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558244">io</span><span class="op" id="3558246">.</span><span class="ident" id="3558247">Closer</span><br>
<span class="lineno"></span><span class="op" id="3558254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558257">type</span>&nbsp;<span class="ident" id="3558262">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3558287">struct</span><span class="op" id="3558293">{</span><span class="op" id="3558294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3558297">func</span>&nbsp;<span class="op" id="3558302">(</span><span class="ident" id="3558303">tlsHandshakeTimeoutError</span><span class="op" id="3558327">)</span>&nbsp;<span class="ident" id="3558329">Timeout</span><span class="op" id="3558336">(</span><span class="op" id="3558337">)</span>&nbsp;<span class="builtintype" id="3558339">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3558346">{</span>&nbsp;<span class="keyword" id="3558348">return</span>&nbsp;<span class="builtintype" id="3558355">true</span>&nbsp;<span class="op" id="3558360">}</span><br>
<span class="lineno"></span><span class="keyword" id="3558362">func</span>&nbsp;<span class="op" id="3558367">(</span><span class="ident" id="3558368">tlsHandshakeTimeoutError</span><span class="op" id="3558392">)</span>&nbsp;<span class="ident" id="3558394">Temporary</span><span class="op" id="3558403">(</span><span class="op" id="3558404">)</span>&nbsp;<span class="builtintype" id="3558406">bool</span>&nbsp;<span class="op" id="3558411">{</span>&nbsp;<span class="keyword" id="3558413">return</span>&nbsp;<span class="builtintype" id="3558420">true</span>&nbsp;<span class="op" id="3558425">}</span><br>
<span class="lineno"></span><span class="keyword" id="3558427">func</span>&nbsp;<span class="op" id="3558432">(</span><span class="ident" id="3558433">tlsHandshakeTimeoutError</span><span class="op" id="3558457">)</span>&nbsp;<span class="ident" id="3558459">Error</span><span class="op" id="3558464">(</span><span class="op" id="3558465">)</span>&nbsp;<span class="builtintype" id="3558467">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3558476">{</span>&nbsp;<span class="keyword" id="3558478">return</span>&nbsp;<span class="string" id="3558485">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3558519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558522">type</span>&nbsp;<span class="ident" id="3558527">noteEOFReader</span>&nbsp;<span class="keyword" id="3558541">struct</span>&nbsp;<span class="op" id="3558548">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558551">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3558558">io</span><span class="op" id="3558560">.</span><span class="ident" id="3558561">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558569">sawEOF</span>&nbsp;<span class="op" id="3558576">*</span><span class="builtintype" id="3558577">bool</span><br>
<span class="lineno"></span><span class="op" id="3558582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3558585">func</span>&nbsp;<span class="op" id="3558590">(</span><span class="ident" id="3558591">nr</span>&nbsp;<span class="ident" id="3558594">noteEOFReader</span><span class="op" id="3558607">)</span>&nbsp;<span class="ident" id="3558609">Read</span><span class="op" id="3558613">(</span><span class="ident" id="3558614">p</span>&nbsp;<span class="op" id="3558616">[</span><span class="op" id="3558617">]</span><span class="builtintype" id="3558618">byte</span><span class="op" id="3558622">)</span>&nbsp;<span class="op" id="3558624">(</span><span class="ident" id="3558625">n</span>&nbsp;<span class="builtintype" id="3558627">int</span><span class="op" id="3558630">,</span>&nbsp;<span class="ident" id="3558632">err</span>&nbsp;<span class="builtintype" id="3558636">error</span><span class="op" id="3558641">)</span>&nbsp;<span class="op" id="3558643">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3558646">n</span><span class="op" id="3558647">,</span>&nbsp;<span class="ident" id="3558649">err</span>&nbsp;<span class="op" id="3558653">=</span>&nbsp;<span class="ident" id="3558655">nr</span><span class="op" id="3558657">.</span><span class="ident" id="3558658">r</span><span class="op" id="3558659">.</span><span class="ident" id="3558660">Read</span><span class="op" id="3558664">(</span><span class="ident" id="3558665">p</span><span class="op" id="3558666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558669">if</span>&nbsp;<span class="ident" id="3558672">err</span>&nbsp;<span class="op" id="3558676">==</span>&nbsp;<span class="ident" id="3558679">io</span><span class="op" id="3558681">.</span><span class="ident" id="3558682">EOF</span>&nbsp;<span class="op" id="3558686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3558690">*</span><span class="ident" id="3558691">nr</span><span class="op" id="3558693">.</span><span class="ident" id="3558694">sawEOF</span>&nbsp;<span class="op" id="3558701">=</span>&nbsp;<span class="builtintype" id="3558703">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3558709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3558712">return</span><br>
<span class="lineno">1275</span><span class="op" id="3558719">}</span>
</div>
</body>
</html>
