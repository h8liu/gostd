<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html" class="current">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4458541">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4458596">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4458650">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4458701">package</span>&nbsp;<span class="ident" id="4458709">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4458714">import</span>&nbsp;<span class="op" id="4458721">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4458724">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4458734">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4458751">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4458761">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4458767">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="4458778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4458781">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4458859">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4458955">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="4459042">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="4459121">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="4459169">func</span>&nbsp;<span class="ident" id="4459174">EncryptPKCS1v15</span><span class="op" id="4459189">(</span><span class="ident" id="4459190">rand</span>&nbsp;<span class="ident" id="4459195">io</span><span class="op" id="4459197">.</span><span class="ident" id="4459198">Reader</span><span class="op" id="4459204">,</span>&nbsp;<span class="ident" id="4459206">pub</span>&nbsp;<span class="op" id="4459210">*</span><span class="ident" id="4459211">PublicKey</span><span class="op" id="4459220">,</span>&nbsp;<span class="ident" id="4459222">msg</span>&nbsp;<span class="op" id="4459226">[</span><span class="op" id="4459227">]</span><span class="builtintype" id="4459228">byte</span><span class="op" id="4459232">)</span>&nbsp;<span class="op" id="4459234">(</span><span class="ident" id="4459235">out</span>&nbsp;<span class="op" id="4459239">[</span><span class="op" id="4459240">]</span><span class="builtintype" id="4459241">byte</span><span class="op" id="4459245">,</span>&nbsp;<span class="ident" id="4459247">err</span>&nbsp;<span class="builtintype" id="4459251">error</span><span class="op" id="4459256">)</span>&nbsp;<span class="op" id="4459258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459261">if</span>&nbsp;<span class="ident" id="4459264">err</span>&nbsp;<span class="op" id="4459268">:=</span>&nbsp;<span class="ident" id="4459271">checkPub</span><span class="op" id="4459279">(</span><span class="ident" id="4459280">pub</span><span class="op" id="4459283">)</span><span class="op" id="4459284">;</span>&nbsp;<span class="ident" id="4459286">err</span>&nbsp;<span class="op" id="4459290">!=</span>&nbsp;<span class="builtintype" id="4459293">nil</span>&nbsp;<span class="op" id="4459297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459301">return</span>&nbsp;<span class="builtintype" id="4459308">nil</span><span class="op" id="4459311">,</span>&nbsp;<span class="ident" id="4459313">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459318">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459321">k</span>&nbsp;<span class="op" id="4459323">:=</span>&nbsp;<span class="op" id="4459326">(</span><span class="ident" id="4459327">pub</span><span class="op" id="4459330">.</span><span class="ident" id="4459331">N</span><span class="op" id="4459332">.</span><span class="ident" id="4459333">BitLen</span><span class="op" id="4459339">(</span><span class="op" id="4459340">)</span>&nbsp;<span class="op" id="4459342">+</span>&nbsp;<span class="num" id="4459344">7</span><span class="op" id="4459345">)</span>&nbsp;<span class="op" id="4459347">/</span>&nbsp;<span class="num" id="4459349">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459352">if</span>&nbsp;<span class="builtinfunc" id="4459355">len</span><span class="op" id="4459358">(</span><span class="ident" id="4459359">msg</span><span class="op" id="4459362">)</span>&nbsp;<span class="op" id="4459364">&gt;</span>&nbsp;<span class="ident" id="4459366">k</span><span class="op" id="4459367">-</span><span class="num" id="4459368">11</span>&nbsp;<span class="op" id="4459371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459375">err</span>&nbsp;<span class="op" id="4459379">=</span>&nbsp;<span class="ident" id="4459381">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459401">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459409">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4459413">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459454">em</span>&nbsp;<span class="op" id="4459457">:=</span>&nbsp;<span class="builtinfunc" id="4459460">make</span><span class="op" id="4459464">(</span><span class="op" id="4459465">[</span><span class="op" id="4459466">]</span><span class="builtintype" id="4459467">byte</span><span class="op" id="4459471">,</span>&nbsp;<span class="ident" id="4459473">k</span><span class="op" id="4459474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459477">em</span><span class="op" id="4459479">[</span><span class="num" id="4459480">1</span><span class="op" id="4459481">]</span>&nbsp;<span class="op" id="4459483">=</span>&nbsp;<span class="num" id="4459485">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459488">ps</span><span class="op" id="4459490">,</span>&nbsp;<span class="ident" id="4459492">mm</span>&nbsp;<span class="op" id="4459495">:=</span>&nbsp;<span class="ident" id="4459498">em</span><span class="op" id="4459500">[</span><span class="num" id="4459501">2</span><span class="op" id="4459502">:</span><span class="builtinfunc" id="4459503">len</span><span class="op" id="4459506">(</span><span class="ident" id="4459507">em</span><span class="op" id="4459509">)</span><span class="op" id="4459510">-</span><span class="builtinfunc" id="4459511">len</span><span class="op" id="4459514">(</span><span class="ident" id="4459515">msg</span><span class="op" id="4459518">)</span><span class="op" id="4459519">-</span><span class="num" id="4459520">1</span><span class="op" id="4459521">]</span><span class="op" id="4459522">,</span>&nbsp;<span class="ident" id="4459524">em</span><span class="op" id="4459526">[</span><span class="builtinfunc" id="4459527">len</span><span class="op" id="4459530">(</span><span class="ident" id="4459531">em</span><span class="op" id="4459533">)</span><span class="op" id="4459534">-</span><span class="builtinfunc" id="4459535">len</span><span class="op" id="4459538">(</span><span class="ident" id="4459539">msg</span><span class="op" id="4459542">)</span><span class="op" id="4459543">:</span><span class="op" id="4459544">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459547">err</span>&nbsp;<span class="op" id="4459551">=</span>&nbsp;<span class="ident" id="4459553">nonZeroRandomBytes</span><span class="op" id="4459571">(</span><span class="ident" id="4459572">ps</span><span class="op" id="4459574">,</span>&nbsp;<span class="ident" id="4459576">rand</span><span class="op" id="4459580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459583">if</span>&nbsp;<span class="ident" id="4459586">err</span>&nbsp;<span class="op" id="4459590">!=</span>&nbsp;<span class="builtintype" id="4459593">nil</span>&nbsp;<span class="op" id="4459597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459601">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4459609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459612">em</span><span class="op" id="4459614">[</span><span class="builtinfunc" id="4459615">len</span><span class="op" id="4459618">(</span><span class="ident" id="4459619">em</span><span class="op" id="4459621">)</span><span class="op" id="4459622">-</span><span class="builtinfunc" id="4459623">len</span><span class="op" id="4459626">(</span><span class="ident" id="4459627">msg</span><span class="op" id="4459630">)</span><span class="op" id="4459631">-</span><span class="num" id="4459632">1</span><span class="op" id="4459633">]</span>&nbsp;<span class="op" id="4459635">=</span>&nbsp;<span class="num" id="4459637">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4459640">copy</span><span class="op" id="4459644">(</span><span class="ident" id="4459645">mm</span><span class="op" id="4459647">,</span>&nbsp;<span class="ident" id="4459649">msg</span><span class="op" id="4459652">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459656">m</span>&nbsp;<span class="op" id="4459658">:=</span>&nbsp;<span class="builtinfunc" id="4459661">new</span><span class="op" id="4459664">(</span><span class="ident" id="4459665">big</span><span class="op" id="4459668">.</span><span class="ident" id="4459669">Int</span><span class="op" id="4459672">)</span><span class="op" id="4459673">.</span><span class="ident" id="4459674">SetBytes</span><span class="op" id="4459682">(</span><span class="ident" id="4459683">em</span><span class="op" id="4459685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459688">c</span>&nbsp;<span class="op" id="4459690">:=</span>&nbsp;<span class="ident" id="4459693">encrypt</span><span class="op" id="4459700">(</span><span class="builtinfunc" id="4459701">new</span><span class="op" id="4459704">(</span><span class="ident" id="4459705">big</span><span class="op" id="4459708">.</span><span class="ident" id="4459709">Int</span><span class="op" id="4459712">)</span><span class="op" id="4459713">,</span>&nbsp;<span class="ident" id="4459715">pub</span><span class="op" id="4459718">,</span>&nbsp;<span class="ident" id="4459720">m</span><span class="op" id="4459721">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459725">copyWithLeftPad</span><span class="op" id="4459740">(</span><span class="ident" id="4459741">em</span><span class="op" id="4459743">,</span>&nbsp;<span class="ident" id="4459745">c</span><span class="op" id="4459746">.</span><span class="ident" id="4459747">Bytes</span><span class="op" id="4459752">(</span><span class="op" id="4459753">)</span><span class="op" id="4459754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4459757">out</span>&nbsp;<span class="op" id="4459761">=</span>&nbsp;<span class="ident" id="4459763">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4459767">return</span><br>
<span class="lineno"></span><span class="op" id="4459774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4459777">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4459868">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="4459946">func</span>&nbsp;<span class="ident" id="4459951">DecryptPKCS1v15</span><span class="op" id="4459966">(</span><span class="ident" id="4459967">rand</span>&nbsp;<span class="ident" id="4459972">io</span><span class="op" id="4459974">.</span><span class="ident" id="4459975">Reader</span><span class="op" id="4459981">,</span>&nbsp;<span class="ident" id="4459983">priv</span>&nbsp;<span class="op" id="4459988">*</span><span class="ident" id="4459989">PrivateKey</span><span class="op" id="4459999">,</span>&nbsp;<span class="ident" id="4460001">ciphertext</span>&nbsp;<span class="op" id="4460012">[</span><span class="op" id="4460013">]</span><span class="builtintype" id="4460014">byte</span><span class="op" id="4460018">)</span>&nbsp;<span class="op" id="4460020">(</span><span class="ident" id="4460021">out</span>&nbsp;<span class="op" id="4460025">[</span><span class="op" id="4460026">]</span><span class="builtintype" id="4460027">byte</span><span class="op" id="4460031">,</span>&nbsp;<span class="ident" id="4460033">err</span>&nbsp;<span class="builtintype" id="4460037">error</span><span class="op" id="4460042">)</span>&nbsp;<span class="op" id="4460044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460047">if</span>&nbsp;<span class="ident" id="4460050">err</span>&nbsp;<span class="op" id="4460054">:=</span>&nbsp;<span class="ident" id="4460057">checkPub</span><span class="op" id="4460065">(</span><span class="op" id="4460066">&amp;</span><span class="ident" id="4460067">priv</span><span class="op" id="4460071">.</span><span class="ident" id="4460072">PublicKey</span><span class="op" id="4460081">)</span><span class="op" id="4460082">;</span>&nbsp;<span class="ident" id="4460084">err</span>&nbsp;<span class="op" id="4460088">!=</span>&nbsp;<span class="builtintype" id="4460091">nil</span>&nbsp;<span class="op" id="4460095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460099">return</span>&nbsp;<span class="builtintype" id="4460106">nil</span><span class="op" id="4460109">,</span>&nbsp;<span class="ident" id="4460111">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4460116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4460119">valid</span><span class="op" id="4460124">,</span>&nbsp;<span class="ident" id="4460126">out</span><span class="op" id="4460129">,</span>&nbsp;<span class="ident" id="4460131">index</span><span class="op" id="4460136">,</span>&nbsp;<span class="ident" id="4460138">err</span>&nbsp;<span class="op" id="4460142">:=</span>&nbsp;<span class="ident" id="4460145">decryptPKCS1v15</span><span class="op" id="4460160">(</span><span class="ident" id="4460161">rand</span><span class="op" id="4460165">,</span>&nbsp;<span class="ident" id="4460167">priv</span><span class="op" id="4460171">,</span>&nbsp;<span class="ident" id="4460173">ciphertext</span><span class="op" id="4460183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460186">if</span>&nbsp;<span class="ident" id="4460189">err</span>&nbsp;<span class="op" id="4460193">!=</span>&nbsp;<span class="builtintype" id="4460196">nil</span>&nbsp;<span class="op" id="4460200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460204">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4460212">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460215">if</span>&nbsp;<span class="ident" id="4460218">valid</span>&nbsp;<span class="op" id="4460224">==</span>&nbsp;<span class="num" id="4460227">0</span>&nbsp;<span class="op" id="4460229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460233">return</span>&nbsp;<span class="builtintype" id="4460240">nil</span><span class="op" id="4460243">,</span>&nbsp;<span class="ident" id="4460245">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4460260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4460263">out</span>&nbsp;<span class="op" id="4460267">=</span>&nbsp;<span class="ident" id="4460269">out</span><span class="op" id="4460272">[</span><span class="ident" id="4460273">index</span><span class="op" id="4460278">:</span><span class="op" id="4460279">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4460282">return</span><br>
<span class="lineno">65</span><span class="op" id="4460289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4460292">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4460395">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="4460473">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4460544">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4460617">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="4460697">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="4460776">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="4460849">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="4460927">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="4461006">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="4461030">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="4461100">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="4461180">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="4461197">func</span>&nbsp;<span class="ident" id="4461202">DecryptPKCS1v15SessionKey</span><span class="op" id="4461227">(</span><span class="ident" id="4461228">rand</span>&nbsp;<span class="ident" id="4461233">io</span><span class="op" id="4461235">.</span><span class="ident" id="4461236">Reader</span><span class="op" id="4461242">,</span>&nbsp;<span class="ident" id="4461244">priv</span>&nbsp;<span class="op" id="4461249">*</span><span class="ident" id="4461250">PrivateKey</span><span class="op" id="4461260">,</span>&nbsp;<span class="ident" id="4461262">ciphertext</span>&nbsp;<span class="op" id="4461273">[</span><span class="op" id="4461274">]</span><span class="builtintype" id="4461275">byte</span><span class="op" id="4461279">,</span>&nbsp;<span class="ident" id="4461281">key</span>&nbsp;<span class="op" id="4461285">[</span><span class="op" id="4461286">]</span><span class="builtintype" id="4461287">byte</span><span class="op" id="4461291">)</span>&nbsp;<span class="op" id="4461293">(</span><span class="ident" id="4461294">err</span>&nbsp;<span class="builtintype" id="4461298">error</span><span class="op" id="4461303">)</span>&nbsp;<span class="op" id="4461305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461308">if</span>&nbsp;<span class="ident" id="4461311">err</span>&nbsp;<span class="op" id="4461315">:=</span>&nbsp;<span class="ident" id="4461318">checkPub</span><span class="op" id="4461326">(</span><span class="op" id="4461327">&amp;</span><span class="ident" id="4461328">priv</span><span class="op" id="4461332">.</span><span class="ident" id="4461333">PublicKey</span><span class="op" id="4461342">)</span><span class="op" id="4461343">;</span>&nbsp;<span class="ident" id="4461345">err</span>&nbsp;<span class="op" id="4461349">!=</span>&nbsp;<span class="builtintype" id="4461352">nil</span>&nbsp;<span class="op" id="4461356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461360">return</span>&nbsp;<span class="ident" id="4461367">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4461372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461375">k</span>&nbsp;<span class="op" id="4461377">:=</span>&nbsp;<span class="op" id="4461380">(</span><span class="ident" id="4461381">priv</span><span class="op" id="4461385">.</span><span class="ident" id="4461386">N</span><span class="op" id="4461387">.</span><span class="ident" id="4461388">BitLen</span><span class="op" id="4461394">(</span><span class="op" id="4461395">)</span>&nbsp;<span class="op" id="4461397">+</span>&nbsp;<span class="num" id="4461399">7</span><span class="op" id="4461400">)</span>&nbsp;<span class="op" id="4461402">/</span>&nbsp;<span class="num" id="4461404">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461407">if</span>&nbsp;<span class="ident" id="4461410">k</span><span class="op" id="4461411">-</span><span class="op" id="4461412">(</span><span class="builtinfunc" id="4461413">len</span><span class="op" id="4461416">(</span><span class="ident" id="4461417">key</span><span class="op" id="4461420">)</span><span class="op" id="4461421">+</span><span class="num" id="4461422">3</span><span class="op" id="4461423">+</span><span class="num" id="4461424">8</span><span class="op" id="4461425">)</span>&nbsp;<span class="op" id="4461427">&lt;</span>&nbsp;<span class="num" id="4461429">0</span>&nbsp;<span class="op" id="4461431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461435">return</span>&nbsp;<span class="ident" id="4461442">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4461457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461461">valid</span><span class="op" id="4461466">,</span>&nbsp;<span class="ident" id="4461468">em</span><span class="op" id="4461470">,</span>&nbsp;<span class="ident" id="4461472">index</span><span class="op" id="4461477">,</span>&nbsp;<span class="ident" id="4461479">err</span>&nbsp;<span class="op" id="4461483">:=</span>&nbsp;<span class="ident" id="4461486">decryptPKCS1v15</span><span class="op" id="4461501">(</span><span class="ident" id="4461502">rand</span><span class="op" id="4461506">,</span>&nbsp;<span class="ident" id="4461508">priv</span><span class="op" id="4461512">,</span>&nbsp;<span class="ident" id="4461514">ciphertext</span><span class="op" id="4461524">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461527">if</span>&nbsp;<span class="ident" id="4461530">err</span>&nbsp;<span class="op" id="4461534">!=</span>&nbsp;<span class="builtintype" id="4461537">nil</span>&nbsp;<span class="op" id="4461541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461545">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4461553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461557">if</span>&nbsp;<span class="builtinfunc" id="4461560">len</span><span class="op" id="4461563">(</span><span class="ident" id="4461564">em</span><span class="op" id="4461566">)</span>&nbsp;<span class="op" id="4461568">!=</span>&nbsp;<span class="ident" id="4461571">k</span>&nbsp;<span class="op" id="4461573">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4461577">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4461639">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461668">return</span>&nbsp;<span class="ident" id="4461675">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4461690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461694">valid</span>&nbsp;<span class="op" id="4461700">&amp;=</span>&nbsp;<span class="ident" id="4461703">subtle</span><span class="op" id="4461709">.</span><span class="ident" id="4461710">ConstantTimeEq</span><span class="op" id="4461724">(</span><span class="builtintype" id="4461725">int32</span><span class="op" id="4461730">(</span><span class="builtinfunc" id="4461731">len</span><span class="op" id="4461734">(</span><span class="ident" id="4461735">em</span><span class="op" id="4461737">)</span><span class="op" id="4461738">-</span><span class="ident" id="4461739">index</span><span class="op" id="4461744">)</span><span class="op" id="4461745">,</span>&nbsp;<span class="builtintype" id="4461747">int32</span><span class="op" id="4461752">(</span><span class="builtinfunc" id="4461753">len</span><span class="op" id="4461756">(</span><span class="ident" id="4461757">key</span><span class="op" id="4461760">)</span><span class="op" id="4461761">)</span><span class="op" id="4461762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4461765">subtle</span><span class="op" id="4461771">.</span><span class="ident" id="4461772">ConstantTimeCopy</span><span class="op" id="4461788">(</span><span class="ident" id="4461789">valid</span><span class="op" id="4461794">,</span>&nbsp;<span class="ident" id="4461796">key</span><span class="op" id="4461799">,</span>&nbsp;<span class="ident" id="4461801">em</span><span class="op" id="4461803">[</span><span class="builtinfunc" id="4461804">len</span><span class="op" id="4461807">(</span><span class="ident" id="4461808">em</span><span class="op" id="4461810">)</span><span class="op" id="4461811">-</span><span class="builtinfunc" id="4461812">len</span><span class="op" id="4461815">(</span><span class="ident" id="4461816">key</span><span class="op" id="4461819">)</span><span class="op" id="4461820">:</span><span class="op" id="4461821">]</span><span class="op" id="4461822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4461825">return</span><br>
<span class="lineno"></span><span class="op" id="4461832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4461835">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4461913">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4461992">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4462064">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="4462143">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="4462221">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="4462291">func</span>&nbsp;<span class="ident" id="4462296">decryptPKCS1v15</span><span class="op" id="4462311">(</span><span class="ident" id="4462312">rand</span>&nbsp;<span class="ident" id="4462317">io</span><span class="op" id="4462319">.</span><span class="ident" id="4462320">Reader</span><span class="op" id="4462326">,</span>&nbsp;<span class="ident" id="4462328">priv</span>&nbsp;<span class="op" id="4462333">*</span><span class="ident" id="4462334">PrivateKey</span><span class="op" id="4462344">,</span>&nbsp;<span class="ident" id="4462346">ciphertext</span>&nbsp;<span class="op" id="4462357">[</span><span class="op" id="4462358">]</span><span class="builtintype" id="4462359">byte</span><span class="op" id="4462363">)</span>&nbsp;<span class="op" id="4462365">(</span><span class="ident" id="4462366">valid</span>&nbsp;<span class="builtintype" id="4462372">int</span><span class="op" id="4462375">,</span>&nbsp;<span class="ident" id="4462377">em</span>&nbsp;<span class="op" id="4462380">[</span><span class="op" id="4462381">]</span><span class="builtintype" id="4462382">byte</span><span class="op" id="4462386">,</span>&nbsp;<span class="ident" id="4462388">index</span>&nbsp;<span class="builtintype" id="4462394">int</span><span class="op" id="4462397">,</span>&nbsp;<span class="ident" id="4462399">err</span>&nbsp;<span class="builtintype" id="4462403">error</span><span class="op" id="4462408">)</span>&nbsp;<span class="op" id="4462410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462413">k</span>&nbsp;<span class="op" id="4462415">:=</span>&nbsp;<span class="op" id="4462418">(</span><span class="ident" id="4462419">priv</span><span class="op" id="4462423">.</span><span class="ident" id="4462424">N</span><span class="op" id="4462425">.</span><span class="ident" id="4462426">BitLen</span><span class="op" id="4462432">(</span><span class="op" id="4462433">)</span>&nbsp;<span class="op" id="4462435">+</span>&nbsp;<span class="num" id="4462437">7</span><span class="op" id="4462438">)</span>&nbsp;<span class="op" id="4462440">/</span>&nbsp;<span class="num" id="4462442">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4462445">if</span>&nbsp;<span class="ident" id="4462448">k</span>&nbsp;<span class="op" id="4462450">&lt;</span>&nbsp;<span class="num" id="4462452">11</span>&nbsp;<span class="op" id="4462455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462459">err</span>&nbsp;<span class="op" id="4462463">=</span>&nbsp;<span class="ident" id="4462465">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4462481">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4462489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462493">c</span>&nbsp;<span class="op" id="4462495">:=</span>&nbsp;<span class="builtinfunc" id="4462498">new</span><span class="op" id="4462501">(</span><span class="ident" id="4462502">big</span><span class="op" id="4462505">.</span><span class="ident" id="4462506">Int</span><span class="op" id="4462509">)</span><span class="op" id="4462510">.</span><span class="ident" id="4462511">SetBytes</span><span class="op" id="4462519">(</span><span class="ident" id="4462520">ciphertext</span><span class="op" id="4462530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462533">m</span><span class="op" id="4462534">,</span>&nbsp;<span class="ident" id="4462536">err</span>&nbsp;<span class="op" id="4462540">:=</span>&nbsp;<span class="ident" id="4462543">decrypt</span><span class="op" id="4462550">(</span><span class="ident" id="4462551">rand</span><span class="op" id="4462555">,</span>&nbsp;<span class="ident" id="4462557">priv</span><span class="op" id="4462561">,</span>&nbsp;<span class="ident" id="4462563">c</span><span class="op" id="4462564">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4462567">if</span>&nbsp;<span class="ident" id="4462570">err</span>&nbsp;<span class="op" id="4462574">!=</span>&nbsp;<span class="builtintype" id="4462577">nil</span>&nbsp;<span class="op" id="4462581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4462585">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4462593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462597">em</span>&nbsp;<span class="op" id="4462600">=</span>&nbsp;<span class="ident" id="4462602">leftPad</span><span class="op" id="4462609">(</span><span class="ident" id="4462610">m</span><span class="op" id="4462611">.</span><span class="ident" id="4462612">Bytes</span><span class="op" id="4462617">(</span><span class="op" id="4462618">)</span><span class="op" id="4462619">,</span>&nbsp;<span class="ident" id="4462621">k</span><span class="op" id="4462622">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462625">firstByteIsZero</span>&nbsp;<span class="op" id="4462641">:=</span>&nbsp;<span class="ident" id="4462644">subtle</span><span class="op" id="4462650">.</span><span class="ident" id="4462651">ConstantTimeByteEq</span><span class="op" id="4462669">(</span><span class="ident" id="4462670">em</span><span class="op" id="4462672">[</span><span class="num" id="4462673">0</span><span class="op" id="4462674">]</span><span class="op" id="4462675">,</span>&nbsp;<span class="num" id="4462677">0</span><span class="op" id="4462678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462681">secondByteIsTwo</span>&nbsp;<span class="op" id="4462697">:=</span>&nbsp;<span class="ident" id="4462700">subtle</span><span class="op" id="4462706">.</span><span class="ident" id="4462707">ConstantTimeByteEq</span><span class="op" id="4462725">(</span><span class="ident" id="4462726">em</span><span class="op" id="4462728">[</span><span class="num" id="4462729">1</span><span class="op" id="4462730">]</span><span class="op" id="4462731">,</span>&nbsp;<span class="num" id="4462733">2</span><span class="op" id="4462734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462738">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462809">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462863">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4462927">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4462975">lookingForIndex</span>&nbsp;<span class="op" id="4462991">:=</span>&nbsp;<span class="num" id="4462994">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4462998">for</span>&nbsp;<span class="ident" id="4463002">i</span>&nbsp;<span class="op" id="4463004">:=</span>&nbsp;<span class="num" id="4463007">2</span><span class="op" id="4463008">;</span>&nbsp;<span class="ident" id="4463010">i</span>&nbsp;<span class="op" id="4463012">&lt;</span>&nbsp;<span class="builtinfunc" id="4463014">len</span><span class="op" id="4463017">(</span><span class="ident" id="4463018">em</span><span class="op" id="4463020">)</span><span class="op" id="4463021">;</span>&nbsp;<span class="ident" id="4463023">i</span><span class="op" id="4463024">++</span>&nbsp;<span class="op" id="4463027">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463031">equals0</span>&nbsp;<span class="op" id="4463039">:=</span>&nbsp;<span class="ident" id="4463042">subtle</span><span class="op" id="4463048">.</span><span class="ident" id="4463049">ConstantTimeByteEq</span><span class="op" id="4463067">(</span><span class="ident" id="4463068">em</span><span class="op" id="4463070">[</span><span class="ident" id="4463071">i</span><span class="op" id="4463072">]</span><span class="op" id="4463073">,</span>&nbsp;<span class="num" id="4463075">0</span><span class="op" id="4463076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463080">index</span>&nbsp;<span class="op" id="4463086">=</span>&nbsp;<span class="ident" id="4463088">subtle</span><span class="op" id="4463094">.</span><span class="ident" id="4463095">ConstantTimeSelect</span><span class="op" id="4463113">(</span><span class="ident" id="4463114">lookingForIndex</span><span class="op" id="4463129">&amp;</span><span class="ident" id="4463130">equals0</span><span class="op" id="4463137">,</span>&nbsp;<span class="ident" id="4463139">i</span><span class="op" id="4463140">,</span>&nbsp;<span class="ident" id="4463142">index</span><span class="op" id="4463147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463151">lookingForIndex</span>&nbsp;<span class="op" id="4463167">=</span>&nbsp;<span class="ident" id="4463169">subtle</span><span class="op" id="4463175">.</span><span class="ident" id="4463176">ConstantTimeSelect</span><span class="op" id="4463194">(</span><span class="ident" id="4463195">equals0</span><span class="op" id="4463202">,</span>&nbsp;<span class="num" id="4463204">0</span><span class="op" id="4463205">,</span>&nbsp;<span class="ident" id="4463207">lookingForIndex</span><span class="op" id="4463222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463229">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463297">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463316">validPS</span>&nbsp;<span class="op" id="4463324">:=</span>&nbsp;<span class="ident" id="4463327">subtle</span><span class="op" id="4463333">.</span><span class="ident" id="4463334">ConstantTimeLessOrEq</span><span class="op" id="4463354">(</span><span class="num" id="4463355">2</span><span class="op" id="4463356">+</span><span class="num" id="4463357">8</span><span class="op" id="4463358">,</span>&nbsp;<span class="ident" id="4463360">index</span><span class="op" id="4463365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463369">valid</span>&nbsp;<span class="op" id="4463375">=</span>&nbsp;<span class="ident" id="4463377">firstByteIsZero</span>&nbsp;<span class="op" id="4463393">&amp;</span>&nbsp;<span class="ident" id="4463395">secondByteIsTwo</span>&nbsp;<span class="op" id="4463411">&amp;</span>&nbsp;<span class="op" id="4463413">(</span><span class="op" id="4463414">^</span><span class="ident" id="4463415">lookingForIndex</span>&nbsp;<span class="op" id="4463431">&amp;</span>&nbsp;<span class="num" id="4463433">1</span><span class="op" id="4463434">)</span>&nbsp;<span class="op" id="4463436">&amp;</span>&nbsp;<span class="ident" id="4463438">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463447">index</span>&nbsp;<span class="op" id="4463453">=</span>&nbsp;<span class="ident" id="4463455">subtle</span><span class="op" id="4463461">.</span><span class="ident" id="4463462">ConstantTimeSelect</span><span class="op" id="4463480">(</span><span class="ident" id="4463481">valid</span><span class="op" id="4463486">,</span>&nbsp;<span class="ident" id="4463488">index</span><span class="op" id="4463493">+</span><span class="num" id="4463494">1</span><span class="op" id="4463495">,</span>&nbsp;<span class="num" id="4463497">0</span><span class="op" id="4463498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463501">return</span>&nbsp;<span class="ident" id="4463508">valid</span><span class="op" id="4463513">,</span>&nbsp;<span class="ident" id="4463515">em</span><span class="op" id="4463517">,</span>&nbsp;<span class="ident" id="4463519">index</span><span class="op" id="4463524">,</span>&nbsp;<span class="builtintype" id="4463526">nil</span><br>
<span class="lineno"></span><span class="op" id="4463530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4463533">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="4463606">func</span>&nbsp;<span class="ident" id="4463611">nonZeroRandomBytes</span><span class="op" id="4463629">(</span><span class="ident" id="4463630">s</span>&nbsp;<span class="op" id="4463632">[</span><span class="op" id="4463633">]</span><span class="builtintype" id="4463634">byte</span><span class="op" id="4463638">,</span>&nbsp;<span class="ident" id="4463640">rand</span>&nbsp;<span class="ident" id="4463645">io</span><span class="op" id="4463647">.</span><span class="ident" id="4463648">Reader</span><span class="op" id="4463654">)</span>&nbsp;<span class="op" id="4463656">(</span><span class="ident" id="4463657">err</span>&nbsp;<span class="builtintype" id="4463661">error</span><span class="op" id="4463666">)</span>&nbsp;<span class="op" id="4463668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463671">_</span><span class="op" id="4463672">,</span>&nbsp;<span class="ident" id="4463674">err</span>&nbsp;<span class="op" id="4463678">=</span>&nbsp;<span class="ident" id="4463680">io</span><span class="op" id="4463682">.</span><span class="ident" id="4463683">ReadFull</span><span class="op" id="4463691">(</span><span class="ident" id="4463692">rand</span><span class="op" id="4463696">,</span>&nbsp;<span class="ident" id="4463698">s</span><span class="op" id="4463699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463702">if</span>&nbsp;<span class="ident" id="4463705">err</span>&nbsp;<span class="op" id="4463709">!=</span>&nbsp;<span class="builtintype" id="4463712">nil</span>&nbsp;<span class="op" id="4463716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463720">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463728">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463732">for</span>&nbsp;<span class="ident" id="4463736">i</span>&nbsp;<span class="op" id="4463738">:=</span>&nbsp;<span class="num" id="4463741">0</span><span class="op" id="4463742">;</span>&nbsp;<span class="ident" id="4463744">i</span>&nbsp;<span class="op" id="4463746">&lt;</span>&nbsp;<span class="builtinfunc" id="4463748">len</span><span class="op" id="4463751">(</span><span class="ident" id="4463752">s</span><span class="op" id="4463753">)</span><span class="op" id="4463754">;</span>&nbsp;<span class="ident" id="4463756">i</span><span class="op" id="4463757">++</span>&nbsp;<span class="op" id="4463760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463764">for</span>&nbsp;<span class="ident" id="4463768">s</span><span class="op" id="4463769">[</span><span class="ident" id="4463770">i</span><span class="op" id="4463771">]</span>&nbsp;<span class="op" id="4463773">==</span>&nbsp;<span class="num" id="4463776">0</span>&nbsp;<span class="op" id="4463778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463783">_</span><span class="op" id="4463784">,</span>&nbsp;<span class="ident" id="4463786">err</span>&nbsp;<span class="op" id="4463790">=</span>&nbsp;<span class="ident" id="4463792">io</span><span class="op" id="4463794">.</span><span class="ident" id="4463795">ReadFull</span><span class="op" id="4463803">(</span><span class="ident" id="4463804">rand</span><span class="op" id="4463808">,</span>&nbsp;<span class="ident" id="4463810">s</span><span class="op" id="4463811">[</span><span class="ident" id="4463812">i</span><span class="op" id="4463813">:</span><span class="ident" id="4463814">i</span><span class="op" id="4463815">+</span><span class="num" id="4463816">1</span><span class="op" id="4463817">]</span><span class="op" id="4463818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463823">if</span>&nbsp;<span class="ident" id="4463826">err</span>&nbsp;<span class="op" id="4463830">!=</span>&nbsp;<span class="builtintype" id="4463833">nil</span>&nbsp;<span class="op" id="4463837">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463858">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4463913">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4463943">s</span><span class="op" id="4463944">[</span><span class="ident" id="4463945">i</span><span class="op" id="4463946">]</span>&nbsp;<span class="op" id="4463948">^=</span>&nbsp;<span class="num" id="4463951">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4463961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4463965">return</span><br>
<span class="lineno"></span><span class="op" id="4463972">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4463975">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="4464009">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4464040">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="4464084">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="4464111">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="4464118">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="4464188">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4464266">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="4464296">var</span>&nbsp;<span class="ident" id="4464300">hashPrefixes</span>&nbsp;<span class="op" id="4464313">=</span>&nbsp;<span class="keyword" id="4464315">map</span><span class="op" id="4464318">[</span><span class="ident" id="4464319">crypto</span><span class="op" id="4464325">.</span><span class="ident" id="4464326">Hash</span><span class="op" id="4464330">]</span><span class="op" id="4464331">[</span><span class="op" id="4464332">]</span><span class="builtintype" id="4464333">byte</span><span class="op" id="4464337">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464340">crypto</span><span class="op" id="4464346">.</span><span class="ident" id="4464347">MD5</span><span class="op" id="4464350">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464358">{</span><span class="num" id="4464359">0x30</span><span class="op" id="4464363">,</span>&nbsp;<span class="num" id="4464365">0x20</span><span class="op" id="4464369">,</span>&nbsp;<span class="num" id="4464371">0x30</span><span class="op" id="4464375">,</span>&nbsp;<span class="num" id="4464377">0x0c</span><span class="op" id="4464381">,</span>&nbsp;<span class="num" id="4464383">0x06</span><span class="op" id="4464387">,</span>&nbsp;<span class="num" id="4464389">0x08</span><span class="op" id="4464393">,</span>&nbsp;<span class="num" id="4464395">0x2a</span><span class="op" id="4464399">,</span>&nbsp;<span class="num" id="4464401">0x86</span><span class="op" id="4464405">,</span>&nbsp;<span class="num" id="4464407">0x48</span><span class="op" id="4464411">,</span>&nbsp;<span class="num" id="4464413">0x86</span><span class="op" id="4464417">,</span>&nbsp;<span class="num" id="4464419">0xf7</span><span class="op" id="4464423">,</span>&nbsp;<span class="num" id="4464425">0x0d</span><span class="op" id="4464429">,</span>&nbsp;<span class="num" id="4464431">0x02</span><span class="op" id="4464435">,</span>&nbsp;<span class="num" id="4464437">0x05</span><span class="op" id="4464441">,</span>&nbsp;<span class="num" id="4464443">0x05</span><span class="op" id="4464447">,</span>&nbsp;<span class="num" id="4464449">0x00</span><span class="op" id="4464453">,</span>&nbsp;<span class="num" id="4464455">0x04</span><span class="op" id="4464459">,</span>&nbsp;<span class="num" id="4464461">0x10</span><span class="op" id="4464465">}</span><span class="op" id="4464466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464469">crypto</span><span class="op" id="4464475">.</span><span class="ident" id="4464476">SHA1</span><span class="op" id="4464480">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464487">{</span><span class="num" id="4464488">0x30</span><span class="op" id="4464492">,</span>&nbsp;<span class="num" id="4464494">0x21</span><span class="op" id="4464498">,</span>&nbsp;<span class="num" id="4464500">0x30</span><span class="op" id="4464504">,</span>&nbsp;<span class="num" id="4464506">0x09</span><span class="op" id="4464510">,</span>&nbsp;<span class="num" id="4464512">0x06</span><span class="op" id="4464516">,</span>&nbsp;<span class="num" id="4464518">0x05</span><span class="op" id="4464522">,</span>&nbsp;<span class="num" id="4464524">0x2b</span><span class="op" id="4464528">,</span>&nbsp;<span class="num" id="4464530">0x0e</span><span class="op" id="4464534">,</span>&nbsp;<span class="num" id="4464536">0x03</span><span class="op" id="4464540">,</span>&nbsp;<span class="num" id="4464542">0x02</span><span class="op" id="4464546">,</span>&nbsp;<span class="num" id="4464548">0x1a</span><span class="op" id="4464552">,</span>&nbsp;<span class="num" id="4464554">0x05</span><span class="op" id="4464558">,</span>&nbsp;<span class="num" id="4464560">0x00</span><span class="op" id="4464564">,</span>&nbsp;<span class="num" id="4464566">0x04</span><span class="op" id="4464570">,</span>&nbsp;<span class="num" id="4464572">0x14</span><span class="op" id="4464576">}</span><span class="op" id="4464577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464580">crypto</span><span class="op" id="4464586">.</span><span class="ident" id="4464587">SHA224</span><span class="op" id="4464593">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464598">{</span><span class="num" id="4464599">0x30</span><span class="op" id="4464603">,</span>&nbsp;<span class="num" id="4464605">0x2d</span><span class="op" id="4464609">,</span>&nbsp;<span class="num" id="4464611">0x30</span><span class="op" id="4464615">,</span>&nbsp;<span class="num" id="4464617">0x0d</span><span class="op" id="4464621">,</span>&nbsp;<span class="num" id="4464623">0x06</span><span class="op" id="4464627">,</span>&nbsp;<span class="num" id="4464629">0x09</span><span class="op" id="4464633">,</span>&nbsp;<span class="num" id="4464635">0x60</span><span class="op" id="4464639">,</span>&nbsp;<span class="num" id="4464641">0x86</span><span class="op" id="4464645">,</span>&nbsp;<span class="num" id="4464647">0x48</span><span class="op" id="4464651">,</span>&nbsp;<span class="num" id="4464653">0x01</span><span class="op" id="4464657">,</span>&nbsp;<span class="num" id="4464659">0x65</span><span class="op" id="4464663">,</span>&nbsp;<span class="num" id="4464665">0x03</span><span class="op" id="4464669">,</span>&nbsp;<span class="num" id="4464671">0x04</span><span class="op" id="4464675">,</span>&nbsp;<span class="num" id="4464677">0x02</span><span class="op" id="4464681">,</span>&nbsp;<span class="num" id="4464683">0x04</span><span class="op" id="4464687">,</span>&nbsp;<span class="num" id="4464689">0x05</span><span class="op" id="4464693">,</span>&nbsp;<span class="num" id="4464695">0x00</span><span class="op" id="4464699">,</span>&nbsp;<span class="num" id="4464701">0x04</span><span class="op" id="4464705">,</span>&nbsp;<span class="num" id="4464707">0x1c</span><span class="op" id="4464711">}</span><span class="op" id="4464712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464715">crypto</span><span class="op" id="4464721">.</span><span class="ident" id="4464722">SHA256</span><span class="op" id="4464728">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464733">{</span><span class="num" id="4464734">0x30</span><span class="op" id="4464738">,</span>&nbsp;<span class="num" id="4464740">0x31</span><span class="op" id="4464744">,</span>&nbsp;<span class="num" id="4464746">0x30</span><span class="op" id="4464750">,</span>&nbsp;<span class="num" id="4464752">0x0d</span><span class="op" id="4464756">,</span>&nbsp;<span class="num" id="4464758">0x06</span><span class="op" id="4464762">,</span>&nbsp;<span class="num" id="4464764">0x09</span><span class="op" id="4464768">,</span>&nbsp;<span class="num" id="4464770">0x60</span><span class="op" id="4464774">,</span>&nbsp;<span class="num" id="4464776">0x86</span><span class="op" id="4464780">,</span>&nbsp;<span class="num" id="4464782">0x48</span><span class="op" id="4464786">,</span>&nbsp;<span class="num" id="4464788">0x01</span><span class="op" id="4464792">,</span>&nbsp;<span class="num" id="4464794">0x65</span><span class="op" id="4464798">,</span>&nbsp;<span class="num" id="4464800">0x03</span><span class="op" id="4464804">,</span>&nbsp;<span class="num" id="4464806">0x04</span><span class="op" id="4464810">,</span>&nbsp;<span class="num" id="4464812">0x02</span><span class="op" id="4464816">,</span>&nbsp;<span class="num" id="4464818">0x01</span><span class="op" id="4464822">,</span>&nbsp;<span class="num" id="4464824">0x05</span><span class="op" id="4464828">,</span>&nbsp;<span class="num" id="4464830">0x00</span><span class="op" id="4464834">,</span>&nbsp;<span class="num" id="4464836">0x04</span><span class="op" id="4464840">,</span>&nbsp;<span class="num" id="4464842">0x20</span><span class="op" id="4464846">}</span><span class="op" id="4464847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464850">crypto</span><span class="op" id="4464856">.</span><span class="ident" id="4464857">SHA384</span><span class="op" id="4464863">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4464868">{</span><span class="num" id="4464869">0x30</span><span class="op" id="4464873">,</span>&nbsp;<span class="num" id="4464875">0x41</span><span class="op" id="4464879">,</span>&nbsp;<span class="num" id="4464881">0x30</span><span class="op" id="4464885">,</span>&nbsp;<span class="num" id="4464887">0x0d</span><span class="op" id="4464891">,</span>&nbsp;<span class="num" id="4464893">0x06</span><span class="op" id="4464897">,</span>&nbsp;<span class="num" id="4464899">0x09</span><span class="op" id="4464903">,</span>&nbsp;<span class="num" id="4464905">0x60</span><span class="op" id="4464909">,</span>&nbsp;<span class="num" id="4464911">0x86</span><span class="op" id="4464915">,</span>&nbsp;<span class="num" id="4464917">0x48</span><span class="op" id="4464921">,</span>&nbsp;<span class="num" id="4464923">0x01</span><span class="op" id="4464927">,</span>&nbsp;<span class="num" id="4464929">0x65</span><span class="op" id="4464933">,</span>&nbsp;<span class="num" id="4464935">0x03</span><span class="op" id="4464939">,</span>&nbsp;<span class="num" id="4464941">0x04</span><span class="op" id="4464945">,</span>&nbsp;<span class="num" id="4464947">0x02</span><span class="op" id="4464951">,</span>&nbsp;<span class="num" id="4464953">0x02</span><span class="op" id="4464957">,</span>&nbsp;<span class="num" id="4464959">0x05</span><span class="op" id="4464963">,</span>&nbsp;<span class="num" id="4464965">0x00</span><span class="op" id="4464969">,</span>&nbsp;<span class="num" id="4464971">0x04</span><span class="op" id="4464975">,</span>&nbsp;<span class="num" id="4464977">0x30</span><span class="op" id="4464981">}</span><span class="op" id="4464982">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4464985">crypto</span><span class="op" id="4464991">.</span><span class="ident" id="4464992">SHA512</span><span class="op" id="4464998">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4465003">{</span><span class="num" id="4465004">0x30</span><span class="op" id="4465008">,</span>&nbsp;<span class="num" id="4465010">0x51</span><span class="op" id="4465014">,</span>&nbsp;<span class="num" id="4465016">0x30</span><span class="op" id="4465020">,</span>&nbsp;<span class="num" id="4465022">0x0d</span><span class="op" id="4465026">,</span>&nbsp;<span class="num" id="4465028">0x06</span><span class="op" id="4465032">,</span>&nbsp;<span class="num" id="4465034">0x09</span><span class="op" id="4465038">,</span>&nbsp;<span class="num" id="4465040">0x60</span><span class="op" id="4465044">,</span>&nbsp;<span class="num" id="4465046">0x86</span><span class="op" id="4465050">,</span>&nbsp;<span class="num" id="4465052">0x48</span><span class="op" id="4465056">,</span>&nbsp;<span class="num" id="4465058">0x01</span><span class="op" id="4465062">,</span>&nbsp;<span class="num" id="4465064">0x65</span><span class="op" id="4465068">,</span>&nbsp;<span class="num" id="4465070">0x03</span><span class="op" id="4465074">,</span>&nbsp;<span class="num" id="4465076">0x04</span><span class="op" id="4465080">,</span>&nbsp;<span class="num" id="4465082">0x02</span><span class="op" id="4465086">,</span>&nbsp;<span class="num" id="4465088">0x03</span><span class="op" id="4465092">,</span>&nbsp;<span class="num" id="4465094">0x05</span><span class="op" id="4465098">,</span>&nbsp;<span class="num" id="4465100">0x00</span><span class="op" id="4465104">,</span>&nbsp;<span class="num" id="4465106">0x04</span><span class="op" id="4465110">,</span>&nbsp;<span class="num" id="4465112">0x40</span><span class="op" id="4465116">}</span><span class="op" id="4465117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465120">crypto</span><span class="op" id="4465126">.</span><span class="ident" id="4465127">MD5SHA1</span><span class="op" id="4465134">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4465138">{</span><span class="op" id="4465139">}</span><span class="op" id="4465140">,</span>&nbsp;<span class="comment" id="4465142">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465199">crypto</span><span class="op" id="4465205">.</span><span class="ident" id="4465206">RIPEMD160</span><span class="op" id="4465215">:</span>&nbsp;<span class="op" id="4465217">{</span><span class="num" id="4465218">0x30</span><span class="op" id="4465222">,</span>&nbsp;<span class="num" id="4465224">0x20</span><span class="op" id="4465228">,</span>&nbsp;<span class="num" id="4465230">0x30</span><span class="op" id="4465234">,</span>&nbsp;<span class="num" id="4465236">0x08</span><span class="op" id="4465240">,</span>&nbsp;<span class="num" id="4465242">0x06</span><span class="op" id="4465246">,</span>&nbsp;<span class="num" id="4465248">0x06</span><span class="op" id="4465252">,</span>&nbsp;<span class="num" id="4465254">0x28</span><span class="op" id="4465258">,</span>&nbsp;<span class="num" id="4465260">0xcf</span><span class="op" id="4465264">,</span>&nbsp;<span class="num" id="4465266">0x06</span><span class="op" id="4465270">,</span>&nbsp;<span class="num" id="4465272">0x03</span><span class="op" id="4465276">,</span>&nbsp;<span class="num" id="4465278">0x00</span><span class="op" id="4465282">,</span>&nbsp;<span class="num" id="4465284">0x31</span><span class="op" id="4465288">,</span>&nbsp;<span class="num" id="4465290">0x04</span><span class="op" id="4465294">,</span>&nbsp;<span class="num" id="4465296">0x14</span><span class="op" id="4465300">}</span><span class="op" id="4465301">,</span><br>
<span class="lineno"></span><span class="op" id="4465303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="4465306">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="4465408">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4465486">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4465565">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4465607">func</span>&nbsp;<span class="ident" id="4465612">SignPKCS1v15</span><span class="op" id="4465624">(</span><span class="ident" id="4465625">rand</span>&nbsp;<span class="ident" id="4465630">io</span><span class="op" id="4465632">.</span><span class="ident" id="4465633">Reader</span><span class="op" id="4465639">,</span>&nbsp;<span class="ident" id="4465641">priv</span>&nbsp;<span class="op" id="4465646">*</span><span class="ident" id="4465647">PrivateKey</span><span class="op" id="4465657">,</span>&nbsp;<span class="ident" id="4465659">hash</span>&nbsp;<span class="ident" id="4465664">crypto</span><span class="op" id="4465670">.</span><span class="ident" id="4465671">Hash</span><span class="op" id="4465675">,</span>&nbsp;<span class="ident" id="4465677">hashed</span>&nbsp;<span class="op" id="4465684">[</span><span class="op" id="4465685">]</span><span class="builtintype" id="4465686">byte</span><span class="op" id="4465690">)</span>&nbsp;<span class="op" id="4465692">(</span><span class="ident" id="4465693">s</span>&nbsp;<span class="op" id="4465695">[</span><span class="op" id="4465696">]</span><span class="builtintype" id="4465697">byte</span><span class="op" id="4465701">,</span>&nbsp;<span class="ident" id="4465703">err</span>&nbsp;<span class="builtintype" id="4465707">error</span><span class="op" id="4465712">)</span>&nbsp;<span class="op" id="4465714">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465717">hashLen</span><span class="op" id="4465724">,</span>&nbsp;<span class="ident" id="4465726">prefix</span><span class="op" id="4465732">,</span>&nbsp;<span class="ident" id="4465734">err</span>&nbsp;<span class="op" id="4465738">:=</span>&nbsp;<span class="ident" id="4465741">pkcs1v15HashInfo</span><span class="op" id="4465757">(</span><span class="ident" id="4465758">hash</span><span class="op" id="4465762">,</span>&nbsp;<span class="builtinfunc" id="4465764">len</span><span class="op" id="4465767">(</span><span class="ident" id="4465768">hashed</span><span class="op" id="4465774">)</span><span class="op" id="4465775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465778">if</span>&nbsp;<span class="ident" id="4465781">err</span>&nbsp;<span class="op" id="4465785">!=</span>&nbsp;<span class="builtintype" id="4465788">nil</span>&nbsp;<span class="op" id="4465792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465796">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4465804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465808">tLen</span>&nbsp;<span class="op" id="4465813">:=</span>&nbsp;<span class="builtinfunc" id="4465816">len</span><span class="op" id="4465819">(</span><span class="ident" id="4465820">prefix</span><span class="op" id="4465826">)</span>&nbsp;<span class="op" id="4465828">+</span>&nbsp;<span class="ident" id="4465830">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465839">k</span>&nbsp;<span class="op" id="4465841">:=</span>&nbsp;<span class="op" id="4465844">(</span><span class="ident" id="4465845">priv</span><span class="op" id="4465849">.</span><span class="ident" id="4465850">N</span><span class="op" id="4465851">.</span><span class="ident" id="4465852">BitLen</span><span class="op" id="4465858">(</span><span class="op" id="4465859">)</span>&nbsp;<span class="op" id="4465861">+</span>&nbsp;<span class="num" id="4465863">7</span><span class="op" id="4465864">)</span>&nbsp;<span class="op" id="4465866">/</span>&nbsp;<span class="num" id="4465868">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465871">if</span>&nbsp;<span class="ident" id="4465874">k</span>&nbsp;<span class="op" id="4465876">&lt;</span>&nbsp;<span class="ident" id="4465878">tLen</span><span class="op" id="4465882">+</span><span class="num" id="4465883">11</span>&nbsp;<span class="op" id="4465886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4465890">return</span>&nbsp;<span class="builtintype" id="4465897">nil</span><span class="op" id="4465900">,</span>&nbsp;<span class="ident" id="4465902">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4465921">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4465925">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465966">em</span>&nbsp;<span class="op" id="4465969">:=</span>&nbsp;<span class="builtinfunc" id="4465972">make</span><span class="op" id="4465976">(</span><span class="op" id="4465977">[</span><span class="op" id="4465978">]</span><span class="builtintype" id="4465979">byte</span><span class="op" id="4465983">,</span>&nbsp;<span class="ident" id="4465985">k</span><span class="op" id="4465986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4465989">em</span><span class="op" id="4465991">[</span><span class="num" id="4465992">1</span><span class="op" id="4465993">]</span>&nbsp;<span class="op" id="4465995">=</span>&nbsp;<span class="num" id="4465997">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466000">for</span>&nbsp;<span class="ident" id="4466004">i</span>&nbsp;<span class="op" id="4466006">:=</span>&nbsp;<span class="num" id="4466009">2</span><span class="op" id="4466010">;</span>&nbsp;<span class="ident" id="4466012">i</span>&nbsp;<span class="op" id="4466014">&lt;</span>&nbsp;<span class="ident" id="4466016">k</span><span class="op" id="4466017">-</span><span class="ident" id="4466018">tLen</span><span class="op" id="4466022">-</span><span class="num" id="4466023">1</span><span class="op" id="4466024">;</span>&nbsp;<span class="ident" id="4466026">i</span><span class="op" id="4466027">++</span>&nbsp;<span class="op" id="4466030">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466034">em</span><span class="op" id="4466036">[</span><span class="ident" id="4466037">i</span><span class="op" id="4466038">]</span>&nbsp;<span class="op" id="4466040">=</span>&nbsp;<span class="num" id="4466042">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4466051">copy</span><span class="op" id="4466055">(</span><span class="ident" id="4466056">em</span><span class="op" id="4466058">[</span><span class="ident" id="4466059">k</span><span class="op" id="4466060">-</span><span class="ident" id="4466061">tLen</span><span class="op" id="4466065">:</span><span class="ident" id="4466066">k</span><span class="op" id="4466067">-</span><span class="ident" id="4466068">hashLen</span><span class="op" id="4466075">]</span><span class="op" id="4466076">,</span>&nbsp;<span class="ident" id="4466078">prefix</span><span class="op" id="4466084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4466087">copy</span><span class="op" id="4466091">(</span><span class="ident" id="4466092">em</span><span class="op" id="4466094">[</span><span class="ident" id="4466095">k</span><span class="op" id="4466096">-</span><span class="ident" id="4466097">hashLen</span><span class="op" id="4466104">:</span><span class="ident" id="4466105">k</span><span class="op" id="4466106">]</span><span class="op" id="4466107">,</span>&nbsp;<span class="ident" id="4466109">hashed</span><span class="op" id="4466115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466119">m</span>&nbsp;<span class="op" id="4466121">:=</span>&nbsp;<span class="builtinfunc" id="4466124">new</span><span class="op" id="4466127">(</span><span class="ident" id="4466128">big</span><span class="op" id="4466131">.</span><span class="ident" id="4466132">Int</span><span class="op" id="4466135">)</span><span class="op" id="4466136">.</span><span class="ident" id="4466137">SetBytes</span><span class="op" id="4466145">(</span><span class="ident" id="4466146">em</span><span class="op" id="4466148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466151">c</span><span class="op" id="4466152">,</span>&nbsp;<span class="ident" id="4466154">err</span>&nbsp;<span class="op" id="4466158">:=</span>&nbsp;<span class="ident" id="4466161">decrypt</span><span class="op" id="4466168">(</span><span class="ident" id="4466169">rand</span><span class="op" id="4466173">,</span>&nbsp;<span class="ident" id="4466175">priv</span><span class="op" id="4466179">,</span>&nbsp;<span class="ident" id="4466181">m</span><span class="op" id="4466182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466185">if</span>&nbsp;<span class="ident" id="4466188">err</span>&nbsp;<span class="op" id="4466192">!=</span>&nbsp;<span class="builtintype" id="4466195">nil</span>&nbsp;<span class="op" id="4466199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466211">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466215">copyWithLeftPad</span><span class="op" id="4466230">(</span><span class="ident" id="4466231">em</span><span class="op" id="4466233">,</span>&nbsp;<span class="ident" id="4466235">c</span><span class="op" id="4466236">.</span><span class="ident" id="4466237">Bytes</span><span class="op" id="4466242">(</span><span class="op" id="4466243">)</span><span class="op" id="4466244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466247">s</span>&nbsp;<span class="op" id="4466249">=</span>&nbsp;<span class="ident" id="4466251">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466255">return</span><br>
<span class="lineno"></span><span class="op" id="4466262">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="4466265">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="4466322">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="4466396">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4466468">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="4466545">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="4466593">func</span>&nbsp;<span class="ident" id="4466598">VerifyPKCS1v15</span><span class="op" id="4466612">(</span><span class="ident" id="4466613">pub</span>&nbsp;<span class="op" id="4466617">*</span><span class="ident" id="4466618">PublicKey</span><span class="op" id="4466627">,</span>&nbsp;<span class="ident" id="4466629">hash</span>&nbsp;<span class="ident" id="4466634">crypto</span><span class="op" id="4466640">.</span><span class="ident" id="4466641">Hash</span><span class="op" id="4466645">,</span>&nbsp;<span class="ident" id="4466647">hashed</span>&nbsp;<span class="op" id="4466654">[</span><span class="op" id="4466655">]</span><span class="builtintype" id="4466656">byte</span><span class="op" id="4466660">,</span>&nbsp;<span class="ident" id="4466662">sig</span>&nbsp;<span class="op" id="4466666">[</span><span class="op" id="4466667">]</span><span class="builtintype" id="4466668">byte</span><span class="op" id="4466672">)</span>&nbsp;<span class="op" id="4466674">(</span><span class="ident" id="4466675">err</span>&nbsp;<span class="builtintype" id="4466679">error</span><span class="op" id="4466684">)</span>&nbsp;<span class="op" id="4466686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466689">hashLen</span><span class="op" id="4466696">,</span>&nbsp;<span class="ident" id="4466698">prefix</span><span class="op" id="4466704">,</span>&nbsp;<span class="ident" id="4466706">err</span>&nbsp;<span class="op" id="4466710">:=</span>&nbsp;<span class="ident" id="4466713">pkcs1v15HashInfo</span><span class="op" id="4466729">(</span><span class="ident" id="4466730">hash</span><span class="op" id="4466734">,</span>&nbsp;<span class="builtinfunc" id="4466736">len</span><span class="op" id="4466739">(</span><span class="ident" id="4466740">hashed</span><span class="op" id="4466746">)</span><span class="op" id="4466747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466750">if</span>&nbsp;<span class="ident" id="4466753">err</span>&nbsp;<span class="op" id="4466757">!=</span>&nbsp;<span class="builtintype" id="4466760">nil</span>&nbsp;<span class="op" id="4466764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466768">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466780">tLen</span>&nbsp;<span class="op" id="4466785">:=</span>&nbsp;<span class="builtinfunc" id="4466788">len</span><span class="op" id="4466791">(</span><span class="ident" id="4466792">prefix</span><span class="op" id="4466798">)</span>&nbsp;<span class="op" id="4466800">+</span>&nbsp;<span class="ident" id="4466802">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466811">k</span>&nbsp;<span class="op" id="4466813">:=</span>&nbsp;<span class="op" id="4466816">(</span><span class="ident" id="4466817">pub</span><span class="op" id="4466820">.</span><span class="ident" id="4466821">N</span><span class="op" id="4466822">.</span><span class="ident" id="4466823">BitLen</span><span class="op" id="4466829">(</span><span class="op" id="4466830">)</span>&nbsp;<span class="op" id="4466832">+</span>&nbsp;<span class="num" id="4466834">7</span><span class="op" id="4466835">)</span>&nbsp;<span class="op" id="4466837">/</span>&nbsp;<span class="num" id="4466839">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466842">if</span>&nbsp;<span class="ident" id="4466845">k</span>&nbsp;<span class="op" id="4466847">&lt;</span>&nbsp;<span class="ident" id="4466849">tLen</span><span class="op" id="4466853">+</span><span class="num" id="4466854">11</span>&nbsp;<span class="op" id="4466857">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466861">err</span>&nbsp;<span class="op" id="4466865">=</span>&nbsp;<span class="ident" id="4466867">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4466885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4466893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466897">c</span>&nbsp;<span class="op" id="4466899">:=</span>&nbsp;<span class="builtinfunc" id="4466902">new</span><span class="op" id="4466905">(</span><span class="ident" id="4466906">big</span><span class="op" id="4466909">.</span><span class="ident" id="4466910">Int</span><span class="op" id="4466913">)</span><span class="op" id="4466914">.</span><span class="ident" id="4466915">SetBytes</span><span class="op" id="4466923">(</span><span class="ident" id="4466924">sig</span><span class="op" id="4466927">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466930">m</span>&nbsp;<span class="op" id="4466932">:=</span>&nbsp;<span class="ident" id="4466935">encrypt</span><span class="op" id="4466942">(</span><span class="builtinfunc" id="4466943">new</span><span class="op" id="4466946">(</span><span class="ident" id="4466947">big</span><span class="op" id="4466950">.</span><span class="ident" id="4466951">Int</span><span class="op" id="4466954">)</span><span class="op" id="4466955">,</span>&nbsp;<span class="ident" id="4466957">pub</span><span class="op" id="4466960">,</span>&nbsp;<span class="ident" id="4466962">c</span><span class="op" id="4466963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4466966">em</span>&nbsp;<span class="op" id="4466969">:=</span>&nbsp;<span class="ident" id="4466972">leftPad</span><span class="op" id="4466979">(</span><span class="ident" id="4466980">m</span><span class="op" id="4466981">.</span><span class="ident" id="4466982">Bytes</span><span class="op" id="4466987">(</span><span class="op" id="4466988">)</span><span class="op" id="4466989">,</span>&nbsp;<span class="ident" id="4466991">k</span><span class="op" id="4466992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4466995">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467037">ok</span>&nbsp;<span class="op" id="4467040">:=</span>&nbsp;<span class="ident" id="4467043">subtle</span><span class="op" id="4467049">.</span><span class="ident" id="4467050">ConstantTimeByteEq</span><span class="op" id="4467068">(</span><span class="ident" id="4467069">em</span><span class="op" id="4467071">[</span><span class="num" id="4467072">0</span><span class="op" id="4467073">]</span><span class="op" id="4467074">,</span>&nbsp;<span class="num" id="4467076">0</span><span class="op" id="4467077">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467080">ok</span>&nbsp;<span class="op" id="4467083">&amp;=</span>&nbsp;<span class="ident" id="4467086">subtle</span><span class="op" id="4467092">.</span><span class="ident" id="4467093">ConstantTimeByteEq</span><span class="op" id="4467111">(</span><span class="ident" id="4467112">em</span><span class="op" id="4467114">[</span><span class="num" id="4467115">1</span><span class="op" id="4467116">]</span><span class="op" id="4467117">,</span>&nbsp;<span class="num" id="4467119">1</span><span class="op" id="4467120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467123">ok</span>&nbsp;<span class="op" id="4467126">&amp;=</span>&nbsp;<span class="ident" id="4467129">subtle</span><span class="op" id="4467135">.</span><span class="ident" id="4467136">ConstantTimeCompare</span><span class="op" id="4467155">(</span><span class="ident" id="4467156">em</span><span class="op" id="4467158">[</span><span class="ident" id="4467159">k</span><span class="op" id="4467160">-</span><span class="ident" id="4467161">hashLen</span><span class="op" id="4467168">:</span><span class="ident" id="4467169">k</span><span class="op" id="4467170">]</span><span class="op" id="4467171">,</span>&nbsp;<span class="ident" id="4467173">hashed</span><span class="op" id="4467179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467182">ok</span>&nbsp;<span class="op" id="4467185">&amp;=</span>&nbsp;<span class="ident" id="4467188">subtle</span><span class="op" id="4467194">.</span><span class="ident" id="4467195">ConstantTimeCompare</span><span class="op" id="4467214">(</span><span class="ident" id="4467215">em</span><span class="op" id="4467217">[</span><span class="ident" id="4467218">k</span><span class="op" id="4467219">-</span><span class="ident" id="4467220">tLen</span><span class="op" id="4467224">:</span><span class="ident" id="4467225">k</span><span class="op" id="4467226">-</span><span class="ident" id="4467227">hashLen</span><span class="op" id="4467234">]</span><span class="op" id="4467235">,</span>&nbsp;<span class="ident" id="4467237">prefix</span><span class="op" id="4467243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467246">ok</span>&nbsp;<span class="op" id="4467249">&amp;=</span>&nbsp;<span class="ident" id="4467252">subtle</span><span class="op" id="4467258">.</span><span class="ident" id="4467259">ConstantTimeByteEq</span><span class="op" id="4467277">(</span><span class="ident" id="4467278">em</span><span class="op" id="4467280">[</span><span class="ident" id="4467281">k</span><span class="op" id="4467282">-</span><span class="ident" id="4467283">tLen</span><span class="op" id="4467287">-</span><span class="num" id="4467288">1</span><span class="op" id="4467289">]</span><span class="op" id="4467290">,</span>&nbsp;<span class="num" id="4467292">0</span><span class="op" id="4467293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467297">for</span>&nbsp;<span class="ident" id="4467301">i</span>&nbsp;<span class="op" id="4467303">:=</span>&nbsp;<span class="num" id="4467306">2</span><span class="op" id="4467307">;</span>&nbsp;<span class="ident" id="4467309">i</span>&nbsp;<span class="op" id="4467311">&lt;</span>&nbsp;<span class="ident" id="4467313">k</span><span class="op" id="4467314">-</span><span class="ident" id="4467315">tLen</span><span class="op" id="4467319">-</span><span class="num" id="4467320">1</span><span class="op" id="4467321">;</span>&nbsp;<span class="ident" id="4467323">i</span><span class="op" id="4467324">++</span>&nbsp;<span class="op" id="4467327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467331">ok</span>&nbsp;<span class="op" id="4467334">&amp;=</span>&nbsp;<span class="ident" id="4467337">subtle</span><span class="op" id="4467343">.</span><span class="ident" id="4467344">ConstantTimeByteEq</span><span class="op" id="4467362">(</span><span class="ident" id="4467363">em</span><span class="op" id="4467365">[</span><span class="ident" id="4467366">i</span><span class="op" id="4467367">]</span><span class="op" id="4467368">,</span>&nbsp;<span class="num" id="4467370">0xff</span><span class="op" id="4467374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467381">if</span>&nbsp;<span class="ident" id="4467384">ok</span>&nbsp;<span class="op" id="4467387">!=</span>&nbsp;<span class="num" id="4467390">1</span>&nbsp;<span class="op" id="4467392">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467396">return</span>&nbsp;<span class="ident" id="4467403">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467424">return</span>&nbsp;<span class="builtintype" id="4467431">nil</span><br>
<span class="lineno"></span><span class="op" id="4467435">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="4467438">func</span>&nbsp;<span class="ident" id="4467443">pkcs1v15HashInfo</span><span class="op" id="4467459">(</span><span class="ident" id="4467460">hash</span>&nbsp;<span class="ident" id="4467465">crypto</span><span class="op" id="4467471">.</span><span class="ident" id="4467472">Hash</span><span class="op" id="4467476">,</span>&nbsp;<span class="ident" id="4467478">inLen</span>&nbsp;<span class="builtintype" id="4467484">int</span><span class="op" id="4467487">)</span>&nbsp;<span class="op" id="4467489">(</span><span class="ident" id="4467490">hashLen</span>&nbsp;<span class="builtintype" id="4467498">int</span><span class="op" id="4467501">,</span>&nbsp;<span class="ident" id="4467503">prefix</span>&nbsp;<span class="op" id="4467510">[</span><span class="op" id="4467511">]</span><span class="builtintype" id="4467512">byte</span><span class="op" id="4467516">,</span>&nbsp;<span class="ident" id="4467518">err</span>&nbsp;<span class="builtintype" id="4467522">error</span><span class="op" id="4467527">)</span>&nbsp;<span class="op" id="4467529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4467532">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4467602">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467623">if</span>&nbsp;<span class="ident" id="4467626">hash</span>&nbsp;<span class="op" id="4467631">==</span>&nbsp;<span class="num" id="4467634">0</span>&nbsp;<span class="op" id="4467636">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467640">return</span>&nbsp;<span class="ident" id="4467647">inLen</span><span class="op" id="4467652">,</span>&nbsp;<span class="builtintype" id="4467654">nil</span><span class="op" id="4467657">,</span>&nbsp;<span class="builtintype" id="4467659">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467668">hashLen</span>&nbsp;<span class="op" id="4467676">=</span>&nbsp;<span class="ident" id="4467678">hash</span><span class="op" id="4467682">.</span><span class="ident" id="4467683">Size</span><span class="op" id="4467687">(</span><span class="op" id="4467688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467691">if</span>&nbsp;<span class="ident" id="4467694">inLen</span>&nbsp;<span class="op" id="4467700">!=</span>&nbsp;<span class="ident" id="4467703">hashLen</span>&nbsp;<span class="op" id="4467711">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467715">return</span>&nbsp;<span class="num" id="4467722">0</span><span class="op" id="4467723">,</span>&nbsp;<span class="builtintype" id="4467725">nil</span><span class="op" id="4467728">,</span>&nbsp;<span class="ident" id="4467730">errors</span><span class="op" id="4467736">.</span><span class="ident" id="4467737">New</span><span class="op" id="4467740">(</span><span class="string" id="4467741">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="4467783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4467789">prefix</span><span class="op" id="4467795">,</span>&nbsp;<span class="ident" id="4467797">ok</span>&nbsp;<span class="op" id="4467800">:=</span>&nbsp;<span class="ident" id="4467803">hashPrefixes</span><span class="op" id="4467815">[</span><span class="ident" id="4467816">hash</span><span class="op" id="4467820">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467823">if</span>&nbsp;<span class="op" id="4467826">!</span><span class="ident" id="4467827">ok</span>&nbsp;<span class="op" id="4467830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467834">return</span>&nbsp;<span class="num" id="4467841">0</span><span class="op" id="4467842">,</span>&nbsp;<span class="builtintype" id="4467844">nil</span><span class="op" id="4467847">,</span>&nbsp;<span class="ident" id="4467849">errors</span><span class="op" id="4467855">.</span><span class="ident" id="4467856">New</span><span class="op" id="4467859">(</span><span class="string" id="4467860">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="4467899">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4467902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4467905">return</span><br>
<span class="lineno"></span><span class="op" id="4467912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4467915">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="4467992">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="4468003">func</span>&nbsp;<span class="ident" id="4468008">copyWithLeftPad</span><span class="op" id="4468023">(</span><span class="ident" id="4468024">dest</span><span class="op" id="4468028">,</span>&nbsp;<span class="ident" id="4468030">src</span>&nbsp;<span class="op" id="4468034">[</span><span class="op" id="4468035">]</span><span class="builtintype" id="4468036">byte</span><span class="op" id="4468040">)</span>&nbsp;<span class="op" id="4468042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468045">numPaddingBytes</span>&nbsp;<span class="op" id="4468061">:=</span>&nbsp;<span class="builtinfunc" id="4468064">len</span><span class="op" id="4468067">(</span><span class="ident" id="4468068">dest</span><span class="op" id="4468072">)</span>&nbsp;<span class="op" id="4468074">-</span>&nbsp;<span class="builtinfunc" id="4468076">len</span><span class="op" id="4468079">(</span><span class="ident" id="4468080">src</span><span class="op" id="4468083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4468086">for</span>&nbsp;<span class="ident" id="4468090">i</span>&nbsp;<span class="op" id="4468092">:=</span>&nbsp;<span class="num" id="4468095">0</span><span class="op" id="4468096">;</span>&nbsp;<span class="ident" id="4468098">i</span>&nbsp;<span class="op" id="4468100">&lt;</span>&nbsp;<span class="ident" id="4468102">numPaddingBytes</span><span class="op" id="4468117">;</span>&nbsp;<span class="ident" id="4468119">i</span><span class="op" id="4468120">++</span>&nbsp;<span class="op" id="4468123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4468127">dest</span><span class="op" id="4468131">[</span><span class="ident" id="4468132">i</span><span class="op" id="4468133">]</span>&nbsp;<span class="op" id="4468135">=</span>&nbsp;<span class="num" id="4468137">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4468140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4468143">copy</span><span class="op" id="4468147">(</span><span class="ident" id="4468148">dest</span><span class="op" id="4468152">[</span><span class="ident" id="4468153">numPaddingBytes</span><span class="op" id="4468168">:</span><span class="op" id="4468169">]</span><span class="op" id="4468170">,</span>&nbsp;<span class="ident" id="4468172">src</span><span class="op" id="4468175">)</span><br>
<span class="lineno"></span><span class="op" id="4468177">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
