<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3505491">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3505546">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3505600">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3505651">package</span>&nbsp;<span class="ident" id="3505659">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3505665">import</span>&nbsp;<span class="op" id="3505672">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505675">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505684">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505693">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505703">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505710">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505716">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505729">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505750">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505767">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505775">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505786">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3505797">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3505804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3505807">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="3505877">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3505913">var</span>&nbsp;<span class="ident" id="3505917">ErrLineTooLong</span>&nbsp;<span class="op" id="3505932">=</span>&nbsp;<span class="ident" id="3505934">internal</span><span class="op" id="3505942">.</span><span class="ident" id="3505943">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3505959">type</span>&nbsp;<span class="ident" id="3505964">errorReader</span>&nbsp;<span class="keyword" id="3505976">struct</span>&nbsp;<span class="op" id="3505983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505986">err</span>&nbsp;<span class="builtintype" id="3505990">error</span><br>
<span class="lineno"></span><span class="op" id="3505996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3505999">func</span>&nbsp;<span class="op" id="3506004">(</span><span class="ident" id="3506005">r</span>&nbsp;<span class="op" id="3506007">*</span><span class="ident" id="3506008">errorReader</span><span class="op" id="3506019">)</span>&nbsp;<span class="ident" id="3506021">Read</span><span class="op" id="3506025">(</span><span class="ident" id="3506026">p</span>&nbsp;<span class="op" id="3506028">[</span><span class="op" id="3506029">]</span><span class="builtintype" id="3506030">byte</span><span class="op" id="3506034">)</span>&nbsp;<span class="op" id="3506036">(</span><span class="ident" id="3506037">n</span>&nbsp;<span class="builtintype" id="3506039">int</span><span class="op" id="3506042">,</span>&nbsp;<span class="ident" id="3506044">err</span>&nbsp;<span class="builtintype" id="3506048">error</span><span class="op" id="3506053">)</span>&nbsp;<span class="op" id="3506055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506058">return</span>&nbsp;<span class="num" id="3506065">0</span><span class="op" id="3506066">,</span>&nbsp;<span class="ident" id="3506068">r</span><span class="op" id="3506069">.</span><span class="ident" id="3506070">err</span><br>
<span class="lineno"></span><span class="op" id="3506074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506077">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="3506155">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3506231">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3506298">type</span>&nbsp;<span class="ident" id="3506303">transferWriter</span>&nbsp;<span class="keyword" id="3506318">struct</span>&nbsp;<span class="op" id="3506325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506328">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3506345">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506353">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506370">io</span><span class="op" id="3506372">.</span><span class="ident" id="3506373">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506381">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506398">io</span><span class="op" id="3506400">.</span><span class="ident" id="3506401">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506409">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3506426">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506432">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506449">int64</span>&nbsp;<span class="comment" id="3506455">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506498">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3506515">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506521">TransferEncoding</span>&nbsp;<span class="op" id="3506538">[</span><span class="op" id="3506539">]</span><span class="builtintype" id="3506540">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506548">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3506565">Header</span><br>
<span class="lineno"></span><span class="op" id="3506572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3506575">func</span>&nbsp;<span class="ident" id="3506580">newTransferWriter</span><span class="op" id="3506597">(</span><span class="ident" id="3506598">r</span>&nbsp;<span class="keyword" id="3506600">interface</span><span class="op" id="3506609">{</span><span class="op" id="3506610">}</span><span class="op" id="3506611">)</span>&nbsp;<span class="op" id="3506613">(</span><span class="ident" id="3506614">t</span>&nbsp;<span class="op" id="3506616">*</span><span class="ident" id="3506617">transferWriter</span><span class="op" id="3506631">,</span>&nbsp;<span class="ident" id="3506633">err</span>&nbsp;<span class="builtintype" id="3506637">error</span><span class="op" id="3506642">)</span>&nbsp;<span class="op" id="3506644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506647">t</span>&nbsp;<span class="op" id="3506649">=</span>&nbsp;<span class="op" id="3506651">&amp;</span><span class="ident" id="3506652">transferWriter</span><span class="op" id="3506666">{</span><span class="op" id="3506667">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3506671">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506699">atLeastHTTP11</span>&nbsp;<span class="op" id="3506713">:=</span>&nbsp;<span class="builtintype" id="3506716">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506723">switch</span>&nbsp;<span class="ident" id="3506730">rr</span>&nbsp;<span class="op" id="3506733">:=</span>&nbsp;<span class="ident" id="3506736">r</span><span class="op" id="3506737">.</span><span class="op" id="3506738">(</span><span class="keyword" id="3506739">type</span><span class="op" id="3506743">)</span>&nbsp;<span class="op" id="3506745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506748">case</span>&nbsp;<span class="op" id="3506753">*</span><span class="ident" id="3506754">Request</span><span class="op" id="3506761">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506765">if</span>&nbsp;<span class="ident" id="3506768">rr</span><span class="op" id="3506770">.</span><span class="ident" id="3506771">ContentLength</span>&nbsp;<span class="op" id="3506785">!=</span>&nbsp;<span class="num" id="3506788">0</span>&nbsp;<span class="op" id="3506790">&amp;&amp;</span>&nbsp;<span class="ident" id="3506793">rr</span><span class="op" id="3506795">.</span><span class="ident" id="3506796">Body</span>&nbsp;<span class="op" id="3506801">==</span>&nbsp;<span class="ident" id="3506804">nil</span>&nbsp;<span class="op" id="3506808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506813">return</span>&nbsp;<span class="ident" id="3506820">nil</span><span class="op" id="3506823">,</span>&nbsp;<span class="ident" id="3506825">fmt</span><span class="op" id="3506828">.</span><span class="ident" id="3506829">Errorf</span><span class="op" id="3506835">(</span><span class="string" id="3506836">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="3506882">,</span>&nbsp;<span class="ident" id="3506884">rr</span><span class="op" id="3506886">.</span><span class="ident" id="3506887">ContentLength</span><span class="op" id="3506900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3506904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506908">t</span><span class="op" id="3506909">.</span><span class="ident" id="3506910">Method</span>&nbsp;<span class="op" id="3506917">=</span>&nbsp;<span class="ident" id="3506919">rr</span><span class="op" id="3506921">.</span><span class="ident" id="3506922">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506931">t</span><span class="op" id="3506932">.</span><span class="ident" id="3506933">Body</span>&nbsp;<span class="op" id="3506938">=</span>&nbsp;<span class="ident" id="3506940">rr</span><span class="op" id="3506942">.</span><span class="ident" id="3506943">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506950">t</span><span class="op" id="3506951">.</span><span class="ident" id="3506952">BodyCloser</span>&nbsp;<span class="op" id="3506963">=</span>&nbsp;<span class="ident" id="3506965">rr</span><span class="op" id="3506967">.</span><span class="ident" id="3506968">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506975">t</span><span class="op" id="3506976">.</span><span class="ident" id="3506977">ContentLength</span>&nbsp;<span class="op" id="3506991">=</span>&nbsp;<span class="ident" id="3506993">rr</span><span class="op" id="3506995">.</span><span class="ident" id="3506996">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507012">t</span><span class="op" id="3507013">.</span><span class="ident" id="3507014">Close</span>&nbsp;<span class="op" id="3507020">=</span>&nbsp;<span class="ident" id="3507022">rr</span><span class="op" id="3507024">.</span><span class="ident" id="3507025">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507033">t</span><span class="op" id="3507034">.</span><span class="ident" id="3507035">TransferEncoding</span>&nbsp;<span class="op" id="3507052">=</span>&nbsp;<span class="ident" id="3507054">rr</span><span class="op" id="3507056">.</span><span class="ident" id="3507057">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507076">t</span><span class="op" id="3507077">.</span><span class="ident" id="3507078">Trailer</span>&nbsp;<span class="op" id="3507086">=</span>&nbsp;<span class="ident" id="3507088">rr</span><span class="op" id="3507090">.</span><span class="ident" id="3507091">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507101">atLeastHTTP11</span>&nbsp;<span class="op" id="3507115">=</span>&nbsp;<span class="ident" id="3507117">rr</span><span class="op" id="3507119">.</span><span class="ident" id="3507120">ProtoAtLeast</span><span class="op" id="3507132">(</span><span class="num" id="3507133">1</span><span class="op" id="3507134">,</span>&nbsp;<span class="num" id="3507136">1</span><span class="op" id="3507137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507141">if</span>&nbsp;<span class="ident" id="3507144">t</span><span class="op" id="3507145">.</span><span class="ident" id="3507146">Body</span>&nbsp;<span class="op" id="3507151">!=</span>&nbsp;<span class="ident" id="3507154">nil</span>&nbsp;<span class="op" id="3507158">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3507161">len</span><span class="op" id="3507164">(</span><span class="ident" id="3507165">t</span><span class="op" id="3507166">.</span><span class="ident" id="3507167">TransferEncoding</span><span class="op" id="3507183">)</span>&nbsp;<span class="op" id="3507185">==</span>&nbsp;<span class="num" id="3507188">0</span>&nbsp;<span class="op" id="3507190">&amp;&amp;</span>&nbsp;<span class="ident" id="3507193">atLeastHTTP11</span>&nbsp;<span class="op" id="3507207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507212">if</span>&nbsp;<span class="ident" id="3507215">t</span><span class="op" id="3507216">.</span><span class="ident" id="3507217">ContentLength</span>&nbsp;<span class="op" id="3507231">==</span>&nbsp;<span class="num" id="3507234">0</span>&nbsp;<span class="op" id="3507236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507242">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507298">var</span>&nbsp;<span class="ident" id="3507302">buf</span>&nbsp;<span class="op" id="3507306">[</span><span class="num" id="3507307">1</span><span class="op" id="3507308">]</span><span class="builtintype" id="3507309">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507318">n</span><span class="op" id="3507319">,</span>&nbsp;<span class="ident" id="3507321">rerr</span>&nbsp;<span class="op" id="3507326">:=</span>&nbsp;<span class="ident" id="3507329">io</span><span class="op" id="3507331">.</span><span class="ident" id="3507332">ReadFull</span><span class="op" id="3507340">(</span><span class="ident" id="3507341">t</span><span class="op" id="3507342">.</span><span class="ident" id="3507343">Body</span><span class="op" id="3507347">,</span>&nbsp;<span class="ident" id="3507349">buf</span><span class="op" id="3507352">[</span><span class="op" id="3507353">:</span><span class="op" id="3507354">]</span><span class="op" id="3507355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507361">if</span>&nbsp;<span class="ident" id="3507364">rerr</span>&nbsp;<span class="op" id="3507369">!=</span>&nbsp;<span class="ident" id="3507372">nil</span>&nbsp;<span class="op" id="3507376">&amp;&amp;</span>&nbsp;<span class="ident" id="3507379">rerr</span>&nbsp;<span class="op" id="3507384">!=</span>&nbsp;<span class="ident" id="3507387">io</span><span class="op" id="3507389">.</span><span class="ident" id="3507390">EOF</span>&nbsp;<span class="op" id="3507394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507401">t</span><span class="op" id="3507402">.</span><span class="ident" id="3507403">ContentLength</span>&nbsp;<span class="op" id="3507417">=</span>&nbsp;<span class="op" id="3507419">-</span><span class="num" id="3507420">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507427">t</span><span class="op" id="3507428">.</span><span class="ident" id="3507429">Body</span>&nbsp;<span class="op" id="3507434">=</span>&nbsp;<span class="op" id="3507436">&amp;</span><span class="ident" id="3507437">errorReader</span><span class="op" id="3507448">{</span><span class="ident" id="3507449">rerr</span><span class="op" id="3507453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507459">}</span>&nbsp;<span class="keyword" id="3507461">else</span>&nbsp;<span class="keyword" id="3507466">if</span>&nbsp;<span class="ident" id="3507469">n</span>&nbsp;<span class="op" id="3507471">==</span>&nbsp;<span class="num" id="3507474">1</span>&nbsp;<span class="op" id="3507476">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507483">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507546">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507595">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507656">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507679">t</span><span class="op" id="3507680">.</span><span class="ident" id="3507681">ContentLength</span>&nbsp;<span class="op" id="3507695">=</span>&nbsp;<span class="op" id="3507697">-</span><span class="num" id="3507698">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507705">t</span><span class="op" id="3507706">.</span><span class="ident" id="3507707">Body</span>&nbsp;<span class="op" id="3507712">=</span>&nbsp;<span class="ident" id="3507714">io</span><span class="op" id="3507716">.</span><span class="ident" id="3507717">MultiReader</span><span class="op" id="3507728">(</span><span class="ident" id="3507729">bytes</span><span class="op" id="3507734">.</span><span class="ident" id="3507735">NewReader</span><span class="op" id="3507744">(</span><span class="ident" id="3507745">buf</span><span class="op" id="3507748">[</span><span class="op" id="3507749">:</span><span class="op" id="3507750">]</span><span class="op" id="3507751">)</span><span class="op" id="3507752">,</span>&nbsp;<span class="ident" id="3507754">t</span><span class="op" id="3507755">.</span><span class="ident" id="3507756">Body</span><span class="op" id="3507760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507766">}</span>&nbsp;<span class="keyword" id="3507768">else</span>&nbsp;<span class="op" id="3507773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507780">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507812">t</span><span class="op" id="3507813">.</span><span class="ident" id="3507814">Body</span>&nbsp;<span class="op" id="3507819">=</span>&nbsp;<span class="ident" id="3507821">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507830">t</span><span class="op" id="3507831">.</span><span class="ident" id="3507832">BodyCloser</span>&nbsp;<span class="op" id="3507843">=</span>&nbsp;<span class="ident" id="3507845">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507863">if</span>&nbsp;<span class="ident" id="3507866">t</span><span class="op" id="3507867">.</span><span class="ident" id="3507868">ContentLength</span>&nbsp;<span class="op" id="3507882">&lt;</span>&nbsp;<span class="num" id="3507884">0</span>&nbsp;<span class="op" id="3507886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507892">t</span><span class="op" id="3507893">.</span><span class="ident" id="3507894">TransferEncoding</span>&nbsp;<span class="op" id="3507911">=</span>&nbsp;<span class="op" id="3507913">[</span><span class="op" id="3507914">]</span><span class="builtintype" id="3507915">string</span><span class="op" id="3507921">{</span><span class="string" id="3507922">&#34;chunked&#34;</span><span class="op" id="3507931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507936">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507943">case</span>&nbsp;<span class="op" id="3507948">*</span><span class="ident" id="3507949">Response</span><span class="op" id="3507957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507961">if</span>&nbsp;<span class="ident" id="3507964">rr</span><span class="op" id="3507966">.</span><span class="ident" id="3507967">Request</span>&nbsp;<span class="op" id="3507975">!=</span>&nbsp;<span class="ident" id="3507978">nil</span>&nbsp;<span class="op" id="3507982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507987">t</span><span class="op" id="3507988">.</span><span class="ident" id="3507989">Method</span>&nbsp;<span class="op" id="3507996">=</span>&nbsp;<span class="ident" id="3507998">rr</span><span class="op" id="3508000">.</span><span class="ident" id="3508001">Request</span><span class="op" id="3508008">.</span><span class="ident" id="3508009">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508018">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508022">t</span><span class="op" id="3508023">.</span><span class="ident" id="3508024">Body</span>&nbsp;<span class="op" id="3508029">=</span>&nbsp;<span class="ident" id="3508031">rr</span><span class="op" id="3508033">.</span><span class="ident" id="3508034">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508041">t</span><span class="op" id="3508042">.</span><span class="ident" id="3508043">BodyCloser</span>&nbsp;<span class="op" id="3508054">=</span>&nbsp;<span class="ident" id="3508056">rr</span><span class="op" id="3508058">.</span><span class="ident" id="3508059">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508066">t</span><span class="op" id="3508067">.</span><span class="ident" id="3508068">ContentLength</span>&nbsp;<span class="op" id="3508082">=</span>&nbsp;<span class="ident" id="3508084">rr</span><span class="op" id="3508086">.</span><span class="ident" id="3508087">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508103">t</span><span class="op" id="3508104">.</span><span class="ident" id="3508105">Close</span>&nbsp;<span class="op" id="3508111">=</span>&nbsp;<span class="ident" id="3508113">rr</span><span class="op" id="3508115">.</span><span class="ident" id="3508116">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508124">t</span><span class="op" id="3508125">.</span><span class="ident" id="3508126">TransferEncoding</span>&nbsp;<span class="op" id="3508143">=</span>&nbsp;<span class="ident" id="3508145">rr</span><span class="op" id="3508147">.</span><span class="ident" id="3508148">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508167">t</span><span class="op" id="3508168">.</span><span class="ident" id="3508169">Trailer</span>&nbsp;<span class="op" id="3508177">=</span>&nbsp;<span class="ident" id="3508179">rr</span><span class="op" id="3508181">.</span><span class="ident" id="3508182">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508192">atLeastHTTP11</span>&nbsp;<span class="op" id="3508206">=</span>&nbsp;<span class="ident" id="3508208">rr</span><span class="op" id="3508210">.</span><span class="ident" id="3508211">ProtoAtLeast</span><span class="op" id="3508223">(</span><span class="num" id="3508224">1</span><span class="op" id="3508225">,</span>&nbsp;<span class="num" id="3508227">1</span><span class="op" id="3508228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508232">t</span><span class="op" id="3508233">.</span><span class="ident" id="3508234">ResponseToHEAD</span>&nbsp;<span class="op" id="3508249">=</span>&nbsp;<span class="ident" id="3508251">noBodyExpected</span><span class="op" id="3508265">(</span><span class="ident" id="3508266">t</span><span class="op" id="3508267">.</span><span class="ident" id="3508268">Method</span><span class="op" id="3508274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3508281">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508330">if</span>&nbsp;<span class="ident" id="3508333">t</span><span class="op" id="3508334">.</span><span class="ident" id="3508335">ResponseToHEAD</span>&nbsp;<span class="op" id="3508350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508354">t</span><span class="op" id="3508355">.</span><span class="ident" id="3508356">Body</span>&nbsp;<span class="op" id="3508361">=</span>&nbsp;<span class="ident" id="3508363">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508369">if</span>&nbsp;<span class="ident" id="3508372">chunked</span><span class="op" id="3508379">(</span><span class="ident" id="3508380">t</span><span class="op" id="3508381">.</span><span class="ident" id="3508382">TransferEncoding</span><span class="op" id="3508398">)</span>&nbsp;<span class="op" id="3508400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508405">t</span><span class="op" id="3508406">.</span><span class="ident" id="3508407">ContentLength</span>&nbsp;<span class="op" id="3508421">=</span>&nbsp;<span class="op" id="3508423">-</span><span class="num" id="3508424">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508431">}</span>&nbsp;<span class="keyword" id="3508433">else</span>&nbsp;<span class="op" id="3508438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508442">if</span>&nbsp;<span class="op" id="3508445">!</span><span class="ident" id="3508446">atLeastHTTP11</span>&nbsp;<span class="op" id="3508460">||</span>&nbsp;<span class="ident" id="3508463">t</span><span class="op" id="3508464">.</span><span class="ident" id="3508465">Body</span>&nbsp;<span class="op" id="3508470">==</span>&nbsp;<span class="ident" id="3508473">nil</span>&nbsp;<span class="op" id="3508477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508482">t</span><span class="op" id="3508483">.</span><span class="ident" id="3508484">TransferEncoding</span>&nbsp;<span class="op" id="3508501">=</span>&nbsp;<span class="ident" id="3508503">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508509">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508513">if</span>&nbsp;<span class="ident" id="3508516">chunked</span><span class="op" id="3508523">(</span><span class="ident" id="3508524">t</span><span class="op" id="3508525">.</span><span class="ident" id="3508526">TransferEncoding</span><span class="op" id="3508542">)</span>&nbsp;<span class="op" id="3508544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508549">t</span><span class="op" id="3508550">.</span><span class="ident" id="3508551">ContentLength</span>&nbsp;<span class="op" id="3508565">=</span>&nbsp;<span class="op" id="3508567">-</span><span class="num" id="3508568">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508572">}</span>&nbsp;<span class="keyword" id="3508574">else</span>&nbsp;<span class="keyword" id="3508579">if</span>&nbsp;<span class="ident" id="3508582">t</span><span class="op" id="3508583">.</span><span class="ident" id="3508584">Body</span>&nbsp;<span class="op" id="3508589">==</span>&nbsp;<span class="ident" id="3508592">nil</span>&nbsp;<span class="op" id="3508596">{</span>&nbsp;<span class="comment" id="3508598">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508625">t</span><span class="op" id="3508626">.</span><span class="ident" id="3508627">ContentLength</span>&nbsp;<span class="op" id="3508641">=</span>&nbsp;<span class="num" id="3508643">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508647">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3508654">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508675">if</span>&nbsp;<span class="op" id="3508678">!</span><span class="ident" id="3508679">chunked</span><span class="op" id="3508686">(</span><span class="ident" id="3508687">t</span><span class="op" id="3508688">.</span><span class="ident" id="3508689">TransferEncoding</span><span class="op" id="3508705">)</span>&nbsp;<span class="op" id="3508707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508711">t</span><span class="op" id="3508712">.</span><span class="ident" id="3508713">Trailer</span>&nbsp;<span class="op" id="3508721">=</span>&nbsp;<span class="ident" id="3508723">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508732">return</span>&nbsp;<span class="ident" id="3508739">t</span><span class="op" id="3508740">,</span>&nbsp;<span class="ident" id="3508742">nil</span><br>
<span class="lineno"></span><span class="op" id="3508746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3508749">func</span>&nbsp;<span class="ident" id="3508754">noBodyExpected</span><span class="op" id="3508768">(</span><span class="ident" id="3508769">requestMethod</span>&nbsp;<span class="builtintype" id="3508783">string</span><span class="op" id="3508789">)</span>&nbsp;<span class="builtintype" id="3508791">bool</span>&nbsp;<span class="op" id="3508796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508799">return</span>&nbsp;<span class="ident" id="3508806">requestMethod</span>&nbsp;<span class="op" id="3508820">==</span>&nbsp;<span class="string" id="3508823">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="3508830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3508833">func</span>&nbsp;<span class="op" id="3508838">(</span><span class="ident" id="3508839">t</span>&nbsp;<span class="op" id="3508841">*</span><span class="ident" id="3508842">transferWriter</span><span class="op" id="3508856">)</span>&nbsp;<span class="ident" id="3508858">shouldSendContentLength</span><span class="op" id="3508881">(</span><span class="op" id="3508882">)</span>&nbsp;<span class="builtintype" id="3508884">bool</span>&nbsp;<span class="op" id="3508889">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508892">if</span>&nbsp;<span class="ident" id="3508895">chunked</span><span class="op" id="3508902">(</span><span class="ident" id="3508903">t</span><span class="op" id="3508904">.</span><span class="ident" id="3508905">TransferEncoding</span><span class="op" id="3508921">)</span>&nbsp;<span class="op" id="3508923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508927">return</span>&nbsp;<span class="builtintype" id="3508934">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508944">if</span>&nbsp;<span class="ident" id="3508947">t</span><span class="op" id="3508948">.</span><span class="ident" id="3508949">ContentLength</span>&nbsp;<span class="op" id="3508963">&gt;</span>&nbsp;<span class="num" id="3508965">0</span>&nbsp;<span class="op" id="3508967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508971">return</span>&nbsp;<span class="builtintype" id="3508978">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3508987">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509046">if</span>&nbsp;<span class="ident" id="3509049">t</span><span class="op" id="3509050">.</span><span class="ident" id="3509051">Method</span>&nbsp;<span class="op" id="3509058">==</span>&nbsp;<span class="string" id="3509061">&#34;POST&#34;</span>&nbsp;<span class="op" id="3509068">||</span>&nbsp;<span class="ident" id="3509071">t</span><span class="op" id="3509072">.</span><span class="ident" id="3509073">Method</span>&nbsp;<span class="op" id="3509080">==</span>&nbsp;<span class="string" id="3509083">&#34;PUT&#34;</span>&nbsp;<span class="op" id="3509089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509093">return</span>&nbsp;<span class="builtintype" id="3509100">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509106">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509109">if</span>&nbsp;<span class="ident" id="3509112">t</span><span class="op" id="3509113">.</span><span class="ident" id="3509114">ContentLength</span>&nbsp;<span class="op" id="3509128">==</span>&nbsp;<span class="num" id="3509131">0</span>&nbsp;<span class="op" id="3509133">&amp;&amp;</span>&nbsp;<span class="ident" id="3509136">isIdentity</span><span class="op" id="3509146">(</span><span class="ident" id="3509147">t</span><span class="op" id="3509148">.</span><span class="ident" id="3509149">TransferEncoding</span><span class="op" id="3509165">)</span>&nbsp;<span class="op" id="3509167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509171">return</span>&nbsp;<span class="builtintype" id="3509178">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509188">return</span>&nbsp;<span class="builtintype" id="3509195">false</span><br>
<span class="lineno">150</span><span class="op" id="3509201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3509204">func</span>&nbsp;<span class="op" id="3509209">(</span><span class="ident" id="3509210">t</span>&nbsp;<span class="op" id="3509212">*</span><span class="ident" id="3509213">transferWriter</span><span class="op" id="3509227">)</span>&nbsp;<span class="ident" id="3509229">WriteHeader</span><span class="op" id="3509240">(</span><span class="ident" id="3509241">w</span>&nbsp;<span class="ident" id="3509243">io</span><span class="op" id="3509245">.</span><span class="ident" id="3509246">Writer</span><span class="op" id="3509252">)</span>&nbsp;<span class="builtintype" id="3509254">error</span>&nbsp;<span class="op" id="3509260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509263">if</span>&nbsp;<span class="ident" id="3509266">t</span><span class="op" id="3509267">.</span><span class="ident" id="3509268">Close</span>&nbsp;<span class="op" id="3509274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509278">if</span>&nbsp;<span class="ident" id="3509281">_</span><span class="op" id="3509282">,</span>&nbsp;<span class="ident" id="3509284">err</span>&nbsp;<span class="op" id="3509288">:=</span>&nbsp;<span class="ident" id="3509291">io</span><span class="op" id="3509293">.</span><span class="ident" id="3509294">WriteString</span><span class="op" id="3509305">(</span><span class="ident" id="3509306">w</span><span class="op" id="3509307">,</span>&nbsp;<span class="string" id="3509309">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="3509332">)</span><span class="op" id="3509333">;</span>&nbsp;<span class="ident" id="3509335">err</span>&nbsp;<span class="op" id="3509339">!=</span>&nbsp;<span class="ident" id="3509342">nil</span>&nbsp;<span class="op" id="3509346">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509351">return</span>&nbsp;<span class="ident" id="3509358">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509371">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509440">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509505">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509527">if</span>&nbsp;<span class="ident" id="3509530">t</span><span class="op" id="3509531">.</span><span class="ident" id="3509532">shouldSendContentLength</span><span class="op" id="3509555">(</span><span class="op" id="3509556">)</span>&nbsp;<span class="op" id="3509558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509562">if</span>&nbsp;<span class="ident" id="3509565">_</span><span class="op" id="3509566">,</span>&nbsp;<span class="ident" id="3509568">err</span>&nbsp;<span class="op" id="3509572">:=</span>&nbsp;<span class="ident" id="3509575">io</span><span class="op" id="3509577">.</span><span class="ident" id="3509578">WriteString</span><span class="op" id="3509589">(</span><span class="ident" id="3509590">w</span><span class="op" id="3509591">,</span>&nbsp;<span class="string" id="3509593">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3509611">)</span><span class="op" id="3509612">;</span>&nbsp;<span class="ident" id="3509614">err</span>&nbsp;<span class="op" id="3509618">!=</span>&nbsp;<span class="ident" id="3509621">nil</span>&nbsp;<span class="op" id="3509625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509630">return</span>&nbsp;<span class="ident" id="3509637">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509647">if</span>&nbsp;<span class="ident" id="3509650">_</span><span class="op" id="3509651">,</span>&nbsp;<span class="ident" id="3509653">err</span>&nbsp;<span class="op" id="3509657">:=</span>&nbsp;<span class="ident" id="3509660">io</span><span class="op" id="3509662">.</span><span class="ident" id="3509663">WriteString</span><span class="op" id="3509674">(</span><span class="ident" id="3509675">w</span><span class="op" id="3509676">,</span>&nbsp;<span class="ident" id="3509678">strconv</span><span class="op" id="3509685">.</span><span class="ident" id="3509686">FormatInt</span><span class="op" id="3509695">(</span><span class="ident" id="3509696">t</span><span class="op" id="3509697">.</span><span class="ident" id="3509698">ContentLength</span><span class="op" id="3509711">,</span>&nbsp;<span class="num" id="3509713">10</span><span class="op" id="3509715">)</span><span class="op" id="3509716">+</span><span class="string" id="3509717">&#34;\r\n&#34;</span><span class="op" id="3509723">)</span><span class="op" id="3509724">;</span>&nbsp;<span class="ident" id="3509726">err</span>&nbsp;<span class="op" id="3509730">!=</span>&nbsp;<span class="ident" id="3509733">nil</span>&nbsp;<span class="op" id="3509737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509742">return</span>&nbsp;<span class="ident" id="3509749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509758">}</span>&nbsp;<span class="keyword" id="3509760">else</span>&nbsp;<span class="keyword" id="3509765">if</span>&nbsp;<span class="ident" id="3509768">chunked</span><span class="op" id="3509775">(</span><span class="ident" id="3509776">t</span><span class="op" id="3509777">.</span><span class="ident" id="3509778">TransferEncoding</span><span class="op" id="3509794">)</span>&nbsp;<span class="op" id="3509796">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509800">if</span>&nbsp;<span class="ident" id="3509803">_</span><span class="op" id="3509804">,</span>&nbsp;<span class="ident" id="3509806">err</span>&nbsp;<span class="op" id="3509810">:=</span>&nbsp;<span class="ident" id="3509813">io</span><span class="op" id="3509815">.</span><span class="ident" id="3509816">WriteString</span><span class="op" id="3509827">(</span><span class="ident" id="3509828">w</span><span class="op" id="3509829">,</span>&nbsp;<span class="string" id="3509831">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="3509863">)</span><span class="op" id="3509864">;</span>&nbsp;<span class="ident" id="3509866">err</span>&nbsp;<span class="op" id="3509870">!=</span>&nbsp;<span class="ident" id="3509873">nil</span>&nbsp;<span class="op" id="3509877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509882">return</span>&nbsp;<span class="ident" id="3509889">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509902">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509927">if</span>&nbsp;<span class="ident" id="3509930">t</span><span class="op" id="3509931">.</span><span class="ident" id="3509932">Trailer</span>&nbsp;<span class="op" id="3509940">!=</span>&nbsp;<span class="ident" id="3509943">nil</span>&nbsp;<span class="op" id="3509947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509951">keys</span>&nbsp;<span class="op" id="3509956">:=</span>&nbsp;<span class="builtinfunc" id="3509959">make</span><span class="op" id="3509963">(</span><span class="op" id="3509964">[</span><span class="op" id="3509965">]</span><span class="builtintype" id="3509966">string</span><span class="op" id="3509972">,</span>&nbsp;<span class="num" id="3509974">0</span><span class="op" id="3509975">,</span>&nbsp;<span class="builtinfunc" id="3509977">len</span><span class="op" id="3509980">(</span><span class="ident" id="3509981">t</span><span class="op" id="3509982">.</span><span class="ident" id="3509983">Trailer</span><span class="op" id="3509990">)</span><span class="op" id="3509991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509995">for</span>&nbsp;<span class="ident" id="3509999">k</span>&nbsp;<span class="op" id="3510001">:=</span>&nbsp;<span class="keyword" id="3510004">range</span>&nbsp;<span class="ident" id="3510010">t</span><span class="op" id="3510011">.</span><span class="ident" id="3510012">Trailer</span>&nbsp;<span class="op" id="3510020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510025">k</span>&nbsp;<span class="op" id="3510027">=</span>&nbsp;<span class="ident" id="3510029">CanonicalHeaderKey</span><span class="op" id="3510047">(</span><span class="ident" id="3510048">k</span><span class="op" id="3510049">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510054">switch</span>&nbsp;<span class="ident" id="3510061">k</span>&nbsp;<span class="op" id="3510063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510068">case</span>&nbsp;<span class="string" id="3510073">&#34;Transfer-Encoding&#34;</span><span class="op" id="3510092">,</span>&nbsp;<span class="string" id="3510094">&#34;Trailer&#34;</span><span class="op" id="3510103">,</span>&nbsp;<span class="string" id="3510105">&#34;Content-Length&#34;</span><span class="op" id="3510121">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510127">return</span>&nbsp;<span class="op" id="3510134">&amp;</span><span class="ident" id="3510135">badStringError</span><span class="op" id="3510149">{</span><span class="string" id="3510150">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="3510171">,</span>&nbsp;<span class="ident" id="3510173">k</span><span class="op" id="3510174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510184">keys</span>&nbsp;<span class="op" id="3510189">=</span>&nbsp;<span class="builtinfunc" id="3510191">append</span><span class="op" id="3510197">(</span><span class="ident" id="3510198">keys</span><span class="op" id="3510202">,</span>&nbsp;<span class="ident" id="3510204">k</span><span class="op" id="3510205">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510213">if</span>&nbsp;<span class="builtinfunc" id="3510216">len</span><span class="op" id="3510219">(</span><span class="ident" id="3510220">keys</span><span class="op" id="3510224">)</span>&nbsp;<span class="op" id="3510226">&gt;</span>&nbsp;<span class="num" id="3510228">0</span>&nbsp;<span class="op" id="3510230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510235">sort</span><span class="op" id="3510239">.</span><span class="ident" id="3510240">Strings</span><span class="op" id="3510247">(</span><span class="ident" id="3510248">keys</span><span class="op" id="3510252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3510257">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3510330">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510359">if</span>&nbsp;<span class="ident" id="3510362">_</span><span class="op" id="3510363">,</span>&nbsp;<span class="ident" id="3510365">err</span>&nbsp;<span class="op" id="3510369">:=</span>&nbsp;<span class="ident" id="3510372">io</span><span class="op" id="3510374">.</span><span class="ident" id="3510375">WriteString</span><span class="op" id="3510386">(</span><span class="ident" id="3510387">w</span><span class="op" id="3510388">,</span>&nbsp;<span class="string" id="3510390">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="3510401">+</span><span class="ident" id="3510402">strings</span><span class="op" id="3510409">.</span><span class="ident" id="3510410">Join</span><span class="op" id="3510414">(</span><span class="ident" id="3510415">keys</span><span class="op" id="3510419">,</span>&nbsp;<span class="string" id="3510421">&#34;,&#34;</span><span class="op" id="3510424">)</span><span class="op" id="3510425">+</span><span class="string" id="3510426">&#34;\r\n&#34;</span><span class="op" id="3510432">)</span><span class="op" id="3510433">;</span>&nbsp;<span class="ident" id="3510435">err</span>&nbsp;<span class="op" id="3510439">!=</span>&nbsp;<span class="ident" id="3510442">nil</span>&nbsp;<span class="op" id="3510446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510452">return</span>&nbsp;<span class="ident" id="3510459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510473">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510477">return</span>&nbsp;<span class="ident" id="3510484">nil</span><br>
<span class="lineno"></span><span class="op" id="3510488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3510491">func</span>&nbsp;<span class="op" id="3510496">(</span><span class="ident" id="3510497">t</span>&nbsp;<span class="op" id="3510499">*</span><span class="ident" id="3510500">transferWriter</span><span class="op" id="3510514">)</span>&nbsp;<span class="ident" id="3510516">WriteBody</span><span class="op" id="3510525">(</span><span class="ident" id="3510526">w</span>&nbsp;<span class="ident" id="3510528">io</span><span class="op" id="3510530">.</span><span class="ident" id="3510531">Writer</span><span class="op" id="3510537">)</span>&nbsp;<span class="builtintype" id="3510539">error</span>&nbsp;<span class="op" id="3510545">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510548">var</span>&nbsp;<span class="ident" id="3510552">err</span>&nbsp;<span class="builtintype" id="3510556">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510563">var</span>&nbsp;<span class="ident" id="3510567">ncopy</span>&nbsp;<span class="ident" id="3510573">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3510581">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510596">if</span>&nbsp;<span class="ident" id="3510599">t</span><span class="op" id="3510600">.</span><span class="ident" id="3510601">Body</span>&nbsp;<span class="op" id="3510606">!=</span>&nbsp;<span class="ident" id="3510609">nil</span>&nbsp;<span class="op" id="3510613">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510617">if</span>&nbsp;<span class="ident" id="3510620">chunked</span><span class="op" id="3510627">(</span><span class="ident" id="3510628">t</span><span class="op" id="3510629">.</span><span class="ident" id="3510630">TransferEncoding</span><span class="op" id="3510646">)</span>&nbsp;<span class="op" id="3510648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510653">cw</span>&nbsp;<span class="op" id="3510656">:=</span>&nbsp;<span class="ident" id="3510659">internal</span><span class="op" id="3510667">.</span><span class="ident" id="3510668">NewChunkedWriter</span><span class="op" id="3510684">(</span><span class="ident" id="3510685">w</span><span class="op" id="3510686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510691">_</span><span class="op" id="3510692">,</span>&nbsp;<span class="ident" id="3510694">err</span>&nbsp;<span class="op" id="3510698">=</span>&nbsp;<span class="ident" id="3510700">io</span><span class="op" id="3510702">.</span><span class="ident" id="3510703">Copy</span><span class="op" id="3510707">(</span><span class="ident" id="3510708">cw</span><span class="op" id="3510710">,</span>&nbsp;<span class="ident" id="3510712">t</span><span class="op" id="3510713">.</span><span class="ident" id="3510714">Body</span><span class="op" id="3510718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510723">if</span>&nbsp;<span class="ident" id="3510726">err</span>&nbsp;<span class="op" id="3510730">==</span>&nbsp;<span class="ident" id="3510733">nil</span>&nbsp;<span class="op" id="3510737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510743">err</span>&nbsp;<span class="op" id="3510747">=</span>&nbsp;<span class="ident" id="3510749">cw</span><span class="op" id="3510751">.</span><span class="ident" id="3510752">Close</span><span class="op" id="3510757">(</span><span class="op" id="3510758">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510767">}</span>&nbsp;<span class="keyword" id="3510769">else</span>&nbsp;<span class="keyword" id="3510774">if</span>&nbsp;<span class="ident" id="3510777">t</span><span class="op" id="3510778">.</span><span class="ident" id="3510779">ContentLength</span>&nbsp;<span class="op" id="3510793">==</span>&nbsp;<span class="op" id="3510796">-</span><span class="num" id="3510797">1</span>&nbsp;<span class="op" id="3510799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510804">ncopy</span><span class="op" id="3510809">,</span>&nbsp;<span class="ident" id="3510811">err</span>&nbsp;<span class="op" id="3510815">=</span>&nbsp;<span class="ident" id="3510817">io</span><span class="op" id="3510819">.</span><span class="ident" id="3510820">Copy</span><span class="op" id="3510824">(</span><span class="ident" id="3510825">w</span><span class="op" id="3510826">,</span>&nbsp;<span class="ident" id="3510828">t</span><span class="op" id="3510829">.</span><span class="ident" id="3510830">Body</span><span class="op" id="3510834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510838">}</span>&nbsp;<span class="keyword" id="3510840">else</span>&nbsp;<span class="op" id="3510845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510850">ncopy</span><span class="op" id="3510855">,</span>&nbsp;<span class="ident" id="3510857">err</span>&nbsp;<span class="op" id="3510861">=</span>&nbsp;<span class="ident" id="3510863">io</span><span class="op" id="3510865">.</span><span class="ident" id="3510866">Copy</span><span class="op" id="3510870">(</span><span class="ident" id="3510871">w</span><span class="op" id="3510872">,</span>&nbsp;<span class="ident" id="3510874">io</span><span class="op" id="3510876">.</span><span class="ident" id="3510877">LimitReader</span><span class="op" id="3510888">(</span><span class="ident" id="3510889">t</span><span class="op" id="3510890">.</span><span class="ident" id="3510891">Body</span><span class="op" id="3510895">,</span>&nbsp;<span class="ident" id="3510897">t</span><span class="op" id="3510898">.</span><span class="ident" id="3510899">ContentLength</span><span class="op" id="3510912">)</span><span class="op" id="3510913">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510918">if</span>&nbsp;<span class="ident" id="3510921">err</span>&nbsp;<span class="op" id="3510925">!=</span>&nbsp;<span class="ident" id="3510928">nil</span>&nbsp;<span class="op" id="3510932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510938">return</span>&nbsp;<span class="ident" id="3510945">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510957">var</span>&nbsp;<span class="ident" id="3510961">nextra</span>&nbsp;<span class="ident" id="3510968">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510977">nextra</span><span class="op" id="3510983">,</span>&nbsp;<span class="ident" id="3510985">err</span>&nbsp;<span class="op" id="3510989">=</span>&nbsp;<span class="ident" id="3510991">io</span><span class="op" id="3510993">.</span><span class="ident" id="3510994">Copy</span><span class="op" id="3510998">(</span><span class="ident" id="3510999">ioutil</span><span class="op" id="3511005">.</span><span class="ident" id="3511006">Discard</span><span class="op" id="3511013">,</span>&nbsp;<span class="ident" id="3511015">t</span><span class="op" id="3511016">.</span><span class="ident" id="3511017">Body</span><span class="op" id="3511021">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511026">ncopy</span>&nbsp;<span class="op" id="3511032">+=</span>&nbsp;<span class="ident" id="3511035">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511048">if</span>&nbsp;<span class="ident" id="3511051">err</span>&nbsp;<span class="op" id="3511055">!=</span>&nbsp;<span class="ident" id="3511058">nil</span>&nbsp;<span class="op" id="3511062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511067">return</span>&nbsp;<span class="ident" id="3511074">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511080">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511084">if</span>&nbsp;<span class="ident" id="3511087">err</span>&nbsp;<span class="op" id="3511091">=</span>&nbsp;<span class="ident" id="3511093">t</span><span class="op" id="3511094">.</span><span class="ident" id="3511095">BodyCloser</span><span class="op" id="3511105">.</span><span class="ident" id="3511106">Close</span><span class="op" id="3511111">(</span><span class="op" id="3511112">)</span><span class="op" id="3511113">;</span>&nbsp;<span class="ident" id="3511115">err</span>&nbsp;<span class="op" id="3511119">!=</span>&nbsp;<span class="ident" id="3511122">nil</span>&nbsp;<span class="op" id="3511126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511131">return</span>&nbsp;<span class="ident" id="3511138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511151">if</span>&nbsp;<span class="op" id="3511154">!</span><span class="ident" id="3511155">t</span><span class="op" id="3511156">.</span><span class="ident" id="3511157">ResponseToHEAD</span>&nbsp;<span class="op" id="3511172">&amp;&amp;</span>&nbsp;<span class="ident" id="3511175">t</span><span class="op" id="3511176">.</span><span class="ident" id="3511177">ContentLength</span>&nbsp;<span class="op" id="3511191">!=</span>&nbsp;<span class="op" id="3511194">-</span><span class="num" id="3511195">1</span>&nbsp;<span class="op" id="3511197">&amp;&amp;</span>&nbsp;<span class="ident" id="3511200">t</span><span class="op" id="3511201">.</span><span class="ident" id="3511202">ContentLength</span>&nbsp;<span class="op" id="3511216">!=</span>&nbsp;<span class="ident" id="3511219">ncopy</span>&nbsp;<span class="op" id="3511225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511229">return</span>&nbsp;<span class="ident" id="3511236">fmt</span><span class="op" id="3511239">.</span><span class="ident" id="3511240">Errorf</span><span class="op" id="3511246">(</span><span class="string" id="3511247">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3511291">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511296">t</span><span class="op" id="3511297">.</span><span class="ident" id="3511298">ContentLength</span><span class="op" id="3511311">,</span>&nbsp;<span class="ident" id="3511313">ncopy</span><span class="op" id="3511318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3511325">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511374">if</span>&nbsp;<span class="ident" id="3511377">chunked</span><span class="op" id="3511384">(</span><span class="ident" id="3511385">t</span><span class="op" id="3511386">.</span><span class="ident" id="3511387">TransferEncoding</span><span class="op" id="3511403">)</span>&nbsp;<span class="op" id="3511405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3511409">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511435">if</span>&nbsp;<span class="ident" id="3511438">t</span><span class="op" id="3511439">.</span><span class="ident" id="3511440">Trailer</span>&nbsp;<span class="op" id="3511448">!=</span>&nbsp;<span class="ident" id="3511451">nil</span>&nbsp;<span class="op" id="3511455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511460">if</span>&nbsp;<span class="ident" id="3511463">err</span>&nbsp;<span class="op" id="3511467">:=</span>&nbsp;<span class="ident" id="3511470">t</span><span class="op" id="3511471">.</span><span class="ident" id="3511472">Trailer</span><span class="op" id="3511479">.</span><span class="ident" id="3511480">Write</span><span class="op" id="3511485">(</span><span class="ident" id="3511486">w</span><span class="op" id="3511487">)</span><span class="op" id="3511488">;</span>&nbsp;<span class="ident" id="3511490">err</span>&nbsp;<span class="op" id="3511494">!=</span>&nbsp;<span class="ident" id="3511497">nil</span>&nbsp;<span class="op" id="3511501">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511507">return</span>&nbsp;<span class="ident" id="3511514">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3511529">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511560">_</span><span class="op" id="3511561">,</span>&nbsp;<span class="ident" id="3511563">err</span>&nbsp;<span class="op" id="3511567">=</span>&nbsp;<span class="ident" id="3511569">io</span><span class="op" id="3511571">.</span><span class="ident" id="3511572">WriteString</span><span class="op" id="3511583">(</span><span class="ident" id="3511584">w</span><span class="op" id="3511585">,</span>&nbsp;<span class="string" id="3511587">&#34;\r\n&#34;</span><span class="op" id="3511593">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511599">return</span>&nbsp;<span class="ident" id="3511606">err</span><br>
<span class="lineno"></span><span class="op" id="3511610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3511613">type</span>&nbsp;<span class="ident" id="3511618">transferReader</span>&nbsp;<span class="keyword" id="3511633">struct</span>&nbsp;<span class="op" id="3511640">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3511643">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511653">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511667">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511675">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3511689">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511694">RequestMethod</span>&nbsp;<span class="builtintype" id="3511708">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511716">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3511730">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511735">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3511749">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3511754">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511765">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511782">io</span><span class="op" id="3511784">.</span><span class="ident" id="3511785">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511797">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511814">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511821">TransferEncoding</span>&nbsp;<span class="op" id="3511838">[</span><span class="op" id="3511839">]</span><span class="builtintype" id="3511840">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511848">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3511865">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511871">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3511888">Header</span><br>
<span class="lineno"></span><span class="op" id="3511895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3511898">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="3511967">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="3512013">func</span>&nbsp;<span class="ident" id="3512018">bodyAllowedForStatus</span><span class="op" id="3512038">(</span><span class="ident" id="3512039">status</span>&nbsp;<span class="builtintype" id="3512046">int</span><span class="op" id="3512049">)</span>&nbsp;<span class="builtintype" id="3512051">bool</span>&nbsp;<span class="op" id="3512056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512059">switch</span>&nbsp;<span class="op" id="3512066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512069">case</span>&nbsp;<span class="ident" id="3512074">status</span>&nbsp;<span class="op" id="3512081">&gt;=</span>&nbsp;<span class="num" id="3512084">100</span>&nbsp;<span class="op" id="3512088">&amp;&amp;</span>&nbsp;<span class="ident" id="3512091">status</span>&nbsp;<span class="op" id="3512098">&lt;=</span>&nbsp;<span class="num" id="3512101">199</span><span class="op" id="3512104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512108">return</span>&nbsp;<span class="builtintype" id="3512115">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512122">case</span>&nbsp;<span class="ident" id="3512127">status</span>&nbsp;<span class="op" id="3512134">==</span>&nbsp;<span class="num" id="3512137">204</span><span class="op" id="3512140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512144">return</span>&nbsp;<span class="builtintype" id="3512151">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512158">case</span>&nbsp;<span class="ident" id="3512163">status</span>&nbsp;<span class="op" id="3512170">==</span>&nbsp;<span class="num" id="3512173">304</span><span class="op" id="3512176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512180">return</span>&nbsp;<span class="builtintype" id="3512187">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3512194">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512197">return</span>&nbsp;<span class="builtintype" id="3512204">true</span><br>
<span class="lineno"></span><span class="op" id="3512209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512212">var</span>&nbsp;<span class="op" id="3512216">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512219">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3512243">=</span>&nbsp;<span class="op" id="3512245">[</span><span class="op" id="3512246">]</span><span class="builtintype" id="3512247">string</span><span class="op" id="3512253">{</span><span class="string" id="3512254">&#34;Content-Type&#34;</span><span class="op" id="3512268">,</span>&nbsp;<span class="string" id="3512270">&#34;Content-Length&#34;</span><span class="op" id="3512286">,</span>&nbsp;<span class="string" id="3512288">&#34;Transfer-Encoding&#34;</span><span class="op" id="3512307">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512310">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="3512334">=</span>&nbsp;<span class="op" id="3512336">[</span><span class="op" id="3512337">]</span><span class="builtintype" id="3512338">string</span><span class="op" id="3512344">{</span><span class="string" id="3512345">&#34;Content-Length&#34;</span><span class="op" id="3512361">,</span>&nbsp;<span class="string" id="3512363">&#34;Transfer-Encoding&#34;</span><span class="op" id="3512382">}</span><br>
<span class="lineno"></span><span class="op" id="3512384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3512387">func</span>&nbsp;<span class="ident" id="3512392">suppressedHeaders</span><span class="op" id="3512409">(</span><span class="ident" id="3512410">status</span>&nbsp;<span class="builtintype" id="3512417">int</span><span class="op" id="3512420">)</span>&nbsp;<span class="op" id="3512422">[</span><span class="op" id="3512423">]</span><span class="builtintype" id="3512424">string</span>&nbsp;<span class="op" id="3512431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512434">switch</span>&nbsp;<span class="op" id="3512441">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512444">case</span>&nbsp;<span class="ident" id="3512449">status</span>&nbsp;<span class="op" id="3512456">==</span>&nbsp;<span class="num" id="3512459">304</span><span class="op" id="3512462">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512466">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512549">return</span>&nbsp;<span class="ident" id="3512556">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512578">case</span>&nbsp;<span class="op" id="3512583">!</span><span class="ident" id="3512584">bodyAllowedForStatus</span><span class="op" id="3512604">(</span><span class="ident" id="3512605">status</span><span class="op" id="3512611">)</span><span class="op" id="3512612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512616">return</span>&nbsp;<span class="ident" id="3512623">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3512648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512651">return</span>&nbsp;<span class="ident" id="3512658">nil</span><br>
<span class="lineno"></span><span class="op" id="3512662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3512665">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="3512698">func</span>&nbsp;<span class="ident" id="3512703">readTransfer</span><span class="op" id="3512715">(</span><span class="ident" id="3512716">msg</span>&nbsp;<span class="keyword" id="3512720">interface</span><span class="op" id="3512729">{</span><span class="op" id="3512730">}</span><span class="op" id="3512731">,</span>&nbsp;<span class="ident" id="3512733">r</span>&nbsp;<span class="op" id="3512735">*</span><span class="ident" id="3512736">bufio</span><span class="op" id="3512741">.</span><span class="ident" id="3512742">Reader</span><span class="op" id="3512748">)</span>&nbsp;<span class="op" id="3512750">(</span><span class="ident" id="3512751">err</span>&nbsp;<span class="builtintype" id="3512755">error</span><span class="op" id="3512760">)</span>&nbsp;<span class="op" id="3512762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512765">t</span>&nbsp;<span class="op" id="3512767">:=</span>&nbsp;<span class="op" id="3512770">&amp;</span><span class="ident" id="3512771">transferReader</span><span class="op" id="3512785">{</span><span class="ident" id="3512786">RequestMethod</span><span class="op" id="3512799">:</span>&nbsp;<span class="string" id="3512801">&#34;GET&#34;</span><span class="op" id="3512806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3512810">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512826">isResponse</span>&nbsp;<span class="op" id="3512837">:=</span>&nbsp;<span class="builtintype" id="3512840">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512847">switch</span>&nbsp;<span class="ident" id="3512854">rr</span>&nbsp;<span class="op" id="3512857">:=</span>&nbsp;<span class="ident" id="3512860">msg</span><span class="op" id="3512863">.</span><span class="op" id="3512864">(</span><span class="keyword" id="3512865">type</span><span class="op" id="3512869">)</span>&nbsp;<span class="op" id="3512871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3512874">case</span>&nbsp;<span class="op" id="3512879">*</span><span class="ident" id="3512880">Response</span><span class="op" id="3512888">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512892">t</span><span class="op" id="3512893">.</span><span class="ident" id="3512894">Header</span>&nbsp;<span class="op" id="3512901">=</span>&nbsp;<span class="ident" id="3512903">rr</span><span class="op" id="3512905">.</span><span class="ident" id="3512906">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512915">t</span><span class="op" id="3512916">.</span><span class="ident" id="3512917">StatusCode</span>&nbsp;<span class="op" id="3512928">=</span>&nbsp;<span class="ident" id="3512930">rr</span><span class="op" id="3512932">.</span><span class="ident" id="3512933">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512946">t</span><span class="op" id="3512947">.</span><span class="ident" id="3512948">ProtoMajor</span>&nbsp;<span class="op" id="3512959">=</span>&nbsp;<span class="ident" id="3512961">rr</span><span class="op" id="3512963">.</span><span class="ident" id="3512964">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3512977">t</span><span class="op" id="3512978">.</span><span class="ident" id="3512979">ProtoMinor</span>&nbsp;<span class="op" id="3512990">=</span>&nbsp;<span class="ident" id="3512992">rr</span><span class="op" id="3512994">.</span><span class="ident" id="3512995">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513008">t</span><span class="op" id="3513009">.</span><span class="ident" id="3513010">Close</span>&nbsp;<span class="op" id="3513016">=</span>&nbsp;<span class="ident" id="3513018">shouldClose</span><span class="op" id="3513029">(</span><span class="ident" id="3513030">t</span><span class="op" id="3513031">.</span><span class="ident" id="3513032">ProtoMajor</span><span class="op" id="3513042">,</span>&nbsp;<span class="ident" id="3513044">t</span><span class="op" id="3513045">.</span><span class="ident" id="3513046">ProtoMinor</span><span class="op" id="3513056">,</span>&nbsp;<span class="ident" id="3513058">t</span><span class="op" id="3513059">.</span><span class="ident" id="3513060">Header</span><span class="op" id="3513066">,</span>&nbsp;<span class="builtintype" id="3513068">true</span><span class="op" id="3513072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513076">isResponse</span>&nbsp;<span class="op" id="3513087">=</span>&nbsp;<span class="builtintype" id="3513089">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513096">if</span>&nbsp;<span class="ident" id="3513099">rr</span><span class="op" id="3513101">.</span><span class="ident" id="3513102">Request</span>&nbsp;<span class="op" id="3513110">!=</span>&nbsp;<span class="ident" id="3513113">nil</span>&nbsp;<span class="op" id="3513117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513122">t</span><span class="op" id="3513123">.</span><span class="ident" id="3513124">RequestMethod</span>&nbsp;<span class="op" id="3513138">=</span>&nbsp;<span class="ident" id="3513140">rr</span><span class="op" id="3513142">.</span><span class="ident" id="3513143">Request</span><span class="op" id="3513150">.</span><span class="ident" id="3513151">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513163">case</span>&nbsp;<span class="op" id="3513168">*</span><span class="ident" id="3513169">Request</span><span class="op" id="3513176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513180">t</span><span class="op" id="3513181">.</span><span class="ident" id="3513182">Header</span>&nbsp;<span class="op" id="3513189">=</span>&nbsp;<span class="ident" id="3513191">rr</span><span class="op" id="3513193">.</span><span class="ident" id="3513194">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513203">t</span><span class="op" id="3513204">.</span><span class="ident" id="3513205">ProtoMajor</span>&nbsp;<span class="op" id="3513216">=</span>&nbsp;<span class="ident" id="3513218">rr</span><span class="op" id="3513220">.</span><span class="ident" id="3513221">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513234">t</span><span class="op" id="3513235">.</span><span class="ident" id="3513236">ProtoMinor</span>&nbsp;<span class="op" id="3513247">=</span>&nbsp;<span class="ident" id="3513249">rr</span><span class="op" id="3513251">.</span><span class="ident" id="3513252">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3513265">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3513329">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513393">t</span><span class="op" id="3513394">.</span><span class="ident" id="3513395">StatusCode</span>&nbsp;<span class="op" id="3513406">=</span>&nbsp;<span class="num" id="3513408">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513413">default</span><span class="op" id="3513420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3513424">panic</span><span class="op" id="3513429">(</span><span class="string" id="3513430">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="3513447">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3513454">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513478">if</span>&nbsp;<span class="ident" id="3513481">t</span><span class="op" id="3513482">.</span><span class="ident" id="3513483">ProtoMajor</span>&nbsp;<span class="op" id="3513494">==</span>&nbsp;<span class="num" id="3513497">0</span>&nbsp;<span class="op" id="3513499">&amp;&amp;</span>&nbsp;<span class="ident" id="3513502">t</span><span class="op" id="3513503">.</span><span class="ident" id="3513504">ProtoMinor</span>&nbsp;<span class="op" id="3513515">==</span>&nbsp;<span class="num" id="3513518">0</span>&nbsp;<span class="op" id="3513520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513524">t</span><span class="op" id="3513525">.</span><span class="ident" id="3513526">ProtoMajor</span><span class="op" id="3513536">,</span>&nbsp;<span class="ident" id="3513538">t</span><span class="op" id="3513539">.</span><span class="ident" id="3513540">ProtoMinor</span>&nbsp;<span class="op" id="3513551">=</span>&nbsp;<span class="num" id="3513553">1</span><span class="op" id="3513554">,</span>&nbsp;<span class="num" id="3513556">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3513563">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513601">t</span><span class="op" id="3513602">.</span><span class="ident" id="3513603">TransferEncoding</span><span class="op" id="3513619">,</span>&nbsp;<span class="ident" id="3513621">err</span>&nbsp;<span class="op" id="3513625">=</span>&nbsp;<span class="ident" id="3513627">fixTransferEncoding</span><span class="op" id="3513646">(</span><span class="ident" id="3513647">t</span><span class="op" id="3513648">.</span><span class="ident" id="3513649">RequestMethod</span><span class="op" id="3513662">,</span>&nbsp;<span class="ident" id="3513664">t</span><span class="op" id="3513665">.</span><span class="ident" id="3513666">Header</span><span class="op" id="3513672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513675">if</span>&nbsp;<span class="ident" id="3513678">err</span>&nbsp;<span class="op" id="3513682">!=</span>&nbsp;<span class="ident" id="3513685">nil</span>&nbsp;<span class="op" id="3513689">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513693">return</span>&nbsp;<span class="ident" id="3513700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513709">realLength</span><span class="op" id="3513719">,</span>&nbsp;<span class="ident" id="3513721">err</span>&nbsp;<span class="op" id="3513725">:=</span>&nbsp;<span class="ident" id="3513728">fixLength</span><span class="op" id="3513737">(</span><span class="ident" id="3513738">isResponse</span><span class="op" id="3513748">,</span>&nbsp;<span class="ident" id="3513750">t</span><span class="op" id="3513751">.</span><span class="ident" id="3513752">StatusCode</span><span class="op" id="3513762">,</span>&nbsp;<span class="ident" id="3513764">t</span><span class="op" id="3513765">.</span><span class="ident" id="3513766">RequestMethod</span><span class="op" id="3513779">,</span>&nbsp;<span class="ident" id="3513781">t</span><span class="op" id="3513782">.</span><span class="ident" id="3513783">Header</span><span class="op" id="3513789">,</span>&nbsp;<span class="ident" id="3513791">t</span><span class="op" id="3513792">.</span><span class="ident" id="3513793">TransferEncoding</span><span class="op" id="3513809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513812">if</span>&nbsp;<span class="ident" id="3513815">err</span>&nbsp;<span class="op" id="3513819">!=</span>&nbsp;<span class="ident" id="3513822">nil</span>&nbsp;<span class="op" id="3513826">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513830">return</span>&nbsp;<span class="ident" id="3513837">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513845">if</span>&nbsp;<span class="ident" id="3513848">isResponse</span>&nbsp;<span class="op" id="3513859">&amp;&amp;</span>&nbsp;<span class="ident" id="3513862">t</span><span class="op" id="3513863">.</span><span class="ident" id="3513864">RequestMethod</span>&nbsp;<span class="op" id="3513878">==</span>&nbsp;<span class="string" id="3513881">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3513888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513892">if</span>&nbsp;<span class="ident" id="3513895">n</span><span class="op" id="3513896">,</span>&nbsp;<span class="ident" id="3513898">err</span>&nbsp;<span class="op" id="3513902">:=</span>&nbsp;<span class="ident" id="3513905">parseContentLength</span><span class="op" id="3513923">(</span><span class="ident" id="3513924">t</span><span class="op" id="3513925">.</span><span class="ident" id="3513926">Header</span><span class="op" id="3513932">.</span><span class="ident" id="3513933">get</span><span class="op" id="3513936">(</span><span class="string" id="3513937">&#34;Content-Length&#34;</span><span class="op" id="3513953">)</span><span class="op" id="3513954">)</span><span class="op" id="3513955">;</span>&nbsp;<span class="ident" id="3513957">err</span>&nbsp;<span class="op" id="3513961">!=</span>&nbsp;<span class="ident" id="3513964">nil</span>&nbsp;<span class="op" id="3513968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3513973">return</span>&nbsp;<span class="ident" id="3513980">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3513986">}</span>&nbsp;<span class="keyword" id="3513988">else</span>&nbsp;<span class="op" id="3513993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3513998">t</span><span class="op" id="3513999">.</span><span class="ident" id="3514000">ContentLength</span>&nbsp;<span class="op" id="3514014">=</span>&nbsp;<span class="ident" id="3514016">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514023">}</span>&nbsp;<span class="keyword" id="3514025">else</span>&nbsp;<span class="op" id="3514030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514034">t</span><span class="op" id="3514035">.</span><span class="ident" id="3514036">ContentLength</span>&nbsp;<span class="op" id="3514050">=</span>&nbsp;<span class="ident" id="3514052">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514068">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514080">t</span><span class="op" id="3514081">.</span><span class="ident" id="3514082">Trailer</span><span class="op" id="3514089">,</span>&nbsp;<span class="ident" id="3514091">err</span>&nbsp;<span class="op" id="3514095">=</span>&nbsp;<span class="ident" id="3514097">fixTrailer</span><span class="op" id="3514107">(</span><span class="ident" id="3514108">t</span><span class="op" id="3514109">.</span><span class="ident" id="3514110">Header</span><span class="op" id="3514116">,</span>&nbsp;<span class="ident" id="3514118">t</span><span class="op" id="3514119">.</span><span class="ident" id="3514120">TransferEncoding</span><span class="op" id="3514136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514139">if</span>&nbsp;<span class="ident" id="3514142">err</span>&nbsp;<span class="op" id="3514146">!=</span>&nbsp;<span class="ident" id="3514149">nil</span>&nbsp;<span class="op" id="3514153">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514157">return</span>&nbsp;<span class="ident" id="3514164">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514173">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514251">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514322">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514352">switch</span>&nbsp;<span class="ident" id="3514359">msg</span><span class="op" id="3514362">.</span><span class="op" id="3514363">(</span><span class="keyword" id="3514364">type</span><span class="op" id="3514368">)</span>&nbsp;<span class="op" id="3514370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514373">case</span>&nbsp;<span class="op" id="3514378">*</span><span class="ident" id="3514379">Response</span><span class="op" id="3514387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514391">if</span>&nbsp;<span class="ident" id="3514394">realLength</span>&nbsp;<span class="op" id="3514405">==</span>&nbsp;<span class="op" id="3514408">-</span><span class="num" id="3514409">1</span>&nbsp;<span class="op" id="3514411">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514417">!</span><span class="ident" id="3514418">chunked</span><span class="op" id="3514425">(</span><span class="ident" id="3514426">t</span><span class="op" id="3514427">.</span><span class="ident" id="3514428">TransferEncoding</span><span class="op" id="3514444">)</span>&nbsp;<span class="op" id="3514446">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514452">bodyAllowedForStatus</span><span class="op" id="3514472">(</span><span class="ident" id="3514473">t</span><span class="op" id="3514474">.</span><span class="ident" id="3514475">StatusCode</span><span class="op" id="3514485">)</span>&nbsp;<span class="op" id="3514487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514492">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514514">t</span><span class="op" id="3514515">.</span><span class="ident" id="3514516">Close</span>&nbsp;<span class="op" id="3514522">=</span>&nbsp;<span class="builtintype" id="3514524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514534">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514538">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3514605">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514681">switch</span>&nbsp;<span class="op" id="3514688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514691">case</span>&nbsp;<span class="ident" id="3514696">chunked</span><span class="op" id="3514703">(</span><span class="ident" id="3514704">t</span><span class="op" id="3514705">.</span><span class="ident" id="3514706">TransferEncoding</span><span class="op" id="3514722">)</span><span class="op" id="3514723">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514727">if</span>&nbsp;<span class="ident" id="3514730">noBodyExpected</span><span class="op" id="3514744">(</span><span class="ident" id="3514745">t</span><span class="op" id="3514746">.</span><span class="ident" id="3514747">RequestMethod</span><span class="op" id="3514760">)</span>&nbsp;<span class="op" id="3514762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514767">t</span><span class="op" id="3514768">.</span><span class="ident" id="3514769">Body</span>&nbsp;<span class="op" id="3514774">=</span>&nbsp;<span class="ident" id="3514776">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514788">}</span>&nbsp;<span class="keyword" id="3514790">else</span>&nbsp;<span class="op" id="3514795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514800">t</span><span class="op" id="3514801">.</span><span class="ident" id="3514802">Body</span>&nbsp;<span class="op" id="3514807">=</span>&nbsp;<span class="op" id="3514809">&amp;</span><span class="ident" id="3514810">body</span><span class="op" id="3514814">{</span><span class="ident" id="3514815">src</span><span class="op" id="3514818">:</span>&nbsp;<span class="ident" id="3514820">internal</span><span class="op" id="3514828">.</span><span class="ident" id="3514829">NewChunkedReader</span><span class="op" id="3514845">(</span><span class="ident" id="3514846">r</span><span class="op" id="3514847">)</span><span class="op" id="3514848">,</span>&nbsp;<span class="ident" id="3514850">hdr</span><span class="op" id="3514853">:</span>&nbsp;<span class="ident" id="3514855">msg</span><span class="op" id="3514858">,</span>&nbsp;<span class="ident" id="3514860">r</span><span class="op" id="3514861">:</span>&nbsp;<span class="ident" id="3514863">r</span><span class="op" id="3514864">,</span>&nbsp;<span class="ident" id="3514866">closing</span><span class="op" id="3514873">:</span>&nbsp;<span class="ident" id="3514875">t</span><span class="op" id="3514876">.</span><span class="ident" id="3514877">Close</span><span class="op" id="3514882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3514886">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514889">case</span>&nbsp;<span class="ident" id="3514894">realLength</span>&nbsp;<span class="op" id="3514905">==</span>&nbsp;<span class="num" id="3514908">0</span><span class="op" id="3514909">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514913">t</span><span class="op" id="3514914">.</span><span class="ident" id="3514915">Body</span>&nbsp;<span class="op" id="3514920">=</span>&nbsp;<span class="ident" id="3514922">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3514933">case</span>&nbsp;<span class="ident" id="3514938">realLength</span>&nbsp;<span class="op" id="3514949">&gt;</span>&nbsp;<span class="num" id="3514951">0</span><span class="op" id="3514952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3514956">t</span><span class="op" id="3514957">.</span><span class="ident" id="3514958">Body</span>&nbsp;<span class="op" id="3514963">=</span>&nbsp;<span class="op" id="3514965">&amp;</span><span class="ident" id="3514966">body</span><span class="op" id="3514970">{</span><span class="ident" id="3514971">src</span><span class="op" id="3514974">:</span>&nbsp;<span class="ident" id="3514976">io</span><span class="op" id="3514978">.</span><span class="ident" id="3514979">LimitReader</span><span class="op" id="3514990">(</span><span class="ident" id="3514991">r</span><span class="op" id="3514992">,</span>&nbsp;<span class="ident" id="3514994">realLength</span><span class="op" id="3515004">)</span><span class="op" id="3515005">,</span>&nbsp;<span class="ident" id="3515007">closing</span><span class="op" id="3515014">:</span>&nbsp;<span class="ident" id="3515016">t</span><span class="op" id="3515017">.</span><span class="ident" id="3515018">Close</span><span class="op" id="3515023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515026">default</span><span class="op" id="3515033">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3515037">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515104">if</span>&nbsp;<span class="ident" id="3515107">t</span><span class="op" id="3515108">.</span><span class="ident" id="3515109">Close</span>&nbsp;<span class="op" id="3515115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3515120">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515158">t</span><span class="op" id="3515159">.</span><span class="ident" id="3515160">Body</span>&nbsp;<span class="op" id="3515165">=</span>&nbsp;<span class="op" id="3515167">&amp;</span><span class="ident" id="3515168">body</span><span class="op" id="3515172">{</span><span class="ident" id="3515173">src</span><span class="op" id="3515176">:</span>&nbsp;<span class="ident" id="3515178">r</span><span class="op" id="3515179">,</span>&nbsp;<span class="ident" id="3515181">closing</span><span class="op" id="3515188">:</span>&nbsp;<span class="ident" id="3515190">t</span><span class="op" id="3515191">.</span><span class="ident" id="3515192">Close</span><span class="op" id="3515197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515201">}</span>&nbsp;<span class="keyword" id="3515203">else</span>&nbsp;<span class="op" id="3515208">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3515213">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515257">t</span><span class="op" id="3515258">.</span><span class="ident" id="3515259">Body</span>&nbsp;<span class="op" id="3515264">=</span>&nbsp;<span class="ident" id="3515266">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3515285">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515302">switch</span>&nbsp;<span class="ident" id="3515309">rr</span>&nbsp;<span class="op" id="3515312">:=</span>&nbsp;<span class="ident" id="3515315">msg</span><span class="op" id="3515318">.</span><span class="op" id="3515319">(</span><span class="keyword" id="3515320">type</span><span class="op" id="3515324">)</span>&nbsp;<span class="op" id="3515326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515329">case</span>&nbsp;<span class="op" id="3515334">*</span><span class="ident" id="3515335">Request</span><span class="op" id="3515342">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515346">rr</span><span class="op" id="3515348">.</span><span class="ident" id="3515349">Body</span>&nbsp;<span class="op" id="3515354">=</span>&nbsp;<span class="ident" id="3515356">t</span><span class="op" id="3515357">.</span><span class="ident" id="3515358">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515365">rr</span><span class="op" id="3515367">.</span><span class="ident" id="3515368">ContentLength</span>&nbsp;<span class="op" id="3515382">=</span>&nbsp;<span class="ident" id="3515384">t</span><span class="op" id="3515385">.</span><span class="ident" id="3515386">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515402">rr</span><span class="op" id="3515404">.</span><span class="ident" id="3515405">TransferEncoding</span>&nbsp;<span class="op" id="3515422">=</span>&nbsp;<span class="ident" id="3515424">t</span><span class="op" id="3515425">.</span><span class="ident" id="3515426">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515445">rr</span><span class="op" id="3515447">.</span><span class="ident" id="3515448">Close</span>&nbsp;<span class="op" id="3515454">=</span>&nbsp;<span class="ident" id="3515456">t</span><span class="op" id="3515457">.</span><span class="ident" id="3515458">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515466">rr</span><span class="op" id="3515468">.</span><span class="ident" id="3515469">Trailer</span>&nbsp;<span class="op" id="3515477">=</span>&nbsp;<span class="ident" id="3515479">t</span><span class="op" id="3515480">.</span><span class="ident" id="3515481">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515490">case</span>&nbsp;<span class="op" id="3515495">*</span><span class="ident" id="3515496">Response</span><span class="op" id="3515504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515508">rr</span><span class="op" id="3515510">.</span><span class="ident" id="3515511">Body</span>&nbsp;<span class="op" id="3515516">=</span>&nbsp;<span class="ident" id="3515518">t</span><span class="op" id="3515519">.</span><span class="ident" id="3515520">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515527">rr</span><span class="op" id="3515529">.</span><span class="ident" id="3515530">ContentLength</span>&nbsp;<span class="op" id="3515544">=</span>&nbsp;<span class="ident" id="3515546">t</span><span class="op" id="3515547">.</span><span class="ident" id="3515548">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515564">rr</span><span class="op" id="3515566">.</span><span class="ident" id="3515567">TransferEncoding</span>&nbsp;<span class="op" id="3515584">=</span>&nbsp;<span class="ident" id="3515586">t</span><span class="op" id="3515587">.</span><span class="ident" id="3515588">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515607">rr</span><span class="op" id="3515609">.</span><span class="ident" id="3515610">Close</span>&nbsp;<span class="op" id="3515616">=</span>&nbsp;<span class="ident" id="3515618">t</span><span class="op" id="3515619">.</span><span class="ident" id="3515620">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3515628">rr</span><span class="op" id="3515630">.</span><span class="ident" id="3515631">Trailer</span>&nbsp;<span class="op" id="3515639">=</span>&nbsp;<span class="ident" id="3515641">t</span><span class="op" id="3515642">.</span><span class="ident" id="3515643">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3515652">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3515656">return</span>&nbsp;<span class="ident" id="3515663">nil</span><br>
<span class="lineno"></span><span class="op" id="3515667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3515670">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="3515727">func</span>&nbsp;<span class="ident" id="3515732">chunked</span><span class="op" id="3515739">(</span><span class="ident" id="3515740">te</span>&nbsp;<span class="op" id="3515743">[</span><span class="op" id="3515744">]</span><span class="builtintype" id="3515745">string</span><span class="op" id="3515751">)</span>&nbsp;<span class="builtintype" id="3515753">bool</span>&nbsp;<span class="op" id="3515758">{</span>&nbsp;<span class="keyword" id="3515760">return</span>&nbsp;<span class="builtinfunc" id="3515767">len</span><span class="op" id="3515770">(</span><span class="ident" id="3515771">te</span><span class="op" id="3515773">)</span>&nbsp;<span class="op" id="3515775">&gt;</span>&nbsp;<span class="num" id="3515777">0</span>&nbsp;<span class="op" id="3515779">&amp;&amp;</span>&nbsp;<span class="ident" id="3515782">te</span><span class="op" id="3515784">[</span><span class="num" id="3515785">0</span><span class="op" id="3515786">]</span>&nbsp;<span class="op" id="3515788">==</span>&nbsp;<span class="string" id="3515791">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3515801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3515804">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3515861">func</span>&nbsp;<span class="ident" id="3515866">isIdentity</span><span class="op" id="3515876">(</span><span class="ident" id="3515877">te</span>&nbsp;<span class="op" id="3515880">[</span><span class="op" id="3515881">]</span><span class="builtintype" id="3515882">string</span><span class="op" id="3515888">)</span>&nbsp;<span class="builtintype" id="3515890">bool</span>&nbsp;<span class="op" id="3515895">{</span>&nbsp;<span class="keyword" id="3515897">return</span>&nbsp;<span class="builtinfunc" id="3515904">len</span><span class="op" id="3515907">(</span><span class="ident" id="3515908">te</span><span class="op" id="3515910">)</span>&nbsp;<span class="op" id="3515912">==</span>&nbsp;<span class="num" id="3515915">1</span>&nbsp;<span class="op" id="3515917">&amp;&amp;</span>&nbsp;<span class="ident" id="3515920">te</span><span class="op" id="3515922">[</span><span class="num" id="3515923">0</span><span class="op" id="3515924">]</span>&nbsp;<span class="op" id="3515926">==</span>&nbsp;<span class="string" id="3515929">&#34;identity&#34;</span>&nbsp;<span class="op" id="3515940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3515943">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="3515973">func</span>&nbsp;<span class="ident" id="3515978">fixTransferEncoding</span><span class="op" id="3515997">(</span><span class="ident" id="3515998">requestMethod</span>&nbsp;<span class="builtintype" id="3516012">string</span><span class="op" id="3516018">,</span>&nbsp;<span class="ident" id="3516020">header</span>&nbsp;<span class="ident" id="3516027">Header</span><span class="op" id="3516033">)</span>&nbsp;<span class="op" id="3516035">(</span><span class="op" id="3516036">[</span><span class="op" id="3516037">]</span><span class="builtintype" id="3516038">string</span><span class="op" id="3516044">,</span>&nbsp;<span class="builtintype" id="3516046">error</span><span class="op" id="3516051">)</span>&nbsp;<span class="op" id="3516053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516056">raw</span><span class="op" id="3516059">,</span>&nbsp;<span class="ident" id="3516061">present</span>&nbsp;<span class="op" id="3516069">:=</span>&nbsp;<span class="ident" id="3516072">header</span><span class="op" id="3516078">[</span><span class="string" id="3516079">&#34;Transfer-Encoding&#34;</span><span class="op" id="3516098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516101">if</span>&nbsp;<span class="op" id="3516104">!</span><span class="ident" id="3516105">present</span>&nbsp;<span class="op" id="3516113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516117">return</span>&nbsp;<span class="ident" id="3516124">nil</span><span class="op" id="3516127">,</span>&nbsp;<span class="ident" id="3516129">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3516138">delete</span><span class="op" id="3516144">(</span><span class="ident" id="3516145">header</span><span class="op" id="3516151">,</span>&nbsp;<span class="string" id="3516153">&#34;Transfer-Encoding&#34;</span><span class="op" id="3516172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516176">encodings</span>&nbsp;<span class="op" id="3516186">:=</span>&nbsp;<span class="ident" id="3516189">strings</span><span class="op" id="3516196">.</span><span class="ident" id="3516197">Split</span><span class="op" id="3516202">(</span><span class="ident" id="3516203">raw</span><span class="op" id="3516206">[</span><span class="num" id="3516207">0</span><span class="op" id="3516208">]</span><span class="op" id="3516209">,</span>&nbsp;<span class="string" id="3516211">&#34;,&#34;</span><span class="op" id="3516214">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516217">te</span>&nbsp;<span class="op" id="3516220">:=</span>&nbsp;<span class="builtinfunc" id="3516223">make</span><span class="op" id="3516227">(</span><span class="op" id="3516228">[</span><span class="op" id="3516229">]</span><span class="builtintype" id="3516230">string</span><span class="op" id="3516236">,</span>&nbsp;<span class="num" id="3516238">0</span><span class="op" id="3516239">,</span>&nbsp;<span class="builtinfunc" id="3516241">len</span><span class="op" id="3516244">(</span><span class="ident" id="3516245">encodings</span><span class="op" id="3516254">)</span><span class="op" id="3516255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516258">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516321">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516383">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516442">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516487">for</span>&nbsp;<span class="ident" id="3516491">_</span><span class="op" id="3516492">,</span>&nbsp;<span class="ident" id="3516494">encoding</span>&nbsp;<span class="op" id="3516503">:=</span>&nbsp;<span class="keyword" id="3516506">range</span>&nbsp;<span class="ident" id="3516512">encodings</span>&nbsp;<span class="op" id="3516522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516526">encoding</span>&nbsp;<span class="op" id="3516535">=</span>&nbsp;<span class="ident" id="3516537">strings</span><span class="op" id="3516544">.</span><span class="ident" id="3516545">ToLower</span><span class="op" id="3516552">(</span><span class="ident" id="3516553">strings</span><span class="op" id="3516560">.</span><span class="ident" id="3516561">TrimSpace</span><span class="op" id="3516570">(</span><span class="ident" id="3516571">encoding</span><span class="op" id="3516579">)</span><span class="op" id="3516580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516584">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516625">if</span>&nbsp;<span class="ident" id="3516628">encoding</span>&nbsp;<span class="op" id="3516637">==</span>&nbsp;<span class="string" id="3516640">&#34;identity&#34;</span>&nbsp;<span class="op" id="3516651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516656">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516668">if</span>&nbsp;<span class="ident" id="3516671">encoding</span>&nbsp;<span class="op" id="3516680">!=</span>&nbsp;<span class="string" id="3516683">&#34;chunked&#34;</span>&nbsp;<span class="op" id="3516693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516698">return</span>&nbsp;<span class="ident" id="3516705">nil</span><span class="op" id="3516708">,</span>&nbsp;<span class="op" id="3516710">&amp;</span><span class="ident" id="3516711">badStringError</span><span class="op" id="3516725">{</span><span class="string" id="3516726">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="3516757">,</span>&nbsp;<span class="ident" id="3516759">encoding</span><span class="op" id="3516767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516775">te</span>&nbsp;<span class="op" id="3516778">=</span>&nbsp;<span class="ident" id="3516780">te</span><span class="op" id="3516782">[</span><span class="num" id="3516783">0</span>&nbsp;<span class="op" id="3516785">:</span>&nbsp;<span class="builtinfunc" id="3516787">len</span><span class="op" id="3516790">(</span><span class="ident" id="3516791">te</span><span class="op" id="3516793">)</span><span class="op" id="3516794">+</span><span class="num" id="3516795">1</span><span class="op" id="3516796">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3516800">te</span><span class="op" id="3516802">[</span><span class="builtinfunc" id="3516803">len</span><span class="op" id="3516806">(</span><span class="ident" id="3516807">te</span><span class="op" id="3516809">)</span><span class="op" id="3516810">-</span><span class="num" id="3516811">1</span><span class="op" id="3516812">]</span>&nbsp;<span class="op" id="3516814">=</span>&nbsp;<span class="ident" id="3516816">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516829">if</span>&nbsp;<span class="builtinfunc" id="3516832">len</span><span class="op" id="3516835">(</span><span class="ident" id="3516836">te</span><span class="op" id="3516838">)</span>&nbsp;<span class="op" id="3516840">&gt;</span>&nbsp;<span class="num" id="3516842">1</span>&nbsp;<span class="op" id="3516844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516848">return</span>&nbsp;<span class="ident" id="3516855">nil</span><span class="op" id="3516858">,</span>&nbsp;<span class="op" id="3516860">&amp;</span><span class="ident" id="3516861">badStringError</span><span class="op" id="3516875">{</span><span class="string" id="3516876">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="3516905">,</span>&nbsp;<span class="ident" id="3516907">strings</span><span class="op" id="3516914">.</span><span class="ident" id="3516915">Join</span><span class="op" id="3516919">(</span><span class="ident" id="3516920">te</span><span class="op" id="3516922">,</span>&nbsp;<span class="string" id="3516924">&#34;,&#34;</span><span class="op" id="3516927">)</span><span class="op" id="3516928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3516931">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3516934">if</span>&nbsp;<span class="builtinfunc" id="3516937">len</span><span class="op" id="3516940">(</span><span class="ident" id="3516941">te</span><span class="op" id="3516943">)</span>&nbsp;<span class="op" id="3516945">&gt;</span>&nbsp;<span class="num" id="3516947">0</span>&nbsp;<span class="op" id="3516949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3516953">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517011">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517067">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3517082">delete</span><span class="op" id="3517088">(</span><span class="ident" id="3517089">header</span><span class="op" id="3517095">,</span>&nbsp;<span class="string" id="3517097">&#34;Content-Length&#34;</span><span class="op" id="3517113">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517117">return</span>&nbsp;<span class="ident" id="3517124">te</span><span class="op" id="3517126">,</span>&nbsp;<span class="ident" id="3517128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517137">return</span>&nbsp;<span class="ident" id="3517144">nil</span><span class="op" id="3517147">,</span>&nbsp;<span class="ident" id="3517149">nil</span><br>
<span class="lineno"></span><span class="op" id="3517153">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3517156">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="3517228">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3517299">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="3517332">func</span>&nbsp;<span class="ident" id="3517337">fixLength</span><span class="op" id="3517346">(</span><span class="ident" id="3517347">isResponse</span>&nbsp;<span class="builtintype" id="3517358">bool</span><span class="op" id="3517362">,</span>&nbsp;<span class="ident" id="3517364">status</span>&nbsp;<span class="builtintype" id="3517371">int</span><span class="op" id="3517374">,</span>&nbsp;<span class="ident" id="3517376">requestMethod</span>&nbsp;<span class="builtintype" id="3517390">string</span><span class="op" id="3517396">,</span>&nbsp;<span class="ident" id="3517398">header</span>&nbsp;<span class="ident" id="3517405">Header</span><span class="op" id="3517411">,</span>&nbsp;<span class="ident" id="3517413">te</span>&nbsp;<span class="op" id="3517416">[</span><span class="op" id="3517417">]</span><span class="builtintype" id="3517418">string</span><span class="op" id="3517424">)</span>&nbsp;<span class="op" id="3517426">(</span><span class="ident" id="3517427">int64</span><span class="op" id="3517432">,</span>&nbsp;<span class="builtintype" id="3517434">error</span><span class="op" id="3517439">)</span>&nbsp;<span class="op" id="3517441">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517445">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517488">if</span>&nbsp;<span class="ident" id="3517491">noBodyExpected</span><span class="op" id="3517505">(</span><span class="ident" id="3517506">requestMethod</span><span class="op" id="3517519">)</span>&nbsp;<span class="op" id="3517521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517525">return</span>&nbsp;<span class="num" id="3517532">0</span><span class="op" id="3517533">,</span>&nbsp;<span class="ident" id="3517535">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517540">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517543">if</span>&nbsp;<span class="ident" id="3517546">status</span><span class="op" id="3517552">/</span><span class="num" id="3517553">100</span>&nbsp;<span class="op" id="3517557">==</span>&nbsp;<span class="num" id="3517560">1</span>&nbsp;<span class="op" id="3517562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517566">return</span>&nbsp;<span class="num" id="3517573">0</span><span class="op" id="3517574">,</span>&nbsp;<span class="ident" id="3517576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517584">switch</span>&nbsp;<span class="ident" id="3517591">status</span>&nbsp;<span class="op" id="3517598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517601">case</span>&nbsp;<span class="num" id="3517606">204</span><span class="op" id="3517609">,</span>&nbsp;<span class="num" id="3517611">304</span><span class="op" id="3517614">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517618">return</span>&nbsp;<span class="num" id="3517625">0</span><span class="op" id="3517626">,</span>&nbsp;<span class="ident" id="3517628">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517637">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517674">if</span>&nbsp;<span class="ident" id="3517677">chunked</span><span class="op" id="3517684">(</span><span class="ident" id="3517685">te</span><span class="op" id="3517687">)</span>&nbsp;<span class="op" id="3517689">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517693">return</span>&nbsp;<span class="op" id="3517700">-</span><span class="num" id="3517701">1</span><span class="op" id="3517702">,</span>&nbsp;<span class="ident" id="3517704">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517713">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517747">cl</span>&nbsp;<span class="op" id="3517750">:=</span>&nbsp;<span class="ident" id="3517753">strings</span><span class="op" id="3517760">.</span><span class="ident" id="3517761">TrimSpace</span><span class="op" id="3517770">(</span><span class="ident" id="3517771">header</span><span class="op" id="3517777">.</span><span class="ident" id="3517778">get</span><span class="op" id="3517781">(</span><span class="string" id="3517782">&#34;Content-Length&#34;</span><span class="op" id="3517798">)</span><span class="op" id="3517799">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517802">if</span>&nbsp;<span class="ident" id="3517805">cl</span>&nbsp;<span class="op" id="3517808">!=</span>&nbsp;<span class="string" id="3517811">&#34;&#34;</span>&nbsp;<span class="op" id="3517814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517818">n</span><span class="op" id="3517819">,</span>&nbsp;<span class="ident" id="3517821">err</span>&nbsp;<span class="op" id="3517825">:=</span>&nbsp;<span class="ident" id="3517828">parseContentLength</span><span class="op" id="3517846">(</span><span class="ident" id="3517847">cl</span><span class="op" id="3517849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517853">if</span>&nbsp;<span class="ident" id="3517856">err</span>&nbsp;<span class="op" id="3517860">!=</span>&nbsp;<span class="ident" id="3517863">nil</span>&nbsp;<span class="op" id="3517867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517872">return</span>&nbsp;<span class="op" id="3517879">-</span><span class="num" id="3517880">1</span><span class="op" id="3517881">,</span>&nbsp;<span class="ident" id="3517883">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517889">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517893">return</span>&nbsp;<span class="ident" id="3517900">n</span><span class="op" id="3517901">,</span>&nbsp;<span class="ident" id="3517903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517908">}</span>&nbsp;<span class="keyword" id="3517910">else</span>&nbsp;<span class="op" id="3517915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3517919">header</span><span class="op" id="3517925">.</span><span class="ident" id="3517926">Del</span><span class="op" id="3517929">(</span><span class="string" id="3517930">&#34;Content-Length&#34;</span><span class="op" id="3517946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3517949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3517953">if</span>&nbsp;<span class="op" id="3517956">!</span><span class="ident" id="3517957">isResponse</span>&nbsp;<span class="op" id="3517968">&amp;&amp;</span>&nbsp;<span class="ident" id="3517971">requestMethod</span>&nbsp;<span class="op" id="3517985">==</span>&nbsp;<span class="string" id="3517988">&#34;GET&#34;</span>&nbsp;<span class="op" id="3517994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3517998">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518052">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518106">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518161">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518199">return</span>&nbsp;<span class="num" id="3518206">0</span><span class="op" id="3518207">,</span>&nbsp;<span class="ident" id="3518209">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518218">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518294">return</span>&nbsp;<span class="op" id="3518301">-</span><span class="num" id="3518302">1</span><span class="op" id="3518303">,</span>&nbsp;<span class="ident" id="3518305">nil</span><br>
<span class="lineno">500</span><span class="op" id="3518309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3518312">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3518381">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="3518414">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="3518449">func</span>&nbsp;<span class="ident" id="3518454">shouldClose</span><span class="op" id="3518465">(</span><span class="ident" id="3518466">major</span><span class="op" id="3518471">,</span>&nbsp;<span class="ident" id="3518473">minor</span>&nbsp;<span class="builtintype" id="3518479">int</span><span class="op" id="3518482">,</span>&nbsp;<span class="ident" id="3518484">header</span>&nbsp;<span class="ident" id="3518491">Header</span><span class="op" id="3518497">,</span>&nbsp;<span class="ident" id="3518499">removeCloseHeader</span>&nbsp;<span class="builtintype" id="3518517">bool</span><span class="op" id="3518521">)</span>&nbsp;<span class="builtintype" id="3518523">bool</span>&nbsp;<span class="op" id="3518528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518531">if</span>&nbsp;<span class="ident" id="3518534">major</span>&nbsp;<span class="op" id="3518540">&lt;</span>&nbsp;<span class="num" id="3518542">1</span>&nbsp;<span class="op" id="3518544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518548">return</span>&nbsp;<span class="builtintype" id="3518555">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518561">}</span>&nbsp;<span class="keyword" id="3518563">else</span>&nbsp;<span class="keyword" id="3518568">if</span>&nbsp;<span class="ident" id="3518571">major</span>&nbsp;<span class="op" id="3518577">==</span>&nbsp;<span class="num" id="3518580">1</span>&nbsp;<span class="op" id="3518582">&amp;&amp;</span>&nbsp;<span class="ident" id="3518585">minor</span>&nbsp;<span class="op" id="3518591">==</span>&nbsp;<span class="num" id="3518594">0</span>&nbsp;<span class="op" id="3518596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518600">if</span>&nbsp;<span class="op" id="3518603">!</span><span class="ident" id="3518604">strings</span><span class="op" id="3518611">.</span><span class="ident" id="3518612">Contains</span><span class="op" id="3518620">(</span><span class="ident" id="3518621">strings</span><span class="op" id="3518628">.</span><span class="ident" id="3518629">ToLower</span><span class="op" id="3518636">(</span><span class="ident" id="3518637">header</span><span class="op" id="3518643">.</span><span class="ident" id="3518644">get</span><span class="op" id="3518647">(</span><span class="string" id="3518648">&#34;Connection&#34;</span><span class="op" id="3518660">)</span><span class="op" id="3518661">)</span><span class="op" id="3518662">,</span>&nbsp;<span class="string" id="3518664">&#34;keep-alive&#34;</span><span class="op" id="3518676">)</span>&nbsp;<span class="op" id="3518678">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518683">return</span>&nbsp;<span class="builtintype" id="3518690">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518701">return</span>&nbsp;<span class="builtintype" id="3518708">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518715">}</span>&nbsp;<span class="keyword" id="3518717">else</span>&nbsp;<span class="op" id="3518722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518726">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3518791">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518818">if</span>&nbsp;<span class="ident" id="3518821">strings</span><span class="op" id="3518828">.</span><span class="ident" id="3518829">ToLower</span><span class="op" id="3518836">(</span><span class="ident" id="3518837">header</span><span class="op" id="3518843">.</span><span class="ident" id="3518844">get</span><span class="op" id="3518847">(</span><span class="string" id="3518848">&#34;Connection&#34;</span><span class="op" id="3518860">)</span><span class="op" id="3518861">)</span>&nbsp;<span class="op" id="3518863">==</span>&nbsp;<span class="string" id="3518866">&#34;close&#34;</span>&nbsp;<span class="op" id="3518874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518879">if</span>&nbsp;<span class="ident" id="3518882">removeCloseHeader</span>&nbsp;<span class="op" id="3518900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3518906">header</span><span class="op" id="3518912">.</span><span class="ident" id="3518913">Del</span><span class="op" id="3518916">(</span><span class="string" id="3518917">&#34;Connection&#34;</span><span class="op" id="3518929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518934">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518939">return</span>&nbsp;<span class="builtintype" id="3518946">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3518956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3518959">return</span>&nbsp;<span class="builtintype" id="3518966">false</span><br>
<span class="lineno"></span><span class="op" id="3518972">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="3518975">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3519003">func</span>&nbsp;<span class="ident" id="3519008">fixTrailer</span><span class="op" id="3519018">(</span><span class="ident" id="3519019">header</span>&nbsp;<span class="ident" id="3519026">Header</span><span class="op" id="3519032">,</span>&nbsp;<span class="ident" id="3519034">te</span>&nbsp;<span class="op" id="3519037">[</span><span class="op" id="3519038">]</span><span class="builtintype" id="3519039">string</span><span class="op" id="3519045">)</span>&nbsp;<span class="op" id="3519047">(</span><span class="ident" id="3519048">Header</span><span class="op" id="3519054">,</span>&nbsp;<span class="builtintype" id="3519056">error</span><span class="op" id="3519061">)</span>&nbsp;<span class="op" id="3519063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519066">raw</span>&nbsp;<span class="op" id="3519070">:=</span>&nbsp;<span class="ident" id="3519073">header</span><span class="op" id="3519079">.</span><span class="ident" id="3519080">get</span><span class="op" id="3519083">(</span><span class="string" id="3519084">&#34;Trailer&#34;</span><span class="op" id="3519093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519096">if</span>&nbsp;<span class="ident" id="3519099">raw</span>&nbsp;<span class="op" id="3519103">==</span>&nbsp;<span class="string" id="3519106">&#34;&#34;</span>&nbsp;<span class="op" id="3519109">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519113">return</span>&nbsp;<span class="ident" id="3519120">nil</span><span class="op" id="3519123">,</span>&nbsp;<span class="ident" id="3519125">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519134">header</span><span class="op" id="3519140">.</span><span class="ident" id="3519141">Del</span><span class="op" id="3519144">(</span><span class="string" id="3519145">&#34;Trailer&#34;</span><span class="op" id="3519154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519157">trailer</span>&nbsp;<span class="op" id="3519165">:=</span>&nbsp;<span class="builtinfunc" id="3519168">make</span><span class="op" id="3519172">(</span><span class="ident" id="3519173">Header</span><span class="op" id="3519179">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519182">keys</span>&nbsp;<span class="op" id="3519187">:=</span>&nbsp;<span class="ident" id="3519190">strings</span><span class="op" id="3519197">.</span><span class="ident" id="3519198">Split</span><span class="op" id="3519203">(</span><span class="ident" id="3519204">raw</span><span class="op" id="3519207">,</span>&nbsp;<span class="string" id="3519209">&#34;,&#34;</span><span class="op" id="3519212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519215">for</span>&nbsp;<span class="ident" id="3519219">_</span><span class="op" id="3519220">,</span>&nbsp;<span class="ident" id="3519222">key</span>&nbsp;<span class="op" id="3519226">:=</span>&nbsp;<span class="keyword" id="3519229">range</span>&nbsp;<span class="ident" id="3519235">keys</span>&nbsp;<span class="op" id="3519240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519244">key</span>&nbsp;<span class="op" id="3519248">=</span>&nbsp;<span class="ident" id="3519250">CanonicalHeaderKey</span><span class="op" id="3519268">(</span><span class="ident" id="3519269">strings</span><span class="op" id="3519276">.</span><span class="ident" id="3519277">TrimSpace</span><span class="op" id="3519286">(</span><span class="ident" id="3519287">key</span><span class="op" id="3519290">)</span><span class="op" id="3519291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519295">switch</span>&nbsp;<span class="ident" id="3519302">key</span>&nbsp;<span class="op" id="3519306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519310">case</span>&nbsp;<span class="string" id="3519315">&#34;Transfer-Encoding&#34;</span><span class="op" id="3519334">,</span>&nbsp;<span class="string" id="3519336">&#34;Trailer&#34;</span><span class="op" id="3519345">,</span>&nbsp;<span class="string" id="3519347">&#34;Content-Length&#34;</span><span class="op" id="3519363">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519368">return</span>&nbsp;<span class="ident" id="3519375">nil</span><span class="op" id="3519378">,</span>&nbsp;<span class="op" id="3519380">&amp;</span><span class="ident" id="3519381">badStringError</span><span class="op" id="3519395">{</span><span class="string" id="3519396">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="3519413">,</span>&nbsp;<span class="ident" id="3519415">key</span><span class="op" id="3519418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519426">trailer</span><span class="op" id="3519433">[</span><span class="ident" id="3519434">key</span><span class="op" id="3519437">]</span>&nbsp;<span class="op" id="3519439">=</span>&nbsp;<span class="ident" id="3519441">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519449">if</span>&nbsp;<span class="builtinfunc" id="3519452">len</span><span class="op" id="3519455">(</span><span class="ident" id="3519456">trailer</span><span class="op" id="3519463">)</span>&nbsp;<span class="op" id="3519465">==</span>&nbsp;<span class="num" id="3519468">0</span>&nbsp;<span class="op" id="3519470">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519474">return</span>&nbsp;<span class="ident" id="3519481">nil</span><span class="op" id="3519484">,</span>&nbsp;<span class="ident" id="3519486">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519494">if</span>&nbsp;<span class="op" id="3519497">!</span><span class="ident" id="3519498">chunked</span><span class="op" id="3519505">(</span><span class="ident" id="3519506">te</span><span class="op" id="3519508">)</span>&nbsp;<span class="op" id="3519510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3519514">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519543">return</span>&nbsp;<span class="ident" id="3519550">nil</span><span class="op" id="3519553">,</span>&nbsp;<span class="ident" id="3519555">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3519577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3519580">return</span>&nbsp;<span class="ident" id="3519587">trailer</span><span class="op" id="3519594">,</span>&nbsp;<span class="ident" id="3519596">nil</span><br>
<span class="lineno"></span><span class="op" id="3519600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3519603">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="3519645">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="3519696">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3519740">type</span>&nbsp;<span class="ident" id="3519745">body</span>&nbsp;<span class="keyword" id="3519750">struct</span>&nbsp;<span class="op" id="3519757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519760">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3519768">io</span><span class="op" id="3519770">.</span><span class="ident" id="3519771">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519779">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3519787">interface</span><span class="op" id="3519796">{</span><span class="op" id="3519797">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3519801">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519860">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3519868">*</span><span class="ident" id="3519869">bufio</span><span class="op" id="3519874">.</span><span class="ident" id="3519875">Reader</span>&nbsp;<span class="comment" id="3519882">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3519932">closing</span>&nbsp;<span class="builtintype" id="3519940">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3519954">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520010">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3520017">sync</span><span class="op" id="3520021">.</span><span class="ident" id="3520022">Mutex</span>&nbsp;<span class="comment" id="3520028">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520075">closed</span>&nbsp;<span class="builtintype" id="3520082">bool</span><br>
<span class="lineno">565</span><span class="op" id="3520087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3520090">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="3520162">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3520242">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="3520306">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="3520325">var</span>&nbsp;<span class="ident" id="3520329">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="3520351">=</span>&nbsp;<span class="ident" id="3520353">errors</span><span class="op" id="3520359">.</span><span class="ident" id="3520360">New</span><span class="op" id="3520363">(</span><span class="string" id="3520364">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="3520399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3520402">func</span>&nbsp;<span class="op" id="3520407">(</span><span class="ident" id="3520408">b</span>&nbsp;<span class="op" id="3520410">*</span><span class="ident" id="3520411">body</span><span class="op" id="3520415">)</span>&nbsp;<span class="ident" id="3520417">Read</span><span class="op" id="3520421">(</span><span class="ident" id="3520422">p</span>&nbsp;<span class="op" id="3520424">[</span><span class="op" id="3520425">]</span><span class="builtintype" id="3520426">byte</span><span class="op" id="3520430">)</span>&nbsp;<span class="op" id="3520432">(</span><span class="ident" id="3520433">n</span>&nbsp;<span class="builtintype" id="3520435">int</span><span class="op" id="3520438">,</span>&nbsp;<span class="ident" id="3520440">err</span>&nbsp;<span class="builtintype" id="3520444">error</span><span class="op" id="3520449">)</span>&nbsp;<span class="op" id="3520451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520454">b</span><span class="op" id="3520455">.</span><span class="ident" id="3520456">mu</span><span class="op" id="3520458">.</span><span class="ident" id="3520459">Lock</span><span class="op" id="3520463">(</span><span class="op" id="3520464">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520467">defer</span>&nbsp;<span class="ident" id="3520473">b</span><span class="op" id="3520474">.</span><span class="ident" id="3520475">mu</span><span class="op" id="3520477">.</span><span class="ident" id="3520478">Unlock</span><span class="op" id="3520484">(</span><span class="op" id="3520485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520488">if</span>&nbsp;<span class="ident" id="3520491">b</span><span class="op" id="3520492">.</span><span class="ident" id="3520493">closed</span>&nbsp;<span class="op" id="3520500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520504">return</span>&nbsp;<span class="num" id="3520511">0</span><span class="op" id="3520512">,</span>&nbsp;<span class="ident" id="3520514">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520540">return</span>&nbsp;<span class="ident" id="3520547">b</span><span class="op" id="3520548">.</span><span class="ident" id="3520549">readLocked</span><span class="op" id="3520559">(</span><span class="ident" id="3520560">p</span><span class="op" id="3520561">)</span><br>
<span class="lineno">580</span><span class="op" id="3520563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3520566">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3520585">func</span>&nbsp;<span class="op" id="3520590">(</span><span class="ident" id="3520591">b</span>&nbsp;<span class="op" id="3520593">*</span><span class="ident" id="3520594">body</span><span class="op" id="3520598">)</span>&nbsp;<span class="ident" id="3520600">readLocked</span><span class="op" id="3520610">(</span><span class="ident" id="3520611">p</span>&nbsp;<span class="op" id="3520613">[</span><span class="op" id="3520614">]</span><span class="builtintype" id="3520615">byte</span><span class="op" id="3520619">)</span>&nbsp;<span class="op" id="3520621">(</span><span class="ident" id="3520622">n</span>&nbsp;<span class="builtintype" id="3520624">int</span><span class="op" id="3520627">,</span>&nbsp;<span class="ident" id="3520629">err</span>&nbsp;<span class="builtintype" id="3520633">error</span><span class="op" id="3520638">)</span>&nbsp;<span class="op" id="3520640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520643">n</span><span class="op" id="3520644">,</span>&nbsp;<span class="ident" id="3520646">err</span>&nbsp;<span class="op" id="3520650">=</span>&nbsp;<span class="ident" id="3520652">b</span><span class="op" id="3520653">.</span><span class="ident" id="3520654">src</span><span class="op" id="3520657">.</span><span class="ident" id="3520658">Read</span><span class="op" id="3520662">(</span><span class="ident" id="3520663">p</span><span class="op" id="3520664">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520668">if</span>&nbsp;<span class="ident" id="3520671">err</span>&nbsp;<span class="op" id="3520675">==</span>&nbsp;<span class="ident" id="3520678">io</span><span class="op" id="3520680">.</span><span class="ident" id="3520681">EOF</span>&nbsp;<span class="op" id="3520685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520689">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520726">if</span>&nbsp;<span class="ident" id="3520729">b</span><span class="op" id="3520730">.</span><span class="ident" id="3520731">hdr</span>&nbsp;<span class="op" id="3520735">!=</span>&nbsp;<span class="ident" id="3520738">nil</span>&nbsp;<span class="op" id="3520742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520747">if</span>&nbsp;<span class="ident" id="3520750">e</span>&nbsp;<span class="op" id="3520752">:=</span>&nbsp;<span class="ident" id="3520755">b</span><span class="op" id="3520756">.</span><span class="ident" id="3520757">readTrailer</span><span class="op" id="3520768">(</span><span class="op" id="3520769">)</span><span class="op" id="3520770">;</span>&nbsp;<span class="ident" id="3520772">e</span>&nbsp;<span class="op" id="3520774">!=</span>&nbsp;<span class="ident" id="3520777">nil</span>&nbsp;<span class="op" id="3520781">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520787">err</span>&nbsp;<span class="op" id="3520791">=</span>&nbsp;<span class="ident" id="3520793">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3520803">b</span><span class="op" id="3520804">.</span><span class="ident" id="3520805">hdr</span>&nbsp;<span class="op" id="3520809">=</span>&nbsp;<span class="ident" id="3520811">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3520817">}</span>&nbsp;<span class="keyword" id="3520819">else</span>&nbsp;<span class="op" id="3520824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520829">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3520906">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3520965">if</span>&nbsp;<span class="ident" id="3520968">lr</span><span class="op" id="3520970">,</span>&nbsp;<span class="ident" id="3520972">ok</span>&nbsp;<span class="op" id="3520975">:=</span>&nbsp;<span class="ident" id="3520978">b</span><span class="op" id="3520979">.</span><span class="ident" id="3520980">src</span><span class="op" id="3520983">.</span><span class="op" id="3520984">(</span><span class="op" id="3520985">*</span><span class="ident" id="3520986">io</span><span class="op" id="3520988">.</span><span class="ident" id="3520989">LimitedReader</span><span class="op" id="3521002">)</span><span class="op" id="3521003">;</span>&nbsp;<span class="ident" id="3521005">ok</span>&nbsp;<span class="op" id="3521008">&amp;&amp;</span>&nbsp;<span class="ident" id="3521011">lr</span><span class="op" id="3521013">.</span><span class="ident" id="3521014">N</span>&nbsp;<span class="op" id="3521016">&gt;</span>&nbsp;<span class="num" id="3521018">0</span>&nbsp;<span class="op" id="3521020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521026">err</span>&nbsp;<span class="op" id="3521030">=</span>&nbsp;<span class="ident" id="3521032">io</span><span class="op" id="3521034">.</span><span class="ident" id="3521035">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521059">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521066">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521128">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521191">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521251">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521312">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521357">if</span>&nbsp;<span class="ident" id="3521360">err</span>&nbsp;<span class="op" id="3521364">==</span>&nbsp;<span class="ident" id="3521367">nil</span>&nbsp;<span class="op" id="3521371">&amp;&amp;</span>&nbsp;<span class="ident" id="3521374">n</span>&nbsp;<span class="op" id="3521376">&gt;</span>&nbsp;<span class="num" id="3521378">0</span>&nbsp;<span class="op" id="3521380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521384">if</span>&nbsp;<span class="ident" id="3521387">lr</span><span class="op" id="3521389">,</span>&nbsp;<span class="ident" id="3521391">ok</span>&nbsp;<span class="op" id="3521394">:=</span>&nbsp;<span class="ident" id="3521397">b</span><span class="op" id="3521398">.</span><span class="ident" id="3521399">src</span><span class="op" id="3521402">.</span><span class="op" id="3521403">(</span><span class="op" id="3521404">*</span><span class="ident" id="3521405">io</span><span class="op" id="3521407">.</span><span class="ident" id="3521408">LimitedReader</span><span class="op" id="3521421">)</span><span class="op" id="3521422">;</span>&nbsp;<span class="ident" id="3521424">ok</span>&nbsp;<span class="op" id="3521427">&amp;&amp;</span>&nbsp;<span class="ident" id="3521430">lr</span><span class="op" id="3521432">.</span><span class="ident" id="3521433">N</span>&nbsp;<span class="op" id="3521435">==</span>&nbsp;<span class="num" id="3521438">0</span>&nbsp;<span class="op" id="3521440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521445">err</span>&nbsp;<span class="op" id="3521449">=</span>&nbsp;<span class="ident" id="3521451">io</span><span class="op" id="3521453">.</span><span class="ident" id="3521454">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521467">return</span>&nbsp;<span class="ident" id="3521474">n</span><span class="op" id="3521475">,</span>&nbsp;<span class="ident" id="3521477">err</span><br>
<span class="lineno"></span><span class="op" id="3521481">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="3521484">var</span>&nbsp;<span class="op" id="3521488">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521491">singleCRLF</span>&nbsp;<span class="op" id="3521502">=</span>&nbsp;<span class="op" id="3521504">[</span><span class="op" id="3521505">]</span><span class="builtintype" id="3521506">byte</span><span class="op" id="3521510">(</span><span class="string" id="3521511">&#34;\r\n&#34;</span><span class="op" id="3521517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521520">doubleCRLF</span>&nbsp;<span class="op" id="3521531">=</span>&nbsp;<span class="op" id="3521533">[</span><span class="op" id="3521534">]</span><span class="builtintype" id="3521535">byte</span><span class="op" id="3521539">(</span><span class="string" id="3521540">&#34;\r\n\r\n&#34;</span><span class="op" id="3521550">)</span><br>
<span class="lineno"></span><span class="op" id="3521552">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="3521555">func</span>&nbsp;<span class="ident" id="3521560">seeUpcomingDoubleCRLF</span><span class="op" id="3521581">(</span><span class="ident" id="3521582">r</span>&nbsp;<span class="op" id="3521584">*</span><span class="ident" id="3521585">bufio</span><span class="op" id="3521590">.</span><span class="ident" id="3521591">Reader</span><span class="op" id="3521597">)</span>&nbsp;<span class="builtintype" id="3521599">bool</span>&nbsp;<span class="op" id="3521604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521607">for</span>&nbsp;<span class="ident" id="3521611">peekSize</span>&nbsp;<span class="op" id="3521620">:=</span>&nbsp;<span class="num" id="3521623">4</span><span class="op" id="3521624">;</span>&nbsp;<span class="op" id="3521626">;</span>&nbsp;<span class="ident" id="3521628">peekSize</span><span class="op" id="3521636">++</span>&nbsp;<span class="op" id="3521639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521643">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521692">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3521744">buf</span><span class="op" id="3521747">,</span>&nbsp;<span class="ident" id="3521749">err</span>&nbsp;<span class="op" id="3521753">:=</span>&nbsp;<span class="ident" id="3521756">r</span><span class="op" id="3521757">.</span><span class="ident" id="3521758">Peek</span><span class="op" id="3521762">(</span><span class="ident" id="3521763">peekSize</span><span class="op" id="3521771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521775">if</span>&nbsp;<span class="ident" id="3521778">bytes</span><span class="op" id="3521783">.</span><span class="ident" id="3521784">HasSuffix</span><span class="op" id="3521793">(</span><span class="ident" id="3521794">buf</span><span class="op" id="3521797">,</span>&nbsp;<span class="ident" id="3521799">doubleCRLF</span><span class="op" id="3521809">)</span>&nbsp;<span class="op" id="3521811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521816">return</span>&nbsp;<span class="builtintype" id="3521823">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521834">if</span>&nbsp;<span class="ident" id="3521837">err</span>&nbsp;<span class="op" id="3521841">!=</span>&nbsp;<span class="ident" id="3521844">nil</span>&nbsp;<span class="op" id="3521848">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521853">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3521864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3521867">return</span>&nbsp;<span class="builtintype" id="3521874">false</span><br>
<span class="lineno"></span><span class="op" id="3521880">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="3521883">var</span>&nbsp;<span class="ident" id="3521887">errTrailerEOF</span>&nbsp;<span class="op" id="3521901">=</span>&nbsp;<span class="ident" id="3521903">errors</span><span class="op" id="3521909">.</span><span class="ident" id="3521910">New</span><span class="op" id="3521913">(</span><span class="string" id="3521914">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="3521952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3521955">func</span>&nbsp;<span class="op" id="3521960">(</span><span class="ident" id="3521961">b</span>&nbsp;<span class="op" id="3521963">*</span><span class="ident" id="3521964">body</span><span class="op" id="3521968">)</span>&nbsp;<span class="ident" id="3521970">readTrailer</span><span class="op" id="3521981">(</span><span class="op" id="3521982">)</span>&nbsp;<span class="builtintype" id="3521984">error</span>&nbsp;<span class="op" id="3521990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3521993">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522042">buf</span><span class="op" id="3522045">,</span>&nbsp;<span class="ident" id="3522047">err</span>&nbsp;<span class="op" id="3522051">:=</span>&nbsp;<span class="ident" id="3522054">b</span><span class="op" id="3522055">.</span><span class="ident" id="3522056">r</span><span class="op" id="3522057">.</span><span class="ident" id="3522058">Peek</span><span class="op" id="3522062">(</span><span class="num" id="3522063">2</span><span class="op" id="3522064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522067">if</span>&nbsp;<span class="ident" id="3522070">bytes</span><span class="op" id="3522075">.</span><span class="ident" id="3522076">Equal</span><span class="op" id="3522081">(</span><span class="ident" id="3522082">buf</span><span class="op" id="3522085">,</span>&nbsp;<span class="ident" id="3522087">singleCRLF</span><span class="op" id="3522097">)</span>&nbsp;<span class="op" id="3522099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522103">b</span><span class="op" id="3522104">.</span><span class="ident" id="3522105">r</span><span class="op" id="3522106">.</span><span class="ident" id="3522107">ReadByte</span><span class="op" id="3522115">(</span><span class="op" id="3522116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522120">b</span><span class="op" id="3522121">.</span><span class="ident" id="3522122">r</span><span class="op" id="3522123">.</span><span class="ident" id="3522124">ReadByte</span><span class="op" id="3522132">(</span><span class="op" id="3522133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522137">return</span>&nbsp;<span class="ident" id="3522144">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522152">if</span>&nbsp;<span class="builtinfunc" id="3522155">len</span><span class="op" id="3522158">(</span><span class="ident" id="3522159">buf</span><span class="op" id="3522162">)</span>&nbsp;<span class="op" id="3522164">&lt;</span>&nbsp;<span class="num" id="3522166">2</span>&nbsp;<span class="op" id="3522168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522172">return</span>&nbsp;<span class="ident" id="3522179">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522197">if</span>&nbsp;<span class="ident" id="3522200">err</span>&nbsp;<span class="op" id="3522204">!=</span>&nbsp;<span class="ident" id="3522207">nil</span>&nbsp;<span class="op" id="3522211">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522215">return</span>&nbsp;<span class="ident" id="3522222">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522231">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522295">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522355">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522419">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522481">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522545">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522609">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3522672">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522746">if</span>&nbsp;<span class="op" id="3522749">!</span><span class="ident" id="3522750">seeUpcomingDoubleCRLF</span><span class="op" id="3522771">(</span><span class="ident" id="3522772">b</span><span class="op" id="3522773">.</span><span class="ident" id="3522774">r</span><span class="op" id="3522775">)</span>&nbsp;<span class="op" id="3522777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522781">return</span>&nbsp;<span class="ident" id="3522788">errors</span><span class="op" id="3522794">.</span><span class="ident" id="3522795">New</span><span class="op" id="3522798">(</span><span class="string" id="3522799">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="3522851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3522858">hdr</span><span class="op" id="3522861">,</span>&nbsp;<span class="ident" id="3522863">err</span>&nbsp;<span class="op" id="3522867">:=</span>&nbsp;<span class="ident" id="3522870">textproto</span><span class="op" id="3522879">.</span><span class="ident" id="3522880">NewReader</span><span class="op" id="3522889">(</span><span class="ident" id="3522890">b</span><span class="op" id="3522891">.</span><span class="ident" id="3522892">r</span><span class="op" id="3522893">)</span><span class="op" id="3522894">.</span><span class="ident" id="3522895">ReadMIMEHeader</span><span class="op" id="3522909">(</span><span class="op" id="3522910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522913">if</span>&nbsp;<span class="ident" id="3522916">err</span>&nbsp;<span class="op" id="3522920">!=</span>&nbsp;<span class="ident" id="3522923">nil</span>&nbsp;<span class="op" id="3522927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522931">if</span>&nbsp;<span class="ident" id="3522934">err</span>&nbsp;<span class="op" id="3522938">==</span>&nbsp;<span class="ident" id="3522941">io</span><span class="op" id="3522943">.</span><span class="ident" id="3522944">EOF</span>&nbsp;<span class="op" id="3522948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522953">return</span>&nbsp;<span class="ident" id="3522960">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522976">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522980">return</span>&nbsp;<span class="ident" id="3522987">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3522992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3522995">switch</span>&nbsp;<span class="ident" id="3523002">rr</span>&nbsp;<span class="op" id="3523005">:=</span>&nbsp;<span class="ident" id="3523008">b</span><span class="op" id="3523009">.</span><span class="ident" id="3523010">hdr</span><span class="op" id="3523013">.</span><span class="op" id="3523014">(</span><span class="keyword" id="3523015">type</span><span class="op" id="3523019">)</span>&nbsp;<span class="op" id="3523021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523024">case</span>&nbsp;<span class="op" id="3523029">*</span><span class="ident" id="3523030">Request</span><span class="op" id="3523037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523041">mergeSetHeader</span><span class="op" id="3523055">(</span><span class="op" id="3523056">&amp;</span><span class="ident" id="3523057">rr</span><span class="op" id="3523059">.</span><span class="ident" id="3523060">Trailer</span><span class="op" id="3523067">,</span>&nbsp;<span class="ident" id="3523069">Header</span><span class="op" id="3523075">(</span><span class="ident" id="3523076">hdr</span><span class="op" id="3523079">)</span><span class="op" id="3523080">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523083">case</span>&nbsp;<span class="op" id="3523088">*</span><span class="ident" id="3523089">Response</span><span class="op" id="3523097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523101">mergeSetHeader</span><span class="op" id="3523115">(</span><span class="op" id="3523116">&amp;</span><span class="ident" id="3523117">rr</span><span class="op" id="3523119">.</span><span class="ident" id="3523120">Trailer</span><span class="op" id="3523127">,</span>&nbsp;<span class="ident" id="3523129">Header</span><span class="op" id="3523135">(</span><span class="ident" id="3523136">hdr</span><span class="op" id="3523139">)</span><span class="op" id="3523140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523146">return</span>&nbsp;<span class="ident" id="3523153">nil</span><br>
<span class="lineno"></span><span class="op" id="3523157">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3523160">func</span>&nbsp;<span class="ident" id="3523165">mergeSetHeader</span><span class="op" id="3523179">(</span><span class="ident" id="3523180">dst</span>&nbsp;<span class="op" id="3523184">*</span><span class="ident" id="3523185">Header</span><span class="op" id="3523191">,</span>&nbsp;<span class="ident" id="3523193">src</span>&nbsp;<span class="ident" id="3523197">Header</span><span class="op" id="3523203">)</span>&nbsp;<span class="op" id="3523205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523208">if</span>&nbsp;<span class="op" id="3523211">*</span><span class="ident" id="3523212">dst</span>&nbsp;<span class="op" id="3523216">==</span>&nbsp;<span class="ident" id="3523219">nil</span>&nbsp;<span class="op" id="3523223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523227">*</span><span class="ident" id="3523228">dst</span>&nbsp;<span class="op" id="3523232">=</span>&nbsp;<span class="ident" id="3523234">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523240">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523251">for</span>&nbsp;<span class="ident" id="3523255">k</span><span class="op" id="3523256">,</span>&nbsp;<span class="ident" id="3523258">vv</span>&nbsp;<span class="op" id="3523261">:=</span>&nbsp;<span class="keyword" id="3523264">range</span>&nbsp;<span class="ident" id="3523270">src</span>&nbsp;<span class="op" id="3523274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523278">(</span><span class="op" id="3523279">*</span><span class="ident" id="3523280">dst</span><span class="op" id="3523283">)</span><span class="op" id="3523284">[</span><span class="ident" id="3523285">k</span><span class="op" id="3523286">]</span>&nbsp;<span class="op" id="3523288">=</span>&nbsp;<span class="ident" id="3523290">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523294">}</span><br>
<span class="lineno"></span><span class="op" id="3523296">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="3523299">func</span>&nbsp;<span class="op" id="3523304">(</span><span class="ident" id="3523305">b</span>&nbsp;<span class="op" id="3523307">*</span><span class="ident" id="3523308">body</span><span class="op" id="3523312">)</span>&nbsp;<span class="ident" id="3523314">Close</span><span class="op" id="3523319">(</span><span class="op" id="3523320">)</span>&nbsp;<span class="builtintype" id="3523322">error</span>&nbsp;<span class="op" id="3523328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523331">b</span><span class="op" id="3523332">.</span><span class="ident" id="3523333">mu</span><span class="op" id="3523335">.</span><span class="ident" id="3523336">Lock</span><span class="op" id="3523340">(</span><span class="op" id="3523341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523344">defer</span>&nbsp;<span class="ident" id="3523350">b</span><span class="op" id="3523351">.</span><span class="ident" id="3523352">mu</span><span class="op" id="3523354">.</span><span class="ident" id="3523355">Unlock</span><span class="op" id="3523361">(</span><span class="op" id="3523362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523365">if</span>&nbsp;<span class="ident" id="3523368">b</span><span class="op" id="3523369">.</span><span class="ident" id="3523370">closed</span>&nbsp;<span class="op" id="3523377">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523381">return</span>&nbsp;<span class="ident" id="3523388">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523396">var</span>&nbsp;<span class="ident" id="3523400">err</span>&nbsp;<span class="builtintype" id="3523404">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523411">switch</span>&nbsp;<span class="op" id="3523418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523421">case</span>&nbsp;<span class="ident" id="3523426">b</span><span class="op" id="3523427">.</span><span class="ident" id="3523428">hdr</span>&nbsp;<span class="op" id="3523432">==</span>&nbsp;<span class="ident" id="3523435">nil</span>&nbsp;<span class="op" id="3523439">&amp;&amp;</span>&nbsp;<span class="ident" id="3523442">b</span><span class="op" id="3523443">.</span><span class="ident" id="3523444">closing</span><span class="op" id="3523451">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523455">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523504">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523536">default</span><span class="op" id="3523543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523547">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3523611">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523664">_</span><span class="op" id="3523665">,</span>&nbsp;<span class="ident" id="3523667">err</span>&nbsp;<span class="op" id="3523671">=</span>&nbsp;<span class="ident" id="3523673">io</span><span class="op" id="3523675">.</span><span class="ident" id="3523676">Copy</span><span class="op" id="3523680">(</span><span class="ident" id="3523681">ioutil</span><span class="op" id="3523687">.</span><span class="ident" id="3523688">Discard</span><span class="op" id="3523695">,</span>&nbsp;<span class="ident" id="3523697">bodyLocked</span><span class="op" id="3523707">{</span><span class="ident" id="3523708">b</span><span class="op" id="3523709">}</span><span class="op" id="3523710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523716">b</span><span class="op" id="3523717">.</span><span class="ident" id="3523718">closed</span>&nbsp;<span class="op" id="3523725">=</span>&nbsp;<span class="builtintype" id="3523727">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523733">return</span>&nbsp;<span class="ident" id="3523740">err</span><br>
<span class="lineno"></span><span class="op" id="3523744">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="3523747">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3523815">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3523832">type</span>&nbsp;<span class="ident" id="3523837">bodyLocked</span>&nbsp;<span class="keyword" id="3523848">struct</span>&nbsp;<span class="op" id="3523855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3523858">b</span>&nbsp;<span class="op" id="3523860">*</span><span class="ident" id="3523861">body</span><br>
<span class="lineno">715</span><span class="op" id="3523866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3523869">func</span>&nbsp;<span class="op" id="3523874">(</span><span class="ident" id="3523875">bl</span>&nbsp;<span class="ident" id="3523878">bodyLocked</span><span class="op" id="3523888">)</span>&nbsp;<span class="ident" id="3523890">Read</span><span class="op" id="3523894">(</span><span class="ident" id="3523895">p</span>&nbsp;<span class="op" id="3523897">[</span><span class="op" id="3523898">]</span><span class="builtintype" id="3523899">byte</span><span class="op" id="3523903">)</span>&nbsp;<span class="op" id="3523905">(</span><span class="ident" id="3523906">n</span>&nbsp;<span class="builtintype" id="3523908">int</span><span class="op" id="3523911">,</span>&nbsp;<span class="ident" id="3523913">err</span>&nbsp;<span class="builtintype" id="3523917">error</span><span class="op" id="3523922">)</span>&nbsp;<span class="op" id="3523924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523927">if</span>&nbsp;<span class="ident" id="3523930">bl</span><span class="op" id="3523932">.</span><span class="ident" id="3523933">b</span><span class="op" id="3523934">.</span><span class="ident" id="3523935">closed</span>&nbsp;<span class="op" id="3523942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523946">return</span>&nbsp;<span class="num" id="3523953">0</span><span class="op" id="3523954">,</span>&nbsp;<span class="ident" id="3523956">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3523979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3523982">return</span>&nbsp;<span class="ident" id="3523989">bl</span><span class="op" id="3523991">.</span><span class="ident" id="3523992">b</span><span class="op" id="3523993">.</span><span class="ident" id="3523994">readLocked</span><span class="op" id="3524004">(</span><span class="ident" id="3524005">p</span><span class="op" id="3524006">)</span><br>
<span class="lineno"></span><span class="op" id="3524008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3524011">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="3524084">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3524122">func</span>&nbsp;<span class="ident" id="3524127">parseContentLength</span><span class="op" id="3524145">(</span><span class="ident" id="3524146">cl</span>&nbsp;<span class="builtintype" id="3524149">string</span><span class="op" id="3524155">)</span>&nbsp;<span class="op" id="3524157">(</span><span class="ident" id="3524158">int64</span><span class="op" id="3524163">,</span>&nbsp;<span class="builtintype" id="3524165">error</span><span class="op" id="3524170">)</span>&nbsp;<span class="op" id="3524172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524175">cl</span>&nbsp;<span class="op" id="3524178">=</span>&nbsp;<span class="ident" id="3524180">strings</span><span class="op" id="3524187">.</span><span class="ident" id="3524188">TrimSpace</span><span class="op" id="3524197">(</span><span class="ident" id="3524198">cl</span><span class="op" id="3524200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524203">if</span>&nbsp;<span class="ident" id="3524206">cl</span>&nbsp;<span class="op" id="3524209">==</span>&nbsp;<span class="string" id="3524212">&#34;&#34;</span>&nbsp;<span class="op" id="3524215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524219">return</span>&nbsp;<span class="op" id="3524226">-</span><span class="num" id="3524227">1</span><span class="op" id="3524228">,</span>&nbsp;<span class="ident" id="3524230">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3524238">n</span><span class="op" id="3524239">,</span>&nbsp;<span class="ident" id="3524241">err</span>&nbsp;<span class="op" id="3524245">:=</span>&nbsp;<span class="ident" id="3524248">strconv</span><span class="op" id="3524255">.</span><span class="ident" id="3524256">ParseInt</span><span class="op" id="3524264">(</span><span class="ident" id="3524265">cl</span><span class="op" id="3524267">,</span>&nbsp;<span class="num" id="3524269">10</span><span class="op" id="3524271">,</span>&nbsp;<span class="num" id="3524273">64</span><span class="op" id="3524275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524278">if</span>&nbsp;<span class="ident" id="3524281">err</span>&nbsp;<span class="op" id="3524285">!=</span>&nbsp;<span class="ident" id="3524288">nil</span>&nbsp;<span class="op" id="3524292">||</span>&nbsp;<span class="ident" id="3524295">n</span>&nbsp;<span class="op" id="3524297">&lt;</span>&nbsp;<span class="num" id="3524299">0</span>&nbsp;<span class="op" id="3524301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524305">return</span>&nbsp;<span class="num" id="3524312">0</span><span class="op" id="3524313">,</span>&nbsp;<span class="op" id="3524315">&amp;</span><span class="ident" id="3524316">badStringError</span><span class="op" id="3524330">{</span><span class="string" id="3524331">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="3524351">,</span>&nbsp;<span class="ident" id="3524353">cl</span><span class="op" id="3524355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3524358">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3524361">return</span>&nbsp;<span class="ident" id="3524368">n</span><span class="op" id="3524369">,</span>&nbsp;<span class="ident" id="3524371">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3524376">}</span>
</div>
</body>
</html>
