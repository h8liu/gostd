<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7450099">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7450154">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7450208">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7450259">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7450292">package</span>&nbsp;<span class="ident" id="7450300">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7450308">import</span>&nbsp;<span class="op" id="7450315">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450318">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450327">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450334">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450340">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450353">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450360">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450367">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450373">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450381">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7450392">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7450399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7450402">func</span>&nbsp;<span class="ident" id="7450407">runPktSyslog</span><span class="op" id="7450419">(</span><span class="ident" id="7450420">c</span>&nbsp;<span class="ident" id="7450422">net</span><span class="op" id="7450425">.</span><span class="ident" id="7450426">PacketConn</span><span class="op" id="7450436">,</span>&nbsp;<span class="ident" id="7450438">done</span>&nbsp;<span class="keyword" id="7450443">chan</span><span class="op" id="7450447">&lt;-</span>&nbsp;<span class="builtintype" id="7450450">string</span><span class="op" id="7450456">)</span>&nbsp;<span class="op" id="7450458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450461">var</span>&nbsp;<span class="ident" id="7450465">buf</span>&nbsp;<span class="op" id="7450469">[</span><span class="num" id="7450470">4096</span><span class="op" id="7450474">]</span><span class="builtintype" id="7450475">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450481">var</span>&nbsp;<span class="ident" id="7450485">rcvd</span>&nbsp;<span class="builtintype" id="7450490">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450498">ct</span>&nbsp;<span class="op" id="7450501">:=</span>&nbsp;<span class="num" id="7450504">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450507">for</span>&nbsp;<span class="op" id="7450511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450515">var</span>&nbsp;<span class="ident" id="7450519">n</span>&nbsp;<span class="builtintype" id="7450521">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450527">var</span>&nbsp;<span class="ident" id="7450531">err</span>&nbsp;<span class="builtintype" id="7450535">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450544">c</span><span class="op" id="7450545">.</span><span class="ident" id="7450546">SetReadDeadline</span><span class="op" id="7450561">(</span><span class="ident" id="7450562">time</span><span class="op" id="7450566">.</span><span class="ident" id="7450567">Now</span><span class="op" id="7450570">(</span><span class="op" id="7450571">)</span><span class="op" id="7450572">.</span><span class="ident" id="7450573">Add</span><span class="op" id="7450576">(</span><span class="num" id="7450577">100</span>&nbsp;<span class="op" id="7450581">*</span>&nbsp;<span class="ident" id="7450583">time</span><span class="op" id="7450587">.</span><span class="ident" id="7450588">Millisecond</span><span class="op" id="7450599">)</span><span class="op" id="7450600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450604">n</span><span class="op" id="7450605">,</span>&nbsp;<span class="ident" id="7450607">_</span><span class="op" id="7450608">,</span>&nbsp;<span class="ident" id="7450610">err</span>&nbsp;<span class="op" id="7450614">=</span>&nbsp;<span class="ident" id="7450616">c</span><span class="op" id="7450617">.</span><span class="ident" id="7450618">ReadFrom</span><span class="op" id="7450626">(</span><span class="ident" id="7450627">buf</span><span class="op" id="7450630">[</span><span class="op" id="7450631">:</span><span class="op" id="7450632">]</span><span class="op" id="7450633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450637">rcvd</span>&nbsp;<span class="op" id="7450642">+=</span>&nbsp;<span class="builtintype" id="7450645">string</span><span class="op" id="7450651">(</span><span class="ident" id="7450652">buf</span><span class="op" id="7450655">[</span><span class="op" id="7450656">:</span><span class="ident" id="7450657">n</span><span class="op" id="7450658">]</span><span class="op" id="7450659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450663">if</span>&nbsp;<span class="ident" id="7450666">err</span>&nbsp;<span class="op" id="7450670">!=</span>&nbsp;<span class="ident" id="7450673">nil</span>&nbsp;<span class="op" id="7450677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450682">if</span>&nbsp;<span class="ident" id="7450685">oe</span><span class="op" id="7450687">,</span>&nbsp;<span class="ident" id="7450689">ok</span>&nbsp;<span class="op" id="7450692">:=</span>&nbsp;<span class="ident" id="7450695">err</span><span class="op" id="7450698">.</span><span class="op" id="7450699">(</span><span class="op" id="7450700">*</span><span class="ident" id="7450701">net</span><span class="op" id="7450704">.</span><span class="ident" id="7450705">OpError</span><span class="op" id="7450712">)</span><span class="op" id="7450713">;</span>&nbsp;<span class="ident" id="7450715">ok</span>&nbsp;<span class="op" id="7450718">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450724">if</span>&nbsp;<span class="ident" id="7450727">ct</span>&nbsp;<span class="op" id="7450730">&lt;</span>&nbsp;<span class="num" id="7450732">3</span>&nbsp;<span class="op" id="7450734">&amp;&amp;</span>&nbsp;<span class="ident" id="7450737">oe</span><span class="op" id="7450739">.</span><span class="ident" id="7450740">Temporary</span><span class="op" id="7450749">(</span><span class="op" id="7450750">)</span>&nbsp;<span class="op" id="7450752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450759">ct</span><span class="op" id="7450761">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450769">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7450782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7450787">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450792">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7450800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7450803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450806">c</span><span class="op" id="7450807">.</span><span class="ident" id="7450808">Close</span><span class="op" id="7450813">(</span><span class="op" id="7450814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7450817">done</span>&nbsp;<span class="op" id="7450822">&lt;-</span>&nbsp;<span class="ident" id="7450825">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7450830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7450833">var</span>&nbsp;<span class="ident" id="7450837">crashy</span>&nbsp;<span class="op" id="7450844">=</span>&nbsp;<span class="builtintype" id="7450846">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7450853">func</span>&nbsp;<span class="ident" id="7450858">runStreamSyslog</span><span class="op" id="7450873">(</span><span class="ident" id="7450874">l</span>&nbsp;<span class="ident" id="7450876">net</span><span class="op" id="7450879">.</span><span class="ident" id="7450880">Listener</span><span class="op" id="7450888">,</span>&nbsp;<span class="ident" id="7450890">done</span>&nbsp;<span class="keyword" id="7450895">chan</span><span class="op" id="7450899">&lt;-</span>&nbsp;<span class="builtintype" id="7450902">string</span><span class="op" id="7450908">,</span>&nbsp;<span class="ident" id="7450910">wg</span>&nbsp;<span class="op" id="7450913">*</span><span class="ident" id="7450914">sync</span><span class="op" id="7450918">.</span><span class="ident" id="7450919">WaitGroup</span><span class="op" id="7450928">)</span>&nbsp;<span class="op" id="7450930">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450933">for</span>&nbsp;<span class="op" id="7450937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450941">var</span>&nbsp;<span class="ident" id="7450945">c</span>&nbsp;<span class="ident" id="7450947">net</span><span class="op" id="7450950">.</span><span class="ident" id="7450951">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450958">var</span>&nbsp;<span class="ident" id="7450962">err</span>&nbsp;<span class="builtintype" id="7450966">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7450974">if</span>&nbsp;<span class="ident" id="7450977">c</span><span class="op" id="7450978">,</span>&nbsp;<span class="ident" id="7450980">err</span>&nbsp;<span class="op" id="7450984">=</span>&nbsp;<span class="ident" id="7450986">l</span><span class="op" id="7450987">.</span><span class="ident" id="7450988">Accept</span><span class="op" id="7450994">(</span><span class="op" id="7450995">)</span><span class="op" id="7450996">;</span>&nbsp;<span class="ident" id="7450998">err</span>&nbsp;<span class="op" id="7451002">!=</span>&nbsp;<span class="ident" id="7451005">nil</span>&nbsp;<span class="op" id="7451009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451014">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451027">wg</span><span class="op" id="7451029">.</span><span class="ident" id="7451030">Add</span><span class="op" id="7451033">(</span><span class="num" id="7451034">1</span><span class="op" id="7451035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451039">go</span>&nbsp;<span class="keyword" id="7451042">func</span><span class="op" id="7451046">(</span><span class="ident" id="7451047">c</span>&nbsp;<span class="ident" id="7451049">net</span><span class="op" id="7451052">.</span><span class="ident" id="7451053">Conn</span><span class="op" id="7451057">)</span>&nbsp;<span class="op" id="7451059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451064">defer</span>&nbsp;<span class="ident" id="7451070">wg</span><span class="op" id="7451072">.</span><span class="ident" id="7451073">Done</span><span class="op" id="7451077">(</span><span class="op" id="7451078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451083">c</span><span class="op" id="7451084">.</span><span class="ident" id="7451085">SetReadDeadline</span><span class="op" id="7451100">(</span><span class="ident" id="7451101">time</span><span class="op" id="7451105">.</span><span class="ident" id="7451106">Now</span><span class="op" id="7451109">(</span><span class="op" id="7451110">)</span><span class="op" id="7451111">.</span><span class="ident" id="7451112">Add</span><span class="op" id="7451115">(</span><span class="num" id="7451116">5</span>&nbsp;<span class="op" id="7451118">*</span>&nbsp;<span class="ident" id="7451120">time</span><span class="op" id="7451124">.</span><span class="ident" id="7451125">Second</span><span class="op" id="7451131">)</span><span class="op" id="7451132">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451137">b</span>&nbsp;<span class="op" id="7451139">:=</span>&nbsp;<span class="ident" id="7451142">bufio</span><span class="op" id="7451147">.</span><span class="ident" id="7451148">NewReader</span><span class="op" id="7451157">(</span><span class="ident" id="7451158">c</span><span class="op" id="7451159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451164">for</span>&nbsp;<span class="ident" id="7451168">ct</span>&nbsp;<span class="op" id="7451171">:=</span>&nbsp;<span class="num" id="7451174">1</span><span class="op" id="7451175">;</span>&nbsp;<span class="op" id="7451177">!</span><span class="ident" id="7451178">crashy</span>&nbsp;<span class="op" id="7451185">||</span>&nbsp;<span class="ident" id="7451188">ct</span><span class="op" id="7451190">&amp;</span><span class="num" id="7451191">7</span>&nbsp;<span class="op" id="7451193">!=</span>&nbsp;<span class="num" id="7451196">0</span><span class="op" id="7451197">;</span>&nbsp;<span class="ident" id="7451199">ct</span><span class="op" id="7451201">++</span>&nbsp;<span class="op" id="7451204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451210">s</span><span class="op" id="7451211">,</span>&nbsp;<span class="ident" id="7451213">err</span>&nbsp;<span class="op" id="7451217">:=</span>&nbsp;<span class="ident" id="7451220">b</span><span class="op" id="7451221">.</span><span class="ident" id="7451222">ReadString</span><span class="op" id="7451232">(</span><span class="string" id="7451233">&#39;\n&#39;</span><span class="op" id="7451237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451243">if</span>&nbsp;<span class="ident" id="7451246">err</span>&nbsp;<span class="op" id="7451250">!=</span>&nbsp;<span class="ident" id="7451253">nil</span>&nbsp;<span class="op" id="7451257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451264">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451280">done</span>&nbsp;<span class="op" id="7451285">&lt;-</span>&nbsp;<span class="ident" id="7451288">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451298">c</span><span class="op" id="7451299">.</span><span class="ident" id="7451300">Close</span><span class="op" id="7451305">(</span><span class="op" id="7451306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451310">}</span><span class="op" id="7451311">(</span><span class="ident" id="7451312">c</span><span class="op" id="7451313">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451316">}</span><br>
<span class="lineno"></span><span class="op" id="7451318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7451321">func</span>&nbsp;<span class="ident" id="7451326">startServer</span><span class="op" id="7451337">(</span><span class="ident" id="7451338">n</span><span class="op" id="7451339">,</span>&nbsp;<span class="ident" id="7451341">la</span>&nbsp;<span class="builtintype" id="7451344">string</span><span class="op" id="7451350">,</span>&nbsp;<span class="ident" id="7451352">done</span>&nbsp;<span class="keyword" id="7451357">chan</span><span class="op" id="7451361">&lt;-</span>&nbsp;<span class="builtintype" id="7451364">string</span><span class="op" id="7451370">)</span>&nbsp;<span class="op" id="7451372">(</span><span class="ident" id="7451373">addr</span>&nbsp;<span class="builtintype" id="7451378">string</span><span class="op" id="7451384">,</span>&nbsp;<span class="ident" id="7451386">sock</span>&nbsp;<span class="ident" id="7451391">io</span><span class="op" id="7451393">.</span><span class="ident" id="7451394">Closer</span><span class="op" id="7451400">,</span>&nbsp;<span class="ident" id="7451402">wg</span>&nbsp;<span class="op" id="7451405">*</span><span class="ident" id="7451406">sync</span><span class="op" id="7451410">.</span><span class="ident" id="7451411">WaitGroup</span><span class="op" id="7451420">)</span>&nbsp;<span class="op" id="7451422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451425">if</span>&nbsp;<span class="ident" id="7451428">n</span>&nbsp;<span class="op" id="7451430">==</span>&nbsp;<span class="string" id="7451433">&#34;udp&#34;</span>&nbsp;<span class="op" id="7451439">||</span>&nbsp;<span class="ident" id="7451442">n</span>&nbsp;<span class="op" id="7451444">==</span>&nbsp;<span class="string" id="7451447">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7451453">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451457">la</span>&nbsp;<span class="op" id="7451460">=</span>&nbsp;<span class="string" id="7451462">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451477">}</span>&nbsp;<span class="keyword" id="7451479">else</span>&nbsp;<span class="op" id="7451484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7451488">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451544">if</span>&nbsp;<span class="ident" id="7451547">la</span>&nbsp;<span class="op" id="7451550">==</span>&nbsp;<span class="string" id="7451553">&#34;&#34;</span>&nbsp;<span class="op" id="7451556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7451561">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451616">f</span><span class="op" id="7451617">,</span>&nbsp;<span class="ident" id="7451619">err</span>&nbsp;<span class="op" id="7451623">:=</span>&nbsp;<span class="ident" id="7451626">ioutil</span><span class="op" id="7451632">.</span><span class="ident" id="7451633">TempFile</span><span class="op" id="7451641">(</span><span class="string" id="7451642">&#34;&#34;</span><span class="op" id="7451644">,</span>&nbsp;<span class="string" id="7451646">&#34;syslogtest&#34;</span><span class="op" id="7451658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451663">if</span>&nbsp;<span class="ident" id="7451666">err</span>&nbsp;<span class="op" id="7451670">!=</span>&nbsp;<span class="ident" id="7451673">nil</span>&nbsp;<span class="op" id="7451677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451683">log</span><span class="op" id="7451686">.</span><span class="ident" id="7451687">Fatal</span><span class="op" id="7451692">(</span><span class="string" id="7451693">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7451705">,</span>&nbsp;<span class="ident" id="7451707">err</span><span class="op" id="7451710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451720">f</span><span class="op" id="7451721">.</span><span class="ident" id="7451722">Close</span><span class="op" id="7451727">(</span><span class="op" id="7451728">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451733">la</span>&nbsp;<span class="op" id="7451736">=</span>&nbsp;<span class="ident" id="7451738">f</span><span class="op" id="7451739">.</span><span class="ident" id="7451740">Name</span><span class="op" id="7451744">(</span><span class="op" id="7451745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451753">os</span><span class="op" id="7451755">.</span><span class="ident" id="7451756">Remove</span><span class="op" id="7451762">(</span><span class="ident" id="7451763">la</span><span class="op" id="7451765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451772">wg</span>&nbsp;<span class="op" id="7451775">=</span>&nbsp;<span class="builtinfunc" id="7451777">new</span><span class="op" id="7451780">(</span><span class="ident" id="7451781">sync</span><span class="op" id="7451785">.</span><span class="ident" id="7451786">WaitGroup</span><span class="op" id="7451795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451798">if</span>&nbsp;<span class="ident" id="7451801">n</span>&nbsp;<span class="op" id="7451803">==</span>&nbsp;<span class="string" id="7451806">&#34;udp&#34;</span>&nbsp;<span class="op" id="7451812">||</span>&nbsp;<span class="ident" id="7451815">n</span>&nbsp;<span class="op" id="7451817">==</span>&nbsp;<span class="string" id="7451820">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7451831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451835">l</span><span class="op" id="7451836">,</span>&nbsp;<span class="ident" id="7451838">e</span>&nbsp;<span class="op" id="7451840">:=</span>&nbsp;<span class="ident" id="7451843">net</span><span class="op" id="7451846">.</span><span class="ident" id="7451847">ListenPacket</span><span class="op" id="7451859">(</span><span class="ident" id="7451860">n</span><span class="op" id="7451861">,</span>&nbsp;<span class="ident" id="7451863">la</span><span class="op" id="7451865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451869">if</span>&nbsp;<span class="ident" id="7451872">e</span>&nbsp;<span class="op" id="7451874">!=</span>&nbsp;<span class="ident" id="7451877">nil</span>&nbsp;<span class="op" id="7451881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451886">log</span><span class="op" id="7451889">.</span><span class="ident" id="7451890">Fatalf</span><span class="op" id="7451896">(</span><span class="string" id="7451897">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7451921">,</span>&nbsp;<span class="ident" id="7451923">e</span><span class="op" id="7451924">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7451928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451932">addr</span>&nbsp;<span class="op" id="7451937">=</span>&nbsp;<span class="ident" id="7451939">l</span><span class="op" id="7451940">.</span><span class="ident" id="7451941">LocalAddr</span><span class="op" id="7451950">(</span><span class="op" id="7451951">)</span><span class="op" id="7451952">.</span><span class="ident" id="7451953">String</span><span class="op" id="7451959">(</span><span class="op" id="7451960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451964">sock</span>&nbsp;<span class="op" id="7451969">=</span>&nbsp;<span class="ident" id="7451971">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7451975">wg</span><span class="op" id="7451977">.</span><span class="ident" id="7451978">Add</span><span class="op" id="7451981">(</span><span class="num" id="7451982">1</span><span class="op" id="7451983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7451987">go</span>&nbsp;<span class="keyword" id="7451990">func</span><span class="op" id="7451994">(</span><span class="op" id="7451995">)</span>&nbsp;<span class="op" id="7451997">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452002">defer</span>&nbsp;<span class="ident" id="7452008">wg</span><span class="op" id="7452010">.</span><span class="ident" id="7452011">Done</span><span class="op" id="7452015">(</span><span class="op" id="7452016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452021">runPktSyslog</span><span class="op" id="7452033">(</span><span class="ident" id="7452034">l</span><span class="op" id="7452035">,</span>&nbsp;<span class="ident" id="7452037">done</span><span class="op" id="7452041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452045">}</span><span class="op" id="7452046">(</span><span class="op" id="7452047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452050">}</span>&nbsp;<span class="keyword" id="7452052">else</span>&nbsp;<span class="op" id="7452057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452061">l</span><span class="op" id="7452062">,</span>&nbsp;<span class="ident" id="7452064">e</span>&nbsp;<span class="op" id="7452066">:=</span>&nbsp;<span class="ident" id="7452069">net</span><span class="op" id="7452072">.</span><span class="ident" id="7452073">Listen</span><span class="op" id="7452079">(</span><span class="ident" id="7452080">n</span><span class="op" id="7452081">,</span>&nbsp;<span class="ident" id="7452083">la</span><span class="op" id="7452085">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452089">if</span>&nbsp;<span class="ident" id="7452092">e</span>&nbsp;<span class="op" id="7452094">!=</span>&nbsp;<span class="ident" id="7452097">nil</span>&nbsp;<span class="op" id="7452101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452106">log</span><span class="op" id="7452109">.</span><span class="ident" id="7452110">Fatalf</span><span class="op" id="7452116">(</span><span class="string" id="7452117">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7452141">,</span>&nbsp;<span class="ident" id="7452143">e</span><span class="op" id="7452144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452152">addr</span>&nbsp;<span class="op" id="7452157">=</span>&nbsp;<span class="ident" id="7452159">l</span><span class="op" id="7452160">.</span><span class="ident" id="7452161">Addr</span><span class="op" id="7452165">(</span><span class="op" id="7452166">)</span><span class="op" id="7452167">.</span><span class="ident" id="7452168">String</span><span class="op" id="7452174">(</span><span class="op" id="7452175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452179">sock</span>&nbsp;<span class="op" id="7452184">=</span>&nbsp;<span class="ident" id="7452186">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452190">wg</span><span class="op" id="7452192">.</span><span class="ident" id="7452193">Add</span><span class="op" id="7452196">(</span><span class="num" id="7452197">1</span><span class="op" id="7452198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452202">go</span>&nbsp;<span class="keyword" id="7452205">func</span><span class="op" id="7452209">(</span><span class="op" id="7452210">)</span>&nbsp;<span class="op" id="7452212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452217">defer</span>&nbsp;<span class="ident" id="7452223">wg</span><span class="op" id="7452225">.</span><span class="ident" id="7452226">Done</span><span class="op" id="7452230">(</span><span class="op" id="7452231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452236">runStreamSyslog</span><span class="op" id="7452251">(</span><span class="ident" id="7452252">l</span><span class="op" id="7452253">,</span>&nbsp;<span class="ident" id="7452255">done</span><span class="op" id="7452259">,</span>&nbsp;<span class="ident" id="7452261">wg</span><span class="op" id="7452263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452267">}</span><span class="op" id="7452268">(</span><span class="op" id="7452269">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452275">return</span><br>
<span class="lineno"></span><span class="op" id="7452282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7452285">func</span>&nbsp;<span class="ident" id="7452290">TestWithSimulated</span><span class="op" id="7452307">(</span><span class="ident" id="7452308">t</span>&nbsp;<span class="op" id="7452310">*</span><span class="ident" id="7452311">testing</span><span class="op" id="7452318">.</span><span class="ident" id="7452319">T</span><span class="op" id="7452320">)</span>&nbsp;<span class="op" id="7452322">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452325">msg</span>&nbsp;<span class="op" id="7452329">:=</span>&nbsp;<span class="string" id="7452332">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452344">transport</span>&nbsp;<span class="op" id="7452354">:=</span>&nbsp;<span class="op" id="7452357">[</span><span class="op" id="7452358">]</span><span class="builtintype" id="7452359">string</span><span class="op" id="7452365">{</span><span class="string" id="7452366">&#34;unix&#34;</span><span class="op" id="7452372">,</span>&nbsp;<span class="string" id="7452374">&#34;unixgram&#34;</span><span class="op" id="7452384">,</span>&nbsp;<span class="string" id="7452386">&#34;udp&#34;</span><span class="op" id="7452391">,</span>&nbsp;<span class="string" id="7452393">&#34;tcp&#34;</span><span class="op" id="7452398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452402">for</span>&nbsp;<span class="ident" id="7452406">_</span><span class="op" id="7452407">,</span>&nbsp;<span class="ident" id="7452409">tr</span>&nbsp;<span class="op" id="7452412">:=</span>&nbsp;<span class="keyword" id="7452415">range</span>&nbsp;<span class="ident" id="7452421">transport</span>&nbsp;<span class="op" id="7452431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452435">done</span>&nbsp;<span class="op" id="7452440">:=</span>&nbsp;<span class="builtinfunc" id="7452443">make</span><span class="op" id="7452447">(</span><span class="keyword" id="7452448">chan</span>&nbsp;<span class="builtintype" id="7452453">string</span><span class="op" id="7452459">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452463">addr</span><span class="op" id="7452467">,</span>&nbsp;<span class="ident" id="7452469">sock</span><span class="op" id="7452473">,</span>&nbsp;<span class="ident" id="7452475">srvWG</span>&nbsp;<span class="op" id="7452481">:=</span>&nbsp;<span class="ident" id="7452484">startServer</span><span class="op" id="7452495">(</span><span class="ident" id="7452496">tr</span><span class="op" id="7452498">,</span>&nbsp;<span class="string" id="7452500">&#34;&#34;</span><span class="op" id="7452502">,</span>&nbsp;<span class="ident" id="7452504">done</span><span class="op" id="7452508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452512">defer</span>&nbsp;<span class="ident" id="7452518">srvWG</span><span class="op" id="7452523">.</span><span class="ident" id="7452524">Wait</span><span class="op" id="7452528">(</span><span class="op" id="7452529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452533">defer</span>&nbsp;<span class="ident" id="7452539">sock</span><span class="op" id="7452543">.</span><span class="ident" id="7452544">Close</span><span class="op" id="7452549">(</span><span class="op" id="7452550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452554">if</span>&nbsp;<span class="ident" id="7452557">tr</span>&nbsp;<span class="op" id="7452560">==</span>&nbsp;<span class="string" id="7452563">&#34;unix&#34;</span>&nbsp;<span class="op" id="7452570">||</span>&nbsp;<span class="ident" id="7452573">tr</span>&nbsp;<span class="op" id="7452576">==</span>&nbsp;<span class="string" id="7452579">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7452590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452595">defer</span>&nbsp;<span class="ident" id="7452601">os</span><span class="op" id="7452603">.</span><span class="ident" id="7452604">Remove</span><span class="op" id="7452610">(</span><span class="ident" id="7452611">addr</span><span class="op" id="7452615">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452623">s</span><span class="op" id="7452624">,</span>&nbsp;<span class="ident" id="7452626">err</span>&nbsp;<span class="op" id="7452630">:=</span>&nbsp;<span class="ident" id="7452633">Dial</span><span class="op" id="7452637">(</span><span class="ident" id="7452638">tr</span><span class="op" id="7452640">,</span>&nbsp;<span class="ident" id="7452642">addr</span><span class="op" id="7452646">,</span>&nbsp;<span class="ident" id="7452648">LOG_INFO</span><span class="op" id="7452656">|</span><span class="ident" id="7452657">LOG_USER</span><span class="op" id="7452665">,</span>&nbsp;<span class="string" id="7452667">&#34;syslog_test&#34;</span><span class="op" id="7452680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452684">if</span>&nbsp;<span class="ident" id="7452687">err</span>&nbsp;<span class="op" id="7452691">!=</span>&nbsp;<span class="ident" id="7452694">nil</span>&nbsp;<span class="op" id="7452698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452703">t</span><span class="op" id="7452704">.</span><span class="ident" id="7452705">Fatalf</span><span class="op" id="7452711">(</span><span class="string" id="7452712">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7452731">,</span>&nbsp;<span class="ident" id="7452733">err</span><span class="op" id="7452736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452740">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452744">err</span>&nbsp;<span class="op" id="7452748">=</span>&nbsp;<span class="ident" id="7452750">s</span><span class="op" id="7452751">.</span><span class="ident" id="7452752">Info</span><span class="op" id="7452756">(</span><span class="ident" id="7452757">msg</span><span class="op" id="7452760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452764">if</span>&nbsp;<span class="ident" id="7452767">err</span>&nbsp;<span class="op" id="7452771">!=</span>&nbsp;<span class="ident" id="7452774">nil</span>&nbsp;<span class="op" id="7452778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452783">t</span><span class="op" id="7452784">.</span><span class="ident" id="7452785">Fatalf</span><span class="op" id="7452791">(</span><span class="string" id="7452792">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7452808">,</span>&nbsp;<span class="ident" id="7452810">err</span><span class="op" id="7452813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452821">check</span><span class="op" id="7452826">(</span><span class="ident" id="7452827">t</span><span class="op" id="7452828">,</span>&nbsp;<span class="ident" id="7452830">msg</span><span class="op" id="7452833">,</span>&nbsp;<span class="op" id="7452835">&lt;-</span><span class="ident" id="7452837">done</span><span class="op" id="7452841">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452845">s</span><span class="op" id="7452846">.</span><span class="ident" id="7452847">Close</span><span class="op" id="7452852">(</span><span class="op" id="7452853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7452856">}</span><br>
<span class="lineno"></span><span class="op" id="7452858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7452861">func</span>&nbsp;<span class="ident" id="7452866">TestFlap</span><span class="op" id="7452874">(</span><span class="ident" id="7452875">t</span>&nbsp;<span class="op" id="7452877">*</span><span class="ident" id="7452878">testing</span><span class="op" id="7452885">.</span><span class="ident" id="7452886">T</span><span class="op" id="7452887">)</span>&nbsp;<span class="op" id="7452889">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452892">net</span>&nbsp;<span class="op" id="7452896">:=</span>&nbsp;<span class="string" id="7452899">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452907">done</span>&nbsp;<span class="op" id="7452912">:=</span>&nbsp;<span class="builtinfunc" id="7452915">make</span><span class="op" id="7452919">(</span><span class="keyword" id="7452920">chan</span>&nbsp;<span class="builtintype" id="7452925">string</span><span class="op" id="7452931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7452934">addr</span><span class="op" id="7452938">,</span>&nbsp;<span class="ident" id="7452940">sock</span><span class="op" id="7452944">,</span>&nbsp;<span class="ident" id="7452946">srvWG</span>&nbsp;<span class="op" id="7452952">:=</span>&nbsp;<span class="ident" id="7452955">startServer</span><span class="op" id="7452966">(</span><span class="ident" id="7452967">net</span><span class="op" id="7452970">,</span>&nbsp;<span class="string" id="7452972">&#34;&#34;</span><span class="op" id="7452974">,</span>&nbsp;<span class="ident" id="7452976">done</span><span class="op" id="7452980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7452983">defer</span>&nbsp;<span class="ident" id="7452989">srvWG</span><span class="op" id="7452994">.</span><span class="ident" id="7452995">Wait</span><span class="op" id="7452999">(</span><span class="op" id="7453000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453003">defer</span>&nbsp;<span class="ident" id="7453009">os</span><span class="op" id="7453011">.</span><span class="ident" id="7453012">Remove</span><span class="op" id="7453018">(</span><span class="ident" id="7453019">addr</span><span class="op" id="7453023">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453026">defer</span>&nbsp;<span class="ident" id="7453032">sock</span><span class="op" id="7453036">.</span><span class="ident" id="7453037">Close</span><span class="op" id="7453042">(</span><span class="op" id="7453043">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453047">s</span><span class="op" id="7453048">,</span>&nbsp;<span class="ident" id="7453050">err</span>&nbsp;<span class="op" id="7453054">:=</span>&nbsp;<span class="ident" id="7453057">Dial</span><span class="op" id="7453061">(</span><span class="ident" id="7453062">net</span><span class="op" id="7453065">,</span>&nbsp;<span class="ident" id="7453067">addr</span><span class="op" id="7453071">,</span>&nbsp;<span class="ident" id="7453073">LOG_INFO</span><span class="op" id="7453081">|</span><span class="ident" id="7453082">LOG_USER</span><span class="op" id="7453090">,</span>&nbsp;<span class="string" id="7453092">&#34;syslog_test&#34;</span><span class="op" id="7453105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453108">if</span>&nbsp;<span class="ident" id="7453111">err</span>&nbsp;<span class="op" id="7453115">!=</span>&nbsp;<span class="ident" id="7453118">nil</span>&nbsp;<span class="op" id="7453122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453126">t</span><span class="op" id="7453127">.</span><span class="ident" id="7453128">Fatalf</span><span class="op" id="7453134">(</span><span class="string" id="7453135">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7453154">,</span>&nbsp;<span class="ident" id="7453156">err</span><span class="op" id="7453159">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453165">msg</span>&nbsp;<span class="op" id="7453169">:=</span>&nbsp;<span class="string" id="7453172">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453181">err</span>&nbsp;<span class="op" id="7453185">=</span>&nbsp;<span class="ident" id="7453187">s</span><span class="op" id="7453188">.</span><span class="ident" id="7453189">Info</span><span class="op" id="7453193">(</span><span class="ident" id="7453194">msg</span><span class="op" id="7453197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453200">if</span>&nbsp;<span class="ident" id="7453203">err</span>&nbsp;<span class="op" id="7453207">!=</span>&nbsp;<span class="ident" id="7453210">nil</span>&nbsp;<span class="op" id="7453214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453218">t</span><span class="op" id="7453219">.</span><span class="ident" id="7453220">Fatalf</span><span class="op" id="7453226">(</span><span class="string" id="7453227">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7453243">,</span>&nbsp;<span class="ident" id="7453245">err</span><span class="op" id="7453248">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453254">check</span><span class="op" id="7453259">(</span><span class="ident" id="7453260">t</span><span class="op" id="7453261">,</span>&nbsp;<span class="ident" id="7453263">msg</span><span class="op" id="7453266">,</span>&nbsp;<span class="op" id="7453268">&lt;-</span><span class="ident" id="7453270">done</span><span class="op" id="7453274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7453278">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453301">_</span><span class="op" id="7453302">,</span>&nbsp;<span class="ident" id="7453304">sock2</span><span class="op" id="7453309">,</span>&nbsp;<span class="ident" id="7453311">srvWG2</span>&nbsp;<span class="op" id="7453318">:=</span>&nbsp;<span class="ident" id="7453321">startServer</span><span class="op" id="7453332">(</span><span class="ident" id="7453333">net</span><span class="op" id="7453336">,</span>&nbsp;<span class="ident" id="7453338">addr</span><span class="op" id="7453342">,</span>&nbsp;<span class="ident" id="7453344">done</span><span class="op" id="7453348">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453351">defer</span>&nbsp;<span class="ident" id="7453357">srvWG2</span><span class="op" id="7453363">.</span><span class="ident" id="7453364">Wait</span><span class="op" id="7453368">(</span><span class="op" id="7453369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453372">defer</span>&nbsp;<span class="ident" id="7453378">sock2</span><span class="op" id="7453383">.</span><span class="ident" id="7453384">Close</span><span class="op" id="7453389">(</span><span class="op" id="7453390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7453394">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453421">msg</span>&nbsp;<span class="op" id="7453425">=</span>&nbsp;<span class="string" id="7453427">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453436">err</span>&nbsp;<span class="op" id="7453440">=</span>&nbsp;<span class="ident" id="7453442">s</span><span class="op" id="7453443">.</span><span class="ident" id="7453444">Info</span><span class="op" id="7453448">(</span><span class="ident" id="7453449">msg</span><span class="op" id="7453452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453455">if</span>&nbsp;<span class="ident" id="7453458">err</span>&nbsp;<span class="op" id="7453462">!=</span>&nbsp;<span class="ident" id="7453465">nil</span>&nbsp;<span class="op" id="7453469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453473">t</span><span class="op" id="7453474">.</span><span class="ident" id="7453475">Fatalf</span><span class="op" id="7453481">(</span><span class="string" id="7453482">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7453498">,</span>&nbsp;<span class="ident" id="7453500">err</span><span class="op" id="7453503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453509">check</span><span class="op" id="7453514">(</span><span class="ident" id="7453515">t</span><span class="op" id="7453516">,</span>&nbsp;<span class="ident" id="7453518">msg</span><span class="op" id="7453521">,</span>&nbsp;<span class="op" id="7453523">&lt;-</span><span class="ident" id="7453525">done</span><span class="op" id="7453529">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453533">s</span><span class="op" id="7453534">.</span><span class="ident" id="7453535">Close</span><span class="op" id="7453540">(</span><span class="op" id="7453541">)</span><br>
<span class="lineno"></span><span class="op" id="7453543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7453546">func</span>&nbsp;<span class="ident" id="7453551">TestNew</span><span class="op" id="7453558">(</span><span class="ident" id="7453559">t</span>&nbsp;<span class="op" id="7453561">*</span><span class="ident" id="7453562">testing</span><span class="op" id="7453569">.</span><span class="ident" id="7453570">T</span><span class="op" id="7453571">)</span>&nbsp;<span class="op" id="7453573">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453576">if</span>&nbsp;<span class="ident" id="7453579">LOG_LOCAL7</span>&nbsp;<span class="op" id="7453590">!=</span>&nbsp;<span class="num" id="7453593">23</span><span class="op" id="7453595">&lt;&lt;</span><span class="num" id="7453597">3</span>&nbsp;<span class="op" id="7453599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453603">t</span><span class="op" id="7453604">.</span><span class="ident" id="7453605">Fatalf</span><span class="op" id="7453611">(</span><span class="string" id="7453612">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7453640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453646">if</span>&nbsp;<span class="ident" id="7453649">testing</span><span class="op" id="7453656">.</span><span class="ident" id="7453657">Short</span><span class="op" id="7453662">(</span><span class="op" id="7453663">)</span>&nbsp;<span class="op" id="7453665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7453669">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453732">t</span><span class="op" id="7453733">.</span><span class="ident" id="7453734">Skip</span><span class="op" id="7453738">(</span><span class="string" id="7453739">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7453775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453782">s</span><span class="op" id="7453783">,</span>&nbsp;<span class="ident" id="7453785">err</span>&nbsp;<span class="op" id="7453789">:=</span>&nbsp;<span class="ident" id="7453792">New</span><span class="op" id="7453795">(</span><span class="ident" id="7453796">LOG_INFO</span><span class="op" id="7453804">|</span><span class="ident" id="7453805">LOG_USER</span><span class="op" id="7453813">,</span>&nbsp;<span class="string" id="7453815">&#34;the_tag&#34;</span><span class="op" id="7453824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453827">if</span>&nbsp;<span class="ident" id="7453830">err</span>&nbsp;<span class="op" id="7453834">!=</span>&nbsp;<span class="ident" id="7453837">nil</span>&nbsp;<span class="op" id="7453841">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453845">t</span><span class="op" id="7453846">.</span><span class="ident" id="7453847">Fatalf</span><span class="op" id="7453853">(</span><span class="string" id="7453854">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7453872">,</span>&nbsp;<span class="ident" id="7453874">err</span><span class="op" id="7453877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7453880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7453883">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453912">s</span><span class="op" id="7453913">.</span><span class="ident" id="7453914">Close</span><span class="op" id="7453919">(</span><span class="op" id="7453920">)</span><br>
<span class="lineno"></span><span class="op" id="7453922">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7453925">func</span>&nbsp;<span class="ident" id="7453930">TestNewLogger</span><span class="op" id="7453943">(</span><span class="ident" id="7453944">t</span>&nbsp;<span class="op" id="7453946">*</span><span class="ident" id="7453947">testing</span><span class="op" id="7453954">.</span><span class="ident" id="7453955">T</span><span class="op" id="7453956">)</span>&nbsp;<span class="op" id="7453958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7453961">if</span>&nbsp;<span class="ident" id="7453964">testing</span><span class="op" id="7453971">.</span><span class="ident" id="7453972">Short</span><span class="op" id="7453977">(</span><span class="op" id="7453978">)</span>&nbsp;<span class="op" id="7453980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7453984">t</span><span class="op" id="7453985">.</span><span class="ident" id="7453986">Skip</span><span class="op" id="7453990">(</span><span class="string" id="7453991">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7454027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454030">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454033">f</span><span class="op" id="7454034">,</span>&nbsp;<span class="ident" id="7454036">err</span>&nbsp;<span class="op" id="7454040">:=</span>&nbsp;<span class="ident" id="7454043">NewLogger</span><span class="op" id="7454052">(</span><span class="ident" id="7454053">LOG_USER</span><span class="op" id="7454061">|</span><span class="ident" id="7454062">LOG_INFO</span><span class="op" id="7454070">,</span>&nbsp;<span class="num" id="7454072">0</span><span class="op" id="7454073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454076">if</span>&nbsp;<span class="ident" id="7454079">f</span>&nbsp;<span class="op" id="7454081">==</span>&nbsp;<span class="ident" id="7454084">nil</span>&nbsp;<span class="op" id="7454088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454092">t</span><span class="op" id="7454093">.</span><span class="ident" id="7454094">Error</span><span class="op" id="7454099">(</span><span class="ident" id="7454100">err</span><span class="op" id="7454103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454106">}</span><br>
<span class="lineno"></span><span class="op" id="7454108">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7454111">func</span>&nbsp;<span class="ident" id="7454116">TestDial</span><span class="op" id="7454124">(</span><span class="ident" id="7454125">t</span>&nbsp;<span class="op" id="7454127">*</span><span class="ident" id="7454128">testing</span><span class="op" id="7454135">.</span><span class="ident" id="7454136">T</span><span class="op" id="7454137">)</span>&nbsp;<span class="op" id="7454139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454142">if</span>&nbsp;<span class="ident" id="7454145">testing</span><span class="op" id="7454152">.</span><span class="ident" id="7454153">Short</span><span class="op" id="7454158">(</span><span class="op" id="7454159">)</span>&nbsp;<span class="op" id="7454161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454165">t</span><span class="op" id="7454166">.</span><span class="ident" id="7454167">Skip</span><span class="op" id="7454171">(</span><span class="string" id="7454172">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7454208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454211">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454214">f</span><span class="op" id="7454215">,</span>&nbsp;<span class="ident" id="7454217">err</span>&nbsp;<span class="op" id="7454221">:=</span>&nbsp;<span class="ident" id="7454224">Dial</span><span class="op" id="7454228">(</span><span class="string" id="7454229">&#34;&#34;</span><span class="op" id="7454231">,</span>&nbsp;<span class="string" id="7454233">&#34;&#34;</span><span class="op" id="7454235">,</span>&nbsp;<span class="op" id="7454237">(</span><span class="ident" id="7454238">LOG_LOCAL7</span><span class="op" id="7454248">|</span><span class="ident" id="7454249">LOG_DEBUG</span><span class="op" id="7454258">)</span><span class="op" id="7454259">+</span><span class="num" id="7454260">1</span><span class="op" id="7454261">,</span>&nbsp;<span class="string" id="7454263">&#34;syslog_test&#34;</span><span class="op" id="7454276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454279">if</span>&nbsp;<span class="ident" id="7454282">f</span>&nbsp;<span class="op" id="7454284">!=</span>&nbsp;<span class="ident" id="7454287">nil</span>&nbsp;<span class="op" id="7454291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454295">t</span><span class="op" id="7454296">.</span><span class="ident" id="7454297">Fatalf</span><span class="op" id="7454303">(</span><span class="string" id="7454304">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7454338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454344">f</span><span class="op" id="7454345">,</span>&nbsp;<span class="ident" id="7454347">err</span>&nbsp;<span class="op" id="7454351">=</span>&nbsp;<span class="ident" id="7454353">Dial</span><span class="op" id="7454357">(</span><span class="string" id="7454358">&#34;&#34;</span><span class="op" id="7454360">,</span>&nbsp;<span class="string" id="7454362">&#34;&#34;</span><span class="op" id="7454364">,</span>&nbsp;<span class="op" id="7454366">-</span><span class="num" id="7454367">1</span><span class="op" id="7454368">,</span>&nbsp;<span class="string" id="7454370">&#34;syslog_test&#34;</span><span class="op" id="7454383">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454386">if</span>&nbsp;<span class="ident" id="7454389">f</span>&nbsp;<span class="op" id="7454391">!=</span>&nbsp;<span class="ident" id="7454394">nil</span>&nbsp;<span class="op" id="7454398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454402">t</span><span class="op" id="7454403">.</span><span class="ident" id="7454404">Fatalf</span><span class="op" id="7454410">(</span><span class="string" id="7454411">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7454445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454451">l</span><span class="op" id="7454452">,</span>&nbsp;<span class="ident" id="7454454">err</span>&nbsp;<span class="op" id="7454458">:=</span>&nbsp;<span class="ident" id="7454461">Dial</span><span class="op" id="7454465">(</span><span class="string" id="7454466">&#34;&#34;</span><span class="op" id="7454468">,</span>&nbsp;<span class="string" id="7454470">&#34;&#34;</span><span class="op" id="7454472">,</span>&nbsp;<span class="ident" id="7454474">LOG_USER</span><span class="op" id="7454482">|</span><span class="ident" id="7454483">LOG_ERR</span><span class="op" id="7454490">,</span>&nbsp;<span class="string" id="7454492">&#34;syslog_test&#34;</span><span class="op" id="7454505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454508">if</span>&nbsp;<span class="ident" id="7454511">err</span>&nbsp;<span class="op" id="7454515">!=</span>&nbsp;<span class="ident" id="7454518">nil</span>&nbsp;<span class="op" id="7454522">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454526">t</span><span class="op" id="7454527">.</span><span class="ident" id="7454528">Fatalf</span><span class="op" id="7454534">(</span><span class="string" id="7454535">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7454554">,</span>&nbsp;<span class="ident" id="7454556">err</span><span class="op" id="7454559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454565">l</span><span class="op" id="7454566">.</span><span class="ident" id="7454567">Close</span><span class="op" id="7454572">(</span><span class="op" id="7454573">)</span><br>
<span class="lineno"></span><span class="op" id="7454575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7454578">func</span>&nbsp;<span class="ident" id="7454583">check</span><span class="op" id="7454588">(</span><span class="ident" id="7454589">t</span>&nbsp;<span class="op" id="7454591">*</span><span class="ident" id="7454592">testing</span><span class="op" id="7454599">.</span><span class="ident" id="7454600">T</span><span class="op" id="7454601">,</span>&nbsp;<span class="ident" id="7454603">in</span><span class="op" id="7454605">,</span>&nbsp;<span class="ident" id="7454607">out</span>&nbsp;<span class="builtintype" id="7454611">string</span><span class="op" id="7454617">)</span>&nbsp;<span class="op" id="7454619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454622">tmpl</span>&nbsp;<span class="op" id="7454627">:=</span>&nbsp;<span class="ident" id="7454630">fmt</span><span class="op" id="7454633">.</span><span class="ident" id="7454634">Sprintf</span><span class="op" id="7454641">(</span><span class="string" id="7454642">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7454678">,</span>&nbsp;<span class="ident" id="7454680">LOG_USER</span><span class="op" id="7454688">+</span><span class="ident" id="7454689">LOG_INFO</span><span class="op" id="7454697">,</span>&nbsp;<span class="ident" id="7454699">in</span><span class="op" id="7454701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454704">if</span>&nbsp;<span class="ident" id="7454707">hostname</span><span class="op" id="7454715">,</span>&nbsp;<span class="ident" id="7454717">err</span>&nbsp;<span class="op" id="7454721">:=</span>&nbsp;<span class="ident" id="7454724">os</span><span class="op" id="7454726">.</span><span class="ident" id="7454727">Hostname</span><span class="op" id="7454735">(</span><span class="op" id="7454736">)</span><span class="op" id="7454737">;</span>&nbsp;<span class="ident" id="7454739">err</span>&nbsp;<span class="op" id="7454743">!=</span>&nbsp;<span class="ident" id="7454746">nil</span>&nbsp;<span class="op" id="7454750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454754">t</span><span class="op" id="7454755">.</span><span class="ident" id="7454756">Error</span><span class="op" id="7454761">(</span><span class="string" id="7454762">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7454789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7454792">}</span>&nbsp;<span class="keyword" id="7454794">else</span>&nbsp;<span class="op" id="7454799">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454803">var</span>&nbsp;<span class="ident" id="7454807">parsedHostname</span><span class="op" id="7454821">,</span>&nbsp;<span class="ident" id="7454823">timestamp</span>&nbsp;<span class="builtintype" id="7454833">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454842">var</span>&nbsp;<span class="ident" id="7454846">pid</span>&nbsp;<span class="builtintype" id="7454850">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7454856">if</span>&nbsp;<span class="ident" id="7454859">n</span><span class="op" id="7454860">,</span>&nbsp;<span class="ident" id="7454862">err</span>&nbsp;<span class="op" id="7454866">:=</span>&nbsp;<span class="ident" id="7454869">fmt</span><span class="op" id="7454872">.</span><span class="ident" id="7454873">Sscanf</span><span class="op" id="7454879">(</span><span class="ident" id="7454880">out</span><span class="op" id="7454883">,</span>&nbsp;<span class="ident" id="7454885">tmpl</span><span class="op" id="7454889">,</span>&nbsp;<span class="op" id="7454891">&amp;</span><span class="ident" id="7454892">timestamp</span><span class="op" id="7454901">,</span>&nbsp;<span class="op" id="7454903">&amp;</span><span class="ident" id="7454904">parsedHostname</span><span class="op" id="7454918">,</span>&nbsp;<span class="op" id="7454920">&amp;</span><span class="ident" id="7454921">pid</span><span class="op" id="7454924">)</span><span class="op" id="7454925">;</span>&nbsp;<span class="ident" id="7454927">n</span>&nbsp;<span class="op" id="7454929">!=</span>&nbsp;<span class="num" id="7454932">3</span>&nbsp;<span class="op" id="7454934">||</span>&nbsp;<span class="ident" id="7454937">err</span>&nbsp;<span class="op" id="7454941">!=</span>&nbsp;<span class="ident" id="7454944">nil</span>&nbsp;<span class="op" id="7454948">||</span>&nbsp;<span class="ident" id="7454951">hostname</span>&nbsp;<span class="op" id="7454960">!=</span>&nbsp;<span class="ident" id="7454963">parsedHostname</span>&nbsp;<span class="op" id="7454978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7454983">t</span><span class="op" id="7454984">.</span><span class="ident" id="7454985">Errorf</span><span class="op" id="7454991">(</span><span class="string" id="7454992">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7455036">,</span>&nbsp;<span class="ident" id="7455038">out</span><span class="op" id="7455041">,</span>&nbsp;<span class="ident" id="7455043">tmpl</span><span class="op" id="7455047">,</span>&nbsp;<span class="ident" id="7455049">n</span><span class="op" id="7455050">,</span>&nbsp;<span class="ident" id="7455052">err</span><span class="op" id="7455055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455059">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455062">}</span><br>
<span class="lineno"></span><span class="op" id="7455064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7455067">func</span>&nbsp;<span class="ident" id="7455072">TestWrite</span><span class="op" id="7455081">(</span><span class="ident" id="7455082">t</span>&nbsp;<span class="op" id="7455084">*</span><span class="ident" id="7455085">testing</span><span class="op" id="7455092">.</span><span class="ident" id="7455093">T</span><span class="op" id="7455094">)</span>&nbsp;<span class="op" id="7455096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455099">tests</span>&nbsp;<span class="op" id="7455105">:=</span>&nbsp;<span class="op" id="7455108">[</span><span class="op" id="7455109">]</span><span class="keyword" id="7455110">struct</span>&nbsp;<span class="op" id="7455117">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455121">pri</span>&nbsp;<span class="ident" id="7455125">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455136">pre</span>&nbsp;<span class="builtintype" id="7455140">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455149">msg</span>&nbsp;<span class="builtintype" id="7455153">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455162">exp</span>&nbsp;<span class="builtintype" id="7455166">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455174">}</span><span class="op" id="7455175">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455179">{</span><span class="ident" id="7455180">LOG_USER</span>&nbsp;<span class="op" id="7455189">|</span>&nbsp;<span class="ident" id="7455191">LOG_ERR</span><span class="op" id="7455198">,</span>&nbsp;<span class="string" id="7455200">&#34;syslog_test&#34;</span><span class="op" id="7455213">,</span>&nbsp;<span class="string" id="7455215">&#34;&#34;</span><span class="op" id="7455217">,</span>&nbsp;<span class="string" id="7455219">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7455246">}</span><span class="op" id="7455247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455251">{</span><span class="ident" id="7455252">LOG_USER</span>&nbsp;<span class="op" id="7455261">|</span>&nbsp;<span class="ident" id="7455263">LOG_ERR</span><span class="op" id="7455270">,</span>&nbsp;<span class="string" id="7455272">&#34;syslog_test&#34;</span><span class="op" id="7455285">,</span>&nbsp;<span class="string" id="7455287">&#34;write&nbsp;test&#34;</span><span class="op" id="7455299">,</span>&nbsp;<span class="string" id="7455301">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7455338">}</span><span class="op" id="7455339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7455343">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455396">{</span><span class="ident" id="7455397">LOG_USER</span>&nbsp;<span class="op" id="7455406">|</span>&nbsp;<span class="ident" id="7455408">LOG_ERR</span><span class="op" id="7455415">,</span>&nbsp;<span class="string" id="7455417">&#34;syslog_test&#34;</span><span class="op" id="7455430">,</span>&nbsp;<span class="string" id="7455432">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7455448">,</span>&nbsp;<span class="string" id="7455450">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7455489">}</span><span class="op" id="7455490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455493">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455497">if</span>&nbsp;<span class="ident" id="7455500">hostname</span><span class="op" id="7455508">,</span>&nbsp;<span class="ident" id="7455510">err</span>&nbsp;<span class="op" id="7455514">:=</span>&nbsp;<span class="ident" id="7455517">os</span><span class="op" id="7455519">.</span><span class="ident" id="7455520">Hostname</span><span class="op" id="7455528">(</span><span class="op" id="7455529">)</span><span class="op" id="7455530">;</span>&nbsp;<span class="ident" id="7455532">err</span>&nbsp;<span class="op" id="7455536">!=</span>&nbsp;<span class="ident" id="7455539">nil</span>&nbsp;<span class="op" id="7455543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455547">t</span><span class="op" id="7455548">.</span><span class="ident" id="7455549">Fatalf</span><span class="op" id="7455555">(</span><span class="string" id="7455556">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7455583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455586">}</span>&nbsp;<span class="keyword" id="7455588">else</span>&nbsp;<span class="op" id="7455593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455597">for</span>&nbsp;<span class="ident" id="7455601">_</span><span class="op" id="7455602">,</span>&nbsp;<span class="ident" id="7455604">test</span>&nbsp;<span class="op" id="7455609">:=</span>&nbsp;<span class="keyword" id="7455612">range</span>&nbsp;<span class="ident" id="7455618">tests</span>&nbsp;<span class="op" id="7455624">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455629">done</span>&nbsp;<span class="op" id="7455634">:=</span>&nbsp;<span class="builtinfunc" id="7455637">make</span><span class="op" id="7455641">(</span><span class="keyword" id="7455642">chan</span>&nbsp;<span class="builtintype" id="7455647">string</span><span class="op" id="7455653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455658">addr</span><span class="op" id="7455662">,</span>&nbsp;<span class="ident" id="7455664">sock</span><span class="op" id="7455668">,</span>&nbsp;<span class="ident" id="7455670">srvWG</span>&nbsp;<span class="op" id="7455676">:=</span>&nbsp;<span class="ident" id="7455679">startServer</span><span class="op" id="7455690">(</span><span class="string" id="7455691">&#34;udp&#34;</span><span class="op" id="7455696">,</span>&nbsp;<span class="string" id="7455698">&#34;&#34;</span><span class="op" id="7455700">,</span>&nbsp;<span class="ident" id="7455702">done</span><span class="op" id="7455706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455711">defer</span>&nbsp;<span class="ident" id="7455717">srvWG</span><span class="op" id="7455722">.</span><span class="ident" id="7455723">Wait</span><span class="op" id="7455727">(</span><span class="op" id="7455728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455733">defer</span>&nbsp;<span class="ident" id="7455739">sock</span><span class="op" id="7455743">.</span><span class="ident" id="7455744">Close</span><span class="op" id="7455749">(</span><span class="op" id="7455750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455755">l</span><span class="op" id="7455756">,</span>&nbsp;<span class="ident" id="7455758">err</span>&nbsp;<span class="op" id="7455762">:=</span>&nbsp;<span class="ident" id="7455765">Dial</span><span class="op" id="7455769">(</span><span class="string" id="7455770">&#34;udp&#34;</span><span class="op" id="7455775">,</span>&nbsp;<span class="ident" id="7455777">addr</span><span class="op" id="7455781">,</span>&nbsp;<span class="ident" id="7455783">test</span><span class="op" id="7455787">.</span><span class="ident" id="7455788">pri</span><span class="op" id="7455791">,</span>&nbsp;<span class="ident" id="7455793">test</span><span class="op" id="7455797">.</span><span class="ident" id="7455798">pre</span><span class="op" id="7455801">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455806">if</span>&nbsp;<span class="ident" id="7455809">err</span>&nbsp;<span class="op" id="7455813">!=</span>&nbsp;<span class="ident" id="7455816">nil</span>&nbsp;<span class="op" id="7455820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455826">t</span><span class="op" id="7455827">.</span><span class="ident" id="7455828">Fatalf</span><span class="op" id="7455834">(</span><span class="string" id="7455835">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7455861">,</span>&nbsp;<span class="ident" id="7455863">err</span><span class="op" id="7455866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7455871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455876">defer</span>&nbsp;<span class="ident" id="7455882">l</span><span class="op" id="7455883">.</span><span class="ident" id="7455884">Close</span><span class="op" id="7455889">(</span><span class="op" id="7455890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455895">_</span><span class="op" id="7455896">,</span>&nbsp;<span class="ident" id="7455898">err</span>&nbsp;<span class="op" id="7455902">=</span>&nbsp;<span class="ident" id="7455904">io</span><span class="op" id="7455906">.</span><span class="ident" id="7455907">WriteString</span><span class="op" id="7455918">(</span><span class="ident" id="7455919">l</span><span class="op" id="7455920">,</span>&nbsp;<span class="ident" id="7455922">test</span><span class="op" id="7455926">.</span><span class="ident" id="7455927">msg</span><span class="op" id="7455930">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7455935">if</span>&nbsp;<span class="ident" id="7455938">err</span>&nbsp;<span class="op" id="7455942">!=</span>&nbsp;<span class="ident" id="7455945">nil</span>&nbsp;<span class="op" id="7455949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7455955">t</span><span class="op" id="7455956">.</span><span class="ident" id="7455957">Fatalf</span><span class="op" id="7455963">(</span><span class="string" id="7455964">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7455990">,</span>&nbsp;<span class="ident" id="7455992">err</span><span class="op" id="7455995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456005">rcvd</span>&nbsp;<span class="op" id="7456010">:=</span>&nbsp;<span class="op" id="7456013">&lt;-</span><span class="ident" id="7456015">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456023">test</span><span class="op" id="7456027">.</span><span class="ident" id="7456028">exp</span>&nbsp;<span class="op" id="7456032">=</span>&nbsp;<span class="ident" id="7456034">fmt</span><span class="op" id="7456037">.</span><span class="ident" id="7456038">Sprintf</span><span class="op" id="7456045">(</span><span class="string" id="7456046">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7456052">,</span>&nbsp;<span class="ident" id="7456054">test</span><span class="op" id="7456058">.</span><span class="ident" id="7456059">pri</span><span class="op" id="7456062">)</span>&nbsp;<span class="op" id="7456064">+</span>&nbsp;<span class="ident" id="7456066">test</span><span class="op" id="7456070">.</span><span class="ident" id="7456071">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456078">var</span>&nbsp;<span class="ident" id="7456082">parsedHostname</span><span class="op" id="7456096">,</span>&nbsp;<span class="ident" id="7456098">timestamp</span>&nbsp;<span class="builtintype" id="7456108">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456118">var</span>&nbsp;<span class="ident" id="7456122">pid</span>&nbsp;<span class="builtintype" id="7456126">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456133">if</span>&nbsp;<span class="ident" id="7456136">n</span><span class="op" id="7456137">,</span>&nbsp;<span class="ident" id="7456139">err</span>&nbsp;<span class="op" id="7456143">:=</span>&nbsp;<span class="ident" id="7456146">fmt</span><span class="op" id="7456149">.</span><span class="ident" id="7456150">Sscanf</span><span class="op" id="7456156">(</span><span class="ident" id="7456157">rcvd</span><span class="op" id="7456161">,</span>&nbsp;<span class="ident" id="7456163">test</span><span class="op" id="7456167">.</span><span class="ident" id="7456168">exp</span><span class="op" id="7456171">,</span>&nbsp;<span class="op" id="7456173">&amp;</span><span class="ident" id="7456174">timestamp</span><span class="op" id="7456183">,</span>&nbsp;<span class="op" id="7456185">&amp;</span><span class="ident" id="7456186">parsedHostname</span><span class="op" id="7456200">,</span>&nbsp;<span class="op" id="7456202">&amp;</span><span class="ident" id="7456203">pid</span><span class="op" id="7456206">)</span><span class="op" id="7456207">;</span>&nbsp;<span class="ident" id="7456209">n</span>&nbsp;<span class="op" id="7456211">!=</span>&nbsp;<span class="num" id="7456214">3</span>&nbsp;<span class="op" id="7456216">||</span>&nbsp;<span class="ident" id="7456219">err</span>&nbsp;<span class="op" id="7456223">!=</span>&nbsp;<span class="ident" id="7456226">nil</span>&nbsp;<span class="op" id="7456230">||</span>&nbsp;<span class="ident" id="7456233">hostname</span>&nbsp;<span class="op" id="7456242">!=</span>&nbsp;<span class="ident" id="7456245">parsedHostname</span>&nbsp;<span class="op" id="7456260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456266">t</span><span class="op" id="7456267">.</span><span class="ident" id="7456268">Errorf</span><span class="op" id="7456274">(</span><span class="string" id="7456275">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7456319">,</span>&nbsp;<span class="ident" id="7456321">rcvd</span><span class="op" id="7456325">,</span>&nbsp;<span class="ident" id="7456327">test</span><span class="op" id="7456331">.</span><span class="ident" id="7456332">exp</span><span class="op" id="7456335">,</span>&nbsp;<span class="ident" id="7456337">n</span><span class="op" id="7456338">,</span>&nbsp;<span class="ident" id="7456340">err</span><span class="op" id="7456343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456348">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456355">}</span><br>
<span class="lineno"></span><span class="op" id="7456357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7456360">func</span>&nbsp;<span class="ident" id="7456365">TestConcurrentWrite</span><span class="op" id="7456384">(</span><span class="ident" id="7456385">t</span>&nbsp;<span class="op" id="7456387">*</span><span class="ident" id="7456388">testing</span><span class="op" id="7456395">.</span><span class="ident" id="7456396">T</span><span class="op" id="7456397">)</span>&nbsp;<span class="op" id="7456399">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456402">addr</span><span class="op" id="7456406">,</span>&nbsp;<span class="ident" id="7456408">sock</span><span class="op" id="7456412">,</span>&nbsp;<span class="ident" id="7456414">srvWG</span>&nbsp;<span class="op" id="7456420">:=</span>&nbsp;<span class="ident" id="7456423">startServer</span><span class="op" id="7456434">(</span><span class="string" id="7456435">&#34;udp&#34;</span><span class="op" id="7456440">,</span>&nbsp;<span class="string" id="7456442">&#34;&#34;</span><span class="op" id="7456444">,</span>&nbsp;<span class="builtinfunc" id="7456446">make</span><span class="op" id="7456450">(</span><span class="keyword" id="7456451">chan</span>&nbsp;<span class="builtintype" id="7456456">string</span><span class="op" id="7456462">,</span>&nbsp;<span class="num" id="7456464">1</span><span class="op" id="7456465">)</span><span class="op" id="7456466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456469">defer</span>&nbsp;<span class="ident" id="7456475">srvWG</span><span class="op" id="7456480">.</span><span class="ident" id="7456481">Wait</span><span class="op" id="7456485">(</span><span class="op" id="7456486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456489">defer</span>&nbsp;<span class="ident" id="7456495">sock</span><span class="op" id="7456499">.</span><span class="ident" id="7456500">Close</span><span class="op" id="7456505">(</span><span class="op" id="7456506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456509">w</span><span class="op" id="7456510">,</span>&nbsp;<span class="ident" id="7456512">err</span>&nbsp;<span class="op" id="7456516">:=</span>&nbsp;<span class="ident" id="7456519">Dial</span><span class="op" id="7456523">(</span><span class="string" id="7456524">&#34;udp&#34;</span><span class="op" id="7456529">,</span>&nbsp;<span class="ident" id="7456531">addr</span><span class="op" id="7456535">,</span>&nbsp;<span class="ident" id="7456537">LOG_USER</span><span class="op" id="7456545">|</span><span class="ident" id="7456546">LOG_ERR</span><span class="op" id="7456553">,</span>&nbsp;<span class="string" id="7456555">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7456572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456575">if</span>&nbsp;<span class="ident" id="7456578">err</span>&nbsp;<span class="op" id="7456582">!=</span>&nbsp;<span class="ident" id="7456585">nil</span>&nbsp;<span class="op" id="7456589">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456593">t</span><span class="op" id="7456594">.</span><span class="ident" id="7456595">Fatalf</span><span class="op" id="7456601">(</span><span class="string" id="7456602">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7456628">,</span>&nbsp;<span class="ident" id="7456630">err</span><span class="op" id="7456633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456639">var</span>&nbsp;<span class="ident" id="7456643">wg</span>&nbsp;<span class="ident" id="7456646">sync</span><span class="op" id="7456650">.</span><span class="ident" id="7456651">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456662">for</span>&nbsp;<span class="ident" id="7456666">i</span>&nbsp;<span class="op" id="7456668">:=</span>&nbsp;<span class="num" id="7456671">0</span><span class="op" id="7456672">;</span>&nbsp;<span class="ident" id="7456674">i</span>&nbsp;<span class="op" id="7456676">&lt;</span>&nbsp;<span class="num" id="7456678">10</span><span class="op" id="7456680">;</span>&nbsp;<span class="ident" id="7456682">i</span><span class="op" id="7456683">++</span>&nbsp;<span class="op" id="7456686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456690">wg</span><span class="op" id="7456692">.</span><span class="ident" id="7456693">Add</span><span class="op" id="7456696">(</span><span class="num" id="7456697">1</span><span class="op" id="7456698">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456702">go</span>&nbsp;<span class="keyword" id="7456705">func</span><span class="op" id="7456709">(</span><span class="op" id="7456710">)</span>&nbsp;<span class="op" id="7456712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456717">defer</span>&nbsp;<span class="ident" id="7456723">wg</span><span class="op" id="7456725">.</span><span class="ident" id="7456726">Done</span><span class="op" id="7456730">(</span><span class="op" id="7456731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456736">err</span>&nbsp;<span class="op" id="7456740">:=</span>&nbsp;<span class="ident" id="7456743">w</span><span class="op" id="7456744">.</span><span class="ident" id="7456745">Info</span><span class="op" id="7456749">(</span><span class="string" id="7456750">&#34;test&#34;</span><span class="op" id="7456756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456761">if</span>&nbsp;<span class="ident" id="7456764">err</span>&nbsp;<span class="op" id="7456768">!=</span>&nbsp;<span class="ident" id="7456771">nil</span>&nbsp;<span class="op" id="7456775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456781">t</span><span class="op" id="7456782">.</span><span class="ident" id="7456783">Errorf</span><span class="op" id="7456789">(</span><span class="string" id="7456790">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7456809">,</span>&nbsp;<span class="ident" id="7456811">err</span><span class="op" id="7456814">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456820">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456834">}</span><span class="op" id="7456835">(</span><span class="op" id="7456836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7456839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456842">wg</span><span class="op" id="7456844">.</span><span class="ident" id="7456845">Wait</span><span class="op" id="7456849">(</span><span class="op" id="7456850">)</span><br>
<span class="lineno">300</span><span class="op" id="7456852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7456855">func</span>&nbsp;<span class="ident" id="7456860">TestConcurrentReconnect</span><span class="op" id="7456883">(</span><span class="ident" id="7456884">t</span>&nbsp;<span class="op" id="7456886">*</span><span class="ident" id="7456887">testing</span><span class="op" id="7456894">.</span><span class="ident" id="7456895">T</span><span class="op" id="7456896">)</span>&nbsp;<span class="op" id="7456898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456901">crashy</span>&nbsp;<span class="op" id="7456908">=</span>&nbsp;<span class="builtintype" id="7456910">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456916">defer</span>&nbsp;<span class="keyword" id="7456922">func</span><span class="op" id="7456926">(</span><span class="op" id="7456927">)</span>&nbsp;<span class="op" id="7456929">{</span>&nbsp;<span class="ident" id="7456931">crashy</span>&nbsp;<span class="op" id="7456938">=</span>&nbsp;<span class="builtintype" id="7456940">false</span>&nbsp;<span class="op" id="7456946">}</span><span class="op" id="7456947">(</span><span class="op" id="7456948">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456952">const</span>&nbsp;<span class="ident" id="7456958">N</span>&nbsp;<span class="op" id="7456960">=</span>&nbsp;<span class="num" id="7456962">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7456966">const</span>&nbsp;<span class="ident" id="7456972">M</span>&nbsp;<span class="op" id="7456974">=</span>&nbsp;<span class="num" id="7456976">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456981">net</span>&nbsp;<span class="op" id="7456985">:=</span>&nbsp;<span class="string" id="7456988">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7456996">done</span>&nbsp;<span class="op" id="7457001">:=</span>&nbsp;<span class="builtinfunc" id="7457004">make</span><span class="op" id="7457008">(</span><span class="keyword" id="7457009">chan</span>&nbsp;<span class="builtintype" id="7457014">string</span><span class="op" id="7457020">,</span>&nbsp;<span class="ident" id="7457022">N</span><span class="op" id="7457023">*</span><span class="ident" id="7457024">M</span><span class="op" id="7457025">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457028">addr</span><span class="op" id="7457032">,</span>&nbsp;<span class="ident" id="7457034">sock</span><span class="op" id="7457038">,</span>&nbsp;<span class="ident" id="7457040">srvWG</span>&nbsp;<span class="op" id="7457046">:=</span>&nbsp;<span class="ident" id="7457049">startServer</span><span class="op" id="7457060">(</span><span class="ident" id="7457061">net</span><span class="op" id="7457064">,</span>&nbsp;<span class="string" id="7457066">&#34;&#34;</span><span class="op" id="7457068">,</span>&nbsp;<span class="ident" id="7457070">done</span><span class="op" id="7457074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457077">defer</span>&nbsp;<span class="ident" id="7457083">os</span><span class="op" id="7457085">.</span><span class="ident" id="7457086">Remove</span><span class="op" id="7457092">(</span><span class="ident" id="7457093">addr</span><span class="op" id="7457097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7457101">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457137">count</span>&nbsp;<span class="op" id="7457143">:=</span>&nbsp;<span class="builtinfunc" id="7457146">make</span><span class="op" id="7457150">(</span><span class="keyword" id="7457151">chan</span>&nbsp;<span class="builtintype" id="7457156">int</span><span class="op" id="7457159">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457162">go</span>&nbsp;<span class="keyword" id="7457165">func</span><span class="op" id="7457169">(</span><span class="op" id="7457170">)</span>&nbsp;<span class="op" id="7457172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457176">ct</span>&nbsp;<span class="op" id="7457179">:=</span>&nbsp;<span class="num" id="7457182">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457186">for</span>&nbsp;<span class="keyword" id="7457190">range</span>&nbsp;<span class="ident" id="7457196">done</span>&nbsp;<span class="op" id="7457201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457206">ct</span><span class="op" id="7457208">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7457214">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7457262">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7457311">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457350">if</span>&nbsp;<span class="ident" id="7457353">ct</span>&nbsp;<span class="op" id="7457356">&gt;</span>&nbsp;<span class="ident" id="7457358">N</span><span class="op" id="7457359">*</span><span class="ident" id="7457360">M</span><span class="op" id="7457361">/</span><span class="num" id="7457362">2</span>&nbsp;<span class="op" id="7457364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457370">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457379">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457387">count</span>&nbsp;<span class="op" id="7457393">&lt;-</span>&nbsp;<span class="ident" id="7457396">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457400">}</span><span class="op" id="7457401">(</span><span class="op" id="7457402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457406">var</span>&nbsp;<span class="ident" id="7457410">wg</span>&nbsp;<span class="ident" id="7457413">sync</span><span class="op" id="7457417">.</span><span class="ident" id="7457418">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457429">wg</span><span class="op" id="7457431">.</span><span class="ident" id="7457432">Add</span><span class="op" id="7457435">(</span><span class="ident" id="7457436">N</span><span class="op" id="7457437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457440">for</span>&nbsp;<span class="ident" id="7457444">i</span>&nbsp;<span class="op" id="7457446">:=</span>&nbsp;<span class="num" id="7457449">0</span><span class="op" id="7457450">;</span>&nbsp;<span class="ident" id="7457452">i</span>&nbsp;<span class="op" id="7457454">&lt;</span>&nbsp;<span class="ident" id="7457456">N</span><span class="op" id="7457457">;</span>&nbsp;<span class="ident" id="7457459">i</span><span class="op" id="7457460">++</span>&nbsp;<span class="op" id="7457463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457467">go</span>&nbsp;<span class="keyword" id="7457470">func</span><span class="op" id="7457474">(</span><span class="op" id="7457475">)</span>&nbsp;<span class="op" id="7457477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457482">defer</span>&nbsp;<span class="ident" id="7457488">wg</span><span class="op" id="7457490">.</span><span class="ident" id="7457491">Done</span><span class="op" id="7457495">(</span><span class="op" id="7457496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457501">w</span><span class="op" id="7457502">,</span>&nbsp;<span class="ident" id="7457504">err</span>&nbsp;<span class="op" id="7457508">:=</span>&nbsp;<span class="ident" id="7457511">Dial</span><span class="op" id="7457515">(</span><span class="ident" id="7457516">net</span><span class="op" id="7457519">,</span>&nbsp;<span class="ident" id="7457521">addr</span><span class="op" id="7457525">,</span>&nbsp;<span class="ident" id="7457527">LOG_USER</span><span class="op" id="7457535">|</span><span class="ident" id="7457536">LOG_ERR</span><span class="op" id="7457543">,</span>&nbsp;<span class="string" id="7457545">&#34;tag&#34;</span><span class="op" id="7457550">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457555">if</span>&nbsp;<span class="ident" id="7457558">err</span>&nbsp;<span class="op" id="7457562">!=</span>&nbsp;<span class="ident" id="7457565">nil</span>&nbsp;<span class="op" id="7457569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457575">t</span><span class="op" id="7457576">.</span><span class="ident" id="7457577">Fatalf</span><span class="op" id="7457583">(</span><span class="string" id="7457584">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7457610">,</span>&nbsp;<span class="ident" id="7457612">err</span><span class="op" id="7457615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457625">defer</span>&nbsp;<span class="ident" id="7457631">w</span><span class="op" id="7457632">.</span><span class="ident" id="7457633">Close</span><span class="op" id="7457638">(</span><span class="op" id="7457639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457644">for</span>&nbsp;<span class="ident" id="7457648">i</span>&nbsp;<span class="op" id="7457650">:=</span>&nbsp;<span class="num" id="7457653">0</span><span class="op" id="7457654">;</span>&nbsp;<span class="ident" id="7457656">i</span>&nbsp;<span class="op" id="7457658">&lt;</span>&nbsp;<span class="ident" id="7457660">M</span><span class="op" id="7457661">;</span>&nbsp;<span class="ident" id="7457663">i</span><span class="op" id="7457664">++</span>&nbsp;<span class="op" id="7457667">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457673">err</span>&nbsp;<span class="op" id="7457677">:=</span>&nbsp;<span class="ident" id="7457680">w</span><span class="op" id="7457681">.</span><span class="ident" id="7457682">Info</span><span class="op" id="7457686">(</span><span class="string" id="7457687">&#34;test&#34;</span><span class="op" id="7457693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457699">if</span>&nbsp;<span class="ident" id="7457702">err</span>&nbsp;<span class="op" id="7457706">!=</span>&nbsp;<span class="ident" id="7457709">nil</span>&nbsp;<span class="op" id="7457713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457720">t</span><span class="op" id="7457721">.</span><span class="ident" id="7457722">Errorf</span><span class="op" id="7457728">(</span><span class="string" id="7457729">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7457748">,</span>&nbsp;<span class="ident" id="7457750">err</span><span class="op" id="7457753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457760">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457771">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457780">}</span><span class="op" id="7457781">(</span><span class="op" id="7457782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457788">wg</span><span class="op" id="7457790">.</span><span class="ident" id="7457791">Wait</span><span class="op" id="7457795">(</span><span class="op" id="7457796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457799">sock</span><span class="op" id="7457803">.</span><span class="ident" id="7457804">Close</span><span class="op" id="7457809">(</span><span class="op" id="7457810">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457813">srvWG</span><span class="op" id="7457818">.</span><span class="ident" id="7457819">Wait</span><span class="op" id="7457823">(</span><span class="op" id="7457824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7457827">close</span><span class="op" id="7457832">(</span><span class="ident" id="7457833">done</span><span class="op" id="7457837">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457841">select</span>&nbsp;<span class="op" id="7457848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457851">case</span>&nbsp;<span class="op" id="7457856">&lt;-</span><span class="ident" id="7457858">count</span><span class="op" id="7457863">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7457866">case</span>&nbsp;<span class="op" id="7457871">&lt;-</span><span class="ident" id="7457873">time</span><span class="op" id="7457877">.</span><span class="ident" id="7457878">After</span><span class="op" id="7457883">(</span><span class="num" id="7457884">100</span>&nbsp;<span class="op" id="7457888">*</span>&nbsp;<span class="ident" id="7457890">time</span><span class="op" id="7457894">.</span><span class="ident" id="7457895">Millisecond</span><span class="op" id="7457906">)</span><span class="op" id="7457907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7457911">t</span><span class="op" id="7457912">.</span><span class="ident" id="7457913">Error</span><span class="op" id="7457918">(</span><span class="string" id="7457919">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7457952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7457955">}</span><br>
<span class="lineno"></span><span class="op" id="7457957">}</span>
</div>
</body>
</html>
