<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7982940">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7982995">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7983049">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7983100">package</span>&nbsp;<span class="ident" id="7983108">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7983113">import</span>&nbsp;<span class="op" id="7983120">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983123">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983146">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983156">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983163">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983169">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983176">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983184">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983195">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983206">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983214">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7983225">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7983232">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7983235">var</span>&nbsp;<span class="ident" id="7983239">_</span>&nbsp;<span class="op" id="7983241">=</span>&nbsp;<span class="ident" id="7983243">log</span><span class="op" id="7983246">.</span><span class="ident" id="7983247">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7983255">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7983323">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7983355">//</span><br>
<span class="lineno"></span><span class="comment" id="7983358">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7983423">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7983490">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7983502">//</span><br>
<span class="lineno">30</span><span class="comment" id="7983505">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7983515">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7983569">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7983630">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7983679">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7983752">//</span><br>
<span class="lineno"></span><span class="comment" id="7983755">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7983820">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7983879">type</span>&nbsp;<span class="ident" id="7983884">fakeDriver</span>&nbsp;<span class="keyword" id="7983895">struct</span>&nbsp;<span class="op" id="7983902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7983905">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7983916">sync</span><span class="op" id="7983920">.</span><span class="ident" id="7983921">Mutex</span>&nbsp;<span class="comment" id="7983927">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7983957">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7983968">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7983979">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7983994">closeCount</span>&nbsp;<span class="builtintype" id="7984005">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7984016">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984032">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984043">chan</span>&nbsp;<span class="keyword" id="7984048">struct</span><span class="op" id="7984054">{</span><span class="op" id="7984055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984058">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7984069">chan</span>&nbsp;<span class="keyword" id="7984074">struct</span><span class="op" id="7984080">{</span><span class="op" id="7984081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984084">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984095">map</span><span class="op" id="7984098">[</span><span class="builtintype" id="7984099">string</span><span class="op" id="7984105">]</span><span class="op" id="7984106">*</span><span class="ident" id="7984107">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7984114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984117">type</span>&nbsp;<span class="ident" id="7984122">fakeDB</span>&nbsp;<span class="keyword" id="7984129">struct</span>&nbsp;<span class="op" id="7984136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984139">name</span>&nbsp;<span class="builtintype" id="7984144">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984153">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984161">sync</span><span class="op" id="7984165">.</span><span class="ident" id="7984166">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984173">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7984181">[</span><span class="op" id="7984182">]</span><span class="op" id="7984183">*</span><span class="ident" id="7984184">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984194">tables</span>&nbsp;&nbsp;<span class="keyword" id="7984202">map</span><span class="op" id="7984205">[</span><span class="builtintype" id="7984206">string</span><span class="op" id="7984212">]</span><span class="op" id="7984213">*</span><span class="ident" id="7984214">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984221">badConn</span>&nbsp;<span class="builtintype" id="7984229">bool</span><br>
<span class="lineno"></span><span class="op" id="7984234">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7984237">type</span>&nbsp;<span class="ident" id="7984242">table</span>&nbsp;<span class="keyword" id="7984248">struct</span>&nbsp;<span class="op" id="7984255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984258">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984266">sync</span><span class="op" id="7984270">.</span><span class="ident" id="7984271">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984278">colname</span>&nbsp;<span class="op" id="7984286">[</span><span class="op" id="7984287">]</span><span class="builtintype" id="7984288">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984296">coltype</span>&nbsp;<span class="op" id="7984304">[</span><span class="op" id="7984305">]</span><span class="builtintype" id="7984306">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984314">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7984322">[</span><span class="op" id="7984323">]</span><span class="op" id="7984324">*</span><span class="ident" id="7984325">row</span><br>
<span class="lineno"></span><span class="op" id="7984329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984332">func</span>&nbsp;<span class="op" id="7984337">(</span><span class="ident" id="7984338">t</span>&nbsp;<span class="op" id="7984340">*</span><span class="ident" id="7984341">table</span><span class="op" id="7984346">)</span>&nbsp;<span class="ident" id="7984348">columnIndex</span><span class="op" id="7984359">(</span><span class="ident" id="7984360">name</span>&nbsp;<span class="builtintype" id="7984365">string</span><span class="op" id="7984371">)</span>&nbsp;<span class="builtintype" id="7984373">int</span>&nbsp;<span class="op" id="7984377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984380">for</span>&nbsp;<span class="ident" id="7984384">n</span><span class="op" id="7984385">,</span>&nbsp;<span class="ident" id="7984387">nname</span>&nbsp;<span class="op" id="7984393">:=</span>&nbsp;<span class="keyword" id="7984396">range</span>&nbsp;<span class="ident" id="7984402">t</span><span class="op" id="7984403">.</span><span class="ident" id="7984404">colname</span>&nbsp;<span class="op" id="7984412">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984416">if</span>&nbsp;<span class="ident" id="7984419">name</span>&nbsp;<span class="op" id="7984424">==</span>&nbsp;<span class="ident" id="7984427">nname</span>&nbsp;<span class="op" id="7984433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984438">return</span>&nbsp;<span class="ident" id="7984445">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7984449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7984452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984455">return</span>&nbsp;<span class="op" id="7984462">-</span><span class="num" id="7984463">1</span><br>
<span class="lineno">70</span><span class="op" id="7984465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984468">type</span>&nbsp;<span class="ident" id="7984473">row</span>&nbsp;<span class="keyword" id="7984477">struct</span>&nbsp;<span class="op" id="7984484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984487">cols</span>&nbsp;<span class="op" id="7984492">[</span><span class="op" id="7984493">]</span><span class="keyword" id="7984494">interface</span><span class="op" id="7984503">{</span><span class="op" id="7984504">}</span>&nbsp;<span class="comment" id="7984506">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7984558">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7984561">func</span>&nbsp;<span class="op" id="7984566">(</span><span class="ident" id="7984567">r</span>&nbsp;<span class="op" id="7984569">*</span><span class="ident" id="7984570">row</span><span class="op" id="7984573">)</span>&nbsp;<span class="ident" id="7984575">clone</span><span class="op" id="7984580">(</span><span class="op" id="7984581">)</span>&nbsp;<span class="op" id="7984583">*</span><span class="ident" id="7984584">row</span>&nbsp;<span class="op" id="7984588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984591">nrow</span>&nbsp;<span class="op" id="7984596">:=</span>&nbsp;<span class="op" id="7984599">&amp;</span><span class="ident" id="7984600">row</span><span class="op" id="7984603">{</span><span class="ident" id="7984604">cols</span><span class="op" id="7984608">:</span>&nbsp;<span class="builtinfunc" id="7984610">make</span><span class="op" id="7984614">(</span><span class="op" id="7984615">[</span><span class="op" id="7984616">]</span><span class="keyword" id="7984617">interface</span><span class="op" id="7984626">{</span><span class="op" id="7984627">}</span><span class="op" id="7984628">,</span>&nbsp;<span class="builtinfunc" id="7984630">len</span><span class="op" id="7984633">(</span><span class="ident" id="7984634">r</span><span class="op" id="7984635">.</span><span class="ident" id="7984636">cols</span><span class="op" id="7984640">)</span><span class="op" id="7984641">)</span><span class="op" id="7984642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7984645">copy</span><span class="op" id="7984649">(</span><span class="ident" id="7984650">nrow</span><span class="op" id="7984654">.</span><span class="ident" id="7984655">cols</span><span class="op" id="7984659">,</span>&nbsp;<span class="ident" id="7984661">r</span><span class="op" id="7984662">.</span><span class="ident" id="7984663">cols</span><span class="op" id="7984667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7984670">return</span>&nbsp;<span class="ident" id="7984677">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7984682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984685">type</span>&nbsp;<span class="ident" id="7984690">fakeConn</span>&nbsp;<span class="keyword" id="7984699">struct</span>&nbsp;<span class="op" id="7984706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984709">db</span>&nbsp;<span class="op" id="7984712">*</span><span class="ident" id="7984713">fakeDB</span>&nbsp;<span class="comment" id="7984720">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984754">currTx</span>&nbsp;<span class="op" id="7984761">*</span><span class="ident" id="7984762">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7984771">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984792">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984804">sync</span><span class="op" id="7984808">.</span><span class="ident" id="7984809">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984816">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7984828">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984833">stmtsClosed</span>&nbsp;<span class="builtintype" id="7984845">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984850">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7984862">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984867">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7984879">bool</span><br>
<span class="lineno"></span><span class="op" id="7984884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7984887">func</span>&nbsp;<span class="op" id="7984892">(</span><span class="ident" id="7984893">c</span>&nbsp;<span class="op" id="7984895">*</span><span class="ident" id="7984896">fakeConn</span><span class="op" id="7984904">)</span>&nbsp;<span class="ident" id="7984906">incrStat</span><span class="op" id="7984914">(</span><span class="ident" id="7984915">v</span>&nbsp;<span class="op" id="7984917">*</span><span class="builtintype" id="7984918">int</span><span class="op" id="7984921">)</span>&nbsp;<span class="op" id="7984923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984926">c</span><span class="op" id="7984927">.</span><span class="ident" id="7984928">mu</span><span class="op" id="7984930">.</span><span class="ident" id="7984931">Lock</span><span class="op" id="7984935">(</span><span class="op" id="7984936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7984939">*</span><span class="ident" id="7984940">v</span><span class="op" id="7984941">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984945">c</span><span class="op" id="7984946">.</span><span class="ident" id="7984947">mu</span><span class="op" id="7984949">.</span><span class="ident" id="7984950">Unlock</span><span class="op" id="7984956">(</span><span class="op" id="7984957">)</span><br>
<span class="lineno"></span><span class="op" id="7984959">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7984962">type</span>&nbsp;<span class="ident" id="7984967">fakeTx</span>&nbsp;<span class="keyword" id="7984974">struct</span>&nbsp;<span class="op" id="7984981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7984984">c</span>&nbsp;<span class="op" id="7984986">*</span><span class="ident" id="7984987">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7984996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7984999">type</span>&nbsp;<span class="ident" id="7985004">fakeStmt</span>&nbsp;<span class="keyword" id="7985013">struct</span>&nbsp;<span class="op" id="7985020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985023">c</span>&nbsp;<span class="op" id="7985025">*</span><span class="ident" id="7985026">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985036">q</span>&nbsp;<span class="builtintype" id="7985038">string</span>&nbsp;<span class="comment" id="7985045">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985069">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7985075">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985083">table</span>&nbsp;<span class="builtintype" id="7985089">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985098">closed</span>&nbsp;<span class="builtintype" id="7985105">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985112">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7985125">[</span><span class="op" id="7985126">]</span><span class="builtintype" id="7985127">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7985139">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985193">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7985206">[</span><span class="op" id="7985207">]</span><span class="builtintype" id="7985208">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7985220">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985239">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7985252">[</span><span class="op" id="7985253">]</span><span class="keyword" id="7985254">interface</span><span class="op" id="7985263">{</span><span class="op" id="7985264">}</span>&nbsp;<span class="comment" id="7985266">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985327">placeholders</span>&nbsp;<span class="builtintype" id="7985340">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7985354">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985401">whereCol</span>&nbsp;<span class="op" id="7985410">[</span><span class="op" id="7985411">]</span><span class="builtintype" id="7985412">string</span>&nbsp;<span class="comment" id="7985419">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985458">placeholderConverter</span>&nbsp;<span class="op" id="7985479">[</span><span class="op" id="7985480">]</span><span class="ident" id="7985481">driver</span><span class="op" id="7985487">.</span><span class="ident" id="7985488">ValueConverter</span>&nbsp;<span class="comment" id="7985503">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7985521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7985524">var</span>&nbsp;<span class="ident" id="7985528">fdriver</span>&nbsp;<span class="ident" id="7985536">driver</span><span class="op" id="7985542">.</span><span class="ident" id="7985543">Driver</span>&nbsp;<span class="op" id="7985550">=</span>&nbsp;<span class="op" id="7985552">&amp;</span><span class="ident" id="7985553">fakeDriver</span><span class="op" id="7985563">{</span><span class="op" id="7985564">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7985567">func</span>&nbsp;<span class="ident" id="7985572">init</span><span class="op" id="7985576">(</span><span class="op" id="7985577">)</span>&nbsp;<span class="op" id="7985579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985582">Register</span><span class="op" id="7985590">(</span><span class="string" id="7985591">&#34;test&#34;</span><span class="op" id="7985597">,</span>&nbsp;<span class="ident" id="7985599">fdriver</span><span class="op" id="7985606">)</span><br>
<span class="lineno"></span><span class="op" id="7985608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7985611">func</span>&nbsp;<span class="ident" id="7985616">contains</span><span class="op" id="7985624">(</span><span class="ident" id="7985625">list</span>&nbsp;<span class="op" id="7985630">[</span><span class="op" id="7985631">]</span><span class="builtintype" id="7985632">string</span><span class="op" id="7985638">,</span>&nbsp;<span class="ident" id="7985640">y</span>&nbsp;<span class="builtintype" id="7985642">string</span><span class="op" id="7985648">)</span>&nbsp;<span class="builtintype" id="7985650">bool</span>&nbsp;<span class="op" id="7985655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7985658">for</span>&nbsp;<span class="ident" id="7985662">_</span><span class="op" id="7985663">,</span>&nbsp;<span class="ident" id="7985665">x</span>&nbsp;<span class="op" id="7985667">:=</span>&nbsp;<span class="keyword" id="7985670">range</span>&nbsp;<span class="ident" id="7985676">list</span>&nbsp;<span class="op" id="7985681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7985685">if</span>&nbsp;<span class="ident" id="7985688">x</span>&nbsp;<span class="op" id="7985690">==</span>&nbsp;<span class="ident" id="7985693">y</span>&nbsp;<span class="op" id="7985695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7985700">return</span>&nbsp;<span class="builtintype" id="7985707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7985714">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7985717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7985720">return</span>&nbsp;<span class="builtintype" id="7985727">false</span><br>
<span class="lineno"></span><span class="op" id="7985733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7985736">type</span>&nbsp;<span class="ident" id="7985741">Dummy</span>&nbsp;<span class="keyword" id="7985747">struct</span>&nbsp;<span class="op" id="7985754">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985757">driver</span><span class="op" id="7985763">.</span><span class="ident" id="7985764">Driver</span><br>
<span class="lineno"></span><span class="op" id="7985771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7985774">func</span>&nbsp;<span class="ident" id="7985779">TestDrivers</span><span class="op" id="7985790">(</span><span class="ident" id="7985791">t</span>&nbsp;<span class="op" id="7985793">*</span><span class="ident" id="7985794">testing</span><span class="op" id="7985801">.</span><span class="ident" id="7985802">T</span><span class="op" id="7985803">)</span>&nbsp;<span class="op" id="7985805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985808">unregisterAllDrivers</span><span class="op" id="7985828">(</span><span class="op" id="7985829">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985832">Register</span><span class="op" id="7985840">(</span><span class="string" id="7985841">&#34;test&#34;</span><span class="op" id="7985847">,</span>&nbsp;<span class="ident" id="7985849">fdriver</span><span class="op" id="7985856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985859">Register</span><span class="op" id="7985867">(</span><span class="string" id="7985868">&#34;invalid&#34;</span><span class="op" id="7985877">,</span>&nbsp;<span class="ident" id="7985879">Dummy</span><span class="op" id="7985884">{</span><span class="op" id="7985885">}</span><span class="op" id="7985886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7985889">all</span>&nbsp;<span class="op" id="7985893">:=</span>&nbsp;<span class="ident" id="7985896">Drivers</span><span class="op" id="7985903">(</span><span class="op" id="7985904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7985907">if</span>&nbsp;<span class="builtinfunc" id="7985910">len</span><span class="op" id="7985913">(</span><span class="ident" id="7985914">all</span><span class="op" id="7985917">)</span>&nbsp;<span class="op" id="7985919">&lt;</span>&nbsp;<span class="num" id="7985921">2</span>&nbsp;<span class="op" id="7985923">||</span>&nbsp;<span class="op" id="7985926">!</span><span class="ident" id="7985927">sort</span><span class="op" id="7985931">.</span><span class="ident" id="7985932">StringsAreSorted</span><span class="op" id="7985948">(</span><span class="ident" id="7985949">all</span><span class="op" id="7985952">)</span>&nbsp;<span class="op" id="7985954">||</span>&nbsp;<span class="op" id="7985957">!</span><span class="ident" id="7985958">contains</span><span class="op" id="7985966">(</span><span class="ident" id="7985967">all</span><span class="op" id="7985970">,</span>&nbsp;<span class="string" id="7985972">&#34;test&#34;</span><span class="op" id="7985978">)</span>&nbsp;<span class="op" id="7985980">||</span>&nbsp;<span class="op" id="7985983">!</span><span class="ident" id="7985984">contains</span><span class="op" id="7985992">(</span><span class="ident" id="7985993">all</span><span class="op" id="7985996">,</span>&nbsp;<span class="string" id="7985998">&#34;invalid&#34;</span><span class="op" id="7986007">)</span>&nbsp;<span class="op" id="7986009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986013">t</span><span class="op" id="7986014">.</span><span class="ident" id="7986015">Fatalf</span><span class="op" id="7986021">(</span><span class="string" id="7986022">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7986084">,</span>&nbsp;<span class="ident" id="7986086">all</span><span class="op" id="7986089">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986092">}</span><br>
<span class="lineno"></span><span class="op" id="7986094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7986097">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7986120">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7986135">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7986205">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7986278">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7986328">func</span>&nbsp;<span class="op" id="7986333">(</span><span class="ident" id="7986334">d</span>&nbsp;<span class="op" id="7986336">*</span><span class="ident" id="7986337">fakeDriver</span><span class="op" id="7986347">)</span>&nbsp;<span class="ident" id="7986349">Open</span><span class="op" id="7986353">(</span><span class="ident" id="7986354">dsn</span>&nbsp;<span class="builtintype" id="7986358">string</span><span class="op" id="7986364">)</span>&nbsp;<span class="op" id="7986366">(</span><span class="ident" id="7986367">driver</span><span class="op" id="7986373">.</span><span class="ident" id="7986374">Conn</span><span class="op" id="7986378">,</span>&nbsp;<span class="builtintype" id="7986380">error</span><span class="op" id="7986385">)</span>&nbsp;<span class="op" id="7986387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986390">parts</span>&nbsp;<span class="op" id="7986396">:=</span>&nbsp;<span class="ident" id="7986399">strings</span><span class="op" id="7986406">.</span><span class="ident" id="7986407">Split</span><span class="op" id="7986412">(</span><span class="ident" id="7986413">dsn</span><span class="op" id="7986416">,</span>&nbsp;<span class="string" id="7986418">&#34;;&#34;</span><span class="op" id="7986421">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986424">if</span>&nbsp;<span class="builtinfunc" id="7986427">len</span><span class="op" id="7986430">(</span><span class="ident" id="7986431">parts</span><span class="op" id="7986436">)</span>&nbsp;<span class="op" id="7986438">&lt;</span>&nbsp;<span class="num" id="7986440">1</span>&nbsp;<span class="op" id="7986442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986446">return</span>&nbsp;<span class="builtintype" id="7986453">nil</span><span class="op" id="7986456">,</span>&nbsp;<span class="ident" id="7986458">errors</span><span class="op" id="7986464">.</span><span class="ident" id="7986465">New</span><span class="op" id="7986468">(</span><span class="string" id="7986469">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7986495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986501">name</span>&nbsp;<span class="op" id="7986506">:=</span>&nbsp;<span class="ident" id="7986509">parts</span><span class="op" id="7986514">[</span><span class="num" id="7986515">0</span><span class="op" id="7986516">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986520">db</span>&nbsp;<span class="op" id="7986523">:=</span>&nbsp;<span class="ident" id="7986526">d</span><span class="op" id="7986527">.</span><span class="ident" id="7986528">getDB</span><span class="op" id="7986533">(</span><span class="ident" id="7986534">name</span><span class="op" id="7986538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986542">d</span><span class="op" id="7986543">.</span><span class="ident" id="7986544">mu</span><span class="op" id="7986546">.</span><span class="ident" id="7986547">Lock</span><span class="op" id="7986551">(</span><span class="op" id="7986552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986555">d</span><span class="op" id="7986556">.</span><span class="ident" id="7986557">openCount</span><span class="op" id="7986566">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986570">d</span><span class="op" id="7986571">.</span><span class="ident" id="7986572">mu</span><span class="op" id="7986574">.</span><span class="ident" id="7986575">Unlock</span><span class="op" id="7986581">(</span><span class="op" id="7986582">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986585">conn</span>&nbsp;<span class="op" id="7986590">:=</span>&nbsp;<span class="op" id="7986593">&amp;</span><span class="ident" id="7986594">fakeConn</span><span class="op" id="7986602">{</span><span class="ident" id="7986603">db</span><span class="op" id="7986605">:</span>&nbsp;<span class="ident" id="7986607">db</span><span class="op" id="7986609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986613">if</span>&nbsp;<span class="builtinfunc" id="7986616">len</span><span class="op" id="7986619">(</span><span class="ident" id="7986620">parts</span><span class="op" id="7986625">)</span>&nbsp;<span class="op" id="7986627">&gt;=</span>&nbsp;<span class="num" id="7986630">2</span>&nbsp;<span class="op" id="7986632">&amp;&amp;</span>&nbsp;<span class="ident" id="7986635">parts</span><span class="op" id="7986640">[</span><span class="num" id="7986641">1</span><span class="op" id="7986642">]</span>&nbsp;<span class="op" id="7986644">==</span>&nbsp;<span class="string" id="7986647">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7986657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986661">conn</span><span class="op" id="7986665">.</span><span class="ident" id="7986666">bad</span>&nbsp;<span class="op" id="7986670">=</span>&nbsp;<span class="builtintype" id="7986672">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986678">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986681">if</span>&nbsp;<span class="ident" id="7986684">d</span><span class="op" id="7986685">.</span><span class="ident" id="7986686">waitCh</span>&nbsp;<span class="op" id="7986693">!=</span>&nbsp;<span class="builtintype" id="7986696">nil</span>&nbsp;<span class="op" id="7986700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986704">d</span><span class="op" id="7986705">.</span><span class="ident" id="7986706">waitingCh</span>&nbsp;<span class="op" id="7986716">&lt;-</span>&nbsp;<span class="keyword" id="7986719">struct</span><span class="op" id="7986725">{</span><span class="op" id="7986726">}</span><span class="op" id="7986727">{</span><span class="op" id="7986728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986732">&lt;-</span><span class="ident" id="7986734">d</span><span class="op" id="7986735">.</span><span class="ident" id="7986736">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986745">d</span><span class="op" id="7986746">.</span><span class="ident" id="7986747">waitCh</span>&nbsp;<span class="op" id="7986754">=</span>&nbsp;<span class="builtintype" id="7986756">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986762">d</span><span class="op" id="7986763">.</span><span class="ident" id="7986764">waitingCh</span>&nbsp;<span class="op" id="7986774">=</span>&nbsp;<span class="builtintype" id="7986776">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986784">return</span>&nbsp;<span class="ident" id="7986791">conn</span><span class="op" id="7986795">,</span>&nbsp;<span class="builtintype" id="7986797">nil</span><br>
<span class="lineno"></span><span class="op" id="7986801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7986804">func</span>&nbsp;<span class="op" id="7986809">(</span><span class="ident" id="7986810">d</span>&nbsp;<span class="op" id="7986812">*</span><span class="ident" id="7986813">fakeDriver</span><span class="op" id="7986823">)</span>&nbsp;<span class="ident" id="7986825">getDB</span><span class="op" id="7986830">(</span><span class="ident" id="7986831">name</span>&nbsp;<span class="builtintype" id="7986836">string</span><span class="op" id="7986842">)</span>&nbsp;<span class="op" id="7986844">*</span><span class="ident" id="7986845">fakeDB</span>&nbsp;<span class="op" id="7986852">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986855">d</span><span class="op" id="7986856">.</span><span class="ident" id="7986857">mu</span><span class="op" id="7986859">.</span><span class="ident" id="7986860">Lock</span><span class="op" id="7986864">(</span><span class="op" id="7986865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986868">defer</span>&nbsp;<span class="ident" id="7986874">d</span><span class="op" id="7986875">.</span><span class="ident" id="7986876">mu</span><span class="op" id="7986878">.</span><span class="ident" id="7986879">Unlock</span><span class="op" id="7986885">(</span><span class="op" id="7986886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986889">if</span>&nbsp;<span class="ident" id="7986892">d</span><span class="op" id="7986893">.</span><span class="ident" id="7986894">dbs</span>&nbsp;<span class="op" id="7986898">==</span>&nbsp;<span class="builtintype" id="7986901">nil</span>&nbsp;<span class="op" id="7986905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986909">d</span><span class="op" id="7986910">.</span><span class="ident" id="7986911">dbs</span>&nbsp;<span class="op" id="7986915">=</span>&nbsp;<span class="builtinfunc" id="7986917">make</span><span class="op" id="7986921">(</span><span class="keyword" id="7986922">map</span><span class="op" id="7986925">[</span><span class="builtintype" id="7986926">string</span><span class="op" id="7986932">]</span><span class="op" id="7986933">*</span><span class="ident" id="7986934">fakeDB</span><span class="op" id="7986940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7986943">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986946">db</span><span class="op" id="7986948">,</span>&nbsp;<span class="ident" id="7986950">ok</span>&nbsp;<span class="op" id="7986953">:=</span>&nbsp;<span class="ident" id="7986956">d</span><span class="op" id="7986957">.</span><span class="ident" id="7986958">dbs</span><span class="op" id="7986961">[</span><span class="ident" id="7986962">name</span><span class="op" id="7986966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7986969">if</span>&nbsp;<span class="op" id="7986972">!</span><span class="ident" id="7986973">ok</span>&nbsp;<span class="op" id="7986976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7986980">db</span>&nbsp;<span class="op" id="7986983">=</span>&nbsp;<span class="op" id="7986985">&amp;</span><span class="ident" id="7986986">fakeDB</span><span class="op" id="7986992">{</span><span class="ident" id="7986993">name</span><span class="op" id="7986997">:</span>&nbsp;<span class="ident" id="7986999">name</span><span class="op" id="7987003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987007">d</span><span class="op" id="7987008">.</span><span class="ident" id="7987009">dbs</span><span class="op" id="7987012">[</span><span class="ident" id="7987013">name</span><span class="op" id="7987017">]</span>&nbsp;<span class="op" id="7987019">=</span>&nbsp;<span class="ident" id="7987021">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7987025">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987028">return</span>&nbsp;<span class="ident" id="7987035">db</span><br>
<span class="lineno"></span><span class="op" id="7987038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7987041">func</span>&nbsp;<span class="op" id="7987046">(</span><span class="ident" id="7987047">db</span>&nbsp;<span class="op" id="7987050">*</span><span class="ident" id="7987051">fakeDB</span><span class="op" id="7987057">)</span>&nbsp;<span class="ident" id="7987059">wipe</span><span class="op" id="7987063">(</span><span class="op" id="7987064">)</span>&nbsp;<span class="op" id="7987066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987069">db</span><span class="op" id="7987071">.</span><span class="ident" id="7987072">mu</span><span class="op" id="7987074">.</span><span class="ident" id="7987075">Lock</span><span class="op" id="7987079">(</span><span class="op" id="7987080">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987083">defer</span>&nbsp;<span class="ident" id="7987089">db</span><span class="op" id="7987091">.</span><span class="ident" id="7987092">mu</span><span class="op" id="7987094">.</span><span class="ident" id="7987095">Unlock</span><span class="op" id="7987101">(</span><span class="op" id="7987102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987105">db</span><span class="op" id="7987107">.</span><span class="ident" id="7987108">tables</span>&nbsp;<span class="op" id="7987115">=</span>&nbsp;<span class="builtintype" id="7987117">nil</span><br>
<span class="lineno"></span><span class="op" id="7987121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7987124">func</span>&nbsp;<span class="op" id="7987129">(</span><span class="ident" id="7987130">db</span>&nbsp;<span class="op" id="7987133">*</span><span class="ident" id="7987134">fakeDB</span><span class="op" id="7987140">)</span>&nbsp;<span class="ident" id="7987142">createTable</span><span class="op" id="7987153">(</span><span class="ident" id="7987154">name</span>&nbsp;<span class="builtintype" id="7987159">string</span><span class="op" id="7987165">,</span>&nbsp;<span class="ident" id="7987167">columnNames</span><span class="op" id="7987178">,</span>&nbsp;<span class="ident" id="7987180">columnTypes</span>&nbsp;<span class="op" id="7987192">[</span><span class="op" id="7987193">]</span><span class="builtintype" id="7987194">string</span><span class="op" id="7987200">)</span>&nbsp;<span class="builtintype" id="7987202">error</span>&nbsp;<span class="op" id="7987208">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987211">db</span><span class="op" id="7987213">.</span><span class="ident" id="7987214">mu</span><span class="op" id="7987216">.</span><span class="ident" id="7987217">Lock</span><span class="op" id="7987221">(</span><span class="op" id="7987222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987225">defer</span>&nbsp;<span class="ident" id="7987231">db</span><span class="op" id="7987233">.</span><span class="ident" id="7987234">mu</span><span class="op" id="7987236">.</span><span class="ident" id="7987237">Unlock</span><span class="op" id="7987243">(</span><span class="op" id="7987244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987247">if</span>&nbsp;<span class="ident" id="7987250">db</span><span class="op" id="7987252">.</span><span class="ident" id="7987253">tables</span>&nbsp;<span class="op" id="7987260">==</span>&nbsp;<span class="builtintype" id="7987263">nil</span>&nbsp;<span class="op" id="7987267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987271">db</span><span class="op" id="7987273">.</span><span class="ident" id="7987274">tables</span>&nbsp;<span class="op" id="7987281">=</span>&nbsp;<span class="builtinfunc" id="7987283">make</span><span class="op" id="7987287">(</span><span class="keyword" id="7987288">map</span><span class="op" id="7987291">[</span><span class="builtintype" id="7987292">string</span><span class="op" id="7987298">]</span><span class="op" id="7987299">*</span><span class="ident" id="7987300">table</span><span class="op" id="7987305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7987308">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987311">if</span>&nbsp;<span class="ident" id="7987314">_</span><span class="op" id="7987315">,</span>&nbsp;<span class="ident" id="7987317">exist</span>&nbsp;<span class="op" id="7987323">:=</span>&nbsp;<span class="ident" id="7987326">db</span><span class="op" id="7987328">.</span><span class="ident" id="7987329">tables</span><span class="op" id="7987335">[</span><span class="ident" id="7987336">name</span><span class="op" id="7987340">]</span><span class="op" id="7987341">;</span>&nbsp;<span class="ident" id="7987343">exist</span>&nbsp;<span class="op" id="7987349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987353">return</span>&nbsp;<span class="ident" id="7987360">fmt</span><span class="op" id="7987363">.</span><span class="ident" id="7987364">Errorf</span><span class="op" id="7987370">(</span><span class="string" id="7987371">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7987396">,</span>&nbsp;<span class="ident" id="7987398">name</span><span class="op" id="7987402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7987405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987408">if</span>&nbsp;<span class="builtinfunc" id="7987411">len</span><span class="op" id="7987414">(</span><span class="ident" id="7987415">columnNames</span><span class="op" id="7987426">)</span>&nbsp;<span class="op" id="7987428">!=</span>&nbsp;<span class="builtinfunc" id="7987431">len</span><span class="op" id="7987434">(</span><span class="ident" id="7987435">columnTypes</span><span class="op" id="7987446">)</span>&nbsp;<span class="op" id="7987448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987452">return</span>&nbsp;<span class="ident" id="7987459">fmt</span><span class="op" id="7987462">.</span><span class="ident" id="7987463">Errorf</span><span class="op" id="7987469">(</span><span class="string" id="7987470">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7987525">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987530">name</span><span class="op" id="7987534">,</span>&nbsp;<span class="builtinfunc" id="7987536">len</span><span class="op" id="7987539">(</span><span class="ident" id="7987540">columnNames</span><span class="op" id="7987551">)</span><span class="op" id="7987552">,</span>&nbsp;<span class="builtinfunc" id="7987554">len</span><span class="op" id="7987557">(</span><span class="ident" id="7987558">columnTypes</span><span class="op" id="7987569">)</span><span class="op" id="7987570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7987573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987576">db</span><span class="op" id="7987578">.</span><span class="ident" id="7987579">tables</span><span class="op" id="7987585">[</span><span class="ident" id="7987586">name</span><span class="op" id="7987590">]</span>&nbsp;<span class="op" id="7987592">=</span>&nbsp;<span class="op" id="7987594">&amp;</span><span class="ident" id="7987595">table</span><span class="op" id="7987600">{</span><span class="ident" id="7987601">colname</span><span class="op" id="7987608">:</span>&nbsp;<span class="ident" id="7987610">columnNames</span><span class="op" id="7987621">,</span>&nbsp;<span class="ident" id="7987623">coltype</span><span class="op" id="7987630">:</span>&nbsp;<span class="ident" id="7987632">columnTypes</span><span class="op" id="7987643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987646">return</span>&nbsp;<span class="builtintype" id="7987653">nil</span><br>
<span class="lineno"></span><span class="op" id="7987657">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7987660">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7987699">func</span>&nbsp;<span class="op" id="7987704">(</span><span class="ident" id="7987705">db</span>&nbsp;<span class="op" id="7987708">*</span><span class="ident" id="7987709">fakeDB</span><span class="op" id="7987715">)</span>&nbsp;<span class="ident" id="7987717">table</span><span class="op" id="7987722">(</span><span class="ident" id="7987723">table</span>&nbsp;<span class="builtintype" id="7987729">string</span><span class="op" id="7987735">)</span>&nbsp;<span class="op" id="7987737">(</span><span class="op" id="7987738">*</span><span class="ident" id="7987739">table</span><span class="op" id="7987744">,</span>&nbsp;<span class="builtintype" id="7987746">bool</span><span class="op" id="7987750">)</span>&nbsp;<span class="op" id="7987752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987755">if</span>&nbsp;<span class="ident" id="7987758">db</span><span class="op" id="7987760">.</span><span class="ident" id="7987761">tables</span>&nbsp;<span class="op" id="7987768">==</span>&nbsp;<span class="builtintype" id="7987771">nil</span>&nbsp;<span class="op" id="7987775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987779">return</span>&nbsp;<span class="builtintype" id="7987786">nil</span><span class="op" id="7987789">,</span>&nbsp;<span class="builtintype" id="7987791">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7987798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987801">t</span><span class="op" id="7987802">,</span>&nbsp;<span class="ident" id="7987804">ok</span>&nbsp;<span class="op" id="7987807">:=</span>&nbsp;<span class="ident" id="7987810">db</span><span class="op" id="7987812">.</span><span class="ident" id="7987813">tables</span><span class="op" id="7987819">[</span><span class="ident" id="7987820">table</span><span class="op" id="7987825">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987828">return</span>&nbsp;<span class="ident" id="7987835">t</span><span class="op" id="7987836">,</span>&nbsp;<span class="ident" id="7987838">ok</span><br>
<span class="lineno"></span><span class="op" id="7987841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7987844">func</span>&nbsp;<span class="op" id="7987849">(</span><span class="ident" id="7987850">db</span>&nbsp;<span class="op" id="7987853">*</span><span class="ident" id="7987854">fakeDB</span><span class="op" id="7987860">)</span>&nbsp;<span class="ident" id="7987862">columnType</span><span class="op" id="7987872">(</span><span class="ident" id="7987873">table</span><span class="op" id="7987878">,</span>&nbsp;<span class="ident" id="7987880">column</span>&nbsp;<span class="builtintype" id="7987887">string</span><span class="op" id="7987893">)</span>&nbsp;<span class="op" id="7987895">(</span><span class="ident" id="7987896">typ</span>&nbsp;<span class="builtintype" id="7987900">string</span><span class="op" id="7987906">,</span>&nbsp;<span class="ident" id="7987908">ok</span>&nbsp;<span class="builtintype" id="7987911">bool</span><span class="op" id="7987915">)</span>&nbsp;<span class="op" id="7987917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987920">db</span><span class="op" id="7987922">.</span><span class="ident" id="7987923">mu</span><span class="op" id="7987925">.</span><span class="ident" id="7987926">Lock</span><span class="op" id="7987930">(</span><span class="op" id="7987931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987934">defer</span>&nbsp;<span class="ident" id="7987940">db</span><span class="op" id="7987942">.</span><span class="ident" id="7987943">mu</span><span class="op" id="7987945">.</span><span class="ident" id="7987946">Unlock</span><span class="op" id="7987952">(</span><span class="op" id="7987953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7987956">t</span><span class="op" id="7987957">,</span>&nbsp;<span class="ident" id="7987959">ok</span>&nbsp;<span class="op" id="7987962">:=</span>&nbsp;<span class="ident" id="7987965">db</span><span class="op" id="7987967">.</span><span class="ident" id="7987968">table</span><span class="op" id="7987973">(</span><span class="ident" id="7987974">table</span><span class="op" id="7987979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987982">if</span>&nbsp;<span class="op" id="7987985">!</span><span class="ident" id="7987986">ok</span>&nbsp;<span class="op" id="7987989">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7987993">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988004">for</span>&nbsp;<span class="ident" id="7988008">n</span><span class="op" id="7988009">,</span>&nbsp;<span class="ident" id="7988011">cname</span>&nbsp;<span class="op" id="7988017">:=</span>&nbsp;<span class="keyword" id="7988020">range</span>&nbsp;<span class="ident" id="7988026">t</span><span class="op" id="7988027">.</span><span class="ident" id="7988028">colname</span>&nbsp;<span class="op" id="7988036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988040">if</span>&nbsp;<span class="ident" id="7988043">cname</span>&nbsp;<span class="op" id="7988049">==</span>&nbsp;<span class="ident" id="7988052">column</span>&nbsp;<span class="op" id="7988059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988064">return</span>&nbsp;<span class="ident" id="7988071">t</span><span class="op" id="7988072">.</span><span class="ident" id="7988073">coltype</span><span class="op" id="7988080">[</span><span class="ident" id="7988081">n</span><span class="op" id="7988082">]</span><span class="op" id="7988083">,</span>&nbsp;<span class="builtintype" id="7988085">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988098">return</span>&nbsp;<span class="string" id="7988105">&#34;&#34;</span><span class="op" id="7988107">,</span>&nbsp;<span class="builtintype" id="7988109">false</span><br>
<span class="lineno"></span><span class="op" id="7988115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7988118">func</span>&nbsp;<span class="op" id="7988123">(</span><span class="ident" id="7988124">c</span>&nbsp;<span class="op" id="7988126">*</span><span class="ident" id="7988127">fakeConn</span><span class="op" id="7988135">)</span>&nbsp;<span class="ident" id="7988137">isBad</span><span class="op" id="7988142">(</span><span class="op" id="7988143">)</span>&nbsp;<span class="builtintype" id="7988145">bool</span>&nbsp;<span class="op" id="7988150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7988153">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988196">if</span>&nbsp;<span class="op" id="7988199">!</span><span class="ident" id="7988200">c</span><span class="op" id="7988201">.</span><span class="ident" id="7988202">bad</span>&nbsp;<span class="op" id="7988206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988210">return</span>&nbsp;<span class="builtintype" id="7988217">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988224">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7988227">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988275">c</span><span class="op" id="7988276">.</span><span class="ident" id="7988277">db</span><span class="op" id="7988279">.</span><span class="ident" id="7988280">badConn</span>&nbsp;<span class="op" id="7988288">=</span>&nbsp;<span class="op" id="7988290">!</span><span class="ident" id="7988291">c</span><span class="op" id="7988292">.</span><span class="ident" id="7988293">db</span><span class="op" id="7988295">.</span><span class="ident" id="7988296">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988305">return</span>&nbsp;<span class="ident" id="7988312">c</span><span class="op" id="7988313">.</span><span class="ident" id="7988314">db</span><span class="op" id="7988316">.</span><span class="ident" id="7988317">badConn</span><br>
<span class="lineno"></span><span class="op" id="7988325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7988328">func</span>&nbsp;<span class="op" id="7988333">(</span><span class="ident" id="7988334">c</span>&nbsp;<span class="op" id="7988336">*</span><span class="ident" id="7988337">fakeConn</span><span class="op" id="7988345">)</span>&nbsp;<span class="ident" id="7988347">Begin</span><span class="op" id="7988352">(</span><span class="op" id="7988353">)</span>&nbsp;<span class="op" id="7988355">(</span><span class="ident" id="7988356">driver</span><span class="op" id="7988362">.</span><span class="ident" id="7988363">Tx</span><span class="op" id="7988365">,</span>&nbsp;<span class="builtintype" id="7988367">error</span><span class="op" id="7988372">)</span>&nbsp;<span class="op" id="7988374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988377">if</span>&nbsp;<span class="ident" id="7988380">c</span><span class="op" id="7988381">.</span><span class="ident" id="7988382">isBad</span><span class="op" id="7988387">(</span><span class="op" id="7988388">)</span>&nbsp;<span class="op" id="7988390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988394">return</span>&nbsp;<span class="builtintype" id="7988401">nil</span><span class="op" id="7988404">,</span>&nbsp;<span class="ident" id="7988406">driver</span><span class="op" id="7988412">.</span><span class="ident" id="7988413">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988428">if</span>&nbsp;<span class="ident" id="7988431">c</span><span class="op" id="7988432">.</span><span class="ident" id="7988433">currTx</span>&nbsp;<span class="op" id="7988440">!=</span>&nbsp;<span class="builtintype" id="7988443">nil</span>&nbsp;<span class="op" id="7988447">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988451">return</span>&nbsp;<span class="builtintype" id="7988458">nil</span><span class="op" id="7988461">,</span>&nbsp;<span class="ident" id="7988463">errors</span><span class="op" id="7988469">.</span><span class="ident" id="7988470">New</span><span class="op" id="7988473">(</span><span class="string" id="7988474">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7988500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7988503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988506">c</span><span class="op" id="7988507">.</span><span class="ident" id="7988508">currTx</span>&nbsp;<span class="op" id="7988515">=</span>&nbsp;<span class="op" id="7988517">&amp;</span><span class="ident" id="7988518">fakeTx</span><span class="op" id="7988524">{</span><span class="ident" id="7988525">c</span><span class="op" id="7988526">:</span>&nbsp;<span class="ident" id="7988528">c</span><span class="op" id="7988529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988532">return</span>&nbsp;<span class="ident" id="7988539">c</span><span class="op" id="7988540">.</span><span class="ident" id="7988541">currTx</span><span class="op" id="7988547">,</span>&nbsp;<span class="builtintype" id="7988549">nil</span><br>
<span class="lineno"></span><span class="op" id="7988553">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7988556">var</span>&nbsp;<span class="ident" id="7988560">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7988578">struct</span>&nbsp;<span class="op" id="7988585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988588">sync</span><span class="op" id="7988592">.</span><span class="ident" id="7988593">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988600">fn</span>&nbsp;<span class="keyword" id="7988603">func</span><span class="op" id="7988607">(</span><span class="op" id="7988608">*</span><span class="ident" id="7988609">fakeConn</span><span class="op" id="7988617">,</span>&nbsp;<span class="builtintype" id="7988619">error</span><span class="op" id="7988624">)</span><br>
<span class="lineno"></span><span class="op" id="7988626">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7988629">func</span>&nbsp;<span class="ident" id="7988634">setHookpostCloseConn</span><span class="op" id="7988654">(</span><span class="ident" id="7988655">fn</span>&nbsp;<span class="keyword" id="7988658">func</span><span class="op" id="7988662">(</span><span class="op" id="7988663">*</span><span class="ident" id="7988664">fakeConn</span><span class="op" id="7988672">,</span>&nbsp;<span class="builtintype" id="7988674">error</span><span class="op" id="7988679">)</span><span class="op" id="7988680">)</span>&nbsp;<span class="op" id="7988682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988685">hookPostCloseConn</span><span class="op" id="7988702">.</span><span class="ident" id="7988703">Lock</span><span class="op" id="7988707">(</span><span class="op" id="7988708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7988711">defer</span>&nbsp;<span class="ident" id="7988717">hookPostCloseConn</span><span class="op" id="7988734">.</span><span class="ident" id="7988735">Unlock</span><span class="op" id="7988741">(</span><span class="op" id="7988742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988745">hookPostCloseConn</span><span class="op" id="7988762">.</span><span class="ident" id="7988763">fn</span>&nbsp;<span class="op" id="7988766">=</span>&nbsp;<span class="ident" id="7988768">fn</span><br>
<span class="lineno">275</span><span class="op" id="7988771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7988774">var</span>&nbsp;<span class="ident" id="7988778">testStrictClose</span>&nbsp;<span class="op" id="7988794">*</span><span class="ident" id="7988795">testing</span><span class="op" id="7988802">.</span><span class="ident" id="7988803">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7988806">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7988876">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7988926">func</span>&nbsp;<span class="ident" id="7988931">setStrictFakeConnClose</span><span class="op" id="7988953">(</span><span class="ident" id="7988954">t</span>&nbsp;<span class="op" id="7988956">*</span><span class="ident" id="7988957">testing</span><span class="op" id="7988964">.</span><span class="ident" id="7988965">T</span><span class="op" id="7988966">)</span>&nbsp;<span class="op" id="7988968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7988971">testStrictClose</span>&nbsp;<span class="op" id="7988987">=</span>&nbsp;<span class="ident" id="7988989">t</span><br>
<span class="lineno"></span><span class="op" id="7988991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7988994">func</span>&nbsp;<span class="op" id="7988999">(</span><span class="ident" id="7989000">c</span>&nbsp;<span class="op" id="7989002">*</span><span class="ident" id="7989003">fakeConn</span><span class="op" id="7989011">)</span>&nbsp;<span class="ident" id="7989013">Close</span><span class="op" id="7989018">(</span><span class="op" id="7989019">)</span>&nbsp;<span class="op" id="7989021">(</span><span class="ident" id="7989022">err</span>&nbsp;<span class="builtintype" id="7989026">error</span><span class="op" id="7989031">)</span>&nbsp;<span class="op" id="7989033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989036">drv</span>&nbsp;<span class="op" id="7989040">:=</span>&nbsp;<span class="ident" id="7989043">fdriver</span><span class="op" id="7989050">.</span><span class="op" id="7989051">(</span><span class="op" id="7989052">*</span><span class="ident" id="7989053">fakeDriver</span><span class="op" id="7989063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989066">defer</span>&nbsp;<span class="keyword" id="7989072">func</span><span class="op" id="7989076">(</span><span class="op" id="7989077">)</span>&nbsp;<span class="op" id="7989079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989083">if</span>&nbsp;<span class="ident" id="7989086">err</span>&nbsp;<span class="op" id="7989090">!=</span>&nbsp;<span class="builtintype" id="7989093">nil</span>&nbsp;<span class="op" id="7989097">&amp;&amp;</span>&nbsp;<span class="ident" id="7989100">testStrictClose</span>&nbsp;<span class="op" id="7989116">!=</span>&nbsp;<span class="builtintype" id="7989119">nil</span>&nbsp;<span class="op" id="7989123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989128">testStrictClose</span><span class="op" id="7989143">.</span><span class="ident" id="7989144">Errorf</span><span class="op" id="7989150">(</span><span class="string" id="7989151">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7989188">,</span>&nbsp;<span class="ident" id="7989190">err</span><span class="op" id="7989193">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989201">hookPostCloseConn</span><span class="op" id="7989218">.</span><span class="ident" id="7989219">Lock</span><span class="op" id="7989223">(</span><span class="op" id="7989224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989228">fn</span>&nbsp;<span class="op" id="7989231">:=</span>&nbsp;<span class="ident" id="7989234">hookPostCloseConn</span><span class="op" id="7989251">.</span><span class="ident" id="7989252">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989257">hookPostCloseConn</span><span class="op" id="7989274">.</span><span class="ident" id="7989275">Unlock</span><span class="op" id="7989281">(</span><span class="op" id="7989282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989286">if</span>&nbsp;<span class="ident" id="7989289">fn</span>&nbsp;<span class="op" id="7989292">!=</span>&nbsp;<span class="builtintype" id="7989295">nil</span>&nbsp;<span class="op" id="7989299">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989304">fn</span><span class="op" id="7989306">(</span><span class="ident" id="7989307">c</span><span class="op" id="7989308">,</span>&nbsp;<span class="ident" id="7989310">err</span><span class="op" id="7989313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989321">if</span>&nbsp;<span class="ident" id="7989324">err</span>&nbsp;<span class="op" id="7989328">==</span>&nbsp;<span class="builtintype" id="7989331">nil</span>&nbsp;<span class="op" id="7989335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989340">drv</span><span class="op" id="7989343">.</span><span class="ident" id="7989344">mu</span><span class="op" id="7989346">.</span><span class="ident" id="7989347">Lock</span><span class="op" id="7989351">(</span><span class="op" id="7989352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989357">drv</span><span class="op" id="7989360">.</span><span class="ident" id="7989361">closeCount</span><span class="op" id="7989371">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989377">drv</span><span class="op" id="7989380">.</span><span class="ident" id="7989381">mu</span><span class="op" id="7989383">.</span><span class="ident" id="7989384">Unlock</span><span class="op" id="7989390">(</span><span class="op" id="7989391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989398">}</span><span class="op" id="7989399">(</span><span class="op" id="7989400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989403">if</span>&nbsp;<span class="ident" id="7989406">c</span><span class="op" id="7989407">.</span><span class="ident" id="7989408">currTx</span>&nbsp;<span class="op" id="7989415">!=</span>&nbsp;<span class="builtintype" id="7989418">nil</span>&nbsp;<span class="op" id="7989422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989426">return</span>&nbsp;<span class="ident" id="7989433">errors</span><span class="op" id="7989439">.</span><span class="ident" id="7989440">New</span><span class="op" id="7989443">(</span><span class="string" id="7989444">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7989484">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989490">if</span>&nbsp;<span class="ident" id="7989493">c</span><span class="op" id="7989494">.</span><span class="ident" id="7989495">db</span>&nbsp;<span class="op" id="7989498">==</span>&nbsp;<span class="builtintype" id="7989501">nil</span>&nbsp;<span class="op" id="7989505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989509">return</span>&nbsp;<span class="ident" id="7989516">errors</span><span class="op" id="7989522">.</span><span class="ident" id="7989523">New</span><span class="op" id="7989526">(</span><span class="string" id="7989527">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7989565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989571">if</span>&nbsp;<span class="ident" id="7989574">c</span><span class="op" id="7989575">.</span><span class="ident" id="7989576">stmtsMade</span>&nbsp;<span class="op" id="7989586">&gt;</span>&nbsp;<span class="ident" id="7989588">c</span><span class="op" id="7989589">.</span><span class="ident" id="7989590">stmtsClosed</span>&nbsp;<span class="op" id="7989602">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989606">return</span>&nbsp;<span class="ident" id="7989613">errors</span><span class="op" id="7989619">.</span><span class="ident" id="7989620">New</span><span class="op" id="7989623">(</span><span class="string" id="7989624">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7989660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7989666">c</span><span class="op" id="7989667">.</span><span class="ident" id="7989668">db</span>&nbsp;<span class="op" id="7989671">=</span>&nbsp;<span class="builtintype" id="7989673">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989678">return</span>&nbsp;<span class="builtintype" id="7989685">nil</span><br>
<span class="lineno"></span><span class="op" id="7989689">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7989692">func</span>&nbsp;<span class="ident" id="7989697">checkSubsetTypes</span><span class="op" id="7989713">(</span><span class="ident" id="7989714">args</span>&nbsp;<span class="op" id="7989719">[</span><span class="op" id="7989720">]</span><span class="ident" id="7989721">driver</span><span class="op" id="7989727">.</span><span class="ident" id="7989728">Value</span><span class="op" id="7989733">)</span>&nbsp;<span class="builtintype" id="7989735">error</span>&nbsp;<span class="op" id="7989741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989744">for</span>&nbsp;<span class="ident" id="7989748">n</span><span class="op" id="7989749">,</span>&nbsp;<span class="ident" id="7989751">arg</span>&nbsp;<span class="op" id="7989755">:=</span>&nbsp;<span class="keyword" id="7989758">range</span>&nbsp;<span class="ident" id="7989764">args</span>&nbsp;<span class="op" id="7989769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989773">switch</span>&nbsp;<span class="ident" id="7989780">arg</span><span class="op" id="7989783">.</span><span class="op" id="7989784">(</span><span class="keyword" id="7989785">type</span><span class="op" id="7989789">)</span>&nbsp;<span class="op" id="7989791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989795">case</span>&nbsp;<span class="ident" id="7989800">int64</span><span class="op" id="7989805">,</span>&nbsp;<span class="builtintype" id="7989807">float64</span><span class="op" id="7989814">,</span>&nbsp;<span class="builtintype" id="7989816">bool</span><span class="op" id="7989820">,</span>&nbsp;<span class="builtintype" id="7989822">nil</span><span class="op" id="7989825">,</span>&nbsp;<span class="op" id="7989827">[</span><span class="op" id="7989828">]</span><span class="builtintype" id="7989829">byte</span><span class="op" id="7989833">,</span>&nbsp;<span class="builtintype" id="7989835">string</span><span class="op" id="7989841">,</span>&nbsp;<span class="ident" id="7989843">time</span><span class="op" id="7989847">.</span><span class="ident" id="7989848">Time</span><span class="op" id="7989852">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989856">default</span><span class="op" id="7989863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989868">return</span>&nbsp;<span class="ident" id="7989875">fmt</span><span class="op" id="7989878">.</span><span class="ident" id="7989879">Errorf</span><span class="op" id="7989885">(</span><span class="string" id="7989886">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7989934">,</span>&nbsp;<span class="ident" id="7989936">n</span><span class="op" id="7989937">+</span><span class="num" id="7989938">1</span><span class="op" id="7989939">,</span>&nbsp;<span class="ident" id="7989941">arg</span><span class="op" id="7989944">,</span>&nbsp;<span class="ident" id="7989946">arg</span><span class="op" id="7989949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7989956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7989959">return</span>&nbsp;<span class="builtintype" id="7989966">nil</span><br>
<span class="lineno">325</span><span class="op" id="7989970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7989973">func</span>&nbsp;<span class="op" id="7989978">(</span><span class="ident" id="7989979">c</span>&nbsp;<span class="op" id="7989981">*</span><span class="ident" id="7989982">fakeConn</span><span class="op" id="7989990">)</span>&nbsp;<span class="ident" id="7989992">Exec</span><span class="op" id="7989996">(</span><span class="ident" id="7989997">query</span>&nbsp;<span class="builtintype" id="7990003">string</span><span class="op" id="7990009">,</span>&nbsp;<span class="ident" id="7990011">args</span>&nbsp;<span class="op" id="7990016">[</span><span class="op" id="7990017">]</span><span class="ident" id="7990018">driver</span><span class="op" id="7990024">.</span><span class="ident" id="7990025">Value</span><span class="op" id="7990030">)</span>&nbsp;<span class="op" id="7990032">(</span><span class="ident" id="7990033">driver</span><span class="op" id="7990039">.</span><span class="ident" id="7990040">Result</span><span class="op" id="7990046">,</span>&nbsp;<span class="builtintype" id="7990048">error</span><span class="op" id="7990053">)</span>&nbsp;<span class="op" id="7990055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990058">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990119">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990180">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990239">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7990266">err</span>&nbsp;<span class="op" id="7990270">:=</span>&nbsp;<span class="ident" id="7990273">checkSubsetTypes</span><span class="op" id="7990289">(</span><span class="ident" id="7990290">args</span><span class="op" id="7990294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990297">if</span>&nbsp;<span class="ident" id="7990300">err</span>&nbsp;<span class="op" id="7990304">!=</span>&nbsp;<span class="builtintype" id="7990307">nil</span>&nbsp;<span class="op" id="7990311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990315">return</span>&nbsp;<span class="builtintype" id="7990322">nil</span><span class="op" id="7990325">,</span>&nbsp;<span class="ident" id="7990327">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7990332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990335">return</span>&nbsp;<span class="builtintype" id="7990342">nil</span><span class="op" id="7990345">,</span>&nbsp;<span class="ident" id="7990347">driver</span><span class="op" id="7990353">.</span><span class="ident" id="7990354">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7990362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7990365">func</span>&nbsp;<span class="op" id="7990370">(</span><span class="ident" id="7990371">c</span>&nbsp;<span class="op" id="7990373">*</span><span class="ident" id="7990374">fakeConn</span><span class="op" id="7990382">)</span>&nbsp;<span class="ident" id="7990384">Query</span><span class="op" id="7990389">(</span><span class="ident" id="7990390">query</span>&nbsp;<span class="builtintype" id="7990396">string</span><span class="op" id="7990402">,</span>&nbsp;<span class="ident" id="7990404">args</span>&nbsp;<span class="op" id="7990409">[</span><span class="op" id="7990410">]</span><span class="ident" id="7990411">driver</span><span class="op" id="7990417">.</span><span class="ident" id="7990418">Value</span><span class="op" id="7990423">)</span>&nbsp;<span class="op" id="7990425">(</span><span class="ident" id="7990426">driver</span><span class="op" id="7990432">.</span><span class="ident" id="7990433">Rows</span><span class="op" id="7990437">,</span>&nbsp;<span class="builtintype" id="7990439">error</span><span class="op" id="7990444">)</span>&nbsp;<span class="op" id="7990446">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990449">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990510">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990571">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7990630">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7990657">err</span>&nbsp;<span class="op" id="7990661">:=</span>&nbsp;<span class="ident" id="7990664">checkSubsetTypes</span><span class="op" id="7990680">(</span><span class="ident" id="7990681">args</span><span class="op" id="7990685">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990688">if</span>&nbsp;<span class="ident" id="7990691">err</span>&nbsp;<span class="op" id="7990695">!=</span>&nbsp;<span class="builtintype" id="7990698">nil</span>&nbsp;<span class="op" id="7990702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990706">return</span>&nbsp;<span class="builtintype" id="7990713">nil</span><span class="op" id="7990716">,</span>&nbsp;<span class="ident" id="7990718">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7990723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990726">return</span>&nbsp;<span class="builtintype" id="7990733">nil</span><span class="op" id="7990736">,</span>&nbsp;<span class="ident" id="7990738">driver</span><span class="op" id="7990744">.</span><span class="ident" id="7990745">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7990753">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7990756">func</span>&nbsp;<span class="ident" id="7990761">errf</span><span class="op" id="7990765">(</span><span class="ident" id="7990766">msg</span>&nbsp;<span class="builtintype" id="7990770">string</span><span class="op" id="7990776">,</span>&nbsp;<span class="ident" id="7990778">args</span>&nbsp;<span class="op" id="7990783">...</span><span class="keyword" id="7990786">interface</span><span class="op" id="7990795">{</span><span class="op" id="7990796">}</span><span class="op" id="7990797">)</span>&nbsp;<span class="builtintype" id="7990799">error</span>&nbsp;<span class="op" id="7990805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7990808">return</span>&nbsp;<span class="ident" id="7990815">errors</span><span class="op" id="7990821">.</span><span class="ident" id="7990822">New</span><span class="op" id="7990825">(</span><span class="string" id="7990826">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7990837">+</span>&nbsp;<span class="ident" id="7990839">fmt</span><span class="op" id="7990842">.</span><span class="ident" id="7990843">Sprintf</span><span class="op" id="7990850">(</span><span class="ident" id="7990851">msg</span><span class="op" id="7990854">,</span>&nbsp;<span class="ident" id="7990856">args</span><span class="op" id="7990860">...</span><span class="op" id="7990863">)</span><span class="op" id="7990864">)</span><br>
<span class="lineno"></span><span class="op" id="7990866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7990869">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7990933">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7990990">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7991024">func</span>&nbsp;<span class="op" id="7991029">(</span><span class="ident" id="7991030">c</span>&nbsp;<span class="op" id="7991032">*</span><span class="ident" id="7991033">fakeConn</span><span class="op" id="7991041">)</span>&nbsp;<span class="ident" id="7991043">prepareSelect</span><span class="op" id="7991056">(</span><span class="ident" id="7991057">stmt</span>&nbsp;<span class="op" id="7991062">*</span><span class="ident" id="7991063">fakeStmt</span><span class="op" id="7991071">,</span>&nbsp;<span class="ident" id="7991073">parts</span>&nbsp;<span class="op" id="7991079">[</span><span class="op" id="7991080">]</span><span class="builtintype" id="7991081">string</span><span class="op" id="7991087">)</span>&nbsp;<span class="op" id="7991089">(</span><span class="ident" id="7991090">driver</span><span class="op" id="7991096">.</span><span class="ident" id="7991097">Stmt</span><span class="op" id="7991101">,</span>&nbsp;<span class="builtintype" id="7991103">error</span><span class="op" id="7991108">)</span>&nbsp;<span class="op" id="7991110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991113">if</span>&nbsp;<span class="builtinfunc" id="7991116">len</span><span class="op" id="7991119">(</span><span class="ident" id="7991120">parts</span><span class="op" id="7991125">)</span>&nbsp;<span class="op" id="7991127">!=</span>&nbsp;<span class="num" id="7991130">3</span>&nbsp;<span class="op" id="7991132">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991136">stmt</span><span class="op" id="7991140">.</span><span class="ident" id="7991141">Close</span><span class="op" id="7991146">(</span><span class="op" id="7991147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991151">return</span>&nbsp;<span class="builtintype" id="7991158">nil</span><span class="op" id="7991161">,</span>&nbsp;<span class="ident" id="7991163">errf</span><span class="op" id="7991167">(</span><span class="string" id="7991168">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7991213">,</span>&nbsp;<span class="builtinfunc" id="7991215">len</span><span class="op" id="7991218">(</span><span class="ident" id="7991219">parts</span><span class="op" id="7991224">)</span><span class="op" id="7991225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7991228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991231">stmt</span><span class="op" id="7991235">.</span><span class="ident" id="7991236">table</span>&nbsp;<span class="op" id="7991242">=</span>&nbsp;<span class="ident" id="7991244">parts</span><span class="op" id="7991249">[</span><span class="num" id="7991250">0</span><span class="op" id="7991251">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991254">stmt</span><span class="op" id="7991258">.</span><span class="ident" id="7991259">colName</span>&nbsp;<span class="op" id="7991267">=</span>&nbsp;<span class="ident" id="7991269">strings</span><span class="op" id="7991276">.</span><span class="ident" id="7991277">Split</span><span class="op" id="7991282">(</span><span class="ident" id="7991283">parts</span><span class="op" id="7991288">[</span><span class="num" id="7991289">1</span><span class="op" id="7991290">]</span><span class="op" id="7991291">,</span>&nbsp;<span class="string" id="7991293">&#34;,&#34;</span><span class="op" id="7991296">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991299">for</span>&nbsp;<span class="ident" id="7991303">n</span><span class="op" id="7991304">,</span>&nbsp;<span class="ident" id="7991306">colspec</span>&nbsp;<span class="op" id="7991314">:=</span>&nbsp;<span class="keyword" id="7991317">range</span>&nbsp;<span class="ident" id="7991323">strings</span><span class="op" id="7991330">.</span><span class="ident" id="7991331">Split</span><span class="op" id="7991336">(</span><span class="ident" id="7991337">parts</span><span class="op" id="7991342">[</span><span class="num" id="7991343">2</span><span class="op" id="7991344">]</span><span class="op" id="7991345">,</span>&nbsp;<span class="string" id="7991347">&#34;,&#34;</span><span class="op" id="7991350">)</span>&nbsp;<span class="op" id="7991352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991356">if</span>&nbsp;<span class="ident" id="7991359">colspec</span>&nbsp;<span class="op" id="7991367">==</span>&nbsp;<span class="string" id="7991370">&#34;&#34;</span>&nbsp;<span class="op" id="7991373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991378">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7991389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991393">nameVal</span>&nbsp;<span class="op" id="7991401">:=</span>&nbsp;<span class="ident" id="7991404">strings</span><span class="op" id="7991411">.</span><span class="ident" id="7991412">Split</span><span class="op" id="7991417">(</span><span class="ident" id="7991418">colspec</span><span class="op" id="7991425">,</span>&nbsp;<span class="string" id="7991427">&#34;=&#34;</span><span class="op" id="7991430">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991434">if</span>&nbsp;<span class="builtinfunc" id="7991437">len</span><span class="op" id="7991440">(</span><span class="ident" id="7991441">nameVal</span><span class="op" id="7991448">)</span>&nbsp;<span class="op" id="7991450">!=</span>&nbsp;<span class="num" id="7991453">2</span>&nbsp;<span class="op" id="7991455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991460">stmt</span><span class="op" id="7991464">.</span><span class="ident" id="7991465">Close</span><span class="op" id="7991470">(</span><span class="op" id="7991471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991476">return</span>&nbsp;<span class="builtintype" id="7991483">nil</span><span class="op" id="7991486">,</span>&nbsp;<span class="ident" id="7991488">errf</span><span class="op" id="7991492">(</span><span class="string" id="7991493">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7991554">,</span>&nbsp;<span class="ident" id="7991556">stmt</span><span class="op" id="7991560">.</span><span class="ident" id="7991561">table</span><span class="op" id="7991566">,</span>&nbsp;<span class="ident" id="7991568">colspec</span><span class="op" id="7991575">,</span>&nbsp;<span class="ident" id="7991577">n</span><span class="op" id="7991578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7991582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991586">column</span><span class="op" id="7991592">,</span>&nbsp;<span class="ident" id="7991594">value</span>&nbsp;<span class="op" id="7991600">:=</span>&nbsp;<span class="ident" id="7991603">nameVal</span><span class="op" id="7991610">[</span><span class="num" id="7991611">0</span><span class="op" id="7991612">]</span><span class="op" id="7991613">,</span>&nbsp;<span class="ident" id="7991615">nameVal</span><span class="op" id="7991622">[</span><span class="num" id="7991623">1</span><span class="op" id="7991624">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991628">_</span><span class="op" id="7991629">,</span>&nbsp;<span class="ident" id="7991631">ok</span>&nbsp;<span class="op" id="7991634">:=</span>&nbsp;<span class="ident" id="7991637">c</span><span class="op" id="7991638">.</span><span class="ident" id="7991639">db</span><span class="op" id="7991641">.</span><span class="ident" id="7991642">columnType</span><span class="op" id="7991652">(</span><span class="ident" id="7991653">stmt</span><span class="op" id="7991657">.</span><span class="ident" id="7991658">table</span><span class="op" id="7991663">,</span>&nbsp;<span class="ident" id="7991665">column</span><span class="op" id="7991671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991675">if</span>&nbsp;<span class="op" id="7991678">!</span><span class="ident" id="7991679">ok</span>&nbsp;<span class="op" id="7991682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991687">stmt</span><span class="op" id="7991691">.</span><span class="ident" id="7991692">Close</span><span class="op" id="7991697">(</span><span class="op" id="7991698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991703">return</span>&nbsp;<span class="builtintype" id="7991710">nil</span><span class="op" id="7991713">,</span>&nbsp;<span class="ident" id="7991715">errf</span><span class="op" id="7991719">(</span><span class="string" id="7991720">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7991774">,</span>&nbsp;<span class="ident" id="7991776">stmt</span><span class="op" id="7991780">.</span><span class="ident" id="7991781">table</span><span class="op" id="7991786">,</span>&nbsp;<span class="ident" id="7991788">column</span><span class="op" id="7991794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7991798">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991802">if</span>&nbsp;<span class="ident" id="7991805">value</span>&nbsp;<span class="op" id="7991811">!=</span>&nbsp;<span class="string" id="7991814">&#34;?&#34;</span>&nbsp;<span class="op" id="7991818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991823">stmt</span><span class="op" id="7991827">.</span><span class="ident" id="7991828">Close</span><span class="op" id="7991833">(</span><span class="op" id="7991834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7991839">return</span>&nbsp;<span class="builtintype" id="7991846">nil</span><span class="op" id="7991849">,</span>&nbsp;<span class="ident" id="7991851">errf</span><span class="op" id="7991855">(</span><span class="string" id="7991856">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7991938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991944">stmt</span><span class="op" id="7991948">.</span><span class="ident" id="7991949">table</span><span class="op" id="7991954">,</span>&nbsp;<span class="ident" id="7991956">column</span><span class="op" id="7991962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7991966">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7991970">stmt</span><span class="op" id="7991974">.</span><span class="ident" id="7991975">whereCol</span>&nbsp;<span class="op" id="7991984">=</span>&nbsp;<span class="builtinfunc" id="7991986">append</span><span class="op" id="7991992">(</span><span class="ident" id="7991993">stmt</span><span class="op" id="7991997">.</span><span class="ident" id="7991998">whereCol</span><span class="op" id="7992006">,</span>&nbsp;<span class="ident" id="7992008">column</span><span class="op" id="7992014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992018">stmt</span><span class="op" id="7992022">.</span><span class="ident" id="7992023">placeholders</span><span class="op" id="7992035">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7992039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992042">return</span>&nbsp;<span class="ident" id="7992049">stmt</span><span class="op" id="7992053">,</span>&nbsp;<span class="builtintype" id="7992055">nil</span><br>
<span class="lineno"></span><span class="op" id="7992059">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7992062">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7992101">func</span>&nbsp;<span class="op" id="7992106">(</span><span class="ident" id="7992107">c</span>&nbsp;<span class="op" id="7992109">*</span><span class="ident" id="7992110">fakeConn</span><span class="op" id="7992118">)</span>&nbsp;<span class="ident" id="7992120">prepareCreate</span><span class="op" id="7992133">(</span><span class="ident" id="7992134">stmt</span>&nbsp;<span class="op" id="7992139">*</span><span class="ident" id="7992140">fakeStmt</span><span class="op" id="7992148">,</span>&nbsp;<span class="ident" id="7992150">parts</span>&nbsp;<span class="op" id="7992156">[</span><span class="op" id="7992157">]</span><span class="builtintype" id="7992158">string</span><span class="op" id="7992164">)</span>&nbsp;<span class="op" id="7992166">(</span><span class="ident" id="7992167">driver</span><span class="op" id="7992173">.</span><span class="ident" id="7992174">Stmt</span><span class="op" id="7992178">,</span>&nbsp;<span class="builtintype" id="7992180">error</span><span class="op" id="7992185">)</span>&nbsp;<span class="op" id="7992187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992190">if</span>&nbsp;<span class="builtinfunc" id="7992193">len</span><span class="op" id="7992196">(</span><span class="ident" id="7992197">parts</span><span class="op" id="7992202">)</span>&nbsp;<span class="op" id="7992204">!=</span>&nbsp;<span class="num" id="7992207">2</span>&nbsp;<span class="op" id="7992209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992213">stmt</span><span class="op" id="7992217">.</span><span class="ident" id="7992218">Close</span><span class="op" id="7992223">(</span><span class="op" id="7992224">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992228">return</span>&nbsp;<span class="builtintype" id="7992235">nil</span><span class="op" id="7992238">,</span>&nbsp;<span class="ident" id="7992240">errf</span><span class="op" id="7992244">(</span><span class="string" id="7992245">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7992290">,</span>&nbsp;<span class="builtinfunc" id="7992292">len</span><span class="op" id="7992295">(</span><span class="ident" id="7992296">parts</span><span class="op" id="7992301">)</span><span class="op" id="7992302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7992305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992308">stmt</span><span class="op" id="7992312">.</span><span class="ident" id="7992313">table</span>&nbsp;<span class="op" id="7992319">=</span>&nbsp;<span class="ident" id="7992321">parts</span><span class="op" id="7992326">[</span><span class="num" id="7992327">0</span><span class="op" id="7992328">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992331">for</span>&nbsp;<span class="ident" id="7992335">n</span><span class="op" id="7992336">,</span>&nbsp;<span class="ident" id="7992338">colspec</span>&nbsp;<span class="op" id="7992346">:=</span>&nbsp;<span class="keyword" id="7992349">range</span>&nbsp;<span class="ident" id="7992355">strings</span><span class="op" id="7992362">.</span><span class="ident" id="7992363">Split</span><span class="op" id="7992368">(</span><span class="ident" id="7992369">parts</span><span class="op" id="7992374">[</span><span class="num" id="7992375">1</span><span class="op" id="7992376">]</span><span class="op" id="7992377">,</span>&nbsp;<span class="string" id="7992379">&#34;,&#34;</span><span class="op" id="7992382">)</span>&nbsp;<span class="op" id="7992384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992388">nameType</span>&nbsp;<span class="op" id="7992397">:=</span>&nbsp;<span class="ident" id="7992400">strings</span><span class="op" id="7992407">.</span><span class="ident" id="7992408">Split</span><span class="op" id="7992413">(</span><span class="ident" id="7992414">colspec</span><span class="op" id="7992421">,</span>&nbsp;<span class="string" id="7992423">&#34;=&#34;</span><span class="op" id="7992426">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992430">if</span>&nbsp;<span class="builtinfunc" id="7992433">len</span><span class="op" id="7992436">(</span><span class="ident" id="7992437">nameType</span><span class="op" id="7992445">)</span>&nbsp;<span class="op" id="7992447">!=</span>&nbsp;<span class="num" id="7992450">2</span>&nbsp;<span class="op" id="7992452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992457">stmt</span><span class="op" id="7992461">.</span><span class="ident" id="7992462">Close</span><span class="op" id="7992467">(</span><span class="op" id="7992468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992473">return</span>&nbsp;<span class="builtintype" id="7992480">nil</span><span class="op" id="7992483">,</span>&nbsp;<span class="ident" id="7992485">errf</span><span class="op" id="7992489">(</span><span class="string" id="7992490">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7992548">,</span>&nbsp;<span class="ident" id="7992550">stmt</span><span class="op" id="7992554">.</span><span class="ident" id="7992555">table</span><span class="op" id="7992560">,</span>&nbsp;<span class="ident" id="7992562">colspec</span><span class="op" id="7992569">,</span>&nbsp;<span class="ident" id="7992571">n</span><span class="op" id="7992572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7992576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992580">stmt</span><span class="op" id="7992584">.</span><span class="ident" id="7992585">colName</span>&nbsp;<span class="op" id="7992593">=</span>&nbsp;<span class="builtinfunc" id="7992595">append</span><span class="op" id="7992601">(</span><span class="ident" id="7992602">stmt</span><span class="op" id="7992606">.</span><span class="ident" id="7992607">colName</span><span class="op" id="7992614">,</span>&nbsp;<span class="ident" id="7992616">nameType</span><span class="op" id="7992624">[</span><span class="num" id="7992625">0</span><span class="op" id="7992626">]</span><span class="op" id="7992627">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992631">stmt</span><span class="op" id="7992635">.</span><span class="ident" id="7992636">colType</span>&nbsp;<span class="op" id="7992644">=</span>&nbsp;<span class="builtinfunc" id="7992646">append</span><span class="op" id="7992652">(</span><span class="ident" id="7992653">stmt</span><span class="op" id="7992657">.</span><span class="ident" id="7992658">colType</span><span class="op" id="7992665">,</span>&nbsp;<span class="ident" id="7992667">nameType</span><span class="op" id="7992675">[</span><span class="num" id="7992676">1</span><span class="op" id="7992677">]</span><span class="op" id="7992678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7992681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992684">return</span>&nbsp;<span class="ident" id="7992691">stmt</span><span class="op" id="7992695">,</span>&nbsp;<span class="builtintype" id="7992697">nil</span><br>
<span class="lineno"></span><span class="op" id="7992701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7992704">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7992738">func</span>&nbsp;<span class="op" id="7992743">(</span><span class="ident" id="7992744">c</span>&nbsp;<span class="op" id="7992746">*</span><span class="ident" id="7992747">fakeConn</span><span class="op" id="7992755">)</span>&nbsp;<span class="ident" id="7992757">prepareInsert</span><span class="op" id="7992770">(</span><span class="ident" id="7992771">stmt</span>&nbsp;<span class="op" id="7992776">*</span><span class="ident" id="7992777">fakeStmt</span><span class="op" id="7992785">,</span>&nbsp;<span class="ident" id="7992787">parts</span>&nbsp;<span class="op" id="7992793">[</span><span class="op" id="7992794">]</span><span class="builtintype" id="7992795">string</span><span class="op" id="7992801">)</span>&nbsp;<span class="op" id="7992803">(</span><span class="ident" id="7992804">driver</span><span class="op" id="7992810">.</span><span class="ident" id="7992811">Stmt</span><span class="op" id="7992815">,</span>&nbsp;<span class="builtintype" id="7992817">error</span><span class="op" id="7992822">)</span>&nbsp;<span class="op" id="7992824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992827">if</span>&nbsp;<span class="builtinfunc" id="7992830">len</span><span class="op" id="7992833">(</span><span class="ident" id="7992834">parts</span><span class="op" id="7992839">)</span>&nbsp;<span class="op" id="7992841">!=</span>&nbsp;<span class="num" id="7992844">2</span>&nbsp;<span class="op" id="7992846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992850">stmt</span><span class="op" id="7992854">.</span><span class="ident" id="7992855">Close</span><span class="op" id="7992860">(</span><span class="op" id="7992861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992865">return</span>&nbsp;<span class="builtintype" id="7992872">nil</span><span class="op" id="7992875">,</span>&nbsp;<span class="ident" id="7992877">errf</span><span class="op" id="7992881">(</span><span class="string" id="7992882">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7992927">,</span>&nbsp;<span class="builtinfunc" id="7992929">len</span><span class="op" id="7992932">(</span><span class="ident" id="7992933">parts</span><span class="op" id="7992938">)</span><span class="op" id="7992939">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7992942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7992945">stmt</span><span class="op" id="7992949">.</span><span class="ident" id="7992950">table</span>&nbsp;<span class="op" id="7992956">=</span>&nbsp;<span class="ident" id="7992958">parts</span><span class="op" id="7992963">[</span><span class="num" id="7992964">0</span><span class="op" id="7992965">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7992968">for</span>&nbsp;<span class="ident" id="7992972">n</span><span class="op" id="7992973">,</span>&nbsp;<span class="ident" id="7992975">colspec</span>&nbsp;<span class="op" id="7992983">:=</span>&nbsp;<span class="keyword" id="7992986">range</span>&nbsp;<span class="ident" id="7992992">strings</span><span class="op" id="7992999">.</span><span class="ident" id="7993000">Split</span><span class="op" id="7993005">(</span><span class="ident" id="7993006">parts</span><span class="op" id="7993011">[</span><span class="num" id="7993012">1</span><span class="op" id="7993013">]</span><span class="op" id="7993014">,</span>&nbsp;<span class="string" id="7993016">&#34;,&#34;</span><span class="op" id="7993019">)</span>&nbsp;<span class="op" id="7993021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993025">nameVal</span>&nbsp;<span class="op" id="7993033">:=</span>&nbsp;<span class="ident" id="7993036">strings</span><span class="op" id="7993043">.</span><span class="ident" id="7993044">Split</span><span class="op" id="7993049">(</span><span class="ident" id="7993050">colspec</span><span class="op" id="7993057">,</span>&nbsp;<span class="string" id="7993059">&#34;=&#34;</span><span class="op" id="7993062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993066">if</span>&nbsp;<span class="builtinfunc" id="7993069">len</span><span class="op" id="7993072">(</span><span class="ident" id="7993073">nameVal</span><span class="op" id="7993080">)</span>&nbsp;<span class="op" id="7993082">!=</span>&nbsp;<span class="num" id="7993085">2</span>&nbsp;<span class="op" id="7993087">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993092">stmt</span><span class="op" id="7993096">.</span><span class="ident" id="7993097">Close</span><span class="op" id="7993102">(</span><span class="op" id="7993103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993108">return</span>&nbsp;<span class="builtintype" id="7993115">nil</span><span class="op" id="7993118">,</span>&nbsp;<span class="ident" id="7993120">errf</span><span class="op" id="7993124">(</span><span class="string" id="7993125">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7993183">,</span>&nbsp;<span class="ident" id="7993185">stmt</span><span class="op" id="7993189">.</span><span class="ident" id="7993190">table</span><span class="op" id="7993195">,</span>&nbsp;<span class="ident" id="7993197">colspec</span><span class="op" id="7993204">,</span>&nbsp;<span class="ident" id="7993206">n</span><span class="op" id="7993207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7993211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993215">column</span><span class="op" id="7993221">,</span>&nbsp;<span class="ident" id="7993223">value</span>&nbsp;<span class="op" id="7993229">:=</span>&nbsp;<span class="ident" id="7993232">nameVal</span><span class="op" id="7993239">[</span><span class="num" id="7993240">0</span><span class="op" id="7993241">]</span><span class="op" id="7993242">,</span>&nbsp;<span class="ident" id="7993244">nameVal</span><span class="op" id="7993251">[</span><span class="num" id="7993252">1</span><span class="op" id="7993253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993257">ctype</span><span class="op" id="7993262">,</span>&nbsp;<span class="ident" id="7993264">ok</span>&nbsp;<span class="op" id="7993267">:=</span>&nbsp;<span class="ident" id="7993270">c</span><span class="op" id="7993271">.</span><span class="ident" id="7993272">db</span><span class="op" id="7993274">.</span><span class="ident" id="7993275">columnType</span><span class="op" id="7993285">(</span><span class="ident" id="7993286">stmt</span><span class="op" id="7993290">.</span><span class="ident" id="7993291">table</span><span class="op" id="7993296">,</span>&nbsp;<span class="ident" id="7993298">column</span><span class="op" id="7993304">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993308">if</span>&nbsp;<span class="op" id="7993311">!</span><span class="ident" id="7993312">ok</span>&nbsp;<span class="op" id="7993315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993320">stmt</span><span class="op" id="7993324">.</span><span class="ident" id="7993325">Close</span><span class="op" id="7993330">(</span><span class="op" id="7993331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993336">return</span>&nbsp;<span class="builtintype" id="7993343">nil</span><span class="op" id="7993346">,</span>&nbsp;<span class="ident" id="7993348">errf</span><span class="op" id="7993352">(</span><span class="string" id="7993353">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7993404">,</span>&nbsp;<span class="ident" id="7993406">stmt</span><span class="op" id="7993410">.</span><span class="ident" id="7993411">table</span><span class="op" id="7993416">,</span>&nbsp;<span class="ident" id="7993418">column</span><span class="op" id="7993424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7993428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993432">stmt</span><span class="op" id="7993436">.</span><span class="ident" id="7993437">colName</span>&nbsp;<span class="op" id="7993445">=</span>&nbsp;<span class="builtinfunc" id="7993447">append</span><span class="op" id="7993453">(</span><span class="ident" id="7993454">stmt</span><span class="op" id="7993458">.</span><span class="ident" id="7993459">colName</span><span class="op" id="7993466">,</span>&nbsp;<span class="ident" id="7993468">column</span><span class="op" id="7993474">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993479">if</span>&nbsp;<span class="ident" id="7993482">value</span>&nbsp;<span class="op" id="7993488">!=</span>&nbsp;<span class="string" id="7993491">&#34;?&#34;</span>&nbsp;<span class="op" id="7993495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993500">var</span>&nbsp;<span class="ident" id="7993504">subsetVal</span>&nbsp;<span class="keyword" id="7993514">interface</span><span class="op" id="7993523">{</span><span class="op" id="7993524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7993529">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993565">switch</span>&nbsp;<span class="ident" id="7993572">ctype</span>&nbsp;<span class="op" id="7993578">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993583">case</span>&nbsp;<span class="string" id="7993588">&#34;string&#34;</span><span class="op" id="7993596">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993602">subsetVal</span>&nbsp;<span class="op" id="7993612">=</span>&nbsp;<span class="op" id="7993614">[</span><span class="op" id="7993615">]</span><span class="builtintype" id="7993616">byte</span><span class="op" id="7993620">(</span><span class="ident" id="7993621">value</span><span class="op" id="7993626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993631">case</span>&nbsp;<span class="string" id="7993636">&#34;blob&#34;</span><span class="op" id="7993642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993648">subsetVal</span>&nbsp;<span class="op" id="7993658">=</span>&nbsp;<span class="op" id="7993660">[</span><span class="op" id="7993661">]</span><span class="builtintype" id="7993662">byte</span><span class="op" id="7993666">(</span><span class="ident" id="7993667">value</span><span class="op" id="7993672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993677">case</span>&nbsp;<span class="string" id="7993682">&#34;int32&#34;</span><span class="op" id="7993689">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993695">i</span><span class="op" id="7993696">,</span>&nbsp;<span class="ident" id="7993698">err</span>&nbsp;<span class="op" id="7993702">:=</span>&nbsp;<span class="ident" id="7993705">strconv</span><span class="op" id="7993712">.</span><span class="ident" id="7993713">Atoi</span><span class="op" id="7993717">(</span><span class="ident" id="7993718">value</span><span class="op" id="7993723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993729">if</span>&nbsp;<span class="ident" id="7993732">err</span>&nbsp;<span class="op" id="7993736">!=</span>&nbsp;<span class="builtintype" id="7993739">nil</span>&nbsp;<span class="op" id="7993743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993750">stmt</span><span class="op" id="7993754">.</span><span class="ident" id="7993755">Close</span><span class="op" id="7993760">(</span><span class="op" id="7993761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993768">return</span>&nbsp;<span class="builtintype" id="7993775">nil</span><span class="op" id="7993778">,</span>&nbsp;<span class="ident" id="7993780">errf</span><span class="op" id="7993784">(</span><span class="string" id="7993785">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7993822">,</span>&nbsp;<span class="ident" id="7993824">value</span><span class="op" id="7993829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7993835">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993841">subsetVal</span>&nbsp;<span class="op" id="7993851">=</span>&nbsp;<span class="ident" id="7993853">int64</span><span class="op" id="7993858">(</span><span class="ident" id="7993859">i</span><span class="op" id="7993860">)</span>&nbsp;<span class="comment" id="7993862">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993906">default</span><span class="op" id="7993913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7993919">stmt</span><span class="op" id="7993923">.</span><span class="ident" id="7993924">Close</span><span class="op" id="7993929">(</span><span class="op" id="7993930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7993936">return</span>&nbsp;<span class="builtintype" id="7993943">nil</span><span class="op" id="7993946">,</span>&nbsp;<span class="ident" id="7993948">errf</span><span class="op" id="7993952">(</span><span class="string" id="7993953">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7994015">,</span>&nbsp;<span class="ident" id="7994017">value</span><span class="op" id="7994022">,</span>&nbsp;<span class="ident" id="7994024">ctype</span><span class="op" id="7994029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994034">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994039">stmt</span><span class="op" id="7994043">.</span><span class="ident" id="7994044">colValue</span>&nbsp;<span class="op" id="7994053">=</span>&nbsp;<span class="builtinfunc" id="7994055">append</span><span class="op" id="7994061">(</span><span class="ident" id="7994062">stmt</span><span class="op" id="7994066">.</span><span class="ident" id="7994067">colValue</span><span class="op" id="7994075">,</span>&nbsp;<span class="ident" id="7994077">subsetVal</span><span class="op" id="7994086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994090">}</span>&nbsp;<span class="keyword" id="7994092">else</span>&nbsp;<span class="op" id="7994097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994102">stmt</span><span class="op" id="7994106">.</span><span class="ident" id="7994107">placeholders</span><span class="op" id="7994119">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994125">stmt</span><span class="op" id="7994129">.</span><span class="ident" id="7994130">placeholderConverter</span>&nbsp;<span class="op" id="7994151">=</span>&nbsp;<span class="builtinfunc" id="7994153">append</span><span class="op" id="7994159">(</span><span class="ident" id="7994160">stmt</span><span class="op" id="7994164">.</span><span class="ident" id="7994165">placeholderConverter</span><span class="op" id="7994185">,</span>&nbsp;<span class="ident" id="7994187">converterForType</span><span class="op" id="7994203">(</span><span class="ident" id="7994204">ctype</span><span class="op" id="7994209">)</span><span class="op" id="7994210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994215">stmt</span><span class="op" id="7994219">.</span><span class="ident" id="7994220">colValue</span>&nbsp;<span class="op" id="7994229">=</span>&nbsp;<span class="builtinfunc" id="7994231">append</span><span class="op" id="7994237">(</span><span class="ident" id="7994238">stmt</span><span class="op" id="7994242">.</span><span class="ident" id="7994243">colValue</span><span class="op" id="7994251">,</span>&nbsp;<span class="string" id="7994253">&#34;?&#34;</span><span class="op" id="7994256">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994266">return</span>&nbsp;<span class="ident" id="7994273">stmt</span><span class="op" id="7994277">,</span>&nbsp;<span class="builtintype" id="7994279">nil</span><br>
<span class="lineno"></span><span class="op" id="7994283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7994286">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7994325">var</span>&nbsp;<span class="ident" id="7994329">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7994348">func</span><span class="op" id="7994352">(</span><span class="op" id="7994353">)</span>&nbsp;<span class="builtintype" id="7994355">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7994361">func</span>&nbsp;<span class="op" id="7994366">(</span><span class="ident" id="7994367">c</span>&nbsp;<span class="op" id="7994369">*</span><span class="ident" id="7994370">fakeConn</span><span class="op" id="7994378">)</span>&nbsp;<span class="ident" id="7994380">Prepare</span><span class="op" id="7994387">(</span><span class="ident" id="7994388">query</span>&nbsp;<span class="builtintype" id="7994394">string</span><span class="op" id="7994400">)</span>&nbsp;<span class="op" id="7994402">(</span><span class="ident" id="7994403">driver</span><span class="op" id="7994409">.</span><span class="ident" id="7994410">Stmt</span><span class="op" id="7994414">,</span>&nbsp;<span class="builtintype" id="7994416">error</span><span class="op" id="7994421">)</span>&nbsp;<span class="op" id="7994423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994426">c</span><span class="op" id="7994427">.</span><span class="ident" id="7994428">numPrepare</span><span class="op" id="7994438">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994442">if</span>&nbsp;<span class="ident" id="7994445">c</span><span class="op" id="7994446">.</span><span class="ident" id="7994447">db</span>&nbsp;<span class="op" id="7994450">==</span>&nbsp;<span class="builtintype" id="7994453">nil</span>&nbsp;<span class="op" id="7994457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7994461">panic</span><span class="op" id="7994466">(</span><span class="string" id="7994467">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7994487">+</span>&nbsp;<span class="ident" id="7994489">fmt</span><span class="op" id="7994492">.</span><span class="ident" id="7994493">Sprintf</span><span class="op" id="7994500">(</span><span class="string" id="7994501">&#34;%#v&#34;</span><span class="op" id="7994506">,</span>&nbsp;<span class="ident" id="7994508">c</span><span class="op" id="7994509">)</span><span class="op" id="7994510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994517">if</span>&nbsp;<span class="ident" id="7994520">hookPrepareBadConn</span>&nbsp;<span class="op" id="7994539">!=</span>&nbsp;<span class="builtintype" id="7994542">nil</span>&nbsp;<span class="op" id="7994546">&amp;&amp;</span>&nbsp;<span class="ident" id="7994549">hookPrepareBadConn</span><span class="op" id="7994567">(</span><span class="op" id="7994568">)</span>&nbsp;<span class="op" id="7994570">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994574">return</span>&nbsp;<span class="builtintype" id="7994581">nil</span><span class="op" id="7994584">,</span>&nbsp;<span class="ident" id="7994586">driver</span><span class="op" id="7994592">.</span><span class="ident" id="7994593">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994609">parts</span>&nbsp;<span class="op" id="7994615">:=</span>&nbsp;<span class="ident" id="7994618">strings</span><span class="op" id="7994625">.</span><span class="ident" id="7994626">Split</span><span class="op" id="7994631">(</span><span class="ident" id="7994632">query</span><span class="op" id="7994637">,</span>&nbsp;<span class="string" id="7994639">&#34;|&#34;</span><span class="op" id="7994642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994645">if</span>&nbsp;<span class="builtinfunc" id="7994648">len</span><span class="op" id="7994651">(</span><span class="ident" id="7994652">parts</span><span class="op" id="7994657">)</span>&nbsp;<span class="op" id="7994659">&lt;</span>&nbsp;<span class="num" id="7994661">1</span>&nbsp;<span class="op" id="7994663">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994667">return</span>&nbsp;<span class="builtintype" id="7994674">nil</span><span class="op" id="7994677">,</span>&nbsp;<span class="ident" id="7994679">errf</span><span class="op" id="7994683">(</span><span class="string" id="7994684">&#34;empty&nbsp;query&#34;</span><span class="op" id="7994697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7994700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994703">cmd</span>&nbsp;<span class="op" id="7994707">:=</span>&nbsp;<span class="ident" id="7994710">parts</span><span class="op" id="7994715">[</span><span class="num" id="7994716">0</span><span class="op" id="7994717">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994720">parts</span>&nbsp;<span class="op" id="7994726">=</span>&nbsp;<span class="ident" id="7994728">parts</span><span class="op" id="7994733">[</span><span class="num" id="7994734">1</span><span class="op" id="7994735">:</span><span class="op" id="7994736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994739">stmt</span>&nbsp;<span class="op" id="7994744">:=</span>&nbsp;<span class="op" id="7994747">&amp;</span><span class="ident" id="7994748">fakeStmt</span><span class="op" id="7994756">{</span><span class="ident" id="7994757">q</span><span class="op" id="7994758">:</span>&nbsp;<span class="ident" id="7994760">query</span><span class="op" id="7994765">,</span>&nbsp;<span class="ident" id="7994767">c</span><span class="op" id="7994768">:</span>&nbsp;<span class="ident" id="7994770">c</span><span class="op" id="7994771">,</span>&nbsp;<span class="ident" id="7994773">cmd</span><span class="op" id="7994776">:</span>&nbsp;<span class="ident" id="7994778">cmd</span><span class="op" id="7994781">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7994784">c</span><span class="op" id="7994785">.</span><span class="ident" id="7994786">incrStat</span><span class="op" id="7994794">(</span><span class="op" id="7994795">&amp;</span><span class="ident" id="7994796">c</span><span class="op" id="7994797">.</span><span class="ident" id="7994798">stmtsMade</span><span class="op" id="7994807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994810">switch</span>&nbsp;<span class="ident" id="7994817">cmd</span>&nbsp;<span class="op" id="7994821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994824">case</span>&nbsp;<span class="string" id="7994829">&#34;WIPE&#34;</span><span class="op" id="7994835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7994839">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994851">case</span>&nbsp;<span class="string" id="7994856">&#34;SELECT&#34;</span><span class="op" id="7994864">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994868">return</span>&nbsp;<span class="ident" id="7994875">c</span><span class="op" id="7994876">.</span><span class="ident" id="7994877">prepareSelect</span><span class="op" id="7994890">(</span><span class="ident" id="7994891">stmt</span><span class="op" id="7994895">,</span>&nbsp;<span class="ident" id="7994897">parts</span><span class="op" id="7994902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994905">case</span>&nbsp;<span class="string" id="7994910">&#34;CREATE&#34;</span><span class="op" id="7994918">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994922">return</span>&nbsp;<span class="ident" id="7994929">c</span><span class="op" id="7994930">.</span><span class="ident" id="7994931">prepareCreate</span><span class="op" id="7994944">(</span><span class="ident" id="7994945">stmt</span><span class="op" id="7994949">,</span>&nbsp;<span class="ident" id="7994951">parts</span><span class="op" id="7994956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994959">case</span>&nbsp;<span class="string" id="7994964">&#34;INSERT&#34;</span><span class="op" id="7994972">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7994976">return</span>&nbsp;<span class="ident" id="7994983">c</span><span class="op" id="7994984">.</span><span class="ident" id="7994985">prepareInsert</span><span class="op" id="7994998">(</span><span class="ident" id="7994999">stmt</span><span class="op" id="7995003">,</span>&nbsp;<span class="ident" id="7995005">parts</span><span class="op" id="7995010">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995013">case</span>&nbsp;<span class="string" id="7995018">&#34;NOSERT&#34;</span><span class="op" id="7995026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7995030">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7995110">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995154">return</span>&nbsp;<span class="ident" id="7995161">c</span><span class="op" id="7995162">.</span><span class="ident" id="7995163">prepareInsert</span><span class="op" id="7995176">(</span><span class="ident" id="7995177">stmt</span><span class="op" id="7995181">,</span>&nbsp;<span class="ident" id="7995183">parts</span><span class="op" id="7995188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995191">default</span><span class="op" id="7995198">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7995202">stmt</span><span class="op" id="7995206">.</span><span class="ident" id="7995207">Close</span><span class="op" id="7995212">(</span><span class="op" id="7995213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995217">return</span>&nbsp;<span class="builtintype" id="7995224">nil</span><span class="op" id="7995227">,</span>&nbsp;<span class="ident" id="7995229">errf</span><span class="op" id="7995233">(</span><span class="string" id="7995234">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7995263">,</span>&nbsp;<span class="ident" id="7995265">cmd</span><span class="op" id="7995268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995274">return</span>&nbsp;<span class="ident" id="7995281">stmt</span><span class="op" id="7995285">,</span>&nbsp;<span class="builtintype" id="7995287">nil</span><br>
<span class="lineno"></span><span class="op" id="7995291">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7995294">func</span>&nbsp;<span class="op" id="7995299">(</span><span class="ident" id="7995300">s</span>&nbsp;<span class="op" id="7995302">*</span><span class="ident" id="7995303">fakeStmt</span><span class="op" id="7995311">)</span>&nbsp;<span class="ident" id="7995313">ColumnConverter</span><span class="op" id="7995328">(</span><span class="ident" id="7995329">idx</span>&nbsp;<span class="builtintype" id="7995333">int</span><span class="op" id="7995336">)</span>&nbsp;<span class="ident" id="7995338">driver</span><span class="op" id="7995344">.</span><span class="ident" id="7995345">ValueConverter</span>&nbsp;<span class="op" id="7995360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995363">if</span>&nbsp;<span class="builtinfunc" id="7995366">len</span><span class="op" id="7995369">(</span><span class="ident" id="7995370">s</span><span class="op" id="7995371">.</span><span class="ident" id="7995372">placeholderConverter</span><span class="op" id="7995392">)</span>&nbsp;<span class="op" id="7995394">==</span>&nbsp;<span class="num" id="7995397">0</span>&nbsp;<span class="op" id="7995399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995403">return</span>&nbsp;<span class="ident" id="7995410">driver</span><span class="op" id="7995416">.</span><span class="ident" id="7995417">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995444">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995447">return</span>&nbsp;<span class="ident" id="7995454">s</span><span class="op" id="7995455">.</span><span class="ident" id="7995456">placeholderConverter</span><span class="op" id="7995476">[</span><span class="ident" id="7995477">idx</span><span class="op" id="7995480">]</span><br>
<span class="lineno"></span><span class="op" id="7995482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7995485">func</span>&nbsp;<span class="op" id="7995490">(</span><span class="ident" id="7995491">s</span>&nbsp;<span class="op" id="7995493">*</span><span class="ident" id="7995494">fakeStmt</span><span class="op" id="7995502">)</span>&nbsp;<span class="ident" id="7995504">Close</span><span class="op" id="7995509">(</span><span class="op" id="7995510">)</span>&nbsp;<span class="builtintype" id="7995512">error</span>&nbsp;<span class="op" id="7995518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995521">if</span>&nbsp;<span class="ident" id="7995524">s</span><span class="op" id="7995525">.</span><span class="ident" id="7995526">c</span>&nbsp;<span class="op" id="7995528">==</span>&nbsp;<span class="builtintype" id="7995531">nil</span>&nbsp;<span class="op" id="7995535">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7995539">panic</span><span class="op" id="7995544">(</span><span class="string" id="7995545">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7995573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995579">if</span>&nbsp;<span class="ident" id="7995582">s</span><span class="op" id="7995583">.</span><span class="ident" id="7995584">c</span><span class="op" id="7995585">.</span><span class="ident" id="7995586">db</span>&nbsp;<span class="op" id="7995589">==</span>&nbsp;<span class="builtintype" id="7995592">nil</span>&nbsp;<span class="op" id="7995596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7995600">panic</span><span class="op" id="7995605">(</span><span class="string" id="7995606">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7995660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995663">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995666">if</span>&nbsp;<span class="op" id="7995669">!</span><span class="ident" id="7995670">s</span><span class="op" id="7995671">.</span><span class="ident" id="7995672">closed</span>&nbsp;<span class="op" id="7995679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7995683">s</span><span class="op" id="7995684">.</span><span class="ident" id="7995685">c</span><span class="op" id="7995686">.</span><span class="ident" id="7995687">incrStat</span><span class="op" id="7995695">(</span><span class="op" id="7995696">&amp;</span><span class="ident" id="7995697">s</span><span class="op" id="7995698">.</span><span class="ident" id="7995699">c</span><span class="op" id="7995700">.</span><span class="ident" id="7995701">stmtsClosed</span><span class="op" id="7995712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7995716">s</span><span class="op" id="7995717">.</span><span class="ident" id="7995718">closed</span>&nbsp;<span class="op" id="7995725">=</span>&nbsp;<span class="builtintype" id="7995727">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995736">return</span>&nbsp;<span class="builtintype" id="7995743">nil</span><br>
<span class="lineno">520</span><span class="op" id="7995747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7995750">var</span>&nbsp;<span class="ident" id="7995754">errClosed</span>&nbsp;<span class="op" id="7995764">=</span>&nbsp;<span class="ident" id="7995766">errors</span><span class="op" id="7995772">.</span><span class="ident" id="7995773">New</span><span class="op" id="7995776">(</span><span class="string" id="7995777">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7995812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7995815">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7995854">var</span>&nbsp;<span class="ident" id="7995858">hookExecBadConn</span>&nbsp;<span class="keyword" id="7995874">func</span><span class="op" id="7995878">(</span><span class="op" id="7995879">)</span>&nbsp;<span class="builtintype" id="7995881">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7995887">func</span>&nbsp;<span class="op" id="7995892">(</span><span class="ident" id="7995893">s</span>&nbsp;<span class="op" id="7995895">*</span><span class="ident" id="7995896">fakeStmt</span><span class="op" id="7995904">)</span>&nbsp;<span class="ident" id="7995906">Exec</span><span class="op" id="7995910">(</span><span class="ident" id="7995911">args</span>&nbsp;<span class="op" id="7995916">[</span><span class="op" id="7995917">]</span><span class="ident" id="7995918">driver</span><span class="op" id="7995924">.</span><span class="ident" id="7995925">Value</span><span class="op" id="7995930">)</span>&nbsp;<span class="op" id="7995932">(</span><span class="ident" id="7995933">driver</span><span class="op" id="7995939">.</span><span class="ident" id="7995940">Result</span><span class="op" id="7995946">,</span>&nbsp;<span class="builtintype" id="7995948">error</span><span class="op" id="7995953">)</span>&nbsp;<span class="op" id="7995955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995958">if</span>&nbsp;<span class="ident" id="7995961">s</span><span class="op" id="7995962">.</span><span class="ident" id="7995963">closed</span>&nbsp;<span class="op" id="7995970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7995974">return</span>&nbsp;<span class="builtintype" id="7995981">nil</span><span class="op" id="7995984">,</span>&nbsp;<span class="ident" id="7995986">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7995997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996001">if</span>&nbsp;<span class="ident" id="7996004">hookExecBadConn</span>&nbsp;<span class="op" id="7996020">!=</span>&nbsp;<span class="builtintype" id="7996023">nil</span>&nbsp;<span class="op" id="7996027">&amp;&amp;</span>&nbsp;<span class="ident" id="7996030">hookExecBadConn</span><span class="op" id="7996045">(</span><span class="op" id="7996046">)</span>&nbsp;<span class="op" id="7996048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996052">return</span>&nbsp;<span class="builtintype" id="7996059">nil</span><span class="op" id="7996062">,</span>&nbsp;<span class="ident" id="7996064">driver</span><span class="op" id="7996070">.</span><span class="ident" id="7996071">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7996083">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7996087">err</span>&nbsp;<span class="op" id="7996091">:=</span>&nbsp;<span class="ident" id="7996094">checkSubsetTypes</span><span class="op" id="7996110">(</span><span class="ident" id="7996111">args</span><span class="op" id="7996115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996118">if</span>&nbsp;<span class="ident" id="7996121">err</span>&nbsp;<span class="op" id="7996125">!=</span>&nbsp;<span class="builtintype" id="7996128">nil</span>&nbsp;<span class="op" id="7996132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996136">return</span>&nbsp;<span class="builtintype" id="7996143">nil</span><span class="op" id="7996146">,</span>&nbsp;<span class="ident" id="7996148">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7996153">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7996157">db</span>&nbsp;<span class="op" id="7996160">:=</span>&nbsp;<span class="ident" id="7996163">s</span><span class="op" id="7996164">.</span><span class="ident" id="7996165">c</span><span class="op" id="7996166">.</span><span class="ident" id="7996167">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996171">switch</span>&nbsp;<span class="ident" id="7996178">s</span><span class="op" id="7996179">.</span><span class="ident" id="7996180">cmd</span>&nbsp;<span class="op" id="7996184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996187">case</span>&nbsp;<span class="string" id="7996192">&#34;WIPE&#34;</span><span class="op" id="7996198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7996202">db</span><span class="op" id="7996204">.</span><span class="ident" id="7996205">wipe</span><span class="op" id="7996209">(</span><span class="op" id="7996210">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996214">return</span>&nbsp;<span class="ident" id="7996221">driver</span><span class="op" id="7996227">.</span><span class="ident" id="7996228">ResultNoRows</span><span class="op" id="7996240">,</span>&nbsp;<span class="builtintype" id="7996242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996247">case</span>&nbsp;<span class="string" id="7996252">&#34;CREATE&#34;</span><span class="op" id="7996260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996264">if</span>&nbsp;<span class="ident" id="7996267">err</span>&nbsp;<span class="op" id="7996271">:=</span>&nbsp;<span class="ident" id="7996274">db</span><span class="op" id="7996276">.</span><span class="ident" id="7996277">createTable</span><span class="op" id="7996288">(</span><span class="ident" id="7996289">s</span><span class="op" id="7996290">.</span><span class="ident" id="7996291">table</span><span class="op" id="7996296">,</span>&nbsp;<span class="ident" id="7996298">s</span><span class="op" id="7996299">.</span><span class="ident" id="7996300">colName</span><span class="op" id="7996307">,</span>&nbsp;<span class="ident" id="7996309">s</span><span class="op" id="7996310">.</span><span class="ident" id="7996311">colType</span><span class="op" id="7996318">)</span><span class="op" id="7996319">;</span>&nbsp;<span class="ident" id="7996321">err</span>&nbsp;<span class="op" id="7996325">!=</span>&nbsp;<span class="builtintype" id="7996328">nil</span>&nbsp;<span class="op" id="7996332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996337">return</span>&nbsp;<span class="builtintype" id="7996344">nil</span><span class="op" id="7996347">,</span>&nbsp;<span class="ident" id="7996349">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7996355">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996359">return</span>&nbsp;<span class="ident" id="7996366">driver</span><span class="op" id="7996372">.</span><span class="ident" id="7996373">ResultNoRows</span><span class="op" id="7996385">,</span>&nbsp;<span class="builtintype" id="7996387">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996392">case</span>&nbsp;<span class="string" id="7996397">&#34;INSERT&#34;</span><span class="op" id="7996405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996409">return</span>&nbsp;<span class="ident" id="7996416">s</span><span class="op" id="7996417">.</span><span class="ident" id="7996418">execInsert</span><span class="op" id="7996428">(</span><span class="ident" id="7996429">args</span><span class="op" id="7996433">,</span>&nbsp;<span class="builtintype" id="7996435">true</span><span class="op" id="7996439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996442">case</span>&nbsp;<span class="string" id="7996447">&#34;NOSERT&#34;</span><span class="op" id="7996455">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7996459">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7996539">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996583">return</span>&nbsp;<span class="ident" id="7996590">s</span><span class="op" id="7996591">.</span><span class="ident" id="7996592">execInsert</span><span class="op" id="7996602">(</span><span class="ident" id="7996603">args</span><span class="op" id="7996607">,</span>&nbsp;<span class="builtintype" id="7996609">false</span><span class="op" id="7996614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7996617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7996620">fmt</span><span class="op" id="7996623">.</span><span class="ident" id="7996624">Printf</span><span class="op" id="7996630">(</span><span class="string" id="7996631">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7996662">,</span>&nbsp;<span class="ident" id="7996664">s</span><span class="op" id="7996665">.</span><span class="ident" id="7996666">cmd</span><span class="op" id="7996669">,</span>&nbsp;<span class="ident" id="7996671">s</span><span class="op" id="7996672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7996675">return</span>&nbsp;<span class="builtintype" id="7996682">nil</span><span class="op" id="7996685">,</span>&nbsp;<span class="ident" id="7996687">fmt</span><span class="op" id="7996690">.</span><span class="ident" id="7996691">Errorf</span><span class="op" id="7996697">(</span><span class="string" id="7996698">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7996747">,</span>&nbsp;<span class="ident" id="7996749">s</span><span class="op" id="7996750">.</span><span class="ident" id="7996751">cmd</span><span class="op" id="7996754">)</span><br>
<span class="lineno">560</span><span class="op" id="7996756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7996759">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7996811">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7996880">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7996918">func</span>&nbsp;<span class="op" id="7996923">(</span><span class="ident" id="7996924">s</span>&nbsp;<span class="op" id="7996926">*</span><span class="ident" id="7996927">fakeStmt</span><span class="op" id="7996935">)</span>&nbsp;<span class="ident" id="7996937">execInsert</span><span class="op" id="7996947">(</span><span class="ident" id="7996948">args</span>&nbsp;<span class="op" id="7996953">[</span><span class="op" id="7996954">]</span><span class="ident" id="7996955">driver</span><span class="op" id="7996961">.</span><span class="ident" id="7996962">Value</span><span class="op" id="7996967">,</span>&nbsp;<span class="ident" id="7996969">doInsert</span>&nbsp;<span class="builtintype" id="7996978">bool</span><span class="op" id="7996982">)</span>&nbsp;<span class="op" id="7996984">(</span><span class="ident" id="7996985">driver</span><span class="op" id="7996991">.</span><span class="ident" id="7996992">Result</span><span class="op" id="7996998">,</span>&nbsp;<span class="builtintype" id="7997000">error</span><span class="op" id="7997005">)</span>&nbsp;<span class="op" id="7997007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997010">db</span>&nbsp;<span class="op" id="7997013">:=</span>&nbsp;<span class="ident" id="7997016">s</span><span class="op" id="7997017">.</span><span class="ident" id="7997018">c</span><span class="op" id="7997019">.</span><span class="ident" id="7997020">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997024">if</span>&nbsp;<span class="builtinfunc" id="7997027">len</span><span class="op" id="7997030">(</span><span class="ident" id="7997031">args</span><span class="op" id="7997035">)</span>&nbsp;<span class="op" id="7997037">!=</span>&nbsp;<span class="ident" id="7997040">s</span><span class="op" id="7997041">.</span><span class="ident" id="7997042">placeholders</span>&nbsp;<span class="op" id="7997055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7997059">panic</span><span class="op" id="7997064">(</span><span class="string" id="7997065">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7997123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997126">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997129">db</span><span class="op" id="7997131">.</span><span class="ident" id="7997132">mu</span><span class="op" id="7997134">.</span><span class="ident" id="7997135">Lock</span><span class="op" id="7997139">(</span><span class="op" id="7997140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997143">t</span><span class="op" id="7997144">,</span>&nbsp;<span class="ident" id="7997146">ok</span>&nbsp;<span class="op" id="7997149">:=</span>&nbsp;<span class="ident" id="7997152">db</span><span class="op" id="7997154">.</span><span class="ident" id="7997155">table</span><span class="op" id="7997160">(</span><span class="ident" id="7997161">s</span><span class="op" id="7997162">.</span><span class="ident" id="7997163">table</span><span class="op" id="7997168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997171">db</span><span class="op" id="7997173">.</span><span class="ident" id="7997174">mu</span><span class="op" id="7997176">.</span><span class="ident" id="7997177">Unlock</span><span class="op" id="7997183">(</span><span class="op" id="7997184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997187">if</span>&nbsp;<span class="op" id="7997190">!</span><span class="ident" id="7997191">ok</span>&nbsp;<span class="op" id="7997194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997198">return</span>&nbsp;<span class="builtintype" id="7997205">nil</span><span class="op" id="7997208">,</span>&nbsp;<span class="ident" id="7997210">fmt</span><span class="op" id="7997213">.</span><span class="ident" id="7997214">Errorf</span><span class="op" id="7997220">(</span><span class="string" id="7997221">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7997253">,</span>&nbsp;<span class="ident" id="7997255">s</span><span class="op" id="7997256">.</span><span class="ident" id="7997257">table</span><span class="op" id="7997262">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997269">t</span><span class="op" id="7997270">.</span><span class="ident" id="7997271">mu</span><span class="op" id="7997273">.</span><span class="ident" id="7997274">Lock</span><span class="op" id="7997278">(</span><span class="op" id="7997279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997282">defer</span>&nbsp;<span class="ident" id="7997288">t</span><span class="op" id="7997289">.</span><span class="ident" id="7997290">mu</span><span class="op" id="7997292">.</span><span class="ident" id="7997293">Unlock</span><span class="op" id="7997299">(</span><span class="op" id="7997300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997304">var</span>&nbsp;<span class="ident" id="7997308">cols</span>&nbsp;<span class="op" id="7997313">[</span><span class="op" id="7997314">]</span><span class="keyword" id="7997315">interface</span><span class="op" id="7997324">{</span><span class="op" id="7997325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997328">if</span>&nbsp;<span class="ident" id="7997331">doInsert</span>&nbsp;<span class="op" id="7997340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997344">cols</span>&nbsp;<span class="op" id="7997349">=</span>&nbsp;<span class="builtinfunc" id="7997351">make</span><span class="op" id="7997355">(</span><span class="op" id="7997356">[</span><span class="op" id="7997357">]</span><span class="keyword" id="7997358">interface</span><span class="op" id="7997367">{</span><span class="op" id="7997368">}</span><span class="op" id="7997369">,</span>&nbsp;<span class="builtinfunc" id="7997371">len</span><span class="op" id="7997374">(</span><span class="ident" id="7997375">t</span><span class="op" id="7997376">.</span><span class="ident" id="7997377">colname</span><span class="op" id="7997384">)</span><span class="op" id="7997385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997391">argPos</span>&nbsp;<span class="op" id="7997398">:=</span>&nbsp;<span class="num" id="7997401">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997404">for</span>&nbsp;<span class="ident" id="7997408">n</span><span class="op" id="7997409">,</span>&nbsp;<span class="ident" id="7997411">colname</span>&nbsp;<span class="op" id="7997419">:=</span>&nbsp;<span class="keyword" id="7997422">range</span>&nbsp;<span class="ident" id="7997428">s</span><span class="op" id="7997429">.</span><span class="ident" id="7997430">colName</span>&nbsp;<span class="op" id="7997438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997442">colidx</span>&nbsp;<span class="op" id="7997449">:=</span>&nbsp;<span class="ident" id="7997452">t</span><span class="op" id="7997453">.</span><span class="ident" id="7997454">columnIndex</span><span class="op" id="7997465">(</span><span class="ident" id="7997466">colname</span><span class="op" id="7997473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997477">if</span>&nbsp;<span class="ident" id="7997480">colidx</span>&nbsp;<span class="op" id="7997487">==</span>&nbsp;<span class="op" id="7997490">-</span><span class="num" id="7997491">1</span>&nbsp;<span class="op" id="7997493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997498">return</span>&nbsp;<span class="builtintype" id="7997505">nil</span><span class="op" id="7997508">,</span>&nbsp;<span class="ident" id="7997510">fmt</span><span class="op" id="7997513">.</span><span class="ident" id="7997514">Errorf</span><span class="op" id="7997520">(</span><span class="string" id="7997521">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7997602">,</span>&nbsp;<span class="ident" id="7997604">colname</span><span class="op" id="7997611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997615">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997619">var</span>&nbsp;<span class="ident" id="7997623">val</span>&nbsp;<span class="keyword" id="7997627">interface</span><span class="op" id="7997636">{</span><span class="op" id="7997637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997641">if</span>&nbsp;<span class="ident" id="7997644">strvalue</span><span class="op" id="7997652">,</span>&nbsp;<span class="ident" id="7997654">ok</span>&nbsp;<span class="op" id="7997657">:=</span>&nbsp;<span class="ident" id="7997660">s</span><span class="op" id="7997661">.</span><span class="ident" id="7997662">colValue</span><span class="op" id="7997670">[</span><span class="ident" id="7997671">n</span><span class="op" id="7997672">]</span><span class="op" id="7997673">.</span><span class="op" id="7997674">(</span><span class="builtintype" id="7997675">string</span><span class="op" id="7997681">)</span><span class="op" id="7997682">;</span>&nbsp;<span class="ident" id="7997684">ok</span>&nbsp;<span class="op" id="7997687">&amp;&amp;</span>&nbsp;<span class="ident" id="7997690">strvalue</span>&nbsp;<span class="op" id="7997699">==</span>&nbsp;<span class="string" id="7997702">&#34;?&#34;</span>&nbsp;<span class="op" id="7997706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997711">val</span>&nbsp;<span class="op" id="7997715">=</span>&nbsp;<span class="ident" id="7997717">args</span><span class="op" id="7997721">[</span><span class="ident" id="7997722">argPos</span><span class="op" id="7997728">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997733">argPos</span><span class="op" id="7997739">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997744">}</span>&nbsp;<span class="keyword" id="7997746">else</span>&nbsp;<span class="op" id="7997751">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997756">val</span>&nbsp;<span class="op" id="7997760">=</span>&nbsp;<span class="ident" id="7997762">s</span><span class="op" id="7997763">.</span><span class="ident" id="7997764">colValue</span><span class="op" id="7997772">[</span><span class="ident" id="7997773">n</span><span class="op" id="7997774">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997782">if</span>&nbsp;<span class="ident" id="7997785">doInsert</span>&nbsp;<span class="op" id="7997794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997799">cols</span><span class="op" id="7997803">[</span><span class="ident" id="7997804">colidx</span><span class="op" id="7997810">]</span>&nbsp;<span class="op" id="7997812">=</span>&nbsp;<span class="ident" id="7997814">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997820">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997827">if</span>&nbsp;<span class="ident" id="7997830">doInsert</span>&nbsp;<span class="op" id="7997839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7997843">t</span><span class="op" id="7997844">.</span><span class="ident" id="7997845">rows</span>&nbsp;<span class="op" id="7997850">=</span>&nbsp;<span class="builtinfunc" id="7997852">append</span><span class="op" id="7997858">(</span><span class="ident" id="7997859">t</span><span class="op" id="7997860">.</span><span class="ident" id="7997861">rows</span><span class="op" id="7997865">,</span>&nbsp;<span class="op" id="7997867">&amp;</span><span class="ident" id="7997868">row</span><span class="op" id="7997871">{</span><span class="ident" id="7997872">cols</span><span class="op" id="7997876">:</span>&nbsp;<span class="ident" id="7997878">cols</span><span class="op" id="7997882">}</span><span class="op" id="7997883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997886">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7997889">return</span>&nbsp;<span class="ident" id="7997896">driver</span><span class="op" id="7997902">.</span><span class="ident" id="7997903">RowsAffected</span><span class="op" id="7997915">(</span><span class="num" id="7997916">1</span><span class="op" id="7997917">)</span><span class="op" id="7997918">,</span>&nbsp;<span class="builtintype" id="7997920">nil</span><br>
<span class="lineno"></span><span class="op" id="7997924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7997927">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7997966">var</span>&nbsp;<span class="ident" id="7997970">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7997987">func</span><span class="op" id="7997991">(</span><span class="op" id="7997992">)</span>&nbsp;<span class="builtintype" id="7997994">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7998000">func</span>&nbsp;<span class="op" id="7998005">(</span><span class="ident" id="7998006">s</span>&nbsp;<span class="op" id="7998008">*</span><span class="ident" id="7998009">fakeStmt</span><span class="op" id="7998017">)</span>&nbsp;<span class="ident" id="7998019">Query</span><span class="op" id="7998024">(</span><span class="ident" id="7998025">args</span>&nbsp;<span class="op" id="7998030">[</span><span class="op" id="7998031">]</span><span class="ident" id="7998032">driver</span><span class="op" id="7998038">.</span><span class="ident" id="7998039">Value</span><span class="op" id="7998044">)</span>&nbsp;<span class="op" id="7998046">(</span><span class="ident" id="7998047">driver</span><span class="op" id="7998053">.</span><span class="ident" id="7998054">Rows</span><span class="op" id="7998058">,</span>&nbsp;<span class="builtintype" id="7998060">error</span><span class="op" id="7998065">)</span>&nbsp;<span class="op" id="7998067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998070">if</span>&nbsp;<span class="ident" id="7998073">s</span><span class="op" id="7998074">.</span><span class="ident" id="7998075">closed</span>&nbsp;<span class="op" id="7998082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998086">return</span>&nbsp;<span class="builtintype" id="7998093">nil</span><span class="op" id="7998096">,</span>&nbsp;<span class="ident" id="7998098">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998109">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998113">if</span>&nbsp;<span class="ident" id="7998116">hookQueryBadConn</span>&nbsp;<span class="op" id="7998133">!=</span>&nbsp;<span class="builtintype" id="7998136">nil</span>&nbsp;<span class="op" id="7998140">&amp;&amp;</span>&nbsp;<span class="ident" id="7998143">hookQueryBadConn</span><span class="op" id="7998159">(</span><span class="op" id="7998160">)</span>&nbsp;<span class="op" id="7998162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998166">return</span>&nbsp;<span class="builtintype" id="7998173">nil</span><span class="op" id="7998176">,</span>&nbsp;<span class="ident" id="7998178">driver</span><span class="op" id="7998184">.</span><span class="ident" id="7998185">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998201">err</span>&nbsp;<span class="op" id="7998205">:=</span>&nbsp;<span class="ident" id="7998208">checkSubsetTypes</span><span class="op" id="7998224">(</span><span class="ident" id="7998225">args</span><span class="op" id="7998229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998232">if</span>&nbsp;<span class="ident" id="7998235">err</span>&nbsp;<span class="op" id="7998239">!=</span>&nbsp;<span class="builtintype" id="7998242">nil</span>&nbsp;<span class="op" id="7998246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998250">return</span>&nbsp;<span class="builtintype" id="7998257">nil</span><span class="op" id="7998260">,</span>&nbsp;<span class="ident" id="7998262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998271">db</span>&nbsp;<span class="op" id="7998274">:=</span>&nbsp;<span class="ident" id="7998277">s</span><span class="op" id="7998278">.</span><span class="ident" id="7998279">c</span><span class="op" id="7998280">.</span><span class="ident" id="7998281">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998285">if</span>&nbsp;<span class="builtinfunc" id="7998288">len</span><span class="op" id="7998291">(</span><span class="ident" id="7998292">args</span><span class="op" id="7998296">)</span>&nbsp;<span class="op" id="7998298">!=</span>&nbsp;<span class="ident" id="7998301">s</span><span class="op" id="7998302">.</span><span class="ident" id="7998303">placeholders</span>&nbsp;<span class="op" id="7998316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7998320">panic</span><span class="op" id="7998325">(</span><span class="string" id="7998326">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7998384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998391">db</span><span class="op" id="7998393">.</span><span class="ident" id="7998394">mu</span><span class="op" id="7998396">.</span><span class="ident" id="7998397">Lock</span><span class="op" id="7998401">(</span><span class="op" id="7998402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998405">t</span><span class="op" id="7998406">,</span>&nbsp;<span class="ident" id="7998408">ok</span>&nbsp;<span class="op" id="7998411">:=</span>&nbsp;<span class="ident" id="7998414">db</span><span class="op" id="7998416">.</span><span class="ident" id="7998417">table</span><span class="op" id="7998422">(</span><span class="ident" id="7998423">s</span><span class="op" id="7998424">.</span><span class="ident" id="7998425">table</span><span class="op" id="7998430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998433">db</span><span class="op" id="7998435">.</span><span class="ident" id="7998436">mu</span><span class="op" id="7998438">.</span><span class="ident" id="7998439">Unlock</span><span class="op" id="7998445">(</span><span class="op" id="7998446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998449">if</span>&nbsp;<span class="op" id="7998452">!</span><span class="ident" id="7998453">ok</span>&nbsp;<span class="op" id="7998456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998460">return</span>&nbsp;<span class="builtintype" id="7998467">nil</span><span class="op" id="7998470">,</span>&nbsp;<span class="ident" id="7998472">fmt</span><span class="op" id="7998475">.</span><span class="ident" id="7998476">Errorf</span><span class="op" id="7998482">(</span><span class="string" id="7998483">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7998515">,</span>&nbsp;<span class="ident" id="7998517">s</span><span class="op" id="7998518">.</span><span class="ident" id="7998519">table</span><span class="op" id="7998524">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998531">if</span>&nbsp;<span class="ident" id="7998534">s</span><span class="op" id="7998535">.</span><span class="ident" id="7998536">table</span>&nbsp;<span class="op" id="7998542">==</span>&nbsp;<span class="string" id="7998545">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7998558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998562">if</span>&nbsp;<span class="builtinfunc" id="7998565">len</span><span class="op" id="7998568">(</span><span class="ident" id="7998569">s</span><span class="op" id="7998570">.</span><span class="ident" id="7998571">whereCol</span><span class="op" id="7998579">)</span>&nbsp;<span class="op" id="7998581">==</span>&nbsp;<span class="num" id="7998584">2</span>&nbsp;<span class="op" id="7998586">&amp;&amp;</span>&nbsp;<span class="ident" id="7998589">s</span><span class="op" id="7998590">.</span><span class="ident" id="7998591">whereCol</span><span class="op" id="7998599">[</span><span class="num" id="7998600">0</span><span class="op" id="7998601">]</span>&nbsp;<span class="op" id="7998603">==</span>&nbsp;<span class="string" id="7998606">&#34;op&#34;</span>&nbsp;<span class="op" id="7998611">&amp;&amp;</span>&nbsp;<span class="ident" id="7998614">s</span><span class="op" id="7998615">.</span><span class="ident" id="7998616">whereCol</span><span class="op" id="7998624">[</span><span class="num" id="7998625">1</span><span class="op" id="7998626">]</span>&nbsp;<span class="op" id="7998628">==</span>&nbsp;<span class="string" id="7998631">&#34;millis&#34;</span>&nbsp;<span class="op" id="7998640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998645">if</span>&nbsp;<span class="ident" id="7998648">args</span><span class="op" id="7998652">[</span><span class="num" id="7998653">0</span><span class="op" id="7998654">]</span>&nbsp;<span class="op" id="7998656">==</span>&nbsp;<span class="string" id="7998659">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7998667">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998673">time</span><span class="op" id="7998677">.</span><span class="ident" id="7998678">Sleep</span><span class="op" id="7998683">(</span><span class="ident" id="7998684">time</span><span class="op" id="7998688">.</span><span class="ident" id="7998689">Duration</span><span class="op" id="7998697">(</span><span class="ident" id="7998698">args</span><span class="op" id="7998702">[</span><span class="num" id="7998703">1</span><span class="op" id="7998704">]</span><span class="op" id="7998705">.</span><span class="op" id="7998706">(</span><span class="ident" id="7998707">int64</span><span class="op" id="7998712">)</span><span class="op" id="7998713">)</span>&nbsp;<span class="op" id="7998715">*</span>&nbsp;<span class="ident" id="7998717">time</span><span class="op" id="7998721">.</span><span class="ident" id="7998722">Millisecond</span><span class="op" id="7998733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7998745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998749">t</span><span class="op" id="7998750">.</span><span class="ident" id="7998751">mu</span><span class="op" id="7998753">.</span><span class="ident" id="7998754">Lock</span><span class="op" id="7998758">(</span><span class="op" id="7998759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998762">defer</span>&nbsp;<span class="ident" id="7998768">t</span><span class="op" id="7998769">.</span><span class="ident" id="7998770">mu</span><span class="op" id="7998772">.</span><span class="ident" id="7998773">Unlock</span><span class="op" id="7998779">(</span><span class="op" id="7998780">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998784">colIdx</span>&nbsp;<span class="op" id="7998791">:=</span>&nbsp;<span class="builtinfunc" id="7998794">make</span><span class="op" id="7998798">(</span><span class="keyword" id="7998799">map</span><span class="op" id="7998802">[</span><span class="builtintype" id="7998803">string</span><span class="op" id="7998809">]</span><span class="builtintype" id="7998810">int</span><span class="op" id="7998813">)</span>&nbsp;<span class="comment" id="7998815">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998863">for</span>&nbsp;<span class="ident" id="7998867">_</span><span class="op" id="7998868">,</span>&nbsp;<span class="ident" id="7998870">name</span>&nbsp;<span class="op" id="7998875">:=</span>&nbsp;<span class="keyword" id="7998878">range</span>&nbsp;<span class="ident" id="7998884">s</span><span class="op" id="7998885">.</span><span class="ident" id="7998886">colName</span>&nbsp;<span class="op" id="7998894">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7998898">idx</span>&nbsp;<span class="op" id="7998902">:=</span>&nbsp;<span class="ident" id="7998905">t</span><span class="op" id="7998906">.</span><span class="ident" id="7998907">columnIndex</span><span class="op" id="7998918">(</span><span class="ident" id="7998919">name</span><span class="op" id="7998923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998927">if</span>&nbsp;<span class="ident" id="7998930">idx</span>&nbsp;<span class="op" id="7998934">==</span>&nbsp;<span class="op" id="7998937">-</span><span class="num" id="7998938">1</span>&nbsp;<span class="op" id="7998940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7998945">return</span>&nbsp;<span class="builtintype" id="7998952">nil</span><span class="op" id="7998955">,</span>&nbsp;<span class="ident" id="7998957">fmt</span><span class="op" id="7998960">.</span><span class="ident" id="7998961">Errorf</span><span class="op" id="7998967">(</span><span class="string" id="7998968">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7999000">,</span>&nbsp;<span class="ident" id="7999002">name</span><span class="op" id="7999006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999014">colIdx</span><span class="op" id="7999020">[</span><span class="ident" id="7999021">name</span><span class="op" id="7999025">]</span>&nbsp;<span class="op" id="7999027">=</span>&nbsp;<span class="ident" id="7999029">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999038">mrows</span>&nbsp;<span class="op" id="7999044">:=</span>&nbsp;<span class="op" id="7999047">[</span><span class="op" id="7999048">]</span><span class="op" id="7999049">*</span><span class="ident" id="7999050">row</span><span class="op" id="7999053">{</span><span class="op" id="7999054">}</span><br>
<span class="lineno"></span><span class="ident" id="7999056">rows</span><span class="op" id="7999060">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999063">for</span>&nbsp;<span class="ident" id="7999067">_</span><span class="op" id="7999068">,</span>&nbsp;<span class="ident" id="7999070">trow</span>&nbsp;<span class="op" id="7999075">:=</span>&nbsp;<span class="keyword" id="7999078">range</span>&nbsp;<span class="ident" id="7999084">t</span><span class="op" id="7999085">.</span><span class="ident" id="7999086">rows</span>&nbsp;<span class="op" id="7999091">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7999095">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7999164">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7999232">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999252">for</span>&nbsp;<span class="ident" id="7999256">widx</span><span class="op" id="7999260">,</span>&nbsp;<span class="ident" id="7999262">wcol</span>&nbsp;<span class="op" id="7999267">:=</span>&nbsp;<span class="keyword" id="7999270">range</span>&nbsp;<span class="ident" id="7999276">s</span><span class="op" id="7999277">.</span><span class="ident" id="7999278">whereCol</span>&nbsp;<span class="op" id="7999287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999292">idx</span>&nbsp;<span class="op" id="7999296">:=</span>&nbsp;<span class="ident" id="7999299">t</span><span class="op" id="7999300">.</span><span class="ident" id="7999301">columnIndex</span><span class="op" id="7999312">(</span><span class="ident" id="7999313">wcol</span><span class="op" id="7999317">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999322">if</span>&nbsp;<span class="ident" id="7999325">idx</span>&nbsp;<span class="op" id="7999329">==</span>&nbsp;<span class="op" id="7999332">-</span><span class="num" id="7999333">1</span>&nbsp;<span class="op" id="7999335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999341">return</span>&nbsp;<span class="builtintype" id="7999348">nil</span><span class="op" id="7999351">,</span>&nbsp;<span class="ident" id="7999353">fmt</span><span class="op" id="7999356">.</span><span class="ident" id="7999357">Errorf</span><span class="op" id="7999363">(</span><span class="string" id="7999364">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7999400">,</span>&nbsp;<span class="ident" id="7999402">wcol</span><span class="op" id="7999406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999416">tcol</span>&nbsp;<span class="op" id="7999421">:=</span>&nbsp;<span class="ident" id="7999424">trow</span><span class="op" id="7999428">.</span><span class="ident" id="7999429">cols</span><span class="op" id="7999433">[</span><span class="ident" id="7999434">idx</span><span class="op" id="7999437">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999442">if</span>&nbsp;<span class="ident" id="7999445">bs</span><span class="op" id="7999447">,</span>&nbsp;<span class="ident" id="7999449">ok</span>&nbsp;<span class="op" id="7999452">:=</span>&nbsp;<span class="ident" id="7999455">tcol</span><span class="op" id="7999459">.</span><span class="op" id="7999460">(</span><span class="op" id="7999461">[</span><span class="op" id="7999462">]</span><span class="builtintype" id="7999463">byte</span><span class="op" id="7999467">)</span><span class="op" id="7999468">;</span>&nbsp;<span class="ident" id="7999470">ok</span>&nbsp;<span class="op" id="7999473">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7999479">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999528">tcol</span>&nbsp;<span class="op" id="7999533">=</span>&nbsp;<span class="builtintype" id="7999535">string</span><span class="op" id="7999541">(</span><span class="ident" id="7999542">bs</span><span class="op" id="7999544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999554">if</span>&nbsp;<span class="ident" id="7999557">fmt</span><span class="op" id="7999560">.</span><span class="ident" id="7999561">Sprintf</span><span class="op" id="7999568">(</span><span class="string" id="7999569">&#34;%v&#34;</span><span class="op" id="7999573">,</span>&nbsp;<span class="ident" id="7999575">tcol</span><span class="op" id="7999579">)</span>&nbsp;<span class="op" id="7999581">!=</span>&nbsp;<span class="ident" id="7999584">fmt</span><span class="op" id="7999587">.</span><span class="ident" id="7999588">Sprintf</span><span class="op" id="7999595">(</span><span class="string" id="7999596">&#34;%v&#34;</span><span class="op" id="7999600">,</span>&nbsp;<span class="ident" id="7999602">args</span><span class="op" id="7999606">[</span><span class="ident" id="7999607">widx</span><span class="op" id="7999611">]</span><span class="op" id="7999612">)</span>&nbsp;<span class="op" id="7999614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999620">continue</span>&nbsp;<span class="ident" id="7999629">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999645">mrow</span>&nbsp;<span class="op" id="7999650">:=</span>&nbsp;<span class="op" id="7999653">&amp;</span><span class="ident" id="7999654">row</span><span class="op" id="7999657">{</span><span class="ident" id="7999658">cols</span><span class="op" id="7999662">:</span>&nbsp;<span class="builtinfunc" id="7999664">make</span><span class="op" id="7999668">(</span><span class="op" id="7999669">[</span><span class="op" id="7999670">]</span><span class="keyword" id="7999671">interface</span><span class="op" id="7999680">{</span><span class="op" id="7999681">}</span><span class="op" id="7999682">,</span>&nbsp;<span class="builtinfunc" id="7999684">len</span><span class="op" id="7999687">(</span><span class="ident" id="7999688">s</span><span class="op" id="7999689">.</span><span class="ident" id="7999690">colName</span><span class="op" id="7999697">)</span><span class="op" id="7999698">)</span><span class="op" id="7999699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999703">for</span>&nbsp;<span class="ident" id="7999707">seli</span><span class="op" id="7999711">,</span>&nbsp;<span class="ident" id="7999713">name</span>&nbsp;<span class="op" id="7999718">:=</span>&nbsp;<span class="keyword" id="7999721">range</span>&nbsp;<span class="ident" id="7999727">s</span><span class="op" id="7999728">.</span><span class="ident" id="7999729">colName</span>&nbsp;<span class="op" id="7999737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999742">mrow</span><span class="op" id="7999746">.</span><span class="ident" id="7999747">cols</span><span class="op" id="7999751">[</span><span class="ident" id="7999752">seli</span><span class="op" id="7999756">]</span>&nbsp;<span class="op" id="7999758">=</span>&nbsp;<span class="ident" id="7999760">trow</span><span class="op" id="7999764">.</span><span class="ident" id="7999765">cols</span><span class="op" id="7999769">[</span><span class="ident" id="7999770">colIdx</span><span class="op" id="7999776">[</span><span class="ident" id="7999777">name</span><span class="op" id="7999781">]</span><span class="op" id="7999782">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999790">mrows</span>&nbsp;<span class="op" id="7999796">=</span>&nbsp;<span class="builtinfunc" id="7999798">append</span><span class="op" id="7999804">(</span><span class="ident" id="7999805">mrows</span><span class="op" id="7999810">,</span>&nbsp;<span class="ident" id="7999812">mrow</span><span class="op" id="7999816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999823">cursor</span>&nbsp;<span class="op" id="7999830">:=</span>&nbsp;<span class="op" id="7999833">&amp;</span><span class="ident" id="7999834">rowsCursor</span><span class="op" id="7999844">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999848">pos</span><span class="op" id="7999851">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999856">-</span><span class="num" id="7999857">1</span><span class="op" id="7999858">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999862">rows</span><span class="op" id="7999866">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7999870">mrows</span><span class="op" id="7999875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999879">cols</span><span class="op" id="7999883">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7999887">s</span><span class="op" id="7999888">.</span><span class="ident" id="7999889">colName</span><span class="op" id="7999896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7999900">errPos</span><span class="op" id="7999906">:</span>&nbsp;<span class="op" id="7999908">-</span><span class="num" id="7999909">1</span><span class="op" id="7999910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7999913">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999916">return</span>&nbsp;<span class="ident" id="7999923">cursor</span><span class="op" id="7999929">,</span>&nbsp;<span class="builtintype" id="7999931">nil</span><br>
<span class="lineno"></span><span class="op" id="7999935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7999938">func</span>&nbsp;<span class="op" id="7999943">(</span><span class="ident" id="7999944">s</span>&nbsp;<span class="op" id="7999946">*</span><span class="ident" id="7999947">fakeStmt</span><span class="op" id="7999955">)</span>&nbsp;<span class="ident" id="7999957">NumInput</span><span class="op" id="7999965">(</span><span class="op" id="7999966">)</span>&nbsp;<span class="builtintype" id="7999968">int</span>&nbsp;<span class="op" id="7999972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7999975">return</span>&nbsp;<span class="ident" id="7999982">s</span><span class="op" id="7999983">.</span><span class="ident" id="7999984">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7999997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000000">func</span>&nbsp;<span class="op" id="8000005">(</span><span class="ident" id="8000006">tx</span>&nbsp;<span class="op" id="8000009">*</span><span class="ident" id="8000010">fakeTx</span><span class="op" id="8000016">)</span>&nbsp;<span class="ident" id="8000018">Commit</span><span class="op" id="8000024">(</span><span class="op" id="8000025">)</span>&nbsp;<span class="builtintype" id="8000027">error</span>&nbsp;<span class="op" id="8000033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000036">tx</span><span class="op" id="8000038">.</span><span class="ident" id="8000039">c</span><span class="op" id="8000040">.</span><span class="ident" id="8000041">currTx</span>&nbsp;<span class="op" id="8000048">=</span>&nbsp;<span class="builtintype" id="8000050">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000055">return</span>&nbsp;<span class="builtintype" id="8000062">nil</span><br>
<span class="lineno">700</span><span class="op" id="8000066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000069">func</span>&nbsp;<span class="op" id="8000074">(</span><span class="ident" id="8000075">tx</span>&nbsp;<span class="op" id="8000078">*</span><span class="ident" id="8000079">fakeTx</span><span class="op" id="8000085">)</span>&nbsp;<span class="ident" id="8000087">Rollback</span><span class="op" id="8000095">(</span><span class="op" id="8000096">)</span>&nbsp;<span class="builtintype" id="8000098">error</span>&nbsp;<span class="op" id="8000104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000107">tx</span><span class="op" id="8000109">.</span><span class="ident" id="8000110">c</span><span class="op" id="8000111">.</span><span class="ident" id="8000112">currTx</span>&nbsp;<span class="op" id="8000119">=</span>&nbsp;<span class="builtintype" id="8000121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000126">return</span>&nbsp;<span class="builtintype" id="8000133">nil</span><br>
<span class="lineno">705</span><span class="op" id="8000137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000140">type</span>&nbsp;<span class="ident" id="8000145">rowsCursor</span>&nbsp;<span class="keyword" id="8000156">struct</span>&nbsp;<span class="op" id="8000163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000166">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8000173">[</span><span class="op" id="8000174">]</span><span class="builtintype" id="8000175">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000183">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8000190">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000195">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8000202">[</span><span class="op" id="8000203">]</span><span class="op" id="8000204">*</span><span class="ident" id="8000205">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000210">closed</span>&nbsp;<span class="builtintype" id="8000217">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8000224">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000288">errPos</span>&nbsp;<span class="builtintype" id="8000295">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000300">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8000307">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8000315">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8000376">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8000436">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000485">bytesClone</span>&nbsp;<span class="keyword" id="8000496">map</span><span class="op" id="8000499">[</span><span class="op" id="8000500">*</span><span class="builtintype" id="8000501">byte</span><span class="op" id="8000505">]</span><span class="op" id="8000506">[</span><span class="op" id="8000507">]</span><span class="builtintype" id="8000508">byte</span><br>
<span class="lineno"></span><span class="op" id="8000513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000516">func</span>&nbsp;<span class="op" id="8000521">(</span><span class="ident" id="8000522">rc</span>&nbsp;<span class="op" id="8000525">*</span><span class="ident" id="8000526">rowsCursor</span><span class="op" id="8000536">)</span>&nbsp;<span class="ident" id="8000538">Close</span><span class="op" id="8000543">(</span><span class="op" id="8000544">)</span>&nbsp;<span class="builtintype" id="8000546">error</span>&nbsp;<span class="op" id="8000552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000555">if</span>&nbsp;<span class="op" id="8000558">!</span><span class="ident" id="8000559">rc</span><span class="op" id="8000561">.</span><span class="ident" id="8000562">closed</span>&nbsp;<span class="op" id="8000569">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000573">for</span>&nbsp;<span class="ident" id="8000577">_</span><span class="op" id="8000578">,</span>&nbsp;<span class="ident" id="8000580">bs</span>&nbsp;<span class="op" id="8000583">:=</span>&nbsp;<span class="keyword" id="8000586">range</span>&nbsp;<span class="ident" id="8000592">rc</span><span class="op" id="8000594">.</span><span class="ident" id="8000595">bytesClone</span>&nbsp;<span class="op" id="8000606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000611">bs</span><span class="op" id="8000613">[</span><span class="num" id="8000614">0</span><span class="op" id="8000615">]</span>&nbsp;<span class="op" id="8000617">=</span>&nbsp;<span class="num" id="8000619">255</span>&nbsp;<span class="comment" id="8000623">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8000649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8000652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000655">rc</span><span class="op" id="8000657">.</span><span class="ident" id="8000658">closed</span>&nbsp;<span class="op" id="8000665">=</span>&nbsp;<span class="builtintype" id="8000667">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000673">return</span>&nbsp;<span class="builtintype" id="8000680">nil</span><br>
<span class="lineno"></span><span class="op" id="8000684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000687">func</span>&nbsp;<span class="op" id="8000692">(</span><span class="ident" id="8000693">rc</span>&nbsp;<span class="op" id="8000696">*</span><span class="ident" id="8000697">rowsCursor</span><span class="op" id="8000707">)</span>&nbsp;<span class="ident" id="8000709">Columns</span><span class="op" id="8000716">(</span><span class="op" id="8000717">)</span>&nbsp;<span class="op" id="8000719">[</span><span class="op" id="8000720">]</span><span class="builtintype" id="8000721">string</span>&nbsp;<span class="op" id="8000728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000731">return</span>&nbsp;<span class="ident" id="8000738">rc</span><span class="op" id="8000740">.</span><span class="ident" id="8000741">cols</span><br>
<span class="lineno">735</span><span class="op" id="8000746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000749">var</span>&nbsp;<span class="ident" id="8000753">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="8000772">func</span><span class="op" id="8000776">(</span><span class="ident" id="8000777">dest</span>&nbsp;<span class="op" id="8000782">[</span><span class="op" id="8000783">]</span><span class="ident" id="8000784">driver</span><span class="op" id="8000790">.</span><span class="ident" id="8000791">Value</span><span class="op" id="8000796">)</span>&nbsp;<span class="builtintype" id="8000798">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8000805">func</span>&nbsp;<span class="op" id="8000810">(</span><span class="ident" id="8000811">rc</span>&nbsp;<span class="op" id="8000814">*</span><span class="ident" id="8000815">rowsCursor</span><span class="op" id="8000825">)</span>&nbsp;<span class="ident" id="8000827">Next</span><span class="op" id="8000831">(</span><span class="ident" id="8000832">dest</span>&nbsp;<span class="op" id="8000837">[</span><span class="op" id="8000838">]</span><span class="ident" id="8000839">driver</span><span class="op" id="8000845">.</span><span class="ident" id="8000846">Value</span><span class="op" id="8000851">)</span>&nbsp;<span class="builtintype" id="8000853">error</span>&nbsp;<span class="op" id="8000859">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000862">if</span>&nbsp;<span class="ident" id="8000865">rowsCursorNextHook</span>&nbsp;<span class="op" id="8000884">!=</span>&nbsp;<span class="builtintype" id="8000887">nil</span>&nbsp;<span class="op" id="8000891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000895">return</span>&nbsp;<span class="ident" id="8000902">rowsCursorNextHook</span><span class="op" id="8000920">(</span><span class="ident" id="8000921">dest</span><span class="op" id="8000925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8000928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000932">if</span>&nbsp;<span class="ident" id="8000935">rc</span><span class="op" id="8000937">.</span><span class="ident" id="8000938">closed</span>&nbsp;<span class="op" id="8000945">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8000949">return</span>&nbsp;<span class="ident" id="8000956">errors</span><span class="op" id="8000962">.</span><span class="ident" id="8000963">New</span><span class="op" id="8000966">(</span><span class="string" id="8000967">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="8000993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8000996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8000999">rc</span><span class="op" id="8001001">.</span><span class="ident" id="8001002">pos</span><span class="op" id="8001005">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001009">if</span>&nbsp;<span class="ident" id="8001012">rc</span><span class="op" id="8001014">.</span><span class="ident" id="8001015">pos</span>&nbsp;<span class="op" id="8001019">==</span>&nbsp;<span class="ident" id="8001022">rc</span><span class="op" id="8001024">.</span><span class="ident" id="8001025">errPos</span>&nbsp;<span class="op" id="8001032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001036">return</span>&nbsp;<span class="ident" id="8001043">rc</span><span class="op" id="8001045">.</span><span class="ident" id="8001046">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001054">if</span>&nbsp;<span class="ident" id="8001057">rc</span><span class="op" id="8001059">.</span><span class="ident" id="8001060">pos</span>&nbsp;<span class="op" id="8001064">&gt;=</span>&nbsp;<span class="builtinfunc" id="8001067">len</span><span class="op" id="8001070">(</span><span class="ident" id="8001071">rc</span><span class="op" id="8001073">.</span><span class="ident" id="8001074">rows</span><span class="op" id="8001078">)</span>&nbsp;<span class="op" id="8001080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001084">return</span>&nbsp;<span class="ident" id="8001091">io</span><span class="op" id="8001093">.</span><span class="ident" id="8001094">EOF</span>&nbsp;<span class="comment" id="8001098">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001124">for</span>&nbsp;<span class="ident" id="8001128">i</span><span class="op" id="8001129">,</span>&nbsp;<span class="ident" id="8001131">v</span>&nbsp;<span class="op" id="8001133">:=</span>&nbsp;<span class="keyword" id="8001136">range</span>&nbsp;<span class="ident" id="8001142">rc</span><span class="op" id="8001144">.</span><span class="ident" id="8001145">rows</span><span class="op" id="8001149">[</span><span class="ident" id="8001150">rc</span><span class="op" id="8001152">.</span><span class="ident" id="8001153">pos</span><span class="op" id="8001156">]</span><span class="op" id="8001157">.</span><span class="ident" id="8001158">cols</span>&nbsp;<span class="op" id="8001163">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001167">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001221">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001273">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001331">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001386">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8001440">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001495">dest</span><span class="op" id="8001499">[</span><span class="ident" id="8001500">i</span><span class="op" id="8001501">]</span>&nbsp;<span class="op" id="8001503">=</span>&nbsp;<span class="ident" id="8001505">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001510">if</span>&nbsp;<span class="ident" id="8001513">bs</span><span class="op" id="8001515">,</span>&nbsp;<span class="ident" id="8001517">ok</span>&nbsp;<span class="op" id="8001520">:=</span>&nbsp;<span class="ident" id="8001523">v</span><span class="op" id="8001524">.</span><span class="op" id="8001525">(</span><span class="op" id="8001526">[</span><span class="op" id="8001527">]</span><span class="builtintype" id="8001528">byte</span><span class="op" id="8001532">)</span><span class="op" id="8001533">;</span>&nbsp;<span class="ident" id="8001535">ok</span>&nbsp;<span class="op" id="8001538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001543">if</span>&nbsp;<span class="ident" id="8001546">rc</span><span class="op" id="8001548">.</span><span class="ident" id="8001549">bytesClone</span>&nbsp;<span class="op" id="8001560">==</span>&nbsp;<span class="builtintype" id="8001563">nil</span>&nbsp;<span class="op" id="8001567">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001573">rc</span><span class="op" id="8001575">.</span><span class="ident" id="8001576">bytesClone</span>&nbsp;<span class="op" id="8001587">=</span>&nbsp;<span class="builtinfunc" id="8001589">make</span><span class="op" id="8001593">(</span><span class="keyword" id="8001594">map</span><span class="op" id="8001597">[</span><span class="op" id="8001598">*</span><span class="builtintype" id="8001599">byte</span><span class="op" id="8001603">]</span><span class="op" id="8001604">[</span><span class="op" id="8001605">]</span><span class="builtintype" id="8001606">byte</span><span class="op" id="8001610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001620">clone</span><span class="op" id="8001625">,</span>&nbsp;<span class="ident" id="8001627">ok</span>&nbsp;<span class="op" id="8001630">:=</span>&nbsp;<span class="ident" id="8001633">rc</span><span class="op" id="8001635">.</span><span class="ident" id="8001636">bytesClone</span><span class="op" id="8001646">[</span><span class="op" id="8001647">&amp;</span><span class="ident" id="8001648">bs</span><span class="op" id="8001650">[</span><span class="num" id="8001651">0</span><span class="op" id="8001652">]</span><span class="op" id="8001653">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001658">if</span>&nbsp;<span class="op" id="8001661">!</span><span class="ident" id="8001662">ok</span>&nbsp;<span class="op" id="8001665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001671">clone</span>&nbsp;<span class="op" id="8001677">=</span>&nbsp;<span class="builtinfunc" id="8001679">make</span><span class="op" id="8001683">(</span><span class="op" id="8001684">[</span><span class="op" id="8001685">]</span><span class="builtintype" id="8001686">byte</span><span class="op" id="8001690">,</span>&nbsp;<span class="builtinfunc" id="8001692">len</span><span class="op" id="8001695">(</span><span class="ident" id="8001696">bs</span><span class="op" id="8001698">)</span><span class="op" id="8001699">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8001705">copy</span><span class="op" id="8001709">(</span><span class="ident" id="8001710">clone</span><span class="op" id="8001715">,</span>&nbsp;<span class="ident" id="8001717">bs</span><span class="op" id="8001719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001725">rc</span><span class="op" id="8001727">.</span><span class="ident" id="8001728">bytesClone</span><span class="op" id="8001738">[</span><span class="op" id="8001739">&amp;</span><span class="ident" id="8001740">bs</span><span class="op" id="8001742">[</span><span class="num" id="8001743">0</span><span class="op" id="8001744">]</span><span class="op" id="8001745">]</span>&nbsp;<span class="op" id="8001747">=</span>&nbsp;<span class="ident" id="8001749">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8001763">dest</span><span class="op" id="8001767">[</span><span class="ident" id="8001768">i</span><span class="op" id="8001769">]</span>&nbsp;<span class="op" id="8001771">=</span>&nbsp;<span class="ident" id="8001773">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001781">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8001784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8001787">return</span>&nbsp;<span class="builtintype" id="8001794">nil</span><br>
<span class="lineno"></span><span class="op" id="8001798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8001801">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="8001872">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="8001898">//</span><br>
<span class="lineno"></span><span class="comment" id="8001901">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="8001964">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8002029">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="8002063">//</span><br>
<span class="lineno"></span><span class="keyword" id="8002066">type</span>&nbsp;<span class="ident" id="8002071">fakeDriverString</span>&nbsp;<span class="keyword" id="8002088">struct</span><span class="op" id="8002094">{</span><span class="op" id="8002095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8002098">func</span>&nbsp;<span class="op" id="8002103">(</span><span class="ident" id="8002104">fakeDriverString</span><span class="op" id="8002120">)</span>&nbsp;<span class="ident" id="8002122">ConvertValue</span><span class="op" id="8002134">(</span><span class="ident" id="8002135">v</span>&nbsp;<span class="keyword" id="8002137">interface</span><span class="op" id="8002146">{</span><span class="op" id="8002147">}</span><span class="op" id="8002148">)</span>&nbsp;<span class="op" id="8002150">(</span><span class="ident" id="8002151">driver</span><span class="op" id="8002157">.</span><span class="ident" id="8002158">Value</span><span class="op" id="8002163">,</span>&nbsp;<span class="builtintype" id="8002165">error</span><span class="op" id="8002170">)</span>&nbsp;<span class="op" id="8002172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002175">switch</span>&nbsp;<span class="ident" id="8002182">c</span>&nbsp;<span class="op" id="8002184">:=</span>&nbsp;<span class="ident" id="8002187">v</span><span class="op" id="8002188">.</span><span class="op" id="8002189">(</span><span class="keyword" id="8002190">type</span><span class="op" id="8002194">)</span>&nbsp;<span class="op" id="8002196">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002199">case</span>&nbsp;<span class="builtintype" id="8002204">string</span><span class="op" id="8002210">,</span>&nbsp;<span class="op" id="8002212">[</span><span class="op" id="8002213">]</span><span class="builtintype" id="8002214">byte</span><span class="op" id="8002218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002222">return</span>&nbsp;<span class="ident" id="8002229">v</span><span class="op" id="8002230">,</span>&nbsp;<span class="builtintype" id="8002232">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002237">case</span>&nbsp;<span class="op" id="8002242">*</span><span class="builtintype" id="8002243">string</span><span class="op" id="8002249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002253">if</span>&nbsp;<span class="ident" id="8002256">c</span>&nbsp;<span class="op" id="8002258">==</span>&nbsp;<span class="builtintype" id="8002261">nil</span>&nbsp;<span class="op" id="8002265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002270">return</span>&nbsp;<span class="builtintype" id="8002277">nil</span><span class="op" id="8002280">,</span>&nbsp;<span class="builtintype" id="8002282">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8002288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002292">return</span>&nbsp;<span class="op" id="8002299">*</span><span class="ident" id="8002300">c</span><span class="op" id="8002301">,</span>&nbsp;<span class="builtintype" id="8002303">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8002308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002311">return</span>&nbsp;<span class="ident" id="8002318">fmt</span><span class="op" id="8002321">.</span><span class="ident" id="8002322">Sprintf</span><span class="op" id="8002329">(</span><span class="string" id="8002330">&#34;%v&#34;</span><span class="op" id="8002334">,</span>&nbsp;<span class="ident" id="8002336">v</span><span class="op" id="8002337">)</span><span class="op" id="8002338">,</span>&nbsp;<span class="builtintype" id="8002340">nil</span><br>
<span class="lineno"></span><span class="op" id="8002344">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="8002347">func</span>&nbsp;<span class="ident" id="8002352">converterForType</span><span class="op" id="8002368">(</span><span class="ident" id="8002369">typ</span>&nbsp;<span class="builtintype" id="8002373">string</span><span class="op" id="8002379">)</span>&nbsp;<span class="ident" id="8002381">driver</span><span class="op" id="8002387">.</span><span class="ident" id="8002388">ValueConverter</span>&nbsp;<span class="op" id="8002403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002406">switch</span>&nbsp;<span class="ident" id="8002413">typ</span>&nbsp;<span class="op" id="8002417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002420">case</span>&nbsp;<span class="string" id="8002425">&#34;bool&#34;</span><span class="op" id="8002431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002435">return</span>&nbsp;<span class="ident" id="8002442">driver</span><span class="op" id="8002448">.</span><span class="ident" id="8002449">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002455">case</span>&nbsp;<span class="string" id="8002460">&#34;nullbool&#34;</span><span class="op" id="8002470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002474">return</span>&nbsp;<span class="ident" id="8002481">driver</span><span class="op" id="8002487">.</span><span class="ident" id="8002488">Null</span><span class="op" id="8002492">{</span><span class="ident" id="8002493">Converter</span><span class="op" id="8002502">:</span>&nbsp;<span class="ident" id="8002504">driver</span><span class="op" id="8002510">.</span><span class="ident" id="8002511">Bool</span><span class="op" id="8002515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002518">case</span>&nbsp;<span class="string" id="8002523">&#34;int32&#34;</span><span class="op" id="8002530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002534">return</span>&nbsp;<span class="ident" id="8002541">driver</span><span class="op" id="8002547">.</span><span class="ident" id="8002548">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002555">case</span>&nbsp;<span class="string" id="8002560">&#34;string&#34;</span><span class="op" id="8002568">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002572">return</span>&nbsp;<span class="ident" id="8002579">driver</span><span class="op" id="8002585">.</span><span class="ident" id="8002586">NotNull</span><span class="op" id="8002593">{</span><span class="ident" id="8002594">Converter</span><span class="op" id="8002603">:</span>&nbsp;<span class="ident" id="8002605">fakeDriverString</span><span class="op" id="8002621">{</span><span class="op" id="8002622">}</span><span class="op" id="8002623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002626">case</span>&nbsp;<span class="string" id="8002631">&#34;nullstring&#34;</span><span class="op" id="8002643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002647">return</span>&nbsp;<span class="ident" id="8002654">driver</span><span class="op" id="8002660">.</span><span class="ident" id="8002661">Null</span><span class="op" id="8002665">{</span><span class="ident" id="8002666">Converter</span><span class="op" id="8002675">:</span>&nbsp;<span class="ident" id="8002677">fakeDriverString</span><span class="op" id="8002693">{</span><span class="op" id="8002694">}</span><span class="op" id="8002695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002698">case</span>&nbsp;<span class="string" id="8002703">&#34;int64&#34;</span><span class="op" id="8002710">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8002714">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002766">return</span>&nbsp;<span class="ident" id="8002773">driver</span><span class="op" id="8002779">.</span><span class="ident" id="8002780">NotNull</span><span class="op" id="8002787">{</span><span class="ident" id="8002788">Converter</span><span class="op" id="8002797">:</span>&nbsp;<span class="ident" id="8002799">driver</span><span class="op" id="8002805">.</span><span class="ident" id="8002806">DefaultParameterConverter</span><span class="op" id="8002831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002834">case</span>&nbsp;<span class="string" id="8002839">&#34;nullint64&#34;</span><span class="op" id="8002850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8002854">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002906">return</span>&nbsp;<span class="ident" id="8002913">driver</span><span class="op" id="8002919">.</span><span class="ident" id="8002920">Null</span><span class="op" id="8002924">{</span><span class="ident" id="8002925">Converter</span><span class="op" id="8002934">:</span>&nbsp;<span class="ident" id="8002936">driver</span><span class="op" id="8002942">.</span><span class="ident" id="8002943">DefaultParameterConverter</span><span class="op" id="8002968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8002971">case</span>&nbsp;<span class="string" id="8002976">&#34;float64&#34;</span><span class="op" id="8002985">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8002989">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003041">return</span>&nbsp;<span class="ident" id="8003048">driver</span><span class="op" id="8003054">.</span><span class="ident" id="8003055">NotNull</span><span class="op" id="8003062">{</span><span class="ident" id="8003063">Converter</span><span class="op" id="8003072">:</span>&nbsp;<span class="ident" id="8003074">driver</span><span class="op" id="8003080">.</span><span class="ident" id="8003081">DefaultParameterConverter</span><span class="op" id="8003106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003109">case</span>&nbsp;<span class="string" id="8003114">&#34;nullfloat64&#34;</span><span class="op" id="8003127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8003131">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003183">return</span>&nbsp;<span class="ident" id="8003190">driver</span><span class="op" id="8003196">.</span><span class="ident" id="8003197">Null</span><span class="op" id="8003201">{</span><span class="ident" id="8003202">Converter</span><span class="op" id="8003211">:</span>&nbsp;<span class="ident" id="8003213">driver</span><span class="op" id="8003219">.</span><span class="ident" id="8003220">DefaultParameterConverter</span><span class="op" id="8003245">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003248">case</span>&nbsp;<span class="string" id="8003253">&#34;datetime&#34;</span><span class="op" id="8003263">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003267">return</span>&nbsp;<span class="ident" id="8003274">driver</span><span class="op" id="8003280">.</span><span class="ident" id="8003281">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8003308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8003311">panic</span><span class="op" id="8003316">(</span><span class="string" id="8003317">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="8003350">+</span>&nbsp;<span class="ident" id="8003352">typ</span><span class="op" id="8003355">)</span><br>
<span class="lineno"></span><span class="op" id="8003357">}</span>
</div>
</body>
</html>
