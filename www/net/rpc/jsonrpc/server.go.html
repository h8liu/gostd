<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5774857">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5774913">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5774967">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5775018">package</span>&nbsp;<span class="ident" id="5775026">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775035">import</span>&nbsp;<span class="op" id="5775042">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775045">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775062">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775072">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775078">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5775089">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5775096">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5775099">var</span>&nbsp;<span class="ident" id="5775103">errMissingParams</span>&nbsp;<span class="op" id="5775120">=</span>&nbsp;<span class="ident" id="5775122"><a href="/net/rpc/jsonrpc/server.go.html#5775062">errors</a></span><span class="op" id="5775128">.</span><span class="ident" id="5775129">New</span><span class="op" id="5775132">(</span><span class="string" id="5775133">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5775171">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775174">type</span>&nbsp;<span class="ident" id="5775179">serverCodec</span>&nbsp;<span class="keyword" id="5775191">struct</span>&nbsp;<span class="op" id="5775198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775201">dec</span>&nbsp;<span class="op" id="5775205">*</span><span class="ident" id="5775206"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5775210">.</span><span class="ident" id="5775211">Decoder</span>&nbsp;<span class="comment" id="5775219">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775247">enc</span>&nbsp;<span class="op" id="5775251">*</span><span class="ident" id="5775252"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5775256">.</span><span class="ident" id="5775257">Encoder</span>&nbsp;<span class="comment" id="5775265">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775293">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5775297"><a href="/net/rpc/jsonrpc/server.go.html#5775072">io</a></span><span class="op" id="5775299">.</span><span class="ident" id="5775300">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775309">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775334">req</span>&nbsp;<span class="ident" id="5775338"><a href="/net/rpc/jsonrpc/server.go.html#5776083">serverRequest</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775354">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775421">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775465">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775524">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775581">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5775634">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775684">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5775692"><a href="/net/rpc/jsonrpc/server.go.html#5775089">sync</a></span><span class="op" id="5775696">.</span><span class="ident" id="5775697">Mutex</span>&nbsp;<span class="comment" id="5775703">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775729">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775737">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775745">pending</span>&nbsp;<span class="keyword" id="5775753">map</span><span class="op" id="5775756">[</span><span class="ident" id="5775757">uint64</span><span class="op" id="5775763">]</span><span class="op" id="5775764">*</span><span class="ident" id="5775765"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5775769">.</span><span class="ident" id="5775770">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5775781">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5775784">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5775856">func</span>&nbsp;<span class="ident" id="5775861">NewServerCodec</span><span class="op" id="5775875">(</span><span class="ident" id="5775876">conn</span>&nbsp;<span class="ident" id="5775881"><a href="/net/rpc/jsonrpc/server.go.html#5775072">io</a></span><span class="op" id="5775883">.</span><span class="ident" id="5775884">ReadWriteCloser</span><span class="op" id="5775899">)</span>&nbsp;<span class="ident" id="5775901"><a href="/net/rpc/jsonrpc/server.go.html#5775078">rpc</a></span><span class="op" id="5775904">.</span><span class="ident" id="5775905">ServerCodec</span>&nbsp;<span class="op" id="5775917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5775920">return</span>&nbsp;<span class="op" id="5775927">&amp;</span><span class="ident" id="5775928"><a href="/net/rpc/jsonrpc/server.go.html#5775179">serverCodec</a></span><span class="op" id="5775939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775943">dec</span><span class="op" id="5775946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775952"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5775956">.</span><span class="ident" id="5775957">NewDecoder</span><span class="op" id="5775967">(</span><span class="ident" id="5775968"><a href="/net/rpc/jsonrpc/server.go.html#5775876">conn</a></span><span class="op" id="5775972">)</span><span class="op" id="5775973">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5775977">enc</span><span class="op" id="5775980">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775986"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5775990">.</span><span class="ident" id="5775991">NewEncoder</span><span class="op" id="5776001">(</span><span class="ident" id="5776002"><a href="/net/rpc/jsonrpc/server.go.html#5775876">conn</a></span><span class="op" id="5776006">)</span><span class="op" id="5776007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776011">c</span><span class="op" id="5776012">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776020"><a href="/net/rpc/jsonrpc/server.go.html#5775876">conn</a></span><span class="op" id="5776024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776028">pending</span><span class="op" id="5776035">:</span>&nbsp;<span class="builtinfunc" id="5776037">make</span><span class="op" id="5776041">(</span><span class="keyword" id="5776042">map</span><span class="op" id="5776045">[</span><span class="ident" id="5776046">uint64</span><span class="op" id="5776052">]</span><span class="op" id="5776053">*</span><span class="ident" id="5776054"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5776058">.</span><span class="ident" id="5776059">RawMessage</span><span class="op" id="5776069">)</span><span class="op" id="5776070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5776073">}</span><br>
<span class="lineno"></span><span class="op" id="5776075">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5776078">type</span>&nbsp;<span class="ident" id="5776083">serverRequest</span>&nbsp;<span class="keyword" id="5776097">struct</span>&nbsp;<span class="op" id="5776104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776107">Method</span>&nbsp;<span class="builtintype" id="5776114">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5776131">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776148">Params</span>&nbsp;<span class="op" id="5776155">*</span><span class="ident" id="5776156"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5776160">.</span><span class="ident" id="5776161">RawMessage</span>&nbsp;<span class="string" id="5776172">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776189">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776196">*</span><span class="ident" id="5776197"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5776201">.</span><span class="ident" id="5776202">RawMessage</span>&nbsp;<span class="string" id="5776213">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5776225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5776228">func</span>&nbsp;<span class="op" id="5776233">(</span><span class="ident" id="5776234">r</span>&nbsp;<span class="op" id="5776236">*</span><span class="ident" id="5776237"><a href="/net/rpc/jsonrpc/server.go.html#5776083">serverRequest</a></span><span class="op" id="5776250">)</span>&nbsp;<span class="ident" id="5776252">reset</span><span class="op" id="5776257">(</span><span class="op" id="5776258">)</span>&nbsp;<span class="op" id="5776260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776263"><a href="/net/rpc/jsonrpc/server.go.html#5776234">r</a></span><span class="op" id="5776264">.</span><span class="ident" id="5776265">Method</span>&nbsp;<span class="op" id="5776272">=</span>&nbsp;<span class="string" id="5776274">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776278"><a href="/net/rpc/jsonrpc/server.go.html#5776234">r</a></span><span class="op" id="5776279">.</span><span class="ident" id="5776280">Params</span>&nbsp;<span class="op" id="5776287">=</span>&nbsp;<span class="ident" id="5776289">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776294"><a href="/net/rpc/jsonrpc/server.go.html#5776234">r</a></span><span class="op" id="5776295">.</span><span class="ident" id="5776296">Id</span>&nbsp;<span class="op" id="5776299">=</span>&nbsp;<span class="ident" id="5776301">nil</span><br>
<span class="lineno"></span><span class="op" id="5776305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5776308">type</span>&nbsp;<span class="ident" id="5776313">serverResponse</span>&nbsp;<span class="keyword" id="5776328">struct</span>&nbsp;<span class="op" id="5776335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776338">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776345">*</span><span class="ident" id="5776346"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5776350">.</span><span class="ident" id="5776351">RawMessage</span>&nbsp;<span class="string" id="5776362">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776375">Result</span>&nbsp;<span class="keyword" id="5776382">interface</span><span class="op" id="5776391">{</span><span class="op" id="5776392">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5776399">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776416">Error</span>&nbsp;&nbsp;<span class="keyword" id="5776423">interface</span><span class="op" id="5776432">{</span><span class="op" id="5776433">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5776440">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5776455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5776458">func</span>&nbsp;<span class="op" id="5776463">(</span><span class="ident" id="5776464">c</span>&nbsp;<span class="op" id="5776466">*</span><span class="ident" id="5776467"><a href="/net/rpc/jsonrpc/server.go.html#5775179">serverCodec</a></span><span class="op" id="5776478">)</span>&nbsp;<span class="ident" id="5776480">ReadRequestHeader</span><span class="op" id="5776497">(</span><span class="ident" id="5776498">r</span>&nbsp;<span class="op" id="5776500">*</span><span class="ident" id="5776501"><a href="/net/rpc/jsonrpc/server.go.html#5775078">rpc</a></span><span class="op" id="5776504">.</span><span class="ident" id="5776505">Request</span><span class="op" id="5776512">)</span>&nbsp;<span class="builtintype" id="5776514">error</span>&nbsp;<span class="op" id="5776520">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776523"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776524">.</span><span class="ident" id="5776525">req</span><span class="op" id="5776528">.</span><span class="ident" id="5776529">reset</span><span class="op" id="5776534">(</span><span class="op" id="5776535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776538">if</span>&nbsp;<span class="ident" id="5776541">err</span>&nbsp;<span class="op" id="5776545">:=</span>&nbsp;<span class="ident" id="5776548"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776549">.</span><span class="ident" id="5776550">dec</span><span class="op" id="5776553">.</span><span class="ident" id="5776554">Decode</span><span class="op" id="5776560">(</span><span class="op" id="5776561">&amp;</span><span class="ident" id="5776562"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776563">.</span><span class="ident" id="5776564">req</span><span class="op" id="5776567">)</span><span class="op" id="5776568">;</span>&nbsp;<span class="ident" id="5776570"><a href="/net/rpc/jsonrpc/server.go.html#5776541">err</a></span>&nbsp;<span class="op" id="5776574">!=</span>&nbsp;<span class="ident" id="5776577">nil</span>&nbsp;<span class="op" id="5776581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776585">return</span>&nbsp;<span class="ident" id="5776592"><a href="/net/rpc/jsonrpc/server.go.html#5776541">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5776597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776600"><a href="/net/rpc/jsonrpc/server.go.html#5776498">r</a></span><span class="op" id="5776601">.</span><span class="ident" id="5776602">ServiceMethod</span>&nbsp;<span class="op" id="5776616">=</span>&nbsp;<span class="ident" id="5776618"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776619">.</span><span class="ident" id="5776620">req</span><span class="op" id="5776623">.</span><span class="ident" id="5776624">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776633">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776676">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5776722">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776769"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776770">.</span><span class="ident" id="5776771">mutex</span><span class="op" id="5776776">.</span><span class="ident" id="5776777">Lock</span><span class="op" id="5776781">(</span><span class="op" id="5776782">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776785"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776786">.</span><span class="ident" id="5776787">seq</span><span class="op" id="5776790">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776794"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776795">.</span><span class="ident" id="5776796">pending</span><span class="op" id="5776803">[</span><span class="ident" id="5776804"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776805">.</span><span class="ident" id="5776806">seq</span><span class="op" id="5776809">]</span>&nbsp;<span class="op" id="5776811">=</span>&nbsp;<span class="ident" id="5776813"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776814">.</span><span class="ident" id="5776815">req</span><span class="op" id="5776818">.</span><span class="ident" id="5776819">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776823"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776824">.</span><span class="ident" id="5776825">req</span><span class="op" id="5776828">.</span><span class="ident" id="5776829">Id</span>&nbsp;<span class="op" id="5776832">=</span>&nbsp;<span class="ident" id="5776834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776839"><a href="/net/rpc/jsonrpc/server.go.html#5776498">r</a></span><span class="op" id="5776840">.</span><span class="ident" id="5776841">Seq</span>&nbsp;<span class="op" id="5776845">=</span>&nbsp;<span class="ident" id="5776847"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776848">.</span><span class="ident" id="5776849">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5776854"><a href="/net/rpc/jsonrpc/server.go.html#5776464">c</a></span><span class="op" id="5776855">.</span><span class="ident" id="5776856">mutex</span><span class="op" id="5776861">.</span><span class="ident" id="5776862">Unlock</span><span class="op" id="5776868">(</span><span class="op" id="5776869">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776873">return</span>&nbsp;<span class="ident" id="5776880">nil</span><br>
<span class="lineno"></span><span class="op" id="5776884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5776887">func</span>&nbsp;<span class="op" id="5776892">(</span><span class="ident" id="5776893">c</span>&nbsp;<span class="op" id="5776895">*</span><span class="ident" id="5776896"><a href="/net/rpc/jsonrpc/server.go.html#5775179">serverCodec</a></span><span class="op" id="5776907">)</span>&nbsp;<span class="ident" id="5776909">ReadRequestBody</span><span class="op" id="5776924">(</span><span class="ident" id="5776925">x</span>&nbsp;<span class="keyword" id="5776927">interface</span><span class="op" id="5776936">{</span><span class="op" id="5776937">}</span><span class="op" id="5776938">)</span>&nbsp;<span class="builtintype" id="5776940">error</span>&nbsp;<span class="op" id="5776946">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776949">if</span>&nbsp;<span class="ident" id="5776952"><a href="/net/rpc/jsonrpc/server.go.html#5776925">x</a></span>&nbsp;<span class="op" id="5776954">==</span>&nbsp;<span class="ident" id="5776957">nil</span>&nbsp;<span class="op" id="5776961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776965">return</span>&nbsp;<span class="ident" id="5776972">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5776977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5776980">if</span>&nbsp;<span class="ident" id="5776983"><a href="/net/rpc/jsonrpc/server.go.html#5776893">c</a></span><span class="op" id="5776984">.</span><span class="ident" id="5776985">req</span><span class="op" id="5776988">.</span><span class="ident" id="5776989">Params</span>&nbsp;<span class="op" id="5776996">==</span>&nbsp;<span class="ident" id="5776999">nil</span>&nbsp;<span class="op" id="5777003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777007">return</span>&nbsp;<span class="ident" id="5777014"><a href="/net/rpc/jsonrpc/server.go.html#5775103">errMissingParams</a></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777035">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777067">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777093">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777145">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777193">var</span>&nbsp;<span class="ident" id="5777197">params</span>&nbsp;<span class="op" id="5777204">[</span><span class="num" id="5777205">1</span><span class="op" id="5777206">]</span><span class="keyword" id="5777207">interface</span><span class="op" id="5777216">{</span><span class="op" id="5777217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777220"><a href="/net/rpc/jsonrpc/server.go.html#5777197">params</a></span><span class="op" id="5777226">[</span><span class="num" id="5777227">0</span><span class="op" id="5777228">]</span>&nbsp;<span class="op" id="5777230">=</span>&nbsp;<span class="ident" id="5777232"><a href="/net/rpc/jsonrpc/server.go.html#5776925">x</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777235">return</span>&nbsp;<span class="ident" id="5777242"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5777246">.</span><span class="ident" id="5777247">Unmarshal</span><span class="op" id="5777256">(</span><span class="op" id="5777257">*</span><span class="ident" id="5777258"><a href="/net/rpc/jsonrpc/server.go.html#5776893">c</a></span><span class="op" id="5777259">.</span><span class="ident" id="5777260">req</span><span class="op" id="5777263">.</span><span class="ident" id="5777264">Params</span><span class="op" id="5777270">,</span>&nbsp;<span class="op" id="5777272">&amp;</span><span class="ident" id="5777273"><a href="/net/rpc/jsonrpc/server.go.html#5777197">params</a></span><span class="op" id="5777279">)</span><br>
<span class="lineno"></span><span class="op" id="5777281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5777284">var</span>&nbsp;<span class="ident" id="5777288">null</span>&nbsp;<span class="op" id="5777293">=</span>&nbsp;<span class="ident" id="5777295"><a href="/net/rpc/jsonrpc/server.go.html#5775045">json</a></span><span class="op" id="5777299">.</span><span class="ident" id="5777300">RawMessage</span><span class="op" id="5777310">(</span><span class="op" id="5777311">[</span><span class="op" id="5777312">]</span><span class="builtintype" id="5777313">byte</span><span class="op" id="5777317">(</span><span class="string" id="5777318">&#34;null&#34;</span><span class="op" id="5777324">)</span><span class="op" id="5777325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5777328">func</span>&nbsp;<span class="op" id="5777333">(</span><span class="ident" id="5777334">c</span>&nbsp;<span class="op" id="5777336">*</span><span class="ident" id="5777337"><a href="/net/rpc/jsonrpc/server.go.html#5775179">serverCodec</a></span><span class="op" id="5777348">)</span>&nbsp;<span class="ident" id="5777350">WriteResponse</span><span class="op" id="5777363">(</span><span class="ident" id="5777364">r</span>&nbsp;<span class="op" id="5777366">*</span><span class="ident" id="5777367"><a href="/net/rpc/jsonrpc/server.go.html#5775078">rpc</a></span><span class="op" id="5777370">.</span><span class="ident" id="5777371">Response</span><span class="op" id="5777379">,</span>&nbsp;<span class="ident" id="5777381">x</span>&nbsp;<span class="keyword" id="5777383">interface</span><span class="op" id="5777392">{</span><span class="op" id="5777393">}</span><span class="op" id="5777394">)</span>&nbsp;<span class="builtintype" id="5777396">error</span>&nbsp;<span class="op" id="5777402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777405"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777406">.</span><span class="ident" id="5777407">mutex</span><span class="op" id="5777412">.</span><span class="ident" id="5777413">Lock</span><span class="op" id="5777417">(</span><span class="op" id="5777418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777421">b</span><span class="op" id="5777422">,</span>&nbsp;<span class="ident" id="5777424">ok</span>&nbsp;<span class="op" id="5777427">:=</span>&nbsp;<span class="ident" id="5777430"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777431">.</span><span class="ident" id="5777432">pending</span><span class="op" id="5777439">[</span><span class="ident" id="5777440"><a href="/net/rpc/jsonrpc/server.go.html#5777364">r</a></span><span class="op" id="5777441">.</span><span class="ident" id="5777442">Seq</span><span class="op" id="5777445">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777448">if</span>&nbsp;<span class="op" id="5777451">!</span><span class="ident" id="5777452"><a href="/net/rpc/jsonrpc/server.go.html#5777424">ok</a></span>&nbsp;<span class="op" id="5777455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777459"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777460">.</span><span class="ident" id="5777461">mutex</span><span class="op" id="5777466">.</span><span class="ident" id="5777467">Unlock</span><span class="op" id="5777473">(</span><span class="op" id="5777474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777478">return</span>&nbsp;<span class="ident" id="5777485"><a href="/net/rpc/jsonrpc/server.go.html#5775062">errors</a></span><span class="op" id="5777491">.</span><span class="ident" id="5777492">New</span><span class="op" id="5777495">(</span><span class="string" id="5777496">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5777533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5777539">delete</span><span class="op" id="5777545">(</span><span class="ident" id="5777546"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777547">.</span><span class="ident" id="5777548">pending</span><span class="op" id="5777555">,</span>&nbsp;<span class="ident" id="5777557"><a href="/net/rpc/jsonrpc/server.go.html#5777364">r</a></span><span class="op" id="5777558">.</span><span class="ident" id="5777559">Seq</span><span class="op" id="5777562">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777565"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777566">.</span><span class="ident" id="5777567">mutex</span><span class="op" id="5777572">.</span><span class="ident" id="5777573">Unlock</span><span class="op" id="5777579">(</span><span class="op" id="5777580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777584">if</span>&nbsp;<span class="ident" id="5777587"><a href="/net/rpc/jsonrpc/server.go.html#5777421">b</a></span>&nbsp;<span class="op" id="5777589">==</span>&nbsp;<span class="ident" id="5777592">nil</span>&nbsp;<span class="op" id="5777596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5777600">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777647"><a href="/net/rpc/jsonrpc/server.go.html#5777421">b</a></span>&nbsp;<span class="op" id="5777649">=</span>&nbsp;<span class="op" id="5777651">&amp;</span><span class="ident" id="5777652"><a href="/net/rpc/jsonrpc/server.go.html#5777288">null</a></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777661">resp</span>&nbsp;<span class="op" id="5777666">:=</span>&nbsp;<span class="ident" id="5777669"><a href="/net/rpc/jsonrpc/server.go.html#5776313">serverResponse</a></span><span class="op" id="5777683">{</span><span class="ident" id="5777684">Id</span><span class="op" id="5777686">:</span>&nbsp;<span class="ident" id="5777688"><a href="/net/rpc/jsonrpc/server.go.html#5777421">b</a></span><span class="op" id="5777689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777692">if</span>&nbsp;<span class="ident" id="5777695"><a href="/net/rpc/jsonrpc/server.go.html#5777364">r</a></span><span class="op" id="5777696">.</span><span class="ident" id="5777697">Error</span>&nbsp;<span class="op" id="5777703">==</span>&nbsp;<span class="string" id="5777706">&#34;&#34;</span>&nbsp;<span class="op" id="5777709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777713"><a href="/net/rpc/jsonrpc/server.go.html#5777661">resp</a></span><span class="op" id="5777717">.</span><span class="ident" id="5777718">Result</span>&nbsp;<span class="op" id="5777725">=</span>&nbsp;<span class="ident" id="5777727"><a href="/net/rpc/jsonrpc/server.go.html#5777381">x</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777730">}</span>&nbsp;<span class="keyword" id="5777732">else</span>&nbsp;<span class="op" id="5777737">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5777741"><a href="/net/rpc/jsonrpc/server.go.html#5777661">resp</a></span><span class="op" id="5777745">.</span><span class="ident" id="5777746">Error</span>&nbsp;<span class="op" id="5777752">=</span>&nbsp;<span class="ident" id="5777754"><a href="/net/rpc/jsonrpc/server.go.html#5777364">r</a></span><span class="op" id="5777755">.</span><span class="ident" id="5777756">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5777763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777766">return</span>&nbsp;<span class="ident" id="5777773"><a href="/net/rpc/jsonrpc/server.go.html#5777334">c</a></span><span class="op" id="5777774">.</span><span class="ident" id="5777775">enc</span><span class="op" id="5777778">.</span><span class="ident" id="5777779">Encode</span><span class="op" id="5777785">(</span><span class="ident" id="5777786"><a href="/net/rpc/jsonrpc/server.go.html#5777661">resp</a></span><span class="op" id="5777790">)</span><br>
<span class="lineno"></span><span class="op" id="5777792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5777795">func</span>&nbsp;<span class="op" id="5777800">(</span><span class="ident" id="5777801">c</span>&nbsp;<span class="op" id="5777803">*</span><span class="ident" id="5777804"><a href="/net/rpc/jsonrpc/server.go.html#5775179">serverCodec</a></span><span class="op" id="5777815">)</span>&nbsp;<span class="ident" id="5777817">Close</span><span class="op" id="5777822">(</span><span class="op" id="5777823">)</span>&nbsp;<span class="builtintype" id="5777825">error</span>&nbsp;<span class="op" id="5777831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5777834">return</span>&nbsp;<span class="ident" id="5777841"><a href="/net/rpc/jsonrpc/server.go.html#5777801">c</a></span><span class="op" id="5777842">.</span><span class="ident" id="5777843">c</span><span class="op" id="5777844">.</span><span class="ident" id="5777845">Close</span><span class="op" id="5777850">(</span><span class="op" id="5777851">)</span><br>
<span class="lineno"></span><span class="op" id="5777853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777856">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5777918">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5777989">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5778050">func</span>&nbsp;<span class="ident" id="5778055">ServeConn</span><span class="op" id="5778064">(</span><span class="ident" id="5778065">conn</span>&nbsp;<span class="ident" id="5778070"><a href="/net/rpc/jsonrpc/server.go.html#5775072">io</a></span><span class="op" id="5778072">.</span><span class="ident" id="5778073">ReadWriteCloser</span><span class="op" id="5778088">)</span>&nbsp;<span class="op" id="5778090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5778093"><a href="/net/rpc/jsonrpc/server.go.html#5775078">rpc</a></span><span class="op" id="5778096">.</span><span class="ident" id="5778097">ServeCodec</span><span class="op" id="5778107">(</span><span class="ident" id="5778108"><a href="/net/rpc/jsonrpc/server.go.html#5775861">NewServerCodec</a></span><span class="op" id="5778122">(</span><span class="ident" id="5778123"><a href="/net/rpc/jsonrpc/server.go.html#5778065">conn</a></span><span class="op" id="5778127">)</span><span class="op" id="5778128">)</span><br>
<span class="lineno"></span><span class="op" id="5778130">}</span>
</div>
</body>
</html>
