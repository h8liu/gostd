<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3737036">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3737091">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3737145">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3737196">package</span>&nbsp;<span class="ident" id="3737204">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737209">import</span>&nbsp;<span class="op" id="3737216">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737219">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737229">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737245">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737264">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737278">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737292">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737307">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737324">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737339">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737356">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737366">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3737372">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3737383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737386">var</span>&nbsp;<span class="ident" id="3737390">errClientKeyExchange</span>&nbsp;<span class="op" id="3737411">=</span>&nbsp;<span class="ident" id="3737413">errors</span><span class="op" id="3737419">.</span><span class="ident" id="3737420">New</span><span class="op" id="3737423">(</span><span class="string" id="3737424">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3737464">)</span><br>
<span class="lineno"></span><span class="keyword" id="3737466">var</span>&nbsp;<span class="ident" id="3737470">errServerKeyExchange</span>&nbsp;<span class="op" id="3737491">=</span>&nbsp;<span class="ident" id="3737493">errors</span><span class="op" id="3737499">.</span><span class="ident" id="3737500">New</span><span class="op" id="3737503">(</span><span class="string" id="3737504">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3737544">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3737547">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3737625">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3737687">type</span>&nbsp;<span class="ident" id="3737692">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3737708">struct</span><span class="op" id="3737714">{</span><span class="op" id="3737715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737718">func</span>&nbsp;<span class="op" id="3737723">(</span><span class="ident" id="3737724">ka</span>&nbsp;<span class="ident" id="3737727">rsaKeyAgreement</span><span class="op" id="3737742">)</span>&nbsp;<span class="ident" id="3737744">generateServerKeyExchange</span><span class="op" id="3737769">(</span><span class="ident" id="3737770">config</span>&nbsp;<span class="op" id="3737777">*</span><span class="ident" id="3737778">Config</span><span class="op" id="3737784">,</span>&nbsp;<span class="ident" id="3737786">cert</span>&nbsp;<span class="op" id="3737791">*</span><span class="ident" id="3737792">Certificate</span><span class="op" id="3737803">,</span>&nbsp;<span class="ident" id="3737805">clientHello</span>&nbsp;<span class="op" id="3737817">*</span><span class="ident" id="3737818">clientHelloMsg</span><span class="op" id="3737832">,</span>&nbsp;<span class="ident" id="3737834">hello</span>&nbsp;<span class="op" id="3737840">*</span><span class="ident" id="3737841">serverHelloMsg</span><span class="op" id="3737855">)</span>&nbsp;<span class="op" id="3737857">(</span><span class="op" id="3737858">*</span><span class="ident" id="3737859">serverKeyExchangeMsg</span><span class="op" id="3737879">,</span>&nbsp;<span class="builtintype" id="3737881">error</span><span class="op" id="3737886">)</span>&nbsp;<span class="op" id="3737888">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737891">return</span>&nbsp;<span class="ident" id="3737898">nil</span><span class="op" id="3737901">,</span>&nbsp;<span class="ident" id="3737903">nil</span><br>
<span class="lineno"></span><span class="op" id="3737907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737910">func</span>&nbsp;<span class="op" id="3737915">(</span><span class="ident" id="3737916">ka</span>&nbsp;<span class="ident" id="3737919">rsaKeyAgreement</span><span class="op" id="3737934">)</span>&nbsp;<span class="ident" id="3737936">processClientKeyExchange</span><span class="op" id="3737960">(</span><span class="ident" id="3737961">config</span>&nbsp;<span class="op" id="3737968">*</span><span class="ident" id="3737969">Config</span><span class="op" id="3737975">,</span>&nbsp;<span class="ident" id="3737977">cert</span>&nbsp;<span class="op" id="3737982">*</span><span class="ident" id="3737983">Certificate</span><span class="op" id="3737994">,</span>&nbsp;<span class="ident" id="3737996">ckx</span>&nbsp;<span class="op" id="3738000">*</span><span class="ident" id="3738001">clientKeyExchangeMsg</span><span class="op" id="3738021">,</span>&nbsp;<span class="ident" id="3738023">version</span>&nbsp;<span class="builtintype" id="3738031">uint16</span><span class="op" id="3738037">)</span>&nbsp;<span class="op" id="3738039">(</span><span class="op" id="3738040">[</span><span class="op" id="3738041">]</span><span class="builtintype" id="3738042">byte</span><span class="op" id="3738046">,</span>&nbsp;<span class="builtintype" id="3738048">error</span><span class="op" id="3738053">)</span>&nbsp;<span class="op" id="3738055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738058">preMasterSecret</span>&nbsp;<span class="op" id="3738074">:=</span>&nbsp;<span class="builtinfunc" id="3738077">make</span><span class="op" id="3738081">(</span><span class="op" id="3738082">[</span><span class="op" id="3738083">]</span><span class="builtintype" id="3738084">byte</span><span class="op" id="3738088">,</span>&nbsp;<span class="num" id="3738090">48</span><span class="op" id="3738092">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738095">_</span><span class="op" id="3738096">,</span>&nbsp;<span class="ident" id="3738098">err</span>&nbsp;<span class="op" id="3738102">:=</span>&nbsp;<span class="ident" id="3738105">io</span><span class="op" id="3738107">.</span><span class="ident" id="3738108">ReadFull</span><span class="op" id="3738116">(</span><span class="ident" id="3738117">config</span><span class="op" id="3738123">.</span><span class="ident" id="3738124">rand</span><span class="op" id="3738128">(</span><span class="op" id="3738129">)</span><span class="op" id="3738130">,</span>&nbsp;<span class="ident" id="3738132">preMasterSecret</span><span class="op" id="3738147">[</span><span class="num" id="3738148">2</span><span class="op" id="3738149">:</span><span class="op" id="3738150">]</span><span class="op" id="3738151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738154">if</span>&nbsp;<span class="ident" id="3738157">err</span>&nbsp;<span class="op" id="3738161">!=</span>&nbsp;<span class="ident" id="3738164">nil</span>&nbsp;<span class="op" id="3738168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738172">return</span>&nbsp;<span class="ident" id="3738179">nil</span><span class="op" id="3738182">,</span>&nbsp;<span class="ident" id="3738184">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738193">if</span>&nbsp;<span class="builtinfunc" id="3738196">len</span><span class="op" id="3738199">(</span><span class="ident" id="3738200">ckx</span><span class="op" id="3738203">.</span><span class="ident" id="3738204">ciphertext</span><span class="op" id="3738214">)</span>&nbsp;<span class="op" id="3738216">&lt;</span>&nbsp;<span class="num" id="3738218">2</span>&nbsp;<span class="op" id="3738220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738224">return</span>&nbsp;<span class="ident" id="3738231">nil</span><span class="op" id="3738234">,</span>&nbsp;<span class="ident" id="3738236">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738262">ciphertext</span>&nbsp;<span class="op" id="3738273">:=</span>&nbsp;<span class="ident" id="3738276">ckx</span><span class="op" id="3738279">.</span><span class="ident" id="3738280">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738292">if</span>&nbsp;<span class="ident" id="3738295">version</span>&nbsp;<span class="op" id="3738303">!=</span>&nbsp;<span class="ident" id="3738306">VersionSSL30</span>&nbsp;<span class="op" id="3738319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738323">ciphertextLen</span>&nbsp;<span class="op" id="3738337">:=</span>&nbsp;<span class="builtintype" id="3738340">int</span><span class="op" id="3738343">(</span><span class="ident" id="3738344">ckx</span><span class="op" id="3738347">.</span><span class="ident" id="3738348">ciphertext</span><span class="op" id="3738358">[</span><span class="num" id="3738359">0</span><span class="op" id="3738360">]</span><span class="op" id="3738361">)</span><span class="op" id="3738362">&lt;&lt;</span><span class="num" id="3738364">8</span>&nbsp;<span class="op" id="3738366">|</span>&nbsp;<span class="builtintype" id="3738368">int</span><span class="op" id="3738371">(</span><span class="ident" id="3738372">ckx</span><span class="op" id="3738375">.</span><span class="ident" id="3738376">ciphertext</span><span class="op" id="3738386">[</span><span class="num" id="3738387">1</span><span class="op" id="3738388">]</span><span class="op" id="3738389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738393">if</span>&nbsp;<span class="ident" id="3738396">ciphertextLen</span>&nbsp;<span class="op" id="3738410">!=</span>&nbsp;<span class="builtinfunc" id="3738413">len</span><span class="op" id="3738416">(</span><span class="ident" id="3738417">ckx</span><span class="op" id="3738420">.</span><span class="ident" id="3738421">ciphertext</span><span class="op" id="3738431">)</span><span class="op" id="3738432">-</span><span class="num" id="3738433">2</span>&nbsp;<span class="op" id="3738435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738440">return</span>&nbsp;<span class="ident" id="3738447">nil</span><span class="op" id="3738450">,</span>&nbsp;<span class="ident" id="3738452">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738475">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738479">ciphertext</span>&nbsp;<span class="op" id="3738490">=</span>&nbsp;<span class="ident" id="3738492">ckx</span><span class="op" id="3738495">.</span><span class="ident" id="3738496">ciphertext</span><span class="op" id="3738506">[</span><span class="num" id="3738507">2</span><span class="op" id="3738508">:</span><span class="op" id="3738509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738516">err</span>&nbsp;<span class="op" id="3738520">=</span>&nbsp;<span class="ident" id="3738522">rsa</span><span class="op" id="3738525">.</span><span class="ident" id="3738526">DecryptPKCS1v15SessionKey</span><span class="op" id="3738551">(</span><span class="ident" id="3738552">config</span><span class="op" id="3738558">.</span><span class="ident" id="3738559">rand</span><span class="op" id="3738563">(</span><span class="op" id="3738564">)</span><span class="op" id="3738565">,</span>&nbsp;<span class="ident" id="3738567">cert</span><span class="op" id="3738571">.</span><span class="ident" id="3738572">PrivateKey</span><span class="op" id="3738582">.</span><span class="op" id="3738583">(</span><span class="op" id="3738584">*</span><span class="ident" id="3738585">rsa</span><span class="op" id="3738588">.</span><span class="ident" id="3738589">PrivateKey</span><span class="op" id="3738599">)</span><span class="op" id="3738600">,</span>&nbsp;<span class="ident" id="3738602">ciphertext</span><span class="op" id="3738612">,</span>&nbsp;<span class="ident" id="3738614">preMasterSecret</span><span class="op" id="3738629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738632">if</span>&nbsp;<span class="ident" id="3738635">err</span>&nbsp;<span class="op" id="3738639">!=</span>&nbsp;<span class="ident" id="3738642">nil</span>&nbsp;<span class="op" id="3738646">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738650">return</span>&nbsp;<span class="ident" id="3738657">nil</span><span class="op" id="3738660">,</span>&nbsp;<span class="ident" id="3738662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738670">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738743">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738815">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738883">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738956">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739023">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739048">return</span>&nbsp;<span class="ident" id="3739055">preMasterSecret</span><span class="op" id="3739070">,</span>&nbsp;<span class="ident" id="3739072">nil</span><br>
<span class="lineno"></span><span class="op" id="3739076">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3739079">func</span>&nbsp;<span class="op" id="3739084">(</span><span class="ident" id="3739085">ka</span>&nbsp;<span class="ident" id="3739088">rsaKeyAgreement</span><span class="op" id="3739103">)</span>&nbsp;<span class="ident" id="3739105">processServerKeyExchange</span><span class="op" id="3739129">(</span><span class="ident" id="3739130">config</span>&nbsp;<span class="op" id="3739137">*</span><span class="ident" id="3739138">Config</span><span class="op" id="3739144">,</span>&nbsp;<span class="ident" id="3739146">clientHello</span>&nbsp;<span class="op" id="3739158">*</span><span class="ident" id="3739159">clientHelloMsg</span><span class="op" id="3739173">,</span>&nbsp;<span class="ident" id="3739175">serverHello</span>&nbsp;<span class="op" id="3739187">*</span><span class="ident" id="3739188">serverHelloMsg</span><span class="op" id="3739202">,</span>&nbsp;<span class="ident" id="3739204">cert</span>&nbsp;<span class="op" id="3739209">*</span><span class="ident" id="3739210">x509</span><span class="op" id="3739214">.</span><span class="ident" id="3739215">Certificate</span><span class="op" id="3739226">,</span>&nbsp;<span class="ident" id="3739228">skx</span>&nbsp;<span class="op" id="3739232">*</span><span class="ident" id="3739233">serverKeyExchangeMsg</span><span class="op" id="3739253">)</span>&nbsp;<span class="builtintype" id="3739255">error</span>&nbsp;<span class="op" id="3739261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739264">return</span>&nbsp;<span class="ident" id="3739271">errors</span><span class="op" id="3739277">.</span><span class="ident" id="3739278">New</span><span class="op" id="3739281">(</span><span class="string" id="3739282">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3739317">)</span><br>
<span class="lineno"></span><span class="op" id="3739319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3739322">func</span>&nbsp;<span class="op" id="3739327">(</span><span class="ident" id="3739328">ka</span>&nbsp;<span class="ident" id="3739331">rsaKeyAgreement</span><span class="op" id="3739346">)</span>&nbsp;<span class="ident" id="3739348">generateClientKeyExchange</span><span class="op" id="3739373">(</span><span class="ident" id="3739374">config</span>&nbsp;<span class="op" id="3739381">*</span><span class="ident" id="3739382">Config</span><span class="op" id="3739388">,</span>&nbsp;<span class="ident" id="3739390">clientHello</span>&nbsp;<span class="op" id="3739402">*</span><span class="ident" id="3739403">clientHelloMsg</span><span class="op" id="3739417">,</span>&nbsp;<span class="ident" id="3739419">cert</span>&nbsp;<span class="op" id="3739424">*</span><span class="ident" id="3739425">x509</span><span class="op" id="3739429">.</span><span class="ident" id="3739430">Certificate</span><span class="op" id="3739441">)</span>&nbsp;<span class="op" id="3739443">(</span><span class="op" id="3739444">[</span><span class="op" id="3739445">]</span><span class="builtintype" id="3739446">byte</span><span class="op" id="3739450">,</span>&nbsp;<span class="op" id="3739452">*</span><span class="ident" id="3739453">clientKeyExchangeMsg</span><span class="op" id="3739473">,</span>&nbsp;<span class="builtintype" id="3739475">error</span><span class="op" id="3739480">)</span>&nbsp;<span class="op" id="3739482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739485">preMasterSecret</span>&nbsp;<span class="op" id="3739501">:=</span>&nbsp;<span class="builtinfunc" id="3739504">make</span><span class="op" id="3739508">(</span><span class="op" id="3739509">[</span><span class="op" id="3739510">]</span><span class="builtintype" id="3739511">byte</span><span class="op" id="3739515">,</span>&nbsp;<span class="num" id="3739517">48</span><span class="op" id="3739519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739522">preMasterSecret</span><span class="op" id="3739537">[</span><span class="num" id="3739538">0</span><span class="op" id="3739539">]</span>&nbsp;<span class="op" id="3739541">=</span>&nbsp;<span class="builtintype" id="3739543">byte</span><span class="op" id="3739547">(</span><span class="ident" id="3739548">clientHello</span><span class="op" id="3739559">.</span><span class="ident" id="3739560">vers</span>&nbsp;<span class="op" id="3739565">&gt;&gt;</span>&nbsp;<span class="num" id="3739568">8</span><span class="op" id="3739569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739572">preMasterSecret</span><span class="op" id="3739587">[</span><span class="num" id="3739588">1</span><span class="op" id="3739589">]</span>&nbsp;<span class="op" id="3739591">=</span>&nbsp;<span class="builtintype" id="3739593">byte</span><span class="op" id="3739597">(</span><span class="ident" id="3739598">clientHello</span><span class="op" id="3739609">.</span><span class="ident" id="3739610">vers</span><span class="op" id="3739614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739617">_</span><span class="op" id="3739618">,</span>&nbsp;<span class="ident" id="3739620">err</span>&nbsp;<span class="op" id="3739624">:=</span>&nbsp;<span class="ident" id="3739627">io</span><span class="op" id="3739629">.</span><span class="ident" id="3739630">ReadFull</span><span class="op" id="3739638">(</span><span class="ident" id="3739639">config</span><span class="op" id="3739645">.</span><span class="ident" id="3739646">rand</span><span class="op" id="3739650">(</span><span class="op" id="3739651">)</span><span class="op" id="3739652">,</span>&nbsp;<span class="ident" id="3739654">preMasterSecret</span><span class="op" id="3739669">[</span><span class="num" id="3739670">2</span><span class="op" id="3739671">:</span><span class="op" id="3739672">]</span><span class="op" id="3739673">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739676">if</span>&nbsp;<span class="ident" id="3739679">err</span>&nbsp;<span class="op" id="3739683">!=</span>&nbsp;<span class="ident" id="3739686">nil</span>&nbsp;<span class="op" id="3739690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739694">return</span>&nbsp;<span class="ident" id="3739701">nil</span><span class="op" id="3739704">,</span>&nbsp;<span class="ident" id="3739706">nil</span><span class="op" id="3739709">,</span>&nbsp;<span class="ident" id="3739711">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739720">encrypted</span><span class="op" id="3739729">,</span>&nbsp;<span class="ident" id="3739731">err</span>&nbsp;<span class="op" id="3739735">:=</span>&nbsp;<span class="ident" id="3739738">rsa</span><span class="op" id="3739741">.</span><span class="ident" id="3739742">EncryptPKCS1v15</span><span class="op" id="3739757">(</span><span class="ident" id="3739758">config</span><span class="op" id="3739764">.</span><span class="ident" id="3739765">rand</span><span class="op" id="3739769">(</span><span class="op" id="3739770">)</span><span class="op" id="3739771">,</span>&nbsp;<span class="ident" id="3739773">cert</span><span class="op" id="3739777">.</span><span class="ident" id="3739778">PublicKey</span><span class="op" id="3739787">.</span><span class="op" id="3739788">(</span><span class="op" id="3739789">*</span><span class="ident" id="3739790">rsa</span><span class="op" id="3739793">.</span><span class="ident" id="3739794">PublicKey</span><span class="op" id="3739803">)</span><span class="op" id="3739804">,</span>&nbsp;<span class="ident" id="3739806">preMasterSecret</span><span class="op" id="3739821">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739824">if</span>&nbsp;<span class="ident" id="3739827">err</span>&nbsp;<span class="op" id="3739831">!=</span>&nbsp;<span class="ident" id="3739834">nil</span>&nbsp;<span class="op" id="3739838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739842">return</span>&nbsp;<span class="ident" id="3739849">nil</span><span class="op" id="3739852">,</span>&nbsp;<span class="ident" id="3739854">nil</span><span class="op" id="3739857">,</span>&nbsp;<span class="ident" id="3739859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739867">ckx</span>&nbsp;<span class="op" id="3739871">:=</span>&nbsp;<span class="builtinfunc" id="3739874">new</span><span class="op" id="3739877">(</span><span class="ident" id="3739878">clientKeyExchangeMsg</span><span class="op" id="3739898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739901">ckx</span><span class="op" id="3739904">.</span><span class="ident" id="3739905">ciphertext</span>&nbsp;<span class="op" id="3739916">=</span>&nbsp;<span class="builtinfunc" id="3739918">make</span><span class="op" id="3739922">(</span><span class="op" id="3739923">[</span><span class="op" id="3739924">]</span><span class="builtintype" id="3739925">byte</span><span class="op" id="3739929">,</span>&nbsp;<span class="builtinfunc" id="3739931">len</span><span class="op" id="3739934">(</span><span class="ident" id="3739935">encrypted</span><span class="op" id="3739944">)</span><span class="op" id="3739945">+</span><span class="num" id="3739946">2</span><span class="op" id="3739947">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739950">ckx</span><span class="op" id="3739953">.</span><span class="ident" id="3739954">ciphertext</span><span class="op" id="3739964">[</span><span class="num" id="3739965">0</span><span class="op" id="3739966">]</span>&nbsp;<span class="op" id="3739968">=</span>&nbsp;<span class="builtintype" id="3739970">byte</span><span class="op" id="3739974">(</span><span class="builtinfunc" id="3739975">len</span><span class="op" id="3739978">(</span><span class="ident" id="3739979">encrypted</span><span class="op" id="3739988">)</span>&nbsp;<span class="op" id="3739990">&gt;&gt;</span>&nbsp;<span class="num" id="3739993">8</span><span class="op" id="3739994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739997">ckx</span><span class="op" id="3740000">.</span><span class="ident" id="3740001">ciphertext</span><span class="op" id="3740011">[</span><span class="num" id="3740012">1</span><span class="op" id="3740013">]</span>&nbsp;<span class="op" id="3740015">=</span>&nbsp;<span class="builtintype" id="3740017">byte</span><span class="op" id="3740021">(</span><span class="builtinfunc" id="3740022">len</span><span class="op" id="3740025">(</span><span class="ident" id="3740026">encrypted</span><span class="op" id="3740035">)</span><span class="op" id="3740036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3740039">copy</span><span class="op" id="3740043">(</span><span class="ident" id="3740044">ckx</span><span class="op" id="3740047">.</span><span class="ident" id="3740048">ciphertext</span><span class="op" id="3740058">[</span><span class="num" id="3740059">2</span><span class="op" id="3740060">:</span><span class="op" id="3740061">]</span><span class="op" id="3740062">,</span>&nbsp;<span class="ident" id="3740064">encrypted</span><span class="op" id="3740073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740076">return</span>&nbsp;<span class="ident" id="3740083">preMasterSecret</span><span class="op" id="3740098">,</span>&nbsp;<span class="ident" id="3740100">ckx</span><span class="op" id="3740103">,</span>&nbsp;<span class="ident" id="3740105">nil</span><br>
<span class="lineno"></span><span class="op" id="3740109">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3740112">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3740175">func</span>&nbsp;<span class="ident" id="3740180">sha1Hash</span><span class="op" id="3740188">(</span><span class="ident" id="3740189">slices</span>&nbsp;<span class="op" id="3740196">[</span><span class="op" id="3740197">]</span><span class="op" id="3740198">[</span><span class="op" id="3740199">]</span><span class="builtintype" id="3740200">byte</span><span class="op" id="3740204">)</span>&nbsp;<span class="op" id="3740206">[</span><span class="op" id="3740207">]</span><span class="builtintype" id="3740208">byte</span>&nbsp;<span class="op" id="3740213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740216">hsha1</span>&nbsp;<span class="op" id="3740222">:=</span>&nbsp;<span class="ident" id="3740225">sha1</span><span class="op" id="3740229">.</span><span class="ident" id="3740230">New</span><span class="op" id="3740233">(</span><span class="op" id="3740234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740237">for</span>&nbsp;<span class="ident" id="3740241">_</span><span class="op" id="3740242">,</span>&nbsp;<span class="ident" id="3740244">slice</span>&nbsp;<span class="op" id="3740250">:=</span>&nbsp;<span class="keyword" id="3740253">range</span>&nbsp;<span class="ident" id="3740259">slices</span>&nbsp;<span class="op" id="3740266">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740270">hsha1</span><span class="op" id="3740275">.</span><span class="ident" id="3740276">Write</span><span class="op" id="3740281">(</span><span class="ident" id="3740282">slice</span><span class="op" id="3740287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740293">return</span>&nbsp;<span class="ident" id="3740300">hsha1</span><span class="op" id="3740305">.</span><span class="ident" id="3740306">Sum</span><span class="op" id="3740309">(</span><span class="ident" id="3740310">nil</span><span class="op" id="3740313">)</span><br>
<span class="lineno"></span><span class="op" id="3740315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3740318">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3740397">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3740439">func</span>&nbsp;<span class="ident" id="3740444">md5SHA1Hash</span><span class="op" id="3740455">(</span><span class="ident" id="3740456">slices</span>&nbsp;<span class="op" id="3740463">[</span><span class="op" id="3740464">]</span><span class="op" id="3740465">[</span><span class="op" id="3740466">]</span><span class="builtintype" id="3740467">byte</span><span class="op" id="3740471">)</span>&nbsp;<span class="op" id="3740473">[</span><span class="op" id="3740474">]</span><span class="builtintype" id="3740475">byte</span>&nbsp;<span class="op" id="3740480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740483">md5sha1</span>&nbsp;<span class="op" id="3740491">:=</span>&nbsp;<span class="builtinfunc" id="3740494">make</span><span class="op" id="3740498">(</span><span class="op" id="3740499">[</span><span class="op" id="3740500">]</span><span class="builtintype" id="3740501">byte</span><span class="op" id="3740505">,</span>&nbsp;<span class="ident" id="3740507">md5</span><span class="op" id="3740510">.</span><span class="ident" id="3740511">Size</span><span class="op" id="3740515">+</span><span class="ident" id="3740516">sha1</span><span class="op" id="3740520">.</span><span class="ident" id="3740521">Size</span><span class="op" id="3740525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740528">hmd5</span>&nbsp;<span class="op" id="3740533">:=</span>&nbsp;<span class="ident" id="3740536">md5</span><span class="op" id="3740539">.</span><span class="ident" id="3740540">New</span><span class="op" id="3740543">(</span><span class="op" id="3740544">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740547">for</span>&nbsp;<span class="ident" id="3740551">_</span><span class="op" id="3740552">,</span>&nbsp;<span class="ident" id="3740554">slice</span>&nbsp;<span class="op" id="3740560">:=</span>&nbsp;<span class="keyword" id="3740563">range</span>&nbsp;<span class="ident" id="3740569">slices</span>&nbsp;<span class="op" id="3740576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740580">hmd5</span><span class="op" id="3740584">.</span><span class="ident" id="3740585">Write</span><span class="op" id="3740590">(</span><span class="ident" id="3740591">slice</span><span class="op" id="3740596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3740602">copy</span><span class="op" id="3740606">(</span><span class="ident" id="3740607">md5sha1</span><span class="op" id="3740614">,</span>&nbsp;<span class="ident" id="3740616">hmd5</span><span class="op" id="3740620">.</span><span class="ident" id="3740621">Sum</span><span class="op" id="3740624">(</span><span class="ident" id="3740625">nil</span><span class="op" id="3740628">)</span><span class="op" id="3740629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3740632">copy</span><span class="op" id="3740636">(</span><span class="ident" id="3740637">md5sha1</span><span class="op" id="3740644">[</span><span class="ident" id="3740645">md5</span><span class="op" id="3740648">.</span><span class="ident" id="3740649">Size</span><span class="op" id="3740653">:</span><span class="op" id="3740654">]</span><span class="op" id="3740655">,</span>&nbsp;<span class="ident" id="3740657">sha1Hash</span><span class="op" id="3740665">(</span><span class="ident" id="3740666">slices</span><span class="op" id="3740672">)</span><span class="op" id="3740673">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740676">return</span>&nbsp;<span class="ident" id="3740683">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="3740691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3740694">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3740744">func</span>&nbsp;<span class="ident" id="3740749">sha256Hash</span><span class="op" id="3740759">(</span><span class="ident" id="3740760">slices</span>&nbsp;<span class="op" id="3740767">[</span><span class="op" id="3740768">]</span><span class="op" id="3740769">[</span><span class="op" id="3740770">]</span><span class="builtintype" id="3740771">byte</span><span class="op" id="3740775">)</span>&nbsp;<span class="op" id="3740777">[</span><span class="op" id="3740778">]</span><span class="builtintype" id="3740779">byte</span>&nbsp;<span class="op" id="3740784">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740787">h</span>&nbsp;<span class="op" id="3740789">:=</span>&nbsp;<span class="ident" id="3740792">sha256</span><span class="op" id="3740798">.</span><span class="ident" id="3740799">New</span><span class="op" id="3740802">(</span><span class="op" id="3740803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740806">for</span>&nbsp;<span class="ident" id="3740810">_</span><span class="op" id="3740811">,</span>&nbsp;<span class="ident" id="3740813">slice</span>&nbsp;<span class="op" id="3740819">:=</span>&nbsp;<span class="keyword" id="3740822">range</span>&nbsp;<span class="ident" id="3740828">slices</span>&nbsp;<span class="op" id="3740835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740839">h</span><span class="op" id="3740840">.</span><span class="ident" id="3740841">Write</span><span class="op" id="3740846">(</span><span class="ident" id="3740847">slice</span><span class="op" id="3740852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740858">return</span>&nbsp;<span class="ident" id="3740865">h</span><span class="op" id="3740866">.</span><span class="ident" id="3740867">Sum</span><span class="op" id="3740870">(</span><span class="ident" id="3740871">nil</span><span class="op" id="3740874">)</span><br>
<span class="lineno">120</span><span class="op" id="3740876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3740879">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3740956">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3741035">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3741109">func</span>&nbsp;<span class="ident" id="3741114">hashForServerKeyExchange</span><span class="op" id="3741138">(</span><span class="ident" id="3741139">sigType</span><span class="op" id="3741146">,</span>&nbsp;<span class="ident" id="3741148">hashFunc</span>&nbsp;<span class="builtintype" id="3741157">uint8</span><span class="op" id="3741162">,</span>&nbsp;<span class="ident" id="3741164">version</span>&nbsp;<span class="builtintype" id="3741172">uint16</span><span class="op" id="3741178">,</span>&nbsp;<span class="ident" id="3741180">slices</span>&nbsp;<span class="op" id="3741187">...</span><span class="op" id="3741190">[</span><span class="op" id="3741191">]</span><span class="builtintype" id="3741192">byte</span><span class="op" id="3741196">)</span>&nbsp;<span class="op" id="3741198">(</span><span class="op" id="3741199">[</span><span class="op" id="3741200">]</span><span class="builtintype" id="3741201">byte</span><span class="op" id="3741205">,</span>&nbsp;<span class="ident" id="3741207">crypto</span><span class="op" id="3741213">.</span><span class="ident" id="3741214">Hash</span><span class="op" id="3741218">,</span>&nbsp;<span class="builtintype" id="3741220">error</span><span class="op" id="3741225">)</span>&nbsp;<span class="op" id="3741227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741230">if</span>&nbsp;<span class="ident" id="3741233">version</span>&nbsp;<span class="op" id="3741241">&gt;=</span>&nbsp;<span class="ident" id="3741244">VersionTLS12</span>&nbsp;<span class="op" id="3741257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741261">switch</span>&nbsp;<span class="ident" id="3741268">hashFunc</span>&nbsp;<span class="op" id="3741277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741281">case</span>&nbsp;<span class="ident" id="3741286">hashSHA256</span><span class="op" id="3741296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741301">return</span>&nbsp;<span class="ident" id="3741308">sha256Hash</span><span class="op" id="3741318">(</span><span class="ident" id="3741319">slices</span><span class="op" id="3741325">)</span><span class="op" id="3741326">,</span>&nbsp;<span class="ident" id="3741328">crypto</span><span class="op" id="3741334">.</span><span class="ident" id="3741335">SHA256</span><span class="op" id="3741341">,</span>&nbsp;<span class="ident" id="3741343">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741349">case</span>&nbsp;<span class="ident" id="3741354">hashSHA1</span><span class="op" id="3741362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741367">return</span>&nbsp;<span class="ident" id="3741374">sha1Hash</span><span class="op" id="3741382">(</span><span class="ident" id="3741383">slices</span><span class="op" id="3741389">)</span><span class="op" id="3741390">,</span>&nbsp;<span class="ident" id="3741392">crypto</span><span class="op" id="3741398">.</span><span class="ident" id="3741399">SHA1</span><span class="op" id="3741403">,</span>&nbsp;<span class="ident" id="3741405">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741411">default</span><span class="op" id="3741418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741423">return</span>&nbsp;<span class="ident" id="3741430">nil</span><span class="op" id="3741433">,</span>&nbsp;<span class="ident" id="3741435">crypto</span><span class="op" id="3741441">.</span><span class="ident" id="3741442">Hash</span><span class="op" id="3741446">(</span><span class="num" id="3741447">0</span><span class="op" id="3741448">)</span><span class="op" id="3741449">,</span>&nbsp;<span class="ident" id="3741451">errors</span><span class="op" id="3741457">.</span><span class="ident" id="3741458">New</span><span class="op" id="3741461">(</span><span class="string" id="3741462">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3741503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741507">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741513">if</span>&nbsp;<span class="ident" id="3741516">sigType</span>&nbsp;<span class="op" id="3741524">==</span>&nbsp;<span class="ident" id="3741527">signatureECDSA</span>&nbsp;<span class="op" id="3741542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741546">return</span>&nbsp;<span class="ident" id="3741553">sha1Hash</span><span class="op" id="3741561">(</span><span class="ident" id="3741562">slices</span><span class="op" id="3741568">)</span><span class="op" id="3741569">,</span>&nbsp;<span class="ident" id="3741571">crypto</span><span class="op" id="3741577">.</span><span class="ident" id="3741578">SHA1</span><span class="op" id="3741582">,</span>&nbsp;<span class="ident" id="3741584">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741592">return</span>&nbsp;<span class="ident" id="3741599">md5SHA1Hash</span><span class="op" id="3741610">(</span><span class="ident" id="3741611">slices</span><span class="op" id="3741617">)</span><span class="op" id="3741618">,</span>&nbsp;<span class="ident" id="3741620">crypto</span><span class="op" id="3741626">.</span><span class="ident" id="3741627">MD5SHA1</span><span class="op" id="3741634">,</span>&nbsp;<span class="ident" id="3741636">nil</span><br>
<span class="lineno">140</span><span class="op" id="3741640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3741643">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3741720">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3741794">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3741859">func</span>&nbsp;<span class="ident" id="3741864">pickTLS12HashForSignature</span><span class="op" id="3741889">(</span><span class="ident" id="3741890">sigType</span>&nbsp;<span class="builtintype" id="3741898">uint8</span><span class="op" id="3741903">,</span>&nbsp;<span class="ident" id="3741905">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3741930">[</span><span class="op" id="3741931">]</span><span class="ident" id="3741932">signatureAndHash</span><span class="op" id="3741948">)</span>&nbsp;<span class="op" id="3741950">(</span><span class="builtintype" id="3741951">uint8</span><span class="op" id="3741956">,</span>&nbsp;<span class="builtintype" id="3741958">error</span><span class="op" id="3741963">)</span>&nbsp;<span class="op" id="3741965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741968">if</span>&nbsp;<span class="builtinfunc" id="3741971">len</span><span class="op" id="3741974">(</span><span class="ident" id="3741975">clientSignatureAndHashes</span><span class="op" id="3741999">)</span>&nbsp;<span class="op" id="3742001">==</span>&nbsp;<span class="num" id="3742004">0</span>&nbsp;<span class="op" id="3742006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742010">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742069">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742130">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742188">return</span>&nbsp;<span class="ident" id="3742195">hashSHA1</span><span class="op" id="3742203">,</span>&nbsp;<span class="ident" id="3742205">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742214">for</span>&nbsp;<span class="ident" id="3742218">_</span><span class="op" id="3742219">,</span>&nbsp;<span class="ident" id="3742221">sigAndHash</span>&nbsp;<span class="op" id="3742232">:=</span>&nbsp;<span class="keyword" id="3742235">range</span>&nbsp;<span class="ident" id="3742241">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3742266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742270">if</span>&nbsp;<span class="ident" id="3742273">sigAndHash</span><span class="op" id="3742283">.</span><span class="ident" id="3742284">signature</span>&nbsp;<span class="op" id="3742294">!=</span>&nbsp;<span class="ident" id="3742297">sigType</span>&nbsp;<span class="op" id="3742305">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742310">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742325">switch</span>&nbsp;<span class="ident" id="3742332">sigAndHash</span><span class="op" id="3742342">.</span><span class="ident" id="3742343">hash</span>&nbsp;<span class="op" id="3742348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742352">case</span>&nbsp;<span class="ident" id="3742357">hashSHA1</span><span class="op" id="3742365">,</span>&nbsp;<span class="ident" id="3742367">hashSHA256</span><span class="op" id="3742377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742382">return</span>&nbsp;<span class="ident" id="3742389">sigAndHash</span><span class="op" id="3742399">.</span><span class="ident" id="3742400">hash</span><span class="op" id="3742404">,</span>&nbsp;<span class="ident" id="3742406">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742419">return</span>&nbsp;<span class="num" id="3742426">0</span><span class="op" id="3742427">,</span>&nbsp;<span class="ident" id="3742429">errors</span><span class="op" id="3742435">.</span><span class="ident" id="3742436">New</span><span class="op" id="3742439">(</span><span class="string" id="3742440">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3742495">)</span><br>
<span class="lineno"></span><span class="op" id="3742497">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3742500">func</span>&nbsp;<span class="ident" id="3742505">curveForCurveID</span><span class="op" id="3742520">(</span><span class="ident" id="3742521">id</span>&nbsp;<span class="ident" id="3742524">CurveID</span><span class="op" id="3742531">)</span>&nbsp;<span class="op" id="3742533">(</span><span class="ident" id="3742534">elliptic</span><span class="op" id="3742542">.</span><span class="ident" id="3742543">Curve</span><span class="op" id="3742548">,</span>&nbsp;<span class="builtintype" id="3742550">bool</span><span class="op" id="3742554">)</span>&nbsp;<span class="op" id="3742556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742559">switch</span>&nbsp;<span class="ident" id="3742566">id</span>&nbsp;<span class="op" id="3742569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742572">case</span>&nbsp;<span class="ident" id="3742577">CurveP256</span><span class="op" id="3742586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742590">return</span>&nbsp;<span class="ident" id="3742597">elliptic</span><span class="op" id="3742605">.</span><span class="ident" id="3742606">P256</span><span class="op" id="3742610">(</span><span class="op" id="3742611">)</span><span class="op" id="3742612">,</span>&nbsp;<span class="builtintype" id="3742614">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742620">case</span>&nbsp;<span class="ident" id="3742625">CurveP384</span><span class="op" id="3742634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742638">return</span>&nbsp;<span class="ident" id="3742645">elliptic</span><span class="op" id="3742653">.</span><span class="ident" id="3742654">P384</span><span class="op" id="3742658">(</span><span class="op" id="3742659">)</span><span class="op" id="3742660">,</span>&nbsp;<span class="builtintype" id="3742662">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742668">case</span>&nbsp;<span class="ident" id="3742673">CurveP521</span><span class="op" id="3742682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742686">return</span>&nbsp;<span class="ident" id="3742693">elliptic</span><span class="op" id="3742701">.</span><span class="ident" id="3742702">P521</span><span class="op" id="3742706">(</span><span class="op" id="3742707">)</span><span class="op" id="3742708">,</span>&nbsp;<span class="builtintype" id="3742710">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742716">default</span><span class="op" id="3742723">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742727">return</span>&nbsp;<span class="ident" id="3742734">nil</span><span class="op" id="3742737">,</span>&nbsp;<span class="builtintype" id="3742739">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3742749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3742752">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3742824">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3742894">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3742964">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3742991">type</span>&nbsp;<span class="ident" id="3742996">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3743014">struct</span>&nbsp;<span class="op" id="3743021">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743024">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3743035">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743043">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3743054">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743061">privateKey</span>&nbsp;<span class="op" id="3743072">[</span><span class="op" id="3743073">]</span><span class="builtintype" id="3743074">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743080">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743091">elliptic</span><span class="op" id="3743099">.</span><span class="ident" id="3743100">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743107">x</span><span class="op" id="3743108">,</span>&nbsp;<span class="ident" id="3743110">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743118">*</span><span class="ident" id="3743119">big</span><span class="op" id="3743122">.</span><span class="ident" id="3743123">Int</span><br>
<span class="lineno">190</span><span class="op" id="3743127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3743130">func</span>&nbsp;<span class="op" id="3743135">(</span><span class="ident" id="3743136">ka</span>&nbsp;<span class="op" id="3743139">*</span><span class="ident" id="3743140">ecdheKeyAgreement</span><span class="op" id="3743157">)</span>&nbsp;<span class="ident" id="3743159">generateServerKeyExchange</span><span class="op" id="3743184">(</span><span class="ident" id="3743185">config</span>&nbsp;<span class="op" id="3743192">*</span><span class="ident" id="3743193">Config</span><span class="op" id="3743199">,</span>&nbsp;<span class="ident" id="3743201">cert</span>&nbsp;<span class="op" id="3743206">*</span><span class="ident" id="3743207">Certificate</span><span class="op" id="3743218">,</span>&nbsp;<span class="ident" id="3743220">clientHello</span>&nbsp;<span class="op" id="3743232">*</span><span class="ident" id="3743233">clientHelloMsg</span><span class="op" id="3743247">,</span>&nbsp;<span class="ident" id="3743249">hello</span>&nbsp;<span class="op" id="3743255">*</span><span class="ident" id="3743256">serverHelloMsg</span><span class="op" id="3743270">)</span>&nbsp;<span class="op" id="3743272">(</span><span class="op" id="3743273">*</span><span class="ident" id="3743274">serverKeyExchangeMsg</span><span class="op" id="3743294">,</span>&nbsp;<span class="builtintype" id="3743296">error</span><span class="op" id="3743301">)</span>&nbsp;<span class="op" id="3743303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743306">var</span>&nbsp;<span class="ident" id="3743310">curveid</span>&nbsp;<span class="ident" id="3743318">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743327">preferredCurves</span>&nbsp;<span class="op" id="3743343">:=</span>&nbsp;<span class="ident" id="3743346">config</span><span class="op" id="3743352">.</span><span class="ident" id="3743353">curvePreferences</span><span class="op" id="3743369">(</span><span class="op" id="3743370">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3743373">NextCandidate</span><span class="op" id="3743386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743389">for</span>&nbsp;<span class="ident" id="3743393">_</span><span class="op" id="3743394">,</span>&nbsp;<span class="ident" id="3743396">candidate</span>&nbsp;<span class="op" id="3743406">:=</span>&nbsp;<span class="keyword" id="3743409">range</span>&nbsp;<span class="ident" id="3743415">preferredCurves</span>&nbsp;<span class="op" id="3743431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743435">for</span>&nbsp;<span class="ident" id="3743439">_</span><span class="op" id="3743440">,</span>&nbsp;<span class="ident" id="3743442">c</span>&nbsp;<span class="op" id="3743444">:=</span>&nbsp;<span class="keyword" id="3743447">range</span>&nbsp;<span class="ident" id="3743453">clientHello</span><span class="op" id="3743464">.</span><span class="ident" id="3743465">supportedCurves</span>&nbsp;<span class="op" id="3743481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743486">if</span>&nbsp;<span class="ident" id="3743489">candidate</span>&nbsp;<span class="op" id="3743499">==</span>&nbsp;<span class="ident" id="3743502">c</span>&nbsp;<span class="op" id="3743504">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743510">curveid</span>&nbsp;<span class="op" id="3743518">=</span>&nbsp;<span class="ident" id="3743520">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743526">break</span>&nbsp;<span class="ident" id="3743532">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743556">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743560">if</span>&nbsp;<span class="ident" id="3743563">curveid</span>&nbsp;<span class="op" id="3743571">==</span>&nbsp;<span class="num" id="3743574">0</span>&nbsp;<span class="op" id="3743576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743580">return</span>&nbsp;<span class="ident" id="3743587">nil</span><span class="op" id="3743590">,</span>&nbsp;<span class="ident" id="3743592">errors</span><span class="op" id="3743598">.</span><span class="ident" id="3743599">New</span><span class="op" id="3743602">(</span><span class="string" id="3743603">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3743646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743653">var</span>&nbsp;<span class="ident" id="3743657">ok</span>&nbsp;<span class="builtintype" id="3743660">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743666">if</span>&nbsp;<span class="ident" id="3743669">ka</span><span class="op" id="3743671">.</span><span class="ident" id="3743672">curve</span><span class="op" id="3743677">,</span>&nbsp;<span class="ident" id="3743679">ok</span>&nbsp;<span class="op" id="3743682">=</span>&nbsp;<span class="ident" id="3743684">curveForCurveID</span><span class="op" id="3743699">(</span><span class="ident" id="3743700">curveid</span><span class="op" id="3743707">)</span><span class="op" id="3743708">;</span>&nbsp;<span class="op" id="3743710">!</span><span class="ident" id="3743711">ok</span>&nbsp;<span class="op" id="3743714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743718">return</span>&nbsp;<span class="ident" id="3743725">nil</span><span class="op" id="3743728">,</span>&nbsp;<span class="ident" id="3743730">errors</span><span class="op" id="3743736">.</span><span class="ident" id="3743737">New</span><span class="op" id="3743740">(</span><span class="string" id="3743741">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3743790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743797">var</span>&nbsp;<span class="ident" id="3743801">x</span><span class="op" id="3743802">,</span>&nbsp;<span class="ident" id="3743804">y</span>&nbsp;<span class="op" id="3743806">*</span><span class="ident" id="3743807">big</span><span class="op" id="3743810">.</span><span class="ident" id="3743811">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743816">var</span>&nbsp;<span class="ident" id="3743820">err</span>&nbsp;<span class="builtintype" id="3743824">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743831">ka</span><span class="op" id="3743833">.</span><span class="ident" id="3743834">privateKey</span><span class="op" id="3743844">,</span>&nbsp;<span class="ident" id="3743846">x</span><span class="op" id="3743847">,</span>&nbsp;<span class="ident" id="3743849">y</span><span class="op" id="3743850">,</span>&nbsp;<span class="ident" id="3743852">err</span>&nbsp;<span class="op" id="3743856">=</span>&nbsp;<span class="ident" id="3743858">elliptic</span><span class="op" id="3743866">.</span><span class="ident" id="3743867">GenerateKey</span><span class="op" id="3743878">(</span><span class="ident" id="3743879">ka</span><span class="op" id="3743881">.</span><span class="ident" id="3743882">curve</span><span class="op" id="3743887">,</span>&nbsp;<span class="ident" id="3743889">config</span><span class="op" id="3743895">.</span><span class="ident" id="3743896">rand</span><span class="op" id="3743900">(</span><span class="op" id="3743901">)</span><span class="op" id="3743902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743905">if</span>&nbsp;<span class="ident" id="3743908">err</span>&nbsp;<span class="op" id="3743912">!=</span>&nbsp;<span class="ident" id="3743915">nil</span>&nbsp;<span class="op" id="3743919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743923">return</span>&nbsp;<span class="ident" id="3743930">nil</span><span class="op" id="3743933">,</span>&nbsp;<span class="ident" id="3743935">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743943">ecdhePublic</span>&nbsp;<span class="op" id="3743955">:=</span>&nbsp;<span class="ident" id="3743958">elliptic</span><span class="op" id="3743966">.</span><span class="ident" id="3743967">Marshal</span><span class="op" id="3743974">(</span><span class="ident" id="3743975">ka</span><span class="op" id="3743977">.</span><span class="ident" id="3743978">curve</span><span class="op" id="3743983">,</span>&nbsp;<span class="ident" id="3743985">x</span><span class="op" id="3743986">,</span>&nbsp;<span class="ident" id="3743988">y</span><span class="op" id="3743989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743993">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744044">serverECDHParams</span>&nbsp;<span class="op" id="3744061">:=</span>&nbsp;<span class="builtinfunc" id="3744064">make</span><span class="op" id="3744068">(</span><span class="op" id="3744069">[</span><span class="op" id="3744070">]</span><span class="builtintype" id="3744071">byte</span><span class="op" id="3744075">,</span>&nbsp;<span class="num" id="3744077">1</span><span class="op" id="3744078">+</span><span class="num" id="3744079">2</span><span class="op" id="3744080">+</span><span class="num" id="3744081">1</span><span class="op" id="3744082">+</span><span class="builtinfunc" id="3744083">len</span><span class="op" id="3744086">(</span><span class="ident" id="3744087">ecdhePublic</span><span class="op" id="3744098">)</span><span class="op" id="3744099">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744102">serverECDHParams</span><span class="op" id="3744118">[</span><span class="num" id="3744119">0</span><span class="op" id="3744120">]</span>&nbsp;<span class="op" id="3744122">=</span>&nbsp;<span class="num" id="3744124">3</span>&nbsp;<span class="comment" id="3744126">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744142">serverECDHParams</span><span class="op" id="3744158">[</span><span class="num" id="3744159">1</span><span class="op" id="3744160">]</span>&nbsp;<span class="op" id="3744162">=</span>&nbsp;<span class="builtintype" id="3744164">byte</span><span class="op" id="3744168">(</span><span class="ident" id="3744169">curveid</span>&nbsp;<span class="op" id="3744177">&gt;&gt;</span>&nbsp;<span class="num" id="3744180">8</span><span class="op" id="3744181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744184">serverECDHParams</span><span class="op" id="3744200">[</span><span class="num" id="3744201">2</span><span class="op" id="3744202">]</span>&nbsp;<span class="op" id="3744204">=</span>&nbsp;<span class="builtintype" id="3744206">byte</span><span class="op" id="3744210">(</span><span class="ident" id="3744211">curveid</span><span class="op" id="3744218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744221">serverECDHParams</span><span class="op" id="3744237">[</span><span class="num" id="3744238">3</span><span class="op" id="3744239">]</span>&nbsp;<span class="op" id="3744241">=</span>&nbsp;<span class="builtintype" id="3744243">byte</span><span class="op" id="3744247">(</span><span class="builtinfunc" id="3744248">len</span><span class="op" id="3744251">(</span><span class="ident" id="3744252">ecdhePublic</span><span class="op" id="3744263">)</span><span class="op" id="3744264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3744267">copy</span><span class="op" id="3744271">(</span><span class="ident" id="3744272">serverECDHParams</span><span class="op" id="3744288">[</span><span class="num" id="3744289">4</span><span class="op" id="3744290">:</span><span class="op" id="3744291">]</span><span class="op" id="3744292">,</span>&nbsp;<span class="ident" id="3744294">ecdhePublic</span><span class="op" id="3744305">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744309">var</span>&nbsp;<span class="ident" id="3744313">tls12HashId</span>&nbsp;<span class="builtintype" id="3744325">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744332">if</span>&nbsp;<span class="ident" id="3744335">ka</span><span class="op" id="3744337">.</span><span class="ident" id="3744338">version</span>&nbsp;<span class="op" id="3744346">&gt;=</span>&nbsp;<span class="ident" id="3744349">VersionTLS12</span>&nbsp;<span class="op" id="3744362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744366">if</span>&nbsp;<span class="ident" id="3744369">tls12HashId</span><span class="op" id="3744380">,</span>&nbsp;<span class="ident" id="3744382">err</span>&nbsp;<span class="op" id="3744386">=</span>&nbsp;<span class="ident" id="3744388">pickTLS12HashForSignature</span><span class="op" id="3744413">(</span><span class="ident" id="3744414">ka</span><span class="op" id="3744416">.</span><span class="ident" id="3744417">sigType</span><span class="op" id="3744424">,</span>&nbsp;<span class="ident" id="3744426">clientHello</span><span class="op" id="3744437">.</span><span class="ident" id="3744438">signatureAndHashes</span><span class="op" id="3744456">)</span><span class="op" id="3744457">;</span>&nbsp;<span class="ident" id="3744459">err</span>&nbsp;<span class="op" id="3744463">!=</span>&nbsp;<span class="ident" id="3744466">nil</span>&nbsp;<span class="op" id="3744470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744475">return</span>&nbsp;<span class="ident" id="3744482">nil</span><span class="op" id="3744485">,</span>&nbsp;<span class="ident" id="3744487">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744500">digest</span><span class="op" id="3744506">,</span>&nbsp;<span class="ident" id="3744508">hashFunc</span><span class="op" id="3744516">,</span>&nbsp;<span class="ident" id="3744518">err</span>&nbsp;<span class="op" id="3744522">:=</span>&nbsp;<span class="ident" id="3744525">hashForServerKeyExchange</span><span class="op" id="3744549">(</span><span class="ident" id="3744550">ka</span><span class="op" id="3744552">.</span><span class="ident" id="3744553">sigType</span><span class="op" id="3744560">,</span>&nbsp;<span class="ident" id="3744562">tls12HashId</span><span class="op" id="3744573">,</span>&nbsp;<span class="ident" id="3744575">ka</span><span class="op" id="3744577">.</span><span class="ident" id="3744578">version</span><span class="op" id="3744585">,</span>&nbsp;<span class="ident" id="3744587">clientHello</span><span class="op" id="3744598">.</span><span class="ident" id="3744599">random</span><span class="op" id="3744605">,</span>&nbsp;<span class="ident" id="3744607">hello</span><span class="op" id="3744612">.</span><span class="ident" id="3744613">random</span><span class="op" id="3744619">,</span>&nbsp;<span class="ident" id="3744621">serverECDHParams</span><span class="op" id="3744637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744640">if</span>&nbsp;<span class="ident" id="3744643">err</span>&nbsp;<span class="op" id="3744647">!=</span>&nbsp;<span class="ident" id="3744650">nil</span>&nbsp;<span class="op" id="3744654">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744658">return</span>&nbsp;<span class="ident" id="3744665">nil</span><span class="op" id="3744668">,</span>&nbsp;<span class="ident" id="3744670">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744678">var</span>&nbsp;<span class="ident" id="3744682">sig</span>&nbsp;<span class="op" id="3744686">[</span><span class="op" id="3744687">]</span><span class="builtintype" id="3744688">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744694">switch</span>&nbsp;<span class="ident" id="3744701">ka</span><span class="op" id="3744703">.</span><span class="ident" id="3744704">sigType</span>&nbsp;<span class="op" id="3744712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744715">case</span>&nbsp;<span class="ident" id="3744720">signatureECDSA</span><span class="op" id="3744734">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744738">privKey</span><span class="op" id="3744745">,</span>&nbsp;<span class="ident" id="3744747">ok</span>&nbsp;<span class="op" id="3744750">:=</span>&nbsp;<span class="ident" id="3744753">cert</span><span class="op" id="3744757">.</span><span class="ident" id="3744758">PrivateKey</span><span class="op" id="3744768">.</span><span class="op" id="3744769">(</span><span class="op" id="3744770">*</span><span class="ident" id="3744771">ecdsa</span><span class="op" id="3744776">.</span><span class="ident" id="3744777">PrivateKey</span><span class="op" id="3744787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744791">if</span>&nbsp;<span class="op" id="3744794">!</span><span class="ident" id="3744795">ok</span>&nbsp;<span class="op" id="3744798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744803">return</span>&nbsp;<span class="ident" id="3744810">nil</span><span class="op" id="3744813">,</span>&nbsp;<span class="ident" id="3744815">errors</span><span class="op" id="3744821">.</span><span class="ident" id="3744822">New</span><span class="op" id="3744825">(</span><span class="string" id="3744826">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3744876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744884">r</span><span class="op" id="3744885">,</span>&nbsp;<span class="ident" id="3744887">s</span><span class="op" id="3744888">,</span>&nbsp;<span class="ident" id="3744890">err</span>&nbsp;<span class="op" id="3744894">:=</span>&nbsp;<span class="ident" id="3744897">ecdsa</span><span class="op" id="3744902">.</span><span class="ident" id="3744903">Sign</span><span class="op" id="3744907">(</span><span class="ident" id="3744908">config</span><span class="op" id="3744914">.</span><span class="ident" id="3744915">rand</span><span class="op" id="3744919">(</span><span class="op" id="3744920">)</span><span class="op" id="3744921">,</span>&nbsp;<span class="ident" id="3744923">privKey</span><span class="op" id="3744930">,</span>&nbsp;<span class="ident" id="3744932">digest</span><span class="op" id="3744938">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744942">if</span>&nbsp;<span class="ident" id="3744945">err</span>&nbsp;<span class="op" id="3744949">!=</span>&nbsp;<span class="ident" id="3744952">nil</span>&nbsp;<span class="op" id="3744956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744961">return</span>&nbsp;<span class="ident" id="3744968">nil</span><span class="op" id="3744971">,</span>&nbsp;<span class="ident" id="3744973">errors</span><span class="op" id="3744979">.</span><span class="ident" id="3744980">New</span><span class="op" id="3744983">(</span><span class="string" id="3744984">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3745020">+</span>&nbsp;<span class="ident" id="3745022">err</span><span class="op" id="3745025">.</span><span class="ident" id="3745026">Error</span><span class="op" id="3745031">(</span><span class="op" id="3745032">)</span><span class="op" id="3745033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745041">sig</span><span class="op" id="3745044">,</span>&nbsp;<span class="ident" id="3745046">err</span>&nbsp;<span class="op" id="3745050">=</span>&nbsp;<span class="ident" id="3745052">asn1</span><span class="op" id="3745056">.</span><span class="ident" id="3745057">Marshal</span><span class="op" id="3745064">(</span><span class="ident" id="3745065">ecdsaSignature</span><span class="op" id="3745079">{</span><span class="ident" id="3745080">r</span><span class="op" id="3745081">,</span>&nbsp;<span class="ident" id="3745083">s</span><span class="op" id="3745084">}</span><span class="op" id="3745085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745088">case</span>&nbsp;<span class="ident" id="3745093">signatureRSA</span><span class="op" id="3745105">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745109">privKey</span><span class="op" id="3745116">,</span>&nbsp;<span class="ident" id="3745118">ok</span>&nbsp;<span class="op" id="3745121">:=</span>&nbsp;<span class="ident" id="3745124">cert</span><span class="op" id="3745128">.</span><span class="ident" id="3745129">PrivateKey</span><span class="op" id="3745139">.</span><span class="op" id="3745140">(</span><span class="op" id="3745141">*</span><span class="ident" id="3745142">rsa</span><span class="op" id="3745145">.</span><span class="ident" id="3745146">PrivateKey</span><span class="op" id="3745156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745160">if</span>&nbsp;<span class="op" id="3745163">!</span><span class="ident" id="3745164">ok</span>&nbsp;<span class="op" id="3745167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745172">return</span>&nbsp;<span class="ident" id="3745179">nil</span><span class="op" id="3745182">,</span>&nbsp;<span class="ident" id="3745184">errors</span><span class="op" id="3745190">.</span><span class="ident" id="3745191">New</span><span class="op" id="3745194">(</span><span class="string" id="3745195">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3745240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745248">sig</span><span class="op" id="3745251">,</span>&nbsp;<span class="ident" id="3745253">err</span>&nbsp;<span class="op" id="3745257">=</span>&nbsp;<span class="ident" id="3745259">rsa</span><span class="op" id="3745262">.</span><span class="ident" id="3745263">SignPKCS1v15</span><span class="op" id="3745275">(</span><span class="ident" id="3745276">config</span><span class="op" id="3745282">.</span><span class="ident" id="3745283">rand</span><span class="op" id="3745287">(</span><span class="op" id="3745288">)</span><span class="op" id="3745289">,</span>&nbsp;<span class="ident" id="3745291">privKey</span><span class="op" id="3745298">,</span>&nbsp;<span class="ident" id="3745300">hashFunc</span><span class="op" id="3745308">,</span>&nbsp;<span class="ident" id="3745310">digest</span><span class="op" id="3745316">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745320">if</span>&nbsp;<span class="ident" id="3745323">err</span>&nbsp;<span class="op" id="3745327">!=</span>&nbsp;<span class="ident" id="3745330">nil</span>&nbsp;<span class="op" id="3745334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745339">return</span>&nbsp;<span class="ident" id="3745346">nil</span><span class="op" id="3745349">,</span>&nbsp;<span class="ident" id="3745351">errors</span><span class="op" id="3745357">.</span><span class="ident" id="3745358">New</span><span class="op" id="3745361">(</span><span class="string" id="3745362">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3745398">+</span>&nbsp;<span class="ident" id="3745400">err</span><span class="op" id="3745403">.</span><span class="ident" id="3745404">Error</span><span class="op" id="3745409">(</span><span class="op" id="3745410">)</span><span class="op" id="3745411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745418">default</span><span class="op" id="3745425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745429">return</span>&nbsp;<span class="ident" id="3745436">nil</span><span class="op" id="3745439">,</span>&nbsp;<span class="ident" id="3745441">errors</span><span class="op" id="3745447">.</span><span class="ident" id="3745448">New</span><span class="op" id="3745451">(</span><span class="string" id="3745452">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3745487">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745494">skx</span>&nbsp;<span class="op" id="3745498">:=</span>&nbsp;<span class="builtinfunc" id="3745501">new</span><span class="op" id="3745504">(</span><span class="ident" id="3745505">serverKeyExchangeMsg</span><span class="op" id="3745525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745528">sigAndHashLen</span>&nbsp;<span class="op" id="3745542">:=</span>&nbsp;<span class="num" id="3745545">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745548">if</span>&nbsp;<span class="ident" id="3745551">ka</span><span class="op" id="3745553">.</span><span class="ident" id="3745554">version</span>&nbsp;<span class="op" id="3745562">&gt;=</span>&nbsp;<span class="ident" id="3745565">VersionTLS12</span>&nbsp;<span class="op" id="3745578">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745582">sigAndHashLen</span>&nbsp;<span class="op" id="3745596">=</span>&nbsp;<span class="num" id="3745598">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745604">skx</span><span class="op" id="3745607">.</span><span class="ident" id="3745608">key</span>&nbsp;<span class="op" id="3745612">=</span>&nbsp;<span class="builtinfunc" id="3745614">make</span><span class="op" id="3745618">(</span><span class="op" id="3745619">[</span><span class="op" id="3745620">]</span><span class="builtintype" id="3745621">byte</span><span class="op" id="3745625">,</span>&nbsp;<span class="builtinfunc" id="3745627">len</span><span class="op" id="3745630">(</span><span class="ident" id="3745631">serverECDHParams</span><span class="op" id="3745647">)</span><span class="op" id="3745648">+</span><span class="ident" id="3745649">sigAndHashLen</span><span class="op" id="3745662">+</span><span class="num" id="3745663">2</span><span class="op" id="3745664">+</span><span class="builtinfunc" id="3745665">len</span><span class="op" id="3745668">(</span><span class="ident" id="3745669">sig</span><span class="op" id="3745672">)</span><span class="op" id="3745673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3745676">copy</span><span class="op" id="3745680">(</span><span class="ident" id="3745681">skx</span><span class="op" id="3745684">.</span><span class="ident" id="3745685">key</span><span class="op" id="3745688">,</span>&nbsp;<span class="ident" id="3745690">serverECDHParams</span><span class="op" id="3745706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745709">k</span>&nbsp;<span class="op" id="3745711">:=</span>&nbsp;<span class="ident" id="3745714">skx</span><span class="op" id="3745717">.</span><span class="ident" id="3745718">key</span><span class="op" id="3745721">[</span><span class="builtinfunc" id="3745722">len</span><span class="op" id="3745725">(</span><span class="ident" id="3745726">serverECDHParams</span><span class="op" id="3745742">)</span><span class="op" id="3745743">:</span><span class="op" id="3745744">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745747">if</span>&nbsp;<span class="ident" id="3745750">ka</span><span class="op" id="3745752">.</span><span class="ident" id="3745753">version</span>&nbsp;<span class="op" id="3745761">&gt;=</span>&nbsp;<span class="ident" id="3745764">VersionTLS12</span>&nbsp;<span class="op" id="3745777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745781">k</span><span class="op" id="3745782">[</span><span class="num" id="3745783">0</span><span class="op" id="3745784">]</span>&nbsp;<span class="op" id="3745786">=</span>&nbsp;<span class="ident" id="3745788">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745802">k</span><span class="op" id="3745803">[</span><span class="num" id="3745804">1</span><span class="op" id="3745805">]</span>&nbsp;<span class="op" id="3745807">=</span>&nbsp;<span class="ident" id="3745809">ka</span><span class="op" id="3745811">.</span><span class="ident" id="3745812">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745822">k</span>&nbsp;<span class="op" id="3745824">=</span>&nbsp;<span class="ident" id="3745826">k</span><span class="op" id="3745827">[</span><span class="num" id="3745828">2</span><span class="op" id="3745829">:</span><span class="op" id="3745830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745833">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745836">k</span><span class="op" id="3745837">[</span><span class="num" id="3745838">0</span><span class="op" id="3745839">]</span>&nbsp;<span class="op" id="3745841">=</span>&nbsp;<span class="builtintype" id="3745843">byte</span><span class="op" id="3745847">(</span><span class="builtinfunc" id="3745848">len</span><span class="op" id="3745851">(</span><span class="ident" id="3745852">sig</span><span class="op" id="3745855">)</span>&nbsp;<span class="op" id="3745857">&gt;&gt;</span>&nbsp;<span class="num" id="3745860">8</span><span class="op" id="3745861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745864">k</span><span class="op" id="3745865">[</span><span class="num" id="3745866">1</span><span class="op" id="3745867">]</span>&nbsp;<span class="op" id="3745869">=</span>&nbsp;<span class="builtintype" id="3745871">byte</span><span class="op" id="3745875">(</span><span class="builtinfunc" id="3745876">len</span><span class="op" id="3745879">(</span><span class="ident" id="3745880">sig</span><span class="op" id="3745883">)</span><span class="op" id="3745884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3745887">copy</span><span class="op" id="3745891">(</span><span class="ident" id="3745892">k</span><span class="op" id="3745893">[</span><span class="num" id="3745894">2</span><span class="op" id="3745895">:</span><span class="op" id="3745896">]</span><span class="op" id="3745897">,</span>&nbsp;<span class="ident" id="3745899">sig</span><span class="op" id="3745902">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745906">return</span>&nbsp;<span class="ident" id="3745913">skx</span><span class="op" id="3745916">,</span>&nbsp;<span class="ident" id="3745918">nil</span><br>
<span class="lineno">285</span><span class="op" id="3745922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3745925">func</span>&nbsp;<span class="op" id="3745930">(</span><span class="ident" id="3745931">ka</span>&nbsp;<span class="op" id="3745934">*</span><span class="ident" id="3745935">ecdheKeyAgreement</span><span class="op" id="3745952">)</span>&nbsp;<span class="ident" id="3745954">processClientKeyExchange</span><span class="op" id="3745978">(</span><span class="ident" id="3745979">config</span>&nbsp;<span class="op" id="3745986">*</span><span class="ident" id="3745987">Config</span><span class="op" id="3745993">,</span>&nbsp;<span class="ident" id="3745995">cert</span>&nbsp;<span class="op" id="3746000">*</span><span class="ident" id="3746001">Certificate</span><span class="op" id="3746012">,</span>&nbsp;<span class="ident" id="3746014">ckx</span>&nbsp;<span class="op" id="3746018">*</span><span class="ident" id="3746019">clientKeyExchangeMsg</span><span class="op" id="3746039">,</span>&nbsp;<span class="ident" id="3746041">version</span>&nbsp;<span class="builtintype" id="3746049">uint16</span><span class="op" id="3746055">)</span>&nbsp;<span class="op" id="3746057">(</span><span class="op" id="3746058">[</span><span class="op" id="3746059">]</span><span class="builtintype" id="3746060">byte</span><span class="op" id="3746064">,</span>&nbsp;<span class="builtintype" id="3746066">error</span><span class="op" id="3746071">)</span>&nbsp;<span class="op" id="3746073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746076">if</span>&nbsp;<span class="builtinfunc" id="3746079">len</span><span class="op" id="3746082">(</span><span class="ident" id="3746083">ckx</span><span class="op" id="3746086">.</span><span class="ident" id="3746087">ciphertext</span><span class="op" id="3746097">)</span>&nbsp;<span class="op" id="3746099">==</span>&nbsp;<span class="num" id="3746102">0</span>&nbsp;<span class="op" id="3746104">||</span>&nbsp;<span class="builtintype" id="3746107">int</span><span class="op" id="3746110">(</span><span class="ident" id="3746111">ckx</span><span class="op" id="3746114">.</span><span class="ident" id="3746115">ciphertext</span><span class="op" id="3746125">[</span><span class="num" id="3746126">0</span><span class="op" id="3746127">]</span><span class="op" id="3746128">)</span>&nbsp;<span class="op" id="3746130">!=</span>&nbsp;<span class="builtinfunc" id="3746133">len</span><span class="op" id="3746136">(</span><span class="ident" id="3746137">ckx</span><span class="op" id="3746140">.</span><span class="ident" id="3746141">ciphertext</span><span class="op" id="3746151">)</span><span class="op" id="3746152">-</span><span class="num" id="3746153">1</span>&nbsp;<span class="op" id="3746155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746159">return</span>&nbsp;<span class="ident" id="3746166">nil</span><span class="op" id="3746169">,</span>&nbsp;<span class="ident" id="3746171">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746196">x</span><span class="op" id="3746197">,</span>&nbsp;<span class="ident" id="3746199">y</span>&nbsp;<span class="op" id="3746201">:=</span>&nbsp;<span class="ident" id="3746204">elliptic</span><span class="op" id="3746212">.</span><span class="ident" id="3746213">Unmarshal</span><span class="op" id="3746222">(</span><span class="ident" id="3746223">ka</span><span class="op" id="3746225">.</span><span class="ident" id="3746226">curve</span><span class="op" id="3746231">,</span>&nbsp;<span class="ident" id="3746233">ckx</span><span class="op" id="3746236">.</span><span class="ident" id="3746237">ciphertext</span><span class="op" id="3746247">[</span><span class="num" id="3746248">1</span><span class="op" id="3746249">:</span><span class="op" id="3746250">]</span><span class="op" id="3746251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746254">if</span>&nbsp;<span class="ident" id="3746257">x</span>&nbsp;<span class="op" id="3746259">==</span>&nbsp;<span class="ident" id="3746262">nil</span>&nbsp;<span class="op" id="3746266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746270">return</span>&nbsp;<span class="ident" id="3746277">nil</span><span class="op" id="3746280">,</span>&nbsp;<span class="ident" id="3746282">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746304">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746307">if</span>&nbsp;<span class="op" id="3746310">!</span><span class="ident" id="3746311">ka</span><span class="op" id="3746313">.</span><span class="ident" id="3746314">curve</span><span class="op" id="3746319">.</span><span class="ident" id="3746320">IsOnCurve</span><span class="op" id="3746329">(</span><span class="ident" id="3746330">x</span><span class="op" id="3746331">,</span>&nbsp;<span class="ident" id="3746333">y</span><span class="op" id="3746334">)</span>&nbsp;<span class="op" id="3746336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746340">return</span>&nbsp;<span class="ident" id="3746347">nil</span><span class="op" id="3746350">,</span>&nbsp;<span class="ident" id="3746352">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746377">x</span><span class="op" id="3746378">,</span>&nbsp;<span class="ident" id="3746380">_</span>&nbsp;<span class="op" id="3746382">=</span>&nbsp;<span class="ident" id="3746384">ka</span><span class="op" id="3746386">.</span><span class="ident" id="3746387">curve</span><span class="op" id="3746392">.</span><span class="ident" id="3746393">ScalarMult</span><span class="op" id="3746403">(</span><span class="ident" id="3746404">x</span><span class="op" id="3746405">,</span>&nbsp;<span class="ident" id="3746407">y</span><span class="op" id="3746408">,</span>&nbsp;<span class="ident" id="3746410">ka</span><span class="op" id="3746412">.</span><span class="ident" id="3746413">privateKey</span><span class="op" id="3746423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746426">preMasterSecret</span>&nbsp;<span class="op" id="3746442">:=</span>&nbsp;<span class="builtinfunc" id="3746445">make</span><span class="op" id="3746449">(</span><span class="op" id="3746450">[</span><span class="op" id="3746451">]</span><span class="builtintype" id="3746452">byte</span><span class="op" id="3746456">,</span>&nbsp;<span class="op" id="3746458">(</span><span class="ident" id="3746459">ka</span><span class="op" id="3746461">.</span><span class="ident" id="3746462">curve</span><span class="op" id="3746467">.</span><span class="ident" id="3746468">Params</span><span class="op" id="3746474">(</span><span class="op" id="3746475">)</span><span class="op" id="3746476">.</span><span class="ident" id="3746477">BitSize</span><span class="op" id="3746484">+</span><span class="num" id="3746485">7</span><span class="op" id="3746486">)</span><span class="op" id="3746487">&gt;&gt;</span><span class="num" id="3746489">3</span><span class="op" id="3746490">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746493">xBytes</span>&nbsp;<span class="op" id="3746500">:=</span>&nbsp;<span class="ident" id="3746503">x</span><span class="op" id="3746504">.</span><span class="ident" id="3746505">Bytes</span><span class="op" id="3746510">(</span><span class="op" id="3746511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3746514">copy</span><span class="op" id="3746518">(</span><span class="ident" id="3746519">preMasterSecret</span><span class="op" id="3746534">[</span><span class="builtinfunc" id="3746535">len</span><span class="op" id="3746538">(</span><span class="ident" id="3746539">preMasterSecret</span><span class="op" id="3746554">)</span><span class="op" id="3746555">-</span><span class="builtinfunc" id="3746556">len</span><span class="op" id="3746559">(</span><span class="ident" id="3746560">xBytes</span><span class="op" id="3746566">)</span><span class="op" id="3746567">:</span><span class="op" id="3746568">]</span><span class="op" id="3746569">,</span>&nbsp;<span class="ident" id="3746571">xBytes</span><span class="op" id="3746577">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746581">return</span>&nbsp;<span class="ident" id="3746588">preMasterSecret</span><span class="op" id="3746603">,</span>&nbsp;<span class="ident" id="3746605">nil</span><br>
<span class="lineno"></span><span class="op" id="3746609">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3746612">func</span>&nbsp;<span class="op" id="3746617">(</span><span class="ident" id="3746618">ka</span>&nbsp;<span class="op" id="3746621">*</span><span class="ident" id="3746622">ecdheKeyAgreement</span><span class="op" id="3746639">)</span>&nbsp;<span class="ident" id="3746641">processServerKeyExchange</span><span class="op" id="3746665">(</span><span class="ident" id="3746666">config</span>&nbsp;<span class="op" id="3746673">*</span><span class="ident" id="3746674">Config</span><span class="op" id="3746680">,</span>&nbsp;<span class="ident" id="3746682">clientHello</span>&nbsp;<span class="op" id="3746694">*</span><span class="ident" id="3746695">clientHelloMsg</span><span class="op" id="3746709">,</span>&nbsp;<span class="ident" id="3746711">serverHello</span>&nbsp;<span class="op" id="3746723">*</span><span class="ident" id="3746724">serverHelloMsg</span><span class="op" id="3746738">,</span>&nbsp;<span class="ident" id="3746740">cert</span>&nbsp;<span class="op" id="3746745">*</span><span class="ident" id="3746746">x509</span><span class="op" id="3746750">.</span><span class="ident" id="3746751">Certificate</span><span class="op" id="3746762">,</span>&nbsp;<span class="ident" id="3746764">skx</span>&nbsp;<span class="op" id="3746768">*</span><span class="ident" id="3746769">serverKeyExchangeMsg</span><span class="op" id="3746789">)</span>&nbsp;<span class="builtintype" id="3746791">error</span>&nbsp;<span class="op" id="3746797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746800">if</span>&nbsp;<span class="builtinfunc" id="3746803">len</span><span class="op" id="3746806">(</span><span class="ident" id="3746807">skx</span><span class="op" id="3746810">.</span><span class="ident" id="3746811">key</span><span class="op" id="3746814">)</span>&nbsp;<span class="op" id="3746816">&lt;</span>&nbsp;<span class="num" id="3746818">4</span>&nbsp;<span class="op" id="3746820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746824">return</span>&nbsp;<span class="ident" id="3746831">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746853">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746856">if</span>&nbsp;<span class="ident" id="3746859">skx</span><span class="op" id="3746862">.</span><span class="ident" id="3746863">key</span><span class="op" id="3746866">[</span><span class="num" id="3746867">0</span><span class="op" id="3746868">]</span>&nbsp;<span class="op" id="3746870">!=</span>&nbsp;<span class="num" id="3746873">3</span>&nbsp;<span class="op" id="3746875">{</span>&nbsp;<span class="comment" id="3746877">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746894">return</span>&nbsp;<span class="ident" id="3746901">errors</span><span class="op" id="3746907">.</span><span class="ident" id="3746908">New</span><span class="op" id="3746911">(</span><span class="string" id="3746912">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3746952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746958">curveid</span>&nbsp;<span class="op" id="3746966">:=</span>&nbsp;<span class="ident" id="3746969">CurveID</span><span class="op" id="3746976">(</span><span class="ident" id="3746977">skx</span><span class="op" id="3746980">.</span><span class="ident" id="3746981">key</span><span class="op" id="3746984">[</span><span class="num" id="3746985">1</span><span class="op" id="3746986">]</span><span class="op" id="3746987">)</span><span class="op" id="3746988">&lt;&lt;</span><span class="num" id="3746990">8</span>&nbsp;<span class="op" id="3746992">|</span>&nbsp;<span class="ident" id="3746994">CurveID</span><span class="op" id="3747001">(</span><span class="ident" id="3747002">skx</span><span class="op" id="3747005">.</span><span class="ident" id="3747006">key</span><span class="op" id="3747009">[</span><span class="num" id="3747010">2</span><span class="op" id="3747011">]</span><span class="op" id="3747012">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747016">var</span>&nbsp;<span class="ident" id="3747020">ok</span>&nbsp;<span class="builtintype" id="3747023">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747029">if</span>&nbsp;<span class="ident" id="3747032">ka</span><span class="op" id="3747034">.</span><span class="ident" id="3747035">curve</span><span class="op" id="3747040">,</span>&nbsp;<span class="ident" id="3747042">ok</span>&nbsp;<span class="op" id="3747045">=</span>&nbsp;<span class="ident" id="3747047">curveForCurveID</span><span class="op" id="3747062">(</span><span class="ident" id="3747063">curveid</span><span class="op" id="3747070">)</span><span class="op" id="3747071">;</span>&nbsp;<span class="op" id="3747073">!</span><span class="ident" id="3747074">ok</span>&nbsp;<span class="op" id="3747077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747081">return</span>&nbsp;<span class="ident" id="3747088">errors</span><span class="op" id="3747094">.</span><span class="ident" id="3747095">New</span><span class="op" id="3747098">(</span><span class="string" id="3747099">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3747139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747146">publicLen</span>&nbsp;<span class="op" id="3747156">:=</span>&nbsp;<span class="builtintype" id="3747159">int</span><span class="op" id="3747162">(</span><span class="ident" id="3747163">skx</span><span class="op" id="3747166">.</span><span class="ident" id="3747167">key</span><span class="op" id="3747170">[</span><span class="num" id="3747171">3</span><span class="op" id="3747172">]</span><span class="op" id="3747173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747176">if</span>&nbsp;<span class="ident" id="3747179">publicLen</span><span class="op" id="3747188">+</span><span class="num" id="3747189">4</span>&nbsp;<span class="op" id="3747191">&gt;</span>&nbsp;<span class="builtinfunc" id="3747193">len</span><span class="op" id="3747196">(</span><span class="ident" id="3747197">skx</span><span class="op" id="3747200">.</span><span class="ident" id="3747201">key</span><span class="op" id="3747204">)</span>&nbsp;<span class="op" id="3747206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747210">return</span>&nbsp;<span class="ident" id="3747217">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747242">ka</span><span class="op" id="3747244">.</span><span class="ident" id="3747245">x</span><span class="op" id="3747246">,</span>&nbsp;<span class="ident" id="3747248">ka</span><span class="op" id="3747250">.</span><span class="ident" id="3747251">y</span>&nbsp;<span class="op" id="3747253">=</span>&nbsp;<span class="ident" id="3747255">elliptic</span><span class="op" id="3747263">.</span><span class="ident" id="3747264">Unmarshal</span><span class="op" id="3747273">(</span><span class="ident" id="3747274">ka</span><span class="op" id="3747276">.</span><span class="ident" id="3747277">curve</span><span class="op" id="3747282">,</span>&nbsp;<span class="ident" id="3747284">skx</span><span class="op" id="3747287">.</span><span class="ident" id="3747288">key</span><span class="op" id="3747291">[</span><span class="num" id="3747292">4</span><span class="op" id="3747293">:</span><span class="num" id="3747294">4</span><span class="op" id="3747295">+</span><span class="ident" id="3747296">publicLen</span><span class="op" id="3747305">]</span><span class="op" id="3747306">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747309">if</span>&nbsp;<span class="ident" id="3747312">ka</span><span class="op" id="3747314">.</span><span class="ident" id="3747315">x</span>&nbsp;<span class="op" id="3747317">==</span>&nbsp;<span class="ident" id="3747320">nil</span>&nbsp;<span class="op" id="3747324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747328">return</span>&nbsp;<span class="ident" id="3747335">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747360">if</span>&nbsp;<span class="op" id="3747363">!</span><span class="ident" id="3747364">ka</span><span class="op" id="3747366">.</span><span class="ident" id="3747367">curve</span><span class="op" id="3747372">.</span><span class="ident" id="3747373">IsOnCurve</span><span class="op" id="3747382">(</span><span class="ident" id="3747383">ka</span><span class="op" id="3747385">.</span><span class="ident" id="3747386">x</span><span class="op" id="3747387">,</span>&nbsp;<span class="ident" id="3747389">ka</span><span class="op" id="3747391">.</span><span class="ident" id="3747392">y</span><span class="op" id="3747393">)</span>&nbsp;<span class="op" id="3747395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747399">return</span>&nbsp;<span class="ident" id="3747406">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747431">serverECDHParams</span>&nbsp;<span class="op" id="3747448">:=</span>&nbsp;<span class="ident" id="3747451">skx</span><span class="op" id="3747454">.</span><span class="ident" id="3747455">key</span><span class="op" id="3747458">[</span><span class="op" id="3747459">:</span><span class="num" id="3747460">4</span><span class="op" id="3747461">+</span><span class="ident" id="3747462">publicLen</span><span class="op" id="3747471">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747475">sig</span>&nbsp;<span class="op" id="3747479">:=</span>&nbsp;<span class="ident" id="3747482">skx</span><span class="op" id="3747485">.</span><span class="ident" id="3747486">key</span><span class="op" id="3747489">[</span><span class="num" id="3747490">4</span><span class="op" id="3747491">+</span><span class="ident" id="3747492">publicLen</span><span class="op" id="3747501">:</span><span class="op" id="3747502">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747505">if</span>&nbsp;<span class="builtinfunc" id="3747508">len</span><span class="op" id="3747511">(</span><span class="ident" id="3747512">sig</span><span class="op" id="3747515">)</span>&nbsp;<span class="op" id="3747517">&lt;</span>&nbsp;<span class="num" id="3747519">2</span>&nbsp;<span class="op" id="3747521">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747525">return</span>&nbsp;<span class="ident" id="3747532">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747558">var</span>&nbsp;<span class="ident" id="3747562">tls12HashId</span>&nbsp;<span class="builtintype" id="3747574">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747581">if</span>&nbsp;<span class="ident" id="3747584">ka</span><span class="op" id="3747586">.</span><span class="ident" id="3747587">version</span>&nbsp;<span class="op" id="3747595">&gt;=</span>&nbsp;<span class="ident" id="3747598">VersionTLS12</span>&nbsp;<span class="op" id="3747611">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3747615">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747653">var</span>&nbsp;<span class="ident" id="3747657">sigAndHash</span>&nbsp;<span class="op" id="3747668">[</span><span class="op" id="3747669">]</span><span class="builtintype" id="3747670">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747678">sigAndHash</span><span class="op" id="3747688">,</span>&nbsp;<span class="ident" id="3747690">sig</span>&nbsp;<span class="op" id="3747694">=</span>&nbsp;<span class="ident" id="3747696">sig</span><span class="op" id="3747699">[</span><span class="op" id="3747700">:</span><span class="num" id="3747701">2</span><span class="op" id="3747702">]</span><span class="op" id="3747703">,</span>&nbsp;<span class="ident" id="3747705">sig</span><span class="op" id="3747708">[</span><span class="num" id="3747709">2</span><span class="op" id="3747710">:</span><span class="op" id="3747711">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747715">if</span>&nbsp;<span class="ident" id="3747718">sigAndHash</span><span class="op" id="3747728">[</span><span class="num" id="3747729">1</span><span class="op" id="3747730">]</span>&nbsp;<span class="op" id="3747732">!=</span>&nbsp;<span class="ident" id="3747735">ka</span><span class="op" id="3747737">.</span><span class="ident" id="3747738">sigType</span>&nbsp;<span class="op" id="3747746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747751">return</span>&nbsp;<span class="ident" id="3747758">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747785">tls12HashId</span>&nbsp;<span class="op" id="3747797">=</span>&nbsp;<span class="ident" id="3747799">sigAndHash</span><span class="op" id="3747809">[</span><span class="num" id="3747810">0</span><span class="op" id="3747811">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747815">if</span>&nbsp;<span class="builtinfunc" id="3747818">len</span><span class="op" id="3747821">(</span><span class="ident" id="3747822">sig</span><span class="op" id="3747825">)</span>&nbsp;<span class="op" id="3747827">&lt;</span>&nbsp;<span class="num" id="3747829">2</span>&nbsp;<span class="op" id="3747831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747836">return</span>&nbsp;<span class="ident" id="3747843">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747866">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747872">sigLen</span>&nbsp;<span class="op" id="3747879">:=</span>&nbsp;<span class="builtintype" id="3747882">int</span><span class="op" id="3747885">(</span><span class="ident" id="3747886">sig</span><span class="op" id="3747889">[</span><span class="num" id="3747890">0</span><span class="op" id="3747891">]</span><span class="op" id="3747892">)</span><span class="op" id="3747893">&lt;&lt;</span><span class="num" id="3747895">8</span>&nbsp;<span class="op" id="3747897">|</span>&nbsp;<span class="builtintype" id="3747899">int</span><span class="op" id="3747902">(</span><span class="ident" id="3747903">sig</span><span class="op" id="3747906">[</span><span class="num" id="3747907">1</span><span class="op" id="3747908">]</span><span class="op" id="3747909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747912">if</span>&nbsp;<span class="ident" id="3747915">sigLen</span><span class="op" id="3747921">+</span><span class="num" id="3747922">2</span>&nbsp;<span class="op" id="3747924">!=</span>&nbsp;<span class="builtinfunc" id="3747927">len</span><span class="op" id="3747930">(</span><span class="ident" id="3747931">sig</span><span class="op" id="3747934">)</span>&nbsp;<span class="op" id="3747936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3747940">return</span>&nbsp;<span class="ident" id="3747947">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3747969">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747972">sig</span>&nbsp;<span class="op" id="3747976">=</span>&nbsp;<span class="ident" id="3747978">sig</span><span class="op" id="3747981">[</span><span class="num" id="3747982">2</span><span class="op" id="3747983">:</span><span class="op" id="3747984">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3747988">digest</span><span class="op" id="3747994">,</span>&nbsp;<span class="ident" id="3747996">hashFunc</span><span class="op" id="3748004">,</span>&nbsp;<span class="ident" id="3748006">err</span>&nbsp;<span class="op" id="3748010">:=</span>&nbsp;<span class="ident" id="3748013">hashForServerKeyExchange</span><span class="op" id="3748037">(</span><span class="ident" id="3748038">ka</span><span class="op" id="3748040">.</span><span class="ident" id="3748041">sigType</span><span class="op" id="3748048">,</span>&nbsp;<span class="ident" id="3748050">tls12HashId</span><span class="op" id="3748061">,</span>&nbsp;<span class="ident" id="3748063">ka</span><span class="op" id="3748065">.</span><span class="ident" id="3748066">version</span><span class="op" id="3748073">,</span>&nbsp;<span class="ident" id="3748075">clientHello</span><span class="op" id="3748086">.</span><span class="ident" id="3748087">random</span><span class="op" id="3748093">,</span>&nbsp;<span class="ident" id="3748095">serverHello</span><span class="op" id="3748106">.</span><span class="ident" id="3748107">random</span><span class="op" id="3748113">,</span>&nbsp;<span class="ident" id="3748115">serverECDHParams</span><span class="op" id="3748131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748134">if</span>&nbsp;<span class="ident" id="3748137">err</span>&nbsp;<span class="op" id="3748141">!=</span>&nbsp;<span class="ident" id="3748144">nil</span>&nbsp;<span class="op" id="3748148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748152">return</span>&nbsp;<span class="ident" id="3748159">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748167">switch</span>&nbsp;<span class="ident" id="3748174">ka</span><span class="op" id="3748176">.</span><span class="ident" id="3748177">sigType</span>&nbsp;<span class="op" id="3748185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748188">case</span>&nbsp;<span class="ident" id="3748193">signatureECDSA</span><span class="op" id="3748207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748211">pubKey</span><span class="op" id="3748217">,</span>&nbsp;<span class="ident" id="3748219">ok</span>&nbsp;<span class="op" id="3748222">:=</span>&nbsp;<span class="ident" id="3748225">cert</span><span class="op" id="3748229">.</span><span class="ident" id="3748230">PublicKey</span><span class="op" id="3748239">.</span><span class="op" id="3748240">(</span><span class="op" id="3748241">*</span><span class="ident" id="3748242">ecdsa</span><span class="op" id="3748247">.</span><span class="ident" id="3748248">PublicKey</span><span class="op" id="3748257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748261">if</span>&nbsp;<span class="op" id="3748264">!</span><span class="ident" id="3748265">ok</span>&nbsp;<span class="op" id="3748268">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748273">return</span>&nbsp;<span class="ident" id="3748280">errors</span><span class="op" id="3748286">.</span><span class="ident" id="3748287">New</span><span class="op" id="3748290">(</span><span class="string" id="3748291">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3748339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748347">ecdsaSig</span>&nbsp;<span class="op" id="3748356">:=</span>&nbsp;<span class="builtinfunc" id="3748359">new</span><span class="op" id="3748362">(</span><span class="ident" id="3748363">ecdsaSignature</span><span class="op" id="3748377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748381">if</span>&nbsp;<span class="ident" id="3748384">_</span><span class="op" id="3748385">,</span>&nbsp;<span class="ident" id="3748387">err</span>&nbsp;<span class="op" id="3748391">:=</span>&nbsp;<span class="ident" id="3748394">asn1</span><span class="op" id="3748398">.</span><span class="ident" id="3748399">Unmarshal</span><span class="op" id="3748408">(</span><span class="ident" id="3748409">sig</span><span class="op" id="3748412">,</span>&nbsp;<span class="ident" id="3748414">ecdsaSig</span><span class="op" id="3748422">)</span><span class="op" id="3748423">;</span>&nbsp;<span class="ident" id="3748425">err</span>&nbsp;<span class="op" id="3748429">!=</span>&nbsp;<span class="ident" id="3748432">nil</span>&nbsp;<span class="op" id="3748436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748441">return</span>&nbsp;<span class="ident" id="3748448">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748458">if</span>&nbsp;<span class="ident" id="3748461">ecdsaSig</span><span class="op" id="3748469">.</span><span class="ident" id="3748470">R</span><span class="op" id="3748471">.</span><span class="ident" id="3748472">Sign</span><span class="op" id="3748476">(</span><span class="op" id="3748477">)</span>&nbsp;<span class="op" id="3748479">&lt;=</span>&nbsp;<span class="num" id="3748482">0</span>&nbsp;<span class="op" id="3748484">||</span>&nbsp;<span class="ident" id="3748487">ecdsaSig</span><span class="op" id="3748495">.</span><span class="ident" id="3748496">S</span><span class="op" id="3748497">.</span><span class="ident" id="3748498">Sign</span><span class="op" id="3748502">(</span><span class="op" id="3748503">)</span>&nbsp;<span class="op" id="3748505">&lt;=</span>&nbsp;<span class="num" id="3748508">0</span>&nbsp;<span class="op" id="3748510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748515">return</span>&nbsp;<span class="ident" id="3748522">errors</span><span class="op" id="3748528">.</span><span class="ident" id="3748529">New</span><span class="op" id="3748532">(</span><span class="string" id="3748533">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3748584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748592">if</span>&nbsp;<span class="op" id="3748595">!</span><span class="ident" id="3748596">ecdsa</span><span class="op" id="3748601">.</span><span class="ident" id="3748602">Verify</span><span class="op" id="3748608">(</span><span class="ident" id="3748609">pubKey</span><span class="op" id="3748615">,</span>&nbsp;<span class="ident" id="3748617">digest</span><span class="op" id="3748623">,</span>&nbsp;<span class="ident" id="3748625">ecdsaSig</span><span class="op" id="3748633">.</span><span class="ident" id="3748634">R</span><span class="op" id="3748635">,</span>&nbsp;<span class="ident" id="3748637">ecdsaSig</span><span class="op" id="3748645">.</span><span class="ident" id="3748646">S</span><span class="op" id="3748647">)</span>&nbsp;<span class="op" id="3748649">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748654">return</span>&nbsp;<span class="ident" id="3748661">errors</span><span class="op" id="3748667">.</span><span class="ident" id="3748668">New</span><span class="op" id="3748671">(</span><span class="string" id="3748672">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3748700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748707">case</span>&nbsp;<span class="ident" id="3748712">signatureRSA</span><span class="op" id="3748724">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3748728">pubKey</span><span class="op" id="3748734">,</span>&nbsp;<span class="ident" id="3748736">ok</span>&nbsp;<span class="op" id="3748739">:=</span>&nbsp;<span class="ident" id="3748742">cert</span><span class="op" id="3748746">.</span><span class="ident" id="3748747">PublicKey</span><span class="op" id="3748756">.</span><span class="op" id="3748757">(</span><span class="op" id="3748758">*</span><span class="ident" id="3748759">rsa</span><span class="op" id="3748762">.</span><span class="ident" id="3748763">PublicKey</span><span class="op" id="3748772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748776">if</span>&nbsp;<span class="op" id="3748779">!</span><span class="ident" id="3748780">ok</span>&nbsp;<span class="op" id="3748783">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748788">return</span>&nbsp;<span class="ident" id="3748795">errors</span><span class="op" id="3748801">.</span><span class="ident" id="3748802">New</span><span class="op" id="3748805">(</span><span class="string" id="3748806">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3748850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748858">if</span>&nbsp;<span class="ident" id="3748861">err</span>&nbsp;<span class="op" id="3748865">:=</span>&nbsp;<span class="ident" id="3748868">rsa</span><span class="op" id="3748871">.</span><span class="ident" id="3748872">VerifyPKCS1v15</span><span class="op" id="3748886">(</span><span class="ident" id="3748887">pubKey</span><span class="op" id="3748893">,</span>&nbsp;<span class="ident" id="3748895">hashFunc</span><span class="op" id="3748903">,</span>&nbsp;<span class="ident" id="3748905">digest</span><span class="op" id="3748911">,</span>&nbsp;<span class="ident" id="3748913">sig</span><span class="op" id="3748916">)</span><span class="op" id="3748917">;</span>&nbsp;<span class="ident" id="3748919">err</span>&nbsp;<span class="op" id="3748923">!=</span>&nbsp;<span class="ident" id="3748926">nil</span>&nbsp;<span class="op" id="3748930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748935">return</span>&nbsp;<span class="ident" id="3748942">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3748948">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748951">default</span><span class="op" id="3748958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3748962">return</span>&nbsp;<span class="ident" id="3748969">errors</span><span class="op" id="3748975">.</span><span class="ident" id="3748976">New</span><span class="op" id="3748979">(</span><span class="string" id="3748980">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3749015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3749018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749022">return</span>&nbsp;<span class="ident" id="3749029">nil</span><br>
<span class="lineno">390</span><span class="op" id="3749033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3749036">func</span>&nbsp;<span class="op" id="3749041">(</span><span class="ident" id="3749042">ka</span>&nbsp;<span class="op" id="3749045">*</span><span class="ident" id="3749046">ecdheKeyAgreement</span><span class="op" id="3749063">)</span>&nbsp;<span class="ident" id="3749065">generateClientKeyExchange</span><span class="op" id="3749090">(</span><span class="ident" id="3749091">config</span>&nbsp;<span class="op" id="3749098">*</span><span class="ident" id="3749099">Config</span><span class="op" id="3749105">,</span>&nbsp;<span class="ident" id="3749107">clientHello</span>&nbsp;<span class="op" id="3749119">*</span><span class="ident" id="3749120">clientHelloMsg</span><span class="op" id="3749134">,</span>&nbsp;<span class="ident" id="3749136">cert</span>&nbsp;<span class="op" id="3749141">*</span><span class="ident" id="3749142">x509</span><span class="op" id="3749146">.</span><span class="ident" id="3749147">Certificate</span><span class="op" id="3749158">)</span>&nbsp;<span class="op" id="3749160">(</span><span class="op" id="3749161">[</span><span class="op" id="3749162">]</span><span class="builtintype" id="3749163">byte</span><span class="op" id="3749167">,</span>&nbsp;<span class="op" id="3749169">*</span><span class="ident" id="3749170">clientKeyExchangeMsg</span><span class="op" id="3749190">,</span>&nbsp;<span class="builtintype" id="3749192">error</span><span class="op" id="3749197">)</span>&nbsp;<span class="op" id="3749199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749202">if</span>&nbsp;<span class="ident" id="3749205">ka</span><span class="op" id="3749207">.</span><span class="ident" id="3749208">curve</span>&nbsp;<span class="op" id="3749214">==</span>&nbsp;<span class="ident" id="3749217">nil</span>&nbsp;<span class="op" id="3749221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749225">return</span>&nbsp;<span class="ident" id="3749232">nil</span><span class="op" id="3749235">,</span>&nbsp;<span class="ident" id="3749237">nil</span><span class="op" id="3749240">,</span>&nbsp;<span class="ident" id="3749242">errors</span><span class="op" id="3749248">.</span><span class="ident" id="3749249">New</span><span class="op" id="3749252">(</span><span class="string" id="3749253">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3749288">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3749291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749294">priv</span><span class="op" id="3749298">,</span>&nbsp;<span class="ident" id="3749300">mx</span><span class="op" id="3749302">,</span>&nbsp;<span class="ident" id="3749304">my</span><span class="op" id="3749306">,</span>&nbsp;<span class="ident" id="3749308">err</span>&nbsp;<span class="op" id="3749312">:=</span>&nbsp;<span class="ident" id="3749315">elliptic</span><span class="op" id="3749323">.</span><span class="ident" id="3749324">GenerateKey</span><span class="op" id="3749335">(</span><span class="ident" id="3749336">ka</span><span class="op" id="3749338">.</span><span class="ident" id="3749339">curve</span><span class="op" id="3749344">,</span>&nbsp;<span class="ident" id="3749346">config</span><span class="op" id="3749352">.</span><span class="ident" id="3749353">rand</span><span class="op" id="3749357">(</span><span class="op" id="3749358">)</span><span class="op" id="3749359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749362">if</span>&nbsp;<span class="ident" id="3749365">err</span>&nbsp;<span class="op" id="3749369">!=</span>&nbsp;<span class="ident" id="3749372">nil</span>&nbsp;<span class="op" id="3749376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749380">return</span>&nbsp;<span class="ident" id="3749387">nil</span><span class="op" id="3749390">,</span>&nbsp;<span class="ident" id="3749392">nil</span><span class="op" id="3749395">,</span>&nbsp;<span class="ident" id="3749397">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3749402">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749405">x</span><span class="op" id="3749406">,</span>&nbsp;<span class="ident" id="3749408">_</span>&nbsp;<span class="op" id="3749410">:=</span>&nbsp;<span class="ident" id="3749413">ka</span><span class="op" id="3749415">.</span><span class="ident" id="3749416">curve</span><span class="op" id="3749421">.</span><span class="ident" id="3749422">ScalarMult</span><span class="op" id="3749432">(</span><span class="ident" id="3749433">ka</span><span class="op" id="3749435">.</span><span class="ident" id="3749436">x</span><span class="op" id="3749437">,</span>&nbsp;<span class="ident" id="3749439">ka</span><span class="op" id="3749441">.</span><span class="ident" id="3749442">y</span><span class="op" id="3749443">,</span>&nbsp;<span class="ident" id="3749445">priv</span><span class="op" id="3749449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749452">preMasterSecret</span>&nbsp;<span class="op" id="3749468">:=</span>&nbsp;<span class="builtinfunc" id="3749471">make</span><span class="op" id="3749475">(</span><span class="op" id="3749476">[</span><span class="op" id="3749477">]</span><span class="builtintype" id="3749478">byte</span><span class="op" id="3749482">,</span>&nbsp;<span class="op" id="3749484">(</span><span class="ident" id="3749485">ka</span><span class="op" id="3749487">.</span><span class="ident" id="3749488">curve</span><span class="op" id="3749493">.</span><span class="ident" id="3749494">Params</span><span class="op" id="3749500">(</span><span class="op" id="3749501">)</span><span class="op" id="3749502">.</span><span class="ident" id="3749503">BitSize</span><span class="op" id="3749510">+</span><span class="num" id="3749511">7</span><span class="op" id="3749512">)</span><span class="op" id="3749513">&gt;&gt;</span><span class="num" id="3749515">3</span><span class="op" id="3749516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749519">xBytes</span>&nbsp;<span class="op" id="3749526">:=</span>&nbsp;<span class="ident" id="3749529">x</span><span class="op" id="3749530">.</span><span class="ident" id="3749531">Bytes</span><span class="op" id="3749536">(</span><span class="op" id="3749537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3749540">copy</span><span class="op" id="3749544">(</span><span class="ident" id="3749545">preMasterSecret</span><span class="op" id="3749560">[</span><span class="builtinfunc" id="3749561">len</span><span class="op" id="3749564">(</span><span class="ident" id="3749565">preMasterSecret</span><span class="op" id="3749580">)</span><span class="op" id="3749581">-</span><span class="builtinfunc" id="3749582">len</span><span class="op" id="3749585">(</span><span class="ident" id="3749586">xBytes</span><span class="op" id="3749592">)</span><span class="op" id="3749593">:</span><span class="op" id="3749594">]</span><span class="op" id="3749595">,</span>&nbsp;<span class="ident" id="3749597">xBytes</span><span class="op" id="3749603">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749607">serialized</span>&nbsp;<span class="op" id="3749618">:=</span>&nbsp;<span class="ident" id="3749621">elliptic</span><span class="op" id="3749629">.</span><span class="ident" id="3749630">Marshal</span><span class="op" id="3749637">(</span><span class="ident" id="3749638">ka</span><span class="op" id="3749640">.</span><span class="ident" id="3749641">curve</span><span class="op" id="3749646">,</span>&nbsp;<span class="ident" id="3749648">mx</span><span class="op" id="3749650">,</span>&nbsp;<span class="ident" id="3749652">my</span><span class="op" id="3749654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749658">ckx</span>&nbsp;<span class="op" id="3749662">:=</span>&nbsp;<span class="builtinfunc" id="3749665">new</span><span class="op" id="3749668">(</span><span class="ident" id="3749669">clientKeyExchangeMsg</span><span class="op" id="3749689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749692">ckx</span><span class="op" id="3749695">.</span><span class="ident" id="3749696">ciphertext</span>&nbsp;<span class="op" id="3749707">=</span>&nbsp;<span class="builtinfunc" id="3749709">make</span><span class="op" id="3749713">(</span><span class="op" id="3749714">[</span><span class="op" id="3749715">]</span><span class="builtintype" id="3749716">byte</span><span class="op" id="3749720">,</span>&nbsp;<span class="num" id="3749722">1</span><span class="op" id="3749723">+</span><span class="builtinfunc" id="3749724">len</span><span class="op" id="3749727">(</span><span class="ident" id="3749728">serialized</span><span class="op" id="3749738">)</span><span class="op" id="3749739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3749742">ckx</span><span class="op" id="3749745">.</span><span class="ident" id="3749746">ciphertext</span><span class="op" id="3749756">[</span><span class="num" id="3749757">0</span><span class="op" id="3749758">]</span>&nbsp;<span class="op" id="3749760">=</span>&nbsp;<span class="builtintype" id="3749762">byte</span><span class="op" id="3749766">(</span><span class="builtinfunc" id="3749767">len</span><span class="op" id="3749770">(</span><span class="ident" id="3749771">serialized</span><span class="op" id="3749781">)</span><span class="op" id="3749782">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3749785">copy</span><span class="op" id="3749789">(</span><span class="ident" id="3749790">ckx</span><span class="op" id="3749793">.</span><span class="ident" id="3749794">ciphertext</span><span class="op" id="3749804">[</span><span class="num" id="3749805">1</span><span class="op" id="3749806">:</span><span class="op" id="3749807">]</span><span class="op" id="3749808">,</span>&nbsp;<span class="ident" id="3749810">serialized</span><span class="op" id="3749820">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3749824">return</span>&nbsp;<span class="ident" id="3749831">preMasterSecret</span><span class="op" id="3749846">,</span>&nbsp;<span class="ident" id="3749848">ckx</span><span class="op" id="3749851">,</span>&nbsp;<span class="ident" id="3749853">nil</span><br>
<span class="lineno"></span><span class="op" id="3749857">}</span>
</div>
</body>
</html>
