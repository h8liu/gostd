<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html" class="current">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4060031">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4060086">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4060140">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4060191">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060261">package</span>&nbsp;<span class="ident" id="4060269">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060274">import</span>&nbsp;<span class="op" id="4060281">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060284">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060290">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060296">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060307">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060322">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4060333">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4060340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4060343">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="4060371">type</span>&nbsp;<span class="ident" id="4060376">netFD</span>&nbsp;<span class="keyword" id="4060382">struct</span>&nbsp;<span class="op" id="4060389">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060392">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060467">fdmu</span>&nbsp;<span class="ident" id="4060472">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060482">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060508">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4060520">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060525">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4060537">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060542">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4060554">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060559">isConnected</span>&nbsp;<span class="builtintype" id="4060571">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060577">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4060589">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060597">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4060609">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060615">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4060627">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4060634">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060650">pd</span>&nbsp;<span class="ident" id="4060653">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="4060662">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="4060665">func</span>&nbsp;<span class="ident" id="4060670">sysInit</span><span class="op" id="4060677">(</span><span class="op" id="4060678">)</span>&nbsp;<span class="op" id="4060680">{</span><br>
<span class="lineno"></span><span class="op" id="4060682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060685">func</span>&nbsp;<span class="ident" id="4060690">dial</span><span class="op" id="4060694">(</span><span class="ident" id="4060695">network</span>&nbsp;<span class="builtintype" id="4060703">string</span><span class="op" id="4060709">,</span>&nbsp;<span class="ident" id="4060711">ra</span>&nbsp;<span class="ident" id="4060714">Addr</span><span class="op" id="4060718">,</span>&nbsp;<span class="ident" id="4060720">dialer</span>&nbsp;<span class="keyword" id="4060727">func</span><span class="op" id="4060731">(</span><span class="ident" id="4060732">time</span><span class="op" id="4060736">.</span><span class="ident" id="4060737">Time</span><span class="op" id="4060741">)</span>&nbsp;<span class="op" id="4060743">(</span><span class="ident" id="4060744">Conn</span><span class="op" id="4060748">,</span>&nbsp;<span class="builtintype" id="4060750">error</span><span class="op" id="4060755">)</span><span class="op" id="4060756">,</span>&nbsp;<span class="ident" id="4060758">deadline</span>&nbsp;<span class="ident" id="4060767">time</span><span class="op" id="4060771">.</span><span class="ident" id="4060772">Time</span><span class="op" id="4060776">)</span>&nbsp;<span class="op" id="4060778">(</span><span class="ident" id="4060779">Conn</span><span class="op" id="4060783">,</span>&nbsp;<span class="builtintype" id="4060785">error</span><span class="op" id="4060790">)</span>&nbsp;<span class="op" id="4060792">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060795">return</span>&nbsp;<span class="ident" id="4060802">dialer</span><span class="op" id="4060808">(</span><span class="ident" id="4060809">deadline</span><span class="op" id="4060817">)</span><br>
<span class="lineno"></span><span class="op" id="4060819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060822">func</span>&nbsp;<span class="ident" id="4060827">newFD</span><span class="op" id="4060832">(</span><span class="ident" id="4060833">sysfd</span><span class="op" id="4060838">,</span>&nbsp;<span class="ident" id="4060840">family</span><span class="op" id="4060846">,</span>&nbsp;<span class="ident" id="4060848">sotype</span>&nbsp;<span class="builtintype" id="4060855">int</span><span class="op" id="4060858">,</span>&nbsp;<span class="ident" id="4060860">net</span>&nbsp;<span class="builtintype" id="4060864">string</span><span class="op" id="4060870">)</span>&nbsp;<span class="op" id="4060872">(</span><span class="op" id="4060873">*</span><span class="ident" id="4060874">netFD</span><span class="op" id="4060879">,</span>&nbsp;<span class="builtintype" id="4060881">error</span><span class="op" id="4060886">)</span>&nbsp;<span class="op" id="4060888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060891">return</span>&nbsp;<span class="op" id="4060898">&amp;</span><span class="ident" id="4060899">netFD</span><span class="op" id="4060904">{</span><span class="ident" id="4060905">sysfd</span><span class="op" id="4060910">:</span>&nbsp;<span class="ident" id="4060912">sysfd</span><span class="op" id="4060917">,</span>&nbsp;<span class="ident" id="4060919">family</span><span class="op" id="4060925">:</span>&nbsp;<span class="ident" id="4060927">family</span><span class="op" id="4060933">,</span>&nbsp;<span class="ident" id="4060935">sotype</span><span class="op" id="4060941">:</span>&nbsp;<span class="ident" id="4060943">sotype</span><span class="op" id="4060949">,</span>&nbsp;<span class="ident" id="4060951">net</span><span class="op" id="4060954">:</span>&nbsp;<span class="ident" id="4060956">net</span><span class="op" id="4060959">}</span><span class="op" id="4060960">,</span>&nbsp;<span class="ident" id="4060962">nil</span><br>
<span class="lineno">45</span><span class="op" id="4060966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4060969">func</span>&nbsp;<span class="op" id="4060974">(</span><span class="ident" id="4060975">fd</span>&nbsp;<span class="op" id="4060978">*</span><span class="ident" id="4060979">netFD</span><span class="op" id="4060984">)</span>&nbsp;<span class="ident" id="4060986">init</span><span class="op" id="4060990">(</span><span class="op" id="4060991">)</span>&nbsp;<span class="builtintype" id="4060993">error</span>&nbsp;<span class="op" id="4060999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061002">if</span>&nbsp;<span class="ident" id="4061005">err</span>&nbsp;<span class="op" id="4061009">:=</span>&nbsp;<span class="ident" id="4061012">fd</span><span class="op" id="4061014">.</span><span class="ident" id="4061015">pd</span><span class="op" id="4061017">.</span><span class="ident" id="4061018">Init</span><span class="op" id="4061022">(</span><span class="ident" id="4061023">fd</span><span class="op" id="4061025">)</span><span class="op" id="4061026">;</span>&nbsp;<span class="ident" id="4061028">err</span>&nbsp;<span class="op" id="4061032">!=</span>&nbsp;<span class="ident" id="4061035">nil</span>&nbsp;<span class="op" id="4061039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061043">return</span>&nbsp;<span class="ident" id="4061050">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061058">return</span>&nbsp;<span class="ident" id="4061065">nil</span><br>
<span class="lineno"></span><span class="op" id="4061069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4061072">func</span>&nbsp;<span class="op" id="4061077">(</span><span class="ident" id="4061078">fd</span>&nbsp;<span class="op" id="4061081">*</span><span class="ident" id="4061082">netFD</span><span class="op" id="4061087">)</span>&nbsp;<span class="ident" id="4061089">setAddr</span><span class="op" id="4061096">(</span><span class="ident" id="4061097">laddr</span><span class="op" id="4061102">,</span>&nbsp;<span class="ident" id="4061104">raddr</span>&nbsp;<span class="ident" id="4061110">Addr</span><span class="op" id="4061114">)</span>&nbsp;<span class="op" id="4061116">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061119">fd</span><span class="op" id="4061121">.</span><span class="ident" id="4061122">laddr</span>&nbsp;<span class="op" id="4061128">=</span>&nbsp;<span class="ident" id="4061130">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061137">fd</span><span class="op" id="4061139">.</span><span class="ident" id="4061140">raddr</span>&nbsp;<span class="op" id="4061146">=</span>&nbsp;<span class="ident" id="4061148">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061155">runtime</span><span class="op" id="4061162">.</span><span class="ident" id="4061163">SetFinalizer</span><span class="op" id="4061175">(</span><span class="ident" id="4061176">fd</span><span class="op" id="4061178">,</span>&nbsp;<span class="op" id="4061180">(</span><span class="op" id="4061181">*</span><span class="ident" id="4061182">netFD</span><span class="op" id="4061187">)</span><span class="op" id="4061188">.</span><span class="ident" id="4061189">Close</span><span class="op" id="4061194">)</span><br>
<span class="lineno"></span><span class="op" id="4061196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4061199">func</span>&nbsp;<span class="op" id="4061204">(</span><span class="ident" id="4061205">fd</span>&nbsp;<span class="op" id="4061208">*</span><span class="ident" id="4061209">netFD</span><span class="op" id="4061214">)</span>&nbsp;<span class="ident" id="4061216">name</span><span class="op" id="4061220">(</span><span class="op" id="4061221">)</span>&nbsp;<span class="builtintype" id="4061223">string</span>&nbsp;<span class="op" id="4061230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061233">var</span>&nbsp;<span class="ident" id="4061237">ls</span><span class="op" id="4061239">,</span>&nbsp;<span class="ident" id="4061241">rs</span>&nbsp;<span class="builtintype" id="4061244">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061252">if</span>&nbsp;<span class="ident" id="4061255">fd</span><span class="op" id="4061257">.</span><span class="ident" id="4061258">laddr</span>&nbsp;<span class="op" id="4061264">!=</span>&nbsp;<span class="ident" id="4061267">nil</span>&nbsp;<span class="op" id="4061271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061275">ls</span>&nbsp;<span class="op" id="4061278">=</span>&nbsp;<span class="ident" id="4061280">fd</span><span class="op" id="4061282">.</span><span class="ident" id="4061283">laddr</span><span class="op" id="4061288">.</span><span class="ident" id="4061289">String</span><span class="op" id="4061295">(</span><span class="op" id="4061296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061299">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061302">if</span>&nbsp;<span class="ident" id="4061305">fd</span><span class="op" id="4061307">.</span><span class="ident" id="4061308">raddr</span>&nbsp;<span class="op" id="4061314">!=</span>&nbsp;<span class="ident" id="4061317">nil</span>&nbsp;<span class="op" id="4061321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061325">rs</span>&nbsp;<span class="op" id="4061328">=</span>&nbsp;<span class="ident" id="4061330">fd</span><span class="op" id="4061332">.</span><span class="ident" id="4061333">raddr</span><span class="op" id="4061338">.</span><span class="ident" id="4061339">String</span><span class="op" id="4061345">(</span><span class="op" id="4061346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061352">return</span>&nbsp;<span class="ident" id="4061359">fd</span><span class="op" id="4061361">.</span><span class="ident" id="4061362">net</span>&nbsp;<span class="op" id="4061366">+</span>&nbsp;<span class="string" id="4061368">&#34;:&#34;</span>&nbsp;<span class="op" id="4061372">+</span>&nbsp;<span class="ident" id="4061374">ls</span>&nbsp;<span class="op" id="4061377">+</span>&nbsp;<span class="string" id="4061379">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="4061384">+</span>&nbsp;<span class="ident" id="4061386">rs</span><br>
<span class="lineno"></span><span class="op" id="4061389">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="4061392">func</span>&nbsp;<span class="op" id="4061397">(</span><span class="ident" id="4061398">fd</span>&nbsp;<span class="op" id="4061401">*</span><span class="ident" id="4061402">netFD</span><span class="op" id="4061407">)</span>&nbsp;<span class="ident" id="4061409">connect</span><span class="op" id="4061416">(</span><span class="ident" id="4061417">la</span><span class="op" id="4061419">,</span>&nbsp;<span class="ident" id="4061421">ra</span>&nbsp;<span class="ident" id="4061424">syscall</span><span class="op" id="4061431">.</span><span class="ident" id="4061432">Sockaddr</span><span class="op" id="4061440">,</span>&nbsp;<span class="ident" id="4061442">deadline</span>&nbsp;<span class="ident" id="4061451">time</span><span class="op" id="4061455">.</span><span class="ident" id="4061456">Time</span><span class="op" id="4061460">)</span>&nbsp;<span class="builtintype" id="4061462">error</span>&nbsp;<span class="op" id="4061468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4061471">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4061514">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4061560">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061606">switch</span>&nbsp;<span class="ident" id="4061613">err</span>&nbsp;<span class="op" id="4061617">:=</span>&nbsp;<span class="ident" id="4061620">syscall</span><span class="op" id="4061627">.</span><span class="ident" id="4061628">Connect</span><span class="op" id="4061635">(</span><span class="ident" id="4061636">fd</span><span class="op" id="4061638">.</span><span class="ident" id="4061639">sysfd</span><span class="op" id="4061644">,</span>&nbsp;<span class="ident" id="4061646">ra</span><span class="op" id="4061648">)</span><span class="op" id="4061649">;</span>&nbsp;<span class="ident" id="4061651">err</span>&nbsp;<span class="op" id="4061655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061658">case</span>&nbsp;<span class="ident" id="4061663">syscall</span><span class="op" id="4061670">.</span><span class="ident" id="4061671">EINPROGRESS</span><span class="op" id="4061682">,</span>&nbsp;<span class="ident" id="4061684">syscall</span><span class="op" id="4061691">.</span><span class="ident" id="4061692">EALREADY</span><span class="op" id="4061700">,</span>&nbsp;<span class="ident" id="4061702">syscall</span><span class="op" id="4061709">.</span><span class="ident" id="4061710">EINTR</span><span class="op" id="4061715">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061718">case</span>&nbsp;<span class="ident" id="4061723">nil</span><span class="op" id="4061726">,</span>&nbsp;<span class="ident" id="4061728">syscall</span><span class="op" id="4061735">.</span><span class="ident" id="4061736">EISCONN</span><span class="op" id="4061743">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061747">if</span>&nbsp;<span class="op" id="4061750">!</span><span class="ident" id="4061751">deadline</span><span class="op" id="4061759">.</span><span class="ident" id="4061760">IsZero</span><span class="op" id="4061766">(</span><span class="op" id="4061767">)</span>&nbsp;<span class="op" id="4061769">&amp;&amp;</span>&nbsp;<span class="ident" id="4061772">deadline</span><span class="op" id="4061780">.</span><span class="ident" id="4061781">Before</span><span class="op" id="4061787">(</span><span class="ident" id="4061788">time</span><span class="op" id="4061792">.</span><span class="ident" id="4061793">Now</span><span class="op" id="4061796">(</span><span class="op" id="4061797">)</span><span class="op" id="4061798">)</span>&nbsp;<span class="op" id="4061800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061805">return</span>&nbsp;<span class="ident" id="4061812">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061829">if</span>&nbsp;<span class="ident" id="4061832">err</span>&nbsp;<span class="op" id="4061836">:=</span>&nbsp;<span class="ident" id="4061839">fd</span><span class="op" id="4061841">.</span><span class="ident" id="4061842">init</span><span class="op" id="4061846">(</span><span class="op" id="4061847">)</span><span class="op" id="4061848">;</span>&nbsp;<span class="ident" id="4061850">err</span>&nbsp;<span class="op" id="4061854">!=</span>&nbsp;<span class="ident" id="4061857">nil</span>&nbsp;<span class="op" id="4061861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061866">return</span>&nbsp;<span class="ident" id="4061873">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061883">return</span>&nbsp;<span class="ident" id="4061890">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061895">case</span>&nbsp;<span class="ident" id="4061900">syscall</span><span class="op" id="4061907">.</span><span class="ident" id="4061908">EINVAL</span><span class="op" id="4061914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4061918">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4061970">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062023">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062077">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062131">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062180">if</span>&nbsp;<span class="ident" id="4062183">runtime</span><span class="op" id="4062190">.</span><span class="ident" id="4062191">GOOS</span>&nbsp;<span class="op" id="4062196">==</span>&nbsp;<span class="string" id="4062199">&#34;solaris&#34;</span>&nbsp;<span class="op" id="4062209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062214">return</span>&nbsp;<span class="ident" id="4062221">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062231">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062244">default</span><span class="op" id="4062251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062255">return</span>&nbsp;<span class="ident" id="4062262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062270">if</span>&nbsp;<span class="ident" id="4062273">err</span>&nbsp;<span class="op" id="4062277">:=</span>&nbsp;<span class="ident" id="4062280">fd</span><span class="op" id="4062282">.</span><span class="ident" id="4062283">init</span><span class="op" id="4062287">(</span><span class="op" id="4062288">)</span><span class="op" id="4062289">;</span>&nbsp;<span class="ident" id="4062291">err</span>&nbsp;<span class="op" id="4062295">!=</span>&nbsp;<span class="ident" id="4062298">nil</span>&nbsp;<span class="op" id="4062302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062306">return</span>&nbsp;<span class="ident" id="4062313">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062321">if</span>&nbsp;<span class="op" id="4062324">!</span><span class="ident" id="4062325">deadline</span><span class="op" id="4062333">.</span><span class="ident" id="4062334">IsZero</span><span class="op" id="4062340">(</span><span class="op" id="4062341">)</span>&nbsp;<span class="op" id="4062343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062347">fd</span><span class="op" id="4062349">.</span><span class="ident" id="4062350">setWriteDeadline</span><span class="op" id="4062366">(</span><span class="ident" id="4062367">deadline</span><span class="op" id="4062375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062379">defer</span>&nbsp;<span class="ident" id="4062385">fd</span><span class="op" id="4062387">.</span><span class="ident" id="4062388">setWriteDeadline</span><span class="op" id="4062404">(</span><span class="ident" id="4062405">noDeadline</span><span class="op" id="4062415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062418">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062421">for</span>&nbsp;<span class="op" id="4062425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062429">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062480">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062534">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062582">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062638">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062693">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062746">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062799">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062813">if</span>&nbsp;<span class="ident" id="4062816">err</span>&nbsp;<span class="op" id="4062820">:=</span>&nbsp;<span class="ident" id="4062823">fd</span><span class="op" id="4062825">.</span><span class="ident" id="4062826">pd</span><span class="op" id="4062828">.</span><span class="ident" id="4062829">WaitWrite</span><span class="op" id="4062838">(</span><span class="op" id="4062839">)</span><span class="op" id="4062840">;</span>&nbsp;<span class="ident" id="4062842">err</span>&nbsp;<span class="op" id="4062846">!=</span>&nbsp;<span class="ident" id="4062849">nil</span>&nbsp;<span class="op" id="4062853">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062858">return</span>&nbsp;<span class="ident" id="4062865">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062875">nerr</span><span class="op" id="4062879">,</span>&nbsp;<span class="ident" id="4062881">err</span>&nbsp;<span class="op" id="4062885">:=</span>&nbsp;<span class="ident" id="4062888">syscall</span><span class="op" id="4062895">.</span><span class="ident" id="4062896">GetsockoptInt</span><span class="op" id="4062909">(</span><span class="ident" id="4062910">fd</span><span class="op" id="4062912">.</span><span class="ident" id="4062913">sysfd</span><span class="op" id="4062918">,</span>&nbsp;<span class="ident" id="4062920">syscall</span><span class="op" id="4062927">.</span><span class="ident" id="4062928">SOL_SOCKET</span><span class="op" id="4062938">,</span>&nbsp;<span class="ident" id="4062940">syscall</span><span class="op" id="4062947">.</span><span class="ident" id="4062948">SO_ERROR</span><span class="op" id="4062956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062960">if</span>&nbsp;<span class="ident" id="4062963">err</span>&nbsp;<span class="op" id="4062967">!=</span>&nbsp;<span class="ident" id="4062970">nil</span>&nbsp;<span class="op" id="4062974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062979">return</span>&nbsp;<span class="ident" id="4062986">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062996">switch</span>&nbsp;<span class="ident" id="4063003">err</span>&nbsp;<span class="op" id="4063007">:=</span>&nbsp;<span class="ident" id="4063010">syscall</span><span class="op" id="4063017">.</span><span class="ident" id="4063018">Errno</span><span class="op" id="4063023">(</span><span class="ident" id="4063024">nerr</span><span class="op" id="4063028">)</span><span class="op" id="4063029">;</span>&nbsp;<span class="ident" id="4063031">err</span>&nbsp;<span class="op" id="4063035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063039">case</span>&nbsp;<span class="ident" id="4063044">syscall</span><span class="op" id="4063051">.</span><span class="ident" id="4063052">EINPROGRESS</span><span class="op" id="4063063">,</span>&nbsp;<span class="ident" id="4063065">syscall</span><span class="op" id="4063072">.</span><span class="ident" id="4063073">EALREADY</span><span class="op" id="4063081">,</span>&nbsp;<span class="ident" id="4063083">syscall</span><span class="op" id="4063090">.</span><span class="ident" id="4063091">EINTR</span><span class="op" id="4063096">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063100">case</span>&nbsp;<span class="ident" id="4063105">syscall</span><span class="op" id="4063112">.</span><span class="ident" id="4063113">Errno</span><span class="op" id="4063118">(</span><span class="num" id="4063119">0</span><span class="op" id="4063120">)</span><span class="op" id="4063121">,</span>&nbsp;<span class="ident" id="4063123">syscall</span><span class="op" id="4063130">.</span><span class="ident" id="4063131">EISCONN</span><span class="op" id="4063138">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063143">return</span>&nbsp;<span class="ident" id="4063150">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063156">default</span><span class="op" id="4063163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063168">return</span>&nbsp;<span class="ident" id="4063175">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063184">}</span><br>
<span class="lineno"></span><span class="op" id="4063186">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="4063189">func</span>&nbsp;<span class="op" id="4063194">(</span><span class="ident" id="4063195">fd</span>&nbsp;<span class="op" id="4063198">*</span><span class="ident" id="4063199">netFD</span><span class="op" id="4063204">)</span>&nbsp;<span class="ident" id="4063206">destroy</span><span class="op" id="4063213">(</span><span class="op" id="4063214">)</span>&nbsp;<span class="op" id="4063216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063219">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063293">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063342">fd</span><span class="op" id="4063344">.</span><span class="ident" id="4063345">pd</span><span class="op" id="4063347">.</span><span class="ident" id="4063348">Close</span><span class="op" id="4063353">(</span><span class="op" id="4063354">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063357">closesocket</span><span class="op" id="4063368">(</span><span class="ident" id="4063369">fd</span><span class="op" id="4063371">.</span><span class="ident" id="4063372">sysfd</span><span class="op" id="4063377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063380">fd</span><span class="op" id="4063382">.</span><span class="ident" id="4063383">sysfd</span>&nbsp;<span class="op" id="4063389">=</span>&nbsp;<span class="op" id="4063391">-</span><span class="num" id="4063392">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063395">runtime</span><span class="op" id="4063402">.</span><span class="ident" id="4063403">SetFinalizer</span><span class="op" id="4063415">(</span><span class="ident" id="4063416">fd</span><span class="op" id="4063418">,</span>&nbsp;<span class="ident" id="4063420">nil</span><span class="op" id="4063423">)</span><br>
<span class="lineno"></span><span class="op" id="4063425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4063428">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="4063459">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4063505">func</span>&nbsp;<span class="op" id="4063510">(</span><span class="ident" id="4063511">fd</span>&nbsp;<span class="op" id="4063514">*</span><span class="ident" id="4063515">netFD</span><span class="op" id="4063520">)</span>&nbsp;<span class="ident" id="4063522">incref</span><span class="op" id="4063528">(</span><span class="op" id="4063529">)</span>&nbsp;<span class="builtintype" id="4063531">error</span>&nbsp;<span class="op" id="4063537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063540">if</span>&nbsp;<span class="op" id="4063543">!</span><span class="ident" id="4063544">fd</span><span class="op" id="4063546">.</span><span class="ident" id="4063547">fdmu</span><span class="op" id="4063551">.</span><span class="ident" id="4063552">Incref</span><span class="op" id="4063558">(</span><span class="op" id="4063559">)</span>&nbsp;<span class="op" id="4063561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063565">return</span>&nbsp;<span class="ident" id="4063572">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063587">return</span>&nbsp;<span class="ident" id="4063594">nil</span><br>
<span class="lineno"></span><span class="op" id="4063598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4063601">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="4063673">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="4063712">func</span>&nbsp;<span class="op" id="4063717">(</span><span class="ident" id="4063718">fd</span>&nbsp;<span class="op" id="4063721">*</span><span class="ident" id="4063722">netFD</span><span class="op" id="4063727">)</span>&nbsp;<span class="ident" id="4063729">decref</span><span class="op" id="4063735">(</span><span class="op" id="4063736">)</span>&nbsp;<span class="op" id="4063738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063741">if</span>&nbsp;<span class="ident" id="4063744">fd</span><span class="op" id="4063746">.</span><span class="ident" id="4063747">fdmu</span><span class="op" id="4063751">.</span><span class="ident" id="4063752">Decref</span><span class="op" id="4063758">(</span><span class="op" id="4063759">)</span>&nbsp;<span class="op" id="4063761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063765">fd</span><span class="op" id="4063767">.</span><span class="ident" id="4063768">destroy</span><span class="op" id="4063775">(</span><span class="op" id="4063776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063779">}</span><br>
<span class="lineno">155</span><span class="op" id="4063781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4063784">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="4063836">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4063882">func</span>&nbsp;<span class="op" id="4063887">(</span><span class="ident" id="4063888">fd</span>&nbsp;<span class="op" id="4063891">*</span><span class="ident" id="4063892">netFD</span><span class="op" id="4063897">)</span>&nbsp;<span class="ident" id="4063899">readLock</span><span class="op" id="4063907">(</span><span class="op" id="4063908">)</span>&nbsp;<span class="builtintype" id="4063910">error</span>&nbsp;<span class="op" id="4063916">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063919">if</span>&nbsp;<span class="op" id="4063922">!</span><span class="ident" id="4063923">fd</span><span class="op" id="4063925">.</span><span class="ident" id="4063926">fdmu</span><span class="op" id="4063930">.</span><span class="ident" id="4063931">RWLock</span><span class="op" id="4063937">(</span><span class="builtintype" id="4063938">true</span><span class="op" id="4063942">)</span>&nbsp;<span class="op" id="4063944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063948">return</span>&nbsp;<span class="ident" id="4063955">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063970">return</span>&nbsp;<span class="ident" id="4063977">nil</span><br>
<span class="lineno"></span><span class="op" id="4063981">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="4063984">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="4064041">func</span>&nbsp;<span class="op" id="4064046">(</span><span class="ident" id="4064047">fd</span>&nbsp;<span class="op" id="4064050">*</span><span class="ident" id="4064051">netFD</span><span class="op" id="4064056">)</span>&nbsp;<span class="ident" id="4064058">readUnlock</span><span class="op" id="4064068">(</span><span class="op" id="4064069">)</span>&nbsp;<span class="op" id="4064071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064074">if</span>&nbsp;<span class="ident" id="4064077">fd</span><span class="op" id="4064079">.</span><span class="ident" id="4064080">fdmu</span><span class="op" id="4064084">.</span><span class="ident" id="4064085">RWUnlock</span><span class="op" id="4064093">(</span><span class="builtintype" id="4064094">true</span><span class="op" id="4064098">)</span>&nbsp;<span class="op" id="4064100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064104">fd</span><span class="op" id="4064106">.</span><span class="ident" id="4064107">destroy</span><span class="op" id="4064114">(</span><span class="op" id="4064115">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064118">}</span><br>
<span class="lineno"></span><span class="op" id="4064120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4064123">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="4064175">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="4064221">func</span>&nbsp;<span class="op" id="4064226">(</span><span class="ident" id="4064227">fd</span>&nbsp;<span class="op" id="4064230">*</span><span class="ident" id="4064231">netFD</span><span class="op" id="4064236">)</span>&nbsp;<span class="ident" id="4064238">writeLock</span><span class="op" id="4064247">(</span><span class="op" id="4064248">)</span>&nbsp;<span class="builtintype" id="4064250">error</span>&nbsp;<span class="op" id="4064256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064259">if</span>&nbsp;<span class="op" id="4064262">!</span><span class="ident" id="4064263">fd</span><span class="op" id="4064265">.</span><span class="ident" id="4064266">fdmu</span><span class="op" id="4064270">.</span><span class="ident" id="4064271">RWLock</span><span class="op" id="4064277">(</span><span class="builtintype" id="4064278">false</span><span class="op" id="4064283">)</span>&nbsp;<span class="op" id="4064285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064289">return</span>&nbsp;<span class="ident" id="4064296">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064311">return</span>&nbsp;<span class="ident" id="4064318">nil</span><br>
<span class="lineno">180</span><span class="op" id="4064322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4064325">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="4064382">func</span>&nbsp;<span class="op" id="4064387">(</span><span class="ident" id="4064388">fd</span>&nbsp;<span class="op" id="4064391">*</span><span class="ident" id="4064392">netFD</span><span class="op" id="4064397">)</span>&nbsp;<span class="ident" id="4064399">writeUnlock</span><span class="op" id="4064410">(</span><span class="op" id="4064411">)</span>&nbsp;<span class="op" id="4064413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064416">if</span>&nbsp;<span class="ident" id="4064419">fd</span><span class="op" id="4064421">.</span><span class="ident" id="4064422">fdmu</span><span class="op" id="4064426">.</span><span class="ident" id="4064427">RWUnlock</span><span class="op" id="4064435">(</span><span class="builtintype" id="4064436">false</span><span class="op" id="4064441">)</span>&nbsp;<span class="op" id="4064443">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064447">fd</span><span class="op" id="4064449">.</span><span class="ident" id="4064450">destroy</span><span class="op" id="4064457">(</span><span class="op" id="4064458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064461">}</span><br>
<span class="lineno"></span><span class="op" id="4064463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4064466">func</span>&nbsp;<span class="op" id="4064471">(</span><span class="ident" id="4064472">fd</span>&nbsp;<span class="op" id="4064475">*</span><span class="ident" id="4064476">netFD</span><span class="op" id="4064481">)</span>&nbsp;<span class="ident" id="4064483">Close</span><span class="op" id="4064488">(</span><span class="op" id="4064489">)</span>&nbsp;<span class="builtintype" id="4064491">error</span>&nbsp;<span class="op" id="4064497">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064500">fd</span><span class="op" id="4064502">.</span><span class="ident" id="4064503">pd</span><span class="op" id="4064505">.</span><span class="ident" id="4064506">Lock</span><span class="op" id="4064510">(</span><span class="op" id="4064511">)</span>&nbsp;<span class="comment" id="4064513">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064568">if</span>&nbsp;<span class="op" id="4064571">!</span><span class="ident" id="4064572">fd</span><span class="op" id="4064574">.</span><span class="ident" id="4064575">fdmu</span><span class="op" id="4064579">.</span><span class="ident" id="4064580">IncrefAndClose</span><span class="op" id="4064594">(</span><span class="op" id="4064595">)</span>&nbsp;<span class="op" id="4064597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064601">fd</span><span class="op" id="4064603">.</span><span class="ident" id="4064604">pd</span><span class="op" id="4064606">.</span><span class="ident" id="4064607">Unlock</span><span class="op" id="4064613">(</span><span class="op" id="4064614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064618">return</span>&nbsp;<span class="ident" id="4064625">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064637">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064640">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064696">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064752">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064814">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064877">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064939">doWakeup</span>&nbsp;<span class="op" id="4064948">:=</span>&nbsp;<span class="ident" id="4064951">fd</span><span class="op" id="4064953">.</span><span class="ident" id="4064954">pd</span><span class="op" id="4064956">.</span><span class="ident" id="4064957">Evict</span><span class="op" id="4064962">(</span><span class="op" id="4064963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064966">fd</span><span class="op" id="4064968">.</span><span class="ident" id="4064969">pd</span><span class="op" id="4064971">.</span><span class="ident" id="4064972">Unlock</span><span class="op" id="4064978">(</span><span class="op" id="4064979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064982">fd</span><span class="op" id="4064984">.</span><span class="ident" id="4064985">decref</span><span class="op" id="4064991">(</span><span class="op" id="4064992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064995">if</span>&nbsp;<span class="ident" id="4064998">doWakeup</span>&nbsp;<span class="op" id="4065007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065011">fd</span><span class="op" id="4065013">.</span><span class="ident" id="4065014">pd</span><span class="op" id="4065016">.</span><span class="ident" id="4065017">Wakeup</span><span class="op" id="4065023">(</span><span class="op" id="4065024">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065030">return</span>&nbsp;<span class="ident" id="4065037">nil</span><br>
<span class="lineno"></span><span class="op" id="4065041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4065044">func</span>&nbsp;<span class="op" id="4065049">(</span><span class="ident" id="4065050">fd</span>&nbsp;<span class="op" id="4065053">*</span><span class="ident" id="4065054">netFD</span><span class="op" id="4065059">)</span>&nbsp;<span class="ident" id="4065061">shutdown</span><span class="op" id="4065069">(</span><span class="ident" id="4065070">how</span>&nbsp;<span class="builtintype" id="4065074">int</span><span class="op" id="4065077">)</span>&nbsp;<span class="builtintype" id="4065079">error</span>&nbsp;<span class="op" id="4065085">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065088">if</span>&nbsp;<span class="ident" id="4065091">err</span>&nbsp;<span class="op" id="4065095">:=</span>&nbsp;<span class="ident" id="4065098">fd</span><span class="op" id="4065100">.</span><span class="ident" id="4065101">incref</span><span class="op" id="4065107">(</span><span class="op" id="4065108">)</span><span class="op" id="4065109">;</span>&nbsp;<span class="ident" id="4065111">err</span>&nbsp;<span class="op" id="4065115">!=</span>&nbsp;<span class="ident" id="4065118">nil</span>&nbsp;<span class="op" id="4065122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065126">return</span>&nbsp;<span class="ident" id="4065133">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065141">defer</span>&nbsp;<span class="ident" id="4065147">fd</span><span class="op" id="4065149">.</span><span class="ident" id="4065150">decref</span><span class="op" id="4065156">(</span><span class="op" id="4065157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065160">err</span>&nbsp;<span class="op" id="4065164">:=</span>&nbsp;<span class="ident" id="4065167">syscall</span><span class="op" id="4065174">.</span><span class="ident" id="4065175">Shutdown</span><span class="op" id="4065183">(</span><span class="ident" id="4065184">fd</span><span class="op" id="4065186">.</span><span class="ident" id="4065187">sysfd</span><span class="op" id="4065192">,</span>&nbsp;<span class="ident" id="4065194">how</span><span class="op" id="4065197">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065200">if</span>&nbsp;<span class="ident" id="4065203">err</span>&nbsp;<span class="op" id="4065207">!=</span>&nbsp;<span class="ident" id="4065210">nil</span>&nbsp;<span class="op" id="4065214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065218">return</span>&nbsp;<span class="op" id="4065225">&amp;</span><span class="ident" id="4065226">OpError</span><span class="op" id="4065233">{</span><span class="string" id="4065234">&#34;shutdown&#34;</span><span class="op" id="4065244">,</span>&nbsp;<span class="ident" id="4065246">fd</span><span class="op" id="4065248">.</span><span class="ident" id="4065249">net</span><span class="op" id="4065252">,</span>&nbsp;<span class="ident" id="4065254">fd</span><span class="op" id="4065256">.</span><span class="ident" id="4065257">laddr</span><span class="op" id="4065262">,</span>&nbsp;<span class="ident" id="4065264">err</span><span class="op" id="4065267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065273">return</span>&nbsp;<span class="ident" id="4065280">nil</span><br>
<span class="lineno"></span><span class="op" id="4065284">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="4065287">func</span>&nbsp;<span class="op" id="4065292">(</span><span class="ident" id="4065293">fd</span>&nbsp;<span class="op" id="4065296">*</span><span class="ident" id="4065297">netFD</span><span class="op" id="4065302">)</span>&nbsp;<span class="ident" id="4065304">closeRead</span><span class="op" id="4065313">(</span><span class="op" id="4065314">)</span>&nbsp;<span class="builtintype" id="4065316">error</span>&nbsp;<span class="op" id="4065322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065325">return</span>&nbsp;<span class="ident" id="4065332">fd</span><span class="op" id="4065334">.</span><span class="ident" id="4065335">shutdown</span><span class="op" id="4065343">(</span><span class="ident" id="4065344">syscall</span><span class="op" id="4065351">.</span><span class="ident" id="4065352">SHUT_RD</span><span class="op" id="4065359">)</span><br>
<span class="lineno"></span><span class="op" id="4065361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="4065364">func</span>&nbsp;<span class="op" id="4065369">(</span><span class="ident" id="4065370">fd</span>&nbsp;<span class="op" id="4065373">*</span><span class="ident" id="4065374">netFD</span><span class="op" id="4065379">)</span>&nbsp;<span class="ident" id="4065381">closeWrite</span><span class="op" id="4065391">(</span><span class="op" id="4065392">)</span>&nbsp;<span class="builtintype" id="4065394">error</span>&nbsp;<span class="op" id="4065400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065403">return</span>&nbsp;<span class="ident" id="4065410">fd</span><span class="op" id="4065412">.</span><span class="ident" id="4065413">shutdown</span><span class="op" id="4065421">(</span><span class="ident" id="4065422">syscall</span><span class="op" id="4065429">.</span><span class="ident" id="4065430">SHUT_WR</span><span class="op" id="4065437">)</span><br>
<span class="lineno"></span><span class="op" id="4065439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4065442">func</span>&nbsp;<span class="op" id="4065447">(</span><span class="ident" id="4065448">fd</span>&nbsp;<span class="op" id="4065451">*</span><span class="ident" id="4065452">netFD</span><span class="op" id="4065457">)</span>&nbsp;<span class="ident" id="4065459">Read</span><span class="op" id="4065463">(</span><span class="ident" id="4065464">p</span>&nbsp;<span class="op" id="4065466">[</span><span class="op" id="4065467">]</span><span class="builtintype" id="4065468">byte</span><span class="op" id="4065472">)</span>&nbsp;<span class="op" id="4065474">(</span><span class="ident" id="4065475">n</span>&nbsp;<span class="builtintype" id="4065477">int</span><span class="op" id="4065480">,</span>&nbsp;<span class="ident" id="4065482">err</span>&nbsp;<span class="builtintype" id="4065486">error</span><span class="op" id="4065491">)</span>&nbsp;<span class="op" id="4065493">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065496">if</span>&nbsp;<span class="ident" id="4065499">err</span>&nbsp;<span class="op" id="4065503">:=</span>&nbsp;<span class="ident" id="4065506">fd</span><span class="op" id="4065508">.</span><span class="ident" id="4065509">readLock</span><span class="op" id="4065517">(</span><span class="op" id="4065518">)</span><span class="op" id="4065519">;</span>&nbsp;<span class="ident" id="4065521">err</span>&nbsp;<span class="op" id="4065525">!=</span>&nbsp;<span class="ident" id="4065528">nil</span>&nbsp;<span class="op" id="4065532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065536">return</span>&nbsp;<span class="num" id="4065543">0</span><span class="op" id="4065544">,</span>&nbsp;<span class="ident" id="4065546">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065554">defer</span>&nbsp;<span class="ident" id="4065560">fd</span><span class="op" id="4065562">.</span><span class="ident" id="4065563">readUnlock</span><span class="op" id="4065573">(</span><span class="op" id="4065574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065577">if</span>&nbsp;<span class="ident" id="4065580">err</span>&nbsp;<span class="op" id="4065584">:=</span>&nbsp;<span class="ident" id="4065587">fd</span><span class="op" id="4065589">.</span><span class="ident" id="4065590">pd</span><span class="op" id="4065592">.</span><span class="ident" id="4065593">PrepareRead</span><span class="op" id="4065604">(</span><span class="op" id="4065605">)</span><span class="op" id="4065606">;</span>&nbsp;<span class="ident" id="4065608">err</span>&nbsp;<span class="op" id="4065612">!=</span>&nbsp;<span class="ident" id="4065615">nil</span>&nbsp;<span class="op" id="4065619">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065623">return</span>&nbsp;<span class="num" id="4065630">0</span><span class="op" id="4065631">,</span>&nbsp;<span class="op" id="4065633">&amp;</span><span class="ident" id="4065634">OpError</span><span class="op" id="4065641">{</span><span class="string" id="4065642">&#34;read&#34;</span><span class="op" id="4065648">,</span>&nbsp;<span class="ident" id="4065650">fd</span><span class="op" id="4065652">.</span><span class="ident" id="4065653">net</span><span class="op" id="4065656">,</span>&nbsp;<span class="ident" id="4065658">fd</span><span class="op" id="4065660">.</span><span class="ident" id="4065661">raddr</span><span class="op" id="4065666">,</span>&nbsp;<span class="ident" id="4065668">err</span><span class="op" id="4065671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065677">for</span>&nbsp;<span class="op" id="4065681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065685">n</span><span class="op" id="4065686">,</span>&nbsp;<span class="ident" id="4065688">err</span>&nbsp;<span class="op" id="4065692">=</span>&nbsp;<span class="ident" id="4065694">syscall</span><span class="op" id="4065701">.</span><span class="ident" id="4065702">Read</span><span class="op" id="4065706">(</span><span class="builtintype" id="4065707">int</span><span class="op" id="4065710">(</span><span class="ident" id="4065711">fd</span><span class="op" id="4065713">.</span><span class="ident" id="4065714">sysfd</span><span class="op" id="4065719">)</span><span class="op" id="4065720">,</span>&nbsp;<span class="ident" id="4065722">p</span><span class="op" id="4065723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065727">if</span>&nbsp;<span class="ident" id="4065730">err</span>&nbsp;<span class="op" id="4065734">!=</span>&nbsp;<span class="ident" id="4065737">nil</span>&nbsp;<span class="op" id="4065741">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065746">n</span>&nbsp;<span class="op" id="4065748">=</span>&nbsp;<span class="num" id="4065750">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065755">if</span>&nbsp;<span class="ident" id="4065758">err</span>&nbsp;<span class="op" id="4065762">==</span>&nbsp;<span class="ident" id="4065765">syscall</span><span class="op" id="4065772">.</span><span class="ident" id="4065773">EAGAIN</span>&nbsp;<span class="op" id="4065780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065786">if</span>&nbsp;<span class="ident" id="4065789">err</span>&nbsp;<span class="op" id="4065793">=</span>&nbsp;<span class="ident" id="4065795">fd</span><span class="op" id="4065797">.</span><span class="ident" id="4065798">pd</span><span class="op" id="4065800">.</span><span class="ident" id="4065801">WaitRead</span><span class="op" id="4065809">(</span><span class="op" id="4065810">)</span><span class="op" id="4065811">;</span>&nbsp;<span class="ident" id="4065813">err</span>&nbsp;<span class="op" id="4065817">==</span>&nbsp;<span class="ident" id="4065820">nil</span>&nbsp;<span class="op" id="4065824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065831">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065844">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065857">err</span>&nbsp;<span class="op" id="4065861">=</span>&nbsp;<span class="ident" id="4065863">chkReadErr</span><span class="op" id="4065873">(</span><span class="ident" id="4065874">n</span><span class="op" id="4065875">,</span>&nbsp;<span class="ident" id="4065877">err</span><span class="op" id="4065880">,</span>&nbsp;<span class="ident" id="4065882">fd</span><span class="op" id="4065884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065888">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065895">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065898">if</span>&nbsp;<span class="ident" id="4065901">err</span>&nbsp;<span class="op" id="4065905">!=</span>&nbsp;<span class="ident" id="4065908">nil</span>&nbsp;<span class="op" id="4065912">&amp;&amp;</span>&nbsp;<span class="ident" id="4065915">err</span>&nbsp;<span class="op" id="4065919">!=</span>&nbsp;<span class="ident" id="4065922">io</span><span class="op" id="4065924">.</span><span class="ident" id="4065925">EOF</span>&nbsp;<span class="op" id="4065929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065933">err</span>&nbsp;<span class="op" id="4065937">=</span>&nbsp;<span class="op" id="4065939">&amp;</span><span class="ident" id="4065940">OpError</span><span class="op" id="4065947">{</span><span class="string" id="4065948">&#34;read&#34;</span><span class="op" id="4065954">,</span>&nbsp;<span class="ident" id="4065956">fd</span><span class="op" id="4065958">.</span><span class="ident" id="4065959">net</span><span class="op" id="4065962">,</span>&nbsp;<span class="ident" id="4065964">fd</span><span class="op" id="4065966">.</span><span class="ident" id="4065967">raddr</span><span class="op" id="4065972">,</span>&nbsp;<span class="ident" id="4065974">err</span><span class="op" id="4065977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065983">return</span><br>
<span class="lineno"></span><span class="op" id="4065990">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="4065993">func</span>&nbsp;<span class="op" id="4065998">(</span><span class="ident" id="4065999">fd</span>&nbsp;<span class="op" id="4066002">*</span><span class="ident" id="4066003">netFD</span><span class="op" id="4066008">)</span>&nbsp;<span class="ident" id="4066010">readFrom</span><span class="op" id="4066018">(</span><span class="ident" id="4066019">p</span>&nbsp;<span class="op" id="4066021">[</span><span class="op" id="4066022">]</span><span class="builtintype" id="4066023">byte</span><span class="op" id="4066027">)</span>&nbsp;<span class="op" id="4066029">(</span><span class="ident" id="4066030">n</span>&nbsp;<span class="builtintype" id="4066032">int</span><span class="op" id="4066035">,</span>&nbsp;<span class="ident" id="4066037">sa</span>&nbsp;<span class="ident" id="4066040">syscall</span><span class="op" id="4066047">.</span><span class="ident" id="4066048">Sockaddr</span><span class="op" id="4066056">,</span>&nbsp;<span class="ident" id="4066058">err</span>&nbsp;<span class="builtintype" id="4066062">error</span><span class="op" id="4066067">)</span>&nbsp;<span class="op" id="4066069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066072">if</span>&nbsp;<span class="ident" id="4066075">err</span>&nbsp;<span class="op" id="4066079">:=</span>&nbsp;<span class="ident" id="4066082">fd</span><span class="op" id="4066084">.</span><span class="ident" id="4066085">readLock</span><span class="op" id="4066093">(</span><span class="op" id="4066094">)</span><span class="op" id="4066095">;</span>&nbsp;<span class="ident" id="4066097">err</span>&nbsp;<span class="op" id="4066101">!=</span>&nbsp;<span class="ident" id="4066104">nil</span>&nbsp;<span class="op" id="4066108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066112">return</span>&nbsp;<span class="num" id="4066119">0</span><span class="op" id="4066120">,</span>&nbsp;<span class="ident" id="4066122">nil</span><span class="op" id="4066125">,</span>&nbsp;<span class="ident" id="4066127">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066132">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066135">defer</span>&nbsp;<span class="ident" id="4066141">fd</span><span class="op" id="4066143">.</span><span class="ident" id="4066144">readUnlock</span><span class="op" id="4066154">(</span><span class="op" id="4066155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066158">if</span>&nbsp;<span class="ident" id="4066161">err</span>&nbsp;<span class="op" id="4066165">:=</span>&nbsp;<span class="ident" id="4066168">fd</span><span class="op" id="4066170">.</span><span class="ident" id="4066171">pd</span><span class="op" id="4066173">.</span><span class="ident" id="4066174">PrepareRead</span><span class="op" id="4066185">(</span><span class="op" id="4066186">)</span><span class="op" id="4066187">;</span>&nbsp;<span class="ident" id="4066189">err</span>&nbsp;<span class="op" id="4066193">!=</span>&nbsp;<span class="ident" id="4066196">nil</span>&nbsp;<span class="op" id="4066200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066204">return</span>&nbsp;<span class="num" id="4066211">0</span><span class="op" id="4066212">,</span>&nbsp;<span class="ident" id="4066214">nil</span><span class="op" id="4066217">,</span>&nbsp;<span class="op" id="4066219">&amp;</span><span class="ident" id="4066220">OpError</span><span class="op" id="4066227">{</span><span class="string" id="4066228">&#34;read&#34;</span><span class="op" id="4066234">,</span>&nbsp;<span class="ident" id="4066236">fd</span><span class="op" id="4066238">.</span><span class="ident" id="4066239">net</span><span class="op" id="4066242">,</span>&nbsp;<span class="ident" id="4066244">fd</span><span class="op" id="4066246">.</span><span class="ident" id="4066247">laddr</span><span class="op" id="4066252">,</span>&nbsp;<span class="ident" id="4066254">err</span><span class="op" id="4066257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066263">for</span>&nbsp;<span class="op" id="4066267">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066271">n</span><span class="op" id="4066272">,</span>&nbsp;<span class="ident" id="4066274">sa</span><span class="op" id="4066276">,</span>&nbsp;<span class="ident" id="4066278">err</span>&nbsp;<span class="op" id="4066282">=</span>&nbsp;<span class="ident" id="4066284">syscall</span><span class="op" id="4066291">.</span><span class="ident" id="4066292">Recvfrom</span><span class="op" id="4066300">(</span><span class="ident" id="4066301">fd</span><span class="op" id="4066303">.</span><span class="ident" id="4066304">sysfd</span><span class="op" id="4066309">,</span>&nbsp;<span class="ident" id="4066311">p</span><span class="op" id="4066312">,</span>&nbsp;<span class="num" id="4066314">0</span><span class="op" id="4066315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066319">if</span>&nbsp;<span class="ident" id="4066322">err</span>&nbsp;<span class="op" id="4066326">!=</span>&nbsp;<span class="ident" id="4066329">nil</span>&nbsp;<span class="op" id="4066333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066338">n</span>&nbsp;<span class="op" id="4066340">=</span>&nbsp;<span class="num" id="4066342">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066347">if</span>&nbsp;<span class="ident" id="4066350">err</span>&nbsp;<span class="op" id="4066354">==</span>&nbsp;<span class="ident" id="4066357">syscall</span><span class="op" id="4066364">.</span><span class="ident" id="4066365">EAGAIN</span>&nbsp;<span class="op" id="4066372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066378">if</span>&nbsp;<span class="ident" id="4066381">err</span>&nbsp;<span class="op" id="4066385">=</span>&nbsp;<span class="ident" id="4066387">fd</span><span class="op" id="4066389">.</span><span class="ident" id="4066390">pd</span><span class="op" id="4066392">.</span><span class="ident" id="4066393">WaitRead</span><span class="op" id="4066401">(</span><span class="op" id="4066402">)</span><span class="op" id="4066403">;</span>&nbsp;<span class="ident" id="4066405">err</span>&nbsp;<span class="op" id="4066409">==</span>&nbsp;<span class="ident" id="4066412">nil</span>&nbsp;<span class="op" id="4066416">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066423">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066449">err</span>&nbsp;<span class="op" id="4066453">=</span>&nbsp;<span class="ident" id="4066455">chkReadErr</span><span class="op" id="4066465">(</span><span class="ident" id="4066466">n</span><span class="op" id="4066467">,</span>&nbsp;<span class="ident" id="4066469">err</span><span class="op" id="4066472">,</span>&nbsp;<span class="ident" id="4066474">fd</span><span class="op" id="4066476">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066480">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066490">if</span>&nbsp;<span class="ident" id="4066493">err</span>&nbsp;<span class="op" id="4066497">!=</span>&nbsp;<span class="ident" id="4066500">nil</span>&nbsp;<span class="op" id="4066504">&amp;&amp;</span>&nbsp;<span class="ident" id="4066507">err</span>&nbsp;<span class="op" id="4066511">!=</span>&nbsp;<span class="ident" id="4066514">io</span><span class="op" id="4066516">.</span><span class="ident" id="4066517">EOF</span>&nbsp;<span class="op" id="4066521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066525">err</span>&nbsp;<span class="op" id="4066529">=</span>&nbsp;<span class="op" id="4066531">&amp;</span><span class="ident" id="4066532">OpError</span><span class="op" id="4066539">{</span><span class="string" id="4066540">&#34;read&#34;</span><span class="op" id="4066546">,</span>&nbsp;<span class="ident" id="4066548">fd</span><span class="op" id="4066550">.</span><span class="ident" id="4066551">net</span><span class="op" id="4066554">,</span>&nbsp;<span class="ident" id="4066556">fd</span><span class="op" id="4066558">.</span><span class="ident" id="4066559">laddr</span><span class="op" id="4066564">,</span>&nbsp;<span class="ident" id="4066566">err</span><span class="op" id="4066569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066572">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066575">return</span><br>
<span class="lineno"></span><span class="op" id="4066582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4066585">func</span>&nbsp;<span class="op" id="4066590">(</span><span class="ident" id="4066591">fd</span>&nbsp;<span class="op" id="4066594">*</span><span class="ident" id="4066595">netFD</span><span class="op" id="4066600">)</span>&nbsp;<span class="ident" id="4066602">readMsg</span><span class="op" id="4066609">(</span><span class="ident" id="4066610">p</span>&nbsp;<span class="op" id="4066612">[</span><span class="op" id="4066613">]</span><span class="builtintype" id="4066614">byte</span><span class="op" id="4066618">,</span>&nbsp;<span class="ident" id="4066620">oob</span>&nbsp;<span class="op" id="4066624">[</span><span class="op" id="4066625">]</span><span class="builtintype" id="4066626">byte</span><span class="op" id="4066630">)</span>&nbsp;<span class="op" id="4066632">(</span><span class="ident" id="4066633">n</span><span class="op" id="4066634">,</span>&nbsp;<span class="ident" id="4066636">oobn</span><span class="op" id="4066640">,</span>&nbsp;<span class="ident" id="4066642">flags</span>&nbsp;<span class="builtintype" id="4066648">int</span><span class="op" id="4066651">,</span>&nbsp;<span class="ident" id="4066653">sa</span>&nbsp;<span class="ident" id="4066656">syscall</span><span class="op" id="4066663">.</span><span class="ident" id="4066664">Sockaddr</span><span class="op" id="4066672">,</span>&nbsp;<span class="ident" id="4066674">err</span>&nbsp;<span class="builtintype" id="4066678">error</span><span class="op" id="4066683">)</span>&nbsp;<span class="op" id="4066685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066688">if</span>&nbsp;<span class="ident" id="4066691">err</span>&nbsp;<span class="op" id="4066695">:=</span>&nbsp;<span class="ident" id="4066698">fd</span><span class="op" id="4066700">.</span><span class="ident" id="4066701">readLock</span><span class="op" id="4066709">(</span><span class="op" id="4066710">)</span><span class="op" id="4066711">;</span>&nbsp;<span class="ident" id="4066713">err</span>&nbsp;<span class="op" id="4066717">!=</span>&nbsp;<span class="ident" id="4066720">nil</span>&nbsp;<span class="op" id="4066724">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066728">return</span>&nbsp;<span class="num" id="4066735">0</span><span class="op" id="4066736">,</span>&nbsp;<span class="num" id="4066738">0</span><span class="op" id="4066739">,</span>&nbsp;<span class="num" id="4066741">0</span><span class="op" id="4066742">,</span>&nbsp;<span class="ident" id="4066744">nil</span><span class="op" id="4066747">,</span>&nbsp;<span class="ident" id="4066749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066757">defer</span>&nbsp;<span class="ident" id="4066763">fd</span><span class="op" id="4066765">.</span><span class="ident" id="4066766">readUnlock</span><span class="op" id="4066776">(</span><span class="op" id="4066777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066780">if</span>&nbsp;<span class="ident" id="4066783">err</span>&nbsp;<span class="op" id="4066787">:=</span>&nbsp;<span class="ident" id="4066790">fd</span><span class="op" id="4066792">.</span><span class="ident" id="4066793">pd</span><span class="op" id="4066795">.</span><span class="ident" id="4066796">PrepareRead</span><span class="op" id="4066807">(</span><span class="op" id="4066808">)</span><span class="op" id="4066809">;</span>&nbsp;<span class="ident" id="4066811">err</span>&nbsp;<span class="op" id="4066815">!=</span>&nbsp;<span class="ident" id="4066818">nil</span>&nbsp;<span class="op" id="4066822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066826">return</span>&nbsp;<span class="num" id="4066833">0</span><span class="op" id="4066834">,</span>&nbsp;<span class="num" id="4066836">0</span><span class="op" id="4066837">,</span>&nbsp;<span class="num" id="4066839">0</span><span class="op" id="4066840">,</span>&nbsp;<span class="ident" id="4066842">nil</span><span class="op" id="4066845">,</span>&nbsp;<span class="op" id="4066847">&amp;</span><span class="ident" id="4066848">OpError</span><span class="op" id="4066855">{</span><span class="string" id="4066856">&#34;read&#34;</span><span class="op" id="4066862">,</span>&nbsp;<span class="ident" id="4066864">fd</span><span class="op" id="4066866">.</span><span class="ident" id="4066867">net</span><span class="op" id="4066870">,</span>&nbsp;<span class="ident" id="4066872">fd</span><span class="op" id="4066874">.</span><span class="ident" id="4066875">laddr</span><span class="op" id="4066880">,</span>&nbsp;<span class="ident" id="4066882">err</span><span class="op" id="4066885">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066891">for</span>&nbsp;<span class="op" id="4066895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066899">n</span><span class="op" id="4066900">,</span>&nbsp;<span class="ident" id="4066902">oobn</span><span class="op" id="4066906">,</span>&nbsp;<span class="ident" id="4066908">flags</span><span class="op" id="4066913">,</span>&nbsp;<span class="ident" id="4066915">sa</span><span class="op" id="4066917">,</span>&nbsp;<span class="ident" id="4066919">err</span>&nbsp;<span class="op" id="4066923">=</span>&nbsp;<span class="ident" id="4066925">syscall</span><span class="op" id="4066932">.</span><span class="ident" id="4066933">Recvmsg</span><span class="op" id="4066940">(</span><span class="ident" id="4066941">fd</span><span class="op" id="4066943">.</span><span class="ident" id="4066944">sysfd</span><span class="op" id="4066949">,</span>&nbsp;<span class="ident" id="4066951">p</span><span class="op" id="4066952">,</span>&nbsp;<span class="ident" id="4066954">oob</span><span class="op" id="4066957">,</span>&nbsp;<span class="num" id="4066959">0</span><span class="op" id="4066960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066964">if</span>&nbsp;<span class="ident" id="4066967">err</span>&nbsp;<span class="op" id="4066971">!=</span>&nbsp;<span class="ident" id="4066974">nil</span>&nbsp;<span class="op" id="4066978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4066983">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067029">if</span>&nbsp;<span class="ident" id="4067032">err</span>&nbsp;<span class="op" id="4067036">==</span>&nbsp;<span class="ident" id="4067039">syscall</span><span class="op" id="4067046">.</span><span class="ident" id="4067047">EAGAIN</span>&nbsp;<span class="op" id="4067054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067060">if</span>&nbsp;<span class="ident" id="4067063">err</span>&nbsp;<span class="op" id="4067067">=</span>&nbsp;<span class="ident" id="4067069">fd</span><span class="op" id="4067071">.</span><span class="ident" id="4067072">pd</span><span class="op" id="4067074">.</span><span class="ident" id="4067075">WaitRead</span><span class="op" id="4067083">(</span><span class="op" id="4067084">)</span><span class="op" id="4067085">;</span>&nbsp;<span class="ident" id="4067087">err</span>&nbsp;<span class="op" id="4067091">==</span>&nbsp;<span class="ident" id="4067094">nil</span>&nbsp;<span class="op" id="4067098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067105">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067123">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067131">err</span>&nbsp;<span class="op" id="4067135">=</span>&nbsp;<span class="ident" id="4067137">chkReadErr</span><span class="op" id="4067147">(</span><span class="ident" id="4067148">n</span><span class="op" id="4067149">,</span>&nbsp;<span class="ident" id="4067151">err</span><span class="op" id="4067154">,</span>&nbsp;<span class="ident" id="4067156">fd</span><span class="op" id="4067158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067162">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067172">if</span>&nbsp;<span class="ident" id="4067175">err</span>&nbsp;<span class="op" id="4067179">!=</span>&nbsp;<span class="ident" id="4067182">nil</span>&nbsp;<span class="op" id="4067186">&amp;&amp;</span>&nbsp;<span class="ident" id="4067189">err</span>&nbsp;<span class="op" id="4067193">!=</span>&nbsp;<span class="ident" id="4067196">io</span><span class="op" id="4067198">.</span><span class="ident" id="4067199">EOF</span>&nbsp;<span class="op" id="4067203">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067207">err</span>&nbsp;<span class="op" id="4067211">=</span>&nbsp;<span class="op" id="4067213">&amp;</span><span class="ident" id="4067214">OpError</span><span class="op" id="4067221">{</span><span class="string" id="4067222">&#34;read&#34;</span><span class="op" id="4067228">,</span>&nbsp;<span class="ident" id="4067230">fd</span><span class="op" id="4067232">.</span><span class="ident" id="4067233">net</span><span class="op" id="4067236">,</span>&nbsp;<span class="ident" id="4067238">fd</span><span class="op" id="4067240">.</span><span class="ident" id="4067241">laddr</span><span class="op" id="4067246">,</span>&nbsp;<span class="ident" id="4067248">err</span><span class="op" id="4067251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067257">return</span><br>
<span class="lineno"></span><span class="op" id="4067264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="4067267">func</span>&nbsp;<span class="ident" id="4067272">chkReadErr</span><span class="op" id="4067282">(</span><span class="ident" id="4067283">n</span>&nbsp;<span class="builtintype" id="4067285">int</span><span class="op" id="4067288">,</span>&nbsp;<span class="ident" id="4067290">err</span>&nbsp;<span class="builtintype" id="4067294">error</span><span class="op" id="4067299">,</span>&nbsp;<span class="ident" id="4067301">fd</span>&nbsp;<span class="op" id="4067304">*</span><span class="ident" id="4067305">netFD</span><span class="op" id="4067310">)</span>&nbsp;<span class="builtintype" id="4067312">error</span>&nbsp;<span class="op" id="4067318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067321">if</span>&nbsp;<span class="ident" id="4067324">n</span>&nbsp;<span class="op" id="4067326">==</span>&nbsp;<span class="num" id="4067329">0</span>&nbsp;<span class="op" id="4067331">&amp;&amp;</span>&nbsp;<span class="ident" id="4067334">err</span>&nbsp;<span class="op" id="4067338">==</span>&nbsp;<span class="ident" id="4067341">nil</span>&nbsp;<span class="op" id="4067345">&amp;&amp;</span>&nbsp;<span class="ident" id="4067348">fd</span><span class="op" id="4067350">.</span><span class="ident" id="4067351">sotype</span>&nbsp;<span class="op" id="4067358">!=</span>&nbsp;<span class="ident" id="4067361">syscall</span><span class="op" id="4067368">.</span><span class="ident" id="4067369">SOCK_DGRAM</span>&nbsp;<span class="op" id="4067380">&amp;&amp;</span>&nbsp;<span class="ident" id="4067383">fd</span><span class="op" id="4067385">.</span><span class="ident" id="4067386">sotype</span>&nbsp;<span class="op" id="4067393">!=</span>&nbsp;<span class="ident" id="4067396">syscall</span><span class="op" id="4067403">.</span><span class="ident" id="4067404">SOCK_RAW</span>&nbsp;<span class="op" id="4067413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067417">return</span>&nbsp;<span class="ident" id="4067424">io</span><span class="op" id="4067426">.</span><span class="ident" id="4067427">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067435">return</span>&nbsp;<span class="ident" id="4067442">err</span><br>
<span class="lineno">315</span><span class="op" id="4067446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4067449">func</span>&nbsp;<span class="op" id="4067454">(</span><span class="ident" id="4067455">fd</span>&nbsp;<span class="op" id="4067458">*</span><span class="ident" id="4067459">netFD</span><span class="op" id="4067464">)</span>&nbsp;<span class="ident" id="4067466">Write</span><span class="op" id="4067471">(</span><span class="ident" id="4067472">p</span>&nbsp;<span class="op" id="4067474">[</span><span class="op" id="4067475">]</span><span class="builtintype" id="4067476">byte</span><span class="op" id="4067480">)</span>&nbsp;<span class="op" id="4067482">(</span><span class="ident" id="4067483">nn</span>&nbsp;<span class="builtintype" id="4067486">int</span><span class="op" id="4067489">,</span>&nbsp;<span class="ident" id="4067491">err</span>&nbsp;<span class="builtintype" id="4067495">error</span><span class="op" id="4067500">)</span>&nbsp;<span class="op" id="4067502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067505">if</span>&nbsp;<span class="ident" id="4067508">err</span>&nbsp;<span class="op" id="4067512">:=</span>&nbsp;<span class="ident" id="4067515">fd</span><span class="op" id="4067517">.</span><span class="ident" id="4067518">writeLock</span><span class="op" id="4067527">(</span><span class="op" id="4067528">)</span><span class="op" id="4067529">;</span>&nbsp;<span class="ident" id="4067531">err</span>&nbsp;<span class="op" id="4067535">!=</span>&nbsp;<span class="ident" id="4067538">nil</span>&nbsp;<span class="op" id="4067542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067546">return</span>&nbsp;<span class="num" id="4067553">0</span><span class="op" id="4067554">,</span>&nbsp;<span class="ident" id="4067556">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067564">defer</span>&nbsp;<span class="ident" id="4067570">fd</span><span class="op" id="4067572">.</span><span class="ident" id="4067573">writeUnlock</span><span class="op" id="4067584">(</span><span class="op" id="4067585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067588">if</span>&nbsp;<span class="ident" id="4067591">err</span>&nbsp;<span class="op" id="4067595">:=</span>&nbsp;<span class="ident" id="4067598">fd</span><span class="op" id="4067600">.</span><span class="ident" id="4067601">pd</span><span class="op" id="4067603">.</span><span class="ident" id="4067604">PrepareWrite</span><span class="op" id="4067616">(</span><span class="op" id="4067617">)</span><span class="op" id="4067618">;</span>&nbsp;<span class="ident" id="4067620">err</span>&nbsp;<span class="op" id="4067624">!=</span>&nbsp;<span class="ident" id="4067627">nil</span>&nbsp;<span class="op" id="4067631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067635">return</span>&nbsp;<span class="num" id="4067642">0</span><span class="op" id="4067643">,</span>&nbsp;<span class="op" id="4067645">&amp;</span><span class="ident" id="4067646">OpError</span><span class="op" id="4067653">{</span><span class="string" id="4067654">&#34;write&#34;</span><span class="op" id="4067661">,</span>&nbsp;<span class="ident" id="4067663">fd</span><span class="op" id="4067665">.</span><span class="ident" id="4067666">net</span><span class="op" id="4067669">,</span>&nbsp;<span class="ident" id="4067671">fd</span><span class="op" id="4067673">.</span><span class="ident" id="4067674">raddr</span><span class="op" id="4067679">,</span>&nbsp;<span class="ident" id="4067681">err</span><span class="op" id="4067684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067687">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067690">for</span>&nbsp;<span class="op" id="4067694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067698">var</span>&nbsp;<span class="ident" id="4067702">n</span>&nbsp;<span class="builtintype" id="4067704">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067710">n</span><span class="op" id="4067711">,</span>&nbsp;<span class="ident" id="4067713">err</span>&nbsp;<span class="op" id="4067717">=</span>&nbsp;<span class="ident" id="4067719">syscall</span><span class="op" id="4067726">.</span><span class="ident" id="4067727">Write</span><span class="op" id="4067732">(</span><span class="builtintype" id="4067733">int</span><span class="op" id="4067736">(</span><span class="ident" id="4067737">fd</span><span class="op" id="4067739">.</span><span class="ident" id="4067740">sysfd</span><span class="op" id="4067745">)</span><span class="op" id="4067746">,</span>&nbsp;<span class="ident" id="4067748">p</span><span class="op" id="4067749">[</span><span class="ident" id="4067750">nn</span><span class="op" id="4067752">:</span><span class="op" id="4067753">]</span><span class="op" id="4067754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067758">if</span>&nbsp;<span class="ident" id="4067761">n</span>&nbsp;<span class="op" id="4067763">&gt;</span>&nbsp;<span class="num" id="4067765">0</span>&nbsp;<span class="op" id="4067767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067772">nn</span>&nbsp;<span class="op" id="4067775">+=</span>&nbsp;<span class="ident" id="4067778">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067786">if</span>&nbsp;<span class="ident" id="4067789">nn</span>&nbsp;<span class="op" id="4067792">==</span>&nbsp;<span class="builtinfunc" id="4067795">len</span><span class="op" id="4067798">(</span><span class="ident" id="4067799">p</span><span class="op" id="4067800">)</span>&nbsp;<span class="op" id="4067802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067807">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067819">if</span>&nbsp;<span class="ident" id="4067822">err</span>&nbsp;<span class="op" id="4067826">==</span>&nbsp;<span class="ident" id="4067829">syscall</span><span class="op" id="4067836">.</span><span class="ident" id="4067837">EAGAIN</span>&nbsp;<span class="op" id="4067844">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067849">if</span>&nbsp;<span class="ident" id="4067852">err</span>&nbsp;<span class="op" id="4067856">=</span>&nbsp;<span class="ident" id="4067858">fd</span><span class="op" id="4067860">.</span><span class="ident" id="4067861">pd</span><span class="op" id="4067863">.</span><span class="ident" id="4067864">WaitWrite</span><span class="op" id="4067873">(</span><span class="op" id="4067874">)</span><span class="op" id="4067875">;</span>&nbsp;<span class="ident" id="4067877">err</span>&nbsp;<span class="op" id="4067881">==</span>&nbsp;<span class="ident" id="4067884">nil</span>&nbsp;<span class="op" id="4067888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067894">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067914">if</span>&nbsp;<span class="ident" id="4067917">err</span>&nbsp;<span class="op" id="4067921">!=</span>&nbsp;<span class="ident" id="4067924">nil</span>&nbsp;<span class="op" id="4067928">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067933">n</span>&nbsp;<span class="op" id="4067935">=</span>&nbsp;<span class="num" id="4067937">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067942">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067954">if</span>&nbsp;<span class="ident" id="4067957">n</span>&nbsp;<span class="op" id="4067959">==</span>&nbsp;<span class="num" id="4067962">0</span>&nbsp;<span class="op" id="4067964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067969">err</span>&nbsp;<span class="op" id="4067973">=</span>&nbsp;<span class="ident" id="4067975">io</span><span class="op" id="4067977">.</span><span class="ident" id="4067978">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067998">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068012">if</span>&nbsp;<span class="ident" id="4068015">err</span>&nbsp;<span class="op" id="4068019">!=</span>&nbsp;<span class="ident" id="4068022">nil</span>&nbsp;<span class="op" id="4068026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068030">err</span>&nbsp;<span class="op" id="4068034">=</span>&nbsp;<span class="op" id="4068036">&amp;</span><span class="ident" id="4068037">OpError</span><span class="op" id="4068044">{</span><span class="string" id="4068045">&#34;write&#34;</span><span class="op" id="4068052">,</span>&nbsp;<span class="ident" id="4068054">fd</span><span class="op" id="4068056">.</span><span class="ident" id="4068057">net</span><span class="op" id="4068060">,</span>&nbsp;<span class="ident" id="4068062">fd</span><span class="op" id="4068064">.</span><span class="ident" id="4068065">raddr</span><span class="op" id="4068070">,</span>&nbsp;<span class="ident" id="4068072">err</span><span class="op" id="4068075">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068081">return</span>&nbsp;<span class="ident" id="4068088">nn</span><span class="op" id="4068090">,</span>&nbsp;<span class="ident" id="4068092">err</span><br>
<span class="lineno"></span><span class="op" id="4068096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4068099">func</span>&nbsp;<span class="op" id="4068104">(</span><span class="ident" id="4068105">fd</span>&nbsp;<span class="op" id="4068108">*</span><span class="ident" id="4068109">netFD</span><span class="op" id="4068114">)</span>&nbsp;<span class="ident" id="4068116">writeTo</span><span class="op" id="4068123">(</span><span class="ident" id="4068124">p</span>&nbsp;<span class="op" id="4068126">[</span><span class="op" id="4068127">]</span><span class="builtintype" id="4068128">byte</span><span class="op" id="4068132">,</span>&nbsp;<span class="ident" id="4068134">sa</span>&nbsp;<span class="ident" id="4068137">syscall</span><span class="op" id="4068144">.</span><span class="ident" id="4068145">Sockaddr</span><span class="op" id="4068153">)</span>&nbsp;<span class="op" id="4068155">(</span><span class="ident" id="4068156">n</span>&nbsp;<span class="builtintype" id="4068158">int</span><span class="op" id="4068161">,</span>&nbsp;<span class="ident" id="4068163">err</span>&nbsp;<span class="builtintype" id="4068167">error</span><span class="op" id="4068172">)</span>&nbsp;<span class="op" id="4068174">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068177">if</span>&nbsp;<span class="ident" id="4068180">err</span>&nbsp;<span class="op" id="4068184">:=</span>&nbsp;<span class="ident" id="4068187">fd</span><span class="op" id="4068189">.</span><span class="ident" id="4068190">writeLock</span><span class="op" id="4068199">(</span><span class="op" id="4068200">)</span><span class="op" id="4068201">;</span>&nbsp;<span class="ident" id="4068203">err</span>&nbsp;<span class="op" id="4068207">!=</span>&nbsp;<span class="ident" id="4068210">nil</span>&nbsp;<span class="op" id="4068214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068218">return</span>&nbsp;<span class="num" id="4068225">0</span><span class="op" id="4068226">,</span>&nbsp;<span class="ident" id="4068228">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068236">defer</span>&nbsp;<span class="ident" id="4068242">fd</span><span class="op" id="4068244">.</span><span class="ident" id="4068245">writeUnlock</span><span class="op" id="4068256">(</span><span class="op" id="4068257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068260">if</span>&nbsp;<span class="ident" id="4068263">err</span>&nbsp;<span class="op" id="4068267">:=</span>&nbsp;<span class="ident" id="4068270">fd</span><span class="op" id="4068272">.</span><span class="ident" id="4068273">pd</span><span class="op" id="4068275">.</span><span class="ident" id="4068276">PrepareWrite</span><span class="op" id="4068288">(</span><span class="op" id="4068289">)</span><span class="op" id="4068290">;</span>&nbsp;<span class="ident" id="4068292">err</span>&nbsp;<span class="op" id="4068296">!=</span>&nbsp;<span class="ident" id="4068299">nil</span>&nbsp;<span class="op" id="4068303">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068307">return</span>&nbsp;<span class="num" id="4068314">0</span><span class="op" id="4068315">,</span>&nbsp;<span class="op" id="4068317">&amp;</span><span class="ident" id="4068318">OpError</span><span class="op" id="4068325">{</span><span class="string" id="4068326">&#34;write&#34;</span><span class="op" id="4068333">,</span>&nbsp;<span class="ident" id="4068335">fd</span><span class="op" id="4068337">.</span><span class="ident" id="4068338">net</span><span class="op" id="4068341">,</span>&nbsp;<span class="ident" id="4068343">fd</span><span class="op" id="4068345">.</span><span class="ident" id="4068346">raddr</span><span class="op" id="4068351">,</span>&nbsp;<span class="ident" id="4068353">err</span><span class="op" id="4068356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068362">for</span>&nbsp;<span class="op" id="4068366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068370">err</span>&nbsp;<span class="op" id="4068374">=</span>&nbsp;<span class="ident" id="4068376">syscall</span><span class="op" id="4068383">.</span><span class="ident" id="4068384">Sendto</span><span class="op" id="4068390">(</span><span class="ident" id="4068391">fd</span><span class="op" id="4068393">.</span><span class="ident" id="4068394">sysfd</span><span class="op" id="4068399">,</span>&nbsp;<span class="ident" id="4068401">p</span><span class="op" id="4068402">,</span>&nbsp;<span class="num" id="4068404">0</span><span class="op" id="4068405">,</span>&nbsp;<span class="ident" id="4068407">sa</span><span class="op" id="4068409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068413">if</span>&nbsp;<span class="ident" id="4068416">err</span>&nbsp;<span class="op" id="4068420">==</span>&nbsp;<span class="ident" id="4068423">syscall</span><span class="op" id="4068430">.</span><span class="ident" id="4068431">EAGAIN</span>&nbsp;<span class="op" id="4068438">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068443">if</span>&nbsp;<span class="ident" id="4068446">err</span>&nbsp;<span class="op" id="4068450">=</span>&nbsp;<span class="ident" id="4068452">fd</span><span class="op" id="4068454">.</span><span class="ident" id="4068455">pd</span><span class="op" id="4068457">.</span><span class="ident" id="4068458">WaitWrite</span><span class="op" id="4068467">(</span><span class="op" id="4068468">)</span><span class="op" id="4068469">;</span>&nbsp;<span class="ident" id="4068471">err</span>&nbsp;<span class="op" id="4068475">==</span>&nbsp;<span class="ident" id="4068478">nil</span>&nbsp;<span class="op" id="4068482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068488">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068508">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068518">if</span>&nbsp;<span class="ident" id="4068521">err</span>&nbsp;<span class="op" id="4068525">==</span>&nbsp;<span class="ident" id="4068528">nil</span>&nbsp;<span class="op" id="4068532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068536">n</span>&nbsp;<span class="op" id="4068538">=</span>&nbsp;<span class="builtinfunc" id="4068540">len</span><span class="op" id="4068543">(</span><span class="ident" id="4068544">p</span><span class="op" id="4068545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068548">}</span>&nbsp;<span class="keyword" id="4068550">else</span>&nbsp;<span class="op" id="4068555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068559">err</span>&nbsp;<span class="op" id="4068563">=</span>&nbsp;<span class="op" id="4068565">&amp;</span><span class="ident" id="4068566">OpError</span><span class="op" id="4068573">{</span><span class="string" id="4068574">&#34;write&#34;</span><span class="op" id="4068581">,</span>&nbsp;<span class="ident" id="4068583">fd</span><span class="op" id="4068585">.</span><span class="ident" id="4068586">net</span><span class="op" id="4068589">,</span>&nbsp;<span class="ident" id="4068591">fd</span><span class="op" id="4068593">.</span><span class="ident" id="4068594">raddr</span><span class="op" id="4068599">,</span>&nbsp;<span class="ident" id="4068601">err</span><span class="op" id="4068604">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068610">return</span><br>
<span class="lineno"></span><span class="op" id="4068617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4068620">func</span>&nbsp;<span class="op" id="4068625">(</span><span class="ident" id="4068626">fd</span>&nbsp;<span class="op" id="4068629">*</span><span class="ident" id="4068630">netFD</span><span class="op" id="4068635">)</span>&nbsp;<span class="ident" id="4068637">writeMsg</span><span class="op" id="4068645">(</span><span class="ident" id="4068646">p</span>&nbsp;<span class="op" id="4068648">[</span><span class="op" id="4068649">]</span><span class="builtintype" id="4068650">byte</span><span class="op" id="4068654">,</span>&nbsp;<span class="ident" id="4068656">oob</span>&nbsp;<span class="op" id="4068660">[</span><span class="op" id="4068661">]</span><span class="builtintype" id="4068662">byte</span><span class="op" id="4068666">,</span>&nbsp;<span class="ident" id="4068668">sa</span>&nbsp;<span class="ident" id="4068671">syscall</span><span class="op" id="4068678">.</span><span class="ident" id="4068679">Sockaddr</span><span class="op" id="4068687">)</span>&nbsp;<span class="op" id="4068689">(</span><span class="ident" id="4068690">n</span>&nbsp;<span class="builtintype" id="4068692">int</span><span class="op" id="4068695">,</span>&nbsp;<span class="ident" id="4068697">oobn</span>&nbsp;<span class="builtintype" id="4068702">int</span><span class="op" id="4068705">,</span>&nbsp;<span class="ident" id="4068707">err</span>&nbsp;<span class="builtintype" id="4068711">error</span><span class="op" id="4068716">)</span>&nbsp;<span class="op" id="4068718">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068721">if</span>&nbsp;<span class="ident" id="4068724">err</span>&nbsp;<span class="op" id="4068728">:=</span>&nbsp;<span class="ident" id="4068731">fd</span><span class="op" id="4068733">.</span><span class="ident" id="4068734">writeLock</span><span class="op" id="4068743">(</span><span class="op" id="4068744">)</span><span class="op" id="4068745">;</span>&nbsp;<span class="ident" id="4068747">err</span>&nbsp;<span class="op" id="4068751">!=</span>&nbsp;<span class="ident" id="4068754">nil</span>&nbsp;<span class="op" id="4068758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068762">return</span>&nbsp;<span class="num" id="4068769">0</span><span class="op" id="4068770">,</span>&nbsp;<span class="num" id="4068772">0</span><span class="op" id="4068773">,</span>&nbsp;<span class="ident" id="4068775">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068783">defer</span>&nbsp;<span class="ident" id="4068789">fd</span><span class="op" id="4068791">.</span><span class="ident" id="4068792">writeUnlock</span><span class="op" id="4068803">(</span><span class="op" id="4068804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068807">if</span>&nbsp;<span class="ident" id="4068810">err</span>&nbsp;<span class="op" id="4068814">:=</span>&nbsp;<span class="ident" id="4068817">fd</span><span class="op" id="4068819">.</span><span class="ident" id="4068820">pd</span><span class="op" id="4068822">.</span><span class="ident" id="4068823">PrepareWrite</span><span class="op" id="4068835">(</span><span class="op" id="4068836">)</span><span class="op" id="4068837">;</span>&nbsp;<span class="ident" id="4068839">err</span>&nbsp;<span class="op" id="4068843">!=</span>&nbsp;<span class="ident" id="4068846">nil</span>&nbsp;<span class="op" id="4068850">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068854">return</span>&nbsp;<span class="num" id="4068861">0</span><span class="op" id="4068862">,</span>&nbsp;<span class="num" id="4068864">0</span><span class="op" id="4068865">,</span>&nbsp;<span class="op" id="4068867">&amp;</span><span class="ident" id="4068868">OpError</span><span class="op" id="4068875">{</span><span class="string" id="4068876">&#34;write&#34;</span><span class="op" id="4068883">,</span>&nbsp;<span class="ident" id="4068885">fd</span><span class="op" id="4068887">.</span><span class="ident" id="4068888">net</span><span class="op" id="4068891">,</span>&nbsp;<span class="ident" id="4068893">fd</span><span class="op" id="4068895">.</span><span class="ident" id="4068896">raddr</span><span class="op" id="4068901">,</span>&nbsp;<span class="ident" id="4068903">err</span><span class="op" id="4068906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068912">for</span>&nbsp;<span class="op" id="4068916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068920">n</span><span class="op" id="4068921">,</span>&nbsp;<span class="ident" id="4068923">err</span>&nbsp;<span class="op" id="4068927">=</span>&nbsp;<span class="ident" id="4068929">syscall</span><span class="op" id="4068936">.</span><span class="ident" id="4068937">SendmsgN</span><span class="op" id="4068945">(</span><span class="ident" id="4068946">fd</span><span class="op" id="4068948">.</span><span class="ident" id="4068949">sysfd</span><span class="op" id="4068954">,</span>&nbsp;<span class="ident" id="4068956">p</span><span class="op" id="4068957">,</span>&nbsp;<span class="ident" id="4068959">oob</span><span class="op" id="4068962">,</span>&nbsp;<span class="ident" id="4068964">sa</span><span class="op" id="4068966">,</span>&nbsp;<span class="num" id="4068968">0</span><span class="op" id="4068969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068973">if</span>&nbsp;<span class="ident" id="4068976">err</span>&nbsp;<span class="op" id="4068980">==</span>&nbsp;<span class="ident" id="4068983">syscall</span><span class="op" id="4068990">.</span><span class="ident" id="4068991">EAGAIN</span>&nbsp;<span class="op" id="4068998">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069003">if</span>&nbsp;<span class="ident" id="4069006">err</span>&nbsp;<span class="op" id="4069010">=</span>&nbsp;<span class="ident" id="4069012">fd</span><span class="op" id="4069014">.</span><span class="ident" id="4069015">pd</span><span class="op" id="4069017">.</span><span class="ident" id="4069018">WaitWrite</span><span class="op" id="4069027">(</span><span class="op" id="4069028">)</span><span class="op" id="4069029">;</span>&nbsp;<span class="ident" id="4069031">err</span>&nbsp;<span class="op" id="4069035">==</span>&nbsp;<span class="ident" id="4069038">nil</span>&nbsp;<span class="op" id="4069042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069048">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069068">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069078">if</span>&nbsp;<span class="ident" id="4069081">err</span>&nbsp;<span class="op" id="4069085">==</span>&nbsp;<span class="ident" id="4069088">nil</span>&nbsp;<span class="op" id="4069092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4069096">oobn</span>&nbsp;<span class="op" id="4069101">=</span>&nbsp;<span class="builtinfunc" id="4069103">len</span><span class="op" id="4069106">(</span><span class="ident" id="4069107">oob</span><span class="op" id="4069110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069113">}</span>&nbsp;<span class="keyword" id="4069115">else</span>&nbsp;<span class="op" id="4069120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4069124">err</span>&nbsp;<span class="op" id="4069128">=</span>&nbsp;<span class="op" id="4069130">&amp;</span><span class="ident" id="4069131">OpError</span><span class="op" id="4069138">{</span><span class="string" id="4069139">&#34;write&#34;</span><span class="op" id="4069146">,</span>&nbsp;<span class="ident" id="4069148">fd</span><span class="op" id="4069150">.</span><span class="ident" id="4069151">net</span><span class="op" id="4069154">,</span>&nbsp;<span class="ident" id="4069156">fd</span><span class="op" id="4069158">.</span><span class="ident" id="4069159">raddr</span><span class="op" id="4069164">,</span>&nbsp;<span class="ident" id="4069166">err</span><span class="op" id="4069169">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069175">return</span><br>
<span class="lineno"></span><span class="op" id="4069182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4069185">func</span>&nbsp;<span class="op" id="4069190">(</span><span class="ident" id="4069191">fd</span>&nbsp;<span class="op" id="4069194">*</span><span class="ident" id="4069195">netFD</span><span class="op" id="4069200">)</span>&nbsp;<span class="ident" id="4069202">accept</span><span class="op" id="4069208">(</span><span class="op" id="4069209">)</span>&nbsp;<span class="op" id="4069211">(</span><span class="ident" id="4069212">netfd</span>&nbsp;<span class="op" id="4069218">*</span><span class="ident" id="4069219">netFD</span><span class="op" id="4069224">,</span>&nbsp;<span class="ident" id="4069226">err</span>&nbsp;<span class="builtintype" id="4069230">error</span><span class="op" id="4069235">)</span>&nbsp;<span class="op" id="4069237">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069240">if</span>&nbsp;<span class="ident" id="4069243">err</span>&nbsp;<span class="op" id="4069247">:=</span>&nbsp;<span class="ident" id="4069250">fd</span><span class="op" id="4069252">.</span><span class="ident" id="4069253">readLock</span><span class="op" id="4069261">(</span><span class="op" id="4069262">)</span><span class="op" id="4069263">;</span>&nbsp;<span class="ident" id="4069265">err</span>&nbsp;<span class="op" id="4069269">!=</span>&nbsp;<span class="ident" id="4069272">nil</span>&nbsp;<span class="op" id="4069276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069280">return</span>&nbsp;<span class="ident" id="4069287">nil</span><span class="op" id="4069290">,</span>&nbsp;<span class="ident" id="4069292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069300">defer</span>&nbsp;<span class="ident" id="4069306">fd</span><span class="op" id="4069308">.</span><span class="ident" id="4069309">readUnlock</span><span class="op" id="4069319">(</span><span class="op" id="4069320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069324">var</span>&nbsp;<span class="ident" id="4069328">s</span>&nbsp;<span class="builtintype" id="4069330">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069335">var</span>&nbsp;<span class="ident" id="4069339">rsa</span>&nbsp;<span class="ident" id="4069343">syscall</span><span class="op" id="4069350">.</span><span class="ident" id="4069351">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069361">if</span>&nbsp;<span class="ident" id="4069364">err</span>&nbsp;<span class="op" id="4069368">=</span>&nbsp;<span class="ident" id="4069370">fd</span><span class="op" id="4069372">.</span><span class="ident" id="4069373">pd</span><span class="op" id="4069375">.</span><span class="ident" id="4069376">PrepareRead</span><span class="op" id="4069387">(</span><span class="op" id="4069388">)</span><span class="op" id="4069389">;</span>&nbsp;<span class="ident" id="4069391">err</span>&nbsp;<span class="op" id="4069395">!=</span>&nbsp;<span class="ident" id="4069398">nil</span>&nbsp;<span class="op" id="4069402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069406">return</span>&nbsp;<span class="ident" id="4069413">nil</span><span class="op" id="4069416">,</span>&nbsp;<span class="op" id="4069418">&amp;</span><span class="ident" id="4069419">OpError</span><span class="op" id="4069426">{</span><span class="string" id="4069427">&#34;accept&#34;</span><span class="op" id="4069435">,</span>&nbsp;<span class="ident" id="4069437">fd</span><span class="op" id="4069439">.</span><span class="ident" id="4069440">net</span><span class="op" id="4069443">,</span>&nbsp;<span class="ident" id="4069445">fd</span><span class="op" id="4069447">.</span><span class="ident" id="4069448">laddr</span><span class="op" id="4069453">,</span>&nbsp;<span class="ident" id="4069455">err</span><span class="op" id="4069458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069461">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069464">for</span>&nbsp;<span class="op" id="4069468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4069472">s</span><span class="op" id="4069473">,</span>&nbsp;<span class="ident" id="4069475">rsa</span><span class="op" id="4069478">,</span>&nbsp;<span class="ident" id="4069480">err</span>&nbsp;<span class="op" id="4069484">=</span>&nbsp;<span class="ident" id="4069486">accept</span><span class="op" id="4069492">(</span><span class="ident" id="4069493">fd</span><span class="op" id="4069495">.</span><span class="ident" id="4069496">sysfd</span><span class="op" id="4069501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069505">if</span>&nbsp;<span class="ident" id="4069508">err</span>&nbsp;<span class="op" id="4069512">!=</span>&nbsp;<span class="ident" id="4069515">nil</span>&nbsp;<span class="op" id="4069519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069524">if</span>&nbsp;<span class="ident" id="4069527">err</span>&nbsp;<span class="op" id="4069531">==</span>&nbsp;<span class="ident" id="4069534">syscall</span><span class="op" id="4069541">.</span><span class="ident" id="4069542">EAGAIN</span>&nbsp;<span class="op" id="4069549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069555">if</span>&nbsp;<span class="ident" id="4069558">err</span>&nbsp;<span class="op" id="4069562">=</span>&nbsp;<span class="ident" id="4069564">fd</span><span class="op" id="4069566">.</span><span class="ident" id="4069567">pd</span><span class="op" id="4069569">.</span><span class="ident" id="4069570">WaitRead</span><span class="op" id="4069578">(</span><span class="op" id="4069579">)</span><span class="op" id="4069580">;</span>&nbsp;<span class="ident" id="4069582">err</span>&nbsp;<span class="op" id="4069586">==</span>&nbsp;<span class="ident" id="4069589">nil</span>&nbsp;<span class="op" id="4069593">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069600">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069618">}</span>&nbsp;<span class="keyword" id="4069620">else</span>&nbsp;<span class="keyword" id="4069625">if</span>&nbsp;<span class="ident" id="4069628">err</span>&nbsp;<span class="op" id="4069632">==</span>&nbsp;<span class="ident" id="4069635">syscall</span><span class="op" id="4069642">.</span><span class="ident" id="4069643">ECONNABORTED</span>&nbsp;<span class="op" id="4069656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4069662">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4069725">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069791">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069808">return</span>&nbsp;<span class="ident" id="4069815">nil</span><span class="op" id="4069818">,</span>&nbsp;<span class="op" id="4069820">&amp;</span><span class="ident" id="4069821">OpError</span><span class="op" id="4069828">{</span><span class="string" id="4069829">&#34;accept&#34;</span><span class="op" id="4069837">,</span>&nbsp;<span class="ident" id="4069839">fd</span><span class="op" id="4069841">.</span><span class="ident" id="4069842">net</span><span class="op" id="4069845">,</span>&nbsp;<span class="ident" id="4069847">fd</span><span class="op" id="4069849">.</span><span class="ident" id="4069850">laddr</span><span class="op" id="4069855">,</span>&nbsp;<span class="ident" id="4069857">err</span><span class="op" id="4069860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069868">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069879">if</span>&nbsp;<span class="ident" id="4069882">netfd</span><span class="op" id="4069887">,</span>&nbsp;<span class="ident" id="4069889">err</span>&nbsp;<span class="op" id="4069893">=</span>&nbsp;<span class="ident" id="4069895">newFD</span><span class="op" id="4069900">(</span><span class="ident" id="4069901">s</span><span class="op" id="4069902">,</span>&nbsp;<span class="ident" id="4069904">fd</span><span class="op" id="4069906">.</span><span class="ident" id="4069907">family</span><span class="op" id="4069913">,</span>&nbsp;<span class="ident" id="4069915">fd</span><span class="op" id="4069917">.</span><span class="ident" id="4069918">sotype</span><span class="op" id="4069924">,</span>&nbsp;<span class="ident" id="4069926">fd</span><span class="op" id="4069928">.</span><span class="ident" id="4069929">net</span><span class="op" id="4069932">)</span><span class="op" id="4069933">;</span>&nbsp;<span class="ident" id="4069935">err</span>&nbsp;<span class="op" id="4069939">!=</span>&nbsp;<span class="ident" id="4069942">nil</span>&nbsp;<span class="op" id="4069946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4069950">closesocket</span><span class="op" id="4069961">(</span><span class="ident" id="4069962">s</span><span class="op" id="4069963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069967">return</span>&nbsp;<span class="ident" id="4069974">nil</span><span class="op" id="4069977">,</span>&nbsp;<span class="ident" id="4069979">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4069984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4069987">if</span>&nbsp;<span class="ident" id="4069990">err</span>&nbsp;<span class="op" id="4069994">=</span>&nbsp;<span class="ident" id="4069996">netfd</span><span class="op" id="4070001">.</span><span class="ident" id="4070002">init</span><span class="op" id="4070006">(</span><span class="op" id="4070007">)</span><span class="op" id="4070008">;</span>&nbsp;<span class="ident" id="4070010">err</span>&nbsp;<span class="op" id="4070014">!=</span>&nbsp;<span class="ident" id="4070017">nil</span>&nbsp;<span class="op" id="4070021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4070025">fd</span><span class="op" id="4070027">.</span><span class="ident" id="4070028">Close</span><span class="op" id="4070033">(</span><span class="op" id="4070034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4070038">return</span>&nbsp;<span class="ident" id="4070045">nil</span><span class="op" id="4070048">,</span>&nbsp;<span class="ident" id="4070050">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4070055">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4070058">lsa</span><span class="op" id="4070061">,</span>&nbsp;<span class="ident" id="4070063">_</span>&nbsp;<span class="op" id="4070065">:=</span>&nbsp;<span class="ident" id="4070068">syscall</span><span class="op" id="4070075">.</span><span class="ident" id="4070076">Getsockname</span><span class="op" id="4070087">(</span><span class="ident" id="4070088">netfd</span><span class="op" id="4070093">.</span><span class="ident" id="4070094">sysfd</span><span class="op" id="4070099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4070102">netfd</span><span class="op" id="4070107">.</span><span class="ident" id="4070108">setAddr</span><span class="op" id="4070115">(</span><span class="ident" id="4070116">netfd</span><span class="op" id="4070121">.</span><span class="ident" id="4070122">addrFunc</span><span class="op" id="4070130">(</span><span class="op" id="4070131">)</span><span class="op" id="4070132">(</span><span class="ident" id="4070133">lsa</span><span class="op" id="4070136">)</span><span class="op" id="4070137">,</span>&nbsp;<span class="ident" id="4070139">netfd</span><span class="op" id="4070144">.</span><span class="ident" id="4070145">addrFunc</span><span class="op" id="4070153">(</span><span class="op" id="4070154">)</span><span class="op" id="4070155">(</span><span class="ident" id="4070156">rsa</span><span class="op" id="4070159">)</span><span class="op" id="4070160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4070163">return</span>&nbsp;<span class="ident" id="4070170">netfd</span><span class="op" id="4070175">,</span>&nbsp;<span class="ident" id="4070177">nil</span><br>
<span class="lineno"></span><span class="op" id="4070181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="4070184">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4070251">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4070306">var</span>&nbsp;<span class="ident" id="4070310">tryDupCloexec</span>&nbsp;<span class="op" id="4070324">=</span>&nbsp;<span class="builtintype" id="4070326">int32</span><span class="op" id="4070331">(</span><span class="num" id="4070332">1</span><span class="op" id="4070333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4070336">func</span>&nbsp;<span class="ident" id="4070341">dupCloseOnExec</span><span class="op" id="4070355">(</span><span class="ident" id="4070356">fd</span>&nbsp;<span class="builtintype" id="4070359">int</span><span class="op" id="4070362">)</span>&nbsp;<span class="op" id="4070364">(</span><span class="ident" id="4070365">newfd</span>&nbsp;<span class="builtintype" id="4070371">int</span><span class="op" id="4070374">,</span>&nbsp;<span class="ident" id="4070376">err</span>&nbsp;<span class="builtintype" id="4070380">error</span><span class="op" id="4070385">)</span>&nbsp;<span class="op" id="4070387">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4070390">if</span>&nbsp;<span class="ident" id="4070393">atomic</span><span class="op" id="4070399">.</span><span class="ident" id="4070400">LoadInt32</span><span class="op" id="4070409">(</span><span class="op" id="4070410">&amp;</span><span class="ident" id="4070411">tryDupCloexec</span><span class="op" id="4070424">)</span>&nbsp;<span class="op" id="4070426">==</span>&nbsp;<span class="num" id="4070429">1</span>&nbsp;<span class="op" id="4070431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4070435">r0</span><span class="op" id="4070437">,</span>&nbsp;<span class="ident" id="4070439">_</span><span class="op" id="4070440">,</span>&nbsp;<span class="ident" id="4070442">e1</span>&nbsp;<span class="op" id="4070445">:=</span>&nbsp;<span class="ident" id="4070448">syscall</span><span class="op" id="4070455">.</span><span class="ident" id="4070456">Syscall</span><span class="op" id="4070463">(</span><span class="ident" id="4070464">syscall</span><span class="op" id="4070471">.</span><span class="ident" id="4070472">SYS_FCNTL</span><span class="op" id="4070481">,</span>&nbsp;<span class="builtintype" id="4070483">uintptr</span><span class="op" id="4070490">(</span><span class="ident" id="4070491">fd</span><span class="op" id="4070493">)</span><span class="op" id="4070494">,</span>&nbsp;<span class="ident" id="4070496">syscall</span><span class="op" id="4070503">.</span><span class="ident" id="4070504">F_DUPFD_CLOEXEC</span><span class="op" id="4070519">,</span>&nbsp;<span class="num" id="4070521">0</span><span class="op" id="4070522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4070526">if</span>&nbsp;<span class="ident" id="4070529">runtime</span><span class="op" id="4070536">.</span><span class="ident" id="4070537">GOOS</span>&nbsp;<span class="op" id="4070542">==</span>&nbsp;<span class="string" id="4070545">&#34;darwin&#34;</span>&nbsp;<span class="op" id="4070554">&amp;&amp;</span>&nbsp;<span class="ident" id="4070557">e1</span>&nbsp;<span class="op" id="4070560">==</span>&nbsp;<span class="ident" id="4070563">syscall</span><span class="op" id="4070570">.</span><span class="ident" id="4070571">EBADF</span>&nbsp;<span class="op" id="4070577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070582">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070632">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070679">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070727">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070776">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070820">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070864">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070909">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070932">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4070987">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071002">e1</span>&nbsp;<span class="op" id="4071005">=</span>&nbsp;<span class="ident" id="4071007">syscall</span><span class="op" id="4071014">.</span><span class="ident" id="4071015">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4071024">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071028">switch</span>&nbsp;<span class="ident" id="4071035">e1</span>&nbsp;<span class="op" id="4071038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071042">case</span>&nbsp;<span class="num" id="4071047">0</span><span class="op" id="4071048">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071053">return</span>&nbsp;<span class="builtintype" id="4071060">int</span><span class="op" id="4071063">(</span><span class="ident" id="4071064">r0</span><span class="op" id="4071066">)</span><span class="op" id="4071067">,</span>&nbsp;<span class="ident" id="4071069">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071075">case</span>&nbsp;<span class="ident" id="4071080">syscall</span><span class="op" id="4071087">.</span><span class="ident" id="4071088">EINVAL</span><span class="op" id="4071094">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071099">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071147">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071166">atomic</span><span class="op" id="4071172">.</span><span class="ident" id="4071173">StoreInt32</span><span class="op" id="4071183">(</span><span class="op" id="4071184">&amp;</span><span class="ident" id="4071185">tryDupCloexec</span><span class="op" id="4071198">,</span>&nbsp;<span class="num" id="4071200">0</span><span class="op" id="4071201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071205">default</span><span class="op" id="4071212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071217">return</span>&nbsp;<span class="op" id="4071224">-</span><span class="num" id="4071225">1</span><span class="op" id="4071226">,</span>&nbsp;<span class="ident" id="4071228">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4071233">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4071236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071239">return</span>&nbsp;<span class="ident" id="4071246">dupCloseOnExecOld</span><span class="op" id="4071263">(</span><span class="ident" id="4071264">fd</span><span class="op" id="4071266">)</span><br>
<span class="lineno"></span><span class="op" id="4071268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4071271">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="4071336">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="4071386">func</span>&nbsp;<span class="ident" id="4071391">dupCloseOnExecOld</span><span class="op" id="4071408">(</span><span class="ident" id="4071409">fd</span>&nbsp;<span class="builtintype" id="4071412">int</span><span class="op" id="4071415">)</span>&nbsp;<span class="op" id="4071417">(</span><span class="ident" id="4071418">newfd</span>&nbsp;<span class="builtintype" id="4071424">int</span><span class="op" id="4071427">,</span>&nbsp;<span class="ident" id="4071429">err</span>&nbsp;<span class="builtintype" id="4071433">error</span><span class="op" id="4071438">)</span>&nbsp;<span class="op" id="4071440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071443">syscall</span><span class="op" id="4071450">.</span><span class="ident" id="4071451">ForkLock</span><span class="op" id="4071459">.</span><span class="ident" id="4071460">RLock</span><span class="op" id="4071465">(</span><span class="op" id="4071466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071469">defer</span>&nbsp;<span class="ident" id="4071475">syscall</span><span class="op" id="4071482">.</span><span class="ident" id="4071483">ForkLock</span><span class="op" id="4071491">.</span><span class="ident" id="4071492">RUnlock</span><span class="op" id="4071499">(</span><span class="op" id="4071500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071503">newfd</span><span class="op" id="4071508">,</span>&nbsp;<span class="ident" id="4071510">err</span>&nbsp;<span class="op" id="4071514">=</span>&nbsp;<span class="ident" id="4071516">syscall</span><span class="op" id="4071523">.</span><span class="ident" id="4071524">Dup</span><span class="op" id="4071527">(</span><span class="ident" id="4071528">fd</span><span class="op" id="4071530">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071533">if</span>&nbsp;<span class="ident" id="4071536">err</span>&nbsp;<span class="op" id="4071540">!=</span>&nbsp;<span class="ident" id="4071543">nil</span>&nbsp;<span class="op" id="4071547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071551">return</span>&nbsp;<span class="op" id="4071558">-</span><span class="num" id="4071559">1</span><span class="op" id="4071560">,</span>&nbsp;<span class="ident" id="4071562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4071567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071570">syscall</span><span class="op" id="4071577">.</span><span class="ident" id="4071578">CloseOnExec</span><span class="op" id="4071589">(</span><span class="ident" id="4071590">newfd</span><span class="op" id="4071595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071598">return</span><br>
<span class="lineno">490</span><span class="op" id="4071605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4071608">func</span>&nbsp;<span class="op" id="4071613">(</span><span class="ident" id="4071614">fd</span>&nbsp;<span class="op" id="4071617">*</span><span class="ident" id="4071618">netFD</span><span class="op" id="4071623">)</span>&nbsp;<span class="ident" id="4071625">dup</span><span class="op" id="4071628">(</span><span class="op" id="4071629">)</span>&nbsp;<span class="op" id="4071631">(</span><span class="ident" id="4071632">f</span>&nbsp;<span class="op" id="4071634">*</span><span class="ident" id="4071635">os</span><span class="op" id="4071637">.</span><span class="ident" id="4071638">File</span><span class="op" id="4071642">,</span>&nbsp;<span class="ident" id="4071644">err</span>&nbsp;<span class="builtintype" id="4071648">error</span><span class="op" id="4071653">)</span>&nbsp;<span class="op" id="4071655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4071658">ns</span><span class="op" id="4071660">,</span>&nbsp;<span class="ident" id="4071662">err</span>&nbsp;<span class="op" id="4071666">:=</span>&nbsp;<span class="ident" id="4071669">dupCloseOnExec</span><span class="op" id="4071683">(</span><span class="ident" id="4071684">fd</span><span class="op" id="4071686">.</span><span class="ident" id="4071687">sysfd</span><span class="op" id="4071692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071695">if</span>&nbsp;<span class="ident" id="4071698">err</span>&nbsp;<span class="op" id="4071702">!=</span>&nbsp;<span class="ident" id="4071705">nil</span>&nbsp;<span class="op" id="4071709">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4071713">return</span>&nbsp;<span class="ident" id="4071720">nil</span><span class="op" id="4071723">,</span>&nbsp;<span class="op" id="4071725">&amp;</span><span class="ident" id="4071726">OpError</span><span class="op" id="4071733">{</span><span class="string" id="4071734">&#34;dup&#34;</span><span class="op" id="4071739">,</span>&nbsp;<span class="ident" id="4071741">fd</span><span class="op" id="4071743">.</span><span class="ident" id="4071744">net</span><span class="op" id="4071747">,</span>&nbsp;<span class="ident" id="4071749">fd</span><span class="op" id="4071751">.</span><span class="ident" id="4071752">laddr</span><span class="op" id="4071757">,</span>&nbsp;<span class="ident" id="4071759">err</span><span class="op" id="4071762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4071765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071769">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071838">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071901">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4071975">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072031">if</span>&nbsp;<span class="ident" id="4072034">err</span>&nbsp;<span class="op" id="4072038">=</span>&nbsp;<span class="ident" id="4072040">syscall</span><span class="op" id="4072047">.</span><span class="ident" id="4072048">SetNonblock</span><span class="op" id="4072059">(</span><span class="ident" id="4072060">ns</span><span class="op" id="4072062">,</span>&nbsp;<span class="builtintype" id="4072064">false</span><span class="op" id="4072069">)</span><span class="op" id="4072070">;</span>&nbsp;<span class="ident" id="4072072">err</span>&nbsp;<span class="op" id="4072076">!=</span>&nbsp;<span class="ident" id="4072079">nil</span>&nbsp;<span class="op" id="4072083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072087">return</span>&nbsp;<span class="ident" id="4072094">nil</span><span class="op" id="4072097">,</span>&nbsp;<span class="op" id="4072099">&amp;</span><span class="ident" id="4072100">OpError</span><span class="op" id="4072107">{</span><span class="string" id="4072108">&#34;setnonblock&#34;</span><span class="op" id="4072121">,</span>&nbsp;<span class="ident" id="4072123">fd</span><span class="op" id="4072125">.</span><span class="ident" id="4072126">net</span><span class="op" id="4072129">,</span>&nbsp;<span class="ident" id="4072131">fd</span><span class="op" id="4072133">.</span><span class="ident" id="4072134">laddr</span><span class="op" id="4072139">,</span>&nbsp;<span class="ident" id="4072141">err</span><span class="op" id="4072144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4072147">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072151">return</span>&nbsp;<span class="ident" id="4072158">os</span><span class="op" id="4072160">.</span><span class="ident" id="4072161">NewFile</span><span class="op" id="4072168">(</span><span class="builtintype" id="4072169">uintptr</span><span class="op" id="4072176">(</span><span class="ident" id="4072177">ns</span><span class="op" id="4072179">)</span><span class="op" id="4072180">,</span>&nbsp;<span class="ident" id="4072182">fd</span><span class="op" id="4072184">.</span><span class="ident" id="4072185">name</span><span class="op" id="4072189">(</span><span class="op" id="4072190">)</span><span class="op" id="4072191">)</span><span class="op" id="4072192">,</span>&nbsp;<span class="ident" id="4072194">nil</span><br>
<span class="lineno"></span><span class="op" id="4072198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4072201">func</span>&nbsp;<span class="ident" id="4072206">closesocket</span><span class="op" id="4072217">(</span><span class="ident" id="4072218">s</span>&nbsp;<span class="builtintype" id="4072220">int</span><span class="op" id="4072223">)</span>&nbsp;<span class="builtintype" id="4072225">error</span>&nbsp;<span class="op" id="4072231">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072234">return</span>&nbsp;<span class="ident" id="4072241">syscall</span><span class="op" id="4072248">.</span><span class="ident" id="4072249">Close</span><span class="op" id="4072254">(</span><span class="ident" id="4072255">s</span><span class="op" id="4072256">)</span><br>
<span class="lineno"></span><span class="op" id="4072258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4072261">func</span>&nbsp;<span class="ident" id="4072266">skipRawSocketTests</span><span class="op" id="4072284">(</span><span class="op" id="4072285">)</span>&nbsp;<span class="op" id="4072287">(</span><span class="ident" id="4072288">skip</span>&nbsp;<span class="builtintype" id="4072293">bool</span><span class="op" id="4072297">,</span>&nbsp;<span class="ident" id="4072299">skipmsg</span>&nbsp;<span class="builtintype" id="4072307">string</span><span class="op" id="4072313">,</span>&nbsp;<span class="ident" id="4072315">err</span>&nbsp;<span class="builtintype" id="4072319">error</span><span class="op" id="4072324">)</span>&nbsp;<span class="op" id="4072326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072329">if</span>&nbsp;<span class="ident" id="4072332">os</span><span class="op" id="4072334">.</span><span class="ident" id="4072335">Getuid</span><span class="op" id="4072341">(</span><span class="op" id="4072342">)</span>&nbsp;<span class="op" id="4072344">!=</span>&nbsp;<span class="num" id="4072347">0</span>&nbsp;<span class="op" id="4072349">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072353">return</span>&nbsp;<span class="builtintype" id="4072360">true</span><span class="op" id="4072364">,</span>&nbsp;<span class="string" id="4072366">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="4072395">,</span>&nbsp;<span class="ident" id="4072397">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4072402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4072405">return</span>&nbsp;<span class="builtintype" id="4072412">false</span><span class="op" id="4072417">,</span>&nbsp;<span class="string" id="4072419">&#34;&#34;</span><span class="op" id="4072421">,</span>&nbsp;<span class="ident" id="4072423">nil</span><br>
<span class="lineno"></span><span class="op" id="4072427">}</span>
</div>
</body>
</html>
