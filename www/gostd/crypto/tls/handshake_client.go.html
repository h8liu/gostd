<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html" class="current">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4373150">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4373205">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4373259">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4373310">package</span>&nbsp;<span class="ident" id="4373318">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4373323">import</span>&nbsp;<span class="op" id="4373330">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373333">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373342">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373352">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373368">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373382">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373399">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373414">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373424">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373431">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373437">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4373444">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4373454">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4373457">type</span>&nbsp;<span class="ident" id="4373462">clientHandshakeState</span>&nbsp;<span class="keyword" id="4373483">struct</span>&nbsp;<span class="op" id="4373490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373493">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373506">*</span><span class="ident" id="4373507">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373513">serverHello</span>&nbsp;&nbsp;<span class="op" id="4373526">*</span><span class="ident" id="4373527">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373543">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373556">*</span><span class="ident" id="4373557">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373573">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373586">*</span><span class="ident" id="4373587">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373600">finishedHash</span>&nbsp;<span class="ident" id="4373613">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373627">masterSecret</span>&nbsp;<span class="op" id="4373640">[</span><span class="op" id="4373641">]</span><span class="builtintype" id="4373642">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373648">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373661">*</span><span class="ident" id="4373662">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4373681">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4373684">func</span>&nbsp;<span class="op" id="4373689">(</span><span class="ident" id="4373690">c</span>&nbsp;<span class="op" id="4373692">*</span><span class="ident" id="4373693">Conn</span><span class="op" id="4373697">)</span>&nbsp;<span class="ident" id="4373699">clientHandshake</span><span class="op" id="4373714">(</span><span class="op" id="4373715">)</span>&nbsp;<span class="builtintype" id="4373717">error</span>&nbsp;<span class="op" id="4373723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373726">if</span>&nbsp;<span class="ident" id="4373729">c</span><span class="op" id="4373730">.</span><span class="ident" id="4373731">config</span>&nbsp;<span class="op" id="4373738">==</span>&nbsp;<span class="builtintype" id="4373741">nil</span>&nbsp;<span class="op" id="4373745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373749">c</span><span class="op" id="4373750">.</span><span class="ident" id="4373751">config</span>&nbsp;<span class="op" id="4373758">=</span>&nbsp;<span class="ident" id="4373760">defaultConfig</span><span class="op" id="4373773">(</span><span class="op" id="4373774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373777">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373781">if</span>&nbsp;<span class="builtinfunc" id="4373784">len</span><span class="op" id="4373787">(</span><span class="ident" id="4373788">c</span><span class="op" id="4373789">.</span><span class="ident" id="4373790">config</span><span class="op" id="4373796">.</span><span class="ident" id="4373797">ServerName</span><span class="op" id="4373807">)</span>&nbsp;<span class="op" id="4373809">==</span>&nbsp;<span class="num" id="4373812">0</span>&nbsp;<span class="op" id="4373814">&amp;&amp;</span>&nbsp;<span class="op" id="4373817">!</span><span class="ident" id="4373818">c</span><span class="op" id="4373819">.</span><span class="ident" id="4373820">config</span><span class="op" id="4373826">.</span><span class="ident" id="4373827">InsecureSkipVerify</span>&nbsp;<span class="op" id="4373846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373850">return</span>&nbsp;<span class="ident" id="4373857">errors</span><span class="op" id="4373863">.</span><span class="ident" id="4373864">New</span><span class="op" id="4373867">(</span><span class="string" id="4373868">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4373950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4373953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4373957">nextProtosLength</span>&nbsp;<span class="op" id="4373974">:=</span>&nbsp;<span class="num" id="4373977">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4373980">for</span>&nbsp;<span class="ident" id="4373984">_</span><span class="op" id="4373985">,</span>&nbsp;<span class="ident" id="4373987">proto</span>&nbsp;<span class="op" id="4373993">:=</span>&nbsp;<span class="keyword" id="4373996">range</span>&nbsp;<span class="ident" id="4374002">c</span><span class="op" id="4374003">.</span><span class="ident" id="4374004">config</span><span class="op" id="4374010">.</span><span class="ident" id="4374011">NextProtos</span>&nbsp;<span class="op" id="4374022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374026">if</span>&nbsp;<span class="ident" id="4374029">l</span>&nbsp;<span class="op" id="4374031">:=</span>&nbsp;<span class="builtinfunc" id="4374034">len</span><span class="op" id="4374037">(</span><span class="ident" id="4374038">proto</span><span class="op" id="4374043">)</span><span class="op" id="4374044">;</span>&nbsp;<span class="ident" id="4374046">l</span>&nbsp;<span class="op" id="4374048">==</span>&nbsp;<span class="num" id="4374051">0</span>&nbsp;<span class="op" id="4374053">||</span>&nbsp;<span class="ident" id="4374056">l</span>&nbsp;<span class="op" id="4374058">&gt;</span>&nbsp;<span class="num" id="4374060">255</span>&nbsp;<span class="op" id="4374064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374069">return</span>&nbsp;<span class="ident" id="4374076">errors</span><span class="op" id="4374082">.</span><span class="ident" id="4374083">New</span><span class="op" id="4374086">(</span><span class="string" id="4374087">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4374118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374122">}</span>&nbsp;<span class="keyword" id="4374124">else</span>&nbsp;<span class="op" id="4374129">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374134">nextProtosLength</span>&nbsp;<span class="op" id="4374151">+=</span>&nbsp;<span class="num" id="4374154">1</span>&nbsp;<span class="op" id="4374156">+</span>&nbsp;<span class="ident" id="4374158">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374168">if</span>&nbsp;<span class="ident" id="4374171">nextProtosLength</span>&nbsp;<span class="op" id="4374188">&gt;</span>&nbsp;<span class="num" id="4374190">0xffff</span>&nbsp;<span class="op" id="4374197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374201">return</span>&nbsp;<span class="ident" id="4374208">errors</span><span class="op" id="4374214">.</span><span class="ident" id="4374215">New</span><span class="op" id="4374218">(</span><span class="string" id="4374219">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4374253">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374260">hello</span>&nbsp;<span class="op" id="4374266">:=</span>&nbsp;<span class="op" id="4374269">&amp;</span><span class="ident" id="4374270">clientHelloMsg</span><span class="op" id="4374284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374288">vers</span><span class="op" id="4374292">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374309">c</span><span class="op" id="4374310">.</span><span class="ident" id="4374311">config</span><span class="op" id="4374317">.</span><span class="ident" id="4374318">maxVersion</span><span class="op" id="4374328">(</span><span class="op" id="4374329">)</span><span class="op" id="4374330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374334">compressionMethods</span><span class="op" id="4374352">:</span>&nbsp;&nbsp;<span class="op" id="4374355">[</span><span class="op" id="4374356">]</span><span class="builtintype" id="4374357">uint8</span><span class="op" id="4374362">{</span><span class="ident" id="4374363">compressionNone</span><span class="op" id="4374378">}</span><span class="op" id="4374379">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374383">random</span><span class="op" id="4374389">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4374404">make</span><span class="op" id="4374408">(</span><span class="op" id="4374409">[</span><span class="op" id="4374410">]</span><span class="builtintype" id="4374411">byte</span><span class="op" id="4374415">,</span>&nbsp;<span class="num" id="4374417">32</span><span class="op" id="4374419">)</span><span class="op" id="4374420">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374424">ocspStapling</span><span class="op" id="4374436">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4374445">true</span><span class="op" id="4374449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374453">serverName</span><span class="op" id="4374463">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374474">c</span><span class="op" id="4374475">.</span><span class="ident" id="4374476">config</span><span class="op" id="4374482">.</span><span class="ident" id="4374483">ServerName</span><span class="op" id="4374493">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374497">supportedCurves</span><span class="op" id="4374512">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374518">c</span><span class="op" id="4374519">.</span><span class="ident" id="4374520">config</span><span class="op" id="4374526">.</span><span class="ident" id="4374527">curvePreferences</span><span class="op" id="4374543">(</span><span class="op" id="4374544">)</span><span class="op" id="4374545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374549">supportedPoints</span><span class="op" id="4374564">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374570">[</span><span class="op" id="4374571">]</span><span class="builtintype" id="4374572">uint8</span><span class="op" id="4374577">{</span><span class="ident" id="4374578">pointFormatUncompressed</span><span class="op" id="4374601">}</span><span class="op" id="4374602">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374606">nextProtoNeg</span><span class="op" id="4374618">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4374627">len</span><span class="op" id="4374630">(</span><span class="ident" id="4374631">c</span><span class="op" id="4374632">.</span><span class="ident" id="4374633">config</span><span class="op" id="4374639">.</span><span class="ident" id="4374640">NextProtos</span><span class="op" id="4374650">)</span>&nbsp;<span class="op" id="4374652">&gt;</span>&nbsp;<span class="num" id="4374654">0</span><span class="op" id="4374655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374659">secureRenegotiation</span><span class="op" id="4374678">:</span>&nbsp;<span class="builtintype" id="4374680">true</span><span class="op" id="4374684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374688">alpnProtocols</span><span class="op" id="4374701">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374709">c</span><span class="op" id="4374710">.</span><span class="ident" id="4374711">config</span><span class="op" id="4374717">.</span><span class="ident" id="4374718">NextProtos</span><span class="op" id="4374728">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374735">possibleCipherSuites</span>&nbsp;<span class="op" id="4374756">:=</span>&nbsp;<span class="ident" id="4374759">c</span><span class="op" id="4374760">.</span><span class="ident" id="4374761">config</span><span class="op" id="4374767">.</span><span class="ident" id="4374768">cipherSuites</span><span class="op" id="4374780">(</span><span class="op" id="4374781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4374784">hello</span><span class="op" id="4374789">.</span><span class="ident" id="4374790">cipherSuites</span>&nbsp;<span class="op" id="4374803">=</span>&nbsp;<span class="builtinfunc" id="4374805">make</span><span class="op" id="4374809">(</span><span class="op" id="4374810">[</span><span class="op" id="4374811">]</span><span class="builtintype" id="4374812">uint16</span><span class="op" id="4374818">,</span>&nbsp;<span class="num" id="4374820">0</span><span class="op" id="4374821">,</span>&nbsp;<span class="builtinfunc" id="4374823">len</span><span class="op" id="4374826">(</span><span class="ident" id="4374827">possibleCipherSuites</span><span class="op" id="4374847">)</span><span class="op" id="4374848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4374851">NextCipherSuite</span><span class="op" id="4374866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374869">for</span>&nbsp;<span class="ident" id="4374873">_</span><span class="op" id="4374874">,</span>&nbsp;<span class="ident" id="4374876">suiteId</span>&nbsp;<span class="op" id="4374884">:=</span>&nbsp;<span class="keyword" id="4374887">range</span>&nbsp;<span class="ident" id="4374893">possibleCipherSuites</span>&nbsp;<span class="op" id="4374914">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374918">for</span>&nbsp;<span class="ident" id="4374922">_</span><span class="op" id="4374923">,</span>&nbsp;<span class="ident" id="4374925">suite</span>&nbsp;<span class="op" id="4374931">:=</span>&nbsp;<span class="keyword" id="4374934">range</span>&nbsp;<span class="ident" id="4374940">cipherSuites</span>&nbsp;<span class="op" id="4374953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374958">if</span>&nbsp;<span class="ident" id="4374961">suite</span><span class="op" id="4374966">.</span><span class="ident" id="4374967">id</span>&nbsp;<span class="op" id="4374970">!=</span>&nbsp;<span class="ident" id="4374973">suiteId</span>&nbsp;<span class="op" id="4374981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4374987">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4374999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4375004">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4375060">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375092">if</span>&nbsp;<span class="ident" id="4375095">hello</span><span class="op" id="4375100">.</span><span class="ident" id="4375101">vers</span>&nbsp;<span class="op" id="4375106">&lt;</span>&nbsp;<span class="ident" id="4375108">VersionTLS12</span>&nbsp;<span class="op" id="4375121">&amp;&amp;</span>&nbsp;<span class="ident" id="4375124">suite</span><span class="op" id="4375129">.</span><span class="ident" id="4375130">flags</span><span class="op" id="4375135">&amp;</span><span class="ident" id="4375136">suiteTLS12</span>&nbsp;<span class="op" id="4375147">!=</span>&nbsp;<span class="num" id="4375150">0</span>&nbsp;<span class="op" id="4375152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375158">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375175">hello</span><span class="op" id="4375180">.</span><span class="ident" id="4375181">cipherSuites</span>&nbsp;<span class="op" id="4375194">=</span>&nbsp;<span class="builtinfunc" id="4375196">append</span><span class="op" id="4375202">(</span><span class="ident" id="4375203">hello</span><span class="op" id="4375208">.</span><span class="ident" id="4375209">cipherSuites</span><span class="op" id="4375221">,</span>&nbsp;<span class="ident" id="4375223">suiteId</span><span class="op" id="4375230">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375235">continue</span>&nbsp;<span class="ident" id="4375244">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375269">_</span><span class="op" id="4375270">,</span>&nbsp;<span class="ident" id="4375272">err</span>&nbsp;<span class="op" id="4375276">:=</span>&nbsp;<span class="ident" id="4375279">io</span><span class="op" id="4375281">.</span><span class="ident" id="4375282">ReadFull</span><span class="op" id="4375290">(</span><span class="ident" id="4375291">c</span><span class="op" id="4375292">.</span><span class="ident" id="4375293">config</span><span class="op" id="4375299">.</span><span class="ident" id="4375300">rand</span><span class="op" id="4375304">(</span><span class="op" id="4375305">)</span><span class="op" id="4375306">,</span>&nbsp;<span class="ident" id="4375308">hello</span><span class="op" id="4375313">.</span><span class="ident" id="4375314">random</span><span class="op" id="4375320">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375323">if</span>&nbsp;<span class="ident" id="4375326">err</span>&nbsp;<span class="op" id="4375330">!=</span>&nbsp;<span class="builtintype" id="4375333">nil</span>&nbsp;<span class="op" id="4375337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375341">c</span><span class="op" id="4375342">.</span><span class="ident" id="4375343">sendAlert</span><span class="op" id="4375352">(</span><span class="ident" id="4375353">alertInternalError</span><span class="op" id="4375371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375375">return</span>&nbsp;<span class="ident" id="4375382">errors</span><span class="op" id="4375388">.</span><span class="ident" id="4375389">New</span><span class="op" id="4375392">(</span><span class="string" id="4375393">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4375423">+</span>&nbsp;<span class="ident" id="4375425">err</span><span class="op" id="4375428">.</span><span class="ident" id="4375429">Error</span><span class="op" id="4375434">(</span><span class="op" id="4375435">)</span><span class="op" id="4375436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375443">if</span>&nbsp;<span class="ident" id="4375446">hello</span><span class="op" id="4375451">.</span><span class="ident" id="4375452">vers</span>&nbsp;<span class="op" id="4375457">&gt;=</span>&nbsp;<span class="ident" id="4375460">VersionTLS12</span>&nbsp;<span class="op" id="4375473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375477">hello</span><span class="op" id="4375482">.</span><span class="ident" id="4375483">signatureAndHashes</span>&nbsp;<span class="op" id="4375502">=</span>&nbsp;<span class="ident" id="4375504">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375541">var</span>&nbsp;<span class="ident" id="4375545">session</span>&nbsp;<span class="op" id="4375553">*</span><span class="ident" id="4375554">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375574">var</span>&nbsp;<span class="ident" id="4375578">cacheKey</span>&nbsp;<span class="builtintype" id="4375587">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375595">sessionCache</span>&nbsp;<span class="op" id="4375608">:=</span>&nbsp;<span class="ident" id="4375611">c</span><span class="op" id="4375612">.</span><span class="ident" id="4375613">config</span><span class="op" id="4375619">.</span><span class="ident" id="4375620">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375640">if</span>&nbsp;<span class="ident" id="4375643">c</span><span class="op" id="4375644">.</span><span class="ident" id="4375645">config</span><span class="op" id="4375651">.</span><span class="ident" id="4375652">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4375675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375679">sessionCache</span>&nbsp;<span class="op" id="4375692">=</span>&nbsp;<span class="builtintype" id="4375694">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4375699">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375703">if</span>&nbsp;<span class="ident" id="4375706">sessionCache</span>&nbsp;<span class="op" id="4375719">!=</span>&nbsp;<span class="builtintype" id="4375722">nil</span>&nbsp;<span class="op" id="4375726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375730">hello</span><span class="op" id="4375735">.</span><span class="ident" id="4375736">ticketSupported</span>&nbsp;<span class="op" id="4375752">=</span>&nbsp;<span class="builtintype" id="4375754">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4375762">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4375821">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375837">cacheKey</span>&nbsp;<span class="op" id="4375846">=</span>&nbsp;<span class="ident" id="4375848">clientSessionCacheKey</span><span class="op" id="4375869">(</span><span class="ident" id="4375870">c</span><span class="op" id="4375871">.</span><span class="ident" id="4375872">conn</span><span class="op" id="4375876">.</span><span class="ident" id="4375877">RemoteAddr</span><span class="op" id="4375887">(</span><span class="op" id="4375888">)</span><span class="op" id="4375889">,</span>&nbsp;<span class="ident" id="4375891">c</span><span class="op" id="4375892">.</span><span class="ident" id="4375893">config</span><span class="op" id="4375899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4375903">candidateSession</span><span class="op" id="4375919">,</span>&nbsp;<span class="ident" id="4375921">ok</span>&nbsp;<span class="op" id="4375924">:=</span>&nbsp;<span class="ident" id="4375927">sessionCache</span><span class="op" id="4375939">.</span><span class="ident" id="4375940">Get</span><span class="op" id="4375943">(</span><span class="ident" id="4375944">cacheKey</span><span class="op" id="4375952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4375956">if</span>&nbsp;<span class="ident" id="4375959">ok</span>&nbsp;<span class="op" id="4375962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4375967">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376021">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376061">cipherSuiteOk</span>&nbsp;<span class="op" id="4376075">:=</span>&nbsp;<span class="builtintype" id="4376078">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376087">for</span>&nbsp;<span class="ident" id="4376091">_</span><span class="op" id="4376092">,</span>&nbsp;<span class="ident" id="4376094">id</span>&nbsp;<span class="op" id="4376097">:=</span>&nbsp;<span class="keyword" id="4376100">range</span>&nbsp;<span class="ident" id="4376106">hello</span><span class="op" id="4376111">.</span><span class="ident" id="4376112">cipherSuites</span>&nbsp;<span class="op" id="4376125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376131">if</span>&nbsp;<span class="ident" id="4376134">id</span>&nbsp;<span class="op" id="4376137">==</span>&nbsp;<span class="ident" id="4376140">candidateSession</span><span class="op" id="4376156">.</span><span class="ident" id="4376157">cipherSuite</span>&nbsp;<span class="op" id="4376169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376176">cipherSuiteOk</span>&nbsp;<span class="op" id="4376190">=</span>&nbsp;<span class="builtintype" id="4376192">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376202">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376223">versOk</span>&nbsp;<span class="op" id="4376230">:=</span>&nbsp;<span class="ident" id="4376233">candidateSession</span><span class="op" id="4376249">.</span><span class="ident" id="4376250">vers</span>&nbsp;<span class="op" id="4376255">&gt;=</span>&nbsp;<span class="ident" id="4376258">c</span><span class="op" id="4376259">.</span><span class="ident" id="4376260">config</span><span class="op" id="4376266">.</span><span class="ident" id="4376267">minVersion</span><span class="op" id="4376277">(</span><span class="op" id="4376278">)</span>&nbsp;<span class="op" id="4376280">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376287">candidateSession</span><span class="op" id="4376303">.</span><span class="ident" id="4376304">vers</span>&nbsp;<span class="op" id="4376309">&lt;=</span>&nbsp;<span class="ident" id="4376312">c</span><span class="op" id="4376313">.</span><span class="ident" id="4376314">config</span><span class="op" id="4376320">.</span><span class="ident" id="4376321">maxVersion</span><span class="op" id="4376331">(</span><span class="op" id="4376332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376337">if</span>&nbsp;<span class="ident" id="4376340">versOk</span>&nbsp;<span class="op" id="4376347">&amp;&amp;</span>&nbsp;<span class="ident" id="4376350">cipherSuiteOk</span>&nbsp;<span class="op" id="4376364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376370">session</span>&nbsp;<span class="op" id="4376378">=</span>&nbsp;<span class="ident" id="4376380">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376404">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376411">if</span>&nbsp;<span class="ident" id="4376414">session</span>&nbsp;<span class="op" id="4376422">!=</span>&nbsp;<span class="builtintype" id="4376425">nil</span>&nbsp;<span class="op" id="4376429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376433">hello</span><span class="op" id="4376438">.</span><span class="ident" id="4376439">sessionTicket</span>&nbsp;<span class="op" id="4376453">=</span>&nbsp;<span class="ident" id="4376455">session</span><span class="op" id="4376462">.</span><span class="ident" id="4376463">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376479">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376531">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4376589">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376610">hello</span><span class="op" id="4376615">.</span><span class="ident" id="4376616">sessionId</span>&nbsp;<span class="op" id="4376626">=</span>&nbsp;<span class="builtinfunc" id="4376628">make</span><span class="op" id="4376632">(</span><span class="op" id="4376633">[</span><span class="op" id="4376634">]</span><span class="builtintype" id="4376635">byte</span><span class="op" id="4376639">,</span>&nbsp;<span class="num" id="4376641">16</span><span class="op" id="4376643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376647">if</span>&nbsp;<span class="ident" id="4376650">_</span><span class="op" id="4376651">,</span>&nbsp;<span class="ident" id="4376653">err</span>&nbsp;<span class="op" id="4376657">:=</span>&nbsp;<span class="ident" id="4376660">io</span><span class="op" id="4376662">.</span><span class="ident" id="4376663">ReadFull</span><span class="op" id="4376671">(</span><span class="ident" id="4376672">c</span><span class="op" id="4376673">.</span><span class="ident" id="4376674">config</span><span class="op" id="4376680">.</span><span class="ident" id="4376681">rand</span><span class="op" id="4376685">(</span><span class="op" id="4376686">)</span><span class="op" id="4376687">,</span>&nbsp;<span class="ident" id="4376689">hello</span><span class="op" id="4376694">.</span><span class="ident" id="4376695">sessionId</span><span class="op" id="4376704">)</span><span class="op" id="4376705">;</span>&nbsp;<span class="ident" id="4376707">err</span>&nbsp;<span class="op" id="4376711">!=</span>&nbsp;<span class="builtintype" id="4376714">nil</span>&nbsp;<span class="op" id="4376718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376723">c</span><span class="op" id="4376724">.</span><span class="ident" id="4376725">sendAlert</span><span class="op" id="4376734">(</span><span class="ident" id="4376735">alertInternalError</span><span class="op" id="4376753">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376758">return</span>&nbsp;<span class="ident" id="4376765">errors</span><span class="op" id="4376771">.</span><span class="ident" id="4376772">New</span><span class="op" id="4376775">(</span><span class="string" id="4376776">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4376806">+</span>&nbsp;<span class="ident" id="4376808">err</span><span class="op" id="4376811">.</span><span class="ident" id="4376812">Error</span><span class="op" id="4376817">(</span><span class="op" id="4376818">)</span><span class="op" id="4376819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376830">c</span><span class="op" id="4376831">.</span><span class="ident" id="4376832">writeRecord</span><span class="op" id="4376843">(</span><span class="ident" id="4376844">recordTypeHandshake</span><span class="op" id="4376863">,</span>&nbsp;<span class="ident" id="4376865">hello</span><span class="op" id="4376870">.</span><span class="ident" id="4376871">marshal</span><span class="op" id="4376878">(</span><span class="op" id="4376879">)</span><span class="op" id="4376880">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376884">msg</span><span class="op" id="4376887">,</span>&nbsp;<span class="ident" id="4376889">err</span>&nbsp;<span class="op" id="4376893">:=</span>&nbsp;<span class="ident" id="4376896">c</span><span class="op" id="4376897">.</span><span class="ident" id="4376898">readHandshake</span><span class="op" id="4376911">(</span><span class="op" id="4376912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376915">if</span>&nbsp;<span class="ident" id="4376918">err</span>&nbsp;<span class="op" id="4376922">!=</span>&nbsp;<span class="builtintype" id="4376925">nil</span>&nbsp;<span class="op" id="4376929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376933">return</span>&nbsp;<span class="ident" id="4376940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4376945">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4376948">serverHello</span><span class="op" id="4376959">,</span>&nbsp;<span class="ident" id="4376961">ok</span>&nbsp;<span class="op" id="4376964">:=</span>&nbsp;<span class="ident" id="4376967">msg</span><span class="op" id="4376970">.</span><span class="op" id="4376971">(</span><span class="op" id="4376972">*</span><span class="ident" id="4376973">serverHelloMsg</span><span class="op" id="4376987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4376990">if</span>&nbsp;<span class="op" id="4376993">!</span><span class="ident" id="4376994">ok</span>&nbsp;<span class="op" id="4376997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377001">c</span><span class="op" id="4377002">.</span><span class="ident" id="4377003">sendAlert</span><span class="op" id="4377012">(</span><span class="ident" id="4377013">alertUnexpectedMessage</span><span class="op" id="4377035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377039">return</span>&nbsp;<span class="ident" id="4377046">unexpectedMessageError</span><span class="op" id="4377068">(</span><span class="ident" id="4377069">serverHello</span><span class="op" id="4377080">,</span>&nbsp;<span class="ident" id="4377082">msg</span><span class="op" id="4377085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377088">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377092">vers</span><span class="op" id="4377096">,</span>&nbsp;<span class="ident" id="4377098">ok</span>&nbsp;<span class="op" id="4377101">:=</span>&nbsp;<span class="ident" id="4377104">c</span><span class="op" id="4377105">.</span><span class="ident" id="4377106">config</span><span class="op" id="4377112">.</span><span class="ident" id="4377113">mutualVersion</span><span class="op" id="4377126">(</span><span class="ident" id="4377127">serverHello</span><span class="op" id="4377138">.</span><span class="ident" id="4377139">vers</span><span class="op" id="4377143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377146">if</span>&nbsp;<span class="op" id="4377149">!</span><span class="ident" id="4377150">ok</span>&nbsp;<span class="op" id="4377153">||</span>&nbsp;<span class="ident" id="4377156">vers</span>&nbsp;<span class="op" id="4377161">&lt;</span>&nbsp;<span class="ident" id="4377163">VersionTLS10</span>&nbsp;<span class="op" id="4377176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4377180">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377239">c</span><span class="op" id="4377240">.</span><span class="ident" id="4377241">sendAlert</span><span class="op" id="4377250">(</span><span class="ident" id="4377251">alertProtocolVersion</span><span class="op" id="4377271">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377275">return</span>&nbsp;<span class="ident" id="4377282">fmt</span><span class="op" id="4377285">.</span><span class="ident" id="4377286">Errorf</span><span class="op" id="4377292">(</span><span class="string" id="4377293">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4377347">,</span>&nbsp;<span class="ident" id="4377349">serverHello</span><span class="op" id="4377360">.</span><span class="ident" id="4377361">vers</span><span class="op" id="4377365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377371">c</span><span class="op" id="4377372">.</span><span class="ident" id="4377373">vers</span>&nbsp;<span class="op" id="4377378">=</span>&nbsp;<span class="ident" id="4377380">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377386">c</span><span class="op" id="4377387">.</span><span class="ident" id="4377388">haveVers</span>&nbsp;<span class="op" id="4377397">=</span>&nbsp;<span class="builtintype" id="4377399">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377406">suite</span>&nbsp;<span class="op" id="4377412">:=</span>&nbsp;<span class="ident" id="4377415">mutualCipherSuite</span><span class="op" id="4377432">(</span><span class="ident" id="4377433">c</span><span class="op" id="4377434">.</span><span class="ident" id="4377435">config</span><span class="op" id="4377441">.</span><span class="ident" id="4377442">cipherSuites</span><span class="op" id="4377454">(</span><span class="op" id="4377455">)</span><span class="op" id="4377456">,</span>&nbsp;<span class="ident" id="4377458">serverHello</span><span class="op" id="4377469">.</span><span class="ident" id="4377470">cipherSuite</span><span class="op" id="4377481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377484">if</span>&nbsp;<span class="ident" id="4377487">suite</span>&nbsp;<span class="op" id="4377493">==</span>&nbsp;<span class="builtintype" id="4377496">nil</span>&nbsp;<span class="op" id="4377500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377504">c</span><span class="op" id="4377505">.</span><span class="ident" id="4377506">sendAlert</span><span class="op" id="4377515">(</span><span class="ident" id="4377516">alertHandshakeFailure</span><span class="op" id="4377537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377541">return</span>&nbsp;<span class="ident" id="4377548">fmt</span><span class="op" id="4377551">.</span><span class="ident" id="4377552">Errorf</span><span class="op" id="4377558">(</span><span class="string" id="4377559">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4377609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377612">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377616">hs</span>&nbsp;<span class="op" id="4377619">:=</span>&nbsp;<span class="op" id="4377622">&amp;</span><span class="ident" id="4377623">clientHandshakeState</span><span class="op" id="4377643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377647">c</span><span class="op" id="4377648">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377661">c</span><span class="op" id="4377662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377666">serverHello</span><span class="op" id="4377677">:</span>&nbsp;&nbsp;<span class="ident" id="4377680">serverHello</span><span class="op" id="4377691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377695">hello</span><span class="op" id="4377700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377709">hello</span><span class="op" id="4377714">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377718">suite</span><span class="op" id="4377723">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377732">suite</span><span class="op" id="4377737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377741">finishedHash</span><span class="op" id="4377753">:</span>&nbsp;<span class="ident" id="4377755">newFinishedHash</span><span class="op" id="4377770">(</span><span class="ident" id="4377771">c</span><span class="op" id="4377772">.</span><span class="ident" id="4377773">vers</span><span class="op" id="4377777">)</span><span class="op" id="4377778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377782">session</span><span class="op" id="4377789">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377796">session</span><span class="op" id="4377803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377810">hs</span><span class="op" id="4377812">.</span><span class="ident" id="4377813">finishedHash</span><span class="op" id="4377825">.</span><span class="ident" id="4377826">Write</span><span class="op" id="4377831">(</span><span class="ident" id="4377832">hs</span><span class="op" id="4377834">.</span><span class="ident" id="4377835">hello</span><span class="op" id="4377840">.</span><span class="ident" id="4377841">marshal</span><span class="op" id="4377848">(</span><span class="op" id="4377849">)</span><span class="op" id="4377850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377853">hs</span><span class="op" id="4377855">.</span><span class="ident" id="4377856">finishedHash</span><span class="op" id="4377868">.</span><span class="ident" id="4377869">Write</span><span class="op" id="4377874">(</span><span class="ident" id="4377875">hs</span><span class="op" id="4377877">.</span><span class="ident" id="4377878">serverHello</span><span class="op" id="4377889">.</span><span class="ident" id="4377890">marshal</span><span class="op" id="4377897">(</span><span class="op" id="4377898">)</span><span class="op" id="4377899">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4377903">isResume</span><span class="op" id="4377911">,</span>&nbsp;<span class="ident" id="4377913">err</span>&nbsp;<span class="op" id="4377917">:=</span>&nbsp;<span class="ident" id="4377920">hs</span><span class="op" id="4377922">.</span><span class="ident" id="4377923">processServerHello</span><span class="op" id="4377941">(</span><span class="op" id="4377942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377945">if</span>&nbsp;<span class="ident" id="4377948">err</span>&nbsp;<span class="op" id="4377952">!=</span>&nbsp;<span class="builtintype" id="4377955">nil</span>&nbsp;<span class="op" id="4377959">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377963">return</span>&nbsp;<span class="ident" id="4377970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4377975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377979">if</span>&nbsp;<span class="ident" id="4377982">isResume</span>&nbsp;<span class="op" id="4377991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4377995">if</span>&nbsp;<span class="ident" id="4377998">err</span>&nbsp;<span class="op" id="4378002">:=</span>&nbsp;<span class="ident" id="4378005">hs</span><span class="op" id="4378007">.</span><span class="ident" id="4378008">establishKeys</span><span class="op" id="4378021">(</span><span class="op" id="4378022">)</span><span class="op" id="4378023">;</span>&nbsp;<span class="ident" id="4378025">err</span>&nbsp;<span class="op" id="4378029">!=</span>&nbsp;<span class="builtintype" id="4378032">nil</span>&nbsp;<span class="op" id="4378036">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378041">return</span>&nbsp;<span class="ident" id="4378048">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378058">if</span>&nbsp;<span class="ident" id="4378061">err</span>&nbsp;<span class="op" id="4378065">:=</span>&nbsp;<span class="ident" id="4378068">hs</span><span class="op" id="4378070">.</span><span class="ident" id="4378071">readSessionTicket</span><span class="op" id="4378088">(</span><span class="op" id="4378089">)</span><span class="op" id="4378090">;</span>&nbsp;<span class="ident" id="4378092">err</span>&nbsp;<span class="op" id="4378096">!=</span>&nbsp;<span class="builtintype" id="4378099">nil</span>&nbsp;<span class="op" id="4378103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378108">return</span>&nbsp;<span class="ident" id="4378115">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378121">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378125">if</span>&nbsp;<span class="ident" id="4378128">err</span>&nbsp;<span class="op" id="4378132">:=</span>&nbsp;<span class="ident" id="4378135">hs</span><span class="op" id="4378137">.</span><span class="ident" id="4378138">readFinished</span><span class="op" id="4378150">(</span><span class="ident" id="4378151">c</span><span class="op" id="4378152">.</span><span class="ident" id="4378153">firstFinished</span><span class="op" id="4378166">[</span><span class="op" id="4378167">:</span><span class="op" id="4378168">]</span><span class="op" id="4378169">)</span><span class="op" id="4378170">;</span>&nbsp;<span class="ident" id="4378172">err</span>&nbsp;<span class="op" id="4378176">!=</span>&nbsp;<span class="builtintype" id="4378179">nil</span>&nbsp;<span class="op" id="4378183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378188">return</span>&nbsp;<span class="ident" id="4378195">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378205">if</span>&nbsp;<span class="ident" id="4378208">err</span>&nbsp;<span class="op" id="4378212">:=</span>&nbsp;<span class="ident" id="4378215">hs</span><span class="op" id="4378217">.</span><span class="ident" id="4378218">sendFinished</span><span class="op" id="4378230">(</span><span class="builtintype" id="4378231">nil</span><span class="op" id="4378234">)</span><span class="op" id="4378235">;</span>&nbsp;<span class="ident" id="4378237">err</span>&nbsp;<span class="op" id="4378241">!=</span>&nbsp;<span class="builtintype" id="4378244">nil</span>&nbsp;<span class="op" id="4378248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378253">return</span>&nbsp;<span class="ident" id="4378260">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378269">}</span>&nbsp;<span class="keyword" id="4378271">else</span>&nbsp;<span class="op" id="4378276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378280">if</span>&nbsp;<span class="ident" id="4378283">err</span>&nbsp;<span class="op" id="4378287">:=</span>&nbsp;<span class="ident" id="4378290">hs</span><span class="op" id="4378292">.</span><span class="ident" id="4378293">doFullHandshake</span><span class="op" id="4378308">(</span><span class="op" id="4378309">)</span><span class="op" id="4378310">;</span>&nbsp;<span class="ident" id="4378312">err</span>&nbsp;<span class="op" id="4378316">!=</span>&nbsp;<span class="builtintype" id="4378319">nil</span>&nbsp;<span class="op" id="4378323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378328">return</span>&nbsp;<span class="ident" id="4378335">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378341">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378345">if</span>&nbsp;<span class="ident" id="4378348">err</span>&nbsp;<span class="op" id="4378352">:=</span>&nbsp;<span class="ident" id="4378355">hs</span><span class="op" id="4378357">.</span><span class="ident" id="4378358">establishKeys</span><span class="op" id="4378371">(</span><span class="op" id="4378372">)</span><span class="op" id="4378373">;</span>&nbsp;<span class="ident" id="4378375">err</span>&nbsp;<span class="op" id="4378379">!=</span>&nbsp;<span class="builtintype" id="4378382">nil</span>&nbsp;<span class="op" id="4378386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378391">return</span>&nbsp;<span class="ident" id="4378398">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378408">if</span>&nbsp;<span class="ident" id="4378411">err</span>&nbsp;<span class="op" id="4378415">:=</span>&nbsp;<span class="ident" id="4378418">hs</span><span class="op" id="4378420">.</span><span class="ident" id="4378421">sendFinished</span><span class="op" id="4378433">(</span><span class="ident" id="4378434">c</span><span class="op" id="4378435">.</span><span class="ident" id="4378436">firstFinished</span><span class="op" id="4378449">[</span><span class="op" id="4378450">:</span><span class="op" id="4378451">]</span><span class="op" id="4378452">)</span><span class="op" id="4378453">;</span>&nbsp;<span class="ident" id="4378455">err</span>&nbsp;<span class="op" id="4378459">!=</span>&nbsp;<span class="builtintype" id="4378462">nil</span>&nbsp;<span class="op" id="4378466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378471">return</span>&nbsp;<span class="ident" id="4378478">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378488">if</span>&nbsp;<span class="ident" id="4378491">err</span>&nbsp;<span class="op" id="4378495">:=</span>&nbsp;<span class="ident" id="4378498">hs</span><span class="op" id="4378500">.</span><span class="ident" id="4378501">readSessionTicket</span><span class="op" id="4378518">(</span><span class="op" id="4378519">)</span><span class="op" id="4378520">;</span>&nbsp;<span class="ident" id="4378522">err</span>&nbsp;<span class="op" id="4378526">!=</span>&nbsp;<span class="builtintype" id="4378529">nil</span>&nbsp;<span class="op" id="4378533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378538">return</span>&nbsp;<span class="ident" id="4378545">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378555">if</span>&nbsp;<span class="ident" id="4378558">err</span>&nbsp;<span class="op" id="4378562">:=</span>&nbsp;<span class="ident" id="4378565">hs</span><span class="op" id="4378567">.</span><span class="ident" id="4378568">readFinished</span><span class="op" id="4378580">(</span><span class="builtintype" id="4378581">nil</span><span class="op" id="4378584">)</span><span class="op" id="4378585">;</span>&nbsp;<span class="ident" id="4378587">err</span>&nbsp;<span class="op" id="4378591">!=</span>&nbsp;<span class="builtintype" id="4378594">nil</span>&nbsp;<span class="op" id="4378598">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378603">return</span>&nbsp;<span class="ident" id="4378610">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378623">if</span>&nbsp;<span class="ident" id="4378626">sessionCache</span>&nbsp;<span class="op" id="4378639">!=</span>&nbsp;<span class="builtintype" id="4378642">nil</span>&nbsp;<span class="op" id="4378646">&amp;&amp;</span>&nbsp;<span class="ident" id="4378649">hs</span><span class="op" id="4378651">.</span><span class="ident" id="4378652">session</span>&nbsp;<span class="op" id="4378660">!=</span>&nbsp;<span class="builtintype" id="4378663">nil</span>&nbsp;<span class="op" id="4378667">&amp;&amp;</span>&nbsp;<span class="ident" id="4378670">session</span>&nbsp;<span class="op" id="4378678">!=</span>&nbsp;<span class="ident" id="4378681">hs</span><span class="op" id="4378683">.</span><span class="ident" id="4378684">session</span>&nbsp;<span class="op" id="4378692">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378696">sessionCache</span><span class="op" id="4378708">.</span><span class="ident" id="4378709">Put</span><span class="op" id="4378712">(</span><span class="ident" id="4378713">cacheKey</span><span class="op" id="4378721">,</span>&nbsp;<span class="ident" id="4378723">hs</span><span class="op" id="4378725">.</span><span class="ident" id="4378726">session</span><span class="op" id="4378733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378740">c</span><span class="op" id="4378741">.</span><span class="ident" id="4378742">didResume</span>&nbsp;<span class="op" id="4378752">=</span>&nbsp;<span class="ident" id="4378754">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378764">c</span><span class="op" id="4378765">.</span><span class="ident" id="4378766">handshakeComplete</span>&nbsp;<span class="op" id="4378784">=</span>&nbsp;<span class="builtintype" id="4378786">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378792">c</span><span class="op" id="4378793">.</span><span class="ident" id="4378794">cipherSuite</span>&nbsp;<span class="op" id="4378806">=</span>&nbsp;<span class="ident" id="4378808">suite</span><span class="op" id="4378813">.</span><span class="ident" id="4378814">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378818">return</span>&nbsp;<span class="builtintype" id="4378825">nil</span><br>
<span class="lineno"></span><span class="op" id="4378829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4378832">func</span>&nbsp;<span class="op" id="4378837">(</span><span class="ident" id="4378838">hs</span>&nbsp;<span class="op" id="4378841">*</span><span class="ident" id="4378842">clientHandshakeState</span><span class="op" id="4378862">)</span>&nbsp;<span class="ident" id="4378864">doFullHandshake</span><span class="op" id="4378879">(</span><span class="op" id="4378880">)</span>&nbsp;<span class="builtintype" id="4378882">error</span>&nbsp;<span class="op" id="4378888">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378891">c</span>&nbsp;<span class="op" id="4378893">:=</span>&nbsp;<span class="ident" id="4378896">hs</span><span class="op" id="4378898">.</span><span class="ident" id="4378899">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378903">msg</span><span class="op" id="4378906">,</span>&nbsp;<span class="ident" id="4378908">err</span>&nbsp;<span class="op" id="4378912">:=</span>&nbsp;<span class="ident" id="4378915">c</span><span class="op" id="4378916">.</span><span class="ident" id="4378917">readHandshake</span><span class="op" id="4378930">(</span><span class="op" id="4378931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378934">if</span>&nbsp;<span class="ident" id="4378937">err</span>&nbsp;<span class="op" id="4378941">!=</span>&nbsp;<span class="builtintype" id="4378944">nil</span>&nbsp;<span class="op" id="4378948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4378952">return</span>&nbsp;<span class="ident" id="4378959">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4378964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4378967">certMsg</span><span class="op" id="4378974">,</span>&nbsp;<span class="ident" id="4378976">ok</span>&nbsp;<span class="op" id="4378979">:=</span>&nbsp;<span class="ident" id="4378982">msg</span><span class="op" id="4378985">.</span><span class="op" id="4378986">(</span><span class="op" id="4378987">*</span><span class="ident" id="4378988">certificateMsg</span><span class="op" id="4379002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379005">if</span>&nbsp;<span class="op" id="4379008">!</span><span class="ident" id="4379009">ok</span>&nbsp;<span class="op" id="4379012">||</span>&nbsp;<span class="builtinfunc" id="4379015">len</span><span class="op" id="4379018">(</span><span class="ident" id="4379019">certMsg</span><span class="op" id="4379026">.</span><span class="ident" id="4379027">certificates</span><span class="op" id="4379039">)</span>&nbsp;<span class="op" id="4379041">==</span>&nbsp;<span class="num" id="4379044">0</span>&nbsp;<span class="op" id="4379046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379050">c</span><span class="op" id="4379051">.</span><span class="ident" id="4379052">sendAlert</span><span class="op" id="4379061">(</span><span class="ident" id="4379062">alertUnexpectedMessage</span><span class="op" id="4379084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379088">return</span>&nbsp;<span class="ident" id="4379095">unexpectedMessageError</span><span class="op" id="4379117">(</span><span class="ident" id="4379118">certMsg</span><span class="op" id="4379125">,</span>&nbsp;<span class="ident" id="4379127">msg</span><span class="op" id="4379130">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379136">hs</span><span class="op" id="4379138">.</span><span class="ident" id="4379139">finishedHash</span><span class="op" id="4379151">.</span><span class="ident" id="4379152">Write</span><span class="op" id="4379157">(</span><span class="ident" id="4379158">certMsg</span><span class="op" id="4379165">.</span><span class="ident" id="4379166">marshal</span><span class="op" id="4379173">(</span><span class="op" id="4379174">)</span><span class="op" id="4379175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379179">certs</span>&nbsp;<span class="op" id="4379185">:=</span>&nbsp;<span class="builtinfunc" id="4379188">make</span><span class="op" id="4379192">(</span><span class="op" id="4379193">[</span><span class="op" id="4379194">]</span><span class="op" id="4379195">*</span><span class="ident" id="4379196">x509</span><span class="op" id="4379200">.</span><span class="ident" id="4379201">Certificate</span><span class="op" id="4379212">,</span>&nbsp;<span class="builtinfunc" id="4379214">len</span><span class="op" id="4379217">(</span><span class="ident" id="4379218">certMsg</span><span class="op" id="4379225">.</span><span class="ident" id="4379226">certificates</span><span class="op" id="4379238">)</span><span class="op" id="4379239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379242">for</span>&nbsp;<span class="ident" id="4379246">i</span><span class="op" id="4379247">,</span>&nbsp;<span class="ident" id="4379249">asn1Data</span>&nbsp;<span class="op" id="4379258">:=</span>&nbsp;<span class="keyword" id="4379261">range</span>&nbsp;<span class="ident" id="4379267">certMsg</span><span class="op" id="4379274">.</span><span class="ident" id="4379275">certificates</span>&nbsp;<span class="op" id="4379288">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379292">cert</span><span class="op" id="4379296">,</span>&nbsp;<span class="ident" id="4379298">err</span>&nbsp;<span class="op" id="4379302">:=</span>&nbsp;<span class="ident" id="4379305">x509</span><span class="op" id="4379309">.</span><span class="ident" id="4379310">ParseCertificate</span><span class="op" id="4379326">(</span><span class="ident" id="4379327">asn1Data</span><span class="op" id="4379335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379339">if</span>&nbsp;<span class="ident" id="4379342">err</span>&nbsp;<span class="op" id="4379346">!=</span>&nbsp;<span class="builtintype" id="4379349">nil</span>&nbsp;<span class="op" id="4379353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379358">c</span><span class="op" id="4379359">.</span><span class="ident" id="4379360">sendAlert</span><span class="op" id="4379369">(</span><span class="ident" id="4379370">alertBadCertificate</span><span class="op" id="4379389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379394">return</span>&nbsp;<span class="ident" id="4379401">errors</span><span class="op" id="4379407">.</span><span class="ident" id="4379408">New</span><span class="op" id="4379411">(</span><span class="string" id="4379412">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4379461">+</span>&nbsp;<span class="ident" id="4379463">err</span><span class="op" id="4379466">.</span><span class="ident" id="4379467">Error</span><span class="op" id="4379472">(</span><span class="op" id="4379473">)</span><span class="op" id="4379474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379478">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379482">certs</span><span class="op" id="4379487">[</span><span class="ident" id="4379488">i</span><span class="op" id="4379489">]</span>&nbsp;<span class="op" id="4379491">=</span>&nbsp;<span class="ident" id="4379493">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379503">if</span>&nbsp;<span class="op" id="4379506">!</span><span class="ident" id="4379507">c</span><span class="op" id="4379508">.</span><span class="ident" id="4379509">config</span><span class="op" id="4379515">.</span><span class="ident" id="4379516">InsecureSkipVerify</span>&nbsp;<span class="op" id="4379535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379539">opts</span>&nbsp;<span class="op" id="4379544">:=</span>&nbsp;<span class="ident" id="4379547">x509</span><span class="op" id="4379551">.</span><span class="ident" id="4379552">VerifyOptions</span><span class="op" id="4379565">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379570">Roots</span><span class="op" id="4379575">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379585">c</span><span class="op" id="4379586">.</span><span class="ident" id="4379587">config</span><span class="op" id="4379593">.</span><span class="ident" id="4379594">RootCAs</span><span class="op" id="4379601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379606">CurrentTime</span><span class="op" id="4379617">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4379621">c</span><span class="op" id="4379622">.</span><span class="ident" id="4379623">config</span><span class="op" id="4379629">.</span><span class="ident" id="4379630">time</span><span class="op" id="4379634">(</span><span class="op" id="4379635">)</span><span class="op" id="4379636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379641">DNSName</span><span class="op" id="4379648">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379656">c</span><span class="op" id="4379657">.</span><span class="ident" id="4379658">config</span><span class="op" id="4379664">.</span><span class="ident" id="4379665">ServerName</span><span class="op" id="4379675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379680">Intermediates</span><span class="op" id="4379693">:</span>&nbsp;<span class="ident" id="4379695">x509</span><span class="op" id="4379699">.</span><span class="ident" id="4379700">NewCertPool</span><span class="op" id="4379711">(</span><span class="op" id="4379712">)</span><span class="op" id="4379713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379717">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379722">for</span>&nbsp;<span class="ident" id="4379726">i</span><span class="op" id="4379727">,</span>&nbsp;<span class="ident" id="4379729">cert</span>&nbsp;<span class="op" id="4379734">:=</span>&nbsp;<span class="keyword" id="4379737">range</span>&nbsp;<span class="ident" id="4379743">certs</span>&nbsp;<span class="op" id="4379749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379754">if</span>&nbsp;<span class="ident" id="4379757">i</span>&nbsp;<span class="op" id="4379759">==</span>&nbsp;<span class="num" id="4379762">0</span>&nbsp;<span class="op" id="4379764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379770">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379782">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379787">opts</span><span class="op" id="4379791">.</span><span class="ident" id="4379792">Intermediates</span><span class="op" id="4379805">.</span><span class="ident" id="4379806">AddCert</span><span class="op" id="4379813">(</span><span class="ident" id="4379814">cert</span><span class="op" id="4379818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379826">c</span><span class="op" id="4379827">.</span><span class="ident" id="4379828">verifiedChains</span><span class="op" id="4379842">,</span>&nbsp;<span class="ident" id="4379844">err</span>&nbsp;<span class="op" id="4379848">=</span>&nbsp;<span class="ident" id="4379850">certs</span><span class="op" id="4379855">[</span><span class="num" id="4379856">0</span><span class="op" id="4379857">]</span><span class="op" id="4379858">.</span><span class="ident" id="4379859">Verify</span><span class="op" id="4379865">(</span><span class="ident" id="4379866">opts</span><span class="op" id="4379870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379874">if</span>&nbsp;<span class="ident" id="4379877">err</span>&nbsp;<span class="op" id="4379881">!=</span>&nbsp;<span class="builtintype" id="4379884">nil</span>&nbsp;<span class="op" id="4379888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4379893">c</span><span class="op" id="4379894">.</span><span class="ident" id="4379895">sendAlert</span><span class="op" id="4379904">(</span><span class="ident" id="4379905">alertBadCertificate</span><span class="op" id="4379924">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379929">return</span>&nbsp;<span class="ident" id="4379936">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4379945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379949">switch</span>&nbsp;<span class="ident" id="4379956">certs</span><span class="op" id="4379961">[</span><span class="num" id="4379962">0</span><span class="op" id="4379963">]</span><span class="op" id="4379964">.</span><span class="ident" id="4379965">PublicKey</span><span class="op" id="4379974">.</span><span class="op" id="4379975">(</span><span class="keyword" id="4379976">type</span><span class="op" id="4379980">)</span>&nbsp;<span class="op" id="4379982">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4379985">case</span>&nbsp;<span class="op" id="4379990">*</span><span class="ident" id="4379991">rsa</span><span class="op" id="4379994">.</span><span class="ident" id="4379995">PublicKey</span><span class="op" id="4380004">,</span>&nbsp;<span class="op" id="4380006">*</span><span class="ident" id="4380007">ecdsa</span><span class="op" id="4380012">.</span><span class="ident" id="4380013">PublicKey</span><span class="op" id="4380022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380026">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380033">default</span><span class="op" id="4380040">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380044">c</span><span class="op" id="4380045">.</span><span class="ident" id="4380046">sendAlert</span><span class="op" id="4380055">(</span><span class="ident" id="4380056">alertUnsupportedCertificate</span><span class="op" id="4380083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380087">return</span>&nbsp;<span class="ident" id="4380094">fmt</span><span class="op" id="4380097">.</span><span class="ident" id="4380098">Errorf</span><span class="op" id="4380104">(</span><span class="string" id="4380105">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4380179">,</span>&nbsp;<span class="ident" id="4380181">certs</span><span class="op" id="4380186">[</span><span class="num" id="4380187">0</span><span class="op" id="4380188">]</span><span class="op" id="4380189">.</span><span class="ident" id="4380190">PublicKey</span><span class="op" id="4380199">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380206">c</span><span class="op" id="4380207">.</span><span class="ident" id="4380208">peerCertificates</span>&nbsp;<span class="op" id="4380225">=</span>&nbsp;<span class="ident" id="4380227">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380235">if</span>&nbsp;<span class="ident" id="4380238">hs</span><span class="op" id="4380240">.</span><span class="ident" id="4380241">serverHello</span><span class="op" id="4380252">.</span><span class="ident" id="4380253">ocspStapling</span>&nbsp;<span class="op" id="4380266">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380270">msg</span><span class="op" id="4380273">,</span>&nbsp;<span class="ident" id="4380275">err</span>&nbsp;<span class="op" id="4380279">=</span>&nbsp;<span class="ident" id="4380281">c</span><span class="op" id="4380282">.</span><span class="ident" id="4380283">readHandshake</span><span class="op" id="4380296">(</span><span class="op" id="4380297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380301">if</span>&nbsp;<span class="ident" id="4380304">err</span>&nbsp;<span class="op" id="4380308">!=</span>&nbsp;<span class="builtintype" id="4380311">nil</span>&nbsp;<span class="op" id="4380315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380320">return</span>&nbsp;<span class="ident" id="4380327">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380337">cs</span><span class="op" id="4380339">,</span>&nbsp;<span class="ident" id="4380341">ok</span>&nbsp;<span class="op" id="4380344">:=</span>&nbsp;<span class="ident" id="4380347">msg</span><span class="op" id="4380350">.</span><span class="op" id="4380351">(</span><span class="op" id="4380352">*</span><span class="ident" id="4380353">certificateStatusMsg</span><span class="op" id="4380373">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380377">if</span>&nbsp;<span class="op" id="4380380">!</span><span class="ident" id="4380381">ok</span>&nbsp;<span class="op" id="4380384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380389">c</span><span class="op" id="4380390">.</span><span class="ident" id="4380391">sendAlert</span><span class="op" id="4380400">(</span><span class="ident" id="4380401">alertUnexpectedMessage</span><span class="op" id="4380423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380428">return</span>&nbsp;<span class="ident" id="4380435">unexpectedMessageError</span><span class="op" id="4380457">(</span><span class="ident" id="4380458">cs</span><span class="op" id="4380460">,</span>&nbsp;<span class="ident" id="4380462">msg</span><span class="op" id="4380465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380473">hs</span><span class="op" id="4380475">.</span><span class="ident" id="4380476">finishedHash</span><span class="op" id="4380488">.</span><span class="ident" id="4380489">Write</span><span class="op" id="4380494">(</span><span class="ident" id="4380495">cs</span><span class="op" id="4380497">.</span><span class="ident" id="4380498">marshal</span><span class="op" id="4380505">(</span><span class="op" id="4380506">)</span><span class="op" id="4380507">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380512">if</span>&nbsp;<span class="ident" id="4380515">cs</span><span class="op" id="4380517">.</span><span class="ident" id="4380518">statusType</span>&nbsp;<span class="op" id="4380529">==</span>&nbsp;<span class="ident" id="4380532">statusTypeOCSP</span>&nbsp;<span class="op" id="4380547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380552">c</span><span class="op" id="4380553">.</span><span class="ident" id="4380554">ocspResponse</span>&nbsp;<span class="op" id="4380567">=</span>&nbsp;<span class="ident" id="4380569">cs</span><span class="op" id="4380571">.</span><span class="ident" id="4380572">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380586">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380590">msg</span><span class="op" id="4380593">,</span>&nbsp;<span class="ident" id="4380595">err</span>&nbsp;<span class="op" id="4380599">=</span>&nbsp;<span class="ident" id="4380601">c</span><span class="op" id="4380602">.</span><span class="ident" id="4380603">readHandshake</span><span class="op" id="4380616">(</span><span class="op" id="4380617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380620">if</span>&nbsp;<span class="ident" id="4380623">err</span>&nbsp;<span class="op" id="4380627">!=</span>&nbsp;<span class="builtintype" id="4380630">nil</span>&nbsp;<span class="op" id="4380634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380638">return</span>&nbsp;<span class="ident" id="4380645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380650">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380654">keyAgreement</span>&nbsp;<span class="op" id="4380667">:=</span>&nbsp;<span class="ident" id="4380670">hs</span><span class="op" id="4380672">.</span><span class="ident" id="4380673">suite</span><span class="op" id="4380678">.</span><span class="ident" id="4380679">ka</span><span class="op" id="4380681">(</span><span class="ident" id="4380682">c</span><span class="op" id="4380683">.</span><span class="ident" id="4380684">vers</span><span class="op" id="4380688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380692">skx</span><span class="op" id="4380695">,</span>&nbsp;<span class="ident" id="4380697">ok</span>&nbsp;<span class="op" id="4380700">:=</span>&nbsp;<span class="ident" id="4380703">msg</span><span class="op" id="4380706">.</span><span class="op" id="4380707">(</span><span class="op" id="4380708">*</span><span class="ident" id="4380709">serverKeyExchangeMsg</span><span class="op" id="4380729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380732">if</span>&nbsp;<span class="ident" id="4380735">ok</span>&nbsp;<span class="op" id="4380738">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380742">hs</span><span class="op" id="4380744">.</span><span class="ident" id="4380745">finishedHash</span><span class="op" id="4380757">.</span><span class="ident" id="4380758">Write</span><span class="op" id="4380763">(</span><span class="ident" id="4380764">skx</span><span class="op" id="4380767">.</span><span class="ident" id="4380768">marshal</span><span class="op" id="4380775">(</span><span class="op" id="4380776">)</span><span class="op" id="4380777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380781">err</span>&nbsp;<span class="op" id="4380785">=</span>&nbsp;<span class="ident" id="4380787">keyAgreement</span><span class="op" id="4380799">.</span><span class="ident" id="4380800">processServerKeyExchange</span><span class="op" id="4380824">(</span><span class="ident" id="4380825">c</span><span class="op" id="4380826">.</span><span class="ident" id="4380827">config</span><span class="op" id="4380833">,</span>&nbsp;<span class="ident" id="4380835">hs</span><span class="op" id="4380837">.</span><span class="ident" id="4380838">hello</span><span class="op" id="4380843">,</span>&nbsp;<span class="ident" id="4380845">hs</span><span class="op" id="4380847">.</span><span class="ident" id="4380848">serverHello</span><span class="op" id="4380859">,</span>&nbsp;<span class="ident" id="4380861">certs</span><span class="op" id="4380866">[</span><span class="num" id="4380867">0</span><span class="op" id="4380868">]</span><span class="op" id="4380869">,</span>&nbsp;<span class="ident" id="4380871">skx</span><span class="op" id="4380874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380878">if</span>&nbsp;<span class="ident" id="4380881">err</span>&nbsp;<span class="op" id="4380885">!=</span>&nbsp;<span class="builtintype" id="4380888">nil</span>&nbsp;<span class="op" id="4380892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380897">c</span><span class="op" id="4380898">.</span><span class="ident" id="4380899">sendAlert</span><span class="op" id="4380908">(</span><span class="ident" id="4380909">alertUnexpectedMessage</span><span class="op" id="4380931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380936">return</span>&nbsp;<span class="ident" id="4380943">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4380949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4380954">msg</span><span class="op" id="4380957">,</span>&nbsp;<span class="ident" id="4380959">err</span>&nbsp;<span class="op" id="4380963">=</span>&nbsp;<span class="ident" id="4380965">c</span><span class="op" id="4380966">.</span><span class="ident" id="4380967">readHandshake</span><span class="op" id="4380980">(</span><span class="op" id="4380981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4380985">if</span>&nbsp;<span class="ident" id="4380988">err</span>&nbsp;<span class="op" id="4380992">!=</span>&nbsp;<span class="builtintype" id="4380995">nil</span>&nbsp;<span class="op" id="4380999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381004">return</span>&nbsp;<span class="ident" id="4381011">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4381017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4381020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381024">var</span>&nbsp;<span class="ident" id="4381028">chainToSend</span>&nbsp;<span class="op" id="4381040">*</span><span class="ident" id="4381041">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381054">var</span>&nbsp;<span class="ident" id="4381058">certRequested</span>&nbsp;<span class="builtintype" id="4381072">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4381078">certReq</span><span class="op" id="4381085">,</span>&nbsp;<span class="ident" id="4381087">ok</span>&nbsp;<span class="op" id="4381090">:=</span>&nbsp;<span class="ident" id="4381093">msg</span><span class="op" id="4381096">.</span><span class="op" id="4381097">(</span><span class="op" id="4381098">*</span><span class="ident" id="4381099">certificateRequestMsg</span><span class="op" id="4381120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381123">if</span>&nbsp;<span class="ident" id="4381126">ok</span>&nbsp;<span class="op" id="4381129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4381133">certRequested</span>&nbsp;<span class="op" id="4381147">=</span>&nbsp;<span class="builtintype" id="4381149">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381157">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381208">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381273">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381339">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381402">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381467">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381514">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381577">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381622">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381680">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4381715">hs</span><span class="op" id="4381717">.</span><span class="ident" id="4381718">finishedHash</span><span class="op" id="4381730">.</span><span class="ident" id="4381731">Write</span><span class="op" id="4381736">(</span><span class="ident" id="4381737">certReq</span><span class="op" id="4381744">.</span><span class="ident" id="4381745">marshal</span><span class="op" id="4381752">(</span><span class="op" id="4381753">)</span><span class="op" id="4381754">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381759">var</span>&nbsp;<span class="ident" id="4381763">rsaAvail</span><span class="op" id="4381771">,</span>&nbsp;<span class="ident" id="4381773">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4381784">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381791">for</span>&nbsp;<span class="ident" id="4381795">_</span><span class="op" id="4381796">,</span>&nbsp;<span class="ident" id="4381798">certType</span>&nbsp;<span class="op" id="4381807">:=</span>&nbsp;<span class="keyword" id="4381810">range</span>&nbsp;<span class="ident" id="4381816">certReq</span><span class="op" id="4381823">.</span><span class="ident" id="4381824">certificateTypes</span>&nbsp;<span class="op" id="4381841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381846">switch</span>&nbsp;<span class="ident" id="4381853">certType</span>&nbsp;<span class="op" id="4381862">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381867">case</span>&nbsp;<span class="ident" id="4381872">certTypeRSASign</span><span class="op" id="4381887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4381893">rsaAvail</span>&nbsp;<span class="op" id="4381902">=</span>&nbsp;<span class="builtintype" id="4381904">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4381912">case</span>&nbsp;<span class="ident" id="4381917">certTypeECDSASign</span><span class="op" id="4381934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4381940">ecdsaAvail</span>&nbsp;<span class="op" id="4381951">=</span>&nbsp;<span class="builtintype" id="4381953">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4381961">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4381965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4381970">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382026">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382092">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4382140">findCert</span><span class="op" id="4382148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382152">for</span>&nbsp;<span class="ident" id="4382156">i</span><span class="op" id="4382157">,</span>&nbsp;<span class="ident" id="4382159">chain</span>&nbsp;<span class="op" id="4382165">:=</span>&nbsp;<span class="keyword" id="4382168">range</span>&nbsp;<span class="ident" id="4382174">c</span><span class="op" id="4382175">.</span><span class="ident" id="4382176">config</span><span class="op" id="4382182">.</span><span class="ident" id="4382183">Certificates</span>&nbsp;<span class="op" id="4382196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382201">if</span>&nbsp;<span class="op" id="4382204">!</span><span class="ident" id="4382205">rsaAvail</span>&nbsp;<span class="op" id="4382214">&amp;&amp;</span>&nbsp;<span class="op" id="4382217">!</span><span class="ident" id="4382218">ecdsaAvail</span>&nbsp;<span class="op" id="4382229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382235">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4382247">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382253">for</span>&nbsp;<span class="ident" id="4382257">j</span><span class="op" id="4382258">,</span>&nbsp;<span class="ident" id="4382260">cert</span>&nbsp;<span class="op" id="4382265">:=</span>&nbsp;<span class="keyword" id="4382268">range</span>&nbsp;<span class="ident" id="4382274">chain</span><span class="op" id="4382279">.</span><span class="ident" id="4382280">Certificate</span>&nbsp;<span class="op" id="4382292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4382298">x509Cert</span>&nbsp;<span class="op" id="4382307">:=</span>&nbsp;<span class="ident" id="4382310">chain</span><span class="op" id="4382315">.</span><span class="ident" id="4382316">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382325">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382377">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382415">if</span>&nbsp;<span class="ident" id="4382418">j</span>&nbsp;<span class="op" id="4382420">!=</span>&nbsp;<span class="num" id="4382423">0</span>&nbsp;<span class="op" id="4382425">||</span>&nbsp;<span class="ident" id="4382428">x509Cert</span>&nbsp;<span class="op" id="4382437">==</span>&nbsp;<span class="builtintype" id="4382440">nil</span>&nbsp;<span class="op" id="4382444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382451">if</span>&nbsp;<span class="ident" id="4382454">x509Cert</span><span class="op" id="4382462">,</span>&nbsp;<span class="ident" id="4382464">err</span>&nbsp;<span class="op" id="4382468">=</span>&nbsp;<span class="ident" id="4382470">x509</span><span class="op" id="4382474">.</span><span class="ident" id="4382475">ParseCertificate</span><span class="op" id="4382491">(</span><span class="ident" id="4382492">cert</span><span class="op" id="4382496">)</span><span class="op" id="4382497">;</span>&nbsp;<span class="ident" id="4382499">err</span>&nbsp;<span class="op" id="4382503">!=</span>&nbsp;<span class="builtintype" id="4382506">nil</span>&nbsp;<span class="op" id="4382510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4382518">c</span><span class="op" id="4382519">.</span><span class="ident" id="4382520">sendAlert</span><span class="op" id="4382529">(</span><span class="ident" id="4382530">alertInternalError</span><span class="op" id="4382548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382556">return</span>&nbsp;<span class="ident" id="4382563">errors</span><span class="op" id="4382569">.</span><span class="ident" id="4382570">New</span><span class="op" id="4382573">(</span><span class="string" id="4382574">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4382618">+</span>&nbsp;<span class="ident" id="4382620">strconv</span><span class="op" id="4382627">.</span><span class="ident" id="4382628">Itoa</span><span class="op" id="4382632">(</span><span class="ident" id="4382633">i</span><span class="op" id="4382634">)</span>&nbsp;<span class="op" id="4382636">+</span>&nbsp;<span class="string" id="4382638">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4382643">+</span>&nbsp;<span class="ident" id="4382645">err</span><span class="op" id="4382648">.</span><span class="ident" id="4382649">Error</span><span class="op" id="4382654">(</span><span class="op" id="4382655">)</span><span class="op" id="4382656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4382663">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4382669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382676">switch</span>&nbsp;<span class="op" id="4382683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382689">case</span>&nbsp;<span class="ident" id="4382694">rsaAvail</span>&nbsp;<span class="op" id="4382703">&amp;&amp;</span>&nbsp;<span class="ident" id="4382706">x509Cert</span><span class="op" id="4382714">.</span><span class="ident" id="4382715">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4382734">==</span>&nbsp;<span class="ident" id="4382737">x509</span><span class="op" id="4382741">.</span><span class="ident" id="4382742">RSA</span><span class="op" id="4382745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382751">case</span>&nbsp;<span class="ident" id="4382756">ecdsaAvail</span>&nbsp;<span class="op" id="4382767">&amp;&amp;</span>&nbsp;<span class="ident" id="4382770">x509Cert</span><span class="op" id="4382778">.</span><span class="ident" id="4382779">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4382798">==</span>&nbsp;<span class="ident" id="4382801">x509</span><span class="op" id="4382805">.</span><span class="ident" id="4382806">ECDSA</span><span class="op" id="4382811">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382817">default</span><span class="op" id="4382824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382831">continue</span>&nbsp;<span class="ident" id="4382840">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4382853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4382860">if</span>&nbsp;<span class="builtinfunc" id="4382863">len</span><span class="op" id="4382866">(</span><span class="ident" id="4382867">certReq</span><span class="op" id="4382874">.</span><span class="ident" id="4382875">certificateAuthorities</span><span class="op" id="4382897">)</span>&nbsp;<span class="op" id="4382899">==</span>&nbsp;<span class="num" id="4382902">0</span>&nbsp;<span class="op" id="4382904">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382911">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4382964">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383010">chainToSend</span>&nbsp;<span class="op" id="4383022">=</span>&nbsp;<span class="op" id="4383024">&amp;</span><span class="ident" id="4383025">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383036">break</span>&nbsp;<span class="ident" id="4383042">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383055">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383062">for</span>&nbsp;<span class="ident" id="4383066">_</span><span class="op" id="4383067">,</span>&nbsp;<span class="ident" id="4383069">ca</span>&nbsp;<span class="op" id="4383072">:=</span>&nbsp;<span class="keyword" id="4383075">range</span>&nbsp;<span class="ident" id="4383081">certReq</span><span class="op" id="4383088">.</span><span class="ident" id="4383089">certificateAuthorities</span>&nbsp;<span class="op" id="4383112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383119">if</span>&nbsp;<span class="ident" id="4383122">bytes</span><span class="op" id="4383127">.</span><span class="ident" id="4383128">Equal</span><span class="op" id="4383133">(</span><span class="ident" id="4383134">x509Cert</span><span class="op" id="4383142">.</span><span class="ident" id="4383143">RawIssuer</span><span class="op" id="4383152">,</span>&nbsp;<span class="ident" id="4383154">ca</span><span class="op" id="4383156">)</span>&nbsp;<span class="op" id="4383158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383166">chainToSend</span>&nbsp;<span class="op" id="4383178">=</span>&nbsp;<span class="op" id="4383180">&amp;</span><span class="ident" id="4383181">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383193">break</span>&nbsp;<span class="ident" id="4383199">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383233">msg</span><span class="op" id="4383236">,</span>&nbsp;<span class="ident" id="4383238">err</span>&nbsp;<span class="op" id="4383242">=</span>&nbsp;<span class="ident" id="4383244">c</span><span class="op" id="4383245">.</span><span class="ident" id="4383246">readHandshake</span><span class="op" id="4383259">(</span><span class="op" id="4383260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383264">if</span>&nbsp;<span class="ident" id="4383267">err</span>&nbsp;<span class="op" id="4383271">!=</span>&nbsp;<span class="builtintype" id="4383274">nil</span>&nbsp;<span class="op" id="4383278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383283">return</span>&nbsp;<span class="ident" id="4383290">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383299">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383303">shd</span><span class="op" id="4383306">,</span>&nbsp;<span class="ident" id="4383308">ok</span>&nbsp;<span class="op" id="4383311">:=</span>&nbsp;<span class="ident" id="4383314">msg</span><span class="op" id="4383317">.</span><span class="op" id="4383318">(</span><span class="op" id="4383319">*</span><span class="ident" id="4383320">serverHelloDoneMsg</span><span class="op" id="4383338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383341">if</span>&nbsp;<span class="op" id="4383344">!</span><span class="ident" id="4383345">ok</span>&nbsp;<span class="op" id="4383348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383352">c</span><span class="op" id="4383353">.</span><span class="ident" id="4383354">sendAlert</span><span class="op" id="4383363">(</span><span class="ident" id="4383364">alertUnexpectedMessage</span><span class="op" id="4383386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383390">return</span>&nbsp;<span class="ident" id="4383397">unexpectedMessageError</span><span class="op" id="4383419">(</span><span class="ident" id="4383420">shd</span><span class="op" id="4383423">,</span>&nbsp;<span class="ident" id="4383425">msg</span><span class="op" id="4383428">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383434">hs</span><span class="op" id="4383436">.</span><span class="ident" id="4383437">finishedHash</span><span class="op" id="4383449">.</span><span class="ident" id="4383450">Write</span><span class="op" id="4383455">(</span><span class="ident" id="4383456">shd</span><span class="op" id="4383459">.</span><span class="ident" id="4383460">marshal</span><span class="op" id="4383467">(</span><span class="op" id="4383468">)</span><span class="op" id="4383469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4383473">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4383538">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4383606">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383631">if</span>&nbsp;<span class="ident" id="4383634">certRequested</span>&nbsp;<span class="op" id="4383648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383652">certMsg</span>&nbsp;<span class="op" id="4383660">=</span>&nbsp;<span class="builtinfunc" id="4383662">new</span><span class="op" id="4383665">(</span><span class="ident" id="4383666">certificateMsg</span><span class="op" id="4383680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383684">if</span>&nbsp;<span class="ident" id="4383687">chainToSend</span>&nbsp;<span class="op" id="4383699">!=</span>&nbsp;<span class="builtintype" id="4383702">nil</span>&nbsp;<span class="op" id="4383706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383711">certMsg</span><span class="op" id="4383718">.</span><span class="ident" id="4383719">certificates</span>&nbsp;<span class="op" id="4383732">=</span>&nbsp;<span class="ident" id="4383734">chainToSend</span><span class="op" id="4383745">.</span><span class="ident" id="4383746">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383764">hs</span><span class="op" id="4383766">.</span><span class="ident" id="4383767">finishedHash</span><span class="op" id="4383779">.</span><span class="ident" id="4383780">Write</span><span class="op" id="4383785">(</span><span class="ident" id="4383786">certMsg</span><span class="op" id="4383793">.</span><span class="ident" id="4383794">marshal</span><span class="op" id="4383801">(</span><span class="op" id="4383802">)</span><span class="op" id="4383803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383807">c</span><span class="op" id="4383808">.</span><span class="ident" id="4383809">writeRecord</span><span class="op" id="4383820">(</span><span class="ident" id="4383821">recordTypeHandshake</span><span class="op" id="4383840">,</span>&nbsp;<span class="ident" id="4383842">certMsg</span><span class="op" id="4383849">.</span><span class="ident" id="4383850">marshal</span><span class="op" id="4383857">(</span><span class="op" id="4383858">)</span><span class="op" id="4383859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4383862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383866">preMasterSecret</span><span class="op" id="4383881">,</span>&nbsp;<span class="ident" id="4383883">ckx</span><span class="op" id="4383886">,</span>&nbsp;<span class="ident" id="4383888">err</span>&nbsp;<span class="op" id="4383892">:=</span>&nbsp;<span class="ident" id="4383895">keyAgreement</span><span class="op" id="4383907">.</span><span class="ident" id="4383908">generateClientKeyExchange</span><span class="op" id="4383933">(</span><span class="ident" id="4383934">c</span><span class="op" id="4383935">.</span><span class="ident" id="4383936">config</span><span class="op" id="4383942">,</span>&nbsp;<span class="ident" id="4383944">hs</span><span class="op" id="4383946">.</span><span class="ident" id="4383947">hello</span><span class="op" id="4383952">,</span>&nbsp;<span class="ident" id="4383954">certs</span><span class="op" id="4383959">[</span><span class="num" id="4383960">0</span><span class="op" id="4383961">]</span><span class="op" id="4383962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4383965">if</span>&nbsp;<span class="ident" id="4383968">err</span>&nbsp;<span class="op" id="4383972">!=</span>&nbsp;<span class="builtintype" id="4383975">nil</span>&nbsp;<span class="op" id="4383979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4383983">c</span><span class="op" id="4383984">.</span><span class="ident" id="4383985">sendAlert</span><span class="op" id="4383994">(</span><span class="ident" id="4383995">alertInternalError</span><span class="op" id="4384013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384017">return</span>&nbsp;<span class="ident" id="4384024">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4384029">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384032">if</span>&nbsp;<span class="ident" id="4384035">ckx</span>&nbsp;<span class="op" id="4384039">!=</span>&nbsp;<span class="builtintype" id="4384042">nil</span>&nbsp;<span class="op" id="4384046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384050">hs</span><span class="op" id="4384052">.</span><span class="ident" id="4384053">finishedHash</span><span class="op" id="4384065">.</span><span class="ident" id="4384066">Write</span><span class="op" id="4384071">(</span><span class="ident" id="4384072">ckx</span><span class="op" id="4384075">.</span><span class="ident" id="4384076">marshal</span><span class="op" id="4384083">(</span><span class="op" id="4384084">)</span><span class="op" id="4384085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384089">c</span><span class="op" id="4384090">.</span><span class="ident" id="4384091">writeRecord</span><span class="op" id="4384102">(</span><span class="ident" id="4384103">recordTypeHandshake</span><span class="op" id="4384122">,</span>&nbsp;<span class="ident" id="4384124">ckx</span><span class="op" id="4384127">.</span><span class="ident" id="4384128">marshal</span><span class="op" id="4384135">(</span><span class="op" id="4384136">)</span><span class="op" id="4384137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4384140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384144">if</span>&nbsp;<span class="ident" id="4384147">chainToSend</span>&nbsp;<span class="op" id="4384159">!=</span>&nbsp;<span class="builtintype" id="4384162">nil</span>&nbsp;<span class="op" id="4384166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384170">var</span>&nbsp;<span class="ident" id="4384174">signed</span>&nbsp;<span class="op" id="4384181">[</span><span class="op" id="4384182">]</span><span class="builtintype" id="4384183">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384190">certVerify</span>&nbsp;<span class="op" id="4384201">:=</span>&nbsp;<span class="op" id="4384204">&amp;</span><span class="ident" id="4384205">certificateVerifyMsg</span><span class="op" id="4384225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384230">hasSignatureAndHash</span><span class="op" id="4384249">:</span>&nbsp;<span class="ident" id="4384251">c</span><span class="op" id="4384252">.</span><span class="ident" id="4384253">vers</span>&nbsp;<span class="op" id="4384258">&gt;=</span>&nbsp;<span class="ident" id="4384261">VersionTLS12</span><span class="op" id="4384273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4384277">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384282">key</span><span class="op" id="4384285">,</span>&nbsp;<span class="ident" id="4384287">ok</span>&nbsp;<span class="op" id="4384290">:=</span>&nbsp;<span class="ident" id="4384293">chainToSend</span><span class="op" id="4384304">.</span><span class="ident" id="4384305">PrivateKey</span><span class="op" id="4384315">.</span><span class="op" id="4384316">(</span><span class="ident" id="4384317">crypto</span><span class="op" id="4384323">.</span><span class="ident" id="4384324">Signer</span><span class="op" id="4384330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384334">if</span>&nbsp;<span class="op" id="4384337">!</span><span class="ident" id="4384338">ok</span>&nbsp;<span class="op" id="4384341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384346">c</span><span class="op" id="4384347">.</span><span class="ident" id="4384348">sendAlert</span><span class="op" id="4384357">(</span><span class="ident" id="4384358">alertInternalError</span><span class="op" id="4384376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384381">return</span>&nbsp;<span class="ident" id="4384388">fmt</span><span class="op" id="4384391">.</span><span class="ident" id="4384392">Errorf</span><span class="op" id="4384398">(</span><span class="string" id="4384399">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4384480">,</span>&nbsp;<span class="ident" id="4384482">chainToSend</span><span class="op" id="4384493">.</span><span class="ident" id="4384494">PrivateKey</span><span class="op" id="4384504">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4384508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384512">switch</span>&nbsp;<span class="ident" id="4384519">key</span><span class="op" id="4384522">.</span><span class="ident" id="4384523">Public</span><span class="op" id="4384529">(</span><span class="op" id="4384530">)</span><span class="op" id="4384531">.</span><span class="op" id="4384532">(</span><span class="keyword" id="4384533">type</span><span class="op" id="4384537">)</span>&nbsp;<span class="op" id="4384539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384543">case</span>&nbsp;<span class="op" id="4384548">*</span><span class="ident" id="4384549">ecdsa</span><span class="op" id="4384554">.</span><span class="ident" id="4384555">PublicKey</span><span class="op" id="4384564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384569">digest</span><span class="op" id="4384575">,</span>&nbsp;<span class="ident" id="4384577">hashFunc</span><span class="op" id="4384585">,</span>&nbsp;<span class="ident" id="4384587">hashId</span>&nbsp;<span class="op" id="4384594">:=</span>&nbsp;<span class="ident" id="4384597">hs</span><span class="op" id="4384599">.</span><span class="ident" id="4384600">finishedHash</span><span class="op" id="4384612">.</span><span class="ident" id="4384613">hashForClientCertificate</span><span class="op" id="4384637">(</span><span class="ident" id="4384638">signatureECDSA</span><span class="op" id="4384652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384657">signed</span><span class="op" id="4384663">,</span>&nbsp;<span class="ident" id="4384665">err</span>&nbsp;<span class="op" id="4384669">=</span>&nbsp;<span class="ident" id="4384671">key</span><span class="op" id="4384674">.</span><span class="ident" id="4384675">Sign</span><span class="op" id="4384679">(</span><span class="ident" id="4384680">c</span><span class="op" id="4384681">.</span><span class="ident" id="4384682">config</span><span class="op" id="4384688">.</span><span class="ident" id="4384689">rand</span><span class="op" id="4384693">(</span><span class="op" id="4384694">)</span><span class="op" id="4384695">,</span>&nbsp;<span class="ident" id="4384697">digest</span><span class="op" id="4384703">,</span>&nbsp;<span class="ident" id="4384705">hashFunc</span><span class="op" id="4384713">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384718">certVerify</span><span class="op" id="4384728">.</span><span class="ident" id="4384729">signatureAndHash</span><span class="op" id="4384745">.</span><span class="ident" id="4384746">signature</span>&nbsp;<span class="op" id="4384756">=</span>&nbsp;<span class="ident" id="4384758">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384776">certVerify</span><span class="op" id="4384786">.</span><span class="ident" id="4384787">signatureAndHash</span><span class="op" id="4384803">.</span><span class="ident" id="4384804">hash</span>&nbsp;<span class="op" id="4384809">=</span>&nbsp;<span class="ident" id="4384811">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4384820">case</span>&nbsp;<span class="op" id="4384825">*</span><span class="ident" id="4384826">rsa</span><span class="op" id="4384829">.</span><span class="ident" id="4384830">PublicKey</span><span class="op" id="4384839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384844">digest</span><span class="op" id="4384850">,</span>&nbsp;<span class="ident" id="4384852">hashFunc</span><span class="op" id="4384860">,</span>&nbsp;<span class="ident" id="4384862">hashId</span>&nbsp;<span class="op" id="4384869">:=</span>&nbsp;<span class="ident" id="4384872">hs</span><span class="op" id="4384874">.</span><span class="ident" id="4384875">finishedHash</span><span class="op" id="4384887">.</span><span class="ident" id="4384888">hashForClientCertificate</span><span class="op" id="4384912">(</span><span class="ident" id="4384913">signatureRSA</span><span class="op" id="4384925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384930">signed</span><span class="op" id="4384936">,</span>&nbsp;<span class="ident" id="4384938">err</span>&nbsp;<span class="op" id="4384942">=</span>&nbsp;<span class="ident" id="4384944">key</span><span class="op" id="4384947">.</span><span class="ident" id="4384948">Sign</span><span class="op" id="4384952">(</span><span class="ident" id="4384953">c</span><span class="op" id="4384954">.</span><span class="ident" id="4384955">config</span><span class="op" id="4384961">.</span><span class="ident" id="4384962">rand</span><span class="op" id="4384966">(</span><span class="op" id="4384967">)</span><span class="op" id="4384968">,</span>&nbsp;<span class="ident" id="4384970">digest</span><span class="op" id="4384976">,</span>&nbsp;<span class="ident" id="4384978">hashFunc</span><span class="op" id="4384986">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4384991">certVerify</span><span class="op" id="4385001">.</span><span class="ident" id="4385002">signatureAndHash</span><span class="op" id="4385018">.</span><span class="ident" id="4385019">signature</span>&nbsp;<span class="op" id="4385029">=</span>&nbsp;<span class="ident" id="4385031">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385047">certVerify</span><span class="op" id="4385057">.</span><span class="ident" id="4385058">signatureAndHash</span><span class="op" id="4385074">.</span><span class="ident" id="4385075">hash</span>&nbsp;<span class="op" id="4385080">=</span>&nbsp;<span class="ident" id="4385082">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385091">default</span><span class="op" id="4385098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385103">err</span>&nbsp;<span class="op" id="4385107">=</span>&nbsp;<span class="ident" id="4385109">fmt</span><span class="op" id="4385112">.</span><span class="ident" id="4385113">Errorf</span><span class="op" id="4385119">(</span><span class="string" id="4385120">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4385166">,</span>&nbsp;<span class="ident" id="4385168">key</span><span class="op" id="4385171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4385175">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385179">if</span>&nbsp;<span class="ident" id="4385182">err</span>&nbsp;<span class="op" id="4385186">!=</span>&nbsp;<span class="builtintype" id="4385189">nil</span>&nbsp;<span class="op" id="4385193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385198">c</span><span class="op" id="4385199">.</span><span class="ident" id="4385200">sendAlert</span><span class="op" id="4385209">(</span><span class="ident" id="4385210">alertInternalError</span><span class="op" id="4385228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385233">return</span>&nbsp;<span class="ident" id="4385240">errors</span><span class="op" id="4385246">.</span><span class="ident" id="4385247">New</span><span class="op" id="4385250">(</span><span class="string" id="4385251">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4385309">+</span>&nbsp;<span class="ident" id="4385311">err</span><span class="op" id="4385314">.</span><span class="ident" id="4385315">Error</span><span class="op" id="4385320">(</span><span class="op" id="4385321">)</span><span class="op" id="4385322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4385326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385330">certVerify</span><span class="op" id="4385340">.</span><span class="ident" id="4385341">signature</span>&nbsp;<span class="op" id="4385351">=</span>&nbsp;<span class="ident" id="4385353">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385363">hs</span><span class="op" id="4385365">.</span><span class="ident" id="4385366">finishedHash</span><span class="op" id="4385378">.</span><span class="ident" id="4385379">Write</span><span class="op" id="4385384">(</span><span class="ident" id="4385385">certVerify</span><span class="op" id="4385395">.</span><span class="ident" id="4385396">marshal</span><span class="op" id="4385403">(</span><span class="op" id="4385404">)</span><span class="op" id="4385405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385409">c</span><span class="op" id="4385410">.</span><span class="ident" id="4385411">writeRecord</span><span class="op" id="4385422">(</span><span class="ident" id="4385423">recordTypeHandshake</span><span class="op" id="4385442">,</span>&nbsp;<span class="ident" id="4385444">certVerify</span><span class="op" id="4385454">.</span><span class="ident" id="4385455">marshal</span><span class="op" id="4385462">(</span><span class="op" id="4385463">)</span><span class="op" id="4385464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4385467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385471">hs</span><span class="op" id="4385473">.</span><span class="ident" id="4385474">masterSecret</span>&nbsp;<span class="op" id="4385487">=</span>&nbsp;<span class="ident" id="4385489">masterFromPreMasterSecret</span><span class="op" id="4385514">(</span><span class="ident" id="4385515">c</span><span class="op" id="4385516">.</span><span class="ident" id="4385517">vers</span><span class="op" id="4385521">,</span>&nbsp;<span class="ident" id="4385523">preMasterSecret</span><span class="op" id="4385538">,</span>&nbsp;<span class="ident" id="4385540">hs</span><span class="op" id="4385542">.</span><span class="ident" id="4385543">hello</span><span class="op" id="4385548">.</span><span class="ident" id="4385549">random</span><span class="op" id="4385555">,</span>&nbsp;<span class="ident" id="4385557">hs</span><span class="op" id="4385559">.</span><span class="ident" id="4385560">serverHello</span><span class="op" id="4385571">.</span><span class="ident" id="4385572">random</span><span class="op" id="4385578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385581">return</span>&nbsp;<span class="builtintype" id="4385588">nil</span><br>
<span class="lineno"></span><span class="op" id="4385592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4385595">func</span>&nbsp;<span class="op" id="4385600">(</span><span class="ident" id="4385601">hs</span>&nbsp;<span class="op" id="4385604">*</span><span class="ident" id="4385605">clientHandshakeState</span><span class="op" id="4385625">)</span>&nbsp;<span class="ident" id="4385627">establishKeys</span><span class="op" id="4385640">(</span><span class="op" id="4385641">)</span>&nbsp;<span class="builtintype" id="4385643">error</span>&nbsp;<span class="op" id="4385649">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385652">c</span>&nbsp;<span class="op" id="4385654">:=</span>&nbsp;<span class="ident" id="4385657">hs</span><span class="op" id="4385659">.</span><span class="ident" id="4385660">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385664">clientMAC</span><span class="op" id="4385673">,</span>&nbsp;<span class="ident" id="4385675">serverMAC</span><span class="op" id="4385684">,</span>&nbsp;<span class="ident" id="4385686">clientKey</span><span class="op" id="4385695">,</span>&nbsp;<span class="ident" id="4385697">serverKey</span><span class="op" id="4385706">,</span>&nbsp;<span class="ident" id="4385708">clientIV</span><span class="op" id="4385716">,</span>&nbsp;<span class="ident" id="4385718">serverIV</span>&nbsp;<span class="op" id="4385727">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385732">keysFromMasterSecret</span><span class="op" id="4385752">(</span><span class="ident" id="4385753">c</span><span class="op" id="4385754">.</span><span class="ident" id="4385755">vers</span><span class="op" id="4385759">,</span>&nbsp;<span class="ident" id="4385761">hs</span><span class="op" id="4385763">.</span><span class="ident" id="4385764">masterSecret</span><span class="op" id="4385776">,</span>&nbsp;<span class="ident" id="4385778">hs</span><span class="op" id="4385780">.</span><span class="ident" id="4385781">hello</span><span class="op" id="4385786">.</span><span class="ident" id="4385787">random</span><span class="op" id="4385793">,</span>&nbsp;<span class="ident" id="4385795">hs</span><span class="op" id="4385797">.</span><span class="ident" id="4385798">serverHello</span><span class="op" id="4385809">.</span><span class="ident" id="4385810">random</span><span class="op" id="4385816">,</span>&nbsp;<span class="ident" id="4385818">hs</span><span class="op" id="4385820">.</span><span class="ident" id="4385821">suite</span><span class="op" id="4385826">.</span><span class="ident" id="4385827">macLen</span><span class="op" id="4385833">,</span>&nbsp;<span class="ident" id="4385835">hs</span><span class="op" id="4385837">.</span><span class="ident" id="4385838">suite</span><span class="op" id="4385843">.</span><span class="ident" id="4385844">keyLen</span><span class="op" id="4385850">,</span>&nbsp;<span class="ident" id="4385852">hs</span><span class="op" id="4385854">.</span><span class="ident" id="4385855">suite</span><span class="op" id="4385860">.</span><span class="ident" id="4385861">ivLen</span><span class="op" id="4385866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385869">var</span>&nbsp;<span class="ident" id="4385873">clientCipher</span><span class="op" id="4385885">,</span>&nbsp;<span class="ident" id="4385887">serverCipher</span>&nbsp;<span class="keyword" id="4385900">interface</span><span class="op" id="4385909">{</span><span class="op" id="4385910">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385913">var</span>&nbsp;<span class="ident" id="4385917">clientHash</span><span class="op" id="4385927">,</span>&nbsp;<span class="ident" id="4385929">serverHash</span>&nbsp;<span class="ident" id="4385940">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4385953">if</span>&nbsp;<span class="ident" id="4385956">hs</span><span class="op" id="4385958">.</span><span class="ident" id="4385959">suite</span><span class="op" id="4385964">.</span><span class="ident" id="4385965">cipher</span>&nbsp;<span class="op" id="4385972">!=</span>&nbsp;<span class="builtintype" id="4385975">nil</span>&nbsp;<span class="op" id="4385979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4385983">clientCipher</span>&nbsp;<span class="op" id="4385996">=</span>&nbsp;<span class="ident" id="4385998">hs</span><span class="op" id="4386000">.</span><span class="ident" id="4386001">suite</span><span class="op" id="4386006">.</span><span class="ident" id="4386007">cipher</span><span class="op" id="4386013">(</span><span class="ident" id="4386014">clientKey</span><span class="op" id="4386023">,</span>&nbsp;<span class="ident" id="4386025">clientIV</span><span class="op" id="4386033">,</span>&nbsp;<span class="builtintype" id="4386035">false</span>&nbsp;<span class="comment" id="4386041">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4386062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386066">clientHash</span>&nbsp;<span class="op" id="4386077">=</span>&nbsp;<span class="ident" id="4386079">hs</span><span class="op" id="4386081">.</span><span class="ident" id="4386082">suite</span><span class="op" id="4386087">.</span><span class="ident" id="4386088">mac</span><span class="op" id="4386091">(</span><span class="ident" id="4386092">c</span><span class="op" id="4386093">.</span><span class="ident" id="4386094">vers</span><span class="op" id="4386098">,</span>&nbsp;<span class="ident" id="4386100">clientMAC</span><span class="op" id="4386109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386113">serverCipher</span>&nbsp;<span class="op" id="4386126">=</span>&nbsp;<span class="ident" id="4386128">hs</span><span class="op" id="4386130">.</span><span class="ident" id="4386131">suite</span><span class="op" id="4386136">.</span><span class="ident" id="4386137">cipher</span><span class="op" id="4386143">(</span><span class="ident" id="4386144">serverKey</span><span class="op" id="4386153">,</span>&nbsp;<span class="ident" id="4386155">serverIV</span><span class="op" id="4386163">,</span>&nbsp;<span class="builtintype" id="4386165">true</span>&nbsp;<span class="comment" id="4386170">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4386187">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386191">serverHash</span>&nbsp;<span class="op" id="4386202">=</span>&nbsp;<span class="ident" id="4386204">hs</span><span class="op" id="4386206">.</span><span class="ident" id="4386207">suite</span><span class="op" id="4386212">.</span><span class="ident" id="4386213">mac</span><span class="op" id="4386216">(</span><span class="ident" id="4386217">c</span><span class="op" id="4386218">.</span><span class="ident" id="4386219">vers</span><span class="op" id="4386223">,</span>&nbsp;<span class="ident" id="4386225">serverMAC</span><span class="op" id="4386234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4386237">}</span>&nbsp;<span class="keyword" id="4386239">else</span>&nbsp;<span class="op" id="4386244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386248">clientCipher</span>&nbsp;<span class="op" id="4386261">=</span>&nbsp;<span class="ident" id="4386263">hs</span><span class="op" id="4386265">.</span><span class="ident" id="4386266">suite</span><span class="op" id="4386271">.</span><span class="ident" id="4386272">aead</span><span class="op" id="4386276">(</span><span class="ident" id="4386277">clientKey</span><span class="op" id="4386286">,</span>&nbsp;<span class="ident" id="4386288">clientIV</span><span class="op" id="4386296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386300">serverCipher</span>&nbsp;<span class="op" id="4386313">=</span>&nbsp;<span class="ident" id="4386315">hs</span><span class="op" id="4386317">.</span><span class="ident" id="4386318">suite</span><span class="op" id="4386323">.</span><span class="ident" id="4386324">aead</span><span class="op" id="4386328">(</span><span class="ident" id="4386329">serverKey</span><span class="op" id="4386338">,</span>&nbsp;<span class="ident" id="4386340">serverIV</span><span class="op" id="4386348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4386351">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386355">c</span><span class="op" id="4386356">.</span><span class="ident" id="4386357">in</span><span class="op" id="4386359">.</span><span class="ident" id="4386360">prepareCipherSpec</span><span class="op" id="4386377">(</span><span class="ident" id="4386378">c</span><span class="op" id="4386379">.</span><span class="ident" id="4386380">vers</span><span class="op" id="4386384">,</span>&nbsp;<span class="ident" id="4386386">serverCipher</span><span class="op" id="4386398">,</span>&nbsp;<span class="ident" id="4386400">serverHash</span><span class="op" id="4386410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386413">c</span><span class="op" id="4386414">.</span><span class="ident" id="4386415">out</span><span class="op" id="4386418">.</span><span class="ident" id="4386419">prepareCipherSpec</span><span class="op" id="4386436">(</span><span class="ident" id="4386437">c</span><span class="op" id="4386438">.</span><span class="ident" id="4386439">vers</span><span class="op" id="4386443">,</span>&nbsp;<span class="ident" id="4386445">clientCipher</span><span class="op" id="4386457">,</span>&nbsp;<span class="ident" id="4386459">clientHash</span><span class="op" id="4386469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4386472">return</span>&nbsp;<span class="builtintype" id="4386479">nil</span><br>
<span class="lineno"></span><span class="op" id="4386483">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4386486">func</span>&nbsp;<span class="op" id="4386491">(</span><span class="ident" id="4386492">hs</span>&nbsp;<span class="op" id="4386495">*</span><span class="ident" id="4386496">clientHandshakeState</span><span class="op" id="4386516">)</span>&nbsp;<span class="ident" id="4386518">serverResumedSession</span><span class="op" id="4386538">(</span><span class="op" id="4386539">)</span>&nbsp;<span class="builtintype" id="4386541">bool</span>&nbsp;<span class="op" id="4386546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4386549">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4386619">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4386676">return</span>&nbsp;<span class="ident" id="4386683">hs</span><span class="op" id="4386685">.</span><span class="ident" id="4386686">session</span>&nbsp;<span class="op" id="4386694">!=</span>&nbsp;<span class="builtintype" id="4386697">nil</span>&nbsp;<span class="op" id="4386701">&amp;&amp;</span>&nbsp;<span class="ident" id="4386704">hs</span><span class="op" id="4386706">.</span><span class="ident" id="4386707">hello</span><span class="op" id="4386712">.</span><span class="ident" id="4386713">sessionId</span>&nbsp;<span class="op" id="4386723">!=</span>&nbsp;<span class="builtintype" id="4386726">nil</span>&nbsp;<span class="op" id="4386730">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386735">bytes</span><span class="op" id="4386740">.</span><span class="ident" id="4386741">Equal</span><span class="op" id="4386746">(</span><span class="ident" id="4386747">hs</span><span class="op" id="4386749">.</span><span class="ident" id="4386750">serverHello</span><span class="op" id="4386761">.</span><span class="ident" id="4386762">sessionId</span><span class="op" id="4386771">,</span>&nbsp;<span class="ident" id="4386773">hs</span><span class="op" id="4386775">.</span><span class="ident" id="4386776">hello</span><span class="op" id="4386781">.</span><span class="ident" id="4386782">sessionId</span><span class="op" id="4386791">)</span><br>
<span class="lineno"></span><span class="op" id="4386793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4386796">func</span>&nbsp;<span class="op" id="4386801">(</span><span class="ident" id="4386802">hs</span>&nbsp;<span class="op" id="4386805">*</span><span class="ident" id="4386806">clientHandshakeState</span><span class="op" id="4386826">)</span>&nbsp;<span class="ident" id="4386828">processServerHello</span><span class="op" id="4386846">(</span><span class="op" id="4386847">)</span>&nbsp;<span class="op" id="4386849">(</span><span class="builtintype" id="4386850">bool</span><span class="op" id="4386854">,</span>&nbsp;<span class="builtintype" id="4386856">error</span><span class="op" id="4386861">)</span>&nbsp;<span class="op" id="4386863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386866">c</span>&nbsp;<span class="op" id="4386868">:=</span>&nbsp;<span class="ident" id="4386871">hs</span><span class="op" id="4386873">.</span><span class="ident" id="4386874">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4386878">if</span>&nbsp;<span class="ident" id="4386881">hs</span><span class="op" id="4386883">.</span><span class="ident" id="4386884">serverHello</span><span class="op" id="4386895">.</span><span class="ident" id="4386896">compressionMethod</span>&nbsp;<span class="op" id="4386914">!=</span>&nbsp;<span class="ident" id="4386917">compressionNone</span>&nbsp;<span class="op" id="4386933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4386937">c</span><span class="op" id="4386938">.</span><span class="ident" id="4386939">sendAlert</span><span class="op" id="4386948">(</span><span class="ident" id="4386949">alertUnexpectedMessage</span><span class="op" id="4386971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4386975">return</span>&nbsp;<span class="builtintype" id="4386982">false</span><span class="op" id="4386987">,</span>&nbsp;<span class="ident" id="4386989">errors</span><span class="op" id="4386995">.</span><span class="ident" id="4386996">New</span><span class="op" id="4386999">(</span><span class="string" id="4387000">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4387053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4387056">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387060">clientDidNPN</span>&nbsp;<span class="op" id="4387073">:=</span>&nbsp;<span class="ident" id="4387076">hs</span><span class="op" id="4387078">.</span><span class="ident" id="4387079">hello</span><span class="op" id="4387084">.</span><span class="ident" id="4387085">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387099">clientDidALPN</span>&nbsp;<span class="op" id="4387113">:=</span>&nbsp;<span class="builtinfunc" id="4387116">len</span><span class="op" id="4387119">(</span><span class="ident" id="4387120">hs</span><span class="op" id="4387122">.</span><span class="ident" id="4387123">hello</span><span class="op" id="4387128">.</span><span class="ident" id="4387129">alpnProtocols</span><span class="op" id="4387142">)</span>&nbsp;<span class="op" id="4387144">&gt;</span>&nbsp;<span class="num" id="4387146">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387149">serverHasNPN</span>&nbsp;<span class="op" id="4387162">:=</span>&nbsp;<span class="ident" id="4387165">hs</span><span class="op" id="4387167">.</span><span class="ident" id="4387168">serverHello</span><span class="op" id="4387179">.</span><span class="ident" id="4387180">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387194">serverHasALPN</span>&nbsp;<span class="op" id="4387208">:=</span>&nbsp;<span class="builtinfunc" id="4387211">len</span><span class="op" id="4387214">(</span><span class="ident" id="4387215">hs</span><span class="op" id="4387217">.</span><span class="ident" id="4387218">serverHello</span><span class="op" id="4387229">.</span><span class="ident" id="4387230">alpnProtocol</span><span class="op" id="4387242">)</span>&nbsp;<span class="op" id="4387244">&gt;</span>&nbsp;<span class="num" id="4387246">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387250">if</span>&nbsp;<span class="op" id="4387253">!</span><span class="ident" id="4387254">clientDidNPN</span>&nbsp;<span class="op" id="4387267">&amp;&amp;</span>&nbsp;<span class="ident" id="4387270">serverHasNPN</span>&nbsp;<span class="op" id="4387283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387287">c</span><span class="op" id="4387288">.</span><span class="ident" id="4387289">sendAlert</span><span class="op" id="4387298">(</span><span class="ident" id="4387299">alertHandshakeFailure</span><span class="op" id="4387320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387324">return</span>&nbsp;<span class="builtintype" id="4387331">false</span><span class="op" id="4387336">,</span>&nbsp;<span class="ident" id="4387338">errors</span><span class="op" id="4387344">.</span><span class="ident" id="4387345">New</span><span class="op" id="4387348">(</span><span class="string" id="4387349">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4387394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4387397">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387401">if</span>&nbsp;<span class="op" id="4387404">!</span><span class="ident" id="4387405">clientDidALPN</span>&nbsp;<span class="op" id="4387419">&amp;&amp;</span>&nbsp;<span class="ident" id="4387422">serverHasALPN</span>&nbsp;<span class="op" id="4387436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387440">c</span><span class="op" id="4387441">.</span><span class="ident" id="4387442">sendAlert</span><span class="op" id="4387451">(</span><span class="ident" id="4387452">alertHandshakeFailure</span><span class="op" id="4387473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387477">return</span>&nbsp;<span class="builtintype" id="4387484">false</span><span class="op" id="4387489">,</span>&nbsp;<span class="ident" id="4387491">errors</span><span class="op" id="4387497">.</span><span class="ident" id="4387498">New</span><span class="op" id="4387501">(</span><span class="string" id="4387502">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4387548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4387551">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387555">if</span>&nbsp;<span class="ident" id="4387558">serverHasNPN</span>&nbsp;<span class="op" id="4387571">&amp;&amp;</span>&nbsp;<span class="ident" id="4387574">serverHasALPN</span>&nbsp;<span class="op" id="4387588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387592">c</span><span class="op" id="4387593">.</span><span class="ident" id="4387594">sendAlert</span><span class="op" id="4387603">(</span><span class="ident" id="4387604">alertHandshakeFailure</span><span class="op" id="4387625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387629">return</span>&nbsp;<span class="builtintype" id="4387636">false</span><span class="op" id="4387641">,</span>&nbsp;<span class="ident" id="4387643">errors</span><span class="op" id="4387649">.</span><span class="ident" id="4387650">New</span><span class="op" id="4387653">(</span><span class="string" id="4387654">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4387702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4387705">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387709">if</span>&nbsp;<span class="ident" id="4387712">serverHasALPN</span>&nbsp;<span class="op" id="4387726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387730">c</span><span class="op" id="4387731">.</span><span class="ident" id="4387732">clientProtocol</span>&nbsp;<span class="op" id="4387747">=</span>&nbsp;<span class="ident" id="4387749">hs</span><span class="op" id="4387751">.</span><span class="ident" id="4387752">serverHello</span><span class="op" id="4387763">.</span><span class="ident" id="4387764">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387779">c</span><span class="op" id="4387780">.</span><span class="ident" id="4387781">clientProtocolFallback</span>&nbsp;<span class="op" id="4387804">=</span>&nbsp;<span class="builtintype" id="4387806">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4387813">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4387817">if</span>&nbsp;<span class="ident" id="4387820">hs</span><span class="op" id="4387822">.</span><span class="ident" id="4387823">serverResumedSession</span><span class="op" id="4387843">(</span><span class="op" id="4387844">)</span>&nbsp;<span class="op" id="4387846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4387850">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387910">hs</span><span class="op" id="4387912">.</span><span class="ident" id="4387913">masterSecret</span>&nbsp;<span class="op" id="4387926">=</span>&nbsp;<span class="ident" id="4387928">hs</span><span class="op" id="4387930">.</span><span class="ident" id="4387931">session</span><span class="op" id="4387938">.</span><span class="ident" id="4387939">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4387954">c</span><span class="op" id="4387955">.</span><span class="ident" id="4387956">peerCertificates</span>&nbsp;<span class="op" id="4387973">=</span>&nbsp;<span class="ident" id="4387975">hs</span><span class="op" id="4387977">.</span><span class="ident" id="4387978">session</span><span class="op" id="4387985">.</span><span class="ident" id="4387986">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388007">return</span>&nbsp;<span class="builtintype" id="4388014">true</span><span class="op" id="4388018">,</span>&nbsp;<span class="builtintype" id="4388020">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388028">return</span>&nbsp;<span class="builtintype" id="4388035">false</span><span class="op" id="4388040">,</span>&nbsp;<span class="builtintype" id="4388042">nil</span><br>
<span class="lineno"></span><span class="op" id="4388046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4388049">func</span>&nbsp;<span class="op" id="4388054">(</span><span class="ident" id="4388055">hs</span>&nbsp;<span class="op" id="4388058">*</span><span class="ident" id="4388059">clientHandshakeState</span><span class="op" id="4388079">)</span>&nbsp;<span class="ident" id="4388081">readFinished</span><span class="op" id="4388093">(</span><span class="ident" id="4388094">out</span>&nbsp;<span class="op" id="4388098">[</span><span class="op" id="4388099">]</span><span class="builtintype" id="4388100">byte</span><span class="op" id="4388104">)</span>&nbsp;<span class="builtintype" id="4388106">error</span>&nbsp;<span class="op" id="4388112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388115">c</span>&nbsp;<span class="op" id="4388117">:=</span>&nbsp;<span class="ident" id="4388120">hs</span><span class="op" id="4388122">.</span><span class="ident" id="4388123">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388127">c</span><span class="op" id="4388128">.</span><span class="ident" id="4388129">readRecord</span><span class="op" id="4388139">(</span><span class="ident" id="4388140">recordTypeChangeCipherSpec</span><span class="op" id="4388166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388169">if</span>&nbsp;<span class="ident" id="4388172">err</span>&nbsp;<span class="op" id="4388176">:=</span>&nbsp;<span class="ident" id="4388179">c</span><span class="op" id="4388180">.</span><span class="ident" id="4388181">in</span><span class="op" id="4388183">.</span><span class="builtintype" id="4388184">error</span><span class="op" id="4388189">(</span><span class="op" id="4388190">)</span><span class="op" id="4388191">;</span>&nbsp;<span class="ident" id="4388193">err</span>&nbsp;<span class="op" id="4388197">!=</span>&nbsp;<span class="builtintype" id="4388200">nil</span>&nbsp;<span class="op" id="4388204">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388208">return</span>&nbsp;<span class="ident" id="4388215">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388224">msg</span><span class="op" id="4388227">,</span>&nbsp;<span class="ident" id="4388229">err</span>&nbsp;<span class="op" id="4388233">:=</span>&nbsp;<span class="ident" id="4388236">c</span><span class="op" id="4388237">.</span><span class="ident" id="4388238">readHandshake</span><span class="op" id="4388251">(</span><span class="op" id="4388252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388255">if</span>&nbsp;<span class="ident" id="4388258">err</span>&nbsp;<span class="op" id="4388262">!=</span>&nbsp;<span class="builtintype" id="4388265">nil</span>&nbsp;<span class="op" id="4388269">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388273">return</span>&nbsp;<span class="ident" id="4388280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388288">serverFinished</span><span class="op" id="4388302">,</span>&nbsp;<span class="ident" id="4388304">ok</span>&nbsp;<span class="op" id="4388307">:=</span>&nbsp;<span class="ident" id="4388310">msg</span><span class="op" id="4388313">.</span><span class="op" id="4388314">(</span><span class="op" id="4388315">*</span><span class="ident" id="4388316">finishedMsg</span><span class="op" id="4388327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388330">if</span>&nbsp;<span class="op" id="4388333">!</span><span class="ident" id="4388334">ok</span>&nbsp;<span class="op" id="4388337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388341">c</span><span class="op" id="4388342">.</span><span class="ident" id="4388343">sendAlert</span><span class="op" id="4388352">(</span><span class="ident" id="4388353">alertUnexpectedMessage</span><span class="op" id="4388375">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388379">return</span>&nbsp;<span class="ident" id="4388386">unexpectedMessageError</span><span class="op" id="4388408">(</span><span class="ident" id="4388409">serverFinished</span><span class="op" id="4388423">,</span>&nbsp;<span class="ident" id="4388425">msg</span><span class="op" id="4388428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388435">verify</span>&nbsp;<span class="op" id="4388442">:=</span>&nbsp;<span class="ident" id="4388445">hs</span><span class="op" id="4388447">.</span><span class="ident" id="4388448">finishedHash</span><span class="op" id="4388460">.</span><span class="ident" id="4388461">serverSum</span><span class="op" id="4388470">(</span><span class="ident" id="4388471">hs</span><span class="op" id="4388473">.</span><span class="ident" id="4388474">masterSecret</span><span class="op" id="4388486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388489">if</span>&nbsp;<span class="builtinfunc" id="4388492">len</span><span class="op" id="4388495">(</span><span class="ident" id="4388496">verify</span><span class="op" id="4388502">)</span>&nbsp;<span class="op" id="4388504">!=</span>&nbsp;<span class="builtinfunc" id="4388507">len</span><span class="op" id="4388510">(</span><span class="ident" id="4388511">serverFinished</span><span class="op" id="4388525">.</span><span class="ident" id="4388526">verifyData</span><span class="op" id="4388536">)</span>&nbsp;<span class="op" id="4388538">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388543">subtle</span><span class="op" id="4388549">.</span><span class="ident" id="4388550">ConstantTimeCompare</span><span class="op" id="4388569">(</span><span class="ident" id="4388570">verify</span><span class="op" id="4388576">,</span>&nbsp;<span class="ident" id="4388578">serverFinished</span><span class="op" id="4388592">.</span><span class="ident" id="4388593">verifyData</span><span class="op" id="4388603">)</span>&nbsp;<span class="op" id="4388605">!=</span>&nbsp;<span class="num" id="4388608">1</span>&nbsp;<span class="op" id="4388610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388614">c</span><span class="op" id="4388615">.</span><span class="ident" id="4388616">sendAlert</span><span class="op" id="4388625">(</span><span class="ident" id="4388626">alertHandshakeFailure</span><span class="op" id="4388647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388651">return</span>&nbsp;<span class="ident" id="4388658">errors</span><span class="op" id="4388664">.</span><span class="ident" id="4388665">New</span><span class="op" id="4388668">(</span><span class="string" id="4388669">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4388715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388721">hs</span><span class="op" id="4388723">.</span><span class="ident" id="4388724">finishedHash</span><span class="op" id="4388736">.</span><span class="ident" id="4388737">Write</span><span class="op" id="4388742">(</span><span class="ident" id="4388743">serverFinished</span><span class="op" id="4388757">.</span><span class="ident" id="4388758">marshal</span><span class="op" id="4388765">(</span><span class="op" id="4388766">)</span><span class="op" id="4388767">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4388770">copy</span><span class="op" id="4388774">(</span><span class="ident" id="4388775">out</span><span class="op" id="4388778">,</span>&nbsp;<span class="ident" id="4388780">verify</span><span class="op" id="4388786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388789">return</span>&nbsp;<span class="builtintype" id="4388796">nil</span><br>
<span class="lineno"></span><span class="op" id="4388800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4388803">func</span>&nbsp;<span class="op" id="4388808">(</span><span class="ident" id="4388809">hs</span>&nbsp;<span class="op" id="4388812">*</span><span class="ident" id="4388813">clientHandshakeState</span><span class="op" id="4388833">)</span>&nbsp;<span class="ident" id="4388835">readSessionTicket</span><span class="op" id="4388852">(</span><span class="op" id="4388853">)</span>&nbsp;<span class="builtintype" id="4388855">error</span>&nbsp;<span class="op" id="4388861">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388864">if</span>&nbsp;<span class="op" id="4388867">!</span><span class="ident" id="4388868">hs</span><span class="op" id="4388870">.</span><span class="ident" id="4388871">serverHello</span><span class="op" id="4388882">.</span><span class="ident" id="4388883">ticketSupported</span>&nbsp;<span class="op" id="4388899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388903">return</span>&nbsp;<span class="builtintype" id="4388910">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388919">c</span>&nbsp;<span class="op" id="4388921">:=</span>&nbsp;<span class="ident" id="4388924">hs</span><span class="op" id="4388926">.</span><span class="ident" id="4388927">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388930">msg</span><span class="op" id="4388933">,</span>&nbsp;<span class="ident" id="4388935">err</span>&nbsp;<span class="op" id="4388939">:=</span>&nbsp;<span class="ident" id="4388942">c</span><span class="op" id="4388943">.</span><span class="ident" id="4388944">readHandshake</span><span class="op" id="4388957">(</span><span class="op" id="4388958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388961">if</span>&nbsp;<span class="ident" id="4388964">err</span>&nbsp;<span class="op" id="4388968">!=</span>&nbsp;<span class="builtintype" id="4388971">nil</span>&nbsp;<span class="op" id="4388975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4388979">return</span>&nbsp;<span class="ident" id="4388986">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4388991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4388994">sessionTicketMsg</span><span class="op" id="4389010">,</span>&nbsp;<span class="ident" id="4389012">ok</span>&nbsp;<span class="op" id="4389015">:=</span>&nbsp;<span class="ident" id="4389018">msg</span><span class="op" id="4389021">.</span><span class="op" id="4389022">(</span><span class="op" id="4389023">*</span><span class="ident" id="4389024">newSessionTicketMsg</span><span class="op" id="4389043">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4389046">if</span>&nbsp;<span class="op" id="4389049">!</span><span class="ident" id="4389050">ok</span>&nbsp;<span class="op" id="4389053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389057">c</span><span class="op" id="4389058">.</span><span class="ident" id="4389059">sendAlert</span><span class="op" id="4389068">(</span><span class="ident" id="4389069">alertUnexpectedMessage</span><span class="op" id="4389091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4389095">return</span>&nbsp;<span class="ident" id="4389102">unexpectedMessageError</span><span class="op" id="4389124">(</span><span class="ident" id="4389125">sessionTicketMsg</span><span class="op" id="4389141">,</span>&nbsp;<span class="ident" id="4389143">msg</span><span class="op" id="4389146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4389149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389152">hs</span><span class="op" id="4389154">.</span><span class="ident" id="4389155">finishedHash</span><span class="op" id="4389167">.</span><span class="ident" id="4389168">Write</span><span class="op" id="4389173">(</span><span class="ident" id="4389174">sessionTicketMsg</span><span class="op" id="4389190">.</span><span class="ident" id="4389191">marshal</span><span class="op" id="4389198">(</span><span class="op" id="4389199">)</span><span class="op" id="4389200">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389204">hs</span><span class="op" id="4389206">.</span><span class="ident" id="4389207">session</span>&nbsp;<span class="op" id="4389215">=</span>&nbsp;<span class="op" id="4389217">&amp;</span><span class="ident" id="4389218">ClientSessionState</span><span class="op" id="4389236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389240">sessionTicket</span><span class="op" id="4389253">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389260">sessionTicketMsg</span><span class="op" id="4389276">.</span><span class="ident" id="4389277">ticket</span><span class="op" id="4389283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389287">vers</span><span class="op" id="4389291">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389307">c</span><span class="op" id="4389308">.</span><span class="ident" id="4389309">vers</span><span class="op" id="4389313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389317">cipherSuite</span><span class="op" id="4389328">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389337">hs</span><span class="op" id="4389339">.</span><span class="ident" id="4389340">suite</span><span class="op" id="4389345">.</span><span class="ident" id="4389346">id</span><span class="op" id="4389348">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389352">masterSecret</span><span class="op" id="4389364">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389372">hs</span><span class="op" id="4389374">.</span><span class="ident" id="4389375">masterSecret</span><span class="op" id="4389387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389391">serverCertificates</span><span class="op" id="4389409">:</span>&nbsp;<span class="ident" id="4389411">c</span><span class="op" id="4389412">.</span><span class="ident" id="4389413">peerCertificates</span><span class="op" id="4389429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4389432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4389436">return</span>&nbsp;<span class="builtintype" id="4389443">nil</span><br>
<span class="lineno">590</span><span class="op" id="4389447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4389450">func</span>&nbsp;<span class="op" id="4389455">(</span><span class="ident" id="4389456">hs</span>&nbsp;<span class="op" id="4389459">*</span><span class="ident" id="4389460">clientHandshakeState</span><span class="op" id="4389480">)</span>&nbsp;<span class="ident" id="4389482">sendFinished</span><span class="op" id="4389494">(</span><span class="ident" id="4389495">out</span>&nbsp;<span class="op" id="4389499">[</span><span class="op" id="4389500">]</span><span class="builtintype" id="4389501">byte</span><span class="op" id="4389505">)</span>&nbsp;<span class="builtintype" id="4389507">error</span>&nbsp;<span class="op" id="4389513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389516">c</span>&nbsp;<span class="op" id="4389518">:=</span>&nbsp;<span class="ident" id="4389521">hs</span><span class="op" id="4389523">.</span><span class="ident" id="4389524">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389528">c</span><span class="op" id="4389529">.</span><span class="ident" id="4389530">writeRecord</span><span class="op" id="4389541">(</span><span class="ident" id="4389542">recordTypeChangeCipherSpec</span><span class="op" id="4389568">,</span>&nbsp;<span class="op" id="4389570">[</span><span class="op" id="4389571">]</span><span class="builtintype" id="4389572">byte</span><span class="op" id="4389576">{</span><span class="num" id="4389577">1</span><span class="op" id="4389578">}</span><span class="op" id="4389579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4389582">if</span>&nbsp;<span class="ident" id="4389585">hs</span><span class="op" id="4389587">.</span><span class="ident" id="4389588">serverHello</span><span class="op" id="4389599">.</span><span class="ident" id="4389600">nextProtoNeg</span>&nbsp;<span class="op" id="4389613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389617">nextProto</span>&nbsp;<span class="op" id="4389627">:=</span>&nbsp;<span class="builtinfunc" id="4389630">new</span><span class="op" id="4389633">(</span><span class="ident" id="4389634">nextProtoMsg</span><span class="op" id="4389646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389650">proto</span><span class="op" id="4389655">,</span>&nbsp;<span class="ident" id="4389657">fallback</span>&nbsp;<span class="op" id="4389666">:=</span>&nbsp;<span class="ident" id="4389669">mutualProtocol</span><span class="op" id="4389683">(</span><span class="ident" id="4389684">c</span><span class="op" id="4389685">.</span><span class="ident" id="4389686">config</span><span class="op" id="4389692">.</span><span class="ident" id="4389693">NextProtos</span><span class="op" id="4389703">,</span>&nbsp;<span class="ident" id="4389705">hs</span><span class="op" id="4389707">.</span><span class="ident" id="4389708">serverHello</span><span class="op" id="4389719">.</span><span class="ident" id="4389720">nextProtos</span><span class="op" id="4389730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389734">nextProto</span><span class="op" id="4389743">.</span><span class="ident" id="4389744">proto</span>&nbsp;<span class="op" id="4389750">=</span>&nbsp;<span class="ident" id="4389752">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389760">c</span><span class="op" id="4389761">.</span><span class="ident" id="4389762">clientProtocol</span>&nbsp;<span class="op" id="4389777">=</span>&nbsp;<span class="ident" id="4389779">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389787">c</span><span class="op" id="4389788">.</span><span class="ident" id="4389789">clientProtocolFallback</span>&nbsp;<span class="op" id="4389812">=</span>&nbsp;<span class="ident" id="4389814">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389826">hs</span><span class="op" id="4389828">.</span><span class="ident" id="4389829">finishedHash</span><span class="op" id="4389841">.</span><span class="ident" id="4389842">Write</span><span class="op" id="4389847">(</span><span class="ident" id="4389848">nextProto</span><span class="op" id="4389857">.</span><span class="ident" id="4389858">marshal</span><span class="op" id="4389865">(</span><span class="op" id="4389866">)</span><span class="op" id="4389867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389871">c</span><span class="op" id="4389872">.</span><span class="ident" id="4389873">writeRecord</span><span class="op" id="4389884">(</span><span class="ident" id="4389885">recordTypeHandshake</span><span class="op" id="4389904">,</span>&nbsp;<span class="ident" id="4389906">nextProto</span><span class="op" id="4389915">.</span><span class="ident" id="4389916">marshal</span><span class="op" id="4389923">(</span><span class="op" id="4389924">)</span><span class="op" id="4389925">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4389928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389932">finished</span>&nbsp;<span class="op" id="4389941">:=</span>&nbsp;<span class="builtinfunc" id="4389944">new</span><span class="op" id="4389947">(</span><span class="ident" id="4389948">finishedMsg</span><span class="op" id="4389959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4389962">finished</span><span class="op" id="4389970">.</span><span class="ident" id="4389971">verifyData</span>&nbsp;<span class="op" id="4389982">=</span>&nbsp;<span class="ident" id="4389984">hs</span><span class="op" id="4389986">.</span><span class="ident" id="4389987">finishedHash</span><span class="op" id="4389999">.</span><span class="ident" id="4390000">clientSum</span><span class="op" id="4390009">(</span><span class="ident" id="4390010">hs</span><span class="op" id="4390012">.</span><span class="ident" id="4390013">masterSecret</span><span class="op" id="4390025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4390028">hs</span><span class="op" id="4390030">.</span><span class="ident" id="4390031">finishedHash</span><span class="op" id="4390043">.</span><span class="ident" id="4390044">Write</span><span class="op" id="4390049">(</span><span class="ident" id="4390050">finished</span><span class="op" id="4390058">.</span><span class="ident" id="4390059">marshal</span><span class="op" id="4390066">(</span><span class="op" id="4390067">)</span><span class="op" id="4390068">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4390071">c</span><span class="op" id="4390072">.</span><span class="ident" id="4390073">writeRecord</span><span class="op" id="4390084">(</span><span class="ident" id="4390085">recordTypeHandshake</span><span class="op" id="4390104">,</span>&nbsp;<span class="ident" id="4390106">finished</span><span class="op" id="4390114">.</span><span class="ident" id="4390115">marshal</span><span class="op" id="4390122">(</span><span class="op" id="4390123">)</span><span class="op" id="4390124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4390127">copy</span><span class="op" id="4390131">(</span><span class="ident" id="4390132">out</span><span class="op" id="4390135">,</span>&nbsp;<span class="ident" id="4390137">finished</span><span class="op" id="4390145">.</span><span class="ident" id="4390146">verifyData</span><span class="op" id="4390156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390159">return</span>&nbsp;<span class="builtintype" id="4390166">nil</span><br>
<span class="lineno"></span><span class="op" id="4390170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4390173">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4390252">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4390323">func</span>&nbsp;<span class="ident" id="4390328">clientSessionCacheKey</span><span class="op" id="4390349">(</span><span class="ident" id="4390350">serverAddr</span>&nbsp;<span class="ident" id="4390361">net</span><span class="op" id="4390364">.</span><span class="ident" id="4390365">Addr</span><span class="op" id="4390369">,</span>&nbsp;<span class="ident" id="4390371">config</span>&nbsp;<span class="op" id="4390378">*</span><span class="ident" id="4390379">Config</span><span class="op" id="4390385">)</span>&nbsp;<span class="builtintype" id="4390387">string</span>&nbsp;<span class="op" id="4390394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390397">if</span>&nbsp;<span class="builtinfunc" id="4390400">len</span><span class="op" id="4390403">(</span><span class="ident" id="4390404">config</span><span class="op" id="4390410">.</span><span class="ident" id="4390411">ServerName</span><span class="op" id="4390421">)</span>&nbsp;<span class="op" id="4390423">&gt;</span>&nbsp;<span class="num" id="4390425">0</span>&nbsp;<span class="op" id="4390427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390431">return</span>&nbsp;<span class="ident" id="4390438">config</span><span class="op" id="4390444">.</span><span class="ident" id="4390445">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4390457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390460">return</span>&nbsp;<span class="ident" id="4390467">serverAddr</span><span class="op" id="4390477">.</span><span class="ident" id="4390478">String</span><span class="op" id="4390484">(</span><span class="op" id="4390485">)</span><br>
<span class="lineno"></span><span class="op" id="4390487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4390490">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4390568">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4390644">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4390720">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4390768">func</span>&nbsp;<span class="ident" id="4390773">mutualProtocol</span><span class="op" id="4390787">(</span><span class="ident" id="4390788">protos</span><span class="op" id="4390794">,</span>&nbsp;<span class="ident" id="4390796">preferenceProtos</span>&nbsp;<span class="op" id="4390813">[</span><span class="op" id="4390814">]</span><span class="builtintype" id="4390815">string</span><span class="op" id="4390821">)</span>&nbsp;<span class="op" id="4390823">(</span><span class="builtintype" id="4390824">string</span><span class="op" id="4390830">,</span>&nbsp;<span class="builtintype" id="4390832">bool</span><span class="op" id="4390836">)</span>&nbsp;<span class="op" id="4390838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390841">for</span>&nbsp;<span class="ident" id="4390845">_</span><span class="op" id="4390846">,</span>&nbsp;<span class="ident" id="4390848">s</span>&nbsp;<span class="op" id="4390850">:=</span>&nbsp;<span class="keyword" id="4390853">range</span>&nbsp;<span class="ident" id="4390859">preferenceProtos</span>&nbsp;<span class="op" id="4390876">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390880">for</span>&nbsp;<span class="ident" id="4390884">_</span><span class="op" id="4390885">,</span>&nbsp;<span class="ident" id="4390887">c</span>&nbsp;<span class="op" id="4390889">:=</span>&nbsp;<span class="keyword" id="4390892">range</span>&nbsp;<span class="ident" id="4390898">protos</span>&nbsp;<span class="op" id="4390905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390910">if</span>&nbsp;<span class="ident" id="4390913">s</span>&nbsp;<span class="op" id="4390915">==</span>&nbsp;<span class="ident" id="4390918">c</span>&nbsp;<span class="op" id="4390920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390926">return</span>&nbsp;<span class="ident" id="4390933">s</span><span class="op" id="4390934">,</span>&nbsp;<span class="builtintype" id="4390936">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4390945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4390949">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4390952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4390956">return</span>&nbsp;<span class="ident" id="4390963">protos</span><span class="op" id="4390969">[</span><span class="num" id="4390970">0</span><span class="op" id="4390971">]</span><span class="op" id="4390972">,</span>&nbsp;<span class="builtintype" id="4390974">true</span><br>
<span class="lineno"></span><span class="op" id="4390979">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
