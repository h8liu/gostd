<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html" class="current">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4617860">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4617915">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4617969">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4618020">package</span>&nbsp;<span class="ident" id="4618028">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4618033">import</span>&nbsp;<span class="op" id="4618040">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618043">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618053">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618069">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618088">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618102">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618116">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618131">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618148">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618163">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618180">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618190">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4618196">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4618207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4618210">var</span>&nbsp;<span class="ident" id="4618214">errClientKeyExchange</span>&nbsp;<span class="op" id="4618235">=</span>&nbsp;<span class="ident" id="4618237">errors</span><span class="op" id="4618243">.</span><span class="ident" id="4618244">New</span><span class="op" id="4618247">(</span><span class="string" id="4618248">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="4618288">)</span><br>
<span class="lineno"></span><span class="keyword" id="4618290">var</span>&nbsp;<span class="ident" id="4618294">errServerKeyExchange</span>&nbsp;<span class="op" id="4618315">=</span>&nbsp;<span class="ident" id="4618317">errors</span><span class="op" id="4618323">.</span><span class="ident" id="4618324">New</span><span class="op" id="4618327">(</span><span class="string" id="4618328">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4618368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4618371">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4618449">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="4618511">type</span>&nbsp;<span class="ident" id="4618516">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="4618532">struct</span><span class="op" id="4618538">{</span><span class="op" id="4618539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4618542">func</span>&nbsp;<span class="op" id="4618547">(</span><span class="ident" id="4618548">ka</span>&nbsp;<span class="ident" id="4618551">rsaKeyAgreement</span><span class="op" id="4618566">)</span>&nbsp;<span class="ident" id="4618568">generateServerKeyExchange</span><span class="op" id="4618593">(</span><span class="ident" id="4618594">config</span>&nbsp;<span class="op" id="4618601">*</span><span class="ident" id="4618602">Config</span><span class="op" id="4618608">,</span>&nbsp;<span class="ident" id="4618610">cert</span>&nbsp;<span class="op" id="4618615">*</span><span class="ident" id="4618616">Certificate</span><span class="op" id="4618627">,</span>&nbsp;<span class="ident" id="4618629">clientHello</span>&nbsp;<span class="op" id="4618641">*</span><span class="ident" id="4618642">clientHelloMsg</span><span class="op" id="4618656">,</span>&nbsp;<span class="ident" id="4618658">hello</span>&nbsp;<span class="op" id="4618664">*</span><span class="ident" id="4618665">serverHelloMsg</span><span class="op" id="4618679">)</span>&nbsp;<span class="op" id="4618681">(</span><span class="op" id="4618682">*</span><span class="ident" id="4618683">serverKeyExchangeMsg</span><span class="op" id="4618703">,</span>&nbsp;<span class="builtintype" id="4618705">error</span><span class="op" id="4618710">)</span>&nbsp;<span class="op" id="4618712">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4618715">return</span>&nbsp;<span class="ident" id="4618722">nil</span><span class="op" id="4618725">,</span>&nbsp;<span class="ident" id="4618727">nil</span><br>
<span class="lineno"></span><span class="op" id="4618731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4618734">func</span>&nbsp;<span class="op" id="4618739">(</span><span class="ident" id="4618740">ka</span>&nbsp;<span class="ident" id="4618743">rsaKeyAgreement</span><span class="op" id="4618758">)</span>&nbsp;<span class="ident" id="4618760">processClientKeyExchange</span><span class="op" id="4618784">(</span><span class="ident" id="4618785">config</span>&nbsp;<span class="op" id="4618792">*</span><span class="ident" id="4618793">Config</span><span class="op" id="4618799">,</span>&nbsp;<span class="ident" id="4618801">cert</span>&nbsp;<span class="op" id="4618806">*</span><span class="ident" id="4618807">Certificate</span><span class="op" id="4618818">,</span>&nbsp;<span class="ident" id="4618820">ckx</span>&nbsp;<span class="op" id="4618824">*</span><span class="ident" id="4618825">clientKeyExchangeMsg</span><span class="op" id="4618845">,</span>&nbsp;<span class="ident" id="4618847">version</span>&nbsp;<span class="builtintype" id="4618855">uint16</span><span class="op" id="4618861">)</span>&nbsp;<span class="op" id="4618863">(</span><span class="op" id="4618864">[</span><span class="op" id="4618865">]</span><span class="builtintype" id="4618866">byte</span><span class="op" id="4618870">,</span>&nbsp;<span class="builtintype" id="4618872">error</span><span class="op" id="4618877">)</span>&nbsp;<span class="op" id="4618879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4618882">preMasterSecret</span>&nbsp;<span class="op" id="4618898">:=</span>&nbsp;<span class="builtinfunc" id="4618901">make</span><span class="op" id="4618905">(</span><span class="op" id="4618906">[</span><span class="op" id="4618907">]</span><span class="builtintype" id="4618908">byte</span><span class="op" id="4618912">,</span>&nbsp;<span class="num" id="4618914">48</span><span class="op" id="4618916">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4618919">_</span><span class="op" id="4618920">,</span>&nbsp;<span class="ident" id="4618922">err</span>&nbsp;<span class="op" id="4618926">:=</span>&nbsp;<span class="ident" id="4618929">io</span><span class="op" id="4618931">.</span><span class="ident" id="4618932">ReadFull</span><span class="op" id="4618940">(</span><span class="ident" id="4618941">config</span><span class="op" id="4618947">.</span><span class="ident" id="4618948">rand</span><span class="op" id="4618952">(</span><span class="op" id="4618953">)</span><span class="op" id="4618954">,</span>&nbsp;<span class="ident" id="4618956">preMasterSecret</span><span class="op" id="4618971">[</span><span class="num" id="4618972">2</span><span class="op" id="4618973">:</span><span class="op" id="4618974">]</span><span class="op" id="4618975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4618978">if</span>&nbsp;<span class="ident" id="4618981">err</span>&nbsp;<span class="op" id="4618985">!=</span>&nbsp;<span class="ident" id="4618988">nil</span>&nbsp;<span class="op" id="4618992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4618996">return</span>&nbsp;<span class="ident" id="4619003">nil</span><span class="op" id="4619006">,</span>&nbsp;<span class="ident" id="4619008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4619013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619017">if</span>&nbsp;<span class="builtinfunc" id="4619020">len</span><span class="op" id="4619023">(</span><span class="ident" id="4619024">ckx</span><span class="op" id="4619027">.</span><span class="ident" id="4619028">ciphertext</span><span class="op" id="4619038">)</span>&nbsp;<span class="op" id="4619040">&lt;</span>&nbsp;<span class="num" id="4619042">2</span>&nbsp;<span class="op" id="4619044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619048">return</span>&nbsp;<span class="ident" id="4619055">nil</span><span class="op" id="4619058">,</span>&nbsp;<span class="ident" id="4619060">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4619082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619086">ciphertext</span>&nbsp;<span class="op" id="4619097">:=</span>&nbsp;<span class="ident" id="4619100">ckx</span><span class="op" id="4619103">.</span><span class="ident" id="4619104">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619116">if</span>&nbsp;<span class="ident" id="4619119">version</span>&nbsp;<span class="op" id="4619127">!=</span>&nbsp;<span class="ident" id="4619130">VersionSSL30</span>&nbsp;<span class="op" id="4619143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619147">ciphertextLen</span>&nbsp;<span class="op" id="4619161">:=</span>&nbsp;<span class="builtintype" id="4619164">int</span><span class="op" id="4619167">(</span><span class="ident" id="4619168">ckx</span><span class="op" id="4619171">.</span><span class="ident" id="4619172">ciphertext</span><span class="op" id="4619182">[</span><span class="num" id="4619183">0</span><span class="op" id="4619184">]</span><span class="op" id="4619185">)</span><span class="op" id="4619186">&lt;&lt;</span><span class="num" id="4619188">8</span>&nbsp;<span class="op" id="4619190">|</span>&nbsp;<span class="builtintype" id="4619192">int</span><span class="op" id="4619195">(</span><span class="ident" id="4619196">ckx</span><span class="op" id="4619199">.</span><span class="ident" id="4619200">ciphertext</span><span class="op" id="4619210">[</span><span class="num" id="4619211">1</span><span class="op" id="4619212">]</span><span class="op" id="4619213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619217">if</span>&nbsp;<span class="ident" id="4619220">ciphertextLen</span>&nbsp;<span class="op" id="4619234">!=</span>&nbsp;<span class="builtinfunc" id="4619237">len</span><span class="op" id="4619240">(</span><span class="ident" id="4619241">ckx</span><span class="op" id="4619244">.</span><span class="ident" id="4619245">ciphertext</span><span class="op" id="4619255">)</span><span class="op" id="4619256">-</span><span class="num" id="4619257">2</span>&nbsp;<span class="op" id="4619259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619264">return</span>&nbsp;<span class="ident" id="4619271">nil</span><span class="op" id="4619274">,</span>&nbsp;<span class="ident" id="4619276">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4619299">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619303">ciphertext</span>&nbsp;<span class="op" id="4619314">=</span>&nbsp;<span class="ident" id="4619316">ckx</span><span class="op" id="4619319">.</span><span class="ident" id="4619320">ciphertext</span><span class="op" id="4619330">[</span><span class="num" id="4619331">2</span><span class="op" id="4619332">:</span><span class="op" id="4619333">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4619336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4619340">err</span>&nbsp;<span class="op" id="4619344">=</span>&nbsp;<span class="ident" id="4619346">rsa</span><span class="op" id="4619349">.</span><span class="ident" id="4619350">DecryptPKCS1v15SessionKey</span><span class="op" id="4619375">(</span><span class="ident" id="4619376">config</span><span class="op" id="4619382">.</span><span class="ident" id="4619383">rand</span><span class="op" id="4619387">(</span><span class="op" id="4619388">)</span><span class="op" id="4619389">,</span>&nbsp;<span class="ident" id="4619391">cert</span><span class="op" id="4619395">.</span><span class="ident" id="4619396">PrivateKey</span><span class="op" id="4619406">.</span><span class="op" id="4619407">(</span><span class="op" id="4619408">*</span><span class="ident" id="4619409">rsa</span><span class="op" id="4619412">.</span><span class="ident" id="4619413">PrivateKey</span><span class="op" id="4619423">)</span><span class="op" id="4619424">,</span>&nbsp;<span class="ident" id="4619426">ciphertext</span><span class="op" id="4619436">,</span>&nbsp;<span class="ident" id="4619438">preMasterSecret</span><span class="op" id="4619453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619456">if</span>&nbsp;<span class="ident" id="4619459">err</span>&nbsp;<span class="op" id="4619463">!=</span>&nbsp;<span class="ident" id="4619466">nil</span>&nbsp;<span class="op" id="4619470">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619474">return</span>&nbsp;<span class="ident" id="4619481">nil</span><span class="op" id="4619484">,</span>&nbsp;<span class="ident" id="4619486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4619491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619494">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619567">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619639">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619707">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619780">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4619847">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4619872">return</span>&nbsp;<span class="ident" id="4619879">preMasterSecret</span><span class="op" id="4619894">,</span>&nbsp;<span class="ident" id="4619896">nil</span><br>
<span class="lineno"></span><span class="op" id="4619900">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4619903">func</span>&nbsp;<span class="op" id="4619908">(</span><span class="ident" id="4619909">ka</span>&nbsp;<span class="ident" id="4619912">rsaKeyAgreement</span><span class="op" id="4619927">)</span>&nbsp;<span class="ident" id="4619929">processServerKeyExchange</span><span class="op" id="4619953">(</span><span class="ident" id="4619954">config</span>&nbsp;<span class="op" id="4619961">*</span><span class="ident" id="4619962">Config</span><span class="op" id="4619968">,</span>&nbsp;<span class="ident" id="4619970">clientHello</span>&nbsp;<span class="op" id="4619982">*</span><span class="ident" id="4619983">clientHelloMsg</span><span class="op" id="4619997">,</span>&nbsp;<span class="ident" id="4619999">serverHello</span>&nbsp;<span class="op" id="4620011">*</span><span class="ident" id="4620012">serverHelloMsg</span><span class="op" id="4620026">,</span>&nbsp;<span class="ident" id="4620028">cert</span>&nbsp;<span class="op" id="4620033">*</span><span class="ident" id="4620034">x509</span><span class="op" id="4620038">.</span><span class="ident" id="4620039">Certificate</span><span class="op" id="4620050">,</span>&nbsp;<span class="ident" id="4620052">skx</span>&nbsp;<span class="op" id="4620056">*</span><span class="ident" id="4620057">serverKeyExchangeMsg</span><span class="op" id="4620077">)</span>&nbsp;<span class="builtintype" id="4620079">error</span>&nbsp;<span class="op" id="4620085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620088">return</span>&nbsp;<span class="ident" id="4620095">errors</span><span class="op" id="4620101">.</span><span class="ident" id="4620102">New</span><span class="op" id="4620105">(</span><span class="string" id="4620106">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="4620141">)</span><br>
<span class="lineno"></span><span class="op" id="4620143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4620146">func</span>&nbsp;<span class="op" id="4620151">(</span><span class="ident" id="4620152">ka</span>&nbsp;<span class="ident" id="4620155">rsaKeyAgreement</span><span class="op" id="4620170">)</span>&nbsp;<span class="ident" id="4620172">generateClientKeyExchange</span><span class="op" id="4620197">(</span><span class="ident" id="4620198">config</span>&nbsp;<span class="op" id="4620205">*</span><span class="ident" id="4620206">Config</span><span class="op" id="4620212">,</span>&nbsp;<span class="ident" id="4620214">clientHello</span>&nbsp;<span class="op" id="4620226">*</span><span class="ident" id="4620227">clientHelloMsg</span><span class="op" id="4620241">,</span>&nbsp;<span class="ident" id="4620243">cert</span>&nbsp;<span class="op" id="4620248">*</span><span class="ident" id="4620249">x509</span><span class="op" id="4620253">.</span><span class="ident" id="4620254">Certificate</span><span class="op" id="4620265">)</span>&nbsp;<span class="op" id="4620267">(</span><span class="op" id="4620268">[</span><span class="op" id="4620269">]</span><span class="builtintype" id="4620270">byte</span><span class="op" id="4620274">,</span>&nbsp;<span class="op" id="4620276">*</span><span class="ident" id="4620277">clientKeyExchangeMsg</span><span class="op" id="4620297">,</span>&nbsp;<span class="builtintype" id="4620299">error</span><span class="op" id="4620304">)</span>&nbsp;<span class="op" id="4620306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620309">preMasterSecret</span>&nbsp;<span class="op" id="4620325">:=</span>&nbsp;<span class="builtinfunc" id="4620328">make</span><span class="op" id="4620332">(</span><span class="op" id="4620333">[</span><span class="op" id="4620334">]</span><span class="builtintype" id="4620335">byte</span><span class="op" id="4620339">,</span>&nbsp;<span class="num" id="4620341">48</span><span class="op" id="4620343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620346">preMasterSecret</span><span class="op" id="4620361">[</span><span class="num" id="4620362">0</span><span class="op" id="4620363">]</span>&nbsp;<span class="op" id="4620365">=</span>&nbsp;<span class="builtintype" id="4620367">byte</span><span class="op" id="4620371">(</span><span class="ident" id="4620372">clientHello</span><span class="op" id="4620383">.</span><span class="ident" id="4620384">vers</span>&nbsp;<span class="op" id="4620389">&gt;&gt;</span>&nbsp;<span class="num" id="4620392">8</span><span class="op" id="4620393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620396">preMasterSecret</span><span class="op" id="4620411">[</span><span class="num" id="4620412">1</span><span class="op" id="4620413">]</span>&nbsp;<span class="op" id="4620415">=</span>&nbsp;<span class="builtintype" id="4620417">byte</span><span class="op" id="4620421">(</span><span class="ident" id="4620422">clientHello</span><span class="op" id="4620433">.</span><span class="ident" id="4620434">vers</span><span class="op" id="4620438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620441">_</span><span class="op" id="4620442">,</span>&nbsp;<span class="ident" id="4620444">err</span>&nbsp;<span class="op" id="4620448">:=</span>&nbsp;<span class="ident" id="4620451">io</span><span class="op" id="4620453">.</span><span class="ident" id="4620454">ReadFull</span><span class="op" id="4620462">(</span><span class="ident" id="4620463">config</span><span class="op" id="4620469">.</span><span class="ident" id="4620470">rand</span><span class="op" id="4620474">(</span><span class="op" id="4620475">)</span><span class="op" id="4620476">,</span>&nbsp;<span class="ident" id="4620478">preMasterSecret</span><span class="op" id="4620493">[</span><span class="num" id="4620494">2</span><span class="op" id="4620495">:</span><span class="op" id="4620496">]</span><span class="op" id="4620497">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620500">if</span>&nbsp;<span class="ident" id="4620503">err</span>&nbsp;<span class="op" id="4620507">!=</span>&nbsp;<span class="ident" id="4620510">nil</span>&nbsp;<span class="op" id="4620514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620518">return</span>&nbsp;<span class="ident" id="4620525">nil</span><span class="op" id="4620528">,</span>&nbsp;<span class="ident" id="4620530">nil</span><span class="op" id="4620533">,</span>&nbsp;<span class="ident" id="4620535">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620544">encrypted</span><span class="op" id="4620553">,</span>&nbsp;<span class="ident" id="4620555">err</span>&nbsp;<span class="op" id="4620559">:=</span>&nbsp;<span class="ident" id="4620562">rsa</span><span class="op" id="4620565">.</span><span class="ident" id="4620566">EncryptPKCS1v15</span><span class="op" id="4620581">(</span><span class="ident" id="4620582">config</span><span class="op" id="4620588">.</span><span class="ident" id="4620589">rand</span><span class="op" id="4620593">(</span><span class="op" id="4620594">)</span><span class="op" id="4620595">,</span>&nbsp;<span class="ident" id="4620597">cert</span><span class="op" id="4620601">.</span><span class="ident" id="4620602">PublicKey</span><span class="op" id="4620611">.</span><span class="op" id="4620612">(</span><span class="op" id="4620613">*</span><span class="ident" id="4620614">rsa</span><span class="op" id="4620617">.</span><span class="ident" id="4620618">PublicKey</span><span class="op" id="4620627">)</span><span class="op" id="4620628">,</span>&nbsp;<span class="ident" id="4620630">preMasterSecret</span><span class="op" id="4620645">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620648">if</span>&nbsp;<span class="ident" id="4620651">err</span>&nbsp;<span class="op" id="4620655">!=</span>&nbsp;<span class="ident" id="4620658">nil</span>&nbsp;<span class="op" id="4620662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620666">return</span>&nbsp;<span class="ident" id="4620673">nil</span><span class="op" id="4620676">,</span>&nbsp;<span class="ident" id="4620678">nil</span><span class="op" id="4620681">,</span>&nbsp;<span class="ident" id="4620683">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4620688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620691">ckx</span>&nbsp;<span class="op" id="4620695">:=</span>&nbsp;<span class="builtinfunc" id="4620698">new</span><span class="op" id="4620701">(</span><span class="ident" id="4620702">clientKeyExchangeMsg</span><span class="op" id="4620722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620725">ckx</span><span class="op" id="4620728">.</span><span class="ident" id="4620729">ciphertext</span>&nbsp;<span class="op" id="4620740">=</span>&nbsp;<span class="builtinfunc" id="4620742">make</span><span class="op" id="4620746">(</span><span class="op" id="4620747">[</span><span class="op" id="4620748">]</span><span class="builtintype" id="4620749">byte</span><span class="op" id="4620753">,</span>&nbsp;<span class="builtinfunc" id="4620755">len</span><span class="op" id="4620758">(</span><span class="ident" id="4620759">encrypted</span><span class="op" id="4620768">)</span><span class="op" id="4620769">+</span><span class="num" id="4620770">2</span><span class="op" id="4620771">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620774">ckx</span><span class="op" id="4620777">.</span><span class="ident" id="4620778">ciphertext</span><span class="op" id="4620788">[</span><span class="num" id="4620789">0</span><span class="op" id="4620790">]</span>&nbsp;<span class="op" id="4620792">=</span>&nbsp;<span class="builtintype" id="4620794">byte</span><span class="op" id="4620798">(</span><span class="builtinfunc" id="4620799">len</span><span class="op" id="4620802">(</span><span class="ident" id="4620803">encrypted</span><span class="op" id="4620812">)</span>&nbsp;<span class="op" id="4620814">&gt;&gt;</span>&nbsp;<span class="num" id="4620817">8</span><span class="op" id="4620818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4620821">ckx</span><span class="op" id="4620824">.</span><span class="ident" id="4620825">ciphertext</span><span class="op" id="4620835">[</span><span class="num" id="4620836">1</span><span class="op" id="4620837">]</span>&nbsp;<span class="op" id="4620839">=</span>&nbsp;<span class="builtintype" id="4620841">byte</span><span class="op" id="4620845">(</span><span class="builtinfunc" id="4620846">len</span><span class="op" id="4620849">(</span><span class="ident" id="4620850">encrypted</span><span class="op" id="4620859">)</span><span class="op" id="4620860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4620863">copy</span><span class="op" id="4620867">(</span><span class="ident" id="4620868">ckx</span><span class="op" id="4620871">.</span><span class="ident" id="4620872">ciphertext</span><span class="op" id="4620882">[</span><span class="num" id="4620883">2</span><span class="op" id="4620884">:</span><span class="op" id="4620885">]</span><span class="op" id="4620886">,</span>&nbsp;<span class="ident" id="4620888">encrypted</span><span class="op" id="4620897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4620900">return</span>&nbsp;<span class="ident" id="4620907">preMasterSecret</span><span class="op" id="4620922">,</span>&nbsp;<span class="ident" id="4620924">ckx</span><span class="op" id="4620927">,</span>&nbsp;<span class="ident" id="4620929">nil</span><br>
<span class="lineno"></span><span class="op" id="4620933">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4620936">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="4620999">func</span>&nbsp;<span class="ident" id="4621004">sha1Hash</span><span class="op" id="4621012">(</span><span class="ident" id="4621013">slices</span>&nbsp;<span class="op" id="4621020">[</span><span class="op" id="4621021">]</span><span class="op" id="4621022">[</span><span class="op" id="4621023">]</span><span class="builtintype" id="4621024">byte</span><span class="op" id="4621028">)</span>&nbsp;<span class="op" id="4621030">[</span><span class="op" id="4621031">]</span><span class="builtintype" id="4621032">byte</span>&nbsp;<span class="op" id="4621037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621040">hsha1</span>&nbsp;<span class="op" id="4621046">:=</span>&nbsp;<span class="ident" id="4621049">sha1</span><span class="op" id="4621053">.</span><span class="ident" id="4621054">New</span><span class="op" id="4621057">(</span><span class="op" id="4621058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621061">for</span>&nbsp;<span class="ident" id="4621065">_</span><span class="op" id="4621066">,</span>&nbsp;<span class="ident" id="4621068">slice</span>&nbsp;<span class="op" id="4621074">:=</span>&nbsp;<span class="keyword" id="4621077">range</span>&nbsp;<span class="ident" id="4621083">slices</span>&nbsp;<span class="op" id="4621090">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621094">hsha1</span><span class="op" id="4621099">.</span><span class="ident" id="4621100">Write</span><span class="op" id="4621105">(</span><span class="ident" id="4621106">slice</span><span class="op" id="4621111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4621114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621117">return</span>&nbsp;<span class="ident" id="4621124">hsha1</span><span class="op" id="4621129">.</span><span class="ident" id="4621130">Sum</span><span class="op" id="4621133">(</span><span class="ident" id="4621134">nil</span><span class="op" id="4621137">)</span><br>
<span class="lineno"></span><span class="op" id="4621139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4621142">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4621221">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="4621263">func</span>&nbsp;<span class="ident" id="4621268">md5SHA1Hash</span><span class="op" id="4621279">(</span><span class="ident" id="4621280">slices</span>&nbsp;<span class="op" id="4621287">[</span><span class="op" id="4621288">]</span><span class="op" id="4621289">[</span><span class="op" id="4621290">]</span><span class="builtintype" id="4621291">byte</span><span class="op" id="4621295">)</span>&nbsp;<span class="op" id="4621297">[</span><span class="op" id="4621298">]</span><span class="builtintype" id="4621299">byte</span>&nbsp;<span class="op" id="4621304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621307">md5sha1</span>&nbsp;<span class="op" id="4621315">:=</span>&nbsp;<span class="builtinfunc" id="4621318">make</span><span class="op" id="4621322">(</span><span class="op" id="4621323">[</span><span class="op" id="4621324">]</span><span class="builtintype" id="4621325">byte</span><span class="op" id="4621329">,</span>&nbsp;<span class="ident" id="4621331">md5</span><span class="op" id="4621334">.</span><span class="ident" id="4621335">Size</span><span class="op" id="4621339">+</span><span class="ident" id="4621340">sha1</span><span class="op" id="4621344">.</span><span class="ident" id="4621345">Size</span><span class="op" id="4621349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621352">hmd5</span>&nbsp;<span class="op" id="4621357">:=</span>&nbsp;<span class="ident" id="4621360">md5</span><span class="op" id="4621363">.</span><span class="ident" id="4621364">New</span><span class="op" id="4621367">(</span><span class="op" id="4621368">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621371">for</span>&nbsp;<span class="ident" id="4621375">_</span><span class="op" id="4621376">,</span>&nbsp;<span class="ident" id="4621378">slice</span>&nbsp;<span class="op" id="4621384">:=</span>&nbsp;<span class="keyword" id="4621387">range</span>&nbsp;<span class="ident" id="4621393">slices</span>&nbsp;<span class="op" id="4621400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621404">hmd5</span><span class="op" id="4621408">.</span><span class="ident" id="4621409">Write</span><span class="op" id="4621414">(</span><span class="ident" id="4621415">slice</span><span class="op" id="4621420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4621423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4621426">copy</span><span class="op" id="4621430">(</span><span class="ident" id="4621431">md5sha1</span><span class="op" id="4621438">,</span>&nbsp;<span class="ident" id="4621440">hmd5</span><span class="op" id="4621444">.</span><span class="ident" id="4621445">Sum</span><span class="op" id="4621448">(</span><span class="ident" id="4621449">nil</span><span class="op" id="4621452">)</span><span class="op" id="4621453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4621456">copy</span><span class="op" id="4621460">(</span><span class="ident" id="4621461">md5sha1</span><span class="op" id="4621468">[</span><span class="ident" id="4621469">md5</span><span class="op" id="4621472">.</span><span class="ident" id="4621473">Size</span><span class="op" id="4621477">:</span><span class="op" id="4621478">]</span><span class="op" id="4621479">,</span>&nbsp;<span class="ident" id="4621481">sha1Hash</span><span class="op" id="4621489">(</span><span class="ident" id="4621490">slices</span><span class="op" id="4621496">)</span><span class="op" id="4621497">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621500">return</span>&nbsp;<span class="ident" id="4621507">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="4621515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4621518">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="4621568">func</span>&nbsp;<span class="ident" id="4621573">sha256Hash</span><span class="op" id="4621583">(</span><span class="ident" id="4621584">slices</span>&nbsp;<span class="op" id="4621591">[</span><span class="op" id="4621592">]</span><span class="op" id="4621593">[</span><span class="op" id="4621594">]</span><span class="builtintype" id="4621595">byte</span><span class="op" id="4621599">)</span>&nbsp;<span class="op" id="4621601">[</span><span class="op" id="4621602">]</span><span class="builtintype" id="4621603">byte</span>&nbsp;<span class="op" id="4621608">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621611">h</span>&nbsp;<span class="op" id="4621613">:=</span>&nbsp;<span class="ident" id="4621616">sha256</span><span class="op" id="4621622">.</span><span class="ident" id="4621623">New</span><span class="op" id="4621626">(</span><span class="op" id="4621627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621630">for</span>&nbsp;<span class="ident" id="4621634">_</span><span class="op" id="4621635">,</span>&nbsp;<span class="ident" id="4621637">slice</span>&nbsp;<span class="op" id="4621643">:=</span>&nbsp;<span class="keyword" id="4621646">range</span>&nbsp;<span class="ident" id="4621652">slices</span>&nbsp;<span class="op" id="4621659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4621663">h</span><span class="op" id="4621664">.</span><span class="ident" id="4621665">Write</span><span class="op" id="4621670">(</span><span class="ident" id="4621671">slice</span><span class="op" id="4621676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4621679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4621682">return</span>&nbsp;<span class="ident" id="4621689">h</span><span class="op" id="4621690">.</span><span class="ident" id="4621691">Sum</span><span class="op" id="4621694">(</span><span class="ident" id="4621695">nil</span><span class="op" id="4621698">)</span><br>
<span class="lineno">120</span><span class="op" id="4621700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4621703">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="4621780">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="4621859">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="4621933">func</span>&nbsp;<span class="ident" id="4621938">hashForServerKeyExchange</span><span class="op" id="4621962">(</span><span class="ident" id="4621963">sigType</span><span class="op" id="4621970">,</span>&nbsp;<span class="ident" id="4621972">hashFunc</span>&nbsp;<span class="builtintype" id="4621981">uint8</span><span class="op" id="4621986">,</span>&nbsp;<span class="ident" id="4621988">version</span>&nbsp;<span class="builtintype" id="4621996">uint16</span><span class="op" id="4622002">,</span>&nbsp;<span class="ident" id="4622004">slices</span>&nbsp;<span class="op" id="4622011">...</span><span class="op" id="4622014">[</span><span class="op" id="4622015">]</span><span class="builtintype" id="4622016">byte</span><span class="op" id="4622020">)</span>&nbsp;<span class="op" id="4622022">(</span><span class="op" id="4622023">[</span><span class="op" id="4622024">]</span><span class="builtintype" id="4622025">byte</span><span class="op" id="4622029">,</span>&nbsp;<span class="ident" id="4622031">crypto</span><span class="op" id="4622037">.</span><span class="ident" id="4622038">Hash</span><span class="op" id="4622042">,</span>&nbsp;<span class="builtintype" id="4622044">error</span><span class="op" id="4622049">)</span>&nbsp;<span class="op" id="4622051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622054">if</span>&nbsp;<span class="ident" id="4622057">version</span>&nbsp;<span class="op" id="4622065">&gt;=</span>&nbsp;<span class="ident" id="4622068">VersionTLS12</span>&nbsp;<span class="op" id="4622081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622085">switch</span>&nbsp;<span class="ident" id="4622092">hashFunc</span>&nbsp;<span class="op" id="4622101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622105">case</span>&nbsp;<span class="ident" id="4622110">hashSHA256</span><span class="op" id="4622120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622125">return</span>&nbsp;<span class="ident" id="4622132">sha256Hash</span><span class="op" id="4622142">(</span><span class="ident" id="4622143">slices</span><span class="op" id="4622149">)</span><span class="op" id="4622150">,</span>&nbsp;<span class="ident" id="4622152">crypto</span><span class="op" id="4622158">.</span><span class="ident" id="4622159">SHA256</span><span class="op" id="4622165">,</span>&nbsp;<span class="ident" id="4622167">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622173">case</span>&nbsp;<span class="ident" id="4622178">hashSHA1</span><span class="op" id="4622186">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622191">return</span>&nbsp;<span class="ident" id="4622198">sha1Hash</span><span class="op" id="4622206">(</span><span class="ident" id="4622207">slices</span><span class="op" id="4622213">)</span><span class="op" id="4622214">,</span>&nbsp;<span class="ident" id="4622216">crypto</span><span class="op" id="4622222">.</span><span class="ident" id="4622223">SHA1</span><span class="op" id="4622227">,</span>&nbsp;<span class="ident" id="4622229">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622235">default</span><span class="op" id="4622242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622247">return</span>&nbsp;<span class="ident" id="4622254">nil</span><span class="op" id="4622257">,</span>&nbsp;<span class="ident" id="4622259">crypto</span><span class="op" id="4622265">.</span><span class="ident" id="4622266">Hash</span><span class="op" id="4622270">(</span><span class="num" id="4622271">0</span><span class="op" id="4622272">)</span><span class="op" id="4622273">,</span>&nbsp;<span class="ident" id="4622275">errors</span><span class="op" id="4622281">.</span><span class="ident" id="4622282">New</span><span class="op" id="4622285">(</span><span class="string" id="4622286">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="4622327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622331">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622337">if</span>&nbsp;<span class="ident" id="4622340">sigType</span>&nbsp;<span class="op" id="4622348">==</span>&nbsp;<span class="ident" id="4622351">signatureECDSA</span>&nbsp;<span class="op" id="4622366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622370">return</span>&nbsp;<span class="ident" id="4622377">sha1Hash</span><span class="op" id="4622385">(</span><span class="ident" id="4622386">slices</span><span class="op" id="4622392">)</span><span class="op" id="4622393">,</span>&nbsp;<span class="ident" id="4622395">crypto</span><span class="op" id="4622401">.</span><span class="ident" id="4622402">SHA1</span><span class="op" id="4622406">,</span>&nbsp;<span class="ident" id="4622408">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4622413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622416">return</span>&nbsp;<span class="ident" id="4622423">md5SHA1Hash</span><span class="op" id="4622434">(</span><span class="ident" id="4622435">slices</span><span class="op" id="4622441">)</span><span class="op" id="4622442">,</span>&nbsp;<span class="ident" id="4622444">crypto</span><span class="op" id="4622450">.</span><span class="ident" id="4622451">MD5SHA1</span><span class="op" id="4622458">,</span>&nbsp;<span class="ident" id="4622460">nil</span><br>
<span class="lineno">140</span><span class="op" id="4622464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4622467">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4622544">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4622618">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="4622683">func</span>&nbsp;<span class="ident" id="4622688">pickTLS12HashForSignature</span><span class="op" id="4622713">(</span><span class="ident" id="4622714">sigType</span>&nbsp;<span class="builtintype" id="4622722">uint8</span><span class="op" id="4622727">,</span>&nbsp;<span class="ident" id="4622729">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4622754">[</span><span class="op" id="4622755">]</span><span class="ident" id="4622756">signatureAndHash</span><span class="op" id="4622772">)</span>&nbsp;<span class="op" id="4622774">(</span><span class="builtintype" id="4622775">uint8</span><span class="op" id="4622780">,</span>&nbsp;<span class="builtintype" id="4622782">error</span><span class="op" id="4622787">)</span>&nbsp;<span class="op" id="4622789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4622792">if</span>&nbsp;<span class="builtinfunc" id="4622795">len</span><span class="op" id="4622798">(</span><span class="ident" id="4622799">clientSignatureAndHashes</span><span class="op" id="4622823">)</span>&nbsp;<span class="op" id="4622825">==</span>&nbsp;<span class="num" id="4622828">0</span>&nbsp;<span class="op" id="4622830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4622834">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4622893">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4622954">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623012">return</span>&nbsp;<span class="ident" id="4623019">hashSHA1</span><span class="op" id="4623027">,</span>&nbsp;<span class="ident" id="4623029">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623038">for</span>&nbsp;<span class="ident" id="4623042">_</span><span class="op" id="4623043">,</span>&nbsp;<span class="ident" id="4623045">sigAndHash</span>&nbsp;<span class="op" id="4623056">:=</span>&nbsp;<span class="keyword" id="4623059">range</span>&nbsp;<span class="ident" id="4623065">clientSignatureAndHashes</span>&nbsp;<span class="op" id="4623090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623094">if</span>&nbsp;<span class="ident" id="4623097">sigAndHash</span><span class="op" id="4623107">.</span><span class="ident" id="4623108">signature</span>&nbsp;<span class="op" id="4623118">!=</span>&nbsp;<span class="ident" id="4623121">sigType</span>&nbsp;<span class="op" id="4623129">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623134">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623149">switch</span>&nbsp;<span class="ident" id="4623156">sigAndHash</span><span class="op" id="4623166">.</span><span class="ident" id="4623167">hash</span>&nbsp;<span class="op" id="4623172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623176">case</span>&nbsp;<span class="ident" id="4623181">hashSHA1</span><span class="op" id="4623189">,</span>&nbsp;<span class="ident" id="4623191">hashSHA256</span><span class="op" id="4623201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623206">return</span>&nbsp;<span class="ident" id="4623213">sigAndHash</span><span class="op" id="4623223">.</span><span class="ident" id="4623224">hash</span><span class="op" id="4623228">,</span>&nbsp;<span class="ident" id="4623230">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623243">return</span>&nbsp;<span class="num" id="4623250">0</span><span class="op" id="4623251">,</span>&nbsp;<span class="ident" id="4623253">errors</span><span class="op" id="4623259">.</span><span class="ident" id="4623260">New</span><span class="op" id="4623263">(</span><span class="string" id="4623264">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="4623319">)</span><br>
<span class="lineno"></span><span class="op" id="4623321">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4623324">func</span>&nbsp;<span class="ident" id="4623329">curveForCurveID</span><span class="op" id="4623344">(</span><span class="ident" id="4623345">id</span>&nbsp;<span class="ident" id="4623348">CurveID</span><span class="op" id="4623355">)</span>&nbsp;<span class="op" id="4623357">(</span><span class="ident" id="4623358">elliptic</span><span class="op" id="4623366">.</span><span class="ident" id="4623367">Curve</span><span class="op" id="4623372">,</span>&nbsp;<span class="builtintype" id="4623374">bool</span><span class="op" id="4623378">)</span>&nbsp;<span class="op" id="4623380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623383">switch</span>&nbsp;<span class="ident" id="4623390">id</span>&nbsp;<span class="op" id="4623393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623396">case</span>&nbsp;<span class="ident" id="4623401">CurveP256</span><span class="op" id="4623410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623414">return</span>&nbsp;<span class="ident" id="4623421">elliptic</span><span class="op" id="4623429">.</span><span class="ident" id="4623430">P256</span><span class="op" id="4623434">(</span><span class="op" id="4623435">)</span><span class="op" id="4623436">,</span>&nbsp;<span class="builtintype" id="4623438">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623444">case</span>&nbsp;<span class="ident" id="4623449">CurveP384</span><span class="op" id="4623458">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623462">return</span>&nbsp;<span class="ident" id="4623469">elliptic</span><span class="op" id="4623477">.</span><span class="ident" id="4623478">P384</span><span class="op" id="4623482">(</span><span class="op" id="4623483">)</span><span class="op" id="4623484">,</span>&nbsp;<span class="builtintype" id="4623486">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623492">case</span>&nbsp;<span class="ident" id="4623497">CurveP521</span><span class="op" id="4623506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623510">return</span>&nbsp;<span class="ident" id="4623517">elliptic</span><span class="op" id="4623525">.</span><span class="ident" id="4623526">P521</span><span class="op" id="4623530">(</span><span class="op" id="4623531">)</span><span class="op" id="4623532">,</span>&nbsp;<span class="builtintype" id="4623534">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623540">default</span><span class="op" id="4623547">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4623551">return</span>&nbsp;<span class="ident" id="4623558">nil</span><span class="op" id="4623561">,</span>&nbsp;<span class="builtintype" id="4623563">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4623570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="4623573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="4623576">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4623648">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4623718">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="4623788">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="4623815">type</span>&nbsp;<span class="ident" id="4623820">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="4623838">struct</span>&nbsp;<span class="op" id="4623845">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623848">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4623859">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623867">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4623878">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623885">privateKey</span>&nbsp;<span class="op" id="4623896">[</span><span class="op" id="4623897">]</span><span class="builtintype" id="4623898">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623904">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4623915">elliptic</span><span class="op" id="4623923">.</span><span class="ident" id="4623924">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4623931">x</span><span class="op" id="4623932">,</span>&nbsp;<span class="ident" id="4623934">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4623942">*</span><span class="ident" id="4623943">big</span><span class="op" id="4623946">.</span><span class="ident" id="4623947">Int</span><br>
<span class="lineno">190</span><span class="op" id="4623951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4623954">func</span>&nbsp;<span class="op" id="4623959">(</span><span class="ident" id="4623960">ka</span>&nbsp;<span class="op" id="4623963">*</span><span class="ident" id="4623964">ecdheKeyAgreement</span><span class="op" id="4623981">)</span>&nbsp;<span class="ident" id="4623983">generateServerKeyExchange</span><span class="op" id="4624008">(</span><span class="ident" id="4624009">config</span>&nbsp;<span class="op" id="4624016">*</span><span class="ident" id="4624017">Config</span><span class="op" id="4624023">,</span>&nbsp;<span class="ident" id="4624025">cert</span>&nbsp;<span class="op" id="4624030">*</span><span class="ident" id="4624031">Certificate</span><span class="op" id="4624042">,</span>&nbsp;<span class="ident" id="4624044">clientHello</span>&nbsp;<span class="op" id="4624056">*</span><span class="ident" id="4624057">clientHelloMsg</span><span class="op" id="4624071">,</span>&nbsp;<span class="ident" id="4624073">hello</span>&nbsp;<span class="op" id="4624079">*</span><span class="ident" id="4624080">serverHelloMsg</span><span class="op" id="4624094">)</span>&nbsp;<span class="op" id="4624096">(</span><span class="op" id="4624097">*</span><span class="ident" id="4624098">serverKeyExchangeMsg</span><span class="op" id="4624118">,</span>&nbsp;<span class="builtintype" id="4624120">error</span><span class="op" id="4624125">)</span>&nbsp;<span class="op" id="4624127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624130">var</span>&nbsp;<span class="ident" id="4624134">curveid</span>&nbsp;<span class="ident" id="4624142">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624151">preferredCurves</span>&nbsp;<span class="op" id="4624167">:=</span>&nbsp;<span class="ident" id="4624170">config</span><span class="op" id="4624176">.</span><span class="ident" id="4624177">curvePreferences</span><span class="op" id="4624193">(</span><span class="op" id="4624194">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="4624197">NextCandidate</span><span class="op" id="4624210">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624213">for</span>&nbsp;<span class="ident" id="4624217">_</span><span class="op" id="4624218">,</span>&nbsp;<span class="ident" id="4624220">candidate</span>&nbsp;<span class="op" id="4624230">:=</span>&nbsp;<span class="keyword" id="4624233">range</span>&nbsp;<span class="ident" id="4624239">preferredCurves</span>&nbsp;<span class="op" id="4624255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624259">for</span>&nbsp;<span class="ident" id="4624263">_</span><span class="op" id="4624264">,</span>&nbsp;<span class="ident" id="4624266">c</span>&nbsp;<span class="op" id="4624268">:=</span>&nbsp;<span class="keyword" id="4624271">range</span>&nbsp;<span class="ident" id="4624277">clientHello</span><span class="op" id="4624288">.</span><span class="ident" id="4624289">supportedCurves</span>&nbsp;<span class="op" id="4624305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624310">if</span>&nbsp;<span class="ident" id="4624313">candidate</span>&nbsp;<span class="op" id="4624323">==</span>&nbsp;<span class="ident" id="4624326">c</span>&nbsp;<span class="op" id="4624328">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624334">curveid</span>&nbsp;<span class="op" id="4624342">=</span>&nbsp;<span class="ident" id="4624344">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624350">break</span>&nbsp;<span class="ident" id="4624356">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624380">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624384">if</span>&nbsp;<span class="ident" id="4624387">curveid</span>&nbsp;<span class="op" id="4624395">==</span>&nbsp;<span class="num" id="4624398">0</span>&nbsp;<span class="op" id="4624400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624404">return</span>&nbsp;<span class="ident" id="4624411">nil</span><span class="op" id="4624414">,</span>&nbsp;<span class="ident" id="4624416">errors</span><span class="op" id="4624422">.</span><span class="ident" id="4624423">New</span><span class="op" id="4624426">(</span><span class="string" id="4624427">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="4624470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624477">var</span>&nbsp;<span class="ident" id="4624481">ok</span>&nbsp;<span class="builtintype" id="4624484">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624490">if</span>&nbsp;<span class="ident" id="4624493">ka</span><span class="op" id="4624495">.</span><span class="ident" id="4624496">curve</span><span class="op" id="4624501">,</span>&nbsp;<span class="ident" id="4624503">ok</span>&nbsp;<span class="op" id="4624506">=</span>&nbsp;<span class="ident" id="4624508">curveForCurveID</span><span class="op" id="4624523">(</span><span class="ident" id="4624524">curveid</span><span class="op" id="4624531">)</span><span class="op" id="4624532">;</span>&nbsp;<span class="op" id="4624534">!</span><span class="ident" id="4624535">ok</span>&nbsp;<span class="op" id="4624538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624542">return</span>&nbsp;<span class="ident" id="4624549">nil</span><span class="op" id="4624552">,</span>&nbsp;<span class="ident" id="4624554">errors</span><span class="op" id="4624560">.</span><span class="ident" id="4624561">New</span><span class="op" id="4624564">(</span><span class="string" id="4624565">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4624614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624621">var</span>&nbsp;<span class="ident" id="4624625">x</span><span class="op" id="4624626">,</span>&nbsp;<span class="ident" id="4624628">y</span>&nbsp;<span class="op" id="4624630">*</span><span class="ident" id="4624631">big</span><span class="op" id="4624634">.</span><span class="ident" id="4624635">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624640">var</span>&nbsp;<span class="ident" id="4624644">err</span>&nbsp;<span class="builtintype" id="4624648">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624655">ka</span><span class="op" id="4624657">.</span><span class="ident" id="4624658">privateKey</span><span class="op" id="4624668">,</span>&nbsp;<span class="ident" id="4624670">x</span><span class="op" id="4624671">,</span>&nbsp;<span class="ident" id="4624673">y</span><span class="op" id="4624674">,</span>&nbsp;<span class="ident" id="4624676">err</span>&nbsp;<span class="op" id="4624680">=</span>&nbsp;<span class="ident" id="4624682">elliptic</span><span class="op" id="4624690">.</span><span class="ident" id="4624691">GenerateKey</span><span class="op" id="4624702">(</span><span class="ident" id="4624703">ka</span><span class="op" id="4624705">.</span><span class="ident" id="4624706">curve</span><span class="op" id="4624711">,</span>&nbsp;<span class="ident" id="4624713">config</span><span class="op" id="4624719">.</span><span class="ident" id="4624720">rand</span><span class="op" id="4624724">(</span><span class="op" id="4624725">)</span><span class="op" id="4624726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624729">if</span>&nbsp;<span class="ident" id="4624732">err</span>&nbsp;<span class="op" id="4624736">!=</span>&nbsp;<span class="ident" id="4624739">nil</span>&nbsp;<span class="op" id="4624743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4624747">return</span>&nbsp;<span class="ident" id="4624754">nil</span><span class="op" id="4624757">,</span>&nbsp;<span class="ident" id="4624759">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4624764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624767">ecdhePublic</span>&nbsp;<span class="op" id="4624779">:=</span>&nbsp;<span class="ident" id="4624782">elliptic</span><span class="op" id="4624790">.</span><span class="ident" id="4624791">Marshal</span><span class="op" id="4624798">(</span><span class="ident" id="4624799">ka</span><span class="op" id="4624801">.</span><span class="ident" id="4624802">curve</span><span class="op" id="4624807">,</span>&nbsp;<span class="ident" id="4624809">x</span><span class="op" id="4624810">,</span>&nbsp;<span class="ident" id="4624812">y</span><span class="op" id="4624813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4624817">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624868">serverECDHParams</span>&nbsp;<span class="op" id="4624885">:=</span>&nbsp;<span class="builtinfunc" id="4624888">make</span><span class="op" id="4624892">(</span><span class="op" id="4624893">[</span><span class="op" id="4624894">]</span><span class="builtintype" id="4624895">byte</span><span class="op" id="4624899">,</span>&nbsp;<span class="num" id="4624901">1</span><span class="op" id="4624902">+</span><span class="num" id="4624903">2</span><span class="op" id="4624904">+</span><span class="num" id="4624905">1</span><span class="op" id="4624906">+</span><span class="builtinfunc" id="4624907">len</span><span class="op" id="4624910">(</span><span class="ident" id="4624911">ecdhePublic</span><span class="op" id="4624922">)</span><span class="op" id="4624923">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624926">serverECDHParams</span><span class="op" id="4624942">[</span><span class="num" id="4624943">0</span><span class="op" id="4624944">]</span>&nbsp;<span class="op" id="4624946">=</span>&nbsp;<span class="num" id="4624948">3</span>&nbsp;<span class="comment" id="4624950">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4624966">serverECDHParams</span><span class="op" id="4624982">[</span><span class="num" id="4624983">1</span><span class="op" id="4624984">]</span>&nbsp;<span class="op" id="4624986">=</span>&nbsp;<span class="builtintype" id="4624988">byte</span><span class="op" id="4624992">(</span><span class="ident" id="4624993">curveid</span>&nbsp;<span class="op" id="4625001">&gt;&gt;</span>&nbsp;<span class="num" id="4625004">8</span><span class="op" id="4625005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625008">serverECDHParams</span><span class="op" id="4625024">[</span><span class="num" id="4625025">2</span><span class="op" id="4625026">]</span>&nbsp;<span class="op" id="4625028">=</span>&nbsp;<span class="builtintype" id="4625030">byte</span><span class="op" id="4625034">(</span><span class="ident" id="4625035">curveid</span><span class="op" id="4625042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625045">serverECDHParams</span><span class="op" id="4625061">[</span><span class="num" id="4625062">3</span><span class="op" id="4625063">]</span>&nbsp;<span class="op" id="4625065">=</span>&nbsp;<span class="builtintype" id="4625067">byte</span><span class="op" id="4625071">(</span><span class="builtinfunc" id="4625072">len</span><span class="op" id="4625075">(</span><span class="ident" id="4625076">ecdhePublic</span><span class="op" id="4625087">)</span><span class="op" id="4625088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4625091">copy</span><span class="op" id="4625095">(</span><span class="ident" id="4625096">serverECDHParams</span><span class="op" id="4625112">[</span><span class="num" id="4625113">4</span><span class="op" id="4625114">:</span><span class="op" id="4625115">]</span><span class="op" id="4625116">,</span>&nbsp;<span class="ident" id="4625118">ecdhePublic</span><span class="op" id="4625129">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625133">var</span>&nbsp;<span class="ident" id="4625137">tls12HashId</span>&nbsp;<span class="builtintype" id="4625149">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625156">if</span>&nbsp;<span class="ident" id="4625159">ka</span><span class="op" id="4625161">.</span><span class="ident" id="4625162">version</span>&nbsp;<span class="op" id="4625170">&gt;=</span>&nbsp;<span class="ident" id="4625173">VersionTLS12</span>&nbsp;<span class="op" id="4625186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625190">if</span>&nbsp;<span class="ident" id="4625193">tls12HashId</span><span class="op" id="4625204">,</span>&nbsp;<span class="ident" id="4625206">err</span>&nbsp;<span class="op" id="4625210">=</span>&nbsp;<span class="ident" id="4625212">pickTLS12HashForSignature</span><span class="op" id="4625237">(</span><span class="ident" id="4625238">ka</span><span class="op" id="4625240">.</span><span class="ident" id="4625241">sigType</span><span class="op" id="4625248">,</span>&nbsp;<span class="ident" id="4625250">clientHello</span><span class="op" id="4625261">.</span><span class="ident" id="4625262">signatureAndHashes</span><span class="op" id="4625280">)</span><span class="op" id="4625281">;</span>&nbsp;<span class="ident" id="4625283">err</span>&nbsp;<span class="op" id="4625287">!=</span>&nbsp;<span class="ident" id="4625290">nil</span>&nbsp;<span class="op" id="4625294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625299">return</span>&nbsp;<span class="ident" id="4625306">nil</span><span class="op" id="4625309">,</span>&nbsp;<span class="ident" id="4625311">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625324">digest</span><span class="op" id="4625330">,</span>&nbsp;<span class="ident" id="4625332">hashFunc</span><span class="op" id="4625340">,</span>&nbsp;<span class="ident" id="4625342">err</span>&nbsp;<span class="op" id="4625346">:=</span>&nbsp;<span class="ident" id="4625349">hashForServerKeyExchange</span><span class="op" id="4625373">(</span><span class="ident" id="4625374">ka</span><span class="op" id="4625376">.</span><span class="ident" id="4625377">sigType</span><span class="op" id="4625384">,</span>&nbsp;<span class="ident" id="4625386">tls12HashId</span><span class="op" id="4625397">,</span>&nbsp;<span class="ident" id="4625399">ka</span><span class="op" id="4625401">.</span><span class="ident" id="4625402">version</span><span class="op" id="4625409">,</span>&nbsp;<span class="ident" id="4625411">clientHello</span><span class="op" id="4625422">.</span><span class="ident" id="4625423">random</span><span class="op" id="4625429">,</span>&nbsp;<span class="ident" id="4625431">hello</span><span class="op" id="4625436">.</span><span class="ident" id="4625437">random</span><span class="op" id="4625443">,</span>&nbsp;<span class="ident" id="4625445">serverECDHParams</span><span class="op" id="4625461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625464">if</span>&nbsp;<span class="ident" id="4625467">err</span>&nbsp;<span class="op" id="4625471">!=</span>&nbsp;<span class="ident" id="4625474">nil</span>&nbsp;<span class="op" id="4625478">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625482">return</span>&nbsp;<span class="ident" id="4625489">nil</span><span class="op" id="4625492">,</span>&nbsp;<span class="ident" id="4625494">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625502">var</span>&nbsp;<span class="ident" id="4625506">sig</span>&nbsp;<span class="op" id="4625510">[</span><span class="op" id="4625511">]</span><span class="builtintype" id="4625512">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625518">switch</span>&nbsp;<span class="ident" id="4625525">ka</span><span class="op" id="4625527">.</span><span class="ident" id="4625528">sigType</span>&nbsp;<span class="op" id="4625536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625539">case</span>&nbsp;<span class="ident" id="4625544">signatureECDSA</span><span class="op" id="4625558">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625562">privKey</span><span class="op" id="4625569">,</span>&nbsp;<span class="ident" id="4625571">ok</span>&nbsp;<span class="op" id="4625574">:=</span>&nbsp;<span class="ident" id="4625577">cert</span><span class="op" id="4625581">.</span><span class="ident" id="4625582">PrivateKey</span><span class="op" id="4625592">.</span><span class="op" id="4625593">(</span><span class="op" id="4625594">*</span><span class="ident" id="4625595">ecdsa</span><span class="op" id="4625600">.</span><span class="ident" id="4625601">PrivateKey</span><span class="op" id="4625611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625615">if</span>&nbsp;<span class="op" id="4625618">!</span><span class="ident" id="4625619">ok</span>&nbsp;<span class="op" id="4625622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625627">return</span>&nbsp;<span class="ident" id="4625634">nil</span><span class="op" id="4625637">,</span>&nbsp;<span class="ident" id="4625639">errors</span><span class="op" id="4625645">.</span><span class="ident" id="4625646">New</span><span class="op" id="4625649">(</span><span class="string" id="4625650">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4625700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625708">r</span><span class="op" id="4625709">,</span>&nbsp;<span class="ident" id="4625711">s</span><span class="op" id="4625712">,</span>&nbsp;<span class="ident" id="4625714">err</span>&nbsp;<span class="op" id="4625718">:=</span>&nbsp;<span class="ident" id="4625721">ecdsa</span><span class="op" id="4625726">.</span><span class="ident" id="4625727">Sign</span><span class="op" id="4625731">(</span><span class="ident" id="4625732">config</span><span class="op" id="4625738">.</span><span class="ident" id="4625739">rand</span><span class="op" id="4625743">(</span><span class="op" id="4625744">)</span><span class="op" id="4625745">,</span>&nbsp;<span class="ident" id="4625747">privKey</span><span class="op" id="4625754">,</span>&nbsp;<span class="ident" id="4625756">digest</span><span class="op" id="4625762">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625766">if</span>&nbsp;<span class="ident" id="4625769">err</span>&nbsp;<span class="op" id="4625773">!=</span>&nbsp;<span class="ident" id="4625776">nil</span>&nbsp;<span class="op" id="4625780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625785">return</span>&nbsp;<span class="ident" id="4625792">nil</span><span class="op" id="4625795">,</span>&nbsp;<span class="ident" id="4625797">errors</span><span class="op" id="4625803">.</span><span class="ident" id="4625804">New</span><span class="op" id="4625807">(</span><span class="string" id="4625808">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4625844">+</span>&nbsp;<span class="ident" id="4625846">err</span><span class="op" id="4625849">.</span><span class="ident" id="4625850">Error</span><span class="op" id="4625855">(</span><span class="op" id="4625856">)</span><span class="op" id="4625857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4625861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625865">sig</span><span class="op" id="4625868">,</span>&nbsp;<span class="ident" id="4625870">err</span>&nbsp;<span class="op" id="4625874">=</span>&nbsp;<span class="ident" id="4625876">asn1</span><span class="op" id="4625880">.</span><span class="ident" id="4625881">Marshal</span><span class="op" id="4625888">(</span><span class="ident" id="4625889">ecdsaSignature</span><span class="op" id="4625903">{</span><span class="ident" id="4625904">r</span><span class="op" id="4625905">,</span>&nbsp;<span class="ident" id="4625907">s</span><span class="op" id="4625908">}</span><span class="op" id="4625909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625912">case</span>&nbsp;<span class="ident" id="4625917">signatureRSA</span><span class="op" id="4625929">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4625933">privKey</span><span class="op" id="4625940">,</span>&nbsp;<span class="ident" id="4625942">ok</span>&nbsp;<span class="op" id="4625945">:=</span>&nbsp;<span class="ident" id="4625948">cert</span><span class="op" id="4625952">.</span><span class="ident" id="4625953">PrivateKey</span><span class="op" id="4625963">.</span><span class="op" id="4625964">(</span><span class="op" id="4625965">*</span><span class="ident" id="4625966">rsa</span><span class="op" id="4625969">.</span><span class="ident" id="4625970">PrivateKey</span><span class="op" id="4625980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625984">if</span>&nbsp;<span class="op" id="4625987">!</span><span class="ident" id="4625988">ok</span>&nbsp;<span class="op" id="4625991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4625996">return</span>&nbsp;<span class="ident" id="4626003">nil</span><span class="op" id="4626006">,</span>&nbsp;<span class="ident" id="4626008">errors</span><span class="op" id="4626014">.</span><span class="ident" id="4626015">New</span><span class="op" id="4626018">(</span><span class="string" id="4626019">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="4626064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626072">sig</span><span class="op" id="4626075">,</span>&nbsp;<span class="ident" id="4626077">err</span>&nbsp;<span class="op" id="4626081">=</span>&nbsp;<span class="ident" id="4626083">rsa</span><span class="op" id="4626086">.</span><span class="ident" id="4626087">SignPKCS1v15</span><span class="op" id="4626099">(</span><span class="ident" id="4626100">config</span><span class="op" id="4626106">.</span><span class="ident" id="4626107">rand</span><span class="op" id="4626111">(</span><span class="op" id="4626112">)</span><span class="op" id="4626113">,</span>&nbsp;<span class="ident" id="4626115">privKey</span><span class="op" id="4626122">,</span>&nbsp;<span class="ident" id="4626124">hashFunc</span><span class="op" id="4626132">,</span>&nbsp;<span class="ident" id="4626134">digest</span><span class="op" id="4626140">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626144">if</span>&nbsp;<span class="ident" id="4626147">err</span>&nbsp;<span class="op" id="4626151">!=</span>&nbsp;<span class="ident" id="4626154">nil</span>&nbsp;<span class="op" id="4626158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626163">return</span>&nbsp;<span class="ident" id="4626170">nil</span><span class="op" id="4626173">,</span>&nbsp;<span class="ident" id="4626175">errors</span><span class="op" id="4626181">.</span><span class="ident" id="4626182">New</span><span class="op" id="4626185">(</span><span class="string" id="4626186">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="4626222">+</span>&nbsp;<span class="ident" id="4626224">err</span><span class="op" id="4626227">.</span><span class="ident" id="4626228">Error</span><span class="op" id="4626233">(</span><span class="op" id="4626234">)</span><span class="op" id="4626235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626242">default</span><span class="op" id="4626249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626253">return</span>&nbsp;<span class="ident" id="4626260">nil</span><span class="op" id="4626263">,</span>&nbsp;<span class="ident" id="4626265">errors</span><span class="op" id="4626271">.</span><span class="ident" id="4626272">New</span><span class="op" id="4626275">(</span><span class="string" id="4626276">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4626311">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626318">skx</span>&nbsp;<span class="op" id="4626322">:=</span>&nbsp;<span class="builtinfunc" id="4626325">new</span><span class="op" id="4626328">(</span><span class="ident" id="4626329">serverKeyExchangeMsg</span><span class="op" id="4626349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626352">sigAndHashLen</span>&nbsp;<span class="op" id="4626366">:=</span>&nbsp;<span class="num" id="4626369">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626372">if</span>&nbsp;<span class="ident" id="4626375">ka</span><span class="op" id="4626377">.</span><span class="ident" id="4626378">version</span>&nbsp;<span class="op" id="4626386">&gt;=</span>&nbsp;<span class="ident" id="4626389">VersionTLS12</span>&nbsp;<span class="op" id="4626402">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626406">sigAndHashLen</span>&nbsp;<span class="op" id="4626420">=</span>&nbsp;<span class="num" id="4626422">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626428">skx</span><span class="op" id="4626431">.</span><span class="ident" id="4626432">key</span>&nbsp;<span class="op" id="4626436">=</span>&nbsp;<span class="builtinfunc" id="4626438">make</span><span class="op" id="4626442">(</span><span class="op" id="4626443">[</span><span class="op" id="4626444">]</span><span class="builtintype" id="4626445">byte</span><span class="op" id="4626449">,</span>&nbsp;<span class="builtinfunc" id="4626451">len</span><span class="op" id="4626454">(</span><span class="ident" id="4626455">serverECDHParams</span><span class="op" id="4626471">)</span><span class="op" id="4626472">+</span><span class="ident" id="4626473">sigAndHashLen</span><span class="op" id="4626486">+</span><span class="num" id="4626487">2</span><span class="op" id="4626488">+</span><span class="builtinfunc" id="4626489">len</span><span class="op" id="4626492">(</span><span class="ident" id="4626493">sig</span><span class="op" id="4626496">)</span><span class="op" id="4626497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4626500">copy</span><span class="op" id="4626504">(</span><span class="ident" id="4626505">skx</span><span class="op" id="4626508">.</span><span class="ident" id="4626509">key</span><span class="op" id="4626512">,</span>&nbsp;<span class="ident" id="4626514">serverECDHParams</span><span class="op" id="4626530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626533">k</span>&nbsp;<span class="op" id="4626535">:=</span>&nbsp;<span class="ident" id="4626538">skx</span><span class="op" id="4626541">.</span><span class="ident" id="4626542">key</span><span class="op" id="4626545">[</span><span class="builtinfunc" id="4626546">len</span><span class="op" id="4626549">(</span><span class="ident" id="4626550">serverECDHParams</span><span class="op" id="4626566">)</span><span class="op" id="4626567">:</span><span class="op" id="4626568">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626571">if</span>&nbsp;<span class="ident" id="4626574">ka</span><span class="op" id="4626576">.</span><span class="ident" id="4626577">version</span>&nbsp;<span class="op" id="4626585">&gt;=</span>&nbsp;<span class="ident" id="4626588">VersionTLS12</span>&nbsp;<span class="op" id="4626601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626605">k</span><span class="op" id="4626606">[</span><span class="num" id="4626607">0</span><span class="op" id="4626608">]</span>&nbsp;<span class="op" id="4626610">=</span>&nbsp;<span class="ident" id="4626612">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626626">k</span><span class="op" id="4626627">[</span><span class="num" id="4626628">1</span><span class="op" id="4626629">]</span>&nbsp;<span class="op" id="4626631">=</span>&nbsp;<span class="ident" id="4626633">ka</span><span class="op" id="4626635">.</span><span class="ident" id="4626636">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626646">k</span>&nbsp;<span class="op" id="4626648">=</span>&nbsp;<span class="ident" id="4626650">k</span><span class="op" id="4626651">[</span><span class="num" id="4626652">2</span><span class="op" id="4626653">:</span><span class="op" id="4626654">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4626657">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626660">k</span><span class="op" id="4626661">[</span><span class="num" id="4626662">0</span><span class="op" id="4626663">]</span>&nbsp;<span class="op" id="4626665">=</span>&nbsp;<span class="builtintype" id="4626667">byte</span><span class="op" id="4626671">(</span><span class="builtinfunc" id="4626672">len</span><span class="op" id="4626675">(</span><span class="ident" id="4626676">sig</span><span class="op" id="4626679">)</span>&nbsp;<span class="op" id="4626681">&gt;&gt;</span>&nbsp;<span class="num" id="4626684">8</span><span class="op" id="4626685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4626688">k</span><span class="op" id="4626689">[</span><span class="num" id="4626690">1</span><span class="op" id="4626691">]</span>&nbsp;<span class="op" id="4626693">=</span>&nbsp;<span class="builtintype" id="4626695">byte</span><span class="op" id="4626699">(</span><span class="builtinfunc" id="4626700">len</span><span class="op" id="4626703">(</span><span class="ident" id="4626704">sig</span><span class="op" id="4626707">)</span><span class="op" id="4626708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4626711">copy</span><span class="op" id="4626715">(</span><span class="ident" id="4626716">k</span><span class="op" id="4626717">[</span><span class="num" id="4626718">2</span><span class="op" id="4626719">:</span><span class="op" id="4626720">]</span><span class="op" id="4626721">,</span>&nbsp;<span class="ident" id="4626723">sig</span><span class="op" id="4626726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626730">return</span>&nbsp;<span class="ident" id="4626737">skx</span><span class="op" id="4626740">,</span>&nbsp;<span class="ident" id="4626742">nil</span><br>
<span class="lineno">285</span><span class="op" id="4626746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4626749">func</span>&nbsp;<span class="op" id="4626754">(</span><span class="ident" id="4626755">ka</span>&nbsp;<span class="op" id="4626758">*</span><span class="ident" id="4626759">ecdheKeyAgreement</span><span class="op" id="4626776">)</span>&nbsp;<span class="ident" id="4626778">processClientKeyExchange</span><span class="op" id="4626802">(</span><span class="ident" id="4626803">config</span>&nbsp;<span class="op" id="4626810">*</span><span class="ident" id="4626811">Config</span><span class="op" id="4626817">,</span>&nbsp;<span class="ident" id="4626819">cert</span>&nbsp;<span class="op" id="4626824">*</span><span class="ident" id="4626825">Certificate</span><span class="op" id="4626836">,</span>&nbsp;<span class="ident" id="4626838">ckx</span>&nbsp;<span class="op" id="4626842">*</span><span class="ident" id="4626843">clientKeyExchangeMsg</span><span class="op" id="4626863">,</span>&nbsp;<span class="ident" id="4626865">version</span>&nbsp;<span class="builtintype" id="4626873">uint16</span><span class="op" id="4626879">)</span>&nbsp;<span class="op" id="4626881">(</span><span class="op" id="4626882">[</span><span class="op" id="4626883">]</span><span class="builtintype" id="4626884">byte</span><span class="op" id="4626888">,</span>&nbsp;<span class="builtintype" id="4626890">error</span><span class="op" id="4626895">)</span>&nbsp;<span class="op" id="4626897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626900">if</span>&nbsp;<span class="builtinfunc" id="4626903">len</span><span class="op" id="4626906">(</span><span class="ident" id="4626907">ckx</span><span class="op" id="4626910">.</span><span class="ident" id="4626911">ciphertext</span><span class="op" id="4626921">)</span>&nbsp;<span class="op" id="4626923">==</span>&nbsp;<span class="num" id="4626926">0</span>&nbsp;<span class="op" id="4626928">||</span>&nbsp;<span class="builtintype" id="4626931">int</span><span class="op" id="4626934">(</span><span class="ident" id="4626935">ckx</span><span class="op" id="4626938">.</span><span class="ident" id="4626939">ciphertext</span><span class="op" id="4626949">[</span><span class="num" id="4626950">0</span><span class="op" id="4626951">]</span><span class="op" id="4626952">)</span>&nbsp;<span class="op" id="4626954">!=</span>&nbsp;<span class="builtinfunc" id="4626957">len</span><span class="op" id="4626960">(</span><span class="ident" id="4626961">ckx</span><span class="op" id="4626964">.</span><span class="ident" id="4626965">ciphertext</span><span class="op" id="4626975">)</span><span class="op" id="4626976">-</span><span class="num" id="4626977">1</span>&nbsp;<span class="op" id="4626979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4626983">return</span>&nbsp;<span class="ident" id="4626990">nil</span><span class="op" id="4626993">,</span>&nbsp;<span class="ident" id="4626995">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627020">x</span><span class="op" id="4627021">,</span>&nbsp;<span class="ident" id="4627023">y</span>&nbsp;<span class="op" id="4627025">:=</span>&nbsp;<span class="ident" id="4627028">elliptic</span><span class="op" id="4627036">.</span><span class="ident" id="4627037">Unmarshal</span><span class="op" id="4627046">(</span><span class="ident" id="4627047">ka</span><span class="op" id="4627049">.</span><span class="ident" id="4627050">curve</span><span class="op" id="4627055">,</span>&nbsp;<span class="ident" id="4627057">ckx</span><span class="op" id="4627060">.</span><span class="ident" id="4627061">ciphertext</span><span class="op" id="4627071">[</span><span class="num" id="4627072">1</span><span class="op" id="4627073">:</span><span class="op" id="4627074">]</span><span class="op" id="4627075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627078">if</span>&nbsp;<span class="ident" id="4627081">x</span>&nbsp;<span class="op" id="4627083">==</span>&nbsp;<span class="ident" id="4627086">nil</span>&nbsp;<span class="op" id="4627090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627094">return</span>&nbsp;<span class="ident" id="4627101">nil</span><span class="op" id="4627104">,</span>&nbsp;<span class="ident" id="4627106">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627128">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627131">if</span>&nbsp;<span class="op" id="4627134">!</span><span class="ident" id="4627135">ka</span><span class="op" id="4627137">.</span><span class="ident" id="4627138">curve</span><span class="op" id="4627143">.</span><span class="ident" id="4627144">IsOnCurve</span><span class="op" id="4627153">(</span><span class="ident" id="4627154">x</span><span class="op" id="4627155">,</span>&nbsp;<span class="ident" id="4627157">y</span><span class="op" id="4627158">)</span>&nbsp;<span class="op" id="4627160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627164">return</span>&nbsp;<span class="ident" id="4627171">nil</span><span class="op" id="4627174">,</span>&nbsp;<span class="ident" id="4627176">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627201">x</span><span class="op" id="4627202">,</span>&nbsp;<span class="ident" id="4627204">_</span>&nbsp;<span class="op" id="4627206">=</span>&nbsp;<span class="ident" id="4627208">ka</span><span class="op" id="4627210">.</span><span class="ident" id="4627211">curve</span><span class="op" id="4627216">.</span><span class="ident" id="4627217">ScalarMult</span><span class="op" id="4627227">(</span><span class="ident" id="4627228">x</span><span class="op" id="4627229">,</span>&nbsp;<span class="ident" id="4627231">y</span><span class="op" id="4627232">,</span>&nbsp;<span class="ident" id="4627234">ka</span><span class="op" id="4627236">.</span><span class="ident" id="4627237">privateKey</span><span class="op" id="4627247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627250">preMasterSecret</span>&nbsp;<span class="op" id="4627266">:=</span>&nbsp;<span class="builtinfunc" id="4627269">make</span><span class="op" id="4627273">(</span><span class="op" id="4627274">[</span><span class="op" id="4627275">]</span><span class="builtintype" id="4627276">byte</span><span class="op" id="4627280">,</span>&nbsp;<span class="op" id="4627282">(</span><span class="ident" id="4627283">ka</span><span class="op" id="4627285">.</span><span class="ident" id="4627286">curve</span><span class="op" id="4627291">.</span><span class="ident" id="4627292">Params</span><span class="op" id="4627298">(</span><span class="op" id="4627299">)</span><span class="op" id="4627300">.</span><span class="ident" id="4627301">BitSize</span><span class="op" id="4627308">+</span><span class="num" id="4627309">7</span><span class="op" id="4627310">)</span><span class="op" id="4627311">&gt;&gt;</span><span class="num" id="4627313">3</span><span class="op" id="4627314">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627317">xBytes</span>&nbsp;<span class="op" id="4627324">:=</span>&nbsp;<span class="ident" id="4627327">x</span><span class="op" id="4627328">.</span><span class="ident" id="4627329">Bytes</span><span class="op" id="4627334">(</span><span class="op" id="4627335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4627338">copy</span><span class="op" id="4627342">(</span><span class="ident" id="4627343">preMasterSecret</span><span class="op" id="4627358">[</span><span class="builtinfunc" id="4627359">len</span><span class="op" id="4627362">(</span><span class="ident" id="4627363">preMasterSecret</span><span class="op" id="4627378">)</span><span class="op" id="4627379">-</span><span class="builtinfunc" id="4627380">len</span><span class="op" id="4627383">(</span><span class="ident" id="4627384">xBytes</span><span class="op" id="4627390">)</span><span class="op" id="4627391">:</span><span class="op" id="4627392">]</span><span class="op" id="4627393">,</span>&nbsp;<span class="ident" id="4627395">xBytes</span><span class="op" id="4627401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627405">return</span>&nbsp;<span class="ident" id="4627412">preMasterSecret</span><span class="op" id="4627427">,</span>&nbsp;<span class="ident" id="4627429">nil</span><br>
<span class="lineno"></span><span class="op" id="4627433">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="4627436">func</span>&nbsp;<span class="op" id="4627441">(</span><span class="ident" id="4627442">ka</span>&nbsp;<span class="op" id="4627445">*</span><span class="ident" id="4627446">ecdheKeyAgreement</span><span class="op" id="4627463">)</span>&nbsp;<span class="ident" id="4627465">processServerKeyExchange</span><span class="op" id="4627489">(</span><span class="ident" id="4627490">config</span>&nbsp;<span class="op" id="4627497">*</span><span class="ident" id="4627498">Config</span><span class="op" id="4627504">,</span>&nbsp;<span class="ident" id="4627506">clientHello</span>&nbsp;<span class="op" id="4627518">*</span><span class="ident" id="4627519">clientHelloMsg</span><span class="op" id="4627533">,</span>&nbsp;<span class="ident" id="4627535">serverHello</span>&nbsp;<span class="op" id="4627547">*</span><span class="ident" id="4627548">serverHelloMsg</span><span class="op" id="4627562">,</span>&nbsp;<span class="ident" id="4627564">cert</span>&nbsp;<span class="op" id="4627569">*</span><span class="ident" id="4627570">x509</span><span class="op" id="4627574">.</span><span class="ident" id="4627575">Certificate</span><span class="op" id="4627586">,</span>&nbsp;<span class="ident" id="4627588">skx</span>&nbsp;<span class="op" id="4627592">*</span><span class="ident" id="4627593">serverKeyExchangeMsg</span><span class="op" id="4627613">)</span>&nbsp;<span class="builtintype" id="4627615">error</span>&nbsp;<span class="op" id="4627621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627624">if</span>&nbsp;<span class="builtinfunc" id="4627627">len</span><span class="op" id="4627630">(</span><span class="ident" id="4627631">skx</span><span class="op" id="4627634">.</span><span class="ident" id="4627635">key</span><span class="op" id="4627638">)</span>&nbsp;<span class="op" id="4627640">&lt;</span>&nbsp;<span class="num" id="4627642">4</span>&nbsp;<span class="op" id="4627644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627648">return</span>&nbsp;<span class="ident" id="4627655">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627677">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627680">if</span>&nbsp;<span class="ident" id="4627683">skx</span><span class="op" id="4627686">.</span><span class="ident" id="4627687">key</span><span class="op" id="4627690">[</span><span class="num" id="4627691">0</span><span class="op" id="4627692">]</span>&nbsp;<span class="op" id="4627694">!=</span>&nbsp;<span class="num" id="4627697">3</span>&nbsp;<span class="op" id="4627699">{</span>&nbsp;<span class="comment" id="4627701">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627718">return</span>&nbsp;<span class="ident" id="4627725">errors</span><span class="op" id="4627731">.</span><span class="ident" id="4627732">New</span><span class="op" id="4627735">(</span><span class="string" id="4627736">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4627776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627782">curveid</span>&nbsp;<span class="op" id="4627790">:=</span>&nbsp;<span class="ident" id="4627793">CurveID</span><span class="op" id="4627800">(</span><span class="ident" id="4627801">skx</span><span class="op" id="4627804">.</span><span class="ident" id="4627805">key</span><span class="op" id="4627808">[</span><span class="num" id="4627809">1</span><span class="op" id="4627810">]</span><span class="op" id="4627811">)</span><span class="op" id="4627812">&lt;&lt;</span><span class="num" id="4627814">8</span>&nbsp;<span class="op" id="4627816">|</span>&nbsp;<span class="ident" id="4627818">CurveID</span><span class="op" id="4627825">(</span><span class="ident" id="4627826">skx</span><span class="op" id="4627829">.</span><span class="ident" id="4627830">key</span><span class="op" id="4627833">[</span><span class="num" id="4627834">2</span><span class="op" id="4627835">]</span><span class="op" id="4627836">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627840">var</span>&nbsp;<span class="ident" id="4627844">ok</span>&nbsp;<span class="builtintype" id="4627847">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627853">if</span>&nbsp;<span class="ident" id="4627856">ka</span><span class="op" id="4627858">.</span><span class="ident" id="4627859">curve</span><span class="op" id="4627864">,</span>&nbsp;<span class="ident" id="4627866">ok</span>&nbsp;<span class="op" id="4627869">=</span>&nbsp;<span class="ident" id="4627871">curveForCurveID</span><span class="op" id="4627886">(</span><span class="ident" id="4627887">curveid</span><span class="op" id="4627894">)</span><span class="op" id="4627895">;</span>&nbsp;<span class="op" id="4627897">!</span><span class="ident" id="4627898">ok</span>&nbsp;<span class="op" id="4627901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4627905">return</span>&nbsp;<span class="ident" id="4627912">errors</span><span class="op" id="4627918">.</span><span class="ident" id="4627919">New</span><span class="op" id="4627922">(</span><span class="string" id="4627923">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="4627963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4627966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4627970">publicLen</span>&nbsp;<span class="op" id="4627980">:=</span>&nbsp;<span class="builtintype" id="4627983">int</span><span class="op" id="4627986">(</span><span class="ident" id="4627987">skx</span><span class="op" id="4627990">.</span><span class="ident" id="4627991">key</span><span class="op" id="4627994">[</span><span class="num" id="4627995">3</span><span class="op" id="4627996">]</span><span class="op" id="4627997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628000">if</span>&nbsp;<span class="ident" id="4628003">publicLen</span><span class="op" id="4628012">+</span><span class="num" id="4628013">4</span>&nbsp;<span class="op" id="4628015">&gt;</span>&nbsp;<span class="builtinfunc" id="4628017">len</span><span class="op" id="4628020">(</span><span class="ident" id="4628021">skx</span><span class="op" id="4628024">.</span><span class="ident" id="4628025">key</span><span class="op" id="4628028">)</span>&nbsp;<span class="op" id="4628030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628034">return</span>&nbsp;<span class="ident" id="4628041">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628066">ka</span><span class="op" id="4628068">.</span><span class="ident" id="4628069">x</span><span class="op" id="4628070">,</span>&nbsp;<span class="ident" id="4628072">ka</span><span class="op" id="4628074">.</span><span class="ident" id="4628075">y</span>&nbsp;<span class="op" id="4628077">=</span>&nbsp;<span class="ident" id="4628079">elliptic</span><span class="op" id="4628087">.</span><span class="ident" id="4628088">Unmarshal</span><span class="op" id="4628097">(</span><span class="ident" id="4628098">ka</span><span class="op" id="4628100">.</span><span class="ident" id="4628101">curve</span><span class="op" id="4628106">,</span>&nbsp;<span class="ident" id="4628108">skx</span><span class="op" id="4628111">.</span><span class="ident" id="4628112">key</span><span class="op" id="4628115">[</span><span class="num" id="4628116">4</span><span class="op" id="4628117">:</span><span class="num" id="4628118">4</span><span class="op" id="4628119">+</span><span class="ident" id="4628120">publicLen</span><span class="op" id="4628129">]</span><span class="op" id="4628130">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628133">if</span>&nbsp;<span class="ident" id="4628136">ka</span><span class="op" id="4628138">.</span><span class="ident" id="4628139">x</span>&nbsp;<span class="op" id="4628141">==</span>&nbsp;<span class="ident" id="4628144">nil</span>&nbsp;<span class="op" id="4628148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628152">return</span>&nbsp;<span class="ident" id="4628159">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628184">if</span>&nbsp;<span class="op" id="4628187">!</span><span class="ident" id="4628188">ka</span><span class="op" id="4628190">.</span><span class="ident" id="4628191">curve</span><span class="op" id="4628196">.</span><span class="ident" id="4628197">IsOnCurve</span><span class="op" id="4628206">(</span><span class="ident" id="4628207">ka</span><span class="op" id="4628209">.</span><span class="ident" id="4628210">x</span><span class="op" id="4628211">,</span>&nbsp;<span class="ident" id="4628213">ka</span><span class="op" id="4628215">.</span><span class="ident" id="4628216">y</span><span class="op" id="4628217">)</span>&nbsp;<span class="op" id="4628219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628223">return</span>&nbsp;<span class="ident" id="4628230">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628255">serverECDHParams</span>&nbsp;<span class="op" id="4628272">:=</span>&nbsp;<span class="ident" id="4628275">skx</span><span class="op" id="4628278">.</span><span class="ident" id="4628279">key</span><span class="op" id="4628282">[</span><span class="op" id="4628283">:</span><span class="num" id="4628284">4</span><span class="op" id="4628285">+</span><span class="ident" id="4628286">publicLen</span><span class="op" id="4628295">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628299">sig</span>&nbsp;<span class="op" id="4628303">:=</span>&nbsp;<span class="ident" id="4628306">skx</span><span class="op" id="4628309">.</span><span class="ident" id="4628310">key</span><span class="op" id="4628313">[</span><span class="num" id="4628314">4</span><span class="op" id="4628315">+</span><span class="ident" id="4628316">publicLen</span><span class="op" id="4628325">:</span><span class="op" id="4628326">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628329">if</span>&nbsp;<span class="builtinfunc" id="4628332">len</span><span class="op" id="4628335">(</span><span class="ident" id="4628336">sig</span><span class="op" id="4628339">)</span>&nbsp;<span class="op" id="4628341">&lt;</span>&nbsp;<span class="num" id="4628343">2</span>&nbsp;<span class="op" id="4628345">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628349">return</span>&nbsp;<span class="ident" id="4628356">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628382">var</span>&nbsp;<span class="ident" id="4628386">tls12HashId</span>&nbsp;<span class="builtintype" id="4628398">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628405">if</span>&nbsp;<span class="ident" id="4628408">ka</span><span class="op" id="4628410">.</span><span class="ident" id="4628411">version</span>&nbsp;<span class="op" id="4628419">&gt;=</span>&nbsp;<span class="ident" id="4628422">VersionTLS12</span>&nbsp;<span class="op" id="4628435">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4628439">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628477">var</span>&nbsp;<span class="ident" id="4628481">sigAndHash</span>&nbsp;<span class="op" id="4628492">[</span><span class="op" id="4628493">]</span><span class="builtintype" id="4628494">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628502">sigAndHash</span><span class="op" id="4628512">,</span>&nbsp;<span class="ident" id="4628514">sig</span>&nbsp;<span class="op" id="4628518">=</span>&nbsp;<span class="ident" id="4628520">sig</span><span class="op" id="4628523">[</span><span class="op" id="4628524">:</span><span class="num" id="4628525">2</span><span class="op" id="4628526">]</span><span class="op" id="4628527">,</span>&nbsp;<span class="ident" id="4628529">sig</span><span class="op" id="4628532">[</span><span class="num" id="4628533">2</span><span class="op" id="4628534">:</span><span class="op" id="4628535">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628539">if</span>&nbsp;<span class="ident" id="4628542">sigAndHash</span><span class="op" id="4628552">[</span><span class="num" id="4628553">1</span><span class="op" id="4628554">]</span>&nbsp;<span class="op" id="4628556">!=</span>&nbsp;<span class="ident" id="4628559">ka</span><span class="op" id="4628561">.</span><span class="ident" id="4628562">sigType</span>&nbsp;<span class="op" id="4628570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628575">return</span>&nbsp;<span class="ident" id="4628582">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628609">tls12HashId</span>&nbsp;<span class="op" id="4628621">=</span>&nbsp;<span class="ident" id="4628623">sigAndHash</span><span class="op" id="4628633">[</span><span class="num" id="4628634">0</span><span class="op" id="4628635">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628639">if</span>&nbsp;<span class="builtinfunc" id="4628642">len</span><span class="op" id="4628645">(</span><span class="ident" id="4628646">sig</span><span class="op" id="4628649">)</span>&nbsp;<span class="op" id="4628651">&lt;</span>&nbsp;<span class="num" id="4628653">2</span>&nbsp;<span class="op" id="4628655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628660">return</span>&nbsp;<span class="ident" id="4628667">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628690">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628696">sigLen</span>&nbsp;<span class="op" id="4628703">:=</span>&nbsp;<span class="builtintype" id="4628706">int</span><span class="op" id="4628709">(</span><span class="ident" id="4628710">sig</span><span class="op" id="4628713">[</span><span class="num" id="4628714">0</span><span class="op" id="4628715">]</span><span class="op" id="4628716">)</span><span class="op" id="4628717">&lt;&lt;</span><span class="num" id="4628719">8</span>&nbsp;<span class="op" id="4628721">|</span>&nbsp;<span class="builtintype" id="4628723">int</span><span class="op" id="4628726">(</span><span class="ident" id="4628727">sig</span><span class="op" id="4628730">[</span><span class="num" id="4628731">1</span><span class="op" id="4628732">]</span><span class="op" id="4628733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628736">if</span>&nbsp;<span class="ident" id="4628739">sigLen</span><span class="op" id="4628745">+</span><span class="num" id="4628746">2</span>&nbsp;<span class="op" id="4628748">!=</span>&nbsp;<span class="builtinfunc" id="4628751">len</span><span class="op" id="4628754">(</span><span class="ident" id="4628755">sig</span><span class="op" id="4628758">)</span>&nbsp;<span class="op" id="4628760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628764">return</span>&nbsp;<span class="ident" id="4628771">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628793">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628796">sig</span>&nbsp;<span class="op" id="4628800">=</span>&nbsp;<span class="ident" id="4628802">sig</span><span class="op" id="4628805">[</span><span class="num" id="4628806">2</span><span class="op" id="4628807">:</span><span class="op" id="4628808">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4628812">digest</span><span class="op" id="4628818">,</span>&nbsp;<span class="ident" id="4628820">hashFunc</span><span class="op" id="4628828">,</span>&nbsp;<span class="ident" id="4628830">err</span>&nbsp;<span class="op" id="4628834">:=</span>&nbsp;<span class="ident" id="4628837">hashForServerKeyExchange</span><span class="op" id="4628861">(</span><span class="ident" id="4628862">ka</span><span class="op" id="4628864">.</span><span class="ident" id="4628865">sigType</span><span class="op" id="4628872">,</span>&nbsp;<span class="ident" id="4628874">tls12HashId</span><span class="op" id="4628885">,</span>&nbsp;<span class="ident" id="4628887">ka</span><span class="op" id="4628889">.</span><span class="ident" id="4628890">version</span><span class="op" id="4628897">,</span>&nbsp;<span class="ident" id="4628899">clientHello</span><span class="op" id="4628910">.</span><span class="ident" id="4628911">random</span><span class="op" id="4628917">,</span>&nbsp;<span class="ident" id="4628919">serverHello</span><span class="op" id="4628930">.</span><span class="ident" id="4628931">random</span><span class="op" id="4628937">,</span>&nbsp;<span class="ident" id="4628939">serverECDHParams</span><span class="op" id="4628955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628958">if</span>&nbsp;<span class="ident" id="4628961">err</span>&nbsp;<span class="op" id="4628965">!=</span>&nbsp;<span class="ident" id="4628968">nil</span>&nbsp;<span class="op" id="4628972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628976">return</span>&nbsp;<span class="ident" id="4628983">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4628988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4628991">switch</span>&nbsp;<span class="ident" id="4628998">ka</span><span class="op" id="4629000">.</span><span class="ident" id="4629001">sigType</span>&nbsp;<span class="op" id="4629009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629012">case</span>&nbsp;<span class="ident" id="4629017">signatureECDSA</span><span class="op" id="4629031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629035">pubKey</span><span class="op" id="4629041">,</span>&nbsp;<span class="ident" id="4629043">ok</span>&nbsp;<span class="op" id="4629046">:=</span>&nbsp;<span class="ident" id="4629049">cert</span><span class="op" id="4629053">.</span><span class="ident" id="4629054">PublicKey</span><span class="op" id="4629063">.</span><span class="op" id="4629064">(</span><span class="op" id="4629065">*</span><span class="ident" id="4629066">ecdsa</span><span class="op" id="4629071">.</span><span class="ident" id="4629072">PublicKey</span><span class="op" id="4629081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629085">if</span>&nbsp;<span class="op" id="4629088">!</span><span class="ident" id="4629089">ok</span>&nbsp;<span class="op" id="4629092">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629097">return</span>&nbsp;<span class="ident" id="4629104">errors</span><span class="op" id="4629110">.</span><span class="ident" id="4629111">New</span><span class="op" id="4629114">(</span><span class="string" id="4629115">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4629163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629171">ecdsaSig</span>&nbsp;<span class="op" id="4629180">:=</span>&nbsp;<span class="builtinfunc" id="4629183">new</span><span class="op" id="4629186">(</span><span class="ident" id="4629187">ecdsaSignature</span><span class="op" id="4629201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629205">if</span>&nbsp;<span class="ident" id="4629208">_</span><span class="op" id="4629209">,</span>&nbsp;<span class="ident" id="4629211">err</span>&nbsp;<span class="op" id="4629215">:=</span>&nbsp;<span class="ident" id="4629218">asn1</span><span class="op" id="4629222">.</span><span class="ident" id="4629223">Unmarshal</span><span class="op" id="4629232">(</span><span class="ident" id="4629233">sig</span><span class="op" id="4629236">,</span>&nbsp;<span class="ident" id="4629238">ecdsaSig</span><span class="op" id="4629246">)</span><span class="op" id="4629247">;</span>&nbsp;<span class="ident" id="4629249">err</span>&nbsp;<span class="op" id="4629253">!=</span>&nbsp;<span class="ident" id="4629256">nil</span>&nbsp;<span class="op" id="4629260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629265">return</span>&nbsp;<span class="ident" id="4629272">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629282">if</span>&nbsp;<span class="ident" id="4629285">ecdsaSig</span><span class="op" id="4629293">.</span><span class="ident" id="4629294">R</span><span class="op" id="4629295">.</span><span class="ident" id="4629296">Sign</span><span class="op" id="4629300">(</span><span class="op" id="4629301">)</span>&nbsp;<span class="op" id="4629303">&lt;=</span>&nbsp;<span class="num" id="4629306">0</span>&nbsp;<span class="op" id="4629308">||</span>&nbsp;<span class="ident" id="4629311">ecdsaSig</span><span class="op" id="4629319">.</span><span class="ident" id="4629320">S</span><span class="op" id="4629321">.</span><span class="ident" id="4629322">Sign</span><span class="op" id="4629326">(</span><span class="op" id="4629327">)</span>&nbsp;<span class="op" id="4629329">&lt;=</span>&nbsp;<span class="num" id="4629332">0</span>&nbsp;<span class="op" id="4629334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629339">return</span>&nbsp;<span class="ident" id="4629346">errors</span><span class="op" id="4629352">.</span><span class="ident" id="4629353">New</span><span class="op" id="4629356">(</span><span class="string" id="4629357">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4629408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629416">if</span>&nbsp;<span class="op" id="4629419">!</span><span class="ident" id="4629420">ecdsa</span><span class="op" id="4629425">.</span><span class="ident" id="4629426">Verify</span><span class="op" id="4629432">(</span><span class="ident" id="4629433">pubKey</span><span class="op" id="4629439">,</span>&nbsp;<span class="ident" id="4629441">digest</span><span class="op" id="4629447">,</span>&nbsp;<span class="ident" id="4629449">ecdsaSig</span><span class="op" id="4629457">.</span><span class="ident" id="4629458">R</span><span class="op" id="4629459">,</span>&nbsp;<span class="ident" id="4629461">ecdsaSig</span><span class="op" id="4629469">.</span><span class="ident" id="4629470">S</span><span class="op" id="4629471">)</span>&nbsp;<span class="op" id="4629473">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629478">return</span>&nbsp;<span class="ident" id="4629485">errors</span><span class="op" id="4629491">.</span><span class="ident" id="4629492">New</span><span class="op" id="4629495">(</span><span class="string" id="4629496">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4629524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629531">case</span>&nbsp;<span class="ident" id="4629536">signatureRSA</span><span class="op" id="4629548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4629552">pubKey</span><span class="op" id="4629558">,</span>&nbsp;<span class="ident" id="4629560">ok</span>&nbsp;<span class="op" id="4629563">:=</span>&nbsp;<span class="ident" id="4629566">cert</span><span class="op" id="4629570">.</span><span class="ident" id="4629571">PublicKey</span><span class="op" id="4629580">.</span><span class="op" id="4629581">(</span><span class="op" id="4629582">*</span><span class="ident" id="4629583">rsa</span><span class="op" id="4629586">.</span><span class="ident" id="4629587">PublicKey</span><span class="op" id="4629596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629600">if</span>&nbsp;<span class="op" id="4629603">!</span><span class="ident" id="4629604">ok</span>&nbsp;<span class="op" id="4629607">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629612">return</span>&nbsp;<span class="ident" id="4629619">errors</span><span class="op" id="4629625">.</span><span class="ident" id="4629626">New</span><span class="op" id="4629629">(</span><span class="string" id="4629630">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="4629674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629682">if</span>&nbsp;<span class="ident" id="4629685">err</span>&nbsp;<span class="op" id="4629689">:=</span>&nbsp;<span class="ident" id="4629692">rsa</span><span class="op" id="4629695">.</span><span class="ident" id="4629696">VerifyPKCS1v15</span><span class="op" id="4629710">(</span><span class="ident" id="4629711">pubKey</span><span class="op" id="4629717">,</span>&nbsp;<span class="ident" id="4629719">hashFunc</span><span class="op" id="4629727">,</span>&nbsp;<span class="ident" id="4629729">digest</span><span class="op" id="4629735">,</span>&nbsp;<span class="ident" id="4629737">sig</span><span class="op" id="4629740">)</span><span class="op" id="4629741">;</span>&nbsp;<span class="ident" id="4629743">err</span>&nbsp;<span class="op" id="4629747">!=</span>&nbsp;<span class="ident" id="4629750">nil</span>&nbsp;<span class="op" id="4629754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629759">return</span>&nbsp;<span class="ident" id="4629766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629772">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629775">default</span><span class="op" id="4629782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629786">return</span>&nbsp;<span class="ident" id="4629793">errors</span><span class="op" id="4629799">.</span><span class="ident" id="4629800">New</span><span class="op" id="4629803">(</span><span class="string" id="4629804">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="4629839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4629842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4629846">return</span>&nbsp;<span class="ident" id="4629853">nil</span><br>
<span class="lineno">390</span><span class="op" id="4629857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4629860">func</span>&nbsp;<span class="op" id="4629865">(</span><span class="ident" id="4629866">ka</span>&nbsp;<span class="op" id="4629869">*</span><span class="ident" id="4629870">ecdheKeyAgreement</span><span class="op" id="4629887">)</span>&nbsp;<span class="ident" id="4629889">generateClientKeyExchange</span><span class="op" id="4629914">(</span><span class="ident" id="4629915">config</span>&nbsp;<span class="op" id="4629922">*</span><span class="ident" id="4629923">Config</span><span class="op" id="4629929">,</span>&nbsp;<span class="ident" id="4629931">clientHello</span>&nbsp;<span class="op" id="4629943">*</span><span class="ident" id="4629944">clientHelloMsg</span><span class="op" id="4629958">,</span>&nbsp;<span class="ident" id="4629960">cert</span>&nbsp;<span class="op" id="4629965">*</span><span class="ident" id="4629966">x509</span><span class="op" id="4629970">.</span><span class="ident" id="4629971">Certificate</span><span class="op" id="4629982">)</span>&nbsp;<span class="op" id="4629984">(</span><span class="op" id="4629985">[</span><span class="op" id="4629986">]</span><span class="builtintype" id="4629987">byte</span><span class="op" id="4629991">,</span>&nbsp;<span class="op" id="4629993">*</span><span class="ident" id="4629994">clientKeyExchangeMsg</span><span class="op" id="4630014">,</span>&nbsp;<span class="builtintype" id="4630016">error</span><span class="op" id="4630021">)</span>&nbsp;<span class="op" id="4630023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630026">if</span>&nbsp;<span class="ident" id="4630029">ka</span><span class="op" id="4630031">.</span><span class="ident" id="4630032">curve</span>&nbsp;<span class="op" id="4630038">==</span>&nbsp;<span class="ident" id="4630041">nil</span>&nbsp;<span class="op" id="4630045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630049">return</span>&nbsp;<span class="ident" id="4630056">nil</span><span class="op" id="4630059">,</span>&nbsp;<span class="ident" id="4630061">nil</span><span class="op" id="4630064">,</span>&nbsp;<span class="ident" id="4630066">errors</span><span class="op" id="4630072">.</span><span class="ident" id="4630073">New</span><span class="op" id="4630076">(</span><span class="string" id="4630077">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="4630112">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4630115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630118">priv</span><span class="op" id="4630122">,</span>&nbsp;<span class="ident" id="4630124">mx</span><span class="op" id="4630126">,</span>&nbsp;<span class="ident" id="4630128">my</span><span class="op" id="4630130">,</span>&nbsp;<span class="ident" id="4630132">err</span>&nbsp;<span class="op" id="4630136">:=</span>&nbsp;<span class="ident" id="4630139">elliptic</span><span class="op" id="4630147">.</span><span class="ident" id="4630148">GenerateKey</span><span class="op" id="4630159">(</span><span class="ident" id="4630160">ka</span><span class="op" id="4630162">.</span><span class="ident" id="4630163">curve</span><span class="op" id="4630168">,</span>&nbsp;<span class="ident" id="4630170">config</span><span class="op" id="4630176">.</span><span class="ident" id="4630177">rand</span><span class="op" id="4630181">(</span><span class="op" id="4630182">)</span><span class="op" id="4630183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630186">if</span>&nbsp;<span class="ident" id="4630189">err</span>&nbsp;<span class="op" id="4630193">!=</span>&nbsp;<span class="ident" id="4630196">nil</span>&nbsp;<span class="op" id="4630200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630204">return</span>&nbsp;<span class="ident" id="4630211">nil</span><span class="op" id="4630214">,</span>&nbsp;<span class="ident" id="4630216">nil</span><span class="op" id="4630219">,</span>&nbsp;<span class="ident" id="4630221">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4630226">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630229">x</span><span class="op" id="4630230">,</span>&nbsp;<span class="ident" id="4630232">_</span>&nbsp;<span class="op" id="4630234">:=</span>&nbsp;<span class="ident" id="4630237">ka</span><span class="op" id="4630239">.</span><span class="ident" id="4630240">curve</span><span class="op" id="4630245">.</span><span class="ident" id="4630246">ScalarMult</span><span class="op" id="4630256">(</span><span class="ident" id="4630257">ka</span><span class="op" id="4630259">.</span><span class="ident" id="4630260">x</span><span class="op" id="4630261">,</span>&nbsp;<span class="ident" id="4630263">ka</span><span class="op" id="4630265">.</span><span class="ident" id="4630266">y</span><span class="op" id="4630267">,</span>&nbsp;<span class="ident" id="4630269">priv</span><span class="op" id="4630273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630276">preMasterSecret</span>&nbsp;<span class="op" id="4630292">:=</span>&nbsp;<span class="builtinfunc" id="4630295">make</span><span class="op" id="4630299">(</span><span class="op" id="4630300">[</span><span class="op" id="4630301">]</span><span class="builtintype" id="4630302">byte</span><span class="op" id="4630306">,</span>&nbsp;<span class="op" id="4630308">(</span><span class="ident" id="4630309">ka</span><span class="op" id="4630311">.</span><span class="ident" id="4630312">curve</span><span class="op" id="4630317">.</span><span class="ident" id="4630318">Params</span><span class="op" id="4630324">(</span><span class="op" id="4630325">)</span><span class="op" id="4630326">.</span><span class="ident" id="4630327">BitSize</span><span class="op" id="4630334">+</span><span class="num" id="4630335">7</span><span class="op" id="4630336">)</span><span class="op" id="4630337">&gt;&gt;</span><span class="num" id="4630339">3</span><span class="op" id="4630340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630343">xBytes</span>&nbsp;<span class="op" id="4630350">:=</span>&nbsp;<span class="ident" id="4630353">x</span><span class="op" id="4630354">.</span><span class="ident" id="4630355">Bytes</span><span class="op" id="4630360">(</span><span class="op" id="4630361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4630364">copy</span><span class="op" id="4630368">(</span><span class="ident" id="4630369">preMasterSecret</span><span class="op" id="4630384">[</span><span class="builtinfunc" id="4630385">len</span><span class="op" id="4630388">(</span><span class="ident" id="4630389">preMasterSecret</span><span class="op" id="4630404">)</span><span class="op" id="4630405">-</span><span class="builtinfunc" id="4630406">len</span><span class="op" id="4630409">(</span><span class="ident" id="4630410">xBytes</span><span class="op" id="4630416">)</span><span class="op" id="4630417">:</span><span class="op" id="4630418">]</span><span class="op" id="4630419">,</span>&nbsp;<span class="ident" id="4630421">xBytes</span><span class="op" id="4630427">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630431">serialized</span>&nbsp;<span class="op" id="4630442">:=</span>&nbsp;<span class="ident" id="4630445">elliptic</span><span class="op" id="4630453">.</span><span class="ident" id="4630454">Marshal</span><span class="op" id="4630461">(</span><span class="ident" id="4630462">ka</span><span class="op" id="4630464">.</span><span class="ident" id="4630465">curve</span><span class="op" id="4630470">,</span>&nbsp;<span class="ident" id="4630472">mx</span><span class="op" id="4630474">,</span>&nbsp;<span class="ident" id="4630476">my</span><span class="op" id="4630478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630482">ckx</span>&nbsp;<span class="op" id="4630486">:=</span>&nbsp;<span class="builtinfunc" id="4630489">new</span><span class="op" id="4630492">(</span><span class="ident" id="4630493">clientKeyExchangeMsg</span><span class="op" id="4630513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630516">ckx</span><span class="op" id="4630519">.</span><span class="ident" id="4630520">ciphertext</span>&nbsp;<span class="op" id="4630531">=</span>&nbsp;<span class="builtinfunc" id="4630533">make</span><span class="op" id="4630537">(</span><span class="op" id="4630538">[</span><span class="op" id="4630539">]</span><span class="builtintype" id="4630540">byte</span><span class="op" id="4630544">,</span>&nbsp;<span class="num" id="4630546">1</span><span class="op" id="4630547">+</span><span class="builtinfunc" id="4630548">len</span><span class="op" id="4630551">(</span><span class="ident" id="4630552">serialized</span><span class="op" id="4630562">)</span><span class="op" id="4630563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4630566">ckx</span><span class="op" id="4630569">.</span><span class="ident" id="4630570">ciphertext</span><span class="op" id="4630580">[</span><span class="num" id="4630581">0</span><span class="op" id="4630582">]</span>&nbsp;<span class="op" id="4630584">=</span>&nbsp;<span class="builtintype" id="4630586">byte</span><span class="op" id="4630590">(</span><span class="builtinfunc" id="4630591">len</span><span class="op" id="4630594">(</span><span class="ident" id="4630595">serialized</span><span class="op" id="4630605">)</span><span class="op" id="4630606">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4630609">copy</span><span class="op" id="4630613">(</span><span class="ident" id="4630614">ckx</span><span class="op" id="4630617">.</span><span class="ident" id="4630618">ciphertext</span><span class="op" id="4630628">[</span><span class="num" id="4630629">1</span><span class="op" id="4630630">:</span><span class="op" id="4630631">]</span><span class="op" id="4630632">,</span>&nbsp;<span class="ident" id="4630634">serialized</span><span class="op" id="4630644">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4630648">return</span>&nbsp;<span class="ident" id="4630655">preMasterSecret</span><span class="op" id="4630670">,</span>&nbsp;<span class="ident" id="4630672">ckx</span><span class="op" id="4630675">,</span>&nbsp;<span class="ident" id="4630677">nil</span><br>
<span class="lineno"></span><span class="op" id="4630681">}</span>
</div>
</body>
</html>
