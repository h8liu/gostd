<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1602053">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1602108">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1602162">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1602213">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602291">package</span>&nbsp;<span class="ident" id="1602299">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602308">import</span>&nbsp;<span class="string" id="1602315">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1602325">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1602383">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1602466">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1602518">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1602609">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1602638">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1602724">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1602781">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1602860">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1602934">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1602985">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1603066">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1603145">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1603223">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1603309">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1603391">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1603449">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1603544">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1603586">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1603617">const</span>&nbsp;<span class="op" id="1603623">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603626">pdReady</span>&nbsp;<span class="builtintype" id="1603634">uintptr</span>&nbsp;<span class="op" id="1603642">=</span>&nbsp;<span class="num" id="1603644">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603647">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1603655">uintptr</span>&nbsp;<span class="op" id="1603663">=</span>&nbsp;<span class="num" id="1603665">2</span><br>
<span class="lineno"></span><span class="op" id="1603667">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1603670">const</span>&nbsp;<span class="ident" id="1603676">pollBlockSize</span>&nbsp;<span class="op" id="1603690">=</span>&nbsp;<span class="num" id="1603692">4</span>&nbsp;<span class="op" id="1603694">*</span>&nbsp;<span class="num" id="1603696">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1603702">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1603732">type</span>&nbsp;<span class="ident" id="1603737">pollDesc</span>&nbsp;<span class="keyword" id="1603746">struct</span>&nbsp;<span class="op" id="1603753">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603756">link</span>&nbsp;<span class="op" id="1603761">*</span><span class="ident" id="1603762">pollDesc</span>&nbsp;<span class="comment" id="1603771">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603818">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1603908">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604005">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604101">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604180">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604222">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604294">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604347">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604355">mutex</span>&nbsp;<span class="comment" id="1604361">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604396">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1604404">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604413">closing</span>&nbsp;<span class="builtintype" id="1604421">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604427">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1604435">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604450">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604505">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1604513">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604528">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604575">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604583">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604598">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604643">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604651">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604666">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604684">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1604692">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604707">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604755">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604763">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604778">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604803">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604811">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604826">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604845">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604853">unsafe</span><span class="op" id="1604859">.</span><span class="ident" id="1604860">Pointer</span>&nbsp;<span class="comment" id="1604868">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1604892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1604895">type</span>&nbsp;<span class="ident" id="1604900">pollCache</span>&nbsp;<span class="keyword" id="1604910">struct</span>&nbsp;<span class="op" id="1604917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604920">lock</span>&nbsp;&nbsp;<span class="ident" id="1604926">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604933">first</span>&nbsp;<span class="op" id="1604939">*</span><span class="ident" id="1604940">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604950">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604992">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605052">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605095">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605152">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1605226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605229">var</span>&nbsp;<span class="ident" id="1605233">pollcache</span>&nbsp;<span class="ident" id="1605243">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605254">func</span>&nbsp;<span class="ident" id="1605259">netpollServerInit</span><span class="op" id="1605276">(</span><span class="op" id="1605277">)</span>&nbsp;<span class="op" id="1605279">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605282">onM</span><span class="op" id="1605285">(</span><span class="ident" id="1605286">netpollinit</span><span class="op" id="1605297">)</span><br>
<span class="lineno"></span><span class="op" id="1605299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605302">func</span>&nbsp;<span class="ident" id="1605307">netpollOpen</span><span class="op" id="1605318">(</span><span class="ident" id="1605319">fd</span>&nbsp;<span class="builtintype" id="1605322">uintptr</span><span class="op" id="1605329">)</span>&nbsp;<span class="op" id="1605331">(</span><span class="op" id="1605332">*</span><span class="ident" id="1605333">pollDesc</span><span class="op" id="1605341">,</span>&nbsp;<span class="builtintype" id="1605343">int</span><span class="op" id="1605346">)</span>&nbsp;<span class="op" id="1605348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605351">pd</span>&nbsp;<span class="op" id="1605354">:=</span>&nbsp;<span class="ident" id="1605357">pollcache</span><span class="op" id="1605366">.</span><span class="ident" id="1605367">alloc</span><span class="op" id="1605372">(</span><span class="op" id="1605373">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605376">lock</span><span class="op" id="1605380">(</span><span class="op" id="1605381">&amp;</span><span class="ident" id="1605382">pd</span><span class="op" id="1605384">.</span><span class="ident" id="1605385">lock</span><span class="op" id="1605389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605392">if</span>&nbsp;<span class="ident" id="1605395">pd</span><span class="op" id="1605397">.</span><span class="ident" id="1605398">wg</span>&nbsp;<span class="op" id="1605401">!=</span>&nbsp;<span class="num" id="1605404">0</span>&nbsp;<span class="op" id="1605406">&amp;&amp;</span>&nbsp;<span class="ident" id="1605409">pd</span><span class="op" id="1605411">.</span><span class="ident" id="1605412">wg</span>&nbsp;<span class="op" id="1605415">!=</span>&nbsp;<span class="ident" id="1605418">pdReady</span>&nbsp;<span class="op" id="1605426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605430">gothrow</span><span class="op" id="1605437">(</span><span class="string" id="1605438">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1605485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605491">if</span>&nbsp;<span class="ident" id="1605494">pd</span><span class="op" id="1605496">.</span><span class="ident" id="1605497">rg</span>&nbsp;<span class="op" id="1605500">!=</span>&nbsp;<span class="num" id="1605503">0</span>&nbsp;<span class="op" id="1605505">&amp;&amp;</span>&nbsp;<span class="ident" id="1605508">pd</span><span class="op" id="1605510">.</span><span class="ident" id="1605511">rg</span>&nbsp;<span class="op" id="1605514">!=</span>&nbsp;<span class="ident" id="1605517">pdReady</span>&nbsp;<span class="op" id="1605525">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605529">gothrow</span><span class="op" id="1605536">(</span><span class="string" id="1605537">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1605583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605589">pd</span><span class="op" id="1605591">.</span><span class="ident" id="1605592">fd</span>&nbsp;<span class="op" id="1605595">=</span>&nbsp;<span class="ident" id="1605597">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605601">pd</span><span class="op" id="1605603">.</span><span class="ident" id="1605604">closing</span>&nbsp;<span class="op" id="1605612">=</span>&nbsp;<span class="builtintype" id="1605614">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605621">pd</span><span class="op" id="1605623">.</span><span class="ident" id="1605624">seq</span><span class="op" id="1605627">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605631">pd</span><span class="op" id="1605633">.</span><span class="ident" id="1605634">rg</span>&nbsp;<span class="op" id="1605637">=</span>&nbsp;<span class="num" id="1605639">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605642">pd</span><span class="op" id="1605644">.</span><span class="ident" id="1605645">rd</span>&nbsp;<span class="op" id="1605648">=</span>&nbsp;<span class="num" id="1605650">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605653">pd</span><span class="op" id="1605655">.</span><span class="ident" id="1605656">wg</span>&nbsp;<span class="op" id="1605659">=</span>&nbsp;<span class="num" id="1605661">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605664">pd</span><span class="op" id="1605666">.</span><span class="ident" id="1605667">wd</span>&nbsp;<span class="op" id="1605670">=</span>&nbsp;<span class="num" id="1605672">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605675">unlock</span><span class="op" id="1605681">(</span><span class="op" id="1605682">&amp;</span><span class="ident" id="1605683">pd</span><span class="op" id="1605685">.</span><span class="ident" id="1605686">lock</span><span class="op" id="1605690">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605694">var</span>&nbsp;<span class="ident" id="1605698">errno</span>&nbsp;<span class="builtintype" id="1605704">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605711">onM</span><span class="op" id="1605714">(</span><span class="keyword" id="1605715">func</span><span class="op" id="1605719">(</span><span class="op" id="1605720">)</span>&nbsp;<span class="op" id="1605722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605726">errno</span>&nbsp;<span class="op" id="1605732">=</span>&nbsp;<span class="ident" id="1605734">netpollopen</span><span class="op" id="1605745">(</span><span class="ident" id="1605746">fd</span><span class="op" id="1605748">,</span>&nbsp;<span class="ident" id="1605750">pd</span><span class="op" id="1605752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605755">}</span><span class="op" id="1605756">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605759">return</span>&nbsp;<span class="ident" id="1605766">pd</span><span class="op" id="1605768">,</span>&nbsp;<span class="builtintype" id="1605770">int</span><span class="op" id="1605773">(</span><span class="ident" id="1605774">errno</span><span class="op" id="1605779">)</span><br>
<span class="lineno"></span><span class="op" id="1605781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605784">func</span>&nbsp;<span class="ident" id="1605789">netpollClose</span><span class="op" id="1605801">(</span><span class="ident" id="1605802">pd</span>&nbsp;<span class="op" id="1605805">*</span><span class="ident" id="1605806">pollDesc</span><span class="op" id="1605814">)</span>&nbsp;<span class="op" id="1605816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605819">if</span>&nbsp;<span class="op" id="1605822">!</span><span class="ident" id="1605823">pd</span><span class="op" id="1605825">.</span><span class="ident" id="1605826">closing</span>&nbsp;<span class="op" id="1605834">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605838">gothrow</span><span class="op" id="1605845">(</span><span class="string" id="1605846">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1605879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605885">if</span>&nbsp;<span class="ident" id="1605888">pd</span><span class="op" id="1605890">.</span><span class="ident" id="1605891">wg</span>&nbsp;<span class="op" id="1605894">!=</span>&nbsp;<span class="num" id="1605897">0</span>&nbsp;<span class="op" id="1605899">&amp;&amp;</span>&nbsp;<span class="ident" id="1605902">pd</span><span class="op" id="1605904">.</span><span class="ident" id="1605905">wg</span>&nbsp;<span class="op" id="1605908">!=</span>&nbsp;<span class="ident" id="1605911">pdReady</span>&nbsp;<span class="op" id="1605919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605923">gothrow</span><span class="op" id="1605930">(</span><span class="string" id="1605931">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1605982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605985">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605988">if</span>&nbsp;<span class="ident" id="1605991">pd</span><span class="op" id="1605993">.</span><span class="ident" id="1605994">rg</span>&nbsp;<span class="op" id="1605997">!=</span>&nbsp;<span class="num" id="1606000">0</span>&nbsp;<span class="op" id="1606002">&amp;&amp;</span>&nbsp;<span class="ident" id="1606005">pd</span><span class="op" id="1606007">.</span><span class="ident" id="1606008">rg</span>&nbsp;<span class="op" id="1606011">!=</span>&nbsp;<span class="ident" id="1606014">pdReady</span>&nbsp;<span class="op" id="1606022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606026">gothrow</span><span class="op" id="1606033">(</span><span class="string" id="1606034">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1606084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606090">onM</span><span class="op" id="1606093">(</span><span class="keyword" id="1606094">func</span><span class="op" id="1606098">(</span><span class="op" id="1606099">)</span>&nbsp;<span class="op" id="1606101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606105">netpollclose</span><span class="op" id="1606117">(</span><span class="builtintype" id="1606118">uintptr</span><span class="op" id="1606125">(</span><span class="ident" id="1606126">pd</span><span class="op" id="1606128">.</span><span class="ident" id="1606129">fd</span><span class="op" id="1606131">)</span><span class="op" id="1606132">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606135">}</span><span class="op" id="1606136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606139">pollcache</span><span class="op" id="1606148">.</span><span class="ident" id="1606149">free</span><span class="op" id="1606153">(</span><span class="ident" id="1606154">pd</span><span class="op" id="1606156">)</span><br>
<span class="lineno"></span><span class="op" id="1606158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1606161">func</span>&nbsp;<span class="op" id="1606166">(</span><span class="ident" id="1606167">c</span>&nbsp;<span class="op" id="1606169">*</span><span class="ident" id="1606170">pollCache</span><span class="op" id="1606179">)</span>&nbsp;<span class="ident" id="1606181">free</span><span class="op" id="1606185">(</span><span class="ident" id="1606186">pd</span>&nbsp;<span class="op" id="1606189">*</span><span class="ident" id="1606190">pollDesc</span><span class="op" id="1606198">)</span>&nbsp;<span class="op" id="1606200">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606203">lock</span><span class="op" id="1606207">(</span><span class="op" id="1606208">&amp;</span><span class="ident" id="1606209">c</span><span class="op" id="1606210">.</span><span class="ident" id="1606211">lock</span><span class="op" id="1606215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606218">pd</span><span class="op" id="1606220">.</span><span class="ident" id="1606221">link</span>&nbsp;<span class="op" id="1606226">=</span>&nbsp;<span class="ident" id="1606228">c</span><span class="op" id="1606229">.</span><span class="ident" id="1606230">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606237">c</span><span class="op" id="1606238">.</span><span class="ident" id="1606239">first</span>&nbsp;<span class="op" id="1606245">=</span>&nbsp;<span class="ident" id="1606247">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606251">unlock</span><span class="op" id="1606257">(</span><span class="op" id="1606258">&amp;</span><span class="ident" id="1606259">c</span><span class="op" id="1606260">.</span><span class="ident" id="1606261">lock</span><span class="op" id="1606265">)</span><br>
<span class="lineno"></span><span class="op" id="1606267">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1606270">func</span>&nbsp;<span class="ident" id="1606275">netpollReset</span><span class="op" id="1606287">(</span><span class="ident" id="1606288">pd</span>&nbsp;<span class="op" id="1606291">*</span><span class="ident" id="1606292">pollDesc</span><span class="op" id="1606300">,</span>&nbsp;<span class="ident" id="1606302">mode</span>&nbsp;<span class="builtintype" id="1606307">int</span><span class="op" id="1606310">)</span>&nbsp;<span class="builtintype" id="1606312">int</span>&nbsp;<span class="op" id="1606316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606319">err</span>&nbsp;<span class="op" id="1606323">:=</span>&nbsp;<span class="ident" id="1606326">netpollcheckerr</span><span class="op" id="1606341">(</span><span class="ident" id="1606342">pd</span><span class="op" id="1606344">,</span>&nbsp;<span class="builtintype" id="1606346">int32</span><span class="op" id="1606351">(</span><span class="ident" id="1606352">mode</span><span class="op" id="1606356">)</span><span class="op" id="1606357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606360">if</span>&nbsp;<span class="ident" id="1606363">err</span>&nbsp;<span class="op" id="1606367">!=</span>&nbsp;<span class="num" id="1606370">0</span>&nbsp;<span class="op" id="1606372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606376">return</span>&nbsp;<span class="ident" id="1606383">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606391">if</span>&nbsp;<span class="ident" id="1606394">mode</span>&nbsp;<span class="op" id="1606399">==</span>&nbsp;<span class="string" id="1606402">&#39;r&#39;</span>&nbsp;<span class="op" id="1606406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606410">pd</span><span class="op" id="1606412">.</span><span class="ident" id="1606413">rg</span>&nbsp;<span class="op" id="1606416">=</span>&nbsp;<span class="num" id="1606418">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606421">}</span>&nbsp;<span class="keyword" id="1606423">else</span>&nbsp;<span class="keyword" id="1606428">if</span>&nbsp;<span class="ident" id="1606431">mode</span>&nbsp;<span class="op" id="1606436">==</span>&nbsp;<span class="string" id="1606439">&#39;w&#39;</span>&nbsp;<span class="op" id="1606443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606447">pd</span><span class="op" id="1606449">.</span><span class="ident" id="1606450">wg</span>&nbsp;<span class="op" id="1606453">=</span>&nbsp;<span class="num" id="1606455">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606461">return</span>&nbsp;<span class="num" id="1606468">0</span><br>
<span class="lineno"></span><span class="op" id="1606470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1606473">func</span>&nbsp;<span class="ident" id="1606478">netpollWait</span><span class="op" id="1606489">(</span><span class="ident" id="1606490">pd</span>&nbsp;<span class="op" id="1606493">*</span><span class="ident" id="1606494">pollDesc</span><span class="op" id="1606502">,</span>&nbsp;<span class="ident" id="1606504">mode</span>&nbsp;<span class="builtintype" id="1606509">int</span><span class="op" id="1606512">)</span>&nbsp;<span class="builtintype" id="1606514">int</span>&nbsp;<span class="op" id="1606518">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606521">err</span>&nbsp;<span class="op" id="1606525">:=</span>&nbsp;<span class="ident" id="1606528">netpollcheckerr</span><span class="op" id="1606543">(</span><span class="ident" id="1606544">pd</span><span class="op" id="1606546">,</span>&nbsp;<span class="builtintype" id="1606548">int32</span><span class="op" id="1606553">(</span><span class="ident" id="1606554">mode</span><span class="op" id="1606558">)</span><span class="op" id="1606559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606562">if</span>&nbsp;<span class="ident" id="1606565">err</span>&nbsp;<span class="op" id="1606569">!=</span>&nbsp;<span class="num" id="1606572">0</span>&nbsp;<span class="op" id="1606574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606578">return</span>&nbsp;<span class="ident" id="1606585">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606593">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606646">if</span>&nbsp;<span class="ident" id="1606649">GOOS</span>&nbsp;<span class="op" id="1606654">==</span>&nbsp;<span class="string" id="1606657">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1606667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606671">onM</span><span class="op" id="1606674">(</span><span class="keyword" id="1606675">func</span><span class="op" id="1606679">(</span><span class="op" id="1606680">)</span>&nbsp;<span class="op" id="1606682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606687">netpollarm</span><span class="op" id="1606697">(</span><span class="ident" id="1606698">pd</span><span class="op" id="1606700">,</span>&nbsp;<span class="ident" id="1606702">mode</span><span class="op" id="1606706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606710">}</span><span class="op" id="1606711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606714">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606717">for</span>&nbsp;<span class="op" id="1606721">!</span><span class="ident" id="1606722">netpollblock</span><span class="op" id="1606734">(</span><span class="ident" id="1606735">pd</span><span class="op" id="1606737">,</span>&nbsp;<span class="builtintype" id="1606739">int32</span><span class="op" id="1606744">(</span><span class="ident" id="1606745">mode</span><span class="op" id="1606749">)</span><span class="op" id="1606750">,</span>&nbsp;<span class="builtintype" id="1606752">false</span><span class="op" id="1606757">)</span>&nbsp;<span class="op" id="1606759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606763">err</span>&nbsp;<span class="op" id="1606767">=</span>&nbsp;<span class="ident" id="1606769">netpollcheckerr</span><span class="op" id="1606784">(</span><span class="ident" id="1606785">pd</span><span class="op" id="1606787">,</span>&nbsp;<span class="builtintype" id="1606789">int32</span><span class="op" id="1606794">(</span><span class="ident" id="1606795">mode</span><span class="op" id="1606799">)</span><span class="op" id="1606800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606804">if</span>&nbsp;<span class="ident" id="1606807">err</span>&nbsp;<span class="op" id="1606811">!=</span>&nbsp;<span class="num" id="1606814">0</span>&nbsp;<span class="op" id="1606816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606821">return</span>&nbsp;<span class="ident" id="1606828">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606834">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606838">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606893">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606957">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607003">return</span>&nbsp;<span class="num" id="1607010">0</span><br>
<span class="lineno">160</span><span class="op" id="1607012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607015">func</span>&nbsp;<span class="ident" id="1607020">netpollWaitCanceled</span><span class="op" id="1607039">(</span><span class="ident" id="1607040">pd</span>&nbsp;<span class="op" id="1607043">*</span><span class="ident" id="1607044">pollDesc</span><span class="op" id="1607052">,</span>&nbsp;<span class="ident" id="1607054">mode</span>&nbsp;<span class="builtintype" id="1607059">int</span><span class="op" id="1607062">)</span>&nbsp;<span class="op" id="1607064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607067">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607142">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607222">for</span>&nbsp;<span class="op" id="1607226">!</span><span class="ident" id="1607227">netpollblock</span><span class="op" id="1607239">(</span><span class="ident" id="1607240">pd</span><span class="op" id="1607242">,</span>&nbsp;<span class="builtintype" id="1607244">int32</span><span class="op" id="1607249">(</span><span class="ident" id="1607250">mode</span><span class="op" id="1607254">)</span><span class="op" id="1607255">,</span>&nbsp;<span class="builtintype" id="1607257">true</span><span class="op" id="1607261">)</span>&nbsp;<span class="op" id="1607263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607266">}</span><br>
<span class="lineno"></span><span class="op" id="1607268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607271">func</span>&nbsp;<span class="ident" id="1607276">netpollSetDeadline</span><span class="op" id="1607294">(</span><span class="ident" id="1607295">pd</span>&nbsp;<span class="op" id="1607298">*</span><span class="ident" id="1607299">pollDesc</span><span class="op" id="1607307">,</span>&nbsp;<span class="ident" id="1607309">d</span>&nbsp;<span class="ident" id="1607311">int64</span><span class="op" id="1607316">,</span>&nbsp;<span class="ident" id="1607318">mode</span>&nbsp;<span class="builtintype" id="1607323">int</span><span class="op" id="1607326">)</span>&nbsp;<span class="op" id="1607328">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607331">lock</span><span class="op" id="1607335">(</span><span class="op" id="1607336">&amp;</span><span class="ident" id="1607337">pd</span><span class="op" id="1607339">.</span><span class="ident" id="1607340">lock</span><span class="op" id="1607344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607347">if</span>&nbsp;<span class="ident" id="1607350">pd</span><span class="op" id="1607352">.</span><span class="ident" id="1607353">closing</span>&nbsp;<span class="op" id="1607361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607365">unlock</span><span class="op" id="1607371">(</span><span class="op" id="1607372">&amp;</span><span class="ident" id="1607373">pd</span><span class="op" id="1607375">.</span><span class="ident" id="1607376">lock</span><span class="op" id="1607380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607384">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607392">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607395">pd</span><span class="op" id="1607397">.</span><span class="ident" id="1607398">seq</span><span class="op" id="1607401">++</span>&nbsp;<span class="comment" id="1607404">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607434">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607460">if</span>&nbsp;<span class="ident" id="1607463">pd</span><span class="op" id="1607465">.</span><span class="ident" id="1607466">rt</span><span class="op" id="1607468">.</span><span class="ident" id="1607469">f</span>&nbsp;<span class="op" id="1607471">!=</span>&nbsp;<span class="builtintype" id="1607474">nil</span>&nbsp;<span class="op" id="1607478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607482">deltimer</span><span class="op" id="1607490">(</span><span class="op" id="1607491">&amp;</span><span class="ident" id="1607492">pd</span><span class="op" id="1607494">.</span><span class="ident" id="1607495">rt</span><span class="op" id="1607497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607501">pd</span><span class="op" id="1607503">.</span><span class="ident" id="1607504">rt</span><span class="op" id="1607506">.</span><span class="ident" id="1607507">f</span>&nbsp;<span class="op" id="1607509">=</span>&nbsp;<span class="builtintype" id="1607511">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607519">if</span>&nbsp;<span class="ident" id="1607522">pd</span><span class="op" id="1607524">.</span><span class="ident" id="1607525">wt</span><span class="op" id="1607527">.</span><span class="ident" id="1607528">f</span>&nbsp;<span class="op" id="1607530">!=</span>&nbsp;<span class="builtintype" id="1607533">nil</span>&nbsp;<span class="op" id="1607537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607541">deltimer</span><span class="op" id="1607549">(</span><span class="op" id="1607550">&amp;</span><span class="ident" id="1607551">pd</span><span class="op" id="1607553">.</span><span class="ident" id="1607554">wt</span><span class="op" id="1607556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607560">pd</span><span class="op" id="1607562">.</span><span class="ident" id="1607563">wt</span><span class="op" id="1607565">.</span><span class="ident" id="1607566">f</span>&nbsp;<span class="op" id="1607568">=</span>&nbsp;<span class="builtintype" id="1607570">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607575">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607578">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607600">if</span>&nbsp;<span class="ident" id="1607603">d</span>&nbsp;<span class="op" id="1607605">!=</span>&nbsp;<span class="num" id="1607608">0</span>&nbsp;<span class="op" id="1607610">&amp;&amp;</span>&nbsp;<span class="ident" id="1607613">d</span>&nbsp;<span class="op" id="1607615">&lt;=</span>&nbsp;<span class="ident" id="1607618">nanotime</span><span class="op" id="1607626">(</span><span class="op" id="1607627">)</span>&nbsp;<span class="op" id="1607629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607633">d</span>&nbsp;<span class="op" id="1607635">=</span>&nbsp;<span class="op" id="1607637">-</span><span class="num" id="1607638">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607644">if</span>&nbsp;<span class="ident" id="1607647">mode</span>&nbsp;<span class="op" id="1607652">==</span>&nbsp;<span class="string" id="1607655">&#39;r&#39;</span>&nbsp;<span class="op" id="1607659">||</span>&nbsp;<span class="ident" id="1607662">mode</span>&nbsp;<span class="op" id="1607667">==</span>&nbsp;<span class="string" id="1607670">&#39;r&#39;</span><span class="op" id="1607673">+</span><span class="string" id="1607674">&#39;w&#39;</span>&nbsp;<span class="op" id="1607678">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607682">pd</span><span class="op" id="1607684">.</span><span class="ident" id="1607685">rd</span>&nbsp;<span class="op" id="1607688">=</span>&nbsp;<span class="ident" id="1607690">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607696">if</span>&nbsp;<span class="ident" id="1607699">mode</span>&nbsp;<span class="op" id="1607704">==</span>&nbsp;<span class="string" id="1607707">&#39;w&#39;</span>&nbsp;<span class="op" id="1607711">||</span>&nbsp;<span class="ident" id="1607714">mode</span>&nbsp;<span class="op" id="1607719">==</span>&nbsp;<span class="string" id="1607722">&#39;r&#39;</span><span class="op" id="1607725">+</span><span class="string" id="1607726">&#39;w&#39;</span>&nbsp;<span class="op" id="1607730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607734">pd</span><span class="op" id="1607736">.</span><span class="ident" id="1607737">wd</span>&nbsp;<span class="op" id="1607740">=</span>&nbsp;<span class="ident" id="1607742">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607745">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607748">if</span>&nbsp;<span class="ident" id="1607751">pd</span><span class="op" id="1607753">.</span><span class="ident" id="1607754">rd</span>&nbsp;<span class="op" id="1607757">&gt;</span>&nbsp;<span class="num" id="1607759">0</span>&nbsp;<span class="op" id="1607761">&amp;&amp;</span>&nbsp;<span class="ident" id="1607764">pd</span><span class="op" id="1607766">.</span><span class="ident" id="1607767">rd</span>&nbsp;<span class="op" id="1607770">==</span>&nbsp;<span class="ident" id="1607773">pd</span><span class="op" id="1607775">.</span><span class="ident" id="1607776">wd</span>&nbsp;<span class="op" id="1607779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607783">pd</span><span class="op" id="1607785">.</span><span class="ident" id="1607786">rt</span><span class="op" id="1607788">.</span><span class="ident" id="1607789">f</span>&nbsp;<span class="op" id="1607791">=</span>&nbsp;<span class="ident" id="1607793">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607811">pd</span><span class="op" id="1607813">.</span><span class="ident" id="1607814">rt</span><span class="op" id="1607816">.</span><span class="ident" id="1607817">when</span>&nbsp;<span class="op" id="1607822">=</span>&nbsp;<span class="ident" id="1607824">pd</span><span class="op" id="1607826">.</span><span class="ident" id="1607827">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607832">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607874">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607941">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608009">pd</span><span class="op" id="1608011">.</span><span class="ident" id="1608012">rt</span><span class="op" id="1608014">.</span><span class="ident" id="1608015">arg</span>&nbsp;<span class="op" id="1608019">=</span>&nbsp;<span class="ident" id="1608021">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608026">pd</span><span class="op" id="1608028">.</span><span class="ident" id="1608029">rt</span><span class="op" id="1608031">.</span><span class="ident" id="1608032">seq</span>&nbsp;<span class="op" id="1608036">=</span>&nbsp;<span class="ident" id="1608038">pd</span><span class="op" id="1608040">.</span><span class="ident" id="1608041">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608047">addtimer</span><span class="op" id="1608055">(</span><span class="op" id="1608056">&amp;</span><span class="ident" id="1608057">pd</span><span class="op" id="1608059">.</span><span class="ident" id="1608060">rt</span><span class="op" id="1608062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608065">}</span>&nbsp;<span class="keyword" id="1608067">else</span>&nbsp;<span class="op" id="1608072">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608076">if</span>&nbsp;<span class="ident" id="1608079">pd</span><span class="op" id="1608081">.</span><span class="ident" id="1608082">rd</span>&nbsp;<span class="op" id="1608085">&gt;</span>&nbsp;<span class="num" id="1608087">0</span>&nbsp;<span class="op" id="1608089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608094">pd</span><span class="op" id="1608096">.</span><span class="ident" id="1608097">rt</span><span class="op" id="1608099">.</span><span class="ident" id="1608100">f</span>&nbsp;<span class="op" id="1608102">=</span>&nbsp;<span class="ident" id="1608104">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608127">pd</span><span class="op" id="1608129">.</span><span class="ident" id="1608130">rt</span><span class="op" id="1608132">.</span><span class="ident" id="1608133">when</span>&nbsp;<span class="op" id="1608138">=</span>&nbsp;<span class="ident" id="1608140">pd</span><span class="op" id="1608142">.</span><span class="ident" id="1608143">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608149">pd</span><span class="op" id="1608151">.</span><span class="ident" id="1608152">rt</span><span class="op" id="1608154">.</span><span class="ident" id="1608155">arg</span>&nbsp;<span class="op" id="1608159">=</span>&nbsp;<span class="ident" id="1608161">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608167">pd</span><span class="op" id="1608169">.</span><span class="ident" id="1608170">rt</span><span class="op" id="1608172">.</span><span class="ident" id="1608173">seq</span>&nbsp;<span class="op" id="1608177">=</span>&nbsp;<span class="ident" id="1608179">pd</span><span class="op" id="1608181">.</span><span class="ident" id="1608182">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608189">addtimer</span><span class="op" id="1608197">(</span><span class="op" id="1608198">&amp;</span><span class="ident" id="1608199">pd</span><span class="op" id="1608201">.</span><span class="ident" id="1608202">rt</span><span class="op" id="1608204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608212">if</span>&nbsp;<span class="ident" id="1608215">pd</span><span class="op" id="1608217">.</span><span class="ident" id="1608218">wd</span>&nbsp;<span class="op" id="1608221">&gt;</span>&nbsp;<span class="num" id="1608223">0</span>&nbsp;<span class="op" id="1608225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608230">pd</span><span class="op" id="1608232">.</span><span class="ident" id="1608233">wt</span><span class="op" id="1608235">.</span><span class="ident" id="1608236">f</span>&nbsp;<span class="op" id="1608238">=</span>&nbsp;<span class="ident" id="1608240">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608264">pd</span><span class="op" id="1608266">.</span><span class="ident" id="1608267">wt</span><span class="op" id="1608269">.</span><span class="ident" id="1608270">when</span>&nbsp;<span class="op" id="1608275">=</span>&nbsp;<span class="ident" id="1608277">pd</span><span class="op" id="1608279">.</span><span class="ident" id="1608280">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608286">pd</span><span class="op" id="1608288">.</span><span class="ident" id="1608289">wt</span><span class="op" id="1608291">.</span><span class="ident" id="1608292">arg</span>&nbsp;<span class="op" id="1608296">=</span>&nbsp;<span class="ident" id="1608298">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608304">pd</span><span class="op" id="1608306">.</span><span class="ident" id="1608307">wt</span><span class="op" id="1608309">.</span><span class="ident" id="1608310">seq</span>&nbsp;<span class="op" id="1608314">=</span>&nbsp;<span class="ident" id="1608316">pd</span><span class="op" id="1608318">.</span><span class="ident" id="1608319">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608326">addtimer</span><span class="op" id="1608334">(</span><span class="op" id="1608335">&amp;</span><span class="ident" id="1608336">pd</span><span class="op" id="1608338">.</span><span class="ident" id="1608339">wt</span><span class="op" id="1608341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608348">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1608351">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608432">var</span>&nbsp;<span class="ident" id="1608436">rg</span><span class="op" id="1608438">,</span>&nbsp;<span class="ident" id="1608440">wg</span>&nbsp;<span class="op" id="1608443">*</span><span class="ident" id="1608444">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608447">atomicstorep</span><span class="op" id="1608459">(</span><span class="ident" id="1608460">unsafe</span><span class="op" id="1608466">.</span><span class="ident" id="1608467">Pointer</span><span class="op" id="1608474">(</span><span class="op" id="1608475">&amp;</span><span class="ident" id="1608476">wg</span><span class="op" id="1608478">)</span><span class="op" id="1608479">,</span>&nbsp;<span class="builtintype" id="1608481">nil</span><span class="op" id="1608484">)</span>&nbsp;<span class="comment" id="1608486">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608570">if</span>&nbsp;<span class="ident" id="1608573">pd</span><span class="op" id="1608575">.</span><span class="ident" id="1608576">rd</span>&nbsp;<span class="op" id="1608579">&lt;</span>&nbsp;<span class="num" id="1608581">0</span>&nbsp;<span class="op" id="1608583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608587">rg</span>&nbsp;<span class="op" id="1608590">=</span>&nbsp;<span class="ident" id="1608592">netpollunblock</span><span class="op" id="1608606">(</span><span class="ident" id="1608607">pd</span><span class="op" id="1608609">,</span>&nbsp;<span class="string" id="1608611">&#39;r&#39;</span><span class="op" id="1608614">,</span>&nbsp;<span class="builtintype" id="1608616">false</span><span class="op" id="1608621">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608627">if</span>&nbsp;<span class="ident" id="1608630">pd</span><span class="op" id="1608632">.</span><span class="ident" id="1608633">wd</span>&nbsp;<span class="op" id="1608636">&lt;</span>&nbsp;<span class="num" id="1608638">0</span>&nbsp;<span class="op" id="1608640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608644">wg</span>&nbsp;<span class="op" id="1608647">=</span>&nbsp;<span class="ident" id="1608649">netpollunblock</span><span class="op" id="1608663">(</span><span class="ident" id="1608664">pd</span><span class="op" id="1608666">,</span>&nbsp;<span class="string" id="1608668">&#39;w&#39;</span><span class="op" id="1608671">,</span>&nbsp;<span class="builtintype" id="1608673">false</span><span class="op" id="1608678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608684">unlock</span><span class="op" id="1608690">(</span><span class="op" id="1608691">&amp;</span><span class="ident" id="1608692">pd</span><span class="op" id="1608694">.</span><span class="ident" id="1608695">lock</span><span class="op" id="1608699">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608702">if</span>&nbsp;<span class="ident" id="1608705">rg</span>&nbsp;<span class="op" id="1608708">!=</span>&nbsp;<span class="builtintype" id="1608711">nil</span>&nbsp;<span class="op" id="1608715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608719">goready</span><span class="op" id="1608726">(</span><span class="ident" id="1608727">rg</span><span class="op" id="1608729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608735">if</span>&nbsp;<span class="ident" id="1608738">wg</span>&nbsp;<span class="op" id="1608741">!=</span>&nbsp;<span class="builtintype" id="1608744">nil</span>&nbsp;<span class="op" id="1608748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608752">goready</span><span class="op" id="1608759">(</span><span class="ident" id="1608760">wg</span><span class="op" id="1608762">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608765">}</span><br>
<span class="lineno"></span><span class="op" id="1608767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608770">func</span>&nbsp;<span class="ident" id="1608775">netpollUnblock</span><span class="op" id="1608789">(</span><span class="ident" id="1608790">pd</span>&nbsp;<span class="op" id="1608793">*</span><span class="ident" id="1608794">pollDesc</span><span class="op" id="1608802">)</span>&nbsp;<span class="op" id="1608804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608807">lock</span><span class="op" id="1608811">(</span><span class="op" id="1608812">&amp;</span><span class="ident" id="1608813">pd</span><span class="op" id="1608815">.</span><span class="ident" id="1608816">lock</span><span class="op" id="1608820">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608823">if</span>&nbsp;<span class="ident" id="1608826">pd</span><span class="op" id="1608828">.</span><span class="ident" id="1608829">closing</span>&nbsp;<span class="op" id="1608837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608841">gothrow</span><span class="op" id="1608848">(</span><span class="string" id="1608849">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1608882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1608885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608888">pd</span><span class="op" id="1608890">.</span><span class="ident" id="1608891">closing</span>&nbsp;<span class="op" id="1608899">=</span>&nbsp;<span class="builtintype" id="1608901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608907">pd</span><span class="op" id="1608909">.</span><span class="ident" id="1608910">seq</span><span class="op" id="1608913">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1608917">var</span>&nbsp;<span class="ident" id="1608921">rg</span><span class="op" id="1608923">,</span>&nbsp;<span class="ident" id="1608925">wg</span>&nbsp;<span class="op" id="1608928">*</span><span class="ident" id="1608929">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1608932">atomicstorep</span><span class="op" id="1608944">(</span><span class="ident" id="1608945">unsafe</span><span class="op" id="1608951">.</span><span class="ident" id="1608952">Pointer</span><span class="op" id="1608959">(</span><span class="op" id="1608960">&amp;</span><span class="ident" id="1608961">rg</span><span class="op" id="1608963">)</span><span class="op" id="1608964">,</span>&nbsp;<span class="builtintype" id="1608966">nil</span><span class="op" id="1608969">)</span>&nbsp;<span class="comment" id="1608971">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609056">rg</span>&nbsp;<span class="op" id="1609059">=</span>&nbsp;<span class="ident" id="1609061">netpollunblock</span><span class="op" id="1609075">(</span><span class="ident" id="1609076">pd</span><span class="op" id="1609078">,</span>&nbsp;<span class="string" id="1609080">&#39;r&#39;</span><span class="op" id="1609083">,</span>&nbsp;<span class="builtintype" id="1609085">false</span><span class="op" id="1609090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609093">wg</span>&nbsp;<span class="op" id="1609096">=</span>&nbsp;<span class="ident" id="1609098">netpollunblock</span><span class="op" id="1609112">(</span><span class="ident" id="1609113">pd</span><span class="op" id="1609115">,</span>&nbsp;<span class="string" id="1609117">&#39;w&#39;</span><span class="op" id="1609120">,</span>&nbsp;<span class="builtintype" id="1609122">false</span><span class="op" id="1609127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609130">if</span>&nbsp;<span class="ident" id="1609133">pd</span><span class="op" id="1609135">.</span><span class="ident" id="1609136">rt</span><span class="op" id="1609138">.</span><span class="ident" id="1609139">f</span>&nbsp;<span class="op" id="1609141">!=</span>&nbsp;<span class="builtintype" id="1609144">nil</span>&nbsp;<span class="op" id="1609148">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609152">deltimer</span><span class="op" id="1609160">(</span><span class="op" id="1609161">&amp;</span><span class="ident" id="1609162">pd</span><span class="op" id="1609164">.</span><span class="ident" id="1609165">rt</span><span class="op" id="1609167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609171">pd</span><span class="op" id="1609173">.</span><span class="ident" id="1609174">rt</span><span class="op" id="1609176">.</span><span class="ident" id="1609177">f</span>&nbsp;<span class="op" id="1609179">=</span>&nbsp;<span class="builtintype" id="1609181">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609189">if</span>&nbsp;<span class="ident" id="1609192">pd</span><span class="op" id="1609194">.</span><span class="ident" id="1609195">wt</span><span class="op" id="1609197">.</span><span class="ident" id="1609198">f</span>&nbsp;<span class="op" id="1609200">!=</span>&nbsp;<span class="builtintype" id="1609203">nil</span>&nbsp;<span class="op" id="1609207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609211">deltimer</span><span class="op" id="1609219">(</span><span class="op" id="1609220">&amp;</span><span class="ident" id="1609221">pd</span><span class="op" id="1609223">.</span><span class="ident" id="1609224">wt</span><span class="op" id="1609226">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609230">pd</span><span class="op" id="1609232">.</span><span class="ident" id="1609233">wt</span><span class="op" id="1609235">.</span><span class="ident" id="1609236">f</span>&nbsp;<span class="op" id="1609238">=</span>&nbsp;<span class="builtintype" id="1609240">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609248">unlock</span><span class="op" id="1609254">(</span><span class="op" id="1609255">&amp;</span><span class="ident" id="1609256">pd</span><span class="op" id="1609258">.</span><span class="ident" id="1609259">lock</span><span class="op" id="1609263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609266">if</span>&nbsp;<span class="ident" id="1609269">rg</span>&nbsp;<span class="op" id="1609272">!=</span>&nbsp;<span class="builtintype" id="1609275">nil</span>&nbsp;<span class="op" id="1609279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609283">goready</span><span class="op" id="1609290">(</span><span class="ident" id="1609291">rg</span><span class="op" id="1609293">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609299">if</span>&nbsp;<span class="ident" id="1609302">wg</span>&nbsp;<span class="op" id="1609305">!=</span>&nbsp;<span class="builtintype" id="1609308">nil</span>&nbsp;<span class="op" id="1609312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609316">goready</span><span class="op" id="1609323">(</span><span class="ident" id="1609324">wg</span><span class="op" id="1609326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609329">}</span><br>
<span class="lineno"></span><span class="op" id="1609331">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1609334">func</span>&nbsp;<span class="ident" id="1609339">netpollfd</span><span class="op" id="1609348">(</span><span class="ident" id="1609349">pd</span>&nbsp;<span class="op" id="1609352">*</span><span class="ident" id="1609353">pollDesc</span><span class="op" id="1609361">)</span>&nbsp;<span class="builtintype" id="1609363">uintptr</span>&nbsp;<span class="op" id="1609371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609374">return</span>&nbsp;<span class="ident" id="1609381">pd</span><span class="op" id="1609383">.</span><span class="ident" id="1609384">fd</span><br>
<span class="lineno"></span><span class="op" id="1609387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1609390">func</span>&nbsp;<span class="ident" id="1609395">netpolluser</span><span class="op" id="1609406">(</span><span class="ident" id="1609407">pd</span>&nbsp;<span class="op" id="1609410">*</span><span class="ident" id="1609411">pollDesc</span><span class="op" id="1609419">)</span>&nbsp;<span class="op" id="1609421">*</span><span class="ident" id="1609422">unsafe</span><span class="op" id="1609428">.</span><span class="ident" id="1609429">Pointer</span>&nbsp;<span class="op" id="1609437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609440">return</span>&nbsp;<span class="op" id="1609447">&amp;</span><span class="ident" id="1609448">pd</span><span class="op" id="1609450">.</span><span class="ident" id="1609451">user</span><br>
<span class="lineno"></span><span class="op" id="1609456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1609459">func</span>&nbsp;<span class="ident" id="1609464">netpollclosing</span><span class="op" id="1609478">(</span><span class="ident" id="1609479">pd</span>&nbsp;<span class="op" id="1609482">*</span><span class="ident" id="1609483">pollDesc</span><span class="op" id="1609491">)</span>&nbsp;<span class="builtintype" id="1609493">bool</span>&nbsp;<span class="op" id="1609498">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609501">return</span>&nbsp;<span class="ident" id="1609508">pd</span><span class="op" id="1609510">.</span><span class="ident" id="1609511">closing</span><br>
<span class="lineno"></span><span class="op" id="1609519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1609522">func</span>&nbsp;<span class="ident" id="1609527">netpolllock</span><span class="op" id="1609538">(</span><span class="ident" id="1609539">pd</span>&nbsp;<span class="op" id="1609542">*</span><span class="ident" id="1609543">pollDesc</span><span class="op" id="1609551">)</span>&nbsp;<span class="op" id="1609553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609556">lock</span><span class="op" id="1609560">(</span><span class="op" id="1609561">&amp;</span><span class="ident" id="1609562">pd</span><span class="op" id="1609564">.</span><span class="ident" id="1609565">lock</span><span class="op" id="1609569">)</span><br>
<span class="lineno">280</span><span class="op" id="1609571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1609574">func</span>&nbsp;<span class="ident" id="1609579">netpollunlock</span><span class="op" id="1609592">(</span><span class="ident" id="1609593">pd</span>&nbsp;<span class="op" id="1609596">*</span><span class="ident" id="1609597">pollDesc</span><span class="op" id="1609605">)</span>&nbsp;<span class="op" id="1609607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609610">unlock</span><span class="op" id="1609616">(</span><span class="op" id="1609617">&amp;</span><span class="ident" id="1609618">pd</span><span class="op" id="1609620">.</span><span class="ident" id="1609621">lock</span><span class="op" id="1609625">)</span><br>
<span class="lineno"></span><span class="op" id="1609627">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1609630">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1609705">func</span>&nbsp;<span class="ident" id="1609710">netpollready</span><span class="op" id="1609722">(</span><span class="ident" id="1609723">gpp</span>&nbsp;<span class="op" id="1609727">*</span><span class="op" id="1609728">*</span><span class="ident" id="1609729">g</span><span class="op" id="1609730">,</span>&nbsp;<span class="ident" id="1609732">pd</span>&nbsp;<span class="op" id="1609735">*</span><span class="ident" id="1609736">pollDesc</span><span class="op" id="1609744">,</span>&nbsp;<span class="ident" id="1609746">mode</span>&nbsp;<span class="builtintype" id="1609751">int32</span><span class="op" id="1609756">)</span>&nbsp;<span class="op" id="1609758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609761">var</span>&nbsp;<span class="ident" id="1609765">rg</span><span class="op" id="1609767">,</span>&nbsp;<span class="ident" id="1609769">wg</span>&nbsp;<span class="op" id="1609772">*</span><span class="ident" id="1609773">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609776">if</span>&nbsp;<span class="ident" id="1609779">mode</span>&nbsp;<span class="op" id="1609784">==</span>&nbsp;<span class="string" id="1609787">&#39;r&#39;</span>&nbsp;<span class="op" id="1609791">||</span>&nbsp;<span class="ident" id="1609794">mode</span>&nbsp;<span class="op" id="1609799">==</span>&nbsp;<span class="string" id="1609802">&#39;r&#39;</span><span class="op" id="1609805">+</span><span class="string" id="1609806">&#39;w&#39;</span>&nbsp;<span class="op" id="1609810">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609814">rg</span>&nbsp;<span class="op" id="1609817">=</span>&nbsp;<span class="ident" id="1609819">netpollunblock</span><span class="op" id="1609833">(</span><span class="ident" id="1609834">pd</span><span class="op" id="1609836">,</span>&nbsp;<span class="string" id="1609838">&#39;r&#39;</span><span class="op" id="1609841">,</span>&nbsp;<span class="builtintype" id="1609843">true</span><span class="op" id="1609847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609853">if</span>&nbsp;<span class="ident" id="1609856">mode</span>&nbsp;<span class="op" id="1609861">==</span>&nbsp;<span class="string" id="1609864">&#39;w&#39;</span>&nbsp;<span class="op" id="1609868">||</span>&nbsp;<span class="ident" id="1609871">mode</span>&nbsp;<span class="op" id="1609876">==</span>&nbsp;<span class="string" id="1609879">&#39;r&#39;</span><span class="op" id="1609882">+</span><span class="string" id="1609883">&#39;w&#39;</span>&nbsp;<span class="op" id="1609887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609891">wg</span>&nbsp;<span class="op" id="1609894">=</span>&nbsp;<span class="ident" id="1609896">netpollunblock</span><span class="op" id="1609910">(</span><span class="ident" id="1609911">pd</span><span class="op" id="1609913">,</span>&nbsp;<span class="string" id="1609915">&#39;w&#39;</span><span class="op" id="1609918">,</span>&nbsp;<span class="builtintype" id="1609920">true</span><span class="op" id="1609924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609927">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609930">if</span>&nbsp;<span class="ident" id="1609933">rg</span>&nbsp;<span class="op" id="1609936">!=</span>&nbsp;<span class="builtintype" id="1609939">nil</span>&nbsp;<span class="op" id="1609943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1609947">rg</span><span class="op" id="1609949">.</span><span class="ident" id="1609950">schedlink</span>&nbsp;<span class="op" id="1609960">=</span>&nbsp;<span class="op" id="1609962">*</span><span class="ident" id="1609963">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609969">*</span><span class="ident" id="1609970">gpp</span>&nbsp;<span class="op" id="1609974">=</span>&nbsp;<span class="ident" id="1609976">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1609980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1609983">if</span>&nbsp;<span class="ident" id="1609986">wg</span>&nbsp;<span class="op" id="1609989">!=</span>&nbsp;<span class="builtintype" id="1609992">nil</span>&nbsp;<span class="op" id="1609996">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610000">wg</span><span class="op" id="1610002">.</span><span class="ident" id="1610003">schedlink</span>&nbsp;<span class="op" id="1610013">=</span>&nbsp;<span class="op" id="1610015">*</span><span class="ident" id="1610016">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610022">*</span><span class="ident" id="1610023">gpp</span>&nbsp;<span class="op" id="1610027">=</span>&nbsp;<span class="ident" id="1610029">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610033">}</span><br>
<span class="lineno"></span><span class="op" id="1610035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1610038">func</span>&nbsp;<span class="ident" id="1610043">netpollcheckerr</span><span class="op" id="1610058">(</span><span class="ident" id="1610059">pd</span>&nbsp;<span class="op" id="1610062">*</span><span class="ident" id="1610063">pollDesc</span><span class="op" id="1610071">,</span>&nbsp;<span class="ident" id="1610073">mode</span>&nbsp;<span class="builtintype" id="1610078">int32</span><span class="op" id="1610083">)</span>&nbsp;<span class="builtintype" id="1610085">int</span>&nbsp;<span class="op" id="1610089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610092">if</span>&nbsp;<span class="ident" id="1610095">pd</span><span class="op" id="1610097">.</span><span class="ident" id="1610098">closing</span>&nbsp;<span class="op" id="1610106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610110">return</span>&nbsp;<span class="num" id="1610117">1</span>&nbsp;<span class="comment" id="1610119">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610137">if</span>&nbsp;<span class="op" id="1610140">(</span><span class="ident" id="1610141">mode</span>&nbsp;<span class="op" id="1610146">==</span>&nbsp;<span class="string" id="1610149">&#39;r&#39;</span>&nbsp;<span class="op" id="1610153">&amp;&amp;</span>&nbsp;<span class="ident" id="1610156">pd</span><span class="op" id="1610158">.</span><span class="ident" id="1610159">rd</span>&nbsp;<span class="op" id="1610162">&lt;</span>&nbsp;<span class="num" id="1610164">0</span><span class="op" id="1610165">)</span>&nbsp;<span class="op" id="1610167">||</span>&nbsp;<span class="op" id="1610170">(</span><span class="ident" id="1610171">mode</span>&nbsp;<span class="op" id="1610176">==</span>&nbsp;<span class="string" id="1610179">&#39;w&#39;</span>&nbsp;<span class="op" id="1610183">&amp;&amp;</span>&nbsp;<span class="ident" id="1610186">pd</span><span class="op" id="1610188">.</span><span class="ident" id="1610189">wd</span>&nbsp;<span class="op" id="1610192">&lt;</span>&nbsp;<span class="num" id="1610194">0</span><span class="op" id="1610195">)</span>&nbsp;<span class="op" id="1610197">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610201">return</span>&nbsp;<span class="num" id="1610208">2</span>&nbsp;<span class="comment" id="1610210">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610228">return</span>&nbsp;<span class="num" id="1610235">0</span><br>
<span class="lineno"></span><span class="op" id="1610237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1610240">func</span>&nbsp;<span class="ident" id="1610245">netpollblockcommit</span><span class="op" id="1610263">(</span><span class="ident" id="1610264">gp</span>&nbsp;<span class="op" id="1610267">*</span><span class="ident" id="1610268">g</span><span class="op" id="1610269">,</span>&nbsp;<span class="ident" id="1610271">gpp</span>&nbsp;<span class="ident" id="1610275">unsafe</span><span class="op" id="1610281">.</span><span class="ident" id="1610282">Pointer</span><span class="op" id="1610289">)</span>&nbsp;<span class="builtintype" id="1610291">bool</span>&nbsp;<span class="op" id="1610296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610299">return</span>&nbsp;<span class="ident" id="1610306">casuintptr</span><span class="op" id="1610316">(</span><span class="op" id="1610317">(</span><span class="op" id="1610318">*</span><span class="builtintype" id="1610319">uintptr</span><span class="op" id="1610326">)</span><span class="op" id="1610327">(</span><span class="ident" id="1610328">gpp</span><span class="op" id="1610331">)</span><span class="op" id="1610332">,</span>&nbsp;<span class="ident" id="1610334">pdWait</span><span class="op" id="1610340">,</span>&nbsp;<span class="builtintype" id="1610342">uintptr</span><span class="op" id="1610349">(</span><span class="ident" id="1610350">unsafe</span><span class="op" id="1610356">.</span><span class="ident" id="1610357">Pointer</span><span class="op" id="1610364">(</span><span class="ident" id="1610365">gp</span><span class="op" id="1610367">)</span><span class="op" id="1610368">)</span><span class="op" id="1610369">)</span><br>
<span class="lineno"></span><span class="op" id="1610371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610374">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1610437">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1610491">func</span>&nbsp;<span class="ident" id="1610496">netpollblock</span><span class="op" id="1610508">(</span><span class="ident" id="1610509">pd</span>&nbsp;<span class="op" id="1610512">*</span><span class="ident" id="1610513">pollDesc</span><span class="op" id="1610521">,</span>&nbsp;<span class="ident" id="1610523">mode</span>&nbsp;<span class="builtintype" id="1610528">int32</span><span class="op" id="1610533">,</span>&nbsp;<span class="ident" id="1610535">waitio</span>&nbsp;<span class="builtintype" id="1610542">bool</span><span class="op" id="1610546">)</span>&nbsp;<span class="builtintype" id="1610548">bool</span>&nbsp;<span class="op" id="1610553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610556">gpp</span>&nbsp;<span class="op" id="1610560">:=</span>&nbsp;<span class="op" id="1610563">&amp;</span><span class="ident" id="1610564">pd</span><span class="op" id="1610566">.</span><span class="ident" id="1610567">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610571">if</span>&nbsp;<span class="ident" id="1610574">mode</span>&nbsp;<span class="op" id="1610579">==</span>&nbsp;<span class="string" id="1610582">&#39;w&#39;</span>&nbsp;<span class="op" id="1610586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610590">gpp</span>&nbsp;<span class="op" id="1610594">=</span>&nbsp;<span class="op" id="1610596">&amp;</span><span class="ident" id="1610597">pd</span><span class="op" id="1610599">.</span><span class="ident" id="1610600">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610608">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610642">for</span>&nbsp;<span class="op" id="1610646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610650">old</span>&nbsp;<span class="op" id="1610654">:=</span>&nbsp;<span class="op" id="1610657">*</span><span class="ident" id="1610658">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610664">if</span>&nbsp;<span class="ident" id="1610667">old</span>&nbsp;<span class="op" id="1610671">==</span>&nbsp;<span class="ident" id="1610674">pdReady</span>&nbsp;<span class="op" id="1610682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610687">*</span><span class="ident" id="1610688">gpp</span>&nbsp;<span class="op" id="1610692">=</span>&nbsp;<span class="num" id="1610694">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610699">return</span>&nbsp;<span class="builtintype" id="1610706">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610717">if</span>&nbsp;<span class="ident" id="1610720">old</span>&nbsp;<span class="op" id="1610724">!=</span>&nbsp;<span class="num" id="1610727">0</span>&nbsp;<span class="op" id="1610729">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1610734">gothrow</span><span class="op" id="1610741">(</span><span class="string" id="1610742">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1610769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610777">if</span>&nbsp;<span class="ident" id="1610780">casuintptr</span><span class="op" id="1610790">(</span><span class="ident" id="1610791">gpp</span><span class="op" id="1610794">,</span>&nbsp;<span class="num" id="1610796">0</span><span class="op" id="1610797">,</span>&nbsp;<span class="ident" id="1610799">pdWait</span><span class="op" id="1610805">)</span>&nbsp;<span class="op" id="1610807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1610812">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610820">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1610823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610827">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610886">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1610973">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611044">if</span>&nbsp;<span class="ident" id="1611047">waitio</span>&nbsp;<span class="op" id="1611054">||</span>&nbsp;<span class="ident" id="1611057">netpollcheckerr</span><span class="op" id="1611072">(</span><span class="ident" id="1611073">pd</span><span class="op" id="1611075">,</span>&nbsp;<span class="ident" id="1611077">mode</span><span class="op" id="1611081">)</span>&nbsp;<span class="op" id="1611083">==</span>&nbsp;<span class="num" id="1611086">0</span>&nbsp;<span class="op" id="1611088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611092">f</span>&nbsp;<span class="op" id="1611094">:=</span>&nbsp;<span class="ident" id="1611097">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611118">gopark</span><span class="op" id="1611124">(</span><span class="op" id="1611125">*</span><span class="op" id="1611126">*</span><span class="op" id="1611127">(</span><span class="op" id="1611128">*</span><span class="op" id="1611129">*</span><span class="ident" id="1611130">unsafe</span><span class="op" id="1611136">.</span><span class="ident" id="1611137">Pointer</span><span class="op" id="1611144">)</span><span class="op" id="1611145">(</span><span class="ident" id="1611146">unsafe</span><span class="op" id="1611152">.</span><span class="ident" id="1611153">Pointer</span><span class="op" id="1611160">(</span><span class="op" id="1611161">&amp;</span><span class="ident" id="1611162">f</span><span class="op" id="1611163">)</span><span class="op" id="1611164">)</span><span class="op" id="1611165">,</span>&nbsp;<span class="ident" id="1611167">unsafe</span><span class="op" id="1611173">.</span><span class="ident" id="1611174">Pointer</span><span class="op" id="1611181">(</span><span class="ident" id="1611182">gpp</span><span class="op" id="1611185">)</span><span class="op" id="1611186">,</span>&nbsp;<span class="string" id="1611188">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1611197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611203">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611260">old</span>&nbsp;<span class="op" id="1611264">:=</span>&nbsp;<span class="ident" id="1611267">xchguintptr</span><span class="op" id="1611278">(</span><span class="ident" id="1611279">gpp</span><span class="op" id="1611282">,</span>&nbsp;<span class="num" id="1611284">0</span><span class="op" id="1611285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611288">if</span>&nbsp;<span class="ident" id="1611291">old</span>&nbsp;<span class="op" id="1611295">&gt;</span>&nbsp;<span class="ident" id="1611297">pdWait</span>&nbsp;<span class="op" id="1611304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611308">gothrow</span><span class="op" id="1611315">(</span><span class="string" id="1611316">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1611347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611353">return</span>&nbsp;<span class="ident" id="1611360">old</span>&nbsp;<span class="op" id="1611364">==</span>&nbsp;<span class="ident" id="1611367">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1611375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611378">func</span>&nbsp;<span class="ident" id="1611383">netpollunblock</span><span class="op" id="1611397">(</span><span class="ident" id="1611398">pd</span>&nbsp;<span class="op" id="1611401">*</span><span class="ident" id="1611402">pollDesc</span><span class="op" id="1611410">,</span>&nbsp;<span class="ident" id="1611412">mode</span>&nbsp;<span class="builtintype" id="1611417">int32</span><span class="op" id="1611422">,</span>&nbsp;<span class="ident" id="1611424">ioready</span>&nbsp;<span class="builtintype" id="1611432">bool</span><span class="op" id="1611436">)</span>&nbsp;<span class="op" id="1611438">*</span><span class="ident" id="1611439">g</span>&nbsp;<span class="op" id="1611441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611444">gpp</span>&nbsp;<span class="op" id="1611448">:=</span>&nbsp;<span class="op" id="1611451">&amp;</span><span class="ident" id="1611452">pd</span><span class="op" id="1611454">.</span><span class="ident" id="1611455">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611459">if</span>&nbsp;<span class="ident" id="1611462">mode</span>&nbsp;<span class="op" id="1611467">==</span>&nbsp;<span class="string" id="1611470">&#39;w&#39;</span>&nbsp;<span class="op" id="1611474">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611478">gpp</span>&nbsp;<span class="op" id="1611482">=</span>&nbsp;<span class="op" id="1611484">&amp;</span><span class="ident" id="1611485">pd</span><span class="op" id="1611487">.</span><span class="ident" id="1611488">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611496">for</span>&nbsp;<span class="op" id="1611500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611504">old</span>&nbsp;<span class="op" id="1611508">:=</span>&nbsp;<span class="op" id="1611511">*</span><span class="ident" id="1611512">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611518">if</span>&nbsp;<span class="ident" id="1611521">old</span>&nbsp;<span class="op" id="1611525">==</span>&nbsp;<span class="ident" id="1611528">pdReady</span>&nbsp;<span class="op" id="1611536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611541">return</span>&nbsp;<span class="builtintype" id="1611548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611558">if</span>&nbsp;<span class="ident" id="1611561">old</span>&nbsp;<span class="op" id="1611565">==</span>&nbsp;<span class="num" id="1611568">0</span>&nbsp;<span class="op" id="1611570">&amp;&amp;</span>&nbsp;<span class="op" id="1611573">!</span><span class="ident" id="1611574">ioready</span>&nbsp;<span class="op" id="1611582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611587">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611638">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611690">return</span>&nbsp;<span class="builtintype" id="1611697">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611707">var</span>&nbsp;<span class="builtinfunc" id="1611711">new</span>&nbsp;<span class="builtintype" id="1611715">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611725">if</span>&nbsp;<span class="ident" id="1611728">ioready</span>&nbsp;<span class="op" id="1611736">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1611741">new</span>&nbsp;<span class="op" id="1611745">=</span>&nbsp;<span class="ident" id="1611747">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611761">if</span>&nbsp;<span class="ident" id="1611764">casuintptr</span><span class="op" id="1611774">(</span><span class="ident" id="1611775">gpp</span><span class="op" id="1611778">,</span>&nbsp;<span class="ident" id="1611780">old</span><span class="op" id="1611783">,</span>&nbsp;<span class="builtinfunc" id="1611785">new</span><span class="op" id="1611788">)</span>&nbsp;<span class="op" id="1611790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611795">if</span>&nbsp;<span class="ident" id="1611798">old</span>&nbsp;<span class="op" id="1611802">==</span>&nbsp;<span class="ident" id="1611805">pdReady</span>&nbsp;<span class="op" id="1611813">||</span>&nbsp;<span class="ident" id="1611816">old</span>&nbsp;<span class="op" id="1611820">==</span>&nbsp;<span class="ident" id="1611823">pdWait</span>&nbsp;<span class="op" id="1611830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611836">old</span>&nbsp;<span class="op" id="1611840">=</span>&nbsp;<span class="num" id="1611842">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1611852">return</span>&nbsp;<span class="op" id="1611859">(</span><span class="op" id="1611860">*</span><span class="ident" id="1611861">g</span><span class="op" id="1611862">)</span><span class="op" id="1611863">(</span><span class="ident" id="1611864">unsafe</span><span class="op" id="1611870">.</span><span class="ident" id="1611871">Pointer</span><span class="op" id="1611878">(</span><span class="ident" id="1611879">old</span><span class="op" id="1611882">)</span><span class="op" id="1611883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1611890">}</span><br>
<span class="lineno"></span><span class="op" id="1611892">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1611895">func</span>&nbsp;<span class="ident" id="1611900">netpolldeadlineimpl</span><span class="op" id="1611919">(</span><span class="ident" id="1611920">pd</span>&nbsp;<span class="op" id="1611923">*</span><span class="ident" id="1611924">pollDesc</span><span class="op" id="1611932">,</span>&nbsp;<span class="ident" id="1611934">seq</span>&nbsp;<span class="builtintype" id="1611938">uintptr</span><span class="op" id="1611945">,</span>&nbsp;<span class="ident" id="1611947">read</span><span class="op" id="1611951">,</span>&nbsp;<span class="ident" id="1611953">write</span>&nbsp;<span class="builtintype" id="1611959">bool</span><span class="op" id="1611963">)</span>&nbsp;<span class="op" id="1611965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1611968">lock</span><span class="op" id="1611972">(</span><span class="op" id="1611973">&amp;</span><span class="ident" id="1611974">pd</span><span class="op" id="1611976">.</span><span class="ident" id="1611977">lock</span><span class="op" id="1611981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1611984">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612027">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612070">if</span>&nbsp;<span class="ident" id="1612073">seq</span>&nbsp;<span class="op" id="1612077">!=</span>&nbsp;<span class="ident" id="1612080">pd</span><span class="op" id="1612082">.</span><span class="ident" id="1612083">seq</span>&nbsp;<span class="op" id="1612087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1612091">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612144">unlock</span><span class="op" id="1612150">(</span><span class="op" id="1612151">&amp;</span><span class="ident" id="1612152">pd</span><span class="op" id="1612154">.</span><span class="ident" id="1612155">lock</span><span class="op" id="1612159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612163">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612171">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612174">var</span>&nbsp;<span class="ident" id="1612178">rg</span>&nbsp;<span class="op" id="1612181">*</span><span class="ident" id="1612182">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612185">if</span>&nbsp;<span class="ident" id="1612188">read</span>&nbsp;<span class="op" id="1612193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612197">if</span>&nbsp;<span class="ident" id="1612200">pd</span><span class="op" id="1612202">.</span><span class="ident" id="1612203">rd</span>&nbsp;<span class="op" id="1612206">&lt;=</span>&nbsp;<span class="num" id="1612209">0</span>&nbsp;<span class="op" id="1612211">||</span>&nbsp;<span class="ident" id="1612214">pd</span><span class="op" id="1612216">.</span><span class="ident" id="1612217">rt</span><span class="op" id="1612219">.</span><span class="ident" id="1612220">f</span>&nbsp;<span class="op" id="1612222">==</span>&nbsp;<span class="builtintype" id="1612225">nil</span>&nbsp;<span class="op" id="1612229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612234">gothrow</span><span class="op" id="1612241">(</span><span class="string" id="1612242">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1612291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612295">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612299">pd</span><span class="op" id="1612301">.</span><span class="ident" id="1612302">rd</span>&nbsp;<span class="op" id="1612305">=</span>&nbsp;<span class="op" id="1612307">-</span><span class="num" id="1612308">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612312">atomicstorep</span><span class="op" id="1612324">(</span><span class="ident" id="1612325">unsafe</span><span class="op" id="1612331">.</span><span class="ident" id="1612332">Pointer</span><span class="op" id="1612339">(</span><span class="op" id="1612340">&amp;</span><span class="ident" id="1612341">pd</span><span class="op" id="1612343">.</span><span class="ident" id="1612344">rt</span><span class="op" id="1612346">.</span><span class="ident" id="1612347">f</span><span class="op" id="1612348">)</span><span class="op" id="1612349">,</span>&nbsp;<span class="builtintype" id="1612351">nil</span><span class="op" id="1612354">)</span>&nbsp;<span class="comment" id="1612356">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612434">rg</span>&nbsp;<span class="op" id="1612437">=</span>&nbsp;<span class="ident" id="1612439">netpollunblock</span><span class="op" id="1612453">(</span><span class="ident" id="1612454">pd</span><span class="op" id="1612456">,</span>&nbsp;<span class="string" id="1612458">&#39;r&#39;</span><span class="op" id="1612461">,</span>&nbsp;<span class="builtintype" id="1612463">false</span><span class="op" id="1612468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612474">var</span>&nbsp;<span class="ident" id="1612478">wg</span>&nbsp;<span class="op" id="1612481">*</span><span class="ident" id="1612482">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612485">if</span>&nbsp;<span class="ident" id="1612488">write</span>&nbsp;<span class="op" id="1612494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612498">if</span>&nbsp;<span class="ident" id="1612501">pd</span><span class="op" id="1612503">.</span><span class="ident" id="1612504">wd</span>&nbsp;<span class="op" id="1612507">&lt;=</span>&nbsp;<span class="num" id="1612510">0</span>&nbsp;<span class="op" id="1612512">||</span>&nbsp;<span class="ident" id="1612515">pd</span><span class="op" id="1612517">.</span><span class="ident" id="1612518">wt</span><span class="op" id="1612520">.</span><span class="ident" id="1612521">f</span>&nbsp;<span class="op" id="1612523">==</span>&nbsp;<span class="builtintype" id="1612526">nil</span>&nbsp;<span class="op" id="1612530">&amp;&amp;</span>&nbsp;<span class="op" id="1612533">!</span><span class="ident" id="1612534">read</span>&nbsp;<span class="op" id="1612539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612544">gothrow</span><span class="op" id="1612551">(</span><span class="string" id="1612552">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1612602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612610">pd</span><span class="op" id="1612612">.</span><span class="ident" id="1612613">wd</span>&nbsp;<span class="op" id="1612616">=</span>&nbsp;<span class="op" id="1612618">-</span><span class="num" id="1612619">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612623">atomicstorep</span><span class="op" id="1612635">(</span><span class="ident" id="1612636">unsafe</span><span class="op" id="1612642">.</span><span class="ident" id="1612643">Pointer</span><span class="op" id="1612650">(</span><span class="op" id="1612651">&amp;</span><span class="ident" id="1612652">pd</span><span class="op" id="1612654">.</span><span class="ident" id="1612655">wt</span><span class="op" id="1612657">.</span><span class="ident" id="1612658">f</span><span class="op" id="1612659">)</span><span class="op" id="1612660">,</span>&nbsp;<span class="builtintype" id="1612662">nil</span><span class="op" id="1612665">)</span>&nbsp;<span class="comment" id="1612667">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612745">wg</span>&nbsp;<span class="op" id="1612748">=</span>&nbsp;<span class="ident" id="1612750">netpollunblock</span><span class="op" id="1612764">(</span><span class="ident" id="1612765">pd</span><span class="op" id="1612767">,</span>&nbsp;<span class="string" id="1612769">&#39;w&#39;</span><span class="op" id="1612772">,</span>&nbsp;<span class="builtintype" id="1612774">false</span><span class="op" id="1612779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612785">unlock</span><span class="op" id="1612791">(</span><span class="op" id="1612792">&amp;</span><span class="ident" id="1612793">pd</span><span class="op" id="1612795">.</span><span class="ident" id="1612796">lock</span><span class="op" id="1612800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612803">if</span>&nbsp;<span class="ident" id="1612806">rg</span>&nbsp;<span class="op" id="1612809">!=</span>&nbsp;<span class="builtintype" id="1612812">nil</span>&nbsp;<span class="op" id="1612816">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612820">goready</span><span class="op" id="1612827">(</span><span class="ident" id="1612828">rg</span><span class="op" id="1612830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1612836">if</span>&nbsp;<span class="ident" id="1612839">wg</span>&nbsp;<span class="op" id="1612842">!=</span>&nbsp;<span class="builtintype" id="1612845">nil</span>&nbsp;<span class="op" id="1612849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612853">goready</span><span class="op" id="1612860">(</span><span class="ident" id="1612861">wg</span><span class="op" id="1612863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1612866">}</span><br>
<span class="lineno">420</span><span class="op" id="1612868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1612871">func</span>&nbsp;<span class="ident" id="1612876">netpollDeadline</span><span class="op" id="1612891">(</span><span class="ident" id="1612892">arg</span>&nbsp;<span class="keyword" id="1612896">interface</span><span class="op" id="1612905">{</span><span class="op" id="1612906">}</span><span class="op" id="1612907">,</span>&nbsp;<span class="ident" id="1612909">seq</span>&nbsp;<span class="builtintype" id="1612913">uintptr</span><span class="op" id="1612920">)</span>&nbsp;<span class="op" id="1612922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1612925">netpolldeadlineimpl</span><span class="op" id="1612944">(</span><span class="ident" id="1612945">arg</span><span class="op" id="1612948">.</span><span class="op" id="1612949">(</span><span class="op" id="1612950">*</span><span class="ident" id="1612951">pollDesc</span><span class="op" id="1612959">)</span><span class="op" id="1612960">,</span>&nbsp;<span class="ident" id="1612962">seq</span><span class="op" id="1612965">,</span>&nbsp;<span class="builtintype" id="1612967">true</span><span class="op" id="1612971">,</span>&nbsp;<span class="builtintype" id="1612973">true</span><span class="op" id="1612977">)</span><br>
<span class="lineno"></span><span class="op" id="1612979">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1612982">func</span>&nbsp;<span class="ident" id="1612987">netpollReadDeadline</span><span class="op" id="1613006">(</span><span class="ident" id="1613007">arg</span>&nbsp;<span class="keyword" id="1613011">interface</span><span class="op" id="1613020">{</span><span class="op" id="1613021">}</span><span class="op" id="1613022">,</span>&nbsp;<span class="ident" id="1613024">seq</span>&nbsp;<span class="builtintype" id="1613028">uintptr</span><span class="op" id="1613035">)</span>&nbsp;<span class="op" id="1613037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613040">netpolldeadlineimpl</span><span class="op" id="1613059">(</span><span class="ident" id="1613060">arg</span><span class="op" id="1613063">.</span><span class="op" id="1613064">(</span><span class="op" id="1613065">*</span><span class="ident" id="1613066">pollDesc</span><span class="op" id="1613074">)</span><span class="op" id="1613075">,</span>&nbsp;<span class="ident" id="1613077">seq</span><span class="op" id="1613080">,</span>&nbsp;<span class="builtintype" id="1613082">true</span><span class="op" id="1613086">,</span>&nbsp;<span class="builtintype" id="1613088">false</span><span class="op" id="1613093">)</span><br>
<span class="lineno"></span><span class="op" id="1613095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1613098">func</span>&nbsp;<span class="ident" id="1613103">netpollWriteDeadline</span><span class="op" id="1613123">(</span><span class="ident" id="1613124">arg</span>&nbsp;<span class="keyword" id="1613128">interface</span><span class="op" id="1613137">{</span><span class="op" id="1613138">}</span><span class="op" id="1613139">,</span>&nbsp;<span class="ident" id="1613141">seq</span>&nbsp;<span class="builtintype" id="1613145">uintptr</span><span class="op" id="1613152">)</span>&nbsp;<span class="op" id="1613154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613157">netpolldeadlineimpl</span><span class="op" id="1613176">(</span><span class="ident" id="1613177">arg</span><span class="op" id="1613180">.</span><span class="op" id="1613181">(</span><span class="op" id="1613182">*</span><span class="ident" id="1613183">pollDesc</span><span class="op" id="1613191">)</span><span class="op" id="1613192">,</span>&nbsp;<span class="ident" id="1613194">seq</span><span class="op" id="1613197">,</span>&nbsp;<span class="builtintype" id="1613199">false</span><span class="op" id="1613204">,</span>&nbsp;<span class="builtintype" id="1613206">true</span><span class="op" id="1613210">)</span><br>
<span class="lineno"></span><span class="op" id="1613212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1613215">func</span>&nbsp;<span class="op" id="1613220">(</span><span class="ident" id="1613221">c</span>&nbsp;<span class="op" id="1613223">*</span><span class="ident" id="1613224">pollCache</span><span class="op" id="1613233">)</span>&nbsp;<span class="ident" id="1613235">alloc</span><span class="op" id="1613240">(</span><span class="op" id="1613241">)</span>&nbsp;<span class="op" id="1613243">*</span><span class="ident" id="1613244">pollDesc</span>&nbsp;<span class="op" id="1613253">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613256">lock</span><span class="op" id="1613260">(</span><span class="op" id="1613261">&amp;</span><span class="ident" id="1613262">c</span><span class="op" id="1613263">.</span><span class="ident" id="1613264">lock</span><span class="op" id="1613268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613271">if</span>&nbsp;<span class="ident" id="1613274">c</span><span class="op" id="1613275">.</span><span class="ident" id="1613276">first</span>&nbsp;<span class="op" id="1613282">==</span>&nbsp;<span class="builtintype" id="1613285">nil</span>&nbsp;<span class="op" id="1613289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613293">const</span>&nbsp;<span class="ident" id="1613299">pdSize</span>&nbsp;<span class="op" id="1613306">=</span>&nbsp;<span class="ident" id="1613308">unsafe</span><span class="op" id="1613314">.</span><span class="ident" id="1613315">Sizeof</span><span class="op" id="1613321">(</span><span class="ident" id="1613322">pollDesc</span><span class="op" id="1613330">{</span><span class="op" id="1613331">}</span><span class="op" id="1613332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613336">n</span>&nbsp;<span class="op" id="1613338">:=</span>&nbsp;<span class="ident" id="1613341">pollBlockSize</span>&nbsp;<span class="op" id="1613355">/</span>&nbsp;<span class="ident" id="1613357">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613366">if</span>&nbsp;<span class="ident" id="1613369">n</span>&nbsp;<span class="op" id="1613371">==</span>&nbsp;<span class="num" id="1613374">0</span>&nbsp;<span class="op" id="1613376">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613381">n</span>&nbsp;<span class="op" id="1613383">=</span>&nbsp;<span class="num" id="1613385">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613393">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1613449">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613488">mem</span>&nbsp;<span class="op" id="1613492">:=</span>&nbsp;<span class="ident" id="1613495">persistentalloc</span><span class="op" id="1613510">(</span><span class="ident" id="1613511">n</span><span class="op" id="1613512">*</span><span class="ident" id="1613513">pdSize</span><span class="op" id="1613519">,</span>&nbsp;<span class="num" id="1613521">0</span><span class="op" id="1613522">,</span>&nbsp;<span class="op" id="1613524">&amp;</span><span class="ident" id="1613525">memstats</span><span class="op" id="1613533">.</span><span class="ident" id="1613534">other_sys</span><span class="op" id="1613543">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613547">for</span>&nbsp;<span class="ident" id="1613551">i</span>&nbsp;<span class="op" id="1613553">:=</span>&nbsp;<span class="builtintype" id="1613556">uintptr</span><span class="op" id="1613563">(</span><span class="num" id="1613564">0</span><span class="op" id="1613565">)</span><span class="op" id="1613566">;</span>&nbsp;<span class="ident" id="1613568">i</span>&nbsp;<span class="op" id="1613570">&lt;</span>&nbsp;<span class="ident" id="1613572">n</span><span class="op" id="1613573">;</span>&nbsp;<span class="ident" id="1613575">i</span><span class="op" id="1613576">++</span>&nbsp;<span class="op" id="1613579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613584">pd</span>&nbsp;<span class="op" id="1613587">:=</span>&nbsp;<span class="op" id="1613590">(</span><span class="op" id="1613591">*</span><span class="ident" id="1613592">pollDesc</span><span class="op" id="1613600">)</span><span class="op" id="1613601">(</span><span class="ident" id="1613602">add</span><span class="op" id="1613605">(</span><span class="ident" id="1613606">mem</span><span class="op" id="1613609">,</span>&nbsp;<span class="ident" id="1613611">i</span><span class="op" id="1613612">*</span><span class="ident" id="1613613">pdSize</span><span class="op" id="1613619">)</span><span class="op" id="1613620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613625">pd</span><span class="op" id="1613627">.</span><span class="ident" id="1613628">link</span>&nbsp;<span class="op" id="1613633">=</span>&nbsp;<span class="ident" id="1613635">c</span><span class="op" id="1613636">.</span><span class="ident" id="1613637">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613646">c</span><span class="op" id="1613647">.</span><span class="ident" id="1613648">first</span>&nbsp;<span class="op" id="1613654">=</span>&nbsp;<span class="ident" id="1613656">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613661">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1613664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613667">pd</span>&nbsp;<span class="op" id="1613670">:=</span>&nbsp;<span class="ident" id="1613673">c</span><span class="op" id="1613674">.</span><span class="ident" id="1613675">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613682">c</span><span class="op" id="1613683">.</span><span class="ident" id="1613684">first</span>&nbsp;<span class="op" id="1613690">=</span>&nbsp;<span class="ident" id="1613692">pd</span><span class="op" id="1613694">.</span><span class="ident" id="1613695">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1613701">unlock</span><span class="op" id="1613707">(</span><span class="op" id="1613708">&amp;</span><span class="ident" id="1613709">c</span><span class="op" id="1613710">.</span><span class="ident" id="1613711">lock</span><span class="op" id="1613715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1613718">return</span>&nbsp;<span class="ident" id="1613725">pd</span><br>
<span class="lineno">455</span><span class="op" id="1613728">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
