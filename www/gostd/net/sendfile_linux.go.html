<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3377638">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3377694">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3377748">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3377799">package</span>&nbsp;<span class="ident" id="3377807">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3377812">import</span>&nbsp;<span class="op" id="3377819">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3377822">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3377828">&#34;os&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3377834">&#34;syscall&#34;</span><br>
<span class="lineno"></span><span class="op" id="3377844">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3377847">//&nbsp;maxSendfileSize&nbsp;is&nbsp;the&nbsp;largest&nbsp;chunk&nbsp;size&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="3377918">//&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">15</span><span class="keyword" id="3377932">const</span>&nbsp;<span class="ident" id="3377938">maxSendfileSize</span>&nbsp;<span class="builtintype" id="3377954">int</span>&nbsp;<span class="op" id="3377958">=</span>&nbsp;<span class="num" id="3377960">4</span>&nbsp;<span class="op" id="3377962">&lt;&lt;</span>&nbsp;<span class="num" id="3377965">20</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3377969">//&nbsp;sendFile&nbsp;copies&nbsp;the&nbsp;contents&nbsp;of&nbsp;r&nbsp;to&nbsp;c&nbsp;using&nbsp;the&nbsp;sendfile</span><br>
<span class="lineno"></span><span class="comment" id="3378030">//&nbsp;system&nbsp;call&nbsp;to&nbsp;minimize&nbsp;copies.</span><br>
<span class="lineno"></span><span class="comment" id="3378065">//</span><br>
<span class="lineno">20</span><span class="comment" id="3378068">//&nbsp;if&nbsp;handled&nbsp;==&nbsp;true,&nbsp;sendFile&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3378143">//&nbsp;non-EOF&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="3378161">//</span><br>
<span class="lineno"></span><span class="comment" id="3378164">//&nbsp;if&nbsp;handled&nbsp;==&nbsp;false,&nbsp;sendFile&nbsp;performed&nbsp;no&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="3378216">func</span>&nbsp;<span class="ident" id="3378221">sendFile</span><span class="op" id="3378229">(</span><span class="ident" id="3378230">c</span>&nbsp;<span class="op" id="3378232">*</span><span class="ident" id="3378233">netFD</span><span class="op" id="3378238">,</span>&nbsp;<span class="ident" id="3378240">r</span>&nbsp;<span class="ident" id="3378242">io</span><span class="op" id="3378244">.</span><span class="ident" id="3378245">Reader</span><span class="op" id="3378251">)</span>&nbsp;<span class="op" id="3378253">(</span><span class="ident" id="3378254">written</span>&nbsp;<span class="ident" id="3378262">int64</span><span class="op" id="3378267">,</span>&nbsp;<span class="ident" id="3378269">err</span>&nbsp;<span class="builtintype" id="3378273">error</span><span class="op" id="3378278">,</span>&nbsp;<span class="ident" id="3378280">handled</span>&nbsp;<span class="builtintype" id="3378288">bool</span><span class="op" id="3378292">)</span>&nbsp;<span class="op" id="3378294">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378297">var</span>&nbsp;<span class="ident" id="3378301">remain</span>&nbsp;<span class="ident" id="3378308">int64</span>&nbsp;<span class="op" id="3378314">=</span>&nbsp;<span class="num" id="3378316">1</span>&nbsp;<span class="op" id="3378318">&lt;&lt;</span>&nbsp;<span class="num" id="3378321">62</span>&nbsp;<span class="comment" id="3378324">//&nbsp;by&nbsp;default,&nbsp;copy&nbsp;until&nbsp;EOF</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378356">lr</span><span class="op" id="3378358">,</span>&nbsp;<span class="ident" id="3378360">ok</span>&nbsp;<span class="op" id="3378363">:=</span>&nbsp;<span class="ident" id="3378366">r</span><span class="op" id="3378367">.</span><span class="op" id="3378368">(</span><span class="op" id="3378369">*</span><span class="ident" id="3378370">io</span><span class="op" id="3378372">.</span><span class="ident" id="3378373">LimitedReader</span><span class="op" id="3378386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378389">if</span>&nbsp;<span class="ident" id="3378392">ok</span>&nbsp;<span class="op" id="3378395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378399">remain</span><span class="op" id="3378405">,</span>&nbsp;<span class="ident" id="3378407">r</span>&nbsp;<span class="op" id="3378409">=</span>&nbsp;<span class="ident" id="3378411">lr</span><span class="op" id="3378413">.</span><span class="ident" id="3378414">N</span><span class="op" id="3378415">,</span>&nbsp;<span class="ident" id="3378417">lr</span><span class="op" id="3378419">.</span><span class="ident" id="3378420">R</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378424">if</span>&nbsp;<span class="ident" id="3378427">remain</span>&nbsp;<span class="op" id="3378434">&lt;=</span>&nbsp;<span class="num" id="3378437">0</span>&nbsp;<span class="op" id="3378439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378444">return</span>&nbsp;<span class="num" id="3378451">0</span><span class="op" id="3378452">,</span>&nbsp;<span class="ident" id="3378454">nil</span><span class="op" id="3378457">,</span>&nbsp;<span class="builtintype" id="3378459">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378472">f</span><span class="op" id="3378473">,</span>&nbsp;<span class="ident" id="3378475">ok</span>&nbsp;<span class="op" id="3378478">:=</span>&nbsp;<span class="ident" id="3378481">r</span><span class="op" id="3378482">.</span><span class="op" id="3378483">(</span><span class="op" id="3378484">*</span><span class="ident" id="3378485">os</span><span class="op" id="3378487">.</span><span class="ident" id="3378488">File</span><span class="op" id="3378492">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378495">if</span>&nbsp;<span class="op" id="3378498">!</span><span class="ident" id="3378499">ok</span>&nbsp;<span class="op" id="3378502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378506">return</span>&nbsp;<span class="num" id="3378513">0</span><span class="op" id="3378514">,</span>&nbsp;<span class="ident" id="3378516">nil</span><span class="op" id="3378519">,</span>&nbsp;<span class="builtintype" id="3378521">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378532">if</span>&nbsp;<span class="ident" id="3378535">err</span>&nbsp;<span class="op" id="3378539">:=</span>&nbsp;<span class="ident" id="3378542">c</span><span class="op" id="3378543">.</span><span class="ident" id="3378544">writeLock</span><span class="op" id="3378553">(</span><span class="op" id="3378554">)</span><span class="op" id="3378555">;</span>&nbsp;<span class="ident" id="3378557">err</span>&nbsp;<span class="op" id="3378561">!=</span>&nbsp;<span class="ident" id="3378564">nil</span>&nbsp;<span class="op" id="3378568">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378572">return</span>&nbsp;<span class="num" id="3378579">0</span><span class="op" id="3378580">,</span>&nbsp;<span class="ident" id="3378582">err</span><span class="op" id="3378585">,</span>&nbsp;<span class="builtintype" id="3378587">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378596">defer</span>&nbsp;<span class="ident" id="3378602">c</span><span class="op" id="3378603">.</span><span class="ident" id="3378604">writeUnlock</span><span class="op" id="3378615">(</span><span class="op" id="3378616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378620">dst</span>&nbsp;<span class="op" id="3378624">:=</span>&nbsp;<span class="ident" id="3378627">c</span><span class="op" id="3378628">.</span><span class="ident" id="3378629">sysfd</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378636">src</span>&nbsp;<span class="op" id="3378640">:=</span>&nbsp;<span class="builtintype" id="3378643">int</span><span class="op" id="3378646">(</span><span class="ident" id="3378647">f</span><span class="op" id="3378648">.</span><span class="ident" id="3378649">Fd</span><span class="op" id="3378651">(</span><span class="op" id="3378652">)</span><span class="op" id="3378653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378656">for</span>&nbsp;<span class="ident" id="3378660">remain</span>&nbsp;<span class="op" id="3378667">&gt;</span>&nbsp;<span class="num" id="3378669">0</span>&nbsp;<span class="op" id="3378671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378675">n</span>&nbsp;<span class="op" id="3378677">:=</span>&nbsp;<span class="ident" id="3378680">maxSendfileSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378698">if</span>&nbsp;<span class="ident" id="3378701">int64</span><span class="op" id="3378706">(</span><span class="ident" id="3378707">n</span><span class="op" id="3378708">)</span>&nbsp;<span class="op" id="3378710">&gt;</span>&nbsp;<span class="ident" id="3378712">remain</span>&nbsp;<span class="op" id="3378719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378724">n</span>&nbsp;<span class="op" id="3378726">=</span>&nbsp;<span class="builtintype" id="3378728">int</span><span class="op" id="3378731">(</span><span class="ident" id="3378732">remain</span><span class="op" id="3378738">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378746">n</span><span class="op" id="3378747">,</span>&nbsp;<span class="ident" id="3378749">err1</span>&nbsp;<span class="op" id="3378754">:=</span>&nbsp;<span class="ident" id="3378757">syscall</span><span class="op" id="3378764">.</span><span class="ident" id="3378765">Sendfile</span><span class="op" id="3378773">(</span><span class="ident" id="3378774">dst</span><span class="op" id="3378777">,</span>&nbsp;<span class="ident" id="3378779">src</span><span class="op" id="3378782">,</span>&nbsp;<span class="ident" id="3378784">nil</span><span class="op" id="3378787">,</span>&nbsp;<span class="ident" id="3378789">n</span><span class="op" id="3378790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378794">if</span>&nbsp;<span class="ident" id="3378797">n</span>&nbsp;<span class="op" id="3378799">&gt;</span>&nbsp;<span class="num" id="3378801">0</span>&nbsp;<span class="op" id="3378803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378808">written</span>&nbsp;<span class="op" id="3378816">+=</span>&nbsp;<span class="ident" id="3378819">int64</span><span class="op" id="3378824">(</span><span class="ident" id="3378825">n</span><span class="op" id="3378826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3378831">remain</span>&nbsp;<span class="op" id="3378838">-=</span>&nbsp;<span class="ident" id="3378841">int64</span><span class="op" id="3378846">(</span><span class="ident" id="3378847">n</span><span class="op" id="3378848">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378856">if</span>&nbsp;<span class="ident" id="3378859">n</span>&nbsp;<span class="op" id="3378861">==</span>&nbsp;<span class="num" id="3378864">0</span>&nbsp;<span class="op" id="3378866">&amp;&amp;</span>&nbsp;<span class="ident" id="3378869">err1</span>&nbsp;<span class="op" id="3378874">==</span>&nbsp;<span class="ident" id="3378877">nil</span>&nbsp;<span class="op" id="3378881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378898">if</span>&nbsp;<span class="ident" id="3378901">err1</span>&nbsp;<span class="op" id="3378906">==</span>&nbsp;<span class="ident" id="3378909">syscall</span><span class="op" id="3378916">.</span><span class="ident" id="3378917">EAGAIN</span>&nbsp;<span class="op" id="3378924">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378929">if</span>&nbsp;<span class="ident" id="3378932">err1</span>&nbsp;<span class="op" id="3378937">=</span>&nbsp;<span class="ident" id="3378939">c</span><span class="op" id="3378940">.</span><span class="ident" id="3378941">pd</span><span class="op" id="3378943">.</span><span class="ident" id="3378944">WaitWrite</span><span class="op" id="3378953">(</span><span class="op" id="3378954">)</span><span class="op" id="3378955">;</span>&nbsp;<span class="ident" id="3378957">err1</span>&nbsp;<span class="op" id="3378962">==</span>&nbsp;<span class="ident" id="3378965">nil</span>&nbsp;<span class="op" id="3378969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378975">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3378991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3378995">if</span>&nbsp;<span class="ident" id="3378998">err1</span>&nbsp;<span class="op" id="3379003">!=</span>&nbsp;<span class="ident" id="3379006">nil</span>&nbsp;<span class="op" id="3379010">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379015">//&nbsp;This&nbsp;includes&nbsp;syscall.ENOSYS&nbsp;(no&nbsp;kernel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379061">//&nbsp;support)&nbsp;and&nbsp;syscall.EINVAL&nbsp;(fd&nbsp;types&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3379111">//&nbsp;don&#39;t&nbsp;implement&nbsp;sendfile&nbsp;together)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379152">err</span>&nbsp;<span class="op" id="3379156">=</span>&nbsp;<span class="op" id="3379158">&amp;</span><span class="ident" id="3379159">OpError</span><span class="op" id="3379166">{</span><span class="string" id="3379167">&#34;sendfile&#34;</span><span class="op" id="3379177">,</span>&nbsp;<span class="ident" id="3379179">c</span><span class="op" id="3379180">.</span><span class="ident" id="3379181">net</span><span class="op" id="3379184">,</span>&nbsp;<span class="ident" id="3379186">c</span><span class="op" id="3379187">.</span><span class="ident" id="3379188">raddr</span><span class="op" id="3379193">,</span>&nbsp;<span class="ident" id="3379195">err1</span><span class="op" id="3379199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379204">break</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379218">if</span>&nbsp;<span class="ident" id="3379221">lr</span>&nbsp;<span class="op" id="3379224">!=</span>&nbsp;<span class="ident" id="3379227">nil</span>&nbsp;<span class="op" id="3379231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3379235">lr</span><span class="op" id="3379237">.</span><span class="ident" id="3379238">N</span>&nbsp;<span class="op" id="3379240">=</span>&nbsp;<span class="ident" id="3379242">remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3379250">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3379253">return</span>&nbsp;<span class="ident" id="3379260">written</span><span class="op" id="3379267">,</span>&nbsp;<span class="ident" id="3379269">err</span><span class="op" id="3379272">,</span>&nbsp;<span class="ident" id="3379274">written</span>&nbsp;<span class="op" id="3379282">&gt;</span>&nbsp;<span class="num" id="3379284">0</span><br>
<span class="lineno"></span><span class="op" id="3379286">}</span>
</div>
</body>
</html>
