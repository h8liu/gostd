<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/debug</h2>
<ul>
<li><a href="/gostd/runtime/debug/garbage.go.html">garbage.go</a></li>
<li><a href="/gostd/runtime/debug/garbage_test.go.html">garbage_test.go</a></li>
<li><a href="/gostd/runtime/debug/heapdump_test.go.html">heapdump_test.go</a></li>
<li><a href="/gostd/runtime/debug/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/debug/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/debug/stubs.go.html">stubs.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7765910">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7765966">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7766020">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7766071">package</span>&nbsp;<span class="ident" id="7766079">debug</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7766086">import</span>&nbsp;<span class="op" id="7766093">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7766096">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7766107">&#34;testing&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7766118">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7766125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7766128">func</span>&nbsp;<span class="ident" id="7766133">TestReadGCStats</span><span class="op" id="7766148">(</span><span class="ident" id="7766149">t</span>&nbsp;<span class="op" id="7766151">*</span><span class="ident" id="7766152">testing</span><span class="op" id="7766159">.</span><span class="ident" id="7766160">T</span><span class="op" id="7766161">)</span>&nbsp;<span class="op" id="7766163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766166">defer</span>&nbsp;<span class="ident" id="7766172">SetGCPercent</span><span class="op" id="7766184">(</span><span class="ident" id="7766185">SetGCPercent</span><span class="op" id="7766197">(</span><span class="op" id="7766198">-</span><span class="num" id="7766199">1</span><span class="op" id="7766200">)</span><span class="op" id="7766201">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766205">var</span>&nbsp;<span class="ident" id="7766209">stats</span>&nbsp;<span class="ident" id="7766215">GCStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766224">var</span>&nbsp;<span class="ident" id="7766228">mstats</span>&nbsp;<span class="ident" id="7766235">runtime</span><span class="op" id="7766242">.</span><span class="ident" id="7766243">MemStats</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766253">var</span>&nbsp;<span class="ident" id="7766257">min</span><span class="op" id="7766260">,</span>&nbsp;<span class="ident" id="7766262">max</span>&nbsp;<span class="ident" id="7766266">time</span><span class="op" id="7766270">.</span><span class="ident" id="7766271">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7766282">//&nbsp;First&nbsp;ReadGCStats&nbsp;will&nbsp;allocate,&nbsp;second&nbsp;should&nbsp;not,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7766338">//&nbsp;especially&nbsp;if&nbsp;we&nbsp;follow&nbsp;up&nbsp;with&nbsp;an&nbsp;explicit&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766406">stats</span><span class="op" id="7766411">.</span><span class="ident" id="7766412">PauseQuantiles</span>&nbsp;<span class="op" id="7766427">=</span>&nbsp;<span class="builtinfunc" id="7766429">make</span><span class="op" id="7766433">(</span><span class="op" id="7766434">[</span><span class="op" id="7766435">]</span><span class="ident" id="7766436">time</span><span class="op" id="7766440">.</span><span class="ident" id="7766441">Duration</span><span class="op" id="7766449">,</span>&nbsp;<span class="num" id="7766451">10</span><span class="op" id="7766453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766456">ReadGCStats</span><span class="op" id="7766467">(</span><span class="op" id="7766468">&amp;</span><span class="ident" id="7766469">stats</span><span class="op" id="7766474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766477">runtime</span><span class="op" id="7766484">.</span><span class="ident" id="7766485">GC</span><span class="op" id="7766487">(</span><span class="op" id="7766488">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7766492">//&nbsp;Assume&nbsp;these&nbsp;will&nbsp;return&nbsp;same&nbsp;data:&nbsp;no&nbsp;GC&nbsp;during&nbsp;ReadGCStats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766558">ReadGCStats</span><span class="op" id="7766569">(</span><span class="op" id="7766570">&amp;</span><span class="ident" id="7766571">stats</span><span class="op" id="7766576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766579">runtime</span><span class="op" id="7766586">.</span><span class="ident" id="7766587">ReadMemStats</span><span class="op" id="7766599">(</span><span class="op" id="7766600">&amp;</span><span class="ident" id="7766601">mstats</span><span class="op" id="7766607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766611">if</span>&nbsp;<span class="ident" id="7766614">stats</span><span class="op" id="7766619">.</span><span class="ident" id="7766620">NumGC</span>&nbsp;<span class="op" id="7766626">!=</span>&nbsp;<span class="ident" id="7766629">int64</span><span class="op" id="7766634">(</span><span class="ident" id="7766635">mstats</span><span class="op" id="7766641">.</span><span class="ident" id="7766642">NumGC</span><span class="op" id="7766647">)</span>&nbsp;<span class="op" id="7766649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766653">t</span><span class="op" id="7766654">.</span><span class="ident" id="7766655">Errorf</span><span class="op" id="7766661">(</span><span class="string" id="7766662">&#34;stats.NumGC&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.NumGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7766703">,</span>&nbsp;<span class="ident" id="7766705">stats</span><span class="op" id="7766710">.</span><span class="ident" id="7766711">NumGC</span><span class="op" id="7766716">,</span>&nbsp;<span class="ident" id="7766718">mstats</span><span class="op" id="7766724">.</span><span class="ident" id="7766725">NumGC</span><span class="op" id="7766730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7766733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766736">if</span>&nbsp;<span class="ident" id="7766739">stats</span><span class="op" id="7766744">.</span><span class="ident" id="7766745">PauseTotal</span>&nbsp;<span class="op" id="7766756">!=</span>&nbsp;<span class="ident" id="7766759">time</span><span class="op" id="7766763">.</span><span class="ident" id="7766764">Duration</span><span class="op" id="7766772">(</span><span class="ident" id="7766773">mstats</span><span class="op" id="7766779">.</span><span class="ident" id="7766780">PauseTotalNs</span><span class="op" id="7766792">)</span>&nbsp;<span class="op" id="7766794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766798">t</span><span class="op" id="7766799">.</span><span class="ident" id="7766800">Errorf</span><span class="op" id="7766806">(</span><span class="string" id="7766807">&#34;stats.PauseTotal&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.PauseTotalNs&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7766860">,</span>&nbsp;<span class="ident" id="7766862">stats</span><span class="op" id="7766867">.</span><span class="ident" id="7766868">PauseTotal</span><span class="op" id="7766878">,</span>&nbsp;<span class="ident" id="7766880">mstats</span><span class="op" id="7766886">.</span><span class="ident" id="7766887">PauseTotalNs</span><span class="op" id="7766899">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7766902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7766905">if</span>&nbsp;<span class="ident" id="7766908">stats</span><span class="op" id="7766913">.</span><span class="ident" id="7766914">LastGC</span><span class="op" id="7766920">.</span><span class="ident" id="7766921">UnixNano</span><span class="op" id="7766929">(</span><span class="op" id="7766930">)</span>&nbsp;<span class="op" id="7766932">!=</span>&nbsp;<span class="ident" id="7766935">int64</span><span class="op" id="7766940">(</span><span class="ident" id="7766941">mstats</span><span class="op" id="7766947">.</span><span class="ident" id="7766948">LastGC</span><span class="op" id="7766954">)</span>&nbsp;<span class="op" id="7766956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7766960">t</span><span class="op" id="7766961">.</span><span class="ident" id="7766962">Errorf</span><span class="op" id="7766968">(</span><span class="string" id="7766969">&#34;stats.LastGC.UnixNano&nbsp;=&nbsp;%d,&nbsp;but&nbsp;mstats.LastGC&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7767021">,</span>&nbsp;<span class="ident" id="7767023">stats</span><span class="op" id="7767028">.</span><span class="ident" id="7767029">LastGC</span><span class="op" id="7767035">.</span><span class="ident" id="7767036">UnixNano</span><span class="op" id="7767044">(</span><span class="op" id="7767045">)</span><span class="op" id="7767046">,</span>&nbsp;<span class="ident" id="7767048">mstats</span><span class="op" id="7767054">.</span><span class="ident" id="7767055">LastGC</span><span class="op" id="7767061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767067">n</span>&nbsp;<span class="op" id="7767069">:=</span>&nbsp;<span class="builtintype" id="7767072">int</span><span class="op" id="7767075">(</span><span class="ident" id="7767076">mstats</span><span class="op" id="7767082">.</span><span class="ident" id="7767083">NumGC</span><span class="op" id="7767088">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767091">if</span>&nbsp;<span class="ident" id="7767094">n</span>&nbsp;<span class="op" id="7767096">&gt;</span>&nbsp;<span class="builtinfunc" id="7767098">len</span><span class="op" id="7767101">(</span><span class="ident" id="7767102">mstats</span><span class="op" id="7767108">.</span><span class="ident" id="7767109">PauseNs</span><span class="op" id="7767116">)</span>&nbsp;<span class="op" id="7767118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767122">n</span>&nbsp;<span class="op" id="7767124">=</span>&nbsp;<span class="builtinfunc" id="7767126">len</span><span class="op" id="7767129">(</span><span class="ident" id="7767130">mstats</span><span class="op" id="7767136">.</span><span class="ident" id="7767137">PauseNs</span><span class="op" id="7767144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767150">if</span>&nbsp;<span class="builtinfunc" id="7767153">len</span><span class="op" id="7767156">(</span><span class="ident" id="7767157">stats</span><span class="op" id="7767162">.</span><span class="ident" id="7767163">Pause</span><span class="op" id="7767168">)</span>&nbsp;<span class="op" id="7767170">!=</span>&nbsp;<span class="ident" id="7767173">n</span>&nbsp;<span class="op" id="7767175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767179">t</span><span class="op" id="7767180">.</span><span class="ident" id="7767181">Errorf</span><span class="op" id="7767187">(</span><span class="string" id="7767188">&#34;len(stats.Pause)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7767220">,</span>&nbsp;<span class="builtinfunc" id="7767222">len</span><span class="op" id="7767225">(</span><span class="ident" id="7767226">stats</span><span class="op" id="7767231">.</span><span class="ident" id="7767232">Pause</span><span class="op" id="7767237">)</span><span class="op" id="7767238">,</span>&nbsp;<span class="ident" id="7767240">n</span><span class="op" id="7767241">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767244">}</span>&nbsp;<span class="keyword" id="7767246">else</span>&nbsp;<span class="op" id="7767251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767255">off</span>&nbsp;<span class="op" id="7767259">:=</span>&nbsp;<span class="op" id="7767262">(</span><span class="builtintype" id="7767263">int</span><span class="op" id="7767266">(</span><span class="ident" id="7767267">mstats</span><span class="op" id="7767273">.</span><span class="ident" id="7767274">NumGC</span><span class="op" id="7767279">)</span>&nbsp;<span class="op" id="7767281">+</span>&nbsp;<span class="builtinfunc" id="7767283">len</span><span class="op" id="7767286">(</span><span class="ident" id="7767287">mstats</span><span class="op" id="7767293">.</span><span class="ident" id="7767294">PauseNs</span><span class="op" id="7767301">)</span>&nbsp;<span class="op" id="7767303">-</span>&nbsp;<span class="num" id="7767305">1</span><span class="op" id="7767306">)</span>&nbsp;<span class="op" id="7767308">%</span>&nbsp;<span class="builtinfunc" id="7767310">len</span><span class="op" id="7767313">(</span><span class="ident" id="7767314">mstats</span><span class="op" id="7767320">.</span><span class="ident" id="7767321">PauseNs</span><span class="op" id="7767328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767332">for</span>&nbsp;<span class="ident" id="7767336">i</span>&nbsp;<span class="op" id="7767338">:=</span>&nbsp;<span class="num" id="7767341">0</span><span class="op" id="7767342">;</span>&nbsp;<span class="ident" id="7767344">i</span>&nbsp;<span class="op" id="7767346">&lt;</span>&nbsp;<span class="ident" id="7767348">n</span><span class="op" id="7767349">;</span>&nbsp;<span class="ident" id="7767351">i</span><span class="op" id="7767352">++</span>&nbsp;<span class="op" id="7767355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767360">dt</span>&nbsp;<span class="op" id="7767363">:=</span>&nbsp;<span class="ident" id="7767366">stats</span><span class="op" id="7767371">.</span><span class="ident" id="7767372">Pause</span><span class="op" id="7767377">[</span><span class="ident" id="7767378">i</span><span class="op" id="7767379">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767384">if</span>&nbsp;<span class="ident" id="7767387">dt</span>&nbsp;<span class="op" id="7767390">!=</span>&nbsp;<span class="ident" id="7767393">time</span><span class="op" id="7767397">.</span><span class="ident" id="7767398">Duration</span><span class="op" id="7767406">(</span><span class="ident" id="7767407">mstats</span><span class="op" id="7767413">.</span><span class="ident" id="7767414">PauseNs</span><span class="op" id="7767421">[</span><span class="ident" id="7767422">off</span><span class="op" id="7767425">]</span><span class="op" id="7767426">)</span>&nbsp;<span class="op" id="7767428">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767434">t</span><span class="op" id="7767435">.</span><span class="ident" id="7767436">Errorf</span><span class="op" id="7767442">(</span><span class="string" id="7767443">&#34;stats.Pause[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7767474">,</span>&nbsp;<span class="ident" id="7767476">i</span><span class="op" id="7767477">,</span>&nbsp;<span class="ident" id="7767479">dt</span><span class="op" id="7767481">,</span>&nbsp;<span class="ident" id="7767483">mstats</span><span class="op" id="7767489">.</span><span class="ident" id="7767490">PauseNs</span><span class="op" id="7767497">[</span><span class="ident" id="7767498">off</span><span class="op" id="7767501">]</span><span class="op" id="7767502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767512">if</span>&nbsp;<span class="ident" id="7767515">max</span>&nbsp;<span class="op" id="7767519">&lt;</span>&nbsp;<span class="ident" id="7767521">dt</span>&nbsp;<span class="op" id="7767524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767530">max</span>&nbsp;<span class="op" id="7767534">=</span>&nbsp;<span class="ident" id="7767536">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767542">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767547">if</span>&nbsp;<span class="ident" id="7767550">min</span>&nbsp;<span class="op" id="7767554">&gt;</span>&nbsp;<span class="ident" id="7767556">dt</span>&nbsp;<span class="op" id="7767559">||</span>&nbsp;<span class="ident" id="7767562">i</span>&nbsp;<span class="op" id="7767564">==</span>&nbsp;<span class="num" id="7767567">0</span>&nbsp;<span class="op" id="7767569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767575">min</span>&nbsp;<span class="op" id="7767579">=</span>&nbsp;<span class="ident" id="7767581">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767592">off</span>&nbsp;<span class="op" id="7767596">=</span>&nbsp;<span class="op" id="7767598">(</span><span class="ident" id="7767599">off</span>&nbsp;<span class="op" id="7767603">+</span>&nbsp;<span class="builtinfunc" id="7767605">len</span><span class="op" id="7767608">(</span><span class="ident" id="7767609">mstats</span><span class="op" id="7767615">.</span><span class="ident" id="7767616">PauseNs</span><span class="op" id="7767623">)</span>&nbsp;<span class="op" id="7767625">-</span>&nbsp;<span class="num" id="7767627">1</span><span class="op" id="7767628">)</span>&nbsp;<span class="op" id="7767630">%</span>&nbsp;<span class="builtinfunc" id="7767632">len</span><span class="op" id="7767635">(</span><span class="ident" id="7767636">mstats</span><span class="op" id="7767642">.</span><span class="ident" id="7767643">PauseNs</span><span class="op" id="7767650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767654">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767661">q</span>&nbsp;<span class="op" id="7767663">:=</span>&nbsp;<span class="ident" id="7767666">stats</span><span class="op" id="7767671">.</span><span class="ident" id="7767672">PauseQuantiles</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767688">nq</span>&nbsp;<span class="op" id="7767691">:=</span>&nbsp;<span class="builtinfunc" id="7767694">len</span><span class="op" id="7767697">(</span><span class="ident" id="7767698">q</span><span class="op" id="7767699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767702">if</span>&nbsp;<span class="ident" id="7767705">q</span><span class="op" id="7767706">[</span><span class="num" id="7767707">0</span><span class="op" id="7767708">]</span>&nbsp;<span class="op" id="7767710">!=</span>&nbsp;<span class="ident" id="7767713">min</span>&nbsp;<span class="op" id="7767717">||</span>&nbsp;<span class="ident" id="7767720">q</span><span class="op" id="7767721">[</span><span class="ident" id="7767722">nq</span><span class="op" id="7767724">-</span><span class="num" id="7767725">1</span><span class="op" id="7767726">]</span>&nbsp;<span class="op" id="7767728">!=</span>&nbsp;<span class="ident" id="7767731">max</span>&nbsp;<span class="op" id="7767735">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767739">t</span><span class="op" id="7767740">.</span><span class="ident" id="7767741">Errorf</span><span class="op" id="7767747">(</span><span class="string" id="7767748">&#34;stats.PauseQuantiles&nbsp;=&nbsp;[%d,&nbsp;...,&nbsp;%d],&nbsp;want&nbsp;[%d,&nbsp;...,&nbsp;%d]&#34;</span><span class="op" id="7767806">,</span>&nbsp;<span class="ident" id="7767808">q</span><span class="op" id="7767809">[</span><span class="num" id="7767810">0</span><span class="op" id="7767811">]</span><span class="op" id="7767812">,</span>&nbsp;<span class="ident" id="7767814">q</span><span class="op" id="7767815">[</span><span class="ident" id="7767816">nq</span><span class="op" id="7767818">-</span><span class="num" id="7767819">1</span><span class="op" id="7767820">]</span><span class="op" id="7767821">,</span>&nbsp;<span class="ident" id="7767823">min</span><span class="op" id="7767826">,</span>&nbsp;<span class="ident" id="7767828">max</span><span class="op" id="7767831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767838">for</span>&nbsp;<span class="ident" id="7767842">i</span>&nbsp;<span class="op" id="7767844">:=</span>&nbsp;<span class="num" id="7767847">0</span><span class="op" id="7767848">;</span>&nbsp;<span class="ident" id="7767850">i</span>&nbsp;<span class="op" id="7767852">&lt;</span>&nbsp;<span class="ident" id="7767854">nq</span><span class="op" id="7767856">-</span><span class="num" id="7767857">1</span><span class="op" id="7767858">;</span>&nbsp;<span class="ident" id="7767860">i</span><span class="op" id="7767861">++</span>&nbsp;<span class="op" id="7767864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7767868">if</span>&nbsp;<span class="ident" id="7767871">q</span><span class="op" id="7767872">[</span><span class="ident" id="7767873">i</span><span class="op" id="7767874">]</span>&nbsp;<span class="op" id="7767876">&gt;</span>&nbsp;<span class="ident" id="7767878">q</span><span class="op" id="7767879">[</span><span class="ident" id="7767880">i</span><span class="op" id="7767881">+</span><span class="num" id="7767882">1</span><span class="op" id="7767883">]</span>&nbsp;<span class="op" id="7767885">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7767890">t</span><span class="op" id="7767891">.</span><span class="ident" id="7767892">Errorf</span><span class="op" id="7767898">(</span><span class="string" id="7767899">&#34;stats.PauseQuantiles[%d]=%d&nbsp;&gt;&nbsp;stats.PauseQuantiles[%d]=%d&#34;</span><span class="op" id="7767958">,</span>&nbsp;<span class="ident" id="7767960">i</span><span class="op" id="7767961">,</span>&nbsp;<span class="ident" id="7767963">q</span><span class="op" id="7767964">[</span><span class="ident" id="7767965">i</span><span class="op" id="7767966">]</span><span class="op" id="7767967">,</span>&nbsp;<span class="ident" id="7767969">i</span><span class="op" id="7767970">+</span><span class="num" id="7767971">1</span><span class="op" id="7767972">,</span>&nbsp;<span class="ident" id="7767974">q</span><span class="op" id="7767975">[</span><span class="ident" id="7767976">i</span><span class="op" id="7767977">+</span><span class="num" id="7767978">1</span><span class="op" id="7767979">]</span><span class="op" id="7767980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7767987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7767991">//&nbsp;compare&nbsp;memory&nbsp;stats&nbsp;with&nbsp;gc&nbsp;stats:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768031">if</span>&nbsp;<span class="builtinfunc" id="7768034">len</span><span class="op" id="7768037">(</span><span class="ident" id="7768038">stats</span><span class="op" id="7768043">.</span><span class="ident" id="7768044">PauseEnd</span><span class="op" id="7768052">)</span>&nbsp;<span class="op" id="7768054">!=</span>&nbsp;<span class="ident" id="7768057">n</span>&nbsp;<span class="op" id="7768059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768063">t</span><span class="op" id="7768064">.</span><span class="ident" id="7768065">Fatalf</span><span class="op" id="7768071">(</span><span class="string" id="7768072">&#34;len(stats.PauseEnd)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7768107">,</span>&nbsp;<span class="builtinfunc" id="7768109">len</span><span class="op" id="7768112">(</span><span class="ident" id="7768113">stats</span><span class="op" id="7768118">.</span><span class="ident" id="7768119">PauseEnd</span><span class="op" id="7768127">)</span><span class="op" id="7768128">,</span>&nbsp;<span class="ident" id="7768130">n</span><span class="op" id="7768131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7768134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768137">off</span>&nbsp;<span class="op" id="7768141">:=</span>&nbsp;<span class="op" id="7768144">(</span><span class="builtintype" id="7768145">int</span><span class="op" id="7768148">(</span><span class="ident" id="7768149">mstats</span><span class="op" id="7768155">.</span><span class="ident" id="7768156">NumGC</span><span class="op" id="7768161">)</span>&nbsp;<span class="op" id="7768163">+</span>&nbsp;<span class="builtinfunc" id="7768165">len</span><span class="op" id="7768168">(</span><span class="ident" id="7768169">mstats</span><span class="op" id="7768175">.</span><span class="ident" id="7768176">PauseEnd</span><span class="op" id="7768184">)</span>&nbsp;<span class="op" id="7768186">-</span>&nbsp;<span class="num" id="7768188">1</span><span class="op" id="7768189">)</span>&nbsp;<span class="op" id="7768191">%</span>&nbsp;<span class="builtinfunc" id="7768193">len</span><span class="op" id="7768196">(</span><span class="ident" id="7768197">mstats</span><span class="op" id="7768203">.</span><span class="ident" id="7768204">PauseEnd</span><span class="op" id="7768212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768215">for</span>&nbsp;<span class="ident" id="7768219">i</span>&nbsp;<span class="op" id="7768221">:=</span>&nbsp;<span class="num" id="7768224">0</span><span class="op" id="7768225">;</span>&nbsp;<span class="ident" id="7768227">i</span>&nbsp;<span class="op" id="7768229">&lt;</span>&nbsp;<span class="ident" id="7768231">n</span><span class="op" id="7768232">;</span>&nbsp;<span class="ident" id="7768234">i</span><span class="op" id="7768235">++</span>&nbsp;<span class="op" id="7768238">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768242">dt</span>&nbsp;<span class="op" id="7768245">:=</span>&nbsp;<span class="ident" id="7768248">stats</span><span class="op" id="7768253">.</span><span class="ident" id="7768254">PauseEnd</span><span class="op" id="7768262">[</span><span class="ident" id="7768263">i</span><span class="op" id="7768264">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768268">if</span>&nbsp;<span class="ident" id="7768271">dt</span><span class="op" id="7768273">.</span><span class="ident" id="7768274">UnixNano</span><span class="op" id="7768282">(</span><span class="op" id="7768283">)</span>&nbsp;<span class="op" id="7768285">!=</span>&nbsp;<span class="ident" id="7768288">int64</span><span class="op" id="7768293">(</span><span class="ident" id="7768294">mstats</span><span class="op" id="7768300">.</span><span class="ident" id="7768301">PauseEnd</span><span class="op" id="7768309">[</span><span class="ident" id="7768310">off</span><span class="op" id="7768313">]</span><span class="op" id="7768314">)</span>&nbsp;<span class="op" id="7768316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768321">t</span><span class="op" id="7768322">.</span><span class="ident" id="7768323">Errorf</span><span class="op" id="7768329">(</span><span class="string" id="7768330">&#34;stats.PauseEnd[%d]&nbsp;=&nbsp;%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7768364">,</span>&nbsp;<span class="ident" id="7768366">i</span><span class="op" id="7768367">,</span>&nbsp;<span class="ident" id="7768369">dt</span><span class="op" id="7768371">,</span>&nbsp;<span class="ident" id="7768373">mstats</span><span class="op" id="7768379">.</span><span class="ident" id="7768380">PauseEnd</span><span class="op" id="7768388">[</span><span class="ident" id="7768389">off</span><span class="op" id="7768392">]</span><span class="op" id="7768393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7768397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768401">off</span>&nbsp;<span class="op" id="7768405">=</span>&nbsp;<span class="op" id="7768407">(</span><span class="ident" id="7768408">off</span>&nbsp;<span class="op" id="7768412">+</span>&nbsp;<span class="builtinfunc" id="7768414">len</span><span class="op" id="7768417">(</span><span class="ident" id="7768418">mstats</span><span class="op" id="7768424">.</span><span class="ident" id="7768425">PauseEnd</span><span class="op" id="7768433">)</span>&nbsp;<span class="op" id="7768435">-</span>&nbsp;<span class="num" id="7768437">1</span><span class="op" id="7768438">)</span>&nbsp;<span class="op" id="7768440">%</span>&nbsp;<span class="builtinfunc" id="7768442">len</span><span class="op" id="7768445">(</span><span class="ident" id="7768446">mstats</span><span class="op" id="7768452">.</span><span class="ident" id="7768453">PauseEnd</span><span class="op" id="7768461">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7768464">}</span><br>
<span class="lineno"></span><span class="op" id="7768466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7768469">var</span>&nbsp;<span class="ident" id="7768473">big</span>&nbsp;<span class="op" id="7768477">=</span>&nbsp;<span class="builtinfunc" id="7768479">make</span><span class="op" id="7768483">(</span><span class="op" id="7768484">[</span><span class="op" id="7768485">]</span><span class="builtintype" id="7768486">byte</span><span class="op" id="7768490">,</span>&nbsp;<span class="num" id="7768492">1</span><span class="op" id="7768493">&lt;&lt;</span><span class="num" id="7768495">20</span><span class="op" id="7768497">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="7768500">func</span>&nbsp;<span class="ident" id="7768505">TestFreeOSMemory</span><span class="op" id="7768521">(</span><span class="ident" id="7768522">t</span>&nbsp;<span class="op" id="7768524">*</span><span class="ident" id="7768525">testing</span><span class="op" id="7768532">.</span><span class="ident" id="7768533">T</span><span class="op" id="7768534">)</span>&nbsp;<span class="op" id="7768536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768539">var</span>&nbsp;<span class="ident" id="7768543">ms1</span><span class="op" id="7768546">,</span>&nbsp;<span class="ident" id="7768548">ms2</span>&nbsp;<span class="ident" id="7768552">runtime</span><span class="op" id="7768559">.</span><span class="ident" id="7768560">MemStats</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768571">if</span>&nbsp;<span class="ident" id="7768574">big</span>&nbsp;<span class="op" id="7768578">==</span>&nbsp;<span class="ident" id="7768581">nil</span>&nbsp;<span class="op" id="7768585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768589">t</span><span class="op" id="7768590">.</span><span class="ident" id="7768591">Skip</span><span class="op" id="7768595">(</span><span class="string" id="7768596">&#34;test&nbsp;is&nbsp;not&nbsp;reliable&nbsp;when&nbsp;run&nbsp;multiple&nbsp;times&#34;</span><span class="op" id="7768642">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7768645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768648">big</span>&nbsp;<span class="op" id="7768652">=</span>&nbsp;<span class="ident" id="7768654">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768659">runtime</span><span class="op" id="7768666">.</span><span class="ident" id="7768667">GC</span><span class="op" id="7768669">(</span><span class="op" id="7768670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768673">runtime</span><span class="op" id="7768680">.</span><span class="ident" id="7768681">ReadMemStats</span><span class="op" id="7768693">(</span><span class="op" id="7768694">&amp;</span><span class="ident" id="7768695">ms1</span><span class="op" id="7768698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768701">FreeOSMemory</span><span class="op" id="7768713">(</span><span class="op" id="7768714">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768717">runtime</span><span class="op" id="7768724">.</span><span class="ident" id="7768725">ReadMemStats</span><span class="op" id="7768737">(</span><span class="op" id="7768738">&amp;</span><span class="ident" id="7768739">ms2</span><span class="op" id="7768742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7768745">if</span>&nbsp;<span class="ident" id="7768748">ms1</span><span class="op" id="7768751">.</span><span class="ident" id="7768752">HeapReleased</span>&nbsp;<span class="op" id="7768765">&gt;=</span>&nbsp;<span class="ident" id="7768768">ms2</span><span class="op" id="7768771">.</span><span class="ident" id="7768772">HeapReleased</span>&nbsp;<span class="op" id="7768785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7768789">t</span><span class="op" id="7768790">.</span><span class="ident" id="7768791">Errorf</span><span class="op" id="7768797">(</span><span class="string" id="7768798">&#34;released&nbsp;before=%d;&nbsp;released&nbsp;after=%d;&nbsp;did&nbsp;not&nbsp;go&nbsp;up&#34;</span><span class="op" id="7768852">,</span>&nbsp;<span class="ident" id="7768854">ms1</span><span class="op" id="7768857">.</span><span class="ident" id="7768858">HeapReleased</span><span class="op" id="7768870">,</span>&nbsp;<span class="ident" id="7768872">ms2</span><span class="op" id="7768875">.</span><span class="ident" id="7768876">HeapReleased</span><span class="op" id="7768888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7768891">}</span><br>
<span class="lineno"></span><span class="op" id="7768893">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="7768896">func</span>&nbsp;<span class="ident" id="7768901">TestSetGCPercent</span><span class="op" id="7768917">(</span><span class="ident" id="7768918">t</span>&nbsp;<span class="op" id="7768920">*</span><span class="ident" id="7768921">testing</span><span class="op" id="7768928">.</span><span class="ident" id="7768929">T</span><span class="op" id="7768930">)</span>&nbsp;<span class="op" id="7768932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7768935">//&nbsp;Test&nbsp;that&nbsp;the&nbsp;variable&nbsp;is&nbsp;being&nbsp;set&nbsp;and&nbsp;returned&nbsp;correctly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7768999">//&nbsp;Assume&nbsp;the&nbsp;percentage&nbsp;itself&nbsp;is&nbsp;implemented&nbsp;fine&nbsp;during&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7769063">//&nbsp;which&nbsp;is&nbsp;harder&nbsp;to&nbsp;test.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7769092">old</span>&nbsp;<span class="op" id="7769096">:=</span>&nbsp;<span class="ident" id="7769099">SetGCPercent</span><span class="op" id="7769111">(</span><span class="num" id="7769112">123</span><span class="op" id="7769115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7769118">new</span>&nbsp;<span class="op" id="7769122">:=</span>&nbsp;<span class="ident" id="7769125">SetGCPercent</span><span class="op" id="7769137">(</span><span class="ident" id="7769138">old</span><span class="op" id="7769141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7769144">if</span>&nbsp;<span class="builtinfunc" id="7769147">new</span>&nbsp;<span class="op" id="7769151">!=</span>&nbsp;<span class="num" id="7769154">123</span>&nbsp;<span class="op" id="7769158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7769162">t</span><span class="op" id="7769163">.</span><span class="ident" id="7769164">Errorf</span><span class="op" id="7769170">(</span><span class="string" id="7769171">&#34;SetGCPercent(123);&nbsp;SetGCPercent(x)&nbsp;=&nbsp;%d,&nbsp;want&nbsp;123&#34;</span><span class="op" id="7769222">,</span>&nbsp;<span class="builtinfunc" id="7769224">new</span><span class="op" id="7769227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7769230">}</span><br>
<span class="lineno">115</span><span class="op" id="7769232">}</span>
</div>
</body>
</html>
