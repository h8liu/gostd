<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7961158">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7961213">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7961267">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7961318">package</span>&nbsp;<span class="ident" id="7961326">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7961332">import</span>&nbsp;<span class="op" id="7961339">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961342">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961351">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961358">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961367">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961382">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961388">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961401">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961414">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961420">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961431">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7961441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7961444">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7961518">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7961596">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7961657">func</span>&nbsp;<span class="ident" id="7961662">TestDecodeProgressive</span><span class="op" id="7961683">(</span><span class="ident" id="7961684">t</span>&nbsp;<span class="op" id="7961686">*</span><span class="ident" id="7961687">testing</span><span class="op" id="7961694">.</span><span class="ident" id="7961695">T</span><span class="op" id="7961696">)</span>&nbsp;<span class="op" id="7961698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7961701">testCases</span>&nbsp;<span class="op" id="7961711">:=</span>&nbsp;<span class="op" id="7961714">[</span><span class="op" id="7961715">]</span><span class="builtintype" id="7961716">string</span><span class="op" id="7961722">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961726">&#34;../testdata/video-001&#34;</span><span class="op" id="7961749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961753">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7961784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961788">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7961819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961823">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7961854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961858">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7961889">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961893">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7961925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961929">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7961965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7961969">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7962016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962022">for</span>&nbsp;<span class="ident" id="7962026">_</span><span class="op" id="7962027">,</span>&nbsp;<span class="ident" id="7962029">tc</span>&nbsp;<span class="op" id="7962032">:=</span>&nbsp;<span class="keyword" id="7962035">range</span>&nbsp;<span class="ident" id="7962041">testCases</span>&nbsp;<span class="op" id="7962051">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962055">m0</span><span class="op" id="7962057">,</span>&nbsp;<span class="ident" id="7962059">err</span>&nbsp;<span class="op" id="7962063">:=</span>&nbsp;<span class="ident" id="7962066">decodeFile</span><span class="op" id="7962076">(</span><span class="ident" id="7962077">tc</span>&nbsp;<span class="op" id="7962080">+</span>&nbsp;<span class="string" id="7962082">&#34;.jpeg&#34;</span><span class="op" id="7962089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962093">if</span>&nbsp;<span class="ident" id="7962096">err</span>&nbsp;<span class="op" id="7962100">!=</span>&nbsp;<span class="ident" id="7962103">nil</span>&nbsp;<span class="op" id="7962107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962112">t</span><span class="op" id="7962113">.</span><span class="ident" id="7962114">Errorf</span><span class="op" id="7962120">(</span><span class="string" id="7962121">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7962129">,</span>&nbsp;<span class="ident" id="7962131">tc</span><span class="op" id="7962133">+</span><span class="string" id="7962134">&#34;.jpeg&#34;</span><span class="op" id="7962141">,</span>&nbsp;<span class="ident" id="7962143">err</span><span class="op" id="7962146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962151">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962162">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962166">m1</span><span class="op" id="7962168">,</span>&nbsp;<span class="ident" id="7962170">err</span>&nbsp;<span class="op" id="7962174">:=</span>&nbsp;<span class="ident" id="7962177">decodeFile</span><span class="op" id="7962187">(</span><span class="ident" id="7962188">tc</span>&nbsp;<span class="op" id="7962191">+</span>&nbsp;<span class="string" id="7962193">&#34;.progressive.jpeg&#34;</span><span class="op" id="7962212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962216">if</span>&nbsp;<span class="ident" id="7962219">err</span>&nbsp;<span class="op" id="7962223">!=</span>&nbsp;<span class="ident" id="7962226">nil</span>&nbsp;<span class="op" id="7962230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962235">t</span><span class="op" id="7962236">.</span><span class="ident" id="7962237">Errorf</span><span class="op" id="7962243">(</span><span class="string" id="7962244">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7962252">,</span>&nbsp;<span class="ident" id="7962254">tc</span><span class="op" id="7962256">+</span><span class="string" id="7962257">&#34;.progressive.jpeg&#34;</span><span class="op" id="7962276">,</span>&nbsp;<span class="ident" id="7962278">err</span><span class="op" id="7962281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962286">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962297">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962301">if</span>&nbsp;<span class="ident" id="7962304">m0</span><span class="op" id="7962306">.</span><span class="ident" id="7962307">Bounds</span><span class="op" id="7962313">(</span><span class="op" id="7962314">)</span>&nbsp;<span class="op" id="7962316">!=</span>&nbsp;<span class="ident" id="7962319">m1</span><span class="op" id="7962321">.</span><span class="ident" id="7962322">Bounds</span><span class="op" id="7962328">(</span><span class="op" id="7962329">)</span>&nbsp;<span class="op" id="7962331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962336">t</span><span class="op" id="7962337">.</span><span class="ident" id="7962338">Errorf</span><span class="op" id="7962344">(</span><span class="string" id="7962345">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7962375">,</span>&nbsp;<span class="ident" id="7962377">tc</span><span class="op" id="7962379">,</span>&nbsp;<span class="ident" id="7962381">m0</span><span class="op" id="7962383">.</span><span class="ident" id="7962384">Bounds</span><span class="op" id="7962390">(</span><span class="op" id="7962391">)</span><span class="op" id="7962392">,</span>&nbsp;<span class="ident" id="7962394">m1</span><span class="op" id="7962396">.</span><span class="ident" id="7962397">Bounds</span><span class="op" id="7962403">(</span><span class="op" id="7962404">)</span><span class="op" id="7962405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962410">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7962425">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962473">if</span>&nbsp;<span class="ident" id="7962476">m0</span><span class="op" id="7962478">.</span><span class="ident" id="7962479">Bounds</span><span class="op" id="7962485">(</span><span class="op" id="7962486">)</span>&nbsp;<span class="op" id="7962488">!=</span>&nbsp;<span class="ident" id="7962491">image</span><span class="op" id="7962496">.</span><span class="ident" id="7962497">Rect</span><span class="op" id="7962501">(</span><span class="num" id="7962502">0</span><span class="op" id="7962503">,</span>&nbsp;<span class="num" id="7962505">0</span><span class="op" id="7962506">,</span>&nbsp;<span class="num" id="7962508">150</span><span class="op" id="7962511">,</span>&nbsp;<span class="num" id="7962513">103</span><span class="op" id="7962516">)</span>&nbsp;<span class="op" id="7962518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962523">t</span><span class="op" id="7962524">.</span><span class="ident" id="7962525">Errorf</span><span class="op" id="7962531">(</span><span class="string" id="7962532">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7962552">,</span>&nbsp;<span class="ident" id="7962554">tc</span><span class="op" id="7962556">,</span>&nbsp;<span class="ident" id="7962558">m0</span><span class="op" id="7962560">.</span><span class="ident" id="7962561">Bounds</span><span class="op" id="7962567">(</span><span class="op" id="7962568">)</span><span class="op" id="7962569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962574">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962590">switch</span>&nbsp;<span class="ident" id="7962597">m0</span>&nbsp;<span class="op" id="7962600">:=</span>&nbsp;<span class="ident" id="7962603">m0</span><span class="op" id="7962605">.</span><span class="op" id="7962606">(</span><span class="keyword" id="7962607">type</span><span class="op" id="7962611">)</span>&nbsp;<span class="op" id="7962613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962617">case</span>&nbsp;<span class="op" id="7962622">*</span><span class="ident" id="7962623">image</span><span class="op" id="7962628">.</span><span class="ident" id="7962629">YCbCr</span><span class="op" id="7962634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962639">m1</span>&nbsp;<span class="op" id="7962642">:=</span>&nbsp;<span class="ident" id="7962645">m1</span><span class="op" id="7962647">.</span><span class="op" id="7962648">(</span><span class="op" id="7962649">*</span><span class="ident" id="7962650">image</span><span class="op" id="7962655">.</span><span class="ident" id="7962656">YCbCr</span><span class="op" id="7962661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962666">if</span>&nbsp;<span class="ident" id="7962669">err</span>&nbsp;<span class="op" id="7962673">:=</span>&nbsp;<span class="ident" id="7962676">check</span><span class="op" id="7962681">(</span><span class="ident" id="7962682">m0</span><span class="op" id="7962684">.</span><span class="ident" id="7962685">Bounds</span><span class="op" id="7962691">(</span><span class="op" id="7962692">)</span><span class="op" id="7962693">,</span>&nbsp;<span class="ident" id="7962695">m0</span><span class="op" id="7962697">.</span><span class="ident" id="7962698">Y</span><span class="op" id="7962699">,</span>&nbsp;<span class="ident" id="7962701">m1</span><span class="op" id="7962703">.</span><span class="ident" id="7962704">Y</span><span class="op" id="7962705">,</span>&nbsp;<span class="ident" id="7962707">m0</span><span class="op" id="7962709">.</span><span class="ident" id="7962710">YStride</span><span class="op" id="7962717">,</span>&nbsp;<span class="ident" id="7962719">m1</span><span class="op" id="7962721">.</span><span class="ident" id="7962722">YStride</span><span class="op" id="7962729">)</span><span class="op" id="7962730">;</span>&nbsp;<span class="ident" id="7962732">err</span>&nbsp;<span class="op" id="7962736">!=</span>&nbsp;<span class="ident" id="7962739">nil</span>&nbsp;<span class="op" id="7962743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962749">t</span><span class="op" id="7962750">.</span><span class="ident" id="7962751">Errorf</span><span class="op" id="7962757">(</span><span class="string" id="7962758">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7962770">,</span>&nbsp;<span class="ident" id="7962772">tc</span><span class="op" id="7962774">,</span>&nbsp;<span class="ident" id="7962776">err</span><span class="op" id="7962779">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962785">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962802">if</span>&nbsp;<span class="ident" id="7962805">err</span>&nbsp;<span class="op" id="7962809">:=</span>&nbsp;<span class="ident" id="7962812">check</span><span class="op" id="7962817">(</span><span class="ident" id="7962818">m0</span><span class="op" id="7962820">.</span><span class="ident" id="7962821">Bounds</span><span class="op" id="7962827">(</span><span class="op" id="7962828">)</span><span class="op" id="7962829">,</span>&nbsp;<span class="ident" id="7962831">m0</span><span class="op" id="7962833">.</span><span class="ident" id="7962834">Cb</span><span class="op" id="7962836">,</span>&nbsp;<span class="ident" id="7962838">m1</span><span class="op" id="7962840">.</span><span class="ident" id="7962841">Cb</span><span class="op" id="7962843">,</span>&nbsp;<span class="ident" id="7962845">m0</span><span class="op" id="7962847">.</span><span class="ident" id="7962848">CStride</span><span class="op" id="7962855">,</span>&nbsp;<span class="ident" id="7962857">m1</span><span class="op" id="7962859">.</span><span class="ident" id="7962860">CStride</span><span class="op" id="7962867">)</span><span class="op" id="7962868">;</span>&nbsp;<span class="ident" id="7962870">err</span>&nbsp;<span class="op" id="7962874">!=</span>&nbsp;<span class="ident" id="7962877">nil</span>&nbsp;<span class="op" id="7962881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7962887">t</span><span class="op" id="7962888">.</span><span class="ident" id="7962889">Errorf</span><span class="op" id="7962895">(</span><span class="string" id="7962896">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7962909">,</span>&nbsp;<span class="ident" id="7962911">tc</span><span class="op" id="7962913">,</span>&nbsp;<span class="ident" id="7962915">err</span><span class="op" id="7962918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962924">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7962936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7962941">if</span>&nbsp;<span class="ident" id="7962944">err</span>&nbsp;<span class="op" id="7962948">:=</span>&nbsp;<span class="ident" id="7962951">check</span><span class="op" id="7962956">(</span><span class="ident" id="7962957">m0</span><span class="op" id="7962959">.</span><span class="ident" id="7962960">Bounds</span><span class="op" id="7962966">(</span><span class="op" id="7962967">)</span><span class="op" id="7962968">,</span>&nbsp;<span class="ident" id="7962970">m0</span><span class="op" id="7962972">.</span><span class="ident" id="7962973">Cr</span><span class="op" id="7962975">,</span>&nbsp;<span class="ident" id="7962977">m1</span><span class="op" id="7962979">.</span><span class="ident" id="7962980">Cr</span><span class="op" id="7962982">,</span>&nbsp;<span class="ident" id="7962984">m0</span><span class="op" id="7962986">.</span><span class="ident" id="7962987">CStride</span><span class="op" id="7962994">,</span>&nbsp;<span class="ident" id="7962996">m1</span><span class="op" id="7962998">.</span><span class="ident" id="7962999">CStride</span><span class="op" id="7963006">)</span><span class="op" id="7963007">;</span>&nbsp;<span class="ident" id="7963009">err</span>&nbsp;<span class="op" id="7963013">!=</span>&nbsp;<span class="ident" id="7963016">nil</span>&nbsp;<span class="op" id="7963020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963026">t</span><span class="op" id="7963027">.</span><span class="ident" id="7963028">Errorf</span><span class="op" id="7963034">(</span><span class="string" id="7963035">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7963048">,</span>&nbsp;<span class="ident" id="7963050">tc</span><span class="op" id="7963052">,</span>&nbsp;<span class="ident" id="7963054">err</span><span class="op" id="7963057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963063">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963075">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963079">case</span>&nbsp;<span class="op" id="7963084">*</span><span class="ident" id="7963085">image</span><span class="op" id="7963090">.</span><span class="ident" id="7963091">Gray</span><span class="op" id="7963095">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963100">m1</span>&nbsp;<span class="op" id="7963103">:=</span>&nbsp;<span class="ident" id="7963106">m1</span><span class="op" id="7963108">.</span><span class="op" id="7963109">(</span><span class="op" id="7963110">*</span><span class="ident" id="7963111">image</span><span class="op" id="7963116">.</span><span class="ident" id="7963117">Gray</span><span class="op" id="7963121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963126">if</span>&nbsp;<span class="ident" id="7963129">err</span>&nbsp;<span class="op" id="7963133">:=</span>&nbsp;<span class="ident" id="7963136">check</span><span class="op" id="7963141">(</span><span class="ident" id="7963142">m0</span><span class="op" id="7963144">.</span><span class="ident" id="7963145">Bounds</span><span class="op" id="7963151">(</span><span class="op" id="7963152">)</span><span class="op" id="7963153">,</span>&nbsp;<span class="ident" id="7963155">m0</span><span class="op" id="7963157">.</span><span class="ident" id="7963158">Pix</span><span class="op" id="7963161">,</span>&nbsp;<span class="ident" id="7963163">m1</span><span class="op" id="7963165">.</span><span class="ident" id="7963166">Pix</span><span class="op" id="7963169">,</span>&nbsp;<span class="ident" id="7963171">m0</span><span class="op" id="7963173">.</span><span class="ident" id="7963174">Stride</span><span class="op" id="7963180">,</span>&nbsp;<span class="ident" id="7963182">m1</span><span class="op" id="7963184">.</span><span class="ident" id="7963185">Stride</span><span class="op" id="7963191">)</span><span class="op" id="7963192">;</span>&nbsp;<span class="ident" id="7963194">err</span>&nbsp;<span class="op" id="7963198">!=</span>&nbsp;<span class="ident" id="7963201">nil</span>&nbsp;<span class="op" id="7963205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963211">t</span><span class="op" id="7963212">.</span><span class="ident" id="7963213">Errorf</span><span class="op" id="7963219">(</span><span class="string" id="7963220">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7963228">,</span>&nbsp;<span class="ident" id="7963230">tc</span><span class="op" id="7963232">,</span>&nbsp;<span class="ident" id="7963234">err</span><span class="op" id="7963237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963243">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963259">default</span><span class="op" id="7963266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963271">t</span><span class="op" id="7963272">.</span><span class="ident" id="7963273">Errorf</span><span class="op" id="7963279">(</span><span class="string" id="7963280">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7963310">,</span>&nbsp;<span class="ident" id="7963312">tc</span><span class="op" id="7963314">,</span>&nbsp;<span class="ident" id="7963316">m0</span><span class="op" id="7963318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963323">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963334">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963337">}</span><br>
<span class="lineno"></span><span class="op" id="7963339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7963342">func</span>&nbsp;<span class="ident" id="7963347">decodeFile</span><span class="op" id="7963357">(</span><span class="ident" id="7963358">filename</span>&nbsp;<span class="builtintype" id="7963367">string</span><span class="op" id="7963373">)</span>&nbsp;<span class="op" id="7963375">(</span><span class="ident" id="7963376">image</span><span class="op" id="7963381">.</span><span class="ident" id="7963382">Image</span><span class="op" id="7963387">,</span>&nbsp;<span class="builtintype" id="7963389">error</span><span class="op" id="7963394">)</span>&nbsp;<span class="op" id="7963396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963399">f</span><span class="op" id="7963400">,</span>&nbsp;<span class="ident" id="7963402">err</span>&nbsp;<span class="op" id="7963406">:=</span>&nbsp;<span class="ident" id="7963409">os</span><span class="op" id="7963411">.</span><span class="ident" id="7963412">Open</span><span class="op" id="7963416">(</span><span class="ident" id="7963417">filename</span><span class="op" id="7963425">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963428">if</span>&nbsp;<span class="ident" id="7963431">err</span>&nbsp;<span class="op" id="7963435">!=</span>&nbsp;<span class="ident" id="7963438">nil</span>&nbsp;<span class="op" id="7963442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963446">return</span>&nbsp;<span class="ident" id="7963453">nil</span><span class="op" id="7963456">,</span>&nbsp;<span class="ident" id="7963458">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963466">defer</span>&nbsp;<span class="ident" id="7963472">f</span><span class="op" id="7963473">.</span><span class="ident" id="7963474">Close</span><span class="op" id="7963479">(</span><span class="op" id="7963480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963483">return</span>&nbsp;<span class="ident" id="7963490">Decode</span><span class="op" id="7963496">(</span><span class="ident" id="7963497">f</span><span class="op" id="7963498">)</span><br>
<span class="lineno">90</span><span class="op" id="7963500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7963503">type</span>&nbsp;<span class="ident" id="7963508">eofReader</span>&nbsp;<span class="keyword" id="7963518">struct</span>&nbsp;<span class="op" id="7963525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963528">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7963537">[</span><span class="op" id="7963538">]</span><span class="builtintype" id="7963539">byte</span>&nbsp;<span class="comment" id="7963544">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963578">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7963587">[</span><span class="op" id="7963588">]</span><span class="builtintype" id="7963589">byte</span>&nbsp;<span class="comment" id="7963594">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963644">lenAtEOF</span>&nbsp;<span class="builtintype" id="7963653">int</span><br>
<span class="lineno"></span><span class="op" id="7963657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7963660">func</span>&nbsp;<span class="op" id="7963665">(</span><span class="ident" id="7963666">r</span>&nbsp;<span class="op" id="7963668">*</span><span class="ident" id="7963669">eofReader</span><span class="op" id="7963678">)</span>&nbsp;<span class="ident" id="7963680">Read</span><span class="op" id="7963684">(</span><span class="ident" id="7963685">b</span>&nbsp;<span class="op" id="7963687">[</span><span class="op" id="7963688">]</span><span class="builtintype" id="7963689">byte</span><span class="op" id="7963693">)</span>&nbsp;<span class="op" id="7963695">(</span><span class="ident" id="7963696">n</span>&nbsp;<span class="builtintype" id="7963698">int</span><span class="op" id="7963701">,</span>&nbsp;<span class="ident" id="7963703">err</span>&nbsp;<span class="builtintype" id="7963707">error</span><span class="op" id="7963712">)</span>&nbsp;<span class="op" id="7963714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963717">if</span>&nbsp;<span class="builtinfunc" id="7963720">len</span><span class="op" id="7963723">(</span><span class="ident" id="7963724">r</span><span class="op" id="7963725">.</span><span class="ident" id="7963726">data</span><span class="op" id="7963730">)</span>&nbsp;<span class="op" id="7963732">&gt;</span>&nbsp;<span class="num" id="7963734">0</span>&nbsp;<span class="op" id="7963736">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963740">n</span>&nbsp;<span class="op" id="7963742">=</span>&nbsp;<span class="builtinfunc" id="7963744">copy</span><span class="op" id="7963748">(</span><span class="ident" id="7963749">b</span><span class="op" id="7963750">,</span>&nbsp;<span class="ident" id="7963752">r</span><span class="op" id="7963753">.</span><span class="ident" id="7963754">data</span><span class="op" id="7963758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963762">r</span><span class="op" id="7963763">.</span><span class="ident" id="7963764">data</span>&nbsp;<span class="op" id="7963769">=</span>&nbsp;<span class="ident" id="7963771">r</span><span class="op" id="7963772">.</span><span class="ident" id="7963773">data</span><span class="op" id="7963777">[</span><span class="ident" id="7963778">n</span><span class="op" id="7963779">:</span><span class="op" id="7963780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963783">}</span>&nbsp;<span class="keyword" id="7963785">else</span>&nbsp;<span class="op" id="7963790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963794">n</span>&nbsp;<span class="op" id="7963796">=</span>&nbsp;<span class="builtinfunc" id="7963798">copy</span><span class="op" id="7963802">(</span><span class="ident" id="7963803">b</span><span class="op" id="7963804">,</span>&nbsp;<span class="ident" id="7963806">r</span><span class="op" id="7963807">.</span><span class="ident" id="7963808">dataEOF</span><span class="op" id="7963815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963819">r</span><span class="op" id="7963820">.</span><span class="ident" id="7963821">dataEOF</span>&nbsp;<span class="op" id="7963829">=</span>&nbsp;<span class="ident" id="7963831">r</span><span class="op" id="7963832">.</span><span class="ident" id="7963833">dataEOF</span><span class="op" id="7963840">[</span><span class="ident" id="7963841">n</span><span class="op" id="7963842">:</span><span class="op" id="7963843">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963847">if</span>&nbsp;<span class="builtinfunc" id="7963850">len</span><span class="op" id="7963853">(</span><span class="ident" id="7963854">r</span><span class="op" id="7963855">.</span><span class="ident" id="7963856">dataEOF</span><span class="op" id="7963863">)</span>&nbsp;<span class="op" id="7963865">==</span>&nbsp;<span class="num" id="7963868">0</span>&nbsp;<span class="op" id="7963870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963875">err</span>&nbsp;<span class="op" id="7963879">=</span>&nbsp;<span class="ident" id="7963881">io</span><span class="op" id="7963883">.</span><span class="ident" id="7963884">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963891">if</span>&nbsp;<span class="ident" id="7963894">r</span><span class="op" id="7963895">.</span><span class="ident" id="7963896">lenAtEOF</span>&nbsp;<span class="op" id="7963905">==</span>&nbsp;<span class="op" id="7963908">-</span><span class="num" id="7963909">1</span>&nbsp;<span class="op" id="7963911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7963917">r</span><span class="op" id="7963918">.</span><span class="ident" id="7963919">lenAtEOF</span>&nbsp;<span class="op" id="7963928">=</span>&nbsp;<span class="ident" id="7963930">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963935">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7963942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7963945">return</span><br>
<span class="lineno"></span><span class="op" id="7963952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7963955">func</span>&nbsp;<span class="ident" id="7963960">TestDecodeEOF</span><span class="op" id="7963973">(</span><span class="ident" id="7963974">t</span>&nbsp;<span class="op" id="7963976">*</span><span class="ident" id="7963977">testing</span><span class="op" id="7963984">.</span><span class="ident" id="7963985">T</span><span class="op" id="7963986">)</span>&nbsp;<span class="op" id="7963988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7963991">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964074">data</span><span class="op" id="7964078">,</span>&nbsp;<span class="ident" id="7964080">err</span>&nbsp;<span class="op" id="7964084">:=</span>&nbsp;<span class="ident" id="7964087">ioutil</span><span class="op" id="7964093">.</span><span class="ident" id="7964094">ReadFile</span><span class="op" id="7964102">(</span><span class="string" id="7964103">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7964131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964134">if</span>&nbsp;<span class="ident" id="7964137">err</span>&nbsp;<span class="op" id="7964141">!=</span>&nbsp;<span class="ident" id="7964144">nil</span>&nbsp;<span class="op" id="7964148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964152">t</span><span class="op" id="7964153">.</span><span class="ident" id="7964154">Fatal</span><span class="op" id="7964159">(</span><span class="ident" id="7964160">err</span><span class="op" id="7964163">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964170">n</span>&nbsp;<span class="op" id="7964172">:=</span>&nbsp;<span class="builtinfunc" id="7964175">len</span><span class="op" id="7964178">(</span><span class="ident" id="7964179">data</span><span class="op" id="7964183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964186">for</span>&nbsp;<span class="ident" id="7964190">i</span>&nbsp;<span class="op" id="7964192">:=</span>&nbsp;<span class="num" id="7964195">0</span><span class="op" id="7964196">;</span>&nbsp;<span class="ident" id="7964198">i</span>&nbsp;<span class="op" id="7964200">&lt;</span>&nbsp;<span class="ident" id="7964202">n</span><span class="op" id="7964203">;</span>&nbsp;<span class="op" id="7964205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964209">r</span>&nbsp;<span class="op" id="7964211">:=</span>&nbsp;<span class="op" id="7964214">&amp;</span><span class="ident" id="7964215">eofReader</span><span class="op" id="7964224">{</span><span class="ident" id="7964225">data</span><span class="op" id="7964229">[</span><span class="op" id="7964230">:</span><span class="ident" id="7964231">n</span><span class="op" id="7964232">-</span><span class="ident" id="7964233">i</span><span class="op" id="7964234">]</span><span class="op" id="7964235">,</span>&nbsp;<span class="ident" id="7964237">data</span><span class="op" id="7964241">[</span><span class="ident" id="7964242">n</span><span class="op" id="7964243">-</span><span class="ident" id="7964244">i</span><span class="op" id="7964245">:</span><span class="op" id="7964246">]</span><span class="op" id="7964247">,</span>&nbsp;<span class="op" id="7964249">-</span><span class="num" id="7964250">1</span><span class="op" id="7964251">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964255">_</span><span class="op" id="7964256">,</span>&nbsp;<span class="ident" id="7964258">err</span>&nbsp;<span class="op" id="7964262">:=</span>&nbsp;<span class="ident" id="7964265">Decode</span><span class="op" id="7964271">(</span><span class="ident" id="7964272">r</span><span class="op" id="7964273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964277">if</span>&nbsp;<span class="ident" id="7964280">err</span>&nbsp;<span class="op" id="7964284">!=</span>&nbsp;<span class="ident" id="7964287">nil</span>&nbsp;<span class="op" id="7964291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964296">t</span><span class="op" id="7964297">.</span><span class="ident" id="7964298">Errorf</span><span class="op" id="7964304">(</span><span class="string" id="7964305">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7964339">,</span>&nbsp;<span class="ident" id="7964341">r</span><span class="op" id="7964342">.</span><span class="ident" id="7964343">lenAtEOF</span><span class="op" id="7964351">,</span>&nbsp;<span class="ident" id="7964353">err</span><span class="op" id="7964356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964364">if</span>&nbsp;<span class="ident" id="7964367">i</span>&nbsp;<span class="op" id="7964369">==</span>&nbsp;<span class="num" id="7964372">0</span>&nbsp;<span class="op" id="7964374">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964379">i</span>&nbsp;<span class="op" id="7964381">=</span>&nbsp;<span class="num" id="7964383">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964387">}</span>&nbsp;<span class="keyword" id="7964389">else</span>&nbsp;<span class="op" id="7964394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7964399">i</span>&nbsp;<span class="op" id="7964401">*=</span>&nbsp;<span class="num" id="7964404">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964411">}</span><br>
<span class="lineno">135</span><span class="op" id="7964413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7964416">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7964490">func</span>&nbsp;<span class="ident" id="7964495">check</span><span class="op" id="7964500">(</span><span class="ident" id="7964501">bounds</span>&nbsp;<span class="ident" id="7964508">image</span><span class="op" id="7964513">.</span><span class="ident" id="7964514">Rectangle</span><span class="op" id="7964523">,</span>&nbsp;<span class="ident" id="7964525">pix0</span><span class="op" id="7964529">,</span>&nbsp;<span class="ident" id="7964531">pix1</span>&nbsp;<span class="op" id="7964536">[</span><span class="op" id="7964537">]</span><span class="builtintype" id="7964538">byte</span><span class="op" id="7964542">,</span>&nbsp;<span class="ident" id="7964544">stride0</span><span class="op" id="7964551">,</span>&nbsp;<span class="ident" id="7964553">stride1</span>&nbsp;<span class="builtintype" id="7964561">int</span><span class="op" id="7964564">)</span>&nbsp;<span class="builtintype" id="7964566">error</span>&nbsp;<span class="op" id="7964572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964575">if</span>&nbsp;<span class="ident" id="7964578">stride0</span>&nbsp;<span class="op" id="7964586">&lt;=</span>&nbsp;<span class="num" id="7964589">0</span>&nbsp;<span class="op" id="7964591">||</span>&nbsp;<span class="ident" id="7964594">stride0</span><span class="op" id="7964601">%</span><span class="num" id="7964602">8</span>&nbsp;<span class="op" id="7964604">!=</span>&nbsp;<span class="num" id="7964607">0</span>&nbsp;<span class="op" id="7964609">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964613">return</span>&nbsp;<span class="ident" id="7964620">fmt</span><span class="op" id="7964623">.</span><span class="ident" id="7964624">Errorf</span><span class="op" id="7964630">(</span><span class="string" id="7964631">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7964646">,</span>&nbsp;<span class="ident" id="7964648">stride0</span><span class="op" id="7964655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964661">if</span>&nbsp;<span class="ident" id="7964664">stride1</span>&nbsp;<span class="op" id="7964672">&lt;=</span>&nbsp;<span class="num" id="7964675">0</span>&nbsp;<span class="op" id="7964677">||</span>&nbsp;<span class="ident" id="7964680">stride1</span><span class="op" id="7964687">%</span><span class="num" id="7964688">8</span>&nbsp;<span class="op" id="7964690">!=</span>&nbsp;<span class="num" id="7964693">0</span>&nbsp;<span class="op" id="7964695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964699">return</span>&nbsp;<span class="ident" id="7964706">fmt</span><span class="op" id="7964709">.</span><span class="ident" id="7964710">Errorf</span><span class="op" id="7964716">(</span><span class="string" id="7964717">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7964732">,</span>&nbsp;<span class="ident" id="7964734">stride1</span><span class="op" id="7964741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7964744">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7964747">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964802">for</span>&nbsp;<span class="ident" id="7964806">y</span>&nbsp;<span class="op" id="7964808">:=</span>&nbsp;<span class="num" id="7964811">0</span><span class="op" id="7964812">;</span>&nbsp;<span class="ident" id="7964814">y</span>&nbsp;<span class="op" id="7964816">&lt;</span>&nbsp;<span class="builtinfunc" id="7964818">len</span><span class="op" id="7964821">(</span><span class="ident" id="7964822">pix0</span><span class="op" id="7964826">)</span><span class="op" id="7964827">/</span><span class="ident" id="7964828">stride0</span>&nbsp;<span class="op" id="7964836">&amp;&amp;</span>&nbsp;<span class="ident" id="7964839">y</span>&nbsp;<span class="op" id="7964841">&lt;</span>&nbsp;<span class="builtinfunc" id="7964843">len</span><span class="op" id="7964846">(</span><span class="ident" id="7964847">pix1</span><span class="op" id="7964851">)</span><span class="op" id="7964852">/</span><span class="ident" id="7964853">stride1</span><span class="op" id="7964860">;</span>&nbsp;<span class="ident" id="7964862">y</span>&nbsp;<span class="op" id="7964864">+=</span>&nbsp;<span class="num" id="7964867">8</span>&nbsp;<span class="op" id="7964869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964873">for</span>&nbsp;<span class="ident" id="7964877">x</span>&nbsp;<span class="op" id="7964879">:=</span>&nbsp;<span class="num" id="7964882">0</span><span class="op" id="7964883">;</span>&nbsp;<span class="ident" id="7964885">x</span>&nbsp;<span class="op" id="7964887">&lt;</span>&nbsp;<span class="ident" id="7964889">stride0</span>&nbsp;<span class="op" id="7964897">&amp;&amp;</span>&nbsp;<span class="ident" id="7964900">x</span>&nbsp;<span class="op" id="7964902">&lt;</span>&nbsp;<span class="ident" id="7964904">stride1</span><span class="op" id="7964911">;</span>&nbsp;<span class="ident" id="7964913">x</span>&nbsp;<span class="op" id="7964915">+=</span>&nbsp;<span class="num" id="7964918">8</span>&nbsp;<span class="op" id="7964920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7964925">if</span>&nbsp;<span class="ident" id="7964928">x</span>&nbsp;<span class="op" id="7964930">&gt;=</span>&nbsp;<span class="ident" id="7964933">bounds</span><span class="op" id="7964939">.</span><span class="ident" id="7964940">Max</span><span class="op" id="7964943">.</span><span class="ident" id="7964944">X</span>&nbsp;<span class="op" id="7964946">||</span>&nbsp;<span class="ident" id="7964949">y</span>&nbsp;<span class="op" id="7964951">&gt;=</span>&nbsp;<span class="ident" id="7964954">bounds</span><span class="op" id="7964960">.</span><span class="ident" id="7964961">Max</span><span class="op" id="7964964">.</span><span class="ident" id="7964965">Y</span>&nbsp;<span class="op" id="7964967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7964973">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7965041">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7965110">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7965181">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7965248">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7965316">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965384">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965402">for</span>&nbsp;<span class="ident" id="7965406">j</span>&nbsp;<span class="op" id="7965408">:=</span>&nbsp;<span class="num" id="7965411">0</span><span class="op" id="7965412">;</span>&nbsp;<span class="ident" id="7965414">j</span>&nbsp;<span class="op" id="7965416">&lt;</span>&nbsp;<span class="num" id="7965418">8</span><span class="op" id="7965419">;</span>&nbsp;<span class="ident" id="7965421">j</span><span class="op" id="7965422">++</span>&nbsp;<span class="op" id="7965425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965431">for</span>&nbsp;<span class="ident" id="7965435">i</span>&nbsp;<span class="op" id="7965437">:=</span>&nbsp;<span class="num" id="7965440">0</span><span class="op" id="7965441">;</span>&nbsp;<span class="ident" id="7965443">i</span>&nbsp;<span class="op" id="7965445">&lt;</span>&nbsp;<span class="num" id="7965447">8</span><span class="op" id="7965448">;</span>&nbsp;<span class="ident" id="7965450">i</span><span class="op" id="7965451">++</span>&nbsp;<span class="op" id="7965454">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965461">index0</span>&nbsp;<span class="op" id="7965468">:=</span>&nbsp;<span class="op" id="7965471">(</span><span class="ident" id="7965472">y</span><span class="op" id="7965473">+</span><span class="ident" id="7965474">j</span><span class="op" id="7965475">)</span><span class="op" id="7965476">*</span><span class="ident" id="7965477">stride0</span>&nbsp;<span class="op" id="7965485">+</span>&nbsp;<span class="op" id="7965487">(</span><span class="ident" id="7965488">x</span>&nbsp;<span class="op" id="7965490">+</span>&nbsp;<span class="ident" id="7965492">i</span><span class="op" id="7965493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965500">index1</span>&nbsp;<span class="op" id="7965507">:=</span>&nbsp;<span class="op" id="7965510">(</span><span class="ident" id="7965511">y</span><span class="op" id="7965512">+</span><span class="ident" id="7965513">j</span><span class="op" id="7965514">)</span><span class="op" id="7965515">*</span><span class="ident" id="7965516">stride1</span>&nbsp;<span class="op" id="7965524">+</span>&nbsp;<span class="op" id="7965526">(</span><span class="ident" id="7965527">x</span>&nbsp;<span class="op" id="7965529">+</span>&nbsp;<span class="ident" id="7965531">i</span><span class="op" id="7965532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965539">if</span>&nbsp;<span class="ident" id="7965542">pix0</span><span class="op" id="7965546">[</span><span class="ident" id="7965547">index0</span><span class="op" id="7965553">]</span>&nbsp;<span class="op" id="7965555">!=</span>&nbsp;<span class="ident" id="7965558">pix1</span><span class="op" id="7965562">[</span><span class="ident" id="7965563">index1</span><span class="op" id="7965569">]</span>&nbsp;<span class="op" id="7965571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965579">return</span>&nbsp;<span class="ident" id="7965586">fmt</span><span class="op" id="7965589">.</span><span class="ident" id="7965590">Errorf</span><span class="op" id="7965596">(</span><span class="string" id="7965597">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7965636">,</span>&nbsp;<span class="ident" id="7965638">x</span><span class="op" id="7965639">,</span>&nbsp;<span class="ident" id="7965641">y</span><span class="op" id="7965642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965651">pixString</span><span class="op" id="7965660">(</span><span class="ident" id="7965661">pix0</span><span class="op" id="7965665">,</span>&nbsp;<span class="ident" id="7965667">stride0</span><span class="op" id="7965674">,</span>&nbsp;<span class="ident" id="7965676">x</span><span class="op" id="7965677">,</span>&nbsp;<span class="ident" id="7965679">y</span><span class="op" id="7965680">)</span><span class="op" id="7965681">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965690">pixString</span><span class="op" id="7965699">(</span><span class="ident" id="7965700">pix1</span><span class="op" id="7965704">,</span>&nbsp;<span class="ident" id="7965706">stride1</span><span class="op" id="7965713">,</span>&nbsp;<span class="ident" id="7965715">x</span><span class="op" id="7965716">,</span>&nbsp;<span class="ident" id="7965718">y</span><span class="op" id="7965719">)</span><span class="op" id="7965720">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965746">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965756">return</span>&nbsp;<span class="ident" id="7965763">nil</span><br>
<span class="lineno"></span><span class="op" id="7965767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7965770">func</span>&nbsp;<span class="ident" id="7965775">pixString</span><span class="op" id="7965784">(</span><span class="ident" id="7965785">pix</span>&nbsp;<span class="op" id="7965789">[</span><span class="op" id="7965790">]</span><span class="builtintype" id="7965791">byte</span><span class="op" id="7965795">,</span>&nbsp;<span class="ident" id="7965797">stride</span><span class="op" id="7965803">,</span>&nbsp;<span class="ident" id="7965805">x</span><span class="op" id="7965806">,</span>&nbsp;<span class="ident" id="7965808">y</span>&nbsp;<span class="builtintype" id="7965810">int</span><span class="op" id="7965813">)</span>&nbsp;<span class="builtintype" id="7965815">string</span>&nbsp;<span class="op" id="7965822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965825">s</span>&nbsp;<span class="op" id="7965827">:=</span>&nbsp;<span class="ident" id="7965830">bytes</span><span class="op" id="7965835">.</span><span class="ident" id="7965836">NewBuffer</span><span class="op" id="7965845">(</span><span class="ident" id="7965846">nil</span><span class="op" id="7965849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965852">for</span>&nbsp;<span class="ident" id="7965856">j</span>&nbsp;<span class="op" id="7965858">:=</span>&nbsp;<span class="num" id="7965861">0</span><span class="op" id="7965862">;</span>&nbsp;<span class="ident" id="7965864">j</span>&nbsp;<span class="op" id="7965866">&lt;</span>&nbsp;<span class="num" id="7965868">8</span><span class="op" id="7965869">;</span>&nbsp;<span class="ident" id="7965871">j</span><span class="op" id="7965872">++</span>&nbsp;<span class="op" id="7965875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965879">fmt</span><span class="op" id="7965882">.</span><span class="ident" id="7965883">Fprintf</span><span class="op" id="7965890">(</span><span class="ident" id="7965891">s</span><span class="op" id="7965892">,</span>&nbsp;<span class="string" id="7965894">&#34;\t&#34;</span><span class="op" id="7965898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7965902">for</span>&nbsp;<span class="ident" id="7965906">i</span>&nbsp;<span class="op" id="7965908">:=</span>&nbsp;<span class="num" id="7965911">0</span><span class="op" id="7965912">;</span>&nbsp;<span class="ident" id="7965914">i</span>&nbsp;<span class="op" id="7965916">&lt;</span>&nbsp;<span class="num" id="7965918">8</span><span class="op" id="7965919">;</span>&nbsp;<span class="ident" id="7965921">i</span><span class="op" id="7965922">++</span>&nbsp;<span class="op" id="7965925">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965930">fmt</span><span class="op" id="7965933">.</span><span class="ident" id="7965934">Fprintf</span><span class="op" id="7965941">(</span><span class="ident" id="7965942">s</span><span class="op" id="7965943">,</span>&nbsp;<span class="string" id="7965945">&#34;%02x&nbsp;&#34;</span><span class="op" id="7965952">,</span>&nbsp;<span class="ident" id="7965954">pix</span><span class="op" id="7965957">[</span><span class="op" id="7965958">(</span><span class="ident" id="7965959">y</span><span class="op" id="7965960">+</span><span class="ident" id="7965961">j</span><span class="op" id="7965962">)</span><span class="op" id="7965963">*</span><span class="ident" id="7965964">stride</span><span class="op" id="7965970">+</span><span class="op" id="7965971">(</span><span class="ident" id="7965972">x</span><span class="op" id="7965973">+</span><span class="ident" id="7965974">i</span><span class="op" id="7965975">)</span><span class="op" id="7965976">]</span><span class="op" id="7965977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7965981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7965985">fmt</span><span class="op" id="7965988">.</span><span class="ident" id="7965989">Fprintf</span><span class="op" id="7965996">(</span><span class="ident" id="7965997">s</span><span class="op" id="7965998">,</span>&nbsp;<span class="string" id="7966000">&#34;\n&#34;</span><span class="op" id="7966004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966010">return</span>&nbsp;<span class="ident" id="7966017">s</span><span class="op" id="7966018">.</span><span class="ident" id="7966019">String</span><span class="op" id="7966025">(</span><span class="op" id="7966026">)</span><br>
<span class="lineno">185</span><span class="op" id="7966028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7966031">func</span>&nbsp;<span class="ident" id="7966036">TestExtraneousData</span><span class="op" id="7966054">(</span><span class="ident" id="7966055">t</span>&nbsp;<span class="op" id="7966057">*</span><span class="ident" id="7966058">testing</span><span class="op" id="7966065">.</span><span class="ident" id="7966066">T</span><span class="op" id="7966067">)</span>&nbsp;<span class="op" id="7966069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966072">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966100">src</span>&nbsp;<span class="op" id="7966104">:=</span>&nbsp;<span class="ident" id="7966107">image</span><span class="op" id="7966112">.</span><span class="ident" id="7966113">NewRGBA</span><span class="op" id="7966120">(</span><span class="ident" id="7966121">image</span><span class="op" id="7966126">.</span><span class="ident" id="7966127">Rect</span><span class="op" id="7966131">(</span><span class="num" id="7966132">0</span><span class="op" id="7966133">,</span>&nbsp;<span class="num" id="7966135">0</span><span class="op" id="7966136">,</span>&nbsp;<span class="num" id="7966138">1</span><span class="op" id="7966139">,</span>&nbsp;<span class="num" id="7966141">1</span><span class="op" id="7966142">)</span><span class="op" id="7966143">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966146">src</span><span class="op" id="7966149">.</span><span class="ident" id="7966150">Set</span><span class="op" id="7966153">(</span><span class="num" id="7966154">0</span><span class="op" id="7966155">,</span>&nbsp;<span class="num" id="7966157">0</span><span class="op" id="7966158">,</span>&nbsp;<span class="ident" id="7966160">color</span><span class="op" id="7966165">.</span><span class="ident" id="7966166">RGBA</span><span class="op" id="7966170">{</span><span class="num" id="7966171">0xff</span><span class="op" id="7966175">,</span>&nbsp;<span class="num" id="7966177">0x00</span><span class="op" id="7966181">,</span>&nbsp;<span class="num" id="7966183">0x00</span><span class="op" id="7966187">,</span>&nbsp;<span class="num" id="7966189">0xff</span><span class="op" id="7966193">}</span><span class="op" id="7966194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966197">buf</span>&nbsp;<span class="op" id="7966201">:=</span>&nbsp;<span class="builtinfunc" id="7966204">new</span><span class="op" id="7966207">(</span><span class="ident" id="7966208">bytes</span><span class="op" id="7966213">.</span><span class="ident" id="7966214">Buffer</span><span class="op" id="7966220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966223">if</span>&nbsp;<span class="ident" id="7966226">err</span>&nbsp;<span class="op" id="7966230">:=</span>&nbsp;<span class="ident" id="7966233">Encode</span><span class="op" id="7966239">(</span><span class="ident" id="7966240">buf</span><span class="op" id="7966243">,</span>&nbsp;<span class="ident" id="7966245">src</span><span class="op" id="7966248">,</span>&nbsp;<span class="ident" id="7966250">nil</span><span class="op" id="7966253">)</span><span class="op" id="7966254">;</span>&nbsp;<span class="ident" id="7966256">err</span>&nbsp;<span class="op" id="7966260">!=</span>&nbsp;<span class="ident" id="7966263">nil</span>&nbsp;<span class="op" id="7966267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966271">t</span><span class="op" id="7966272">.</span><span class="ident" id="7966273">Fatalf</span><span class="op" id="7966279">(</span><span class="string" id="7966280">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7966292">,</span>&nbsp;<span class="ident" id="7966294">err</span><span class="op" id="7966297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966300">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966303">enc</span>&nbsp;<span class="op" id="7966307">:=</span>&nbsp;<span class="ident" id="7966310">buf</span><span class="op" id="7966313">.</span><span class="ident" id="7966314">String</span><span class="op" id="7966320">(</span><span class="op" id="7966321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966324">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966397">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966469">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966506">if</span>&nbsp;<span class="builtinfunc" id="7966509">len</span><span class="op" id="7966512">(</span><span class="ident" id="7966513">enc</span><span class="op" id="7966516">)</span>&nbsp;<span class="op" id="7966518">&lt;</span>&nbsp;<span class="num" id="7966520">64</span>&nbsp;<span class="op" id="7966523">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966527">t</span><span class="op" id="7966528">.</span><span class="ident" id="7966529">Fatalf</span><span class="op" id="7966535">(</span><span class="string" id="7966536">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7966573">,</span>&nbsp;<span class="builtinfunc" id="7966575">len</span><span class="op" id="7966578">(</span><span class="ident" id="7966579">enc</span><span class="op" id="7966582">)</span><span class="op" id="7966583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966589">if</span>&nbsp;<span class="ident" id="7966592">got</span><span class="op" id="7966595">,</span>&nbsp;<span class="ident" id="7966597">want</span>&nbsp;<span class="op" id="7966602">:=</span>&nbsp;<span class="ident" id="7966605">enc</span><span class="op" id="7966608">[</span><span class="builtinfunc" id="7966609">len</span><span class="op" id="7966612">(</span><span class="ident" id="7966613">enc</span><span class="op" id="7966616">)</span><span class="op" id="7966617">-</span><span class="num" id="7966618">2</span><span class="op" id="7966619">:</span><span class="op" id="7966620">]</span><span class="op" id="7966621">,</span>&nbsp;<span class="string" id="7966623">&#34;\xff\xd9&#34;</span><span class="op" id="7966633">;</span>&nbsp;<span class="ident" id="7966635">got</span>&nbsp;<span class="op" id="7966639">!=</span>&nbsp;<span class="ident" id="7966642">want</span>&nbsp;<span class="op" id="7966647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966651">t</span><span class="op" id="7966652">.</span><span class="ident" id="7966653">Fatalf</span><span class="op" id="7966659">(</span><span class="string" id="7966660">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7966696">,</span>&nbsp;<span class="ident" id="7966698">got</span><span class="op" id="7966701">,</span>&nbsp;<span class="ident" id="7966703">want</span><span class="op" id="7966707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966710">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7966713">if</span>&nbsp;<span class="ident" id="7966716">s</span>&nbsp;<span class="op" id="7966718">:=</span>&nbsp;<span class="ident" id="7966721">enc</span><span class="op" id="7966724">[</span><span class="builtinfunc" id="7966725">len</span><span class="op" id="7966728">(</span><span class="ident" id="7966729">enc</span><span class="op" id="7966732">)</span><span class="op" id="7966733">-</span><span class="num" id="7966734">64</span><span class="op" id="7966736">:</span><span class="op" id="7966737">]</span><span class="op" id="7966738">;</span>&nbsp;<span class="op" id="7966740">!</span><span class="ident" id="7966741">strings</span><span class="op" id="7966748">.</span><span class="ident" id="7966749">Contains</span><span class="op" id="7966757">(</span><span class="ident" id="7966758">s</span><span class="op" id="7966759">,</span>&nbsp;<span class="string" id="7966761">&#34;\xff\xda&#34;</span><span class="op" id="7966771">)</span>&nbsp;<span class="op" id="7966773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966777">t</span><span class="op" id="7966778">.</span><span class="ident" id="7966779">Fatalf</span><span class="op" id="7966785">(</span><span class="string" id="7966786">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7966856">,</span>&nbsp;<span class="ident" id="7966858">s</span><span class="op" id="7966859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7966862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966865">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7966934">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7966979">rnd</span>&nbsp;<span class="op" id="7966983">:=</span>&nbsp;<span class="ident" id="7966986">rand</span><span class="op" id="7966990">.</span><span class="ident" id="7966991">New</span><span class="op" id="7966994">(</span><span class="ident" id="7966995">rand</span><span class="op" id="7966999">.</span><span class="ident" id="7967000">NewSource</span><span class="op" id="7967009">(</span><span class="num" id="7967010">1</span><span class="op" id="7967011">)</span><span class="op" id="7967012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967015">for</span>&nbsp;<span class="ident" id="7967019">i</span><span class="op" id="7967020">,</span>&nbsp;<span class="ident" id="7967022">nerr</span>&nbsp;<span class="op" id="7967027">:=</span>&nbsp;<span class="num" id="7967030">0</span><span class="op" id="7967031">,</span>&nbsp;<span class="num" id="7967033">0</span><span class="op" id="7967034">;</span>&nbsp;<span class="ident" id="7967036">i</span>&nbsp;<span class="op" id="7967038">&lt;</span>&nbsp;<span class="num" id="7967040">1000</span>&nbsp;<span class="op" id="7967045">&amp;&amp;</span>&nbsp;<span class="ident" id="7967048">nerr</span>&nbsp;<span class="op" id="7967053">&lt;</span>&nbsp;<span class="num" id="7967055">10</span><span class="op" id="7967057">;</span>&nbsp;<span class="ident" id="7967059">i</span><span class="op" id="7967060">++</span>&nbsp;<span class="op" id="7967063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967067">buf</span><span class="op" id="7967070">.</span><span class="ident" id="7967071">Reset</span><span class="op" id="7967076">(</span><span class="op" id="7967077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967081">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967136">buf</span><span class="op" id="7967139">.</span><span class="ident" id="7967140">WriteString</span><span class="op" id="7967151">(</span><span class="ident" id="7967152">enc</span><span class="op" id="7967155">[</span><span class="op" id="7967156">:</span><span class="builtinfunc" id="7967157">len</span><span class="op" id="7967160">(</span><span class="ident" id="7967161">enc</span><span class="op" id="7967164">)</span><span class="op" id="7967165">-</span><span class="num" id="7967166">2</span><span class="op" id="7967167">]</span><span class="op" id="7967168">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967172">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967212">for</span>&nbsp;<span class="ident" id="7967216">n</span>&nbsp;<span class="op" id="7967218">:=</span>&nbsp;<span class="ident" id="7967221">rnd</span><span class="op" id="7967224">.</span><span class="ident" id="7967225">Intn</span><span class="op" id="7967229">(</span><span class="num" id="7967230">10</span><span class="op" id="7967232">)</span><span class="op" id="7967233">;</span>&nbsp;<span class="ident" id="7967235">n</span>&nbsp;<span class="op" id="7967237">&gt;</span>&nbsp;<span class="num" id="7967239">0</span><span class="op" id="7967240">;</span>&nbsp;<span class="ident" id="7967242">n</span><span class="op" id="7967243">--</span>&nbsp;<span class="op" id="7967246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967251">if</span>&nbsp;<span class="ident" id="7967254">x</span>&nbsp;<span class="op" id="7967256">:=</span>&nbsp;<span class="builtintype" id="7967259">byte</span><span class="op" id="7967263">(</span><span class="ident" id="7967264">rnd</span><span class="op" id="7967267">.</span><span class="ident" id="7967268">Intn</span><span class="op" id="7967272">(</span><span class="num" id="7967273">256</span><span class="op" id="7967276">)</span><span class="op" id="7967277">)</span><span class="op" id="7967278">;</span>&nbsp;<span class="ident" id="7967280">x</span>&nbsp;<span class="op" id="7967282">!=</span>&nbsp;<span class="num" id="7967285">0xff</span>&nbsp;<span class="op" id="7967290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967296">buf</span><span class="op" id="7967299">.</span><span class="ident" id="7967300">WriteByte</span><span class="op" id="7967309">(</span><span class="ident" id="7967310">x</span><span class="op" id="7967311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967316">}</span>&nbsp;<span class="keyword" id="7967318">else</span>&nbsp;<span class="op" id="7967323">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967329">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967396">buf</span><span class="op" id="7967399">.</span><span class="ident" id="7967400">WriteString</span><span class="op" id="7967411">(</span><span class="string" id="7967412">&#34;\xff\x00&#34;</span><span class="op" id="7967422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967435">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967473">buf</span><span class="op" id="7967476">.</span><span class="ident" id="7967477">WriteString</span><span class="op" id="7967488">(</span><span class="string" id="7967489">&#34;\xff\xd9&#34;</span><span class="op" id="7967499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7967504">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967561">got</span><span class="op" id="7967564">,</span>&nbsp;<span class="ident" id="7967566">err</span>&nbsp;<span class="op" id="7967570">:=</span>&nbsp;<span class="ident" id="7967573">Decode</span><span class="op" id="7967579">(</span><span class="ident" id="7967580">buf</span><span class="op" id="7967583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967587">if</span>&nbsp;<span class="ident" id="7967590">err</span>&nbsp;<span class="op" id="7967594">!=</span>&nbsp;<span class="ident" id="7967597">nil</span>&nbsp;<span class="op" id="7967601">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967606">t</span><span class="op" id="7967607">.</span><span class="ident" id="7967608">Errorf</span><span class="op" id="7967614">(</span><span class="string" id="7967615">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7967647">,</span>&nbsp;<span class="ident" id="7967649">i</span><span class="op" id="7967650">,</span>&nbsp;<span class="ident" id="7967652">err</span><span class="op" id="7967655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967660">nerr</span><span class="op" id="7967664">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967670">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967685">if</span>&nbsp;<span class="ident" id="7967688">got</span><span class="op" id="7967691">.</span><span class="ident" id="7967692">Bounds</span><span class="op" id="7967698">(</span><span class="op" id="7967699">)</span>&nbsp;<span class="op" id="7967701">!=</span>&nbsp;<span class="ident" id="7967704">src</span><span class="op" id="7967707">.</span><span class="ident" id="7967708">Bounds</span><span class="op" id="7967714">(</span><span class="op" id="7967715">)</span>&nbsp;<span class="op" id="7967717">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967722">t</span><span class="op" id="7967723">.</span><span class="ident" id="7967724">Errorf</span><span class="op" id="7967730">(</span><span class="string" id="7967731">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7967768">,</span>&nbsp;<span class="ident" id="7967770">i</span><span class="op" id="7967771">,</span>&nbsp;<span class="ident" id="7967773">got</span><span class="op" id="7967776">.</span><span class="ident" id="7967777">Bounds</span><span class="op" id="7967783">(</span><span class="op" id="7967784">)</span><span class="op" id="7967785">,</span>&nbsp;<span class="ident" id="7967787">src</span><span class="op" id="7967790">.</span><span class="ident" id="7967791">Bounds</span><span class="op" id="7967797">(</span><span class="op" id="7967798">)</span><span class="op" id="7967799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967804">nerr</span><span class="op" id="7967808">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967814">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967829">if</span>&nbsp;<span class="ident" id="7967832">averageDelta</span><span class="op" id="7967844">(</span><span class="ident" id="7967845">got</span><span class="op" id="7967848">,</span>&nbsp;<span class="ident" id="7967850">src</span><span class="op" id="7967853">)</span>&nbsp;<span class="op" id="7967855">&gt;</span>&nbsp;<span class="num" id="7967857">2</span><span class="op" id="7967858">&lt;&lt;</span><span class="num" id="7967860">8</span>&nbsp;<span class="op" id="7967862">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967867">t</span><span class="op" id="7967868">.</span><span class="ident" id="7967869">Errorf</span><span class="op" id="7967875">(</span><span class="string" id="7967876">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7967923">,</span>&nbsp;<span class="ident" id="7967925">i</span><span class="op" id="7967926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7967931">nerr</span><span class="op" id="7967935">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7967941">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7967955">}</span><br>
<span class="lineno">245</span><span class="op" id="7967957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7967960">func</span>&nbsp;<span class="ident" id="7967965">benchmarkDecode</span><span class="op" id="7967980">(</span><span class="ident" id="7967981">b</span>&nbsp;<span class="op" id="7967983">*</span><span class="ident" id="7967984">testing</span><span class="op" id="7967991">.</span><span class="ident" id="7967992">B</span><span class="op" id="7967993">,</span>&nbsp;<span class="ident" id="7967995">filename</span>&nbsp;<span class="builtintype" id="7968004">string</span><span class="op" id="7968010">)</span>&nbsp;<span class="op" id="7968012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968015">b</span><span class="op" id="7968016">.</span><span class="ident" id="7968017">StopTimer</span><span class="op" id="7968026">(</span><span class="op" id="7968027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968030">data</span><span class="op" id="7968034">,</span>&nbsp;<span class="ident" id="7968036">err</span>&nbsp;<span class="op" id="7968040">:=</span>&nbsp;<span class="ident" id="7968043">ioutil</span><span class="op" id="7968049">.</span><span class="ident" id="7968050">ReadFile</span><span class="op" id="7968058">(</span><span class="ident" id="7968059">filename</span><span class="op" id="7968067">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968070">if</span>&nbsp;<span class="ident" id="7968073">err</span>&nbsp;<span class="op" id="7968077">!=</span>&nbsp;<span class="ident" id="7968080">nil</span>&nbsp;<span class="op" id="7968084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968088">b</span><span class="op" id="7968089">.</span><span class="ident" id="7968090">Fatal</span><span class="op" id="7968095">(</span><span class="ident" id="7968096">err</span><span class="op" id="7968099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968105">cfg</span><span class="op" id="7968108">,</span>&nbsp;<span class="ident" id="7968110">err</span>&nbsp;<span class="op" id="7968114">:=</span>&nbsp;<span class="ident" id="7968117">DecodeConfig</span><span class="op" id="7968129">(</span><span class="ident" id="7968130">bytes</span><span class="op" id="7968135">.</span><span class="ident" id="7968136">NewReader</span><span class="op" id="7968145">(</span><span class="ident" id="7968146">data</span><span class="op" id="7968150">)</span><span class="op" id="7968151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968154">if</span>&nbsp;<span class="ident" id="7968157">err</span>&nbsp;<span class="op" id="7968161">!=</span>&nbsp;<span class="ident" id="7968164">nil</span>&nbsp;<span class="op" id="7968168">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968172">b</span><span class="op" id="7968173">.</span><span class="ident" id="7968174">Fatal</span><span class="op" id="7968179">(</span><span class="ident" id="7968180">err</span><span class="op" id="7968183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968189">b</span><span class="op" id="7968190">.</span><span class="ident" id="7968191">SetBytes</span><span class="op" id="7968199">(</span><span class="ident" id="7968200">int64</span><span class="op" id="7968205">(</span><span class="ident" id="7968206">cfg</span><span class="op" id="7968209">.</span><span class="ident" id="7968210">Width</span>&nbsp;<span class="op" id="7968216">*</span>&nbsp;<span class="ident" id="7968218">cfg</span><span class="op" id="7968221">.</span><span class="ident" id="7968222">Height</span>&nbsp;<span class="op" id="7968229">*</span>&nbsp;<span class="num" id="7968231">4</span><span class="op" id="7968232">)</span><span class="op" id="7968233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968236">b</span><span class="op" id="7968237">.</span><span class="ident" id="7968238">StartTimer</span><span class="op" id="7968248">(</span><span class="op" id="7968249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7968252">for</span>&nbsp;<span class="ident" id="7968256">i</span>&nbsp;<span class="op" id="7968258">:=</span>&nbsp;<span class="num" id="7968261">0</span><span class="op" id="7968262">;</span>&nbsp;<span class="ident" id="7968264">i</span>&nbsp;<span class="op" id="7968266">&lt;</span>&nbsp;<span class="ident" id="7968268">b</span><span class="op" id="7968269">.</span><span class="ident" id="7968270">N</span><span class="op" id="7968271">;</span>&nbsp;<span class="ident" id="7968273">i</span><span class="op" id="7968274">++</span>&nbsp;<span class="op" id="7968277">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968281">Decode</span><span class="op" id="7968287">(</span><span class="ident" id="7968288">bytes</span><span class="op" id="7968293">.</span><span class="ident" id="7968294">NewReader</span><span class="op" id="7968303">(</span><span class="ident" id="7968304">data</span><span class="op" id="7968308">)</span><span class="op" id="7968309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7968312">}</span><br>
<span class="lineno"></span><span class="op" id="7968314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7968317">func</span>&nbsp;<span class="ident" id="7968322">BenchmarkDecodeBaseline</span><span class="op" id="7968345">(</span><span class="ident" id="7968346">b</span>&nbsp;<span class="op" id="7968348">*</span><span class="ident" id="7968349">testing</span><span class="op" id="7968356">.</span><span class="ident" id="7968357">B</span><span class="op" id="7968358">)</span>&nbsp;<span class="op" id="7968360">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968363">benchmarkDecode</span><span class="op" id="7968378">(</span><span class="ident" id="7968379">b</span><span class="op" id="7968380">,</span>&nbsp;<span class="string" id="7968382">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7968410">)</span><br>
<span class="lineno"></span><span class="op" id="7968412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7968415">func</span>&nbsp;<span class="ident" id="7968420">BenchmarkDecodeProgressive</span><span class="op" id="7968446">(</span><span class="ident" id="7968447">b</span>&nbsp;<span class="op" id="7968449">*</span><span class="ident" id="7968450">testing</span><span class="op" id="7968457">.</span><span class="ident" id="7968458">B</span><span class="op" id="7968459">)</span>&nbsp;<span class="op" id="7968461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7968464">benchmarkDecode</span><span class="op" id="7968479">(</span><span class="ident" id="7968480">b</span><span class="op" id="7968481">,</span>&nbsp;<span class="string" id="7968483">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7968523">)</span><br>
<span class="lineno">270</span><span class="op" id="7968525">}</span>
</div>
</body>
</html>
