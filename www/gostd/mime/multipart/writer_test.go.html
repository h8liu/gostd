<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8119383">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8119438">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8119492">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8119543">package</span>&nbsp;<span class="ident" id="8119551">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8119562">import</span>&nbsp;<span class="op" id="8119569">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8119572">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8119581">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8119594">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8119605">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8119615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8119618">func</span>&nbsp;<span class="ident" id="8119623">TestWriter</span><span class="op" id="8119633">(</span><span class="ident" id="8119634">t</span>&nbsp;<span class="op" id="8119636">*</span><span class="ident" id="8119637">testing</span><span class="op" id="8119644">.</span><span class="ident" id="8119645">T</span><span class="op" id="8119646">)</span>&nbsp;<span class="op" id="8119648">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119651">fileContents</span>&nbsp;<span class="op" id="8119664">:=</span>&nbsp;<span class="op" id="8119667">[</span><span class="op" id="8119668">]</span><span class="builtintype" id="8119669">byte</span><span class="op" id="8119673">(</span><span class="string" id="8119674">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="8119692">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8119696">var</span>&nbsp;<span class="ident" id="8119700">b</span>&nbsp;<span class="ident" id="8119702">bytes</span><span class="op" id="8119707">.</span><span class="ident" id="8119708">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119716">w</span>&nbsp;<span class="op" id="8119718">:=</span>&nbsp;<span class="ident" id="8119721">NewWriter</span><span class="op" id="8119730">(</span><span class="op" id="8119731">&amp;</span><span class="ident" id="8119732">b</span><span class="op" id="8119733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8119736">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119740">part</span><span class="op" id="8119744">,</span>&nbsp;<span class="ident" id="8119746">err</span>&nbsp;<span class="op" id="8119750">:=</span>&nbsp;<span class="ident" id="8119753">w</span><span class="op" id="8119754">.</span><span class="ident" id="8119755">CreateFormFile</span><span class="op" id="8119769">(</span><span class="string" id="8119770">&#34;myfile&#34;</span><span class="op" id="8119778">,</span>&nbsp;<span class="string" id="8119780">&#34;my-file.txt&#34;</span><span class="op" id="8119793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8119797">if</span>&nbsp;<span class="ident" id="8119800">err</span>&nbsp;<span class="op" id="8119804">!=</span>&nbsp;<span class="ident" id="8119807">nil</span>&nbsp;<span class="op" id="8119811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119816">t</span><span class="op" id="8119817">.</span><span class="ident" id="8119818">Fatalf</span><span class="op" id="8119824">(</span><span class="string" id="8119825">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="8119845">,</span>&nbsp;<span class="ident" id="8119847">err</span><span class="op" id="8119850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8119854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119858">part</span><span class="op" id="8119862">.</span><span class="ident" id="8119863">Write</span><span class="op" id="8119868">(</span><span class="ident" id="8119869">fileContents</span><span class="op" id="8119881">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119885">err</span>&nbsp;<span class="op" id="8119889">=</span>&nbsp;<span class="ident" id="8119891">w</span><span class="op" id="8119892">.</span><span class="ident" id="8119893">WriteField</span><span class="op" id="8119903">(</span><span class="string" id="8119904">&#34;key&#34;</span><span class="op" id="8119909">,</span>&nbsp;<span class="string" id="8119911">&#34;val&#34;</span><span class="op" id="8119916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8119920">if</span>&nbsp;<span class="ident" id="8119923">err</span>&nbsp;<span class="op" id="8119927">!=</span>&nbsp;<span class="ident" id="8119930">nil</span>&nbsp;<span class="op" id="8119934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119939">t</span><span class="op" id="8119940">.</span><span class="ident" id="8119941">Fatalf</span><span class="op" id="8119947">(</span><span class="string" id="8119948">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="8119964">,</span>&nbsp;<span class="ident" id="8119966">err</span><span class="op" id="8119969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8119973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8119977">part</span><span class="op" id="8119981">.</span><span class="ident" id="8119982">Write</span><span class="op" id="8119987">(</span><span class="op" id="8119988">[</span><span class="op" id="8119989">]</span><span class="builtintype" id="8119990">byte</span><span class="op" id="8119994">(</span><span class="string" id="8119995">&#34;val&#34;</span><span class="op" id="8120000">)</span><span class="op" id="8120001">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120005">err</span>&nbsp;<span class="op" id="8120009">=</span>&nbsp;<span class="ident" id="8120011">w</span><span class="op" id="8120012">.</span><span class="ident" id="8120013">Close</span><span class="op" id="8120018">(</span><span class="op" id="8120019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120023">if</span>&nbsp;<span class="ident" id="8120026">err</span>&nbsp;<span class="op" id="8120030">!=</span>&nbsp;<span class="ident" id="8120033">nil</span>&nbsp;<span class="op" id="8120037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120042">t</span><span class="op" id="8120043">.</span><span class="ident" id="8120044">Fatalf</span><span class="op" id="8120050">(</span><span class="string" id="8120051">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8120062">,</span>&nbsp;<span class="ident" id="8120064">err</span><span class="op" id="8120067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120075">s</span>&nbsp;<span class="op" id="8120077">:=</span>&nbsp;<span class="ident" id="8120080">b</span><span class="op" id="8120081">.</span><span class="ident" id="8120082">String</span><span class="op" id="8120088">(</span><span class="op" id="8120089">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120093">if</span>&nbsp;<span class="builtinfunc" id="8120096">len</span><span class="op" id="8120099">(</span><span class="ident" id="8120100">s</span><span class="op" id="8120101">)</span>&nbsp;<span class="op" id="8120103">==</span>&nbsp;<span class="num" id="8120106">0</span>&nbsp;<span class="op" id="8120108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120113">t</span><span class="op" id="8120114">.</span><span class="ident" id="8120115">Fatal</span><span class="op" id="8120120">(</span><span class="string" id="8120121">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="8120154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120162">if</span>&nbsp;<span class="ident" id="8120165">s</span><span class="op" id="8120166">[</span><span class="num" id="8120167">0</span><span class="op" id="8120168">]</span>&nbsp;<span class="op" id="8120170">==</span>&nbsp;<span class="string" id="8120173">&#39;\r&#39;</span>&nbsp;<span class="op" id="8120178">||</span>&nbsp;<span class="ident" id="8120181">s</span><span class="op" id="8120182">[</span><span class="num" id="8120183">0</span><span class="op" id="8120184">]</span>&nbsp;<span class="op" id="8120186">==</span>&nbsp;<span class="string" id="8120189">&#39;\n&#39;</span>&nbsp;<span class="op" id="8120194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120199">t</span><span class="op" id="8120200">.</span><span class="ident" id="8120201">Fatal</span><span class="op" id="8120206">(</span><span class="string" id="8120207">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="8120235">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120246">r</span>&nbsp;<span class="op" id="8120248">:=</span>&nbsp;<span class="ident" id="8120251">NewReader</span><span class="op" id="8120260">(</span><span class="op" id="8120261">&amp;</span><span class="ident" id="8120262">b</span><span class="op" id="8120263">,</span>&nbsp;<span class="ident" id="8120265">w</span><span class="op" id="8120266">.</span><span class="ident" id="8120267">Boundary</span><span class="op" id="8120275">(</span><span class="op" id="8120276">)</span><span class="op" id="8120277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120281">part</span><span class="op" id="8120285">,</span>&nbsp;<span class="ident" id="8120287">err</span>&nbsp;<span class="op" id="8120291">:=</span>&nbsp;<span class="ident" id="8120294">r</span><span class="op" id="8120295">.</span><span class="ident" id="8120296">NextPart</span><span class="op" id="8120304">(</span><span class="op" id="8120305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120308">if</span>&nbsp;<span class="ident" id="8120311">err</span>&nbsp;<span class="op" id="8120315">!=</span>&nbsp;<span class="ident" id="8120318">nil</span>&nbsp;<span class="op" id="8120322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120326">t</span><span class="op" id="8120327">.</span><span class="ident" id="8120328">Fatalf</span><span class="op" id="8120334">(</span><span class="string" id="8120335">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="8120347">,</span>&nbsp;<span class="ident" id="8120349">err</span><span class="op" id="8120352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120358">if</span>&nbsp;<span class="ident" id="8120361">g</span><span class="op" id="8120362">,</span>&nbsp;<span class="ident" id="8120364">e</span>&nbsp;<span class="op" id="8120366">:=</span>&nbsp;<span class="ident" id="8120369">part</span><span class="op" id="8120373">.</span><span class="ident" id="8120374">FormName</span><span class="op" id="8120382">(</span><span class="op" id="8120383">)</span><span class="op" id="8120384">,</span>&nbsp;<span class="string" id="8120386">&#34;myfile&#34;</span><span class="op" id="8120394">;</span>&nbsp;<span class="ident" id="8120396">g</span>&nbsp;<span class="op" id="8120398">!=</span>&nbsp;<span class="ident" id="8120401">e</span>&nbsp;<span class="op" id="8120403">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120407">t</span><span class="op" id="8120408">.</span><span class="ident" id="8120409">Errorf</span><span class="op" id="8120415">(</span><span class="string" id="8120416">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8120451">,</span>&nbsp;<span class="ident" id="8120453">e</span><span class="op" id="8120454">,</span>&nbsp;<span class="ident" id="8120456">g</span><span class="op" id="8120457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120463">slurp</span><span class="op" id="8120468">,</span>&nbsp;<span class="ident" id="8120470">err</span>&nbsp;<span class="op" id="8120474">:=</span>&nbsp;<span class="ident" id="8120477">ioutil</span><span class="op" id="8120483">.</span><span class="ident" id="8120484">ReadAll</span><span class="op" id="8120491">(</span><span class="ident" id="8120492">part</span><span class="op" id="8120496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120499">if</span>&nbsp;<span class="ident" id="8120502">err</span>&nbsp;<span class="op" id="8120506">!=</span>&nbsp;<span class="ident" id="8120509">nil</span>&nbsp;<span class="op" id="8120513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120517">t</span><span class="op" id="8120518">.</span><span class="ident" id="8120519">Fatalf</span><span class="op" id="8120525">(</span><span class="string" id="8120526">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="8120547">,</span>&nbsp;<span class="ident" id="8120549">err</span><span class="op" id="8120552">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120558">if</span>&nbsp;<span class="ident" id="8120561">e</span><span class="op" id="8120562">,</span>&nbsp;<span class="ident" id="8120564">g</span>&nbsp;<span class="op" id="8120566">:=</span>&nbsp;<span class="builtintype" id="8120569">string</span><span class="op" id="8120575">(</span><span class="ident" id="8120576">fileContents</span><span class="op" id="8120588">)</span><span class="op" id="8120589">,</span>&nbsp;<span class="builtintype" id="8120591">string</span><span class="op" id="8120597">(</span><span class="ident" id="8120598">slurp</span><span class="op" id="8120603">)</span><span class="op" id="8120604">;</span>&nbsp;<span class="ident" id="8120606">e</span>&nbsp;<span class="op" id="8120608">!=</span>&nbsp;<span class="ident" id="8120611">g</span>&nbsp;<span class="op" id="8120613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120617">t</span><span class="op" id="8120618">.</span><span class="ident" id="8120619">Errorf</span><span class="op" id="8120625">(</span><span class="string" id="8120626">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8120660">,</span>&nbsp;<span class="ident" id="8120662">e</span><span class="op" id="8120663">,</span>&nbsp;<span class="ident" id="8120665">g</span><span class="op" id="8120666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120673">part</span><span class="op" id="8120677">,</span>&nbsp;<span class="ident" id="8120679">err</span>&nbsp;<span class="op" id="8120683">=</span>&nbsp;<span class="ident" id="8120685">r</span><span class="op" id="8120686">.</span><span class="ident" id="8120687">NextPart</span><span class="op" id="8120695">(</span><span class="op" id="8120696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120699">if</span>&nbsp;<span class="ident" id="8120702">err</span>&nbsp;<span class="op" id="8120706">!=</span>&nbsp;<span class="ident" id="8120709">nil</span>&nbsp;<span class="op" id="8120713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120717">t</span><span class="op" id="8120718">.</span><span class="ident" id="8120719">Fatalf</span><span class="op" id="8120725">(</span><span class="string" id="8120726">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="8120738">,</span>&nbsp;<span class="ident" id="8120740">err</span><span class="op" id="8120743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120749">if</span>&nbsp;<span class="ident" id="8120752">g</span><span class="op" id="8120753">,</span>&nbsp;<span class="ident" id="8120755">e</span>&nbsp;<span class="op" id="8120757">:=</span>&nbsp;<span class="ident" id="8120760">part</span><span class="op" id="8120764">.</span><span class="ident" id="8120765">FormName</span><span class="op" id="8120773">(</span><span class="op" id="8120774">)</span><span class="op" id="8120775">,</span>&nbsp;<span class="string" id="8120777">&#34;key&#34;</span><span class="op" id="8120782">;</span>&nbsp;<span class="ident" id="8120784">g</span>&nbsp;<span class="op" id="8120786">!=</span>&nbsp;<span class="ident" id="8120789">e</span>&nbsp;<span class="op" id="8120791">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120795">t</span><span class="op" id="8120796">.</span><span class="ident" id="8120797">Errorf</span><span class="op" id="8120803">(</span><span class="string" id="8120804">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8120839">,</span>&nbsp;<span class="ident" id="8120841">e</span><span class="op" id="8120842">,</span>&nbsp;<span class="ident" id="8120844">g</span><span class="op" id="8120845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120851">slurp</span><span class="op" id="8120856">,</span>&nbsp;<span class="ident" id="8120858">err</span>&nbsp;<span class="op" id="8120862">=</span>&nbsp;<span class="ident" id="8120864">ioutil</span><span class="op" id="8120870">.</span><span class="ident" id="8120871">ReadAll</span><span class="op" id="8120878">(</span><span class="ident" id="8120879">part</span><span class="op" id="8120883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120886">if</span>&nbsp;<span class="ident" id="8120889">err</span>&nbsp;<span class="op" id="8120893">!=</span>&nbsp;<span class="ident" id="8120896">nil</span>&nbsp;<span class="op" id="8120900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120904">t</span><span class="op" id="8120905">.</span><span class="ident" id="8120906">Fatalf</span><span class="op" id="8120912">(</span><span class="string" id="8120913">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="8120934">,</span>&nbsp;<span class="ident" id="8120936">err</span><span class="op" id="8120939">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8120942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8120945">if</span>&nbsp;<span class="ident" id="8120948">e</span><span class="op" id="8120949">,</span>&nbsp;<span class="ident" id="8120951">g</span>&nbsp;<span class="op" id="8120953">:=</span>&nbsp;<span class="string" id="8120956">&#34;val&#34;</span><span class="op" id="8120961">,</span>&nbsp;<span class="builtintype" id="8120963">string</span><span class="op" id="8120969">(</span><span class="ident" id="8120970">slurp</span><span class="op" id="8120975">)</span><span class="op" id="8120976">;</span>&nbsp;<span class="ident" id="8120978">e</span>&nbsp;<span class="op" id="8120980">!=</span>&nbsp;<span class="ident" id="8120983">g</span>&nbsp;<span class="op" id="8120985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8120989">t</span><span class="op" id="8120990">.</span><span class="ident" id="8120991">Errorf</span><span class="op" id="8120997">(</span><span class="string" id="8120998">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8121032">,</span>&nbsp;<span class="ident" id="8121034">e</span><span class="op" id="8121035">,</span>&nbsp;<span class="ident" id="8121037">g</span><span class="op" id="8121038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121045">part</span><span class="op" id="8121049">,</span>&nbsp;<span class="ident" id="8121051">err</span>&nbsp;<span class="op" id="8121055">=</span>&nbsp;<span class="ident" id="8121057">r</span><span class="op" id="8121058">.</span><span class="ident" id="8121059">NextPart</span><span class="op" id="8121067">(</span><span class="op" id="8121068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121071">if</span>&nbsp;<span class="ident" id="8121074">part</span>&nbsp;<span class="op" id="8121079">!=</span>&nbsp;<span class="ident" id="8121082">nil</span>&nbsp;<span class="op" id="8121086">||</span>&nbsp;<span class="ident" id="8121089">err</span>&nbsp;<span class="op" id="8121093">==</span>&nbsp;<span class="ident" id="8121096">nil</span>&nbsp;<span class="op" id="8121100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121104">t</span><span class="op" id="8121105">.</span><span class="ident" id="8121106">Fatalf</span><span class="op" id="8121112">(</span><span class="string" id="8121113">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8121148">,</span>&nbsp;<span class="ident" id="8121150">part</span><span class="op" id="8121154">,</span>&nbsp;<span class="ident" id="8121156">err</span><span class="op" id="8121159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121162">}</span><br>
<span class="lineno"></span><span class="op" id="8121164">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="8121167">func</span>&nbsp;<span class="ident" id="8121172">TestWriterSetBoundary</span><span class="op" id="8121193">(</span><span class="ident" id="8121194">t</span>&nbsp;<span class="op" id="8121196">*</span><span class="ident" id="8121197">testing</span><span class="op" id="8121204">.</span><span class="ident" id="8121205">T</span><span class="op" id="8121206">)</span>&nbsp;<span class="op" id="8121208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121211">var</span>&nbsp;<span class="ident" id="8121215">b</span>&nbsp;<span class="ident" id="8121217">bytes</span><span class="op" id="8121222">.</span><span class="ident" id="8121223">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121231">w</span>&nbsp;<span class="op" id="8121233">:=</span>&nbsp;<span class="ident" id="8121236">NewWriter</span><span class="op" id="8121245">(</span><span class="op" id="8121246">&amp;</span><span class="ident" id="8121247">b</span><span class="op" id="8121248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121251">tests</span>&nbsp;<span class="op" id="8121257">:=</span>&nbsp;<span class="op" id="8121260">[</span><span class="op" id="8121261">]</span><span class="keyword" id="8121262">struct</span>&nbsp;<span class="op" id="8121269">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121273">b</span>&nbsp;&nbsp;<span class="builtintype" id="8121276">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121285">ok</span>&nbsp;<span class="builtintype" id="8121288">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121294">}</span><span class="op" id="8121295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121299">{</span><span class="string" id="8121300">&#34;abc&#34;</span><span class="op" id="8121305">,</span>&nbsp;<span class="builtintype" id="8121307">true</span><span class="op" id="8121311">}</span><span class="op" id="8121312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121316">{</span><span class="string" id="8121317">&#34;&#34;</span><span class="op" id="8121319">,</span>&nbsp;<span class="builtintype" id="8121321">false</span><span class="op" id="8121326">}</span><span class="op" id="8121327">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121331">{</span><span class="string" id="8121332">&#34;ung√ºltig&#34;</span><span class="op" id="8121343">,</span>&nbsp;<span class="builtintype" id="8121345">false</span><span class="op" id="8121350">}</span><span class="op" id="8121351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121355">{</span><span class="string" id="8121356">&#34;!&#34;</span><span class="op" id="8121359">,</span>&nbsp;<span class="builtintype" id="8121361">false</span><span class="op" id="8121366">}</span><span class="op" id="8121367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121371">{</span><span class="ident" id="8121372">strings</span><span class="op" id="8121379">.</span><span class="ident" id="8121380">Repeat</span><span class="op" id="8121386">(</span><span class="string" id="8121387">&#34;x&#34;</span><span class="op" id="8121390">,</span>&nbsp;<span class="num" id="8121392">69</span><span class="op" id="8121394">)</span><span class="op" id="8121395">,</span>&nbsp;<span class="builtintype" id="8121397">true</span><span class="op" id="8121401">}</span><span class="op" id="8121402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121406">{</span><span class="ident" id="8121407">strings</span><span class="op" id="8121414">.</span><span class="ident" id="8121415">Repeat</span><span class="op" id="8121421">(</span><span class="string" id="8121422">&#34;x&#34;</span><span class="op" id="8121425">,</span>&nbsp;<span class="num" id="8121427">70</span><span class="op" id="8121429">)</span><span class="op" id="8121430">,</span>&nbsp;<span class="builtintype" id="8121432">false</span><span class="op" id="8121437">}</span><span class="op" id="8121438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121442">{</span><span class="string" id="8121443">&#34;bad!ascii!&#34;</span><span class="op" id="8121455">,</span>&nbsp;<span class="builtintype" id="8121457">false</span><span class="op" id="8121462">}</span><span class="op" id="8121463">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121467">{</span><span class="string" id="8121468">&#34;my-separator&#34;</span><span class="op" id="8121482">,</span>&nbsp;<span class="builtintype" id="8121484">true</span><span class="op" id="8121488">}</span><span class="op" id="8121489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121495">for</span>&nbsp;<span class="ident" id="8121499">i</span><span class="op" id="8121500">,</span>&nbsp;<span class="ident" id="8121502">tt</span>&nbsp;<span class="op" id="8121505">:=</span>&nbsp;<span class="keyword" id="8121508">range</span>&nbsp;<span class="ident" id="8121514">tests</span>&nbsp;<span class="op" id="8121520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121524">err</span>&nbsp;<span class="op" id="8121528">:=</span>&nbsp;<span class="ident" id="8121531">w</span><span class="op" id="8121532">.</span><span class="ident" id="8121533">SetBoundary</span><span class="op" id="8121544">(</span><span class="ident" id="8121545">tt</span><span class="op" id="8121547">.</span><span class="ident" id="8121548">b</span><span class="op" id="8121549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121553">got</span>&nbsp;<span class="op" id="8121557">:=</span>&nbsp;<span class="ident" id="8121560">err</span>&nbsp;<span class="op" id="8121564">==</span>&nbsp;<span class="ident" id="8121567">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121573">if</span>&nbsp;<span class="ident" id="8121576">got</span>&nbsp;<span class="op" id="8121580">!=</span>&nbsp;<span class="ident" id="8121583">tt</span><span class="op" id="8121585">.</span><span class="ident" id="8121586">ok</span>&nbsp;<span class="op" id="8121589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121594">t</span><span class="op" id="8121595">.</span><span class="ident" id="8121596">Errorf</span><span class="op" id="8121602">(</span><span class="string" id="8121603">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8121639">,</span>&nbsp;<span class="ident" id="8121641">i</span><span class="op" id="8121642">,</span>&nbsp;<span class="ident" id="8121644">tt</span><span class="op" id="8121646">.</span><span class="ident" id="8121647">b</span><span class="op" id="8121648">,</span>&nbsp;<span class="ident" id="8121650">got</span><span class="op" id="8121653">,</span>&nbsp;<span class="ident" id="8121655">err</span><span class="op" id="8121658">,</span>&nbsp;<span class="ident" id="8121660">tt</span><span class="op" id="8121662">.</span><span class="ident" id="8121663">ok</span><span class="op" id="8121665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121669">}</span>&nbsp;<span class="keyword" id="8121671">else</span>&nbsp;<span class="keyword" id="8121676">if</span>&nbsp;<span class="ident" id="8121679">tt</span><span class="op" id="8121681">.</span><span class="ident" id="8121682">ok</span>&nbsp;<span class="op" id="8121685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121690">got</span>&nbsp;<span class="op" id="8121694">:=</span>&nbsp;<span class="ident" id="8121697">w</span><span class="op" id="8121698">.</span><span class="ident" id="8121699">Boundary</span><span class="op" id="8121707">(</span><span class="op" id="8121708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121713">if</span>&nbsp;<span class="ident" id="8121716">got</span>&nbsp;<span class="op" id="8121720">!=</span>&nbsp;<span class="ident" id="8121723">tt</span><span class="op" id="8121725">.</span><span class="ident" id="8121726">b</span>&nbsp;<span class="op" id="8121728">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121734">t</span><span class="op" id="8121735">.</span><span class="ident" id="8121736">Errorf</span><span class="op" id="8121742">(</span><span class="string" id="8121743">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8121767">,</span>&nbsp;<span class="ident" id="8121769">got</span><span class="op" id="8121772">,</span>&nbsp;<span class="ident" id="8121774">tt</span><span class="op" id="8121776">.</span><span class="ident" id="8121777">b</span><span class="op" id="8121778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121793">w</span><span class="op" id="8121794">.</span><span class="ident" id="8121795">Close</span><span class="op" id="8121800">(</span><span class="op" id="8121801">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8121804">if</span>&nbsp;<span class="ident" id="8121807">got</span>&nbsp;<span class="op" id="8121811">:=</span>&nbsp;<span class="ident" id="8121814">b</span><span class="op" id="8121815">.</span><span class="ident" id="8121816">String</span><span class="op" id="8121822">(</span><span class="op" id="8121823">)</span><span class="op" id="8121824">;</span>&nbsp;<span class="op" id="8121826">!</span><span class="ident" id="8121827">strings</span><span class="op" id="8121834">.</span><span class="ident" id="8121835">Contains</span><span class="op" id="8121843">(</span><span class="ident" id="8121844">got</span><span class="op" id="8121847">,</span>&nbsp;<span class="string" id="8121849">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="8121875">)</span>&nbsp;<span class="op" id="8121877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8121881">t</span><span class="op" id="8121882">.</span><span class="ident" id="8121883">Errorf</span><span class="op" id="8121889">(</span><span class="string" id="8121890">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8121932">,</span>&nbsp;<span class="ident" id="8121934">got</span><span class="op" id="8121937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8121940">}</span><br>
<span class="lineno"></span><span class="op" id="8121942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="8121945">func</span>&nbsp;<span class="ident" id="8121950">TestWriterBoundaryGoroutines</span><span class="op" id="8121978">(</span><span class="ident" id="8121979">t</span>&nbsp;<span class="op" id="8121981">*</span><span class="ident" id="8121982">testing</span><span class="op" id="8121989">.</span><span class="ident" id="8121990">T</span><span class="op" id="8121991">)</span>&nbsp;<span class="op" id="8121993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8121996">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8122072">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8122128">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8122189">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8122235">w</span>&nbsp;<span class="op" id="8122237">:=</span>&nbsp;<span class="ident" id="8122240">NewWriter</span><span class="op" id="8122249">(</span><span class="ident" id="8122250">ioutil</span><span class="op" id="8122256">.</span><span class="ident" id="8122257">Discard</span><span class="op" id="8122264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8122267">done</span>&nbsp;<span class="op" id="8122272">:=</span>&nbsp;<span class="builtinfunc" id="8122275">make</span><span class="op" id="8122279">(</span><span class="keyword" id="8122280">chan</span>&nbsp;<span class="builtintype" id="8122285">int</span><span class="op" id="8122288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8122291">go</span>&nbsp;<span class="keyword" id="8122294">func</span><span class="op" id="8122298">(</span><span class="op" id="8122299">)</span>&nbsp;<span class="op" id="8122301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8122305">w</span><span class="op" id="8122306">.</span><span class="ident" id="8122307">CreateFormField</span><span class="op" id="8122322">(</span><span class="string" id="8122323">&#34;foo&#34;</span><span class="op" id="8122328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8122332">done</span>&nbsp;<span class="op" id="8122337">&lt;-</span>&nbsp;<span class="num" id="8122340">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8122343">}</span><span class="op" id="8122344">(</span><span class="op" id="8122345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8122348">w</span><span class="op" id="8122349">.</span><span class="ident" id="8122350">Boundary</span><span class="op" id="8122358">(</span><span class="op" id="8122359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8122362">&lt;-</span><span class="ident" id="8122364">done</span><br>
<span class="lineno"></span><span class="op" id="8122369">}</span>
</div>
</body>
</html>
