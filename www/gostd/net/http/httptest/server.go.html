<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6289611">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6289666">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6289720">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6289771">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6289800">package</span>&nbsp;<span class="ident" id="6289808">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6289818">import</span>&nbsp;<span class="op" id="6289825">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289828">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289842">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289850">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289857">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289864">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289876">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6289882">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6289889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6289892">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="6289963">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="6290026">type</span>&nbsp;<span class="ident" id="6290031">Server</span>&nbsp;<span class="keyword" id="6290038">struct</span>&nbsp;<span class="op" id="6290045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290048">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6290057">string</span>&nbsp;<span class="comment" id="6290064">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290127">Listener</span>&nbsp;<span class="ident" id="6290136">net</span><span class="op" id="6290139">.</span><span class="ident" id="6290140">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290151">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290222">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290294">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290357">TLS</span>&nbsp;<span class="op" id="6290361">*</span><span class="ident" id="6290362">tls</span><span class="op" id="6290365">.</span><span class="ident" id="6290366">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290375">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290438">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290468">Config</span>&nbsp;<span class="op" id="6290475">*</span><span class="ident" id="6290476">http</span><span class="op" id="6290480">.</span><span class="ident" id="6290481">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290490">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290560">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290610">wg</span>&nbsp;<span class="ident" id="6290613">sync</span><span class="op" id="6290617">.</span><span class="ident" id="6290618">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="6290628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6290631">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="6290696">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="6290709">type</span>&nbsp;<span class="ident" id="6290714">historyListener</span>&nbsp;<span class="keyword" id="6290730">struct</span>&nbsp;<span class="op" id="6290737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290740">net</span><span class="op" id="6290743">.</span><span class="ident" id="6290744">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290754">sync</span><span class="op" id="6290758">.</span><span class="ident" id="6290759">Mutex</span>&nbsp;<span class="comment" id="6290765">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290786">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290797">[</span><span class="op" id="6290798">]</span><span class="ident" id="6290799">net</span><span class="op" id="6290802">.</span><span class="ident" id="6290803">Conn</span><br>
<span class="lineno">45</span><span class="op" id="6290808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6290811">func</span>&nbsp;<span class="op" id="6290816">(</span><span class="ident" id="6290817">hs</span>&nbsp;<span class="op" id="6290820">*</span><span class="ident" id="6290821">historyListener</span><span class="op" id="6290836">)</span>&nbsp;<span class="ident" id="6290838">Accept</span><span class="op" id="6290844">(</span><span class="op" id="6290845">)</span>&nbsp;<span class="op" id="6290847">(</span><span class="ident" id="6290848">c</span>&nbsp;<span class="ident" id="6290850">net</span><span class="op" id="6290853">.</span><span class="ident" id="6290854">Conn</span><span class="op" id="6290858">,</span>&nbsp;<span class="ident" id="6290860">err</span>&nbsp;<span class="builtintype" id="6290864">error</span><span class="op" id="6290869">)</span>&nbsp;<span class="op" id="6290871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290874">c</span><span class="op" id="6290875">,</span>&nbsp;<span class="ident" id="6290877">err</span>&nbsp;<span class="op" id="6290881">=</span>&nbsp;<span class="ident" id="6290883">hs</span><span class="op" id="6290885">.</span><span class="ident" id="6290886">Listener</span><span class="op" id="6290894">.</span><span class="ident" id="6290895">Accept</span><span class="op" id="6290901">(</span><span class="op" id="6290902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290905">if</span>&nbsp;<span class="ident" id="6290908">err</span>&nbsp;<span class="op" id="6290912">==</span>&nbsp;<span class="builtintype" id="6290915">nil</span>&nbsp;<span class="op" id="6290919">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290923">hs</span><span class="op" id="6290925">.</span><span class="ident" id="6290926">Lock</span><span class="op" id="6290930">(</span><span class="op" id="6290931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290935">hs</span><span class="op" id="6290937">.</span><span class="ident" id="6290938">history</span>&nbsp;<span class="op" id="6290946">=</span>&nbsp;<span class="builtinfunc" id="6290948">append</span><span class="op" id="6290954">(</span><span class="ident" id="6290955">hs</span><span class="op" id="6290957">.</span><span class="ident" id="6290958">history</span><span class="op" id="6290965">,</span>&nbsp;<span class="ident" id="6290967">c</span><span class="op" id="6290968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290972">hs</span><span class="op" id="6290974">.</span><span class="ident" id="6290975">Unlock</span><span class="op" id="6290981">(</span><span class="op" id="6290982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290988">return</span><br>
<span class="lineno">55</span><span class="op" id="6290995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6290998">func</span>&nbsp;<span class="ident" id="6291003">newLocalListener</span><span class="op" id="6291019">(</span><span class="op" id="6291020">)</span>&nbsp;<span class="ident" id="6291022">net</span><span class="op" id="6291025">.</span><span class="ident" id="6291026">Listener</span>&nbsp;<span class="op" id="6291035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291038">if</span>&nbsp;<span class="op" id="6291041">*</span><span class="ident" id="6291042">serve</span>&nbsp;<span class="op" id="6291048">!=</span>&nbsp;<span class="string" id="6291051">&#34;&#34;</span>&nbsp;<span class="op" id="6291054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291058">l</span><span class="op" id="6291059">,</span>&nbsp;<span class="ident" id="6291061">err</span>&nbsp;<span class="op" id="6291065">:=</span>&nbsp;<span class="ident" id="6291068">net</span><span class="op" id="6291071">.</span><span class="ident" id="6291072">Listen</span><span class="op" id="6291078">(</span><span class="string" id="6291079">&#34;tcp&#34;</span><span class="op" id="6291084">,</span>&nbsp;<span class="op" id="6291086">*</span><span class="ident" id="6291087">serve</span><span class="op" id="6291092">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291096">if</span>&nbsp;<span class="ident" id="6291099">err</span>&nbsp;<span class="op" id="6291103">!=</span>&nbsp;<span class="builtintype" id="6291106">nil</span>&nbsp;<span class="op" id="6291110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6291115">panic</span><span class="op" id="6291120">(</span><span class="ident" id="6291121">fmt</span><span class="op" id="6291124">.</span><span class="ident" id="6291125">Sprintf</span><span class="op" id="6291132">(</span><span class="string" id="6291133">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="6291171">,</span>&nbsp;<span class="op" id="6291173">*</span><span class="ident" id="6291174">serve</span><span class="op" id="6291179">,</span>&nbsp;<span class="ident" id="6291181">err</span><span class="op" id="6291184">)</span><span class="op" id="6291185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291193">return</span>&nbsp;<span class="ident" id="6291200">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291203">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291206">l</span><span class="op" id="6291207">,</span>&nbsp;<span class="ident" id="6291209">err</span>&nbsp;<span class="op" id="6291213">:=</span>&nbsp;<span class="ident" id="6291216">net</span><span class="op" id="6291219">.</span><span class="ident" id="6291220">Listen</span><span class="op" id="6291226">(</span><span class="string" id="6291227">&#34;tcp&#34;</span><span class="op" id="6291232">,</span>&nbsp;<span class="string" id="6291234">&#34;127.0.0.1:0&#34;</span><span class="op" id="6291247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291250">if</span>&nbsp;<span class="ident" id="6291253">err</span>&nbsp;<span class="op" id="6291257">!=</span>&nbsp;<span class="builtintype" id="6291260">nil</span>&nbsp;<span class="op" id="6291264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291268">if</span>&nbsp;<span class="ident" id="6291271">l</span><span class="op" id="6291272">,</span>&nbsp;<span class="ident" id="6291274">err</span>&nbsp;<span class="op" id="6291278">=</span>&nbsp;<span class="ident" id="6291280">net</span><span class="op" id="6291283">.</span><span class="ident" id="6291284">Listen</span><span class="op" id="6291290">(</span><span class="string" id="6291291">&#34;tcp6&#34;</span><span class="op" id="6291297">,</span>&nbsp;<span class="string" id="6291299">&#34;[::1]:0&#34;</span><span class="op" id="6291308">)</span><span class="op" id="6291309">;</span>&nbsp;<span class="ident" id="6291311">err</span>&nbsp;<span class="op" id="6291315">!=</span>&nbsp;<span class="builtintype" id="6291318">nil</span>&nbsp;<span class="op" id="6291322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6291327">panic</span><span class="op" id="6291332">(</span><span class="ident" id="6291333">fmt</span><span class="op" id="6291336">.</span><span class="ident" id="6291337">Sprintf</span><span class="op" id="6291344">(</span><span class="string" id="6291345">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="6291387">,</span>&nbsp;<span class="ident" id="6291389">err</span><span class="op" id="6291392">)</span><span class="op" id="6291393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291397">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291403">return</span>&nbsp;<span class="ident" id="6291410">l</span><br>
<span class="lineno"></span><span class="op" id="6291412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6291415">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="6291470">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6291496">//&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="6291554">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="6291622">var</span>&nbsp;<span class="ident" id="6291626">serve</span>&nbsp;<span class="op" id="6291632">=</span>&nbsp;<span class="ident" id="6291634">flag</span><span class="op" id="6291638">.</span><span class="ident" id="6291639">String</span><span class="op" id="6291645">(</span><span class="string" id="6291646">&#34;httptest.serve&#34;</span><span class="op" id="6291662">,</span>&nbsp;<span class="string" id="6291664">&#34;&#34;</span><span class="op" id="6291666">,</span>&nbsp;<span class="string" id="6291668">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="6291736">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="6291739">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="6291785">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6291849">func</span>&nbsp;<span class="ident" id="6291854">NewServer</span><span class="op" id="6291863">(</span><span class="ident" id="6291864">handler</span>&nbsp;<span class="ident" id="6291872">http</span><span class="op" id="6291876">.</span><span class="ident" id="6291877">Handler</span><span class="op" id="6291884">)</span>&nbsp;<span class="op" id="6291886">*</span><span class="ident" id="6291887">Server</span>&nbsp;<span class="op" id="6291894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291897">ts</span>&nbsp;<span class="op" id="6291900">:=</span>&nbsp;<span class="ident" id="6291903">NewUnstartedServer</span><span class="op" id="6291921">(</span><span class="ident" id="6291922">handler</span><span class="op" id="6291929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291932">ts</span><span class="op" id="6291934">.</span><span class="ident" id="6291935">Start</span><span class="op" id="6291940">(</span><span class="op" id="6291941">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291944">return</span>&nbsp;<span class="ident" id="6291951">ts</span><br>
<span class="lineno"></span><span class="op" id="6291954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6291957">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6292022">//</span><br>
<span class="lineno">90</span><span class="comment" id="6292025">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6292094">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="6292107">//</span><br>
<span class="lineno"></span><span class="comment" id="6292110">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6292174">func</span>&nbsp;<span class="ident" id="6292179">NewUnstartedServer</span><span class="op" id="6292197">(</span><span class="ident" id="6292198">handler</span>&nbsp;<span class="ident" id="6292206">http</span><span class="op" id="6292210">.</span><span class="ident" id="6292211">Handler</span><span class="op" id="6292218">)</span>&nbsp;<span class="op" id="6292220">*</span><span class="ident" id="6292221">Server</span>&nbsp;<span class="op" id="6292228">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292231">return</span>&nbsp;<span class="op" id="6292238">&amp;</span><span class="ident" id="6292239">Server</span><span class="op" id="6292245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292249">Listener</span><span class="op" id="6292257">:</span>&nbsp;<span class="ident" id="6292259">newLocalListener</span><span class="op" id="6292275">(</span><span class="op" id="6292276">)</span><span class="op" id="6292277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292281">Config</span><span class="op" id="6292287">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6292291">&amp;</span><span class="ident" id="6292292">http</span><span class="op" id="6292296">.</span><span class="ident" id="6292297">Server</span><span class="op" id="6292303">{</span><span class="ident" id="6292304">Handler</span><span class="op" id="6292311">:</span>&nbsp;<span class="ident" id="6292313">handler</span><span class="op" id="6292320">}</span><span class="op" id="6292321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292324">}</span><br>
<span class="lineno"></span><span class="op" id="6292326">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6292329">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6292379">func</span>&nbsp;<span class="op" id="6292384">(</span><span class="ident" id="6292385">s</span>&nbsp;<span class="op" id="6292387">*</span><span class="ident" id="6292388">Server</span><span class="op" id="6292394">)</span>&nbsp;<span class="ident" id="6292396">Start</span><span class="op" id="6292401">(</span><span class="op" id="6292402">)</span>&nbsp;<span class="op" id="6292404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292407">if</span>&nbsp;<span class="ident" id="6292410">s</span><span class="op" id="6292411">.</span><span class="ident" id="6292412">URL</span>&nbsp;<span class="op" id="6292416">!=</span>&nbsp;<span class="string" id="6292419">&#34;&#34;</span>&nbsp;<span class="op" id="6292422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6292426">panic</span><span class="op" id="6292431">(</span><span class="string" id="6292432">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6292456">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292462">s</span><span class="op" id="6292463">.</span><span class="ident" id="6292464">Listener</span>&nbsp;<span class="op" id="6292473">=</span>&nbsp;<span class="op" id="6292475">&amp;</span><span class="ident" id="6292476">historyListener</span><span class="op" id="6292491">{</span><span class="ident" id="6292492">Listener</span><span class="op" id="6292500">:</span>&nbsp;<span class="ident" id="6292502">s</span><span class="op" id="6292503">.</span><span class="ident" id="6292504">Listener</span><span class="op" id="6292512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292515">s</span><span class="op" id="6292516">.</span><span class="ident" id="6292517">URL</span>&nbsp;<span class="op" id="6292521">=</span>&nbsp;<span class="string" id="6292523">&#34;http://&#34;</span>&nbsp;<span class="op" id="6292533">+</span>&nbsp;<span class="ident" id="6292535">s</span><span class="op" id="6292536">.</span><span class="ident" id="6292537">Listener</span><span class="op" id="6292545">.</span><span class="ident" id="6292546">Addr</span><span class="op" id="6292550">(</span><span class="op" id="6292551">)</span><span class="op" id="6292552">.</span><span class="ident" id="6292553">String</span><span class="op" id="6292559">(</span><span class="op" id="6292560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292563">s</span><span class="op" id="6292564">.</span><span class="ident" id="6292565">wrapHandler</span><span class="op" id="6292576">(</span><span class="op" id="6292577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292580">go</span>&nbsp;<span class="ident" id="6292583">s</span><span class="op" id="6292584">.</span><span class="ident" id="6292585">Config</span><span class="op" id="6292591">.</span><span class="ident" id="6292592">Serve</span><span class="op" id="6292597">(</span><span class="ident" id="6292598">s</span><span class="op" id="6292599">.</span><span class="ident" id="6292600">Listener</span><span class="op" id="6292608">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292611">if</span>&nbsp;<span class="op" id="6292614">*</span><span class="ident" id="6292615">serve</span>&nbsp;<span class="op" id="6292621">!=</span>&nbsp;<span class="string" id="6292624">&#34;&#34;</span>&nbsp;<span class="op" id="6292627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292631">fmt</span><span class="op" id="6292634">.</span><span class="ident" id="6292635">Fprintln</span><span class="op" id="6292643">(</span><span class="ident" id="6292644">os</span><span class="op" id="6292646">.</span><span class="ident" id="6292647">Stderr</span><span class="op" id="6292653">,</span>&nbsp;<span class="string" id="6292655">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="6292677">,</span>&nbsp;<span class="ident" id="6292679">s</span><span class="op" id="6292680">.</span><span class="ident" id="6292681">URL</span><span class="op" id="6292684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292688">select</span>&nbsp;<span class="op" id="6292695">{</span><span class="op" id="6292696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292699">}</span><br>
<span class="lineno"></span><span class="op" id="6292701">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6292704">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6292764">func</span>&nbsp;<span class="op" id="6292769">(</span><span class="ident" id="6292770">s</span>&nbsp;<span class="op" id="6292772">*</span><span class="ident" id="6292773">Server</span><span class="op" id="6292779">)</span>&nbsp;<span class="ident" id="6292781">StartTLS</span><span class="op" id="6292789">(</span><span class="op" id="6292790">)</span>&nbsp;<span class="op" id="6292792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292795">if</span>&nbsp;<span class="ident" id="6292798">s</span><span class="op" id="6292799">.</span><span class="ident" id="6292800">URL</span>&nbsp;<span class="op" id="6292804">!=</span>&nbsp;<span class="string" id="6292807">&#34;&#34;</span>&nbsp;<span class="op" id="6292810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6292814">panic</span><span class="op" id="6292819">(</span><span class="string" id="6292820">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6292844">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292850">cert</span><span class="op" id="6292854">,</span>&nbsp;<span class="ident" id="6292856">err</span>&nbsp;<span class="op" id="6292860">:=</span>&nbsp;<span class="ident" id="6292863">tls</span><span class="op" id="6292866">.</span><span class="ident" id="6292867">X509KeyPair</span><span class="op" id="6292878">(</span><span class="ident" id="6292879">localhostCert</span><span class="op" id="6292892">,</span>&nbsp;<span class="ident" id="6292894">localhostKey</span><span class="op" id="6292906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292909">if</span>&nbsp;<span class="ident" id="6292912">err</span>&nbsp;<span class="op" id="6292916">!=</span>&nbsp;<span class="builtintype" id="6292919">nil</span>&nbsp;<span class="op" id="6292923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6292927">panic</span><span class="op" id="6292932">(</span><span class="ident" id="6292933">fmt</span><span class="op" id="6292936">.</span><span class="ident" id="6292937">Sprintf</span><span class="op" id="6292944">(</span><span class="string" id="6292945">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="6292973">,</span>&nbsp;<span class="ident" id="6292975">err</span><span class="op" id="6292978">)</span><span class="op" id="6292979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292982">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292986">existingConfig</span>&nbsp;<span class="op" id="6293001">:=</span>&nbsp;<span class="ident" id="6293004">s</span><span class="op" id="6293005">.</span><span class="ident" id="6293006">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293011">s</span><span class="op" id="6293012">.</span><span class="ident" id="6293013">TLS</span>&nbsp;<span class="op" id="6293017">=</span>&nbsp;<span class="builtinfunc" id="6293019">new</span><span class="op" id="6293022">(</span><span class="ident" id="6293023">tls</span><span class="op" id="6293026">.</span><span class="ident" id="6293027">Config</span><span class="op" id="6293033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293036">if</span>&nbsp;<span class="ident" id="6293039">existingConfig</span>&nbsp;<span class="op" id="6293054">!=</span>&nbsp;<span class="builtintype" id="6293057">nil</span>&nbsp;<span class="op" id="6293061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293065">*</span><span class="ident" id="6293066">s</span><span class="op" id="6293067">.</span><span class="ident" id="6293068">TLS</span>&nbsp;<span class="op" id="6293072">=</span>&nbsp;<span class="op" id="6293074">*</span><span class="ident" id="6293075">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293094">if</span>&nbsp;<span class="ident" id="6293097">s</span><span class="op" id="6293098">.</span><span class="ident" id="6293099">TLS</span><span class="op" id="6293102">.</span><span class="ident" id="6293103">NextProtos</span>&nbsp;<span class="op" id="6293114">==</span>&nbsp;<span class="builtintype" id="6293117">nil</span>&nbsp;<span class="op" id="6293121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293125">s</span><span class="op" id="6293126">.</span><span class="ident" id="6293127">TLS</span><span class="op" id="6293130">.</span><span class="ident" id="6293131">NextProtos</span>&nbsp;<span class="op" id="6293142">=</span>&nbsp;<span class="op" id="6293144">[</span><span class="op" id="6293145">]</span><span class="builtintype" id="6293146">string</span><span class="op" id="6293152">{</span><span class="string" id="6293153">&#34;http/1.1&#34;</span><span class="op" id="6293163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293169">if</span>&nbsp;<span class="builtinfunc" id="6293172">len</span><span class="op" id="6293175">(</span><span class="ident" id="6293176">s</span><span class="op" id="6293177">.</span><span class="ident" id="6293178">TLS</span><span class="op" id="6293181">.</span><span class="ident" id="6293182">Certificates</span><span class="op" id="6293194">)</span>&nbsp;<span class="op" id="6293196">==</span>&nbsp;<span class="num" id="6293199">0</span>&nbsp;<span class="op" id="6293201">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293205">s</span><span class="op" id="6293206">.</span><span class="ident" id="6293207">TLS</span><span class="op" id="6293210">.</span><span class="ident" id="6293211">Certificates</span>&nbsp;<span class="op" id="6293224">=</span>&nbsp;<span class="op" id="6293226">[</span><span class="op" id="6293227">]</span><span class="ident" id="6293228">tls</span><span class="op" id="6293231">.</span><span class="ident" id="6293232">Certificate</span><span class="op" id="6293243">{</span><span class="ident" id="6293244">cert</span><span class="op" id="6293248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293254">tlsListener</span>&nbsp;<span class="op" id="6293266">:=</span>&nbsp;<span class="ident" id="6293269">tls</span><span class="op" id="6293272">.</span><span class="ident" id="6293273">NewListener</span><span class="op" id="6293284">(</span><span class="ident" id="6293285">s</span><span class="op" id="6293286">.</span><span class="ident" id="6293287">Listener</span><span class="op" id="6293295">,</span>&nbsp;<span class="ident" id="6293297">s</span><span class="op" id="6293298">.</span><span class="ident" id="6293299">TLS</span><span class="op" id="6293302">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293306">s</span><span class="op" id="6293307">.</span><span class="ident" id="6293308">Listener</span>&nbsp;<span class="op" id="6293317">=</span>&nbsp;<span class="op" id="6293319">&amp;</span><span class="ident" id="6293320">historyListener</span><span class="op" id="6293335">{</span><span class="ident" id="6293336">Listener</span><span class="op" id="6293344">:</span>&nbsp;<span class="ident" id="6293346">tlsListener</span><span class="op" id="6293357">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293360">s</span><span class="op" id="6293361">.</span><span class="ident" id="6293362">URL</span>&nbsp;<span class="op" id="6293366">=</span>&nbsp;<span class="string" id="6293368">&#34;https://&#34;</span>&nbsp;<span class="op" id="6293379">+</span>&nbsp;<span class="ident" id="6293381">s</span><span class="op" id="6293382">.</span><span class="ident" id="6293383">Listener</span><span class="op" id="6293391">.</span><span class="ident" id="6293392">Addr</span><span class="op" id="6293396">(</span><span class="op" id="6293397">)</span><span class="op" id="6293398">.</span><span class="ident" id="6293399">String</span><span class="op" id="6293405">(</span><span class="op" id="6293406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293409">s</span><span class="op" id="6293410">.</span><span class="ident" id="6293411">wrapHandler</span><span class="op" id="6293422">(</span><span class="op" id="6293423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293426">go</span>&nbsp;<span class="ident" id="6293429">s</span><span class="op" id="6293430">.</span><span class="ident" id="6293431">Config</span><span class="op" id="6293437">.</span><span class="ident" id="6293438">Serve</span><span class="op" id="6293443">(</span><span class="ident" id="6293444">s</span><span class="op" id="6293445">.</span><span class="ident" id="6293446">Listener</span><span class="op" id="6293454">)</span><br>
<span class="lineno"></span><span class="op" id="6293456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6293459">func</span>&nbsp;<span class="op" id="6293464">(</span><span class="ident" id="6293465">s</span>&nbsp;<span class="op" id="6293467">*</span><span class="ident" id="6293468">Server</span><span class="op" id="6293474">)</span>&nbsp;<span class="ident" id="6293476">wrapHandler</span><span class="op" id="6293487">(</span><span class="op" id="6293488">)</span>&nbsp;<span class="op" id="6293490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293493">h</span>&nbsp;<span class="op" id="6293495">:=</span>&nbsp;<span class="ident" id="6293498">s</span><span class="op" id="6293499">.</span><span class="ident" id="6293500">Config</span><span class="op" id="6293506">.</span><span class="ident" id="6293507">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293516">if</span>&nbsp;<span class="ident" id="6293519">h</span>&nbsp;<span class="op" id="6293521">==</span>&nbsp;<span class="builtintype" id="6293524">nil</span>&nbsp;<span class="op" id="6293528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293532">h</span>&nbsp;<span class="op" id="6293534">=</span>&nbsp;<span class="ident" id="6293536">http</span><span class="op" id="6293540">.</span><span class="ident" id="6293541">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293558">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293561">s</span><span class="op" id="6293562">.</span><span class="ident" id="6293563">Config</span><span class="op" id="6293569">.</span><span class="ident" id="6293570">Handler</span>&nbsp;<span class="op" id="6293578">=</span>&nbsp;<span class="op" id="6293580">&amp;</span><span class="ident" id="6293581">waitGroupHandler</span><span class="op" id="6293597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293601">s</span><span class="op" id="6293602">:</span>&nbsp;<span class="ident" id="6293604">s</span><span class="op" id="6293605">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293609">h</span><span class="op" id="6293610">:</span>&nbsp;<span class="ident" id="6293612">h</span><span class="op" id="6293613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293616">}</span><br>
<span class="lineno"></span><span class="op" id="6293618">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6293621">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="6293680">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6293744">func</span>&nbsp;<span class="ident" id="6293749">NewTLSServer</span><span class="op" id="6293761">(</span><span class="ident" id="6293762">handler</span>&nbsp;<span class="ident" id="6293770">http</span><span class="op" id="6293774">.</span><span class="ident" id="6293775">Handler</span><span class="op" id="6293782">)</span>&nbsp;<span class="op" id="6293784">*</span><span class="ident" id="6293785">Server</span>&nbsp;<span class="op" id="6293792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293795">ts</span>&nbsp;<span class="op" id="6293798">:=</span>&nbsp;<span class="ident" id="6293801">NewUnstartedServer</span><span class="op" id="6293819">(</span><span class="ident" id="6293820">handler</span><span class="op" id="6293827">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293830">ts</span><span class="op" id="6293832">.</span><span class="ident" id="6293833">StartTLS</span><span class="op" id="6293841">(</span><span class="op" id="6293842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293845">return</span>&nbsp;<span class="ident" id="6293852">ts</span><br>
<span class="lineno"></span><span class="op" id="6293855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6293858">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="6293922">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6293965">func</span>&nbsp;<span class="op" id="6293970">(</span><span class="ident" id="6293971">s</span>&nbsp;<span class="op" id="6293973">*</span><span class="ident" id="6293974">Server</span><span class="op" id="6293980">)</span>&nbsp;<span class="ident" id="6293982">Close</span><span class="op" id="6293987">(</span><span class="op" id="6293988">)</span>&nbsp;<span class="op" id="6293990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293993">s</span><span class="op" id="6293994">.</span><span class="ident" id="6293995">Listener</span><span class="op" id="6294003">.</span><span class="ident" id="6294004">Close</span><span class="op" id="6294009">(</span><span class="op" id="6294010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294013">s</span><span class="op" id="6294014">.</span><span class="ident" id="6294015">wg</span><span class="op" id="6294017">.</span><span class="ident" id="6294018">Wait</span><span class="op" id="6294022">(</span><span class="op" id="6294023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294026">s</span><span class="op" id="6294027">.</span><span class="ident" id="6294028">CloseClientConnections</span><span class="op" id="6294050">(</span><span class="op" id="6294051">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6294054">if</span>&nbsp;<span class="ident" id="6294057">t</span><span class="op" id="6294058">,</span>&nbsp;<span class="ident" id="6294060">ok</span>&nbsp;<span class="op" id="6294063">:=</span>&nbsp;<span class="ident" id="6294066">http</span><span class="op" id="6294070">.</span><span class="ident" id="6294071">DefaultTransport</span><span class="op" id="6294087">.</span><span class="op" id="6294088">(</span><span class="op" id="6294089">*</span><span class="ident" id="6294090">http</span><span class="op" id="6294094">.</span><span class="ident" id="6294095">Transport</span><span class="op" id="6294104">)</span><span class="op" id="6294105">;</span>&nbsp;<span class="ident" id="6294107">ok</span>&nbsp;<span class="op" id="6294110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294114">t</span><span class="op" id="6294115">.</span><span class="ident" id="6294116">CloseIdleConnections</span><span class="op" id="6294136">(</span><span class="op" id="6294137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6294140">}</span><br>
<span class="lineno"></span><span class="op" id="6294142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6294145">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="6294214">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="6294237">func</span>&nbsp;<span class="op" id="6294242">(</span><span class="ident" id="6294243">s</span>&nbsp;<span class="op" id="6294245">*</span><span class="ident" id="6294246">Server</span><span class="op" id="6294252">)</span>&nbsp;<span class="ident" id="6294254">CloseClientConnections</span><span class="op" id="6294276">(</span><span class="op" id="6294277">)</span>&nbsp;<span class="op" id="6294279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294282">hl</span><span class="op" id="6294284">,</span>&nbsp;<span class="ident" id="6294286">ok</span>&nbsp;<span class="op" id="6294289">:=</span>&nbsp;<span class="ident" id="6294292">s</span><span class="op" id="6294293">.</span><span class="ident" id="6294294">Listener</span><span class="op" id="6294302">.</span><span class="op" id="6294303">(</span><span class="op" id="6294304">*</span><span class="ident" id="6294305">historyListener</span><span class="op" id="6294320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6294323">if</span>&nbsp;<span class="op" id="6294326">!</span><span class="ident" id="6294327">ok</span>&nbsp;<span class="op" id="6294330">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6294334">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6294342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294345">hl</span><span class="op" id="6294347">.</span><span class="ident" id="6294348">Lock</span><span class="op" id="6294352">(</span><span class="op" id="6294353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6294356">for</span>&nbsp;<span class="ident" id="6294360">_</span><span class="op" id="6294361">,</span>&nbsp;<span class="ident" id="6294363">conn</span>&nbsp;<span class="op" id="6294368">:=</span>&nbsp;<span class="keyword" id="6294371">range</span>&nbsp;<span class="ident" id="6294377">hl</span><span class="op" id="6294379">.</span><span class="ident" id="6294380">history</span>&nbsp;<span class="op" id="6294388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294392">conn</span><span class="op" id="6294396">.</span><span class="ident" id="6294397">Close</span><span class="op" id="6294402">(</span><span class="op" id="6294403">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6294406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294409">hl</span><span class="op" id="6294411">.</span><span class="ident" id="6294412">Unlock</span><span class="op" id="6294418">(</span><span class="op" id="6294419">)</span><br>
<span class="lineno"></span><span class="op" id="6294421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6294424">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="6294493">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="6294560">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="6294604">type</span>&nbsp;<span class="ident" id="6294609">waitGroupHandler</span>&nbsp;<span class="keyword" id="6294626">struct</span>&nbsp;<span class="op" id="6294633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294636">s</span>&nbsp;<span class="op" id="6294638">*</span><span class="ident" id="6294639">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294647">h</span>&nbsp;<span class="ident" id="6294649">http</span><span class="op" id="6294653">.</span><span class="ident" id="6294654">Handler</span>&nbsp;<span class="comment" id="6294662">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="6294673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6294676">func</span>&nbsp;<span class="op" id="6294681">(</span><span class="ident" id="6294682">h</span>&nbsp;<span class="op" id="6294684">*</span><span class="ident" id="6294685">waitGroupHandler</span><span class="op" id="6294701">)</span>&nbsp;<span class="ident" id="6294703">ServeHTTP</span><span class="op" id="6294712">(</span><span class="ident" id="6294713">w</span>&nbsp;<span class="ident" id="6294715">http</span><span class="op" id="6294719">.</span><span class="ident" id="6294720">ResponseWriter</span><span class="op" id="6294734">,</span>&nbsp;<span class="ident" id="6294736">r</span>&nbsp;<span class="op" id="6294738">*</span><span class="ident" id="6294739">http</span><span class="op" id="6294743">.</span><span class="ident" id="6294744">Request</span><span class="op" id="6294751">)</span>&nbsp;<span class="op" id="6294753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294756">h</span><span class="op" id="6294757">.</span><span class="ident" id="6294758">s</span><span class="op" id="6294759">.</span><span class="ident" id="6294760">wg</span><span class="op" id="6294762">.</span><span class="ident" id="6294763">Add</span><span class="op" id="6294766">(</span><span class="num" id="6294767">1</span><span class="op" id="6294768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6294771">defer</span>&nbsp;<span class="ident" id="6294777">h</span><span class="op" id="6294778">.</span><span class="ident" id="6294779">s</span><span class="op" id="6294780">.</span><span class="ident" id="6294781">wg</span><span class="op" id="6294783">.</span><span class="ident" id="6294784">Done</span><span class="op" id="6294788">(</span><span class="op" id="6294789">)</span>&nbsp;<span class="comment" id="6294791">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6294835">h</span><span class="op" id="6294836">.</span><span class="ident" id="6294837">h</span><span class="op" id="6294838">.</span><span class="ident" id="6294839">ServeHTTP</span><span class="op" id="6294848">(</span><span class="ident" id="6294849">w</span><span class="op" id="6294850">,</span>&nbsp;<span class="ident" id="6294852">r</span><span class="op" id="6294853">)</span><br>
<span class="lineno"></span><span class="op" id="6294855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6294858">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="6294914">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="6294987">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6295006">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6295040">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6295176">var</span>&nbsp;<span class="ident" id="6295180">localhostCert</span>&nbsp;<span class="op" id="6295194">=</span>&nbsp;<span class="op" id="6295196">[</span><span class="op" id="6295197">]</span><span class="builtintype" id="6295198">byte</span><span class="op" id="6295202">(</span><span class="string" id="6295203">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6295774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6295777">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="6295831">var</span>&nbsp;<span class="ident" id="6295835">localhostKey</span>&nbsp;<span class="op" id="6295848">=</span>&nbsp;<span class="op" id="6295850">[</span><span class="op" id="6295851">]</span><span class="builtintype" id="6295852">byte</span><span class="op" id="6295856">(</span><span class="string" id="6295857">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6296355">)</span>
</div>
</body>
</html>
