<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html" class="current">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5474402">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5474457">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5474511">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5474562">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="5474625">package</span>&nbsp;<span class="ident" id="5474633">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5474641">import</span>&nbsp;<span class="op" id="5474648">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474651">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474660">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474667">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474677">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474690">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474704">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474716">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5474722">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5474732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5474735">var</span>&nbsp;<span class="ident" id="5474739">config</span>&nbsp;<span class="op" id="5474746">=</span>&nbsp;<span class="ident" id="5474748">printer</span><span class="op" id="5474755">.</span><span class="ident" id="5474756">Config</span><span class="op" id="5474762">{</span><span class="ident" id="5474763">Mode</span><span class="op" id="5474767">:</span>&nbsp;<span class="ident" id="5474769">printer</span><span class="op" id="5474776">.</span><span class="ident" id="5474777">UseSpaces</span>&nbsp;<span class="op" id="5474787">|</span>&nbsp;<span class="ident" id="5474789">printer</span><span class="op" id="5474796">.</span><span class="ident" id="5474797">TabIndent</span><span class="op" id="5474806">,</span>&nbsp;<span class="ident" id="5474808">Tabwidth</span><span class="op" id="5474816">:</span>&nbsp;<span class="num" id="5474818">8</span><span class="op" id="5474819">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5474822">const</span>&nbsp;<span class="ident" id="5474828">parserMode</span>&nbsp;<span class="op" id="5474839">=</span>&nbsp;<span class="ident" id="5474841">parser</span><span class="op" id="5474847">.</span><span class="ident" id="5474848">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5474863">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="5474939">//</span><br>
<span class="lineno">25</span><span class="comment" id="5474942">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="5475014">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="5475087">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="5475157">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5475229">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="5475298">//</span><br>
<span class="lineno"></span><span class="comment" id="5475301">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="5475372">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="5475444">//</span><br>
<span class="lineno"></span><span class="keyword" id="5475447">func</span>&nbsp;<span class="ident" id="5475452">Node</span><span class="op" id="5475456">(</span><span class="ident" id="5475457">dst</span>&nbsp;<span class="ident" id="5475461">io</span><span class="op" id="5475463">.</span><span class="ident" id="5475464">Writer</span><span class="op" id="5475470">,</span>&nbsp;<span class="ident" id="5475472">fset</span>&nbsp;<span class="op" id="5475477">*</span><span class="ident" id="5475478">token</span><span class="op" id="5475483">.</span><span class="ident" id="5475484">FileSet</span><span class="op" id="5475491">,</span>&nbsp;<span class="ident" id="5475493">node</span>&nbsp;<span class="keyword" id="5475498">interface</span><span class="op" id="5475507">{</span><span class="op" id="5475508">}</span><span class="op" id="5475509">)</span>&nbsp;<span class="builtintype" id="5475511">error</span>&nbsp;<span class="op" id="5475517">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5475520">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475583">var</span>&nbsp;<span class="ident" id="5475587">file</span>&nbsp;<span class="op" id="5475592">*</span><span class="ident" id="5475593">ast</span><span class="op" id="5475596">.</span><span class="ident" id="5475597">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475603">var</span>&nbsp;<span class="ident" id="5475607">cnode</span>&nbsp;<span class="op" id="5475613">*</span><span class="ident" id="5475614">printer</span><span class="op" id="5475621">.</span><span class="ident" id="5475622">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475637">switch</span>&nbsp;<span class="ident" id="5475644">n</span>&nbsp;<span class="op" id="5475646">:=</span>&nbsp;<span class="ident" id="5475649">node</span><span class="op" id="5475653">.</span><span class="op" id="5475654">(</span><span class="keyword" id="5475655">type</span><span class="op" id="5475659">)</span>&nbsp;<span class="op" id="5475661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475664">case</span>&nbsp;<span class="op" id="5475669">*</span><span class="ident" id="5475670">ast</span><span class="op" id="5475673">.</span><span class="ident" id="5475674">File</span><span class="op" id="5475678">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5475682">file</span>&nbsp;<span class="op" id="5475687">=</span>&nbsp;<span class="ident" id="5475689">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475692">case</span>&nbsp;<span class="op" id="5475697">*</span><span class="ident" id="5475698">printer</span><span class="op" id="5475705">.</span><span class="ident" id="5475706">CommentedNode</span><span class="op" id="5475719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475723">if</span>&nbsp;<span class="ident" id="5475726">f</span><span class="op" id="5475727">,</span>&nbsp;<span class="ident" id="5475729">ok</span>&nbsp;<span class="op" id="5475732">:=</span>&nbsp;<span class="ident" id="5475735">n</span><span class="op" id="5475736">.</span><span class="ident" id="5475737">Node</span><span class="op" id="5475741">.</span><span class="op" id="5475742">(</span><span class="op" id="5475743">*</span><span class="ident" id="5475744">ast</span><span class="op" id="5475747">.</span><span class="ident" id="5475748">File</span><span class="op" id="5475752">)</span><span class="op" id="5475753">;</span>&nbsp;<span class="ident" id="5475755">ok</span>&nbsp;<span class="op" id="5475758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5475763">file</span>&nbsp;<span class="op" id="5475768">=</span>&nbsp;<span class="ident" id="5475770">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5475775">cnode</span>&nbsp;<span class="op" id="5475781">=</span>&nbsp;<span class="ident" id="5475783">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5475787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5475790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5475794">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475825">if</span>&nbsp;<span class="ident" id="5475828">file</span>&nbsp;<span class="op" id="5475833">!=</span>&nbsp;<span class="builtintype" id="5475836">nil</span>&nbsp;<span class="op" id="5475840">&amp;&amp;</span>&nbsp;<span class="ident" id="5475843">hasUnsortedImports</span><span class="op" id="5475861">(</span><span class="ident" id="5475862">file</span><span class="op" id="5475866">)</span>&nbsp;<span class="op" id="5475868">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5475872">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5475940">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5475981">var</span>&nbsp;<span class="ident" id="5475985">buf</span>&nbsp;<span class="ident" id="5475989">bytes</span><span class="op" id="5475994">.</span><span class="ident" id="5475995">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5476004">err</span>&nbsp;<span class="op" id="5476008">:=</span>&nbsp;<span class="ident" id="5476011">config</span><span class="op" id="5476017">.</span><span class="ident" id="5476018">Fprint</span><span class="op" id="5476024">(</span><span class="op" id="5476025">&amp;</span><span class="ident" id="5476026">buf</span><span class="op" id="5476029">,</span>&nbsp;<span class="ident" id="5476031">fset</span><span class="op" id="5476035">,</span>&nbsp;<span class="ident" id="5476037">file</span><span class="op" id="5476041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476045">if</span>&nbsp;<span class="ident" id="5476048">err</span>&nbsp;<span class="op" id="5476052">!=</span>&nbsp;<span class="builtintype" id="5476055">nil</span>&nbsp;<span class="op" id="5476059">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476064">return</span>&nbsp;<span class="ident" id="5476071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5476077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5476081">file</span><span class="op" id="5476085">,</span>&nbsp;<span class="ident" id="5476087">err</span>&nbsp;<span class="op" id="5476091">=</span>&nbsp;<span class="ident" id="5476093">parser</span><span class="op" id="5476099">.</span><span class="ident" id="5476100">ParseFile</span><span class="op" id="5476109">(</span><span class="ident" id="5476110">fset</span><span class="op" id="5476114">,</span>&nbsp;<span class="string" id="5476116">&#34;&#34;</span><span class="op" id="5476118">,</span>&nbsp;<span class="ident" id="5476120">buf</span><span class="op" id="5476123">.</span><span class="ident" id="5476124">Bytes</span><span class="op" id="5476129">(</span><span class="op" id="5476130">)</span><span class="op" id="5476131">,</span>&nbsp;<span class="ident" id="5476133">parserMode</span><span class="op" id="5476143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476147">if</span>&nbsp;<span class="ident" id="5476150">err</span>&nbsp;<span class="op" id="5476154">!=</span>&nbsp;<span class="builtintype" id="5476157">nil</span>&nbsp;<span class="op" id="5476161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5476166">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476233">return</span>&nbsp;<span class="ident" id="5476240">fmt</span><span class="op" id="5476243">.</span><span class="ident" id="5476244">Errorf</span><span class="op" id="5476250">(</span><span class="string" id="5476251">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="5476284">,</span>&nbsp;<span class="ident" id="5476286">err</span><span class="op" id="5476289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5476293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5476297">ast</span><span class="op" id="5476300">.</span><span class="ident" id="5476301">SortImports</span><span class="op" id="5476312">(</span><span class="ident" id="5476313">fset</span><span class="op" id="5476317">,</span>&nbsp;<span class="ident" id="5476319">file</span><span class="op" id="5476323">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5476328">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5476367">node</span>&nbsp;<span class="op" id="5476372">=</span>&nbsp;<span class="ident" id="5476374">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476381">if</span>&nbsp;<span class="ident" id="5476384">cnode</span>&nbsp;<span class="op" id="5476390">!=</span>&nbsp;<span class="builtintype" id="5476393">nil</span>&nbsp;<span class="op" id="5476397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5476402">node</span>&nbsp;<span class="op" id="5476407">=</span>&nbsp;<span class="op" id="5476409">&amp;</span><span class="ident" id="5476410">printer</span><span class="op" id="5476417">.</span><span class="ident" id="5476418">CommentedNode</span><span class="op" id="5476431">{</span><span class="ident" id="5476432">Node</span><span class="op" id="5476436">:</span>&nbsp;<span class="ident" id="5476438">file</span><span class="op" id="5476442">,</span>&nbsp;<span class="ident" id="5476444">Comments</span><span class="op" id="5476452">:</span>&nbsp;<span class="ident" id="5476454">cnode</span><span class="op" id="5476459">.</span><span class="ident" id="5476460">Comments</span><span class="op" id="5476468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5476472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5476475">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5476479">return</span>&nbsp;<span class="ident" id="5476486">config</span><span class="op" id="5476492">.</span><span class="ident" id="5476493">Fprint</span><span class="op" id="5476499">(</span><span class="ident" id="5476500">dst</span><span class="op" id="5476503">,</span>&nbsp;<span class="ident" id="5476505">fset</span><span class="op" id="5476509">,</span>&nbsp;<span class="ident" id="5476511">node</span><span class="op" id="5476515">)</span><br>
<span class="lineno"></span><span class="op" id="5476517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5476520">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="5476590">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="5476660">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="5476731">//</span><br>
<span class="lineno"></span><span class="comment" id="5476734">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5476808">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="5476884">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5476961">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="5477042">//</span><br>
<span class="lineno"></span><span class="keyword" id="5477045">func</span>&nbsp;<span class="ident" id="5477050">Source</span><span class="op" id="5477056">(</span><span class="ident" id="5477057">src</span>&nbsp;<span class="op" id="5477061">[</span><span class="op" id="5477062">]</span><span class="builtintype" id="5477063">byte</span><span class="op" id="5477067">)</span>&nbsp;<span class="op" id="5477069">(</span><span class="op" id="5477070">[</span><span class="op" id="5477071">]</span><span class="builtintype" id="5477072">byte</span><span class="op" id="5477076">,</span>&nbsp;<span class="builtintype" id="5477078">error</span><span class="op" id="5477083">)</span>&nbsp;<span class="op" id="5477085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5477088">fset</span>&nbsp;<span class="op" id="5477093">:=</span>&nbsp;<span class="ident" id="5477096">token</span><span class="op" id="5477101">.</span><span class="ident" id="5477102">NewFileSet</span><span class="op" id="5477112">(</span><span class="op" id="5477113">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5477116">file</span><span class="op" id="5477120">,</span>&nbsp;<span class="ident" id="5477122">sourceAdj</span><span class="op" id="5477131">,</span>&nbsp;<span class="ident" id="5477133">indentAdj</span><span class="op" id="5477142">,</span>&nbsp;<span class="ident" id="5477144">err</span>&nbsp;<span class="op" id="5477148">:=</span>&nbsp;<span class="ident" id="5477151">parse</span><span class="op" id="5477156">(</span><span class="ident" id="5477157">fset</span><span class="op" id="5477161">,</span>&nbsp;<span class="string" id="5477163">&#34;&#34;</span><span class="op" id="5477165">,</span>&nbsp;<span class="ident" id="5477167">src</span><span class="op" id="5477170">,</span>&nbsp;<span class="builtintype" id="5477172">true</span><span class="op" id="5477176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477179">if</span>&nbsp;<span class="ident" id="5477182">err</span>&nbsp;<span class="op" id="5477186">!=</span>&nbsp;<span class="builtintype" id="5477189">nil</span>&nbsp;<span class="op" id="5477193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477197">return</span>&nbsp;<span class="builtintype" id="5477204">nil</span><span class="op" id="5477207">,</span>&nbsp;<span class="ident" id="5477209">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5477214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477218">if</span>&nbsp;<span class="ident" id="5477221">sourceAdj</span>&nbsp;<span class="op" id="5477231">==</span>&nbsp;<span class="builtintype" id="5477234">nil</span>&nbsp;<span class="op" id="5477238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477242">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477269">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5477312">ast</span><span class="op" id="5477315">.</span><span class="ident" id="5477316">SortImports</span><span class="op" id="5477327">(</span><span class="ident" id="5477328">fset</span><span class="op" id="5477332">,</span>&nbsp;<span class="ident" id="5477334">file</span><span class="op" id="5477338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5477341">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477345">return</span>&nbsp;<span class="ident" id="5477352">format</span><span class="op" id="5477358">(</span><span class="ident" id="5477359">fset</span><span class="op" id="5477363">,</span>&nbsp;<span class="ident" id="5477365">file</span><span class="op" id="5477369">,</span>&nbsp;<span class="ident" id="5477371">sourceAdj</span><span class="op" id="5477380">,</span>&nbsp;<span class="ident" id="5477382">indentAdj</span><span class="op" id="5477391">,</span>&nbsp;<span class="ident" id="5477393">src</span><span class="op" id="5477396">,</span>&nbsp;<span class="ident" id="5477398">config</span><span class="op" id="5477404">)</span><br>
<span class="lineno"></span><span class="op" id="5477406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5477409">func</span>&nbsp;<span class="ident" id="5477414">hasUnsortedImports</span><span class="op" id="5477432">(</span><span class="ident" id="5477433">file</span>&nbsp;<span class="op" id="5477438">*</span><span class="ident" id="5477439">ast</span><span class="op" id="5477442">.</span><span class="ident" id="5477443">File</span><span class="op" id="5477447">)</span>&nbsp;<span class="builtintype" id="5477449">bool</span>&nbsp;<span class="op" id="5477454">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477457">for</span>&nbsp;<span class="ident" id="5477461">_</span><span class="op" id="5477462">,</span>&nbsp;<span class="ident" id="5477464">d</span>&nbsp;<span class="op" id="5477466">:=</span>&nbsp;<span class="keyword" id="5477469">range</span>&nbsp;<span class="ident" id="5477475">file</span><span class="op" id="5477479">.</span><span class="ident" id="5477480">Decls</span>&nbsp;<span class="op" id="5477486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5477490">d</span><span class="op" id="5477491">,</span>&nbsp;<span class="ident" id="5477493">ok</span>&nbsp;<span class="op" id="5477496">:=</span>&nbsp;<span class="ident" id="5477499">d</span><span class="op" id="5477500">.</span><span class="op" id="5477501">(</span><span class="op" id="5477502">*</span><span class="ident" id="5477503">ast</span><span class="op" id="5477506">.</span><span class="ident" id="5477507">GenDecl</span><span class="op" id="5477514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477518">if</span>&nbsp;<span class="op" id="5477521">!</span><span class="ident" id="5477522">ok</span>&nbsp;<span class="op" id="5477525">||</span>&nbsp;<span class="ident" id="5477528">d</span><span class="op" id="5477529">.</span><span class="ident" id="5477530">Tok</span>&nbsp;<span class="op" id="5477534">!=</span>&nbsp;<span class="ident" id="5477537">token</span><span class="op" id="5477542">.</span><span class="ident" id="5477543">IMPORT</span>&nbsp;<span class="op" id="5477550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477555">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477603">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477635">return</span>&nbsp;<span class="builtintype" id="5477642">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5477650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477654">if</span>&nbsp;<span class="ident" id="5477657">d</span><span class="op" id="5477658">.</span><span class="ident" id="5477659">Lparen</span><span class="op" id="5477665">.</span><span class="ident" id="5477666">IsValid</span><span class="op" id="5477673">(</span><span class="op" id="5477674">)</span>&nbsp;<span class="op" id="5477676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477681">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477736">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477793">return</span>&nbsp;<span class="builtintype" id="5477800">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5477807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5477811">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5477856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5477859">return</span>&nbsp;<span class="builtintype" id="5477866">false</span><br>
<span class="lineno">115</span><span class="op" id="5477872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5477875">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="5477955">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="5477976">//</span><br>
<span class="lineno">120</span><span class="comment" id="5477979">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5478050">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="5478117">//</span><br>
<span class="lineno"></span><span class="comment" id="5478120">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5478177">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="5478234">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="5478290">func</span>&nbsp;<span class="ident" id="5478295">parse</span><span class="op" id="5478300">(</span><span class="ident" id="5478301">fset</span>&nbsp;<span class="op" id="5478306">*</span><span class="ident" id="5478307">token</span><span class="op" id="5478312">.</span><span class="ident" id="5478313">FileSet</span><span class="op" id="5478320">,</span>&nbsp;<span class="ident" id="5478322">filename</span>&nbsp;<span class="builtintype" id="5478331">string</span><span class="op" id="5478337">,</span>&nbsp;<span class="ident" id="5478339">src</span>&nbsp;<span class="op" id="5478343">[</span><span class="op" id="5478344">]</span><span class="builtintype" id="5478345">byte</span><span class="op" id="5478349">,</span>&nbsp;<span class="ident" id="5478351">fragmentOk</span>&nbsp;<span class="builtintype" id="5478362">bool</span><span class="op" id="5478366">)</span>&nbsp;<span class="op" id="5478368">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5478371">file</span>&nbsp;<span class="op" id="5478376">*</span><span class="ident" id="5478377">ast</span><span class="op" id="5478380">.</span><span class="ident" id="5478381">File</span><span class="op" id="5478385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5478388">sourceAdj</span>&nbsp;<span class="keyword" id="5478398">func</span><span class="op" id="5478402">(</span><span class="ident" id="5478403">src</span>&nbsp;<span class="op" id="5478407">[</span><span class="op" id="5478408">]</span><span class="builtintype" id="5478409">byte</span><span class="op" id="5478413">,</span>&nbsp;<span class="ident" id="5478415">indent</span>&nbsp;<span class="builtintype" id="5478422">int</span><span class="op" id="5478425">)</span>&nbsp;<span class="op" id="5478427">[</span><span class="op" id="5478428">]</span><span class="builtintype" id="5478429">byte</span><span class="op" id="5478433">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5478436">indentAdj</span>&nbsp;<span class="builtintype" id="5478446">int</span><span class="op" id="5478449">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5478452">err</span>&nbsp;<span class="builtintype" id="5478456">error</span><span class="op" id="5478461">,</span><br>
<span class="lineno"></span><span class="op" id="5478463">)</span>&nbsp;<span class="op" id="5478465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478468">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5478498">file</span><span class="op" id="5478502">,</span>&nbsp;<span class="ident" id="5478504">err</span>&nbsp;<span class="op" id="5478508">=</span>&nbsp;<span class="ident" id="5478510">parser</span><span class="op" id="5478516">.</span><span class="ident" id="5478517">ParseFile</span><span class="op" id="5478526">(</span><span class="ident" id="5478527">fset</span><span class="op" id="5478531">,</span>&nbsp;<span class="ident" id="5478533">filename</span><span class="op" id="5478541">,</span>&nbsp;<span class="ident" id="5478543">src</span><span class="op" id="5478546">,</span>&nbsp;<span class="ident" id="5478548">parserMode</span><span class="op" id="5478558">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478561">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478652">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478714">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5478781">if</span>&nbsp;<span class="ident" id="5478784">err</span>&nbsp;<span class="op" id="5478788">==</span>&nbsp;<span class="builtintype" id="5478791">nil</span>&nbsp;<span class="op" id="5478795">||</span>&nbsp;<span class="op" id="5478798">!</span><span class="ident" id="5478799">fragmentOk</span>&nbsp;<span class="op" id="5478810">||</span>&nbsp;<span class="op" id="5478813">!</span><span class="ident" id="5478814">strings</span><span class="op" id="5478821">.</span><span class="ident" id="5478822">Contains</span><span class="op" id="5478830">(</span><span class="ident" id="5478831">err</span><span class="op" id="5478834">.</span><span class="ident" id="5478835">Error</span><span class="op" id="5478840">(</span><span class="op" id="5478841">)</span><span class="op" id="5478842">,</span>&nbsp;<span class="string" id="5478844">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="5478864">)</span>&nbsp;<span class="op" id="5478866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5478870">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5478878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478882">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478939">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5478974">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479036">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479071">psrc</span>&nbsp;<span class="op" id="5479076">:=</span>&nbsp;<span class="builtinfunc" id="5479079">append</span><span class="op" id="5479085">(</span><span class="op" id="5479086">[</span><span class="op" id="5479087">]</span><span class="builtintype" id="5479088">byte</span><span class="op" id="5479092">(</span><span class="string" id="5479093">&#34;package&nbsp;p;&#34;</span><span class="op" id="5479105">)</span><span class="op" id="5479106">,</span>&nbsp;<span class="ident" id="5479108">src</span><span class="op" id="5479111">...</span><span class="op" id="5479114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479117">file</span><span class="op" id="5479121">,</span>&nbsp;<span class="ident" id="5479123">err</span>&nbsp;<span class="op" id="5479127">=</span>&nbsp;<span class="ident" id="5479129">parser</span><span class="op" id="5479135">.</span><span class="ident" id="5479136">ParseFile</span><span class="op" id="5479145">(</span><span class="ident" id="5479146">fset</span><span class="op" id="5479150">,</span>&nbsp;<span class="ident" id="5479152">filename</span><span class="op" id="5479160">,</span>&nbsp;<span class="ident" id="5479162">psrc</span><span class="op" id="5479166">,</span>&nbsp;<span class="ident" id="5479168">parserMode</span><span class="op" id="5479178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5479181">if</span>&nbsp;<span class="ident" id="5479184">err</span>&nbsp;<span class="op" id="5479188">==</span>&nbsp;<span class="builtintype" id="5479191">nil</span>&nbsp;<span class="op" id="5479195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479199">sourceAdj</span>&nbsp;<span class="op" id="5479209">=</span>&nbsp;<span class="keyword" id="5479211">func</span><span class="op" id="5479215">(</span><span class="ident" id="5479216">src</span>&nbsp;<span class="op" id="5479220">[</span><span class="op" id="5479221">]</span><span class="builtintype" id="5479222">byte</span><span class="op" id="5479226">,</span>&nbsp;<span class="ident" id="5479228">indent</span>&nbsp;<span class="builtintype" id="5479235">int</span><span class="op" id="5479238">)</span>&nbsp;<span class="op" id="5479240">[</span><span class="op" id="5479241">]</span><span class="builtintype" id="5479242">byte</span>&nbsp;<span class="op" id="5479247">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479252">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479285">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479325">src</span>&nbsp;<span class="op" id="5479329">=</span>&nbsp;<span class="ident" id="5479331">src</span><span class="op" id="5479334">[</span><span class="ident" id="5479335">indent</span><span class="op" id="5479341">+</span><span class="builtinfunc" id="5479342">len</span><span class="op" id="5479345">(</span><span class="string" id="5479346">&#34;package&nbsp;p\n&#34;</span><span class="op" id="5479359">)</span><span class="op" id="5479360">:</span><span class="op" id="5479361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5479366">return</span>&nbsp;<span class="ident" id="5479373">bytes</span><span class="op" id="5479378">.</span><span class="ident" id="5479379">TrimSpace</span><span class="op" id="5479388">(</span><span class="ident" id="5479389">src</span><span class="op" id="5479392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5479396">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5479400">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5479408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479411">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479472">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479530">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5479570">if</span>&nbsp;<span class="op" id="5479573">!</span><span class="ident" id="5479574">strings</span><span class="op" id="5479581">.</span><span class="ident" id="5479582">Contains</span><span class="op" id="5479590">(</span><span class="ident" id="5479591">err</span><span class="op" id="5479594">.</span><span class="ident" id="5479595">Error</span><span class="op" id="5479600">(</span><span class="op" id="5479601">)</span><span class="op" id="5479602">,</span>&nbsp;<span class="string" id="5479604">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="5479626">)</span>&nbsp;<span class="op" id="5479628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5479632">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5479640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479644">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479699">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479754">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479811">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5479873">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479908">fsrc</span>&nbsp;<span class="op" id="5479913">:=</span>&nbsp;<span class="builtinfunc" id="5479916">append</span><span class="op" id="5479922">(</span><span class="builtinfunc" id="5479923">append</span><span class="op" id="5479929">(</span><span class="op" id="5479930">[</span><span class="op" id="5479931">]</span><span class="builtintype" id="5479932">byte</span><span class="op" id="5479936">(</span><span class="string" id="5479937">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5479960">)</span><span class="op" id="5479961">,</span>&nbsp;<span class="ident" id="5479963">src</span><span class="op" id="5479966">...</span><span class="op" id="5479969">)</span><span class="op" id="5479970">,</span>&nbsp;<span class="string" id="5479972">&#39;\n&#39;</span><span class="op" id="5479976">,</span>&nbsp;<span class="string" id="5479978">&#39;}&#39;</span><span class="op" id="5479981">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5479984">file</span><span class="op" id="5479988">,</span>&nbsp;<span class="ident" id="5479990">err</span>&nbsp;<span class="op" id="5479994">=</span>&nbsp;<span class="ident" id="5479996">parser</span><span class="op" id="5480002">.</span><span class="ident" id="5480003">ParseFile</span><span class="op" id="5480012">(</span><span class="ident" id="5480013">fset</span><span class="op" id="5480017">,</span>&nbsp;<span class="ident" id="5480019">filename</span><span class="op" id="5480027">,</span>&nbsp;<span class="ident" id="5480029">fsrc</span><span class="op" id="5480033">,</span>&nbsp;<span class="ident" id="5480035">parserMode</span><span class="op" id="5480045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5480048">if</span>&nbsp;<span class="ident" id="5480051">err</span>&nbsp;<span class="op" id="5480055">==</span>&nbsp;<span class="builtintype" id="5480058">nil</span>&nbsp;<span class="op" id="5480062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480066">sourceAdj</span>&nbsp;<span class="op" id="5480076">=</span>&nbsp;<span class="keyword" id="5480078">func</span><span class="op" id="5480082">(</span><span class="ident" id="5480083">src</span>&nbsp;<span class="op" id="5480087">[</span><span class="op" id="5480088">]</span><span class="builtintype" id="5480089">byte</span><span class="op" id="5480093">,</span>&nbsp;<span class="ident" id="5480095">indent</span>&nbsp;<span class="builtintype" id="5480102">int</span><span class="op" id="5480105">)</span>&nbsp;<span class="op" id="5480107">[</span><span class="op" id="5480108">]</span><span class="builtintype" id="5480109">byte</span>&nbsp;<span class="op" id="5480114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480119">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5480154">if</span>&nbsp;<span class="ident" id="5480157">indent</span>&nbsp;<span class="op" id="5480164">&lt;</span>&nbsp;<span class="num" id="5480166">0</span>&nbsp;<span class="op" id="5480168">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480174">indent</span>&nbsp;<span class="op" id="5480181">=</span>&nbsp;<span class="num" id="5480183">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5480188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480193">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480220">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480262">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480331">src</span>&nbsp;<span class="op" id="5480335">=</span>&nbsp;<span class="ident" id="5480337">src</span><span class="op" id="5480340">[</span><span class="num" id="5480341">2</span><span class="op" id="5480342">*</span><span class="ident" id="5480343">indent</span><span class="op" id="5480349">+</span><span class="builtinfunc" id="5480350">len</span><span class="op" id="5480353">(</span><span class="string" id="5480354">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="5480379">)</span><span class="op" id="5480380">:</span><span class="op" id="5480381">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480386">src</span>&nbsp;<span class="op" id="5480390">=</span>&nbsp;<span class="ident" id="5480392">src</span><span class="op" id="5480395">[</span><span class="op" id="5480396">:</span><span class="builtinfunc" id="5480397">len</span><span class="op" id="5480400">(</span><span class="ident" id="5480401">src</span><span class="op" id="5480404">)</span><span class="op" id="5480405">-</span><span class="op" id="5480406">(</span><span class="ident" id="5480407">indent</span><span class="op" id="5480413">+</span><span class="builtinfunc" id="5480414">len</span><span class="op" id="5480417">(</span><span class="string" id="5480418">&#34;\n}\n&#34;</span><span class="op" id="5480425">)</span><span class="op" id="5480426">)</span><span class="op" id="5480427">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5480432">return</span>&nbsp;<span class="ident" id="5480439">bytes</span><span class="op" id="5480444">.</span><span class="ident" id="5480445">TrimSpace</span><span class="op" id="5480454">(</span><span class="ident" id="5480455">src</span><span class="op" id="5480458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5480462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480466">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480524">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480557">indentAdj</span>&nbsp;<span class="op" id="5480567">=</span>&nbsp;<span class="op" id="5480569">-</span><span class="num" id="5480570">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5480573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480577">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5480611">return</span><br>
<span class="lineno"></span><span class="op" id="5480618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5480621">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="5480691">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="5480760">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="5480778">func</span>&nbsp;<span class="ident" id="5480783">format</span><span class="op" id="5480789">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480792">fset</span>&nbsp;<span class="op" id="5480797">*</span><span class="ident" id="5480798">token</span><span class="op" id="5480803">.</span><span class="ident" id="5480804">FileSet</span><span class="op" id="5480811">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480814">file</span>&nbsp;<span class="op" id="5480819">*</span><span class="ident" id="5480820">ast</span><span class="op" id="5480823">.</span><span class="ident" id="5480824">File</span><span class="op" id="5480828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480831">sourceAdj</span>&nbsp;<span class="keyword" id="5480841">func</span><span class="op" id="5480845">(</span><span class="ident" id="5480846">src</span>&nbsp;<span class="op" id="5480850">[</span><span class="op" id="5480851">]</span><span class="builtintype" id="5480852">byte</span><span class="op" id="5480856">,</span>&nbsp;<span class="ident" id="5480858">indent</span>&nbsp;<span class="builtintype" id="5480865">int</span><span class="op" id="5480868">)</span>&nbsp;<span class="op" id="5480870">[</span><span class="op" id="5480871">]</span><span class="builtintype" id="5480872">byte</span><span class="op" id="5480876">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480879">indentAdj</span>&nbsp;<span class="builtintype" id="5480889">int</span><span class="op" id="5480892">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480895">src</span>&nbsp;<span class="op" id="5480899">[</span><span class="op" id="5480900">]</span><span class="builtintype" id="5480901">byte</span><span class="op" id="5480905">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5480908">cfg</span>&nbsp;<span class="ident" id="5480912">printer</span><span class="op" id="5480919">.</span><span class="ident" id="5480920">Config</span><span class="op" id="5480926">,</span><br>
<span class="lineno"></span><span class="op" id="5480928">)</span>&nbsp;<span class="op" id="5480930">(</span><span class="op" id="5480931">[</span><span class="op" id="5480932">]</span><span class="builtintype" id="5480933">byte</span><span class="op" id="5480937">,</span>&nbsp;<span class="builtintype" id="5480939">error</span><span class="op" id="5480944">)</span>&nbsp;<span class="op" id="5480946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5480949">if</span>&nbsp;<span class="ident" id="5480952">sourceAdj</span>&nbsp;<span class="op" id="5480962">==</span>&nbsp;<span class="builtintype" id="5480965">nil</span>&nbsp;<span class="op" id="5480969">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5480973">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481000">var</span>&nbsp;<span class="ident" id="5481004">buf</span>&nbsp;<span class="ident" id="5481008">bytes</span><span class="op" id="5481013">.</span><span class="ident" id="5481014">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481023">err</span>&nbsp;<span class="op" id="5481027">:=</span>&nbsp;<span class="ident" id="5481030">cfg</span><span class="op" id="5481033">.</span><span class="ident" id="5481034">Fprint</span><span class="op" id="5481040">(</span><span class="op" id="5481041">&amp;</span><span class="ident" id="5481042">buf</span><span class="op" id="5481045">,</span>&nbsp;<span class="ident" id="5481047">fset</span><span class="op" id="5481051">,</span>&nbsp;<span class="ident" id="5481053">file</span><span class="op" id="5481057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481061">if</span>&nbsp;<span class="ident" id="5481064">err</span>&nbsp;<span class="op" id="5481068">!=</span>&nbsp;<span class="builtintype" id="5481071">nil</span>&nbsp;<span class="op" id="5481075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481080">return</span>&nbsp;<span class="builtintype" id="5481087">nil</span><span class="op" id="5481090">,</span>&nbsp;<span class="ident" id="5481092">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481102">return</span>&nbsp;<span class="ident" id="5481109">buf</span><span class="op" id="5481112">.</span><span class="ident" id="5481113">Bytes</span><span class="op" id="5481118">(</span><span class="op" id="5481119">)</span><span class="op" id="5481120">,</span>&nbsp;<span class="builtintype" id="5481122">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481131">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481156">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481197">i</span><span class="op" id="5481198">,</span>&nbsp;<span class="ident" id="5481200">j</span>&nbsp;<span class="op" id="5481202">:=</span>&nbsp;<span class="num" id="5481205">0</span><span class="op" id="5481206">,</span>&nbsp;<span class="num" id="5481208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481211">for</span>&nbsp;<span class="ident" id="5481215">j</span>&nbsp;<span class="op" id="5481217">&lt;</span>&nbsp;<span class="builtinfunc" id="5481219">len</span><span class="op" id="5481222">(</span><span class="ident" id="5481223">src</span><span class="op" id="5481226">)</span>&nbsp;<span class="op" id="5481228">&amp;&amp;</span>&nbsp;<span class="ident" id="5481231">isSpace</span><span class="op" id="5481238">(</span><span class="ident" id="5481239">src</span><span class="op" id="5481242">[</span><span class="ident" id="5481243">j</span><span class="op" id="5481244">]</span><span class="op" id="5481245">)</span>&nbsp;<span class="op" id="5481247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481251">if</span>&nbsp;<span class="ident" id="5481254">src</span><span class="op" id="5481257">[</span><span class="ident" id="5481258">j</span><span class="op" id="5481259">]</span>&nbsp;<span class="op" id="5481261">==</span>&nbsp;<span class="string" id="5481264">&#39;\n&#39;</span>&nbsp;<span class="op" id="5481269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481274">i</span>&nbsp;<span class="op" id="5481276">=</span>&nbsp;<span class="ident" id="5481278">j</span>&nbsp;<span class="op" id="5481280">+</span>&nbsp;<span class="num" id="5481282">1</span>&nbsp;<span class="comment" id="5481284">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481335">j</span><span class="op" id="5481336">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481343">var</span>&nbsp;<span class="ident" id="5481347">res</span>&nbsp;<span class="op" id="5481351">[</span><span class="op" id="5481352">]</span><span class="builtintype" id="5481353">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481359">res</span>&nbsp;<span class="op" id="5481363">=</span>&nbsp;<span class="builtinfunc" id="5481365">append</span><span class="op" id="5481371">(</span><span class="ident" id="5481372">res</span><span class="op" id="5481375">,</span>&nbsp;<span class="ident" id="5481377">src</span><span class="op" id="5481380">[</span><span class="op" id="5481381">:</span><span class="ident" id="5481382">i</span><span class="op" id="5481383">]</span><span class="op" id="5481384">...</span><span class="op" id="5481387">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481391">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481449">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481498">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481541">indent</span>&nbsp;<span class="op" id="5481548">:=</span>&nbsp;<span class="num" id="5481551">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481554">hasSpace</span>&nbsp;<span class="op" id="5481563">:=</span>&nbsp;<span class="builtintype" id="5481566">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481573">for</span>&nbsp;<span class="ident" id="5481577">_</span><span class="op" id="5481578">,</span>&nbsp;<span class="ident" id="5481580">b</span>&nbsp;<span class="op" id="5481582">:=</span>&nbsp;<span class="keyword" id="5481585">range</span>&nbsp;<span class="ident" id="5481591">src</span><span class="op" id="5481594">[</span><span class="ident" id="5481595">i</span><span class="op" id="5481596">:</span><span class="ident" id="5481597">j</span><span class="op" id="5481598">]</span>&nbsp;<span class="op" id="5481600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481604">switch</span>&nbsp;<span class="ident" id="5481611">b</span>&nbsp;<span class="op" id="5481613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481617">case</span>&nbsp;<span class="string" id="5481622">&#39;&nbsp;&#39;</span><span class="op" id="5481625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481630">hasSpace</span>&nbsp;<span class="op" id="5481639">=</span>&nbsp;<span class="builtintype" id="5481641">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481648">case</span>&nbsp;<span class="string" id="5481653">&#39;\t&#39;</span><span class="op" id="5481657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481662">indent</span><span class="op" id="5481668">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481679">if</span>&nbsp;<span class="ident" id="5481682">indent</span>&nbsp;<span class="op" id="5481689">==</span>&nbsp;<span class="num" id="5481692">0</span>&nbsp;<span class="op" id="5481694">&amp;&amp;</span>&nbsp;<span class="ident" id="5481697">hasSpace</span>&nbsp;<span class="op" id="5481706">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481710">indent</span>&nbsp;<span class="op" id="5481717">=</span>&nbsp;<span class="num" id="5481719">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481725">for</span>&nbsp;<span class="ident" id="5481729">i</span>&nbsp;<span class="op" id="5481731">:=</span>&nbsp;<span class="num" id="5481734">0</span><span class="op" id="5481735">;</span>&nbsp;<span class="ident" id="5481737">i</span>&nbsp;<span class="op" id="5481739">&lt;</span>&nbsp;<span class="ident" id="5481741">indent</span><span class="op" id="5481747">;</span>&nbsp;<span class="ident" id="5481749">i</span><span class="op" id="5481750">++</span>&nbsp;<span class="op" id="5481753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481757">res</span>&nbsp;<span class="op" id="5481761">=</span>&nbsp;<span class="builtinfunc" id="5481763">append</span><span class="op" id="5481769">(</span><span class="ident" id="5481770">res</span><span class="op" id="5481773">,</span>&nbsp;<span class="string" id="5481775">&#39;\t&#39;</span><span class="op" id="5481779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481782">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481786">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5481809">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481862">cfg</span><span class="op" id="5481865">.</span><span class="ident" id="5481866">Indent</span>&nbsp;<span class="op" id="5481873">=</span>&nbsp;<span class="ident" id="5481875">indent</span>&nbsp;<span class="op" id="5481882">+</span>&nbsp;<span class="ident" id="5481884">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481895">var</span>&nbsp;<span class="ident" id="5481899">buf</span>&nbsp;<span class="ident" id="5481903">bytes</span><span class="op" id="5481908">.</span><span class="ident" id="5481909">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481917">err</span>&nbsp;<span class="op" id="5481921">:=</span>&nbsp;<span class="ident" id="5481924">cfg</span><span class="op" id="5481927">.</span><span class="ident" id="5481928">Fprint</span><span class="op" id="5481934">(</span><span class="op" id="5481935">&amp;</span><span class="ident" id="5481936">buf</span><span class="op" id="5481939">,</span>&nbsp;<span class="ident" id="5481941">fset</span><span class="op" id="5481945">,</span>&nbsp;<span class="ident" id="5481947">file</span><span class="op" id="5481951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481954">if</span>&nbsp;<span class="ident" id="5481957">err</span>&nbsp;<span class="op" id="5481961">!=</span>&nbsp;<span class="builtintype" id="5481964">nil</span>&nbsp;<span class="op" id="5481968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5481972">return</span>&nbsp;<span class="builtintype" id="5481979">nil</span><span class="op" id="5481982">,</span>&nbsp;<span class="ident" id="5481984">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5481989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5481992">res</span>&nbsp;<span class="op" id="5481996">=</span>&nbsp;<span class="builtinfunc" id="5481998">append</span><span class="op" id="5482004">(</span><span class="ident" id="5482005">res</span><span class="op" id="5482008">,</span>&nbsp;<span class="ident" id="5482010">sourceAdj</span><span class="op" id="5482019">(</span><span class="ident" id="5482020">buf</span><span class="op" id="5482023">.</span><span class="ident" id="5482024">Bytes</span><span class="op" id="5482029">(</span><span class="op" id="5482030">)</span><span class="op" id="5482031">,</span>&nbsp;<span class="ident" id="5482033">cfg</span><span class="op" id="5482036">.</span><span class="ident" id="5482037">Indent</span><span class="op" id="5482043">)</span><span class="op" id="5482044">...</span><span class="op" id="5482047">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5482051">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5482092">i</span>&nbsp;<span class="op" id="5482094">=</span>&nbsp;<span class="builtinfunc" id="5482096">len</span><span class="op" id="5482099">(</span><span class="ident" id="5482100">src</span><span class="op" id="5482103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5482106">for</span>&nbsp;<span class="ident" id="5482110">i</span>&nbsp;<span class="op" id="5482112">&gt;</span>&nbsp;<span class="num" id="5482114">0</span>&nbsp;<span class="op" id="5482116">&amp;&amp;</span>&nbsp;<span class="ident" id="5482119">isSpace</span><span class="op" id="5482126">(</span><span class="ident" id="5482127">src</span><span class="op" id="5482130">[</span><span class="ident" id="5482131">i</span><span class="op" id="5482132">-</span><span class="num" id="5482133">1</span><span class="op" id="5482134">]</span><span class="op" id="5482135">)</span>&nbsp;<span class="op" id="5482137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5482141">i</span><span class="op" id="5482142">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5482146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5482149">return</span>&nbsp;<span class="builtinfunc" id="5482156">append</span><span class="op" id="5482162">(</span><span class="ident" id="5482163">res</span><span class="op" id="5482166">,</span>&nbsp;<span class="ident" id="5482168">src</span><span class="op" id="5482171">[</span><span class="ident" id="5482172">i</span><span class="op" id="5482173">:</span><span class="op" id="5482174">]</span><span class="op" id="5482175">...</span><span class="op" id="5482178">)</span><span class="op" id="5482179">,</span>&nbsp;<span class="builtintype" id="5482181">nil</span><br>
<span class="lineno"></span><span class="op" id="5482185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5482188">func</span>&nbsp;<span class="ident" id="5482193">isSpace</span><span class="op" id="5482200">(</span><span class="ident" id="5482201">b</span>&nbsp;<span class="builtintype" id="5482203">byte</span><span class="op" id="5482207">)</span>&nbsp;<span class="builtintype" id="5482209">bool</span>&nbsp;<span class="op" id="5482214">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5482217">return</span>&nbsp;<span class="ident" id="5482224">b</span>&nbsp;<span class="op" id="5482226">==</span>&nbsp;<span class="string" id="5482229">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5482233">||</span>&nbsp;<span class="ident" id="5482236">b</span>&nbsp;<span class="op" id="5482238">==</span>&nbsp;<span class="string" id="5482241">&#39;\t&#39;</span>&nbsp;<span class="op" id="5482246">||</span>&nbsp;<span class="ident" id="5482249">b</span>&nbsp;<span class="op" id="5482251">==</span>&nbsp;<span class="string" id="5482254">&#39;\n&#39;</span>&nbsp;<span class="op" id="5482259">||</span>&nbsp;<span class="ident" id="5482262">b</span>&nbsp;<span class="op" id="5482264">==</span>&nbsp;<span class="string" id="5482267">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="5482272">}</span>
</div>
</body>
</html>
