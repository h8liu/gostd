<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4006291">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4006346">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4006400">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4006451">package</span>&nbsp;<span class="ident" id="4006459">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4006464">import</span>&nbsp;<span class="op" id="4006471">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006474">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006480">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006491">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4006498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4006501">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4006576">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="4006607">type</span>&nbsp;<span class="ident" id="4006612">Encoder</span>&nbsp;<span class="keyword" id="4006620">struct</span>&nbsp;<span class="op" id="4006627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006630">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006641">sync</span><span class="op" id="4006645">.</span><span class="ident" id="4006646">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006665">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006703">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006714">[</span><span class="op" id="4006715">]</span><span class="ident" id="4006716">io</span><span class="op" id="4006718">.</span><span class="ident" id="4006719">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006738">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006765">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006776">map</span><span class="op" id="4006779">[</span><span class="ident" id="4006780">reflect</span><span class="op" id="4006787">.</span><span class="ident" id="4006788">Type</span><span class="op" id="4006792">]</span><span class="ident" id="4006793">typeId</span>&nbsp;<span class="comment" id="4006800">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006835">countState</span>&nbsp;<span class="op" id="4006846">*</span><span class="ident" id="4006847">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006870">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006899">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4006910">*</span><span class="ident" id="4006911">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006934">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006986">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006997">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4007021">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007059">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4007070">error</span><br>
<span class="lineno"></span><span class="op" id="4007076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4007079">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4007146">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4007213">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4007275">const</span>&nbsp;<span class="ident" id="4007281">maxLength</span>&nbsp;<span class="op" id="4007291">=</span>&nbsp;<span class="num" id="4007293">9</span>&nbsp;<span class="comment" id="4007295">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4007333">var</span>&nbsp;<span class="ident" id="4007337">spaceForLength</span>&nbsp;<span class="op" id="4007352">=</span>&nbsp;<span class="builtinfunc" id="4007354">make</span><span class="op" id="4007358">(</span><span class="op" id="4007359">[</span><span class="op" id="4007360">]</span><span class="builtintype" id="4007361">byte</span><span class="op" id="4007365">,</span>&nbsp;<span class="ident" id="4007367">maxLength</span><span class="op" id="4007376">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4007379">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4007452">func</span>&nbsp;<span class="ident" id="4007457">NewEncoder</span><span class="op" id="4007467">(</span><span class="ident" id="4007468">w</span>&nbsp;<span class="ident" id="4007470">io</span><span class="op" id="4007472">.</span><span class="ident" id="4007473">Writer</span><span class="op" id="4007479">)</span>&nbsp;<span class="op" id="4007481">*</span><span class="ident" id="4007482">Encoder</span>&nbsp;<span class="op" id="4007490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007493">enc</span>&nbsp;<span class="op" id="4007497">:=</span>&nbsp;<span class="builtinfunc" id="4007500">new</span><span class="op" id="4007503">(</span><span class="ident" id="4007504">Encoder</span><span class="op" id="4007511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007514">enc</span><span class="op" id="4007517">.</span><span class="ident" id="4007518">w</span>&nbsp;<span class="op" id="4007520">=</span>&nbsp;<span class="op" id="4007522">[</span><span class="op" id="4007523">]</span><span class="ident" id="4007524">io</span><span class="op" id="4007526">.</span><span class="ident" id="4007527">Writer</span><span class="op" id="4007533">{</span><span class="ident" id="4007534">w</span><span class="op" id="4007535">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007538">enc</span><span class="op" id="4007541">.</span><span class="ident" id="4007542">sent</span>&nbsp;<span class="op" id="4007547">=</span>&nbsp;<span class="builtinfunc" id="4007549">make</span><span class="op" id="4007553">(</span><span class="keyword" id="4007554">map</span><span class="op" id="4007557">[</span><span class="ident" id="4007558">reflect</span><span class="op" id="4007565">.</span><span class="ident" id="4007566">Type</span><span class="op" id="4007570">]</span><span class="ident" id="4007571">typeId</span><span class="op" id="4007577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007580">enc</span><span class="op" id="4007583">.</span><span class="ident" id="4007584">countState</span>&nbsp;<span class="op" id="4007595">=</span>&nbsp;<span class="ident" id="4007597">enc</span><span class="op" id="4007600">.</span><span class="ident" id="4007601">newEncoderState</span><span class="op" id="4007616">(</span><span class="builtinfunc" id="4007617">new</span><span class="op" id="4007620">(</span><span class="ident" id="4007621">encBuffer</span><span class="op" id="4007630">)</span><span class="op" id="4007631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007634">return</span>&nbsp;<span class="ident" id="4007641">enc</span><br>
<span class="lineno"></span><span class="op" id="4007645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4007648">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="4007710">func</span>&nbsp;<span class="op" id="4007715">(</span><span class="ident" id="4007716">enc</span>&nbsp;<span class="op" id="4007720">*</span><span class="ident" id="4007721">Encoder</span><span class="op" id="4007728">)</span>&nbsp;<span class="ident" id="4007730">writer</span><span class="op" id="4007736">(</span><span class="op" id="4007737">)</span>&nbsp;<span class="ident" id="4007739">io</span><span class="op" id="4007741">.</span><span class="ident" id="4007742">Writer</span>&nbsp;<span class="op" id="4007749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007752">return</span>&nbsp;<span class="ident" id="4007759">enc</span><span class="op" id="4007762">.</span><span class="ident" id="4007763">w</span><span class="op" id="4007764">[</span><span class="builtinfunc" id="4007765">len</span><span class="op" id="4007768">(</span><span class="ident" id="4007769">enc</span><span class="op" id="4007772">.</span><span class="ident" id="4007773">w</span><span class="op" id="4007774">)</span><span class="op" id="4007775">-</span><span class="num" id="4007776">1</span><span class="op" id="4007777">]</span><br>
<span class="lineno"></span><span class="op" id="4007779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4007782">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4007826">func</span>&nbsp;<span class="op" id="4007831">(</span><span class="ident" id="4007832">enc</span>&nbsp;<span class="op" id="4007836">*</span><span class="ident" id="4007837">Encoder</span><span class="op" id="4007844">)</span>&nbsp;<span class="ident" id="4007846">pushWriter</span><span class="op" id="4007856">(</span><span class="ident" id="4007857">w</span>&nbsp;<span class="ident" id="4007859">io</span><span class="op" id="4007861">.</span><span class="ident" id="4007862">Writer</span><span class="op" id="4007868">)</span>&nbsp;<span class="op" id="4007870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007873">enc</span><span class="op" id="4007876">.</span><span class="ident" id="4007877">w</span>&nbsp;<span class="op" id="4007879">=</span>&nbsp;<span class="builtinfunc" id="4007881">append</span><span class="op" id="4007887">(</span><span class="ident" id="4007888">enc</span><span class="op" id="4007891">.</span><span class="ident" id="4007892">w</span><span class="op" id="4007893">,</span>&nbsp;<span class="ident" id="4007895">w</span><span class="op" id="4007896">)</span><br>
<span class="lineno"></span><span class="op" id="4007898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4007901">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4007941">func</span>&nbsp;<span class="op" id="4007946">(</span><span class="ident" id="4007947">enc</span>&nbsp;<span class="op" id="4007951">*</span><span class="ident" id="4007952">Encoder</span><span class="op" id="4007959">)</span>&nbsp;<span class="ident" id="4007961">popWriter</span><span class="op" id="4007970">(</span><span class="op" id="4007971">)</span>&nbsp;<span class="op" id="4007973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007976">enc</span><span class="op" id="4007979">.</span><span class="ident" id="4007980">w</span>&nbsp;<span class="op" id="4007982">=</span>&nbsp;<span class="ident" id="4007984">enc</span><span class="op" id="4007987">.</span><span class="ident" id="4007988">w</span><span class="op" id="4007989">[</span><span class="num" id="4007990">0</span>&nbsp;<span class="op" id="4007992">:</span>&nbsp;<span class="builtinfunc" id="4007994">len</span><span class="op" id="4007997">(</span><span class="ident" id="4007998">enc</span><span class="op" id="4008001">.</span><span class="ident" id="4008002">w</span><span class="op" id="4008003">)</span><span class="op" id="4008004">-</span><span class="num" id="4008005">1</span><span class="op" id="4008006">]</span><br>
<span class="lineno"></span><span class="op" id="4008008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4008011">func</span>&nbsp;<span class="op" id="4008016">(</span><span class="ident" id="4008017">enc</span>&nbsp;<span class="op" id="4008021">*</span><span class="ident" id="4008022">Encoder</span><span class="op" id="4008029">)</span>&nbsp;<span class="ident" id="4008031">setError</span><span class="op" id="4008039">(</span><span class="ident" id="4008040">err</span>&nbsp;<span class="builtintype" id="4008044">error</span><span class="op" id="4008049">)</span>&nbsp;<span class="op" id="4008051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008054">if</span>&nbsp;<span class="ident" id="4008057">enc</span><span class="op" id="4008060">.</span><span class="ident" id="4008061">err</span>&nbsp;<span class="op" id="4008065">==</span>&nbsp;<span class="ident" id="4008068">nil</span>&nbsp;<span class="op" id="4008072">{</span>&nbsp;<span class="comment" id="4008074">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008099">enc</span><span class="op" id="4008102">.</span><span class="ident" id="4008103">err</span>&nbsp;<span class="op" id="4008107">=</span>&nbsp;<span class="ident" id="4008109">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008114">}</span><br>
<span class="lineno"></span><span class="op" id="4008116">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4008119">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="4008199">func</span>&nbsp;<span class="op" id="4008204">(</span><span class="ident" id="4008205">enc</span>&nbsp;<span class="op" id="4008209">*</span><span class="ident" id="4008210">Encoder</span><span class="op" id="4008217">)</span>&nbsp;<span class="ident" id="4008219">writeMessage</span><span class="op" id="4008231">(</span><span class="ident" id="4008232">w</span>&nbsp;<span class="ident" id="4008234">io</span><span class="op" id="4008236">.</span><span class="ident" id="4008237">Writer</span><span class="op" id="4008243">,</span>&nbsp;<span class="ident" id="4008245">b</span>&nbsp;<span class="op" id="4008247">*</span><span class="ident" id="4008248">encBuffer</span><span class="op" id="4008257">)</span>&nbsp;<span class="op" id="4008259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008262">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008333">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008413">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008429">message</span>&nbsp;<span class="op" id="4008437">:=</span>&nbsp;<span class="ident" id="4008440">b</span><span class="op" id="4008441">.</span><span class="ident" id="4008442">Bytes</span><span class="op" id="4008447">(</span><span class="op" id="4008448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008451">messageLen</span>&nbsp;<span class="op" id="4008462">:=</span>&nbsp;<span class="builtinfunc" id="4008465">len</span><span class="op" id="4008468">(</span><span class="ident" id="4008469">message</span><span class="op" id="4008476">)</span>&nbsp;<span class="op" id="4008478">-</span>&nbsp;<span class="ident" id="4008480">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008491">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008514">enc</span><span class="op" id="4008517">.</span><span class="ident" id="4008518">countState</span><span class="op" id="4008528">.</span><span class="ident" id="4008529">b</span><span class="op" id="4008530">.</span><span class="ident" id="4008531">Reset</span><span class="op" id="4008536">(</span><span class="op" id="4008537">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008540">enc</span><span class="op" id="4008543">.</span><span class="ident" id="4008544">countState</span><span class="op" id="4008554">.</span><span class="ident" id="4008555">encodeUint</span><span class="op" id="4008565">(</span><span class="ident" id="4008566">uint64</span><span class="op" id="4008572">(</span><span class="ident" id="4008573">messageLen</span><span class="op" id="4008583">)</span><span class="op" id="4008584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008587">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008638">offset</span>&nbsp;<span class="op" id="4008645">:=</span>&nbsp;<span class="ident" id="4008648">maxLength</span>&nbsp;<span class="op" id="4008658">-</span>&nbsp;<span class="ident" id="4008660">enc</span><span class="op" id="4008663">.</span><span class="ident" id="4008664">countState</span><span class="op" id="4008674">.</span><span class="ident" id="4008675">b</span><span class="op" id="4008676">.</span><span class="ident" id="4008677">Len</span><span class="op" id="4008680">(</span><span class="op" id="4008681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4008684">copy</span><span class="op" id="4008688">(</span><span class="ident" id="4008689">message</span><span class="op" id="4008696">[</span><span class="ident" id="4008697">offset</span><span class="op" id="4008703">:</span><span class="op" id="4008704">]</span><span class="op" id="4008705">,</span>&nbsp;<span class="ident" id="4008707">enc</span><span class="op" id="4008710">.</span><span class="ident" id="4008711">countState</span><span class="op" id="4008721">.</span><span class="ident" id="4008722">b</span><span class="op" id="4008723">.</span><span class="ident" id="4008724">Bytes</span><span class="op" id="4008729">(</span><span class="op" id="4008730">)</span><span class="op" id="4008731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008734">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008754">_</span><span class="op" id="4008755">,</span>&nbsp;<span class="ident" id="4008757">err</span>&nbsp;<span class="op" id="4008761">:=</span>&nbsp;<span class="ident" id="4008764">w</span><span class="op" id="4008765">.</span><span class="ident" id="4008766">Write</span><span class="op" id="4008771">(</span><span class="ident" id="4008772">message</span><span class="op" id="4008779">[</span><span class="ident" id="4008780">offset</span><span class="op" id="4008786">:</span><span class="op" id="4008787">]</span><span class="op" id="4008788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008791">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008882">b</span><span class="op" id="4008883">.</span><span class="ident" id="4008884">Reset</span><span class="op" id="4008889">(</span><span class="op" id="4008890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008893">b</span><span class="op" id="4008894">.</span><span class="ident" id="4008895">Write</span><span class="op" id="4008900">(</span><span class="ident" id="4008901">spaceForLength</span><span class="op" id="4008915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008918">if</span>&nbsp;<span class="ident" id="4008921">err</span>&nbsp;<span class="op" id="4008925">!=</span>&nbsp;<span class="ident" id="4008928">nil</span>&nbsp;<span class="op" id="4008932">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008936">enc</span><span class="op" id="4008939">.</span><span class="ident" id="4008940">setError</span><span class="op" id="4008948">(</span><span class="ident" id="4008949">err</span><span class="op" id="4008952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008955">}</span><br>
<span class="lineno"></span><span class="op" id="4008957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4008960">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="4009042">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="4009068">func</span>&nbsp;<span class="op" id="4009073">(</span><span class="ident" id="4009074">enc</span>&nbsp;<span class="op" id="4009078">*</span><span class="ident" id="4009079">Encoder</span><span class="op" id="4009086">)</span>&nbsp;<span class="ident" id="4009088">sendActualType</span><span class="op" id="4009102">(</span><span class="ident" id="4009103">w</span>&nbsp;<span class="ident" id="4009105">io</span><span class="op" id="4009107">.</span><span class="ident" id="4009108">Writer</span><span class="op" id="4009114">,</span>&nbsp;<span class="ident" id="4009116">state</span>&nbsp;<span class="op" id="4009122">*</span><span class="ident" id="4009123">encoderState</span><span class="op" id="4009135">,</span>&nbsp;<span class="ident" id="4009137">ut</span>&nbsp;<span class="op" id="4009140">*</span><span class="ident" id="4009141">userTypeInfo</span><span class="op" id="4009153">,</span>&nbsp;<span class="ident" id="4009155">actual</span>&nbsp;<span class="ident" id="4009162">reflect</span><span class="op" id="4009169">.</span><span class="ident" id="4009170">Type</span><span class="op" id="4009174">)</span>&nbsp;<span class="op" id="4009176">(</span><span class="ident" id="4009177">sent</span>&nbsp;<span class="builtintype" id="4009182">bool</span><span class="op" id="4009186">)</span>&nbsp;<span class="op" id="4009188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009191">if</span>&nbsp;<span class="ident" id="4009194">_</span><span class="op" id="4009195">,</span>&nbsp;<span class="ident" id="4009197">alreadySent</span>&nbsp;<span class="op" id="4009209">:=</span>&nbsp;<span class="ident" id="4009212">enc</span><span class="op" id="4009215">.</span><span class="ident" id="4009216">sent</span><span class="op" id="4009220">[</span><span class="ident" id="4009221">actual</span><span class="op" id="4009227">]</span><span class="op" id="4009228">;</span>&nbsp;<span class="ident" id="4009230">alreadySent</span>&nbsp;<span class="op" id="4009242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009246">return</span>&nbsp;<span class="builtintype" id="4009253">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009260">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009263">info</span><span class="op" id="4009267">,</span>&nbsp;<span class="ident" id="4009269">err</span>&nbsp;<span class="op" id="4009273">:=</span>&nbsp;<span class="ident" id="4009276">getTypeInfo</span><span class="op" id="4009287">(</span><span class="ident" id="4009288">ut</span><span class="op" id="4009290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009293">if</span>&nbsp;<span class="ident" id="4009296">err</span>&nbsp;<span class="op" id="4009300">!=</span>&nbsp;<span class="ident" id="4009303">nil</span>&nbsp;<span class="op" id="4009307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009311">enc</span><span class="op" id="4009314">.</span><span class="ident" id="4009315">setError</span><span class="op" id="4009323">(</span><span class="ident" id="4009324">err</span><span class="op" id="4009327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009339">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4009342">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4009372">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009380">state</span><span class="op" id="4009385">.</span><span class="ident" id="4009386">encodeInt</span><span class="op" id="4009395">(</span><span class="op" id="4009396">-</span><span class="ident" id="4009397">int64</span><span class="op" id="4009402">(</span><span class="ident" id="4009403">info</span><span class="op" id="4009407">.</span><span class="ident" id="4009408">id</span><span class="op" id="4009410">)</span><span class="op" id="4009411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4009414">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009424">enc</span><span class="op" id="4009427">.</span><span class="ident" id="4009428">encode</span><span class="op" id="4009434">(</span><span class="ident" id="4009435">state</span><span class="op" id="4009440">.</span><span class="ident" id="4009441">b</span><span class="op" id="4009442">,</span>&nbsp;<span class="ident" id="4009444">reflect</span><span class="op" id="4009451">.</span><span class="ident" id="4009452">ValueOf</span><span class="op" id="4009459">(</span><span class="ident" id="4009460">info</span><span class="op" id="4009464">.</span><span class="ident" id="4009465">wire</span><span class="op" id="4009469">)</span><span class="op" id="4009470">,</span>&nbsp;<span class="ident" id="4009472">wireTypeUserInfo</span><span class="op" id="4009488">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009491">enc</span><span class="op" id="4009494">.</span><span class="ident" id="4009495">writeMessage</span><span class="op" id="4009507">(</span><span class="ident" id="4009508">w</span><span class="op" id="4009509">,</span>&nbsp;<span class="ident" id="4009511">state</span><span class="op" id="4009516">.</span><span class="ident" id="4009517">b</span><span class="op" id="4009518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009521">if</span>&nbsp;<span class="ident" id="4009524">enc</span><span class="op" id="4009527">.</span><span class="ident" id="4009528">err</span>&nbsp;<span class="op" id="4009532">!=</span>&nbsp;<span class="ident" id="4009535">nil</span>&nbsp;<span class="op" id="4009539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009543">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4009555">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009636">enc</span><span class="op" id="4009639">.</span><span class="ident" id="4009640">sent</span><span class="op" id="4009644">[</span><span class="ident" id="4009645">ut</span><span class="op" id="4009647">.</span><span class="ident" id="4009648">base</span><span class="op" id="4009652">]</span>&nbsp;<span class="op" id="4009654">=</span>&nbsp;<span class="ident" id="4009656">info</span><span class="op" id="4009660">.</span><span class="ident" id="4009661">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009665">if</span>&nbsp;<span class="ident" id="4009668">ut</span><span class="op" id="4009670">.</span><span class="ident" id="4009671">user</span>&nbsp;<span class="op" id="4009676">!=</span>&nbsp;<span class="ident" id="4009679">ut</span><span class="op" id="4009681">.</span><span class="ident" id="4009682">base</span>&nbsp;<span class="op" id="4009687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009691">enc</span><span class="op" id="4009694">.</span><span class="ident" id="4009695">sent</span><span class="op" id="4009699">[</span><span class="ident" id="4009700">ut</span><span class="op" id="4009702">.</span><span class="ident" id="4009703">user</span><span class="op" id="4009707">]</span>&nbsp;<span class="op" id="4009709">=</span>&nbsp;<span class="ident" id="4009711">info</span><span class="op" id="4009715">.</span><span class="ident" id="4009716">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009720">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4009723">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009752">switch</span>&nbsp;<span class="ident" id="4009759">st</span>&nbsp;<span class="op" id="4009762">:=</span>&nbsp;<span class="ident" id="4009765">actual</span><span class="op" id="4009771">;</span>&nbsp;<span class="ident" id="4009773">st</span><span class="op" id="4009775">.</span><span class="ident" id="4009776">Kind</span><span class="op" id="4009780">(</span><span class="op" id="4009781">)</span>&nbsp;<span class="op" id="4009783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009786">case</span>&nbsp;<span class="ident" id="4009791">reflect</span><span class="op" id="4009798">.</span><span class="ident" id="4009799">Struct</span><span class="op" id="4009805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009809">for</span>&nbsp;<span class="ident" id="4009813">i</span>&nbsp;<span class="op" id="4009815">:=</span>&nbsp;<span class="num" id="4009818">0</span><span class="op" id="4009819">;</span>&nbsp;<span class="ident" id="4009821">i</span>&nbsp;<span class="op" id="4009823">&lt;</span>&nbsp;<span class="ident" id="4009825">st</span><span class="op" id="4009827">.</span><span class="ident" id="4009828">NumField</span><span class="op" id="4009836">(</span><span class="op" id="4009837">)</span><span class="op" id="4009838">;</span>&nbsp;<span class="ident" id="4009840">i</span><span class="op" id="4009841">++</span>&nbsp;<span class="op" id="4009844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009849">if</span>&nbsp;<span class="ident" id="4009852">isExported</span><span class="op" id="4009862">(</span><span class="ident" id="4009863">st</span><span class="op" id="4009865">.</span><span class="ident" id="4009866">Field</span><span class="op" id="4009871">(</span><span class="ident" id="4009872">i</span><span class="op" id="4009873">)</span><span class="op" id="4009874">.</span><span class="ident" id="4009875">Name</span><span class="op" id="4009879">)</span>&nbsp;<span class="op" id="4009881">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009887">enc</span><span class="op" id="4009890">.</span><span class="ident" id="4009891">sendType</span><span class="op" id="4009899">(</span><span class="ident" id="4009900">w</span><span class="op" id="4009901">,</span>&nbsp;<span class="ident" id="4009903">state</span><span class="op" id="4009908">,</span>&nbsp;<span class="ident" id="4009910">st</span><span class="op" id="4009912">.</span><span class="ident" id="4009913">Field</span><span class="op" id="4009918">(</span><span class="ident" id="4009919">i</span><span class="op" id="4009920">)</span><span class="op" id="4009921">.</span><span class="ident" id="4009922">Type</span><span class="op" id="4009926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009938">case</span>&nbsp;<span class="ident" id="4009943">reflect</span><span class="op" id="4009950">.</span><span class="ident" id="4009951">Array</span><span class="op" id="4009956">,</span>&nbsp;<span class="ident" id="4009958">reflect</span><span class="op" id="4009965">.</span><span class="ident" id="4009966">Slice</span><span class="op" id="4009971">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009975">enc</span><span class="op" id="4009978">.</span><span class="ident" id="4009979">sendType</span><span class="op" id="4009987">(</span><span class="ident" id="4009988">w</span><span class="op" id="4009989">,</span>&nbsp;<span class="ident" id="4009991">state</span><span class="op" id="4009996">,</span>&nbsp;<span class="ident" id="4009998">st</span><span class="op" id="4010000">.</span><span class="ident" id="4010001">Elem</span><span class="op" id="4010005">(</span><span class="op" id="4010006">)</span><span class="op" id="4010007">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010010">case</span>&nbsp;<span class="ident" id="4010015">reflect</span><span class="op" id="4010022">.</span><span class="ident" id="4010023">Map</span><span class="op" id="4010026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010030">enc</span><span class="op" id="4010033">.</span><span class="ident" id="4010034">sendType</span><span class="op" id="4010042">(</span><span class="ident" id="4010043">w</span><span class="op" id="4010044">,</span>&nbsp;<span class="ident" id="4010046">state</span><span class="op" id="4010051">,</span>&nbsp;<span class="ident" id="4010053">st</span><span class="op" id="4010055">.</span><span class="ident" id="4010056">Key</span><span class="op" id="4010059">(</span><span class="op" id="4010060">)</span><span class="op" id="4010061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010065">enc</span><span class="op" id="4010068">.</span><span class="ident" id="4010069">sendType</span><span class="op" id="4010077">(</span><span class="ident" id="4010078">w</span><span class="op" id="4010079">,</span>&nbsp;<span class="ident" id="4010081">state</span><span class="op" id="4010086">,</span>&nbsp;<span class="ident" id="4010088">st</span><span class="op" id="4010090">.</span><span class="ident" id="4010091">Elem</span><span class="op" id="4010095">(</span><span class="op" id="4010096">)</span><span class="op" id="4010097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010103">return</span>&nbsp;<span class="builtintype" id="4010110">true</span><br>
<span class="lineno">125</span><span class="op" id="4010115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4010118">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4010183">func</span>&nbsp;<span class="op" id="4010188">(</span><span class="ident" id="4010189">enc</span>&nbsp;<span class="op" id="4010193">*</span><span class="ident" id="4010194">Encoder</span><span class="op" id="4010201">)</span>&nbsp;<span class="ident" id="4010203">sendType</span><span class="op" id="4010211">(</span><span class="ident" id="4010212">w</span>&nbsp;<span class="ident" id="4010214">io</span><span class="op" id="4010216">.</span><span class="ident" id="4010217">Writer</span><span class="op" id="4010223">,</span>&nbsp;<span class="ident" id="4010225">state</span>&nbsp;<span class="op" id="4010231">*</span><span class="ident" id="4010232">encoderState</span><span class="op" id="4010244">,</span>&nbsp;<span class="ident" id="4010246">origt</span>&nbsp;<span class="ident" id="4010252">reflect</span><span class="op" id="4010259">.</span><span class="ident" id="4010260">Type</span><span class="op" id="4010264">)</span>&nbsp;<span class="op" id="4010266">(</span><span class="ident" id="4010267">sent</span>&nbsp;<span class="builtintype" id="4010272">bool</span><span class="op" id="4010276">)</span>&nbsp;<span class="op" id="4010278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010281">ut</span>&nbsp;<span class="op" id="4010284">:=</span>&nbsp;<span class="ident" id="4010287">userType</span><span class="op" id="4010295">(</span><span class="ident" id="4010296">origt</span><span class="op" id="4010301">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010304">if</span>&nbsp;<span class="ident" id="4010307">ut</span><span class="op" id="4010309">.</span><span class="ident" id="4010310">externalEnc</span>&nbsp;<span class="op" id="4010322">!=</span>&nbsp;<span class="num" id="4010325">0</span>&nbsp;<span class="op" id="4010327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010331">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010413">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010485">return</span>&nbsp;<span class="ident" id="4010492">enc</span><span class="op" id="4010495">.</span><span class="ident" id="4010496">sendActualType</span><span class="op" id="4010510">(</span><span class="ident" id="4010511">w</span><span class="op" id="4010512">,</span>&nbsp;<span class="ident" id="4010514">state</span><span class="op" id="4010519">,</span>&nbsp;<span class="ident" id="4010521">ut</span><span class="op" id="4010523">,</span>&nbsp;<span class="ident" id="4010525">ut</span><span class="op" id="4010527">.</span><span class="ident" id="4010528">base</span><span class="op" id="4010532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010535">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010539">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010598">switch</span>&nbsp;<span class="ident" id="4010605">rt</span>&nbsp;<span class="op" id="4010608">:=</span>&nbsp;<span class="ident" id="4010611">ut</span><span class="op" id="4010613">.</span><span class="ident" id="4010614">base</span><span class="op" id="4010618">;</span>&nbsp;<span class="ident" id="4010620">rt</span><span class="op" id="4010622">.</span><span class="ident" id="4010623">Kind</span><span class="op" id="4010627">(</span><span class="op" id="4010628">)</span>&nbsp;<span class="op" id="4010630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010633">default</span><span class="op" id="4010640">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010644">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010705">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010713">case</span>&nbsp;<span class="ident" id="4010718">reflect</span><span class="op" id="4010725">.</span><span class="ident" id="4010726">Slice</span><span class="op" id="4010731">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010735">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010792">if</span>&nbsp;<span class="ident" id="4010795">rt</span><span class="op" id="4010797">.</span><span class="ident" id="4010798">Elem</span><span class="op" id="4010802">(</span><span class="op" id="4010803">)</span><span class="op" id="4010804">.</span><span class="ident" id="4010805">Kind</span><span class="op" id="4010809">(</span><span class="op" id="4010810">)</span>&nbsp;<span class="op" id="4010812">==</span>&nbsp;<span class="ident" id="4010815">reflect</span><span class="op" id="4010822">.</span><span class="ident" id="4010823">Uint8</span>&nbsp;<span class="op" id="4010829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010834">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010847">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010874">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010881">case</span>&nbsp;<span class="ident" id="4010886">reflect</span><span class="op" id="4010893">.</span><span class="ident" id="4010894">Array</span><span class="op" id="4010899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010903">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010972">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010979">case</span>&nbsp;<span class="ident" id="4010984">reflect</span><span class="op" id="4010991">.</span><span class="ident" id="4010992">Map</span><span class="op" id="4010995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4010999">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011068">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011075">case</span>&nbsp;<span class="ident" id="4011080">reflect</span><span class="op" id="4011087">.</span><span class="ident" id="4011088">Struct</span><span class="op" id="4011094">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4011098">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011149">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011156">case</span>&nbsp;<span class="ident" id="4011161">reflect</span><span class="op" id="4011168">.</span><span class="ident" id="4011169">Chan</span><span class="op" id="4011173">,</span>&nbsp;<span class="ident" id="4011175">reflect</span><span class="op" id="4011182">.</span><span class="ident" id="4011183">Func</span><span class="op" id="4011187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4011191">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011249">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011261">return</span>&nbsp;<span class="ident" id="4011268">enc</span><span class="op" id="4011271">.</span><span class="ident" id="4011272">sendActualType</span><span class="op" id="4011286">(</span><span class="ident" id="4011287">w</span><span class="op" id="4011288">,</span>&nbsp;<span class="ident" id="4011290">state</span><span class="op" id="4011295">,</span>&nbsp;<span class="ident" id="4011297">ut</span><span class="op" id="4011299">,</span>&nbsp;<span class="ident" id="4011301">ut</span><span class="op" id="4011303">.</span><span class="ident" id="4011304">base</span><span class="op" id="4011308">)</span><br>
<span class="lineno"></span><span class="op" id="4011310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4011313">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4011389">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4011469">func</span>&nbsp;<span class="op" id="4011474">(</span><span class="ident" id="4011475">enc</span>&nbsp;<span class="op" id="4011479">*</span><span class="ident" id="4011480">Encoder</span><span class="op" id="4011487">)</span>&nbsp;<span class="ident" id="4011489">Encode</span><span class="op" id="4011495">(</span><span class="ident" id="4011496">e</span>&nbsp;<span class="keyword" id="4011498">interface</span><span class="op" id="4011507">{</span><span class="op" id="4011508">}</span><span class="op" id="4011509">)</span>&nbsp;<span class="builtintype" id="4011511">error</span>&nbsp;<span class="op" id="4011517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011520">return</span>&nbsp;<span class="ident" id="4011527">enc</span><span class="op" id="4011530">.</span><span class="ident" id="4011531">EncodeValue</span><span class="op" id="4011542">(</span><span class="ident" id="4011543">reflect</span><span class="op" id="4011550">.</span><span class="ident" id="4011551">ValueOf</span><span class="op" id="4011558">(</span><span class="ident" id="4011559">e</span><span class="op" id="4011560">)</span><span class="op" id="4011561">)</span><br>
<span class="lineno"></span><span class="op" id="4011563">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="4011566">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4011638">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="4011711">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="4011720">func</span>&nbsp;<span class="op" id="4011725">(</span><span class="ident" id="4011726">enc</span>&nbsp;<span class="op" id="4011730">*</span><span class="ident" id="4011731">Encoder</span><span class="op" id="4011738">)</span>&nbsp;<span class="ident" id="4011740">sendTypeDescriptor</span><span class="op" id="4011758">(</span><span class="ident" id="4011759">w</span>&nbsp;<span class="ident" id="4011761">io</span><span class="op" id="4011763">.</span><span class="ident" id="4011764">Writer</span><span class="op" id="4011770">,</span>&nbsp;<span class="ident" id="4011772">state</span>&nbsp;<span class="op" id="4011778">*</span><span class="ident" id="4011779">encoderState</span><span class="op" id="4011791">,</span>&nbsp;<span class="ident" id="4011793">ut</span>&nbsp;<span class="op" id="4011796">*</span><span class="ident" id="4011797">userTypeInfo</span><span class="op" id="4011809">)</span>&nbsp;<span class="op" id="4011811">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4011814">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4011865">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011908">rt</span>&nbsp;<span class="op" id="4011911">:=</span>&nbsp;<span class="ident" id="4011914">ut</span><span class="op" id="4011916">.</span><span class="ident" id="4011917">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011923">if</span>&nbsp;<span class="ident" id="4011926">ut</span><span class="op" id="4011928">.</span><span class="ident" id="4011929">externalEnc</span>&nbsp;<span class="op" id="4011941">!=</span>&nbsp;<span class="num" id="4011944">0</span>&nbsp;<span class="op" id="4011946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011950">rt</span>&nbsp;<span class="op" id="4011953">=</span>&nbsp;<span class="ident" id="4011955">ut</span><span class="op" id="4011957">.</span><span class="ident" id="4011958">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011967">if</span>&nbsp;<span class="ident" id="4011970">_</span><span class="op" id="4011971">,</span>&nbsp;<span class="ident" id="4011973">alreadySent</span>&nbsp;<span class="op" id="4011985">:=</span>&nbsp;<span class="ident" id="4011988">enc</span><span class="op" id="4011991">.</span><span class="ident" id="4011992">sent</span><span class="op" id="4011996">[</span><span class="ident" id="4011997">rt</span><span class="op" id="4011999">]</span><span class="op" id="4012000">;</span>&nbsp;<span class="op" id="4012002">!</span><span class="ident" id="4012003">alreadySent</span>&nbsp;<span class="op" id="4012015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012019">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012040">sent</span>&nbsp;<span class="op" id="4012045">:=</span>&nbsp;<span class="ident" id="4012048">enc</span><span class="op" id="4012051">.</span><span class="ident" id="4012052">sendType</span><span class="op" id="4012060">(</span><span class="ident" id="4012061">w</span><span class="op" id="4012062">,</span>&nbsp;<span class="ident" id="4012064">state</span><span class="op" id="4012069">,</span>&nbsp;<span class="ident" id="4012071">rt</span><span class="op" id="4012073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012077">if</span>&nbsp;<span class="ident" id="4012080">enc</span><span class="op" id="4012083">.</span><span class="ident" id="4012084">err</span>&nbsp;<span class="op" id="4012088">!=</span>&nbsp;<span class="ident" id="4012091">nil</span>&nbsp;<span class="op" id="4012095">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012100">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012113">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012184">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012255">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012322">if</span>&nbsp;<span class="op" id="4012325">!</span><span class="ident" id="4012326">sent</span>&nbsp;<span class="op" id="4012331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012336">info</span><span class="op" id="4012340">,</span>&nbsp;<span class="ident" id="4012342">err</span>&nbsp;<span class="op" id="4012346">:=</span>&nbsp;<span class="ident" id="4012349">getTypeInfo</span><span class="op" id="4012360">(</span><span class="ident" id="4012361">ut</span><span class="op" id="4012363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012368">if</span>&nbsp;<span class="ident" id="4012371">err</span>&nbsp;<span class="op" id="4012375">!=</span>&nbsp;<span class="ident" id="4012378">nil</span>&nbsp;<span class="op" id="4012382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012388">enc</span><span class="op" id="4012391">.</span><span class="ident" id="4012392">setError</span><span class="op" id="4012400">(</span><span class="ident" id="4012401">err</span><span class="op" id="4012404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012410">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012425">enc</span><span class="op" id="4012428">.</span><span class="ident" id="4012429">sent</span><span class="op" id="4012433">[</span><span class="ident" id="4012434">rt</span><span class="op" id="4012436">]</span>&nbsp;<span class="op" id="4012438">=</span>&nbsp;<span class="ident" id="4012440">info</span><span class="op" id="4012444">.</span><span class="ident" id="4012445">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012453">}</span><br>
<span class="lineno"></span><span class="op" id="4012455">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4012458">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4012524">func</span>&nbsp;<span class="op" id="4012529">(</span><span class="ident" id="4012530">enc</span>&nbsp;<span class="op" id="4012534">*</span><span class="ident" id="4012535">Encoder</span><span class="op" id="4012542">)</span>&nbsp;<span class="ident" id="4012544">sendTypeId</span><span class="op" id="4012554">(</span><span class="ident" id="4012555">state</span>&nbsp;<span class="op" id="4012561">*</span><span class="ident" id="4012562">encoderState</span><span class="op" id="4012574">,</span>&nbsp;<span class="ident" id="4012576">ut</span>&nbsp;<span class="op" id="4012579">*</span><span class="ident" id="4012580">userTypeInfo</span><span class="op" id="4012592">)</span>&nbsp;<span class="op" id="4012594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012597">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012644">state</span><span class="op" id="4012649">.</span><span class="ident" id="4012650">encodeInt</span><span class="op" id="4012659">(</span><span class="ident" id="4012660">int64</span><span class="op" id="4012665">(</span><span class="ident" id="4012666">enc</span><span class="op" id="4012669">.</span><span class="ident" id="4012670">sent</span><span class="op" id="4012674">[</span><span class="ident" id="4012675">ut</span><span class="op" id="4012677">.</span><span class="ident" id="4012678">base</span><span class="op" id="4012682">]</span><span class="op" id="4012683">)</span><span class="op" id="4012684">)</span><br>
<span class="lineno">205</span><span class="op" id="4012686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4012689">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="4012765">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="4012845">func</span>&nbsp;<span class="op" id="4012850">(</span><span class="ident" id="4012851">enc</span>&nbsp;<span class="op" id="4012855">*</span><span class="ident" id="4012856">Encoder</span><span class="op" id="4012863">)</span>&nbsp;<span class="ident" id="4012865">EncodeValue</span><span class="op" id="4012876">(</span><span class="ident" id="4012877">value</span>&nbsp;<span class="ident" id="4012883">reflect</span><span class="op" id="4012890">.</span><span class="ident" id="4012891">Value</span><span class="op" id="4012896">)</span>&nbsp;<span class="builtintype" id="4012898">error</span>&nbsp;<span class="op" id="4012904">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012907">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012974">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013003">if</span>&nbsp;<span class="ident" id="4013006">value</span><span class="op" id="4013011">.</span><span class="ident" id="4013012">Kind</span><span class="op" id="4013016">(</span><span class="op" id="4013017">)</span>&nbsp;<span class="op" id="4013019">==</span>&nbsp;<span class="ident" id="4013022">reflect</span><span class="op" id="4013029">.</span><span class="ident" id="4013030">Ptr</span>&nbsp;<span class="op" id="4013034">&amp;&amp;</span>&nbsp;<span class="ident" id="4013037">value</span><span class="op" id="4013042">.</span><span class="ident" id="4013043">IsNil</span><span class="op" id="4013048">(</span><span class="op" id="4013049">)</span>&nbsp;<span class="op" id="4013051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4013055">panic</span><span class="op" id="4013060">(</span><span class="string" id="4013061">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4013103">+</span>&nbsp;<span class="ident" id="4013105">value</span><span class="op" id="4013110">.</span><span class="ident" id="4013111">Type</span><span class="op" id="4013115">(</span><span class="op" id="4013116">)</span><span class="op" id="4013117">.</span><span class="ident" id="4013118">String</span><span class="op" id="4013124">(</span><span class="op" id="4013125">)</span><span class="op" id="4013126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013129">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013133">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013195">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013232">enc</span><span class="op" id="4013235">.</span><span class="ident" id="4013236">mutex</span><span class="op" id="4013241">.</span><span class="ident" id="4013242">Lock</span><span class="op" id="4013246">(</span><span class="op" id="4013247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013250">defer</span>&nbsp;<span class="ident" id="4013256">enc</span><span class="op" id="4013259">.</span><span class="ident" id="4013260">mutex</span><span class="op" id="4013265">.</span><span class="ident" id="4013266">Unlock</span><span class="op" id="4013272">(</span><span class="op" id="4013273">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013277">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013341">enc</span><span class="op" id="4013344">.</span><span class="ident" id="4013345">w</span>&nbsp;<span class="op" id="4013347">=</span>&nbsp;<span class="ident" id="4013349">enc</span><span class="op" id="4013352">.</span><span class="ident" id="4013353">w</span><span class="op" id="4013354">[</span><span class="num" id="4013355">0</span><span class="op" id="4013356">:</span><span class="num" id="4013357">1</span><span class="op" id="4013358">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013362">ut</span><span class="op" id="4013364">,</span>&nbsp;<span class="ident" id="4013366">err</span>&nbsp;<span class="op" id="4013370">:=</span>&nbsp;<span class="ident" id="4013373">validUserType</span><span class="op" id="4013386">(</span><span class="ident" id="4013387">value</span><span class="op" id="4013392">.</span><span class="ident" id="4013393">Type</span><span class="op" id="4013397">(</span><span class="op" id="4013398">)</span><span class="op" id="4013399">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013402">if</span>&nbsp;<span class="ident" id="4013405">err</span>&nbsp;<span class="op" id="4013409">!=</span>&nbsp;<span class="ident" id="4013412">nil</span>&nbsp;<span class="op" id="4013416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013420">return</span>&nbsp;<span class="ident" id="4013427">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013436">enc</span><span class="op" id="4013439">.</span><span class="ident" id="4013440">err</span>&nbsp;<span class="op" id="4013444">=</span>&nbsp;<span class="ident" id="4013446">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013451">enc</span><span class="op" id="4013454">.</span><span class="ident" id="4013455">byteBuf</span><span class="op" id="4013462">.</span><span class="ident" id="4013463">Reset</span><span class="op" id="4013468">(</span><span class="op" id="4013469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013472">enc</span><span class="op" id="4013475">.</span><span class="ident" id="4013476">byteBuf</span><span class="op" id="4013483">.</span><span class="ident" id="4013484">Write</span><span class="op" id="4013489">(</span><span class="ident" id="4013490">spaceForLength</span><span class="op" id="4013504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013507">state</span>&nbsp;<span class="op" id="4013513">:=</span>&nbsp;<span class="ident" id="4013516">enc</span><span class="op" id="4013519">.</span><span class="ident" id="4013520">newEncoderState</span><span class="op" id="4013535">(</span><span class="op" id="4013536">&amp;</span><span class="ident" id="4013537">enc</span><span class="op" id="4013540">.</span><span class="ident" id="4013541">byteBuf</span><span class="op" id="4013548">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013552">enc</span><span class="op" id="4013555">.</span><span class="ident" id="4013556">sendTypeDescriptor</span><span class="op" id="4013574">(</span><span class="ident" id="4013575">enc</span><span class="op" id="4013578">.</span><span class="ident" id="4013579">writer</span><span class="op" id="4013585">(</span><span class="op" id="4013586">)</span><span class="op" id="4013587">,</span>&nbsp;<span class="ident" id="4013589">state</span><span class="op" id="4013594">,</span>&nbsp;<span class="ident" id="4013596">ut</span><span class="op" id="4013598">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013601">enc</span><span class="op" id="4013604">.</span><span class="ident" id="4013605">sendTypeId</span><span class="op" id="4013615">(</span><span class="ident" id="4013616">state</span><span class="op" id="4013621">,</span>&nbsp;<span class="ident" id="4013623">ut</span><span class="op" id="4013625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013628">if</span>&nbsp;<span class="ident" id="4013631">enc</span><span class="op" id="4013634">.</span><span class="ident" id="4013635">err</span>&nbsp;<span class="op" id="4013639">!=</span>&nbsp;<span class="ident" id="4013642">nil</span>&nbsp;<span class="op" id="4013646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013650">return</span>&nbsp;<span class="ident" id="4013657">enc</span><span class="op" id="4013660">.</span><span class="ident" id="4013661">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013670">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013693">enc</span><span class="op" id="4013696">.</span><span class="ident" id="4013697">encode</span><span class="op" id="4013703">(</span><span class="ident" id="4013704">state</span><span class="op" id="4013709">.</span><span class="ident" id="4013710">b</span><span class="op" id="4013711">,</span>&nbsp;<span class="ident" id="4013713">value</span><span class="op" id="4013718">,</span>&nbsp;<span class="ident" id="4013720">ut</span><span class="op" id="4013722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013725">if</span>&nbsp;<span class="ident" id="4013728">enc</span><span class="op" id="4013731">.</span><span class="ident" id="4013732">err</span>&nbsp;<span class="op" id="4013736">==</span>&nbsp;<span class="ident" id="4013739">nil</span>&nbsp;<span class="op" id="4013743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013747">enc</span><span class="op" id="4013750">.</span><span class="ident" id="4013751">writeMessage</span><span class="op" id="4013763">(</span><span class="ident" id="4013764">enc</span><span class="op" id="4013767">.</span><span class="ident" id="4013768">writer</span><span class="op" id="4013774">(</span><span class="op" id="4013775">)</span><span class="op" id="4013776">,</span>&nbsp;<span class="ident" id="4013778">state</span><span class="op" id="4013783">.</span><span class="ident" id="4013784">b</span><span class="op" id="4013785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013788">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013792">enc</span><span class="op" id="4013795">.</span><span class="ident" id="4013796">freeEncoderState</span><span class="op" id="4013812">(</span><span class="ident" id="4013813">state</span><span class="op" id="4013818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013821">return</span>&nbsp;<span class="ident" id="4013828">enc</span><span class="op" id="4013831">.</span><span class="ident" id="4013832">err</span><br>
<span class="lineno"></span><span class="op" id="4013836">}</span>
</div>
</body>
</html>
