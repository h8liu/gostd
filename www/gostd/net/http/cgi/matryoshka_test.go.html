<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8164033">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8164088">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8164142">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8164193">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="8164256">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="8164320">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8164377">package</span>&nbsp;<span class="ident" id="8164385">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="8164390">import</span>&nbsp;<span class="op" id="8164397">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164400">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164409">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164419">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164426">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164432">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164444">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164465">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164471">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164482">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164493">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8164500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8164503">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="8164573">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="8164637">func</span>&nbsp;<span class="ident" id="8164642">TestHostingOurselves</span><span class="op" id="8164662">(</span><span class="ident" id="8164663">t</span>&nbsp;<span class="op" id="8164665">*</span><span class="ident" id="8164666">testing</span><span class="op" id="8164673">.</span><span class="ident" id="8164674">T</span><span class="op" id="8164675">)</span>&nbsp;<span class="op" id="8164677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8164680">if</span>&nbsp;<span class="ident" id="8164683">runtime</span><span class="op" id="8164690">.</span><span class="ident" id="8164691">GOOS</span>&nbsp;<span class="op" id="8164696">==</span>&nbsp;<span class="string" id="8164699">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8164706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164710">t</span><span class="op" id="8164711">.</span><span class="ident" id="8164712">Skip</span><span class="op" id="8164716">(</span><span class="string" id="8164717">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8164735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8164738">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164742">h</span>&nbsp;<span class="op" id="8164744">:=</span>&nbsp;<span class="op" id="8164747">&amp;</span><span class="ident" id="8164748">Handler</span><span class="op" id="8164755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164759">Path</span><span class="op" id="8164763">:</span>&nbsp;<span class="ident" id="8164765">os</span><span class="op" id="8164767">.</span><span class="ident" id="8164768">Args</span><span class="op" id="8164772">[</span><span class="num" id="8164773">0</span><span class="op" id="8164774">]</span><span class="op" id="8164775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164779">Root</span><span class="op" id="8164783">:</span>&nbsp;<span class="string" id="8164785">&#34;/test.go&#34;</span><span class="op" id="8164795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164799">Args</span><span class="op" id="8164803">:</span>&nbsp;<span class="op" id="8164805">[</span><span class="op" id="8164806">]</span><span class="builtintype" id="8164807">string</span><span class="op" id="8164813">{</span><span class="string" id="8164814">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8164847">}</span><span class="op" id="8164848">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8164851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8164854">expectedMap</span>&nbsp;<span class="op" id="8164866">:=</span>&nbsp;<span class="keyword" id="8164869">map</span><span class="op" id="8164872">[</span><span class="builtintype" id="8164873">string</span><span class="op" id="8164879">]</span><span class="builtintype" id="8164880">string</span><span class="op" id="8164886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164890">&#34;test&#34;</span><span class="op" id="8164896">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8164915">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="8164933">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164937">&#34;param-a&#34;</span><span class="op" id="8164946">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8164962">&#34;b&#34;</span><span class="op" id="8164965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8164969">&#34;param-foo&#34;</span><span class="op" id="8164980">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8164994">&#34;bar&#34;</span><span class="op" id="8164999">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165003">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8165026">:</span>&nbsp;<span class="string" id="8165028">&#34;CGI/1.1&#34;</span><span class="op" id="8165037">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165041">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8165056">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165066">&#34;example.com&#34;</span><span class="op" id="8165079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165083">&#34;env-PATH_INFO&#34;</span><span class="op" id="8165098">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165108">&#34;&#34;</span><span class="op" id="8165110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165114">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8165132">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165139">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8165152">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165156">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8165173">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165181">&#34;1.2.3.4&#34;</span><span class="op" id="8165190">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165194">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8165211">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165219">&#34;1.2.3.4&#34;</span><span class="op" id="8165228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165232">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8165252">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165257">&#34;GET&#34;</span><span class="op" id="8165262">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165266">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8165283">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165291">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="8165313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165317">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8165338">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8165342">os</span><span class="op" id="8165344">.</span><span class="ident" id="8165345">Args</span><span class="op" id="8165349">[</span><span class="num" id="8165350">0</span><span class="op" id="8165351">]</span><span class="op" id="8165352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165356">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8165373">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165381">&#34;/test.go&#34;</span><span class="op" id="8165391">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165395">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8165412">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165420">&#34;example.com&#34;</span><span class="op" id="8165433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165437">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8165454">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8165462">&#34;80&#34;</span><span class="op" id="8165466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8165470">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8165491">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8165495">&#34;go&#34;</span><span class="op" id="8165499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8165502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8165505">replay</span>&nbsp;<span class="op" id="8165512">:=</span>&nbsp;<span class="ident" id="8165515">runCgiTest</span><span class="op" id="8165525">(</span><span class="ident" id="8165526">t</span><span class="op" id="8165527">,</span>&nbsp;<span class="ident" id="8165529">h</span><span class="op" id="8165530">,</span>&nbsp;<span class="string" id="8165532">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8165590">,</span>&nbsp;<span class="ident" id="8165592">expectedMap</span><span class="op" id="8165603">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8165607">if</span>&nbsp;<span class="ident" id="8165610">expected</span><span class="op" id="8165618">,</span>&nbsp;<span class="ident" id="8165620">got</span>&nbsp;<span class="op" id="8165624">:=</span>&nbsp;<span class="string" id="8165627">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="8165653">,</span>&nbsp;<span class="ident" id="8165655">replay</span><span class="op" id="8165661">.</span><span class="ident" id="8165662">Header</span><span class="op" id="8165668">(</span><span class="op" id="8165669">)</span><span class="op" id="8165670">.</span><span class="ident" id="8165671">Get</span><span class="op" id="8165674">(</span><span class="string" id="8165675">&#34;Content-Type&#34;</span><span class="op" id="8165689">)</span><span class="op" id="8165690">;</span>&nbsp;<span class="ident" id="8165692">got</span>&nbsp;<span class="op" id="8165696">!=</span>&nbsp;<span class="ident" id="8165699">expected</span>&nbsp;<span class="op" id="8165708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8165712">t</span><span class="op" id="8165713">.</span><span class="ident" id="8165714">Errorf</span><span class="op" id="8165720">(</span><span class="string" id="8165721">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8165760">,</span>&nbsp;<span class="ident" id="8165762">got</span><span class="op" id="8165765">,</span>&nbsp;<span class="ident" id="8165767">expected</span><span class="op" id="8165775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8165778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8165781">if</span>&nbsp;<span class="ident" id="8165784">expected</span><span class="op" id="8165792">,</span>&nbsp;<span class="ident" id="8165794">got</span>&nbsp;<span class="op" id="8165798">:=</span>&nbsp;<span class="string" id="8165801">&#34;X-Test-Value&#34;</span><span class="op" id="8165815">,</span>&nbsp;<span class="ident" id="8165817">replay</span><span class="op" id="8165823">.</span><span class="ident" id="8165824">Header</span><span class="op" id="8165830">(</span><span class="op" id="8165831">)</span><span class="op" id="8165832">.</span><span class="ident" id="8165833">Get</span><span class="op" id="8165836">(</span><span class="string" id="8165837">&#34;X-Test-Header&#34;</span><span class="op" id="8165852">)</span><span class="op" id="8165853">;</span>&nbsp;<span class="ident" id="8165855">got</span>&nbsp;<span class="op" id="8165859">!=</span>&nbsp;<span class="ident" id="8165862">expected</span>&nbsp;<span class="op" id="8165871">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8165875">t</span><span class="op" id="8165876">.</span><span class="ident" id="8165877">Errorf</span><span class="op" id="8165883">(</span><span class="string" id="8165884">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8165924">,</span>&nbsp;<span class="ident" id="8165926">got</span><span class="op" id="8165929">,</span>&nbsp;<span class="ident" id="8165931">expected</span><span class="op" id="8165939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8165942">}</span><br>
<span class="lineno"></span><span class="op" id="8165944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8165947">type</span>&nbsp;<span class="ident" id="8165952">customWriterRecorder</span>&nbsp;<span class="keyword" id="8165973">struct</span>&nbsp;<span class="op" id="8165980">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8165983">w</span>&nbsp;<span class="ident" id="8165985">io</span><span class="op" id="8165987">.</span><span class="ident" id="8165988">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8165996">*</span><span class="ident" id="8165997">httptest</span><span class="op" id="8166005">.</span><span class="ident" id="8166006">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="8166023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8166026">func</span>&nbsp;<span class="op" id="8166031">(</span><span class="ident" id="8166032">r</span>&nbsp;<span class="op" id="8166034">*</span><span class="ident" id="8166035">customWriterRecorder</span><span class="op" id="8166055">)</span>&nbsp;<span class="ident" id="8166057">Write</span><span class="op" id="8166062">(</span><span class="ident" id="8166063">p</span>&nbsp;<span class="op" id="8166065">[</span><span class="op" id="8166066">]</span><span class="builtintype" id="8166067">byte</span><span class="op" id="8166071">)</span>&nbsp;<span class="op" id="8166073">(</span><span class="ident" id="8166074">n</span>&nbsp;<span class="builtintype" id="8166076">int</span><span class="op" id="8166079">,</span>&nbsp;<span class="ident" id="8166081">err</span>&nbsp;<span class="builtintype" id="8166085">error</span><span class="op" id="8166090">)</span>&nbsp;<span class="op" id="8166092">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166095">return</span>&nbsp;<span class="ident" id="8166102">r</span><span class="op" id="8166103">.</span><span class="ident" id="8166104">w</span><span class="op" id="8166105">.</span><span class="ident" id="8166106">Write</span><span class="op" id="8166111">(</span><span class="ident" id="8166112">p</span><span class="op" id="8166113">)</span><br>
<span class="lineno"></span><span class="op" id="8166115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8166118">type</span>&nbsp;<span class="ident" id="8166123">limitWriter</span>&nbsp;<span class="keyword" id="8166135">struct</span>&nbsp;<span class="op" id="8166142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166145">w</span>&nbsp;<span class="ident" id="8166147">io</span><span class="op" id="8166149">.</span><span class="ident" id="8166150">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166158">n</span>&nbsp;<span class="builtintype" id="8166160">int</span><br>
<span class="lineno"></span><span class="op" id="8166164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8166167">func</span>&nbsp;<span class="op" id="8166172">(</span><span class="ident" id="8166173">w</span>&nbsp;<span class="op" id="8166175">*</span><span class="ident" id="8166176">limitWriter</span><span class="op" id="8166187">)</span>&nbsp;<span class="ident" id="8166189">Write</span><span class="op" id="8166194">(</span><span class="ident" id="8166195">p</span>&nbsp;<span class="op" id="8166197">[</span><span class="op" id="8166198">]</span><span class="builtintype" id="8166199">byte</span><span class="op" id="8166203">)</span>&nbsp;<span class="op" id="8166205">(</span><span class="ident" id="8166206">n</span>&nbsp;<span class="builtintype" id="8166208">int</span><span class="op" id="8166211">,</span>&nbsp;<span class="ident" id="8166213">err</span>&nbsp;<span class="builtintype" id="8166217">error</span><span class="op" id="8166222">)</span>&nbsp;<span class="op" id="8166224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166227">if</span>&nbsp;<span class="builtinfunc" id="8166230">len</span><span class="op" id="8166233">(</span><span class="ident" id="8166234">p</span><span class="op" id="8166235">)</span>&nbsp;<span class="op" id="8166237">&gt;</span>&nbsp;<span class="ident" id="8166239">w</span><span class="op" id="8166240">.</span><span class="ident" id="8166241">n</span>&nbsp;<span class="op" id="8166243">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166247">p</span>&nbsp;<span class="op" id="8166249">=</span>&nbsp;<span class="ident" id="8166251">p</span><span class="op" id="8166252">[</span><span class="op" id="8166253">:</span><span class="ident" id="8166254">w</span><span class="op" id="8166255">.</span><span class="ident" id="8166256">n</span><span class="op" id="8166257">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166263">if</span>&nbsp;<span class="builtinfunc" id="8166266">len</span><span class="op" id="8166269">(</span><span class="ident" id="8166270">p</span><span class="op" id="8166271">)</span>&nbsp;<span class="op" id="8166273">&gt;</span>&nbsp;<span class="num" id="8166275">0</span>&nbsp;<span class="op" id="8166277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166281">n</span><span class="op" id="8166282">,</span>&nbsp;<span class="ident" id="8166284">err</span>&nbsp;<span class="op" id="8166288">=</span>&nbsp;<span class="ident" id="8166290">w</span><span class="op" id="8166291">.</span><span class="ident" id="8166292">w</span><span class="op" id="8166293">.</span><span class="ident" id="8166294">Write</span><span class="op" id="8166299">(</span><span class="ident" id="8166300">p</span><span class="op" id="8166301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166305">w</span><span class="op" id="8166306">.</span><span class="ident" id="8166307">n</span>&nbsp;<span class="op" id="8166309">-=</span>&nbsp;<span class="ident" id="8166312">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166318">if</span>&nbsp;<span class="ident" id="8166321">w</span><span class="op" id="8166322">.</span><span class="ident" id="8166323">n</span>&nbsp;<span class="op" id="8166325">==</span>&nbsp;<span class="num" id="8166328">0</span>&nbsp;<span class="op" id="8166330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166334">err</span>&nbsp;<span class="op" id="8166338">=</span>&nbsp;<span class="ident" id="8166340">errors</span><span class="op" id="8166346">.</span><span class="ident" id="8166347">New</span><span class="op" id="8166350">(</span><span class="string" id="8166351">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="8166369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166375">return</span><br>
<span class="lineno">90</span><span class="op" id="8166382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8166385">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="8166455">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="8166482">func</span>&nbsp;<span class="ident" id="8166487">TestKillChildAfterCopyError</span><span class="op" id="8166514">(</span><span class="ident" id="8166515">t</span>&nbsp;<span class="op" id="8166517">*</span><span class="ident" id="8166518">testing</span><span class="op" id="8166525">.</span><span class="ident" id="8166526">T</span><span class="op" id="8166527">)</span>&nbsp;<span class="op" id="8166529">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166532">if</span>&nbsp;<span class="ident" id="8166535">runtime</span><span class="op" id="8166542">.</span><span class="ident" id="8166543">GOOS</span>&nbsp;<span class="op" id="8166548">==</span>&nbsp;<span class="string" id="8166551">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8166558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166562">t</span><span class="op" id="8166563">.</span><span class="ident" id="8166564">Skip</span><span class="op" id="8166568">(</span><span class="string" id="8166569">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8166587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166594">defer</span>&nbsp;<span class="keyword" id="8166600">func</span><span class="op" id="8166604">(</span><span class="op" id="8166605">)</span>&nbsp;<span class="op" id="8166607">{</span>&nbsp;<span class="ident" id="8166609">testHookStartProcess</span>&nbsp;<span class="op" id="8166630">=</span>&nbsp;<span class="ident" id="8166632">nil</span>&nbsp;<span class="op" id="8166636">}</span><span class="op" id="8166637">(</span><span class="op" id="8166638">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166641">proc</span>&nbsp;<span class="op" id="8166646">:=</span>&nbsp;<span class="builtinfunc" id="8166649">make</span><span class="op" id="8166653">(</span><span class="keyword" id="8166654">chan</span>&nbsp;<span class="op" id="8166659">*</span><span class="ident" id="8166660">os</span><span class="op" id="8166662">.</span><span class="ident" id="8166663">Process</span><span class="op" id="8166670">,</span>&nbsp;<span class="num" id="8166672">1</span><span class="op" id="8166673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166676">testHookStartProcess</span>&nbsp;<span class="op" id="8166697">=</span>&nbsp;<span class="keyword" id="8166699">func</span><span class="op" id="8166703">(</span><span class="ident" id="8166704">p</span>&nbsp;<span class="op" id="8166706">*</span><span class="ident" id="8166707">os</span><span class="op" id="8166709">.</span><span class="ident" id="8166710">Process</span><span class="op" id="8166717">)</span>&nbsp;<span class="op" id="8166719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166723">proc</span>&nbsp;<span class="op" id="8166728">&lt;-</span>&nbsp;<span class="ident" id="8166731">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166738">h</span>&nbsp;<span class="op" id="8166740">:=</span>&nbsp;<span class="op" id="8166743">&amp;</span><span class="ident" id="8166744">Handler</span><span class="op" id="8166751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166755">Path</span><span class="op" id="8166759">:</span>&nbsp;<span class="ident" id="8166761">os</span><span class="op" id="8166763">.</span><span class="ident" id="8166764">Args</span><span class="op" id="8166768">[</span><span class="num" id="8166769">0</span><span class="op" id="8166770">]</span><span class="op" id="8166771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166775">Root</span><span class="op" id="8166779">:</span>&nbsp;<span class="string" id="8166781">&#34;/test.go&#34;</span><span class="op" id="8166791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166795">Args</span><span class="op" id="8166799">:</span>&nbsp;<span class="op" id="8166801">[</span><span class="op" id="8166802">]</span><span class="builtintype" id="8166803">string</span><span class="op" id="8166809">{</span><span class="string" id="8166810">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8166843">}</span><span class="op" id="8166844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8166847">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166850">req</span><span class="op" id="8166853">,</span>&nbsp;<span class="ident" id="8166855">_</span>&nbsp;<span class="op" id="8166857">:=</span>&nbsp;<span class="ident" id="8166860">http</span><span class="op" id="8166864">.</span><span class="ident" id="8166865">NewRequest</span><span class="op" id="8166875">(</span><span class="string" id="8166876">&#34;GET&#34;</span><span class="op" id="8166881">,</span>&nbsp;<span class="string" id="8166883">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="8166928">,</span>&nbsp;<span class="ident" id="8166930">nil</span><span class="op" id="8166933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8166936">rec</span>&nbsp;<span class="op" id="8166940">:=</span>&nbsp;<span class="ident" id="8166943">httptest</span><span class="op" id="8166951">.</span><span class="ident" id="8166952">NewRecorder</span><span class="op" id="8166963">(</span><span class="op" id="8166964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166967">var</span>&nbsp;<span class="ident" id="8166971">out</span>&nbsp;<span class="ident" id="8166975">bytes</span><span class="op" id="8166980">.</span><span class="ident" id="8166981">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8166989">const</span>&nbsp;<span class="ident" id="8166995">writeLen</span>&nbsp;<span class="op" id="8167004">=</span>&nbsp;<span class="num" id="8167006">50</span>&nbsp;<span class="op" id="8167009">&lt;&lt;</span>&nbsp;<span class="num" id="8167012">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167016">rw</span>&nbsp;<span class="op" id="8167019">:=</span>&nbsp;<span class="op" id="8167022">&amp;</span><span class="ident" id="8167023">customWriterRecorder</span><span class="op" id="8167043">{</span><span class="op" id="8167044">&amp;</span><span class="ident" id="8167045">limitWriter</span><span class="op" id="8167056">{</span><span class="op" id="8167057">&amp;</span><span class="ident" id="8167058">out</span><span class="op" id="8167061">,</span>&nbsp;<span class="ident" id="8167063">writeLen</span><span class="op" id="8167071">}</span><span class="op" id="8167072">,</span>&nbsp;<span class="ident" id="8167074">rec</span><span class="op" id="8167077">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167081">donec</span>&nbsp;<span class="op" id="8167087">:=</span>&nbsp;<span class="builtinfunc" id="8167090">make</span><span class="op" id="8167094">(</span><span class="keyword" id="8167095">chan</span>&nbsp;<span class="builtintype" id="8167100">bool</span><span class="op" id="8167104">,</span>&nbsp;<span class="num" id="8167106">1</span><span class="op" id="8167107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167110">go</span>&nbsp;<span class="keyword" id="8167113">func</span><span class="op" id="8167117">(</span><span class="op" id="8167118">)</span>&nbsp;<span class="op" id="8167120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167124">h</span><span class="op" id="8167125">.</span><span class="ident" id="8167126">ServeHTTP</span><span class="op" id="8167135">(</span><span class="ident" id="8167136">rw</span><span class="op" id="8167138">,</span>&nbsp;<span class="ident" id="8167140">req</span><span class="op" id="8167143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167147">donec</span>&nbsp;<span class="op" id="8167153">&lt;-</span>&nbsp;<span class="builtintype" id="8167156">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167162">}</span><span class="op" id="8167163">(</span><span class="op" id="8167164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167168">select</span>&nbsp;<span class="op" id="8167175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167178">case</span>&nbsp;<span class="op" id="8167183">&lt;-</span><span class="ident" id="8167185">donec</span><span class="op" id="8167190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167194">if</span>&nbsp;<span class="ident" id="8167197">out</span><span class="op" id="8167200">.</span><span class="ident" id="8167201">Len</span><span class="op" id="8167204">(</span><span class="op" id="8167205">)</span>&nbsp;<span class="op" id="8167207">!=</span>&nbsp;<span class="ident" id="8167210">writeLen</span>&nbsp;<span class="op" id="8167219">||</span>&nbsp;<span class="ident" id="8167222">out</span><span class="op" id="8167225">.</span><span class="ident" id="8167226">Bytes</span><span class="op" id="8167231">(</span><span class="op" id="8167232">)</span><span class="op" id="8167233">[</span><span class="num" id="8167234">0</span><span class="op" id="8167235">]</span>&nbsp;<span class="op" id="8167237">!=</span>&nbsp;<span class="string" id="8167240">&#39;a&#39;</span>&nbsp;<span class="op" id="8167244">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167249">t</span><span class="op" id="8167250">.</span><span class="ident" id="8167251">Errorf</span><span class="op" id="8167257">(</span><span class="string" id="8167258">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="8167281">,</span>&nbsp;<span class="ident" id="8167283">out</span><span class="op" id="8167286">.</span><span class="ident" id="8167287">Bytes</span><span class="op" id="8167292">(</span><span class="op" id="8167293">)</span><span class="op" id="8167294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167301">case</span>&nbsp;<span class="op" id="8167306">&lt;-</span><span class="ident" id="8167308">time</span><span class="op" id="8167312">.</span><span class="ident" id="8167313">After</span><span class="op" id="8167318">(</span><span class="num" id="8167319">5</span>&nbsp;<span class="op" id="8167321">*</span>&nbsp;<span class="ident" id="8167323">time</span><span class="op" id="8167327">.</span><span class="ident" id="8167328">Second</span><span class="op" id="8167334">)</span><span class="op" id="8167335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167339">t</span><span class="op" id="8167340">.</span><span class="ident" id="8167341">Errorf</span><span class="op" id="8167347">(</span><span class="string" id="8167348">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="8167408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167412">select</span>&nbsp;<span class="op" id="8167419">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167423">case</span>&nbsp;<span class="ident" id="8167428">p</span>&nbsp;<span class="op" id="8167430">:=</span>&nbsp;<span class="op" id="8167433">&lt;-</span><span class="ident" id="8167435">proc</span><span class="op" id="8167439">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167444">p</span><span class="op" id="8167445">.</span><span class="ident" id="8167446">Kill</span><span class="op" id="8167450">(</span><span class="op" id="8167451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167456">t</span><span class="op" id="8167457">.</span><span class="ident" id="8167458">Logf</span><span class="op" id="8167462">(</span><span class="string" id="8167463">&#34;killed&nbsp;process&#34;</span><span class="op" id="8167479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167483">default</span><span class="op" id="8167490">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167495">t</span><span class="op" id="8167496">.</span><span class="ident" id="8167497">Logf</span><span class="op" id="8167501">(</span><span class="string" id="8167502">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="8167523">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167530">}</span><br>
<span class="lineno"></span><span class="op" id="8167532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8167535">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="8167592">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="8167617">func</span>&nbsp;<span class="ident" id="8167622">TestChildOnlyHeaders</span><span class="op" id="8167642">(</span><span class="ident" id="8167643">t</span>&nbsp;<span class="op" id="8167645">*</span><span class="ident" id="8167646">testing</span><span class="op" id="8167653">.</span><span class="ident" id="8167654">T</span><span class="op" id="8167655">)</span>&nbsp;<span class="op" id="8167657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167660">if</span>&nbsp;<span class="ident" id="8167663">runtime</span><span class="op" id="8167670">.</span><span class="ident" id="8167671">GOOS</span>&nbsp;<span class="op" id="8167676">==</span>&nbsp;<span class="string" id="8167679">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8167686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167690">t</span><span class="op" id="8167691">.</span><span class="ident" id="8167692">Skip</span><span class="op" id="8167696">(</span><span class="string" id="8167697">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8167715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167718">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167722">h</span>&nbsp;<span class="op" id="8167724">:=</span>&nbsp;<span class="op" id="8167727">&amp;</span><span class="ident" id="8167728">Handler</span><span class="op" id="8167735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167739">Path</span><span class="op" id="8167743">:</span>&nbsp;<span class="ident" id="8167745">os</span><span class="op" id="8167747">.</span><span class="ident" id="8167748">Args</span><span class="op" id="8167752">[</span><span class="num" id="8167753">0</span><span class="op" id="8167754">]</span><span class="op" id="8167755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167759">Root</span><span class="op" id="8167763">:</span>&nbsp;<span class="string" id="8167765">&#34;/test.go&#34;</span><span class="op" id="8167775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167779">Args</span><span class="op" id="8167783">:</span>&nbsp;<span class="op" id="8167785">[</span><span class="op" id="8167786">]</span><span class="builtintype" id="8167787">string</span><span class="op" id="8167793">{</span><span class="string" id="8167794">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8167827">}</span><span class="op" id="8167828">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167834">expectedMap</span>&nbsp;<span class="op" id="8167846">:=</span>&nbsp;<span class="keyword" id="8167849">map</span><span class="op" id="8167852">[</span><span class="builtintype" id="8167853">string</span><span class="op" id="8167859">]</span><span class="builtintype" id="8167860">string</span><span class="op" id="8167866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8167870">&#34;_body&#34;</span><span class="op" id="8167877">:</span>&nbsp;<span class="string" id="8167879">&#34;&#34;</span><span class="op" id="8167881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8167884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8167887">replay</span>&nbsp;<span class="op" id="8167894">:=</span>&nbsp;<span class="ident" id="8167897">runCgiTest</span><span class="op" id="8167907">(</span><span class="ident" id="8167908">t</span><span class="op" id="8167909">,</span>&nbsp;<span class="ident" id="8167911">h</span><span class="op" id="8167912">,</span>&nbsp;<span class="string" id="8167914">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8167970">,</span>&nbsp;<span class="ident" id="8167972">expectedMap</span><span class="op" id="8167983">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8167986">if</span>&nbsp;<span class="ident" id="8167989">expected</span><span class="op" id="8167997">,</span>&nbsp;<span class="ident" id="8167999">got</span>&nbsp;<span class="op" id="8168003">:=</span>&nbsp;<span class="string" id="8168006">&#34;X-Test-Value&#34;</span><span class="op" id="8168020">,</span>&nbsp;<span class="ident" id="8168022">replay</span><span class="op" id="8168028">.</span><span class="ident" id="8168029">Header</span><span class="op" id="8168035">(</span><span class="op" id="8168036">)</span><span class="op" id="8168037">.</span><span class="ident" id="8168038">Get</span><span class="op" id="8168041">(</span><span class="string" id="8168042">&#34;X-Test-Header&#34;</span><span class="op" id="8168057">)</span><span class="op" id="8168058">;</span>&nbsp;<span class="ident" id="8168060">got</span>&nbsp;<span class="op" id="8168064">!=</span>&nbsp;<span class="ident" id="8168067">expected</span>&nbsp;<span class="op" id="8168076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168080">t</span><span class="op" id="8168081">.</span><span class="ident" id="8168082">Errorf</span><span class="op" id="8168088">(</span><span class="string" id="8168089">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8168129">,</span>&nbsp;<span class="ident" id="8168131">got</span><span class="op" id="8168134">,</span>&nbsp;<span class="ident" id="8168136">expected</span><span class="op" id="8168144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8168147">}</span><br>
<span class="lineno"></span><span class="op" id="8168149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="8168152">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="8168177">func</span>&nbsp;<span class="ident" id="8168182">Test500WithNoHeaders</span><span class="op" id="8168202">(</span><span class="ident" id="8168203">t</span>&nbsp;<span class="op" id="8168205">*</span><span class="ident" id="8168206">testing</span><span class="op" id="8168213">.</span><span class="ident" id="8168214">T</span><span class="op" id="8168215">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8168221">{</span>&nbsp;<span class="ident" id="8168223">want500Test</span><span class="op" id="8168234">(</span><span class="ident" id="8168235">t</span><span class="op" id="8168236">,</span>&nbsp;<span class="string" id="8168238">&#34;/immediate-disconnect&#34;</span><span class="op" id="8168261">)</span>&nbsp;<span class="op" id="8168263">}</span><br>
<span class="lineno"></span><span class="keyword" id="8168265">func</span>&nbsp;<span class="ident" id="8168270">Test500WithNoContentType</span><span class="op" id="8168294">(</span><span class="ident" id="8168295">t</span>&nbsp;<span class="op" id="8168297">*</span><span class="ident" id="8168298">testing</span><span class="op" id="8168305">.</span><span class="ident" id="8168306">T</span><span class="op" id="8168307">)</span>&nbsp;<span class="op" id="8168309">{</span>&nbsp;<span class="ident" id="8168311">want500Test</span><span class="op" id="8168322">(</span><span class="ident" id="8168323">t</span><span class="op" id="8168324">,</span>&nbsp;<span class="string" id="8168326">&#34;/no-content-type&#34;</span><span class="op" id="8168344">)</span>&nbsp;<span class="op" id="8168346">}</span><br>
<span class="lineno"></span><span class="keyword" id="8168348">func</span>&nbsp;<span class="ident" id="8168353">Test500WithEmptyHeaders</span><span class="op" id="8168376">(</span><span class="ident" id="8168377">t</span>&nbsp;<span class="op" id="8168379">*</span><span class="ident" id="8168380">testing</span><span class="op" id="8168387">.</span><span class="ident" id="8168388">T</span><span class="op" id="8168389">)</span>&nbsp;&nbsp;<span class="op" id="8168392">{</span>&nbsp;<span class="ident" id="8168394">want500Test</span><span class="op" id="8168405">(</span><span class="ident" id="8168406">t</span><span class="op" id="8168407">,</span>&nbsp;<span class="string" id="8168409">&#34;/empty-headers&#34;</span><span class="op" id="8168425">)</span>&nbsp;<span class="op" id="8168427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8168430">func</span>&nbsp;<span class="ident" id="8168435">want500Test</span><span class="op" id="8168446">(</span><span class="ident" id="8168447">t</span>&nbsp;<span class="op" id="8168449">*</span><span class="ident" id="8168450">testing</span><span class="op" id="8168457">.</span><span class="ident" id="8168458">T</span><span class="op" id="8168459">,</span>&nbsp;<span class="ident" id="8168461">path</span>&nbsp;<span class="builtintype" id="8168466">string</span><span class="op" id="8168472">)</span>&nbsp;<span class="op" id="8168474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168477">h</span>&nbsp;<span class="op" id="8168479">:=</span>&nbsp;<span class="op" id="8168482">&amp;</span><span class="ident" id="8168483">Handler</span><span class="op" id="8168490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168494">Path</span><span class="op" id="8168498">:</span>&nbsp;<span class="ident" id="8168500">os</span><span class="op" id="8168502">.</span><span class="ident" id="8168503">Args</span><span class="op" id="8168507">[</span><span class="num" id="8168508">0</span><span class="op" id="8168509">]</span><span class="op" id="8168510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168514">Root</span><span class="op" id="8168518">:</span>&nbsp;<span class="string" id="8168520">&#34;/test.go&#34;</span><span class="op" id="8168530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168534">Args</span><span class="op" id="8168538">:</span>&nbsp;<span class="op" id="8168540">[</span><span class="op" id="8168541">]</span><span class="builtintype" id="8168542">string</span><span class="op" id="8168548">{</span><span class="string" id="8168549">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8168582">}</span><span class="op" id="8168583">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8168586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168589">expectedMap</span>&nbsp;<span class="op" id="8168601">:=</span>&nbsp;<span class="keyword" id="8168604">map</span><span class="op" id="8168607">[</span><span class="builtintype" id="8168608">string</span><span class="op" id="8168614">]</span><span class="builtintype" id="8168615">string</span><span class="op" id="8168621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8168625">&#34;_body&#34;</span><span class="op" id="8168632">:</span>&nbsp;<span class="string" id="8168634">&#34;&#34;</span><span class="op" id="8168636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8168639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168642">replay</span>&nbsp;<span class="op" id="8168649">:=</span>&nbsp;<span class="ident" id="8168652">runCgiTest</span><span class="op" id="8168662">(</span><span class="ident" id="8168663">t</span><span class="op" id="8168664">,</span>&nbsp;<span class="ident" id="8168666">h</span><span class="op" id="8168667">,</span>&nbsp;<span class="string" id="8168669">&#34;GET&nbsp;&#34;</span><span class="op" id="8168675">+</span><span class="ident" id="8168676">path</span><span class="op" id="8168680">+</span><span class="string" id="8168681">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8168715">,</span>&nbsp;<span class="ident" id="8168717">expectedMap</span><span class="op" id="8168728">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8168731">if</span>&nbsp;<span class="ident" id="8168734">replay</span><span class="op" id="8168740">.</span><span class="ident" id="8168741">Code</span>&nbsp;<span class="op" id="8168746">!=</span>&nbsp;<span class="num" id="8168749">500</span>&nbsp;<span class="op" id="8168753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168757">t</span><span class="op" id="8168758">.</span><span class="ident" id="8168759">Errorf</span><span class="op" id="8168765">(</span><span class="string" id="8168766">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="8168789">,</span>&nbsp;<span class="ident" id="8168791">replay</span><span class="op" id="8168797">.</span><span class="ident" id="8168798">Code</span><span class="op" id="8168802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8168805">}</span><br>
<span class="lineno"></span><span class="op" id="8168807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8168810">type</span>&nbsp;<span class="ident" id="8168815">neverEnding</span>&nbsp;<span class="builtintype" id="8168827">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8168833">func</span>&nbsp;<span class="op" id="8168838">(</span><span class="ident" id="8168839">b</span>&nbsp;<span class="ident" id="8168841">neverEnding</span><span class="op" id="8168852">)</span>&nbsp;<span class="ident" id="8168854">Read</span><span class="op" id="8168858">(</span><span class="ident" id="8168859">p</span>&nbsp;<span class="op" id="8168861">[</span><span class="op" id="8168862">]</span><span class="builtintype" id="8168863">byte</span><span class="op" id="8168867">)</span>&nbsp;<span class="op" id="8168869">(</span><span class="ident" id="8168870">n</span>&nbsp;<span class="builtintype" id="8168872">int</span><span class="op" id="8168875">,</span>&nbsp;<span class="ident" id="8168877">err</span>&nbsp;<span class="builtintype" id="8168881">error</span><span class="op" id="8168886">)</span>&nbsp;<span class="op" id="8168888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8168891">for</span>&nbsp;<span class="ident" id="8168895">i</span>&nbsp;<span class="op" id="8168897">:=</span>&nbsp;<span class="keyword" id="8168900">range</span>&nbsp;<span class="ident" id="8168906">p</span>&nbsp;<span class="op" id="8168908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8168912">p</span><span class="op" id="8168913">[</span><span class="ident" id="8168914">i</span><span class="op" id="8168915">]</span>&nbsp;<span class="op" id="8168917">=</span>&nbsp;<span class="builtintype" id="8168919">byte</span><span class="op" id="8168923">(</span><span class="ident" id="8168924">b</span><span class="op" id="8168925">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8168928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8168931">return</span>&nbsp;<span class="builtinfunc" id="8168938">len</span><span class="op" id="8168941">(</span><span class="ident" id="8168942">p</span><span class="op" id="8168943">)</span><span class="op" id="8168944">,</span>&nbsp;<span class="ident" id="8168946">nil</span><br>
<span class="lineno"></span><span class="op" id="8168950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8168953">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="8168983">func</span>&nbsp;<span class="ident" id="8168988">TestBeChildCGIProcess</span><span class="op" id="8169009">(</span><span class="ident" id="8169010">t</span>&nbsp;<span class="op" id="8169012">*</span><span class="ident" id="8169013">testing</span><span class="op" id="8169020">.</span><span class="ident" id="8169021">T</span><span class="op" id="8169022">)</span>&nbsp;<span class="op" id="8169024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169027">if</span>&nbsp;<span class="ident" id="8169030">os</span><span class="op" id="8169032">.</span><span class="ident" id="8169033">Getenv</span><span class="op" id="8169039">(</span><span class="string" id="8169040">&#34;REQUEST_METHOD&#34;</span><span class="op" id="8169056">)</span>&nbsp;<span class="op" id="8169058">==</span>&nbsp;<span class="string" id="8169061">&#34;&#34;</span>&nbsp;<span class="op" id="8169064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8169068">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169122">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169125">switch</span>&nbsp;<span class="ident" id="8169132">os</span><span class="op" id="8169134">.</span><span class="ident" id="8169135">Getenv</span><span class="op" id="8169141">(</span><span class="string" id="8169142">&#34;REQUEST_URI&#34;</span><span class="op" id="8169155">)</span>&nbsp;<span class="op" id="8169157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169160">case</span>&nbsp;<span class="string" id="8169165">&#34;/immediate-disconnect&#34;</span><span class="op" id="8169188">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169192">os</span><span class="op" id="8169194">.</span><span class="ident" id="8169195">Exit</span><span class="op" id="8169199">(</span><span class="num" id="8169200">0</span><span class="op" id="8169201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169204">case</span>&nbsp;<span class="string" id="8169209">&#34;/no-content-type&#34;</span><span class="op" id="8169227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169231">fmt</span><span class="op" id="8169234">.</span><span class="ident" id="8169235">Printf</span><span class="op" id="8169241">(</span><span class="string" id="8169242">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="8169272">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169276">os</span><span class="op" id="8169278">.</span><span class="ident" id="8169279">Exit</span><span class="op" id="8169283">(</span><span class="num" id="8169284">0</span><span class="op" id="8169285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169288">case</span>&nbsp;<span class="string" id="8169293">&#34;/empty-headers&#34;</span><span class="op" id="8169309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169313">fmt</span><span class="op" id="8169316">.</span><span class="ident" id="8169317">Printf</span><span class="op" id="8169323">(</span><span class="string" id="8169324">&#34;\nHello&#34;</span><span class="op" id="8169333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169337">os</span><span class="op" id="8169339">.</span><span class="ident" id="8169340">Exit</span><span class="op" id="8169344">(</span><span class="num" id="8169345">0</span><span class="op" id="8169346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169349">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169352">Serve</span><span class="op" id="8169357">(</span><span class="ident" id="8169358">http</span><span class="op" id="8169362">.</span><span class="ident" id="8169363">HandlerFunc</span><span class="op" id="8169374">(</span><span class="keyword" id="8169375">func</span><span class="op" id="8169379">(</span><span class="ident" id="8169380">rw</span>&nbsp;<span class="ident" id="8169383">http</span><span class="op" id="8169387">.</span><span class="ident" id="8169388">ResponseWriter</span><span class="op" id="8169402">,</span>&nbsp;<span class="ident" id="8169404">req</span>&nbsp;<span class="op" id="8169408">*</span><span class="ident" id="8169409">http</span><span class="op" id="8169413">.</span><span class="ident" id="8169414">Request</span><span class="op" id="8169421">)</span>&nbsp;<span class="op" id="8169423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169427">rw</span><span class="op" id="8169429">.</span><span class="ident" id="8169430">Header</span><span class="op" id="8169436">(</span><span class="op" id="8169437">)</span><span class="op" id="8169438">.</span><span class="ident" id="8169439">Set</span><span class="op" id="8169442">(</span><span class="string" id="8169443">&#34;X-Test-Header&#34;</span><span class="op" id="8169458">,</span>&nbsp;<span class="string" id="8169460">&#34;X-Test-Value&#34;</span><span class="op" id="8169474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169478">req</span><span class="op" id="8169481">.</span><span class="ident" id="8169482">ParseForm</span><span class="op" id="8169491">(</span><span class="op" id="8169492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169496">if</span>&nbsp;<span class="ident" id="8169499">req</span><span class="op" id="8169502">.</span><span class="ident" id="8169503">FormValue</span><span class="op" id="8169512">(</span><span class="string" id="8169513">&#34;no-body&#34;</span><span class="op" id="8169522">)</span>&nbsp;<span class="op" id="8169524">==</span>&nbsp;<span class="string" id="8169527">&#34;1&#34;</span>&nbsp;<span class="op" id="8169531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169536">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169549">if</span>&nbsp;<span class="ident" id="8169552">req</span><span class="op" id="8169555">.</span><span class="ident" id="8169556">FormValue</span><span class="op" id="8169565">(</span><span class="string" id="8169566">&#34;write-forever&#34;</span><span class="op" id="8169581">)</span>&nbsp;<span class="op" id="8169583">==</span>&nbsp;<span class="string" id="8169586">&#34;1&#34;</span>&nbsp;<span class="op" id="8169590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169595">io</span><span class="op" id="8169597">.</span><span class="ident" id="8169598">Copy</span><span class="op" id="8169602">(</span><span class="ident" id="8169603">rw</span><span class="op" id="8169605">,</span>&nbsp;<span class="ident" id="8169607">neverEnding</span><span class="op" id="8169618">(</span><span class="string" id="8169619">&#39;a&#39;</span><span class="op" id="8169622">)</span><span class="op" id="8169623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169628">for</span>&nbsp;<span class="op" id="8169632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169638">time</span><span class="op" id="8169642">.</span><span class="ident" id="8169643">Sleep</span><span class="op" id="8169648">(</span><span class="num" id="8169649">5</span>&nbsp;<span class="op" id="8169651">*</span>&nbsp;<span class="ident" id="8169653">time</span><span class="op" id="8169657">.</span><span class="ident" id="8169658">Second</span><span class="op" id="8169664">)</span>&nbsp;<span class="comment" id="8169666">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169707">fmt</span><span class="op" id="8169710">.</span><span class="ident" id="8169711">Fprintf</span><span class="op" id="8169718">(</span><span class="ident" id="8169719">rw</span><span class="op" id="8169721">,</span>&nbsp;<span class="string" id="8169723">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="8169748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169752">for</span>&nbsp;<span class="ident" id="8169756">k</span><span class="op" id="8169757">,</span>&nbsp;<span class="ident" id="8169759">vv</span>&nbsp;<span class="op" id="8169762">:=</span>&nbsp;<span class="keyword" id="8169765">range</span>&nbsp;<span class="ident" id="8169771">req</span><span class="op" id="8169774">.</span><span class="ident" id="8169775">Form</span>&nbsp;<span class="op" id="8169780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169785">for</span>&nbsp;<span class="ident" id="8169789">_</span><span class="op" id="8169790">,</span>&nbsp;<span class="ident" id="8169792">v</span>&nbsp;<span class="op" id="8169794">:=</span>&nbsp;<span class="keyword" id="8169797">range</span>&nbsp;<span class="ident" id="8169803">vv</span>&nbsp;<span class="op" id="8169806">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169812">fmt</span><span class="op" id="8169815">.</span><span class="ident" id="8169816">Fprintf</span><span class="op" id="8169823">(</span><span class="ident" id="8169824">rw</span><span class="op" id="8169826">,</span>&nbsp;<span class="string" id="8169828">&#34;param-%s=%s\n&#34;</span><span class="op" id="8169843">,</span>&nbsp;<span class="ident" id="8169845">k</span><span class="op" id="8169846">,</span>&nbsp;<span class="ident" id="8169848">v</span><span class="op" id="8169849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8169862">for</span>&nbsp;<span class="ident" id="8169866">_</span><span class="op" id="8169867">,</span>&nbsp;<span class="ident" id="8169869">kv</span>&nbsp;<span class="op" id="8169872">:=</span>&nbsp;<span class="keyword" id="8169875">range</span>&nbsp;<span class="ident" id="8169881">os</span><span class="op" id="8169883">.</span><span class="ident" id="8169884">Environ</span><span class="op" id="8169891">(</span><span class="op" id="8169892">)</span>&nbsp;<span class="op" id="8169894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169899">fmt</span><span class="op" id="8169902">.</span><span class="ident" id="8169903">Fprintf</span><span class="op" id="8169910">(</span><span class="ident" id="8169911">rw</span><span class="op" id="8169913">,</span>&nbsp;<span class="string" id="8169915">&#34;env-%s\n&#34;</span><span class="op" id="8169925">,</span>&nbsp;<span class="ident" id="8169927">kv</span><span class="op" id="8169929">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8169936">}</span><span class="op" id="8169937">)</span><span class="op" id="8169938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8169941">os</span><span class="op" id="8169943">.</span><span class="ident" id="8169944">Exit</span><span class="op" id="8169948">(</span><span class="num" id="8169949">0</span><span class="op" id="8169950">)</span><br>
<span class="lineno"></span><span class="op" id="8169952">}</span>
</div>
</body>
</html>
