<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7155147">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7155202">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7155256">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7155307">package</span>&nbsp;<span class="ident" id="7155315">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7155320">import</span>&nbsp;<span class="op" id="7155327">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155330">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155353">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155363">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155370">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155376">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155383">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155391">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155402">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155413">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155421">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7155432">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7155439">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7155442">var</span>&nbsp;<span class="ident" id="7155446">_</span>&nbsp;<span class="op" id="7155448">=</span>&nbsp;<span class="ident" id="7155450">log</span><span class="op" id="7155453">.</span><span class="ident" id="7155454">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7155462">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7155530">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7155562">//</span><br>
<span class="lineno"></span><span class="comment" id="7155565">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7155630">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7155697">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7155709">//</span><br>
<span class="lineno">30</span><span class="comment" id="7155712">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7155722">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7155776">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7155837">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7155886">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7155959">//</span><br>
<span class="lineno"></span><span class="comment" id="7155962">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7156027">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7156086">type</span>&nbsp;<span class="ident" id="7156091">fakeDriver</span>&nbsp;<span class="keyword" id="7156102">struct</span>&nbsp;<span class="op" id="7156109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156112">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156123">sync</span><span class="op" id="7156127">.</span><span class="ident" id="7156128">Mutex</span>&nbsp;<span class="comment" id="7156134">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156164">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7156175">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7156186">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156201">closeCount</span>&nbsp;<span class="builtintype" id="7156212">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7156223">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156239">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156250">chan</span>&nbsp;<span class="keyword" id="7156255">struct</span><span class="op" id="7156261">{</span><span class="op" id="7156262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156265">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7156276">chan</span>&nbsp;<span class="keyword" id="7156281">struct</span><span class="op" id="7156287">{</span><span class="op" id="7156288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156291">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156302">map</span><span class="op" id="7156305">[</span><span class="builtintype" id="7156306">string</span><span class="op" id="7156312">]</span><span class="op" id="7156313">*</span><span class="ident" id="7156314">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7156321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7156324">type</span>&nbsp;<span class="ident" id="7156329">fakeDB</span>&nbsp;<span class="keyword" id="7156336">struct</span>&nbsp;<span class="op" id="7156343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156346">name</span>&nbsp;<span class="builtintype" id="7156351">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156360">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156368">sync</span><span class="op" id="7156372">.</span><span class="ident" id="7156373">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156380">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7156388">[</span><span class="op" id="7156389">]</span><span class="op" id="7156390">*</span><span class="ident" id="7156391">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156401">tables</span>&nbsp;&nbsp;<span class="keyword" id="7156409">map</span><span class="op" id="7156412">[</span><span class="builtintype" id="7156413">string</span><span class="op" id="7156419">]</span><span class="op" id="7156420">*</span><span class="ident" id="7156421">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156428">badConn</span>&nbsp;<span class="builtintype" id="7156436">bool</span><br>
<span class="lineno"></span><span class="op" id="7156441">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7156444">type</span>&nbsp;<span class="ident" id="7156449">table</span>&nbsp;<span class="keyword" id="7156455">struct</span>&nbsp;<span class="op" id="7156462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156465">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156473">sync</span><span class="op" id="7156477">.</span><span class="ident" id="7156478">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156485">colname</span>&nbsp;<span class="op" id="7156493">[</span><span class="op" id="7156494">]</span><span class="builtintype" id="7156495">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156503">coltype</span>&nbsp;<span class="op" id="7156511">[</span><span class="op" id="7156512">]</span><span class="builtintype" id="7156513">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156521">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7156529">[</span><span class="op" id="7156530">]</span><span class="op" id="7156531">*</span><span class="ident" id="7156532">row</span><br>
<span class="lineno"></span><span class="op" id="7156536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7156539">func</span>&nbsp;<span class="op" id="7156544">(</span><span class="ident" id="7156545">t</span>&nbsp;<span class="op" id="7156547">*</span><span class="ident" id="7156548">table</span><span class="op" id="7156553">)</span>&nbsp;<span class="ident" id="7156555">columnIndex</span><span class="op" id="7156566">(</span><span class="ident" id="7156567">name</span>&nbsp;<span class="builtintype" id="7156572">string</span><span class="op" id="7156578">)</span>&nbsp;<span class="builtintype" id="7156580">int</span>&nbsp;<span class="op" id="7156584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156587">for</span>&nbsp;<span class="ident" id="7156591">n</span><span class="op" id="7156592">,</span>&nbsp;<span class="ident" id="7156594">nname</span>&nbsp;<span class="op" id="7156600">:=</span>&nbsp;<span class="keyword" id="7156603">range</span>&nbsp;<span class="ident" id="7156609">t</span><span class="op" id="7156610">.</span><span class="ident" id="7156611">colname</span>&nbsp;<span class="op" id="7156619">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156623">if</span>&nbsp;<span class="ident" id="7156626">name</span>&nbsp;<span class="op" id="7156631">==</span>&nbsp;<span class="ident" id="7156634">nname</span>&nbsp;<span class="op" id="7156640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156645">return</span>&nbsp;<span class="ident" id="7156652">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7156656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7156659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156662">return</span>&nbsp;<span class="op" id="7156669">-</span><span class="num" id="7156670">1</span><br>
<span class="lineno">70</span><span class="op" id="7156672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7156675">type</span>&nbsp;<span class="ident" id="7156680">row</span>&nbsp;<span class="keyword" id="7156684">struct</span>&nbsp;<span class="op" id="7156691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156694">cols</span>&nbsp;<span class="op" id="7156699">[</span><span class="op" id="7156700">]</span><span class="keyword" id="7156701">interface</span><span class="op" id="7156710">{</span><span class="op" id="7156711">}</span>&nbsp;<span class="comment" id="7156713">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7156765">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7156768">func</span>&nbsp;<span class="op" id="7156773">(</span><span class="ident" id="7156774">r</span>&nbsp;<span class="op" id="7156776">*</span><span class="ident" id="7156777">row</span><span class="op" id="7156780">)</span>&nbsp;<span class="ident" id="7156782">clone</span><span class="op" id="7156787">(</span><span class="op" id="7156788">)</span>&nbsp;<span class="op" id="7156790">*</span><span class="ident" id="7156791">row</span>&nbsp;<span class="op" id="7156795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156798">nrow</span>&nbsp;<span class="op" id="7156803">:=</span>&nbsp;<span class="op" id="7156806">&amp;</span><span class="ident" id="7156807">row</span><span class="op" id="7156810">{</span><span class="ident" id="7156811">cols</span><span class="op" id="7156815">:</span>&nbsp;<span class="builtinfunc" id="7156817">make</span><span class="op" id="7156821">(</span><span class="op" id="7156822">[</span><span class="op" id="7156823">]</span><span class="keyword" id="7156824">interface</span><span class="op" id="7156833">{</span><span class="op" id="7156834">}</span><span class="op" id="7156835">,</span>&nbsp;<span class="builtinfunc" id="7156837">len</span><span class="op" id="7156840">(</span><span class="ident" id="7156841">r</span><span class="op" id="7156842">.</span><span class="ident" id="7156843">cols</span><span class="op" id="7156847">)</span><span class="op" id="7156848">)</span><span class="op" id="7156849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7156852">copy</span><span class="op" id="7156856">(</span><span class="ident" id="7156857">nrow</span><span class="op" id="7156861">.</span><span class="ident" id="7156862">cols</span><span class="op" id="7156866">,</span>&nbsp;<span class="ident" id="7156868">r</span><span class="op" id="7156869">.</span><span class="ident" id="7156870">cols</span><span class="op" id="7156874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7156877">return</span>&nbsp;<span class="ident" id="7156884">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7156889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7156892">type</span>&nbsp;<span class="ident" id="7156897">fakeConn</span>&nbsp;<span class="keyword" id="7156906">struct</span>&nbsp;<span class="op" id="7156913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156916">db</span>&nbsp;<span class="op" id="7156919">*</span><span class="ident" id="7156920">fakeDB</span>&nbsp;<span class="comment" id="7156927">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156961">currTx</span>&nbsp;<span class="op" id="7156968">*</span><span class="ident" id="7156969">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7156978">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7156999">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157011">sync</span><span class="op" id="7157015">.</span><span class="ident" id="7157016">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157023">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7157035">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157040">stmtsClosed</span>&nbsp;<span class="builtintype" id="7157052">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157057">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7157069">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157074">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7157086">bool</span><br>
<span class="lineno"></span><span class="op" id="7157091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7157094">func</span>&nbsp;<span class="op" id="7157099">(</span><span class="ident" id="7157100">c</span>&nbsp;<span class="op" id="7157102">*</span><span class="ident" id="7157103">fakeConn</span><span class="op" id="7157111">)</span>&nbsp;<span class="ident" id="7157113">incrStat</span><span class="op" id="7157121">(</span><span class="ident" id="7157122">v</span>&nbsp;<span class="op" id="7157124">*</span><span class="builtintype" id="7157125">int</span><span class="op" id="7157128">)</span>&nbsp;<span class="op" id="7157130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157133">c</span><span class="op" id="7157134">.</span><span class="ident" id="7157135">mu</span><span class="op" id="7157137">.</span><span class="ident" id="7157138">Lock</span><span class="op" id="7157142">(</span><span class="op" id="7157143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157146">*</span><span class="ident" id="7157147">v</span><span class="op" id="7157148">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157152">c</span><span class="op" id="7157153">.</span><span class="ident" id="7157154">mu</span><span class="op" id="7157156">.</span><span class="ident" id="7157157">Unlock</span><span class="op" id="7157163">(</span><span class="op" id="7157164">)</span><br>
<span class="lineno"></span><span class="op" id="7157166">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7157169">type</span>&nbsp;<span class="ident" id="7157174">fakeTx</span>&nbsp;<span class="keyword" id="7157181">struct</span>&nbsp;<span class="op" id="7157188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157191">c</span>&nbsp;<span class="op" id="7157193">*</span><span class="ident" id="7157194">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7157203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7157206">type</span>&nbsp;<span class="ident" id="7157211">fakeStmt</span>&nbsp;<span class="keyword" id="7157220">struct</span>&nbsp;<span class="op" id="7157227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157230">c</span>&nbsp;<span class="op" id="7157232">*</span><span class="ident" id="7157233">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157243">q</span>&nbsp;<span class="builtintype" id="7157245">string</span>&nbsp;<span class="comment" id="7157252">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157276">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7157282">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157290">table</span>&nbsp;<span class="builtintype" id="7157296">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157305">closed</span>&nbsp;<span class="builtintype" id="7157312">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157319">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157332">[</span><span class="op" id="7157333">]</span><span class="builtintype" id="7157334">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7157346">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157400">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157413">[</span><span class="op" id="7157414">]</span><span class="builtintype" id="7157415">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7157427">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157446">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157459">[</span><span class="op" id="7157460">]</span><span class="keyword" id="7157461">interface</span><span class="op" id="7157470">{</span><span class="op" id="7157471">}</span>&nbsp;<span class="comment" id="7157473">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157534">placeholders</span>&nbsp;<span class="builtintype" id="7157547">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7157561">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157608">whereCol</span>&nbsp;<span class="op" id="7157617">[</span><span class="op" id="7157618">]</span><span class="builtintype" id="7157619">string</span>&nbsp;<span class="comment" id="7157626">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157665">placeholderConverter</span>&nbsp;<span class="op" id="7157686">[</span><span class="op" id="7157687">]</span><span class="ident" id="7157688">driver</span><span class="op" id="7157694">.</span><span class="ident" id="7157695">ValueConverter</span>&nbsp;<span class="comment" id="7157710">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7157728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7157731">var</span>&nbsp;<span class="ident" id="7157735">fdriver</span>&nbsp;<span class="ident" id="7157743">driver</span><span class="op" id="7157749">.</span><span class="ident" id="7157750">Driver</span>&nbsp;<span class="op" id="7157757">=</span>&nbsp;<span class="op" id="7157759">&amp;</span><span class="ident" id="7157760">fakeDriver</span><span class="op" id="7157770">{</span><span class="op" id="7157771">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7157774">func</span>&nbsp;<span class="ident" id="7157779">init</span><span class="op" id="7157783">(</span><span class="op" id="7157784">)</span>&nbsp;<span class="op" id="7157786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157789">Register</span><span class="op" id="7157797">(</span><span class="string" id="7157798">&#34;test&#34;</span><span class="op" id="7157804">,</span>&nbsp;<span class="ident" id="7157806">fdriver</span><span class="op" id="7157813">)</span><br>
<span class="lineno"></span><span class="op" id="7157815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7157818">func</span>&nbsp;<span class="ident" id="7157823">contains</span><span class="op" id="7157831">(</span><span class="ident" id="7157832">list</span>&nbsp;<span class="op" id="7157837">[</span><span class="op" id="7157838">]</span><span class="builtintype" id="7157839">string</span><span class="op" id="7157845">,</span>&nbsp;<span class="ident" id="7157847">y</span>&nbsp;<span class="builtintype" id="7157849">string</span><span class="op" id="7157855">)</span>&nbsp;<span class="builtintype" id="7157857">bool</span>&nbsp;<span class="op" id="7157862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7157865">for</span>&nbsp;<span class="ident" id="7157869">_</span><span class="op" id="7157870">,</span>&nbsp;<span class="ident" id="7157872">x</span>&nbsp;<span class="op" id="7157874">:=</span>&nbsp;<span class="keyword" id="7157877">range</span>&nbsp;<span class="ident" id="7157883">list</span>&nbsp;<span class="op" id="7157888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7157892">if</span>&nbsp;<span class="ident" id="7157895">x</span>&nbsp;<span class="op" id="7157897">==</span>&nbsp;<span class="ident" id="7157900">y</span>&nbsp;<span class="op" id="7157902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7157907">return</span>&nbsp;<span class="builtintype" id="7157914">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157921">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7157924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7157927">return</span>&nbsp;<span class="builtintype" id="7157934">false</span><br>
<span class="lineno"></span><span class="op" id="7157940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7157943">type</span>&nbsp;<span class="ident" id="7157948">Dummy</span>&nbsp;<span class="keyword" id="7157954">struct</span>&nbsp;<span class="op" id="7157961">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7157964">driver</span><span class="op" id="7157970">.</span><span class="ident" id="7157971">Driver</span><br>
<span class="lineno"></span><span class="op" id="7157978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7157981">func</span>&nbsp;<span class="ident" id="7157986">TestDrivers</span><span class="op" id="7157997">(</span><span class="ident" id="7157998">t</span>&nbsp;<span class="op" id="7158000">*</span><span class="ident" id="7158001">testing</span><span class="op" id="7158008">.</span><span class="ident" id="7158009">T</span><span class="op" id="7158010">)</span>&nbsp;<span class="op" id="7158012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158015">unregisterAllDrivers</span><span class="op" id="7158035">(</span><span class="op" id="7158036">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158039">Register</span><span class="op" id="7158047">(</span><span class="string" id="7158048">&#34;test&#34;</span><span class="op" id="7158054">,</span>&nbsp;<span class="ident" id="7158056">fdriver</span><span class="op" id="7158063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158066">Register</span><span class="op" id="7158074">(</span><span class="string" id="7158075">&#34;invalid&#34;</span><span class="op" id="7158084">,</span>&nbsp;<span class="ident" id="7158086">Dummy</span><span class="op" id="7158091">{</span><span class="op" id="7158092">}</span><span class="op" id="7158093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158096">all</span>&nbsp;<span class="op" id="7158100">:=</span>&nbsp;<span class="ident" id="7158103">Drivers</span><span class="op" id="7158110">(</span><span class="op" id="7158111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158114">if</span>&nbsp;<span class="builtinfunc" id="7158117">len</span><span class="op" id="7158120">(</span><span class="ident" id="7158121">all</span><span class="op" id="7158124">)</span>&nbsp;<span class="op" id="7158126">&lt;</span>&nbsp;<span class="num" id="7158128">2</span>&nbsp;<span class="op" id="7158130">||</span>&nbsp;<span class="op" id="7158133">!</span><span class="ident" id="7158134">sort</span><span class="op" id="7158138">.</span><span class="ident" id="7158139">StringsAreSorted</span><span class="op" id="7158155">(</span><span class="ident" id="7158156">all</span><span class="op" id="7158159">)</span>&nbsp;<span class="op" id="7158161">||</span>&nbsp;<span class="op" id="7158164">!</span><span class="ident" id="7158165">contains</span><span class="op" id="7158173">(</span><span class="ident" id="7158174">all</span><span class="op" id="7158177">,</span>&nbsp;<span class="string" id="7158179">&#34;test&#34;</span><span class="op" id="7158185">)</span>&nbsp;<span class="op" id="7158187">||</span>&nbsp;<span class="op" id="7158190">!</span><span class="ident" id="7158191">contains</span><span class="op" id="7158199">(</span><span class="ident" id="7158200">all</span><span class="op" id="7158203">,</span>&nbsp;<span class="string" id="7158205">&#34;invalid&#34;</span><span class="op" id="7158214">)</span>&nbsp;<span class="op" id="7158216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158220">t</span><span class="op" id="7158221">.</span><span class="ident" id="7158222">Fatalf</span><span class="op" id="7158228">(</span><span class="string" id="7158229">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7158291">,</span>&nbsp;<span class="ident" id="7158293">all</span><span class="op" id="7158296">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7158299">}</span><br>
<span class="lineno"></span><span class="op" id="7158301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7158304">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7158327">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7158342">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7158412">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7158485">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7158535">func</span>&nbsp;<span class="op" id="7158540">(</span><span class="ident" id="7158541">d</span>&nbsp;<span class="op" id="7158543">*</span><span class="ident" id="7158544">fakeDriver</span><span class="op" id="7158554">)</span>&nbsp;<span class="ident" id="7158556">Open</span><span class="op" id="7158560">(</span><span class="ident" id="7158561">dsn</span>&nbsp;<span class="builtintype" id="7158565">string</span><span class="op" id="7158571">)</span>&nbsp;<span class="op" id="7158573">(</span><span class="ident" id="7158574">driver</span><span class="op" id="7158580">.</span><span class="ident" id="7158581">Conn</span><span class="op" id="7158585">,</span>&nbsp;<span class="builtintype" id="7158587">error</span><span class="op" id="7158592">)</span>&nbsp;<span class="op" id="7158594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158597">parts</span>&nbsp;<span class="op" id="7158603">:=</span>&nbsp;<span class="ident" id="7158606">strings</span><span class="op" id="7158613">.</span><span class="ident" id="7158614">Split</span><span class="op" id="7158619">(</span><span class="ident" id="7158620">dsn</span><span class="op" id="7158623">,</span>&nbsp;<span class="string" id="7158625">&#34;;&#34;</span><span class="op" id="7158628">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158631">if</span>&nbsp;<span class="builtinfunc" id="7158634">len</span><span class="op" id="7158637">(</span><span class="ident" id="7158638">parts</span><span class="op" id="7158643">)</span>&nbsp;<span class="op" id="7158645">&lt;</span>&nbsp;<span class="num" id="7158647">1</span>&nbsp;<span class="op" id="7158649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158653">return</span>&nbsp;<span class="builtintype" id="7158660">nil</span><span class="op" id="7158663">,</span>&nbsp;<span class="ident" id="7158665">errors</span><span class="op" id="7158671">.</span><span class="ident" id="7158672">New</span><span class="op" id="7158675">(</span><span class="string" id="7158676">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7158702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7158705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158708">name</span>&nbsp;<span class="op" id="7158713">:=</span>&nbsp;<span class="ident" id="7158716">parts</span><span class="op" id="7158721">[</span><span class="num" id="7158722">0</span><span class="op" id="7158723">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158727">db</span>&nbsp;<span class="op" id="7158730">:=</span>&nbsp;<span class="ident" id="7158733">d</span><span class="op" id="7158734">.</span><span class="ident" id="7158735">getDB</span><span class="op" id="7158740">(</span><span class="ident" id="7158741">name</span><span class="op" id="7158745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158749">d</span><span class="op" id="7158750">.</span><span class="ident" id="7158751">mu</span><span class="op" id="7158753">.</span><span class="ident" id="7158754">Lock</span><span class="op" id="7158758">(</span><span class="op" id="7158759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158762">d</span><span class="op" id="7158763">.</span><span class="ident" id="7158764">openCount</span><span class="op" id="7158773">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158777">d</span><span class="op" id="7158778">.</span><span class="ident" id="7158779">mu</span><span class="op" id="7158781">.</span><span class="ident" id="7158782">Unlock</span><span class="op" id="7158788">(</span><span class="op" id="7158789">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158792">conn</span>&nbsp;<span class="op" id="7158797">:=</span>&nbsp;<span class="op" id="7158800">&amp;</span><span class="ident" id="7158801">fakeConn</span><span class="op" id="7158809">{</span><span class="ident" id="7158810">db</span><span class="op" id="7158812">:</span>&nbsp;<span class="ident" id="7158814">db</span><span class="op" id="7158816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158820">if</span>&nbsp;<span class="builtinfunc" id="7158823">len</span><span class="op" id="7158826">(</span><span class="ident" id="7158827">parts</span><span class="op" id="7158832">)</span>&nbsp;<span class="op" id="7158834">&gt;=</span>&nbsp;<span class="num" id="7158837">2</span>&nbsp;<span class="op" id="7158839">&amp;&amp;</span>&nbsp;<span class="ident" id="7158842">parts</span><span class="op" id="7158847">[</span><span class="num" id="7158848">1</span><span class="op" id="7158849">]</span>&nbsp;<span class="op" id="7158851">==</span>&nbsp;<span class="string" id="7158854">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7158864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158868">conn</span><span class="op" id="7158872">.</span><span class="ident" id="7158873">bad</span>&nbsp;<span class="op" id="7158877">=</span>&nbsp;<span class="builtintype" id="7158879">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7158885">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158888">if</span>&nbsp;<span class="ident" id="7158891">d</span><span class="op" id="7158892">.</span><span class="ident" id="7158893">waitCh</span>&nbsp;<span class="op" id="7158900">!=</span>&nbsp;<span class="builtintype" id="7158903">nil</span>&nbsp;<span class="op" id="7158907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158911">d</span><span class="op" id="7158912">.</span><span class="ident" id="7158913">waitingCh</span>&nbsp;<span class="op" id="7158923">&lt;-</span>&nbsp;<span class="keyword" id="7158926">struct</span><span class="op" id="7158932">{</span><span class="op" id="7158933">}</span><span class="op" id="7158934">{</span><span class="op" id="7158935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7158939">&lt;-</span><span class="ident" id="7158941">d</span><span class="op" id="7158942">.</span><span class="ident" id="7158943">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158952">d</span><span class="op" id="7158953">.</span><span class="ident" id="7158954">waitCh</span>&nbsp;<span class="op" id="7158961">=</span>&nbsp;<span class="builtintype" id="7158963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7158969">d</span><span class="op" id="7158970">.</span><span class="ident" id="7158971">waitingCh</span>&nbsp;<span class="op" id="7158981">=</span>&nbsp;<span class="builtintype" id="7158983">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7158988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7158991">return</span>&nbsp;<span class="ident" id="7158998">conn</span><span class="op" id="7159002">,</span>&nbsp;<span class="builtintype" id="7159004">nil</span><br>
<span class="lineno"></span><span class="op" id="7159008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7159011">func</span>&nbsp;<span class="op" id="7159016">(</span><span class="ident" id="7159017">d</span>&nbsp;<span class="op" id="7159019">*</span><span class="ident" id="7159020">fakeDriver</span><span class="op" id="7159030">)</span>&nbsp;<span class="ident" id="7159032">getDB</span><span class="op" id="7159037">(</span><span class="ident" id="7159038">name</span>&nbsp;<span class="builtintype" id="7159043">string</span><span class="op" id="7159049">)</span>&nbsp;<span class="op" id="7159051">*</span><span class="ident" id="7159052">fakeDB</span>&nbsp;<span class="op" id="7159059">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159062">d</span><span class="op" id="7159063">.</span><span class="ident" id="7159064">mu</span><span class="op" id="7159066">.</span><span class="ident" id="7159067">Lock</span><span class="op" id="7159071">(</span><span class="op" id="7159072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159075">defer</span>&nbsp;<span class="ident" id="7159081">d</span><span class="op" id="7159082">.</span><span class="ident" id="7159083">mu</span><span class="op" id="7159085">.</span><span class="ident" id="7159086">Unlock</span><span class="op" id="7159092">(</span><span class="op" id="7159093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159096">if</span>&nbsp;<span class="ident" id="7159099">d</span><span class="op" id="7159100">.</span><span class="ident" id="7159101">dbs</span>&nbsp;<span class="op" id="7159105">==</span>&nbsp;<span class="builtintype" id="7159108">nil</span>&nbsp;<span class="op" id="7159112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159116">d</span><span class="op" id="7159117">.</span><span class="ident" id="7159118">dbs</span>&nbsp;<span class="op" id="7159122">=</span>&nbsp;<span class="builtinfunc" id="7159124">make</span><span class="op" id="7159128">(</span><span class="keyword" id="7159129">map</span><span class="op" id="7159132">[</span><span class="builtintype" id="7159133">string</span><span class="op" id="7159139">]</span><span class="op" id="7159140">*</span><span class="ident" id="7159141">fakeDB</span><span class="op" id="7159147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7159150">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159153">db</span><span class="op" id="7159155">,</span>&nbsp;<span class="ident" id="7159157">ok</span>&nbsp;<span class="op" id="7159160">:=</span>&nbsp;<span class="ident" id="7159163">d</span><span class="op" id="7159164">.</span><span class="ident" id="7159165">dbs</span><span class="op" id="7159168">[</span><span class="ident" id="7159169">name</span><span class="op" id="7159173">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159176">if</span>&nbsp;<span class="op" id="7159179">!</span><span class="ident" id="7159180">ok</span>&nbsp;<span class="op" id="7159183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159187">db</span>&nbsp;<span class="op" id="7159190">=</span>&nbsp;<span class="op" id="7159192">&amp;</span><span class="ident" id="7159193">fakeDB</span><span class="op" id="7159199">{</span><span class="ident" id="7159200">name</span><span class="op" id="7159204">:</span>&nbsp;<span class="ident" id="7159206">name</span><span class="op" id="7159210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159214">d</span><span class="op" id="7159215">.</span><span class="ident" id="7159216">dbs</span><span class="op" id="7159219">[</span><span class="ident" id="7159220">name</span><span class="op" id="7159224">]</span>&nbsp;<span class="op" id="7159226">=</span>&nbsp;<span class="ident" id="7159228">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7159232">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159235">return</span>&nbsp;<span class="ident" id="7159242">db</span><br>
<span class="lineno"></span><span class="op" id="7159245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7159248">func</span>&nbsp;<span class="op" id="7159253">(</span><span class="ident" id="7159254">db</span>&nbsp;<span class="op" id="7159257">*</span><span class="ident" id="7159258">fakeDB</span><span class="op" id="7159264">)</span>&nbsp;<span class="ident" id="7159266">wipe</span><span class="op" id="7159270">(</span><span class="op" id="7159271">)</span>&nbsp;<span class="op" id="7159273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159276">db</span><span class="op" id="7159278">.</span><span class="ident" id="7159279">mu</span><span class="op" id="7159281">.</span><span class="ident" id="7159282">Lock</span><span class="op" id="7159286">(</span><span class="op" id="7159287">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159290">defer</span>&nbsp;<span class="ident" id="7159296">db</span><span class="op" id="7159298">.</span><span class="ident" id="7159299">mu</span><span class="op" id="7159301">.</span><span class="ident" id="7159302">Unlock</span><span class="op" id="7159308">(</span><span class="op" id="7159309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159312">db</span><span class="op" id="7159314">.</span><span class="ident" id="7159315">tables</span>&nbsp;<span class="op" id="7159322">=</span>&nbsp;<span class="builtintype" id="7159324">nil</span><br>
<span class="lineno"></span><span class="op" id="7159328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7159331">func</span>&nbsp;<span class="op" id="7159336">(</span><span class="ident" id="7159337">db</span>&nbsp;<span class="op" id="7159340">*</span><span class="ident" id="7159341">fakeDB</span><span class="op" id="7159347">)</span>&nbsp;<span class="ident" id="7159349">createTable</span><span class="op" id="7159360">(</span><span class="ident" id="7159361">name</span>&nbsp;<span class="builtintype" id="7159366">string</span><span class="op" id="7159372">,</span>&nbsp;<span class="ident" id="7159374">columnNames</span><span class="op" id="7159385">,</span>&nbsp;<span class="ident" id="7159387">columnTypes</span>&nbsp;<span class="op" id="7159399">[</span><span class="op" id="7159400">]</span><span class="builtintype" id="7159401">string</span><span class="op" id="7159407">)</span>&nbsp;<span class="builtintype" id="7159409">error</span>&nbsp;<span class="op" id="7159415">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159418">db</span><span class="op" id="7159420">.</span><span class="ident" id="7159421">mu</span><span class="op" id="7159423">.</span><span class="ident" id="7159424">Lock</span><span class="op" id="7159428">(</span><span class="op" id="7159429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159432">defer</span>&nbsp;<span class="ident" id="7159438">db</span><span class="op" id="7159440">.</span><span class="ident" id="7159441">mu</span><span class="op" id="7159443">.</span><span class="ident" id="7159444">Unlock</span><span class="op" id="7159450">(</span><span class="op" id="7159451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159454">if</span>&nbsp;<span class="ident" id="7159457">db</span><span class="op" id="7159459">.</span><span class="ident" id="7159460">tables</span>&nbsp;<span class="op" id="7159467">==</span>&nbsp;<span class="builtintype" id="7159470">nil</span>&nbsp;<span class="op" id="7159474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159478">db</span><span class="op" id="7159480">.</span><span class="ident" id="7159481">tables</span>&nbsp;<span class="op" id="7159488">=</span>&nbsp;<span class="builtinfunc" id="7159490">make</span><span class="op" id="7159494">(</span><span class="keyword" id="7159495">map</span><span class="op" id="7159498">[</span><span class="builtintype" id="7159499">string</span><span class="op" id="7159505">]</span><span class="op" id="7159506">*</span><span class="ident" id="7159507">table</span><span class="op" id="7159512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7159515">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159518">if</span>&nbsp;<span class="ident" id="7159521">_</span><span class="op" id="7159522">,</span>&nbsp;<span class="ident" id="7159524">exist</span>&nbsp;<span class="op" id="7159530">:=</span>&nbsp;<span class="ident" id="7159533">db</span><span class="op" id="7159535">.</span><span class="ident" id="7159536">tables</span><span class="op" id="7159542">[</span><span class="ident" id="7159543">name</span><span class="op" id="7159547">]</span><span class="op" id="7159548">;</span>&nbsp;<span class="ident" id="7159550">exist</span>&nbsp;<span class="op" id="7159556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159560">return</span>&nbsp;<span class="ident" id="7159567">fmt</span><span class="op" id="7159570">.</span><span class="ident" id="7159571">Errorf</span><span class="op" id="7159577">(</span><span class="string" id="7159578">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7159603">,</span>&nbsp;<span class="ident" id="7159605">name</span><span class="op" id="7159609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7159612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159615">if</span>&nbsp;<span class="builtinfunc" id="7159618">len</span><span class="op" id="7159621">(</span><span class="ident" id="7159622">columnNames</span><span class="op" id="7159633">)</span>&nbsp;<span class="op" id="7159635">!=</span>&nbsp;<span class="builtinfunc" id="7159638">len</span><span class="op" id="7159641">(</span><span class="ident" id="7159642">columnTypes</span><span class="op" id="7159653">)</span>&nbsp;<span class="op" id="7159655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159659">return</span>&nbsp;<span class="ident" id="7159666">fmt</span><span class="op" id="7159669">.</span><span class="ident" id="7159670">Errorf</span><span class="op" id="7159676">(</span><span class="string" id="7159677">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7159732">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159737">name</span><span class="op" id="7159741">,</span>&nbsp;<span class="builtinfunc" id="7159743">len</span><span class="op" id="7159746">(</span><span class="ident" id="7159747">columnNames</span><span class="op" id="7159758">)</span><span class="op" id="7159759">,</span>&nbsp;<span class="builtinfunc" id="7159761">len</span><span class="op" id="7159764">(</span><span class="ident" id="7159765">columnTypes</span><span class="op" id="7159776">)</span><span class="op" id="7159777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7159780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7159783">db</span><span class="op" id="7159785">.</span><span class="ident" id="7159786">tables</span><span class="op" id="7159792">[</span><span class="ident" id="7159793">name</span><span class="op" id="7159797">]</span>&nbsp;<span class="op" id="7159799">=</span>&nbsp;<span class="op" id="7159801">&amp;</span><span class="ident" id="7159802">table</span><span class="op" id="7159807">{</span><span class="ident" id="7159808">colname</span><span class="op" id="7159815">:</span>&nbsp;<span class="ident" id="7159817">columnNames</span><span class="op" id="7159828">,</span>&nbsp;<span class="ident" id="7159830">coltype</span><span class="op" id="7159837">:</span>&nbsp;<span class="ident" id="7159839">columnTypes</span><span class="op" id="7159850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159853">return</span>&nbsp;<span class="builtintype" id="7159860">nil</span><br>
<span class="lineno"></span><span class="op" id="7159864">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7159867">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7159906">func</span>&nbsp;<span class="op" id="7159911">(</span><span class="ident" id="7159912">db</span>&nbsp;<span class="op" id="7159915">*</span><span class="ident" id="7159916">fakeDB</span><span class="op" id="7159922">)</span>&nbsp;<span class="ident" id="7159924">table</span><span class="op" id="7159929">(</span><span class="ident" id="7159930">table</span>&nbsp;<span class="builtintype" id="7159936">string</span><span class="op" id="7159942">)</span>&nbsp;<span class="op" id="7159944">(</span><span class="op" id="7159945">*</span><span class="ident" id="7159946">table</span><span class="op" id="7159951">,</span>&nbsp;<span class="builtintype" id="7159953">bool</span><span class="op" id="7159957">)</span>&nbsp;<span class="op" id="7159959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159962">if</span>&nbsp;<span class="ident" id="7159965">db</span><span class="op" id="7159967">.</span><span class="ident" id="7159968">tables</span>&nbsp;<span class="op" id="7159975">==</span>&nbsp;<span class="builtintype" id="7159978">nil</span>&nbsp;<span class="op" id="7159982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7159986">return</span>&nbsp;<span class="builtintype" id="7159993">nil</span><span class="op" id="7159996">,</span>&nbsp;<span class="builtintype" id="7159998">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160008">t</span><span class="op" id="7160009">,</span>&nbsp;<span class="ident" id="7160011">ok</span>&nbsp;<span class="op" id="7160014">:=</span>&nbsp;<span class="ident" id="7160017">db</span><span class="op" id="7160019">.</span><span class="ident" id="7160020">tables</span><span class="op" id="7160026">[</span><span class="ident" id="7160027">table</span><span class="op" id="7160032">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160035">return</span>&nbsp;<span class="ident" id="7160042">t</span><span class="op" id="7160043">,</span>&nbsp;<span class="ident" id="7160045">ok</span><br>
<span class="lineno"></span><span class="op" id="7160048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7160051">func</span>&nbsp;<span class="op" id="7160056">(</span><span class="ident" id="7160057">db</span>&nbsp;<span class="op" id="7160060">*</span><span class="ident" id="7160061">fakeDB</span><span class="op" id="7160067">)</span>&nbsp;<span class="ident" id="7160069">columnType</span><span class="op" id="7160079">(</span><span class="ident" id="7160080">table</span><span class="op" id="7160085">,</span>&nbsp;<span class="ident" id="7160087">column</span>&nbsp;<span class="builtintype" id="7160094">string</span><span class="op" id="7160100">)</span>&nbsp;<span class="op" id="7160102">(</span><span class="ident" id="7160103">typ</span>&nbsp;<span class="builtintype" id="7160107">string</span><span class="op" id="7160113">,</span>&nbsp;<span class="ident" id="7160115">ok</span>&nbsp;<span class="builtintype" id="7160118">bool</span><span class="op" id="7160122">)</span>&nbsp;<span class="op" id="7160124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160127">db</span><span class="op" id="7160129">.</span><span class="ident" id="7160130">mu</span><span class="op" id="7160132">.</span><span class="ident" id="7160133">Lock</span><span class="op" id="7160137">(</span><span class="op" id="7160138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160141">defer</span>&nbsp;<span class="ident" id="7160147">db</span><span class="op" id="7160149">.</span><span class="ident" id="7160150">mu</span><span class="op" id="7160152">.</span><span class="ident" id="7160153">Unlock</span><span class="op" id="7160159">(</span><span class="op" id="7160160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160163">t</span><span class="op" id="7160164">,</span>&nbsp;<span class="ident" id="7160166">ok</span>&nbsp;<span class="op" id="7160169">:=</span>&nbsp;<span class="ident" id="7160172">db</span><span class="op" id="7160174">.</span><span class="ident" id="7160175">table</span><span class="op" id="7160180">(</span><span class="ident" id="7160181">table</span><span class="op" id="7160186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160189">if</span>&nbsp;<span class="op" id="7160192">!</span><span class="ident" id="7160193">ok</span>&nbsp;<span class="op" id="7160196">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160200">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160211">for</span>&nbsp;<span class="ident" id="7160215">n</span><span class="op" id="7160216">,</span>&nbsp;<span class="ident" id="7160218">cname</span>&nbsp;<span class="op" id="7160224">:=</span>&nbsp;<span class="keyword" id="7160227">range</span>&nbsp;<span class="ident" id="7160233">t</span><span class="op" id="7160234">.</span><span class="ident" id="7160235">colname</span>&nbsp;<span class="op" id="7160243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160247">if</span>&nbsp;<span class="ident" id="7160250">cname</span>&nbsp;<span class="op" id="7160256">==</span>&nbsp;<span class="ident" id="7160259">column</span>&nbsp;<span class="op" id="7160266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160271">return</span>&nbsp;<span class="ident" id="7160278">t</span><span class="op" id="7160279">.</span><span class="ident" id="7160280">coltype</span><span class="op" id="7160287">[</span><span class="ident" id="7160288">n</span><span class="op" id="7160289">]</span><span class="op" id="7160290">,</span>&nbsp;<span class="builtintype" id="7160292">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160305">return</span>&nbsp;<span class="string" id="7160312">&#34;&#34;</span><span class="op" id="7160314">,</span>&nbsp;<span class="builtintype" id="7160316">false</span><br>
<span class="lineno"></span><span class="op" id="7160322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7160325">func</span>&nbsp;<span class="op" id="7160330">(</span><span class="ident" id="7160331">c</span>&nbsp;<span class="op" id="7160333">*</span><span class="ident" id="7160334">fakeConn</span><span class="op" id="7160342">)</span>&nbsp;<span class="ident" id="7160344">isBad</span><span class="op" id="7160349">(</span><span class="op" id="7160350">)</span>&nbsp;<span class="builtintype" id="7160352">bool</span>&nbsp;<span class="op" id="7160357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7160360">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160403">if</span>&nbsp;<span class="op" id="7160406">!</span><span class="ident" id="7160407">c</span><span class="op" id="7160408">.</span><span class="ident" id="7160409">bad</span>&nbsp;<span class="op" id="7160413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160417">return</span>&nbsp;<span class="builtintype" id="7160424">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160431">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7160434">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160482">c</span><span class="op" id="7160483">.</span><span class="ident" id="7160484">db</span><span class="op" id="7160486">.</span><span class="ident" id="7160487">badConn</span>&nbsp;<span class="op" id="7160495">=</span>&nbsp;<span class="op" id="7160497">!</span><span class="ident" id="7160498">c</span><span class="op" id="7160499">.</span><span class="ident" id="7160500">db</span><span class="op" id="7160502">.</span><span class="ident" id="7160503">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160512">return</span>&nbsp;<span class="ident" id="7160519">c</span><span class="op" id="7160520">.</span><span class="ident" id="7160521">db</span><span class="op" id="7160523">.</span><span class="ident" id="7160524">badConn</span><br>
<span class="lineno"></span><span class="op" id="7160532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7160535">func</span>&nbsp;<span class="op" id="7160540">(</span><span class="ident" id="7160541">c</span>&nbsp;<span class="op" id="7160543">*</span><span class="ident" id="7160544">fakeConn</span><span class="op" id="7160552">)</span>&nbsp;<span class="ident" id="7160554">Begin</span><span class="op" id="7160559">(</span><span class="op" id="7160560">)</span>&nbsp;<span class="op" id="7160562">(</span><span class="ident" id="7160563">driver</span><span class="op" id="7160569">.</span><span class="ident" id="7160570">Tx</span><span class="op" id="7160572">,</span>&nbsp;<span class="builtintype" id="7160574">error</span><span class="op" id="7160579">)</span>&nbsp;<span class="op" id="7160581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160584">if</span>&nbsp;<span class="ident" id="7160587">c</span><span class="op" id="7160588">.</span><span class="ident" id="7160589">isBad</span><span class="op" id="7160594">(</span><span class="op" id="7160595">)</span>&nbsp;<span class="op" id="7160597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160601">return</span>&nbsp;<span class="builtintype" id="7160608">nil</span><span class="op" id="7160611">,</span>&nbsp;<span class="ident" id="7160613">driver</span><span class="op" id="7160619">.</span><span class="ident" id="7160620">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160635">if</span>&nbsp;<span class="ident" id="7160638">c</span><span class="op" id="7160639">.</span><span class="ident" id="7160640">currTx</span>&nbsp;<span class="op" id="7160647">!=</span>&nbsp;<span class="builtintype" id="7160650">nil</span>&nbsp;<span class="op" id="7160654">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160658">return</span>&nbsp;<span class="builtintype" id="7160665">nil</span><span class="op" id="7160668">,</span>&nbsp;<span class="ident" id="7160670">errors</span><span class="op" id="7160676">.</span><span class="ident" id="7160677">New</span><span class="op" id="7160680">(</span><span class="string" id="7160681">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7160707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7160710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160713">c</span><span class="op" id="7160714">.</span><span class="ident" id="7160715">currTx</span>&nbsp;<span class="op" id="7160722">=</span>&nbsp;<span class="op" id="7160724">&amp;</span><span class="ident" id="7160725">fakeTx</span><span class="op" id="7160731">{</span><span class="ident" id="7160732">c</span><span class="op" id="7160733">:</span>&nbsp;<span class="ident" id="7160735">c</span><span class="op" id="7160736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160739">return</span>&nbsp;<span class="ident" id="7160746">c</span><span class="op" id="7160747">.</span><span class="ident" id="7160748">currTx</span><span class="op" id="7160754">,</span>&nbsp;<span class="builtintype" id="7160756">nil</span><br>
<span class="lineno"></span><span class="op" id="7160760">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7160763">var</span>&nbsp;<span class="ident" id="7160767">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7160785">struct</span>&nbsp;<span class="op" id="7160792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160795">sync</span><span class="op" id="7160799">.</span><span class="ident" id="7160800">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160807">fn</span>&nbsp;<span class="keyword" id="7160810">func</span><span class="op" id="7160814">(</span><span class="op" id="7160815">*</span><span class="ident" id="7160816">fakeConn</span><span class="op" id="7160824">,</span>&nbsp;<span class="builtintype" id="7160826">error</span><span class="op" id="7160831">)</span><br>
<span class="lineno"></span><span class="op" id="7160833">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7160836">func</span>&nbsp;<span class="ident" id="7160841">setHookpostCloseConn</span><span class="op" id="7160861">(</span><span class="ident" id="7160862">fn</span>&nbsp;<span class="keyword" id="7160865">func</span><span class="op" id="7160869">(</span><span class="op" id="7160870">*</span><span class="ident" id="7160871">fakeConn</span><span class="op" id="7160879">,</span>&nbsp;<span class="builtintype" id="7160881">error</span><span class="op" id="7160886">)</span><span class="op" id="7160887">)</span>&nbsp;<span class="op" id="7160889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160892">hookPostCloseConn</span><span class="op" id="7160909">.</span><span class="ident" id="7160910">Lock</span><span class="op" id="7160914">(</span><span class="op" id="7160915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7160918">defer</span>&nbsp;<span class="ident" id="7160924">hookPostCloseConn</span><span class="op" id="7160941">.</span><span class="ident" id="7160942">Unlock</span><span class="op" id="7160948">(</span><span class="op" id="7160949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7160952">hookPostCloseConn</span><span class="op" id="7160969">.</span><span class="ident" id="7160970">fn</span>&nbsp;<span class="op" id="7160973">=</span>&nbsp;<span class="ident" id="7160975">fn</span><br>
<span class="lineno">275</span><span class="op" id="7160978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7160981">var</span>&nbsp;<span class="ident" id="7160985">testStrictClose</span>&nbsp;<span class="op" id="7161001">*</span><span class="ident" id="7161002">testing</span><span class="op" id="7161009">.</span><span class="ident" id="7161010">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7161013">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7161083">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7161133">func</span>&nbsp;<span class="ident" id="7161138">setStrictFakeConnClose</span><span class="op" id="7161160">(</span><span class="ident" id="7161161">t</span>&nbsp;<span class="op" id="7161163">*</span><span class="ident" id="7161164">testing</span><span class="op" id="7161171">.</span><span class="ident" id="7161172">T</span><span class="op" id="7161173">)</span>&nbsp;<span class="op" id="7161175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161178">testStrictClose</span>&nbsp;<span class="op" id="7161194">=</span>&nbsp;<span class="ident" id="7161196">t</span><br>
<span class="lineno"></span><span class="op" id="7161198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7161201">func</span>&nbsp;<span class="op" id="7161206">(</span><span class="ident" id="7161207">c</span>&nbsp;<span class="op" id="7161209">*</span><span class="ident" id="7161210">fakeConn</span><span class="op" id="7161218">)</span>&nbsp;<span class="ident" id="7161220">Close</span><span class="op" id="7161225">(</span><span class="op" id="7161226">)</span>&nbsp;<span class="op" id="7161228">(</span><span class="ident" id="7161229">err</span>&nbsp;<span class="builtintype" id="7161233">error</span><span class="op" id="7161238">)</span>&nbsp;<span class="op" id="7161240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161243">drv</span>&nbsp;<span class="op" id="7161247">:=</span>&nbsp;<span class="ident" id="7161250">fdriver</span><span class="op" id="7161257">.</span><span class="op" id="7161258">(</span><span class="op" id="7161259">*</span><span class="ident" id="7161260">fakeDriver</span><span class="op" id="7161270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161273">defer</span>&nbsp;<span class="keyword" id="7161279">func</span><span class="op" id="7161283">(</span><span class="op" id="7161284">)</span>&nbsp;<span class="op" id="7161286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161290">if</span>&nbsp;<span class="ident" id="7161293">err</span>&nbsp;<span class="op" id="7161297">!=</span>&nbsp;<span class="builtintype" id="7161300">nil</span>&nbsp;<span class="op" id="7161304">&amp;&amp;</span>&nbsp;<span class="ident" id="7161307">testStrictClose</span>&nbsp;<span class="op" id="7161323">!=</span>&nbsp;<span class="builtintype" id="7161326">nil</span>&nbsp;<span class="op" id="7161330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161335">testStrictClose</span><span class="op" id="7161350">.</span><span class="ident" id="7161351">Errorf</span><span class="op" id="7161357">(</span><span class="string" id="7161358">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7161395">,</span>&nbsp;<span class="ident" id="7161397">err</span><span class="op" id="7161400">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161408">hookPostCloseConn</span><span class="op" id="7161425">.</span><span class="ident" id="7161426">Lock</span><span class="op" id="7161430">(</span><span class="op" id="7161431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161435">fn</span>&nbsp;<span class="op" id="7161438">:=</span>&nbsp;<span class="ident" id="7161441">hookPostCloseConn</span><span class="op" id="7161458">.</span><span class="ident" id="7161459">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161464">hookPostCloseConn</span><span class="op" id="7161481">.</span><span class="ident" id="7161482">Unlock</span><span class="op" id="7161488">(</span><span class="op" id="7161489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161493">if</span>&nbsp;<span class="ident" id="7161496">fn</span>&nbsp;<span class="op" id="7161499">!=</span>&nbsp;<span class="builtintype" id="7161502">nil</span>&nbsp;<span class="op" id="7161506">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161511">fn</span><span class="op" id="7161513">(</span><span class="ident" id="7161514">c</span><span class="op" id="7161515">,</span>&nbsp;<span class="ident" id="7161517">err</span><span class="op" id="7161520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161528">if</span>&nbsp;<span class="ident" id="7161531">err</span>&nbsp;<span class="op" id="7161535">==</span>&nbsp;<span class="builtintype" id="7161538">nil</span>&nbsp;<span class="op" id="7161542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161547">drv</span><span class="op" id="7161550">.</span><span class="ident" id="7161551">mu</span><span class="op" id="7161553">.</span><span class="ident" id="7161554">Lock</span><span class="op" id="7161558">(</span><span class="op" id="7161559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161564">drv</span><span class="op" id="7161567">.</span><span class="ident" id="7161568">closeCount</span><span class="op" id="7161578">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161584">drv</span><span class="op" id="7161587">.</span><span class="ident" id="7161588">mu</span><span class="op" id="7161590">.</span><span class="ident" id="7161591">Unlock</span><span class="op" id="7161597">(</span><span class="op" id="7161598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161605">}</span><span class="op" id="7161606">(</span><span class="op" id="7161607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161610">if</span>&nbsp;<span class="ident" id="7161613">c</span><span class="op" id="7161614">.</span><span class="ident" id="7161615">currTx</span>&nbsp;<span class="op" id="7161622">!=</span>&nbsp;<span class="builtintype" id="7161625">nil</span>&nbsp;<span class="op" id="7161629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161633">return</span>&nbsp;<span class="ident" id="7161640">errors</span><span class="op" id="7161646">.</span><span class="ident" id="7161647">New</span><span class="op" id="7161650">(</span><span class="string" id="7161651">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7161691">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161697">if</span>&nbsp;<span class="ident" id="7161700">c</span><span class="op" id="7161701">.</span><span class="ident" id="7161702">db</span>&nbsp;<span class="op" id="7161705">==</span>&nbsp;<span class="builtintype" id="7161708">nil</span>&nbsp;<span class="op" id="7161712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161716">return</span>&nbsp;<span class="ident" id="7161723">errors</span><span class="op" id="7161729">.</span><span class="ident" id="7161730">New</span><span class="op" id="7161733">(</span><span class="string" id="7161734">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7161772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161778">if</span>&nbsp;<span class="ident" id="7161781">c</span><span class="op" id="7161782">.</span><span class="ident" id="7161783">stmtsMade</span>&nbsp;<span class="op" id="7161793">&gt;</span>&nbsp;<span class="ident" id="7161795">c</span><span class="op" id="7161796">.</span><span class="ident" id="7161797">stmtsClosed</span>&nbsp;<span class="op" id="7161809">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161813">return</span>&nbsp;<span class="ident" id="7161820">errors</span><span class="op" id="7161826">.</span><span class="ident" id="7161827">New</span><span class="op" id="7161830">(</span><span class="string" id="7161831">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7161867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7161870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7161873">c</span><span class="op" id="7161874">.</span><span class="ident" id="7161875">db</span>&nbsp;<span class="op" id="7161878">=</span>&nbsp;<span class="builtintype" id="7161880">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161885">return</span>&nbsp;<span class="builtintype" id="7161892">nil</span><br>
<span class="lineno"></span><span class="op" id="7161896">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7161899">func</span>&nbsp;<span class="ident" id="7161904">checkSubsetTypes</span><span class="op" id="7161920">(</span><span class="ident" id="7161921">args</span>&nbsp;<span class="op" id="7161926">[</span><span class="op" id="7161927">]</span><span class="ident" id="7161928">driver</span><span class="op" id="7161934">.</span><span class="ident" id="7161935">Value</span><span class="op" id="7161940">)</span>&nbsp;<span class="builtintype" id="7161942">error</span>&nbsp;<span class="op" id="7161948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161951">for</span>&nbsp;<span class="ident" id="7161955">n</span><span class="op" id="7161956">,</span>&nbsp;<span class="ident" id="7161958">arg</span>&nbsp;<span class="op" id="7161962">:=</span>&nbsp;<span class="keyword" id="7161965">range</span>&nbsp;<span class="ident" id="7161971">args</span>&nbsp;<span class="op" id="7161976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7161980">switch</span>&nbsp;<span class="ident" id="7161987">arg</span><span class="op" id="7161990">.</span><span class="op" id="7161991">(</span><span class="keyword" id="7161992">type</span><span class="op" id="7161996">)</span>&nbsp;<span class="op" id="7161998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162002">case</span>&nbsp;<span class="ident" id="7162007">int64</span><span class="op" id="7162012">,</span>&nbsp;<span class="builtintype" id="7162014">float64</span><span class="op" id="7162021">,</span>&nbsp;<span class="builtintype" id="7162023">bool</span><span class="op" id="7162027">,</span>&nbsp;<span class="builtintype" id="7162029">nil</span><span class="op" id="7162032">,</span>&nbsp;<span class="op" id="7162034">[</span><span class="op" id="7162035">]</span><span class="builtintype" id="7162036">byte</span><span class="op" id="7162040">,</span>&nbsp;<span class="builtintype" id="7162042">string</span><span class="op" id="7162048">,</span>&nbsp;<span class="ident" id="7162050">time</span><span class="op" id="7162054">.</span><span class="ident" id="7162055">Time</span><span class="op" id="7162059">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162063">default</span><span class="op" id="7162070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162075">return</span>&nbsp;<span class="ident" id="7162082">fmt</span><span class="op" id="7162085">.</span><span class="ident" id="7162086">Errorf</span><span class="op" id="7162092">(</span><span class="string" id="7162093">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7162141">,</span>&nbsp;<span class="ident" id="7162143">n</span><span class="op" id="7162144">+</span><span class="num" id="7162145">1</span><span class="op" id="7162146">,</span>&nbsp;<span class="ident" id="7162148">arg</span><span class="op" id="7162151">,</span>&nbsp;<span class="ident" id="7162153">arg</span><span class="op" id="7162156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7162160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7162163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162166">return</span>&nbsp;<span class="builtintype" id="7162173">nil</span><br>
<span class="lineno">325</span><span class="op" id="7162177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7162180">func</span>&nbsp;<span class="op" id="7162185">(</span><span class="ident" id="7162186">c</span>&nbsp;<span class="op" id="7162188">*</span><span class="ident" id="7162189">fakeConn</span><span class="op" id="7162197">)</span>&nbsp;<span class="ident" id="7162199">Exec</span><span class="op" id="7162203">(</span><span class="ident" id="7162204">query</span>&nbsp;<span class="builtintype" id="7162210">string</span><span class="op" id="7162216">,</span>&nbsp;<span class="ident" id="7162218">args</span>&nbsp;<span class="op" id="7162223">[</span><span class="op" id="7162224">]</span><span class="ident" id="7162225">driver</span><span class="op" id="7162231">.</span><span class="ident" id="7162232">Value</span><span class="op" id="7162237">)</span>&nbsp;<span class="op" id="7162239">(</span><span class="ident" id="7162240">driver</span><span class="op" id="7162246">.</span><span class="ident" id="7162247">Result</span><span class="op" id="7162253">,</span>&nbsp;<span class="builtintype" id="7162255">error</span><span class="op" id="7162260">)</span>&nbsp;<span class="op" id="7162262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162265">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162326">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162387">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162446">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7162473">err</span>&nbsp;<span class="op" id="7162477">:=</span>&nbsp;<span class="ident" id="7162480">checkSubsetTypes</span><span class="op" id="7162496">(</span><span class="ident" id="7162497">args</span><span class="op" id="7162501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162504">if</span>&nbsp;<span class="ident" id="7162507">err</span>&nbsp;<span class="op" id="7162511">!=</span>&nbsp;<span class="builtintype" id="7162514">nil</span>&nbsp;<span class="op" id="7162518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162522">return</span>&nbsp;<span class="builtintype" id="7162529">nil</span><span class="op" id="7162532">,</span>&nbsp;<span class="ident" id="7162534">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7162539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162542">return</span>&nbsp;<span class="builtintype" id="7162549">nil</span><span class="op" id="7162552">,</span>&nbsp;<span class="ident" id="7162554">driver</span><span class="op" id="7162560">.</span><span class="ident" id="7162561">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7162569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7162572">func</span>&nbsp;<span class="op" id="7162577">(</span><span class="ident" id="7162578">c</span>&nbsp;<span class="op" id="7162580">*</span><span class="ident" id="7162581">fakeConn</span><span class="op" id="7162589">)</span>&nbsp;<span class="ident" id="7162591">Query</span><span class="op" id="7162596">(</span><span class="ident" id="7162597">query</span>&nbsp;<span class="builtintype" id="7162603">string</span><span class="op" id="7162609">,</span>&nbsp;<span class="ident" id="7162611">args</span>&nbsp;<span class="op" id="7162616">[</span><span class="op" id="7162617">]</span><span class="ident" id="7162618">driver</span><span class="op" id="7162624">.</span><span class="ident" id="7162625">Value</span><span class="op" id="7162630">)</span>&nbsp;<span class="op" id="7162632">(</span><span class="ident" id="7162633">driver</span><span class="op" id="7162639">.</span><span class="ident" id="7162640">Rows</span><span class="op" id="7162644">,</span>&nbsp;<span class="builtintype" id="7162646">error</span><span class="op" id="7162651">)</span>&nbsp;<span class="op" id="7162653">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162656">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162717">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162778">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7162837">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7162864">err</span>&nbsp;<span class="op" id="7162868">:=</span>&nbsp;<span class="ident" id="7162871">checkSubsetTypes</span><span class="op" id="7162887">(</span><span class="ident" id="7162888">args</span><span class="op" id="7162892">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162895">if</span>&nbsp;<span class="ident" id="7162898">err</span>&nbsp;<span class="op" id="7162902">!=</span>&nbsp;<span class="builtintype" id="7162905">nil</span>&nbsp;<span class="op" id="7162909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162913">return</span>&nbsp;<span class="builtintype" id="7162920">nil</span><span class="op" id="7162923">,</span>&nbsp;<span class="ident" id="7162925">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7162930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7162933">return</span>&nbsp;<span class="builtintype" id="7162940">nil</span><span class="op" id="7162943">,</span>&nbsp;<span class="ident" id="7162945">driver</span><span class="op" id="7162951">.</span><span class="ident" id="7162952">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7162960">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7162963">func</span>&nbsp;<span class="ident" id="7162968">errf</span><span class="op" id="7162972">(</span><span class="ident" id="7162973">msg</span>&nbsp;<span class="builtintype" id="7162977">string</span><span class="op" id="7162983">,</span>&nbsp;<span class="ident" id="7162985">args</span>&nbsp;<span class="op" id="7162990">...</span><span class="keyword" id="7162993">interface</span><span class="op" id="7163002">{</span><span class="op" id="7163003">}</span><span class="op" id="7163004">)</span>&nbsp;<span class="builtintype" id="7163006">error</span>&nbsp;<span class="op" id="7163012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163015">return</span>&nbsp;<span class="ident" id="7163022">errors</span><span class="op" id="7163028">.</span><span class="ident" id="7163029">New</span><span class="op" id="7163032">(</span><span class="string" id="7163033">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7163044">+</span>&nbsp;<span class="ident" id="7163046">fmt</span><span class="op" id="7163049">.</span><span class="ident" id="7163050">Sprintf</span><span class="op" id="7163057">(</span><span class="ident" id="7163058">msg</span><span class="op" id="7163061">,</span>&nbsp;<span class="ident" id="7163063">args</span><span class="op" id="7163067">...</span><span class="op" id="7163070">)</span><span class="op" id="7163071">)</span><br>
<span class="lineno"></span><span class="op" id="7163073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7163076">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7163140">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7163197">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7163231">func</span>&nbsp;<span class="op" id="7163236">(</span><span class="ident" id="7163237">c</span>&nbsp;<span class="op" id="7163239">*</span><span class="ident" id="7163240">fakeConn</span><span class="op" id="7163248">)</span>&nbsp;<span class="ident" id="7163250">prepareSelect</span><span class="op" id="7163263">(</span><span class="ident" id="7163264">stmt</span>&nbsp;<span class="op" id="7163269">*</span><span class="ident" id="7163270">fakeStmt</span><span class="op" id="7163278">,</span>&nbsp;<span class="ident" id="7163280">parts</span>&nbsp;<span class="op" id="7163286">[</span><span class="op" id="7163287">]</span><span class="builtintype" id="7163288">string</span><span class="op" id="7163294">)</span>&nbsp;<span class="op" id="7163296">(</span><span class="ident" id="7163297">driver</span><span class="op" id="7163303">.</span><span class="ident" id="7163304">Stmt</span><span class="op" id="7163308">,</span>&nbsp;<span class="builtintype" id="7163310">error</span><span class="op" id="7163315">)</span>&nbsp;<span class="op" id="7163317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163320">if</span>&nbsp;<span class="builtinfunc" id="7163323">len</span><span class="op" id="7163326">(</span><span class="ident" id="7163327">parts</span><span class="op" id="7163332">)</span>&nbsp;<span class="op" id="7163334">!=</span>&nbsp;<span class="num" id="7163337">3</span>&nbsp;<span class="op" id="7163339">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163343">stmt</span><span class="op" id="7163347">.</span><span class="ident" id="7163348">Close</span><span class="op" id="7163353">(</span><span class="op" id="7163354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163358">return</span>&nbsp;<span class="builtintype" id="7163365">nil</span><span class="op" id="7163368">,</span>&nbsp;<span class="ident" id="7163370">errf</span><span class="op" id="7163374">(</span><span class="string" id="7163375">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7163420">,</span>&nbsp;<span class="builtinfunc" id="7163422">len</span><span class="op" id="7163425">(</span><span class="ident" id="7163426">parts</span><span class="op" id="7163431">)</span><span class="op" id="7163432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7163435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163438">stmt</span><span class="op" id="7163442">.</span><span class="ident" id="7163443">table</span>&nbsp;<span class="op" id="7163449">=</span>&nbsp;<span class="ident" id="7163451">parts</span><span class="op" id="7163456">[</span><span class="num" id="7163457">0</span><span class="op" id="7163458">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163461">stmt</span><span class="op" id="7163465">.</span><span class="ident" id="7163466">colName</span>&nbsp;<span class="op" id="7163474">=</span>&nbsp;<span class="ident" id="7163476">strings</span><span class="op" id="7163483">.</span><span class="ident" id="7163484">Split</span><span class="op" id="7163489">(</span><span class="ident" id="7163490">parts</span><span class="op" id="7163495">[</span><span class="num" id="7163496">1</span><span class="op" id="7163497">]</span><span class="op" id="7163498">,</span>&nbsp;<span class="string" id="7163500">&#34;,&#34;</span><span class="op" id="7163503">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163506">for</span>&nbsp;<span class="ident" id="7163510">n</span><span class="op" id="7163511">,</span>&nbsp;<span class="ident" id="7163513">colspec</span>&nbsp;<span class="op" id="7163521">:=</span>&nbsp;<span class="keyword" id="7163524">range</span>&nbsp;<span class="ident" id="7163530">strings</span><span class="op" id="7163537">.</span><span class="ident" id="7163538">Split</span><span class="op" id="7163543">(</span><span class="ident" id="7163544">parts</span><span class="op" id="7163549">[</span><span class="num" id="7163550">2</span><span class="op" id="7163551">]</span><span class="op" id="7163552">,</span>&nbsp;<span class="string" id="7163554">&#34;,&#34;</span><span class="op" id="7163557">)</span>&nbsp;<span class="op" id="7163559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163563">if</span>&nbsp;<span class="ident" id="7163566">colspec</span>&nbsp;<span class="op" id="7163574">==</span>&nbsp;<span class="string" id="7163577">&#34;&#34;</span>&nbsp;<span class="op" id="7163580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163585">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7163596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163600">nameVal</span>&nbsp;<span class="op" id="7163608">:=</span>&nbsp;<span class="ident" id="7163611">strings</span><span class="op" id="7163618">.</span><span class="ident" id="7163619">Split</span><span class="op" id="7163624">(</span><span class="ident" id="7163625">colspec</span><span class="op" id="7163632">,</span>&nbsp;<span class="string" id="7163634">&#34;=&#34;</span><span class="op" id="7163637">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163641">if</span>&nbsp;<span class="builtinfunc" id="7163644">len</span><span class="op" id="7163647">(</span><span class="ident" id="7163648">nameVal</span><span class="op" id="7163655">)</span>&nbsp;<span class="op" id="7163657">!=</span>&nbsp;<span class="num" id="7163660">2</span>&nbsp;<span class="op" id="7163662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163667">stmt</span><span class="op" id="7163671">.</span><span class="ident" id="7163672">Close</span><span class="op" id="7163677">(</span><span class="op" id="7163678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163683">return</span>&nbsp;<span class="builtintype" id="7163690">nil</span><span class="op" id="7163693">,</span>&nbsp;<span class="ident" id="7163695">errf</span><span class="op" id="7163699">(</span><span class="string" id="7163700">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7163761">,</span>&nbsp;<span class="ident" id="7163763">stmt</span><span class="op" id="7163767">.</span><span class="ident" id="7163768">table</span><span class="op" id="7163773">,</span>&nbsp;<span class="ident" id="7163775">colspec</span><span class="op" id="7163782">,</span>&nbsp;<span class="ident" id="7163784">n</span><span class="op" id="7163785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7163789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163793">column</span><span class="op" id="7163799">,</span>&nbsp;<span class="ident" id="7163801">value</span>&nbsp;<span class="op" id="7163807">:=</span>&nbsp;<span class="ident" id="7163810">nameVal</span><span class="op" id="7163817">[</span><span class="num" id="7163818">0</span><span class="op" id="7163819">]</span><span class="op" id="7163820">,</span>&nbsp;<span class="ident" id="7163822">nameVal</span><span class="op" id="7163829">[</span><span class="num" id="7163830">1</span><span class="op" id="7163831">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163835">_</span><span class="op" id="7163836">,</span>&nbsp;<span class="ident" id="7163838">ok</span>&nbsp;<span class="op" id="7163841">:=</span>&nbsp;<span class="ident" id="7163844">c</span><span class="op" id="7163845">.</span><span class="ident" id="7163846">db</span><span class="op" id="7163848">.</span><span class="ident" id="7163849">columnType</span><span class="op" id="7163859">(</span><span class="ident" id="7163860">stmt</span><span class="op" id="7163864">.</span><span class="ident" id="7163865">table</span><span class="op" id="7163870">,</span>&nbsp;<span class="ident" id="7163872">column</span><span class="op" id="7163878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163882">if</span>&nbsp;<span class="op" id="7163885">!</span><span class="ident" id="7163886">ok</span>&nbsp;<span class="op" id="7163889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7163894">stmt</span><span class="op" id="7163898">.</span><span class="ident" id="7163899">Close</span><span class="op" id="7163904">(</span><span class="op" id="7163905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7163910">return</span>&nbsp;<span class="builtintype" id="7163917">nil</span><span class="op" id="7163920">,</span>&nbsp;<span class="ident" id="7163922">errf</span><span class="op" id="7163926">(</span><span class="string" id="7163927">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7163981">,</span>&nbsp;<span class="ident" id="7163983">stmt</span><span class="op" id="7163987">.</span><span class="ident" id="7163988">table</span><span class="op" id="7163993">,</span>&nbsp;<span class="ident" id="7163995">column</span><span class="op" id="7164001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164005">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164009">if</span>&nbsp;<span class="ident" id="7164012">value</span>&nbsp;<span class="op" id="7164018">!=</span>&nbsp;<span class="string" id="7164021">&#34;?&#34;</span>&nbsp;<span class="op" id="7164025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164030">stmt</span><span class="op" id="7164034">.</span><span class="ident" id="7164035">Close</span><span class="op" id="7164040">(</span><span class="op" id="7164041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164046">return</span>&nbsp;<span class="builtintype" id="7164053">nil</span><span class="op" id="7164056">,</span>&nbsp;<span class="ident" id="7164058">errf</span><span class="op" id="7164062">(</span><span class="string" id="7164063">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7164145">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164151">stmt</span><span class="op" id="7164155">.</span><span class="ident" id="7164156">table</span><span class="op" id="7164161">,</span>&nbsp;<span class="ident" id="7164163">column</span><span class="op" id="7164169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164173">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164177">stmt</span><span class="op" id="7164181">.</span><span class="ident" id="7164182">whereCol</span>&nbsp;<span class="op" id="7164191">=</span>&nbsp;<span class="builtinfunc" id="7164193">append</span><span class="op" id="7164199">(</span><span class="ident" id="7164200">stmt</span><span class="op" id="7164204">.</span><span class="ident" id="7164205">whereCol</span><span class="op" id="7164213">,</span>&nbsp;<span class="ident" id="7164215">column</span><span class="op" id="7164221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164225">stmt</span><span class="op" id="7164229">.</span><span class="ident" id="7164230">placeholders</span><span class="op" id="7164242">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164249">return</span>&nbsp;<span class="ident" id="7164256">stmt</span><span class="op" id="7164260">,</span>&nbsp;<span class="builtintype" id="7164262">nil</span><br>
<span class="lineno"></span><span class="op" id="7164266">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7164269">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7164308">func</span>&nbsp;<span class="op" id="7164313">(</span><span class="ident" id="7164314">c</span>&nbsp;<span class="op" id="7164316">*</span><span class="ident" id="7164317">fakeConn</span><span class="op" id="7164325">)</span>&nbsp;<span class="ident" id="7164327">prepareCreate</span><span class="op" id="7164340">(</span><span class="ident" id="7164341">stmt</span>&nbsp;<span class="op" id="7164346">*</span><span class="ident" id="7164347">fakeStmt</span><span class="op" id="7164355">,</span>&nbsp;<span class="ident" id="7164357">parts</span>&nbsp;<span class="op" id="7164363">[</span><span class="op" id="7164364">]</span><span class="builtintype" id="7164365">string</span><span class="op" id="7164371">)</span>&nbsp;<span class="op" id="7164373">(</span><span class="ident" id="7164374">driver</span><span class="op" id="7164380">.</span><span class="ident" id="7164381">Stmt</span><span class="op" id="7164385">,</span>&nbsp;<span class="builtintype" id="7164387">error</span><span class="op" id="7164392">)</span>&nbsp;<span class="op" id="7164394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164397">if</span>&nbsp;<span class="builtinfunc" id="7164400">len</span><span class="op" id="7164403">(</span><span class="ident" id="7164404">parts</span><span class="op" id="7164409">)</span>&nbsp;<span class="op" id="7164411">!=</span>&nbsp;<span class="num" id="7164414">2</span>&nbsp;<span class="op" id="7164416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164420">stmt</span><span class="op" id="7164424">.</span><span class="ident" id="7164425">Close</span><span class="op" id="7164430">(</span><span class="op" id="7164431">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164435">return</span>&nbsp;<span class="builtintype" id="7164442">nil</span><span class="op" id="7164445">,</span>&nbsp;<span class="ident" id="7164447">errf</span><span class="op" id="7164451">(</span><span class="string" id="7164452">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7164497">,</span>&nbsp;<span class="builtinfunc" id="7164499">len</span><span class="op" id="7164502">(</span><span class="ident" id="7164503">parts</span><span class="op" id="7164508">)</span><span class="op" id="7164509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164515">stmt</span><span class="op" id="7164519">.</span><span class="ident" id="7164520">table</span>&nbsp;<span class="op" id="7164526">=</span>&nbsp;<span class="ident" id="7164528">parts</span><span class="op" id="7164533">[</span><span class="num" id="7164534">0</span><span class="op" id="7164535">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164538">for</span>&nbsp;<span class="ident" id="7164542">n</span><span class="op" id="7164543">,</span>&nbsp;<span class="ident" id="7164545">colspec</span>&nbsp;<span class="op" id="7164553">:=</span>&nbsp;<span class="keyword" id="7164556">range</span>&nbsp;<span class="ident" id="7164562">strings</span><span class="op" id="7164569">.</span><span class="ident" id="7164570">Split</span><span class="op" id="7164575">(</span><span class="ident" id="7164576">parts</span><span class="op" id="7164581">[</span><span class="num" id="7164582">1</span><span class="op" id="7164583">]</span><span class="op" id="7164584">,</span>&nbsp;<span class="string" id="7164586">&#34;,&#34;</span><span class="op" id="7164589">)</span>&nbsp;<span class="op" id="7164591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164595">nameType</span>&nbsp;<span class="op" id="7164604">:=</span>&nbsp;<span class="ident" id="7164607">strings</span><span class="op" id="7164614">.</span><span class="ident" id="7164615">Split</span><span class="op" id="7164620">(</span><span class="ident" id="7164621">colspec</span><span class="op" id="7164628">,</span>&nbsp;<span class="string" id="7164630">&#34;=&#34;</span><span class="op" id="7164633">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164637">if</span>&nbsp;<span class="builtinfunc" id="7164640">len</span><span class="op" id="7164643">(</span><span class="ident" id="7164644">nameType</span><span class="op" id="7164652">)</span>&nbsp;<span class="op" id="7164654">!=</span>&nbsp;<span class="num" id="7164657">2</span>&nbsp;<span class="op" id="7164659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164664">stmt</span><span class="op" id="7164668">.</span><span class="ident" id="7164669">Close</span><span class="op" id="7164674">(</span><span class="op" id="7164675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164680">return</span>&nbsp;<span class="builtintype" id="7164687">nil</span><span class="op" id="7164690">,</span>&nbsp;<span class="ident" id="7164692">errf</span><span class="op" id="7164696">(</span><span class="string" id="7164697">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7164755">,</span>&nbsp;<span class="ident" id="7164757">stmt</span><span class="op" id="7164761">.</span><span class="ident" id="7164762">table</span><span class="op" id="7164767">,</span>&nbsp;<span class="ident" id="7164769">colspec</span><span class="op" id="7164776">,</span>&nbsp;<span class="ident" id="7164778">n</span><span class="op" id="7164779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164787">stmt</span><span class="op" id="7164791">.</span><span class="ident" id="7164792">colName</span>&nbsp;<span class="op" id="7164800">=</span>&nbsp;<span class="builtinfunc" id="7164802">append</span><span class="op" id="7164808">(</span><span class="ident" id="7164809">stmt</span><span class="op" id="7164813">.</span><span class="ident" id="7164814">colName</span><span class="op" id="7164821">,</span>&nbsp;<span class="ident" id="7164823">nameType</span><span class="op" id="7164831">[</span><span class="num" id="7164832">0</span><span class="op" id="7164833">]</span><span class="op" id="7164834">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7164838">stmt</span><span class="op" id="7164842">.</span><span class="ident" id="7164843">colType</span>&nbsp;<span class="op" id="7164851">=</span>&nbsp;<span class="builtinfunc" id="7164853">append</span><span class="op" id="7164859">(</span><span class="ident" id="7164860">stmt</span><span class="op" id="7164864">.</span><span class="ident" id="7164865">colType</span><span class="op" id="7164872">,</span>&nbsp;<span class="ident" id="7164874">nameType</span><span class="op" id="7164882">[</span><span class="num" id="7164883">1</span><span class="op" id="7164884">]</span><span class="op" id="7164885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7164888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7164891">return</span>&nbsp;<span class="ident" id="7164898">stmt</span><span class="op" id="7164902">,</span>&nbsp;<span class="builtintype" id="7164904">nil</span><br>
<span class="lineno"></span><span class="op" id="7164908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7164911">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7164945">func</span>&nbsp;<span class="op" id="7164950">(</span><span class="ident" id="7164951">c</span>&nbsp;<span class="op" id="7164953">*</span><span class="ident" id="7164954">fakeConn</span><span class="op" id="7164962">)</span>&nbsp;<span class="ident" id="7164964">prepareInsert</span><span class="op" id="7164977">(</span><span class="ident" id="7164978">stmt</span>&nbsp;<span class="op" id="7164983">*</span><span class="ident" id="7164984">fakeStmt</span><span class="op" id="7164992">,</span>&nbsp;<span class="ident" id="7164994">parts</span>&nbsp;<span class="op" id="7165000">[</span><span class="op" id="7165001">]</span><span class="builtintype" id="7165002">string</span><span class="op" id="7165008">)</span>&nbsp;<span class="op" id="7165010">(</span><span class="ident" id="7165011">driver</span><span class="op" id="7165017">.</span><span class="ident" id="7165018">Stmt</span><span class="op" id="7165022">,</span>&nbsp;<span class="builtintype" id="7165024">error</span><span class="op" id="7165029">)</span>&nbsp;<span class="op" id="7165031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165034">if</span>&nbsp;<span class="builtinfunc" id="7165037">len</span><span class="op" id="7165040">(</span><span class="ident" id="7165041">parts</span><span class="op" id="7165046">)</span>&nbsp;<span class="op" id="7165048">!=</span>&nbsp;<span class="num" id="7165051">2</span>&nbsp;<span class="op" id="7165053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165057">stmt</span><span class="op" id="7165061">.</span><span class="ident" id="7165062">Close</span><span class="op" id="7165067">(</span><span class="op" id="7165068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165072">return</span>&nbsp;<span class="builtintype" id="7165079">nil</span><span class="op" id="7165082">,</span>&nbsp;<span class="ident" id="7165084">errf</span><span class="op" id="7165088">(</span><span class="string" id="7165089">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7165134">,</span>&nbsp;<span class="builtinfunc" id="7165136">len</span><span class="op" id="7165139">(</span><span class="ident" id="7165140">parts</span><span class="op" id="7165145">)</span><span class="op" id="7165146">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7165149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165152">stmt</span><span class="op" id="7165156">.</span><span class="ident" id="7165157">table</span>&nbsp;<span class="op" id="7165163">=</span>&nbsp;<span class="ident" id="7165165">parts</span><span class="op" id="7165170">[</span><span class="num" id="7165171">0</span><span class="op" id="7165172">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165175">for</span>&nbsp;<span class="ident" id="7165179">n</span><span class="op" id="7165180">,</span>&nbsp;<span class="ident" id="7165182">colspec</span>&nbsp;<span class="op" id="7165190">:=</span>&nbsp;<span class="keyword" id="7165193">range</span>&nbsp;<span class="ident" id="7165199">strings</span><span class="op" id="7165206">.</span><span class="ident" id="7165207">Split</span><span class="op" id="7165212">(</span><span class="ident" id="7165213">parts</span><span class="op" id="7165218">[</span><span class="num" id="7165219">1</span><span class="op" id="7165220">]</span><span class="op" id="7165221">,</span>&nbsp;<span class="string" id="7165223">&#34;,&#34;</span><span class="op" id="7165226">)</span>&nbsp;<span class="op" id="7165228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165232">nameVal</span>&nbsp;<span class="op" id="7165240">:=</span>&nbsp;<span class="ident" id="7165243">strings</span><span class="op" id="7165250">.</span><span class="ident" id="7165251">Split</span><span class="op" id="7165256">(</span><span class="ident" id="7165257">colspec</span><span class="op" id="7165264">,</span>&nbsp;<span class="string" id="7165266">&#34;=&#34;</span><span class="op" id="7165269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165273">if</span>&nbsp;<span class="builtinfunc" id="7165276">len</span><span class="op" id="7165279">(</span><span class="ident" id="7165280">nameVal</span><span class="op" id="7165287">)</span>&nbsp;<span class="op" id="7165289">!=</span>&nbsp;<span class="num" id="7165292">2</span>&nbsp;<span class="op" id="7165294">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165299">stmt</span><span class="op" id="7165303">.</span><span class="ident" id="7165304">Close</span><span class="op" id="7165309">(</span><span class="op" id="7165310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165315">return</span>&nbsp;<span class="builtintype" id="7165322">nil</span><span class="op" id="7165325">,</span>&nbsp;<span class="ident" id="7165327">errf</span><span class="op" id="7165331">(</span><span class="string" id="7165332">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7165390">,</span>&nbsp;<span class="ident" id="7165392">stmt</span><span class="op" id="7165396">.</span><span class="ident" id="7165397">table</span><span class="op" id="7165402">,</span>&nbsp;<span class="ident" id="7165404">colspec</span><span class="op" id="7165411">,</span>&nbsp;<span class="ident" id="7165413">n</span><span class="op" id="7165414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7165418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165422">column</span><span class="op" id="7165428">,</span>&nbsp;<span class="ident" id="7165430">value</span>&nbsp;<span class="op" id="7165436">:=</span>&nbsp;<span class="ident" id="7165439">nameVal</span><span class="op" id="7165446">[</span><span class="num" id="7165447">0</span><span class="op" id="7165448">]</span><span class="op" id="7165449">,</span>&nbsp;<span class="ident" id="7165451">nameVal</span><span class="op" id="7165458">[</span><span class="num" id="7165459">1</span><span class="op" id="7165460">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165464">ctype</span><span class="op" id="7165469">,</span>&nbsp;<span class="ident" id="7165471">ok</span>&nbsp;<span class="op" id="7165474">:=</span>&nbsp;<span class="ident" id="7165477">c</span><span class="op" id="7165478">.</span><span class="ident" id="7165479">db</span><span class="op" id="7165481">.</span><span class="ident" id="7165482">columnType</span><span class="op" id="7165492">(</span><span class="ident" id="7165493">stmt</span><span class="op" id="7165497">.</span><span class="ident" id="7165498">table</span><span class="op" id="7165503">,</span>&nbsp;<span class="ident" id="7165505">column</span><span class="op" id="7165511">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165515">if</span>&nbsp;<span class="op" id="7165518">!</span><span class="ident" id="7165519">ok</span>&nbsp;<span class="op" id="7165522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165527">stmt</span><span class="op" id="7165531">.</span><span class="ident" id="7165532">Close</span><span class="op" id="7165537">(</span><span class="op" id="7165538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165543">return</span>&nbsp;<span class="builtintype" id="7165550">nil</span><span class="op" id="7165553">,</span>&nbsp;<span class="ident" id="7165555">errf</span><span class="op" id="7165559">(</span><span class="string" id="7165560">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7165611">,</span>&nbsp;<span class="ident" id="7165613">stmt</span><span class="op" id="7165617">.</span><span class="ident" id="7165618">table</span><span class="op" id="7165623">,</span>&nbsp;<span class="ident" id="7165625">column</span><span class="op" id="7165631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7165635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165639">stmt</span><span class="op" id="7165643">.</span><span class="ident" id="7165644">colName</span>&nbsp;<span class="op" id="7165652">=</span>&nbsp;<span class="builtinfunc" id="7165654">append</span><span class="op" id="7165660">(</span><span class="ident" id="7165661">stmt</span><span class="op" id="7165665">.</span><span class="ident" id="7165666">colName</span><span class="op" id="7165673">,</span>&nbsp;<span class="ident" id="7165675">column</span><span class="op" id="7165681">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165686">if</span>&nbsp;<span class="ident" id="7165689">value</span>&nbsp;<span class="op" id="7165695">!=</span>&nbsp;<span class="string" id="7165698">&#34;?&#34;</span>&nbsp;<span class="op" id="7165702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165707">var</span>&nbsp;<span class="ident" id="7165711">subsetVal</span>&nbsp;<span class="keyword" id="7165721">interface</span><span class="op" id="7165730">{</span><span class="op" id="7165731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7165736">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165772">switch</span>&nbsp;<span class="ident" id="7165779">ctype</span>&nbsp;<span class="op" id="7165785">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165790">case</span>&nbsp;<span class="string" id="7165795">&#34;string&#34;</span><span class="op" id="7165803">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165809">subsetVal</span>&nbsp;<span class="op" id="7165819">=</span>&nbsp;<span class="op" id="7165821">[</span><span class="op" id="7165822">]</span><span class="builtintype" id="7165823">byte</span><span class="op" id="7165827">(</span><span class="ident" id="7165828">value</span><span class="op" id="7165833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165838">case</span>&nbsp;<span class="string" id="7165843">&#34;blob&#34;</span><span class="op" id="7165849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165855">subsetVal</span>&nbsp;<span class="op" id="7165865">=</span>&nbsp;<span class="op" id="7165867">[</span><span class="op" id="7165868">]</span><span class="builtintype" id="7165869">byte</span><span class="op" id="7165873">(</span><span class="ident" id="7165874">value</span><span class="op" id="7165879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165884">case</span>&nbsp;<span class="string" id="7165889">&#34;int32&#34;</span><span class="op" id="7165896">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165902">i</span><span class="op" id="7165903">,</span>&nbsp;<span class="ident" id="7165905">err</span>&nbsp;<span class="op" id="7165909">:=</span>&nbsp;<span class="ident" id="7165912">strconv</span><span class="op" id="7165919">.</span><span class="ident" id="7165920">Atoi</span><span class="op" id="7165924">(</span><span class="ident" id="7165925">value</span><span class="op" id="7165930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165936">if</span>&nbsp;<span class="ident" id="7165939">err</span>&nbsp;<span class="op" id="7165943">!=</span>&nbsp;<span class="builtintype" id="7165946">nil</span>&nbsp;<span class="op" id="7165950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7165957">stmt</span><span class="op" id="7165961">.</span><span class="ident" id="7165962">Close</span><span class="op" id="7165967">(</span><span class="op" id="7165968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7165975">return</span>&nbsp;<span class="builtintype" id="7165982">nil</span><span class="op" id="7165985">,</span>&nbsp;<span class="ident" id="7165987">errf</span><span class="op" id="7165991">(</span><span class="string" id="7165992">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7166029">,</span>&nbsp;<span class="ident" id="7166031">value</span><span class="op" id="7166036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166042">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166048">subsetVal</span>&nbsp;<span class="op" id="7166058">=</span>&nbsp;<span class="ident" id="7166060">int64</span><span class="op" id="7166065">(</span><span class="ident" id="7166066">i</span><span class="op" id="7166067">)</span>&nbsp;<span class="comment" id="7166069">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166113">default</span><span class="op" id="7166120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166126">stmt</span><span class="op" id="7166130">.</span><span class="ident" id="7166131">Close</span><span class="op" id="7166136">(</span><span class="op" id="7166137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166143">return</span>&nbsp;<span class="builtintype" id="7166150">nil</span><span class="op" id="7166153">,</span>&nbsp;<span class="ident" id="7166155">errf</span><span class="op" id="7166159">(</span><span class="string" id="7166160">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7166222">,</span>&nbsp;<span class="ident" id="7166224">value</span><span class="op" id="7166229">,</span>&nbsp;<span class="ident" id="7166231">ctype</span><span class="op" id="7166236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166241">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166246">stmt</span><span class="op" id="7166250">.</span><span class="ident" id="7166251">colValue</span>&nbsp;<span class="op" id="7166260">=</span>&nbsp;<span class="builtinfunc" id="7166262">append</span><span class="op" id="7166268">(</span><span class="ident" id="7166269">stmt</span><span class="op" id="7166273">.</span><span class="ident" id="7166274">colValue</span><span class="op" id="7166282">,</span>&nbsp;<span class="ident" id="7166284">subsetVal</span><span class="op" id="7166293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166297">}</span>&nbsp;<span class="keyword" id="7166299">else</span>&nbsp;<span class="op" id="7166304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166309">stmt</span><span class="op" id="7166313">.</span><span class="ident" id="7166314">placeholders</span><span class="op" id="7166326">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166332">stmt</span><span class="op" id="7166336">.</span><span class="ident" id="7166337">placeholderConverter</span>&nbsp;<span class="op" id="7166358">=</span>&nbsp;<span class="builtinfunc" id="7166360">append</span><span class="op" id="7166366">(</span><span class="ident" id="7166367">stmt</span><span class="op" id="7166371">.</span><span class="ident" id="7166372">placeholderConverter</span><span class="op" id="7166392">,</span>&nbsp;<span class="ident" id="7166394">converterForType</span><span class="op" id="7166410">(</span><span class="ident" id="7166411">ctype</span><span class="op" id="7166416">)</span><span class="op" id="7166417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166422">stmt</span><span class="op" id="7166426">.</span><span class="ident" id="7166427">colValue</span>&nbsp;<span class="op" id="7166436">=</span>&nbsp;<span class="builtinfunc" id="7166438">append</span><span class="op" id="7166444">(</span><span class="ident" id="7166445">stmt</span><span class="op" id="7166449">.</span><span class="ident" id="7166450">colValue</span><span class="op" id="7166458">,</span>&nbsp;<span class="string" id="7166460">&#34;?&#34;</span><span class="op" id="7166463">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166473">return</span>&nbsp;<span class="ident" id="7166480">stmt</span><span class="op" id="7166484">,</span>&nbsp;<span class="builtintype" id="7166486">nil</span><br>
<span class="lineno"></span><span class="op" id="7166490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7166493">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7166532">var</span>&nbsp;<span class="ident" id="7166536">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7166555">func</span><span class="op" id="7166559">(</span><span class="op" id="7166560">)</span>&nbsp;<span class="builtintype" id="7166562">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7166568">func</span>&nbsp;<span class="op" id="7166573">(</span><span class="ident" id="7166574">c</span>&nbsp;<span class="op" id="7166576">*</span><span class="ident" id="7166577">fakeConn</span><span class="op" id="7166585">)</span>&nbsp;<span class="ident" id="7166587">Prepare</span><span class="op" id="7166594">(</span><span class="ident" id="7166595">query</span>&nbsp;<span class="builtintype" id="7166601">string</span><span class="op" id="7166607">)</span>&nbsp;<span class="op" id="7166609">(</span><span class="ident" id="7166610">driver</span><span class="op" id="7166616">.</span><span class="ident" id="7166617">Stmt</span><span class="op" id="7166621">,</span>&nbsp;<span class="builtintype" id="7166623">error</span><span class="op" id="7166628">)</span>&nbsp;<span class="op" id="7166630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166633">c</span><span class="op" id="7166634">.</span><span class="ident" id="7166635">numPrepare</span><span class="op" id="7166645">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166649">if</span>&nbsp;<span class="ident" id="7166652">c</span><span class="op" id="7166653">.</span><span class="ident" id="7166654">db</span>&nbsp;<span class="op" id="7166657">==</span>&nbsp;<span class="builtintype" id="7166660">nil</span>&nbsp;<span class="op" id="7166664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7166668">panic</span><span class="op" id="7166673">(</span><span class="string" id="7166674">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7166694">+</span>&nbsp;<span class="ident" id="7166696">fmt</span><span class="op" id="7166699">.</span><span class="ident" id="7166700">Sprintf</span><span class="op" id="7166707">(</span><span class="string" id="7166708">&#34;%#v&#34;</span><span class="op" id="7166713">,</span>&nbsp;<span class="ident" id="7166715">c</span><span class="op" id="7166716">)</span><span class="op" id="7166717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166724">if</span>&nbsp;<span class="ident" id="7166727">hookPrepareBadConn</span>&nbsp;<span class="op" id="7166746">!=</span>&nbsp;<span class="builtintype" id="7166749">nil</span>&nbsp;<span class="op" id="7166753">&amp;&amp;</span>&nbsp;<span class="ident" id="7166756">hookPrepareBadConn</span><span class="op" id="7166774">(</span><span class="op" id="7166775">)</span>&nbsp;<span class="op" id="7166777">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166781">return</span>&nbsp;<span class="builtintype" id="7166788">nil</span><span class="op" id="7166791">,</span>&nbsp;<span class="ident" id="7166793">driver</span><span class="op" id="7166799">.</span><span class="ident" id="7166800">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166816">parts</span>&nbsp;<span class="op" id="7166822">:=</span>&nbsp;<span class="ident" id="7166825">strings</span><span class="op" id="7166832">.</span><span class="ident" id="7166833">Split</span><span class="op" id="7166838">(</span><span class="ident" id="7166839">query</span><span class="op" id="7166844">,</span>&nbsp;<span class="string" id="7166846">&#34;|&#34;</span><span class="op" id="7166849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166852">if</span>&nbsp;<span class="builtinfunc" id="7166855">len</span><span class="op" id="7166858">(</span><span class="ident" id="7166859">parts</span><span class="op" id="7166864">)</span>&nbsp;<span class="op" id="7166866">&lt;</span>&nbsp;<span class="num" id="7166868">1</span>&nbsp;<span class="op" id="7166870">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7166874">return</span>&nbsp;<span class="builtintype" id="7166881">nil</span><span class="op" id="7166884">,</span>&nbsp;<span class="ident" id="7166886">errf</span><span class="op" id="7166890">(</span><span class="string" id="7166891">&#34;empty&nbsp;query&#34;</span><span class="op" id="7166904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7166907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166910">cmd</span>&nbsp;<span class="op" id="7166914">:=</span>&nbsp;<span class="ident" id="7166917">parts</span><span class="op" id="7166922">[</span><span class="num" id="7166923">0</span><span class="op" id="7166924">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166927">parts</span>&nbsp;<span class="op" id="7166933">=</span>&nbsp;<span class="ident" id="7166935">parts</span><span class="op" id="7166940">[</span><span class="num" id="7166941">1</span><span class="op" id="7166942">:</span><span class="op" id="7166943">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166946">stmt</span>&nbsp;<span class="op" id="7166951">:=</span>&nbsp;<span class="op" id="7166954">&amp;</span><span class="ident" id="7166955">fakeStmt</span><span class="op" id="7166963">{</span><span class="ident" id="7166964">q</span><span class="op" id="7166965">:</span>&nbsp;<span class="ident" id="7166967">query</span><span class="op" id="7166972">,</span>&nbsp;<span class="ident" id="7166974">c</span><span class="op" id="7166975">:</span>&nbsp;<span class="ident" id="7166977">c</span><span class="op" id="7166978">,</span>&nbsp;<span class="ident" id="7166980">cmd</span><span class="op" id="7166983">:</span>&nbsp;<span class="ident" id="7166985">cmd</span><span class="op" id="7166988">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7166991">c</span><span class="op" id="7166992">.</span><span class="ident" id="7166993">incrStat</span><span class="op" id="7167001">(</span><span class="op" id="7167002">&amp;</span><span class="ident" id="7167003">c</span><span class="op" id="7167004">.</span><span class="ident" id="7167005">stmtsMade</span><span class="op" id="7167014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167017">switch</span>&nbsp;<span class="ident" id="7167024">cmd</span>&nbsp;<span class="op" id="7167028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167031">case</span>&nbsp;<span class="string" id="7167036">&#34;WIPE&#34;</span><span class="op" id="7167042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7167046">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167058">case</span>&nbsp;<span class="string" id="7167063">&#34;SELECT&#34;</span><span class="op" id="7167071">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167075">return</span>&nbsp;<span class="ident" id="7167082">c</span><span class="op" id="7167083">.</span><span class="ident" id="7167084">prepareSelect</span><span class="op" id="7167097">(</span><span class="ident" id="7167098">stmt</span><span class="op" id="7167102">,</span>&nbsp;<span class="ident" id="7167104">parts</span><span class="op" id="7167109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167112">case</span>&nbsp;<span class="string" id="7167117">&#34;CREATE&#34;</span><span class="op" id="7167125">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167129">return</span>&nbsp;<span class="ident" id="7167136">c</span><span class="op" id="7167137">.</span><span class="ident" id="7167138">prepareCreate</span><span class="op" id="7167151">(</span><span class="ident" id="7167152">stmt</span><span class="op" id="7167156">,</span>&nbsp;<span class="ident" id="7167158">parts</span><span class="op" id="7167163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167166">case</span>&nbsp;<span class="string" id="7167171">&#34;INSERT&#34;</span><span class="op" id="7167179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167183">return</span>&nbsp;<span class="ident" id="7167190">c</span><span class="op" id="7167191">.</span><span class="ident" id="7167192">prepareInsert</span><span class="op" id="7167205">(</span><span class="ident" id="7167206">stmt</span><span class="op" id="7167210">,</span>&nbsp;<span class="ident" id="7167212">parts</span><span class="op" id="7167217">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167220">case</span>&nbsp;<span class="string" id="7167225">&#34;NOSERT&#34;</span><span class="op" id="7167233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7167237">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7167317">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167361">return</span>&nbsp;<span class="ident" id="7167368">c</span><span class="op" id="7167369">.</span><span class="ident" id="7167370">prepareInsert</span><span class="op" id="7167383">(</span><span class="ident" id="7167384">stmt</span><span class="op" id="7167388">,</span>&nbsp;<span class="ident" id="7167390">parts</span><span class="op" id="7167395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167398">default</span><span class="op" id="7167405">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7167409">stmt</span><span class="op" id="7167413">.</span><span class="ident" id="7167414">Close</span><span class="op" id="7167419">(</span><span class="op" id="7167420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167424">return</span>&nbsp;<span class="builtintype" id="7167431">nil</span><span class="op" id="7167434">,</span>&nbsp;<span class="ident" id="7167436">errf</span><span class="op" id="7167440">(</span><span class="string" id="7167441">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7167470">,</span>&nbsp;<span class="ident" id="7167472">cmd</span><span class="op" id="7167475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7167478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167481">return</span>&nbsp;<span class="ident" id="7167488">stmt</span><span class="op" id="7167492">,</span>&nbsp;<span class="builtintype" id="7167494">nil</span><br>
<span class="lineno"></span><span class="op" id="7167498">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7167501">func</span>&nbsp;<span class="op" id="7167506">(</span><span class="ident" id="7167507">s</span>&nbsp;<span class="op" id="7167509">*</span><span class="ident" id="7167510">fakeStmt</span><span class="op" id="7167518">)</span>&nbsp;<span class="ident" id="7167520">ColumnConverter</span><span class="op" id="7167535">(</span><span class="ident" id="7167536">idx</span>&nbsp;<span class="builtintype" id="7167540">int</span><span class="op" id="7167543">)</span>&nbsp;<span class="ident" id="7167545">driver</span><span class="op" id="7167551">.</span><span class="ident" id="7167552">ValueConverter</span>&nbsp;<span class="op" id="7167567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167570">if</span>&nbsp;<span class="builtinfunc" id="7167573">len</span><span class="op" id="7167576">(</span><span class="ident" id="7167577">s</span><span class="op" id="7167578">.</span><span class="ident" id="7167579">placeholderConverter</span><span class="op" id="7167599">)</span>&nbsp;<span class="op" id="7167601">==</span>&nbsp;<span class="num" id="7167604">0</span>&nbsp;<span class="op" id="7167606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167610">return</span>&nbsp;<span class="ident" id="7167617">driver</span><span class="op" id="7167623">.</span><span class="ident" id="7167624">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7167651">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167654">return</span>&nbsp;<span class="ident" id="7167661">s</span><span class="op" id="7167662">.</span><span class="ident" id="7167663">placeholderConverter</span><span class="op" id="7167683">[</span><span class="ident" id="7167684">idx</span><span class="op" id="7167687">]</span><br>
<span class="lineno"></span><span class="op" id="7167689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7167692">func</span>&nbsp;<span class="op" id="7167697">(</span><span class="ident" id="7167698">s</span>&nbsp;<span class="op" id="7167700">*</span><span class="ident" id="7167701">fakeStmt</span><span class="op" id="7167709">)</span>&nbsp;<span class="ident" id="7167711">Close</span><span class="op" id="7167716">(</span><span class="op" id="7167717">)</span>&nbsp;<span class="builtintype" id="7167719">error</span>&nbsp;<span class="op" id="7167725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167728">if</span>&nbsp;<span class="ident" id="7167731">s</span><span class="op" id="7167732">.</span><span class="ident" id="7167733">c</span>&nbsp;<span class="op" id="7167735">==</span>&nbsp;<span class="builtintype" id="7167738">nil</span>&nbsp;<span class="op" id="7167742">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7167746">panic</span><span class="op" id="7167751">(</span><span class="string" id="7167752">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7167780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7167783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167786">if</span>&nbsp;<span class="ident" id="7167789">s</span><span class="op" id="7167790">.</span><span class="ident" id="7167791">c</span><span class="op" id="7167792">.</span><span class="ident" id="7167793">db</span>&nbsp;<span class="op" id="7167796">==</span>&nbsp;<span class="builtintype" id="7167799">nil</span>&nbsp;<span class="op" id="7167803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7167807">panic</span><span class="op" id="7167812">(</span><span class="string" id="7167813">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7167867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7167870">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167873">if</span>&nbsp;<span class="op" id="7167876">!</span><span class="ident" id="7167877">s</span><span class="op" id="7167878">.</span><span class="ident" id="7167879">closed</span>&nbsp;<span class="op" id="7167886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7167890">s</span><span class="op" id="7167891">.</span><span class="ident" id="7167892">c</span><span class="op" id="7167893">.</span><span class="ident" id="7167894">incrStat</span><span class="op" id="7167902">(</span><span class="op" id="7167903">&amp;</span><span class="ident" id="7167904">s</span><span class="op" id="7167905">.</span><span class="ident" id="7167906">c</span><span class="op" id="7167907">.</span><span class="ident" id="7167908">stmtsClosed</span><span class="op" id="7167919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7167923">s</span><span class="op" id="7167924">.</span><span class="ident" id="7167925">closed</span>&nbsp;<span class="op" id="7167932">=</span>&nbsp;<span class="builtintype" id="7167934">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7167940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7167943">return</span>&nbsp;<span class="builtintype" id="7167950">nil</span><br>
<span class="lineno">520</span><span class="op" id="7167954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7167957">var</span>&nbsp;<span class="ident" id="7167961">errClosed</span>&nbsp;<span class="op" id="7167971">=</span>&nbsp;<span class="ident" id="7167973">errors</span><span class="op" id="7167979">.</span><span class="ident" id="7167980">New</span><span class="op" id="7167983">(</span><span class="string" id="7167984">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7168019">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7168022">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7168061">var</span>&nbsp;<span class="ident" id="7168065">hookExecBadConn</span>&nbsp;<span class="keyword" id="7168081">func</span><span class="op" id="7168085">(</span><span class="op" id="7168086">)</span>&nbsp;<span class="builtintype" id="7168088">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7168094">func</span>&nbsp;<span class="op" id="7168099">(</span><span class="ident" id="7168100">s</span>&nbsp;<span class="op" id="7168102">*</span><span class="ident" id="7168103">fakeStmt</span><span class="op" id="7168111">)</span>&nbsp;<span class="ident" id="7168113">Exec</span><span class="op" id="7168117">(</span><span class="ident" id="7168118">args</span>&nbsp;<span class="op" id="7168123">[</span><span class="op" id="7168124">]</span><span class="ident" id="7168125">driver</span><span class="op" id="7168131">.</span><span class="ident" id="7168132">Value</span><span class="op" id="7168137">)</span>&nbsp;<span class="op" id="7168139">(</span><span class="ident" id="7168140">driver</span><span class="op" id="7168146">.</span><span class="ident" id="7168147">Result</span><span class="op" id="7168153">,</span>&nbsp;<span class="builtintype" id="7168155">error</span><span class="op" id="7168160">)</span>&nbsp;<span class="op" id="7168162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168165">if</span>&nbsp;<span class="ident" id="7168168">s</span><span class="op" id="7168169">.</span><span class="ident" id="7168170">closed</span>&nbsp;<span class="op" id="7168177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168181">return</span>&nbsp;<span class="builtintype" id="7168188">nil</span><span class="op" id="7168191">,</span>&nbsp;<span class="ident" id="7168193">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168208">if</span>&nbsp;<span class="ident" id="7168211">hookExecBadConn</span>&nbsp;<span class="op" id="7168227">!=</span>&nbsp;<span class="builtintype" id="7168230">nil</span>&nbsp;<span class="op" id="7168234">&amp;&amp;</span>&nbsp;<span class="ident" id="7168237">hookExecBadConn</span><span class="op" id="7168252">(</span><span class="op" id="7168253">)</span>&nbsp;<span class="op" id="7168255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168259">return</span>&nbsp;<span class="builtintype" id="7168266">nil</span><span class="op" id="7168269">,</span>&nbsp;<span class="ident" id="7168271">driver</span><span class="op" id="7168277">.</span><span class="ident" id="7168278">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168290">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7168294">err</span>&nbsp;<span class="op" id="7168298">:=</span>&nbsp;<span class="ident" id="7168301">checkSubsetTypes</span><span class="op" id="7168317">(</span><span class="ident" id="7168318">args</span><span class="op" id="7168322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168325">if</span>&nbsp;<span class="ident" id="7168328">err</span>&nbsp;<span class="op" id="7168332">!=</span>&nbsp;<span class="builtintype" id="7168335">nil</span>&nbsp;<span class="op" id="7168339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168343">return</span>&nbsp;<span class="builtintype" id="7168350">nil</span><span class="op" id="7168353">,</span>&nbsp;<span class="ident" id="7168355">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168360">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7168364">db</span>&nbsp;<span class="op" id="7168367">:=</span>&nbsp;<span class="ident" id="7168370">s</span><span class="op" id="7168371">.</span><span class="ident" id="7168372">c</span><span class="op" id="7168373">.</span><span class="ident" id="7168374">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168378">switch</span>&nbsp;<span class="ident" id="7168385">s</span><span class="op" id="7168386">.</span><span class="ident" id="7168387">cmd</span>&nbsp;<span class="op" id="7168391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168394">case</span>&nbsp;<span class="string" id="7168399">&#34;WIPE&#34;</span><span class="op" id="7168405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7168409">db</span><span class="op" id="7168411">.</span><span class="ident" id="7168412">wipe</span><span class="op" id="7168416">(</span><span class="op" id="7168417">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168421">return</span>&nbsp;<span class="ident" id="7168428">driver</span><span class="op" id="7168434">.</span><span class="ident" id="7168435">ResultNoRows</span><span class="op" id="7168447">,</span>&nbsp;<span class="builtintype" id="7168449">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168454">case</span>&nbsp;<span class="string" id="7168459">&#34;CREATE&#34;</span><span class="op" id="7168467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168471">if</span>&nbsp;<span class="ident" id="7168474">err</span>&nbsp;<span class="op" id="7168478">:=</span>&nbsp;<span class="ident" id="7168481">db</span><span class="op" id="7168483">.</span><span class="ident" id="7168484">createTable</span><span class="op" id="7168495">(</span><span class="ident" id="7168496">s</span><span class="op" id="7168497">.</span><span class="ident" id="7168498">table</span><span class="op" id="7168503">,</span>&nbsp;<span class="ident" id="7168505">s</span><span class="op" id="7168506">.</span><span class="ident" id="7168507">colName</span><span class="op" id="7168514">,</span>&nbsp;<span class="ident" id="7168516">s</span><span class="op" id="7168517">.</span><span class="ident" id="7168518">colType</span><span class="op" id="7168525">)</span><span class="op" id="7168526">;</span>&nbsp;<span class="ident" id="7168528">err</span>&nbsp;<span class="op" id="7168532">!=</span>&nbsp;<span class="builtintype" id="7168535">nil</span>&nbsp;<span class="op" id="7168539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168544">return</span>&nbsp;<span class="builtintype" id="7168551">nil</span><span class="op" id="7168554">,</span>&nbsp;<span class="ident" id="7168556">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168562">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168566">return</span>&nbsp;<span class="ident" id="7168573">driver</span><span class="op" id="7168579">.</span><span class="ident" id="7168580">ResultNoRows</span><span class="op" id="7168592">,</span>&nbsp;<span class="builtintype" id="7168594">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168599">case</span>&nbsp;<span class="string" id="7168604">&#34;INSERT&#34;</span><span class="op" id="7168612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168616">return</span>&nbsp;<span class="ident" id="7168623">s</span><span class="op" id="7168624">.</span><span class="ident" id="7168625">execInsert</span><span class="op" id="7168635">(</span><span class="ident" id="7168636">args</span><span class="op" id="7168640">,</span>&nbsp;<span class="builtintype" id="7168642">true</span><span class="op" id="7168646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168649">case</span>&nbsp;<span class="string" id="7168654">&#34;NOSERT&#34;</span><span class="op" id="7168662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7168666">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7168746">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168790">return</span>&nbsp;<span class="ident" id="7168797">s</span><span class="op" id="7168798">.</span><span class="ident" id="7168799">execInsert</span><span class="op" id="7168809">(</span><span class="ident" id="7168810">args</span><span class="op" id="7168814">,</span>&nbsp;<span class="builtintype" id="7168816">false</span><span class="op" id="7168821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7168827">fmt</span><span class="op" id="7168830">.</span><span class="ident" id="7168831">Printf</span><span class="op" id="7168837">(</span><span class="string" id="7168838">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7168869">,</span>&nbsp;<span class="ident" id="7168871">s</span><span class="op" id="7168872">.</span><span class="ident" id="7168873">cmd</span><span class="op" id="7168876">,</span>&nbsp;<span class="ident" id="7168878">s</span><span class="op" id="7168879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7168882">return</span>&nbsp;<span class="builtintype" id="7168889">nil</span><span class="op" id="7168892">,</span>&nbsp;<span class="ident" id="7168894">fmt</span><span class="op" id="7168897">.</span><span class="ident" id="7168898">Errorf</span><span class="op" id="7168904">(</span><span class="string" id="7168905">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7168954">,</span>&nbsp;<span class="ident" id="7168956">s</span><span class="op" id="7168957">.</span><span class="ident" id="7168958">cmd</span><span class="op" id="7168961">)</span><br>
<span class="lineno">560</span><span class="op" id="7168963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7168966">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7169018">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7169087">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7169125">func</span>&nbsp;<span class="op" id="7169130">(</span><span class="ident" id="7169131">s</span>&nbsp;<span class="op" id="7169133">*</span><span class="ident" id="7169134">fakeStmt</span><span class="op" id="7169142">)</span>&nbsp;<span class="ident" id="7169144">execInsert</span><span class="op" id="7169154">(</span><span class="ident" id="7169155">args</span>&nbsp;<span class="op" id="7169160">[</span><span class="op" id="7169161">]</span><span class="ident" id="7169162">driver</span><span class="op" id="7169168">.</span><span class="ident" id="7169169">Value</span><span class="op" id="7169174">,</span>&nbsp;<span class="ident" id="7169176">doInsert</span>&nbsp;<span class="builtintype" id="7169185">bool</span><span class="op" id="7169189">)</span>&nbsp;<span class="op" id="7169191">(</span><span class="ident" id="7169192">driver</span><span class="op" id="7169198">.</span><span class="ident" id="7169199">Result</span><span class="op" id="7169205">,</span>&nbsp;<span class="builtintype" id="7169207">error</span><span class="op" id="7169212">)</span>&nbsp;<span class="op" id="7169214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169217">db</span>&nbsp;<span class="op" id="7169220">:=</span>&nbsp;<span class="ident" id="7169223">s</span><span class="op" id="7169224">.</span><span class="ident" id="7169225">c</span><span class="op" id="7169226">.</span><span class="ident" id="7169227">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169231">if</span>&nbsp;<span class="builtinfunc" id="7169234">len</span><span class="op" id="7169237">(</span><span class="ident" id="7169238">args</span><span class="op" id="7169242">)</span>&nbsp;<span class="op" id="7169244">!=</span>&nbsp;<span class="ident" id="7169247">s</span><span class="op" id="7169248">.</span><span class="ident" id="7169249">placeholders</span>&nbsp;<span class="op" id="7169262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7169266">panic</span><span class="op" id="7169271">(</span><span class="string" id="7169272">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7169330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169333">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169336">db</span><span class="op" id="7169338">.</span><span class="ident" id="7169339">mu</span><span class="op" id="7169341">.</span><span class="ident" id="7169342">Lock</span><span class="op" id="7169346">(</span><span class="op" id="7169347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169350">t</span><span class="op" id="7169351">,</span>&nbsp;<span class="ident" id="7169353">ok</span>&nbsp;<span class="op" id="7169356">:=</span>&nbsp;<span class="ident" id="7169359">db</span><span class="op" id="7169361">.</span><span class="ident" id="7169362">table</span><span class="op" id="7169367">(</span><span class="ident" id="7169368">s</span><span class="op" id="7169369">.</span><span class="ident" id="7169370">table</span><span class="op" id="7169375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169378">db</span><span class="op" id="7169380">.</span><span class="ident" id="7169381">mu</span><span class="op" id="7169383">.</span><span class="ident" id="7169384">Unlock</span><span class="op" id="7169390">(</span><span class="op" id="7169391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169394">if</span>&nbsp;<span class="op" id="7169397">!</span><span class="ident" id="7169398">ok</span>&nbsp;<span class="op" id="7169401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169405">return</span>&nbsp;<span class="builtintype" id="7169412">nil</span><span class="op" id="7169415">,</span>&nbsp;<span class="ident" id="7169417">fmt</span><span class="op" id="7169420">.</span><span class="ident" id="7169421">Errorf</span><span class="op" id="7169427">(</span><span class="string" id="7169428">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7169460">,</span>&nbsp;<span class="ident" id="7169462">s</span><span class="op" id="7169463">.</span><span class="ident" id="7169464">table</span><span class="op" id="7169469">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169476">t</span><span class="op" id="7169477">.</span><span class="ident" id="7169478">mu</span><span class="op" id="7169480">.</span><span class="ident" id="7169481">Lock</span><span class="op" id="7169485">(</span><span class="op" id="7169486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169489">defer</span>&nbsp;<span class="ident" id="7169495">t</span><span class="op" id="7169496">.</span><span class="ident" id="7169497">mu</span><span class="op" id="7169499">.</span><span class="ident" id="7169500">Unlock</span><span class="op" id="7169506">(</span><span class="op" id="7169507">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169511">var</span>&nbsp;<span class="ident" id="7169515">cols</span>&nbsp;<span class="op" id="7169520">[</span><span class="op" id="7169521">]</span><span class="keyword" id="7169522">interface</span><span class="op" id="7169531">{</span><span class="op" id="7169532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169535">if</span>&nbsp;<span class="ident" id="7169538">doInsert</span>&nbsp;<span class="op" id="7169547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169551">cols</span>&nbsp;<span class="op" id="7169556">=</span>&nbsp;<span class="builtinfunc" id="7169558">make</span><span class="op" id="7169562">(</span><span class="op" id="7169563">[</span><span class="op" id="7169564">]</span><span class="keyword" id="7169565">interface</span><span class="op" id="7169574">{</span><span class="op" id="7169575">}</span><span class="op" id="7169576">,</span>&nbsp;<span class="builtinfunc" id="7169578">len</span><span class="op" id="7169581">(</span><span class="ident" id="7169582">t</span><span class="op" id="7169583">.</span><span class="ident" id="7169584">colname</span><span class="op" id="7169591">)</span><span class="op" id="7169592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169598">argPos</span>&nbsp;<span class="op" id="7169605">:=</span>&nbsp;<span class="num" id="7169608">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169611">for</span>&nbsp;<span class="ident" id="7169615">n</span><span class="op" id="7169616">,</span>&nbsp;<span class="ident" id="7169618">colname</span>&nbsp;<span class="op" id="7169626">:=</span>&nbsp;<span class="keyword" id="7169629">range</span>&nbsp;<span class="ident" id="7169635">s</span><span class="op" id="7169636">.</span><span class="ident" id="7169637">colName</span>&nbsp;<span class="op" id="7169645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169649">colidx</span>&nbsp;<span class="op" id="7169656">:=</span>&nbsp;<span class="ident" id="7169659">t</span><span class="op" id="7169660">.</span><span class="ident" id="7169661">columnIndex</span><span class="op" id="7169672">(</span><span class="ident" id="7169673">colname</span><span class="op" id="7169680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169684">if</span>&nbsp;<span class="ident" id="7169687">colidx</span>&nbsp;<span class="op" id="7169694">==</span>&nbsp;<span class="op" id="7169697">-</span><span class="num" id="7169698">1</span>&nbsp;<span class="op" id="7169700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169705">return</span>&nbsp;<span class="builtintype" id="7169712">nil</span><span class="op" id="7169715">,</span>&nbsp;<span class="ident" id="7169717">fmt</span><span class="op" id="7169720">.</span><span class="ident" id="7169721">Errorf</span><span class="op" id="7169727">(</span><span class="string" id="7169728">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7169809">,</span>&nbsp;<span class="ident" id="7169811">colname</span><span class="op" id="7169818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169822">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169826">var</span>&nbsp;<span class="ident" id="7169830">val</span>&nbsp;<span class="keyword" id="7169834">interface</span><span class="op" id="7169843">{</span><span class="op" id="7169844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169848">if</span>&nbsp;<span class="ident" id="7169851">strvalue</span><span class="op" id="7169859">,</span>&nbsp;<span class="ident" id="7169861">ok</span>&nbsp;<span class="op" id="7169864">:=</span>&nbsp;<span class="ident" id="7169867">s</span><span class="op" id="7169868">.</span><span class="ident" id="7169869">colValue</span><span class="op" id="7169877">[</span><span class="ident" id="7169878">n</span><span class="op" id="7169879">]</span><span class="op" id="7169880">.</span><span class="op" id="7169881">(</span><span class="builtintype" id="7169882">string</span><span class="op" id="7169888">)</span><span class="op" id="7169889">;</span>&nbsp;<span class="ident" id="7169891">ok</span>&nbsp;<span class="op" id="7169894">&amp;&amp;</span>&nbsp;<span class="ident" id="7169897">strvalue</span>&nbsp;<span class="op" id="7169906">==</span>&nbsp;<span class="string" id="7169909">&#34;?&#34;</span>&nbsp;<span class="op" id="7169913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169918">val</span>&nbsp;<span class="op" id="7169922">=</span>&nbsp;<span class="ident" id="7169924">args</span><span class="op" id="7169928">[</span><span class="ident" id="7169929">argPos</span><span class="op" id="7169935">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169940">argPos</span><span class="op" id="7169946">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169951">}</span>&nbsp;<span class="keyword" id="7169953">else</span>&nbsp;<span class="op" id="7169958">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7169963">val</span>&nbsp;<span class="op" id="7169967">=</span>&nbsp;<span class="ident" id="7169969">s</span><span class="op" id="7169970">.</span><span class="ident" id="7169971">colValue</span><span class="op" id="7169979">[</span><span class="ident" id="7169980">n</span><span class="op" id="7169981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7169985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7169989">if</span>&nbsp;<span class="ident" id="7169992">doInsert</span>&nbsp;<span class="op" id="7170001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170006">cols</span><span class="op" id="7170010">[</span><span class="ident" id="7170011">colidx</span><span class="op" id="7170017">]</span>&nbsp;<span class="op" id="7170019">=</span>&nbsp;<span class="ident" id="7170021">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170027">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170034">if</span>&nbsp;<span class="ident" id="7170037">doInsert</span>&nbsp;<span class="op" id="7170046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170050">t</span><span class="op" id="7170051">.</span><span class="ident" id="7170052">rows</span>&nbsp;<span class="op" id="7170057">=</span>&nbsp;<span class="builtinfunc" id="7170059">append</span><span class="op" id="7170065">(</span><span class="ident" id="7170066">t</span><span class="op" id="7170067">.</span><span class="ident" id="7170068">rows</span><span class="op" id="7170072">,</span>&nbsp;<span class="op" id="7170074">&amp;</span><span class="ident" id="7170075">row</span><span class="op" id="7170078">{</span><span class="ident" id="7170079">cols</span><span class="op" id="7170083">:</span>&nbsp;<span class="ident" id="7170085">cols</span><span class="op" id="7170089">}</span><span class="op" id="7170090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170093">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170096">return</span>&nbsp;<span class="ident" id="7170103">driver</span><span class="op" id="7170109">.</span><span class="ident" id="7170110">RowsAffected</span><span class="op" id="7170122">(</span><span class="num" id="7170123">1</span><span class="op" id="7170124">)</span><span class="op" id="7170125">,</span>&nbsp;<span class="builtintype" id="7170127">nil</span><br>
<span class="lineno"></span><span class="op" id="7170131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7170134">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7170173">var</span>&nbsp;<span class="ident" id="7170177">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7170194">func</span><span class="op" id="7170198">(</span><span class="op" id="7170199">)</span>&nbsp;<span class="builtintype" id="7170201">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7170207">func</span>&nbsp;<span class="op" id="7170212">(</span><span class="ident" id="7170213">s</span>&nbsp;<span class="op" id="7170215">*</span><span class="ident" id="7170216">fakeStmt</span><span class="op" id="7170224">)</span>&nbsp;<span class="ident" id="7170226">Query</span><span class="op" id="7170231">(</span><span class="ident" id="7170232">args</span>&nbsp;<span class="op" id="7170237">[</span><span class="op" id="7170238">]</span><span class="ident" id="7170239">driver</span><span class="op" id="7170245">.</span><span class="ident" id="7170246">Value</span><span class="op" id="7170251">)</span>&nbsp;<span class="op" id="7170253">(</span><span class="ident" id="7170254">driver</span><span class="op" id="7170260">.</span><span class="ident" id="7170261">Rows</span><span class="op" id="7170265">,</span>&nbsp;<span class="builtintype" id="7170267">error</span><span class="op" id="7170272">)</span>&nbsp;<span class="op" id="7170274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170277">if</span>&nbsp;<span class="ident" id="7170280">s</span><span class="op" id="7170281">.</span><span class="ident" id="7170282">closed</span>&nbsp;<span class="op" id="7170289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170293">return</span>&nbsp;<span class="builtintype" id="7170300">nil</span><span class="op" id="7170303">,</span>&nbsp;<span class="ident" id="7170305">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170316">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170320">if</span>&nbsp;<span class="ident" id="7170323">hookQueryBadConn</span>&nbsp;<span class="op" id="7170340">!=</span>&nbsp;<span class="builtintype" id="7170343">nil</span>&nbsp;<span class="op" id="7170347">&amp;&amp;</span>&nbsp;<span class="ident" id="7170350">hookQueryBadConn</span><span class="op" id="7170366">(</span><span class="op" id="7170367">)</span>&nbsp;<span class="op" id="7170369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170373">return</span>&nbsp;<span class="builtintype" id="7170380">nil</span><span class="op" id="7170383">,</span>&nbsp;<span class="ident" id="7170385">driver</span><span class="op" id="7170391">.</span><span class="ident" id="7170392">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170408">err</span>&nbsp;<span class="op" id="7170412">:=</span>&nbsp;<span class="ident" id="7170415">checkSubsetTypes</span><span class="op" id="7170431">(</span><span class="ident" id="7170432">args</span><span class="op" id="7170436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170439">if</span>&nbsp;<span class="ident" id="7170442">err</span>&nbsp;<span class="op" id="7170446">!=</span>&nbsp;<span class="builtintype" id="7170449">nil</span>&nbsp;<span class="op" id="7170453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170457">return</span>&nbsp;<span class="builtintype" id="7170464">nil</span><span class="op" id="7170467">,</span>&nbsp;<span class="ident" id="7170469">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170478">db</span>&nbsp;<span class="op" id="7170481">:=</span>&nbsp;<span class="ident" id="7170484">s</span><span class="op" id="7170485">.</span><span class="ident" id="7170486">c</span><span class="op" id="7170487">.</span><span class="ident" id="7170488">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170492">if</span>&nbsp;<span class="builtinfunc" id="7170495">len</span><span class="op" id="7170498">(</span><span class="ident" id="7170499">args</span><span class="op" id="7170503">)</span>&nbsp;<span class="op" id="7170505">!=</span>&nbsp;<span class="ident" id="7170508">s</span><span class="op" id="7170509">.</span><span class="ident" id="7170510">placeholders</span>&nbsp;<span class="op" id="7170523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7170527">panic</span><span class="op" id="7170532">(</span><span class="string" id="7170533">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7170591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170598">db</span><span class="op" id="7170600">.</span><span class="ident" id="7170601">mu</span><span class="op" id="7170603">.</span><span class="ident" id="7170604">Lock</span><span class="op" id="7170608">(</span><span class="op" id="7170609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170612">t</span><span class="op" id="7170613">,</span>&nbsp;<span class="ident" id="7170615">ok</span>&nbsp;<span class="op" id="7170618">:=</span>&nbsp;<span class="ident" id="7170621">db</span><span class="op" id="7170623">.</span><span class="ident" id="7170624">table</span><span class="op" id="7170629">(</span><span class="ident" id="7170630">s</span><span class="op" id="7170631">.</span><span class="ident" id="7170632">table</span><span class="op" id="7170637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170640">db</span><span class="op" id="7170642">.</span><span class="ident" id="7170643">mu</span><span class="op" id="7170645">.</span><span class="ident" id="7170646">Unlock</span><span class="op" id="7170652">(</span><span class="op" id="7170653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170656">if</span>&nbsp;<span class="op" id="7170659">!</span><span class="ident" id="7170660">ok</span>&nbsp;<span class="op" id="7170663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170667">return</span>&nbsp;<span class="builtintype" id="7170674">nil</span><span class="op" id="7170677">,</span>&nbsp;<span class="ident" id="7170679">fmt</span><span class="op" id="7170682">.</span><span class="ident" id="7170683">Errorf</span><span class="op" id="7170689">(</span><span class="string" id="7170690">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7170722">,</span>&nbsp;<span class="ident" id="7170724">s</span><span class="op" id="7170725">.</span><span class="ident" id="7170726">table</span><span class="op" id="7170731">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170738">if</span>&nbsp;<span class="ident" id="7170741">s</span><span class="op" id="7170742">.</span><span class="ident" id="7170743">table</span>&nbsp;<span class="op" id="7170749">==</span>&nbsp;<span class="string" id="7170752">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7170765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170769">if</span>&nbsp;<span class="builtinfunc" id="7170772">len</span><span class="op" id="7170775">(</span><span class="ident" id="7170776">s</span><span class="op" id="7170777">.</span><span class="ident" id="7170778">whereCol</span><span class="op" id="7170786">)</span>&nbsp;<span class="op" id="7170788">==</span>&nbsp;<span class="num" id="7170791">2</span>&nbsp;<span class="op" id="7170793">&amp;&amp;</span>&nbsp;<span class="ident" id="7170796">s</span><span class="op" id="7170797">.</span><span class="ident" id="7170798">whereCol</span><span class="op" id="7170806">[</span><span class="num" id="7170807">0</span><span class="op" id="7170808">]</span>&nbsp;<span class="op" id="7170810">==</span>&nbsp;<span class="string" id="7170813">&#34;op&#34;</span>&nbsp;<span class="op" id="7170818">&amp;&amp;</span>&nbsp;<span class="ident" id="7170821">s</span><span class="op" id="7170822">.</span><span class="ident" id="7170823">whereCol</span><span class="op" id="7170831">[</span><span class="num" id="7170832">1</span><span class="op" id="7170833">]</span>&nbsp;<span class="op" id="7170835">==</span>&nbsp;<span class="string" id="7170838">&#34;millis&#34;</span>&nbsp;<span class="op" id="7170847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170852">if</span>&nbsp;<span class="ident" id="7170855">args</span><span class="op" id="7170859">[</span><span class="num" id="7170860">0</span><span class="op" id="7170861">]</span>&nbsp;<span class="op" id="7170863">==</span>&nbsp;<span class="string" id="7170866">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7170874">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170880">time</span><span class="op" id="7170884">.</span><span class="ident" id="7170885">Sleep</span><span class="op" id="7170890">(</span><span class="ident" id="7170891">time</span><span class="op" id="7170895">.</span><span class="ident" id="7170896">Duration</span><span class="op" id="7170904">(</span><span class="ident" id="7170905">args</span><span class="op" id="7170909">[</span><span class="num" id="7170910">1</span><span class="op" id="7170911">]</span><span class="op" id="7170912">.</span><span class="op" id="7170913">(</span><span class="ident" id="7170914">int64</span><span class="op" id="7170919">)</span><span class="op" id="7170920">)</span>&nbsp;<span class="op" id="7170922">*</span>&nbsp;<span class="ident" id="7170924">time</span><span class="op" id="7170928">.</span><span class="ident" id="7170929">Millisecond</span><span class="op" id="7170940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7170952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170956">t</span><span class="op" id="7170957">.</span><span class="ident" id="7170958">mu</span><span class="op" id="7170960">.</span><span class="ident" id="7170961">Lock</span><span class="op" id="7170965">(</span><span class="op" id="7170966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7170969">defer</span>&nbsp;<span class="ident" id="7170975">t</span><span class="op" id="7170976">.</span><span class="ident" id="7170977">mu</span><span class="op" id="7170979">.</span><span class="ident" id="7170980">Unlock</span><span class="op" id="7170986">(</span><span class="op" id="7170987">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7170991">colIdx</span>&nbsp;<span class="op" id="7170998">:=</span>&nbsp;<span class="builtinfunc" id="7171001">make</span><span class="op" id="7171005">(</span><span class="keyword" id="7171006">map</span><span class="op" id="7171009">[</span><span class="builtintype" id="7171010">string</span><span class="op" id="7171016">]</span><span class="builtintype" id="7171017">int</span><span class="op" id="7171020">)</span>&nbsp;<span class="comment" id="7171022">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171070">for</span>&nbsp;<span class="ident" id="7171074">_</span><span class="op" id="7171075">,</span>&nbsp;<span class="ident" id="7171077">name</span>&nbsp;<span class="op" id="7171082">:=</span>&nbsp;<span class="keyword" id="7171085">range</span>&nbsp;<span class="ident" id="7171091">s</span><span class="op" id="7171092">.</span><span class="ident" id="7171093">colName</span>&nbsp;<span class="op" id="7171101">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171105">idx</span>&nbsp;<span class="op" id="7171109">:=</span>&nbsp;<span class="ident" id="7171112">t</span><span class="op" id="7171113">.</span><span class="ident" id="7171114">columnIndex</span><span class="op" id="7171125">(</span><span class="ident" id="7171126">name</span><span class="op" id="7171130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171134">if</span>&nbsp;<span class="ident" id="7171137">idx</span>&nbsp;<span class="op" id="7171141">==</span>&nbsp;<span class="op" id="7171144">-</span><span class="num" id="7171145">1</span>&nbsp;<span class="op" id="7171147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171152">return</span>&nbsp;<span class="builtintype" id="7171159">nil</span><span class="op" id="7171162">,</span>&nbsp;<span class="ident" id="7171164">fmt</span><span class="op" id="7171167">.</span><span class="ident" id="7171168">Errorf</span><span class="op" id="7171174">(</span><span class="string" id="7171175">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7171207">,</span>&nbsp;<span class="ident" id="7171209">name</span><span class="op" id="7171213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171221">colIdx</span><span class="op" id="7171227">[</span><span class="ident" id="7171228">name</span><span class="op" id="7171232">]</span>&nbsp;<span class="op" id="7171234">=</span>&nbsp;<span class="ident" id="7171236">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171245">mrows</span>&nbsp;<span class="op" id="7171251">:=</span>&nbsp;<span class="op" id="7171254">[</span><span class="op" id="7171255">]</span><span class="op" id="7171256">*</span><span class="ident" id="7171257">row</span><span class="op" id="7171260">{</span><span class="op" id="7171261">}</span><br>
<span class="lineno"></span><span class="ident" id="7171263">rows</span><span class="op" id="7171267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171270">for</span>&nbsp;<span class="ident" id="7171274">_</span><span class="op" id="7171275">,</span>&nbsp;<span class="ident" id="7171277">trow</span>&nbsp;<span class="op" id="7171282">:=</span>&nbsp;<span class="keyword" id="7171285">range</span>&nbsp;<span class="ident" id="7171291">t</span><span class="op" id="7171292">.</span><span class="ident" id="7171293">rows</span>&nbsp;<span class="op" id="7171298">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7171302">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7171371">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7171439">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171459">for</span>&nbsp;<span class="ident" id="7171463">widx</span><span class="op" id="7171467">,</span>&nbsp;<span class="ident" id="7171469">wcol</span>&nbsp;<span class="op" id="7171474">:=</span>&nbsp;<span class="keyword" id="7171477">range</span>&nbsp;<span class="ident" id="7171483">s</span><span class="op" id="7171484">.</span><span class="ident" id="7171485">whereCol</span>&nbsp;<span class="op" id="7171494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171499">idx</span>&nbsp;<span class="op" id="7171503">:=</span>&nbsp;<span class="ident" id="7171506">t</span><span class="op" id="7171507">.</span><span class="ident" id="7171508">columnIndex</span><span class="op" id="7171519">(</span><span class="ident" id="7171520">wcol</span><span class="op" id="7171524">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171529">if</span>&nbsp;<span class="ident" id="7171532">idx</span>&nbsp;<span class="op" id="7171536">==</span>&nbsp;<span class="op" id="7171539">-</span><span class="num" id="7171540">1</span>&nbsp;<span class="op" id="7171542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171548">return</span>&nbsp;<span class="builtintype" id="7171555">nil</span><span class="op" id="7171558">,</span>&nbsp;<span class="ident" id="7171560">fmt</span><span class="op" id="7171563">.</span><span class="ident" id="7171564">Errorf</span><span class="op" id="7171570">(</span><span class="string" id="7171571">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7171607">,</span>&nbsp;<span class="ident" id="7171609">wcol</span><span class="op" id="7171613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171623">tcol</span>&nbsp;<span class="op" id="7171628">:=</span>&nbsp;<span class="ident" id="7171631">trow</span><span class="op" id="7171635">.</span><span class="ident" id="7171636">cols</span><span class="op" id="7171640">[</span><span class="ident" id="7171641">idx</span><span class="op" id="7171644">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171649">if</span>&nbsp;<span class="ident" id="7171652">bs</span><span class="op" id="7171654">,</span>&nbsp;<span class="ident" id="7171656">ok</span>&nbsp;<span class="op" id="7171659">:=</span>&nbsp;<span class="ident" id="7171662">tcol</span><span class="op" id="7171666">.</span><span class="op" id="7171667">(</span><span class="op" id="7171668">[</span><span class="op" id="7171669">]</span><span class="builtintype" id="7171670">byte</span><span class="op" id="7171674">)</span><span class="op" id="7171675">;</span>&nbsp;<span class="ident" id="7171677">ok</span>&nbsp;<span class="op" id="7171680">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7171686">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171735">tcol</span>&nbsp;<span class="op" id="7171740">=</span>&nbsp;<span class="builtintype" id="7171742">string</span><span class="op" id="7171748">(</span><span class="ident" id="7171749">bs</span><span class="op" id="7171751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171761">if</span>&nbsp;<span class="ident" id="7171764">fmt</span><span class="op" id="7171767">.</span><span class="ident" id="7171768">Sprintf</span><span class="op" id="7171775">(</span><span class="string" id="7171776">&#34;%v&#34;</span><span class="op" id="7171780">,</span>&nbsp;<span class="ident" id="7171782">tcol</span><span class="op" id="7171786">)</span>&nbsp;<span class="op" id="7171788">!=</span>&nbsp;<span class="ident" id="7171791">fmt</span><span class="op" id="7171794">.</span><span class="ident" id="7171795">Sprintf</span><span class="op" id="7171802">(</span><span class="string" id="7171803">&#34;%v&#34;</span><span class="op" id="7171807">,</span>&nbsp;<span class="ident" id="7171809">args</span><span class="op" id="7171813">[</span><span class="ident" id="7171814">widx</span><span class="op" id="7171818">]</span><span class="op" id="7171819">)</span>&nbsp;<span class="op" id="7171821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171827">continue</span>&nbsp;<span class="ident" id="7171836">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171852">mrow</span>&nbsp;<span class="op" id="7171857">:=</span>&nbsp;<span class="op" id="7171860">&amp;</span><span class="ident" id="7171861">row</span><span class="op" id="7171864">{</span><span class="ident" id="7171865">cols</span><span class="op" id="7171869">:</span>&nbsp;<span class="builtinfunc" id="7171871">make</span><span class="op" id="7171875">(</span><span class="op" id="7171876">[</span><span class="op" id="7171877">]</span><span class="keyword" id="7171878">interface</span><span class="op" id="7171887">{</span><span class="op" id="7171888">}</span><span class="op" id="7171889">,</span>&nbsp;<span class="builtinfunc" id="7171891">len</span><span class="op" id="7171894">(</span><span class="ident" id="7171895">s</span><span class="op" id="7171896">.</span><span class="ident" id="7171897">colName</span><span class="op" id="7171904">)</span><span class="op" id="7171905">)</span><span class="op" id="7171906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7171910">for</span>&nbsp;<span class="ident" id="7171914">seli</span><span class="op" id="7171918">,</span>&nbsp;<span class="ident" id="7171920">name</span>&nbsp;<span class="op" id="7171925">:=</span>&nbsp;<span class="keyword" id="7171928">range</span>&nbsp;<span class="ident" id="7171934">s</span><span class="op" id="7171935">.</span><span class="ident" id="7171936">colName</span>&nbsp;<span class="op" id="7171944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171949">mrow</span><span class="op" id="7171953">.</span><span class="ident" id="7171954">cols</span><span class="op" id="7171958">[</span><span class="ident" id="7171959">seli</span><span class="op" id="7171963">]</span>&nbsp;<span class="op" id="7171965">=</span>&nbsp;<span class="ident" id="7171967">trow</span><span class="op" id="7171971">.</span><span class="ident" id="7171972">cols</span><span class="op" id="7171976">[</span><span class="ident" id="7171977">colIdx</span><span class="op" id="7171983">[</span><span class="ident" id="7171984">name</span><span class="op" id="7171988">]</span><span class="op" id="7171989">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7171993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7171997">mrows</span>&nbsp;<span class="op" id="7172003">=</span>&nbsp;<span class="builtinfunc" id="7172005">append</span><span class="op" id="7172011">(</span><span class="ident" id="7172012">mrows</span><span class="op" id="7172017">,</span>&nbsp;<span class="ident" id="7172019">mrow</span><span class="op" id="7172023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7172026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172030">cursor</span>&nbsp;<span class="op" id="7172037">:=</span>&nbsp;<span class="op" id="7172040">&amp;</span><span class="ident" id="7172041">rowsCursor</span><span class="op" id="7172051">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172055">pos</span><span class="op" id="7172058">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7172063">-</span><span class="num" id="7172064">1</span><span class="op" id="7172065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172069">rows</span><span class="op" id="7172073">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7172077">mrows</span><span class="op" id="7172082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172086">cols</span><span class="op" id="7172090">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7172094">s</span><span class="op" id="7172095">.</span><span class="ident" id="7172096">colName</span><span class="op" id="7172103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172107">errPos</span><span class="op" id="7172113">:</span>&nbsp;<span class="op" id="7172115">-</span><span class="num" id="7172116">1</span><span class="op" id="7172117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7172120">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172123">return</span>&nbsp;<span class="ident" id="7172130">cursor</span><span class="op" id="7172136">,</span>&nbsp;<span class="builtintype" id="7172138">nil</span><br>
<span class="lineno"></span><span class="op" id="7172142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172145">func</span>&nbsp;<span class="op" id="7172150">(</span><span class="ident" id="7172151">s</span>&nbsp;<span class="op" id="7172153">*</span><span class="ident" id="7172154">fakeStmt</span><span class="op" id="7172162">)</span>&nbsp;<span class="ident" id="7172164">NumInput</span><span class="op" id="7172172">(</span><span class="op" id="7172173">)</span>&nbsp;<span class="builtintype" id="7172175">int</span>&nbsp;<span class="op" id="7172179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172182">return</span>&nbsp;<span class="ident" id="7172189">s</span><span class="op" id="7172190">.</span><span class="ident" id="7172191">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7172204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172207">func</span>&nbsp;<span class="op" id="7172212">(</span><span class="ident" id="7172213">tx</span>&nbsp;<span class="op" id="7172216">*</span><span class="ident" id="7172217">fakeTx</span><span class="op" id="7172223">)</span>&nbsp;<span class="ident" id="7172225">Commit</span><span class="op" id="7172231">(</span><span class="op" id="7172232">)</span>&nbsp;<span class="builtintype" id="7172234">error</span>&nbsp;<span class="op" id="7172240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172243">tx</span><span class="op" id="7172245">.</span><span class="ident" id="7172246">c</span><span class="op" id="7172247">.</span><span class="ident" id="7172248">currTx</span>&nbsp;<span class="op" id="7172255">=</span>&nbsp;<span class="builtintype" id="7172257">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172262">return</span>&nbsp;<span class="builtintype" id="7172269">nil</span><br>
<span class="lineno">700</span><span class="op" id="7172273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172276">func</span>&nbsp;<span class="op" id="7172281">(</span><span class="ident" id="7172282">tx</span>&nbsp;<span class="op" id="7172285">*</span><span class="ident" id="7172286">fakeTx</span><span class="op" id="7172292">)</span>&nbsp;<span class="ident" id="7172294">Rollback</span><span class="op" id="7172302">(</span><span class="op" id="7172303">)</span>&nbsp;<span class="builtintype" id="7172305">error</span>&nbsp;<span class="op" id="7172311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172314">tx</span><span class="op" id="7172316">.</span><span class="ident" id="7172317">c</span><span class="op" id="7172318">.</span><span class="ident" id="7172319">currTx</span>&nbsp;<span class="op" id="7172326">=</span>&nbsp;<span class="builtintype" id="7172328">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172333">return</span>&nbsp;<span class="builtintype" id="7172340">nil</span><br>
<span class="lineno">705</span><span class="op" id="7172344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172347">type</span>&nbsp;<span class="ident" id="7172352">rowsCursor</span>&nbsp;<span class="keyword" id="7172363">struct</span>&nbsp;<span class="op" id="7172370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172373">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7172380">[</span><span class="op" id="7172381">]</span><span class="builtintype" id="7172382">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172390">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7172397">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172402">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7172409">[</span><span class="op" id="7172410">]</span><span class="op" id="7172411">*</span><span class="ident" id="7172412">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172417">closed</span>&nbsp;<span class="builtintype" id="7172424">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7172431">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172495">errPos</span>&nbsp;<span class="builtintype" id="7172502">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172507">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7172514">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7172522">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7172583">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7172643">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172692">bytesClone</span>&nbsp;<span class="keyword" id="7172703">map</span><span class="op" id="7172706">[</span><span class="op" id="7172707">*</span><span class="builtintype" id="7172708">byte</span><span class="op" id="7172712">]</span><span class="op" id="7172713">[</span><span class="op" id="7172714">]</span><span class="builtintype" id="7172715">byte</span><br>
<span class="lineno"></span><span class="op" id="7172720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172723">func</span>&nbsp;<span class="op" id="7172728">(</span><span class="ident" id="7172729">rc</span>&nbsp;<span class="op" id="7172732">*</span><span class="ident" id="7172733">rowsCursor</span><span class="op" id="7172743">)</span>&nbsp;<span class="ident" id="7172745">Close</span><span class="op" id="7172750">(</span><span class="op" id="7172751">)</span>&nbsp;<span class="builtintype" id="7172753">error</span>&nbsp;<span class="op" id="7172759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172762">if</span>&nbsp;<span class="op" id="7172765">!</span><span class="ident" id="7172766">rc</span><span class="op" id="7172768">.</span><span class="ident" id="7172769">closed</span>&nbsp;<span class="op" id="7172776">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172780">for</span>&nbsp;<span class="ident" id="7172784">_</span><span class="op" id="7172785">,</span>&nbsp;<span class="ident" id="7172787">bs</span>&nbsp;<span class="op" id="7172790">:=</span>&nbsp;<span class="keyword" id="7172793">range</span>&nbsp;<span class="ident" id="7172799">rc</span><span class="op" id="7172801">.</span><span class="ident" id="7172802">bytesClone</span>&nbsp;<span class="op" id="7172813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172818">bs</span><span class="op" id="7172820">[</span><span class="num" id="7172821">0</span><span class="op" id="7172822">]</span>&nbsp;<span class="op" id="7172824">=</span>&nbsp;<span class="num" id="7172826">255</span>&nbsp;<span class="comment" id="7172830">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7172856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7172859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7172862">rc</span><span class="op" id="7172864">.</span><span class="ident" id="7172865">closed</span>&nbsp;<span class="op" id="7172872">=</span>&nbsp;<span class="builtintype" id="7172874">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172880">return</span>&nbsp;<span class="builtintype" id="7172887">nil</span><br>
<span class="lineno"></span><span class="op" id="7172891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172894">func</span>&nbsp;<span class="op" id="7172899">(</span><span class="ident" id="7172900">rc</span>&nbsp;<span class="op" id="7172903">*</span><span class="ident" id="7172904">rowsCursor</span><span class="op" id="7172914">)</span>&nbsp;<span class="ident" id="7172916">Columns</span><span class="op" id="7172923">(</span><span class="op" id="7172924">)</span>&nbsp;<span class="op" id="7172926">[</span><span class="op" id="7172927">]</span><span class="builtintype" id="7172928">string</span>&nbsp;<span class="op" id="7172935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7172938">return</span>&nbsp;<span class="ident" id="7172945">rc</span><span class="op" id="7172947">.</span><span class="ident" id="7172948">cols</span><br>
<span class="lineno">735</span><span class="op" id="7172953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172956">var</span>&nbsp;<span class="ident" id="7172960">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7172979">func</span><span class="op" id="7172983">(</span><span class="ident" id="7172984">dest</span>&nbsp;<span class="op" id="7172989">[</span><span class="op" id="7172990">]</span><span class="ident" id="7172991">driver</span><span class="op" id="7172997">.</span><span class="ident" id="7172998">Value</span><span class="op" id="7173003">)</span>&nbsp;<span class="builtintype" id="7173005">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7173012">func</span>&nbsp;<span class="op" id="7173017">(</span><span class="ident" id="7173018">rc</span>&nbsp;<span class="op" id="7173021">*</span><span class="ident" id="7173022">rowsCursor</span><span class="op" id="7173032">)</span>&nbsp;<span class="ident" id="7173034">Next</span><span class="op" id="7173038">(</span><span class="ident" id="7173039">dest</span>&nbsp;<span class="op" id="7173044">[</span><span class="op" id="7173045">]</span><span class="ident" id="7173046">driver</span><span class="op" id="7173052">.</span><span class="ident" id="7173053">Value</span><span class="op" id="7173058">)</span>&nbsp;<span class="builtintype" id="7173060">error</span>&nbsp;<span class="op" id="7173066">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173069">if</span>&nbsp;<span class="ident" id="7173072">rowsCursorNextHook</span>&nbsp;<span class="op" id="7173091">!=</span>&nbsp;<span class="builtintype" id="7173094">nil</span>&nbsp;<span class="op" id="7173098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173102">return</span>&nbsp;<span class="ident" id="7173109">rowsCursorNextHook</span><span class="op" id="7173127">(</span><span class="ident" id="7173128">dest</span><span class="op" id="7173132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173139">if</span>&nbsp;<span class="ident" id="7173142">rc</span><span class="op" id="7173144">.</span><span class="ident" id="7173145">closed</span>&nbsp;<span class="op" id="7173152">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173156">return</span>&nbsp;<span class="ident" id="7173163">errors</span><span class="op" id="7173169">.</span><span class="ident" id="7173170">New</span><span class="op" id="7173173">(</span><span class="string" id="7173174">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7173200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173206">rc</span><span class="op" id="7173208">.</span><span class="ident" id="7173209">pos</span><span class="op" id="7173212">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173216">if</span>&nbsp;<span class="ident" id="7173219">rc</span><span class="op" id="7173221">.</span><span class="ident" id="7173222">pos</span>&nbsp;<span class="op" id="7173226">==</span>&nbsp;<span class="ident" id="7173229">rc</span><span class="op" id="7173231">.</span><span class="ident" id="7173232">errPos</span>&nbsp;<span class="op" id="7173239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173243">return</span>&nbsp;<span class="ident" id="7173250">rc</span><span class="op" id="7173252">.</span><span class="ident" id="7173253">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173261">if</span>&nbsp;<span class="ident" id="7173264">rc</span><span class="op" id="7173266">.</span><span class="ident" id="7173267">pos</span>&nbsp;<span class="op" id="7173271">&gt;=</span>&nbsp;<span class="builtinfunc" id="7173274">len</span><span class="op" id="7173277">(</span><span class="ident" id="7173278">rc</span><span class="op" id="7173280">.</span><span class="ident" id="7173281">rows</span><span class="op" id="7173285">)</span>&nbsp;<span class="op" id="7173287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173291">return</span>&nbsp;<span class="ident" id="7173298">io</span><span class="op" id="7173300">.</span><span class="ident" id="7173301">EOF</span>&nbsp;<span class="comment" id="7173305">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173331">for</span>&nbsp;<span class="ident" id="7173335">i</span><span class="op" id="7173336">,</span>&nbsp;<span class="ident" id="7173338">v</span>&nbsp;<span class="op" id="7173340">:=</span>&nbsp;<span class="keyword" id="7173343">range</span>&nbsp;<span class="ident" id="7173349">rc</span><span class="op" id="7173351">.</span><span class="ident" id="7173352">rows</span><span class="op" id="7173356">[</span><span class="ident" id="7173357">rc</span><span class="op" id="7173359">.</span><span class="ident" id="7173360">pos</span><span class="op" id="7173363">]</span><span class="op" id="7173364">.</span><span class="ident" id="7173365">cols</span>&nbsp;<span class="op" id="7173370">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173374">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173428">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173480">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173538">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173593">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7173647">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173702">dest</span><span class="op" id="7173706">[</span><span class="ident" id="7173707">i</span><span class="op" id="7173708">]</span>&nbsp;<span class="op" id="7173710">=</span>&nbsp;<span class="ident" id="7173712">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173717">if</span>&nbsp;<span class="ident" id="7173720">bs</span><span class="op" id="7173722">,</span>&nbsp;<span class="ident" id="7173724">ok</span>&nbsp;<span class="op" id="7173727">:=</span>&nbsp;<span class="ident" id="7173730">v</span><span class="op" id="7173731">.</span><span class="op" id="7173732">(</span><span class="op" id="7173733">[</span><span class="op" id="7173734">]</span><span class="builtintype" id="7173735">byte</span><span class="op" id="7173739">)</span><span class="op" id="7173740">;</span>&nbsp;<span class="ident" id="7173742">ok</span>&nbsp;<span class="op" id="7173745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173750">if</span>&nbsp;<span class="ident" id="7173753">rc</span><span class="op" id="7173755">.</span><span class="ident" id="7173756">bytesClone</span>&nbsp;<span class="op" id="7173767">==</span>&nbsp;<span class="builtintype" id="7173770">nil</span>&nbsp;<span class="op" id="7173774">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173780">rc</span><span class="op" id="7173782">.</span><span class="ident" id="7173783">bytesClone</span>&nbsp;<span class="op" id="7173794">=</span>&nbsp;<span class="builtinfunc" id="7173796">make</span><span class="op" id="7173800">(</span><span class="keyword" id="7173801">map</span><span class="op" id="7173804">[</span><span class="op" id="7173805">*</span><span class="builtintype" id="7173806">byte</span><span class="op" id="7173810">]</span><span class="op" id="7173811">[</span><span class="op" id="7173812">]</span><span class="builtintype" id="7173813">byte</span><span class="op" id="7173817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173827">clone</span><span class="op" id="7173832">,</span>&nbsp;<span class="ident" id="7173834">ok</span>&nbsp;<span class="op" id="7173837">:=</span>&nbsp;<span class="ident" id="7173840">rc</span><span class="op" id="7173842">.</span><span class="ident" id="7173843">bytesClone</span><span class="op" id="7173853">[</span><span class="op" id="7173854">&amp;</span><span class="ident" id="7173855">bs</span><span class="op" id="7173857">[</span><span class="num" id="7173858">0</span><span class="op" id="7173859">]</span><span class="op" id="7173860">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173865">if</span>&nbsp;<span class="op" id="7173868">!</span><span class="ident" id="7173869">ok</span>&nbsp;<span class="op" id="7173872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173878">clone</span>&nbsp;<span class="op" id="7173884">=</span>&nbsp;<span class="builtinfunc" id="7173886">make</span><span class="op" id="7173890">(</span><span class="op" id="7173891">[</span><span class="op" id="7173892">]</span><span class="builtintype" id="7173893">byte</span><span class="op" id="7173897">,</span>&nbsp;<span class="builtinfunc" id="7173899">len</span><span class="op" id="7173902">(</span><span class="ident" id="7173903">bs</span><span class="op" id="7173905">)</span><span class="op" id="7173906">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7173912">copy</span><span class="op" id="7173916">(</span><span class="ident" id="7173917">clone</span><span class="op" id="7173922">,</span>&nbsp;<span class="ident" id="7173924">bs</span><span class="op" id="7173926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173932">rc</span><span class="op" id="7173934">.</span><span class="ident" id="7173935">bytesClone</span><span class="op" id="7173945">[</span><span class="op" id="7173946">&amp;</span><span class="ident" id="7173947">bs</span><span class="op" id="7173949">[</span><span class="num" id="7173950">0</span><span class="op" id="7173951">]</span><span class="op" id="7173952">]</span>&nbsp;<span class="op" id="7173954">=</span>&nbsp;<span class="ident" id="7173956">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7173970">dest</span><span class="op" id="7173974">[</span><span class="ident" id="7173975">i</span><span class="op" id="7173976">]</span>&nbsp;<span class="op" id="7173978">=</span>&nbsp;<span class="ident" id="7173980">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173988">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7173991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7173994">return</span>&nbsp;<span class="builtintype" id="7174001">nil</span><br>
<span class="lineno"></span><span class="op" id="7174005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7174008">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7174079">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7174105">//</span><br>
<span class="lineno"></span><span class="comment" id="7174108">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7174171">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7174236">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7174270">//</span><br>
<span class="lineno"></span><span class="keyword" id="7174273">type</span>&nbsp;<span class="ident" id="7174278">fakeDriverString</span>&nbsp;<span class="keyword" id="7174295">struct</span><span class="op" id="7174301">{</span><span class="op" id="7174302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7174305">func</span>&nbsp;<span class="op" id="7174310">(</span><span class="ident" id="7174311">fakeDriverString</span><span class="op" id="7174327">)</span>&nbsp;<span class="ident" id="7174329">ConvertValue</span><span class="op" id="7174341">(</span><span class="ident" id="7174342">v</span>&nbsp;<span class="keyword" id="7174344">interface</span><span class="op" id="7174353">{</span><span class="op" id="7174354">}</span><span class="op" id="7174355">)</span>&nbsp;<span class="op" id="7174357">(</span><span class="ident" id="7174358">driver</span><span class="op" id="7174364">.</span><span class="ident" id="7174365">Value</span><span class="op" id="7174370">,</span>&nbsp;<span class="builtintype" id="7174372">error</span><span class="op" id="7174377">)</span>&nbsp;<span class="op" id="7174379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174382">switch</span>&nbsp;<span class="ident" id="7174389">c</span>&nbsp;<span class="op" id="7174391">:=</span>&nbsp;<span class="ident" id="7174394">v</span><span class="op" id="7174395">.</span><span class="op" id="7174396">(</span><span class="keyword" id="7174397">type</span><span class="op" id="7174401">)</span>&nbsp;<span class="op" id="7174403">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174406">case</span>&nbsp;<span class="builtintype" id="7174411">string</span><span class="op" id="7174417">,</span>&nbsp;<span class="op" id="7174419">[</span><span class="op" id="7174420">]</span><span class="builtintype" id="7174421">byte</span><span class="op" id="7174425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174429">return</span>&nbsp;<span class="ident" id="7174436">v</span><span class="op" id="7174437">,</span>&nbsp;<span class="builtintype" id="7174439">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174444">case</span>&nbsp;<span class="op" id="7174449">*</span><span class="builtintype" id="7174450">string</span><span class="op" id="7174456">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174460">if</span>&nbsp;<span class="ident" id="7174463">c</span>&nbsp;<span class="op" id="7174465">==</span>&nbsp;<span class="builtintype" id="7174468">nil</span>&nbsp;<span class="op" id="7174472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174477">return</span>&nbsp;<span class="builtintype" id="7174484">nil</span><span class="op" id="7174487">,</span>&nbsp;<span class="builtintype" id="7174489">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7174495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174499">return</span>&nbsp;<span class="op" id="7174506">*</span><span class="ident" id="7174507">c</span><span class="op" id="7174508">,</span>&nbsp;<span class="builtintype" id="7174510">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7174515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174518">return</span>&nbsp;<span class="ident" id="7174525">fmt</span><span class="op" id="7174528">.</span><span class="ident" id="7174529">Sprintf</span><span class="op" id="7174536">(</span><span class="string" id="7174537">&#34;%v&#34;</span><span class="op" id="7174541">,</span>&nbsp;<span class="ident" id="7174543">v</span><span class="op" id="7174544">)</span><span class="op" id="7174545">,</span>&nbsp;<span class="builtintype" id="7174547">nil</span><br>
<span class="lineno"></span><span class="op" id="7174551">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7174554">func</span>&nbsp;<span class="ident" id="7174559">converterForType</span><span class="op" id="7174575">(</span><span class="ident" id="7174576">typ</span>&nbsp;<span class="builtintype" id="7174580">string</span><span class="op" id="7174586">)</span>&nbsp;<span class="ident" id="7174588">driver</span><span class="op" id="7174594">.</span><span class="ident" id="7174595">ValueConverter</span>&nbsp;<span class="op" id="7174610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174613">switch</span>&nbsp;<span class="ident" id="7174620">typ</span>&nbsp;<span class="op" id="7174624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174627">case</span>&nbsp;<span class="string" id="7174632">&#34;bool&#34;</span><span class="op" id="7174638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174642">return</span>&nbsp;<span class="ident" id="7174649">driver</span><span class="op" id="7174655">.</span><span class="ident" id="7174656">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174662">case</span>&nbsp;<span class="string" id="7174667">&#34;nullbool&#34;</span><span class="op" id="7174677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174681">return</span>&nbsp;<span class="ident" id="7174688">driver</span><span class="op" id="7174694">.</span><span class="ident" id="7174695">Null</span><span class="op" id="7174699">{</span><span class="ident" id="7174700">Converter</span><span class="op" id="7174709">:</span>&nbsp;<span class="ident" id="7174711">driver</span><span class="op" id="7174717">.</span><span class="ident" id="7174718">Bool</span><span class="op" id="7174722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174725">case</span>&nbsp;<span class="string" id="7174730">&#34;int32&#34;</span><span class="op" id="7174737">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174741">return</span>&nbsp;<span class="ident" id="7174748">driver</span><span class="op" id="7174754">.</span><span class="ident" id="7174755">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174762">case</span>&nbsp;<span class="string" id="7174767">&#34;string&#34;</span><span class="op" id="7174775">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174779">return</span>&nbsp;<span class="ident" id="7174786">driver</span><span class="op" id="7174792">.</span><span class="ident" id="7174793">NotNull</span><span class="op" id="7174800">{</span><span class="ident" id="7174801">Converter</span><span class="op" id="7174810">:</span>&nbsp;<span class="ident" id="7174812">fakeDriverString</span><span class="op" id="7174828">{</span><span class="op" id="7174829">}</span><span class="op" id="7174830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174833">case</span>&nbsp;<span class="string" id="7174838">&#34;nullstring&#34;</span><span class="op" id="7174850">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174854">return</span>&nbsp;<span class="ident" id="7174861">driver</span><span class="op" id="7174867">.</span><span class="ident" id="7174868">Null</span><span class="op" id="7174872">{</span><span class="ident" id="7174873">Converter</span><span class="op" id="7174882">:</span>&nbsp;<span class="ident" id="7174884">fakeDriverString</span><span class="op" id="7174900">{</span><span class="op" id="7174901">}</span><span class="op" id="7174902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174905">case</span>&nbsp;<span class="string" id="7174910">&#34;int64&#34;</span><span class="op" id="7174917">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7174921">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7174973">return</span>&nbsp;<span class="ident" id="7174980">driver</span><span class="op" id="7174986">.</span><span class="ident" id="7174987">NotNull</span><span class="op" id="7174994">{</span><span class="ident" id="7174995">Converter</span><span class="op" id="7175004">:</span>&nbsp;<span class="ident" id="7175006">driver</span><span class="op" id="7175012">.</span><span class="ident" id="7175013">DefaultParameterConverter</span><span class="op" id="7175038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175041">case</span>&nbsp;<span class="string" id="7175046">&#34;nullint64&#34;</span><span class="op" id="7175057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7175061">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175113">return</span>&nbsp;<span class="ident" id="7175120">driver</span><span class="op" id="7175126">.</span><span class="ident" id="7175127">Null</span><span class="op" id="7175131">{</span><span class="ident" id="7175132">Converter</span><span class="op" id="7175141">:</span>&nbsp;<span class="ident" id="7175143">driver</span><span class="op" id="7175149">.</span><span class="ident" id="7175150">DefaultParameterConverter</span><span class="op" id="7175175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175178">case</span>&nbsp;<span class="string" id="7175183">&#34;float64&#34;</span><span class="op" id="7175192">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7175196">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175248">return</span>&nbsp;<span class="ident" id="7175255">driver</span><span class="op" id="7175261">.</span><span class="ident" id="7175262">NotNull</span><span class="op" id="7175269">{</span><span class="ident" id="7175270">Converter</span><span class="op" id="7175279">:</span>&nbsp;<span class="ident" id="7175281">driver</span><span class="op" id="7175287">.</span><span class="ident" id="7175288">DefaultParameterConverter</span><span class="op" id="7175313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175316">case</span>&nbsp;<span class="string" id="7175321">&#34;nullfloat64&#34;</span><span class="op" id="7175334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7175338">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175390">return</span>&nbsp;<span class="ident" id="7175397">driver</span><span class="op" id="7175403">.</span><span class="ident" id="7175404">Null</span><span class="op" id="7175408">{</span><span class="ident" id="7175409">Converter</span><span class="op" id="7175418">:</span>&nbsp;<span class="ident" id="7175420">driver</span><span class="op" id="7175426">.</span><span class="ident" id="7175427">DefaultParameterConverter</span><span class="op" id="7175452">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175455">case</span>&nbsp;<span class="string" id="7175460">&#34;datetime&#34;</span><span class="op" id="7175470">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7175474">return</span>&nbsp;<span class="ident" id="7175481">driver</span><span class="op" id="7175487">.</span><span class="ident" id="7175488">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7175515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7175518">panic</span><span class="op" id="7175523">(</span><span class="string" id="7175524">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="7175557">+</span>&nbsp;<span class="ident" id="7175559">typ</span><span class="op" id="7175562">)</span><br>
<span class="lineno"></span><span class="op" id="7175564">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
