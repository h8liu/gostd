<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1473405">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1473461">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1473515">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1473566">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1473584">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1473635">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1473682">//</span><br>
<span class="lineno"></span><span class="comment" id="1473685">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1473751">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1473822">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1473891">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1473930">//</span><br>
<span class="lineno"></span><span class="comment" id="1473933">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1474007">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1474079">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1474148">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1474220">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1474287">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1474363">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1474435">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1474509">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1474587">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1474665">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1474745">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1474816">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1474894">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1474967">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1474989">//</span><br>
<span class="lineno">30</span><span class="comment" id="1474992">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1475064">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1475145">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1475222">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1475292">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1475365">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1475441">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1475515">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1475596">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1475680">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1475762">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1475801">//</span><br>
<span class="lineno"></span><span class="comment" id="1475804">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1475865">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1475943">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1476009">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1476082">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1476156">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1476229">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1476305">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1476370">package</span>&nbsp;<span class="ident" id="1476378">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476387">import</span>&nbsp;<span class="string" id="1476394">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1476404">const</span>&nbsp;<span class="op" id="1476410">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476413">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476429">=</span>&nbsp;<span class="num" id="1476431">1</span>&nbsp;<span class="op" id="1476433">&lt;&lt;</span>&nbsp;<span class="num" id="1476436">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476440">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476456">=</span>&nbsp;<span class="num" id="1476458">1</span>&nbsp;<span class="op" id="1476460">&lt;&lt;</span>&nbsp;<span class="num" id="1476463">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476467">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476483">=</span>&nbsp;<span class="num" id="1476485">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476488">maxCPUProfStack</span>&nbsp;<span class="op" id="1476504">=</span>&nbsp;<span class="num" id="1476506">64</span><br>
<span class="lineno">60</span><span class="op" id="1476509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476512">type</span>&nbsp;<span class="ident" id="1476517">cpuprofEntry</span>&nbsp;<span class="keyword" id="1476530">struct</span>&nbsp;<span class="op" id="1476537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476540">count</span>&nbsp;<span class="builtintype" id="1476546">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476555">depth</span>&nbsp;<span class="builtintype" id="1476561">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476570">stack</span>&nbsp;<span class="op" id="1476576">[</span><span class="ident" id="1476577">maxCPUProfStack</span><span class="op" id="1476592">]</span><span class="builtintype" id="1476593">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1476601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1476604">type</span>&nbsp;<span class="ident" id="1476609">cpuProfile</span>&nbsp;<span class="keyword" id="1476620">struct</span>&nbsp;<span class="op" id="1476627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476630">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1476637">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1476645">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476665">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1476672">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1476680">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476705">count</span>&nbsp;&nbsp;<span class="builtintype" id="1476712">uintptr</span>&nbsp;<span class="comment" id="1476720">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476735">evicts</span>&nbsp;<span class="builtintype" id="1476742">uintptr</span>&nbsp;<span class="comment" id="1476750">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476769">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1476776">uintptr</span>&nbsp;<span class="comment" id="1476784">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1476823">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476855">hash</span>&nbsp;<span class="op" id="1476860">[</span><span class="ident" id="1476861">numBuckets</span><span class="op" id="1476871">]</span><span class="keyword" id="1476872">struct</span>&nbsp;<span class="op" id="1476879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476883">entry</span>&nbsp;<span class="op" id="1476889">[</span><span class="ident" id="1476890">assoc</span><span class="op" id="1476895">]</span><span class="ident" id="1476896">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1476914">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1476951">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477001">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477051">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477059">[</span><span class="num" id="1477060">2</span><span class="op" id="1477061">]</span><span class="op" id="1477062">[</span><span class="ident" id="1477063">logSize</span>&nbsp;<span class="op" id="1477071">/</span>&nbsp;<span class="num" id="1477073">2</span><span class="op" id="1477074">]</span><span class="builtintype" id="1477075">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477084">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1477092">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477101">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1477109">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477116">handoff</span>&nbsp;<span class="builtintype" id="1477124">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477133">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477151">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477202">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477242">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1477251">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477259">wholding</span>&nbsp;<span class="builtintype" id="1477268">bool</span>&nbsp;<span class="comment" id="1477273">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477314">flushing</span>&nbsp;<span class="builtintype" id="1477323">bool</span>&nbsp;<span class="comment" id="1477328">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477370">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1477379">bool</span>&nbsp;<span class="comment" id="1477384">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1477432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477435">var</span>&nbsp;<span class="op" id="1477439">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477442">cpuprofLock</span>&nbsp;<span class="ident" id="1477454">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477461">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477473">*</span><span class="ident" id="1477474">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477487">eod</span>&nbsp;<span class="op" id="1477491">=</span>&nbsp;<span class="op" id="1477493">[</span><span class="num" id="1477494">3</span><span class="op" id="1477495">]</span><span class="builtintype" id="1477496">uintptr</span><span class="op" id="1477503">{</span><span class="num" id="1477504">0</span><span class="op" id="1477505">,</span>&nbsp;<span class="num" id="1477507">1</span><span class="op" id="1477508">,</span>&nbsp;<span class="num" id="1477510">0</span><span class="op" id="1477511">}</span><br>
<span class="lineno"></span><span class="op" id="1477513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477516">func</span>&nbsp;<span class="ident" id="1477521">setcpuprofilerate_m</span><span class="op" id="1477540">(</span><span class="op" id="1477541">)</span>&nbsp;<span class="comment" id="1477543">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1477554">func</span>&nbsp;<span class="ident" id="1477559">setcpuprofilerate</span><span class="op" id="1477576">(</span><span class="ident" id="1477577">hz</span>&nbsp;<span class="builtintype" id="1477580">int32</span><span class="op" id="1477585">)</span>&nbsp;<span class="op" id="1477587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477590">g</span>&nbsp;<span class="op" id="1477592">:=</span>&nbsp;<span class="ident" id="1477595">getg</span><span class="op" id="1477599">(</span><span class="op" id="1477600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477603">g</span><span class="op" id="1477604">.</span><span class="ident" id="1477605">m</span><span class="op" id="1477606">.</span><span class="ident" id="1477607">scalararg</span><span class="op" id="1477616">[</span><span class="num" id="1477617">0</span><span class="op" id="1477618">]</span>&nbsp;<span class="op" id="1477620">=</span>&nbsp;<span class="builtintype" id="1477622">uintptr</span><span class="op" id="1477629">(</span><span class="ident" id="1477630">hz</span><span class="op" id="1477632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477635">onM</span><span class="op" id="1477638">(</span><span class="ident" id="1477639">setcpuprofilerate_m</span><span class="op" id="1477658">)</span><br>
<span class="lineno">110</span><span class="op" id="1477660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1477663">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1477719">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1477777">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1477816">func</span>&nbsp;<span class="ident" id="1477821">lostProfileData</span><span class="op" id="1477836">(</span><span class="op" id="1477837">)</span>&nbsp;<span class="op" id="1477839">{</span><span class="op" id="1477840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1477843">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1477918">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1477972">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1478055">//</span><br>
<span class="lineno"></span><span class="comment" id="1478058">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1478114">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1478180">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1478211">func</span>&nbsp;<span class="ident" id="1478216">SetCPUProfileRate</span><span class="op" id="1478233">(</span><span class="ident" id="1478234">hz</span>&nbsp;<span class="builtintype" id="1478237">int</span><span class="op" id="1478240">)</span>&nbsp;<span class="op" id="1478242">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478245">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478283">if</span>&nbsp;<span class="ident" id="1478286">hz</span>&nbsp;<span class="op" id="1478289">&lt;</span>&nbsp;<span class="num" id="1478291">0</span>&nbsp;<span class="op" id="1478293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478297">hz</span>&nbsp;<span class="op" id="1478300">=</span>&nbsp;<span class="num" id="1478302">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478308">if</span>&nbsp;<span class="ident" id="1478311">hz</span>&nbsp;<span class="op" id="1478314">&gt;</span>&nbsp;<span class="num" id="1478316">1000000</span>&nbsp;<span class="op" id="1478324">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478328">hz</span>&nbsp;<span class="op" id="1478331">=</span>&nbsp;<span class="num" id="1478333">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478346">lock</span><span class="op" id="1478350">(</span><span class="op" id="1478351">&amp;</span><span class="ident" id="1478352">cpuprofLock</span><span class="op" id="1478363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478366">if</span>&nbsp;<span class="ident" id="1478369">hz</span>&nbsp;<span class="op" id="1478372">&gt;</span>&nbsp;<span class="num" id="1478374">0</span>&nbsp;<span class="op" id="1478376">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478380">if</span>&nbsp;<span class="ident" id="1478383">cpuprof</span>&nbsp;<span class="op" id="1478391">==</span>&nbsp;<span class="builtintype" id="1478394">nil</span>&nbsp;<span class="op" id="1478398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478403">cpuprof</span>&nbsp;<span class="op" id="1478411">=</span>&nbsp;<span class="op" id="1478413">(</span><span class="op" id="1478414">*</span><span class="ident" id="1478415">cpuProfile</span><span class="op" id="1478425">)</span><span class="op" id="1478426">(</span><span class="ident" id="1478427">sysAlloc</span><span class="op" id="1478435">(</span><span class="ident" id="1478436">unsafe</span><span class="op" id="1478442">.</span><span class="ident" id="1478443">Sizeof</span><span class="op" id="1478449">(</span><span class="ident" id="1478450">cpuProfile</span><span class="op" id="1478460">{</span><span class="op" id="1478461">}</span><span class="op" id="1478462">)</span><span class="op" id="1478463">,</span>&nbsp;<span class="op" id="1478465">&amp;</span><span class="ident" id="1478466">memstats</span><span class="op" id="1478474">.</span><span class="ident" id="1478475">other_sys</span><span class="op" id="1478484">)</span><span class="op" id="1478485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478490">if</span>&nbsp;<span class="ident" id="1478493">cpuprof</span>&nbsp;<span class="op" id="1478501">==</span>&nbsp;<span class="builtintype" id="1478504">nil</span>&nbsp;<span class="op" id="1478508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1478514">print</span><span class="op" id="1478519">(</span><span class="string" id="1478520">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1478569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478575">unlock</span><span class="op" id="1478581">(</span><span class="op" id="1478582">&amp;</span><span class="ident" id="1478583">cpuprofLock</span><span class="op" id="1478594">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478618">if</span>&nbsp;<span class="ident" id="1478621">cpuprof</span><span class="op" id="1478628">.</span><span class="ident" id="1478629">on</span>&nbsp;<span class="op" id="1478632">||</span>&nbsp;<span class="ident" id="1478635">cpuprof</span><span class="op" id="1478642">.</span><span class="ident" id="1478643">handoff</span>&nbsp;<span class="op" id="1478651">!=</span>&nbsp;<span class="num" id="1478654">0</span>&nbsp;<span class="op" id="1478656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1478661">print</span><span class="op" id="1478666">(</span><span class="string" id="1478667">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1478744">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478749">unlock</span><span class="op" id="1478755">(</span><span class="op" id="1478756">&amp;</span><span class="ident" id="1478757">cpuprofLock</span><span class="op" id="1478768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478773">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478787">cpuprof</span><span class="op" id="1478794">.</span><span class="ident" id="1478795">on</span>&nbsp;<span class="op" id="1478798">=</span>&nbsp;<span class="builtintype" id="1478800">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478807">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478840">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478930">p</span>&nbsp;<span class="op" id="1478932">:=</span>&nbsp;<span class="op" id="1478935">&amp;</span><span class="ident" id="1478936">cpuprof</span><span class="op" id="1478943">.</span><span class="ident" id="1478944">log</span><span class="op" id="1478947">[</span><span class="num" id="1478948">0</span><span class="op" id="1478949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478953">p</span><span class="op" id="1478954">[</span><span class="num" id="1478955">0</span><span class="op" id="1478956">]</span>&nbsp;<span class="op" id="1478958">=</span>&nbsp;<span class="num" id="1478960">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478978">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479000">p</span><span class="op" id="1479001">[</span><span class="num" id="1479002">1</span><span class="op" id="1479003">]</span>&nbsp;<span class="op" id="1479005">=</span>&nbsp;<span class="num" id="1479007">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1479025">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479047">p</span><span class="op" id="1479048">[</span><span class="num" id="1479049">2</span><span class="op" id="1479050">]</span>&nbsp;<span class="op" id="1479052">=</span>&nbsp;<span class="num" id="1479054">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1479072">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479092">p</span><span class="op" id="1479093">[</span><span class="num" id="1479094">3</span><span class="op" id="1479095">]</span>&nbsp;<span class="op" id="1479097">=</span>&nbsp;<span class="builtintype" id="1479099">uintptr</span><span class="op" id="1479106">(</span><span class="num" id="1479107">1e6</span>&nbsp;<span class="op" id="1479111">/</span>&nbsp;<span class="ident" id="1479113">hz</span><span class="op" id="1479115">)</span>&nbsp;<span class="comment" id="1479117">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479144">p</span><span class="op" id="1479145">[</span><span class="num" id="1479146">4</span><span class="op" id="1479147">]</span>&nbsp;<span class="op" id="1479149">=</span>&nbsp;<span class="num" id="1479151">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479155">cpuprof</span><span class="op" id="1479162">.</span><span class="ident" id="1479163">nlog</span>&nbsp;<span class="op" id="1479168">=</span>&nbsp;<span class="num" id="1479170">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479174">cpuprof</span><span class="op" id="1479181">.</span><span class="ident" id="1479182">toggle</span>&nbsp;<span class="op" id="1479189">=</span>&nbsp;<span class="num" id="1479191">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479195">cpuprof</span><span class="op" id="1479202">.</span><span class="ident" id="1479203">wholding</span>&nbsp;<span class="op" id="1479212">=</span>&nbsp;<span class="builtintype" id="1479214">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479222">cpuprof</span><span class="op" id="1479229">.</span><span class="ident" id="1479230">wtoggle</span>&nbsp;<span class="op" id="1479238">=</span>&nbsp;<span class="num" id="1479240">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479244">cpuprof</span><span class="op" id="1479251">.</span><span class="ident" id="1479252">flushing</span>&nbsp;<span class="op" id="1479261">=</span>&nbsp;<span class="builtintype" id="1479263">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479271">cpuprof</span><span class="op" id="1479278">.</span><span class="ident" id="1479279">eodSent</span>&nbsp;<span class="op" id="1479287">=</span>&nbsp;<span class="builtintype" id="1479289">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479297">noteclear</span><span class="op" id="1479306">(</span><span class="op" id="1479307">&amp;</span><span class="ident" id="1479308">cpuprof</span><span class="op" id="1479315">.</span><span class="ident" id="1479316">wait</span><span class="op" id="1479320">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479325">setcpuprofilerate</span><span class="op" id="1479342">(</span><span class="builtintype" id="1479343">int32</span><span class="op" id="1479348">(</span><span class="ident" id="1479349">hz</span><span class="op" id="1479351">)</span><span class="op" id="1479352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479355">}</span>&nbsp;<span class="keyword" id="1479357">else</span>&nbsp;<span class="keyword" id="1479362">if</span>&nbsp;<span class="ident" id="1479365">cpuprof</span>&nbsp;<span class="op" id="1479373">!=</span>&nbsp;<span class="builtintype" id="1479376">nil</span>&nbsp;<span class="op" id="1479380">&amp;&amp;</span>&nbsp;<span class="ident" id="1479383">cpuprof</span><span class="op" id="1479390">.</span><span class="ident" id="1479391">on</span>&nbsp;<span class="op" id="1479394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479398">setcpuprofilerate</span><span class="op" id="1479415">(</span><span class="num" id="1479416">0</span><span class="op" id="1479417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479421">cpuprof</span><span class="op" id="1479428">.</span><span class="ident" id="1479429">on</span>&nbsp;<span class="op" id="1479432">=</span>&nbsp;<span class="builtintype" id="1479434">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1479443">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1479516">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479575">for</span>&nbsp;<span class="op" id="1479579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479584">n</span>&nbsp;<span class="op" id="1479586">:=</span>&nbsp;<span class="ident" id="1479589">cpuprof</span><span class="op" id="1479596">.</span><span class="ident" id="1479597">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479608">if</span>&nbsp;<span class="ident" id="1479611">n</span><span class="op" id="1479612">&amp;</span><span class="num" id="1479613">0x80000000</span>&nbsp;<span class="op" id="1479624">!=</span>&nbsp;<span class="num" id="1479627">0</span>&nbsp;<span class="op" id="1479629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1479635">print</span><span class="op" id="1479640">(</span><span class="string" id="1479641">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1479678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479688">if</span>&nbsp;<span class="ident" id="1479691">cas</span><span class="op" id="1479694">(</span><span class="op" id="1479695">&amp;</span><span class="ident" id="1479696">cpuprof</span><span class="op" id="1479703">.</span><span class="ident" id="1479704">handoff</span><span class="op" id="1479711">,</span>&nbsp;<span class="ident" id="1479713">n</span><span class="op" id="1479714">,</span>&nbsp;<span class="ident" id="1479716">n</span><span class="op" id="1479717">|</span><span class="num" id="1479718">0x80000000</span><span class="op" id="1479728">)</span>&nbsp;<span class="op" id="1479730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479736">if</span>&nbsp;<span class="ident" id="1479739">n</span>&nbsp;<span class="op" id="1479741">==</span>&nbsp;<span class="num" id="1479744">0</span>&nbsp;<span class="op" id="1479746">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1479753">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479823">notewakeup</span><span class="op" id="1479833">(</span><span class="op" id="1479834">&amp;</span><span class="ident" id="1479835">cpuprof</span><span class="op" id="1479842">.</span><span class="ident" id="1479843">wait</span><span class="op" id="1479847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479859">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479868">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479878">unlock</span><span class="op" id="1479884">(</span><span class="op" id="1479885">&amp;</span><span class="ident" id="1479886">cpuprofLock</span><span class="op" id="1479897">)</span><br>
<span class="lineno"></span><span class="op" id="1479899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1479902">func</span>&nbsp;<span class="ident" id="1479907">cpuproftick</span><span class="op" id="1479918">(</span><span class="ident" id="1479919">pc</span>&nbsp;<span class="op" id="1479922">*</span><span class="builtintype" id="1479923">uintptr</span><span class="op" id="1479930">,</span>&nbsp;<span class="ident" id="1479932">n</span>&nbsp;<span class="builtintype" id="1479934">int32</span><span class="op" id="1479939">)</span>&nbsp;<span class="op" id="1479941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479944">if</span>&nbsp;<span class="ident" id="1479947">n</span>&nbsp;<span class="op" id="1479949">&gt;</span>&nbsp;<span class="ident" id="1479951">maxCPUProfStack</span>&nbsp;<span class="op" id="1479967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479971">n</span>&nbsp;<span class="op" id="1479973">=</span>&nbsp;<span class="ident" id="1479975">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1479992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479995">s</span>&nbsp;<span class="op" id="1479997">:=</span>&nbsp;<span class="op" id="1480000">(</span><span class="op" id="1480001">*</span><span class="op" id="1480002">[</span><span class="ident" id="1480003">maxCPUProfStack</span><span class="op" id="1480018">]</span><span class="builtintype" id="1480019">uintptr</span><span class="op" id="1480026">)</span><span class="op" id="1480027">(</span><span class="ident" id="1480028">unsafe</span><span class="op" id="1480034">.</span><span class="ident" id="1480035">Pointer</span><span class="op" id="1480042">(</span><span class="ident" id="1480043">pc</span><span class="op" id="1480045">)</span><span class="op" id="1480046">)</span><span class="op" id="1480047">[</span><span class="op" id="1480048">:</span><span class="ident" id="1480049">n</span><span class="op" id="1480050">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480053">cpuprof</span><span class="op" id="1480060">.</span><span class="ident" id="1480061">add</span><span class="op" id="1480064">(</span><span class="ident" id="1480065">s</span><span class="op" id="1480066">)</span><br>
<span class="lineno"></span><span class="op" id="1480068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1480071">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1480115">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1480183">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1480244">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1480314">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1480357">func</span>&nbsp;<span class="op" id="1480362">(</span><span class="ident" id="1480363">p</span>&nbsp;<span class="op" id="1480365">*</span><span class="ident" id="1480366">cpuProfile</span><span class="op" id="1480376">)</span>&nbsp;<span class="ident" id="1480378">add</span><span class="op" id="1480381">(</span><span class="ident" id="1480382">pc</span>&nbsp;<span class="op" id="1480385">[</span><span class="op" id="1480386">]</span><span class="builtintype" id="1480387">uintptr</span><span class="op" id="1480394">)</span>&nbsp;<span class="op" id="1480396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1480399">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480417">h</span>&nbsp;<span class="op" id="1480419">:=</span>&nbsp;<span class="builtintype" id="1480422">uintptr</span><span class="op" id="1480429">(</span><span class="num" id="1480430">0</span><span class="op" id="1480431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480434">for</span>&nbsp;<span class="ident" id="1480438">_</span><span class="op" id="1480439">,</span>&nbsp;<span class="ident" id="1480441">x</span>&nbsp;<span class="op" id="1480443">:=</span>&nbsp;<span class="keyword" id="1480446">range</span>&nbsp;<span class="ident" id="1480452">pc</span>&nbsp;<span class="op" id="1480455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480459">h</span>&nbsp;<span class="op" id="1480461">=</span>&nbsp;<span class="ident" id="1480463">h</span><span class="op" id="1480464">&lt;&lt;</span><span class="num" id="1480466">8</span>&nbsp;<span class="op" id="1480468">|</span>&nbsp;<span class="op" id="1480470">(</span><span class="ident" id="1480471">h</span>&nbsp;<span class="op" id="1480473">&gt;&gt;</span>&nbsp;<span class="op" id="1480476">(</span><span class="num" id="1480477">8</span>&nbsp;<span class="op" id="1480479">*</span>&nbsp;<span class="op" id="1480481">(</span><span class="ident" id="1480482">unsafe</span><span class="op" id="1480488">.</span><span class="ident" id="1480489">Sizeof</span><span class="op" id="1480495">(</span><span class="ident" id="1480496">h</span><span class="op" id="1480497">)</span>&nbsp;<span class="op" id="1480499">-</span>&nbsp;<span class="num" id="1480501">1</span><span class="op" id="1480502">)</span><span class="op" id="1480503">)</span><span class="op" id="1480504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480508">h</span>&nbsp;<span class="op" id="1480510">+=</span>&nbsp;<span class="ident" id="1480513">x</span><span class="op" id="1480514">*</span><span class="num" id="1480515">31</span>&nbsp;<span class="op" id="1480518">+</span>&nbsp;<span class="ident" id="1480520">x</span><span class="op" id="1480521">*</span><span class="num" id="1480522">7</span>&nbsp;<span class="op" id="1480524">+</span>&nbsp;<span class="ident" id="1480526">x</span><span class="op" id="1480527">*</span><span class="num" id="1480528">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480531">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480534">p</span><span class="op" id="1480535">.</span><span class="ident" id="1480536">count</span><span class="op" id="1480541">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1480546">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480598">b</span>&nbsp;<span class="op" id="1480600">:=</span>&nbsp;<span class="op" id="1480603">&amp;</span><span class="ident" id="1480604">p</span><span class="op" id="1480605">.</span><span class="ident" id="1480606">hash</span><span class="op" id="1480610">[</span><span class="ident" id="1480611">h</span><span class="op" id="1480612">%</span><span class="ident" id="1480613">numBuckets</span><span class="op" id="1480623">]</span><br>
<span class="lineno"></span><span class="ident" id="1480625">Assoc</span><span class="op" id="1480630">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480633">for</span>&nbsp;<span class="ident" id="1480637">i</span>&nbsp;<span class="op" id="1480639">:=</span>&nbsp;<span class="keyword" id="1480642">range</span>&nbsp;<span class="ident" id="1480648">b</span><span class="op" id="1480649">.</span><span class="ident" id="1480650">entry</span>&nbsp;<span class="op" id="1480656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480660">e</span>&nbsp;<span class="op" id="1480662">:=</span>&nbsp;<span class="op" id="1480665">&amp;</span><span class="ident" id="1480666">b</span><span class="op" id="1480667">.</span><span class="ident" id="1480668">entry</span><span class="op" id="1480673">[</span><span class="ident" id="1480674">i</span><span class="op" id="1480675">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480679">if</span>&nbsp;<span class="ident" id="1480682">e</span><span class="op" id="1480683">.</span><span class="ident" id="1480684">depth</span>&nbsp;<span class="op" id="1480690">!=</span>&nbsp;<span class="builtintype" id="1480693">uintptr</span><span class="op" id="1480700">(</span><span class="builtinfunc" id="1480701">len</span><span class="op" id="1480704">(</span><span class="ident" id="1480705">pc</span><span class="op" id="1480707">)</span><span class="op" id="1480708">)</span>&nbsp;<span class="op" id="1480710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480715">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480726">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480730">for</span>&nbsp;<span class="ident" id="1480734">j</span>&nbsp;<span class="op" id="1480736">:=</span>&nbsp;<span class="keyword" id="1480739">range</span>&nbsp;<span class="ident" id="1480745">pc</span>&nbsp;<span class="op" id="1480748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480753">if</span>&nbsp;<span class="ident" id="1480756">e</span><span class="op" id="1480757">.</span><span class="ident" id="1480758">stack</span><span class="op" id="1480763">[</span><span class="ident" id="1480764">j</span><span class="op" id="1480765">]</span>&nbsp;<span class="op" id="1480767">!=</span>&nbsp;<span class="ident" id="1480770">pc</span><span class="op" id="1480772">[</span><span class="ident" id="1480773">j</span><span class="op" id="1480774">]</span>&nbsp;<span class="op" id="1480776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480782">continue</span>&nbsp;<span class="ident" id="1480791">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480804">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480808">e</span><span class="op" id="1480809">.</span><span class="ident" id="1480810">count</span><span class="op" id="1480815">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480820">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1480832">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480869">var</span>&nbsp;<span class="ident" id="1480873">e</span>&nbsp;<span class="op" id="1480875">*</span><span class="ident" id="1480876">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480890">for</span>&nbsp;<span class="ident" id="1480894">i</span>&nbsp;<span class="op" id="1480896">:=</span>&nbsp;<span class="keyword" id="1480899">range</span>&nbsp;<span class="ident" id="1480905">b</span><span class="op" id="1480906">.</span><span class="ident" id="1480907">entry</span>&nbsp;<span class="op" id="1480913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480917">if</span>&nbsp;<span class="ident" id="1480920">e</span>&nbsp;<span class="op" id="1480922">==</span>&nbsp;<span class="builtintype" id="1480925">nil</span>&nbsp;<span class="op" id="1480929">||</span>&nbsp;<span class="ident" id="1480932">b</span><span class="op" id="1480933">.</span><span class="ident" id="1480934">entry</span><span class="op" id="1480939">[</span><span class="ident" id="1480940">i</span><span class="op" id="1480941">]</span><span class="op" id="1480942">.</span><span class="ident" id="1480943">count</span>&nbsp;<span class="op" id="1480949">&lt;</span>&nbsp;<span class="ident" id="1480951">e</span><span class="op" id="1480952">.</span><span class="ident" id="1480953">count</span>&nbsp;<span class="op" id="1480959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1480964">e</span>&nbsp;<span class="op" id="1480966">=</span>&nbsp;<span class="op" id="1480968">&amp;</span><span class="ident" id="1480969">b</span><span class="op" id="1480970">.</span><span class="ident" id="1480971">entry</span><span class="op" id="1480976">[</span><span class="ident" id="1480977">i</span><span class="op" id="1480978">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480982">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1480985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1480988">if</span>&nbsp;<span class="ident" id="1480991">e</span><span class="op" id="1480992">.</span><span class="ident" id="1480993">count</span>&nbsp;<span class="op" id="1480999">&gt;</span>&nbsp;<span class="num" id="1481001">0</span>&nbsp;<span class="op" id="1481003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481007">if</span>&nbsp;<span class="op" id="1481010">!</span><span class="ident" id="1481011">p</span><span class="op" id="1481012">.</span><span class="ident" id="1481013">evict</span><span class="op" id="1481018">(</span><span class="ident" id="1481019">e</span><span class="op" id="1481020">)</span>&nbsp;<span class="op" id="1481022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1481027">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481076">p</span><span class="op" id="1481077">.</span><span class="ident" id="1481078">lost</span><span class="op" id="1481082">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481088">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1481097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481101">p</span><span class="op" id="1481102">.</span><span class="ident" id="1481103">evicts</span><span class="op" id="1481109">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1481113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1481117">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481152">e</span><span class="op" id="1481153">.</span><span class="ident" id="1481154">depth</span>&nbsp;<span class="op" id="1481160">=</span>&nbsp;<span class="builtintype" id="1481162">uintptr</span><span class="op" id="1481169">(</span><span class="builtinfunc" id="1481170">len</span><span class="op" id="1481173">(</span><span class="ident" id="1481174">pc</span><span class="op" id="1481176">)</span><span class="op" id="1481177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481180">e</span><span class="op" id="1481181">.</span><span class="ident" id="1481182">count</span>&nbsp;<span class="op" id="1481188">=</span>&nbsp;<span class="num" id="1481190">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1481193">copy</span><span class="op" id="1481197">(</span><span class="ident" id="1481198">e</span><span class="op" id="1481199">.</span><span class="ident" id="1481200">stack</span><span class="op" id="1481205">[</span><span class="op" id="1481206">:</span><span class="op" id="1481207">]</span><span class="op" id="1481208">,</span>&nbsp;<span class="ident" id="1481210">pc</span><span class="op" id="1481212">)</span><br>
<span class="lineno"></span><span class="op" id="1481214">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1481217">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1481278">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1481339">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1481402">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1481461">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1481519">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1481560">func</span>&nbsp;<span class="op" id="1481565">(</span><span class="ident" id="1481566">p</span>&nbsp;<span class="op" id="1481568">*</span><span class="ident" id="1481569">cpuProfile</span><span class="op" id="1481579">)</span>&nbsp;<span class="ident" id="1481581">evict</span><span class="op" id="1481586">(</span><span class="ident" id="1481587">e</span>&nbsp;<span class="op" id="1481589">*</span><span class="ident" id="1481590">cpuprofEntry</span><span class="op" id="1481602">)</span>&nbsp;<span class="builtintype" id="1481604">bool</span>&nbsp;<span class="op" id="1481609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481612">d</span>&nbsp;<span class="op" id="1481614">:=</span>&nbsp;<span class="ident" id="1481617">e</span><span class="op" id="1481618">.</span><span class="ident" id="1481619">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481626">nslot</span>&nbsp;<span class="op" id="1481632">:=</span>&nbsp;<span class="ident" id="1481635">d</span>&nbsp;<span class="op" id="1481637">+</span>&nbsp;<span class="num" id="1481639">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481642">log</span>&nbsp;<span class="op" id="1481646">:=</span>&nbsp;<span class="op" id="1481649">&amp;</span><span class="ident" id="1481650">p</span><span class="op" id="1481651">.</span><span class="ident" id="1481652">log</span><span class="op" id="1481655">[</span><span class="ident" id="1481656">p</span><span class="op" id="1481657">.</span><span class="ident" id="1481658">toggle</span><span class="op" id="1481664">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481667">if</span>&nbsp;<span class="ident" id="1481670">p</span><span class="op" id="1481671">.</span><span class="ident" id="1481672">nlog</span><span class="op" id="1481676">+</span><span class="ident" id="1481677">nslot</span>&nbsp;<span class="op" id="1481683">&gt;</span>&nbsp;<span class="builtintype" id="1481685">uintptr</span><span class="op" id="1481692">(</span><span class="builtinfunc" id="1481693">len</span><span class="op" id="1481696">(</span><span class="ident" id="1481697">p</span><span class="op" id="1481698">.</span><span class="ident" id="1481699">log</span><span class="op" id="1481702">[</span><span class="num" id="1481703">0</span><span class="op" id="1481704">]</span><span class="op" id="1481705">)</span><span class="op" id="1481706">)</span>&nbsp;<span class="op" id="1481708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481712">if</span>&nbsp;<span class="op" id="1481715">!</span><span class="ident" id="1481716">p</span><span class="op" id="1481717">.</span><span class="ident" id="1481718">flushlog</span><span class="op" id="1481726">(</span><span class="op" id="1481727">)</span>&nbsp;<span class="op" id="1481729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481734">return</span>&nbsp;<span class="builtintype" id="1481741">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1481749">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481753">log</span>&nbsp;<span class="op" id="1481757">=</span>&nbsp;<span class="op" id="1481759">&amp;</span><span class="ident" id="1481760">p</span><span class="op" id="1481761">.</span><span class="ident" id="1481762">log</span><span class="op" id="1481765">[</span><span class="ident" id="1481766">p</span><span class="op" id="1481767">.</span><span class="ident" id="1481768">toggle</span><span class="op" id="1481774">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1481777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481781">q</span>&nbsp;<span class="op" id="1481783">:=</span>&nbsp;<span class="ident" id="1481786">p</span><span class="op" id="1481787">.</span><span class="ident" id="1481788">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481794">log</span><span class="op" id="1481797">[</span><span class="ident" id="1481798">q</span><span class="op" id="1481799">]</span>&nbsp;<span class="op" id="1481801">=</span>&nbsp;<span class="ident" id="1481803">e</span><span class="op" id="1481804">.</span><span class="ident" id="1481805">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481812">q</span><span class="op" id="1481813">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481817">log</span><span class="op" id="1481820">[</span><span class="ident" id="1481821">q</span><span class="op" id="1481822">]</span>&nbsp;<span class="op" id="1481824">=</span>&nbsp;<span class="ident" id="1481826">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481829">q</span><span class="op" id="1481830">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1481834">copy</span><span class="op" id="1481838">(</span><span class="ident" id="1481839">log</span><span class="op" id="1481842">[</span><span class="ident" id="1481843">q</span><span class="op" id="1481844">:</span><span class="op" id="1481845">]</span><span class="op" id="1481846">,</span>&nbsp;<span class="ident" id="1481848">e</span><span class="op" id="1481849">.</span><span class="ident" id="1481850">stack</span><span class="op" id="1481855">[</span><span class="op" id="1481856">:</span><span class="ident" id="1481857">d</span><span class="op" id="1481858">]</span><span class="op" id="1481859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481862">q</span>&nbsp;<span class="op" id="1481864">+=</span>&nbsp;<span class="ident" id="1481867">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481870">p</span><span class="op" id="1481871">.</span><span class="ident" id="1481872">nlog</span>&nbsp;<span class="op" id="1481877">=</span>&nbsp;<span class="ident" id="1481879">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1481882">e</span><span class="op" id="1481883">.</span><span class="ident" id="1481884">count</span>&nbsp;<span class="op" id="1481890">=</span>&nbsp;<span class="num" id="1481892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1481895">return</span>&nbsp;<span class="builtintype" id="1481902">true</span><br>
<span class="lineno"></span><span class="op" id="1481907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1481910">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1481982">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1482065">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1482137">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1482216">func</span>&nbsp;<span class="op" id="1482221">(</span><span class="ident" id="1482222">p</span>&nbsp;<span class="op" id="1482224">*</span><span class="ident" id="1482225">cpuProfile</span><span class="op" id="1482235">)</span>&nbsp;<span class="ident" id="1482237">flushlog</span><span class="op" id="1482245">(</span><span class="op" id="1482246">)</span>&nbsp;<span class="builtintype" id="1482248">bool</span>&nbsp;<span class="op" id="1482253">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482256">if</span>&nbsp;<span class="op" id="1482259">!</span><span class="ident" id="1482260">cas</span><span class="op" id="1482263">(</span><span class="op" id="1482264">&amp;</span><span class="ident" id="1482265">p</span><span class="op" id="1482266">.</span><span class="ident" id="1482267">handoff</span><span class="op" id="1482274">,</span>&nbsp;<span class="num" id="1482276">0</span><span class="op" id="1482277">,</span>&nbsp;<span class="builtintype" id="1482279">uint32</span><span class="op" id="1482285">(</span><span class="ident" id="1482286">p</span><span class="op" id="1482287">.</span><span class="ident" id="1482288">nlog</span><span class="op" id="1482292">)</span><span class="op" id="1482293">)</span>&nbsp;<span class="op" id="1482295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482299">return</span>&nbsp;<span class="builtintype" id="1482306">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1482313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482316">notewakeup</span><span class="op" id="1482326">(</span><span class="op" id="1482327">&amp;</span><span class="ident" id="1482328">p</span><span class="op" id="1482329">.</span><span class="ident" id="1482330">wait</span><span class="op" id="1482334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482338">p</span><span class="op" id="1482339">.</span><span class="ident" id="1482340">toggle</span>&nbsp;<span class="op" id="1482347">=</span>&nbsp;<span class="num" id="1482349">1</span>&nbsp;<span class="op" id="1482351">-</span>&nbsp;<span class="ident" id="1482353">p</span><span class="op" id="1482354">.</span><span class="ident" id="1482355">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482363">log</span>&nbsp;<span class="op" id="1482367">:=</span>&nbsp;<span class="op" id="1482370">&amp;</span><span class="ident" id="1482371">p</span><span class="op" id="1482372">.</span><span class="ident" id="1482373">log</span><span class="op" id="1482376">[</span><span class="ident" id="1482377">p</span><span class="op" id="1482378">.</span><span class="ident" id="1482379">toggle</span><span class="op" id="1482385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482388">q</span>&nbsp;<span class="op" id="1482390">:=</span>&nbsp;<span class="builtintype" id="1482393">uintptr</span><span class="op" id="1482400">(</span><span class="num" id="1482401">0</span><span class="op" id="1482402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482405">if</span>&nbsp;<span class="ident" id="1482408">p</span><span class="op" id="1482409">.</span><span class="ident" id="1482410">lost</span>&nbsp;<span class="op" id="1482415">&gt;</span>&nbsp;<span class="num" id="1482417">0</span>&nbsp;<span class="op" id="1482419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482423">lostPC</span>&nbsp;<span class="op" id="1482430">:=</span>&nbsp;<span class="ident" id="1482433">funcPC</span><span class="op" id="1482439">(</span><span class="ident" id="1482440">lostProfileData</span><span class="op" id="1482455">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482459">log</span><span class="op" id="1482462">[</span><span class="num" id="1482463">0</span><span class="op" id="1482464">]</span>&nbsp;<span class="op" id="1482466">=</span>&nbsp;<span class="ident" id="1482468">p</span><span class="op" id="1482469">.</span><span class="ident" id="1482470">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482477">log</span><span class="op" id="1482480">[</span><span class="num" id="1482481">1</span><span class="op" id="1482482">]</span>&nbsp;<span class="op" id="1482484">=</span>&nbsp;<span class="num" id="1482486">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482490">log</span><span class="op" id="1482493">[</span><span class="num" id="1482494">2</span><span class="op" id="1482495">]</span>&nbsp;<span class="op" id="1482497">=</span>&nbsp;<span class="ident" id="1482499">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482508">q</span>&nbsp;<span class="op" id="1482510">=</span>&nbsp;<span class="num" id="1482512">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482516">p</span><span class="op" id="1482517">.</span><span class="ident" id="1482518">lost</span>&nbsp;<span class="op" id="1482523">=</span>&nbsp;<span class="num" id="1482525">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1482528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482531">p</span><span class="op" id="1482532">.</span><span class="ident" id="1482533">nlog</span>&nbsp;<span class="op" id="1482538">=</span>&nbsp;<span class="ident" id="1482540">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482543">return</span>&nbsp;<span class="builtintype" id="1482550">true</span><br>
<span class="lineno"></span><span class="op" id="1482555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1482558">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1482631">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1482704">func</span>&nbsp;<span class="op" id="1482709">(</span><span class="ident" id="1482710">p</span>&nbsp;<span class="op" id="1482712">*</span><span class="ident" id="1482713">cpuProfile</span><span class="op" id="1482723">)</span>&nbsp;<span class="ident" id="1482725">getprofile</span><span class="op" id="1482735">(</span><span class="op" id="1482736">)</span>&nbsp;<span class="op" id="1482738">[</span><span class="op" id="1482739">]</span><span class="builtintype" id="1482740">byte</span>&nbsp;<span class="op" id="1482745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482748">if</span>&nbsp;<span class="ident" id="1482751">p</span>&nbsp;<span class="op" id="1482753">==</span>&nbsp;<span class="builtintype" id="1482756">nil</span>&nbsp;<span class="op" id="1482760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482764">return</span>&nbsp;<span class="builtintype" id="1482771">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1482776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482780">if</span>&nbsp;<span class="ident" id="1482783">p</span><span class="op" id="1482784">.</span><span class="ident" id="1482785">wholding</span>&nbsp;<span class="op" id="1482794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1482798">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1482849">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482911">for</span>&nbsp;<span class="op" id="1482915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1482920">n</span>&nbsp;<span class="op" id="1482922">:=</span>&nbsp;<span class="ident" id="1482925">p</span><span class="op" id="1482926">.</span><span class="ident" id="1482927">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1482938">if</span>&nbsp;<span class="ident" id="1482941">n</span>&nbsp;<span class="op" id="1482943">==</span>&nbsp;<span class="num" id="1482946">0</span>&nbsp;<span class="op" id="1482948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1482954">print</span><span class="op" id="1482959">(</span><span class="string" id="1482960">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1483011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483017">return</span>&nbsp;<span class="builtintype" id="1483024">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483036">if</span>&nbsp;<span class="ident" id="1483039">n</span><span class="op" id="1483040">&amp;</span><span class="num" id="1483041">0x80000000</span>&nbsp;<span class="op" id="1483052">!=</span>&nbsp;<span class="num" id="1483055">0</span>&nbsp;<span class="op" id="1483057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483063">p</span><span class="op" id="1483064">.</span><span class="ident" id="1483065">wtoggle</span>&nbsp;<span class="op" id="1483073">=</span>&nbsp;<span class="num" id="1483075">1</span>&nbsp;<span class="op" id="1483077">-</span>&nbsp;<span class="ident" id="1483079">p</span><span class="op" id="1483080">.</span><span class="ident" id="1483081">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483093">p</span><span class="op" id="1483094">.</span><span class="ident" id="1483095">wholding</span>&nbsp;<span class="op" id="1483104">=</span>&nbsp;<span class="builtintype" id="1483106">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483116">p</span><span class="op" id="1483117">.</span><span class="ident" id="1483118">flushing</span>&nbsp;<span class="op" id="1483127">=</span>&nbsp;<span class="builtintype" id="1483129">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483138">goto</span>&nbsp;<span class="ident" id="1483143">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483157">if</span>&nbsp;<span class="ident" id="1483160">cas</span><span class="op" id="1483163">(</span><span class="op" id="1483164">&amp;</span><span class="ident" id="1483165">p</span><span class="op" id="1483166">.</span><span class="ident" id="1483167">handoff</span><span class="op" id="1483174">,</span>&nbsp;<span class="ident" id="1483176">n</span><span class="op" id="1483177">,</span>&nbsp;<span class="num" id="1483179">0</span><span class="op" id="1483180">)</span>&nbsp;<span class="op" id="1483182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483197">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483205">p</span><span class="op" id="1483206">.</span><span class="ident" id="1483207">wtoggle</span>&nbsp;<span class="op" id="1483215">=</span>&nbsp;<span class="num" id="1483217">1</span>&nbsp;<span class="op" id="1483219">-</span>&nbsp;<span class="ident" id="1483221">p</span><span class="op" id="1483222">.</span><span class="ident" id="1483223">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483233">p</span><span class="op" id="1483234">.</span><span class="ident" id="1483235">wholding</span>&nbsp;<span class="op" id="1483244">=</span>&nbsp;<span class="builtintype" id="1483246">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483257">if</span>&nbsp;<span class="ident" id="1483260">p</span><span class="op" id="1483261">.</span><span class="ident" id="1483262">flushing</span>&nbsp;<span class="op" id="1483271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483275">goto</span>&nbsp;<span class="ident" id="1483280">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483291">if</span>&nbsp;<span class="op" id="1483294">!</span><span class="ident" id="1483295">p</span><span class="op" id="1483296">.</span><span class="ident" id="1483297">on</span>&nbsp;<span class="op" id="1483300">&amp;&amp;</span>&nbsp;<span class="ident" id="1483303">p</span><span class="op" id="1483304">.</span><span class="ident" id="1483305">handoff</span>&nbsp;<span class="op" id="1483313">==</span>&nbsp;<span class="num" id="1483316">0</span>&nbsp;<span class="op" id="1483318">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483322">return</span>&nbsp;<span class="builtintype" id="1483329">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483338">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483360">notetsleepg</span><span class="op" id="1483371">(</span><span class="op" id="1483372">&amp;</span><span class="ident" id="1483373">p</span><span class="op" id="1483374">.</span><span class="ident" id="1483375">wait</span><span class="op" id="1483379">,</span>&nbsp;<span class="op" id="1483381">-</span><span class="num" id="1483382">1</span><span class="op" id="1483383">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483386">noteclear</span><span class="op" id="1483395">(</span><span class="op" id="1483396">&amp;</span><span class="ident" id="1483397">p</span><span class="op" id="1483398">.</span><span class="ident" id="1483399">wait</span><span class="op" id="1483403">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483407">switch</span>&nbsp;<span class="ident" id="1483414">n</span>&nbsp;<span class="op" id="1483416">:=</span>&nbsp;<span class="ident" id="1483419">p</span><span class="op" id="1483420">.</span><span class="ident" id="1483421">handoff</span><span class="op" id="1483428">;</span>&nbsp;<span class="op" id="1483430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483433">case</span>&nbsp;<span class="ident" id="1483438">n</span>&nbsp;<span class="op" id="1483440">==</span>&nbsp;<span class="num" id="1483443">0</span><span class="op" id="1483444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1483448">print</span><span class="op" id="1483453">(</span><span class="string" id="1483454">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1483502">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483506">return</span>&nbsp;<span class="builtintype" id="1483513">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483518">case</span>&nbsp;<span class="ident" id="1483523">n</span>&nbsp;<span class="op" id="1483525">==</span>&nbsp;<span class="num" id="1483528">0x80000000</span><span class="op" id="1483538">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483542">p</span><span class="op" id="1483543">.</span><span class="ident" id="1483544">flushing</span>&nbsp;<span class="op" id="1483553">=</span>&nbsp;<span class="builtintype" id="1483555">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483562">goto</span>&nbsp;<span class="ident" id="1483567">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483574">default</span><span class="op" id="1483581">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483585">n</span>&nbsp;<span class="op" id="1483587">&amp;^=</span>&nbsp;<span class="num" id="1483591">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483605">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483636">p</span><span class="op" id="1483637">.</span><span class="ident" id="1483638">wholding</span>&nbsp;<span class="op" id="1483647">=</span>&nbsp;<span class="builtintype" id="1483649">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483657">return</span>&nbsp;<span class="ident" id="1483664">uintptrBytes</span><span class="op" id="1483676">(</span><span class="ident" id="1483677">p</span><span class="op" id="1483678">.</span><span class="ident" id="1483679">log</span><span class="op" id="1483682">[</span><span class="ident" id="1483683">p</span><span class="op" id="1483684">.</span><span class="ident" id="1483685">wtoggle</span><span class="op" id="1483692">]</span><span class="op" id="1483693">[</span><span class="op" id="1483694">:</span><span class="ident" id="1483695">n</span><span class="op" id="1483696">]</span><span class="op" id="1483697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1483700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483704">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483723">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483775">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1483840">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1483892">Flush</span><span class="op" id="1483897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483900">for</span>&nbsp;<span class="ident" id="1483904">i</span>&nbsp;<span class="op" id="1483906">:=</span>&nbsp;<span class="keyword" id="1483909">range</span>&nbsp;<span class="ident" id="1483915">p</span><span class="op" id="1483916">.</span><span class="ident" id="1483917">hash</span>&nbsp;<span class="op" id="1483922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483926">b</span>&nbsp;<span class="op" id="1483928">:=</span>&nbsp;<span class="op" id="1483931">&amp;</span><span class="ident" id="1483932">p</span><span class="op" id="1483933">.</span><span class="ident" id="1483934">hash</span><span class="op" id="1483938">[</span><span class="ident" id="1483939">i</span><span class="op" id="1483940">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483944">for</span>&nbsp;<span class="ident" id="1483948">j</span>&nbsp;<span class="op" id="1483950">:=</span>&nbsp;<span class="keyword" id="1483953">range</span>&nbsp;<span class="ident" id="1483959">b</span><span class="op" id="1483960">.</span><span class="ident" id="1483961">entry</span>&nbsp;<span class="op" id="1483967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1483972">e</span>&nbsp;<span class="op" id="1483974">:=</span>&nbsp;<span class="op" id="1483977">&amp;</span><span class="ident" id="1483978">b</span><span class="op" id="1483979">.</span><span class="ident" id="1483980">entry</span><span class="op" id="1483985">[</span><span class="ident" id="1483986">j</span><span class="op" id="1483987">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1483992">if</span>&nbsp;<span class="ident" id="1483995">e</span><span class="op" id="1483996">.</span><span class="ident" id="1483997">count</span>&nbsp;<span class="op" id="1484003">&gt;</span>&nbsp;<span class="num" id="1484005">0</span>&nbsp;<span class="op" id="1484007">&amp;&amp;</span>&nbsp;<span class="op" id="1484010">!</span><span class="ident" id="1484011">p</span><span class="op" id="1484012">.</span><span class="ident" id="1484013">evict</span><span class="op" id="1484018">(</span><span class="ident" id="1484019">e</span><span class="op" id="1484020">)</span>&nbsp;<span class="op" id="1484022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484028">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484093">break</span>&nbsp;<span class="ident" id="1484099">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484119">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484148">if</span>&nbsp;<span class="ident" id="1484151">p</span><span class="op" id="1484152">.</span><span class="ident" id="1484153">nlog</span>&nbsp;<span class="op" id="1484158">&gt;</span>&nbsp;<span class="num" id="1484160">0</span>&nbsp;<span class="op" id="1484162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484166">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484218">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484266">n</span>&nbsp;<span class="op" id="1484268">:=</span>&nbsp;<span class="ident" id="1484271">p</span><span class="op" id="1484272">.</span><span class="ident" id="1484273">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484280">p</span><span class="op" id="1484281">.</span><span class="ident" id="1484282">nlog</span>&nbsp;<span class="op" id="1484287">=</span>&nbsp;<span class="num" id="1484289">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484293">return</span>&nbsp;<span class="ident" id="1484300">uintptrBytes</span><span class="op" id="1484312">(</span><span class="ident" id="1484313">p</span><span class="op" id="1484314">.</span><span class="ident" id="1484315">log</span><span class="op" id="1484318">[</span><span class="ident" id="1484319">p</span><span class="op" id="1484320">.</span><span class="ident" id="1484321">toggle</span><span class="op" id="1484327">]</span><span class="op" id="1484328">[</span><span class="op" id="1484329">:</span><span class="ident" id="1484330">n</span><span class="op" id="1484331">]</span><span class="op" id="1484332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484339">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484402">if</span>&nbsp;<span class="op" id="1484405">!</span><span class="ident" id="1484406">p</span><span class="op" id="1484407">.</span><span class="ident" id="1484408">eodSent</span>&nbsp;<span class="op" id="1484416">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484420">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484486">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484551">p</span><span class="op" id="1484552">.</span><span class="ident" id="1484553">eodSent</span>&nbsp;<span class="op" id="1484561">=</span>&nbsp;<span class="builtintype" id="1484563">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484570">return</span>&nbsp;<span class="ident" id="1484577">uintptrBytes</span><span class="op" id="1484589">(</span><span class="ident" id="1484590">eod</span><span class="op" id="1484593">[</span><span class="op" id="1484594">:</span><span class="op" id="1484595">]</span><span class="op" id="1484596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484599">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1484603">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484647">p</span><span class="op" id="1484648">.</span><span class="ident" id="1484649">flushing</span>&nbsp;<span class="op" id="1484658">=</span>&nbsp;<span class="builtintype" id="1484660">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484667">if</span>&nbsp;<span class="op" id="1484670">!</span><span class="ident" id="1484671">cas</span><span class="op" id="1484674">(</span><span class="op" id="1484675">&amp;</span><span class="ident" id="1484676">p</span><span class="op" id="1484677">.</span><span class="ident" id="1484678">handoff</span><span class="op" id="1484685">,</span>&nbsp;<span class="ident" id="1484687">p</span><span class="op" id="1484688">.</span><span class="ident" id="1484689">handoff</span><span class="op" id="1484696">,</span>&nbsp;<span class="num" id="1484698">0</span><span class="op" id="1484699">)</span>&nbsp;<span class="op" id="1484701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1484705">print</span><span class="op" id="1484710">(</span><span class="string" id="1484711">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1484759">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1484762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484765">return</span>&nbsp;<span class="builtintype" id="1484772">nil</span><br>
<span class="lineno"></span><span class="op" id="1484776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1484779">func</span>&nbsp;<span class="ident" id="1484784">uintptrBytes</span><span class="op" id="1484796">(</span><span class="ident" id="1484797">p</span>&nbsp;<span class="op" id="1484799">[</span><span class="op" id="1484800">]</span><span class="builtintype" id="1484801">uintptr</span><span class="op" id="1484808">)</span>&nbsp;<span class="op" id="1484810">(</span><span class="ident" id="1484811">ret</span>&nbsp;<span class="op" id="1484815">[</span><span class="op" id="1484816">]</span><span class="builtintype" id="1484817">byte</span><span class="op" id="1484821">)</span>&nbsp;<span class="op" id="1484823">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484826">pp</span>&nbsp;<span class="op" id="1484829">:=</span>&nbsp;<span class="op" id="1484832">(</span><span class="op" id="1484833">*</span><span class="ident" id="1484834">sliceStruct</span><span class="op" id="1484845">)</span><span class="op" id="1484846">(</span><span class="ident" id="1484847">unsafe</span><span class="op" id="1484853">.</span><span class="ident" id="1484854">Pointer</span><span class="op" id="1484861">(</span><span class="op" id="1484862">&amp;</span><span class="ident" id="1484863">p</span><span class="op" id="1484864">)</span><span class="op" id="1484865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484868">rp</span>&nbsp;<span class="op" id="1484871">:=</span>&nbsp;<span class="op" id="1484874">(</span><span class="op" id="1484875">*</span><span class="ident" id="1484876">sliceStruct</span><span class="op" id="1484887">)</span><span class="op" id="1484888">(</span><span class="ident" id="1484889">unsafe</span><span class="op" id="1484895">.</span><span class="ident" id="1484896">Pointer</span><span class="op" id="1484903">(</span><span class="op" id="1484904">&amp;</span><span class="ident" id="1484905">ret</span><span class="op" id="1484908">)</span><span class="op" id="1484909">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484913">rp</span><span class="op" id="1484915">.</span><span class="ident" id="1484916">array</span>&nbsp;<span class="op" id="1484922">=</span>&nbsp;<span class="ident" id="1484924">pp</span><span class="op" id="1484926">.</span><span class="ident" id="1484927">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484934">rp</span><span class="op" id="1484936">.</span><span class="builtinfunc" id="1484937">len</span>&nbsp;<span class="op" id="1484941">=</span>&nbsp;<span class="ident" id="1484943">pp</span><span class="op" id="1484945">.</span><span class="builtinfunc" id="1484946">len</span>&nbsp;<span class="op" id="1484950">*</span>&nbsp;<span class="builtintype" id="1484952">int</span><span class="op" id="1484955">(</span><span class="ident" id="1484956">unsafe</span><span class="op" id="1484962">.</span><span class="ident" id="1484963">Sizeof</span><span class="op" id="1484969">(</span><span class="ident" id="1484970">p</span><span class="op" id="1484971">[</span><span class="num" id="1484972">0</span><span class="op" id="1484973">]</span><span class="op" id="1484974">)</span><span class="op" id="1484975">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1484978">rp</span><span class="op" id="1484980">.</span><span class="builtinfunc" id="1484981">cap</span>&nbsp;<span class="op" id="1484985">=</span>&nbsp;<span class="ident" id="1484987">rp</span><span class="op" id="1484989">.</span><span class="builtinfunc" id="1484990">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1484996">return</span><br>
<span class="lineno"></span><span class="op" id="1485003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1485006">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1485085">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1485170">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1485249">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1485324">//</span><br>
<span class="lineno">420</span><span class="comment" id="1485327">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1485383">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1485449">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1485473">func</span>&nbsp;<span class="ident" id="1485478">CPUProfile</span><span class="op" id="1485488">(</span><span class="op" id="1485489">)</span>&nbsp;<span class="op" id="1485491">[</span><span class="op" id="1485492">]</span><span class="builtintype" id="1485493">byte</span>&nbsp;<span class="op" id="1485498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1485501">return</span>&nbsp;<span class="ident" id="1485508">cpuprof</span><span class="op" id="1485515">.</span><span class="ident" id="1485516">getprofile</span><span class="op" id="1485526">(</span><span class="op" id="1485527">)</span><br>
<span class="lineno">425</span><span class="op" id="1485529">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
