<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html" class="current">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5025930">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5025985">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5026039">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5026090">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5026127">package</span>&nbsp;<span class="ident" id="5026135">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5026140">import</span>&nbsp;<span class="op" id="5026147">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5026150">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5026157">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5026171">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5026183">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="5026193">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="5026196">type</span>&nbsp;<span class="ident" id="5026201">pkgBuilder</span>&nbsp;<span class="keyword" id="5026212">struct</span>&nbsp;<span class="op" id="5026219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026222">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5026229">*</span><span class="ident" id="5026230">token</span><span class="op" id="5026235">.</span><span class="ident" id="5026236">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026245">errors</span>&nbsp;<span class="ident" id="5026252">scanner</span><span class="op" id="5026259">.</span><span class="ident" id="5026260">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="5026270">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5026273">func</span>&nbsp;<span class="op" id="5026278">(</span><span class="ident" id="5026279">p</span>&nbsp;<span class="op" id="5026281">*</span><span class="ident" id="5026282">pkgBuilder</span><span class="op" id="5026292">)</span>&nbsp;<span class="builtintype" id="5026294">error</span><span class="op" id="5026299">(</span><span class="ident" id="5026300">pos</span>&nbsp;<span class="ident" id="5026304">token</span><span class="op" id="5026309">.</span><span class="ident" id="5026310">Pos</span><span class="op" id="5026313">,</span>&nbsp;<span class="ident" id="5026315">msg</span>&nbsp;<span class="builtintype" id="5026319">string</span><span class="op" id="5026325">)</span>&nbsp;<span class="op" id="5026327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026330">p</span><span class="op" id="5026331">.</span><span class="ident" id="5026332">errors</span><span class="op" id="5026338">.</span><span class="ident" id="5026339">Add</span><span class="op" id="5026342">(</span><span class="ident" id="5026343">p</span><span class="op" id="5026344">.</span><span class="ident" id="5026345">fset</span><span class="op" id="5026349">.</span><span class="ident" id="5026350">Position</span><span class="op" id="5026358">(</span><span class="ident" id="5026359">pos</span><span class="op" id="5026362">)</span><span class="op" id="5026363">,</span>&nbsp;<span class="ident" id="5026365">msg</span><span class="op" id="5026368">)</span><br>
<span class="lineno"></span><span class="op" id="5026370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5026373">func</span>&nbsp;<span class="op" id="5026378">(</span><span class="ident" id="5026379">p</span>&nbsp;<span class="op" id="5026381">*</span><span class="ident" id="5026382">pkgBuilder</span><span class="op" id="5026392">)</span>&nbsp;<span class="ident" id="5026394">errorf</span><span class="op" id="5026400">(</span><span class="ident" id="5026401">pos</span>&nbsp;<span class="ident" id="5026405">token</span><span class="op" id="5026410">.</span><span class="ident" id="5026411">Pos</span><span class="op" id="5026414">,</span>&nbsp;<span class="ident" id="5026416">format</span>&nbsp;<span class="builtintype" id="5026423">string</span><span class="op" id="5026429">,</span>&nbsp;<span class="ident" id="5026431">args</span>&nbsp;<span class="op" id="5026436">...</span><span class="keyword" id="5026439">interface</span><span class="op" id="5026448">{</span><span class="op" id="5026449">}</span><span class="op" id="5026450">)</span>&nbsp;<span class="op" id="5026452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026455">p</span><span class="op" id="5026456">.</span><span class="builtintype" id="5026457">error</span><span class="op" id="5026462">(</span><span class="ident" id="5026463">pos</span><span class="op" id="5026466">,</span>&nbsp;<span class="ident" id="5026468">fmt</span><span class="op" id="5026471">.</span><span class="ident" id="5026472">Sprintf</span><span class="op" id="5026479">(</span><span class="ident" id="5026480">format</span><span class="op" id="5026486">,</span>&nbsp;<span class="ident" id="5026488">args</span><span class="op" id="5026492">...</span><span class="op" id="5026495">)</span><span class="op" id="5026496">)</span><br>
<span class="lineno"></span><span class="op" id="5026498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5026501">func</span>&nbsp;<span class="op" id="5026506">(</span><span class="ident" id="5026507">p</span>&nbsp;<span class="op" id="5026509">*</span><span class="ident" id="5026510">pkgBuilder</span><span class="op" id="5026520">)</span>&nbsp;<span class="ident" id="5026522">declare</span><span class="op" id="5026529">(</span><span class="ident" id="5026530">scope</span><span class="op" id="5026535">,</span>&nbsp;<span class="ident" id="5026537">altScope</span>&nbsp;<span class="op" id="5026546">*</span><span class="ident" id="5026547">Scope</span><span class="op" id="5026552">,</span>&nbsp;<span class="ident" id="5026554">obj</span>&nbsp;<span class="op" id="5026558">*</span><span class="ident" id="5026559">Object</span><span class="op" id="5026565">)</span>&nbsp;<span class="op" id="5026567">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026570">alt</span>&nbsp;<span class="op" id="5026574">:=</span>&nbsp;<span class="ident" id="5026577">scope</span><span class="op" id="5026582">.</span><span class="ident" id="5026583">Insert</span><span class="op" id="5026589">(</span><span class="ident" id="5026590">obj</span><span class="op" id="5026593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5026596">if</span>&nbsp;<span class="ident" id="5026599">alt</span>&nbsp;<span class="op" id="5026603">==</span>&nbsp;<span class="builtintype" id="5026606">nil</span>&nbsp;<span class="op" id="5026610">&amp;&amp;</span>&nbsp;<span class="ident" id="5026613">altScope</span>&nbsp;<span class="op" id="5026622">!=</span>&nbsp;<span class="builtintype" id="5026625">nil</span>&nbsp;<span class="op" id="5026629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5026633">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026692">alt</span>&nbsp;<span class="op" id="5026696">=</span>&nbsp;<span class="ident" id="5026698">altScope</span><span class="op" id="5026706">.</span><span class="ident" id="5026707">Lookup</span><span class="op" id="5026713">(</span><span class="ident" id="5026714">obj</span><span class="op" id="5026717">.</span><span class="ident" id="5026718">Name</span><span class="op" id="5026722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5026725">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5026728">if</span>&nbsp;<span class="ident" id="5026731">alt</span>&nbsp;<span class="op" id="5026735">!=</span>&nbsp;<span class="builtintype" id="5026738">nil</span>&nbsp;<span class="op" id="5026742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026746">prevDecl</span>&nbsp;<span class="op" id="5026755">:=</span>&nbsp;<span class="string" id="5026758">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5026763">if</span>&nbsp;<span class="ident" id="5026766">pos</span>&nbsp;<span class="op" id="5026770">:=</span>&nbsp;<span class="ident" id="5026773">alt</span><span class="op" id="5026776">.</span><span class="ident" id="5026777">Pos</span><span class="op" id="5026780">(</span><span class="op" id="5026781">)</span><span class="op" id="5026782">;</span>&nbsp;<span class="ident" id="5026784">pos</span><span class="op" id="5026787">.</span><span class="ident" id="5026788">IsValid</span><span class="op" id="5026795">(</span><span class="op" id="5026796">)</span>&nbsp;<span class="op" id="5026798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026803">prevDecl</span>&nbsp;<span class="op" id="5026812">=</span>&nbsp;<span class="ident" id="5026814">fmt</span><span class="op" id="5026817">.</span><span class="ident" id="5026818">Sprintf</span><span class="op" id="5026825">(</span><span class="string" id="5026826">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="5026858">,</span>&nbsp;<span class="ident" id="5026860">p</span><span class="op" id="5026861">.</span><span class="ident" id="5026862">fset</span><span class="op" id="5026866">.</span><span class="ident" id="5026867">Position</span><span class="op" id="5026875">(</span><span class="ident" id="5026876">pos</span><span class="op" id="5026879">)</span><span class="op" id="5026880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5026884">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5026888">p</span><span class="op" id="5026889">.</span><span class="builtintype" id="5026890">error</span><span class="op" id="5026895">(</span><span class="ident" id="5026896">obj</span><span class="op" id="5026899">.</span><span class="ident" id="5026900">Pos</span><span class="op" id="5026903">(</span><span class="op" id="5026904">)</span><span class="op" id="5026905">,</span>&nbsp;<span class="ident" id="5026907">fmt</span><span class="op" id="5026910">.</span><span class="ident" id="5026911">Sprintf</span><span class="op" id="5026918">(</span><span class="string" id="5026919">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="5026950">,</span>&nbsp;<span class="ident" id="5026952">obj</span><span class="op" id="5026955">.</span><span class="ident" id="5026956">Name</span><span class="op" id="5026960">,</span>&nbsp;<span class="ident" id="5026962">prevDecl</span><span class="op" id="5026970">)</span><span class="op" id="5026971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5026974">}</span><br>
<span class="lineno"></span><span class="op" id="5026976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5026979">func</span>&nbsp;<span class="ident" id="5026984">resolve</span><span class="op" id="5026991">(</span><span class="ident" id="5026992">scope</span>&nbsp;<span class="op" id="5026998">*</span><span class="ident" id="5026999">Scope</span><span class="op" id="5027004">,</span>&nbsp;<span class="ident" id="5027006">ident</span>&nbsp;<span class="op" id="5027012">*</span><span class="ident" id="5027013">Ident</span><span class="op" id="5027018">)</span>&nbsp;<span class="builtintype" id="5027020">bool</span>&nbsp;<span class="op" id="5027025">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5027028">for</span>&nbsp;<span class="op" id="5027032">;</span>&nbsp;<span class="ident" id="5027034">scope</span>&nbsp;<span class="op" id="5027040">!=</span>&nbsp;<span class="builtintype" id="5027043">nil</span><span class="op" id="5027046">;</span>&nbsp;<span class="ident" id="5027048">scope</span>&nbsp;<span class="op" id="5027054">=</span>&nbsp;<span class="ident" id="5027056">scope</span><span class="op" id="5027061">.</span><span class="ident" id="5027062">Outer</span>&nbsp;<span class="op" id="5027068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5027072">if</span>&nbsp;<span class="ident" id="5027075">obj</span>&nbsp;<span class="op" id="5027079">:=</span>&nbsp;<span class="ident" id="5027082">scope</span><span class="op" id="5027087">.</span><span class="ident" id="5027088">Lookup</span><span class="op" id="5027094">(</span><span class="ident" id="5027095">ident</span><span class="op" id="5027100">.</span><span class="ident" id="5027101">Name</span><span class="op" id="5027105">)</span><span class="op" id="5027106">;</span>&nbsp;<span class="ident" id="5027108">obj</span>&nbsp;<span class="op" id="5027112">!=</span>&nbsp;<span class="builtintype" id="5027115">nil</span>&nbsp;<span class="op" id="5027119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5027124">ident</span><span class="op" id="5027129">.</span><span class="ident" id="5027130">Obj</span>&nbsp;<span class="op" id="5027134">=</span>&nbsp;<span class="ident" id="5027136">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5027143">return</span>&nbsp;<span class="builtintype" id="5027150">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5027157">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5027160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5027163">return</span>&nbsp;<span class="builtintype" id="5027170">false</span><br>
<span class="lineno"></span><span class="op" id="5027176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5027179">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="5027236">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="5027294">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="5027344">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5027404">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5027473">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="5027538">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="5027603">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5027667">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="5027682">type</span>&nbsp;<span class="ident" id="5027687">Importer</span>&nbsp;<span class="keyword" id="5027696">func</span><span class="op" id="5027700">(</span><span class="ident" id="5027701">imports</span>&nbsp;<span class="keyword" id="5027709">map</span><span class="op" id="5027712">[</span><span class="builtintype" id="5027713">string</span><span class="op" id="5027719">]</span><span class="op" id="5027720">*</span><span class="ident" id="5027721">Object</span><span class="op" id="5027727">,</span>&nbsp;<span class="ident" id="5027729">path</span>&nbsp;<span class="builtintype" id="5027734">string</span><span class="op" id="5027740">)</span>&nbsp;<span class="op" id="5027742">(</span><span class="ident" id="5027743">pkg</span>&nbsp;<span class="op" id="5027747">*</span><span class="ident" id="5027748">Object</span><span class="op" id="5027754">,</span>&nbsp;<span class="ident" id="5027756">err</span>&nbsp;<span class="builtintype" id="5027760">error</span><span class="op" id="5027765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5027768">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="5027847">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="5027926">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5028006">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="5028083">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="5028160">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5028237">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5028295">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="5028373">//</span><br>
<span class="lineno"></span><span class="keyword" id="5028376">func</span>&nbsp;<span class="ident" id="5028381">NewPackage</span><span class="op" id="5028391">(</span><span class="ident" id="5028392">fset</span>&nbsp;<span class="op" id="5028397">*</span><span class="ident" id="5028398">token</span><span class="op" id="5028403">.</span><span class="ident" id="5028404">FileSet</span><span class="op" id="5028411">,</span>&nbsp;<span class="ident" id="5028413">files</span>&nbsp;<span class="keyword" id="5028419">map</span><span class="op" id="5028422">[</span><span class="builtintype" id="5028423">string</span><span class="op" id="5028429">]</span><span class="op" id="5028430">*</span><span class="ident" id="5028431">File</span><span class="op" id="5028435">,</span>&nbsp;<span class="ident" id="5028437">importer</span>&nbsp;<span class="ident" id="5028446">Importer</span><span class="op" id="5028454">,</span>&nbsp;<span class="ident" id="5028456">universe</span>&nbsp;<span class="op" id="5028465">*</span><span class="ident" id="5028466">Scope</span><span class="op" id="5028471">)</span>&nbsp;<span class="op" id="5028473">(</span><span class="op" id="5028474">*</span><span class="ident" id="5028475">Package</span><span class="op" id="5028482">,</span>&nbsp;<span class="builtintype" id="5028484">error</span><span class="op" id="5028489">)</span>&nbsp;<span class="op" id="5028491">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028494">var</span>&nbsp;<span class="ident" id="5028498">p</span>&nbsp;<span class="ident" id="5028500">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028512">p</span><span class="op" id="5028513">.</span><span class="ident" id="5028514">fset</span>&nbsp;<span class="op" id="5028519">=</span>&nbsp;<span class="ident" id="5028521">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5028528">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028555">pkgName</span>&nbsp;<span class="op" id="5028563">:=</span>&nbsp;<span class="string" id="5028566">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028570">pkgScope</span>&nbsp;<span class="op" id="5028579">:=</span>&nbsp;<span class="ident" id="5028582">NewScope</span><span class="op" id="5028590">(</span><span class="ident" id="5028591">universe</span><span class="op" id="5028599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028602">for</span>&nbsp;<span class="ident" id="5028606">_</span><span class="op" id="5028607">,</span>&nbsp;<span class="ident" id="5028609">file</span>&nbsp;<span class="op" id="5028614">:=</span>&nbsp;<span class="keyword" id="5028617">range</span>&nbsp;<span class="ident" id="5028623">files</span>&nbsp;<span class="op" id="5028629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5028633">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028663">switch</span>&nbsp;<span class="ident" id="5028670">name</span>&nbsp;<span class="op" id="5028675">:=</span>&nbsp;<span class="ident" id="5028678">file</span><span class="op" id="5028682">.</span><span class="ident" id="5028683">Name</span><span class="op" id="5028687">.</span><span class="ident" id="5028688">Name</span><span class="op" id="5028692">;</span>&nbsp;<span class="op" id="5028694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028698">case</span>&nbsp;<span class="ident" id="5028703">pkgName</span>&nbsp;<span class="op" id="5028711">==</span>&nbsp;<span class="string" id="5028714">&#34;&#34;</span><span class="op" id="5028716">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028721">pkgName</span>&nbsp;<span class="op" id="5028729">=</span>&nbsp;<span class="ident" id="5028731">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028738">case</span>&nbsp;<span class="ident" id="5028743">name</span>&nbsp;<span class="op" id="5028748">!=</span>&nbsp;<span class="ident" id="5028751">pkgName</span><span class="op" id="5028758">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028763">p</span><span class="op" id="5028764">.</span><span class="ident" id="5028765">errorf</span><span class="op" id="5028771">(</span><span class="ident" id="5028772">file</span><span class="op" id="5028776">.</span><span class="ident" id="5028777">Package</span><span class="op" id="5028784">,</span>&nbsp;<span class="string" id="5028786">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="5028811">,</span>&nbsp;<span class="ident" id="5028813">name</span><span class="op" id="5028817">,</span>&nbsp;<span class="ident" id="5028819">pkgName</span><span class="op" id="5028826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028831">continue</span>&nbsp;<span class="comment" id="5028840">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5028862">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5028867">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5028920">for</span>&nbsp;<span class="ident" id="5028924">_</span><span class="op" id="5028925">,</span>&nbsp;<span class="ident" id="5028927">obj</span>&nbsp;<span class="op" id="5028931">:=</span>&nbsp;<span class="keyword" id="5028934">range</span>&nbsp;<span class="ident" id="5028940">file</span><span class="op" id="5028944">.</span><span class="ident" id="5028945">Scope</span><span class="op" id="5028950">.</span><span class="ident" id="5028951">Objects</span>&nbsp;<span class="op" id="5028959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5028964">p</span><span class="op" id="5028965">.</span><span class="ident" id="5028966">declare</span><span class="op" id="5028973">(</span><span class="ident" id="5028974">pkgScope</span><span class="op" id="5028982">,</span>&nbsp;<span class="builtintype" id="5028984">nil</span><span class="op" id="5028987">,</span>&nbsp;<span class="ident" id="5028989">obj</span><span class="op" id="5028992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5028996">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5028999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029003">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029073">imports</span>&nbsp;<span class="op" id="5029081">:=</span>&nbsp;<span class="builtinfunc" id="5029084">make</span><span class="op" id="5029088">(</span><span class="keyword" id="5029089">map</span><span class="op" id="5029092">[</span><span class="builtintype" id="5029093">string</span><span class="op" id="5029099">]</span><span class="op" id="5029100">*</span><span class="ident" id="5029101">Object</span><span class="op" id="5029107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029111">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029173">for</span>&nbsp;<span class="ident" id="5029177">_</span><span class="op" id="5029178">,</span>&nbsp;<span class="ident" id="5029180">file</span>&nbsp;<span class="op" id="5029185">:=</span>&nbsp;<span class="keyword" id="5029188">range</span>&nbsp;<span class="ident" id="5029194">files</span>&nbsp;<span class="op" id="5029200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029204">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029258">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029297">if</span>&nbsp;<span class="ident" id="5029300">file</span><span class="op" id="5029304">.</span><span class="ident" id="5029305">Name</span><span class="op" id="5029309">.</span><span class="ident" id="5029310">Name</span>&nbsp;<span class="op" id="5029315">!=</span>&nbsp;<span class="ident" id="5029318">pkgName</span>&nbsp;<span class="op" id="5029326">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029331">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5029342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029347">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029395">importErrors</span>&nbsp;<span class="op" id="5029408">:=</span>&nbsp;<span class="builtintype" id="5029411">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029419">fileScope</span>&nbsp;<span class="op" id="5029429">:=</span>&nbsp;<span class="ident" id="5029432">NewScope</span><span class="op" id="5029440">(</span><span class="ident" id="5029441">pkgScope</span><span class="op" id="5029449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029453">for</span>&nbsp;<span class="ident" id="5029457">_</span><span class="op" id="5029458">,</span>&nbsp;<span class="ident" id="5029460">spec</span>&nbsp;<span class="op" id="5029465">:=</span>&nbsp;<span class="keyword" id="5029468">range</span>&nbsp;<span class="ident" id="5029474">file</span><span class="op" id="5029478">.</span><span class="ident" id="5029479">Imports</span>&nbsp;<span class="op" id="5029487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029492">if</span>&nbsp;<span class="ident" id="5029495">importer</span>&nbsp;<span class="op" id="5029504">==</span>&nbsp;<span class="builtintype" id="5029507">nil</span>&nbsp;<span class="op" id="5029511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029517">importErrors</span>&nbsp;<span class="op" id="5029530">=</span>&nbsp;<span class="builtintype" id="5029532">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029541">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5029553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029558">path</span><span class="op" id="5029562">,</span>&nbsp;<span class="ident" id="5029564">_</span>&nbsp;<span class="op" id="5029566">:=</span>&nbsp;<span class="ident" id="5029569">strconv</span><span class="op" id="5029576">.</span><span class="ident" id="5029577">Unquote</span><span class="op" id="5029584">(</span><span class="ident" id="5029585">spec</span><span class="op" id="5029589">.</span><span class="ident" id="5029590">Path</span><span class="op" id="5029594">.</span><span class="ident" id="5029595">Value</span><span class="op" id="5029600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029605">pkg</span><span class="op" id="5029608">,</span>&nbsp;<span class="ident" id="5029610">err</span>&nbsp;<span class="op" id="5029614">:=</span>&nbsp;<span class="ident" id="5029617">importer</span><span class="op" id="5029625">(</span><span class="ident" id="5029626">imports</span><span class="op" id="5029633">,</span>&nbsp;<span class="ident" id="5029635">path</span><span class="op" id="5029639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029644">if</span>&nbsp;<span class="ident" id="5029647">err</span>&nbsp;<span class="op" id="5029651">!=</span>&nbsp;<span class="builtintype" id="5029654">nil</span>&nbsp;<span class="op" id="5029658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029664">p</span><span class="op" id="5029665">.</span><span class="ident" id="5029666">errorf</span><span class="op" id="5029672">(</span><span class="ident" id="5029673">spec</span><span class="op" id="5029677">.</span><span class="ident" id="5029678">Path</span><span class="op" id="5029682">.</span><span class="ident" id="5029683">Pos</span><span class="op" id="5029686">(</span><span class="op" id="5029687">)</span><span class="op" id="5029688">,</span>&nbsp;<span class="string" id="5029690">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="5029716">,</span>&nbsp;<span class="ident" id="5029718">path</span><span class="op" id="5029722">,</span>&nbsp;<span class="ident" id="5029724">err</span><span class="op" id="5029727">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5029733">importErrors</span>&nbsp;<span class="op" id="5029746">=</span>&nbsp;<span class="builtintype" id="5029748">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5029757">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5029769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029774">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029834">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029895">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5029958">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030007">name</span>&nbsp;<span class="op" id="5030012">:=</span>&nbsp;<span class="ident" id="5030015">pkg</span><span class="op" id="5030018">.</span><span class="ident" id="5030019">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030027">if</span>&nbsp;<span class="ident" id="5030030">spec</span><span class="op" id="5030034">.</span><span class="ident" id="5030035">Name</span>&nbsp;<span class="op" id="5030040">!=</span>&nbsp;<span class="builtintype" id="5030043">nil</span>&nbsp;<span class="op" id="5030047">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030053">name</span>&nbsp;<span class="op" id="5030058">=</span>&nbsp;<span class="ident" id="5030060">spec</span><span class="op" id="5030064">.</span><span class="ident" id="5030065">Name</span><span class="op" id="5030069">.</span><span class="ident" id="5030070">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030084">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030115">if</span>&nbsp;<span class="ident" id="5030118">name</span>&nbsp;<span class="op" id="5030123">==</span>&nbsp;<span class="string" id="5030126">&#34;.&#34;</span>&nbsp;<span class="op" id="5030130">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030136">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030180">for</span>&nbsp;<span class="ident" id="5030184">_</span><span class="op" id="5030185">,</span>&nbsp;<span class="ident" id="5030187">obj</span>&nbsp;<span class="op" id="5030191">:=</span>&nbsp;<span class="keyword" id="5030194">range</span>&nbsp;<span class="ident" id="5030200">pkg</span><span class="op" id="5030203">.</span><span class="ident" id="5030204">Data</span><span class="op" id="5030208">.</span><span class="op" id="5030209">(</span><span class="op" id="5030210">*</span><span class="ident" id="5030211">Scope</span><span class="op" id="5030216">)</span><span class="op" id="5030217">.</span><span class="ident" id="5030218">Objects</span>&nbsp;<span class="op" id="5030226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030233">p</span><span class="op" id="5030234">.</span><span class="ident" id="5030235">declare</span><span class="op" id="5030242">(</span><span class="ident" id="5030243">fileScope</span><span class="op" id="5030252">,</span>&nbsp;<span class="ident" id="5030254">pkgScope</span><span class="op" id="5030262">,</span>&nbsp;<span class="ident" id="5030264">obj</span><span class="op" id="5030267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030278">}</span>&nbsp;<span class="keyword" id="5030280">else</span>&nbsp;<span class="keyword" id="5030285">if</span>&nbsp;<span class="ident" id="5030288">name</span>&nbsp;<span class="op" id="5030293">!=</span>&nbsp;<span class="string" id="5030296">&#34;_&#34;</span>&nbsp;<span class="op" id="5030300">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030306">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030359">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030414">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030471">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030499">obj</span>&nbsp;<span class="op" id="5030503">:=</span>&nbsp;<span class="ident" id="5030506">NewObj</span><span class="op" id="5030512">(</span><span class="ident" id="5030513">Pkg</span><span class="op" id="5030516">,</span>&nbsp;<span class="ident" id="5030518">name</span><span class="op" id="5030522">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030528">obj</span><span class="op" id="5030531">.</span><span class="ident" id="5030532">Decl</span>&nbsp;<span class="op" id="5030537">=</span>&nbsp;<span class="ident" id="5030539">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030548">obj</span><span class="op" id="5030551">.</span><span class="ident" id="5030552">Data</span>&nbsp;<span class="op" id="5030557">=</span>&nbsp;<span class="ident" id="5030559">pkg</span><span class="op" id="5030562">.</span><span class="ident" id="5030563">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030572">p</span><span class="op" id="5030573">.</span><span class="ident" id="5030574">declare</span><span class="op" id="5030581">(</span><span class="ident" id="5030582">fileScope</span><span class="op" id="5030591">,</span>&nbsp;<span class="ident" id="5030593">pkgScope</span><span class="op" id="5030601">,</span>&nbsp;<span class="ident" id="5030603">obj</span><span class="op" id="5030606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030615">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030620">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030645">if</span>&nbsp;<span class="ident" id="5030648">importErrors</span>&nbsp;<span class="op" id="5030661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030666">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030725">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030784">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5030843">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030882">pkgScope</span><span class="op" id="5030890">.</span><span class="ident" id="5030891">Outer</span>&nbsp;<span class="op" id="5030897">=</span>&nbsp;<span class="builtintype" id="5030899">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5030905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030909">i</span>&nbsp;<span class="op" id="5030911">:=</span>&nbsp;<span class="num" id="5030914">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030918">for</span>&nbsp;<span class="ident" id="5030922">_</span><span class="op" id="5030923">,</span>&nbsp;<span class="ident" id="5030925">ident</span>&nbsp;<span class="op" id="5030931">:=</span>&nbsp;<span class="keyword" id="5030934">range</span>&nbsp;<span class="ident" id="5030940">file</span><span class="op" id="5030944">.</span><span class="ident" id="5030945">Unresolved</span>&nbsp;<span class="op" id="5030956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5030961">if</span>&nbsp;<span class="op" id="5030964">!</span><span class="ident" id="5030965">resolve</span><span class="op" id="5030972">(</span><span class="ident" id="5030973">fileScope</span><span class="op" id="5030982">,</span>&nbsp;<span class="ident" id="5030984">ident</span><span class="op" id="5030989">)</span>&nbsp;<span class="op" id="5030991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5030997">p</span><span class="op" id="5030998">.</span><span class="ident" id="5030999">errorf</span><span class="op" id="5031005">(</span><span class="ident" id="5031006">ident</span><span class="op" id="5031011">.</span><span class="ident" id="5031012">Pos</span><span class="op" id="5031015">(</span><span class="op" id="5031016">)</span><span class="op" id="5031017">,</span>&nbsp;<span class="string" id="5031019">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="5031040">,</span>&nbsp;<span class="ident" id="5031042">ident</span><span class="op" id="5031047">.</span><span class="ident" id="5031048">Name</span><span class="op" id="5031052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5031058">file</span><span class="op" id="5031062">.</span><span class="ident" id="5031063">Unresolved</span><span class="op" id="5031073">[</span><span class="ident" id="5031074">i</span><span class="op" id="5031075">]</span>&nbsp;<span class="op" id="5031077">=</span>&nbsp;<span class="ident" id="5031079">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5031089">i</span><span class="op" id="5031090">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5031096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5031101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5031105">file</span><span class="op" id="5031109">.</span><span class="ident" id="5031110">Unresolved</span>&nbsp;<span class="op" id="5031121">=</span>&nbsp;<span class="ident" id="5031123">file</span><span class="op" id="5031127">.</span><span class="ident" id="5031128">Unresolved</span><span class="op" id="5031138">[</span><span class="num" id="5031139">0</span><span class="op" id="5031140">:</span><span class="ident" id="5031141">i</span><span class="op" id="5031142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5031146">pkgScope</span><span class="op" id="5031154">.</span><span class="ident" id="5031155">Outer</span>&nbsp;<span class="op" id="5031161">=</span>&nbsp;<span class="ident" id="5031163">universe</span>&nbsp;<span class="comment" id="5031172">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5031197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5031201">p</span><span class="op" id="5031202">.</span><span class="ident" id="5031203">errors</span><span class="op" id="5031209">.</span><span class="ident" id="5031210">Sort</span><span class="op" id="5031214">(</span><span class="op" id="5031215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5031218">return</span>&nbsp;<span class="op" id="5031225">&amp;</span><span class="ident" id="5031226">Package</span><span class="op" id="5031233">{</span><span class="ident" id="5031234">pkgName</span><span class="op" id="5031241">,</span>&nbsp;<span class="ident" id="5031243">pkgScope</span><span class="op" id="5031251">,</span>&nbsp;<span class="ident" id="5031253">imports</span><span class="op" id="5031260">,</span>&nbsp;<span class="ident" id="5031262">files</span><span class="op" id="5031267">}</span><span class="op" id="5031268">,</span>&nbsp;<span class="ident" id="5031270">p</span><span class="op" id="5031271">.</span><span class="ident" id="5031272">errors</span><span class="op" id="5031278">.</span><span class="ident" id="5031279">Err</span><span class="op" id="5031282">(</span><span class="op" id="5031283">)</span><br>
<span class="lineno"></span><span class="op" id="5031285">}</span>
</div>
</body>
</html>
