<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6879499">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6879554">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6879608">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6879659">package</span>&nbsp;<span class="ident" id="6879667">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879672">import</span>&nbsp;<span class="op" id="6879679">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879682">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879705">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879715">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879722">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879735">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879746">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879757">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879768">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879776">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879787">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6879794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6879797">func</span>&nbsp;<span class="ident" id="6879802">init</span><span class="op" id="6879806">(</span><span class="op" id="6879807">)</span>&nbsp;<span class="op" id="6879809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879812">type</span>&nbsp;<span class="ident" id="6879817">dbConn</span>&nbsp;<span class="keyword" id="6879824">struct</span>&nbsp;<span class="op" id="6879831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879835">db</span>&nbsp;<span class="op" id="6879838">*</span><span class="ident" id="6879839">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879844">c</span>&nbsp;&nbsp;<span class="op" id="6879847">*</span><span class="ident" id="6879848">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879860">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879863">freedFrom</span>&nbsp;<span class="op" id="6879873">:=</span>&nbsp;<span class="builtinfunc" id="6879876">make</span><span class="op" id="6879880">(</span><span class="keyword" id="6879881">map</span><span class="op" id="6879884">[</span><span class="ident" id="6879885">dbConn</span><span class="op" id="6879891">]</span><span class="builtintype" id="6879892">string</span><span class="op" id="6879898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879901">putConnHook</span>&nbsp;<span class="op" id="6879913">=</span>&nbsp;<span class="keyword" id="6879915">func</span><span class="op" id="6879919">(</span><span class="ident" id="6879920">db</span>&nbsp;<span class="op" id="6879923">*</span><span class="ident" id="6879924">DB</span><span class="op" id="6879926">,</span>&nbsp;<span class="ident" id="6879928">c</span>&nbsp;<span class="op" id="6879930">*</span><span class="ident" id="6879931">driverConn</span><span class="op" id="6879941">)</span>&nbsp;<span class="op" id="6879943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879947">idx</span>&nbsp;<span class="op" id="6879951">:=</span>&nbsp;<span class="op" id="6879954">-</span><span class="num" id="6879955">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879959">for</span>&nbsp;<span class="ident" id="6879963">i</span><span class="op" id="6879964">,</span>&nbsp;<span class="ident" id="6879966">v</span>&nbsp;<span class="op" id="6879968">:=</span>&nbsp;<span class="keyword" id="6879971">range</span>&nbsp;<span class="ident" id="6879977">db</span><span class="op" id="6879979">.</span><span class="ident" id="6879980">freeConn</span>&nbsp;<span class="op" id="6879989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879994">if</span>&nbsp;<span class="ident" id="6879997">v</span>&nbsp;<span class="op" id="6879999">==</span>&nbsp;<span class="ident" id="6880002">c</span>&nbsp;<span class="op" id="6880004">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880010">idx</span>&nbsp;<span class="op" id="6880014">=</span>&nbsp;<span class="ident" id="6880016">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880022">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880039">if</span>&nbsp;<span class="ident" id="6880042">idx</span>&nbsp;<span class="op" id="6880046">&gt;=</span>&nbsp;<span class="num" id="6880049">0</span>&nbsp;<span class="op" id="6880051">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6880056">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6880129">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6880196">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6880230">println</span><span class="op" id="6880237">(</span><span class="string" id="6880238">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="6880281">+</span>&nbsp;<span class="ident" id="6880283">freedFrom</span><span class="op" id="6880292">[</span><span class="ident" id="6880293">dbConn</span><span class="op" id="6880299">{</span><span class="ident" id="6880300">db</span><span class="op" id="6880302">,</span>&nbsp;<span class="ident" id="6880304">c</span><span class="op" id="6880305">}</span><span class="op" id="6880306">]</span>&nbsp;<span class="op" id="6880308">+</span>&nbsp;<span class="string" id="6880310">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="6880325">+</span>&nbsp;<span class="ident" id="6880327">stack</span><span class="op" id="6880332">(</span><span class="op" id="6880333">)</span><span class="op" id="6880334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6880339">panic</span><span class="op" id="6880344">(</span><span class="string" id="6880345">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="6880367">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880375">freedFrom</span><span class="op" id="6880384">[</span><span class="ident" id="6880385">dbConn</span><span class="op" id="6880391">{</span><span class="ident" id="6880392">db</span><span class="op" id="6880394">,</span>&nbsp;<span class="ident" id="6880396">c</span><span class="op" id="6880397">}</span><span class="op" id="6880398">]</span>&nbsp;<span class="op" id="6880400">=</span>&nbsp;<span class="ident" id="6880402">stack</span><span class="op" id="6880407">(</span><span class="op" id="6880408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880411">}</span><br>
<span class="lineno"></span><span class="op" id="6880413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="6880416">const</span>&nbsp;<span class="ident" id="6880422">fakeDBName</span>&nbsp;<span class="op" id="6880433">=</span>&nbsp;<span class="string" id="6880435">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6880442">var</span>&nbsp;<span class="ident" id="6880446">chrisBirthday</span>&nbsp;<span class="op" id="6880460">=</span>&nbsp;<span class="ident" id="6880462">time</span><span class="op" id="6880466">.</span><span class="ident" id="6880467">Unix</span><span class="op" id="6880471">(</span><span class="num" id="6880472">123456789</span><span class="op" id="6880481">,</span>&nbsp;<span class="num" id="6880483">0</span><span class="op" id="6880484">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6880487">func</span>&nbsp;<span class="ident" id="6880492">newTestDB</span><span class="op" id="6880501">(</span><span class="ident" id="6880502">t</span>&nbsp;<span class="ident" id="6880504">testing</span><span class="op" id="6880511">.</span><span class="ident" id="6880512">TB</span><span class="op" id="6880514">,</span>&nbsp;<span class="ident" id="6880516">name</span>&nbsp;<span class="builtintype" id="6880521">string</span><span class="op" id="6880527">)</span>&nbsp;<span class="op" id="6880529">*</span><span class="ident" id="6880530">DB</span>&nbsp;<span class="op" id="6880533">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880536">db</span><span class="op" id="6880538">,</span>&nbsp;<span class="ident" id="6880540">err</span>&nbsp;<span class="op" id="6880544">:=</span>&nbsp;<span class="ident" id="6880547">Open</span><span class="op" id="6880551">(</span><span class="string" id="6880552">&#34;test&#34;</span><span class="op" id="6880558">,</span>&nbsp;<span class="ident" id="6880560">fakeDBName</span><span class="op" id="6880570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880573">if</span>&nbsp;<span class="ident" id="6880576">err</span>&nbsp;<span class="op" id="6880580">!=</span>&nbsp;<span class="ident" id="6880583">nil</span>&nbsp;<span class="op" id="6880587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880591">t</span><span class="op" id="6880592">.</span><span class="ident" id="6880593">Fatalf</span><span class="op" id="6880599">(</span><span class="string" id="6880600">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6880610">,</span>&nbsp;<span class="ident" id="6880612">err</span><span class="op" id="6880615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880621">if</span>&nbsp;<span class="ident" id="6880624">_</span><span class="op" id="6880625">,</span>&nbsp;<span class="ident" id="6880627">err</span>&nbsp;<span class="op" id="6880631">:=</span>&nbsp;<span class="ident" id="6880634">db</span><span class="op" id="6880636">.</span><span class="ident" id="6880637">Exec</span><span class="op" id="6880641">(</span><span class="string" id="6880642">&#34;WIPE&#34;</span><span class="op" id="6880648">)</span><span class="op" id="6880649">;</span>&nbsp;<span class="ident" id="6880651">err</span>&nbsp;<span class="op" id="6880655">!=</span>&nbsp;<span class="ident" id="6880658">nil</span>&nbsp;<span class="op" id="6880662">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880666">t</span><span class="op" id="6880667">.</span><span class="ident" id="6880668">Fatalf</span><span class="op" id="6880674">(</span><span class="string" id="6880675">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6880690">,</span>&nbsp;<span class="ident" id="6880692">err</span><span class="op" id="6880695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880701">if</span>&nbsp;<span class="ident" id="6880704">name</span>&nbsp;<span class="op" id="6880709">==</span>&nbsp;<span class="string" id="6880712">&#34;people&#34;</span>&nbsp;<span class="op" id="6880721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880725">exec</span><span class="op" id="6880729">(</span><span class="ident" id="6880730">t</span><span class="op" id="6880731">,</span>&nbsp;<span class="ident" id="6880733">db</span><span class="op" id="6880735">,</span>&nbsp;<span class="string" id="6880737">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="6880810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880814">exec</span><span class="op" id="6880818">(</span><span class="ident" id="6880819">t</span><span class="op" id="6880820">,</span>&nbsp;<span class="ident" id="6880822">db</span><span class="op" id="6880824">,</span>&nbsp;<span class="string" id="6880826">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="6880871">,</span>&nbsp;<span class="num" id="6880873">1</span><span class="op" id="6880874">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880878">exec</span><span class="op" id="6880882">(</span><span class="ident" id="6880883">t</span><span class="op" id="6880884">,</span>&nbsp;<span class="ident" id="6880886">db</span><span class="op" id="6880888">,</span>&nbsp;<span class="string" id="6880890">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="6880933">,</span>&nbsp;<span class="num" id="6880935">2</span><span class="op" id="6880936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880940">exec</span><span class="op" id="6880944">(</span><span class="ident" id="6880945">t</span><span class="op" id="6880946">,</span>&nbsp;<span class="ident" id="6880948">db</span><span class="op" id="6880950">,</span>&nbsp;<span class="string" id="6880952">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6881005">,</span>&nbsp;<span class="num" id="6881007">3</span><span class="op" id="6881008">,</span>&nbsp;<span class="ident" id="6881010">chrisBirthday</span><span class="op" id="6881023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881029">if</span>&nbsp;<span class="ident" id="6881032">name</span>&nbsp;<span class="op" id="6881037">==</span>&nbsp;<span class="string" id="6881040">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6881053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881057">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881116">exec</span><span class="op" id="6881120">(</span><span class="ident" id="6881121">t</span><span class="op" id="6881122">,</span>&nbsp;<span class="ident" id="6881124">db</span><span class="op" id="6881126">,</span>&nbsp;<span class="string" id="6881128">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="6881170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881174">exec</span><span class="op" id="6881178">(</span><span class="ident" id="6881179">t</span><span class="op" id="6881180">,</span>&nbsp;<span class="ident" id="6881182">db</span><span class="op" id="6881184">,</span>&nbsp;<span class="string" id="6881186">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="6881224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881230">return</span>&nbsp;<span class="ident" id="6881237">db</span><br>
<span class="lineno"></span><span class="op" id="6881240">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6881243">func</span>&nbsp;<span class="ident" id="6881248">exec</span><span class="op" id="6881252">(</span><span class="ident" id="6881253">t</span>&nbsp;<span class="ident" id="6881255">testing</span><span class="op" id="6881262">.</span><span class="ident" id="6881263">TB</span><span class="op" id="6881265">,</span>&nbsp;<span class="ident" id="6881267">db</span>&nbsp;<span class="op" id="6881270">*</span><span class="ident" id="6881271">DB</span><span class="op" id="6881273">,</span>&nbsp;<span class="ident" id="6881275">query</span>&nbsp;<span class="builtintype" id="6881281">string</span><span class="op" id="6881287">,</span>&nbsp;<span class="ident" id="6881289">args</span>&nbsp;<span class="op" id="6881294">...</span><span class="keyword" id="6881297">interface</span><span class="op" id="6881306">{</span><span class="op" id="6881307">}</span><span class="op" id="6881308">)</span>&nbsp;<span class="op" id="6881310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881313">_</span><span class="op" id="6881314">,</span>&nbsp;<span class="ident" id="6881316">err</span>&nbsp;<span class="op" id="6881320">:=</span>&nbsp;<span class="ident" id="6881323">db</span><span class="op" id="6881325">.</span><span class="ident" id="6881326">Exec</span><span class="op" id="6881330">(</span><span class="ident" id="6881331">query</span><span class="op" id="6881336">,</span>&nbsp;<span class="ident" id="6881338">args</span><span class="op" id="6881342">...</span><span class="op" id="6881345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881348">if</span>&nbsp;<span class="ident" id="6881351">err</span>&nbsp;<span class="op" id="6881355">!=</span>&nbsp;<span class="ident" id="6881358">nil</span>&nbsp;<span class="op" id="6881362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881366">t</span><span class="op" id="6881367">.</span><span class="ident" id="6881368">Fatalf</span><span class="op" id="6881374">(</span><span class="string" id="6881375">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="6881391">,</span>&nbsp;<span class="ident" id="6881393">query</span><span class="op" id="6881398">,</span>&nbsp;<span class="ident" id="6881400">err</span><span class="op" id="6881403">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881406">}</span><br>
<span class="lineno"></span><span class="op" id="6881408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6881411">func</span>&nbsp;<span class="ident" id="6881416">closeDB</span><span class="op" id="6881423">(</span><span class="ident" id="6881424">t</span>&nbsp;<span class="ident" id="6881426">testing</span><span class="op" id="6881433">.</span><span class="ident" id="6881434">TB</span><span class="op" id="6881436">,</span>&nbsp;<span class="ident" id="6881438">db</span>&nbsp;<span class="op" id="6881441">*</span><span class="ident" id="6881442">DB</span><span class="op" id="6881444">)</span>&nbsp;<span class="op" id="6881446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881449">if</span>&nbsp;<span class="ident" id="6881452">e</span>&nbsp;<span class="op" id="6881454">:=</span>&nbsp;<span class="builtinfunc" id="6881457">recover</span><span class="op" id="6881464">(</span><span class="op" id="6881465">)</span><span class="op" id="6881466">;</span>&nbsp;<span class="ident" id="6881468">e</span>&nbsp;<span class="op" id="6881470">!=</span>&nbsp;<span class="ident" id="6881473">nil</span>&nbsp;<span class="op" id="6881477">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881481">fmt</span><span class="op" id="6881484">.</span><span class="ident" id="6881485">Printf</span><span class="op" id="6881491">(</span><span class="string" id="6881492">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="6881505">,</span>&nbsp;<span class="ident" id="6881507">e</span><span class="op" id="6881508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6881512">panic</span><span class="op" id="6881517">(</span><span class="ident" id="6881518">e</span><span class="op" id="6881519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881525">defer</span>&nbsp;<span class="ident" id="6881531">setHookpostCloseConn</span><span class="op" id="6881551">(</span><span class="ident" id="6881552">nil</span><span class="op" id="6881555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881558">setHookpostCloseConn</span><span class="op" id="6881578">(</span><span class="keyword" id="6881579">func</span><span class="op" id="6881583">(</span><span class="ident" id="6881584">_</span>&nbsp;<span class="op" id="6881586">*</span><span class="ident" id="6881587">fakeConn</span><span class="op" id="6881595">,</span>&nbsp;<span class="ident" id="6881597">err</span>&nbsp;<span class="builtintype" id="6881601">error</span><span class="op" id="6881606">)</span>&nbsp;<span class="op" id="6881608">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881612">if</span>&nbsp;<span class="ident" id="6881615">err</span>&nbsp;<span class="op" id="6881619">!=</span>&nbsp;<span class="ident" id="6881622">nil</span>&nbsp;<span class="op" id="6881626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881631">t</span><span class="op" id="6881632">.</span><span class="ident" id="6881633">Errorf</span><span class="op" id="6881639">(</span><span class="string" id="6881640">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6881668">,</span>&nbsp;<span class="ident" id="6881670">err</span><span class="op" id="6881673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881680">}</span><span class="op" id="6881681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881684">for</span>&nbsp;<span class="ident" id="6881688">i</span><span class="op" id="6881689">,</span>&nbsp;<span class="ident" id="6881691">dc</span>&nbsp;<span class="op" id="6881694">:=</span>&nbsp;<span class="keyword" id="6881697">range</span>&nbsp;<span class="ident" id="6881703">db</span><span class="op" id="6881705">.</span><span class="ident" id="6881706">freeConn</span>&nbsp;<span class="op" id="6881715">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881719">if</span>&nbsp;<span class="ident" id="6881722">n</span>&nbsp;<span class="op" id="6881724">:=</span>&nbsp;<span class="builtinfunc" id="6881727">len</span><span class="op" id="6881730">(</span><span class="ident" id="6881731">dc</span><span class="op" id="6881733">.</span><span class="ident" id="6881734">openStmt</span><span class="op" id="6881742">)</span><span class="op" id="6881743">;</span>&nbsp;<span class="ident" id="6881745">n</span>&nbsp;<span class="op" id="6881747">&gt;</span>&nbsp;<span class="num" id="6881749">0</span>&nbsp;<span class="op" id="6881751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881756">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881800">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881849">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881898">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6881945">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881974">t</span><span class="op" id="6881975">.</span><span class="ident" id="6881976">Errorf</span><span class="op" id="6881982">(</span><span class="string" id="6881983">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6882043">,</span>&nbsp;<span class="ident" id="6882045">i</span><span class="op" id="6882046">,</span>&nbsp;<span class="builtinfunc" id="6882048">len</span><span class="op" id="6882051">(</span><span class="ident" id="6882052">db</span><span class="op" id="6882054">.</span><span class="ident" id="6882055">freeConn</span><span class="op" id="6882063">)</span><span class="op" id="6882064">,</span>&nbsp;<span class="ident" id="6882066">n</span><span class="op" id="6882067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882077">err</span>&nbsp;<span class="op" id="6882081">:=</span>&nbsp;<span class="ident" id="6882084">db</span><span class="op" id="6882086">.</span><span class="ident" id="6882087">Close</span><span class="op" id="6882092">(</span><span class="op" id="6882093">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882096">if</span>&nbsp;<span class="ident" id="6882099">err</span>&nbsp;<span class="op" id="6882103">!=</span>&nbsp;<span class="ident" id="6882106">nil</span>&nbsp;<span class="op" id="6882110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882114">t</span><span class="op" id="6882115">.</span><span class="ident" id="6882116">Fatalf</span><span class="op" id="6882122">(</span><span class="string" id="6882123">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="6882145">,</span>&nbsp;<span class="ident" id="6882147">err</span><span class="op" id="6882150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882156">db</span><span class="op" id="6882158">.</span><span class="ident" id="6882159">mu</span><span class="op" id="6882161">.</span><span class="ident" id="6882162">Lock</span><span class="op" id="6882166">(</span><span class="op" id="6882167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882170">count</span>&nbsp;<span class="op" id="6882176">:=</span>&nbsp;<span class="ident" id="6882179">db</span><span class="op" id="6882181">.</span><span class="ident" id="6882182">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882191">db</span><span class="op" id="6882193">.</span><span class="ident" id="6882194">mu</span><span class="op" id="6882196">.</span><span class="ident" id="6882197">Unlock</span><span class="op" id="6882203">(</span><span class="op" id="6882204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882207">if</span>&nbsp;<span class="ident" id="6882210">count</span>&nbsp;<span class="op" id="6882216">!=</span>&nbsp;<span class="num" id="6882219">0</span>&nbsp;<span class="op" id="6882221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882225">t</span><span class="op" id="6882226">.</span><span class="ident" id="6882227">Fatalf</span><span class="op" id="6882233">(</span><span class="string" id="6882234">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="6882278">,</span>&nbsp;<span class="ident" id="6882280">db</span><span class="op" id="6882282">.</span><span class="ident" id="6882283">numOpen</span><span class="op" id="6882290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882293">}</span><br>
<span class="lineno"></span><span class="op" id="6882295">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="6882298">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="6882365">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="6882398">func</span>&nbsp;<span class="ident" id="6882403">numPrepares</span><span class="op" id="6882414">(</span><span class="ident" id="6882415">t</span>&nbsp;<span class="op" id="6882417">*</span><span class="ident" id="6882418">testing</span><span class="op" id="6882425">.</span><span class="ident" id="6882426">T</span><span class="op" id="6882427">,</span>&nbsp;<span class="ident" id="6882429">db</span>&nbsp;<span class="op" id="6882432">*</span><span class="ident" id="6882433">DB</span><span class="op" id="6882435">)</span>&nbsp;<span class="builtintype" id="6882437">int</span>&nbsp;<span class="op" id="6882441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882444">if</span>&nbsp;<span class="ident" id="6882447">n</span>&nbsp;<span class="op" id="6882449">:=</span>&nbsp;<span class="builtinfunc" id="6882452">len</span><span class="op" id="6882455">(</span><span class="ident" id="6882456">db</span><span class="op" id="6882458">.</span><span class="ident" id="6882459">freeConn</span><span class="op" id="6882467">)</span><span class="op" id="6882468">;</span>&nbsp;<span class="ident" id="6882470">n</span>&nbsp;<span class="op" id="6882472">!=</span>&nbsp;<span class="num" id="6882475">1</span>&nbsp;<span class="op" id="6882477">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882481">t</span><span class="op" id="6882482">.</span><span class="ident" id="6882483">Fatalf</span><span class="op" id="6882489">(</span><span class="string" id="6882490">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6882515">,</span>&nbsp;<span class="ident" id="6882517">n</span><span class="op" id="6882518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882524">return</span>&nbsp;<span class="ident" id="6882531">db</span><span class="op" id="6882533">.</span><span class="ident" id="6882534">freeConn</span><span class="op" id="6882542">[</span><span class="num" id="6882543">0</span><span class="op" id="6882544">]</span><span class="op" id="6882545">.</span><span class="ident" id="6882546">ci</span><span class="op" id="6882548">.</span><span class="op" id="6882549">(</span><span class="op" id="6882550">*</span><span class="ident" id="6882551">fakeConn</span><span class="op" id="6882559">)</span><span class="op" id="6882560">.</span><span class="ident" id="6882561">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="6882572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="6882575">func</span>&nbsp;<span class="op" id="6882580">(</span><span class="ident" id="6882581">db</span>&nbsp;<span class="op" id="6882584">*</span><span class="ident" id="6882585">DB</span><span class="op" id="6882587">)</span>&nbsp;<span class="ident" id="6882589">numDeps</span><span class="op" id="6882596">(</span><span class="op" id="6882597">)</span>&nbsp;<span class="builtintype" id="6882599">int</span>&nbsp;<span class="op" id="6882603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882606">db</span><span class="op" id="6882608">.</span><span class="ident" id="6882609">mu</span><span class="op" id="6882611">.</span><span class="ident" id="6882612">Lock</span><span class="op" id="6882616">(</span><span class="op" id="6882617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882620">defer</span>&nbsp;<span class="ident" id="6882626">db</span><span class="op" id="6882628">.</span><span class="ident" id="6882629">mu</span><span class="op" id="6882631">.</span><span class="ident" id="6882632">Unlock</span><span class="op" id="6882638">(</span><span class="op" id="6882639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882642">return</span>&nbsp;<span class="builtinfunc" id="6882649">len</span><span class="op" id="6882652">(</span><span class="ident" id="6882653">db</span><span class="op" id="6882655">.</span><span class="ident" id="6882656">dep</span><span class="op" id="6882659">)</span><br>
<span class="lineno"></span><span class="op" id="6882661">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="6882664">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6882734">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="6882779">func</span>&nbsp;<span class="op" id="6882784">(</span><span class="ident" id="6882785">db</span>&nbsp;<span class="op" id="6882788">*</span><span class="ident" id="6882789">DB</span><span class="op" id="6882791">)</span>&nbsp;<span class="ident" id="6882793">numDepsPollUntil</span><span class="op" id="6882809">(</span><span class="ident" id="6882810">want</span>&nbsp;<span class="builtintype" id="6882815">int</span><span class="op" id="6882818">,</span>&nbsp;<span class="ident" id="6882820">d</span>&nbsp;<span class="ident" id="6882822">time</span><span class="op" id="6882826">.</span><span class="ident" id="6882827">Duration</span><span class="op" id="6882835">)</span>&nbsp;<span class="builtintype" id="6882837">int</span>&nbsp;<span class="op" id="6882841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882844">deadline</span>&nbsp;<span class="op" id="6882853">:=</span>&nbsp;<span class="ident" id="6882856">time</span><span class="op" id="6882860">.</span><span class="ident" id="6882861">Now</span><span class="op" id="6882864">(</span><span class="op" id="6882865">)</span><span class="op" id="6882866">.</span><span class="ident" id="6882867">Add</span><span class="op" id="6882870">(</span><span class="ident" id="6882871">d</span><span class="op" id="6882872">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882875">for</span>&nbsp;<span class="op" id="6882879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882883">n</span>&nbsp;<span class="op" id="6882885">:=</span>&nbsp;<span class="ident" id="6882888">db</span><span class="op" id="6882890">.</span><span class="ident" id="6882891">numDeps</span><span class="op" id="6882898">(</span><span class="op" id="6882899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882903">if</span>&nbsp;<span class="ident" id="6882906">n</span>&nbsp;<span class="op" id="6882908">&lt;=</span>&nbsp;<span class="ident" id="6882911">want</span>&nbsp;<span class="op" id="6882916">||</span>&nbsp;<span class="ident" id="6882919">time</span><span class="op" id="6882923">.</span><span class="ident" id="6882924">Now</span><span class="op" id="6882927">(</span><span class="op" id="6882928">)</span><span class="op" id="6882929">.</span><span class="ident" id="6882930">After</span><span class="op" id="6882935">(</span><span class="ident" id="6882936">deadline</span><span class="op" id="6882944">)</span>&nbsp;<span class="op" id="6882946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882951">return</span>&nbsp;<span class="ident" id="6882958">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882962">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882966">time</span><span class="op" id="6882970">.</span><span class="ident" id="6882971">Sleep</span><span class="op" id="6882976">(</span><span class="num" id="6882977">50</span>&nbsp;<span class="op" id="6882980">*</span>&nbsp;<span class="ident" id="6882982">time</span><span class="op" id="6882986">.</span><span class="ident" id="6882987">Millisecond</span><span class="op" id="6882998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883001">}</span><br>
<span class="lineno"></span><span class="op" id="6883003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6883006">func</span>&nbsp;<span class="op" id="6883011">(</span><span class="ident" id="6883012">db</span>&nbsp;<span class="op" id="6883015">*</span><span class="ident" id="6883016">DB</span><span class="op" id="6883018">)</span>&nbsp;<span class="ident" id="6883020">numFreeConns</span><span class="op" id="6883032">(</span><span class="op" id="6883033">)</span>&nbsp;<span class="builtintype" id="6883035">int</span>&nbsp;<span class="op" id="6883039">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883042">db</span><span class="op" id="6883044">.</span><span class="ident" id="6883045">mu</span><span class="op" id="6883047">.</span><span class="ident" id="6883048">Lock</span><span class="op" id="6883052">(</span><span class="op" id="6883053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883056">defer</span>&nbsp;<span class="ident" id="6883062">db</span><span class="op" id="6883064">.</span><span class="ident" id="6883065">mu</span><span class="op" id="6883067">.</span><span class="ident" id="6883068">Unlock</span><span class="op" id="6883074">(</span><span class="op" id="6883075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883078">return</span>&nbsp;<span class="builtinfunc" id="6883085">len</span><span class="op" id="6883088">(</span><span class="ident" id="6883089">db</span><span class="op" id="6883091">.</span><span class="ident" id="6883092">freeConn</span><span class="op" id="6883100">)</span><br>
<span class="lineno"></span><span class="op" id="6883102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6883105">func</span>&nbsp;<span class="op" id="6883110">(</span><span class="ident" id="6883111">db</span>&nbsp;<span class="op" id="6883114">*</span><span class="ident" id="6883115">DB</span><span class="op" id="6883117">)</span>&nbsp;<span class="ident" id="6883119">dumpDeps</span><span class="op" id="6883127">(</span><span class="ident" id="6883128">t</span>&nbsp;<span class="op" id="6883130">*</span><span class="ident" id="6883131">testing</span><span class="op" id="6883138">.</span><span class="ident" id="6883139">T</span><span class="op" id="6883140">)</span>&nbsp;<span class="op" id="6883142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883145">for</span>&nbsp;<span class="ident" id="6883149">fc</span>&nbsp;<span class="op" id="6883152">:=</span>&nbsp;<span class="keyword" id="6883155">range</span>&nbsp;<span class="ident" id="6883161">db</span><span class="op" id="6883163">.</span><span class="ident" id="6883164">dep</span>&nbsp;<span class="op" id="6883168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883172">db</span><span class="op" id="6883174">.</span><span class="ident" id="6883175">dumpDep</span><span class="op" id="6883182">(</span><span class="ident" id="6883183">t</span><span class="op" id="6883184">,</span>&nbsp;<span class="num" id="6883186">0</span><span class="op" id="6883187">,</span>&nbsp;<span class="ident" id="6883189">fc</span><span class="op" id="6883191">,</span>&nbsp;<span class="keyword" id="6883193">map</span><span class="op" id="6883196">[</span><span class="ident" id="6883197">finalCloser</span><span class="op" id="6883208">]</span><span class="builtintype" id="6883209">bool</span><span class="op" id="6883213">{</span><span class="op" id="6883214">}</span><span class="op" id="6883215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883218">}</span><br>
<span class="lineno"></span><span class="op" id="6883220">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="6883223">func</span>&nbsp;<span class="op" id="6883228">(</span><span class="ident" id="6883229">db</span>&nbsp;<span class="op" id="6883232">*</span><span class="ident" id="6883233">DB</span><span class="op" id="6883235">)</span>&nbsp;<span class="ident" id="6883237">dumpDep</span><span class="op" id="6883244">(</span><span class="ident" id="6883245">t</span>&nbsp;<span class="op" id="6883247">*</span><span class="ident" id="6883248">testing</span><span class="op" id="6883255">.</span><span class="ident" id="6883256">T</span><span class="op" id="6883257">,</span>&nbsp;<span class="ident" id="6883259">depth</span>&nbsp;<span class="builtintype" id="6883265">int</span><span class="op" id="6883268">,</span>&nbsp;<span class="ident" id="6883270">dep</span>&nbsp;<span class="ident" id="6883274">finalCloser</span><span class="op" id="6883285">,</span>&nbsp;<span class="ident" id="6883287">seen</span>&nbsp;<span class="keyword" id="6883292">map</span><span class="op" id="6883295">[</span><span class="ident" id="6883296">finalCloser</span><span class="op" id="6883307">]</span><span class="builtintype" id="6883308">bool</span><span class="op" id="6883312">)</span>&nbsp;<span class="op" id="6883314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883317">seen</span><span class="op" id="6883321">[</span><span class="ident" id="6883322">dep</span><span class="op" id="6883325">]</span>&nbsp;<span class="op" id="6883327">=</span>&nbsp;<span class="builtintype" id="6883329">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883335">indent</span>&nbsp;<span class="op" id="6883342">:=</span>&nbsp;<span class="ident" id="6883345">strings</span><span class="op" id="6883352">.</span><span class="ident" id="6883353">Repeat</span><span class="op" id="6883359">(</span><span class="string" id="6883360">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="6883364">,</span>&nbsp;<span class="ident" id="6883366">depth</span><span class="op" id="6883371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883374">ds</span>&nbsp;<span class="op" id="6883377">:=</span>&nbsp;<span class="ident" id="6883380">db</span><span class="op" id="6883382">.</span><span class="ident" id="6883383">dep</span><span class="op" id="6883386">[</span><span class="ident" id="6883387">dep</span><span class="op" id="6883390">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883393">for</span>&nbsp;<span class="ident" id="6883397">k</span>&nbsp;<span class="op" id="6883399">:=</span>&nbsp;<span class="keyword" id="6883402">range</span>&nbsp;<span class="ident" id="6883408">ds</span>&nbsp;<span class="op" id="6883411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883415">t</span><span class="op" id="6883416">.</span><span class="ident" id="6883417">Logf</span><span class="op" id="6883421">(</span><span class="string" id="6883422">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="6883456">,</span>&nbsp;<span class="ident" id="6883458">indent</span><span class="op" id="6883464">,</span>&nbsp;<span class="ident" id="6883466">dep</span><span class="op" id="6883469">,</span>&nbsp;<span class="ident" id="6883471">dep</span><span class="op" id="6883474">,</span>&nbsp;<span class="ident" id="6883476">k</span><span class="op" id="6883477">,</span>&nbsp;<span class="ident" id="6883479">k</span><span class="op" id="6883480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883484">if</span>&nbsp;<span class="ident" id="6883487">fc</span><span class="op" id="6883489">,</span>&nbsp;<span class="ident" id="6883491">ok</span>&nbsp;<span class="op" id="6883494">:=</span>&nbsp;<span class="ident" id="6883497">k</span><span class="op" id="6883498">.</span><span class="op" id="6883499">(</span><span class="ident" id="6883500">finalCloser</span><span class="op" id="6883511">)</span><span class="op" id="6883512">;</span>&nbsp;<span class="ident" id="6883514">ok</span>&nbsp;<span class="op" id="6883517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883522">if</span>&nbsp;<span class="op" id="6883525">!</span><span class="ident" id="6883526">seen</span><span class="op" id="6883530">[</span><span class="ident" id="6883531">fc</span><span class="op" id="6883533">]</span>&nbsp;<span class="op" id="6883535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883541">db</span><span class="op" id="6883543">.</span><span class="ident" id="6883544">dumpDep</span><span class="op" id="6883551">(</span><span class="ident" id="6883552">t</span><span class="op" id="6883553">,</span>&nbsp;<span class="ident" id="6883555">depth</span><span class="op" id="6883560">+</span><span class="num" id="6883561">1</span><span class="op" id="6883562">,</span>&nbsp;<span class="ident" id="6883564">fc</span><span class="op" id="6883566">,</span>&nbsp;<span class="ident" id="6883568">seen</span><span class="op" id="6883572">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883584">}</span><br>
<span class="lineno"></span><span class="op" id="6883586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6883589">func</span>&nbsp;<span class="ident" id="6883594">TestQuery</span><span class="op" id="6883603">(</span><span class="ident" id="6883604">t</span>&nbsp;<span class="op" id="6883606">*</span><span class="ident" id="6883607">testing</span><span class="op" id="6883614">.</span><span class="ident" id="6883615">T</span><span class="op" id="6883616">)</span>&nbsp;<span class="op" id="6883618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883621">db</span>&nbsp;<span class="op" id="6883624">:=</span>&nbsp;<span class="ident" id="6883627">newTestDB</span><span class="op" id="6883636">(</span><span class="ident" id="6883637">t</span><span class="op" id="6883638">,</span>&nbsp;<span class="string" id="6883640">&#34;people&#34;</span><span class="op" id="6883648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883651">defer</span>&nbsp;<span class="ident" id="6883657">closeDB</span><span class="op" id="6883664">(</span><span class="ident" id="6883665">t</span><span class="op" id="6883666">,</span>&nbsp;<span class="ident" id="6883668">db</span><span class="op" id="6883670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883673">prepares0</span>&nbsp;<span class="op" id="6883683">:=</span>&nbsp;<span class="ident" id="6883686">numPrepares</span><span class="op" id="6883697">(</span><span class="ident" id="6883698">t</span><span class="op" id="6883699">,</span>&nbsp;<span class="ident" id="6883701">db</span><span class="op" id="6883703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883706">rows</span><span class="op" id="6883710">,</span>&nbsp;<span class="ident" id="6883712">err</span>&nbsp;<span class="op" id="6883716">:=</span>&nbsp;<span class="ident" id="6883719">db</span><span class="op" id="6883721">.</span><span class="ident" id="6883722">Query</span><span class="op" id="6883727">(</span><span class="string" id="6883728">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6883753">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883756">if</span>&nbsp;<span class="ident" id="6883759">err</span>&nbsp;<span class="op" id="6883763">!=</span>&nbsp;<span class="ident" id="6883766">nil</span>&nbsp;<span class="op" id="6883770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883774">t</span><span class="op" id="6883775">.</span><span class="ident" id="6883776">Fatalf</span><span class="op" id="6883782">(</span><span class="string" id="6883783">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6883794">,</span>&nbsp;<span class="ident" id="6883796">err</span><span class="op" id="6883799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883805">type</span>&nbsp;<span class="ident" id="6883810">row</span>&nbsp;<span class="keyword" id="6883814">struct</span>&nbsp;<span class="op" id="6883821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883825">age</span>&nbsp;&nbsp;<span class="builtintype" id="6883830">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883836">name</span>&nbsp;<span class="builtintype" id="6883841">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883852">got</span>&nbsp;<span class="op" id="6883856">:=</span>&nbsp;<span class="op" id="6883859">[</span><span class="op" id="6883860">]</span><span class="ident" id="6883861">row</span><span class="op" id="6883864">{</span><span class="op" id="6883865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883868">for</span>&nbsp;<span class="ident" id="6883872">rows</span><span class="op" id="6883876">.</span><span class="ident" id="6883877">Next</span><span class="op" id="6883881">(</span><span class="op" id="6883882">)</span>&nbsp;<span class="op" id="6883884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883888">var</span>&nbsp;<span class="ident" id="6883892">r</span>&nbsp;<span class="ident" id="6883894">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883900">err</span>&nbsp;<span class="op" id="6883904">=</span>&nbsp;<span class="ident" id="6883906">rows</span><span class="op" id="6883910">.</span><span class="ident" id="6883911">Scan</span><span class="op" id="6883915">(</span><span class="op" id="6883916">&amp;</span><span class="ident" id="6883917">r</span><span class="op" id="6883918">.</span><span class="ident" id="6883919">age</span><span class="op" id="6883922">,</span>&nbsp;<span class="op" id="6883924">&amp;</span><span class="ident" id="6883925">r</span><span class="op" id="6883926">.</span><span class="ident" id="6883927">name</span><span class="op" id="6883931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883935">if</span>&nbsp;<span class="ident" id="6883938">err</span>&nbsp;<span class="op" id="6883942">!=</span>&nbsp;<span class="ident" id="6883945">nil</span>&nbsp;<span class="op" id="6883949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883954">t</span><span class="op" id="6883955">.</span><span class="ident" id="6883956">Fatalf</span><span class="op" id="6883962">(</span><span class="string" id="6883963">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6883973">,</span>&nbsp;<span class="ident" id="6883975">err</span><span class="op" id="6883978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883986">got</span>&nbsp;<span class="op" id="6883990">=</span>&nbsp;<span class="builtinfunc" id="6883992">append</span><span class="op" id="6883998">(</span><span class="ident" id="6883999">got</span><span class="op" id="6884002">,</span>&nbsp;<span class="ident" id="6884004">r</span><span class="op" id="6884005">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884011">err</span>&nbsp;<span class="op" id="6884015">=</span>&nbsp;<span class="ident" id="6884017">rows</span><span class="op" id="6884021">.</span><span class="ident" id="6884022">Err</span><span class="op" id="6884025">(</span><span class="op" id="6884026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884029">if</span>&nbsp;<span class="ident" id="6884032">err</span>&nbsp;<span class="op" id="6884036">!=</span>&nbsp;<span class="ident" id="6884039">nil</span>&nbsp;<span class="op" id="6884043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884047">t</span><span class="op" id="6884048">.</span><span class="ident" id="6884049">Fatalf</span><span class="op" id="6884055">(</span><span class="string" id="6884056">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="6884065">,</span>&nbsp;<span class="ident" id="6884067">err</span><span class="op" id="6884070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884073">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884076">want</span>&nbsp;<span class="op" id="6884081">:=</span>&nbsp;<span class="op" id="6884084">[</span><span class="op" id="6884085">]</span><span class="ident" id="6884086">row</span><span class="op" id="6884089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884093">{</span><span class="ident" id="6884094">age</span><span class="op" id="6884097">:</span>&nbsp;<span class="num" id="6884099">1</span><span class="op" id="6884100">,</span>&nbsp;<span class="ident" id="6884102">name</span><span class="op" id="6884106">:</span>&nbsp;<span class="string" id="6884108">&#34;Alice&#34;</span><span class="op" id="6884115">}</span><span class="op" id="6884116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884120">{</span><span class="ident" id="6884121">age</span><span class="op" id="6884124">:</span>&nbsp;<span class="num" id="6884126">2</span><span class="op" id="6884127">,</span>&nbsp;<span class="ident" id="6884129">name</span><span class="op" id="6884133">:</span>&nbsp;<span class="string" id="6884135">&#34;Bob&#34;</span><span class="op" id="6884140">}</span><span class="op" id="6884141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884145">{</span><span class="ident" id="6884146">age</span><span class="op" id="6884149">:</span>&nbsp;<span class="num" id="6884151">3</span><span class="op" id="6884152">,</span>&nbsp;<span class="ident" id="6884154">name</span><span class="op" id="6884158">:</span>&nbsp;<span class="string" id="6884160">&#34;Chris&#34;</span><span class="op" id="6884167">}</span><span class="op" id="6884168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884171">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884174">if</span>&nbsp;<span class="op" id="6884177">!</span><span class="ident" id="6884178">reflect</span><span class="op" id="6884185">.</span><span class="ident" id="6884186">DeepEqual</span><span class="op" id="6884195">(</span><span class="ident" id="6884196">got</span><span class="op" id="6884199">,</span>&nbsp;<span class="ident" id="6884201">want</span><span class="op" id="6884205">)</span>&nbsp;<span class="op" id="6884207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884211">t</span><span class="op" id="6884212">.</span><span class="ident" id="6884213">Errorf</span><span class="op" id="6884219">(</span><span class="string" id="6884220">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6884253">,</span>&nbsp;<span class="ident" id="6884255">got</span><span class="op" id="6884258">,</span>&nbsp;<span class="ident" id="6884260">want</span><span class="op" id="6884264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884271">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884334">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884371">if</span>&nbsp;<span class="ident" id="6884374">n</span>&nbsp;<span class="op" id="6884376">:=</span>&nbsp;<span class="ident" id="6884379">db</span><span class="op" id="6884381">.</span><span class="ident" id="6884382">numFreeConns</span><span class="op" id="6884394">(</span><span class="op" id="6884395">)</span><span class="op" id="6884396">;</span>&nbsp;<span class="ident" id="6884398">n</span>&nbsp;<span class="op" id="6884400">!=</span>&nbsp;<span class="num" id="6884403">1</span>&nbsp;<span class="op" id="6884405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884409">t</span><span class="op" id="6884410">.</span><span class="ident" id="6884411">Fatalf</span><span class="op" id="6884417">(</span><span class="string" id="6884418">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6884467">,</span>&nbsp;<span class="ident" id="6884469">n</span><span class="op" id="6884470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884476">if</span>&nbsp;<span class="ident" id="6884479">prepares</span>&nbsp;<span class="op" id="6884488">:=</span>&nbsp;<span class="ident" id="6884491">numPrepares</span><span class="op" id="6884502">(</span><span class="ident" id="6884503">t</span><span class="op" id="6884504">,</span>&nbsp;<span class="ident" id="6884506">db</span><span class="op" id="6884508">)</span>&nbsp;<span class="op" id="6884510">-</span>&nbsp;<span class="ident" id="6884512">prepares0</span><span class="op" id="6884521">;</span>&nbsp;<span class="ident" id="6884523">prepares</span>&nbsp;<span class="op" id="6884532">!=</span>&nbsp;<span class="num" id="6884535">1</span>&nbsp;<span class="op" id="6884537">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884541">t</span><span class="op" id="6884542">.</span><span class="ident" id="6884543">Errorf</span><span class="op" id="6884549">(</span><span class="string" id="6884550">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6884590">,</span>&nbsp;<span class="ident" id="6884592">prepares</span><span class="op" id="6884600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884603">}</span><br>
<span class="lineno"></span><span class="op" id="6884605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884608">func</span>&nbsp;<span class="ident" id="6884613">TestByteOwnership</span><span class="op" id="6884630">(</span><span class="ident" id="6884631">t</span>&nbsp;<span class="op" id="6884633">*</span><span class="ident" id="6884634">testing</span><span class="op" id="6884641">.</span><span class="ident" id="6884642">T</span><span class="op" id="6884643">)</span>&nbsp;<span class="op" id="6884645">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884648">db</span>&nbsp;<span class="op" id="6884651">:=</span>&nbsp;<span class="ident" id="6884654">newTestDB</span><span class="op" id="6884663">(</span><span class="ident" id="6884664">t</span><span class="op" id="6884665">,</span>&nbsp;<span class="string" id="6884667">&#34;people&#34;</span><span class="op" id="6884675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884678">defer</span>&nbsp;<span class="ident" id="6884684">closeDB</span><span class="op" id="6884691">(</span><span class="ident" id="6884692">t</span><span class="op" id="6884693">,</span>&nbsp;<span class="ident" id="6884695">db</span><span class="op" id="6884697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884700">rows</span><span class="op" id="6884704">,</span>&nbsp;<span class="ident" id="6884706">err</span>&nbsp;<span class="op" id="6884710">:=</span>&nbsp;<span class="ident" id="6884713">db</span><span class="op" id="6884715">.</span><span class="ident" id="6884716">Query</span><span class="op" id="6884721">(</span><span class="string" id="6884722">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="6884749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884752">if</span>&nbsp;<span class="ident" id="6884755">err</span>&nbsp;<span class="op" id="6884759">!=</span>&nbsp;<span class="ident" id="6884762">nil</span>&nbsp;<span class="op" id="6884766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884770">t</span><span class="op" id="6884771">.</span><span class="ident" id="6884772">Fatalf</span><span class="op" id="6884778">(</span><span class="string" id="6884779">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6884790">,</span>&nbsp;<span class="ident" id="6884792">err</span><span class="op" id="6884795">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884801">type</span>&nbsp;<span class="ident" id="6884806">row</span>&nbsp;<span class="keyword" id="6884810">struct</span>&nbsp;<span class="op" id="6884817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884821">name</span>&nbsp;&nbsp;<span class="op" id="6884827">[</span><span class="op" id="6884828">]</span><span class="builtintype" id="6884829">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884836">photo</span>&nbsp;<span class="ident" id="6884842">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884852">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884855">got</span>&nbsp;<span class="op" id="6884859">:=</span>&nbsp;<span class="op" id="6884862">[</span><span class="op" id="6884863">]</span><span class="ident" id="6884864">row</span><span class="op" id="6884867">{</span><span class="op" id="6884868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884871">for</span>&nbsp;<span class="ident" id="6884875">rows</span><span class="op" id="6884879">.</span><span class="ident" id="6884880">Next</span><span class="op" id="6884884">(</span><span class="op" id="6884885">)</span>&nbsp;<span class="op" id="6884887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884891">var</span>&nbsp;<span class="ident" id="6884895">r</span>&nbsp;<span class="ident" id="6884897">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884903">err</span>&nbsp;<span class="op" id="6884907">=</span>&nbsp;<span class="ident" id="6884909">rows</span><span class="op" id="6884913">.</span><span class="ident" id="6884914">Scan</span><span class="op" id="6884918">(</span><span class="op" id="6884919">&amp;</span><span class="ident" id="6884920">r</span><span class="op" id="6884921">.</span><span class="ident" id="6884922">name</span><span class="op" id="6884926">,</span>&nbsp;<span class="op" id="6884928">&amp;</span><span class="ident" id="6884929">r</span><span class="op" id="6884930">.</span><span class="ident" id="6884931">photo</span><span class="op" id="6884936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884940">if</span>&nbsp;<span class="ident" id="6884943">err</span>&nbsp;<span class="op" id="6884947">!=</span>&nbsp;<span class="ident" id="6884950">nil</span>&nbsp;<span class="op" id="6884954">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884959">t</span><span class="op" id="6884960">.</span><span class="ident" id="6884961">Fatalf</span><span class="op" id="6884967">(</span><span class="string" id="6884968">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="6884978">,</span>&nbsp;<span class="ident" id="6884980">err</span><span class="op" id="6884983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884991">got</span>&nbsp;<span class="op" id="6884995">=</span>&nbsp;<span class="builtinfunc" id="6884997">append</span><span class="op" id="6885003">(</span><span class="ident" id="6885004">got</span><span class="op" id="6885007">,</span>&nbsp;<span class="ident" id="6885009">r</span><span class="op" id="6885010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885016">corruptMemory</span>&nbsp;<span class="op" id="6885030">:=</span>&nbsp;<span class="op" id="6885033">[</span><span class="op" id="6885034">]</span><span class="builtintype" id="6885035">byte</span><span class="op" id="6885039">(</span><span class="string" id="6885040">&#34;\xffPHOTO&#34;</span><span class="op" id="6885051">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885054">want</span>&nbsp;<span class="op" id="6885059">:=</span>&nbsp;<span class="op" id="6885062">[</span><span class="op" id="6885063">]</span><span class="ident" id="6885064">row</span><span class="op" id="6885067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885071">{</span><span class="ident" id="6885072">name</span><span class="op" id="6885076">:</span>&nbsp;<span class="op" id="6885078">[</span><span class="op" id="6885079">]</span><span class="builtintype" id="6885080">byte</span><span class="op" id="6885084">(</span><span class="string" id="6885085">&#34;Alice&#34;</span><span class="op" id="6885092">)</span><span class="op" id="6885093">,</span>&nbsp;<span class="ident" id="6885095">photo</span><span class="op" id="6885100">:</span>&nbsp;<span class="ident" id="6885102">corruptMemory</span><span class="op" id="6885115">}</span><span class="op" id="6885116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885120">{</span><span class="ident" id="6885121">name</span><span class="op" id="6885125">:</span>&nbsp;<span class="op" id="6885127">[</span><span class="op" id="6885128">]</span><span class="builtintype" id="6885129">byte</span><span class="op" id="6885133">(</span><span class="string" id="6885134">&#34;Bob&#34;</span><span class="op" id="6885139">)</span><span class="op" id="6885140">,</span>&nbsp;<span class="ident" id="6885142">photo</span><span class="op" id="6885147">:</span>&nbsp;<span class="ident" id="6885149">corruptMemory</span><span class="op" id="6885162">}</span><span class="op" id="6885163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885167">{</span><span class="ident" id="6885168">name</span><span class="op" id="6885172">:</span>&nbsp;<span class="op" id="6885174">[</span><span class="op" id="6885175">]</span><span class="builtintype" id="6885176">byte</span><span class="op" id="6885180">(</span><span class="string" id="6885181">&#34;Chris&#34;</span><span class="op" id="6885188">)</span><span class="op" id="6885189">,</span>&nbsp;<span class="ident" id="6885191">photo</span><span class="op" id="6885196">:</span>&nbsp;<span class="ident" id="6885198">corruptMemory</span><span class="op" id="6885211">}</span><span class="op" id="6885212">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885215">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885218">if</span>&nbsp;<span class="op" id="6885221">!</span><span class="ident" id="6885222">reflect</span><span class="op" id="6885229">.</span><span class="ident" id="6885230">DeepEqual</span><span class="op" id="6885239">(</span><span class="ident" id="6885240">got</span><span class="op" id="6885243">,</span>&nbsp;<span class="ident" id="6885245">want</span><span class="op" id="6885249">)</span>&nbsp;<span class="op" id="6885251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885255">t</span><span class="op" id="6885256">.</span><span class="ident" id="6885257">Errorf</span><span class="op" id="6885263">(</span><span class="string" id="6885264">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="6885297">,</span>&nbsp;<span class="ident" id="6885299">got</span><span class="op" id="6885302">,</span>&nbsp;<span class="ident" id="6885304">want</span><span class="op" id="6885308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885315">var</span>&nbsp;<span class="ident" id="6885319">photo</span>&nbsp;<span class="ident" id="6885325">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885335">err</span>&nbsp;<span class="op" id="6885339">=</span>&nbsp;<span class="ident" id="6885341">db</span><span class="op" id="6885343">.</span><span class="ident" id="6885344">QueryRow</span><span class="op" id="6885352">(</span><span class="string" id="6885353">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6885381">,</span>&nbsp;<span class="string" id="6885383">&#34;Alice&#34;</span><span class="op" id="6885390">)</span><span class="op" id="6885391">.</span><span class="ident" id="6885392">Scan</span><span class="op" id="6885396">(</span><span class="op" id="6885397">&amp;</span><span class="ident" id="6885398">photo</span><span class="op" id="6885403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885406">if</span>&nbsp;<span class="ident" id="6885409">err</span>&nbsp;<span class="op" id="6885413">==</span>&nbsp;<span class="ident" id="6885416">nil</span>&nbsp;<span class="op" id="6885420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885424">t</span><span class="op" id="6885425">.</span><span class="ident" id="6885426">Error</span><span class="op" id="6885431">(</span><span class="string" id="6885432">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="6885481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885484">}</span><br>
<span class="lineno"></span><span class="op" id="6885486">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="6885489">func</span>&nbsp;<span class="ident" id="6885494">TestRowsColumns</span><span class="op" id="6885509">(</span><span class="ident" id="6885510">t</span>&nbsp;<span class="op" id="6885512">*</span><span class="ident" id="6885513">testing</span><span class="op" id="6885520">.</span><span class="ident" id="6885521">T</span><span class="op" id="6885522">)</span>&nbsp;<span class="op" id="6885524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885527">db</span>&nbsp;<span class="op" id="6885530">:=</span>&nbsp;<span class="ident" id="6885533">newTestDB</span><span class="op" id="6885542">(</span><span class="ident" id="6885543">t</span><span class="op" id="6885544">,</span>&nbsp;<span class="string" id="6885546">&#34;people&#34;</span><span class="op" id="6885554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885557">defer</span>&nbsp;<span class="ident" id="6885563">closeDB</span><span class="op" id="6885570">(</span><span class="ident" id="6885571">t</span><span class="op" id="6885572">,</span>&nbsp;<span class="ident" id="6885574">db</span><span class="op" id="6885576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885579">rows</span><span class="op" id="6885583">,</span>&nbsp;<span class="ident" id="6885585">err</span>&nbsp;<span class="op" id="6885589">:=</span>&nbsp;<span class="ident" id="6885592">db</span><span class="op" id="6885594">.</span><span class="ident" id="6885595">Query</span><span class="op" id="6885600">(</span><span class="string" id="6885601">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6885626">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885629">if</span>&nbsp;<span class="ident" id="6885632">err</span>&nbsp;<span class="op" id="6885636">!=</span>&nbsp;<span class="ident" id="6885639">nil</span>&nbsp;<span class="op" id="6885643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885647">t</span><span class="op" id="6885648">.</span><span class="ident" id="6885649">Fatalf</span><span class="op" id="6885655">(</span><span class="string" id="6885656">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="6885667">,</span>&nbsp;<span class="ident" id="6885669">err</span><span class="op" id="6885672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885678">cols</span><span class="op" id="6885682">,</span>&nbsp;<span class="ident" id="6885684">err</span>&nbsp;<span class="op" id="6885688">:=</span>&nbsp;<span class="ident" id="6885691">rows</span><span class="op" id="6885695">.</span><span class="ident" id="6885696">Columns</span><span class="op" id="6885703">(</span><span class="op" id="6885704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885707">if</span>&nbsp;<span class="ident" id="6885710">err</span>&nbsp;<span class="op" id="6885714">!=</span>&nbsp;<span class="ident" id="6885717">nil</span>&nbsp;<span class="op" id="6885721">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885725">t</span><span class="op" id="6885726">.</span><span class="ident" id="6885727">Fatalf</span><span class="op" id="6885733">(</span><span class="string" id="6885734">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="6885747">,</span>&nbsp;<span class="ident" id="6885749">err</span><span class="op" id="6885752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885758">want</span>&nbsp;<span class="op" id="6885763">:=</span>&nbsp;<span class="op" id="6885766">[</span><span class="op" id="6885767">]</span><span class="builtintype" id="6885768">string</span><span class="op" id="6885774">{</span><span class="string" id="6885775">&#34;age&#34;</span><span class="op" id="6885780">,</span>&nbsp;<span class="string" id="6885782">&#34;name&#34;</span><span class="op" id="6885788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885791">if</span>&nbsp;<span class="op" id="6885794">!</span><span class="ident" id="6885795">reflect</span><span class="op" id="6885802">.</span><span class="ident" id="6885803">DeepEqual</span><span class="op" id="6885812">(</span><span class="ident" id="6885813">cols</span><span class="op" id="6885817">,</span>&nbsp;<span class="ident" id="6885819">want</span><span class="op" id="6885823">)</span>&nbsp;<span class="op" id="6885825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885829">t</span><span class="op" id="6885830">.</span><span class="ident" id="6885831">Errorf</span><span class="op" id="6885837">(</span><span class="string" id="6885838">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6885857">,</span>&nbsp;<span class="ident" id="6885859">cols</span><span class="op" id="6885863">,</span>&nbsp;<span class="ident" id="6885865">want</span><span class="op" id="6885869">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885875">if</span>&nbsp;<span class="ident" id="6885878">err</span>&nbsp;<span class="op" id="6885882">:=</span>&nbsp;<span class="ident" id="6885885">rows</span><span class="op" id="6885889">.</span><span class="ident" id="6885890">Close</span><span class="op" id="6885895">(</span><span class="op" id="6885896">)</span><span class="op" id="6885897">;</span>&nbsp;<span class="ident" id="6885899">err</span>&nbsp;<span class="op" id="6885903">!=</span>&nbsp;<span class="ident" id="6885906">nil</span>&nbsp;<span class="op" id="6885910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885914">t</span><span class="op" id="6885915">.</span><span class="ident" id="6885916">Errorf</span><span class="op" id="6885922">(</span><span class="string" id="6885923">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="6885947">,</span>&nbsp;<span class="ident" id="6885949">err</span><span class="op" id="6885952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885955">}</span><br>
<span class="lineno"></span><span class="op" id="6885957">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6885960">func</span>&nbsp;<span class="ident" id="6885965">TestQueryRow</span><span class="op" id="6885977">(</span><span class="ident" id="6885978">t</span>&nbsp;<span class="op" id="6885980">*</span><span class="ident" id="6885981">testing</span><span class="op" id="6885988">.</span><span class="ident" id="6885989">T</span><span class="op" id="6885990">)</span>&nbsp;<span class="op" id="6885992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885995">db</span>&nbsp;<span class="op" id="6885998">:=</span>&nbsp;<span class="ident" id="6886001">newTestDB</span><span class="op" id="6886010">(</span><span class="ident" id="6886011">t</span><span class="op" id="6886012">,</span>&nbsp;<span class="string" id="6886014">&#34;people&#34;</span><span class="op" id="6886022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886025">defer</span>&nbsp;<span class="ident" id="6886031">closeDB</span><span class="op" id="6886038">(</span><span class="ident" id="6886039">t</span><span class="op" id="6886040">,</span>&nbsp;<span class="ident" id="6886042">db</span><span class="op" id="6886044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886047">var</span>&nbsp;<span class="ident" id="6886051">name</span>&nbsp;<span class="builtintype" id="6886056">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886064">var</span>&nbsp;<span class="ident" id="6886068">age</span>&nbsp;<span class="builtintype" id="6886072">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886077">var</span>&nbsp;<span class="ident" id="6886081">birthday</span>&nbsp;<span class="ident" id="6886090">time</span><span class="op" id="6886094">.</span><span class="ident" id="6886095">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886102">err</span>&nbsp;<span class="op" id="6886106">:=</span>&nbsp;<span class="ident" id="6886109">db</span><span class="op" id="6886111">.</span><span class="ident" id="6886112">QueryRow</span><span class="op" id="6886120">(</span><span class="string" id="6886121">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6886151">,</span>&nbsp;<span class="num" id="6886153">3</span><span class="op" id="6886154">)</span><span class="op" id="6886155">.</span><span class="ident" id="6886156">Scan</span><span class="op" id="6886160">(</span><span class="op" id="6886161">&amp;</span><span class="ident" id="6886162">age</span><span class="op" id="6886165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886168">if</span>&nbsp;<span class="ident" id="6886171">err</span>&nbsp;<span class="op" id="6886175">==</span>&nbsp;<span class="ident" id="6886178">nil</span>&nbsp;<span class="op" id="6886182">||</span>&nbsp;<span class="op" id="6886185">!</span><span class="ident" id="6886186">strings</span><span class="op" id="6886193">.</span><span class="ident" id="6886194">Contains</span><span class="op" id="6886202">(</span><span class="ident" id="6886203">err</span><span class="op" id="6886206">.</span><span class="ident" id="6886207">Error</span><span class="op" id="6886212">(</span><span class="op" id="6886213">)</span><span class="op" id="6886214">,</span>&nbsp;<span class="string" id="6886216">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="6886250">)</span>&nbsp;<span class="op" id="6886252">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886256">t</span><span class="op" id="6886257">.</span><span class="ident" id="6886258">Errorf</span><span class="op" id="6886264">(</span><span class="string" id="6886265">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="6886330">,</span>&nbsp;<span class="ident" id="6886332">err</span><span class="op" id="6886335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886342">err</span>&nbsp;<span class="op" id="6886346">=</span>&nbsp;<span class="ident" id="6886348">db</span><span class="op" id="6886350">.</span><span class="ident" id="6886351">QueryRow</span><span class="op" id="6886359">(</span><span class="string" id="6886360">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="6886387">,</span>&nbsp;<span class="num" id="6886389">3</span><span class="op" id="6886390">)</span><span class="op" id="6886391">.</span><span class="ident" id="6886392">Scan</span><span class="op" id="6886396">(</span><span class="op" id="6886397">&amp;</span><span class="ident" id="6886398">birthday</span><span class="op" id="6886406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886409">if</span>&nbsp;<span class="ident" id="6886412">err</span>&nbsp;<span class="op" id="6886416">!=</span>&nbsp;<span class="ident" id="6886419">nil</span>&nbsp;<span class="op" id="6886423">||</span>&nbsp;<span class="op" id="6886426">!</span><span class="ident" id="6886427">birthday</span><span class="op" id="6886435">.</span><span class="ident" id="6886436">Equal</span><span class="op" id="6886441">(</span><span class="ident" id="6886442">chrisBirthday</span><span class="op" id="6886455">)</span>&nbsp;<span class="op" id="6886457">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886461">t</span><span class="op" id="6886462">.</span><span class="ident" id="6886463">Errorf</span><span class="op" id="6886469">(</span><span class="string" id="6886470">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6886510">,</span>&nbsp;<span class="ident" id="6886512">birthday</span><span class="op" id="6886520">,</span>&nbsp;<span class="ident" id="6886522">err</span><span class="op" id="6886525">,</span>&nbsp;<span class="ident" id="6886527">chrisBirthday</span><span class="op" id="6886540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886547">err</span>&nbsp;<span class="op" id="6886551">=</span>&nbsp;<span class="ident" id="6886553">db</span><span class="op" id="6886555">.</span><span class="ident" id="6886556">QueryRow</span><span class="op" id="6886564">(</span><span class="string" id="6886565">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6886595">,</span>&nbsp;<span class="num" id="6886597">2</span><span class="op" id="6886598">)</span><span class="op" id="6886599">.</span><span class="ident" id="6886600">Scan</span><span class="op" id="6886604">(</span><span class="op" id="6886605">&amp;</span><span class="ident" id="6886606">age</span><span class="op" id="6886609">,</span>&nbsp;<span class="op" id="6886611">&amp;</span><span class="ident" id="6886612">name</span><span class="op" id="6886616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886619">if</span>&nbsp;<span class="ident" id="6886622">err</span>&nbsp;<span class="op" id="6886626">!=</span>&nbsp;<span class="ident" id="6886629">nil</span>&nbsp;<span class="op" id="6886633">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886637">t</span><span class="op" id="6886638">.</span><span class="ident" id="6886639">Fatalf</span><span class="op" id="6886645">(</span><span class="string" id="6886646">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6886669">,</span>&nbsp;<span class="ident" id="6886671">err</span><span class="op" id="6886674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886680">if</span>&nbsp;<span class="ident" id="6886683">name</span>&nbsp;<span class="op" id="6886688">!=</span>&nbsp;<span class="string" id="6886691">&#34;Bob&#34;</span>&nbsp;<span class="op" id="6886697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886701">t</span><span class="op" id="6886702">.</span><span class="ident" id="6886703">Errorf</span><span class="op" id="6886709">(</span><span class="string" id="6886710">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6886737">,</span>&nbsp;<span class="ident" id="6886739">name</span><span class="op" id="6886743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886746">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886749">if</span>&nbsp;<span class="ident" id="6886752">age</span>&nbsp;<span class="op" id="6886756">!=</span>&nbsp;<span class="num" id="6886759">2</span>&nbsp;<span class="op" id="6886761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886765">t</span><span class="op" id="6886766">.</span><span class="ident" id="6886767">Errorf</span><span class="op" id="6886773">(</span><span class="string" id="6886774">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6886798">,</span>&nbsp;<span class="ident" id="6886800">age</span><span class="op" id="6886803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886810">err</span>&nbsp;<span class="op" id="6886814">=</span>&nbsp;<span class="ident" id="6886816">db</span><span class="op" id="6886818">.</span><span class="ident" id="6886819">QueryRow</span><span class="op" id="6886827">(</span><span class="string" id="6886828">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="6886859">,</span>&nbsp;<span class="string" id="6886861">&#34;Alice&#34;</span><span class="op" id="6886868">)</span><span class="op" id="6886869">.</span><span class="ident" id="6886870">Scan</span><span class="op" id="6886874">(</span><span class="op" id="6886875">&amp;</span><span class="ident" id="6886876">age</span><span class="op" id="6886879">,</span>&nbsp;<span class="op" id="6886881">&amp;</span><span class="ident" id="6886882">name</span><span class="op" id="6886886">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886889">if</span>&nbsp;<span class="ident" id="6886892">err</span>&nbsp;<span class="op" id="6886896">!=</span>&nbsp;<span class="ident" id="6886899">nil</span>&nbsp;<span class="op" id="6886903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886907">t</span><span class="op" id="6886908">.</span><span class="ident" id="6886909">Fatalf</span><span class="op" id="6886915">(</span><span class="string" id="6886916">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6886940">,</span>&nbsp;<span class="ident" id="6886942">err</span><span class="op" id="6886945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886951">if</span>&nbsp;<span class="ident" id="6886954">name</span>&nbsp;<span class="op" id="6886959">!=</span>&nbsp;<span class="string" id="6886962">&#34;Alice&#34;</span>&nbsp;<span class="op" id="6886970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886974">t</span><span class="op" id="6886975">.</span><span class="ident" id="6886976">Errorf</span><span class="op" id="6886982">(</span><span class="string" id="6886983">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6887012">,</span>&nbsp;<span class="ident" id="6887014">name</span><span class="op" id="6887018">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887024">if</span>&nbsp;<span class="ident" id="6887027">age</span>&nbsp;<span class="op" id="6887031">!=</span>&nbsp;<span class="num" id="6887034">1</span>&nbsp;<span class="op" id="6887036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887040">t</span><span class="op" id="6887041">.</span><span class="ident" id="6887042">Errorf</span><span class="op" id="6887048">(</span><span class="string" id="6887049">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6887073">,</span>&nbsp;<span class="ident" id="6887075">age</span><span class="op" id="6887078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887085">var</span>&nbsp;<span class="ident" id="6887089">photo</span>&nbsp;<span class="op" id="6887095">[</span><span class="op" id="6887096">]</span><span class="builtintype" id="6887097">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887103">err</span>&nbsp;<span class="op" id="6887107">=</span>&nbsp;<span class="ident" id="6887109">db</span><span class="op" id="6887111">.</span><span class="ident" id="6887112">QueryRow</span><span class="op" id="6887120">(</span><span class="string" id="6887121">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="6887149">,</span>&nbsp;<span class="string" id="6887151">&#34;Alice&#34;</span><span class="op" id="6887158">)</span><span class="op" id="6887159">.</span><span class="ident" id="6887160">Scan</span><span class="op" id="6887164">(</span><span class="op" id="6887165">&amp;</span><span class="ident" id="6887166">photo</span><span class="op" id="6887171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887174">if</span>&nbsp;<span class="ident" id="6887177">err</span>&nbsp;<span class="op" id="6887181">!=</span>&nbsp;<span class="ident" id="6887184">nil</span>&nbsp;<span class="op" id="6887188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887192">t</span><span class="op" id="6887193">.</span><span class="ident" id="6887194">Fatalf</span><span class="op" id="6887200">(</span><span class="string" id="6887201">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="6887226">,</span>&nbsp;<span class="ident" id="6887228">err</span><span class="op" id="6887231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887234">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887237">want</span>&nbsp;<span class="op" id="6887242">:=</span>&nbsp;<span class="op" id="6887245">[</span><span class="op" id="6887246">]</span><span class="builtintype" id="6887247">byte</span><span class="op" id="6887251">(</span><span class="string" id="6887252">&#34;APHOTO&#34;</span><span class="op" id="6887260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887263">if</span>&nbsp;<span class="op" id="6887266">!</span><span class="ident" id="6887267">reflect</span><span class="op" id="6887274">.</span><span class="ident" id="6887275">DeepEqual</span><span class="op" id="6887284">(</span><span class="ident" id="6887285">photo</span><span class="op" id="6887290">,</span>&nbsp;<span class="ident" id="6887292">want</span><span class="op" id="6887296">)</span>&nbsp;<span class="op" id="6887298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887302">t</span><span class="op" id="6887303">.</span><span class="ident" id="6887304">Errorf</span><span class="op" id="6887310">(</span><span class="string" id="6887311">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6887332">,</span>&nbsp;<span class="ident" id="6887334">photo</span><span class="op" id="6887339">,</span>&nbsp;<span class="ident" id="6887341">want</span><span class="op" id="6887345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887348">}</span><br>
<span class="lineno"></span><span class="op" id="6887350">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6887353">func</span>&nbsp;<span class="ident" id="6887358">TestStatementErrorAfterClose</span><span class="op" id="6887386">(</span><span class="ident" id="6887387">t</span>&nbsp;<span class="op" id="6887389">*</span><span class="ident" id="6887390">testing</span><span class="op" id="6887397">.</span><span class="ident" id="6887398">T</span><span class="op" id="6887399">)</span>&nbsp;<span class="op" id="6887401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887404">db</span>&nbsp;<span class="op" id="6887407">:=</span>&nbsp;<span class="ident" id="6887410">newTestDB</span><span class="op" id="6887419">(</span><span class="ident" id="6887420">t</span><span class="op" id="6887421">,</span>&nbsp;<span class="string" id="6887423">&#34;people&#34;</span><span class="op" id="6887431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887434">defer</span>&nbsp;<span class="ident" id="6887440">closeDB</span><span class="op" id="6887447">(</span><span class="ident" id="6887448">t</span><span class="op" id="6887449">,</span>&nbsp;<span class="ident" id="6887451">db</span><span class="op" id="6887453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887456">stmt</span><span class="op" id="6887460">,</span>&nbsp;<span class="ident" id="6887462">err</span>&nbsp;<span class="op" id="6887466">:=</span>&nbsp;<span class="ident" id="6887469">db</span><span class="op" id="6887471">.</span><span class="ident" id="6887472">Prepare</span><span class="op" id="6887479">(</span><span class="string" id="6887480">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6887506">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887509">if</span>&nbsp;<span class="ident" id="6887512">err</span>&nbsp;<span class="op" id="6887516">!=</span>&nbsp;<span class="ident" id="6887519">nil</span>&nbsp;<span class="op" id="6887523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887527">t</span><span class="op" id="6887528">.</span><span class="ident" id="6887529">Fatalf</span><span class="op" id="6887535">(</span><span class="string" id="6887536">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6887549">,</span>&nbsp;<span class="ident" id="6887551">err</span><span class="op" id="6887554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887560">err</span>&nbsp;<span class="op" id="6887564">=</span>&nbsp;<span class="ident" id="6887566">stmt</span><span class="op" id="6887570">.</span><span class="ident" id="6887571">Close</span><span class="op" id="6887576">(</span><span class="op" id="6887577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887580">if</span>&nbsp;<span class="ident" id="6887583">err</span>&nbsp;<span class="op" id="6887587">!=</span>&nbsp;<span class="ident" id="6887590">nil</span>&nbsp;<span class="op" id="6887594">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887598">t</span><span class="op" id="6887599">.</span><span class="ident" id="6887600">Fatalf</span><span class="op" id="6887606">(</span><span class="string" id="6887607">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="6887618">,</span>&nbsp;<span class="ident" id="6887620">err</span><span class="op" id="6887623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887629">var</span>&nbsp;<span class="ident" id="6887633">name</span>&nbsp;<span class="builtintype" id="6887638">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887646">err</span>&nbsp;<span class="op" id="6887650">=</span>&nbsp;<span class="ident" id="6887652">stmt</span><span class="op" id="6887656">.</span><span class="ident" id="6887657">QueryRow</span><span class="op" id="6887665">(</span><span class="string" id="6887666">&#34;foo&#34;</span><span class="op" id="6887671">)</span><span class="op" id="6887672">.</span><span class="ident" id="6887673">Scan</span><span class="op" id="6887677">(</span><span class="op" id="6887678">&amp;</span><span class="ident" id="6887679">name</span><span class="op" id="6887683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887686">if</span>&nbsp;<span class="ident" id="6887689">err</span>&nbsp;<span class="op" id="6887693">==</span>&nbsp;<span class="ident" id="6887696">nil</span>&nbsp;<span class="op" id="6887700">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887704">t</span><span class="op" id="6887705">.</span><span class="ident" id="6887706">Errorf</span><span class="op" id="6887712">(</span><span class="string" id="6887713">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="6887765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887768">}</span><br>
<span class="lineno"></span><span class="op" id="6887770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6887773">func</span>&nbsp;<span class="ident" id="6887778">TestStatementQueryRow</span><span class="op" id="6887799">(</span><span class="ident" id="6887800">t</span>&nbsp;<span class="op" id="6887802">*</span><span class="ident" id="6887803">testing</span><span class="op" id="6887810">.</span><span class="ident" id="6887811">T</span><span class="op" id="6887812">)</span>&nbsp;<span class="op" id="6887814">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887817">db</span>&nbsp;<span class="op" id="6887820">:=</span>&nbsp;<span class="ident" id="6887823">newTestDB</span><span class="op" id="6887832">(</span><span class="ident" id="6887833">t</span><span class="op" id="6887834">,</span>&nbsp;<span class="string" id="6887836">&#34;people&#34;</span><span class="op" id="6887844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887847">defer</span>&nbsp;<span class="ident" id="6887853">closeDB</span><span class="op" id="6887860">(</span><span class="ident" id="6887861">t</span><span class="op" id="6887862">,</span>&nbsp;<span class="ident" id="6887864">db</span><span class="op" id="6887866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887869">stmt</span><span class="op" id="6887873">,</span>&nbsp;<span class="ident" id="6887875">err</span>&nbsp;<span class="op" id="6887879">:=</span>&nbsp;<span class="ident" id="6887882">db</span><span class="op" id="6887884">.</span><span class="ident" id="6887885">Prepare</span><span class="op" id="6887892">(</span><span class="string" id="6887893">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6887919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887922">if</span>&nbsp;<span class="ident" id="6887925">err</span>&nbsp;<span class="op" id="6887929">!=</span>&nbsp;<span class="ident" id="6887932">nil</span>&nbsp;<span class="op" id="6887936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887940">t</span><span class="op" id="6887941">.</span><span class="ident" id="6887942">Fatalf</span><span class="op" id="6887948">(</span><span class="string" id="6887949">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6887962">,</span>&nbsp;<span class="ident" id="6887964">err</span><span class="op" id="6887967">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887973">defer</span>&nbsp;<span class="ident" id="6887979">stmt</span><span class="op" id="6887983">.</span><span class="ident" id="6887984">Close</span><span class="op" id="6887989">(</span><span class="op" id="6887990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887993">var</span>&nbsp;<span class="ident" id="6887997">age</span>&nbsp;<span class="builtintype" id="6888001">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888006">for</span>&nbsp;<span class="ident" id="6888010">n</span><span class="op" id="6888011">,</span>&nbsp;<span class="ident" id="6888013">tt</span>&nbsp;<span class="op" id="6888016">:=</span>&nbsp;<span class="keyword" id="6888019">range</span>&nbsp;<span class="op" id="6888025">[</span><span class="op" id="6888026">]</span><span class="keyword" id="6888027">struct</span>&nbsp;<span class="op" id="6888034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888038">name</span>&nbsp;<span class="builtintype" id="6888043">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888052">want</span>&nbsp;<span class="builtintype" id="6888057">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888062">}</span><span class="op" id="6888063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888067">{</span><span class="string" id="6888068">&#34;Alice&#34;</span><span class="op" id="6888075">,</span>&nbsp;<span class="num" id="6888077">1</span><span class="op" id="6888078">}</span><span class="op" id="6888079">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888083">{</span><span class="string" id="6888084">&#34;Bob&#34;</span><span class="op" id="6888089">,</span>&nbsp;<span class="num" id="6888091">2</span><span class="op" id="6888092">}</span><span class="op" id="6888093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888097">{</span><span class="string" id="6888098">&#34;Chris&#34;</span><span class="op" id="6888105">,</span>&nbsp;<span class="num" id="6888107">3</span><span class="op" id="6888108">}</span><span class="op" id="6888109">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888112">}</span>&nbsp;<span class="op" id="6888114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888118">if</span>&nbsp;<span class="ident" id="6888121">err</span>&nbsp;<span class="op" id="6888125">:=</span>&nbsp;<span class="ident" id="6888128">stmt</span><span class="op" id="6888132">.</span><span class="ident" id="6888133">QueryRow</span><span class="op" id="6888141">(</span><span class="ident" id="6888142">tt</span><span class="op" id="6888144">.</span><span class="ident" id="6888145">name</span><span class="op" id="6888149">)</span><span class="op" id="6888150">.</span><span class="ident" id="6888151">Scan</span><span class="op" id="6888155">(</span><span class="op" id="6888156">&amp;</span><span class="ident" id="6888157">age</span><span class="op" id="6888160">)</span><span class="op" id="6888161">;</span>&nbsp;<span class="ident" id="6888163">err</span>&nbsp;<span class="op" id="6888167">!=</span>&nbsp;<span class="ident" id="6888170">nil</span>&nbsp;<span class="op" id="6888174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888179">t</span><span class="op" id="6888180">.</span><span class="ident" id="6888181">Errorf</span><span class="op" id="6888187">(</span><span class="string" id="6888188">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="6888218">,</span>&nbsp;<span class="ident" id="6888220">n</span><span class="op" id="6888221">,</span>&nbsp;<span class="ident" id="6888223">tt</span><span class="op" id="6888225">.</span><span class="ident" id="6888226">name</span><span class="op" id="6888230">,</span>&nbsp;<span class="ident" id="6888232">err</span><span class="op" id="6888235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888239">}</span>&nbsp;<span class="keyword" id="6888241">else</span>&nbsp;<span class="keyword" id="6888246">if</span>&nbsp;<span class="ident" id="6888249">age</span>&nbsp;<span class="op" id="6888253">!=</span>&nbsp;<span class="ident" id="6888256">tt</span><span class="op" id="6888258">.</span><span class="ident" id="6888259">want</span>&nbsp;<span class="op" id="6888264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888269">t</span><span class="op" id="6888270">.</span><span class="ident" id="6888271">Errorf</span><span class="op" id="6888277">(</span><span class="string" id="6888278">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6888299">,</span>&nbsp;<span class="ident" id="6888301">n</span><span class="op" id="6888302">,</span>&nbsp;<span class="ident" id="6888304">age</span><span class="op" id="6888307">,</span>&nbsp;<span class="ident" id="6888309">tt</span><span class="op" id="6888311">.</span><span class="ident" id="6888312">want</span><span class="op" id="6888316">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888323">}</span><br>
<span class="lineno"></span><span class="op" id="6888325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6888328">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="6888353">func</span>&nbsp;<span class="ident" id="6888358">TestStatementQueryRowConcurrent</span><span class="op" id="6888389">(</span><span class="ident" id="6888390">t</span>&nbsp;<span class="op" id="6888392">*</span><span class="ident" id="6888393">testing</span><span class="op" id="6888400">.</span><span class="ident" id="6888401">T</span><span class="op" id="6888402">)</span>&nbsp;<span class="op" id="6888404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888407">db</span>&nbsp;<span class="op" id="6888410">:=</span>&nbsp;<span class="ident" id="6888413">newTestDB</span><span class="op" id="6888422">(</span><span class="ident" id="6888423">t</span><span class="op" id="6888424">,</span>&nbsp;<span class="string" id="6888426">&#34;people&#34;</span><span class="op" id="6888434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888437">defer</span>&nbsp;<span class="ident" id="6888443">closeDB</span><span class="op" id="6888450">(</span><span class="ident" id="6888451">t</span><span class="op" id="6888452">,</span>&nbsp;<span class="ident" id="6888454">db</span><span class="op" id="6888456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888459">stmt</span><span class="op" id="6888463">,</span>&nbsp;<span class="ident" id="6888465">err</span>&nbsp;<span class="op" id="6888469">:=</span>&nbsp;<span class="ident" id="6888472">db</span><span class="op" id="6888474">.</span><span class="ident" id="6888475">Prepare</span><span class="op" id="6888482">(</span><span class="string" id="6888483">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="6888509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888512">if</span>&nbsp;<span class="ident" id="6888515">err</span>&nbsp;<span class="op" id="6888519">!=</span>&nbsp;<span class="ident" id="6888522">nil</span>&nbsp;<span class="op" id="6888526">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888530">t</span><span class="op" id="6888531">.</span><span class="ident" id="6888532">Fatalf</span><span class="op" id="6888538">(</span><span class="string" id="6888539">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="6888552">,</span>&nbsp;<span class="ident" id="6888554">err</span><span class="op" id="6888557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888563">defer</span>&nbsp;<span class="ident" id="6888569">stmt</span><span class="op" id="6888573">.</span><span class="ident" id="6888574">Close</span><span class="op" id="6888579">(</span><span class="op" id="6888580">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888584">const</span>&nbsp;<span class="ident" id="6888590">n</span>&nbsp;<span class="op" id="6888592">=</span>&nbsp;<span class="num" id="6888594">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888598">ch</span>&nbsp;<span class="op" id="6888601">:=</span>&nbsp;<span class="builtinfunc" id="6888604">make</span><span class="op" id="6888608">(</span><span class="keyword" id="6888609">chan</span>&nbsp;<span class="builtintype" id="6888614">error</span><span class="op" id="6888619">,</span>&nbsp;<span class="ident" id="6888621">n</span><span class="op" id="6888622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888625">for</span>&nbsp;<span class="ident" id="6888629">i</span>&nbsp;<span class="op" id="6888631">:=</span>&nbsp;<span class="num" id="6888634">0</span><span class="op" id="6888635">;</span>&nbsp;<span class="ident" id="6888637">i</span>&nbsp;<span class="op" id="6888639">&lt;</span>&nbsp;<span class="ident" id="6888641">n</span><span class="op" id="6888642">;</span>&nbsp;<span class="ident" id="6888644">i</span><span class="op" id="6888645">++</span>&nbsp;<span class="op" id="6888648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888652">go</span>&nbsp;<span class="keyword" id="6888655">func</span><span class="op" id="6888659">(</span><span class="op" id="6888660">)</span>&nbsp;<span class="op" id="6888662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888667">var</span>&nbsp;<span class="ident" id="6888671">age</span>&nbsp;<span class="builtintype" id="6888675">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888682">err</span>&nbsp;<span class="op" id="6888686">:=</span>&nbsp;<span class="ident" id="6888689">stmt</span><span class="op" id="6888693">.</span><span class="ident" id="6888694">QueryRow</span><span class="op" id="6888702">(</span><span class="string" id="6888703">&#34;Alice&#34;</span><span class="op" id="6888710">)</span><span class="op" id="6888711">.</span><span class="ident" id="6888712">Scan</span><span class="op" id="6888716">(</span><span class="op" id="6888717">&amp;</span><span class="ident" id="6888718">age</span><span class="op" id="6888721">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888726">if</span>&nbsp;<span class="ident" id="6888729">err</span>&nbsp;<span class="op" id="6888733">==</span>&nbsp;<span class="ident" id="6888736">nil</span>&nbsp;<span class="op" id="6888740">&amp;&amp;</span>&nbsp;<span class="ident" id="6888743">age</span>&nbsp;<span class="op" id="6888747">!=</span>&nbsp;<span class="num" id="6888750">1</span>&nbsp;<span class="op" id="6888752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888758">err</span>&nbsp;<span class="op" id="6888762">=</span>&nbsp;<span class="ident" id="6888764">fmt</span><span class="op" id="6888767">.</span><span class="ident" id="6888768">Errorf</span><span class="op" id="6888774">(</span><span class="string" id="6888775">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="6888794">,</span>&nbsp;<span class="ident" id="6888796">age</span><span class="op" id="6888799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888809">ch</span>&nbsp;<span class="op" id="6888812">&lt;-</span>&nbsp;<span class="ident" id="6888815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888821">}</span><span class="op" id="6888822">(</span><span class="op" id="6888823">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888829">for</span>&nbsp;<span class="ident" id="6888833">i</span>&nbsp;<span class="op" id="6888835">:=</span>&nbsp;<span class="num" id="6888838">0</span><span class="op" id="6888839">;</span>&nbsp;<span class="ident" id="6888841">i</span>&nbsp;<span class="op" id="6888843">&lt;</span>&nbsp;<span class="ident" id="6888845">n</span><span class="op" id="6888846">;</span>&nbsp;<span class="ident" id="6888848">i</span><span class="op" id="6888849">++</span>&nbsp;<span class="op" id="6888852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6888856">if</span>&nbsp;<span class="ident" id="6888859">err</span>&nbsp;<span class="op" id="6888863">:=</span>&nbsp;<span class="op" id="6888866">&lt;-</span><span class="ident" id="6888868">ch</span><span class="op" id="6888870">;</span>&nbsp;<span class="ident" id="6888872">err</span>&nbsp;<span class="op" id="6888876">!=</span>&nbsp;<span class="ident" id="6888879">nil</span>&nbsp;<span class="op" id="6888883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888888">t</span><span class="op" id="6888889">.</span><span class="ident" id="6888890">Error</span><span class="op" id="6888895">(</span><span class="ident" id="6888896">err</span><span class="op" id="6888899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888903">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888906">}</span><br>
<span class="lineno"></span><span class="op" id="6888908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6888911">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="6888943">func</span>&nbsp;<span class="ident" id="6888948">TestBogusPreboundParameters</span><span class="op" id="6888975">(</span><span class="ident" id="6888976">t</span>&nbsp;<span class="op" id="6888978">*</span><span class="ident" id="6888979">testing</span><span class="op" id="6888986">.</span><span class="ident" id="6888987">T</span><span class="op" id="6888988">)</span>&nbsp;<span class="op" id="6888990">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888993">db</span>&nbsp;<span class="op" id="6888996">:=</span>&nbsp;<span class="ident" id="6888999">newTestDB</span><span class="op" id="6889008">(</span><span class="ident" id="6889009">t</span><span class="op" id="6889010">,</span>&nbsp;<span class="string" id="6889012">&#34;foo&#34;</span><span class="op" id="6889017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889020">defer</span>&nbsp;<span class="ident" id="6889026">closeDB</span><span class="op" id="6889033">(</span><span class="ident" id="6889034">t</span><span class="op" id="6889035">,</span>&nbsp;<span class="ident" id="6889037">db</span><span class="op" id="6889039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889042">exec</span><span class="op" id="6889046">(</span><span class="ident" id="6889047">t</span><span class="op" id="6889048">,</span>&nbsp;<span class="ident" id="6889050">db</span><span class="op" id="6889052">,</span>&nbsp;<span class="string" id="6889054">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6889097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889100">_</span><span class="op" id="6889101">,</span>&nbsp;<span class="ident" id="6889103">err</span>&nbsp;<span class="op" id="6889107">:=</span>&nbsp;<span class="ident" id="6889110">db</span><span class="op" id="6889112">.</span><span class="ident" id="6889113">Prepare</span><span class="op" id="6889120">(</span><span class="string" id="6889121">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="6889159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889162">if</span>&nbsp;<span class="ident" id="6889165">err</span>&nbsp;<span class="op" id="6889169">==</span>&nbsp;<span class="ident" id="6889172">nil</span>&nbsp;<span class="op" id="6889176">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889180">t</span><span class="op" id="6889181">.</span><span class="ident" id="6889182">Fatalf</span><span class="op" id="6889188">(</span><span class="string" id="6889189">&#34;expected&nbsp;error&#34;</span><span class="op" id="6889205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889211">if</span>&nbsp;<span class="ident" id="6889214">err</span><span class="op" id="6889217">.</span><span class="ident" id="6889218">Error</span><span class="op" id="6889223">(</span><span class="op" id="6889224">)</span>&nbsp;<span class="op" id="6889226">!=</span>&nbsp;<span class="string" id="6889229">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="6889290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889294">t</span><span class="op" id="6889295">.</span><span class="ident" id="6889296">Errorf</span><span class="op" id="6889302">(</span><span class="string" id="6889303">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6889325">,</span>&nbsp;<span class="ident" id="6889327">err</span><span class="op" id="6889330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889333">}</span><br>
<span class="lineno">400</span><span class="op" id="6889335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6889338">func</span>&nbsp;<span class="ident" id="6889343">TestExec</span><span class="op" id="6889351">(</span><span class="ident" id="6889352">t</span>&nbsp;<span class="op" id="6889354">*</span><span class="ident" id="6889355">testing</span><span class="op" id="6889362">.</span><span class="ident" id="6889363">T</span><span class="op" id="6889364">)</span>&nbsp;<span class="op" id="6889366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889369">db</span>&nbsp;<span class="op" id="6889372">:=</span>&nbsp;<span class="ident" id="6889375">newTestDB</span><span class="op" id="6889384">(</span><span class="ident" id="6889385">t</span><span class="op" id="6889386">,</span>&nbsp;<span class="string" id="6889388">&#34;foo&#34;</span><span class="op" id="6889393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889396">defer</span>&nbsp;<span class="ident" id="6889402">closeDB</span><span class="op" id="6889409">(</span><span class="ident" id="6889410">t</span><span class="op" id="6889411">,</span>&nbsp;<span class="ident" id="6889413">db</span><span class="op" id="6889415">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889418">exec</span><span class="op" id="6889422">(</span><span class="ident" id="6889423">t</span><span class="op" id="6889424">,</span>&nbsp;<span class="ident" id="6889426">db</span><span class="op" id="6889428">,</span>&nbsp;<span class="string" id="6889430">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6889473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889476">stmt</span><span class="op" id="6889480">,</span>&nbsp;<span class="ident" id="6889482">err</span>&nbsp;<span class="op" id="6889486">:=</span>&nbsp;<span class="ident" id="6889489">db</span><span class="op" id="6889491">.</span><span class="ident" id="6889492">Prepare</span><span class="op" id="6889499">(</span><span class="string" id="6889500">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6889524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889527">if</span>&nbsp;<span class="ident" id="6889530">err</span>&nbsp;<span class="op" id="6889534">!=</span>&nbsp;<span class="ident" id="6889537">nil</span>&nbsp;<span class="op" id="6889541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889545">t</span><span class="op" id="6889546">.</span><span class="ident" id="6889547">Errorf</span><span class="op" id="6889553">(</span><span class="string" id="6889554">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6889574">,</span>&nbsp;<span class="ident" id="6889576">stmt</span><span class="op" id="6889580">,</span>&nbsp;<span class="ident" id="6889582">err</span><span class="op" id="6889585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889588">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889591">defer</span>&nbsp;<span class="ident" id="6889597">stmt</span><span class="op" id="6889601">.</span><span class="ident" id="6889602">Close</span><span class="op" id="6889607">(</span><span class="op" id="6889608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889612">type</span>&nbsp;<span class="ident" id="6889617">execTest</span>&nbsp;<span class="keyword" id="6889626">struct</span>&nbsp;<span class="op" id="6889633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889637">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6889645">[</span><span class="op" id="6889646">]</span><span class="keyword" id="6889647">interface</span><span class="op" id="6889656">{</span><span class="op" id="6889657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889661">wantErr</span>&nbsp;<span class="builtintype" id="6889669">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889680">execTests</span>&nbsp;<span class="op" id="6889690">:=</span>&nbsp;<span class="op" id="6889693">[</span><span class="op" id="6889694">]</span><span class="ident" id="6889695">execTest</span><span class="op" id="6889703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889707">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889718">{</span><span class="op" id="6889719">[</span><span class="op" id="6889720">]</span><span class="keyword" id="6889721">interface</span><span class="op" id="6889730">{</span><span class="op" id="6889731">}</span><span class="op" id="6889732">{</span><span class="string" id="6889733">&#34;Brad&#34;</span><span class="op" id="6889739">,</span>&nbsp;<span class="num" id="6889741">31</span><span class="op" id="6889743">}</span><span class="op" id="6889744">,</span>&nbsp;<span class="string" id="6889746">&#34;&#34;</span><span class="op" id="6889748">}</span><span class="op" id="6889749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889753">{</span><span class="op" id="6889754">[</span><span class="op" id="6889755">]</span><span class="keyword" id="6889756">interface</span><span class="op" id="6889765">{</span><span class="op" id="6889766">}</span><span class="op" id="6889767">{</span><span class="string" id="6889768">&#34;Brad&#34;</span><span class="op" id="6889774">,</span>&nbsp;<span class="ident" id="6889776">int64</span><span class="op" id="6889781">(</span><span class="num" id="6889782">31</span><span class="op" id="6889784">)</span><span class="op" id="6889785">}</span><span class="op" id="6889786">,</span>&nbsp;<span class="string" id="6889788">&#34;&#34;</span><span class="op" id="6889790">}</span><span class="op" id="6889791">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889795">{</span><span class="op" id="6889796">[</span><span class="op" id="6889797">]</span><span class="keyword" id="6889798">interface</span><span class="op" id="6889807">{</span><span class="op" id="6889808">}</span><span class="op" id="6889809">{</span><span class="string" id="6889810">&#34;Bob&#34;</span><span class="op" id="6889815">,</span>&nbsp;<span class="string" id="6889817">&#34;32&#34;</span><span class="op" id="6889821">}</span><span class="op" id="6889822">,</span>&nbsp;<span class="string" id="6889824">&#34;&#34;</span><span class="op" id="6889826">}</span><span class="op" id="6889827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889831">{</span><span class="op" id="6889832">[</span><span class="op" id="6889833">]</span><span class="keyword" id="6889834">interface</span><span class="op" id="6889843">{</span><span class="op" id="6889844">}</span><span class="op" id="6889845">{</span><span class="num" id="6889846">7</span><span class="op" id="6889847">,</span>&nbsp;<span class="num" id="6889849">9</span><span class="op" id="6889850">}</span><span class="op" id="6889851">,</span>&nbsp;<span class="string" id="6889853">&#34;&#34;</span><span class="op" id="6889855">}</span><span class="op" id="6889856">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6889861">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889887">{</span><span class="op" id="6889888">[</span><span class="op" id="6889889">]</span><span class="keyword" id="6889890">interface</span><span class="op" id="6889899">{</span><span class="op" id="6889900">}</span><span class="op" id="6889901">{</span><span class="string" id="6889902">&#34;Brad&#34;</span><span class="op" id="6889908">,</span>&nbsp;<span class="ident" id="6889910">int64</span><span class="op" id="6889915">(</span><span class="num" id="6889916">0xFFFFFFFF</span><span class="op" id="6889926">)</span><span class="op" id="6889927">}</span><span class="op" id="6889928">,</span>&nbsp;<span class="string" id="6889930">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="6890012">}</span><span class="op" id="6890013">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890017">{</span><span class="op" id="6890018">[</span><span class="op" id="6890019">]</span><span class="keyword" id="6890020">interface</span><span class="op" id="6890029">{</span><span class="op" id="6890030">}</span><span class="op" id="6890031">{</span><span class="string" id="6890032">&#34;Brad&#34;</span><span class="op" id="6890038">,</span>&nbsp;<span class="string" id="6890040">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="6890054">}</span><span class="op" id="6890055">,</span>&nbsp;<span class="string" id="6890057">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="6890157">}</span><span class="op" id="6890158">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6890163">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890190">{</span><span class="op" id="6890191">[</span><span class="op" id="6890192">]</span><span class="keyword" id="6890193">interface</span><span class="op" id="6890202">{</span><span class="op" id="6890203">}</span><span class="op" id="6890204">{</span><span class="op" id="6890205">}</span><span class="op" id="6890206">,</span>&nbsp;<span class="string" id="6890208">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="6890242">}</span><span class="op" id="6890243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890247">{</span><span class="op" id="6890248">[</span><span class="op" id="6890249">]</span><span class="keyword" id="6890250">interface</span><span class="op" id="6890259">{</span><span class="op" id="6890260">}</span><span class="op" id="6890261">{</span><span class="num" id="6890262">1</span><span class="op" id="6890263">,</span>&nbsp;<span class="num" id="6890265">2</span><span class="op" id="6890266">,</span>&nbsp;<span class="num" id="6890268">3</span><span class="op" id="6890269">}</span><span class="op" id="6890270">,</span>&nbsp;<span class="string" id="6890272">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="6890306">}</span><span class="op" id="6890307">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890313">for</span>&nbsp;<span class="ident" id="6890317">n</span><span class="op" id="6890318">,</span>&nbsp;<span class="ident" id="6890320">et</span>&nbsp;<span class="op" id="6890323">:=</span>&nbsp;<span class="keyword" id="6890326">range</span>&nbsp;<span class="ident" id="6890332">execTests</span>&nbsp;<span class="op" id="6890342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890346">_</span><span class="op" id="6890347">,</span>&nbsp;<span class="ident" id="6890349">err</span>&nbsp;<span class="op" id="6890353">:=</span>&nbsp;<span class="ident" id="6890356">stmt</span><span class="op" id="6890360">.</span><span class="ident" id="6890361">Exec</span><span class="op" id="6890365">(</span><span class="ident" id="6890366">et</span><span class="op" id="6890368">.</span><span class="ident" id="6890369">args</span><span class="op" id="6890373">...</span><span class="op" id="6890376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890380">errStr</span>&nbsp;<span class="op" id="6890387">:=</span>&nbsp;<span class="string" id="6890390">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890395">if</span>&nbsp;<span class="ident" id="6890398">err</span>&nbsp;<span class="op" id="6890402">!=</span>&nbsp;<span class="ident" id="6890405">nil</span>&nbsp;<span class="op" id="6890409">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890414">errStr</span>&nbsp;<span class="op" id="6890421">=</span>&nbsp;<span class="ident" id="6890423">err</span><span class="op" id="6890426">.</span><span class="ident" id="6890427">Error</span><span class="op" id="6890432">(</span><span class="op" id="6890433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890441">if</span>&nbsp;<span class="ident" id="6890444">errStr</span>&nbsp;<span class="op" id="6890451">!=</span>&nbsp;<span class="ident" id="6890454">et</span><span class="op" id="6890456">.</span><span class="ident" id="6890457">wantErr</span>&nbsp;<span class="op" id="6890465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890470">t</span><span class="op" id="6890471">.</span><span class="ident" id="6890472">Errorf</span><span class="op" id="6890478">(</span><span class="string" id="6890479">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="6890534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890540">n</span><span class="op" id="6890541">,</span>&nbsp;<span class="ident" id="6890543">et</span><span class="op" id="6890545">.</span><span class="ident" id="6890546">args</span><span class="op" id="6890550">,</span>&nbsp;<span class="ident" id="6890552">errStr</span><span class="op" id="6890558">,</span>&nbsp;<span class="ident" id="6890560">et</span><span class="op" id="6890562">.</span><span class="ident" id="6890563">wantErr</span><span class="op" id="6890570">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890577">}</span><br>
<span class="lineno"></span><span class="op" id="6890579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890582">func</span>&nbsp;<span class="ident" id="6890587">TestTxPrepare</span><span class="op" id="6890600">(</span><span class="ident" id="6890601">t</span>&nbsp;<span class="op" id="6890603">*</span><span class="ident" id="6890604">testing</span><span class="op" id="6890611">.</span><span class="ident" id="6890612">T</span><span class="op" id="6890613">)</span>&nbsp;<span class="op" id="6890615">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890618">db</span>&nbsp;<span class="op" id="6890621">:=</span>&nbsp;<span class="ident" id="6890624">newTestDB</span><span class="op" id="6890633">(</span><span class="ident" id="6890634">t</span><span class="op" id="6890635">,</span>&nbsp;<span class="string" id="6890637">&#34;&#34;</span><span class="op" id="6890639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890642">defer</span>&nbsp;<span class="ident" id="6890648">closeDB</span><span class="op" id="6890655">(</span><span class="ident" id="6890656">t</span><span class="op" id="6890657">,</span>&nbsp;<span class="ident" id="6890659">db</span><span class="op" id="6890661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890664">exec</span><span class="op" id="6890668">(</span><span class="ident" id="6890669">t</span><span class="op" id="6890670">,</span>&nbsp;<span class="ident" id="6890672">db</span><span class="op" id="6890674">,</span>&nbsp;<span class="string" id="6890676">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6890719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890722">tx</span><span class="op" id="6890724">,</span>&nbsp;<span class="ident" id="6890726">err</span>&nbsp;<span class="op" id="6890730">:=</span>&nbsp;<span class="ident" id="6890733">db</span><span class="op" id="6890735">.</span><span class="ident" id="6890736">Begin</span><span class="op" id="6890741">(</span><span class="op" id="6890742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890745">if</span>&nbsp;<span class="ident" id="6890748">err</span>&nbsp;<span class="op" id="6890752">!=</span>&nbsp;<span class="ident" id="6890755">nil</span>&nbsp;<span class="op" id="6890759">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890763">t</span><span class="op" id="6890764">.</span><span class="ident" id="6890765">Fatalf</span><span class="op" id="6890771">(</span><span class="string" id="6890772">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6890784">,</span>&nbsp;<span class="ident" id="6890786">err</span><span class="op" id="6890789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890795">stmt</span><span class="op" id="6890799">,</span>&nbsp;<span class="ident" id="6890801">err</span>&nbsp;<span class="op" id="6890805">:=</span>&nbsp;<span class="ident" id="6890808">tx</span><span class="op" id="6890810">.</span><span class="ident" id="6890811">Prepare</span><span class="op" id="6890818">(</span><span class="string" id="6890819">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6890843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890846">if</span>&nbsp;<span class="ident" id="6890849">err</span>&nbsp;<span class="op" id="6890853">!=</span>&nbsp;<span class="ident" id="6890856">nil</span>&nbsp;<span class="op" id="6890860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890864">t</span><span class="op" id="6890865">.</span><span class="ident" id="6890866">Fatalf</span><span class="op" id="6890872">(</span><span class="string" id="6890873">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6890893">,</span>&nbsp;<span class="ident" id="6890895">stmt</span><span class="op" id="6890899">,</span>&nbsp;<span class="ident" id="6890901">err</span><span class="op" id="6890904">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890910">defer</span>&nbsp;<span class="ident" id="6890916">stmt</span><span class="op" id="6890920">.</span><span class="ident" id="6890921">Close</span><span class="op" id="6890926">(</span><span class="op" id="6890927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890930">_</span><span class="op" id="6890931">,</span>&nbsp;<span class="ident" id="6890933">err</span>&nbsp;<span class="op" id="6890937">=</span>&nbsp;<span class="ident" id="6890939">stmt</span><span class="op" id="6890943">.</span><span class="ident" id="6890944">Exec</span><span class="op" id="6890948">(</span><span class="string" id="6890949">&#34;Bobby&#34;</span><span class="op" id="6890956">,</span>&nbsp;<span class="num" id="6890958">7</span><span class="op" id="6890959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890962">if</span>&nbsp;<span class="ident" id="6890965">err</span>&nbsp;<span class="op" id="6890969">!=</span>&nbsp;<span class="ident" id="6890972">nil</span>&nbsp;<span class="op" id="6890976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890980">t</span><span class="op" id="6890981">.</span><span class="ident" id="6890982">Fatalf</span><span class="op" id="6890988">(</span><span class="string" id="6890989">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6891000">,</span>&nbsp;<span class="ident" id="6891002">err</span><span class="op" id="6891005">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891011">err</span>&nbsp;<span class="op" id="6891015">=</span>&nbsp;<span class="ident" id="6891017">tx</span><span class="op" id="6891019">.</span><span class="ident" id="6891020">Commit</span><span class="op" id="6891026">(</span><span class="op" id="6891027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891030">if</span>&nbsp;<span class="ident" id="6891033">err</span>&nbsp;<span class="op" id="6891037">!=</span>&nbsp;<span class="ident" id="6891040">nil</span>&nbsp;<span class="op" id="6891044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891048">t</span><span class="op" id="6891049">.</span><span class="ident" id="6891050">Fatalf</span><span class="op" id="6891056">(</span><span class="string" id="6891057">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6891070">,</span>&nbsp;<span class="ident" id="6891072">err</span><span class="op" id="6891075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891078">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6891081">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891127">if</span>&nbsp;<span class="op" id="6891130">!</span><span class="ident" id="6891131">stmt</span><span class="op" id="6891135">.</span><span class="ident" id="6891136">closed</span>&nbsp;<span class="op" id="6891143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891147">t</span><span class="op" id="6891148">.</span><span class="ident" id="6891149">Fatal</span><span class="op" id="6891154">(</span><span class="string" id="6891155">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6891185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891188">}</span><br>
<span class="lineno"></span><span class="op" id="6891190">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="6891193">func</span>&nbsp;<span class="ident" id="6891198">TestTxStmt</span><span class="op" id="6891208">(</span><span class="ident" id="6891209">t</span>&nbsp;<span class="op" id="6891211">*</span><span class="ident" id="6891212">testing</span><span class="op" id="6891219">.</span><span class="ident" id="6891220">T</span><span class="op" id="6891221">)</span>&nbsp;<span class="op" id="6891223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891226">db</span>&nbsp;<span class="op" id="6891229">:=</span>&nbsp;<span class="ident" id="6891232">newTestDB</span><span class="op" id="6891241">(</span><span class="ident" id="6891242">t</span><span class="op" id="6891243">,</span>&nbsp;<span class="string" id="6891245">&#34;&#34;</span><span class="op" id="6891247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891250">defer</span>&nbsp;<span class="ident" id="6891256">closeDB</span><span class="op" id="6891263">(</span><span class="ident" id="6891264">t</span><span class="op" id="6891265">,</span>&nbsp;<span class="ident" id="6891267">db</span><span class="op" id="6891269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891272">exec</span><span class="op" id="6891276">(</span><span class="ident" id="6891277">t</span><span class="op" id="6891278">,</span>&nbsp;<span class="ident" id="6891280">db</span><span class="op" id="6891282">,</span>&nbsp;<span class="string" id="6891284">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6891327">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891330">stmt</span><span class="op" id="6891334">,</span>&nbsp;<span class="ident" id="6891336">err</span>&nbsp;<span class="op" id="6891340">:=</span>&nbsp;<span class="ident" id="6891343">db</span><span class="op" id="6891345">.</span><span class="ident" id="6891346">Prepare</span><span class="op" id="6891353">(</span><span class="string" id="6891354">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6891378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891381">if</span>&nbsp;<span class="ident" id="6891384">err</span>&nbsp;<span class="op" id="6891388">!=</span>&nbsp;<span class="ident" id="6891391">nil</span>&nbsp;<span class="op" id="6891395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891399">t</span><span class="op" id="6891400">.</span><span class="ident" id="6891401">Fatalf</span><span class="op" id="6891407">(</span><span class="string" id="6891408">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6891428">,</span>&nbsp;<span class="ident" id="6891430">stmt</span><span class="op" id="6891434">,</span>&nbsp;<span class="ident" id="6891436">err</span><span class="op" id="6891439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891445">defer</span>&nbsp;<span class="ident" id="6891451">stmt</span><span class="op" id="6891455">.</span><span class="ident" id="6891456">Close</span><span class="op" id="6891461">(</span><span class="op" id="6891462">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891465">tx</span><span class="op" id="6891467">,</span>&nbsp;<span class="ident" id="6891469">err</span>&nbsp;<span class="op" id="6891473">:=</span>&nbsp;<span class="ident" id="6891476">db</span><span class="op" id="6891478">.</span><span class="ident" id="6891479">Begin</span><span class="op" id="6891484">(</span><span class="op" id="6891485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891488">if</span>&nbsp;<span class="ident" id="6891491">err</span>&nbsp;<span class="op" id="6891495">!=</span>&nbsp;<span class="ident" id="6891498">nil</span>&nbsp;<span class="op" id="6891502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891506">t</span><span class="op" id="6891507">.</span><span class="ident" id="6891508">Fatalf</span><span class="op" id="6891514">(</span><span class="string" id="6891515">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6891527">,</span>&nbsp;<span class="ident" id="6891529">err</span><span class="op" id="6891532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891538">txs</span>&nbsp;<span class="op" id="6891542">:=</span>&nbsp;<span class="ident" id="6891545">tx</span><span class="op" id="6891547">.</span><span class="ident" id="6891548">Stmt</span><span class="op" id="6891552">(</span><span class="ident" id="6891553">stmt</span><span class="op" id="6891557">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891560">defer</span>&nbsp;<span class="ident" id="6891566">txs</span><span class="op" id="6891569">.</span><span class="ident" id="6891570">Close</span><span class="op" id="6891575">(</span><span class="op" id="6891576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891579">_</span><span class="op" id="6891580">,</span>&nbsp;<span class="ident" id="6891582">err</span>&nbsp;<span class="op" id="6891586">=</span>&nbsp;<span class="ident" id="6891588">txs</span><span class="op" id="6891591">.</span><span class="ident" id="6891592">Exec</span><span class="op" id="6891596">(</span><span class="string" id="6891597">&#34;Bobby&#34;</span><span class="op" id="6891604">,</span>&nbsp;<span class="num" id="6891606">7</span><span class="op" id="6891607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891610">if</span>&nbsp;<span class="ident" id="6891613">err</span>&nbsp;<span class="op" id="6891617">!=</span>&nbsp;<span class="ident" id="6891620">nil</span>&nbsp;<span class="op" id="6891624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891628">t</span><span class="op" id="6891629">.</span><span class="ident" id="6891630">Fatalf</span><span class="op" id="6891636">(</span><span class="string" id="6891637">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6891648">,</span>&nbsp;<span class="ident" id="6891650">err</span><span class="op" id="6891653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891656">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891659">err</span>&nbsp;<span class="op" id="6891663">=</span>&nbsp;<span class="ident" id="6891665">tx</span><span class="op" id="6891667">.</span><span class="ident" id="6891668">Commit</span><span class="op" id="6891674">(</span><span class="op" id="6891675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891678">if</span>&nbsp;<span class="ident" id="6891681">err</span>&nbsp;<span class="op" id="6891685">!=</span>&nbsp;<span class="ident" id="6891688">nil</span>&nbsp;<span class="op" id="6891692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891696">t</span><span class="op" id="6891697">.</span><span class="ident" id="6891698">Fatalf</span><span class="op" id="6891704">(</span><span class="string" id="6891705">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6891718">,</span>&nbsp;<span class="ident" id="6891720">err</span><span class="op" id="6891723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6891729">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891775">if</span>&nbsp;<span class="op" id="6891778">!</span><span class="ident" id="6891779">txs</span><span class="op" id="6891782">.</span><span class="ident" id="6891783">closed</span>&nbsp;<span class="op" id="6891790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891794">t</span><span class="op" id="6891795">.</span><span class="ident" id="6891796">Fatal</span><span class="op" id="6891801">(</span><span class="string" id="6891802">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="6891832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891835">}</span><br>
<span class="lineno"></span><span class="op" id="6891837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="6891840">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="6891879">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="6891956">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="6892023">func</span>&nbsp;<span class="ident" id="6892028">TestTxQuery</span><span class="op" id="6892039">(</span><span class="ident" id="6892040">t</span>&nbsp;<span class="op" id="6892042">*</span><span class="ident" id="6892043">testing</span><span class="op" id="6892050">.</span><span class="ident" id="6892051">T</span><span class="op" id="6892052">)</span>&nbsp;<span class="op" id="6892054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892057">db</span>&nbsp;<span class="op" id="6892060">:=</span>&nbsp;<span class="ident" id="6892063">newTestDB</span><span class="op" id="6892072">(</span><span class="ident" id="6892073">t</span><span class="op" id="6892074">,</span>&nbsp;<span class="string" id="6892076">&#34;&#34;</span><span class="op" id="6892078">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892081">defer</span>&nbsp;<span class="ident" id="6892087">closeDB</span><span class="op" id="6892094">(</span><span class="ident" id="6892095">t</span><span class="op" id="6892096">,</span>&nbsp;<span class="ident" id="6892098">db</span><span class="op" id="6892100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892103">exec</span><span class="op" id="6892107">(</span><span class="ident" id="6892108">t</span><span class="op" id="6892109">,</span>&nbsp;<span class="ident" id="6892111">db</span><span class="op" id="6892113">,</span>&nbsp;<span class="string" id="6892115">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6892158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892161">exec</span><span class="op" id="6892165">(</span><span class="ident" id="6892166">t</span><span class="op" id="6892167">,</span>&nbsp;<span class="ident" id="6892169">db</span><span class="op" id="6892171">,</span>&nbsp;<span class="string" id="6892173">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="6892195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892199">tx</span><span class="op" id="6892201">,</span>&nbsp;<span class="ident" id="6892203">err</span>&nbsp;<span class="op" id="6892207">:=</span>&nbsp;<span class="ident" id="6892210">db</span><span class="op" id="6892212">.</span><span class="ident" id="6892213">Begin</span><span class="op" id="6892218">(</span><span class="op" id="6892219">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892222">if</span>&nbsp;<span class="ident" id="6892225">err</span>&nbsp;<span class="op" id="6892229">!=</span>&nbsp;<span class="ident" id="6892232">nil</span>&nbsp;<span class="op" id="6892236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892240">t</span><span class="op" id="6892241">.</span><span class="ident" id="6892242">Fatal</span><span class="op" id="6892247">(</span><span class="ident" id="6892248">err</span><span class="op" id="6892251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892257">defer</span>&nbsp;<span class="ident" id="6892263">tx</span><span class="op" id="6892265">.</span><span class="ident" id="6892266">Rollback</span><span class="op" id="6892274">(</span><span class="op" id="6892275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892279">r</span><span class="op" id="6892280">,</span>&nbsp;<span class="ident" id="6892282">err</span>&nbsp;<span class="op" id="6892286">:=</span>&nbsp;<span class="ident" id="6892289">tx</span><span class="op" id="6892291">.</span><span class="ident" id="6892292">Query</span><span class="op" id="6892297">(</span><span class="string" id="6892298">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6892315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892318">if</span>&nbsp;<span class="ident" id="6892321">err</span>&nbsp;<span class="op" id="6892325">!=</span>&nbsp;<span class="ident" id="6892328">nil</span>&nbsp;<span class="op" id="6892332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892336">t</span><span class="op" id="6892337">.</span><span class="ident" id="6892338">Fatal</span><span class="op" id="6892343">(</span><span class="ident" id="6892344">err</span><span class="op" id="6892347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892353">defer</span>&nbsp;<span class="ident" id="6892359">r</span><span class="op" id="6892360">.</span><span class="ident" id="6892361">Close</span><span class="op" id="6892366">(</span><span class="op" id="6892367">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892371">if</span>&nbsp;<span class="op" id="6892374">!</span><span class="ident" id="6892375">r</span><span class="op" id="6892376">.</span><span class="ident" id="6892377">Next</span><span class="op" id="6892381">(</span><span class="op" id="6892382">)</span>&nbsp;<span class="op" id="6892384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892388">if</span>&nbsp;<span class="ident" id="6892391">r</span><span class="op" id="6892392">.</span><span class="ident" id="6892393">Err</span><span class="op" id="6892396">(</span><span class="op" id="6892397">)</span>&nbsp;<span class="op" id="6892399">!=</span>&nbsp;<span class="ident" id="6892402">nil</span>&nbsp;<span class="op" id="6892406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892411">t</span><span class="op" id="6892412">.</span><span class="ident" id="6892413">Fatal</span><span class="op" id="6892418">(</span><span class="ident" id="6892419">r</span><span class="op" id="6892420">.</span><span class="ident" id="6892421">Err</span><span class="op" id="6892424">(</span><span class="op" id="6892425">)</span><span class="op" id="6892426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892430">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892434">t</span><span class="op" id="6892435">.</span><span class="ident" id="6892436">Fatal</span><span class="op" id="6892441">(</span><span class="string" id="6892442">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="6892460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892467">var</span>&nbsp;<span class="ident" id="6892471">x</span>&nbsp;<span class="builtintype" id="6892473">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892481">err</span>&nbsp;<span class="op" id="6892485">=</span>&nbsp;<span class="ident" id="6892487">r</span><span class="op" id="6892488">.</span><span class="ident" id="6892489">Scan</span><span class="op" id="6892493">(</span><span class="op" id="6892494">&amp;</span><span class="ident" id="6892495">x</span><span class="op" id="6892496">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892499">if</span>&nbsp;<span class="ident" id="6892502">err</span>&nbsp;<span class="op" id="6892506">!=</span>&nbsp;<span class="ident" id="6892509">nil</span>&nbsp;<span class="op" id="6892513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892517">t</span><span class="op" id="6892518">.</span><span class="ident" id="6892519">Fatal</span><span class="op" id="6892524">(</span><span class="ident" id="6892525">err</span><span class="op" id="6892528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892531">}</span><br>
<span class="lineno"></span><span class="op" id="6892533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6892536">func</span>&nbsp;<span class="ident" id="6892541">TestTxQueryInvalid</span><span class="op" id="6892559">(</span><span class="ident" id="6892560">t</span>&nbsp;<span class="op" id="6892562">*</span><span class="ident" id="6892563">testing</span><span class="op" id="6892570">.</span><span class="ident" id="6892571">T</span><span class="op" id="6892572">)</span>&nbsp;<span class="op" id="6892574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892577">db</span>&nbsp;<span class="op" id="6892580">:=</span>&nbsp;<span class="ident" id="6892583">newTestDB</span><span class="op" id="6892592">(</span><span class="ident" id="6892593">t</span><span class="op" id="6892594">,</span>&nbsp;<span class="string" id="6892596">&#34;&#34;</span><span class="op" id="6892598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892601">defer</span>&nbsp;<span class="ident" id="6892607">closeDB</span><span class="op" id="6892614">(</span><span class="ident" id="6892615">t</span><span class="op" id="6892616">,</span>&nbsp;<span class="ident" id="6892618">db</span><span class="op" id="6892620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892624">tx</span><span class="op" id="6892626">,</span>&nbsp;<span class="ident" id="6892628">err</span>&nbsp;<span class="op" id="6892632">:=</span>&nbsp;<span class="ident" id="6892635">db</span><span class="op" id="6892637">.</span><span class="ident" id="6892638">Begin</span><span class="op" id="6892643">(</span><span class="op" id="6892644">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892647">if</span>&nbsp;<span class="ident" id="6892650">err</span>&nbsp;<span class="op" id="6892654">!=</span>&nbsp;<span class="ident" id="6892657">nil</span>&nbsp;<span class="op" id="6892661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892665">t</span><span class="op" id="6892666">.</span><span class="ident" id="6892667">Fatal</span><span class="op" id="6892672">(</span><span class="ident" id="6892673">err</span><span class="op" id="6892676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892682">defer</span>&nbsp;<span class="ident" id="6892688">tx</span><span class="op" id="6892690">.</span><span class="ident" id="6892691">Rollback</span><span class="op" id="6892699">(</span><span class="op" id="6892700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892704">_</span><span class="op" id="6892705">,</span>&nbsp;<span class="ident" id="6892707">err</span>&nbsp;<span class="op" id="6892711">=</span>&nbsp;<span class="ident" id="6892713">tx</span><span class="op" id="6892715">.</span><span class="ident" id="6892716">Query</span><span class="op" id="6892721">(</span><span class="string" id="6892722">&#34;SELECT|t1|name|&#34;</span><span class="op" id="6892739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892742">if</span>&nbsp;<span class="ident" id="6892745">err</span>&nbsp;<span class="op" id="6892749">==</span>&nbsp;<span class="ident" id="6892752">nil</span>&nbsp;<span class="op" id="6892756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892760">t</span><span class="op" id="6892761">.</span><span class="ident" id="6892762">Fatal</span><span class="op" id="6892767">(</span><span class="string" id="6892768">&#34;Error&nbsp;expected&#34;</span><span class="op" id="6892784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892787">}</span><br>
<span class="lineno"></span><span class="op" id="6892789">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="6892792">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6892855">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="6892890">func</span>&nbsp;<span class="ident" id="6892895">TestTxErrBadConn</span><span class="op" id="6892911">(</span><span class="ident" id="6892912">t</span>&nbsp;<span class="op" id="6892914">*</span><span class="ident" id="6892915">testing</span><span class="op" id="6892922">.</span><span class="ident" id="6892923">T</span><span class="op" id="6892924">)</span>&nbsp;<span class="op" id="6892926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892929">db</span><span class="op" id="6892931">,</span>&nbsp;<span class="ident" id="6892933">err</span>&nbsp;<span class="op" id="6892937">:=</span>&nbsp;<span class="ident" id="6892940">Open</span><span class="op" id="6892944">(</span><span class="string" id="6892945">&#34;test&#34;</span><span class="op" id="6892951">,</span>&nbsp;<span class="ident" id="6892953">fakeDBName</span><span class="op" id="6892963">+</span><span class="string" id="6892964">&#34;;badConn&#34;</span><span class="op" id="6892974">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892977">if</span>&nbsp;<span class="ident" id="6892980">err</span>&nbsp;<span class="op" id="6892984">!=</span>&nbsp;<span class="ident" id="6892987">nil</span>&nbsp;<span class="op" id="6892991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892995">t</span><span class="op" id="6892996">.</span><span class="ident" id="6892997">Fatalf</span><span class="op" id="6893003">(</span><span class="string" id="6893004">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="6893014">,</span>&nbsp;<span class="ident" id="6893016">err</span><span class="op" id="6893019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893025">if</span>&nbsp;<span class="ident" id="6893028">_</span><span class="op" id="6893029">,</span>&nbsp;<span class="ident" id="6893031">err</span>&nbsp;<span class="op" id="6893035">:=</span>&nbsp;<span class="ident" id="6893038">db</span><span class="op" id="6893040">.</span><span class="ident" id="6893041">Exec</span><span class="op" id="6893045">(</span><span class="string" id="6893046">&#34;WIPE&#34;</span><span class="op" id="6893052">)</span><span class="op" id="6893053">;</span>&nbsp;<span class="ident" id="6893055">err</span>&nbsp;<span class="op" id="6893059">!=</span>&nbsp;<span class="ident" id="6893062">nil</span>&nbsp;<span class="op" id="6893066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893070">t</span><span class="op" id="6893071">.</span><span class="ident" id="6893072">Fatalf</span><span class="op" id="6893078">(</span><span class="string" id="6893079">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="6893094">,</span>&nbsp;<span class="ident" id="6893096">err</span><span class="op" id="6893099">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893105">defer</span>&nbsp;<span class="ident" id="6893111">closeDB</span><span class="op" id="6893118">(</span><span class="ident" id="6893119">t</span><span class="op" id="6893120">,</span>&nbsp;<span class="ident" id="6893122">db</span><span class="op" id="6893124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893127">exec</span><span class="op" id="6893131">(</span><span class="ident" id="6893132">t</span><span class="op" id="6893133">,</span>&nbsp;<span class="ident" id="6893135">db</span><span class="op" id="6893137">,</span>&nbsp;<span class="string" id="6893139">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6893182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893185">stmt</span><span class="op" id="6893189">,</span>&nbsp;<span class="ident" id="6893191">err</span>&nbsp;<span class="op" id="6893195">:=</span>&nbsp;<span class="ident" id="6893198">db</span><span class="op" id="6893200">.</span><span class="ident" id="6893201">Prepare</span><span class="op" id="6893208">(</span><span class="string" id="6893209">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="6893233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893236">if</span>&nbsp;<span class="ident" id="6893239">err</span>&nbsp;<span class="op" id="6893243">!=</span>&nbsp;<span class="ident" id="6893246">nil</span>&nbsp;<span class="op" id="6893250">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893254">t</span><span class="op" id="6893255">.</span><span class="ident" id="6893256">Fatalf</span><span class="op" id="6893262">(</span><span class="string" id="6893263">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="6893283">,</span>&nbsp;<span class="ident" id="6893285">stmt</span><span class="op" id="6893289">,</span>&nbsp;<span class="ident" id="6893291">err</span><span class="op" id="6893294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893300">defer</span>&nbsp;<span class="ident" id="6893306">stmt</span><span class="op" id="6893310">.</span><span class="ident" id="6893311">Close</span><span class="op" id="6893316">(</span><span class="op" id="6893317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893320">tx</span><span class="op" id="6893322">,</span>&nbsp;<span class="ident" id="6893324">err</span>&nbsp;<span class="op" id="6893328">:=</span>&nbsp;<span class="ident" id="6893331">db</span><span class="op" id="6893333">.</span><span class="ident" id="6893334">Begin</span><span class="op" id="6893339">(</span><span class="op" id="6893340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893343">if</span>&nbsp;<span class="ident" id="6893346">err</span>&nbsp;<span class="op" id="6893350">!=</span>&nbsp;<span class="ident" id="6893353">nil</span>&nbsp;<span class="op" id="6893357">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893361">t</span><span class="op" id="6893362">.</span><span class="ident" id="6893363">Fatalf</span><span class="op" id="6893369">(</span><span class="string" id="6893370">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6893382">,</span>&nbsp;<span class="ident" id="6893384">err</span><span class="op" id="6893387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893393">txs</span>&nbsp;<span class="op" id="6893397">:=</span>&nbsp;<span class="ident" id="6893400">tx</span><span class="op" id="6893402">.</span><span class="ident" id="6893403">Stmt</span><span class="op" id="6893407">(</span><span class="ident" id="6893408">stmt</span><span class="op" id="6893412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893415">defer</span>&nbsp;<span class="ident" id="6893421">txs</span><span class="op" id="6893424">.</span><span class="ident" id="6893425">Close</span><span class="op" id="6893430">(</span><span class="op" id="6893431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893434">_</span><span class="op" id="6893435">,</span>&nbsp;<span class="ident" id="6893437">err</span>&nbsp;<span class="op" id="6893441">=</span>&nbsp;<span class="ident" id="6893443">txs</span><span class="op" id="6893446">.</span><span class="ident" id="6893447">Exec</span><span class="op" id="6893451">(</span><span class="string" id="6893452">&#34;Bobby&#34;</span><span class="op" id="6893459">,</span>&nbsp;<span class="num" id="6893461">7</span><span class="op" id="6893462">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893465">if</span>&nbsp;<span class="ident" id="6893468">err</span>&nbsp;<span class="op" id="6893472">!=</span>&nbsp;<span class="ident" id="6893475">nil</span>&nbsp;<span class="op" id="6893479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893483">t</span><span class="op" id="6893484">.</span><span class="ident" id="6893485">Fatalf</span><span class="op" id="6893491">(</span><span class="string" id="6893492">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6893503">,</span>&nbsp;<span class="ident" id="6893505">err</span><span class="op" id="6893508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893514">err</span>&nbsp;<span class="op" id="6893518">=</span>&nbsp;<span class="ident" id="6893520">tx</span><span class="op" id="6893522">.</span><span class="ident" id="6893523">Commit</span><span class="op" id="6893529">(</span><span class="op" id="6893530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893533">if</span>&nbsp;<span class="ident" id="6893536">err</span>&nbsp;<span class="op" id="6893540">!=</span>&nbsp;<span class="ident" id="6893543">nil</span>&nbsp;<span class="op" id="6893547">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893551">t</span><span class="op" id="6893552">.</span><span class="ident" id="6893553">Fatalf</span><span class="op" id="6893559">(</span><span class="string" id="6893560">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6893573">,</span>&nbsp;<span class="ident" id="6893575">err</span><span class="op" id="6893578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893581">}</span><br>
<span class="lineno"></span><span class="op" id="6893583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6893586">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="6893655">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6893679">func</span>&nbsp;<span class="ident" id="6893684">TestIssue2542Deadlock</span><span class="op" id="6893705">(</span><span class="ident" id="6893706">t</span>&nbsp;<span class="op" id="6893708">*</span><span class="ident" id="6893709">testing</span><span class="op" id="6893716">.</span><span class="ident" id="6893717">T</span><span class="op" id="6893718">)</span>&nbsp;<span class="op" id="6893720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893723">db</span>&nbsp;<span class="op" id="6893726">:=</span>&nbsp;<span class="ident" id="6893729">newTestDB</span><span class="op" id="6893738">(</span><span class="ident" id="6893739">t</span><span class="op" id="6893740">,</span>&nbsp;<span class="string" id="6893742">&#34;people&#34;</span><span class="op" id="6893750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893753">closeDB</span><span class="op" id="6893760">(</span><span class="ident" id="6893761">t</span><span class="op" id="6893762">,</span>&nbsp;<span class="ident" id="6893764">db</span><span class="op" id="6893766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893769">for</span>&nbsp;<span class="ident" id="6893773">i</span>&nbsp;<span class="op" id="6893775">:=</span>&nbsp;<span class="num" id="6893778">0</span><span class="op" id="6893779">;</span>&nbsp;<span class="ident" id="6893781">i</span>&nbsp;<span class="op" id="6893783">&lt;</span>&nbsp;<span class="num" id="6893785">2</span><span class="op" id="6893786">;</span>&nbsp;<span class="ident" id="6893788">i</span><span class="op" id="6893789">++</span>&nbsp;<span class="op" id="6893792">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893796">_</span><span class="op" id="6893797">,</span>&nbsp;<span class="ident" id="6893799">err</span>&nbsp;<span class="op" id="6893803">:=</span>&nbsp;<span class="ident" id="6893806">db</span><span class="op" id="6893808">.</span><span class="ident" id="6893809">Query</span><span class="op" id="6893814">(</span><span class="string" id="6893815">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6893840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893844">if</span>&nbsp;<span class="ident" id="6893847">err</span>&nbsp;<span class="op" id="6893851">==</span>&nbsp;<span class="ident" id="6893854">nil</span>&nbsp;<span class="op" id="6893858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893863">t</span><span class="op" id="6893864">.</span><span class="ident" id="6893865">Fatalf</span><span class="op" id="6893871">(</span><span class="string" id="6893872">&#34;expected&nbsp;error&#34;</span><span class="op" id="6893888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893895">}</span><br>
<span class="lineno">595</span><span class="op" id="6893897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6893900">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="6893930">func</span>&nbsp;<span class="ident" id="6893935">TestCloseStmtBeforeRows</span><span class="op" id="6893958">(</span><span class="ident" id="6893959">t</span>&nbsp;<span class="op" id="6893961">*</span><span class="ident" id="6893962">testing</span><span class="op" id="6893969">.</span><span class="ident" id="6893970">T</span><span class="op" id="6893971">)</span>&nbsp;<span class="op" id="6893973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893976">db</span>&nbsp;<span class="op" id="6893979">:=</span>&nbsp;<span class="ident" id="6893982">newTestDB</span><span class="op" id="6893991">(</span><span class="ident" id="6893992">t</span><span class="op" id="6893993">,</span>&nbsp;<span class="string" id="6893995">&#34;people&#34;</span><span class="op" id="6894003">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894006">defer</span>&nbsp;<span class="ident" id="6894012">closeDB</span><span class="op" id="6894019">(</span><span class="ident" id="6894020">t</span><span class="op" id="6894021">,</span>&nbsp;<span class="ident" id="6894023">db</span><span class="op" id="6894025">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894029">s</span><span class="op" id="6894030">,</span>&nbsp;<span class="ident" id="6894032">err</span>&nbsp;<span class="op" id="6894036">:=</span>&nbsp;<span class="ident" id="6894039">db</span><span class="op" id="6894041">.</span><span class="ident" id="6894042">Prepare</span><span class="op" id="6894049">(</span><span class="string" id="6894050">&#34;SELECT|people|name|&#34;</span><span class="op" id="6894071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894074">if</span>&nbsp;<span class="ident" id="6894077">err</span>&nbsp;<span class="op" id="6894081">!=</span>&nbsp;<span class="ident" id="6894084">nil</span>&nbsp;<span class="op" id="6894088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894092">t</span><span class="op" id="6894093">.</span><span class="ident" id="6894094">Fatal</span><span class="op" id="6894099">(</span><span class="ident" id="6894100">err</span><span class="op" id="6894103">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894110">r</span><span class="op" id="6894111">,</span>&nbsp;<span class="ident" id="6894113">err</span>&nbsp;<span class="op" id="6894117">:=</span>&nbsp;<span class="ident" id="6894120">s</span><span class="op" id="6894121">.</span><span class="ident" id="6894122">Query</span><span class="op" id="6894127">(</span><span class="op" id="6894128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894131">if</span>&nbsp;<span class="ident" id="6894134">err</span>&nbsp;<span class="op" id="6894138">!=</span>&nbsp;<span class="ident" id="6894141">nil</span>&nbsp;<span class="op" id="6894145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894149">s</span><span class="op" id="6894150">.</span><span class="ident" id="6894151">Close</span><span class="op" id="6894156">(</span><span class="op" id="6894157">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894161">t</span><span class="op" id="6894162">.</span><span class="ident" id="6894163">Fatal</span><span class="op" id="6894168">(</span><span class="ident" id="6894169">err</span><span class="op" id="6894172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894179">err</span>&nbsp;<span class="op" id="6894183">=</span>&nbsp;<span class="ident" id="6894185">s</span><span class="op" id="6894186">.</span><span class="ident" id="6894187">Close</span><span class="op" id="6894192">(</span><span class="op" id="6894193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894196">if</span>&nbsp;<span class="ident" id="6894199">err</span>&nbsp;<span class="op" id="6894203">!=</span>&nbsp;<span class="ident" id="6894206">nil</span>&nbsp;<span class="op" id="6894210">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894214">t</span><span class="op" id="6894215">.</span><span class="ident" id="6894216">Fatal</span><span class="op" id="6894221">(</span><span class="ident" id="6894222">err</span><span class="op" id="6894225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894232">r</span><span class="op" id="6894233">.</span><span class="ident" id="6894234">Close</span><span class="op" id="6894239">(</span><span class="op" id="6894240">)</span><br>
<span class="lineno"></span><span class="op" id="6894242">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="6894245">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6894310">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="6894345">func</span>&nbsp;<span class="ident" id="6894350">TestNullByteSlice</span><span class="op" id="6894367">(</span><span class="ident" id="6894368">t</span>&nbsp;<span class="op" id="6894370">*</span><span class="ident" id="6894371">testing</span><span class="op" id="6894378">.</span><span class="ident" id="6894379">T</span><span class="op" id="6894380">)</span>&nbsp;<span class="op" id="6894382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894385">db</span>&nbsp;<span class="op" id="6894388">:=</span>&nbsp;<span class="ident" id="6894391">newTestDB</span><span class="op" id="6894400">(</span><span class="ident" id="6894401">t</span><span class="op" id="6894402">,</span>&nbsp;<span class="string" id="6894404">&#34;&#34;</span><span class="op" id="6894406">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894409">defer</span>&nbsp;<span class="ident" id="6894415">closeDB</span><span class="op" id="6894422">(</span><span class="ident" id="6894423">t</span><span class="op" id="6894424">,</span>&nbsp;<span class="ident" id="6894426">db</span><span class="op" id="6894428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894431">exec</span><span class="op" id="6894435">(</span><span class="ident" id="6894436">t</span><span class="op" id="6894437">,</span>&nbsp;<span class="ident" id="6894439">db</span><span class="op" id="6894441">,</span>&nbsp;<span class="string" id="6894443">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6894478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894481">exec</span><span class="op" id="6894485">(</span><span class="ident" id="6894486">t</span><span class="op" id="6894487">,</span>&nbsp;<span class="ident" id="6894489">db</span><span class="op" id="6894491">,</span>&nbsp;<span class="string" id="6894493">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6894516">,</span>&nbsp;<span class="ident" id="6894518">nil</span><span class="op" id="6894521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894525">var</span>&nbsp;<span class="ident" id="6894529">name</span>&nbsp;<span class="op" id="6894534">[</span><span class="op" id="6894535">]</span><span class="builtintype" id="6894536">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894543">err</span>&nbsp;<span class="op" id="6894547">:=</span>&nbsp;<span class="ident" id="6894550">db</span><span class="op" id="6894552">.</span><span class="ident" id="6894553">QueryRow</span><span class="op" id="6894561">(</span><span class="string" id="6894562">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6894582">,</span>&nbsp;<span class="num" id="6894584">10</span><span class="op" id="6894586">)</span><span class="op" id="6894587">.</span><span class="ident" id="6894588">Scan</span><span class="op" id="6894592">(</span><span class="op" id="6894593">&amp;</span><span class="ident" id="6894594">name</span><span class="op" id="6894598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894601">if</span>&nbsp;<span class="ident" id="6894604">err</span>&nbsp;<span class="op" id="6894608">!=</span>&nbsp;<span class="ident" id="6894611">nil</span>&nbsp;<span class="op" id="6894615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894619">t</span><span class="op" id="6894620">.</span><span class="ident" id="6894621">Fatal</span><span class="op" id="6894626">(</span><span class="ident" id="6894627">err</span><span class="op" id="6894630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894633">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894636">if</span>&nbsp;<span class="ident" id="6894639">name</span>&nbsp;<span class="op" id="6894644">!=</span>&nbsp;<span class="ident" id="6894647">nil</span>&nbsp;<span class="op" id="6894651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894655">t</span><span class="op" id="6894656">.</span><span class="ident" id="6894657">Fatalf</span><span class="op" id="6894663">(</span><span class="string" id="6894664">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="6894723">,</span>&nbsp;<span class="ident" id="6894725">name</span><span class="op" id="6894729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894736">exec</span><span class="op" id="6894740">(</span><span class="ident" id="6894741">t</span><span class="op" id="6894742">,</span>&nbsp;<span class="ident" id="6894744">db</span><span class="op" id="6894746">,</span>&nbsp;<span class="string" id="6894748">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="6894771">,</span>&nbsp;<span class="string" id="6894773">&#34;bob&#34;</span><span class="op" id="6894778">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894781">err</span>&nbsp;<span class="op" id="6894785">=</span>&nbsp;<span class="ident" id="6894787">db</span><span class="op" id="6894789">.</span><span class="ident" id="6894790">QueryRow</span><span class="op" id="6894798">(</span><span class="string" id="6894799">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6894819">,</span>&nbsp;<span class="num" id="6894821">11</span><span class="op" id="6894823">)</span><span class="op" id="6894824">.</span><span class="ident" id="6894825">Scan</span><span class="op" id="6894829">(</span><span class="op" id="6894830">&amp;</span><span class="ident" id="6894831">name</span><span class="op" id="6894835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894838">if</span>&nbsp;<span class="ident" id="6894841">err</span>&nbsp;<span class="op" id="6894845">!=</span>&nbsp;<span class="ident" id="6894848">nil</span>&nbsp;<span class="op" id="6894852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894856">t</span><span class="op" id="6894857">.</span><span class="ident" id="6894858">Fatal</span><span class="op" id="6894863">(</span><span class="ident" id="6894864">err</span><span class="op" id="6894867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894873">if</span>&nbsp;<span class="builtintype" id="6894876">string</span><span class="op" id="6894882">(</span><span class="ident" id="6894883">name</span><span class="op" id="6894887">)</span>&nbsp;<span class="op" id="6894889">!=</span>&nbsp;<span class="string" id="6894892">&#34;bob&#34;</span>&nbsp;<span class="op" id="6894898">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894902">t</span><span class="op" id="6894903">.</span><span class="ident" id="6894904">Fatalf</span><span class="op" id="6894910">(</span><span class="string" id="6894911">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="6894947">,</span>&nbsp;<span class="builtintype" id="6894949">string</span><span class="op" id="6894955">(</span><span class="ident" id="6894956">name</span><span class="op" id="6894960">)</span><span class="op" id="6894961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894964">}</span><br>
<span class="lineno"></span><span class="op" id="6894966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6894969">func</span>&nbsp;<span class="ident" id="6894974">TestPointerParamsAndScans</span><span class="op" id="6894999">(</span><span class="ident" id="6895000">t</span>&nbsp;<span class="op" id="6895002">*</span><span class="ident" id="6895003">testing</span><span class="op" id="6895010">.</span><span class="ident" id="6895011">T</span><span class="op" id="6895012">)</span>&nbsp;<span class="op" id="6895014">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895017">db</span>&nbsp;<span class="op" id="6895020">:=</span>&nbsp;<span class="ident" id="6895023">newTestDB</span><span class="op" id="6895032">(</span><span class="ident" id="6895033">t</span><span class="op" id="6895034">,</span>&nbsp;<span class="string" id="6895036">&#34;&#34;</span><span class="op" id="6895038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895041">defer</span>&nbsp;<span class="ident" id="6895047">closeDB</span><span class="op" id="6895054">(</span><span class="ident" id="6895055">t</span><span class="op" id="6895056">,</span>&nbsp;<span class="ident" id="6895058">db</span><span class="op" id="6895060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895063">exec</span><span class="op" id="6895067">(</span><span class="ident" id="6895068">t</span><span class="op" id="6895069">,</span>&nbsp;<span class="ident" id="6895071">db</span><span class="op" id="6895073">,</span>&nbsp;<span class="string" id="6895075">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="6895110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895114">bob</span>&nbsp;<span class="op" id="6895118">:=</span>&nbsp;<span class="string" id="6895121">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895128">var</span>&nbsp;<span class="ident" id="6895132">name</span>&nbsp;<span class="op" id="6895137">*</span><span class="builtintype" id="6895138">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895147">name</span>&nbsp;<span class="op" id="6895152">=</span>&nbsp;<span class="op" id="6895154">&amp;</span><span class="ident" id="6895155">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895160">exec</span><span class="op" id="6895164">(</span><span class="ident" id="6895165">t</span><span class="op" id="6895166">,</span>&nbsp;<span class="ident" id="6895168">db</span><span class="op" id="6895170">,</span>&nbsp;<span class="string" id="6895172">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="6895195">,</span>&nbsp;<span class="ident" id="6895197">name</span><span class="op" id="6895201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895204">name</span>&nbsp;<span class="op" id="6895209">=</span>&nbsp;<span class="ident" id="6895211">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895216">exec</span><span class="op" id="6895220">(</span><span class="ident" id="6895221">t</span><span class="op" id="6895222">,</span>&nbsp;<span class="ident" id="6895224">db</span><span class="op" id="6895226">,</span>&nbsp;<span class="string" id="6895228">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="6895251">,</span>&nbsp;<span class="ident" id="6895253">name</span><span class="op" id="6895257">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895261">err</span>&nbsp;<span class="op" id="6895265">:=</span>&nbsp;<span class="ident" id="6895268">db</span><span class="op" id="6895270">.</span><span class="ident" id="6895271">QueryRow</span><span class="op" id="6895279">(</span><span class="string" id="6895280">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6895300">,</span>&nbsp;<span class="num" id="6895302">10</span><span class="op" id="6895304">)</span><span class="op" id="6895305">.</span><span class="ident" id="6895306">Scan</span><span class="op" id="6895310">(</span><span class="op" id="6895311">&amp;</span><span class="ident" id="6895312">name</span><span class="op" id="6895316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895319">if</span>&nbsp;<span class="ident" id="6895322">err</span>&nbsp;<span class="op" id="6895326">!=</span>&nbsp;<span class="ident" id="6895329">nil</span>&nbsp;<span class="op" id="6895333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895337">t</span><span class="op" id="6895338">.</span><span class="ident" id="6895339">Fatalf</span><span class="op" id="6895345">(</span><span class="string" id="6895346">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="6895366">,</span>&nbsp;<span class="ident" id="6895368">err</span><span class="op" id="6895371">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895377">if</span>&nbsp;<span class="ident" id="6895380">name</span>&nbsp;<span class="op" id="6895385">==</span>&nbsp;<span class="ident" id="6895388">nil</span>&nbsp;<span class="op" id="6895392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895396">t</span><span class="op" id="6895397">.</span><span class="ident" id="6895398">Errorf</span><span class="op" id="6895404">(</span><span class="string" id="6895405">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6895435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895438">}</span>&nbsp;<span class="keyword" id="6895440">else</span>&nbsp;<span class="keyword" id="6895445">if</span>&nbsp;<span class="op" id="6895448">*</span><span class="ident" id="6895449">name</span>&nbsp;<span class="op" id="6895454">!=</span>&nbsp;<span class="string" id="6895457">&#34;bob&#34;</span>&nbsp;<span class="op" id="6895463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895467">t</span><span class="op" id="6895468">.</span><span class="ident" id="6895469">Errorf</span><span class="op" id="6895475">(</span><span class="string" id="6895476">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="6895505">,</span>&nbsp;<span class="op" id="6895507">*</span><span class="ident" id="6895508">name</span><span class="op" id="6895512">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895519">err</span>&nbsp;<span class="op" id="6895523">=</span>&nbsp;<span class="ident" id="6895525">db</span><span class="op" id="6895527">.</span><span class="ident" id="6895528">QueryRow</span><span class="op" id="6895536">(</span><span class="string" id="6895537">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="6895557">,</span>&nbsp;<span class="num" id="6895559">20</span><span class="op" id="6895561">)</span><span class="op" id="6895562">.</span><span class="ident" id="6895563">Scan</span><span class="op" id="6895567">(</span><span class="op" id="6895568">&amp;</span><span class="ident" id="6895569">name</span><span class="op" id="6895573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895576">if</span>&nbsp;<span class="ident" id="6895579">err</span>&nbsp;<span class="op" id="6895583">!=</span>&nbsp;<span class="ident" id="6895586">nil</span>&nbsp;<span class="op" id="6895590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895594">t</span><span class="op" id="6895595">.</span><span class="ident" id="6895596">Fatalf</span><span class="op" id="6895602">(</span><span class="string" id="6895603">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="6895623">,</span>&nbsp;<span class="ident" id="6895625">err</span><span class="op" id="6895628">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895634">if</span>&nbsp;<span class="ident" id="6895637">name</span>&nbsp;<span class="op" id="6895642">!=</span>&nbsp;<span class="ident" id="6895645">nil</span>&nbsp;<span class="op" id="6895649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895653">t</span><span class="op" id="6895654">.</span><span class="ident" id="6895655">Errorf</span><span class="op" id="6895661">(</span><span class="string" id="6895662">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="6895684">,</span>&nbsp;<span class="op" id="6895686">*</span><span class="ident" id="6895687">name</span><span class="op" id="6895691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895694">}</span><br>
<span class="lineno"></span><span class="op" id="6895696">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="6895699">func</span>&nbsp;<span class="ident" id="6895704">TestQueryRowClosingStmt</span><span class="op" id="6895727">(</span><span class="ident" id="6895728">t</span>&nbsp;<span class="op" id="6895730">*</span><span class="ident" id="6895731">testing</span><span class="op" id="6895738">.</span><span class="ident" id="6895739">T</span><span class="op" id="6895740">)</span>&nbsp;<span class="op" id="6895742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895745">db</span>&nbsp;<span class="op" id="6895748">:=</span>&nbsp;<span class="ident" id="6895751">newTestDB</span><span class="op" id="6895760">(</span><span class="ident" id="6895761">t</span><span class="op" id="6895762">,</span>&nbsp;<span class="string" id="6895764">&#34;people&#34;</span><span class="op" id="6895772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895775">defer</span>&nbsp;<span class="ident" id="6895781">closeDB</span><span class="op" id="6895788">(</span><span class="ident" id="6895789">t</span><span class="op" id="6895790">,</span>&nbsp;<span class="ident" id="6895792">db</span><span class="op" id="6895794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895797">var</span>&nbsp;<span class="ident" id="6895801">name</span>&nbsp;<span class="builtintype" id="6895806">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895814">var</span>&nbsp;<span class="ident" id="6895818">age</span>&nbsp;<span class="builtintype" id="6895822">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895827">err</span>&nbsp;<span class="op" id="6895831">:=</span>&nbsp;<span class="ident" id="6895834">db</span><span class="op" id="6895836">.</span><span class="ident" id="6895837">QueryRow</span><span class="op" id="6895845">(</span><span class="string" id="6895846">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="6895876">,</span>&nbsp;<span class="num" id="6895878">3</span><span class="op" id="6895879">)</span><span class="op" id="6895880">.</span><span class="ident" id="6895881">Scan</span><span class="op" id="6895885">(</span><span class="op" id="6895886">&amp;</span><span class="ident" id="6895887">age</span><span class="op" id="6895890">,</span>&nbsp;<span class="op" id="6895892">&amp;</span><span class="ident" id="6895893">name</span><span class="op" id="6895897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895900">if</span>&nbsp;<span class="ident" id="6895903">err</span>&nbsp;<span class="op" id="6895907">!=</span>&nbsp;<span class="ident" id="6895910">nil</span>&nbsp;<span class="op" id="6895914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895918">t</span><span class="op" id="6895919">.</span><span class="ident" id="6895920">Fatal</span><span class="op" id="6895925">(</span><span class="ident" id="6895926">err</span><span class="op" id="6895929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895932">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6895935">if</span>&nbsp;<span class="builtinfunc" id="6895938">len</span><span class="op" id="6895941">(</span><span class="ident" id="6895942">db</span><span class="op" id="6895944">.</span><span class="ident" id="6895945">freeConn</span><span class="op" id="6895953">)</span>&nbsp;<span class="op" id="6895955">!=</span>&nbsp;<span class="num" id="6895958">1</span>&nbsp;<span class="op" id="6895960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6895964">t</span><span class="op" id="6895965">.</span><span class="ident" id="6895966">Fatalf</span><span class="op" id="6895972">(</span><span class="string" id="6895973">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="6895995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6895998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896001">fakeConn</span>&nbsp;<span class="op" id="6896010">:=</span>&nbsp;<span class="ident" id="6896013">db</span><span class="op" id="6896015">.</span><span class="ident" id="6896016">freeConn</span><span class="op" id="6896024">[</span><span class="num" id="6896025">0</span><span class="op" id="6896026">]</span><span class="op" id="6896027">.</span><span class="ident" id="6896028">ci</span><span class="op" id="6896030">.</span><span class="op" id="6896031">(</span><span class="op" id="6896032">*</span><span class="ident" id="6896033">fakeConn</span><span class="op" id="6896041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896044">if</span>&nbsp;<span class="ident" id="6896047">made</span><span class="op" id="6896051">,</span>&nbsp;<span class="ident" id="6896053">closed</span>&nbsp;<span class="op" id="6896060">:=</span>&nbsp;<span class="ident" id="6896063">fakeConn</span><span class="op" id="6896071">.</span><span class="ident" id="6896072">stmtsMade</span><span class="op" id="6896081">,</span>&nbsp;<span class="ident" id="6896083">fakeConn</span><span class="op" id="6896091">.</span><span class="ident" id="6896092">stmtsClosed</span><span class="op" id="6896103">;</span>&nbsp;<span class="ident" id="6896105">made</span>&nbsp;<span class="op" id="6896110">!=</span>&nbsp;<span class="ident" id="6896113">closed</span>&nbsp;<span class="op" id="6896120">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896124">t</span><span class="op" id="6896125">.</span><span class="ident" id="6896126">Errorf</span><span class="op" id="6896132">(</span><span class="string" id="6896133">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="6896179">,</span>&nbsp;<span class="ident" id="6896181">made</span><span class="op" id="6896185">,</span>&nbsp;<span class="ident" id="6896187">closed</span><span class="op" id="6896193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896196">}</span><br>
<span class="lineno"></span><span class="op" id="6896198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6896201">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="6896220">func</span>&nbsp;<span class="ident" id="6896225">TestIssue6651</span><span class="op" id="6896238">(</span><span class="ident" id="6896239">t</span>&nbsp;<span class="op" id="6896241">*</span><span class="ident" id="6896242">testing</span><span class="op" id="6896249">.</span><span class="ident" id="6896250">T</span><span class="op" id="6896251">)</span>&nbsp;<span class="op" id="6896253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896256">db</span>&nbsp;<span class="op" id="6896259">:=</span>&nbsp;<span class="ident" id="6896262">newTestDB</span><span class="op" id="6896271">(</span><span class="ident" id="6896272">t</span><span class="op" id="6896273">,</span>&nbsp;<span class="string" id="6896275">&#34;people&#34;</span><span class="op" id="6896283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896286">defer</span>&nbsp;<span class="ident" id="6896292">closeDB</span><span class="op" id="6896299">(</span><span class="ident" id="6896300">t</span><span class="op" id="6896301">,</span>&nbsp;<span class="ident" id="6896303">db</span><span class="op" id="6896305">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896309">var</span>&nbsp;<span class="ident" id="6896313">v</span>&nbsp;<span class="builtintype" id="6896315">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896324">want</span>&nbsp;<span class="op" id="6896329">:=</span>&nbsp;<span class="string" id="6896332">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896354">rowsCursorNextHook</span>&nbsp;<span class="op" id="6896373">=</span>&nbsp;<span class="keyword" id="6896375">func</span><span class="op" id="6896379">(</span><span class="ident" id="6896380">dest</span>&nbsp;<span class="op" id="6896385">[</span><span class="op" id="6896386">]</span><span class="ident" id="6896387">driver</span><span class="op" id="6896393">.</span><span class="ident" id="6896394">Value</span><span class="op" id="6896399">)</span>&nbsp;<span class="builtintype" id="6896401">error</span>&nbsp;<span class="op" id="6896407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896411">return</span>&nbsp;<span class="ident" id="6896418">fmt</span><span class="op" id="6896421">.</span><span class="ident" id="6896422">Errorf</span><span class="op" id="6896428">(</span><span class="ident" id="6896429">want</span><span class="op" id="6896433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896436">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896439">defer</span>&nbsp;<span class="keyword" id="6896445">func</span><span class="op" id="6896449">(</span><span class="op" id="6896450">)</span>&nbsp;<span class="op" id="6896452">{</span>&nbsp;<span class="ident" id="6896454">rowsCursorNextHook</span>&nbsp;<span class="op" id="6896473">=</span>&nbsp;<span class="ident" id="6896475">nil</span>&nbsp;<span class="op" id="6896479">}</span><span class="op" id="6896480">(</span><span class="op" id="6896481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896484">err</span>&nbsp;<span class="op" id="6896488">:=</span>&nbsp;<span class="ident" id="6896491">db</span><span class="op" id="6896493">.</span><span class="ident" id="6896494">QueryRow</span><span class="op" id="6896502">(</span><span class="string" id="6896503">&#34;SELECT|people|name|&#34;</span><span class="op" id="6896524">)</span><span class="op" id="6896525">.</span><span class="ident" id="6896526">Scan</span><span class="op" id="6896530">(</span><span class="op" id="6896531">&amp;</span><span class="ident" id="6896532">v</span><span class="op" id="6896533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896536">if</span>&nbsp;<span class="ident" id="6896539">err</span>&nbsp;<span class="op" id="6896543">==</span>&nbsp;<span class="ident" id="6896546">nil</span>&nbsp;<span class="op" id="6896550">||</span>&nbsp;<span class="ident" id="6896553">err</span><span class="op" id="6896556">.</span><span class="ident" id="6896557">Error</span><span class="op" id="6896562">(</span><span class="op" id="6896563">)</span>&nbsp;<span class="op" id="6896565">!=</span>&nbsp;<span class="ident" id="6896568">want</span>&nbsp;<span class="op" id="6896573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896577">t</span><span class="op" id="6896578">.</span><span class="ident" id="6896579">Errorf</span><span class="op" id="6896585">(</span><span class="string" id="6896586">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6896607">,</span>&nbsp;<span class="ident" id="6896609">err</span><span class="op" id="6896612">,</span>&nbsp;<span class="ident" id="6896614">want</span><span class="op" id="6896618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896621">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896624">rowsCursorNextHook</span>&nbsp;<span class="op" id="6896643">=</span>&nbsp;<span class="ident" id="6896645">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896651">want</span>&nbsp;<span class="op" id="6896656">=</span>&nbsp;<span class="string" id="6896658">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896681">rowsCloseHook</span>&nbsp;<span class="op" id="6896695">=</span>&nbsp;<span class="keyword" id="6896697">func</span><span class="op" id="6896701">(</span><span class="ident" id="6896702">rows</span>&nbsp;<span class="op" id="6896707">*</span><span class="ident" id="6896708">Rows</span><span class="op" id="6896712">,</span>&nbsp;<span class="ident" id="6896714">err</span>&nbsp;<span class="op" id="6896718">*</span><span class="builtintype" id="6896719">error</span><span class="op" id="6896724">)</span>&nbsp;<span class="op" id="6896726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896730">*</span><span class="ident" id="6896731">err</span>&nbsp;<span class="op" id="6896735">=</span>&nbsp;<span class="ident" id="6896737">fmt</span><span class="op" id="6896740">.</span><span class="ident" id="6896741">Errorf</span><span class="op" id="6896747">(</span><span class="ident" id="6896748">want</span><span class="op" id="6896752">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896758">defer</span>&nbsp;<span class="keyword" id="6896764">func</span><span class="op" id="6896768">(</span><span class="op" id="6896769">)</span>&nbsp;<span class="op" id="6896771">{</span>&nbsp;<span class="ident" id="6896773">rowsCloseHook</span>&nbsp;<span class="op" id="6896787">=</span>&nbsp;<span class="ident" id="6896789">nil</span>&nbsp;<span class="op" id="6896793">}</span><span class="op" id="6896794">(</span><span class="op" id="6896795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896798">err</span>&nbsp;<span class="op" id="6896802">=</span>&nbsp;<span class="ident" id="6896804">db</span><span class="op" id="6896806">.</span><span class="ident" id="6896807">QueryRow</span><span class="op" id="6896815">(</span><span class="string" id="6896816">&#34;SELECT|people|name|&#34;</span><span class="op" id="6896837">)</span><span class="op" id="6896838">.</span><span class="ident" id="6896839">Scan</span><span class="op" id="6896843">(</span><span class="op" id="6896844">&amp;</span><span class="ident" id="6896845">v</span><span class="op" id="6896846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6896849">if</span>&nbsp;<span class="ident" id="6896852">err</span>&nbsp;<span class="op" id="6896856">==</span>&nbsp;<span class="ident" id="6896859">nil</span>&nbsp;<span class="op" id="6896863">||</span>&nbsp;<span class="ident" id="6896866">err</span><span class="op" id="6896869">.</span><span class="ident" id="6896870">Error</span><span class="op" id="6896875">(</span><span class="op" id="6896876">)</span>&nbsp;<span class="op" id="6896878">!=</span>&nbsp;<span class="ident" id="6896881">want</span>&nbsp;<span class="op" id="6896886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896890">t</span><span class="op" id="6896891">.</span><span class="ident" id="6896892">Errorf</span><span class="op" id="6896898">(</span><span class="string" id="6896899">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6896920">,</span>&nbsp;<span class="ident" id="6896922">err</span><span class="op" id="6896925">,</span>&nbsp;<span class="ident" id="6896927">want</span><span class="op" id="6896931">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6896934">}</span><br>
<span class="lineno"></span><span class="op" id="6896936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6896939">type</span>&nbsp;<span class="ident" id="6896944">nullTestRow</span>&nbsp;<span class="keyword" id="6896956">struct</span>&nbsp;<span class="op" id="6896963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896966">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6896979">interface</span><span class="op" id="6896988">{</span><span class="op" id="6896989">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6896992">notNullParam</span>&nbsp;<span class="keyword" id="6897005">interface</span><span class="op" id="6897014">{</span><span class="op" id="6897015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897018">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="6897031">interface</span><span class="op" id="6897040">{</span><span class="op" id="6897041">}</span><br>
<span class="lineno"></span><span class="op" id="6897043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6897046">type</span>&nbsp;<span class="ident" id="6897051">nullTestSpec</span>&nbsp;<span class="keyword" id="6897064">struct</span>&nbsp;<span class="op" id="6897071">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897074">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6897086">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897094">notNullType</span>&nbsp;<span class="builtintype" id="6897106">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897114">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6897126">[</span><span class="num" id="6897127">6</span><span class="op" id="6897128">]</span><span class="ident" id="6897129">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="6897141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="6897144">func</span>&nbsp;<span class="ident" id="6897149">TestNullStringParam</span><span class="op" id="6897168">(</span><span class="ident" id="6897169">t</span>&nbsp;<span class="op" id="6897171">*</span><span class="ident" id="6897172">testing</span><span class="op" id="6897179">.</span><span class="ident" id="6897180">T</span><span class="op" id="6897181">)</span>&nbsp;<span class="op" id="6897183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897186">spec</span>&nbsp;<span class="op" id="6897191">:=</span>&nbsp;<span class="ident" id="6897194">nullTestSpec</span><span class="op" id="6897206">{</span><span class="string" id="6897207">&#34;nullstring&#34;</span><span class="op" id="6897219">,</span>&nbsp;<span class="string" id="6897221">&#34;string&#34;</span><span class="op" id="6897229">,</span>&nbsp;<span class="op" id="6897231">[</span><span class="num" id="6897232">6</span><span class="op" id="6897233">]</span><span class="ident" id="6897234">nullTestRow</span><span class="op" id="6897245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897249">{</span><span class="ident" id="6897250">NullString</span><span class="op" id="6897260">{</span><span class="string" id="6897261">&#34;aqua&#34;</span><span class="op" id="6897267">,</span>&nbsp;<span class="builtintype" id="6897269">true</span><span class="op" id="6897273">}</span><span class="op" id="6897274">,</span>&nbsp;<span class="string" id="6897276">&#34;&#34;</span><span class="op" id="6897278">,</span>&nbsp;<span class="ident" id="6897280">NullString</span><span class="op" id="6897290">{</span><span class="string" id="6897291">&#34;aqua&#34;</span><span class="op" id="6897297">,</span>&nbsp;<span class="builtintype" id="6897299">true</span><span class="op" id="6897303">}</span><span class="op" id="6897304">}</span><span class="op" id="6897305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897309">{</span><span class="ident" id="6897310">NullString</span><span class="op" id="6897320">{</span><span class="string" id="6897321">&#34;brown&#34;</span><span class="op" id="6897328">,</span>&nbsp;<span class="builtintype" id="6897330">false</span><span class="op" id="6897335">}</span><span class="op" id="6897336">,</span>&nbsp;<span class="string" id="6897338">&#34;&#34;</span><span class="op" id="6897340">,</span>&nbsp;<span class="ident" id="6897342">NullString</span><span class="op" id="6897352">{</span><span class="string" id="6897353">&#34;&#34;</span><span class="op" id="6897355">,</span>&nbsp;<span class="builtintype" id="6897357">false</span><span class="op" id="6897362">}</span><span class="op" id="6897363">}</span><span class="op" id="6897364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897368">{</span><span class="string" id="6897369">&#34;chartreuse&#34;</span><span class="op" id="6897381">,</span>&nbsp;<span class="string" id="6897383">&#34;&#34;</span><span class="op" id="6897385">,</span>&nbsp;<span class="ident" id="6897387">NullString</span><span class="op" id="6897397">{</span><span class="string" id="6897398">&#34;chartreuse&#34;</span><span class="op" id="6897410">,</span>&nbsp;<span class="builtintype" id="6897412">true</span><span class="op" id="6897416">}</span><span class="op" id="6897417">}</span><span class="op" id="6897418">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897422">{</span><span class="ident" id="6897423">NullString</span><span class="op" id="6897433">{</span><span class="string" id="6897434">&#34;darkred&#34;</span><span class="op" id="6897443">,</span>&nbsp;<span class="builtintype" id="6897445">true</span><span class="op" id="6897449">}</span><span class="op" id="6897450">,</span>&nbsp;<span class="string" id="6897452">&#34;&#34;</span><span class="op" id="6897454">,</span>&nbsp;<span class="ident" id="6897456">NullString</span><span class="op" id="6897466">{</span><span class="string" id="6897467">&#34;darkred&#34;</span><span class="op" id="6897476">,</span>&nbsp;<span class="builtintype" id="6897478">true</span><span class="op" id="6897482">}</span><span class="op" id="6897483">}</span><span class="op" id="6897484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897488">{</span><span class="ident" id="6897489">NullString</span><span class="op" id="6897499">{</span><span class="string" id="6897500">&#34;eel&#34;</span><span class="op" id="6897505">,</span>&nbsp;<span class="builtintype" id="6897507">false</span><span class="op" id="6897512">}</span><span class="op" id="6897513">,</span>&nbsp;<span class="string" id="6897515">&#34;&#34;</span><span class="op" id="6897517">,</span>&nbsp;<span class="ident" id="6897519">NullString</span><span class="op" id="6897529">{</span><span class="string" id="6897530">&#34;&#34;</span><span class="op" id="6897532">,</span>&nbsp;<span class="builtintype" id="6897534">false</span><span class="op" id="6897539">}</span><span class="op" id="6897540">}</span><span class="op" id="6897541">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897545">{</span><span class="string" id="6897546">&#34;foo&#34;</span><span class="op" id="6897551">,</span>&nbsp;<span class="ident" id="6897553">NullString</span><span class="op" id="6897563">{</span><span class="string" id="6897564">&#34;black&#34;</span><span class="op" id="6897571">,</span>&nbsp;<span class="builtintype" id="6897573">false</span><span class="op" id="6897578">}</span><span class="op" id="6897579">,</span>&nbsp;<span class="ident" id="6897581">nil</span><span class="op" id="6897584">}</span><span class="op" id="6897585">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897588">}</span><span class="op" id="6897589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897592">nullTestRun</span><span class="op" id="6897603">(</span><span class="ident" id="6897604">t</span><span class="op" id="6897605">,</span>&nbsp;<span class="ident" id="6897607">spec</span><span class="op" id="6897611">)</span><br>
<span class="lineno">750</span><span class="op" id="6897613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6897616">func</span>&nbsp;<span class="ident" id="6897621">TestNullInt64Param</span><span class="op" id="6897639">(</span><span class="ident" id="6897640">t</span>&nbsp;<span class="op" id="6897642">*</span><span class="ident" id="6897643">testing</span><span class="op" id="6897650">.</span><span class="ident" id="6897651">T</span><span class="op" id="6897652">)</span>&nbsp;<span class="op" id="6897654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897657">spec</span>&nbsp;<span class="op" id="6897662">:=</span>&nbsp;<span class="ident" id="6897665">nullTestSpec</span><span class="op" id="6897677">{</span><span class="string" id="6897678">&#34;nullint64&#34;</span><span class="op" id="6897689">,</span>&nbsp;<span class="string" id="6897691">&#34;int64&#34;</span><span class="op" id="6897698">,</span>&nbsp;<span class="op" id="6897700">[</span><span class="num" id="6897701">6</span><span class="op" id="6897702">]</span><span class="ident" id="6897703">nullTestRow</span><span class="op" id="6897714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897718">{</span><span class="ident" id="6897719">NullInt64</span><span class="op" id="6897728">{</span><span class="num" id="6897729">31</span><span class="op" id="6897731">,</span>&nbsp;<span class="builtintype" id="6897733">true</span><span class="op" id="6897737">}</span><span class="op" id="6897738">,</span>&nbsp;<span class="num" id="6897740">1</span><span class="op" id="6897741">,</span>&nbsp;<span class="ident" id="6897743">NullInt64</span><span class="op" id="6897752">{</span><span class="num" id="6897753">31</span><span class="op" id="6897755">,</span>&nbsp;<span class="builtintype" id="6897757">true</span><span class="op" id="6897761">}</span><span class="op" id="6897762">}</span><span class="op" id="6897763">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897767">{</span><span class="ident" id="6897768">NullInt64</span><span class="op" id="6897777">{</span><span class="op" id="6897778">-</span><span class="num" id="6897779">22</span><span class="op" id="6897781">,</span>&nbsp;<span class="builtintype" id="6897783">false</span><span class="op" id="6897788">}</span><span class="op" id="6897789">,</span>&nbsp;<span class="num" id="6897791">1</span><span class="op" id="6897792">,</span>&nbsp;<span class="ident" id="6897794">NullInt64</span><span class="op" id="6897803">{</span><span class="num" id="6897804">0</span><span class="op" id="6897805">,</span>&nbsp;<span class="builtintype" id="6897807">false</span><span class="op" id="6897812">}</span><span class="op" id="6897813">}</span><span class="op" id="6897814">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897818">{</span><span class="num" id="6897819">22</span><span class="op" id="6897821">,</span>&nbsp;<span class="num" id="6897823">1</span><span class="op" id="6897824">,</span>&nbsp;<span class="ident" id="6897826">NullInt64</span><span class="op" id="6897835">{</span><span class="num" id="6897836">22</span><span class="op" id="6897838">,</span>&nbsp;<span class="builtintype" id="6897840">true</span><span class="op" id="6897844">}</span><span class="op" id="6897845">}</span><span class="op" id="6897846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897850">{</span><span class="ident" id="6897851">NullInt64</span><span class="op" id="6897860">{</span><span class="num" id="6897861">33</span><span class="op" id="6897863">,</span>&nbsp;<span class="builtintype" id="6897865">true</span><span class="op" id="6897869">}</span><span class="op" id="6897870">,</span>&nbsp;<span class="num" id="6897872">1</span><span class="op" id="6897873">,</span>&nbsp;<span class="ident" id="6897875">NullInt64</span><span class="op" id="6897884">{</span><span class="num" id="6897885">33</span><span class="op" id="6897887">,</span>&nbsp;<span class="builtintype" id="6897889">true</span><span class="op" id="6897893">}</span><span class="op" id="6897894">}</span><span class="op" id="6897895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897899">{</span><span class="ident" id="6897900">NullInt64</span><span class="op" id="6897909">{</span><span class="num" id="6897910">222</span><span class="op" id="6897913">,</span>&nbsp;<span class="builtintype" id="6897915">false</span><span class="op" id="6897920">}</span><span class="op" id="6897921">,</span>&nbsp;<span class="num" id="6897923">1</span><span class="op" id="6897924">,</span>&nbsp;<span class="ident" id="6897926">NullInt64</span><span class="op" id="6897935">{</span><span class="num" id="6897936">0</span><span class="op" id="6897937">,</span>&nbsp;<span class="builtintype" id="6897939">false</span><span class="op" id="6897944">}</span><span class="op" id="6897945">}</span><span class="op" id="6897946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897950">{</span><span class="num" id="6897951">0</span><span class="op" id="6897952">,</span>&nbsp;<span class="ident" id="6897954">NullInt64</span><span class="op" id="6897963">{</span><span class="num" id="6897964">31</span><span class="op" id="6897966">,</span>&nbsp;<span class="builtintype" id="6897968">false</span><span class="op" id="6897973">}</span><span class="op" id="6897974">,</span>&nbsp;<span class="ident" id="6897976">nil</span><span class="op" id="6897979">}</span><span class="op" id="6897980">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6897983">}</span><span class="op" id="6897984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6897987">nullTestRun</span><span class="op" id="6897998">(</span><span class="ident" id="6897999">t</span><span class="op" id="6898000">,</span>&nbsp;<span class="ident" id="6898002">spec</span><span class="op" id="6898006">)</span><br>
<span class="lineno"></span><span class="op" id="6898008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898011">func</span>&nbsp;<span class="ident" id="6898016">TestNullFloat64Param</span><span class="op" id="6898036">(</span><span class="ident" id="6898037">t</span>&nbsp;<span class="op" id="6898039">*</span><span class="ident" id="6898040">testing</span><span class="op" id="6898047">.</span><span class="ident" id="6898048">T</span><span class="op" id="6898049">)</span>&nbsp;<span class="op" id="6898051">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898054">spec</span>&nbsp;<span class="op" id="6898059">:=</span>&nbsp;<span class="ident" id="6898062">nullTestSpec</span><span class="op" id="6898074">{</span><span class="string" id="6898075">&#34;nullfloat64&#34;</span><span class="op" id="6898088">,</span>&nbsp;<span class="string" id="6898090">&#34;float64&#34;</span><span class="op" id="6898099">,</span>&nbsp;<span class="op" id="6898101">[</span><span class="num" id="6898102">6</span><span class="op" id="6898103">]</span><span class="ident" id="6898104">nullTestRow</span><span class="op" id="6898115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898119">{</span><span class="ident" id="6898120">NullFloat64</span><span class="op" id="6898131">{</span><span class="num" id="6898132">31.2</span><span class="op" id="6898136">,</span>&nbsp;<span class="builtintype" id="6898138">true</span><span class="op" id="6898142">}</span><span class="op" id="6898143">,</span>&nbsp;<span class="num" id="6898145">1</span><span class="op" id="6898146">,</span>&nbsp;<span class="ident" id="6898148">NullFloat64</span><span class="op" id="6898159">{</span><span class="num" id="6898160">31.2</span><span class="op" id="6898164">,</span>&nbsp;<span class="builtintype" id="6898166">true</span><span class="op" id="6898170">}</span><span class="op" id="6898171">}</span><span class="op" id="6898172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898176">{</span><span class="ident" id="6898177">NullFloat64</span><span class="op" id="6898188">{</span><span class="num" id="6898189">13.1</span><span class="op" id="6898193">,</span>&nbsp;<span class="builtintype" id="6898195">false</span><span class="op" id="6898200">}</span><span class="op" id="6898201">,</span>&nbsp;<span class="num" id="6898203">1</span><span class="op" id="6898204">,</span>&nbsp;<span class="ident" id="6898206">NullFloat64</span><span class="op" id="6898217">{</span><span class="num" id="6898218">0</span><span class="op" id="6898219">,</span>&nbsp;<span class="builtintype" id="6898221">false</span><span class="op" id="6898226">}</span><span class="op" id="6898227">}</span><span class="op" id="6898228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898232">{</span><span class="op" id="6898233">-</span><span class="num" id="6898234">22.9</span><span class="op" id="6898238">,</span>&nbsp;<span class="num" id="6898240">1</span><span class="op" id="6898241">,</span>&nbsp;<span class="ident" id="6898243">NullFloat64</span><span class="op" id="6898254">{</span><span class="op" id="6898255">-</span><span class="num" id="6898256">22.9</span><span class="op" id="6898260">,</span>&nbsp;<span class="builtintype" id="6898262">true</span><span class="op" id="6898266">}</span><span class="op" id="6898267">}</span><span class="op" id="6898268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898272">{</span><span class="ident" id="6898273">NullFloat64</span><span class="op" id="6898284">{</span><span class="num" id="6898285">33.81</span><span class="op" id="6898290">,</span>&nbsp;<span class="builtintype" id="6898292">true</span><span class="op" id="6898296">}</span><span class="op" id="6898297">,</span>&nbsp;<span class="num" id="6898299">1</span><span class="op" id="6898300">,</span>&nbsp;<span class="ident" id="6898302">NullFloat64</span><span class="op" id="6898313">{</span><span class="num" id="6898314">33.81</span><span class="op" id="6898319">,</span>&nbsp;<span class="builtintype" id="6898321">true</span><span class="op" id="6898325">}</span><span class="op" id="6898326">}</span><span class="op" id="6898327">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898331">{</span><span class="ident" id="6898332">NullFloat64</span><span class="op" id="6898343">{</span><span class="num" id="6898344">222</span><span class="op" id="6898347">,</span>&nbsp;<span class="builtintype" id="6898349">false</span><span class="op" id="6898354">}</span><span class="op" id="6898355">,</span>&nbsp;<span class="num" id="6898357">1</span><span class="op" id="6898358">,</span>&nbsp;<span class="ident" id="6898360">NullFloat64</span><span class="op" id="6898371">{</span><span class="num" id="6898372">0</span><span class="op" id="6898373">,</span>&nbsp;<span class="builtintype" id="6898375">false</span><span class="op" id="6898380">}</span><span class="op" id="6898381">}</span><span class="op" id="6898382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898386">{</span><span class="num" id="6898387">10</span><span class="op" id="6898389">,</span>&nbsp;<span class="ident" id="6898391">NullFloat64</span><span class="op" id="6898402">{</span><span class="num" id="6898403">31.2</span><span class="op" id="6898407">,</span>&nbsp;<span class="builtintype" id="6898409">false</span><span class="op" id="6898414">}</span><span class="op" id="6898415">,</span>&nbsp;<span class="ident" id="6898417">nil</span><span class="op" id="6898420">}</span><span class="op" id="6898421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898424">}</span><span class="op" id="6898425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898428">nullTestRun</span><span class="op" id="6898439">(</span><span class="ident" id="6898440">t</span><span class="op" id="6898441">,</span>&nbsp;<span class="ident" id="6898443">spec</span><span class="op" id="6898447">)</span><br>
<span class="lineno"></span><span class="op" id="6898449">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="6898452">func</span>&nbsp;<span class="ident" id="6898457">TestNullBoolParam</span><span class="op" id="6898474">(</span><span class="ident" id="6898475">t</span>&nbsp;<span class="op" id="6898477">*</span><span class="ident" id="6898478">testing</span><span class="op" id="6898485">.</span><span class="ident" id="6898486">T</span><span class="op" id="6898487">)</span>&nbsp;<span class="op" id="6898489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898492">spec</span>&nbsp;<span class="op" id="6898497">:=</span>&nbsp;<span class="ident" id="6898500">nullTestSpec</span><span class="op" id="6898512">{</span><span class="string" id="6898513">&#34;nullbool&#34;</span><span class="op" id="6898523">,</span>&nbsp;<span class="string" id="6898525">&#34;bool&#34;</span><span class="op" id="6898531">,</span>&nbsp;<span class="op" id="6898533">[</span><span class="num" id="6898534">6</span><span class="op" id="6898535">]</span><span class="ident" id="6898536">nullTestRow</span><span class="op" id="6898547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898551">{</span><span class="ident" id="6898552">NullBool</span><span class="op" id="6898560">{</span><span class="builtintype" id="6898561">false</span><span class="op" id="6898566">,</span>&nbsp;<span class="builtintype" id="6898568">true</span><span class="op" id="6898572">}</span><span class="op" id="6898573">,</span>&nbsp;<span class="builtintype" id="6898575">true</span><span class="op" id="6898579">,</span>&nbsp;<span class="ident" id="6898581">NullBool</span><span class="op" id="6898589">{</span><span class="builtintype" id="6898590">false</span><span class="op" id="6898595">,</span>&nbsp;<span class="builtintype" id="6898597">true</span><span class="op" id="6898601">}</span><span class="op" id="6898602">}</span><span class="op" id="6898603">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898607">{</span><span class="ident" id="6898608">NullBool</span><span class="op" id="6898616">{</span><span class="builtintype" id="6898617">true</span><span class="op" id="6898621">,</span>&nbsp;<span class="builtintype" id="6898623">false</span><span class="op" id="6898628">}</span><span class="op" id="6898629">,</span>&nbsp;<span class="builtintype" id="6898631">false</span><span class="op" id="6898636">,</span>&nbsp;<span class="ident" id="6898638">NullBool</span><span class="op" id="6898646">{</span><span class="builtintype" id="6898647">false</span><span class="op" id="6898652">,</span>&nbsp;<span class="builtintype" id="6898654">false</span><span class="op" id="6898659">}</span><span class="op" id="6898660">}</span><span class="op" id="6898661">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898665">{</span><span class="builtintype" id="6898666">true</span><span class="op" id="6898670">,</span>&nbsp;<span class="builtintype" id="6898672">true</span><span class="op" id="6898676">,</span>&nbsp;<span class="ident" id="6898678">NullBool</span><span class="op" id="6898686">{</span><span class="builtintype" id="6898687">true</span><span class="op" id="6898691">,</span>&nbsp;<span class="builtintype" id="6898693">true</span><span class="op" id="6898697">}</span><span class="op" id="6898698">}</span><span class="op" id="6898699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898703">{</span><span class="ident" id="6898704">NullBool</span><span class="op" id="6898712">{</span><span class="builtintype" id="6898713">true</span><span class="op" id="6898717">,</span>&nbsp;<span class="builtintype" id="6898719">true</span><span class="op" id="6898723">}</span><span class="op" id="6898724">,</span>&nbsp;<span class="builtintype" id="6898726">false</span><span class="op" id="6898731">,</span>&nbsp;<span class="ident" id="6898733">NullBool</span><span class="op" id="6898741">{</span><span class="builtintype" id="6898742">true</span><span class="op" id="6898746">,</span>&nbsp;<span class="builtintype" id="6898748">true</span><span class="op" id="6898752">}</span><span class="op" id="6898753">}</span><span class="op" id="6898754">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898758">{</span><span class="ident" id="6898759">NullBool</span><span class="op" id="6898767">{</span><span class="builtintype" id="6898768">true</span><span class="op" id="6898772">,</span>&nbsp;<span class="builtintype" id="6898774">false</span><span class="op" id="6898779">}</span><span class="op" id="6898780">,</span>&nbsp;<span class="builtintype" id="6898782">true</span><span class="op" id="6898786">,</span>&nbsp;<span class="ident" id="6898788">NullBool</span><span class="op" id="6898796">{</span><span class="builtintype" id="6898797">false</span><span class="op" id="6898802">,</span>&nbsp;<span class="builtintype" id="6898804">false</span><span class="op" id="6898809">}</span><span class="op" id="6898810">}</span><span class="op" id="6898811">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898815">{</span><span class="builtintype" id="6898816">true</span><span class="op" id="6898820">,</span>&nbsp;<span class="ident" id="6898822">NullBool</span><span class="op" id="6898830">{</span><span class="builtintype" id="6898831">true</span><span class="op" id="6898835">,</span>&nbsp;<span class="builtintype" id="6898837">false</span><span class="op" id="6898842">}</span><span class="op" id="6898843">,</span>&nbsp;<span class="ident" id="6898845">nil</span><span class="op" id="6898848">}</span><span class="op" id="6898849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6898852">}</span><span class="op" id="6898853">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898856">nullTestRun</span><span class="op" id="6898867">(</span><span class="ident" id="6898868">t</span><span class="op" id="6898869">,</span>&nbsp;<span class="ident" id="6898871">spec</span><span class="op" id="6898875">)</span><br>
<span class="lineno"></span><span class="op" id="6898877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6898880">func</span>&nbsp;<span class="ident" id="6898885">nullTestRun</span><span class="op" id="6898896">(</span><span class="ident" id="6898897">t</span>&nbsp;<span class="op" id="6898899">*</span><span class="ident" id="6898900">testing</span><span class="op" id="6898907">.</span><span class="ident" id="6898908">T</span><span class="op" id="6898909">,</span>&nbsp;<span class="ident" id="6898911">spec</span>&nbsp;<span class="ident" id="6898916">nullTestSpec</span><span class="op" id="6898928">)</span>&nbsp;<span class="op" id="6898930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898933">db</span>&nbsp;<span class="op" id="6898936">:=</span>&nbsp;<span class="ident" id="6898939">newTestDB</span><span class="op" id="6898948">(</span><span class="ident" id="6898949">t</span><span class="op" id="6898950">,</span>&nbsp;<span class="string" id="6898952">&#34;&#34;</span><span class="op" id="6898954">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6898957">defer</span>&nbsp;<span class="ident" id="6898963">closeDB</span><span class="op" id="6898970">(</span><span class="ident" id="6898971">t</span><span class="op" id="6898972">,</span>&nbsp;<span class="ident" id="6898974">db</span><span class="op" id="6898976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6898979">exec</span><span class="op" id="6898983">(</span><span class="ident" id="6898984">t</span><span class="op" id="6898985">,</span>&nbsp;<span class="ident" id="6898987">db</span><span class="op" id="6898989">,</span>&nbsp;<span class="ident" id="6898991">fmt</span><span class="op" id="6898994">.</span><span class="ident" id="6898995">Sprintf</span><span class="op" id="6899002">(</span><span class="string" id="6899003">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="6899055">,</span>&nbsp;<span class="ident" id="6899057">spec</span><span class="op" id="6899061">.</span><span class="ident" id="6899062">nullType</span><span class="op" id="6899070">,</span>&nbsp;<span class="ident" id="6899072">spec</span><span class="op" id="6899076">.</span><span class="ident" id="6899077">notNullType</span><span class="op" id="6899088">)</span><span class="op" id="6899089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6899093">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899119">exec</span><span class="op" id="6899123">(</span><span class="ident" id="6899124">t</span><span class="op" id="6899125">,</span>&nbsp;<span class="ident" id="6899127">db</span><span class="op" id="6899129">,</span>&nbsp;<span class="string" id="6899131">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6899172">,</span>&nbsp;<span class="num" id="6899174">1</span><span class="op" id="6899175">,</span>&nbsp;<span class="string" id="6899177">&#34;alice&#34;</span><span class="op" id="6899184">,</span>&nbsp;<span class="ident" id="6899186">spec</span><span class="op" id="6899190">.</span><span class="ident" id="6899191">rows</span><span class="op" id="6899195">[</span><span class="num" id="6899196">0</span><span class="op" id="6899197">]</span><span class="op" id="6899198">.</span><span class="ident" id="6899199">nullParam</span><span class="op" id="6899208">,</span>&nbsp;<span class="ident" id="6899210">spec</span><span class="op" id="6899214">.</span><span class="ident" id="6899215">rows</span><span class="op" id="6899219">[</span><span class="num" id="6899220">0</span><span class="op" id="6899221">]</span><span class="op" id="6899222">.</span><span class="ident" id="6899223">notNullParam</span><span class="op" id="6899235">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899238">exec</span><span class="op" id="6899242">(</span><span class="ident" id="6899243">t</span><span class="op" id="6899244">,</span>&nbsp;<span class="ident" id="6899246">db</span><span class="op" id="6899248">,</span>&nbsp;<span class="string" id="6899250">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6899291">,</span>&nbsp;<span class="num" id="6899293">2</span><span class="op" id="6899294">,</span>&nbsp;<span class="string" id="6899296">&#34;bob&#34;</span><span class="op" id="6899301">,</span>&nbsp;<span class="ident" id="6899303">spec</span><span class="op" id="6899307">.</span><span class="ident" id="6899308">rows</span><span class="op" id="6899312">[</span><span class="num" id="6899313">1</span><span class="op" id="6899314">]</span><span class="op" id="6899315">.</span><span class="ident" id="6899316">nullParam</span><span class="op" id="6899325">,</span>&nbsp;<span class="ident" id="6899327">spec</span><span class="op" id="6899331">.</span><span class="ident" id="6899332">rows</span><span class="op" id="6899336">[</span><span class="num" id="6899337">1</span><span class="op" id="6899338">]</span><span class="op" id="6899339">.</span><span class="ident" id="6899340">notNullParam</span><span class="op" id="6899352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6899356">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899395">stmt</span><span class="op" id="6899399">,</span>&nbsp;<span class="ident" id="6899401">err</span>&nbsp;<span class="op" id="6899405">:=</span>&nbsp;<span class="ident" id="6899408">db</span><span class="op" id="6899410">.</span><span class="ident" id="6899411">Prepare</span><span class="op" id="6899418">(</span><span class="string" id="6899419">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="6899460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899463">if</span>&nbsp;<span class="ident" id="6899466">err</span>&nbsp;<span class="op" id="6899470">!=</span>&nbsp;<span class="ident" id="6899473">nil</span>&nbsp;<span class="op" id="6899477">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899481">t</span><span class="op" id="6899482">.</span><span class="ident" id="6899483">Fatalf</span><span class="op" id="6899489">(</span><span class="string" id="6899490">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6899503">,</span>&nbsp;<span class="ident" id="6899505">err</span><span class="op" id="6899508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899514">defer</span>&nbsp;<span class="ident" id="6899520">stmt</span><span class="op" id="6899524">.</span><span class="ident" id="6899525">Close</span><span class="op" id="6899530">(</span><span class="op" id="6899531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899534">if</span>&nbsp;<span class="ident" id="6899537">_</span><span class="op" id="6899538">,</span>&nbsp;<span class="ident" id="6899540">err</span>&nbsp;<span class="op" id="6899544">:=</span>&nbsp;<span class="ident" id="6899547">stmt</span><span class="op" id="6899551">.</span><span class="ident" id="6899552">Exec</span><span class="op" id="6899556">(</span><span class="num" id="6899557">3</span><span class="op" id="6899558">,</span>&nbsp;<span class="string" id="6899560">&#34;chris&#34;</span><span class="op" id="6899567">,</span>&nbsp;<span class="ident" id="6899569">spec</span><span class="op" id="6899573">.</span><span class="ident" id="6899574">rows</span><span class="op" id="6899578">[</span><span class="num" id="6899579">2</span><span class="op" id="6899580">]</span><span class="op" id="6899581">.</span><span class="ident" id="6899582">nullParam</span><span class="op" id="6899591">,</span>&nbsp;<span class="ident" id="6899593">spec</span><span class="op" id="6899597">.</span><span class="ident" id="6899598">rows</span><span class="op" id="6899602">[</span><span class="num" id="6899603">2</span><span class="op" id="6899604">]</span><span class="op" id="6899605">.</span><span class="ident" id="6899606">notNullParam</span><span class="op" id="6899618">)</span><span class="op" id="6899619">;</span>&nbsp;<span class="ident" id="6899621">err</span>&nbsp;<span class="op" id="6899625">!=</span>&nbsp;<span class="ident" id="6899628">nil</span>&nbsp;<span class="op" id="6899632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899636">t</span><span class="op" id="6899637">.</span><span class="ident" id="6899638">Errorf</span><span class="op" id="6899644">(</span><span class="string" id="6899645">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="6899668">,</span>&nbsp;<span class="ident" id="6899670">err</span><span class="op" id="6899673">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899679">if</span>&nbsp;<span class="ident" id="6899682">_</span><span class="op" id="6899683">,</span>&nbsp;<span class="ident" id="6899685">err</span>&nbsp;<span class="op" id="6899689">:=</span>&nbsp;<span class="ident" id="6899692">stmt</span><span class="op" id="6899696">.</span><span class="ident" id="6899697">Exec</span><span class="op" id="6899701">(</span><span class="num" id="6899702">4</span><span class="op" id="6899703">,</span>&nbsp;<span class="string" id="6899705">&#34;dave&#34;</span><span class="op" id="6899711">,</span>&nbsp;<span class="ident" id="6899713">spec</span><span class="op" id="6899717">.</span><span class="ident" id="6899718">rows</span><span class="op" id="6899722">[</span><span class="num" id="6899723">3</span><span class="op" id="6899724">]</span><span class="op" id="6899725">.</span><span class="ident" id="6899726">nullParam</span><span class="op" id="6899735">,</span>&nbsp;<span class="ident" id="6899737">spec</span><span class="op" id="6899741">.</span><span class="ident" id="6899742">rows</span><span class="op" id="6899746">[</span><span class="num" id="6899747">3</span><span class="op" id="6899748">]</span><span class="op" id="6899749">.</span><span class="ident" id="6899750">notNullParam</span><span class="op" id="6899762">)</span><span class="op" id="6899763">;</span>&nbsp;<span class="ident" id="6899765">err</span>&nbsp;<span class="op" id="6899769">!=</span>&nbsp;<span class="ident" id="6899772">nil</span>&nbsp;<span class="op" id="6899776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899780">t</span><span class="op" id="6899781">.</span><span class="ident" id="6899782">Errorf</span><span class="op" id="6899788">(</span><span class="string" id="6899789">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="6899811">,</span>&nbsp;<span class="ident" id="6899813">err</span><span class="op" id="6899816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6899822">if</span>&nbsp;<span class="ident" id="6899825">_</span><span class="op" id="6899826">,</span>&nbsp;<span class="ident" id="6899828">err</span>&nbsp;<span class="op" id="6899832">:=</span>&nbsp;<span class="ident" id="6899835">stmt</span><span class="op" id="6899839">.</span><span class="ident" id="6899840">Exec</span><span class="op" id="6899844">(</span><span class="num" id="6899845">5</span><span class="op" id="6899846">,</span>&nbsp;<span class="string" id="6899848">&#34;eleanor&#34;</span><span class="op" id="6899857">,</span>&nbsp;<span class="ident" id="6899859">spec</span><span class="op" id="6899863">.</span><span class="ident" id="6899864">rows</span><span class="op" id="6899868">[</span><span class="num" id="6899869">4</span><span class="op" id="6899870">]</span><span class="op" id="6899871">.</span><span class="ident" id="6899872">nullParam</span><span class="op" id="6899881">,</span>&nbsp;<span class="ident" id="6899883">spec</span><span class="op" id="6899887">.</span><span class="ident" id="6899888">rows</span><span class="op" id="6899892">[</span><span class="num" id="6899893">4</span><span class="op" id="6899894">]</span><span class="op" id="6899895">.</span><span class="ident" id="6899896">notNullParam</span><span class="op" id="6899908">)</span><span class="op" id="6899909">;</span>&nbsp;<span class="ident" id="6899911">err</span>&nbsp;<span class="op" id="6899915">!=</span>&nbsp;<span class="ident" id="6899918">nil</span>&nbsp;<span class="op" id="6899922">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6899926">t</span><span class="op" id="6899927">.</span><span class="ident" id="6899928">Errorf</span><span class="op" id="6899934">(</span><span class="string" id="6899935">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="6899960">,</span>&nbsp;<span class="ident" id="6899962">err</span><span class="op" id="6899965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6899968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6899972">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900013">if</span>&nbsp;<span class="ident" id="6900016">_</span><span class="op" id="6900017">,</span>&nbsp;<span class="ident" id="6900019">err</span>&nbsp;<span class="op" id="6900023">:=</span>&nbsp;<span class="ident" id="6900026">stmt</span><span class="op" id="6900030">.</span><span class="ident" id="6900031">Exec</span><span class="op" id="6900035">(</span><span class="num" id="6900036">6</span><span class="op" id="6900037">,</span>&nbsp;<span class="string" id="6900039">&#34;bob&#34;</span><span class="op" id="6900044">,</span>&nbsp;<span class="ident" id="6900046">spec</span><span class="op" id="6900050">.</span><span class="ident" id="6900051">rows</span><span class="op" id="6900055">[</span><span class="num" id="6900056">5</span><span class="op" id="6900057">]</span><span class="op" id="6900058">.</span><span class="ident" id="6900059">nullParam</span><span class="op" id="6900068">,</span>&nbsp;<span class="ident" id="6900070">spec</span><span class="op" id="6900074">.</span><span class="ident" id="6900075">rows</span><span class="op" id="6900079">[</span><span class="num" id="6900080">5</span><span class="op" id="6900081">]</span><span class="op" id="6900082">.</span><span class="ident" id="6900083">notNullParam</span><span class="op" id="6900095">)</span><span class="op" id="6900096">;</span>&nbsp;<span class="ident" id="6900098">err</span>&nbsp;<span class="op" id="6900102">==</span>&nbsp;<span class="ident" id="6900105">nil</span>&nbsp;<span class="op" id="6900109">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900113">t</span><span class="op" id="6900114">.</span><span class="ident" id="6900115">Errorf</span><span class="op" id="6900121">(</span><span class="string" id="6900122">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="6900185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900192">_</span><span class="op" id="6900193">,</span>&nbsp;<span class="ident" id="6900195">err</span>&nbsp;<span class="op" id="6900199">=</span>&nbsp;<span class="ident" id="6900201">db</span><span class="op" id="6900203">.</span><span class="ident" id="6900204">Exec</span><span class="op" id="6900208">(</span><span class="string" id="6900209">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="6900239">,</span>&nbsp;<span class="num" id="6900241">999</span><span class="op" id="6900244">,</span>&nbsp;<span class="ident" id="6900246">nil</span><span class="op" id="6900249">,</span>&nbsp;<span class="ident" id="6900251">nil</span><span class="op" id="6900254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900257">if</span>&nbsp;<span class="ident" id="6900260">err</span>&nbsp;<span class="op" id="6900264">==</span>&nbsp;<span class="ident" id="6900267">nil</span>&nbsp;<span class="op" id="6900271">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900275">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900325">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900381">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900433">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900481">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6900525">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900589">paramtype</span>&nbsp;<span class="op" id="6900599">:=</span>&nbsp;<span class="ident" id="6900602">reflect</span><span class="op" id="6900609">.</span><span class="ident" id="6900610">TypeOf</span><span class="op" id="6900616">(</span><span class="ident" id="6900617">spec</span><span class="op" id="6900621">.</span><span class="ident" id="6900622">rows</span><span class="op" id="6900626">[</span><span class="num" id="6900627">0</span><span class="op" id="6900628">]</span><span class="op" id="6900629">.</span><span class="ident" id="6900630">nullParam</span><span class="op" id="6900639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900642">bindVal</span>&nbsp;<span class="op" id="6900650">:=</span>&nbsp;<span class="ident" id="6900653">reflect</span><span class="op" id="6900660">.</span><span class="ident" id="6900661">New</span><span class="op" id="6900664">(</span><span class="ident" id="6900665">paramtype</span><span class="op" id="6900674">)</span><span class="op" id="6900675">.</span><span class="ident" id="6900676">Interface</span><span class="op" id="6900685">(</span><span class="op" id="6900686">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900690">for</span>&nbsp;<span class="ident" id="6900694">i</span>&nbsp;<span class="op" id="6900696">:=</span>&nbsp;<span class="num" id="6900699">0</span><span class="op" id="6900700">;</span>&nbsp;<span class="ident" id="6900702">i</span>&nbsp;<span class="op" id="6900704">&lt;</span>&nbsp;<span class="num" id="6900706">5</span><span class="op" id="6900707">;</span>&nbsp;<span class="ident" id="6900709">i</span><span class="op" id="6900710">++</span>&nbsp;<span class="op" id="6900713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900717">id</span>&nbsp;<span class="op" id="6900720">:=</span>&nbsp;<span class="ident" id="6900723">i</span>&nbsp;<span class="op" id="6900725">+</span>&nbsp;<span class="num" id="6900727">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900731">if</span>&nbsp;<span class="ident" id="6900734">err</span>&nbsp;<span class="op" id="6900738">:=</span>&nbsp;<span class="ident" id="6900741">db</span><span class="op" id="6900743">.</span><span class="ident" id="6900744">QueryRow</span><span class="op" id="6900752">(</span><span class="string" id="6900753">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="6900774">,</span>&nbsp;<span class="ident" id="6900776">id</span><span class="op" id="6900778">)</span><span class="op" id="6900779">.</span><span class="ident" id="6900780">Scan</span><span class="op" id="6900784">(</span><span class="ident" id="6900785">bindVal</span><span class="op" id="6900792">)</span><span class="op" id="6900793">;</span>&nbsp;<span class="ident" id="6900795">err</span>&nbsp;<span class="op" id="6900799">!=</span>&nbsp;<span class="ident" id="6900802">nil</span>&nbsp;<span class="op" id="6900806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900811">t</span><span class="op" id="6900812">.</span><span class="ident" id="6900813">Errorf</span><span class="op" id="6900819">(</span><span class="string" id="6900820">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="6900836">,</span>&nbsp;<span class="ident" id="6900838">id</span><span class="op" id="6900840">,</span>&nbsp;<span class="ident" id="6900842">err</span><span class="op" id="6900845">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6900849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900853">bindValDeref</span>&nbsp;<span class="op" id="6900866">:=</span>&nbsp;<span class="ident" id="6900869">reflect</span><span class="op" id="6900876">.</span><span class="ident" id="6900877">ValueOf</span><span class="op" id="6900884">(</span><span class="ident" id="6900885">bindVal</span><span class="op" id="6900892">)</span><span class="op" id="6900893">.</span><span class="ident" id="6900894">Elem</span><span class="op" id="6900898">(</span><span class="op" id="6900899">)</span><span class="op" id="6900900">.</span><span class="ident" id="6900901">Interface</span><span class="op" id="6900910">(</span><span class="op" id="6900911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6900915">if</span>&nbsp;<span class="op" id="6900918">!</span><span class="ident" id="6900919">reflect</span><span class="op" id="6900926">.</span><span class="ident" id="6900927">DeepEqual</span><span class="op" id="6900936">(</span><span class="ident" id="6900937">bindValDeref</span><span class="op" id="6900949">,</span>&nbsp;<span class="ident" id="6900951">spec</span><span class="op" id="6900955">.</span><span class="ident" id="6900956">rows</span><span class="op" id="6900960">[</span><span class="ident" id="6900961">i</span><span class="op" id="6900962">]</span><span class="op" id="6900963">.</span><span class="ident" id="6900964">scanNullVal</span><span class="op" id="6900975">)</span>&nbsp;<span class="op" id="6900977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6900982">t</span><span class="op" id="6900983">.</span><span class="ident" id="6900984">Errorf</span><span class="op" id="6900990">(</span><span class="string" id="6900991">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6901016">,</span>&nbsp;<span class="ident" id="6901018">id</span><span class="op" id="6901020">,</span>&nbsp;<span class="ident" id="6901022">bindValDeref</span><span class="op" id="6901034">,</span>&nbsp;<span class="ident" id="6901036">spec</span><span class="op" id="6901040">.</span><span class="ident" id="6901041">rows</span><span class="op" id="6901045">[</span><span class="ident" id="6901046">i</span><span class="op" id="6901047">]</span><span class="op" id="6901048">.</span><span class="ident" id="6901049">scanNullVal</span><span class="op" id="6901060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901064">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901067">}</span><br>
<span class="lineno"></span><span class="op" id="6901069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6901072">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="6901097">func</span>&nbsp;<span class="ident" id="6901102">TestQueryRowNilScanDest</span><span class="op" id="6901125">(</span><span class="ident" id="6901126">t</span>&nbsp;<span class="op" id="6901128">*</span><span class="ident" id="6901129">testing</span><span class="op" id="6901136">.</span><span class="ident" id="6901137">T</span><span class="op" id="6901138">)</span>&nbsp;<span class="op" id="6901140">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901143">db</span>&nbsp;<span class="op" id="6901146">:=</span>&nbsp;<span class="ident" id="6901149">newTestDB</span><span class="op" id="6901158">(</span><span class="ident" id="6901159">t</span><span class="op" id="6901160">,</span>&nbsp;<span class="string" id="6901162">&#34;people&#34;</span><span class="op" id="6901170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901173">defer</span>&nbsp;<span class="ident" id="6901179">closeDB</span><span class="op" id="6901186">(</span><span class="ident" id="6901187">t</span><span class="op" id="6901188">,</span>&nbsp;<span class="ident" id="6901190">db</span><span class="op" id="6901192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901195">var</span>&nbsp;<span class="ident" id="6901199">name</span>&nbsp;<span class="op" id="6901204">*</span><span class="builtintype" id="6901205">string</span>&nbsp;<span class="comment" id="6901212">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901228">err</span>&nbsp;<span class="op" id="6901232">:=</span>&nbsp;<span class="ident" id="6901235">db</span><span class="op" id="6901237">.</span><span class="ident" id="6901238">QueryRow</span><span class="op" id="6901246">(</span><span class="string" id="6901247">&#34;SELECT|people|name|&#34;</span><span class="op" id="6901268">)</span><span class="op" id="6901269">.</span><span class="ident" id="6901270">Scan</span><span class="op" id="6901274">(</span><span class="ident" id="6901275">name</span><span class="op" id="6901279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901282">want</span>&nbsp;<span class="op" id="6901287">:=</span>&nbsp;<span class="string" id="6901290">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901355">if</span>&nbsp;<span class="ident" id="6901358">err</span>&nbsp;<span class="op" id="6901362">==</span>&nbsp;<span class="ident" id="6901365">nil</span>&nbsp;<span class="op" id="6901369">||</span>&nbsp;<span class="ident" id="6901372">err</span><span class="op" id="6901375">.</span><span class="ident" id="6901376">Error</span><span class="op" id="6901381">(</span><span class="op" id="6901382">)</span>&nbsp;<span class="op" id="6901384">!=</span>&nbsp;<span class="ident" id="6901387">want</span>&nbsp;<span class="op" id="6901392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901396">t</span><span class="op" id="6901397">.</span><span class="ident" id="6901398">Errorf</span><span class="op" id="6901404">(</span><span class="string" id="6901405">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6901426">,</span>&nbsp;<span class="ident" id="6901428">err</span><span class="op" id="6901431">.</span><span class="ident" id="6901432">Error</span><span class="op" id="6901437">(</span><span class="op" id="6901438">)</span><span class="op" id="6901439">,</span>&nbsp;<span class="ident" id="6901441">want</span><span class="op" id="6901445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901448">}</span><br>
<span class="lineno"></span><span class="op" id="6901450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="6901453">func</span>&nbsp;<span class="ident" id="6901458">TestIssue4902</span><span class="op" id="6901471">(</span><span class="ident" id="6901472">t</span>&nbsp;<span class="op" id="6901474">*</span><span class="ident" id="6901475">testing</span><span class="op" id="6901482">.</span><span class="ident" id="6901483">T</span><span class="op" id="6901484">)</span>&nbsp;<span class="op" id="6901486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901489">db</span>&nbsp;<span class="op" id="6901492">:=</span>&nbsp;<span class="ident" id="6901495">newTestDB</span><span class="op" id="6901504">(</span><span class="ident" id="6901505">t</span><span class="op" id="6901506">,</span>&nbsp;<span class="string" id="6901508">&#34;people&#34;</span><span class="op" id="6901516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901519">defer</span>&nbsp;<span class="ident" id="6901525">closeDB</span><span class="op" id="6901532">(</span><span class="ident" id="6901533">t</span><span class="op" id="6901534">,</span>&nbsp;<span class="ident" id="6901536">db</span><span class="op" id="6901538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901542">driver</span>&nbsp;<span class="op" id="6901549">:=</span>&nbsp;<span class="ident" id="6901552">db</span><span class="op" id="6901554">.</span><span class="ident" id="6901555">driver</span><span class="op" id="6901561">.</span><span class="op" id="6901562">(</span><span class="op" id="6901563">*</span><span class="ident" id="6901564">fakeDriver</span><span class="op" id="6901574">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901577">opens0</span>&nbsp;<span class="op" id="6901584">:=</span>&nbsp;<span class="ident" id="6901587">driver</span><span class="op" id="6901593">.</span><span class="ident" id="6901594">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901606">var</span>&nbsp;<span class="ident" id="6901610">stmt</span>&nbsp;<span class="op" id="6901615">*</span><span class="ident" id="6901616">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901622">var</span>&nbsp;<span class="ident" id="6901626">err</span>&nbsp;<span class="builtintype" id="6901630">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901637">for</span>&nbsp;<span class="ident" id="6901641">i</span>&nbsp;<span class="op" id="6901643">:=</span>&nbsp;<span class="num" id="6901646">0</span><span class="op" id="6901647">;</span>&nbsp;<span class="ident" id="6901649">i</span>&nbsp;<span class="op" id="6901651">&lt;</span>&nbsp;<span class="num" id="6901653">10</span><span class="op" id="6901655">;</span>&nbsp;<span class="ident" id="6901657">i</span><span class="op" id="6901658">++</span>&nbsp;<span class="op" id="6901661">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901665">stmt</span><span class="op" id="6901669">,</span>&nbsp;<span class="ident" id="6901671">err</span>&nbsp;<span class="op" id="6901675">=</span>&nbsp;<span class="ident" id="6901677">db</span><span class="op" id="6901679">.</span><span class="ident" id="6901680">Prepare</span><span class="op" id="6901687">(</span><span class="string" id="6901688">&#34;SELECT|people|name|&#34;</span><span class="op" id="6901709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901713">if</span>&nbsp;<span class="ident" id="6901716">err</span>&nbsp;<span class="op" id="6901720">!=</span>&nbsp;<span class="ident" id="6901723">nil</span>&nbsp;<span class="op" id="6901727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901732">t</span><span class="op" id="6901733">.</span><span class="ident" id="6901734">Fatal</span><span class="op" id="6901739">(</span><span class="ident" id="6901740">err</span><span class="op" id="6901743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901751">err</span>&nbsp;<span class="op" id="6901755">=</span>&nbsp;<span class="ident" id="6901757">stmt</span><span class="op" id="6901761">.</span><span class="ident" id="6901762">Close</span><span class="op" id="6901767">(</span><span class="op" id="6901768">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901772">if</span>&nbsp;<span class="ident" id="6901775">err</span>&nbsp;<span class="op" id="6901779">!=</span>&nbsp;<span class="ident" id="6901782">nil</span>&nbsp;<span class="op" id="6901786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901791">t</span><span class="op" id="6901792">.</span><span class="ident" id="6901793">Fatal</span><span class="op" id="6901798">(</span><span class="ident" id="6901799">err</span><span class="op" id="6901802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901813">opens</span>&nbsp;<span class="op" id="6901819">:=</span>&nbsp;<span class="ident" id="6901822">driver</span><span class="op" id="6901828">.</span><span class="ident" id="6901829">openCount</span>&nbsp;<span class="op" id="6901839">-</span>&nbsp;<span class="ident" id="6901841">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6901849">if</span>&nbsp;<span class="ident" id="6901852">opens</span>&nbsp;<span class="op" id="6901858">&gt;</span>&nbsp;<span class="num" id="6901860">1</span>&nbsp;<span class="op" id="6901862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901866">t</span><span class="op" id="6901867">.</span><span class="ident" id="6901868">Errorf</span><span class="op" id="6901874">(</span><span class="string" id="6901875">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6901898">,</span>&nbsp;<span class="ident" id="6901900">opens</span><span class="op" id="6901905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901909">t</span><span class="op" id="6901910">.</span><span class="ident" id="6901911">Logf</span><span class="op" id="6901915">(</span><span class="string" id="6901916">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6901926">,</span>&nbsp;<span class="ident" id="6901928">db</span><span class="op" id="6901930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901934">t</span><span class="op" id="6901935">.</span><span class="ident" id="6901936">Logf</span><span class="op" id="6901940">(</span><span class="string" id="6901941">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6901955">,</span>&nbsp;<span class="ident" id="6901957">driver</span><span class="op" id="6901963">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6901967">t</span><span class="op" id="6901968">.</span><span class="ident" id="6901969">Logf</span><span class="op" id="6901973">(</span><span class="string" id="6901974">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6901986">,</span>&nbsp;<span class="ident" id="6901988">stmt</span><span class="op" id="6901992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6901995">}</span><br>
<span class="lineno"></span><span class="op" id="6901997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6902000">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="6902014">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="6902040">func</span>&nbsp;<span class="ident" id="6902045">TestSimultaneousQueries</span><span class="op" id="6902068">(</span><span class="ident" id="6902069">t</span>&nbsp;<span class="op" id="6902071">*</span><span class="ident" id="6902072">testing</span><span class="op" id="6902079">.</span><span class="ident" id="6902080">T</span><span class="op" id="6902081">)</span>&nbsp;<span class="op" id="6902083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902086">db</span>&nbsp;<span class="op" id="6902089">:=</span>&nbsp;<span class="ident" id="6902092">newTestDB</span><span class="op" id="6902101">(</span><span class="ident" id="6902102">t</span><span class="op" id="6902103">,</span>&nbsp;<span class="string" id="6902105">&#34;people&#34;</span><span class="op" id="6902113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902116">defer</span>&nbsp;<span class="ident" id="6902122">closeDB</span><span class="op" id="6902129">(</span><span class="ident" id="6902130">t</span><span class="op" id="6902131">,</span>&nbsp;<span class="ident" id="6902133">db</span><span class="op" id="6902135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902139">tx</span><span class="op" id="6902141">,</span>&nbsp;<span class="ident" id="6902143">err</span>&nbsp;<span class="op" id="6902147">:=</span>&nbsp;<span class="ident" id="6902150">db</span><span class="op" id="6902152">.</span><span class="ident" id="6902153">Begin</span><span class="op" id="6902158">(</span><span class="op" id="6902159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902162">if</span>&nbsp;<span class="ident" id="6902165">err</span>&nbsp;<span class="op" id="6902169">!=</span>&nbsp;<span class="ident" id="6902172">nil</span>&nbsp;<span class="op" id="6902176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902180">t</span><span class="op" id="6902181">.</span><span class="ident" id="6902182">Fatal</span><span class="op" id="6902187">(</span><span class="ident" id="6902188">err</span><span class="op" id="6902191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902197">defer</span>&nbsp;<span class="ident" id="6902203">tx</span><span class="op" id="6902205">.</span><span class="ident" id="6902206">Rollback</span><span class="op" id="6902214">(</span><span class="op" id="6902215">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902219">r1</span><span class="op" id="6902221">,</span>&nbsp;<span class="ident" id="6902223">err</span>&nbsp;<span class="op" id="6902227">:=</span>&nbsp;<span class="ident" id="6902230">tx</span><span class="op" id="6902232">.</span><span class="ident" id="6902233">Query</span><span class="op" id="6902238">(</span><span class="string" id="6902239">&#34;SELECT|people|name|&#34;</span><span class="op" id="6902260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902263">if</span>&nbsp;<span class="ident" id="6902266">err</span>&nbsp;<span class="op" id="6902270">!=</span>&nbsp;<span class="ident" id="6902273">nil</span>&nbsp;<span class="op" id="6902277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902281">t</span><span class="op" id="6902282">.</span><span class="ident" id="6902283">Fatal</span><span class="op" id="6902288">(</span><span class="ident" id="6902289">err</span><span class="op" id="6902292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902295">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902298">defer</span>&nbsp;<span class="ident" id="6902304">r1</span><span class="op" id="6902306">.</span><span class="ident" id="6902307">Close</span><span class="op" id="6902312">(</span><span class="op" id="6902313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902317">r2</span><span class="op" id="6902319">,</span>&nbsp;<span class="ident" id="6902321">err</span>&nbsp;<span class="op" id="6902325">:=</span>&nbsp;<span class="ident" id="6902328">tx</span><span class="op" id="6902330">.</span><span class="ident" id="6902331">Query</span><span class="op" id="6902336">(</span><span class="string" id="6902337">&#34;SELECT|people|name|&#34;</span><span class="op" id="6902358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902361">if</span>&nbsp;<span class="ident" id="6902364">err</span>&nbsp;<span class="op" id="6902368">!=</span>&nbsp;<span class="ident" id="6902371">nil</span>&nbsp;<span class="op" id="6902375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902379">t</span><span class="op" id="6902380">.</span><span class="ident" id="6902381">Fatal</span><span class="op" id="6902386">(</span><span class="ident" id="6902387">err</span><span class="op" id="6902390">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902396">defer</span>&nbsp;<span class="ident" id="6902402">r2</span><span class="op" id="6902404">.</span><span class="ident" id="6902405">Close</span><span class="op" id="6902410">(</span><span class="op" id="6902411">)</span><br>
<span class="lineno"></span><span class="op" id="6902413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6902416">func</span>&nbsp;<span class="ident" id="6902421">TestMaxIdleConns</span><span class="op" id="6902437">(</span><span class="ident" id="6902438">t</span>&nbsp;<span class="op" id="6902440">*</span><span class="ident" id="6902441">testing</span><span class="op" id="6902448">.</span><span class="ident" id="6902449">T</span><span class="op" id="6902450">)</span>&nbsp;<span class="op" id="6902452">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902455">db</span>&nbsp;<span class="op" id="6902458">:=</span>&nbsp;<span class="ident" id="6902461">newTestDB</span><span class="op" id="6902470">(</span><span class="ident" id="6902471">t</span><span class="op" id="6902472">,</span>&nbsp;<span class="string" id="6902474">&#34;people&#34;</span><span class="op" id="6902482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902485">defer</span>&nbsp;<span class="ident" id="6902491">closeDB</span><span class="op" id="6902498">(</span><span class="ident" id="6902499">t</span><span class="op" id="6902500">,</span>&nbsp;<span class="ident" id="6902502">db</span><span class="op" id="6902504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902508">tx</span><span class="op" id="6902510">,</span>&nbsp;<span class="ident" id="6902512">err</span>&nbsp;<span class="op" id="6902516">:=</span>&nbsp;<span class="ident" id="6902519">db</span><span class="op" id="6902521">.</span><span class="ident" id="6902522">Begin</span><span class="op" id="6902527">(</span><span class="op" id="6902528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902531">if</span>&nbsp;<span class="ident" id="6902534">err</span>&nbsp;<span class="op" id="6902538">!=</span>&nbsp;<span class="ident" id="6902541">nil</span>&nbsp;<span class="op" id="6902545">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902549">t</span><span class="op" id="6902550">.</span><span class="ident" id="6902551">Fatal</span><span class="op" id="6902556">(</span><span class="ident" id="6902557">err</span><span class="op" id="6902560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902566">tx</span><span class="op" id="6902568">.</span><span class="ident" id="6902569">Commit</span><span class="op" id="6902575">(</span><span class="op" id="6902576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902579">if</span>&nbsp;<span class="ident" id="6902582">got</span>&nbsp;<span class="op" id="6902586">:=</span>&nbsp;<span class="builtinfunc" id="6902589">len</span><span class="op" id="6902592">(</span><span class="ident" id="6902593">db</span><span class="op" id="6902595">.</span><span class="ident" id="6902596">freeConn</span><span class="op" id="6902604">)</span><span class="op" id="6902605">;</span>&nbsp;<span class="ident" id="6902607">got</span>&nbsp;<span class="op" id="6902611">!=</span>&nbsp;<span class="num" id="6902614">1</span>&nbsp;<span class="op" id="6902616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902620">t</span><span class="op" id="6902621">.</span><span class="ident" id="6902622">Errorf</span><span class="op" id="6902628">(</span><span class="string" id="6902629">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6902653">,</span>&nbsp;<span class="ident" id="6902655">got</span><span class="op" id="6902658">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902665">db</span><span class="op" id="6902667">.</span><span class="ident" id="6902668">SetMaxIdleConns</span><span class="op" id="6902683">(</span><span class="num" id="6902684">0</span><span class="op" id="6902685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902689">if</span>&nbsp;<span class="ident" id="6902692">got</span>&nbsp;<span class="op" id="6902696">:=</span>&nbsp;<span class="builtinfunc" id="6902699">len</span><span class="op" id="6902702">(</span><span class="ident" id="6902703">db</span><span class="op" id="6902705">.</span><span class="ident" id="6902706">freeConn</span><span class="op" id="6902714">)</span><span class="op" id="6902715">;</span>&nbsp;<span class="ident" id="6902717">got</span>&nbsp;<span class="op" id="6902721">!=</span>&nbsp;<span class="num" id="6902724">0</span>&nbsp;<span class="op" id="6902726">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902730">t</span><span class="op" id="6902731">.</span><span class="ident" id="6902732">Errorf</span><span class="op" id="6902738">(</span><span class="string" id="6902739">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6902781">,</span>&nbsp;<span class="ident" id="6902783">got</span><span class="op" id="6902786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902793">tx</span><span class="op" id="6902795">,</span>&nbsp;<span class="ident" id="6902797">err</span>&nbsp;<span class="op" id="6902801">=</span>&nbsp;<span class="ident" id="6902803">db</span><span class="op" id="6902805">.</span><span class="ident" id="6902806">Begin</span><span class="op" id="6902811">(</span><span class="op" id="6902812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902815">if</span>&nbsp;<span class="ident" id="6902818">err</span>&nbsp;<span class="op" id="6902822">!=</span>&nbsp;<span class="ident" id="6902825">nil</span>&nbsp;<span class="op" id="6902829">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902833">t</span><span class="op" id="6902834">.</span><span class="ident" id="6902835">Fatal</span><span class="op" id="6902840">(</span><span class="ident" id="6902841">err</span><span class="op" id="6902844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902850">tx</span><span class="op" id="6902852">.</span><span class="ident" id="6902853">Commit</span><span class="op" id="6902859">(</span><span class="op" id="6902860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902863">if</span>&nbsp;<span class="ident" id="6902866">got</span>&nbsp;<span class="op" id="6902870">:=</span>&nbsp;<span class="builtinfunc" id="6902873">len</span><span class="op" id="6902876">(</span><span class="ident" id="6902877">db</span><span class="op" id="6902879">.</span><span class="ident" id="6902880">freeConn</span><span class="op" id="6902888">)</span><span class="op" id="6902889">;</span>&nbsp;<span class="ident" id="6902891">got</span>&nbsp;<span class="op" id="6902895">!=</span>&nbsp;<span class="num" id="6902898">0</span>&nbsp;<span class="op" id="6902900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6902904">t</span><span class="op" id="6902905">.</span><span class="ident" id="6902906">Errorf</span><span class="op" id="6902912">(</span><span class="string" id="6902913">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6902937">,</span>&nbsp;<span class="ident" id="6902939">got</span><span class="op" id="6902942">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6902945">}</span><br>
<span class="lineno"></span><span class="op" id="6902947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6902950">func</span>&nbsp;<span class="ident" id="6902955">TestMaxOpenConns</span><span class="op" id="6902971">(</span><span class="ident" id="6902972">t</span>&nbsp;<span class="op" id="6902974">*</span><span class="ident" id="6902975">testing</span><span class="op" id="6902982">.</span><span class="ident" id="6902983">T</span><span class="op" id="6902984">)</span>&nbsp;<span class="op" id="6902986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6902989">if</span>&nbsp;<span class="ident" id="6902992">testing</span><span class="op" id="6902999">.</span><span class="ident" id="6903000">Short</span><span class="op" id="6903005">(</span><span class="op" id="6903006">)</span>&nbsp;<span class="op" id="6903008">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903012">t</span><span class="op" id="6903013">.</span><span class="ident" id="6903014">Skip</span><span class="op" id="6903018">(</span><span class="string" id="6903019">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6903043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903049">defer</span>&nbsp;<span class="ident" id="6903055">setHookpostCloseConn</span><span class="op" id="6903075">(</span><span class="ident" id="6903076">nil</span><span class="op" id="6903079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903082">setHookpostCloseConn</span><span class="op" id="6903102">(</span><span class="keyword" id="6903103">func</span><span class="op" id="6903107">(</span><span class="ident" id="6903108">_</span>&nbsp;<span class="op" id="6903110">*</span><span class="ident" id="6903111">fakeConn</span><span class="op" id="6903119">,</span>&nbsp;<span class="ident" id="6903121">err</span>&nbsp;<span class="builtintype" id="6903125">error</span><span class="op" id="6903130">)</span>&nbsp;<span class="op" id="6903132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903136">if</span>&nbsp;<span class="ident" id="6903139">err</span>&nbsp;<span class="op" id="6903143">!=</span>&nbsp;<span class="ident" id="6903146">nil</span>&nbsp;<span class="op" id="6903150">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903155">t</span><span class="op" id="6903156">.</span><span class="ident" id="6903157">Errorf</span><span class="op" id="6903163">(</span><span class="string" id="6903164">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6903192">,</span>&nbsp;<span class="ident" id="6903194">err</span><span class="op" id="6903197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903204">}</span><span class="op" id="6903205">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903209">db</span>&nbsp;<span class="op" id="6903212">:=</span>&nbsp;<span class="ident" id="6903215">newTestDB</span><span class="op" id="6903224">(</span><span class="ident" id="6903225">t</span><span class="op" id="6903226">,</span>&nbsp;<span class="string" id="6903228">&#34;magicquery&#34;</span><span class="op" id="6903240">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903243">defer</span>&nbsp;<span class="ident" id="6903249">closeDB</span><span class="op" id="6903256">(</span><span class="ident" id="6903257">t</span><span class="op" id="6903258">,</span>&nbsp;<span class="ident" id="6903260">db</span><span class="op" id="6903262">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903266">driver</span>&nbsp;<span class="op" id="6903273">:=</span>&nbsp;<span class="ident" id="6903276">db</span><span class="op" id="6903278">.</span><span class="ident" id="6903279">driver</span><span class="op" id="6903285">.</span><span class="op" id="6903286">(</span><span class="op" id="6903287">*</span><span class="ident" id="6903288">fakeDriver</span><span class="op" id="6903298">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6903302">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6903374">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903397">db</span><span class="op" id="6903399">.</span><span class="ident" id="6903400">SetMaxIdleConns</span><span class="op" id="6903415">(</span><span class="num" id="6903416">0</span><span class="op" id="6903417">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903421">if</span>&nbsp;<span class="ident" id="6903424">g</span><span class="op" id="6903425">,</span>&nbsp;<span class="ident" id="6903427">w</span>&nbsp;<span class="op" id="6903429">:=</span>&nbsp;<span class="ident" id="6903432">db</span><span class="op" id="6903434">.</span><span class="ident" id="6903435">numFreeConns</span><span class="op" id="6903447">(</span><span class="op" id="6903448">)</span><span class="op" id="6903449">,</span>&nbsp;<span class="num" id="6903451">0</span><span class="op" id="6903452">;</span>&nbsp;<span class="ident" id="6903454">g</span>&nbsp;<span class="op" id="6903456">!=</span>&nbsp;<span class="ident" id="6903459">w</span>&nbsp;<span class="op" id="6903461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903465">t</span><span class="op" id="6903466">.</span><span class="ident" id="6903467">Errorf</span><span class="op" id="6903473">(</span><span class="string" id="6903474">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6903500">,</span>&nbsp;<span class="ident" id="6903502">g</span><span class="op" id="6903503">,</span>&nbsp;<span class="ident" id="6903505">w</span><span class="op" id="6903506">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903513">if</span>&nbsp;<span class="ident" id="6903516">n</span>&nbsp;<span class="op" id="6903518">:=</span>&nbsp;<span class="ident" id="6903521">db</span><span class="op" id="6903523">.</span><span class="ident" id="6903524">numDepsPollUntil</span><span class="op" id="6903540">(</span><span class="num" id="6903541">0</span><span class="op" id="6903542">,</span>&nbsp;<span class="ident" id="6903544">time</span><span class="op" id="6903548">.</span><span class="ident" id="6903549">Second</span><span class="op" id="6903555">)</span><span class="op" id="6903556">;</span>&nbsp;<span class="ident" id="6903558">n</span>&nbsp;<span class="op" id="6903560">&gt;</span>&nbsp;<span class="num" id="6903562">0</span>&nbsp;<span class="op" id="6903564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903568">t</span><span class="op" id="6903569">.</span><span class="ident" id="6903570">Errorf</span><span class="op" id="6903576">(</span><span class="string" id="6903577">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6903618">,</span>&nbsp;<span class="ident" id="6903620">n</span><span class="op" id="6903621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903625">db</span><span class="op" id="6903627">.</span><span class="ident" id="6903628">dumpDeps</span><span class="op" id="6903636">(</span><span class="ident" id="6903637">t</span><span class="op" id="6903638">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903645">driver</span><span class="op" id="6903651">.</span><span class="ident" id="6903652">mu</span><span class="op" id="6903654">.</span><span class="ident" id="6903655">Lock</span><span class="op" id="6903659">(</span><span class="op" id="6903660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903663">opens0</span>&nbsp;<span class="op" id="6903670">:=</span>&nbsp;<span class="ident" id="6903673">driver</span><span class="op" id="6903679">.</span><span class="ident" id="6903680">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903691">closes0</span>&nbsp;<span class="op" id="6903699">:=</span>&nbsp;<span class="ident" id="6903702">driver</span><span class="op" id="6903708">.</span><span class="ident" id="6903709">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903721">driver</span><span class="op" id="6903727">.</span><span class="ident" id="6903728">mu</span><span class="op" id="6903730">.</span><span class="ident" id="6903731">Unlock</span><span class="op" id="6903737">(</span><span class="op" id="6903738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903742">db</span><span class="op" id="6903744">.</span><span class="ident" id="6903745">SetMaxIdleConns</span><span class="op" id="6903760">(</span><span class="num" id="6903761">10</span><span class="op" id="6903763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903766">db</span><span class="op" id="6903768">.</span><span class="ident" id="6903769">SetMaxOpenConns</span><span class="op" id="6903784">(</span><span class="num" id="6903785">10</span><span class="op" id="6903787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903791">stmt</span><span class="op" id="6903795">,</span>&nbsp;<span class="ident" id="6903797">err</span>&nbsp;<span class="op" id="6903801">:=</span>&nbsp;<span class="ident" id="6903804">db</span><span class="op" id="6903806">.</span><span class="ident" id="6903807">Prepare</span><span class="op" id="6903814">(</span><span class="string" id="6903815">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6903851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903854">if</span>&nbsp;<span class="ident" id="6903857">err</span>&nbsp;<span class="op" id="6903861">!=</span>&nbsp;<span class="ident" id="6903864">nil</span>&nbsp;<span class="op" id="6903868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903872">t</span><span class="op" id="6903873">.</span><span class="ident" id="6903874">Fatal</span><span class="op" id="6903879">(</span><span class="ident" id="6903880">err</span><span class="op" id="6903883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6903890">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903926">const</span>&nbsp;<span class="op" id="6903932">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903936">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6903948">=</span>&nbsp;<span class="num" id="6903950">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903955">sleepMillis</span>&nbsp;<span class="op" id="6903967">=</span>&nbsp;<span class="num" id="6903969">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6903974">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6903986">=</span>&nbsp;<span class="num" id="6903988">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6903991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6903994">var</span>&nbsp;<span class="ident" id="6903998">wg</span>&nbsp;<span class="ident" id="6904001">sync</span><span class="op" id="6904005">.</span><span class="ident" id="6904006">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904017">for</span>&nbsp;<span class="ident" id="6904021">batch</span>&nbsp;<span class="op" id="6904027">:=</span>&nbsp;<span class="num" id="6904030">0</span><span class="op" id="6904031">;</span>&nbsp;<span class="ident" id="6904033">batch</span>&nbsp;<span class="op" id="6904039">&lt;</span>&nbsp;<span class="ident" id="6904041">nbatch</span><span class="op" id="6904047">;</span>&nbsp;<span class="ident" id="6904049">batch</span><span class="op" id="6904054">++</span>&nbsp;<span class="op" id="6904057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904061">for</span>&nbsp;<span class="ident" id="6904065">i</span>&nbsp;<span class="op" id="6904067">:=</span>&nbsp;<span class="num" id="6904070">0</span><span class="op" id="6904071">;</span>&nbsp;<span class="ident" id="6904073">i</span>&nbsp;<span class="op" id="6904075">&lt;</span>&nbsp;<span class="ident" id="6904077">nquery</span><span class="op" id="6904083">;</span>&nbsp;<span class="ident" id="6904085">i</span><span class="op" id="6904086">++</span>&nbsp;<span class="op" id="6904089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904094">wg</span><span class="op" id="6904096">.</span><span class="ident" id="6904097">Add</span><span class="op" id="6904100">(</span><span class="num" id="6904101">1</span><span class="op" id="6904102">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904107">go</span>&nbsp;<span class="keyword" id="6904110">func</span><span class="op" id="6904114">(</span><span class="op" id="6904115">)</span>&nbsp;<span class="op" id="6904117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904123">defer</span>&nbsp;<span class="ident" id="6904129">wg</span><span class="op" id="6904131">.</span><span class="ident" id="6904132">Done</span><span class="op" id="6904136">(</span><span class="op" id="6904137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904143">var</span>&nbsp;<span class="ident" id="6904147">op</span>&nbsp;<span class="builtintype" id="6904150">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904161">if</span>&nbsp;<span class="ident" id="6904164">err</span>&nbsp;<span class="op" id="6904168">:=</span>&nbsp;<span class="ident" id="6904171">stmt</span><span class="op" id="6904175">.</span><span class="ident" id="6904176">QueryRow</span><span class="op" id="6904184">(</span><span class="string" id="6904185">&#34;sleep&#34;</span><span class="op" id="6904192">,</span>&nbsp;<span class="ident" id="6904194">sleepMillis</span><span class="op" id="6904205">)</span><span class="op" id="6904206">.</span><span class="ident" id="6904207">Scan</span><span class="op" id="6904211">(</span><span class="op" id="6904212">&amp;</span><span class="ident" id="6904213">op</span><span class="op" id="6904215">)</span><span class="op" id="6904216">;</span>&nbsp;<span class="ident" id="6904218">err</span>&nbsp;<span class="op" id="6904222">!=</span>&nbsp;<span class="ident" id="6904225">nil</span>&nbsp;<span class="op" id="6904229">&amp;&amp;</span>&nbsp;<span class="ident" id="6904232">err</span>&nbsp;<span class="op" id="6904236">!=</span>&nbsp;<span class="ident" id="6904239">ErrNoRows</span>&nbsp;<span class="op" id="6904249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904256">t</span><span class="op" id="6904257">.</span><span class="ident" id="6904258">Error</span><span class="op" id="6904263">(</span><span class="ident" id="6904264">err</span><span class="op" id="6904267">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904278">}</span><span class="op" id="6904279">(</span><span class="op" id="6904280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6904288">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6904345">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6904402">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904423">time</span><span class="op" id="6904427">.</span><span class="ident" id="6904428">Sleep</span><span class="op" id="6904433">(</span><span class="num" id="6904434">2</span>&nbsp;<span class="op" id="6904436">*</span>&nbsp;<span class="ident" id="6904438">sleepMillis</span>&nbsp;<span class="op" id="6904450">*</span>&nbsp;<span class="ident" id="6904452">time</span><span class="op" id="6904456">.</span><span class="ident" id="6904457">Millisecond</span><span class="op" id="6904468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904474">wg</span><span class="op" id="6904476">.</span><span class="ident" id="6904477">Wait</span><span class="op" id="6904481">(</span><span class="op" id="6904482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904486">if</span>&nbsp;<span class="ident" id="6904489">g</span><span class="op" id="6904490">,</span>&nbsp;<span class="ident" id="6904492">w</span>&nbsp;<span class="op" id="6904494">:=</span>&nbsp;<span class="ident" id="6904497">db</span><span class="op" id="6904499">.</span><span class="ident" id="6904500">numFreeConns</span><span class="op" id="6904512">(</span><span class="op" id="6904513">)</span><span class="op" id="6904514">,</span>&nbsp;<span class="num" id="6904516">10</span><span class="op" id="6904518">;</span>&nbsp;<span class="ident" id="6904520">g</span>&nbsp;<span class="op" id="6904522">!=</span>&nbsp;<span class="ident" id="6904525">w</span>&nbsp;<span class="op" id="6904527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904531">t</span><span class="op" id="6904532">.</span><span class="ident" id="6904533">Errorf</span><span class="op" id="6904539">(</span><span class="string" id="6904540">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6904566">,</span>&nbsp;<span class="ident" id="6904568">g</span><span class="op" id="6904569">,</span>&nbsp;<span class="ident" id="6904571">w</span><span class="op" id="6904572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904579">if</span>&nbsp;<span class="ident" id="6904582">n</span>&nbsp;<span class="op" id="6904584">:=</span>&nbsp;<span class="ident" id="6904587">db</span><span class="op" id="6904589">.</span><span class="ident" id="6904590">numDepsPollUntil</span><span class="op" id="6904606">(</span><span class="num" id="6904607">20</span><span class="op" id="6904609">,</span>&nbsp;<span class="ident" id="6904611">time</span><span class="op" id="6904615">.</span><span class="ident" id="6904616">Second</span><span class="op" id="6904622">)</span><span class="op" id="6904623">;</span>&nbsp;<span class="ident" id="6904625">n</span>&nbsp;<span class="op" id="6904627">&gt;</span>&nbsp;<span class="num" id="6904629">20</span>&nbsp;<span class="op" id="6904632">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904636">t</span><span class="op" id="6904637">.</span><span class="ident" id="6904638">Errorf</span><span class="op" id="6904644">(</span><span class="string" id="6904645">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="6904690">,</span>&nbsp;<span class="ident" id="6904692">n</span><span class="op" id="6904693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904697">db</span><span class="op" id="6904699">.</span><span class="ident" id="6904700">dumpDeps</span><span class="op" id="6904708">(</span><span class="ident" id="6904709">t</span><span class="op" id="6904710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904717">driver</span><span class="op" id="6904723">.</span><span class="ident" id="6904724">mu</span><span class="op" id="6904726">.</span><span class="ident" id="6904727">Lock</span><span class="op" id="6904731">(</span><span class="op" id="6904732">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904735">opens</span>&nbsp;<span class="op" id="6904741">:=</span>&nbsp;<span class="ident" id="6904744">driver</span><span class="op" id="6904750">.</span><span class="ident" id="6904751">openCount</span>&nbsp;<span class="op" id="6904761">-</span>&nbsp;<span class="ident" id="6904763">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904771">closes</span>&nbsp;<span class="op" id="6904778">:=</span>&nbsp;<span class="ident" id="6904781">driver</span><span class="op" id="6904787">.</span><span class="ident" id="6904788">closeCount</span>&nbsp;<span class="op" id="6904799">-</span>&nbsp;<span class="ident" id="6904801">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904810">driver</span><span class="op" id="6904816">.</span><span class="ident" id="6904817">mu</span><span class="op" id="6904819">.</span><span class="ident" id="6904820">Unlock</span><span class="op" id="6904826">(</span><span class="op" id="6904827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6904831">if</span>&nbsp;<span class="ident" id="6904834">opens</span>&nbsp;<span class="op" id="6904840">&gt;</span>&nbsp;<span class="num" id="6904842">10</span>&nbsp;<span class="op" id="6904845">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904849">t</span><span class="op" id="6904850">.</span><span class="ident" id="6904851">Logf</span><span class="op" id="6904855">(</span><span class="string" id="6904856">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6904873">,</span>&nbsp;<span class="ident" id="6904875">opens</span><span class="op" id="6904880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904884">t</span><span class="op" id="6904885">.</span><span class="ident" id="6904886">Logf</span><span class="op" id="6904890">(</span><span class="string" id="6904891">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6904909">,</span>&nbsp;<span class="ident" id="6904911">closes</span><span class="op" id="6904917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904921">t</span><span class="op" id="6904922">.</span><span class="ident" id="6904923">Errorf</span><span class="op" id="6904929">(</span><span class="string" id="6904930">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6904970">,</span>&nbsp;<span class="ident" id="6904972">opens</span><span class="op" id="6904977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6904981">db</span><span class="op" id="6904983">.</span><span class="ident" id="6904984">dumpDeps</span><span class="op" id="6904992">(</span><span class="ident" id="6904993">t</span><span class="op" id="6904994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6904997">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905001">if</span>&nbsp;<span class="ident" id="6905004">err</span>&nbsp;<span class="op" id="6905008">:=</span>&nbsp;<span class="ident" id="6905011">stmt</span><span class="op" id="6905015">.</span><span class="ident" id="6905016">Close</span><span class="op" id="6905021">(</span><span class="op" id="6905022">)</span><span class="op" id="6905023">;</span>&nbsp;<span class="ident" id="6905025">err</span>&nbsp;<span class="op" id="6905029">!=</span>&nbsp;<span class="ident" id="6905032">nil</span>&nbsp;<span class="op" id="6905036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905040">t</span><span class="op" id="6905041">.</span><span class="ident" id="6905042">Fatal</span><span class="op" id="6905047">(</span><span class="ident" id="6905048">err</span><span class="op" id="6905051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905058">if</span>&nbsp;<span class="ident" id="6905061">g</span><span class="op" id="6905062">,</span>&nbsp;<span class="ident" id="6905064">w</span>&nbsp;<span class="op" id="6905066">:=</span>&nbsp;<span class="ident" id="6905069">db</span><span class="op" id="6905071">.</span><span class="ident" id="6905072">numFreeConns</span><span class="op" id="6905084">(</span><span class="op" id="6905085">)</span><span class="op" id="6905086">,</span>&nbsp;<span class="num" id="6905088">10</span><span class="op" id="6905090">;</span>&nbsp;<span class="ident" id="6905092">g</span>&nbsp;<span class="op" id="6905094">!=</span>&nbsp;<span class="ident" id="6905097">w</span>&nbsp;<span class="op" id="6905099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905103">t</span><span class="op" id="6905104">.</span><span class="ident" id="6905105">Errorf</span><span class="op" id="6905111">(</span><span class="string" id="6905112">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6905138">,</span>&nbsp;<span class="ident" id="6905140">g</span><span class="op" id="6905141">,</span>&nbsp;<span class="ident" id="6905143">w</span><span class="op" id="6905144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905151">if</span>&nbsp;<span class="ident" id="6905154">n</span>&nbsp;<span class="op" id="6905156">:=</span>&nbsp;<span class="ident" id="6905159">db</span><span class="op" id="6905161">.</span><span class="ident" id="6905162">numDepsPollUntil</span><span class="op" id="6905178">(</span><span class="num" id="6905179">10</span><span class="op" id="6905181">,</span>&nbsp;<span class="ident" id="6905183">time</span><span class="op" id="6905187">.</span><span class="ident" id="6905188">Second</span><span class="op" id="6905194">)</span><span class="op" id="6905195">;</span>&nbsp;<span class="ident" id="6905197">n</span>&nbsp;<span class="op" id="6905199">&gt;</span>&nbsp;<span class="num" id="6905201">10</span>&nbsp;<span class="op" id="6905204">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905208">t</span><span class="op" id="6905209">.</span><span class="ident" id="6905210">Errorf</span><span class="op" id="6905216">(</span><span class="string" id="6905217">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="6905262">,</span>&nbsp;<span class="ident" id="6905264">n</span><span class="op" id="6905265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905269">db</span><span class="op" id="6905271">.</span><span class="ident" id="6905272">dumpDeps</span><span class="op" id="6905280">(</span><span class="ident" id="6905281">t</span><span class="op" id="6905282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905289">db</span><span class="op" id="6905291">.</span><span class="ident" id="6905292">SetMaxOpenConns</span><span class="op" id="6905307">(</span><span class="num" id="6905308">5</span><span class="op" id="6905309">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905313">if</span>&nbsp;<span class="ident" id="6905316">g</span><span class="op" id="6905317">,</span>&nbsp;<span class="ident" id="6905319">w</span>&nbsp;<span class="op" id="6905321">:=</span>&nbsp;<span class="ident" id="6905324">db</span><span class="op" id="6905326">.</span><span class="ident" id="6905327">numFreeConns</span><span class="op" id="6905339">(</span><span class="op" id="6905340">)</span><span class="op" id="6905341">,</span>&nbsp;<span class="num" id="6905343">5</span><span class="op" id="6905344">;</span>&nbsp;<span class="ident" id="6905346">g</span>&nbsp;<span class="op" id="6905348">!=</span>&nbsp;<span class="ident" id="6905351">w</span>&nbsp;<span class="op" id="6905353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905357">t</span><span class="op" id="6905358">.</span><span class="ident" id="6905359">Errorf</span><span class="op" id="6905365">(</span><span class="string" id="6905366">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6905392">,</span>&nbsp;<span class="ident" id="6905394">g</span><span class="op" id="6905395">,</span>&nbsp;<span class="ident" id="6905397">w</span><span class="op" id="6905398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905405">if</span>&nbsp;<span class="ident" id="6905408">n</span>&nbsp;<span class="op" id="6905410">:=</span>&nbsp;<span class="ident" id="6905413">db</span><span class="op" id="6905415">.</span><span class="ident" id="6905416">numDepsPollUntil</span><span class="op" id="6905432">(</span><span class="num" id="6905433">5</span><span class="op" id="6905434">,</span>&nbsp;<span class="ident" id="6905436">time</span><span class="op" id="6905440">.</span><span class="ident" id="6905441">Second</span><span class="op" id="6905447">)</span><span class="op" id="6905448">;</span>&nbsp;<span class="ident" id="6905450">n</span>&nbsp;<span class="op" id="6905452">&gt;</span>&nbsp;<span class="num" id="6905454">5</span>&nbsp;<span class="op" id="6905456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905460">t</span><span class="op" id="6905461">.</span><span class="ident" id="6905462">Errorf</span><span class="op" id="6905468">(</span><span class="string" id="6905469">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6905510">,</span>&nbsp;<span class="ident" id="6905512">n</span><span class="op" id="6905513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905517">db</span><span class="op" id="6905519">.</span><span class="ident" id="6905520">dumpDeps</span><span class="op" id="6905528">(</span><span class="ident" id="6905529">t</span><span class="op" id="6905530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905537">db</span><span class="op" id="6905539">.</span><span class="ident" id="6905540">SetMaxOpenConns</span><span class="op" id="6905555">(</span><span class="num" id="6905556">0</span><span class="op" id="6905557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905561">if</span>&nbsp;<span class="ident" id="6905564">g</span><span class="op" id="6905565">,</span>&nbsp;<span class="ident" id="6905567">w</span>&nbsp;<span class="op" id="6905569">:=</span>&nbsp;<span class="ident" id="6905572">db</span><span class="op" id="6905574">.</span><span class="ident" id="6905575">numFreeConns</span><span class="op" id="6905587">(</span><span class="op" id="6905588">)</span><span class="op" id="6905589">,</span>&nbsp;<span class="num" id="6905591">5</span><span class="op" id="6905592">;</span>&nbsp;<span class="ident" id="6905594">g</span>&nbsp;<span class="op" id="6905596">!=</span>&nbsp;<span class="ident" id="6905599">w</span>&nbsp;<span class="op" id="6905601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905605">t</span><span class="op" id="6905606">.</span><span class="ident" id="6905607">Errorf</span><span class="op" id="6905613">(</span><span class="string" id="6905614">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6905640">,</span>&nbsp;<span class="ident" id="6905642">g</span><span class="op" id="6905643">,</span>&nbsp;<span class="ident" id="6905645">w</span><span class="op" id="6905646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905649">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905653">if</span>&nbsp;<span class="ident" id="6905656">n</span>&nbsp;<span class="op" id="6905658">:=</span>&nbsp;<span class="ident" id="6905661">db</span><span class="op" id="6905663">.</span><span class="ident" id="6905664">numDepsPollUntil</span><span class="op" id="6905680">(</span><span class="num" id="6905681">5</span><span class="op" id="6905682">,</span>&nbsp;<span class="ident" id="6905684">time</span><span class="op" id="6905688">.</span><span class="ident" id="6905689">Second</span><span class="op" id="6905695">)</span><span class="op" id="6905696">;</span>&nbsp;<span class="ident" id="6905698">n</span>&nbsp;<span class="op" id="6905700">&gt;</span>&nbsp;<span class="num" id="6905702">5</span>&nbsp;<span class="op" id="6905704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905708">t</span><span class="op" id="6905709">.</span><span class="ident" id="6905710">Errorf</span><span class="op" id="6905716">(</span><span class="string" id="6905717">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6905758">,</span>&nbsp;<span class="ident" id="6905760">n</span><span class="op" id="6905761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905765">db</span><span class="op" id="6905767">.</span><span class="ident" id="6905768">dumpDeps</span><span class="op" id="6905776">(</span><span class="ident" id="6905777">t</span><span class="op" id="6905778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905781">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905785">db</span><span class="op" id="6905787">.</span><span class="ident" id="6905788">SetMaxIdleConns</span><span class="op" id="6905803">(</span><span class="num" id="6905804">0</span><span class="op" id="6905805">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905809">if</span>&nbsp;<span class="ident" id="6905812">g</span><span class="op" id="6905813">,</span>&nbsp;<span class="ident" id="6905815">w</span>&nbsp;<span class="op" id="6905817">:=</span>&nbsp;<span class="ident" id="6905820">db</span><span class="op" id="6905822">.</span><span class="ident" id="6905823">numFreeConns</span><span class="op" id="6905835">(</span><span class="op" id="6905836">)</span><span class="op" id="6905837">,</span>&nbsp;<span class="num" id="6905839">0</span><span class="op" id="6905840">;</span>&nbsp;<span class="ident" id="6905842">g</span>&nbsp;<span class="op" id="6905844">!=</span>&nbsp;<span class="ident" id="6905847">w</span>&nbsp;<span class="op" id="6905849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905853">t</span><span class="op" id="6905854">.</span><span class="ident" id="6905855">Errorf</span><span class="op" id="6905861">(</span><span class="string" id="6905862">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6905888">,</span>&nbsp;<span class="ident" id="6905890">g</span><span class="op" id="6905891">,</span>&nbsp;<span class="ident" id="6905893">w</span><span class="op" id="6905894">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6905897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6905901">if</span>&nbsp;<span class="ident" id="6905904">n</span>&nbsp;<span class="op" id="6905906">:=</span>&nbsp;<span class="ident" id="6905909">db</span><span class="op" id="6905911">.</span><span class="ident" id="6905912">numDepsPollUntil</span><span class="op" id="6905928">(</span><span class="num" id="6905929">0</span><span class="op" id="6905930">,</span>&nbsp;<span class="ident" id="6905932">time</span><span class="op" id="6905936">.</span><span class="ident" id="6905937">Second</span><span class="op" id="6905943">)</span><span class="op" id="6905944">;</span>&nbsp;<span class="ident" id="6905946">n</span>&nbsp;<span class="op" id="6905948">&gt;</span>&nbsp;<span class="num" id="6905950">0</span>&nbsp;<span class="op" id="6905952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6905956">t</span><span class="op" id="6905957">.</span><span class="ident" id="6905958">Errorf</span><span class="op" id="6905964">(</span><span class="string" id="6905965">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6906006">,</span>&nbsp;<span class="ident" id="6906008">n</span><span class="op" id="6906009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906013">db</span><span class="op" id="6906015">.</span><span class="ident" id="6906016">dumpDeps</span><span class="op" id="6906024">(</span><span class="ident" id="6906025">t</span><span class="op" id="6906026">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906029">}</span><br>
<span class="lineno"></span><span class="op" id="6906031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6906034">func</span>&nbsp;<span class="ident" id="6906039">TestSingleOpenConn</span><span class="op" id="6906057">(</span><span class="ident" id="6906058">t</span>&nbsp;<span class="op" id="6906060">*</span><span class="ident" id="6906061">testing</span><span class="op" id="6906068">.</span><span class="ident" id="6906069">T</span><span class="op" id="6906070">)</span>&nbsp;<span class="op" id="6906072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906075">db</span>&nbsp;<span class="op" id="6906078">:=</span>&nbsp;<span class="ident" id="6906081">newTestDB</span><span class="op" id="6906090">(</span><span class="ident" id="6906091">t</span><span class="op" id="6906092">,</span>&nbsp;<span class="string" id="6906094">&#34;people&#34;</span><span class="op" id="6906102">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906105">defer</span>&nbsp;<span class="ident" id="6906111">closeDB</span><span class="op" id="6906118">(</span><span class="ident" id="6906119">t</span><span class="op" id="6906120">,</span>&nbsp;<span class="ident" id="6906122">db</span><span class="op" id="6906124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906128">db</span><span class="op" id="6906130">.</span><span class="ident" id="6906131">SetMaxOpenConns</span><span class="op" id="6906146">(</span><span class="num" id="6906147">1</span><span class="op" id="6906148">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906152">rows</span><span class="op" id="6906156">,</span>&nbsp;<span class="ident" id="6906158">err</span>&nbsp;<span class="op" id="6906162">:=</span>&nbsp;<span class="ident" id="6906165">db</span><span class="op" id="6906167">.</span><span class="ident" id="6906168">Query</span><span class="op" id="6906173">(</span><span class="string" id="6906174">&#34;SELECT|people|name|&#34;</span><span class="op" id="6906195">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906198">if</span>&nbsp;<span class="ident" id="6906201">err</span>&nbsp;<span class="op" id="6906205">!=</span>&nbsp;<span class="ident" id="6906208">nil</span>&nbsp;<span class="op" id="6906212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906216">t</span><span class="op" id="6906217">.</span><span class="ident" id="6906218">Fatal</span><span class="op" id="6906223">(</span><span class="ident" id="6906224">err</span><span class="op" id="6906227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906233">if</span>&nbsp;<span class="ident" id="6906236">err</span>&nbsp;<span class="op" id="6906240">=</span>&nbsp;<span class="ident" id="6906242">rows</span><span class="op" id="6906246">.</span><span class="ident" id="6906247">Close</span><span class="op" id="6906252">(</span><span class="op" id="6906253">)</span><span class="op" id="6906254">;</span>&nbsp;<span class="ident" id="6906256">err</span>&nbsp;<span class="op" id="6906260">!=</span>&nbsp;<span class="ident" id="6906263">nil</span>&nbsp;<span class="op" id="6906267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906271">t</span><span class="op" id="6906272">.</span><span class="ident" id="6906273">Fatal</span><span class="op" id="6906278">(</span><span class="ident" id="6906279">err</span><span class="op" id="6906282">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6906288">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906311">rows</span><span class="op" id="6906315">,</span>&nbsp;<span class="ident" id="6906317">err</span>&nbsp;<span class="op" id="6906321">=</span>&nbsp;<span class="ident" id="6906323">db</span><span class="op" id="6906325">.</span><span class="ident" id="6906326">Query</span><span class="op" id="6906331">(</span><span class="string" id="6906332">&#34;SELECT|people|name|&#34;</span><span class="op" id="6906353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906356">if</span>&nbsp;<span class="ident" id="6906359">err</span>&nbsp;<span class="op" id="6906363">!=</span>&nbsp;<span class="ident" id="6906366">nil</span>&nbsp;<span class="op" id="6906370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906374">t</span><span class="op" id="6906375">.</span><span class="ident" id="6906376">Fatal</span><span class="op" id="6906381">(</span><span class="ident" id="6906382">err</span><span class="op" id="6906385">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906391">if</span>&nbsp;<span class="ident" id="6906394">err</span>&nbsp;<span class="op" id="6906398">=</span>&nbsp;<span class="ident" id="6906400">rows</span><span class="op" id="6906404">.</span><span class="ident" id="6906405">Close</span><span class="op" id="6906410">(</span><span class="op" id="6906411">)</span><span class="op" id="6906412">;</span>&nbsp;<span class="ident" id="6906414">err</span>&nbsp;<span class="op" id="6906418">!=</span>&nbsp;<span class="ident" id="6906421">nil</span>&nbsp;<span class="op" id="6906425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906429">t</span><span class="op" id="6906430">.</span><span class="ident" id="6906431">Fatal</span><span class="op" id="6906436">(</span><span class="ident" id="6906437">err</span><span class="op" id="6906440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906443">}</span><br>
<span class="lineno"></span><span class="op" id="6906445">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="6906448">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="6906473">func</span>&nbsp;<span class="ident" id="6906478">TestStmtCloseDeps</span><span class="op" id="6906495">(</span><span class="ident" id="6906496">t</span>&nbsp;<span class="op" id="6906498">*</span><span class="ident" id="6906499">testing</span><span class="op" id="6906506">.</span><span class="ident" id="6906507">T</span><span class="op" id="6906508">)</span>&nbsp;<span class="op" id="6906510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906513">if</span>&nbsp;<span class="ident" id="6906516">testing</span><span class="op" id="6906523">.</span><span class="ident" id="6906524">Short</span><span class="op" id="6906529">(</span><span class="op" id="6906530">)</span>&nbsp;<span class="op" id="6906532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906536">t</span><span class="op" id="6906537">.</span><span class="ident" id="6906538">Skip</span><span class="op" id="6906542">(</span><span class="string" id="6906543">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6906567">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906573">defer</span>&nbsp;<span class="ident" id="6906579">setHookpostCloseConn</span><span class="op" id="6906599">(</span><span class="ident" id="6906600">nil</span><span class="op" id="6906603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906606">setHookpostCloseConn</span><span class="op" id="6906626">(</span><span class="keyword" id="6906627">func</span><span class="op" id="6906631">(</span><span class="ident" id="6906632">_</span>&nbsp;<span class="op" id="6906634">*</span><span class="ident" id="6906635">fakeConn</span><span class="op" id="6906643">,</span>&nbsp;<span class="ident" id="6906645">err</span>&nbsp;<span class="builtintype" id="6906649">error</span><span class="op" id="6906654">)</span>&nbsp;<span class="op" id="6906656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906660">if</span>&nbsp;<span class="ident" id="6906663">err</span>&nbsp;<span class="op" id="6906667">!=</span>&nbsp;<span class="ident" id="6906670">nil</span>&nbsp;<span class="op" id="6906674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906679">t</span><span class="op" id="6906680">.</span><span class="ident" id="6906681">Errorf</span><span class="op" id="6906687">(</span><span class="string" id="6906688">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6906716">,</span>&nbsp;<span class="ident" id="6906718">err</span><span class="op" id="6906721">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6906728">}</span><span class="op" id="6906729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906733">db</span>&nbsp;<span class="op" id="6906736">:=</span>&nbsp;<span class="ident" id="6906739">newTestDB</span><span class="op" id="6906748">(</span><span class="ident" id="6906749">t</span><span class="op" id="6906750">,</span>&nbsp;<span class="string" id="6906752">&#34;magicquery&#34;</span><span class="op" id="6906764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6906767">defer</span>&nbsp;<span class="ident" id="6906773">closeDB</span><span class="op" id="6906780">(</span><span class="ident" id="6906781">t</span><span class="op" id="6906782">,</span>&nbsp;<span class="ident" id="6906784">db</span><span class="op" id="6906786">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906790">driver</span>&nbsp;<span class="op" id="6906797">:=</span>&nbsp;<span class="ident" id="6906800">db</span><span class="op" id="6906802">.</span><span class="ident" id="6906803">driver</span><span class="op" id="6906809">.</span><span class="op" id="6906810">(</span><span class="op" id="6906811">*</span><span class="ident" id="6906812">fakeDriver</span><span class="op" id="6906822">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906826">driver</span><span class="op" id="6906832">.</span><span class="ident" id="6906833">mu</span><span class="op" id="6906835">.</span><span class="ident" id="6906836">Lock</span><span class="op" id="6906840">(</span><span class="op" id="6906841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906844">opens0</span>&nbsp;<span class="op" id="6906851">:=</span>&nbsp;<span class="ident" id="6906854">driver</span><span class="op" id="6906860">.</span><span class="ident" id="6906861">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906872">closes0</span>&nbsp;<span class="op" id="6906880">:=</span>&nbsp;<span class="ident" id="6906883">driver</span><span class="op" id="6906889">.</span><span class="ident" id="6906890">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906902">driver</span><span class="op" id="6906908">.</span><span class="ident" id="6906909">mu</span><span class="op" id="6906911">.</span><span class="ident" id="6906912">Unlock</span><span class="op" id="6906918">(</span><span class="op" id="6906919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906922">openDelta0</span>&nbsp;<span class="op" id="6906933">:=</span>&nbsp;<span class="ident" id="6906936">opens0</span>&nbsp;<span class="op" id="6906943">-</span>&nbsp;<span class="ident" id="6906945">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6906955">stmt</span><span class="op" id="6906959">,</span>&nbsp;<span class="ident" id="6906961">err</span>&nbsp;<span class="op" id="6906965">:=</span>&nbsp;<span class="ident" id="6906968">db</span><span class="op" id="6906970">.</span><span class="ident" id="6906971">Prepare</span><span class="op" id="6906978">(</span><span class="string" id="6906979">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="6907015">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907018">if</span>&nbsp;<span class="ident" id="6907021">err</span>&nbsp;<span class="op" id="6907025">!=</span>&nbsp;<span class="ident" id="6907028">nil</span>&nbsp;<span class="op" id="6907032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907036">t</span><span class="op" id="6907037">.</span><span class="ident" id="6907038">Fatal</span><span class="op" id="6907043">(</span><span class="ident" id="6907044">err</span><span class="op" id="6907047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907054">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907090">const</span>&nbsp;<span class="op" id="6907096">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907100">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6907112">=</span>&nbsp;<span class="num" id="6907114">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907119">sleepMillis</span>&nbsp;<span class="op" id="6907131">=</span>&nbsp;<span class="num" id="6907133">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907138">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6907150">=</span>&nbsp;<span class="num" id="6907152">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907155">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907158">var</span>&nbsp;<span class="ident" id="6907162">wg</span>&nbsp;<span class="ident" id="6907165">sync</span><span class="op" id="6907169">.</span><span class="ident" id="6907170">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907181">for</span>&nbsp;<span class="ident" id="6907185">batch</span>&nbsp;<span class="op" id="6907191">:=</span>&nbsp;<span class="num" id="6907194">0</span><span class="op" id="6907195">;</span>&nbsp;<span class="ident" id="6907197">batch</span>&nbsp;<span class="op" id="6907203">&lt;</span>&nbsp;<span class="ident" id="6907205">nbatch</span><span class="op" id="6907211">;</span>&nbsp;<span class="ident" id="6907213">batch</span><span class="op" id="6907218">++</span>&nbsp;<span class="op" id="6907221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907225">for</span>&nbsp;<span class="ident" id="6907229">i</span>&nbsp;<span class="op" id="6907231">:=</span>&nbsp;<span class="num" id="6907234">0</span><span class="op" id="6907235">;</span>&nbsp;<span class="ident" id="6907237">i</span>&nbsp;<span class="op" id="6907239">&lt;</span>&nbsp;<span class="ident" id="6907241">nquery</span><span class="op" id="6907247">;</span>&nbsp;<span class="ident" id="6907249">i</span><span class="op" id="6907250">++</span>&nbsp;<span class="op" id="6907253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907258">wg</span><span class="op" id="6907260">.</span><span class="ident" id="6907261">Add</span><span class="op" id="6907264">(</span><span class="num" id="6907265">1</span><span class="op" id="6907266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907271">go</span>&nbsp;<span class="keyword" id="6907274">func</span><span class="op" id="6907278">(</span><span class="op" id="6907279">)</span>&nbsp;<span class="op" id="6907281">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907287">defer</span>&nbsp;<span class="ident" id="6907293">wg</span><span class="op" id="6907295">.</span><span class="ident" id="6907296">Done</span><span class="op" id="6907300">(</span><span class="op" id="6907301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907307">var</span>&nbsp;<span class="ident" id="6907311">op</span>&nbsp;<span class="builtintype" id="6907314">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907325">if</span>&nbsp;<span class="ident" id="6907328">err</span>&nbsp;<span class="op" id="6907332">:=</span>&nbsp;<span class="ident" id="6907335">stmt</span><span class="op" id="6907339">.</span><span class="ident" id="6907340">QueryRow</span><span class="op" id="6907348">(</span><span class="string" id="6907349">&#34;sleep&#34;</span><span class="op" id="6907356">,</span>&nbsp;<span class="ident" id="6907358">sleepMillis</span><span class="op" id="6907369">)</span><span class="op" id="6907370">.</span><span class="ident" id="6907371">Scan</span><span class="op" id="6907375">(</span><span class="op" id="6907376">&amp;</span><span class="ident" id="6907377">op</span><span class="op" id="6907379">)</span><span class="op" id="6907380">;</span>&nbsp;<span class="ident" id="6907382">err</span>&nbsp;<span class="op" id="6907386">!=</span>&nbsp;<span class="ident" id="6907389">nil</span>&nbsp;<span class="op" id="6907393">&amp;&amp;</span>&nbsp;<span class="ident" id="6907396">err</span>&nbsp;<span class="op" id="6907400">!=</span>&nbsp;<span class="ident" id="6907403">ErrNoRows</span>&nbsp;<span class="op" id="6907413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907420">t</span><span class="op" id="6907421">.</span><span class="ident" id="6907422">Error</span><span class="op" id="6907427">(</span><span class="ident" id="6907428">err</span><span class="op" id="6907431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907437">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907442">}</span><span class="op" id="6907443">(</span><span class="op" id="6907444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907452">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907509">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6907566">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907587">time</span><span class="op" id="6907591">.</span><span class="ident" id="6907592">Sleep</span><span class="op" id="6907597">(</span><span class="num" id="6907598">2</span>&nbsp;<span class="op" id="6907600">*</span>&nbsp;<span class="ident" id="6907602">sleepMillis</span>&nbsp;<span class="op" id="6907614">*</span>&nbsp;<span class="ident" id="6907616">time</span><span class="op" id="6907620">.</span><span class="ident" id="6907621">Millisecond</span><span class="op" id="6907632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907638">wg</span><span class="op" id="6907640">.</span><span class="ident" id="6907641">Wait</span><span class="op" id="6907645">(</span><span class="op" id="6907646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907650">if</span>&nbsp;<span class="ident" id="6907653">g</span><span class="op" id="6907654">,</span>&nbsp;<span class="ident" id="6907656">w</span>&nbsp;<span class="op" id="6907658">:=</span>&nbsp;<span class="ident" id="6907661">db</span><span class="op" id="6907663">.</span><span class="ident" id="6907664">numFreeConns</span><span class="op" id="6907676">(</span><span class="op" id="6907677">)</span><span class="op" id="6907678">,</span>&nbsp;<span class="num" id="6907680">2</span><span class="op" id="6907681">;</span>&nbsp;<span class="ident" id="6907683">g</span>&nbsp;<span class="op" id="6907685">!=</span>&nbsp;<span class="ident" id="6907688">w</span>&nbsp;<span class="op" id="6907690">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907694">t</span><span class="op" id="6907695">.</span><span class="ident" id="6907696">Errorf</span><span class="op" id="6907702">(</span><span class="string" id="6907703">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6907729">,</span>&nbsp;<span class="ident" id="6907731">g</span><span class="op" id="6907732">,</span>&nbsp;<span class="ident" id="6907734">w</span><span class="op" id="6907735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6907742">if</span>&nbsp;<span class="ident" id="6907745">n</span>&nbsp;<span class="op" id="6907747">:=</span>&nbsp;<span class="ident" id="6907750">db</span><span class="op" id="6907752">.</span><span class="ident" id="6907753">numDepsPollUntil</span><span class="op" id="6907769">(</span><span class="num" id="6907770">4</span><span class="op" id="6907771">,</span>&nbsp;<span class="ident" id="6907773">time</span><span class="op" id="6907777">.</span><span class="ident" id="6907778">Second</span><span class="op" id="6907784">)</span><span class="op" id="6907785">;</span>&nbsp;<span class="ident" id="6907787">n</span>&nbsp;<span class="op" id="6907789">&gt;</span>&nbsp;<span class="num" id="6907791">4</span>&nbsp;<span class="op" id="6907793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907797">t</span><span class="op" id="6907798">.</span><span class="ident" id="6907799">Errorf</span><span class="op" id="6907805">(</span><span class="string" id="6907806">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="6907850">,</span>&nbsp;<span class="ident" id="6907852">n</span><span class="op" id="6907853">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907857">db</span><span class="op" id="6907859">.</span><span class="ident" id="6907860">dumpDeps</span><span class="op" id="6907868">(</span><span class="ident" id="6907869">t</span><span class="op" id="6907870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6907873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907877">driver</span><span class="op" id="6907883">.</span><span class="ident" id="6907884">mu</span><span class="op" id="6907886">.</span><span class="ident" id="6907887">Lock</span><span class="op" id="6907891">(</span><span class="op" id="6907892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907895">opens</span>&nbsp;<span class="op" id="6907901">:=</span>&nbsp;<span class="ident" id="6907904">driver</span><span class="op" id="6907910">.</span><span class="ident" id="6907911">openCount</span>&nbsp;<span class="op" id="6907921">-</span>&nbsp;<span class="ident" id="6907923">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907931">closes</span>&nbsp;<span class="op" id="6907938">:=</span>&nbsp;<span class="ident" id="6907941">driver</span><span class="op" id="6907947">.</span><span class="ident" id="6907948">closeCount</span>&nbsp;<span class="op" id="6907959">-</span>&nbsp;<span class="ident" id="6907961">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6907970">openDelta</span>&nbsp;<span class="op" id="6907980">:=</span>&nbsp;<span class="op" id="6907983">(</span><span class="ident" id="6907984">driver</span><span class="op" id="6907990">.</span><span class="ident" id="6907991">openCount</span>&nbsp;<span class="op" id="6908001">-</span>&nbsp;<span class="ident" id="6908003">driver</span><span class="op" id="6908009">.</span><span class="ident" id="6908010">closeCount</span><span class="op" id="6908020">)</span>&nbsp;<span class="op" id="6908022">-</span>&nbsp;<span class="ident" id="6908024">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908036">driver</span><span class="op" id="6908042">.</span><span class="ident" id="6908043">mu</span><span class="op" id="6908045">.</span><span class="ident" id="6908046">Unlock</span><span class="op" id="6908052">(</span><span class="op" id="6908053">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908057">if</span>&nbsp;<span class="ident" id="6908060">openDelta</span>&nbsp;<span class="op" id="6908070">&gt;</span>&nbsp;<span class="num" id="6908072">2</span>&nbsp;<span class="op" id="6908074">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908078">t</span><span class="op" id="6908079">.</span><span class="ident" id="6908080">Logf</span><span class="op" id="6908084">(</span><span class="string" id="6908085">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6908102">,</span>&nbsp;<span class="ident" id="6908104">opens</span><span class="op" id="6908109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908113">t</span><span class="op" id="6908114">.</span><span class="ident" id="6908115">Logf</span><span class="op" id="6908119">(</span><span class="string" id="6908120">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6908138">,</span>&nbsp;<span class="ident" id="6908140">closes</span><span class="op" id="6908146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908150">t</span><span class="op" id="6908151">.</span><span class="ident" id="6908152">Logf</span><span class="op" id="6908156">(</span><span class="string" id="6908157">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="6908174">,</span>&nbsp;<span class="ident" id="6908176">openDelta</span><span class="op" id="6908185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908189">t</span><span class="op" id="6908190">.</span><span class="ident" id="6908191">Errorf</span><span class="op" id="6908197">(</span><span class="string" id="6908198">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6908237">,</span>&nbsp;<span class="ident" id="6908239">openDelta</span><span class="op" id="6908248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908252">db</span><span class="op" id="6908254">.</span><span class="ident" id="6908255">dumpDeps</span><span class="op" id="6908263">(</span><span class="ident" id="6908264">t</span><span class="op" id="6908265">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908272">if</span>&nbsp;<span class="builtinfunc" id="6908275">len</span><span class="op" id="6908278">(</span><span class="ident" id="6908279">stmt</span><span class="op" id="6908283">.</span><span class="ident" id="6908284">css</span><span class="op" id="6908287">)</span>&nbsp;<span class="op" id="6908289">&gt;</span>&nbsp;<span class="ident" id="6908291">nquery</span>&nbsp;<span class="op" id="6908298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908302">t</span><span class="op" id="6908303">.</span><span class="ident" id="6908304">Errorf</span><span class="op" id="6908310">(</span><span class="string" id="6908311">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="6908343">,</span>&nbsp;<span class="builtinfunc" id="6908345">len</span><span class="op" id="6908348">(</span><span class="ident" id="6908349">stmt</span><span class="op" id="6908353">.</span><span class="ident" id="6908354">css</span><span class="op" id="6908357">)</span><span class="op" id="6908358">,</span>&nbsp;<span class="ident" id="6908360">nquery</span><span class="op" id="6908366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908369">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908373">if</span>&nbsp;<span class="ident" id="6908376">err</span>&nbsp;<span class="op" id="6908380">:=</span>&nbsp;<span class="ident" id="6908383">stmt</span><span class="op" id="6908387">.</span><span class="ident" id="6908388">Close</span><span class="op" id="6908393">(</span><span class="op" id="6908394">)</span><span class="op" id="6908395">;</span>&nbsp;<span class="ident" id="6908397">err</span>&nbsp;<span class="op" id="6908401">!=</span>&nbsp;<span class="ident" id="6908404">nil</span>&nbsp;<span class="op" id="6908408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908412">t</span><span class="op" id="6908413">.</span><span class="ident" id="6908414">Fatal</span><span class="op" id="6908419">(</span><span class="ident" id="6908420">err</span><span class="op" id="6908423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908430">if</span>&nbsp;<span class="ident" id="6908433">g</span><span class="op" id="6908434">,</span>&nbsp;<span class="ident" id="6908436">w</span>&nbsp;<span class="op" id="6908438">:=</span>&nbsp;<span class="ident" id="6908441">db</span><span class="op" id="6908443">.</span><span class="ident" id="6908444">numFreeConns</span><span class="op" id="6908456">(</span><span class="op" id="6908457">)</span><span class="op" id="6908458">,</span>&nbsp;<span class="num" id="6908460">2</span><span class="op" id="6908461">;</span>&nbsp;<span class="ident" id="6908463">g</span>&nbsp;<span class="op" id="6908465">!=</span>&nbsp;<span class="ident" id="6908468">w</span>&nbsp;<span class="op" id="6908470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908474">t</span><span class="op" id="6908475">.</span><span class="ident" id="6908476">Errorf</span><span class="op" id="6908482">(</span><span class="string" id="6908483">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6908509">,</span>&nbsp;<span class="ident" id="6908511">g</span><span class="op" id="6908512">,</span>&nbsp;<span class="ident" id="6908514">w</span><span class="op" id="6908515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908522">if</span>&nbsp;<span class="ident" id="6908525">n</span>&nbsp;<span class="op" id="6908527">:=</span>&nbsp;<span class="ident" id="6908530">db</span><span class="op" id="6908532">.</span><span class="ident" id="6908533">numDepsPollUntil</span><span class="op" id="6908549">(</span><span class="num" id="6908550">2</span><span class="op" id="6908551">,</span>&nbsp;<span class="ident" id="6908553">time</span><span class="op" id="6908557">.</span><span class="ident" id="6908558">Second</span><span class="op" id="6908564">)</span><span class="op" id="6908565">;</span>&nbsp;<span class="ident" id="6908567">n</span>&nbsp;<span class="op" id="6908569">&gt;</span>&nbsp;<span class="num" id="6908571">2</span>&nbsp;<span class="op" id="6908573">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908577">t</span><span class="op" id="6908578">.</span><span class="ident" id="6908579">Errorf</span><span class="op" id="6908585">(</span><span class="string" id="6908586">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="6908630">,</span>&nbsp;<span class="ident" id="6908632">n</span><span class="op" id="6908633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908637">db</span><span class="op" id="6908639">.</span><span class="ident" id="6908640">dumpDeps</span><span class="op" id="6908648">(</span><span class="ident" id="6908649">t</span><span class="op" id="6908650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908657">db</span><span class="op" id="6908659">.</span><span class="ident" id="6908660">SetMaxIdleConns</span><span class="op" id="6908675">(</span><span class="num" id="6908676">0</span><span class="op" id="6908677">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908681">if</span>&nbsp;<span class="ident" id="6908684">g</span><span class="op" id="6908685">,</span>&nbsp;<span class="ident" id="6908687">w</span>&nbsp;<span class="op" id="6908689">:=</span>&nbsp;<span class="ident" id="6908692">db</span><span class="op" id="6908694">.</span><span class="ident" id="6908695">numFreeConns</span><span class="op" id="6908707">(</span><span class="op" id="6908708">)</span><span class="op" id="6908709">,</span>&nbsp;<span class="num" id="6908711">0</span><span class="op" id="6908712">;</span>&nbsp;<span class="ident" id="6908714">g</span>&nbsp;<span class="op" id="6908716">!=</span>&nbsp;<span class="ident" id="6908719">w</span>&nbsp;<span class="op" id="6908721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908725">t</span><span class="op" id="6908726">.</span><span class="ident" id="6908727">Errorf</span><span class="op" id="6908733">(</span><span class="string" id="6908734">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6908760">,</span>&nbsp;<span class="ident" id="6908762">g</span><span class="op" id="6908763">,</span>&nbsp;<span class="ident" id="6908765">w</span><span class="op" id="6908766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6908773">if</span>&nbsp;<span class="ident" id="6908776">n</span>&nbsp;<span class="op" id="6908778">:=</span>&nbsp;<span class="ident" id="6908781">db</span><span class="op" id="6908783">.</span><span class="ident" id="6908784">numDepsPollUntil</span><span class="op" id="6908800">(</span><span class="num" id="6908801">0</span><span class="op" id="6908802">,</span>&nbsp;<span class="ident" id="6908804">time</span><span class="op" id="6908808">.</span><span class="ident" id="6908809">Second</span><span class="op" id="6908815">)</span><span class="op" id="6908816">;</span>&nbsp;<span class="ident" id="6908818">n</span>&nbsp;<span class="op" id="6908820">&gt;</span>&nbsp;<span class="num" id="6908822">0</span>&nbsp;<span class="op" id="6908824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908828">t</span><span class="op" id="6908829">.</span><span class="ident" id="6908830">Errorf</span><span class="op" id="6908836">(</span><span class="string" id="6908837">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="6908878">,</span>&nbsp;<span class="ident" id="6908880">n</span><span class="op" id="6908881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908885">db</span><span class="op" id="6908887">.</span><span class="ident" id="6908888">dumpDeps</span><span class="op" id="6908896">(</span><span class="ident" id="6908897">t</span><span class="op" id="6908898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6908901">}</span><br>
<span class="lineno"></span><span class="op" id="6908903">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="6908906">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="6908931">func</span>&nbsp;<span class="ident" id="6908936">TestCloseConnBeforeStmts</span><span class="op" id="6908960">(</span><span class="ident" id="6908961">t</span>&nbsp;<span class="op" id="6908963">*</span><span class="ident" id="6908964">testing</span><span class="op" id="6908971">.</span><span class="ident" id="6908972">T</span><span class="op" id="6908973">)</span>&nbsp;<span class="op" id="6908975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6908978">db</span>&nbsp;<span class="op" id="6908981">:=</span>&nbsp;<span class="ident" id="6908984">newTestDB</span><span class="op" id="6908993">(</span><span class="ident" id="6908994">t</span><span class="op" id="6908995">,</span>&nbsp;<span class="string" id="6908997">&#34;people&#34;</span><span class="op" id="6909005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909008">defer</span>&nbsp;<span class="ident" id="6909014">closeDB</span><span class="op" id="6909021">(</span><span class="ident" id="6909022">t</span><span class="op" id="6909023">,</span>&nbsp;<span class="ident" id="6909025">db</span><span class="op" id="6909027">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909031">defer</span>&nbsp;<span class="ident" id="6909037">setHookpostCloseConn</span><span class="op" id="6909057">(</span><span class="ident" id="6909058">nil</span><span class="op" id="6909061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909064">setHookpostCloseConn</span><span class="op" id="6909084">(</span><span class="keyword" id="6909085">func</span><span class="op" id="6909089">(</span><span class="ident" id="6909090">_</span>&nbsp;<span class="op" id="6909092">*</span><span class="ident" id="6909093">fakeConn</span><span class="op" id="6909101">,</span>&nbsp;<span class="ident" id="6909103">err</span>&nbsp;<span class="builtintype" id="6909107">error</span><span class="op" id="6909112">)</span>&nbsp;<span class="op" id="6909114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909118">if</span>&nbsp;<span class="ident" id="6909121">err</span>&nbsp;<span class="op" id="6909125">!=</span>&nbsp;<span class="ident" id="6909128">nil</span>&nbsp;<span class="op" id="6909132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909137">t</span><span class="op" id="6909138">.</span><span class="ident" id="6909139">Errorf</span><span class="op" id="6909145">(</span><span class="string" id="6909146">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="6909183">,</span>&nbsp;<span class="ident" id="6909185">err</span><span class="op" id="6909188">,</span>&nbsp;<span class="ident" id="6909190">stack</span><span class="op" id="6909195">(</span><span class="op" id="6909196">)</span><span class="op" id="6909197">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909202">db</span><span class="op" id="6909204">.</span><span class="ident" id="6909205">dumpDeps</span><span class="op" id="6909213">(</span><span class="ident" id="6909214">t</span><span class="op" id="6909215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909220">t</span><span class="op" id="6909221">.</span><span class="ident" id="6909222">Errorf</span><span class="op" id="6909228">(</span><span class="string" id="6909229">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="6909239">,</span>&nbsp;<span class="ident" id="6909241">db</span><span class="op" id="6909243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909250">}</span><span class="op" id="6909251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909255">stmt</span><span class="op" id="6909259">,</span>&nbsp;<span class="ident" id="6909261">err</span>&nbsp;<span class="op" id="6909265">:=</span>&nbsp;<span class="ident" id="6909268">db</span><span class="op" id="6909270">.</span><span class="ident" id="6909271">Prepare</span><span class="op" id="6909278">(</span><span class="string" id="6909279">&#34;SELECT|people|name|&#34;</span><span class="op" id="6909300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909303">if</span>&nbsp;<span class="ident" id="6909306">err</span>&nbsp;<span class="op" id="6909310">!=</span>&nbsp;<span class="ident" id="6909313">nil</span>&nbsp;<span class="op" id="6909317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909321">t</span><span class="op" id="6909322">.</span><span class="ident" id="6909323">Fatal</span><span class="op" id="6909328">(</span><span class="ident" id="6909329">err</span><span class="op" id="6909332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909339">if</span>&nbsp;<span class="builtinfunc" id="6909342">len</span><span class="op" id="6909345">(</span><span class="ident" id="6909346">db</span><span class="op" id="6909348">.</span><span class="ident" id="6909349">freeConn</span><span class="op" id="6909357">)</span>&nbsp;<span class="op" id="6909359">!=</span>&nbsp;<span class="num" id="6909362">1</span>&nbsp;<span class="op" id="6909364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909368">t</span><span class="op" id="6909369">.</span><span class="ident" id="6909370">Fatalf</span><span class="op" id="6909376">(</span><span class="string" id="6909377">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6909406">,</span>&nbsp;<span class="builtinfunc" id="6909408">len</span><span class="op" id="6909411">(</span><span class="ident" id="6909412">db</span><span class="op" id="6909414">.</span><span class="ident" id="6909415">freeConn</span><span class="op" id="6909423">)</span><span class="op" id="6909424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909430">dc</span>&nbsp;<span class="op" id="6909433">:=</span>&nbsp;<span class="ident" id="6909436">db</span><span class="op" id="6909438">.</span><span class="ident" id="6909439">freeConn</span><span class="op" id="6909447">[</span><span class="num" id="6909448">0</span><span class="op" id="6909449">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909452">if</span>&nbsp;<span class="ident" id="6909455">dc</span><span class="op" id="6909457">.</span><span class="ident" id="6909458">closed</span>&nbsp;<span class="op" id="6909465">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909469">t</span><span class="op" id="6909470">.</span><span class="ident" id="6909471">Errorf</span><span class="op" id="6909477">(</span><span class="string" id="6909478">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6909504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909511">if</span>&nbsp;<span class="ident" id="6909514">n</span>&nbsp;<span class="op" id="6909516">:=</span>&nbsp;<span class="builtinfunc" id="6909519">len</span><span class="op" id="6909522">(</span><span class="ident" id="6909523">dc</span><span class="op" id="6909525">.</span><span class="ident" id="6909526">openStmt</span><span class="op" id="6909534">)</span><span class="op" id="6909535">;</span>&nbsp;<span class="ident" id="6909537">n</span>&nbsp;<span class="op" id="6909539">!=</span>&nbsp;<span class="num" id="6909542">1</span>&nbsp;<span class="op" id="6909544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909548">t</span><span class="op" id="6909549">.</span><span class="ident" id="6909550">Errorf</span><span class="op" id="6909556">(</span><span class="string" id="6909557">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="6909595">,</span>&nbsp;<span class="ident" id="6909597">n</span><span class="op" id="6909598">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909604">err</span>&nbsp;<span class="op" id="6909608">=</span>&nbsp;<span class="ident" id="6909610">db</span><span class="op" id="6909612">.</span><span class="ident" id="6909613">Close</span><span class="op" id="6909618">(</span><span class="op" id="6909619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909622">if</span>&nbsp;<span class="ident" id="6909625">err</span>&nbsp;<span class="op" id="6909629">!=</span>&nbsp;<span class="ident" id="6909632">nil</span>&nbsp;<span class="op" id="6909636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909640">t</span><span class="op" id="6909641">.</span><span class="ident" id="6909642">Errorf</span><span class="op" id="6909648">(</span><span class="string" id="6909649">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6909664">,</span>&nbsp;<span class="ident" id="6909666">err</span><span class="op" id="6909669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909672">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909675">if</span>&nbsp;<span class="op" id="6909678">!</span><span class="ident" id="6909679">dc</span><span class="op" id="6909681">.</span><span class="ident" id="6909682">closed</span>&nbsp;<span class="op" id="6909689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909693">t</span><span class="op" id="6909694">.</span><span class="ident" id="6909695">Errorf</span><span class="op" id="6909701">(</span><span class="string" id="6909702">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6909747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909753">if</span>&nbsp;<span class="ident" id="6909756">n</span>&nbsp;<span class="op" id="6909758">:=</span>&nbsp;<span class="builtinfunc" id="6909761">len</span><span class="op" id="6909764">(</span><span class="ident" id="6909765">dc</span><span class="op" id="6909767">.</span><span class="ident" id="6909768">openStmt</span><span class="op" id="6909776">)</span><span class="op" id="6909777">;</span>&nbsp;<span class="ident" id="6909779">n</span>&nbsp;<span class="op" id="6909781">!=</span>&nbsp;<span class="num" id="6909784">0</span>&nbsp;<span class="op" id="6909786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909790">t</span><span class="op" id="6909791">.</span><span class="ident" id="6909792">Errorf</span><span class="op" id="6909798">(</span><span class="string" id="6909799">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6909837">,</span>&nbsp;<span class="ident" id="6909839">n</span><span class="op" id="6909840">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909847">err</span>&nbsp;<span class="op" id="6909851">=</span>&nbsp;<span class="ident" id="6909853">stmt</span><span class="op" id="6909857">.</span><span class="ident" id="6909858">Close</span><span class="op" id="6909863">(</span><span class="op" id="6909864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909867">if</span>&nbsp;<span class="ident" id="6909870">err</span>&nbsp;<span class="op" id="6909874">!=</span>&nbsp;<span class="ident" id="6909877">nil</span>&nbsp;<span class="op" id="6909881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909885">t</span><span class="op" id="6909886">.</span><span class="ident" id="6909887">Errorf</span><span class="op" id="6909893">(</span><span class="string" id="6909894">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="6909911">,</span>&nbsp;<span class="ident" id="6909913">err</span><span class="op" id="6909916">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909923">if</span>&nbsp;<span class="op" id="6909926">!</span><span class="ident" id="6909927">dc</span><span class="op" id="6909929">.</span><span class="ident" id="6909930">closed</span>&nbsp;<span class="op" id="6909937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909941">t</span><span class="op" id="6909942">.</span><span class="ident" id="6909943">Errorf</span><span class="op" id="6909949">(</span><span class="string" id="6909950">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6909973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6909976">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6909979">if</span>&nbsp;<span class="ident" id="6909982">dc</span><span class="op" id="6909984">.</span><span class="ident" id="6909985">ci</span>&nbsp;<span class="op" id="6909988">!=</span>&nbsp;<span class="ident" id="6909991">nil</span>&nbsp;<span class="op" id="6909995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6909999">t</span><span class="op" id="6910000">.</span><span class="ident" id="6910001">Errorf</span><span class="op" id="6910007">(</span><span class="string" id="6910008">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="6910069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910072">}</span><br>
<span class="lineno"></span><span class="op" id="6910074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="6910077">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="6910147">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="6910177">func</span>&nbsp;<span class="ident" id="6910182">TestRowsCloseOrder</span><span class="op" id="6910200">(</span><span class="ident" id="6910201">t</span>&nbsp;<span class="op" id="6910203">*</span><span class="ident" id="6910204">testing</span><span class="op" id="6910211">.</span><span class="ident" id="6910212">T</span><span class="op" id="6910213">)</span>&nbsp;<span class="op" id="6910215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910218">db</span>&nbsp;<span class="op" id="6910221">:=</span>&nbsp;<span class="ident" id="6910224">newTestDB</span><span class="op" id="6910233">(</span><span class="ident" id="6910234">t</span><span class="op" id="6910235">,</span>&nbsp;<span class="string" id="6910237">&#34;people&#34;</span><span class="op" id="6910245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910248">defer</span>&nbsp;<span class="ident" id="6910254">closeDB</span><span class="op" id="6910261">(</span><span class="ident" id="6910262">t</span><span class="op" id="6910263">,</span>&nbsp;<span class="ident" id="6910265">db</span><span class="op" id="6910267">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910271">db</span><span class="op" id="6910273">.</span><span class="ident" id="6910274">SetMaxIdleConns</span><span class="op" id="6910289">(</span><span class="num" id="6910290">0</span><span class="op" id="6910291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910294">setStrictFakeConnClose</span><span class="op" id="6910316">(</span><span class="ident" id="6910317">t</span><span class="op" id="6910318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910321">defer</span>&nbsp;<span class="ident" id="6910327">setStrictFakeConnClose</span><span class="op" id="6910349">(</span><span class="ident" id="6910350">nil</span><span class="op" id="6910353">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910357">rows</span><span class="op" id="6910361">,</span>&nbsp;<span class="ident" id="6910363">err</span>&nbsp;<span class="op" id="6910367">:=</span>&nbsp;<span class="ident" id="6910370">db</span><span class="op" id="6910372">.</span><span class="ident" id="6910373">Query</span><span class="op" id="6910378">(</span><span class="string" id="6910379">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6910404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910407">if</span>&nbsp;<span class="ident" id="6910410">err</span>&nbsp;<span class="op" id="6910414">!=</span>&nbsp;<span class="ident" id="6910417">nil</span>&nbsp;<span class="op" id="6910421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910425">t</span><span class="op" id="6910426">.</span><span class="ident" id="6910427">Fatal</span><span class="op" id="6910432">(</span><span class="ident" id="6910433">err</span><span class="op" id="6910436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910442">err</span>&nbsp;<span class="op" id="6910446">=</span>&nbsp;<span class="ident" id="6910448">rows</span><span class="op" id="6910452">.</span><span class="ident" id="6910453">Close</span><span class="op" id="6910458">(</span><span class="op" id="6910459">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910462">if</span>&nbsp;<span class="ident" id="6910465">err</span>&nbsp;<span class="op" id="6910469">!=</span>&nbsp;<span class="ident" id="6910472">nil</span>&nbsp;<span class="op" id="6910476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910480">t</span><span class="op" id="6910481">.</span><span class="ident" id="6910482">Fatal</span><span class="op" id="6910487">(</span><span class="ident" id="6910488">err</span><span class="op" id="6910491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910494">}</span><br>
<span class="lineno"></span><span class="op" id="6910496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="6910499">func</span>&nbsp;<span class="ident" id="6910504">TestRowsImplicitClose</span><span class="op" id="6910525">(</span><span class="ident" id="6910526">t</span>&nbsp;<span class="op" id="6910528">*</span><span class="ident" id="6910529">testing</span><span class="op" id="6910536">.</span><span class="ident" id="6910537">T</span><span class="op" id="6910538">)</span>&nbsp;<span class="op" id="6910540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910543">db</span>&nbsp;<span class="op" id="6910546">:=</span>&nbsp;<span class="ident" id="6910549">newTestDB</span><span class="op" id="6910558">(</span><span class="ident" id="6910559">t</span><span class="op" id="6910560">,</span>&nbsp;<span class="string" id="6910562">&#34;people&#34;</span><span class="op" id="6910570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910573">defer</span>&nbsp;<span class="ident" id="6910579">closeDB</span><span class="op" id="6910586">(</span><span class="ident" id="6910587">t</span><span class="op" id="6910588">,</span>&nbsp;<span class="ident" id="6910590">db</span><span class="op" id="6910592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910596">rows</span><span class="op" id="6910600">,</span>&nbsp;<span class="ident" id="6910602">err</span>&nbsp;<span class="op" id="6910606">:=</span>&nbsp;<span class="ident" id="6910609">db</span><span class="op" id="6910611">.</span><span class="ident" id="6910612">Query</span><span class="op" id="6910617">(</span><span class="string" id="6910618">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="6910643">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910646">if</span>&nbsp;<span class="ident" id="6910649">err</span>&nbsp;<span class="op" id="6910653">!=</span>&nbsp;<span class="ident" id="6910656">nil</span>&nbsp;<span class="op" id="6910660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910664">t</span><span class="op" id="6910665">.</span><span class="ident" id="6910666">Fatal</span><span class="op" id="6910671">(</span><span class="ident" id="6910672">err</span><span class="op" id="6910675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910682">want</span><span class="op" id="6910686">,</span>&nbsp;<span class="ident" id="6910688">fail</span>&nbsp;<span class="op" id="6910693">:=</span>&nbsp;<span class="num" id="6910696">2</span><span class="op" id="6910697">,</span>&nbsp;<span class="ident" id="6910699">errors</span><span class="op" id="6910705">.</span><span class="ident" id="6910706">New</span><span class="op" id="6910709">(</span><span class="string" id="6910710">&#34;fail&#34;</span><span class="op" id="6910716">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910719">r</span>&nbsp;<span class="op" id="6910721">:=</span>&nbsp;<span class="ident" id="6910724">rows</span><span class="op" id="6910728">.</span><span class="ident" id="6910729">rowsi</span><span class="op" id="6910734">.</span><span class="op" id="6910735">(</span><span class="op" id="6910736">*</span><span class="ident" id="6910737">rowsCursor</span><span class="op" id="6910747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910750">r</span><span class="op" id="6910751">.</span><span class="ident" id="6910752">errPos</span><span class="op" id="6910758">,</span>&nbsp;<span class="ident" id="6910760">r</span><span class="op" id="6910761">.</span><span class="ident" id="6910762">err</span>&nbsp;<span class="op" id="6910766">=</span>&nbsp;<span class="ident" id="6910768">want</span><span class="op" id="6910772">,</span>&nbsp;<span class="ident" id="6910774">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910781">got</span>&nbsp;<span class="op" id="6910785">:=</span>&nbsp;<span class="num" id="6910788">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910791">for</span>&nbsp;<span class="ident" id="6910795">rows</span><span class="op" id="6910799">.</span><span class="ident" id="6910800">Next</span><span class="op" id="6910804">(</span><span class="op" id="6910805">)</span>&nbsp;<span class="op" id="6910807">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910811">got</span><span class="op" id="6910814">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910821">if</span>&nbsp;<span class="ident" id="6910824">got</span>&nbsp;<span class="op" id="6910828">!=</span>&nbsp;<span class="ident" id="6910831">want</span>&nbsp;<span class="op" id="6910836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910840">t</span><span class="op" id="6910841">.</span><span class="ident" id="6910842">Errorf</span><span class="op" id="6910848">(</span><span class="string" id="6910849">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6910871">,</span>&nbsp;<span class="ident" id="6910873">got</span><span class="op" id="6910876">,</span>&nbsp;<span class="ident" id="6910878">want</span><span class="op" id="6910882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910885">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910888">if</span>&nbsp;<span class="ident" id="6910891">err</span>&nbsp;<span class="op" id="6910895">:=</span>&nbsp;<span class="ident" id="6910898">rows</span><span class="op" id="6910902">.</span><span class="ident" id="6910903">Err</span><span class="op" id="6910906">(</span><span class="op" id="6910907">)</span><span class="op" id="6910908">;</span>&nbsp;<span class="ident" id="6910910">err</span>&nbsp;<span class="op" id="6910914">!=</span>&nbsp;<span class="ident" id="6910917">fail</span>&nbsp;<span class="op" id="6910922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910926">t</span><span class="op" id="6910927">.</span><span class="ident" id="6910928">Errorf</span><span class="op" id="6910934">(</span><span class="string" id="6910935">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6910958">,</span>&nbsp;<span class="ident" id="6910960">err</span><span class="op" id="6910963">,</span>&nbsp;<span class="ident" id="6910965">fail</span><span class="op" id="6910969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6910972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6910975">if</span>&nbsp;<span class="op" id="6910978">!</span><span class="ident" id="6910979">r</span><span class="op" id="6910980">.</span><span class="ident" id="6910981">closed</span>&nbsp;<span class="op" id="6910988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6910992">t</span><span class="op" id="6910993">.</span><span class="ident" id="6910994">Errorf</span><span class="op" id="6911000">(</span><span class="string" id="6911001">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="6911031">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911034">}</span><br>
<span class="lineno"></span><span class="op" id="6911036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6911039">func</span>&nbsp;<span class="ident" id="6911044">TestStmtCloseOrder</span><span class="op" id="6911062">(</span><span class="ident" id="6911063">t</span>&nbsp;<span class="op" id="6911065">*</span><span class="ident" id="6911066">testing</span><span class="op" id="6911073">.</span><span class="ident" id="6911074">T</span><span class="op" id="6911075">)</span>&nbsp;<span class="op" id="6911077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911080">db</span>&nbsp;<span class="op" id="6911083">:=</span>&nbsp;<span class="ident" id="6911086">newTestDB</span><span class="op" id="6911095">(</span><span class="ident" id="6911096">t</span><span class="op" id="6911097">,</span>&nbsp;<span class="string" id="6911099">&#34;people&#34;</span><span class="op" id="6911107">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911110">defer</span>&nbsp;<span class="ident" id="6911116">closeDB</span><span class="op" id="6911123">(</span><span class="ident" id="6911124">t</span><span class="op" id="6911125">,</span>&nbsp;<span class="ident" id="6911127">db</span><span class="op" id="6911129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911133">db</span><span class="op" id="6911135">.</span><span class="ident" id="6911136">SetMaxIdleConns</span><span class="op" id="6911151">(</span><span class="num" id="6911152">0</span><span class="op" id="6911153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911156">setStrictFakeConnClose</span><span class="op" id="6911178">(</span><span class="ident" id="6911179">t</span><span class="op" id="6911180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911183">defer</span>&nbsp;<span class="ident" id="6911189">setStrictFakeConnClose</span><span class="op" id="6911211">(</span><span class="ident" id="6911212">nil</span><span class="op" id="6911215">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911219">_</span><span class="op" id="6911220">,</span>&nbsp;<span class="ident" id="6911222">err</span>&nbsp;<span class="op" id="6911226">:=</span>&nbsp;<span class="ident" id="6911229">db</span><span class="op" id="6911231">.</span><span class="ident" id="6911232">Query</span><span class="op" id="6911237">(</span><span class="string" id="6911238">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="6911265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911268">if</span>&nbsp;<span class="ident" id="6911271">err</span>&nbsp;<span class="op" id="6911275">==</span>&nbsp;<span class="ident" id="6911278">nil</span>&nbsp;<span class="op" id="6911282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911286">t</span><span class="op" id="6911287">.</span><span class="ident" id="6911288">Fatal</span><span class="op" id="6911293">(</span><span class="string" id="6911294">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="6911334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911337">}</span><br>
<span class="lineno">1315</span><span class="op" id="6911339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6911342">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="6911367">func</span>&nbsp;<span class="ident" id="6911372">TestErrBadConnReconnect</span><span class="op" id="6911395">(</span><span class="ident" id="6911396">t</span>&nbsp;<span class="op" id="6911398">*</span><span class="ident" id="6911399">testing</span><span class="op" id="6911406">.</span><span class="ident" id="6911407">T</span><span class="op" id="6911408">)</span>&nbsp;<span class="op" id="6911410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911413">db</span>&nbsp;<span class="op" id="6911416">:=</span>&nbsp;<span class="ident" id="6911419">newTestDB</span><span class="op" id="6911428">(</span><span class="ident" id="6911429">t</span><span class="op" id="6911430">,</span>&nbsp;<span class="string" id="6911432">&#34;foo&#34;</span><span class="op" id="6911437">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911440">defer</span>&nbsp;<span class="ident" id="6911446">closeDB</span><span class="op" id="6911453">(</span><span class="ident" id="6911454">t</span><span class="op" id="6911455">,</span>&nbsp;<span class="ident" id="6911457">db</span><span class="op" id="6911459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911462">exec</span><span class="op" id="6911466">(</span><span class="ident" id="6911467">t</span><span class="op" id="6911468">,</span>&nbsp;<span class="ident" id="6911470">db</span><span class="op" id="6911472">,</span>&nbsp;<span class="string" id="6911474">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="6911517">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911521">simulateBadConn</span>&nbsp;<span class="op" id="6911537">:=</span>&nbsp;<span class="keyword" id="6911540">func</span><span class="op" id="6911544">(</span><span class="ident" id="6911545">name</span>&nbsp;<span class="builtintype" id="6911550">string</span><span class="op" id="6911556">,</span>&nbsp;<span class="ident" id="6911558">hook</span>&nbsp;<span class="op" id="6911563">*</span><span class="keyword" id="6911564">func</span><span class="op" id="6911568">(</span><span class="op" id="6911569">)</span>&nbsp;<span class="builtintype" id="6911571">bool</span><span class="op" id="6911575">,</span>&nbsp;<span class="ident" id="6911577">op</span>&nbsp;<span class="keyword" id="6911580">func</span><span class="op" id="6911584">(</span><span class="op" id="6911585">)</span>&nbsp;<span class="builtintype" id="6911587">error</span><span class="op" id="6911592">)</span>&nbsp;<span class="op" id="6911594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911598">broken</span><span class="op" id="6911604">,</span>&nbsp;<span class="ident" id="6911606">retried</span>&nbsp;<span class="op" id="6911614">:=</span>&nbsp;<span class="builtintype" id="6911617">false</span><span class="op" id="6911622">,</span>&nbsp;<span class="builtintype" id="6911624">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911632">numOpen</span>&nbsp;<span class="op" id="6911640">:=</span>&nbsp;<span class="ident" id="6911643">db</span><span class="op" id="6911645">.</span><span class="ident" id="6911646">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6911657">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911708">*</span><span class="ident" id="6911709">hook</span>&nbsp;<span class="op" id="6911714">=</span>&nbsp;<span class="keyword" id="6911716">func</span><span class="op" id="6911720">(</span><span class="op" id="6911721">)</span>&nbsp;<span class="builtintype" id="6911723">bool</span>&nbsp;<span class="op" id="6911728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911733">if</span>&nbsp;<span class="op" id="6911736">!</span><span class="ident" id="6911737">broken</span>&nbsp;<span class="op" id="6911744">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911750">broken</span>&nbsp;<span class="op" id="6911757">=</span>&nbsp;<span class="builtintype" id="6911759">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911768">return</span>&nbsp;<span class="builtintype" id="6911775">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911788">retried</span>&nbsp;<span class="op" id="6911796">=</span>&nbsp;<span class="builtintype" id="6911798">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911806">return</span>&nbsp;<span class="builtintype" id="6911813">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911826">if</span>&nbsp;<span class="ident" id="6911829">err</span>&nbsp;<span class="op" id="6911833">:=</span>&nbsp;<span class="ident" id="6911836">op</span><span class="op" id="6911838">(</span><span class="op" id="6911839">)</span><span class="op" id="6911840">;</span>&nbsp;<span class="ident" id="6911842">err</span>&nbsp;<span class="op" id="6911846">!=</span>&nbsp;<span class="ident" id="6911849">nil</span>&nbsp;<span class="op" id="6911853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911858">t</span><span class="op" id="6911859">.</span><span class="ident" id="6911860">Errorf</span><span class="op" id="6911866">(</span><span class="ident" id="6911867">name</span><span class="op" id="6911871">+</span><span class="string" id="6911872">&#34;:&nbsp;%v&#34;</span><span class="op" id="6911878">,</span>&nbsp;<span class="ident" id="6911880">err</span><span class="op" id="6911883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911888">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6911902">if</span>&nbsp;<span class="op" id="6911905">!</span><span class="ident" id="6911906">broken</span>&nbsp;<span class="op" id="6911913">||</span>&nbsp;<span class="op" id="6911916">!</span><span class="ident" id="6911917">retried</span>&nbsp;<span class="op" id="6911925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6911930">t</span><span class="op" id="6911931">.</span><span class="ident" id="6911932">Error</span><span class="op" id="6911937">(</span><span class="ident" id="6911938">name</span>&nbsp;<span class="op" id="6911943">+</span>&nbsp;<span class="string" id="6911945">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="6911985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911989">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6911993">*</span><span class="ident" id="6911994">hook</span>&nbsp;<span class="op" id="6911999">=</span>&nbsp;<span class="ident" id="6912001">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912008">if</span>&nbsp;<span class="ident" id="6912011">numOpen</span>&nbsp;<span class="op" id="6912019">!=</span>&nbsp;<span class="ident" id="6912022">db</span><span class="op" id="6912024">.</span><span class="ident" id="6912025">numOpen</span>&nbsp;<span class="op" id="6912033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912038">t</span><span class="op" id="6912039">.</span><span class="ident" id="6912040">Errorf</span><span class="op" id="6912046">(</span><span class="ident" id="6912047">name</span><span class="op" id="6912051">+</span><span class="string" id="6912052">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="6912080">,</span>&nbsp;<span class="ident" id="6912082">db</span><span class="op" id="6912084">.</span><span class="ident" id="6912085">numOpen</span><span class="op" id="6912092">-</span><span class="ident" id="6912093">numOpen</span><span class="op" id="6912100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912105">numOpen</span>&nbsp;<span class="op" id="6912113">=</span>&nbsp;<span class="ident" id="6912115">db</span><span class="op" id="6912117">.</span><span class="ident" id="6912118">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912135">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912147">dbExec</span>&nbsp;<span class="op" id="6912154">:=</span>&nbsp;<span class="keyword" id="6912157">func</span><span class="op" id="6912161">(</span><span class="op" id="6912162">)</span>&nbsp;<span class="builtintype" id="6912164">error</span>&nbsp;<span class="op" id="6912170">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912174">_</span><span class="op" id="6912175">,</span>&nbsp;<span class="ident" id="6912177">err</span>&nbsp;<span class="op" id="6912181">:=</span>&nbsp;<span class="ident" id="6912184">db</span><span class="op" id="6912186">.</span><span class="ident" id="6912187">Exec</span><span class="op" id="6912191">(</span><span class="string" id="6912192">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6912223">,</span>&nbsp;<span class="string" id="6912225">&#34;Gordon&#34;</span><span class="op" id="6912233">,</span>&nbsp;<span class="num" id="6912235">3</span><span class="op" id="6912236">,</span>&nbsp;<span class="builtintype" id="6912238">true</span><span class="op" id="6912242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912246">return</span>&nbsp;<span class="ident" id="6912253">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912261">simulateBadConn</span><span class="op" id="6912276">(</span><span class="string" id="6912277">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="6912294">,</span>&nbsp;<span class="op" id="6912296">&amp;</span><span class="ident" id="6912297">hookPrepareBadConn</span><span class="op" id="6912315">,</span>&nbsp;<span class="ident" id="6912317">dbExec</span><span class="op" id="6912323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912326">simulateBadConn</span><span class="op" id="6912341">(</span><span class="string" id="6912342">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="6912356">,</span>&nbsp;<span class="op" id="6912358">&amp;</span><span class="ident" id="6912359">hookExecBadConn</span><span class="op" id="6912374">,</span>&nbsp;<span class="ident" id="6912376">dbExec</span><span class="op" id="6912382">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912386">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912399">dbQuery</span>&nbsp;<span class="op" id="6912407">:=</span>&nbsp;<span class="keyword" id="6912410">func</span><span class="op" id="6912414">(</span><span class="op" id="6912415">)</span>&nbsp;<span class="builtintype" id="6912417">error</span>&nbsp;<span class="op" id="6912423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912427">rows</span><span class="op" id="6912431">,</span>&nbsp;<span class="ident" id="6912433">err</span>&nbsp;<span class="op" id="6912437">:=</span>&nbsp;<span class="ident" id="6912440">db</span><span class="op" id="6912442">.</span><span class="ident" id="6912443">Query</span><span class="op" id="6912448">(</span><span class="string" id="6912449">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6912470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912474">if</span>&nbsp;<span class="ident" id="6912477">err</span>&nbsp;<span class="op" id="6912481">==</span>&nbsp;<span class="ident" id="6912484">nil</span>&nbsp;<span class="op" id="6912488">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912493">err</span>&nbsp;<span class="op" id="6912497">=</span>&nbsp;<span class="ident" id="6912499">rows</span><span class="op" id="6912503">.</span><span class="ident" id="6912504">Close</span><span class="op" id="6912509">(</span><span class="op" id="6912510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912518">return</span>&nbsp;<span class="ident" id="6912525">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912533">simulateBadConn</span><span class="op" id="6912548">(</span><span class="string" id="6912549">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="6912567">,</span>&nbsp;<span class="op" id="6912569">&amp;</span><span class="ident" id="6912570">hookPrepareBadConn</span><span class="op" id="6912588">,</span>&nbsp;<span class="ident" id="6912590">dbQuery</span><span class="op" id="6912597">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912600">simulateBadConn</span><span class="op" id="6912615">(</span><span class="string" id="6912616">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="6912632">,</span>&nbsp;<span class="op" id="6912634">&amp;</span><span class="ident" id="6912635">hookQueryBadConn</span><span class="op" id="6912651">,</span>&nbsp;<span class="ident" id="6912653">dbQuery</span><span class="op" id="6912660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912664">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912679">simulateBadConn</span><span class="op" id="6912694">(</span><span class="string" id="6912695">&#34;db.Prepare&#34;</span><span class="op" id="6912707">,</span>&nbsp;<span class="op" id="6912709">&amp;</span><span class="ident" id="6912710">hookPrepareBadConn</span><span class="op" id="6912728">,</span>&nbsp;<span class="keyword" id="6912730">func</span><span class="op" id="6912734">(</span><span class="op" id="6912735">)</span>&nbsp;<span class="builtintype" id="6912737">error</span>&nbsp;<span class="op" id="6912743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912747">stmt</span><span class="op" id="6912751">,</span>&nbsp;<span class="ident" id="6912753">err</span>&nbsp;<span class="op" id="6912757">:=</span>&nbsp;<span class="ident" id="6912760">db</span><span class="op" id="6912762">.</span><span class="ident" id="6912763">Prepare</span><span class="op" id="6912770">(</span><span class="string" id="6912771">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6912802">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912806">if</span>&nbsp;<span class="ident" id="6912809">err</span>&nbsp;<span class="op" id="6912813">!=</span>&nbsp;<span class="ident" id="6912816">nil</span>&nbsp;<span class="op" id="6912820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912825">return</span>&nbsp;<span class="ident" id="6912832">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912842">stmt</span><span class="op" id="6912846">.</span><span class="ident" id="6912847">Close</span><span class="op" id="6912852">(</span><span class="op" id="6912853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6912857">return</span>&nbsp;<span class="ident" id="6912864">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6912869">}</span><span class="op" id="6912870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6912874">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912947">forcePrepare</span>&nbsp;<span class="op" id="6912960">:=</span>&nbsp;<span class="keyword" id="6912963">func</span><span class="op" id="6912967">(</span><span class="ident" id="6912968">stmt</span>&nbsp;<span class="op" id="6912973">*</span><span class="ident" id="6912974">Stmt</span><span class="op" id="6912978">)</span>&nbsp;<span class="op" id="6912980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6912984">stmt</span><span class="op" id="6912988">.</span><span class="ident" id="6912989">css</span>&nbsp;<span class="op" id="6912993">=</span>&nbsp;<span class="ident" id="6912995">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6913004">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913018">stmt1</span><span class="op" id="6913023">,</span>&nbsp;<span class="ident" id="6913025">err</span>&nbsp;<span class="op" id="6913029">:=</span>&nbsp;<span class="ident" id="6913032">db</span><span class="op" id="6913034">.</span><span class="ident" id="6913035">Prepare</span><span class="op" id="6913042">(</span><span class="string" id="6913043">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="6913074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913077">if</span>&nbsp;<span class="ident" id="6913080">err</span>&nbsp;<span class="op" id="6913084">!=</span>&nbsp;<span class="ident" id="6913087">nil</span>&nbsp;<span class="op" id="6913091">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913095">t</span><span class="op" id="6913096">.</span><span class="ident" id="6913097">Fatalf</span><span class="op" id="6913103">(</span><span class="string" id="6913104">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6913117">,</span>&nbsp;<span class="ident" id="6913119">err</span><span class="op" id="6913122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913128">defer</span>&nbsp;<span class="ident" id="6913134">stmt1</span><span class="op" id="6913139">.</span><span class="ident" id="6913140">Close</span><span class="op" id="6913145">(</span><span class="op" id="6913146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6913149">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913194">forcePrepare</span><span class="op" id="6913206">(</span><span class="ident" id="6913207">stmt1</span><span class="op" id="6913212">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913216">stmtExec</span>&nbsp;<span class="op" id="6913225">:=</span>&nbsp;<span class="keyword" id="6913228">func</span><span class="op" id="6913232">(</span><span class="op" id="6913233">)</span>&nbsp;<span class="builtintype" id="6913235">error</span>&nbsp;<span class="op" id="6913241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913245">_</span><span class="op" id="6913246">,</span>&nbsp;<span class="ident" id="6913248">err</span>&nbsp;<span class="op" id="6913252">:=</span>&nbsp;<span class="ident" id="6913255">stmt1</span><span class="op" id="6913260">.</span><span class="ident" id="6913261">Exec</span><span class="op" id="6913265">(</span><span class="string" id="6913266">&#34;Gopher&#34;</span><span class="op" id="6913274">,</span>&nbsp;<span class="num" id="6913276">3</span><span class="op" id="6913277">,</span>&nbsp;<span class="builtintype" id="6913279">false</span><span class="op" id="6913284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913288">return</span>&nbsp;<span class="ident" id="6913295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913300">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913303">simulateBadConn</span><span class="op" id="6913318">(</span><span class="string" id="6913319">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="6913338">,</span>&nbsp;<span class="op" id="6913340">&amp;</span><span class="ident" id="6913341">hookPrepareBadConn</span><span class="op" id="6913359">,</span>&nbsp;<span class="ident" id="6913361">stmtExec</span><span class="op" id="6913369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913372">simulateBadConn</span><span class="op" id="6913387">(</span><span class="string" id="6913388">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="6913404">,</span>&nbsp;<span class="op" id="6913406">&amp;</span><span class="ident" id="6913407">hookExecBadConn</span><span class="op" id="6913422">,</span>&nbsp;<span class="ident" id="6913424">stmtExec</span><span class="op" id="6913432">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6913436">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913451">stmt2</span><span class="op" id="6913456">,</span>&nbsp;<span class="ident" id="6913458">err</span>&nbsp;<span class="op" id="6913462">:=</span>&nbsp;<span class="ident" id="6913465">db</span><span class="op" id="6913467">.</span><span class="ident" id="6913468">Prepare</span><span class="op" id="6913475">(</span><span class="string" id="6913476">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="6913497">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913500">if</span>&nbsp;<span class="ident" id="6913503">err</span>&nbsp;<span class="op" id="6913507">!=</span>&nbsp;<span class="ident" id="6913510">nil</span>&nbsp;<span class="op" id="6913514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913518">t</span><span class="op" id="6913519">.</span><span class="ident" id="6913520">Fatalf</span><span class="op" id="6913526">(</span><span class="string" id="6913527">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="6913540">,</span>&nbsp;<span class="ident" id="6913542">err</span><span class="op" id="6913545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913551">defer</span>&nbsp;<span class="ident" id="6913557">stmt2</span><span class="op" id="6913562">.</span><span class="ident" id="6913563">Close</span><span class="op" id="6913568">(</span><span class="op" id="6913569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6913572">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913617">forcePrepare</span><span class="op" id="6913629">(</span><span class="ident" id="6913630">stmt2</span><span class="op" id="6913635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913639">stmtQuery</span>&nbsp;<span class="op" id="6913649">:=</span>&nbsp;<span class="keyword" id="6913652">func</span><span class="op" id="6913656">(</span><span class="op" id="6913657">)</span>&nbsp;<span class="builtintype" id="6913659">error</span>&nbsp;<span class="op" id="6913665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913669">rows</span><span class="op" id="6913673">,</span>&nbsp;<span class="ident" id="6913675">err</span>&nbsp;<span class="op" id="6913679">:=</span>&nbsp;<span class="ident" id="6913682">stmt2</span><span class="op" id="6913687">.</span><span class="ident" id="6913688">Query</span><span class="op" id="6913693">(</span><span class="op" id="6913694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913698">if</span>&nbsp;<span class="ident" id="6913701">err</span>&nbsp;<span class="op" id="6913705">==</span>&nbsp;<span class="ident" id="6913708">nil</span>&nbsp;<span class="op" id="6913712">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913717">err</span>&nbsp;<span class="op" id="6913721">=</span>&nbsp;<span class="ident" id="6913723">rows</span><span class="op" id="6913727">.</span><span class="ident" id="6913728">Close</span><span class="op" id="6913733">(</span><span class="op" id="6913734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6913742">return</span>&nbsp;<span class="ident" id="6913749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6913754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913757">simulateBadConn</span><span class="op" id="6913772">(</span><span class="string" id="6913773">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="6913793">,</span>&nbsp;<span class="op" id="6913795">&amp;</span><span class="ident" id="6913796">hookPrepareBadConn</span><span class="op" id="6913814">,</span>&nbsp;<span class="ident" id="6913816">stmtQuery</span><span class="op" id="6913825">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913828">simulateBadConn</span><span class="op" id="6913843">(</span><span class="string" id="6913844">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="6913861">,</span>&nbsp;<span class="op" id="6913863">&amp;</span><span class="ident" id="6913864">hookQueryBadConn</span><span class="op" id="6913880">,</span>&nbsp;<span class="ident" id="6913882">stmtQuery</span><span class="op" id="6913891">)</span><br>
<span class="lineno"></span><span class="op" id="6913893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6913896">type</span>&nbsp;<span class="ident" id="6913901">concurrentTest</span>&nbsp;<span class="keyword" id="6913916">interface</span>&nbsp;<span class="op" id="6913926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913929">init</span><span class="op" id="6913933">(</span><span class="ident" id="6913934">t</span>&nbsp;<span class="ident" id="6913936">testing</span><span class="op" id="6913943">.</span><span class="ident" id="6913944">TB</span><span class="op" id="6913946">,</span>&nbsp;<span class="ident" id="6913948">db</span>&nbsp;<span class="op" id="6913951">*</span><span class="ident" id="6913952">DB</span><span class="op" id="6913954">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913957">finish</span><span class="op" id="6913963">(</span><span class="ident" id="6913964">t</span>&nbsp;<span class="ident" id="6913966">testing</span><span class="op" id="6913973">.</span><span class="ident" id="6913974">TB</span><span class="op" id="6913976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6913979">test</span><span class="op" id="6913983">(</span><span class="ident" id="6913984">t</span>&nbsp;<span class="ident" id="6913986">testing</span><span class="op" id="6913993">.</span><span class="ident" id="6913994">TB</span><span class="op" id="6913996">)</span>&nbsp;<span class="builtintype" id="6913998">error</span><br>
<span class="lineno"></span><span class="op" id="6914004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914007">type</span>&nbsp;<span class="ident" id="6914012">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="6914034">struct</span>&nbsp;<span class="op" id="6914041">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914044">db</span>&nbsp;<span class="op" id="6914047">*</span><span class="ident" id="6914048">DB</span><br>
<span class="lineno"></span><span class="op" id="6914051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914054">func</span>&nbsp;<span class="op" id="6914059">(</span><span class="ident" id="6914060">c</span>&nbsp;<span class="op" id="6914062">*</span><span class="ident" id="6914063">concurrentDBQueryTest</span><span class="op" id="6914084">)</span>&nbsp;<span class="ident" id="6914086">init</span><span class="op" id="6914090">(</span><span class="ident" id="6914091">t</span>&nbsp;<span class="ident" id="6914093">testing</span><span class="op" id="6914100">.</span><span class="ident" id="6914101">TB</span><span class="op" id="6914103">,</span>&nbsp;<span class="ident" id="6914105">db</span>&nbsp;<span class="op" id="6914108">*</span><span class="ident" id="6914109">DB</span><span class="op" id="6914111">)</span>&nbsp;<span class="op" id="6914113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914116">c</span><span class="op" id="6914117">.</span><span class="ident" id="6914118">db</span>&nbsp;<span class="op" id="6914121">=</span>&nbsp;<span class="ident" id="6914123">db</span><br>
<span class="lineno">1435</span><span class="op" id="6914126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914129">func</span>&nbsp;<span class="op" id="6914134">(</span><span class="ident" id="6914135">c</span>&nbsp;<span class="op" id="6914137">*</span><span class="ident" id="6914138">concurrentDBQueryTest</span><span class="op" id="6914159">)</span>&nbsp;<span class="ident" id="6914161">finish</span><span class="op" id="6914167">(</span><span class="ident" id="6914168">t</span>&nbsp;<span class="ident" id="6914170">testing</span><span class="op" id="6914177">.</span><span class="ident" id="6914178">TB</span><span class="op" id="6914180">)</span>&nbsp;<span class="op" id="6914182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914185">c</span><span class="op" id="6914186">.</span><span class="ident" id="6914187">db</span>&nbsp;<span class="op" id="6914190">=</span>&nbsp;<span class="ident" id="6914192">nil</span><br>
<span class="lineno"></span><span class="op" id="6914196">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="6914199">func</span>&nbsp;<span class="op" id="6914204">(</span><span class="ident" id="6914205">c</span>&nbsp;<span class="op" id="6914207">*</span><span class="ident" id="6914208">concurrentDBQueryTest</span><span class="op" id="6914229">)</span>&nbsp;<span class="ident" id="6914231">test</span><span class="op" id="6914235">(</span><span class="ident" id="6914236">t</span>&nbsp;<span class="ident" id="6914238">testing</span><span class="op" id="6914245">.</span><span class="ident" id="6914246">TB</span><span class="op" id="6914248">)</span>&nbsp;<span class="builtintype" id="6914250">error</span>&nbsp;<span class="op" id="6914256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914259">rows</span><span class="op" id="6914263">,</span>&nbsp;<span class="ident" id="6914265">err</span>&nbsp;<span class="op" id="6914269">:=</span>&nbsp;<span class="ident" id="6914272">c</span><span class="op" id="6914273">.</span><span class="ident" id="6914274">db</span><span class="op" id="6914276">.</span><span class="ident" id="6914277">Query</span><span class="op" id="6914282">(</span><span class="string" id="6914283">&#34;SELECT|people|name|&#34;</span><span class="op" id="6914304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914307">if</span>&nbsp;<span class="ident" id="6914310">err</span>&nbsp;<span class="op" id="6914314">!=</span>&nbsp;<span class="ident" id="6914317">nil</span>&nbsp;<span class="op" id="6914321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914325">t</span><span class="op" id="6914326">.</span><span class="ident" id="6914327">Error</span><span class="op" id="6914332">(</span><span class="ident" id="6914333">err</span><span class="op" id="6914336">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914340">return</span>&nbsp;<span class="ident" id="6914347">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914355">var</span>&nbsp;<span class="ident" id="6914359">name</span>&nbsp;<span class="builtintype" id="6914364">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914372">for</span>&nbsp;<span class="ident" id="6914376">rows</span><span class="op" id="6914380">.</span><span class="ident" id="6914381">Next</span><span class="op" id="6914385">(</span><span class="op" id="6914386">)</span>&nbsp;<span class="op" id="6914388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914392">rows</span><span class="op" id="6914396">.</span><span class="ident" id="6914397">Scan</span><span class="op" id="6914401">(</span><span class="op" id="6914402">&amp;</span><span class="ident" id="6914403">name</span><span class="op" id="6914407">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914413">rows</span><span class="op" id="6914417">.</span><span class="ident" id="6914418">Close</span><span class="op" id="6914423">(</span><span class="op" id="6914424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914427">return</span>&nbsp;<span class="ident" id="6914434">nil</span><br>
<span class="lineno"></span><span class="op" id="6914438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="6914441">type</span>&nbsp;<span class="ident" id="6914446">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="6914467">struct</span>&nbsp;<span class="op" id="6914474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914477">db</span>&nbsp;<span class="op" id="6914480">*</span><span class="ident" id="6914481">DB</span><br>
<span class="lineno"></span><span class="op" id="6914484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914487">func</span>&nbsp;<span class="op" id="6914492">(</span><span class="ident" id="6914493">c</span>&nbsp;<span class="op" id="6914495">*</span><span class="ident" id="6914496">concurrentDBExecTest</span><span class="op" id="6914516">)</span>&nbsp;<span class="ident" id="6914518">init</span><span class="op" id="6914522">(</span><span class="ident" id="6914523">t</span>&nbsp;<span class="ident" id="6914525">testing</span><span class="op" id="6914532">.</span><span class="ident" id="6914533">TB</span><span class="op" id="6914535">,</span>&nbsp;<span class="ident" id="6914537">db</span>&nbsp;<span class="op" id="6914540">*</span><span class="ident" id="6914541">DB</span><span class="op" id="6914543">)</span>&nbsp;<span class="op" id="6914545">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914548">c</span><span class="op" id="6914549">.</span><span class="ident" id="6914550">db</span>&nbsp;<span class="op" id="6914553">=</span>&nbsp;<span class="ident" id="6914555">db</span><br>
<span class="lineno"></span><span class="op" id="6914558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914561">func</span>&nbsp;<span class="op" id="6914566">(</span><span class="ident" id="6914567">c</span>&nbsp;<span class="op" id="6914569">*</span><span class="ident" id="6914570">concurrentDBExecTest</span><span class="op" id="6914590">)</span>&nbsp;<span class="ident" id="6914592">finish</span><span class="op" id="6914598">(</span><span class="ident" id="6914599">t</span>&nbsp;<span class="ident" id="6914601">testing</span><span class="op" id="6914608">.</span><span class="ident" id="6914609">TB</span><span class="op" id="6914611">)</span>&nbsp;<span class="op" id="6914613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914616">c</span><span class="op" id="6914617">.</span><span class="ident" id="6914618">db</span>&nbsp;<span class="op" id="6914621">=</span>&nbsp;<span class="ident" id="6914623">nil</span><br>
<span class="lineno">1465</span><span class="op" id="6914627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6914630">func</span>&nbsp;<span class="op" id="6914635">(</span><span class="ident" id="6914636">c</span>&nbsp;<span class="op" id="6914638">*</span><span class="ident" id="6914639">concurrentDBExecTest</span><span class="op" id="6914659">)</span>&nbsp;<span class="ident" id="6914661">test</span><span class="op" id="6914665">(</span><span class="ident" id="6914666">t</span>&nbsp;<span class="ident" id="6914668">testing</span><span class="op" id="6914675">.</span><span class="ident" id="6914676">TB</span><span class="op" id="6914678">)</span>&nbsp;<span class="builtintype" id="6914680">error</span>&nbsp;<span class="op" id="6914686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914689">_</span><span class="op" id="6914690">,</span>&nbsp;<span class="ident" id="6914692">err</span>&nbsp;<span class="op" id="6914696">:=</span>&nbsp;<span class="ident" id="6914699">c</span><span class="op" id="6914700">.</span><span class="ident" id="6914701">db</span><span class="op" id="6914703">.</span><span class="ident" id="6914704">Exec</span><span class="op" id="6914708">(</span><span class="string" id="6914709">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6914762">,</span>&nbsp;<span class="num" id="6914764">3</span><span class="op" id="6914765">,</span>&nbsp;<span class="ident" id="6914767">chrisBirthday</span><span class="op" id="6914780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914783">if</span>&nbsp;<span class="ident" id="6914786">err</span>&nbsp;<span class="op" id="6914790">!=</span>&nbsp;<span class="ident" id="6914793">nil</span>&nbsp;<span class="op" id="6914797">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914801">t</span><span class="op" id="6914802">.</span><span class="ident" id="6914803">Error</span><span class="op" id="6914808">(</span><span class="ident" id="6914809">err</span><span class="op" id="6914812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914816">return</span>&nbsp;<span class="ident" id="6914823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6914828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914831">return</span>&nbsp;<span class="ident" id="6914838">nil</span><br>
<span class="lineno"></span><span class="op" id="6914842">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="6914845">type</span>&nbsp;<span class="ident" id="6914850">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="6914874">struct</span>&nbsp;<span class="op" id="6914881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914884">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6914889">*</span><span class="ident" id="6914890">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914894">stmt</span>&nbsp;<span class="op" id="6914899">*</span><span class="ident" id="6914900">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6914905">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="6914908">func</span>&nbsp;<span class="op" id="6914913">(</span><span class="ident" id="6914914">c</span>&nbsp;<span class="op" id="6914916">*</span><span class="ident" id="6914917">concurrentStmtQueryTest</span><span class="op" id="6914940">)</span>&nbsp;<span class="ident" id="6914942">init</span><span class="op" id="6914946">(</span><span class="ident" id="6914947">t</span>&nbsp;<span class="ident" id="6914949">testing</span><span class="op" id="6914956">.</span><span class="ident" id="6914957">TB</span><span class="op" id="6914959">,</span>&nbsp;<span class="ident" id="6914961">db</span>&nbsp;<span class="op" id="6914964">*</span><span class="ident" id="6914965">DB</span><span class="op" id="6914967">)</span>&nbsp;<span class="op" id="6914969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914972">c</span><span class="op" id="6914973">.</span><span class="ident" id="6914974">db</span>&nbsp;<span class="op" id="6914977">=</span>&nbsp;<span class="ident" id="6914979">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6914983">var</span>&nbsp;<span class="ident" id="6914987">err</span>&nbsp;<span class="builtintype" id="6914991">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6914998">c</span><span class="op" id="6914999">.</span><span class="ident" id="6915000">stmt</span><span class="op" id="6915004">,</span>&nbsp;<span class="ident" id="6915006">err</span>&nbsp;<span class="op" id="6915010">=</span>&nbsp;<span class="ident" id="6915012">db</span><span class="op" id="6915014">.</span><span class="ident" id="6915015">Prepare</span><span class="op" id="6915022">(</span><span class="string" id="6915023">&#34;SELECT|people|name|&#34;</span><span class="op" id="6915044">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915047">if</span>&nbsp;<span class="ident" id="6915050">err</span>&nbsp;<span class="op" id="6915054">!=</span>&nbsp;<span class="ident" id="6915057">nil</span>&nbsp;<span class="op" id="6915061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915065">t</span><span class="op" id="6915066">.</span><span class="ident" id="6915067">Fatal</span><span class="op" id="6915072">(</span><span class="ident" id="6915073">err</span><span class="op" id="6915076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915079">}</span><br>
<span class="lineno"></span><span class="op" id="6915081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="6915084">func</span>&nbsp;<span class="op" id="6915089">(</span><span class="ident" id="6915090">c</span>&nbsp;<span class="op" id="6915092">*</span><span class="ident" id="6915093">concurrentStmtQueryTest</span><span class="op" id="6915116">)</span>&nbsp;<span class="ident" id="6915118">finish</span><span class="op" id="6915124">(</span><span class="ident" id="6915125">t</span>&nbsp;<span class="ident" id="6915127">testing</span><span class="op" id="6915134">.</span><span class="ident" id="6915135">TB</span><span class="op" id="6915137">)</span>&nbsp;<span class="op" id="6915139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915142">if</span>&nbsp;<span class="ident" id="6915145">c</span><span class="op" id="6915146">.</span><span class="ident" id="6915147">stmt</span>&nbsp;<span class="op" id="6915152">!=</span>&nbsp;<span class="ident" id="6915155">nil</span>&nbsp;<span class="op" id="6915159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915163">c</span><span class="op" id="6915164">.</span><span class="ident" id="6915165">stmt</span><span class="op" id="6915169">.</span><span class="ident" id="6915170">Close</span><span class="op" id="6915175">(</span><span class="op" id="6915176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915180">c</span><span class="op" id="6915181">.</span><span class="ident" id="6915182">stmt</span>&nbsp;<span class="op" id="6915187">=</span>&nbsp;<span class="ident" id="6915189">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915194">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915197">c</span><span class="op" id="6915198">.</span><span class="ident" id="6915199">db</span>&nbsp;<span class="op" id="6915202">=</span>&nbsp;<span class="ident" id="6915204">nil</span><br>
<span class="lineno"></span><span class="op" id="6915208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6915211">func</span>&nbsp;<span class="op" id="6915216">(</span><span class="ident" id="6915217">c</span>&nbsp;<span class="op" id="6915219">*</span><span class="ident" id="6915220">concurrentStmtQueryTest</span><span class="op" id="6915243">)</span>&nbsp;<span class="ident" id="6915245">test</span><span class="op" id="6915249">(</span><span class="ident" id="6915250">t</span>&nbsp;<span class="ident" id="6915252">testing</span><span class="op" id="6915259">.</span><span class="ident" id="6915260">TB</span><span class="op" id="6915262">)</span>&nbsp;<span class="builtintype" id="6915264">error</span>&nbsp;<span class="op" id="6915270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915273">rows</span><span class="op" id="6915277">,</span>&nbsp;<span class="ident" id="6915279">err</span>&nbsp;<span class="op" id="6915283">:=</span>&nbsp;<span class="ident" id="6915286">c</span><span class="op" id="6915287">.</span><span class="ident" id="6915288">stmt</span><span class="op" id="6915292">.</span><span class="ident" id="6915293">Query</span><span class="op" id="6915298">(</span><span class="op" id="6915299">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915302">if</span>&nbsp;<span class="ident" id="6915305">err</span>&nbsp;<span class="op" id="6915309">!=</span>&nbsp;<span class="ident" id="6915312">nil</span>&nbsp;<span class="op" id="6915316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915320">t</span><span class="op" id="6915321">.</span><span class="ident" id="6915322">Errorf</span><span class="op" id="6915328">(</span><span class="string" id="6915329">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6915350">,</span>&nbsp;<span class="ident" id="6915352">err</span><span class="op" id="6915355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915359">return</span>&nbsp;<span class="ident" id="6915366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915375">var</span>&nbsp;<span class="ident" id="6915379">name</span>&nbsp;<span class="builtintype" id="6915384">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915392">for</span>&nbsp;<span class="ident" id="6915396">rows</span><span class="op" id="6915400">.</span><span class="ident" id="6915401">Next</span><span class="op" id="6915405">(</span><span class="op" id="6915406">)</span>&nbsp;<span class="op" id="6915408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915412">rows</span><span class="op" id="6915416">.</span><span class="ident" id="6915417">Scan</span><span class="op" id="6915421">(</span><span class="op" id="6915422">&amp;</span><span class="ident" id="6915423">name</span><span class="op" id="6915427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915433">rows</span><span class="op" id="6915437">.</span><span class="ident" id="6915438">Close</span><span class="op" id="6915443">(</span><span class="op" id="6915444">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915447">return</span>&nbsp;<span class="ident" id="6915454">nil</span><br>
<span class="lineno"></span><span class="op" id="6915458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6915461">type</span>&nbsp;<span class="ident" id="6915466">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="6915489">struct</span>&nbsp;<span class="op" id="6915496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915499">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6915504">*</span><span class="ident" id="6915505">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915509">stmt</span>&nbsp;<span class="op" id="6915514">*</span><span class="ident" id="6915515">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6915520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6915523">func</span>&nbsp;<span class="op" id="6915528">(</span><span class="ident" id="6915529">c</span>&nbsp;<span class="op" id="6915531">*</span><span class="ident" id="6915532">concurrentStmtExecTest</span><span class="op" id="6915554">)</span>&nbsp;<span class="ident" id="6915556">init</span><span class="op" id="6915560">(</span><span class="ident" id="6915561">t</span>&nbsp;<span class="ident" id="6915563">testing</span><span class="op" id="6915570">.</span><span class="ident" id="6915571">TB</span><span class="op" id="6915573">,</span>&nbsp;<span class="ident" id="6915575">db</span>&nbsp;<span class="op" id="6915578">*</span><span class="ident" id="6915579">DB</span><span class="op" id="6915581">)</span>&nbsp;<span class="op" id="6915583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915586">c</span><span class="op" id="6915587">.</span><span class="ident" id="6915588">db</span>&nbsp;<span class="op" id="6915591">=</span>&nbsp;<span class="ident" id="6915593">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915597">var</span>&nbsp;<span class="ident" id="6915601">err</span>&nbsp;<span class="builtintype" id="6915605">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915612">c</span><span class="op" id="6915613">.</span><span class="ident" id="6915614">stmt</span><span class="op" id="6915618">,</span>&nbsp;<span class="ident" id="6915620">err</span>&nbsp;<span class="op" id="6915624">=</span>&nbsp;<span class="ident" id="6915626">db</span><span class="op" id="6915628">.</span><span class="ident" id="6915629">Prepare</span><span class="op" id="6915636">(</span><span class="string" id="6915637">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6915690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915693">if</span>&nbsp;<span class="ident" id="6915696">err</span>&nbsp;<span class="op" id="6915700">!=</span>&nbsp;<span class="ident" id="6915703">nil</span>&nbsp;<span class="op" id="6915707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915711">t</span><span class="op" id="6915712">.</span><span class="ident" id="6915713">Fatal</span><span class="op" id="6915718">(</span><span class="ident" id="6915719">err</span><span class="op" id="6915722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915725">}</span><br>
<span class="lineno">1525</span><span class="op" id="6915727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6915730">func</span>&nbsp;<span class="op" id="6915735">(</span><span class="ident" id="6915736">c</span>&nbsp;<span class="op" id="6915738">*</span><span class="ident" id="6915739">concurrentStmtExecTest</span><span class="op" id="6915761">)</span>&nbsp;<span class="ident" id="6915763">finish</span><span class="op" id="6915769">(</span><span class="ident" id="6915770">t</span>&nbsp;<span class="ident" id="6915772">testing</span><span class="op" id="6915779">.</span><span class="ident" id="6915780">TB</span><span class="op" id="6915782">)</span>&nbsp;<span class="op" id="6915784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915787">if</span>&nbsp;<span class="ident" id="6915790">c</span><span class="op" id="6915791">.</span><span class="ident" id="6915792">stmt</span>&nbsp;<span class="op" id="6915797">!=</span>&nbsp;<span class="ident" id="6915800">nil</span>&nbsp;<span class="op" id="6915804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915808">c</span><span class="op" id="6915809">.</span><span class="ident" id="6915810">stmt</span><span class="op" id="6915814">.</span><span class="ident" id="6915815">Close</span><span class="op" id="6915820">(</span><span class="op" id="6915821">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915825">c</span><span class="op" id="6915826">.</span><span class="ident" id="6915827">stmt</span>&nbsp;<span class="op" id="6915832">=</span>&nbsp;<span class="ident" id="6915834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6915839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915842">c</span><span class="op" id="6915843">.</span><span class="ident" id="6915844">db</span>&nbsp;<span class="op" id="6915847">=</span>&nbsp;<span class="ident" id="6915849">nil</span><br>
<span class="lineno"></span><span class="op" id="6915853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="6915856">func</span>&nbsp;<span class="op" id="6915861">(</span><span class="ident" id="6915862">c</span>&nbsp;<span class="op" id="6915864">*</span><span class="ident" id="6915865">concurrentStmtExecTest</span><span class="op" id="6915887">)</span>&nbsp;<span class="ident" id="6915889">test</span><span class="op" id="6915893">(</span><span class="ident" id="6915894">t</span>&nbsp;<span class="ident" id="6915896">testing</span><span class="op" id="6915903">.</span><span class="ident" id="6915904">TB</span><span class="op" id="6915906">)</span>&nbsp;<span class="builtintype" id="6915908">error</span>&nbsp;<span class="op" id="6915914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915917">_</span><span class="op" id="6915918">,</span>&nbsp;<span class="ident" id="6915920">err</span>&nbsp;<span class="op" id="6915924">:=</span>&nbsp;<span class="ident" id="6915927">c</span><span class="op" id="6915928">.</span><span class="ident" id="6915929">stmt</span><span class="op" id="6915933">.</span><span class="ident" id="6915934">Exec</span><span class="op" id="6915938">(</span><span class="num" id="6915939">3</span><span class="op" id="6915940">,</span>&nbsp;<span class="ident" id="6915942">chrisBirthday</span><span class="op" id="6915955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6915958">if</span>&nbsp;<span class="ident" id="6915961">err</span>&nbsp;<span class="op" id="6915965">!=</span>&nbsp;<span class="ident" id="6915968">nil</span>&nbsp;<span class="op" id="6915972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6915976">t</span><span class="op" id="6915977">.</span><span class="ident" id="6915978">Errorf</span><span class="op" id="6915984">(</span><span class="string" id="6915985">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6916005">,</span>&nbsp;<span class="ident" id="6916007">err</span><span class="op" id="6916010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916014">return</span>&nbsp;<span class="ident" id="6916021">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916029">return</span>&nbsp;<span class="ident" id="6916036">nil</span><br>
<span class="lineno"></span><span class="op" id="6916040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6916043">type</span>&nbsp;<span class="ident" id="6916048">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="6916070">struct</span>&nbsp;<span class="op" id="6916077">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916080">db</span>&nbsp;<span class="op" id="6916083">*</span><span class="ident" id="6916084">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916088">tx</span>&nbsp;<span class="op" id="6916091">*</span><span class="ident" id="6916092">Tx</span><br>
<span class="lineno"></span><span class="op" id="6916095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6916098">func</span>&nbsp;<span class="op" id="6916103">(</span><span class="ident" id="6916104">c</span>&nbsp;<span class="op" id="6916106">*</span><span class="ident" id="6916107">concurrentTxQueryTest</span><span class="op" id="6916128">)</span>&nbsp;<span class="ident" id="6916130">init</span><span class="op" id="6916134">(</span><span class="ident" id="6916135">t</span>&nbsp;<span class="ident" id="6916137">testing</span><span class="op" id="6916144">.</span><span class="ident" id="6916145">TB</span><span class="op" id="6916147">,</span>&nbsp;<span class="ident" id="6916149">db</span>&nbsp;<span class="op" id="6916152">*</span><span class="ident" id="6916153">DB</span><span class="op" id="6916155">)</span>&nbsp;<span class="op" id="6916157">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916160">c</span><span class="op" id="6916161">.</span><span class="ident" id="6916162">db</span>&nbsp;<span class="op" id="6916165">=</span>&nbsp;<span class="ident" id="6916167">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916171">var</span>&nbsp;<span class="ident" id="6916175">err</span>&nbsp;<span class="builtintype" id="6916179">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916186">c</span><span class="op" id="6916187">.</span><span class="ident" id="6916188">tx</span><span class="op" id="6916190">,</span>&nbsp;<span class="ident" id="6916192">err</span>&nbsp;<span class="op" id="6916196">=</span>&nbsp;<span class="ident" id="6916198">c</span><span class="op" id="6916199">.</span><span class="ident" id="6916200">db</span><span class="op" id="6916202">.</span><span class="ident" id="6916203">Begin</span><span class="op" id="6916208">(</span><span class="op" id="6916209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916212">if</span>&nbsp;<span class="ident" id="6916215">err</span>&nbsp;<span class="op" id="6916219">!=</span>&nbsp;<span class="ident" id="6916222">nil</span>&nbsp;<span class="op" id="6916226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916230">t</span><span class="op" id="6916231">.</span><span class="ident" id="6916232">Fatal</span><span class="op" id="6916237">(</span><span class="ident" id="6916238">err</span><span class="op" id="6916241">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916244">}</span><br>
<span class="lineno"></span><span class="op" id="6916246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6916249">func</span>&nbsp;<span class="op" id="6916254">(</span><span class="ident" id="6916255">c</span>&nbsp;<span class="op" id="6916257">*</span><span class="ident" id="6916258">concurrentTxQueryTest</span><span class="op" id="6916279">)</span>&nbsp;<span class="ident" id="6916281">finish</span><span class="op" id="6916287">(</span><span class="ident" id="6916288">t</span>&nbsp;<span class="ident" id="6916290">testing</span><span class="op" id="6916297">.</span><span class="ident" id="6916298">TB</span><span class="op" id="6916300">)</span>&nbsp;<span class="op" id="6916302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916305">if</span>&nbsp;<span class="ident" id="6916308">c</span><span class="op" id="6916309">.</span><span class="ident" id="6916310">tx</span>&nbsp;<span class="op" id="6916313">!=</span>&nbsp;<span class="ident" id="6916316">nil</span>&nbsp;<span class="op" id="6916320">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916324">c</span><span class="op" id="6916325">.</span><span class="ident" id="6916326">tx</span><span class="op" id="6916328">.</span><span class="ident" id="6916329">Rollback</span><span class="op" id="6916337">(</span><span class="op" id="6916338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916342">c</span><span class="op" id="6916343">.</span><span class="ident" id="6916344">tx</span>&nbsp;<span class="op" id="6916347">=</span>&nbsp;<span class="ident" id="6916349">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916357">c</span><span class="op" id="6916358">.</span><span class="ident" id="6916359">db</span>&nbsp;<span class="op" id="6916362">=</span>&nbsp;<span class="ident" id="6916364">nil</span><br>
<span class="lineno"></span><span class="op" id="6916368">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="6916371">func</span>&nbsp;<span class="op" id="6916376">(</span><span class="ident" id="6916377">c</span>&nbsp;<span class="op" id="6916379">*</span><span class="ident" id="6916380">concurrentTxQueryTest</span><span class="op" id="6916401">)</span>&nbsp;<span class="ident" id="6916403">test</span><span class="op" id="6916407">(</span><span class="ident" id="6916408">t</span>&nbsp;<span class="ident" id="6916410">testing</span><span class="op" id="6916417">.</span><span class="ident" id="6916418">TB</span><span class="op" id="6916420">)</span>&nbsp;<span class="builtintype" id="6916422">error</span>&nbsp;<span class="op" id="6916428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916431">rows</span><span class="op" id="6916435">,</span>&nbsp;<span class="ident" id="6916437">err</span>&nbsp;<span class="op" id="6916441">:=</span>&nbsp;<span class="ident" id="6916444">c</span><span class="op" id="6916445">.</span><span class="ident" id="6916446">db</span><span class="op" id="6916448">.</span><span class="ident" id="6916449">Query</span><span class="op" id="6916454">(</span><span class="string" id="6916455">&#34;SELECT|people|name|&#34;</span><span class="op" id="6916476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916479">if</span>&nbsp;<span class="ident" id="6916482">err</span>&nbsp;<span class="op" id="6916486">!=</span>&nbsp;<span class="ident" id="6916489">nil</span>&nbsp;<span class="op" id="6916493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916497">t</span><span class="op" id="6916498">.</span><span class="ident" id="6916499">Error</span><span class="op" id="6916504">(</span><span class="ident" id="6916505">err</span><span class="op" id="6916508">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916512">return</span>&nbsp;<span class="ident" id="6916519">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916527">var</span>&nbsp;<span class="ident" id="6916531">name</span>&nbsp;<span class="builtintype" id="6916536">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916544">for</span>&nbsp;<span class="ident" id="6916548">rows</span><span class="op" id="6916552">.</span><span class="ident" id="6916553">Next</span><span class="op" id="6916557">(</span><span class="op" id="6916558">)</span>&nbsp;<span class="op" id="6916560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916564">rows</span><span class="op" id="6916568">.</span><span class="ident" id="6916569">Scan</span><span class="op" id="6916573">(</span><span class="op" id="6916574">&amp;</span><span class="ident" id="6916575">name</span><span class="op" id="6916579">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916585">rows</span><span class="op" id="6916589">.</span><span class="ident" id="6916590">Close</span><span class="op" id="6916595">(</span><span class="op" id="6916596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916599">return</span>&nbsp;<span class="ident" id="6916606">nil</span><br>
<span class="lineno"></span><span class="op" id="6916610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="6916613">type</span>&nbsp;<span class="ident" id="6916618">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="6916639">struct</span>&nbsp;<span class="op" id="6916646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916649">db</span>&nbsp;<span class="op" id="6916652">*</span><span class="ident" id="6916653">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916657">tx</span>&nbsp;<span class="op" id="6916660">*</span><span class="ident" id="6916661">Tx</span><br>
<span class="lineno"></span><span class="op" id="6916664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="6916667">func</span>&nbsp;<span class="op" id="6916672">(</span><span class="ident" id="6916673">c</span>&nbsp;<span class="op" id="6916675">*</span><span class="ident" id="6916676">concurrentTxExecTest</span><span class="op" id="6916696">)</span>&nbsp;<span class="ident" id="6916698">init</span><span class="op" id="6916702">(</span><span class="ident" id="6916703">t</span>&nbsp;<span class="ident" id="6916705">testing</span><span class="op" id="6916712">.</span><span class="ident" id="6916713">TB</span><span class="op" id="6916715">,</span>&nbsp;<span class="ident" id="6916717">db</span>&nbsp;<span class="op" id="6916720">*</span><span class="ident" id="6916721">DB</span><span class="op" id="6916723">)</span>&nbsp;<span class="op" id="6916725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916728">c</span><span class="op" id="6916729">.</span><span class="ident" id="6916730">db</span>&nbsp;<span class="op" id="6916733">=</span>&nbsp;<span class="ident" id="6916735">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916739">var</span>&nbsp;<span class="ident" id="6916743">err</span>&nbsp;<span class="builtintype" id="6916747">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916754">c</span><span class="op" id="6916755">.</span><span class="ident" id="6916756">tx</span><span class="op" id="6916758">,</span>&nbsp;<span class="ident" id="6916760">err</span>&nbsp;<span class="op" id="6916764">=</span>&nbsp;<span class="ident" id="6916766">c</span><span class="op" id="6916767">.</span><span class="ident" id="6916768">db</span><span class="op" id="6916770">.</span><span class="ident" id="6916771">Begin</span><span class="op" id="6916776">(</span><span class="op" id="6916777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916780">if</span>&nbsp;<span class="ident" id="6916783">err</span>&nbsp;<span class="op" id="6916787">!=</span>&nbsp;<span class="ident" id="6916790">nil</span>&nbsp;<span class="op" id="6916794">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916798">t</span><span class="op" id="6916799">.</span><span class="ident" id="6916800">Fatal</span><span class="op" id="6916805">(</span><span class="ident" id="6916806">err</span><span class="op" id="6916809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916812">}</span><br>
<span class="lineno"></span><span class="op" id="6916814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6916817">func</span>&nbsp;<span class="op" id="6916822">(</span><span class="ident" id="6916823">c</span>&nbsp;<span class="op" id="6916825">*</span><span class="ident" id="6916826">concurrentTxExecTest</span><span class="op" id="6916846">)</span>&nbsp;<span class="ident" id="6916848">finish</span><span class="op" id="6916854">(</span><span class="ident" id="6916855">t</span>&nbsp;<span class="ident" id="6916857">testing</span><span class="op" id="6916864">.</span><span class="ident" id="6916865">TB</span><span class="op" id="6916867">)</span>&nbsp;<span class="op" id="6916869">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6916872">if</span>&nbsp;<span class="ident" id="6916875">c</span><span class="op" id="6916876">.</span><span class="ident" id="6916877">tx</span>&nbsp;<span class="op" id="6916880">!=</span>&nbsp;<span class="ident" id="6916883">nil</span>&nbsp;<span class="op" id="6916887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916891">c</span><span class="op" id="6916892">.</span><span class="ident" id="6916893">tx</span><span class="op" id="6916895">.</span><span class="ident" id="6916896">Rollback</span><span class="op" id="6916904">(</span><span class="op" id="6916905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916909">c</span><span class="op" id="6916910">.</span><span class="ident" id="6916911">tx</span>&nbsp;<span class="op" id="6916914">=</span>&nbsp;<span class="ident" id="6916916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6916921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916924">c</span><span class="op" id="6916925">.</span><span class="ident" id="6916926">db</span>&nbsp;<span class="op" id="6916929">=</span>&nbsp;<span class="ident" id="6916931">nil</span><br>
<span class="lineno">1600</span><span class="op" id="6916935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6916938">func</span>&nbsp;<span class="op" id="6916943">(</span><span class="ident" id="6916944">c</span>&nbsp;<span class="op" id="6916946">*</span><span class="ident" id="6916947">concurrentTxExecTest</span><span class="op" id="6916967">)</span>&nbsp;<span class="ident" id="6916969">test</span><span class="op" id="6916973">(</span><span class="ident" id="6916974">t</span>&nbsp;<span class="ident" id="6916976">testing</span><span class="op" id="6916983">.</span><span class="ident" id="6916984">TB</span><span class="op" id="6916986">)</span>&nbsp;<span class="builtintype" id="6916988">error</span>&nbsp;<span class="op" id="6916994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6916997">_</span><span class="op" id="6916998">,</span>&nbsp;<span class="ident" id="6917000">err</span>&nbsp;<span class="op" id="6917004">:=</span>&nbsp;<span class="ident" id="6917007">c</span><span class="op" id="6917008">.</span><span class="ident" id="6917009">tx</span><span class="op" id="6917011">.</span><span class="ident" id="6917012">Exec</span><span class="op" id="6917016">(</span><span class="string" id="6917017">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6917070">,</span>&nbsp;<span class="num" id="6917072">3</span><span class="op" id="6917073">,</span>&nbsp;<span class="ident" id="6917075">chrisBirthday</span><span class="op" id="6917088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917091">if</span>&nbsp;<span class="ident" id="6917094">err</span>&nbsp;<span class="op" id="6917098">!=</span>&nbsp;<span class="ident" id="6917101">nil</span>&nbsp;<span class="op" id="6917105">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917109">t</span><span class="op" id="6917110">.</span><span class="ident" id="6917111">Error</span><span class="op" id="6917116">(</span><span class="ident" id="6917117">err</span><span class="op" id="6917120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917124">return</span>&nbsp;<span class="ident" id="6917131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917139">return</span>&nbsp;<span class="ident" id="6917146">nil</span><br>
<span class="lineno"></span><span class="op" id="6917150">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="6917153">type</span>&nbsp;<span class="ident" id="6917158">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="6917184">struct</span>&nbsp;<span class="op" id="6917191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917194">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6917199">*</span><span class="ident" id="6917200">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917204">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6917209">*</span><span class="ident" id="6917210">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917214">stmt</span>&nbsp;<span class="op" id="6917219">*</span><span class="ident" id="6917220">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="6917225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6917228">func</span>&nbsp;<span class="op" id="6917233">(</span><span class="ident" id="6917234">c</span>&nbsp;<span class="op" id="6917236">*</span><span class="ident" id="6917237">concurrentTxStmtQueryTest</span><span class="op" id="6917262">)</span>&nbsp;<span class="ident" id="6917264">init</span><span class="op" id="6917268">(</span><span class="ident" id="6917269">t</span>&nbsp;<span class="ident" id="6917271">testing</span><span class="op" id="6917278">.</span><span class="ident" id="6917279">TB</span><span class="op" id="6917281">,</span>&nbsp;<span class="ident" id="6917283">db</span>&nbsp;<span class="op" id="6917286">*</span><span class="ident" id="6917287">DB</span><span class="op" id="6917289">)</span>&nbsp;<span class="op" id="6917291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917294">c</span><span class="op" id="6917295">.</span><span class="ident" id="6917296">db</span>&nbsp;<span class="op" id="6917299">=</span>&nbsp;<span class="ident" id="6917301">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917305">var</span>&nbsp;<span class="ident" id="6917309">err</span>&nbsp;<span class="builtintype" id="6917313">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917320">c</span><span class="op" id="6917321">.</span><span class="ident" id="6917322">tx</span><span class="op" id="6917324">,</span>&nbsp;<span class="ident" id="6917326">err</span>&nbsp;<span class="op" id="6917330">=</span>&nbsp;<span class="ident" id="6917332">c</span><span class="op" id="6917333">.</span><span class="ident" id="6917334">db</span><span class="op" id="6917336">.</span><span class="ident" id="6917337">Begin</span><span class="op" id="6917342">(</span><span class="op" id="6917343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917346">if</span>&nbsp;<span class="ident" id="6917349">err</span>&nbsp;<span class="op" id="6917353">!=</span>&nbsp;<span class="ident" id="6917356">nil</span>&nbsp;<span class="op" id="6917360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917364">t</span><span class="op" id="6917365">.</span><span class="ident" id="6917366">Fatal</span><span class="op" id="6917371">(</span><span class="ident" id="6917372">err</span><span class="op" id="6917375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917381">c</span><span class="op" id="6917382">.</span><span class="ident" id="6917383">stmt</span><span class="op" id="6917387">,</span>&nbsp;<span class="ident" id="6917389">err</span>&nbsp;<span class="op" id="6917393">=</span>&nbsp;<span class="ident" id="6917395">c</span><span class="op" id="6917396">.</span><span class="ident" id="6917397">tx</span><span class="op" id="6917399">.</span><span class="ident" id="6917400">Prepare</span><span class="op" id="6917407">(</span><span class="string" id="6917408">&#34;SELECT|people|name|&#34;</span><span class="op" id="6917429">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917432">if</span>&nbsp;<span class="ident" id="6917435">err</span>&nbsp;<span class="op" id="6917439">!=</span>&nbsp;<span class="ident" id="6917442">nil</span>&nbsp;<span class="op" id="6917446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917450">t</span><span class="op" id="6917451">.</span><span class="ident" id="6917452">Fatal</span><span class="op" id="6917457">(</span><span class="ident" id="6917458">err</span><span class="op" id="6917461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917464">}</span><br>
<span class="lineno"></span><span class="op" id="6917466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="6917469">func</span>&nbsp;<span class="op" id="6917474">(</span><span class="ident" id="6917475">c</span>&nbsp;<span class="op" id="6917477">*</span><span class="ident" id="6917478">concurrentTxStmtQueryTest</span><span class="op" id="6917503">)</span>&nbsp;<span class="ident" id="6917505">finish</span><span class="op" id="6917511">(</span><span class="ident" id="6917512">t</span>&nbsp;<span class="ident" id="6917514">testing</span><span class="op" id="6917521">.</span><span class="ident" id="6917522">TB</span><span class="op" id="6917524">)</span>&nbsp;<span class="op" id="6917526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917529">if</span>&nbsp;<span class="ident" id="6917532">c</span><span class="op" id="6917533">.</span><span class="ident" id="6917534">stmt</span>&nbsp;<span class="op" id="6917539">!=</span>&nbsp;<span class="ident" id="6917542">nil</span>&nbsp;<span class="op" id="6917546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917550">c</span><span class="op" id="6917551">.</span><span class="ident" id="6917552">stmt</span><span class="op" id="6917556">.</span><span class="ident" id="6917557">Close</span><span class="op" id="6917562">(</span><span class="op" id="6917563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917567">c</span><span class="op" id="6917568">.</span><span class="ident" id="6917569">stmt</span>&nbsp;<span class="op" id="6917574">=</span>&nbsp;<span class="ident" id="6917576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917581">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917584">if</span>&nbsp;<span class="ident" id="6917587">c</span><span class="op" id="6917588">.</span><span class="ident" id="6917589">tx</span>&nbsp;<span class="op" id="6917592">!=</span>&nbsp;<span class="ident" id="6917595">nil</span>&nbsp;<span class="op" id="6917599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917603">c</span><span class="op" id="6917604">.</span><span class="ident" id="6917605">tx</span><span class="op" id="6917607">.</span><span class="ident" id="6917608">Rollback</span><span class="op" id="6917616">(</span><span class="op" id="6917617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917621">c</span><span class="op" id="6917622">.</span><span class="ident" id="6917623">tx</span>&nbsp;<span class="op" id="6917626">=</span>&nbsp;<span class="ident" id="6917628">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917636">c</span><span class="op" id="6917637">.</span><span class="ident" id="6917638">db</span>&nbsp;<span class="op" id="6917641">=</span>&nbsp;<span class="ident" id="6917643">nil</span><br>
<span class="lineno">1640</span><span class="op" id="6917647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6917650">func</span>&nbsp;<span class="op" id="6917655">(</span><span class="ident" id="6917656">c</span>&nbsp;<span class="op" id="6917658">*</span><span class="ident" id="6917659">concurrentTxStmtQueryTest</span><span class="op" id="6917684">)</span>&nbsp;<span class="ident" id="6917686">test</span><span class="op" id="6917690">(</span><span class="ident" id="6917691">t</span>&nbsp;<span class="ident" id="6917693">testing</span><span class="op" id="6917700">.</span><span class="ident" id="6917701">TB</span><span class="op" id="6917703">)</span>&nbsp;<span class="builtintype" id="6917705">error</span>&nbsp;<span class="op" id="6917711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917714">rows</span><span class="op" id="6917718">,</span>&nbsp;<span class="ident" id="6917720">err</span>&nbsp;<span class="op" id="6917724">:=</span>&nbsp;<span class="ident" id="6917727">c</span><span class="op" id="6917728">.</span><span class="ident" id="6917729">stmt</span><span class="op" id="6917733">.</span><span class="ident" id="6917734">Query</span><span class="op" id="6917739">(</span><span class="op" id="6917740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917743">if</span>&nbsp;<span class="ident" id="6917746">err</span>&nbsp;<span class="op" id="6917750">!=</span>&nbsp;<span class="ident" id="6917753">nil</span>&nbsp;<span class="op" id="6917757">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917761">t</span><span class="op" id="6917762">.</span><span class="ident" id="6917763">Errorf</span><span class="op" id="6917769">(</span><span class="string" id="6917770">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6917791">,</span>&nbsp;<span class="ident" id="6917793">err</span><span class="op" id="6917796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917800">return</span>&nbsp;<span class="ident" id="6917807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917816">var</span>&nbsp;<span class="ident" id="6917820">name</span>&nbsp;<span class="builtintype" id="6917825">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917833">for</span>&nbsp;<span class="ident" id="6917837">rows</span><span class="op" id="6917841">.</span><span class="ident" id="6917842">Next</span><span class="op" id="6917846">(</span><span class="op" id="6917847">)</span>&nbsp;<span class="op" id="6917849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917853">rows</span><span class="op" id="6917857">.</span><span class="ident" id="6917858">Scan</span><span class="op" id="6917862">(</span><span class="op" id="6917863">&amp;</span><span class="ident" id="6917864">name</span><span class="op" id="6917868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6917871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917874">rows</span><span class="op" id="6917878">.</span><span class="ident" id="6917879">Close</span><span class="op" id="6917884">(</span><span class="op" id="6917885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6917888">return</span>&nbsp;<span class="ident" id="6917895">nil</span><br>
<span class="lineno">1655</span><span class="op" id="6917899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6917902">type</span>&nbsp;<span class="ident" id="6917907">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="6917932">struct</span>&nbsp;<span class="op" id="6917939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917942">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6917947">*</span><span class="ident" id="6917948">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917952">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6917957">*</span><span class="ident" id="6917958">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6917962">stmt</span>&nbsp;<span class="op" id="6917967">*</span><span class="ident" id="6917968">Stmt</span><br>
<span class="lineno"></span><span class="op" id="6917973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6917976">func</span>&nbsp;<span class="op" id="6917981">(</span><span class="ident" id="6917982">c</span>&nbsp;<span class="op" id="6917984">*</span><span class="ident" id="6917985">concurrentTxStmtExecTest</span><span class="op" id="6918009">)</span>&nbsp;<span class="ident" id="6918011">init</span><span class="op" id="6918015">(</span><span class="ident" id="6918016">t</span>&nbsp;<span class="ident" id="6918018">testing</span><span class="op" id="6918025">.</span><span class="ident" id="6918026">TB</span><span class="op" id="6918028">,</span>&nbsp;<span class="ident" id="6918030">db</span>&nbsp;<span class="op" id="6918033">*</span><span class="ident" id="6918034">DB</span><span class="op" id="6918036">)</span>&nbsp;<span class="op" id="6918038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918041">c</span><span class="op" id="6918042">.</span><span class="ident" id="6918043">db</span>&nbsp;<span class="op" id="6918046">=</span>&nbsp;<span class="ident" id="6918048">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918052">var</span>&nbsp;<span class="ident" id="6918056">err</span>&nbsp;<span class="builtintype" id="6918060">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918067">c</span><span class="op" id="6918068">.</span><span class="ident" id="6918069">tx</span><span class="op" id="6918071">,</span>&nbsp;<span class="ident" id="6918073">err</span>&nbsp;<span class="op" id="6918077">=</span>&nbsp;<span class="ident" id="6918079">c</span><span class="op" id="6918080">.</span><span class="ident" id="6918081">db</span><span class="op" id="6918083">.</span><span class="ident" id="6918084">Begin</span><span class="op" id="6918089">(</span><span class="op" id="6918090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918093">if</span>&nbsp;<span class="ident" id="6918096">err</span>&nbsp;<span class="op" id="6918100">!=</span>&nbsp;<span class="ident" id="6918103">nil</span>&nbsp;<span class="op" id="6918107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918111">t</span><span class="op" id="6918112">.</span><span class="ident" id="6918113">Fatal</span><span class="op" id="6918118">(</span><span class="ident" id="6918119">err</span><span class="op" id="6918122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918125">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918128">c</span><span class="op" id="6918129">.</span><span class="ident" id="6918130">stmt</span><span class="op" id="6918134">,</span>&nbsp;<span class="ident" id="6918136">err</span>&nbsp;<span class="op" id="6918140">=</span>&nbsp;<span class="ident" id="6918142">c</span><span class="op" id="6918143">.</span><span class="ident" id="6918144">tx</span><span class="op" id="6918146">.</span><span class="ident" id="6918147">Prepare</span><span class="op" id="6918154">(</span><span class="string" id="6918155">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="6918208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918211">if</span>&nbsp;<span class="ident" id="6918214">err</span>&nbsp;<span class="op" id="6918218">!=</span>&nbsp;<span class="ident" id="6918221">nil</span>&nbsp;<span class="op" id="6918225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918229">t</span><span class="op" id="6918230">.</span><span class="ident" id="6918231">Fatal</span><span class="op" id="6918236">(</span><span class="ident" id="6918237">err</span><span class="op" id="6918240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918243">}</span><br>
<span class="lineno"></span><span class="op" id="6918245">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="6918248">func</span>&nbsp;<span class="op" id="6918253">(</span><span class="ident" id="6918254">c</span>&nbsp;<span class="op" id="6918256">*</span><span class="ident" id="6918257">concurrentTxStmtExecTest</span><span class="op" id="6918281">)</span>&nbsp;<span class="ident" id="6918283">finish</span><span class="op" id="6918289">(</span><span class="ident" id="6918290">t</span>&nbsp;<span class="ident" id="6918292">testing</span><span class="op" id="6918299">.</span><span class="ident" id="6918300">TB</span><span class="op" id="6918302">)</span>&nbsp;<span class="op" id="6918304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918307">if</span>&nbsp;<span class="ident" id="6918310">c</span><span class="op" id="6918311">.</span><span class="ident" id="6918312">stmt</span>&nbsp;<span class="op" id="6918317">!=</span>&nbsp;<span class="ident" id="6918320">nil</span>&nbsp;<span class="op" id="6918324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918328">c</span><span class="op" id="6918329">.</span><span class="ident" id="6918330">stmt</span><span class="op" id="6918334">.</span><span class="ident" id="6918335">Close</span><span class="op" id="6918340">(</span><span class="op" id="6918341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918345">c</span><span class="op" id="6918346">.</span><span class="ident" id="6918347">stmt</span>&nbsp;<span class="op" id="6918352">=</span>&nbsp;<span class="ident" id="6918354">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918362">if</span>&nbsp;<span class="ident" id="6918365">c</span><span class="op" id="6918366">.</span><span class="ident" id="6918367">tx</span>&nbsp;<span class="op" id="6918370">!=</span>&nbsp;<span class="ident" id="6918373">nil</span>&nbsp;<span class="op" id="6918377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918381">c</span><span class="op" id="6918382">.</span><span class="ident" id="6918383">tx</span><span class="op" id="6918385">.</span><span class="ident" id="6918386">Rollback</span><span class="op" id="6918394">(</span><span class="op" id="6918395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918399">c</span><span class="op" id="6918400">.</span><span class="ident" id="6918401">tx</span>&nbsp;<span class="op" id="6918404">=</span>&nbsp;<span class="ident" id="6918406">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918411">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918414">c</span><span class="op" id="6918415">.</span><span class="ident" id="6918416">db</span>&nbsp;<span class="op" id="6918419">=</span>&nbsp;<span class="ident" id="6918421">nil</span><br>
<span class="lineno"></span><span class="op" id="6918425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6918428">func</span>&nbsp;<span class="op" id="6918433">(</span><span class="ident" id="6918434">c</span>&nbsp;<span class="op" id="6918436">*</span><span class="ident" id="6918437">concurrentTxStmtExecTest</span><span class="op" id="6918461">)</span>&nbsp;<span class="ident" id="6918463">test</span><span class="op" id="6918467">(</span><span class="ident" id="6918468">t</span>&nbsp;<span class="ident" id="6918470">testing</span><span class="op" id="6918477">.</span><span class="ident" id="6918478">TB</span><span class="op" id="6918480">)</span>&nbsp;<span class="builtintype" id="6918482">error</span>&nbsp;<span class="op" id="6918488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918491">_</span><span class="op" id="6918492">,</span>&nbsp;<span class="ident" id="6918494">err</span>&nbsp;<span class="op" id="6918498">:=</span>&nbsp;<span class="ident" id="6918501">c</span><span class="op" id="6918502">.</span><span class="ident" id="6918503">stmt</span><span class="op" id="6918507">.</span><span class="ident" id="6918508">Exec</span><span class="op" id="6918512">(</span><span class="num" id="6918513">3</span><span class="op" id="6918514">,</span>&nbsp;<span class="ident" id="6918516">chrisBirthday</span><span class="op" id="6918529">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918532">if</span>&nbsp;<span class="ident" id="6918535">err</span>&nbsp;<span class="op" id="6918539">!=</span>&nbsp;<span class="ident" id="6918542">nil</span>&nbsp;<span class="op" id="6918546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918550">t</span><span class="op" id="6918551">.</span><span class="ident" id="6918552">Errorf</span><span class="op" id="6918558">(</span><span class="string" id="6918559">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6918579">,</span>&nbsp;<span class="ident" id="6918581">err</span><span class="op" id="6918584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918588">return</span>&nbsp;<span class="ident" id="6918595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6918600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6918603">return</span>&nbsp;<span class="ident" id="6918610">nil</span><br>
<span class="lineno">1695</span><span class="op" id="6918614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6918617">type</span>&nbsp;<span class="ident" id="6918622">concurrentRandomTest</span>&nbsp;<span class="keyword" id="6918643">struct</span>&nbsp;<span class="op" id="6918650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918653">tests</span>&nbsp;<span class="op" id="6918659">[</span><span class="op" id="6918660">]</span><span class="ident" id="6918661">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="6918676">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="6918679">func</span>&nbsp;<span class="op" id="6918684">(</span><span class="ident" id="6918685">c</span>&nbsp;<span class="op" id="6918687">*</span><span class="ident" id="6918688">concurrentRandomTest</span><span class="op" id="6918708">)</span>&nbsp;<span class="ident" id="6918710">init</span><span class="op" id="6918714">(</span><span class="ident" id="6918715">t</span>&nbsp;<span class="ident" id="6918717">testing</span><span class="op" id="6918724">.</span><span class="ident" id="6918725">TB</span><span class="op" id="6918727">,</span>&nbsp;<span class="ident" id="6918729">db</span>&nbsp;<span class="op" id="6918732">*</span><span class="ident" id="6918733">DB</span><span class="op" id="6918735">)</span>&nbsp;<span class="op" id="6918737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6918740">c</span><span class="op" id="6918741">.</span><span class="ident" id="6918742">tests</span>&nbsp;<span class="op" id="6918748">=</span>&nbsp;<span class="op" id="6918750">[</span><span class="op" id="6918751">]</span><span class="ident" id="6918752">concurrentTest</span><span class="op" id="6918766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918770">new</span><span class="op" id="6918773">(</span><span class="ident" id="6918774">concurrentDBQueryTest</span><span class="op" id="6918795">)</span><span class="op" id="6918796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918800">new</span><span class="op" id="6918803">(</span><span class="ident" id="6918804">concurrentDBExecTest</span><span class="op" id="6918824">)</span><span class="op" id="6918825">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918829">new</span><span class="op" id="6918832">(</span><span class="ident" id="6918833">concurrentStmtQueryTest</span><span class="op" id="6918856">)</span><span class="op" id="6918857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918861">new</span><span class="op" id="6918864">(</span><span class="ident" id="6918865">concurrentStmtExecTest</span><span class="op" id="6918887">)</span><span class="op" id="6918888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918892">new</span><span class="op" id="6918895">(</span><span class="ident" id="6918896">concurrentTxQueryTest</span><span class="op" id="6918917">)</span><span class="op" id="6918918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918922">new</span><span class="op" id="6918925">(</span><span class="ident" id="6918926">concurrentTxExecTest</span><span class="op" id="6918946">)</span><span class="op" id="6918947">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918951">new</span><span class="op" id="6918954">(</span><span class="ident" id="6918955">concurrentTxStmtQueryTest</span><span class="op" id="6918980">)</span><span class="op" id="6918981">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6918985">new</span><span class="op" id="6918988">(</span><span class="ident" id="6918989">concurrentTxStmtExecTest</span><span class="op" id="6919013">)</span><span class="op" id="6919014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919020">for</span>&nbsp;<span class="ident" id="6919024">_</span><span class="op" id="6919025">,</span>&nbsp;<span class="ident" id="6919027">ct</span>&nbsp;<span class="op" id="6919030">:=</span>&nbsp;<span class="keyword" id="6919033">range</span>&nbsp;<span class="ident" id="6919039">c</span><span class="op" id="6919040">.</span><span class="ident" id="6919041">tests</span>&nbsp;<span class="op" id="6919047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919051">ct</span><span class="op" id="6919053">.</span><span class="ident" id="6919054">init</span><span class="op" id="6919058">(</span><span class="ident" id="6919059">t</span><span class="op" id="6919060">,</span>&nbsp;<span class="ident" id="6919062">db</span><span class="op" id="6919064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919067">}</span><br>
<span class="lineno">1715</span><span class="op" id="6919069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6919072">func</span>&nbsp;<span class="op" id="6919077">(</span><span class="ident" id="6919078">c</span>&nbsp;<span class="op" id="6919080">*</span><span class="ident" id="6919081">concurrentRandomTest</span><span class="op" id="6919101">)</span>&nbsp;<span class="ident" id="6919103">finish</span><span class="op" id="6919109">(</span><span class="ident" id="6919110">t</span>&nbsp;<span class="ident" id="6919112">testing</span><span class="op" id="6919119">.</span><span class="ident" id="6919120">TB</span><span class="op" id="6919122">)</span>&nbsp;<span class="op" id="6919124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919127">for</span>&nbsp;<span class="ident" id="6919131">_</span><span class="op" id="6919132">,</span>&nbsp;<span class="ident" id="6919134">ct</span>&nbsp;<span class="op" id="6919137">:=</span>&nbsp;<span class="keyword" id="6919140">range</span>&nbsp;<span class="ident" id="6919146">c</span><span class="op" id="6919147">.</span><span class="ident" id="6919148">tests</span>&nbsp;<span class="op" id="6919154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919158">ct</span><span class="op" id="6919160">.</span><span class="ident" id="6919161">finish</span><span class="op" id="6919167">(</span><span class="ident" id="6919168">t</span><span class="op" id="6919169">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919172">}</span><br>
<span class="lineno"></span><span class="op" id="6919174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6919177">func</span>&nbsp;<span class="op" id="6919182">(</span><span class="ident" id="6919183">c</span>&nbsp;<span class="op" id="6919185">*</span><span class="ident" id="6919186">concurrentRandomTest</span><span class="op" id="6919206">)</span>&nbsp;<span class="ident" id="6919208">test</span><span class="op" id="6919212">(</span><span class="ident" id="6919213">t</span>&nbsp;<span class="ident" id="6919215">testing</span><span class="op" id="6919222">.</span><span class="ident" id="6919223">TB</span><span class="op" id="6919225">)</span>&nbsp;<span class="builtintype" id="6919227">error</span>&nbsp;<span class="op" id="6919233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919236">ct</span>&nbsp;<span class="op" id="6919239">:=</span>&nbsp;<span class="ident" id="6919242">c</span><span class="op" id="6919243">.</span><span class="ident" id="6919244">tests</span><span class="op" id="6919249">[</span><span class="ident" id="6919250">rand</span><span class="op" id="6919254">.</span><span class="ident" id="6919255">Intn</span><span class="op" id="6919259">(</span><span class="builtinfunc" id="6919260">len</span><span class="op" id="6919263">(</span><span class="ident" id="6919264">c</span><span class="op" id="6919265">.</span><span class="ident" id="6919266">tests</span><span class="op" id="6919271">)</span><span class="op" id="6919272">)</span><span class="op" id="6919273">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919276">return</span>&nbsp;<span class="ident" id="6919283">ct</span><span class="op" id="6919285">.</span><span class="ident" id="6919286">test</span><span class="op" id="6919290">(</span><span class="ident" id="6919291">t</span><span class="op" id="6919292">)</span><br>
<span class="lineno"></span><span class="op" id="6919294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6919297">func</span>&nbsp;<span class="ident" id="6919302">doConcurrentTest</span><span class="op" id="6919318">(</span><span class="ident" id="6919319">t</span>&nbsp;<span class="ident" id="6919321">testing</span><span class="op" id="6919328">.</span><span class="ident" id="6919329">TB</span><span class="op" id="6919331">,</span>&nbsp;<span class="ident" id="6919333">ct</span>&nbsp;<span class="ident" id="6919336">concurrentTest</span><span class="op" id="6919350">)</span>&nbsp;<span class="op" id="6919352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919355">maxProcs</span><span class="op" id="6919363">,</span>&nbsp;<span class="ident" id="6919365">numReqs</span>&nbsp;<span class="op" id="6919373">:=</span>&nbsp;<span class="num" id="6919376">1</span><span class="op" id="6919377">,</span>&nbsp;<span class="num" id="6919379">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919384">if</span>&nbsp;<span class="ident" id="6919387">testing</span><span class="op" id="6919394">.</span><span class="ident" id="6919395">Short</span><span class="op" id="6919400">(</span><span class="op" id="6919401">)</span>&nbsp;<span class="op" id="6919403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919407">maxProcs</span><span class="op" id="6919415">,</span>&nbsp;<span class="ident" id="6919417">numReqs</span>&nbsp;<span class="op" id="6919425">=</span>&nbsp;<span class="num" id="6919427">4</span><span class="op" id="6919428">,</span>&nbsp;<span class="num" id="6919430">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919437">defer</span>&nbsp;<span class="ident" id="6919443">runtime</span><span class="op" id="6919450">.</span><span class="ident" id="6919451">GOMAXPROCS</span><span class="op" id="6919461">(</span><span class="ident" id="6919462">runtime</span><span class="op" id="6919469">.</span><span class="ident" id="6919470">GOMAXPROCS</span><span class="op" id="6919480">(</span><span class="ident" id="6919481">maxProcs</span><span class="op" id="6919489">)</span><span class="op" id="6919490">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919494">db</span>&nbsp;<span class="op" id="6919497">:=</span>&nbsp;<span class="ident" id="6919500">newTestDB</span><span class="op" id="6919509">(</span><span class="ident" id="6919510">t</span><span class="op" id="6919511">,</span>&nbsp;<span class="string" id="6919513">&#34;people&#34;</span><span class="op" id="6919521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919524">defer</span>&nbsp;<span class="ident" id="6919530">closeDB</span><span class="op" id="6919537">(</span><span class="ident" id="6919538">t</span><span class="op" id="6919539">,</span>&nbsp;<span class="ident" id="6919541">db</span><span class="op" id="6919543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919547">ct</span><span class="op" id="6919549">.</span><span class="ident" id="6919550">init</span><span class="op" id="6919554">(</span><span class="ident" id="6919555">t</span><span class="op" id="6919556">,</span>&nbsp;<span class="ident" id="6919558">db</span><span class="op" id="6919560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919563">defer</span>&nbsp;<span class="ident" id="6919569">ct</span><span class="op" id="6919571">.</span><span class="ident" id="6919572">finish</span><span class="op" id="6919578">(</span><span class="ident" id="6919579">t</span><span class="op" id="6919580">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919584">var</span>&nbsp;<span class="ident" id="6919588">wg</span>&nbsp;<span class="ident" id="6919591">sync</span><span class="op" id="6919595">.</span><span class="ident" id="6919596">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919607">wg</span><span class="op" id="6919609">.</span><span class="ident" id="6919610">Add</span><span class="op" id="6919613">(</span><span class="ident" id="6919614">numReqs</span><span class="op" id="6919621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919625">reqs</span>&nbsp;<span class="op" id="6919630">:=</span>&nbsp;<span class="builtinfunc" id="6919633">make</span><span class="op" id="6919637">(</span><span class="keyword" id="6919638">chan</span>&nbsp;<span class="builtintype" id="6919643">bool</span><span class="op" id="6919647">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919650">defer</span>&nbsp;<span class="builtinfunc" id="6919656">close</span><span class="op" id="6919661">(</span><span class="ident" id="6919662">reqs</span><span class="op" id="6919666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919670">for</span>&nbsp;<span class="ident" id="6919674">i</span>&nbsp;<span class="op" id="6919676">:=</span>&nbsp;<span class="num" id="6919679">0</span><span class="op" id="6919680">;</span>&nbsp;<span class="ident" id="6919682">i</span>&nbsp;<span class="op" id="6919684">&lt;</span>&nbsp;<span class="ident" id="6919686">maxProcs</span><span class="op" id="6919694">*</span><span class="num" id="6919695">2</span><span class="op" id="6919696">;</span>&nbsp;<span class="ident" id="6919698">i</span><span class="op" id="6919699">++</span>&nbsp;<span class="op" id="6919702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919706">go</span>&nbsp;<span class="keyword" id="6919709">func</span><span class="op" id="6919713">(</span><span class="op" id="6919714">)</span>&nbsp;<span class="op" id="6919716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919721">for</span>&nbsp;<span class="keyword" id="6919725">range</span>&nbsp;<span class="ident" id="6919731">reqs</span>&nbsp;<span class="op" id="6919736">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919742">err</span>&nbsp;<span class="op" id="6919746">:=</span>&nbsp;<span class="ident" id="6919749">ct</span><span class="op" id="6919751">.</span><span class="ident" id="6919752">test</span><span class="op" id="6919756">(</span><span class="ident" id="6919757">t</span><span class="op" id="6919758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919764">if</span>&nbsp;<span class="ident" id="6919767">err</span>&nbsp;<span class="op" id="6919771">!=</span>&nbsp;<span class="ident" id="6919774">nil</span>&nbsp;<span class="op" id="6919778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919785">wg</span><span class="op" id="6919787">.</span><span class="ident" id="6919788">Done</span><span class="op" id="6919792">(</span><span class="op" id="6919793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919800">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919813">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919819">wg</span><span class="op" id="6919821">.</span><span class="ident" id="6919822">Done</span><span class="op" id="6919826">(</span><span class="op" id="6919827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919836">}</span><span class="op" id="6919837">(</span><span class="op" id="6919838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919845">for</span>&nbsp;<span class="ident" id="6919849">i</span>&nbsp;<span class="op" id="6919851">:=</span>&nbsp;<span class="num" id="6919854">0</span><span class="op" id="6919855">;</span>&nbsp;<span class="ident" id="6919857">i</span>&nbsp;<span class="op" id="6919859">&lt;</span>&nbsp;<span class="ident" id="6919861">numReqs</span><span class="op" id="6919868">;</span>&nbsp;<span class="ident" id="6919870">i</span><span class="op" id="6919871">++</span>&nbsp;<span class="op" id="6919874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919878">reqs</span>&nbsp;<span class="op" id="6919883">&lt;-</span>&nbsp;<span class="builtintype" id="6919886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6919892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919896">wg</span><span class="op" id="6919898">.</span><span class="ident" id="6919899">Wait</span><span class="op" id="6919903">(</span><span class="op" id="6919904">)</span><br>
<span class="lineno">1765</span><span class="op" id="6919906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6919909">func</span>&nbsp;<span class="ident" id="6919914">manyConcurrentQueries</span><span class="op" id="6919935">(</span><span class="ident" id="6919936">t</span>&nbsp;<span class="ident" id="6919938">testing</span><span class="op" id="6919945">.</span><span class="ident" id="6919946">TB</span><span class="op" id="6919948">)</span>&nbsp;<span class="op" id="6919950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6919953">maxProcs</span><span class="op" id="6919961">,</span>&nbsp;<span class="ident" id="6919963">numReqs</span>&nbsp;<span class="op" id="6919971">:=</span>&nbsp;<span class="num" id="6919974">16</span><span class="op" id="6919976">,</span>&nbsp;<span class="num" id="6919978">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6919983">if</span>&nbsp;<span class="ident" id="6919986">testing</span><span class="op" id="6919993">.</span><span class="ident" id="6919994">Short</span><span class="op" id="6919999">(</span><span class="op" id="6920000">)</span>&nbsp;<span class="op" id="6920002">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920006">maxProcs</span><span class="op" id="6920014">,</span>&nbsp;<span class="ident" id="6920016">numReqs</span>&nbsp;<span class="op" id="6920024">=</span>&nbsp;<span class="num" id="6920026">4</span><span class="op" id="6920027">,</span>&nbsp;<span class="num" id="6920029">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920036">defer</span>&nbsp;<span class="ident" id="6920042">runtime</span><span class="op" id="6920049">.</span><span class="ident" id="6920050">GOMAXPROCS</span><span class="op" id="6920060">(</span><span class="ident" id="6920061">runtime</span><span class="op" id="6920068">.</span><span class="ident" id="6920069">GOMAXPROCS</span><span class="op" id="6920079">(</span><span class="ident" id="6920080">maxProcs</span><span class="op" id="6920088">)</span><span class="op" id="6920089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920093">db</span>&nbsp;<span class="op" id="6920096">:=</span>&nbsp;<span class="ident" id="6920099">newTestDB</span><span class="op" id="6920108">(</span><span class="ident" id="6920109">t</span><span class="op" id="6920110">,</span>&nbsp;<span class="string" id="6920112">&#34;people&#34;</span><span class="op" id="6920120">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920123">defer</span>&nbsp;<span class="ident" id="6920129">closeDB</span><span class="op" id="6920136">(</span><span class="ident" id="6920137">t</span><span class="op" id="6920138">,</span>&nbsp;<span class="ident" id="6920140">db</span><span class="op" id="6920142">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920146">stmt</span><span class="op" id="6920150">,</span>&nbsp;<span class="ident" id="6920152">err</span>&nbsp;<span class="op" id="6920156">:=</span>&nbsp;<span class="ident" id="6920159">db</span><span class="op" id="6920161">.</span><span class="ident" id="6920162">Prepare</span><span class="op" id="6920169">(</span><span class="string" id="6920170">&#34;SELECT|people|name|&#34;</span><span class="op" id="6920191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920194">if</span>&nbsp;<span class="ident" id="6920197">err</span>&nbsp;<span class="op" id="6920201">!=</span>&nbsp;<span class="ident" id="6920204">nil</span>&nbsp;<span class="op" id="6920208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920212">t</span><span class="op" id="6920213">.</span><span class="ident" id="6920214">Fatal</span><span class="op" id="6920219">(</span><span class="ident" id="6920220">err</span><span class="op" id="6920223">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920229">defer</span>&nbsp;<span class="ident" id="6920235">stmt</span><span class="op" id="6920239">.</span><span class="ident" id="6920240">Close</span><span class="op" id="6920245">(</span><span class="op" id="6920246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920250">var</span>&nbsp;<span class="ident" id="6920254">wg</span>&nbsp;<span class="ident" id="6920257">sync</span><span class="op" id="6920261">.</span><span class="ident" id="6920262">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920273">wg</span><span class="op" id="6920275">.</span><span class="ident" id="6920276">Add</span><span class="op" id="6920279">(</span><span class="ident" id="6920280">numReqs</span><span class="op" id="6920287">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920291">reqs</span>&nbsp;<span class="op" id="6920296">:=</span>&nbsp;<span class="builtinfunc" id="6920299">make</span><span class="op" id="6920303">(</span><span class="keyword" id="6920304">chan</span>&nbsp;<span class="builtintype" id="6920309">bool</span><span class="op" id="6920313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920316">defer</span>&nbsp;<span class="builtinfunc" id="6920322">close</span><span class="op" id="6920327">(</span><span class="ident" id="6920328">reqs</span><span class="op" id="6920332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920336">for</span>&nbsp;<span class="ident" id="6920340">i</span>&nbsp;<span class="op" id="6920342">:=</span>&nbsp;<span class="num" id="6920345">0</span><span class="op" id="6920346">;</span>&nbsp;<span class="ident" id="6920348">i</span>&nbsp;<span class="op" id="6920350">&lt;</span>&nbsp;<span class="ident" id="6920352">maxProcs</span><span class="op" id="6920360">*</span><span class="num" id="6920361">2</span><span class="op" id="6920362">;</span>&nbsp;<span class="ident" id="6920364">i</span><span class="op" id="6920365">++</span>&nbsp;<span class="op" id="6920368">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920372">go</span>&nbsp;<span class="keyword" id="6920375">func</span><span class="op" id="6920379">(</span><span class="op" id="6920380">)</span>&nbsp;<span class="op" id="6920382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920387">for</span>&nbsp;<span class="keyword" id="6920391">range</span>&nbsp;<span class="ident" id="6920397">reqs</span>&nbsp;<span class="op" id="6920402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920408">rows</span><span class="op" id="6920412">,</span>&nbsp;<span class="ident" id="6920414">err</span>&nbsp;<span class="op" id="6920418">:=</span>&nbsp;<span class="ident" id="6920421">stmt</span><span class="op" id="6920425">.</span><span class="ident" id="6920426">Query</span><span class="op" id="6920431">(</span><span class="op" id="6920432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920438">if</span>&nbsp;<span class="ident" id="6920441">err</span>&nbsp;<span class="op" id="6920445">!=</span>&nbsp;<span class="ident" id="6920448">nil</span>&nbsp;<span class="op" id="6920452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920459">t</span><span class="op" id="6920460">.</span><span class="ident" id="6920461">Errorf</span><span class="op" id="6920467">(</span><span class="string" id="6920468">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="6920489">,</span>&nbsp;<span class="ident" id="6920491">err</span><span class="op" id="6920494">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920501">wg</span><span class="op" id="6920503">.</span><span class="ident" id="6920504">Done</span><span class="op" id="6920508">(</span><span class="op" id="6920509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920516">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920536">var</span>&nbsp;<span class="ident" id="6920540">name</span>&nbsp;<span class="builtintype" id="6920545">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920556">for</span>&nbsp;<span class="ident" id="6920560">rows</span><span class="op" id="6920564">.</span><span class="ident" id="6920565">Next</span><span class="op" id="6920569">(</span><span class="op" id="6920570">)</span>&nbsp;<span class="op" id="6920572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920579">rows</span><span class="op" id="6920583">.</span><span class="ident" id="6920584">Scan</span><span class="op" id="6920588">(</span><span class="op" id="6920589">&amp;</span><span class="ident" id="6920590">name</span><span class="op" id="6920594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920606">rows</span><span class="op" id="6920610">.</span><span class="ident" id="6920611">Close</span><span class="op" id="6920616">(</span><span class="op" id="6920617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920624">wg</span><span class="op" id="6920626">.</span><span class="ident" id="6920627">Done</span><span class="op" id="6920631">(</span><span class="op" id="6920632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920641">}</span><span class="op" id="6920642">(</span><span class="op" id="6920643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920650">for</span>&nbsp;<span class="ident" id="6920654">i</span>&nbsp;<span class="op" id="6920656">:=</span>&nbsp;<span class="num" id="6920659">0</span><span class="op" id="6920660">;</span>&nbsp;<span class="ident" id="6920662">i</span>&nbsp;<span class="op" id="6920664">&lt;</span>&nbsp;<span class="ident" id="6920666">numReqs</span><span class="op" id="6920673">;</span>&nbsp;<span class="ident" id="6920675">i</span><span class="op" id="6920676">++</span>&nbsp;<span class="op" id="6920679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920683">reqs</span>&nbsp;<span class="op" id="6920688">&lt;-</span>&nbsp;<span class="builtintype" id="6920691">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6920697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920701">wg</span><span class="op" id="6920703">.</span><span class="ident" id="6920704">Wait</span><span class="op" id="6920708">(</span><span class="op" id="6920709">)</span><br>
<span class="lineno">1815</span><span class="op" id="6920711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6920714">func</span>&nbsp;<span class="ident" id="6920719">TestIssue6081</span><span class="op" id="6920732">(</span><span class="ident" id="6920733">t</span>&nbsp;<span class="op" id="6920735">*</span><span class="ident" id="6920736">testing</span><span class="op" id="6920743">.</span><span class="ident" id="6920744">T</span><span class="op" id="6920745">)</span>&nbsp;<span class="op" id="6920747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920750">db</span>&nbsp;<span class="op" id="6920753">:=</span>&nbsp;<span class="ident" id="6920756">newTestDB</span><span class="op" id="6920765">(</span><span class="ident" id="6920766">t</span><span class="op" id="6920767">,</span>&nbsp;<span class="string" id="6920769">&#34;people&#34;</span><span class="op" id="6920777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920780">defer</span>&nbsp;<span class="ident" id="6920786">closeDB</span><span class="op" id="6920793">(</span><span class="ident" id="6920794">t</span><span class="op" id="6920795">,</span>&nbsp;<span class="ident" id="6920797">db</span><span class="op" id="6920799">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920803">drv</span>&nbsp;<span class="op" id="6920807">:=</span>&nbsp;<span class="ident" id="6920810">db</span><span class="op" id="6920812">.</span><span class="ident" id="6920813">driver</span><span class="op" id="6920819">.</span><span class="op" id="6920820">(</span><span class="op" id="6920821">*</span><span class="ident" id="6920822">fakeDriver</span><span class="op" id="6920832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920835">drv</span><span class="op" id="6920838">.</span><span class="ident" id="6920839">mu</span><span class="op" id="6920841">.</span><span class="ident" id="6920842">Lock</span><span class="op" id="6920846">(</span><span class="op" id="6920847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920850">opens0</span>&nbsp;<span class="op" id="6920857">:=</span>&nbsp;<span class="ident" id="6920860">drv</span><span class="op" id="6920863">.</span><span class="ident" id="6920864">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920875">closes0</span>&nbsp;<span class="op" id="6920883">:=</span>&nbsp;<span class="ident" id="6920886">drv</span><span class="op" id="6920889">.</span><span class="ident" id="6920890">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920902">drv</span><span class="op" id="6920905">.</span><span class="ident" id="6920906">mu</span><span class="op" id="6920908">.</span><span class="ident" id="6920909">Unlock</span><span class="op" id="6920915">(</span><span class="op" id="6920916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920920">stmt</span><span class="op" id="6920924">,</span>&nbsp;<span class="ident" id="6920926">err</span>&nbsp;<span class="op" id="6920930">:=</span>&nbsp;<span class="ident" id="6920933">db</span><span class="op" id="6920935">.</span><span class="ident" id="6920936">Prepare</span><span class="op" id="6920943">(</span><span class="string" id="6920944">&#34;SELECT|people|name|&#34;</span><span class="op" id="6920965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6920968">if</span>&nbsp;<span class="ident" id="6920971">err</span>&nbsp;<span class="op" id="6920975">!=</span>&nbsp;<span class="ident" id="6920978">nil</span>&nbsp;<span class="op" id="6920982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6920986">t</span><span class="op" id="6920987">.</span><span class="ident" id="6920988">Fatal</span><span class="op" id="6920993">(</span><span class="ident" id="6920994">err</span><span class="op" id="6920997">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921003">rowsCloseHook</span>&nbsp;<span class="op" id="6921017">=</span>&nbsp;<span class="keyword" id="6921019">func</span><span class="op" id="6921023">(</span><span class="ident" id="6921024">rows</span>&nbsp;<span class="op" id="6921029">*</span><span class="ident" id="6921030">Rows</span><span class="op" id="6921034">,</span>&nbsp;<span class="ident" id="6921036">err</span>&nbsp;<span class="op" id="6921040">*</span><span class="builtintype" id="6921041">error</span><span class="op" id="6921046">)</span>&nbsp;<span class="op" id="6921048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921052">*</span><span class="ident" id="6921053">err</span>&nbsp;<span class="op" id="6921057">=</span>&nbsp;<span class="ident" id="6921059">driver</span><span class="op" id="6921065">.</span><span class="ident" id="6921066">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921081">defer</span>&nbsp;<span class="keyword" id="6921087">func</span><span class="op" id="6921091">(</span><span class="op" id="6921092">)</span>&nbsp;<span class="op" id="6921094">{</span>&nbsp;<span class="ident" id="6921096">rowsCloseHook</span>&nbsp;<span class="op" id="6921110">=</span>&nbsp;<span class="ident" id="6921112">nil</span>&nbsp;<span class="op" id="6921116">}</span><span class="op" id="6921117">(</span><span class="op" id="6921118">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921121">for</span>&nbsp;<span class="ident" id="6921125">i</span>&nbsp;<span class="op" id="6921127">:=</span>&nbsp;<span class="num" id="6921130">0</span><span class="op" id="6921131">;</span>&nbsp;<span class="ident" id="6921133">i</span>&nbsp;<span class="op" id="6921135">&lt;</span>&nbsp;<span class="num" id="6921137">10</span><span class="op" id="6921139">;</span>&nbsp;<span class="ident" id="6921141">i</span><span class="op" id="6921142">++</span>&nbsp;<span class="op" id="6921145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921149">rows</span><span class="op" id="6921153">,</span>&nbsp;<span class="ident" id="6921155">err</span>&nbsp;<span class="op" id="6921159">:=</span>&nbsp;<span class="ident" id="6921162">stmt</span><span class="op" id="6921166">.</span><span class="ident" id="6921167">Query</span><span class="op" id="6921172">(</span><span class="op" id="6921173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921177">if</span>&nbsp;<span class="ident" id="6921180">err</span>&nbsp;<span class="op" id="6921184">!=</span>&nbsp;<span class="ident" id="6921187">nil</span>&nbsp;<span class="op" id="6921191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921196">t</span><span class="op" id="6921197">.</span><span class="ident" id="6921198">Fatal</span><span class="op" id="6921203">(</span><span class="ident" id="6921204">err</span><span class="op" id="6921207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921211">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921215">rows</span><span class="op" id="6921219">.</span><span class="ident" id="6921220">Close</span><span class="op" id="6921225">(</span><span class="op" id="6921226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921232">if</span>&nbsp;<span class="ident" id="6921235">n</span>&nbsp;<span class="op" id="6921237">:=</span>&nbsp;<span class="builtinfunc" id="6921240">len</span><span class="op" id="6921243">(</span><span class="ident" id="6921244">stmt</span><span class="op" id="6921248">.</span><span class="ident" id="6921249">css</span><span class="op" id="6921252">)</span><span class="op" id="6921253">;</span>&nbsp;<span class="ident" id="6921255">n</span>&nbsp;<span class="op" id="6921257">&gt;</span>&nbsp;<span class="num" id="6921259">1</span>&nbsp;<span class="op" id="6921261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921265">t</span><span class="op" id="6921266">.</span><span class="ident" id="6921267">Errorf</span><span class="op" id="6921273">(</span><span class="string" id="6921274">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="6921306">,</span>&nbsp;<span class="ident" id="6921308">n</span><span class="op" id="6921309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921312">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921315">stmt</span><span class="op" id="6921319">.</span><span class="ident" id="6921320">Close</span><span class="op" id="6921325">(</span><span class="op" id="6921326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921329">if</span>&nbsp;<span class="ident" id="6921332">n</span>&nbsp;<span class="op" id="6921334">:=</span>&nbsp;<span class="builtinfunc" id="6921337">len</span><span class="op" id="6921340">(</span><span class="ident" id="6921341">stmt</span><span class="op" id="6921345">.</span><span class="ident" id="6921346">css</span><span class="op" id="6921349">)</span><span class="op" id="6921350">;</span>&nbsp;<span class="ident" id="6921352">n</span>&nbsp;<span class="op" id="6921354">!=</span>&nbsp;<span class="num" id="6921357">0</span>&nbsp;<span class="op" id="6921359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921363">t</span><span class="op" id="6921364">.</span><span class="ident" id="6921365">Errorf</span><span class="op" id="6921371">(</span><span class="string" id="6921372">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="6921413">,</span>&nbsp;<span class="ident" id="6921415">n</span><span class="op" id="6921416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921423">drv</span><span class="op" id="6921426">.</span><span class="ident" id="6921427">mu</span><span class="op" id="6921429">.</span><span class="ident" id="6921430">Lock</span><span class="op" id="6921434">(</span><span class="op" id="6921435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921438">opens</span>&nbsp;<span class="op" id="6921444">:=</span>&nbsp;<span class="ident" id="6921447">drv</span><span class="op" id="6921450">.</span><span class="ident" id="6921451">openCount</span>&nbsp;<span class="op" id="6921461">-</span>&nbsp;<span class="ident" id="6921463">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921471">closes</span>&nbsp;<span class="op" id="6921478">:=</span>&nbsp;<span class="ident" id="6921481">drv</span><span class="op" id="6921484">.</span><span class="ident" id="6921485">closeCount</span>&nbsp;<span class="op" id="6921496">-</span>&nbsp;<span class="ident" id="6921498">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921507">drv</span><span class="op" id="6921510">.</span><span class="ident" id="6921511">mu</span><span class="op" id="6921513">.</span><span class="ident" id="6921514">Unlock</span><span class="op" id="6921520">(</span><span class="op" id="6921521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921524">if</span>&nbsp;<span class="ident" id="6921527">opens</span>&nbsp;<span class="op" id="6921533">&lt;</span>&nbsp;<span class="num" id="6921535">9</span>&nbsp;<span class="op" id="6921537">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921541">t</span><span class="op" id="6921542">.</span><span class="ident" id="6921543">Errorf</span><span class="op" id="6921549">(</span><span class="string" id="6921550">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6921573">,</span>&nbsp;<span class="ident" id="6921575">opens</span><span class="op" id="6921580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6921586">if</span>&nbsp;<span class="ident" id="6921589">closes</span>&nbsp;<span class="op" id="6921596">&lt;</span>&nbsp;<span class="num" id="6921598">9</span>&nbsp;<span class="op" id="6921600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921604">t</span><span class="op" id="6921605">.</span><span class="ident" id="6921606">Errorf</span><span class="op" id="6921612">(</span><span class="string" id="6921613">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="6921637">,</span>&nbsp;<span class="ident" id="6921639">closes</span><span class="op" id="6921645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6921648">}</span><br>
<span class="lineno">1860</span><span class="op" id="6921650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6921653">func</span>&nbsp;<span class="ident" id="6921658">TestConcurrency</span><span class="op" id="6921673">(</span><span class="ident" id="6921674">t</span>&nbsp;<span class="op" id="6921676">*</span><span class="ident" id="6921677">testing</span><span class="op" id="6921684">.</span><span class="ident" id="6921685">T</span><span class="op" id="6921686">)</span>&nbsp;<span class="op" id="6921688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921691">doConcurrentTest</span><span class="op" id="6921707">(</span><span class="ident" id="6921708">t</span><span class="op" id="6921709">,</span>&nbsp;<span class="builtinfunc" id="6921711">new</span><span class="op" id="6921714">(</span><span class="ident" id="6921715">concurrentDBQueryTest</span><span class="op" id="6921736">)</span><span class="op" id="6921737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921740">doConcurrentTest</span><span class="op" id="6921756">(</span><span class="ident" id="6921757">t</span><span class="op" id="6921758">,</span>&nbsp;<span class="builtinfunc" id="6921760">new</span><span class="op" id="6921763">(</span><span class="ident" id="6921764">concurrentDBExecTest</span><span class="op" id="6921784">)</span><span class="op" id="6921785">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921788">doConcurrentTest</span><span class="op" id="6921804">(</span><span class="ident" id="6921805">t</span><span class="op" id="6921806">,</span>&nbsp;<span class="builtinfunc" id="6921808">new</span><span class="op" id="6921811">(</span><span class="ident" id="6921812">concurrentStmtQueryTest</span><span class="op" id="6921835">)</span><span class="op" id="6921836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921839">doConcurrentTest</span><span class="op" id="6921855">(</span><span class="ident" id="6921856">t</span><span class="op" id="6921857">,</span>&nbsp;<span class="builtinfunc" id="6921859">new</span><span class="op" id="6921862">(</span><span class="ident" id="6921863">concurrentStmtExecTest</span><span class="op" id="6921885">)</span><span class="op" id="6921886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921889">doConcurrentTest</span><span class="op" id="6921905">(</span><span class="ident" id="6921906">t</span><span class="op" id="6921907">,</span>&nbsp;<span class="builtinfunc" id="6921909">new</span><span class="op" id="6921912">(</span><span class="ident" id="6921913">concurrentTxQueryTest</span><span class="op" id="6921934">)</span><span class="op" id="6921935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921938">doConcurrentTest</span><span class="op" id="6921954">(</span><span class="ident" id="6921955">t</span><span class="op" id="6921956">,</span>&nbsp;<span class="builtinfunc" id="6921958">new</span><span class="op" id="6921961">(</span><span class="ident" id="6921962">concurrentTxExecTest</span><span class="op" id="6921982">)</span><span class="op" id="6921983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6921986">doConcurrentTest</span><span class="op" id="6922002">(</span><span class="ident" id="6922003">t</span><span class="op" id="6922004">,</span>&nbsp;<span class="builtinfunc" id="6922006">new</span><span class="op" id="6922009">(</span><span class="ident" id="6922010">concurrentTxStmtQueryTest</span><span class="op" id="6922035">)</span><span class="op" id="6922036">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922039">doConcurrentTest</span><span class="op" id="6922055">(</span><span class="ident" id="6922056">t</span><span class="op" id="6922057">,</span>&nbsp;<span class="builtinfunc" id="6922059">new</span><span class="op" id="6922062">(</span><span class="ident" id="6922063">concurrentTxStmtExecTest</span><span class="op" id="6922087">)</span><span class="op" id="6922088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922091">doConcurrentTest</span><span class="op" id="6922107">(</span><span class="ident" id="6922108">t</span><span class="op" id="6922109">,</span>&nbsp;<span class="builtinfunc" id="6922111">new</span><span class="op" id="6922114">(</span><span class="ident" id="6922115">concurrentRandomTest</span><span class="op" id="6922135">)</span><span class="op" id="6922136">)</span><br>
<span class="lineno"></span><span class="op" id="6922138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6922141">func</span>&nbsp;<span class="ident" id="6922146">TestConnectionLeak</span><span class="op" id="6922164">(</span><span class="ident" id="6922165">t</span>&nbsp;<span class="op" id="6922167">*</span><span class="ident" id="6922168">testing</span><span class="op" id="6922175">.</span><span class="ident" id="6922176">T</span><span class="op" id="6922177">)</span>&nbsp;<span class="op" id="6922179">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922182">db</span>&nbsp;<span class="op" id="6922185">:=</span>&nbsp;<span class="ident" id="6922188">newTestDB</span><span class="op" id="6922197">(</span><span class="ident" id="6922198">t</span><span class="op" id="6922199">,</span>&nbsp;<span class="string" id="6922201">&#34;people&#34;</span><span class="op" id="6922209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922212">defer</span>&nbsp;<span class="ident" id="6922218">closeDB</span><span class="op" id="6922225">(</span><span class="ident" id="6922226">t</span><span class="op" id="6922227">,</span>&nbsp;<span class="ident" id="6922229">db</span><span class="op" id="6922231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922234">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922275">rows</span>&nbsp;<span class="op" id="6922280">:=</span>&nbsp;<span class="builtinfunc" id="6922283">make</span><span class="op" id="6922287">(</span><span class="op" id="6922288">[</span><span class="op" id="6922289">]</span><span class="op" id="6922290">*</span><span class="ident" id="6922291">Rows</span><span class="op" id="6922295">,</span>&nbsp;<span class="ident" id="6922297">defaultMaxIdleConns</span><span class="op" id="6922316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922319">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922385">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922455">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922472">db</span><span class="op" id="6922474">.</span><span class="ident" id="6922475">SetMaxOpenConns</span><span class="op" id="6922490">(</span><span class="builtinfunc" id="6922491">len</span><span class="op" id="6922494">(</span><span class="ident" id="6922495">rows</span><span class="op" id="6922499">)</span>&nbsp;<span class="op" id="6922501">+</span>&nbsp;<span class="num" id="6922503">1</span><span class="op" id="6922504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922507">for</span>&nbsp;<span class="ident" id="6922511">ii</span>&nbsp;<span class="op" id="6922514">:=</span>&nbsp;<span class="keyword" id="6922517">range</span>&nbsp;<span class="ident" id="6922523">rows</span>&nbsp;<span class="op" id="6922528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922532">r</span><span class="op" id="6922533">,</span>&nbsp;<span class="ident" id="6922535">err</span>&nbsp;<span class="op" id="6922539">:=</span>&nbsp;<span class="ident" id="6922542">db</span><span class="op" id="6922544">.</span><span class="ident" id="6922545">Query</span><span class="op" id="6922550">(</span><span class="string" id="6922551">&#34;SELECT|people|name|&#34;</span><span class="op" id="6922572">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922576">if</span>&nbsp;<span class="ident" id="6922579">err</span>&nbsp;<span class="op" id="6922583">!=</span>&nbsp;<span class="ident" id="6922586">nil</span>&nbsp;<span class="op" id="6922590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922595">t</span><span class="op" id="6922596">.</span><span class="ident" id="6922597">Fatal</span><span class="op" id="6922602">(</span><span class="ident" id="6922603">err</span><span class="op" id="6922606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922614">r</span><span class="op" id="6922615">.</span><span class="ident" id="6922616">Next</span><span class="op" id="6922620">(</span><span class="op" id="6922621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922625">if</span>&nbsp;<span class="ident" id="6922628">err</span>&nbsp;<span class="op" id="6922632">:=</span>&nbsp;<span class="ident" id="6922635">r</span><span class="op" id="6922636">.</span><span class="ident" id="6922637">Err</span><span class="op" id="6922640">(</span><span class="op" id="6922641">)</span><span class="op" id="6922642">;</span>&nbsp;<span class="ident" id="6922644">err</span>&nbsp;<span class="op" id="6922648">!=</span>&nbsp;<span class="ident" id="6922651">nil</span>&nbsp;<span class="op" id="6922655">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922660">t</span><span class="op" id="6922661">.</span><span class="ident" id="6922662">Fatal</span><span class="op" id="6922667">(</span><span class="ident" id="6922668">err</span><span class="op" id="6922671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922679">rows</span><span class="op" id="6922683">[</span><span class="ident" id="6922684">ii</span><span class="op" id="6922686">]</span>&nbsp;<span class="op" id="6922688">=</span>&nbsp;<span class="ident" id="6922690">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6922693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922696">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922755">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6922819">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922855">drv</span>&nbsp;<span class="op" id="6922859">:=</span>&nbsp;<span class="ident" id="6922862">db</span><span class="op" id="6922864">.</span><span class="ident" id="6922865">driver</span><span class="op" id="6922871">.</span><span class="op" id="6922872">(</span><span class="op" id="6922873">*</span><span class="ident" id="6922874">fakeDriver</span><span class="op" id="6922884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922887">drv</span><span class="op" id="6922890">.</span><span class="ident" id="6922891">waitCh</span>&nbsp;<span class="op" id="6922898">=</span>&nbsp;<span class="builtinfunc" id="6922900">make</span><span class="op" id="6922904">(</span><span class="keyword" id="6922905">chan</span>&nbsp;<span class="keyword" id="6922910">struct</span><span class="op" id="6922916">{</span><span class="op" id="6922917">}</span><span class="op" id="6922918">,</span>&nbsp;<span class="num" id="6922920">1</span><span class="op" id="6922921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922924">drv</span><span class="op" id="6922927">.</span><span class="ident" id="6922928">waitingCh</span>&nbsp;<span class="op" id="6922938">=</span>&nbsp;<span class="builtinfunc" id="6922940">make</span><span class="op" id="6922944">(</span><span class="keyword" id="6922945">chan</span>&nbsp;<span class="keyword" id="6922950">struct</span><span class="op" id="6922956">{</span><span class="op" id="6922957">}</span><span class="op" id="6922958">,</span>&nbsp;<span class="num" id="6922960">1</span><span class="op" id="6922961">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922964">var</span>&nbsp;<span class="ident" id="6922968">wg</span>&nbsp;<span class="ident" id="6922971">sync</span><span class="op" id="6922975">.</span><span class="ident" id="6922976">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6922987">wg</span><span class="op" id="6922989">.</span><span class="ident" id="6922990">Add</span><span class="op" id="6922993">(</span><span class="num" id="6922994">1</span><span class="op" id="6922995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6922998">go</span>&nbsp;<span class="keyword" id="6923001">func</span><span class="op" id="6923005">(</span><span class="op" id="6923006">)</span>&nbsp;<span class="op" id="6923008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923012">r</span><span class="op" id="6923013">,</span>&nbsp;<span class="ident" id="6923015">err</span>&nbsp;<span class="op" id="6923019">:=</span>&nbsp;<span class="ident" id="6923022">db</span><span class="op" id="6923024">.</span><span class="ident" id="6923025">Query</span><span class="op" id="6923030">(</span><span class="string" id="6923031">&#34;SELECT|people|name|&#34;</span><span class="op" id="6923052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923056">if</span>&nbsp;<span class="ident" id="6923059">err</span>&nbsp;<span class="op" id="6923063">!=</span>&nbsp;<span class="ident" id="6923066">nil</span>&nbsp;<span class="op" id="6923070">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923075">t</span><span class="op" id="6923076">.</span><span class="ident" id="6923077">Fatal</span><span class="op" id="6923082">(</span><span class="ident" id="6923083">err</span><span class="op" id="6923086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923094">r</span><span class="op" id="6923095">.</span><span class="ident" id="6923096">Close</span><span class="op" id="6923101">(</span><span class="op" id="6923102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923106">wg</span><span class="op" id="6923108">.</span><span class="ident" id="6923109">Done</span><span class="op" id="6923113">(</span><span class="op" id="6923114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923117">}</span><span class="op" id="6923118">(</span><span class="op" id="6923119">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923122">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923191">&lt;-</span><span class="ident" id="6923193">drv</span><span class="op" id="6923196">.</span><span class="ident" id="6923197">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923208">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923275">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923335">for</span>&nbsp;<span class="ident" id="6923339">_</span><span class="op" id="6923340">,</span>&nbsp;<span class="ident" id="6923342">v</span>&nbsp;<span class="op" id="6923344">:=</span>&nbsp;<span class="keyword" id="6923347">range</span>&nbsp;<span class="ident" id="6923353">rows</span>&nbsp;<span class="op" id="6923358">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923362">v</span><span class="op" id="6923363">.</span><span class="ident" id="6923364">Close</span><span class="op" id="6923369">(</span><span class="op" id="6923370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923376">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923447">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923518">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6923587">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923603">drv</span><span class="op" id="6923606">.</span><span class="ident" id="6923607">waitCh</span>&nbsp;<span class="op" id="6923614">&lt;-</span>&nbsp;<span class="keyword" id="6923617">struct</span><span class="op" id="6923623">{</span><span class="op" id="6923624">}</span><span class="op" id="6923625">{</span><span class="op" id="6923626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923629">wg</span><span class="op" id="6923631">.</span><span class="ident" id="6923632">Wait</span><span class="op" id="6923636">(</span><span class="op" id="6923637">)</span><br>
<span class="lineno"></span><span class="op" id="6923639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="6923642">func</span>&nbsp;<span class="ident" id="6923647">BenchmarkConcurrentDBExec</span><span class="op" id="6923672">(</span><span class="ident" id="6923673">b</span>&nbsp;<span class="op" id="6923675">*</span><span class="ident" id="6923676">testing</span><span class="op" id="6923683">.</span><span class="ident" id="6923684">B</span><span class="op" id="6923685">)</span>&nbsp;<span class="op" id="6923687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923690">b</span><span class="op" id="6923691">.</span><span class="ident" id="6923692">ReportAllocs</span><span class="op" id="6923704">(</span><span class="op" id="6923705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923708">ct</span>&nbsp;<span class="op" id="6923711">:=</span>&nbsp;<span class="builtinfunc" id="6923714">new</span><span class="op" id="6923717">(</span><span class="ident" id="6923718">concurrentDBExecTest</span><span class="op" id="6923738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923741">for</span>&nbsp;<span class="ident" id="6923745">i</span>&nbsp;<span class="op" id="6923747">:=</span>&nbsp;<span class="num" id="6923750">0</span><span class="op" id="6923751">;</span>&nbsp;<span class="ident" id="6923753">i</span>&nbsp;<span class="op" id="6923755">&lt;</span>&nbsp;<span class="ident" id="6923757">b</span><span class="op" id="6923758">.</span><span class="ident" id="6923759">N</span><span class="op" id="6923760">;</span>&nbsp;<span class="ident" id="6923762">i</span><span class="op" id="6923763">++</span>&nbsp;<span class="op" id="6923766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923770">doConcurrentTest</span><span class="op" id="6923786">(</span><span class="ident" id="6923787">b</span><span class="op" id="6923788">,</span>&nbsp;<span class="ident" id="6923790">ct</span><span class="op" id="6923792">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923795">}</span><br>
<span class="lineno"></span><span class="op" id="6923797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6923800">func</span>&nbsp;<span class="ident" id="6923805">BenchmarkConcurrentStmtQuery</span><span class="op" id="6923833">(</span><span class="ident" id="6923834">b</span>&nbsp;<span class="op" id="6923836">*</span><span class="ident" id="6923837">testing</span><span class="op" id="6923844">.</span><span class="ident" id="6923845">B</span><span class="op" id="6923846">)</span>&nbsp;<span class="op" id="6923848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923851">b</span><span class="op" id="6923852">.</span><span class="ident" id="6923853">ReportAllocs</span><span class="op" id="6923865">(</span><span class="op" id="6923866">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923869">ct</span>&nbsp;<span class="op" id="6923872">:=</span>&nbsp;<span class="builtinfunc" id="6923875">new</span><span class="op" id="6923878">(</span><span class="ident" id="6923879">concurrentStmtQueryTest</span><span class="op" id="6923902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6923905">for</span>&nbsp;<span class="ident" id="6923909">i</span>&nbsp;<span class="op" id="6923911">:=</span>&nbsp;<span class="num" id="6923914">0</span><span class="op" id="6923915">;</span>&nbsp;<span class="ident" id="6923917">i</span>&nbsp;<span class="op" id="6923919">&lt;</span>&nbsp;<span class="ident" id="6923921">b</span><span class="op" id="6923922">.</span><span class="ident" id="6923923">N</span><span class="op" id="6923924">;</span>&nbsp;<span class="ident" id="6923926">i</span><span class="op" id="6923927">++</span>&nbsp;<span class="op" id="6923930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6923934">doConcurrentTest</span><span class="op" id="6923950">(</span><span class="ident" id="6923951">b</span><span class="op" id="6923952">,</span>&nbsp;<span class="ident" id="6923954">ct</span><span class="op" id="6923956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6923959">}</span><br>
<span class="lineno"></span><span class="op" id="6923961">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="6923964">func</span>&nbsp;<span class="ident" id="6923969">BenchmarkConcurrentStmtExec</span><span class="op" id="6923996">(</span><span class="ident" id="6923997">b</span>&nbsp;<span class="op" id="6923999">*</span><span class="ident" id="6924000">testing</span><span class="op" id="6924007">.</span><span class="ident" id="6924008">B</span><span class="op" id="6924009">)</span>&nbsp;<span class="op" id="6924011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924014">b</span><span class="op" id="6924015">.</span><span class="ident" id="6924016">ReportAllocs</span><span class="op" id="6924028">(</span><span class="op" id="6924029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924032">ct</span>&nbsp;<span class="op" id="6924035">:=</span>&nbsp;<span class="builtinfunc" id="6924038">new</span><span class="op" id="6924041">(</span><span class="ident" id="6924042">concurrentStmtExecTest</span><span class="op" id="6924064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924067">for</span>&nbsp;<span class="ident" id="6924071">i</span>&nbsp;<span class="op" id="6924073">:=</span>&nbsp;<span class="num" id="6924076">0</span><span class="op" id="6924077">;</span>&nbsp;<span class="ident" id="6924079">i</span>&nbsp;<span class="op" id="6924081">&lt;</span>&nbsp;<span class="ident" id="6924083">b</span><span class="op" id="6924084">.</span><span class="ident" id="6924085">N</span><span class="op" id="6924086">;</span>&nbsp;<span class="ident" id="6924088">i</span><span class="op" id="6924089">++</span>&nbsp;<span class="op" id="6924092">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924096">doConcurrentTest</span><span class="op" id="6924112">(</span><span class="ident" id="6924113">b</span><span class="op" id="6924114">,</span>&nbsp;<span class="ident" id="6924116">ct</span><span class="op" id="6924118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924121">}</span><br>
<span class="lineno"></span><span class="op" id="6924123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924126">func</span>&nbsp;<span class="ident" id="6924131">BenchmarkConcurrentTxQuery</span><span class="op" id="6924157">(</span><span class="ident" id="6924158">b</span>&nbsp;<span class="op" id="6924160">*</span><span class="ident" id="6924161">testing</span><span class="op" id="6924168">.</span><span class="ident" id="6924169">B</span><span class="op" id="6924170">)</span>&nbsp;<span class="op" id="6924172">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924175">b</span><span class="op" id="6924176">.</span><span class="ident" id="6924177">ReportAllocs</span><span class="op" id="6924189">(</span><span class="op" id="6924190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924193">ct</span>&nbsp;<span class="op" id="6924196">:=</span>&nbsp;<span class="builtinfunc" id="6924199">new</span><span class="op" id="6924202">(</span><span class="ident" id="6924203">concurrentTxQueryTest</span><span class="op" id="6924224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924227">for</span>&nbsp;<span class="ident" id="6924231">i</span>&nbsp;<span class="op" id="6924233">:=</span>&nbsp;<span class="num" id="6924236">0</span><span class="op" id="6924237">;</span>&nbsp;<span class="ident" id="6924239">i</span>&nbsp;<span class="op" id="6924241">&lt;</span>&nbsp;<span class="ident" id="6924243">b</span><span class="op" id="6924244">.</span><span class="ident" id="6924245">N</span><span class="op" id="6924246">;</span>&nbsp;<span class="ident" id="6924248">i</span><span class="op" id="6924249">++</span>&nbsp;<span class="op" id="6924252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924256">doConcurrentTest</span><span class="op" id="6924272">(</span><span class="ident" id="6924273">b</span><span class="op" id="6924274">,</span>&nbsp;<span class="ident" id="6924276">ct</span><span class="op" id="6924278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924281">}</span><br>
<span class="lineno">1955</span><span class="op" id="6924283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924286">func</span>&nbsp;<span class="ident" id="6924291">BenchmarkConcurrentTxExec</span><span class="op" id="6924316">(</span><span class="ident" id="6924317">b</span>&nbsp;<span class="op" id="6924319">*</span><span class="ident" id="6924320">testing</span><span class="op" id="6924327">.</span><span class="ident" id="6924328">B</span><span class="op" id="6924329">)</span>&nbsp;<span class="op" id="6924331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924334">b</span><span class="op" id="6924335">.</span><span class="ident" id="6924336">ReportAllocs</span><span class="op" id="6924348">(</span><span class="op" id="6924349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924352">ct</span>&nbsp;<span class="op" id="6924355">:=</span>&nbsp;<span class="builtinfunc" id="6924358">new</span><span class="op" id="6924361">(</span><span class="ident" id="6924362">concurrentTxExecTest</span><span class="op" id="6924382">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924385">for</span>&nbsp;<span class="ident" id="6924389">i</span>&nbsp;<span class="op" id="6924391">:=</span>&nbsp;<span class="num" id="6924394">0</span><span class="op" id="6924395">;</span>&nbsp;<span class="ident" id="6924397">i</span>&nbsp;<span class="op" id="6924399">&lt;</span>&nbsp;<span class="ident" id="6924401">b</span><span class="op" id="6924402">.</span><span class="ident" id="6924403">N</span><span class="op" id="6924404">;</span>&nbsp;<span class="ident" id="6924406">i</span><span class="op" id="6924407">++</span>&nbsp;<span class="op" id="6924410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924414">doConcurrentTest</span><span class="op" id="6924430">(</span><span class="ident" id="6924431">b</span><span class="op" id="6924432">,</span>&nbsp;<span class="ident" id="6924434">ct</span><span class="op" id="6924436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924439">}</span><br>
<span class="lineno"></span><span class="op" id="6924441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="6924444">func</span>&nbsp;<span class="ident" id="6924449">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="6924479">(</span><span class="ident" id="6924480">b</span>&nbsp;<span class="op" id="6924482">*</span><span class="ident" id="6924483">testing</span><span class="op" id="6924490">.</span><span class="ident" id="6924491">B</span><span class="op" id="6924492">)</span>&nbsp;<span class="op" id="6924494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924497">b</span><span class="op" id="6924498">.</span><span class="ident" id="6924499">ReportAllocs</span><span class="op" id="6924511">(</span><span class="op" id="6924512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924515">ct</span>&nbsp;<span class="op" id="6924518">:=</span>&nbsp;<span class="builtinfunc" id="6924521">new</span><span class="op" id="6924524">(</span><span class="ident" id="6924525">concurrentTxStmtQueryTest</span><span class="op" id="6924550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924553">for</span>&nbsp;<span class="ident" id="6924557">i</span>&nbsp;<span class="op" id="6924559">:=</span>&nbsp;<span class="num" id="6924562">0</span><span class="op" id="6924563">;</span>&nbsp;<span class="ident" id="6924565">i</span>&nbsp;<span class="op" id="6924567">&lt;</span>&nbsp;<span class="ident" id="6924569">b</span><span class="op" id="6924570">.</span><span class="ident" id="6924571">N</span><span class="op" id="6924572">;</span>&nbsp;<span class="ident" id="6924574">i</span><span class="op" id="6924575">++</span>&nbsp;<span class="op" id="6924578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924582">doConcurrentTest</span><span class="op" id="6924598">(</span><span class="ident" id="6924599">b</span><span class="op" id="6924600">,</span>&nbsp;<span class="ident" id="6924602">ct</span><span class="op" id="6924604">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924607">}</span><br>
<span class="lineno"></span><span class="op" id="6924609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6924612">func</span>&nbsp;<span class="ident" id="6924617">BenchmarkConcurrentTxStmtExec</span><span class="op" id="6924646">(</span><span class="ident" id="6924647">b</span>&nbsp;<span class="op" id="6924649">*</span><span class="ident" id="6924650">testing</span><span class="op" id="6924657">.</span><span class="ident" id="6924658">B</span><span class="op" id="6924659">)</span>&nbsp;<span class="op" id="6924661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924664">b</span><span class="op" id="6924665">.</span><span class="ident" id="6924666">ReportAllocs</span><span class="op" id="6924678">(</span><span class="op" id="6924679">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924682">ct</span>&nbsp;<span class="op" id="6924685">:=</span>&nbsp;<span class="builtinfunc" id="6924688">new</span><span class="op" id="6924691">(</span><span class="ident" id="6924692">concurrentTxStmtExecTest</span><span class="op" id="6924716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924719">for</span>&nbsp;<span class="ident" id="6924723">i</span>&nbsp;<span class="op" id="6924725">:=</span>&nbsp;<span class="num" id="6924728">0</span><span class="op" id="6924729">;</span>&nbsp;<span class="ident" id="6924731">i</span>&nbsp;<span class="op" id="6924733">&lt;</span>&nbsp;<span class="ident" id="6924735">b</span><span class="op" id="6924736">.</span><span class="ident" id="6924737">N</span><span class="op" id="6924738">;</span>&nbsp;<span class="ident" id="6924740">i</span><span class="op" id="6924741">++</span>&nbsp;<span class="op" id="6924744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924748">doConcurrentTest</span><span class="op" id="6924764">(</span><span class="ident" id="6924765">b</span><span class="op" id="6924766">,</span>&nbsp;<span class="ident" id="6924768">ct</span><span class="op" id="6924770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924773">}</span><br>
<span class="lineno"></span><span class="op" id="6924775">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="6924778">func</span>&nbsp;<span class="ident" id="6924783">BenchmarkConcurrentRandom</span><span class="op" id="6924808">(</span><span class="ident" id="6924809">b</span>&nbsp;<span class="op" id="6924811">*</span><span class="ident" id="6924812">testing</span><span class="op" id="6924819">.</span><span class="ident" id="6924820">B</span><span class="op" id="6924821">)</span>&nbsp;<span class="op" id="6924823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924826">b</span><span class="op" id="6924827">.</span><span class="ident" id="6924828">ReportAllocs</span><span class="op" id="6924840">(</span><span class="op" id="6924841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924844">ct</span>&nbsp;<span class="op" id="6924847">:=</span>&nbsp;<span class="builtinfunc" id="6924850">new</span><span class="op" id="6924853">(</span><span class="ident" id="6924854">concurrentRandomTest</span><span class="op" id="6924874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6924877">for</span>&nbsp;<span class="ident" id="6924881">i</span>&nbsp;<span class="op" id="6924883">:=</span>&nbsp;<span class="num" id="6924886">0</span><span class="op" id="6924887">;</span>&nbsp;<span class="ident" id="6924889">i</span>&nbsp;<span class="op" id="6924891">&lt;</span>&nbsp;<span class="ident" id="6924893">b</span><span class="op" id="6924894">.</span><span class="ident" id="6924895">N</span><span class="op" id="6924896">;</span>&nbsp;<span class="ident" id="6924898">i</span><span class="op" id="6924899">++</span>&nbsp;<span class="op" id="6924902">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6924906">doConcurrentTest</span><span class="op" id="6924922">(</span><span class="ident" id="6924923">b</span><span class="op" id="6924924">,</span>&nbsp;<span class="ident" id="6924926">ct</span><span class="op" id="6924928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6924931">}</span><br>
<span class="lineno"></span><span class="op" id="6924933">}</span>
</div>
</body>
</html>
