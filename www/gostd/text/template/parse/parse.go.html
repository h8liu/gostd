<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4637138">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4637193">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4637247">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4637298">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="4637376">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="4637455">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4637531">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4637560">package</span>&nbsp;<span class="ident" id="4637568">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4637575">import</span>&nbsp;<span class="op" id="4637582">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4637585">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4637594">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4637601">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4637612">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4637623">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4637633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4637636">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="4637695">type</span>&nbsp;<span class="ident" id="4637700">Tree</span>&nbsp;<span class="keyword" id="4637705">struct</span>&nbsp;<span class="op" id="4637712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4637715">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4637725">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4637735">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4637785">ParseName</span>&nbsp;<span class="builtintype" id="4637795">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4637805">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4637876">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4637886">*</span><span class="ident" id="4637887">ListNode</span>&nbsp;<span class="comment" id="4637896">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4637928">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4637938">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4637948">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4638003">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638042">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4638052">[</span><span class="op" id="4638053">]</span><span class="keyword" id="4638054">map</span><span class="op" id="4638057">[</span><span class="builtintype" id="4638058">string</span><span class="op" id="4638064">]</span><span class="keyword" id="4638065">interface</span><span class="op" id="4638074">{</span><span class="op" id="4638075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638078">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4638088">*</span><span class="ident" id="4638089">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638096">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4638106">[</span><span class="num" id="4638107">3</span><span class="op" id="4638108">]</span><span class="ident" id="4638109">item</span>&nbsp;<span class="comment" id="4638114">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638152">peekCount</span>&nbsp;<span class="builtintype" id="4638162">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638167">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4638177">[</span><span class="op" id="4638178">]</span><span class="builtintype" id="4638179">string</span>&nbsp;<span class="comment" id="4638186">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="4638222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4638225">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4638293">func</span>&nbsp;<span class="op" id="4638298">(</span><span class="ident" id="4638299">t</span>&nbsp;<span class="op" id="4638301">*</span><span class="ident" id="4638302">Tree</span><span class="op" id="4638306">)</span>&nbsp;<span class="ident" id="4638308">Copy</span><span class="op" id="4638312">(</span><span class="op" id="4638313">)</span>&nbsp;<span class="op" id="4638315">*</span><span class="ident" id="4638316">Tree</span>&nbsp;<span class="op" id="4638321">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4638324">if</span>&nbsp;<span class="ident" id="4638327">t</span>&nbsp;<span class="op" id="4638329">==</span>&nbsp;<span class="ident" id="4638332">nil</span>&nbsp;<span class="op" id="4638336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4638340">return</span>&nbsp;<span class="ident" id="4638347">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4638352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4638355">return</span>&nbsp;<span class="op" id="4638362">&amp;</span><span class="ident" id="4638363">Tree</span><span class="op" id="4638367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638371">Name</span><span class="op" id="4638375">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4638382">t</span><span class="op" id="4638383">.</span><span class="ident" id="4638384">Name</span><span class="op" id="4638388">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638392">ParseName</span><span class="op" id="4638401">:</span>&nbsp;<span class="ident" id="4638403">t</span><span class="op" id="4638404">.</span><span class="ident" id="4638405">ParseName</span><span class="op" id="4638414">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638418">Root</span><span class="op" id="4638422">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4638429">t</span><span class="op" id="4638430">.</span><span class="ident" id="4638431">Root</span><span class="op" id="4638435">.</span><span class="ident" id="4638436">CopyList</span><span class="op" id="4638444">(</span><span class="op" id="4638445">)</span><span class="op" id="4638446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638450">text</span><span class="op" id="4638454">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4638461">t</span><span class="op" id="4638462">.</span><span class="ident" id="4638463">text</span><span class="op" id="4638467">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4638470">}</span><br>
<span class="lineno"></span><span class="op" id="4638472">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4638475">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4638555">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4638633">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4638711">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="4638752">func</span>&nbsp;<span class="ident" id="4638757">Parse</span><span class="op" id="4638762">(</span><span class="ident" id="4638763">name</span><span class="op" id="4638767">,</span>&nbsp;<span class="ident" id="4638769">text</span><span class="op" id="4638773">,</span>&nbsp;<span class="ident" id="4638775">leftDelim</span><span class="op" id="4638784">,</span>&nbsp;<span class="ident" id="4638786">rightDelim</span>&nbsp;<span class="builtintype" id="4638797">string</span><span class="op" id="4638803">,</span>&nbsp;<span class="ident" id="4638805">funcs</span>&nbsp;<span class="op" id="4638811">...</span><span class="keyword" id="4638814">map</span><span class="op" id="4638817">[</span><span class="builtintype" id="4638818">string</span><span class="op" id="4638824">]</span><span class="keyword" id="4638825">interface</span><span class="op" id="4638834">{</span><span class="op" id="4638835">}</span><span class="op" id="4638836">)</span>&nbsp;<span class="op" id="4638838">(</span><span class="ident" id="4638839">treeSet</span>&nbsp;<span class="keyword" id="4638847">map</span><span class="op" id="4638850">[</span><span class="builtintype" id="4638851">string</span><span class="op" id="4638857">]</span><span class="op" id="4638858">*</span><span class="ident" id="4638859">Tree</span><span class="op" id="4638863">,</span>&nbsp;<span class="ident" id="4638865">err</span>&nbsp;<span class="builtintype" id="4638869">error</span><span class="op" id="4638874">)</span>&nbsp;<span class="op" id="4638876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638879">treeSet</span>&nbsp;<span class="op" id="4638887">=</span>&nbsp;<span class="builtinfunc" id="4638889">make</span><span class="op" id="4638893">(</span><span class="keyword" id="4638894">map</span><span class="op" id="4638897">[</span><span class="builtintype" id="4638898">string</span><span class="op" id="4638904">]</span><span class="op" id="4638905">*</span><span class="ident" id="4638906">Tree</span><span class="op" id="4638910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638913">t</span>&nbsp;<span class="op" id="4638915">:=</span>&nbsp;<span class="ident" id="4638918">New</span><span class="op" id="4638921">(</span><span class="ident" id="4638922">name</span><span class="op" id="4638926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638929">t</span><span class="op" id="4638930">.</span><span class="ident" id="4638931">text</span>&nbsp;<span class="op" id="4638936">=</span>&nbsp;<span class="ident" id="4638938">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4638944">_</span><span class="op" id="4638945">,</span>&nbsp;<span class="ident" id="4638947">err</span>&nbsp;<span class="op" id="4638951">=</span>&nbsp;<span class="ident" id="4638953">t</span><span class="op" id="4638954">.</span><span class="ident" id="4638955">Parse</span><span class="op" id="4638960">(</span><span class="ident" id="4638961">text</span><span class="op" id="4638965">,</span>&nbsp;<span class="ident" id="4638967">leftDelim</span><span class="op" id="4638976">,</span>&nbsp;<span class="ident" id="4638978">rightDelim</span><span class="op" id="4638988">,</span>&nbsp;<span class="ident" id="4638990">treeSet</span><span class="op" id="4638997">,</span>&nbsp;<span class="ident" id="4638999">funcs</span><span class="op" id="4639004">...</span><span class="op" id="4639007">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639010">return</span><br>
<span class="lineno"></span><span class="op" id="4639017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4639020">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4639052">func</span>&nbsp;<span class="op" id="4639057">(</span><span class="ident" id="4639058">t</span>&nbsp;<span class="op" id="4639060">*</span><span class="ident" id="4639061">Tree</span><span class="op" id="4639065">)</span>&nbsp;<span class="ident" id="4639067">next</span><span class="op" id="4639071">(</span><span class="op" id="4639072">)</span>&nbsp;<span class="ident" id="4639074">item</span>&nbsp;<span class="op" id="4639079">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639082">if</span>&nbsp;<span class="ident" id="4639085">t</span><span class="op" id="4639086">.</span><span class="ident" id="4639087">peekCount</span>&nbsp;<span class="op" id="4639097">&gt;</span>&nbsp;<span class="num" id="4639099">0</span>&nbsp;<span class="op" id="4639101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639105">t</span><span class="op" id="4639106">.</span><span class="ident" id="4639107">peekCount</span><span class="op" id="4639116">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4639120">}</span>&nbsp;<span class="keyword" id="4639122">else</span>&nbsp;<span class="op" id="4639127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639131">t</span><span class="op" id="4639132">.</span><span class="ident" id="4639133">token</span><span class="op" id="4639138">[</span><span class="num" id="4639139">0</span><span class="op" id="4639140">]</span>&nbsp;<span class="op" id="4639142">=</span>&nbsp;<span class="ident" id="4639144">t</span><span class="op" id="4639145">.</span><span class="ident" id="4639146">lex</span><span class="op" id="4639149">.</span><span class="ident" id="4639150">nextItem</span><span class="op" id="4639158">(</span><span class="op" id="4639159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4639162">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639165">return</span>&nbsp;<span class="ident" id="4639172">t</span><span class="op" id="4639173">.</span><span class="ident" id="4639174">token</span><span class="op" id="4639179">[</span><span class="ident" id="4639180">t</span><span class="op" id="4639181">.</span><span class="ident" id="4639182">peekCount</span><span class="op" id="4639191">]</span><br>
<span class="lineno"></span><span class="op" id="4639193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4639196">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4639243">func</span>&nbsp;<span class="op" id="4639248">(</span><span class="ident" id="4639249">t</span>&nbsp;<span class="op" id="4639251">*</span><span class="ident" id="4639252">Tree</span><span class="op" id="4639256">)</span>&nbsp;<span class="ident" id="4639258">backup</span><span class="op" id="4639264">(</span><span class="op" id="4639265">)</span>&nbsp;<span class="op" id="4639267">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639270">t</span><span class="op" id="4639271">.</span><span class="ident" id="4639272">peekCount</span><span class="op" id="4639281">++</span><br>
<span class="lineno"></span><span class="op" id="4639284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4639287">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="4639336">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="4639374">func</span>&nbsp;<span class="op" id="4639379">(</span><span class="ident" id="4639380">t</span>&nbsp;<span class="op" id="4639382">*</span><span class="ident" id="4639383">Tree</span><span class="op" id="4639387">)</span>&nbsp;<span class="ident" id="4639389">backup2</span><span class="op" id="4639396">(</span><span class="ident" id="4639397">t1</span>&nbsp;<span class="ident" id="4639400">item</span><span class="op" id="4639404">)</span>&nbsp;<span class="op" id="4639406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639409">t</span><span class="op" id="4639410">.</span><span class="ident" id="4639411">token</span><span class="op" id="4639416">[</span><span class="num" id="4639417">1</span><span class="op" id="4639418">]</span>&nbsp;<span class="op" id="4639420">=</span>&nbsp;<span class="ident" id="4639422">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639426">t</span><span class="op" id="4639427">.</span><span class="ident" id="4639428">peekCount</span>&nbsp;<span class="op" id="4639438">=</span>&nbsp;<span class="num" id="4639440">2</span><br>
<span class="lineno"></span><span class="op" id="4639442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="4639445">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="4639495">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="4639533">func</span>&nbsp;<span class="op" id="4639538">(</span><span class="ident" id="4639539">t</span>&nbsp;<span class="op" id="4639541">*</span><span class="ident" id="4639542">Tree</span><span class="op" id="4639546">)</span>&nbsp;<span class="ident" id="4639548">backup3</span><span class="op" id="4639555">(</span><span class="ident" id="4639556">t2</span><span class="op" id="4639558">,</span>&nbsp;<span class="ident" id="4639560">t1</span>&nbsp;<span class="ident" id="4639563">item</span><span class="op" id="4639567">)</span>&nbsp;<span class="op" id="4639569">{</span>&nbsp;<span class="comment" id="4639571">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639610">t</span><span class="op" id="4639611">.</span><span class="ident" id="4639612">token</span><span class="op" id="4639617">[</span><span class="num" id="4639618">1</span><span class="op" id="4639619">]</span>&nbsp;<span class="op" id="4639621">=</span>&nbsp;<span class="ident" id="4639623">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639627">t</span><span class="op" id="4639628">.</span><span class="ident" id="4639629">token</span><span class="op" id="4639634">[</span><span class="num" id="4639635">2</span><span class="op" id="4639636">]</span>&nbsp;<span class="op" id="4639638">=</span>&nbsp;<span class="ident" id="4639640">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639644">t</span><span class="op" id="4639645">.</span><span class="ident" id="4639646">peekCount</span>&nbsp;<span class="op" id="4639656">=</span>&nbsp;<span class="num" id="4639658">3</span><br>
<span class="lineno"></span><span class="op" id="4639660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4639663">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4639716">func</span>&nbsp;<span class="op" id="4639721">(</span><span class="ident" id="4639722">t</span>&nbsp;<span class="op" id="4639724">*</span><span class="ident" id="4639725">Tree</span><span class="op" id="4639729">)</span>&nbsp;<span class="ident" id="4639731">peek</span><span class="op" id="4639735">(</span><span class="op" id="4639736">)</span>&nbsp;<span class="ident" id="4639738">item</span>&nbsp;<span class="op" id="4639743">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639746">if</span>&nbsp;<span class="ident" id="4639749">t</span><span class="op" id="4639750">.</span><span class="ident" id="4639751">peekCount</span>&nbsp;<span class="op" id="4639761">&gt;</span>&nbsp;<span class="num" id="4639763">0</span>&nbsp;<span class="op" id="4639765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639769">return</span>&nbsp;<span class="ident" id="4639776">t</span><span class="op" id="4639777">.</span><span class="ident" id="4639778">token</span><span class="op" id="4639783">[</span><span class="ident" id="4639784">t</span><span class="op" id="4639785">.</span><span class="ident" id="4639786">peekCount</span><span class="op" id="4639795">-</span><span class="num" id="4639796">1</span><span class="op" id="4639797">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4639800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639803">t</span><span class="op" id="4639804">.</span><span class="ident" id="4639805">peekCount</span>&nbsp;<span class="op" id="4639815">=</span>&nbsp;<span class="num" id="4639817">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639820">t</span><span class="op" id="4639821">.</span><span class="ident" id="4639822">token</span><span class="op" id="4639827">[</span><span class="num" id="4639828">0</span><span class="op" id="4639829">]</span>&nbsp;<span class="op" id="4639831">=</span>&nbsp;<span class="ident" id="4639833">t</span><span class="op" id="4639834">.</span><span class="ident" id="4639835">lex</span><span class="op" id="4639838">.</span><span class="ident" id="4639839">nextItem</span><span class="op" id="4639847">(</span><span class="op" id="4639848">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639851">return</span>&nbsp;<span class="ident" id="4639858">t</span><span class="op" id="4639859">.</span><span class="ident" id="4639860">token</span><span class="op" id="4639865">[</span><span class="num" id="4639866">0</span><span class="op" id="4639867">]</span><br>
<span class="lineno"></span><span class="op" id="4639869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4639872">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="4639922">func</span>&nbsp;<span class="op" id="4639927">(</span><span class="ident" id="4639928">t</span>&nbsp;<span class="op" id="4639930">*</span><span class="ident" id="4639931">Tree</span><span class="op" id="4639935">)</span>&nbsp;<span class="ident" id="4639937">nextNonSpace</span><span class="op" id="4639949">(</span><span class="op" id="4639950">)</span>&nbsp;<span class="op" id="4639952">(</span><span class="ident" id="4639953">token</span>&nbsp;<span class="ident" id="4639959">item</span><span class="op" id="4639963">)</span>&nbsp;<span class="op" id="4639965">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639968">for</span>&nbsp;<span class="op" id="4639972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4639976">token</span>&nbsp;<span class="op" id="4639982">=</span>&nbsp;<span class="ident" id="4639984">t</span><span class="op" id="4639985">.</span><span class="ident" id="4639986">next</span><span class="op" id="4639990">(</span><span class="op" id="4639991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4639995">if</span>&nbsp;<span class="ident" id="4639998">token</span><span class="op" id="4640003">.</span><span class="ident" id="4640004">typ</span>&nbsp;<span class="op" id="4640008">!=</span>&nbsp;<span class="ident" id="4640011">itemSpace</span>&nbsp;<span class="op" id="4640021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640026">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640034">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640040">return</span>&nbsp;<span class="ident" id="4640047">token</span><br>
<span class="lineno"></span><span class="op" id="4640053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4640056">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="4640127">func</span>&nbsp;<span class="op" id="4640132">(</span><span class="ident" id="4640133">t</span>&nbsp;<span class="op" id="4640135">*</span><span class="ident" id="4640136">Tree</span><span class="op" id="4640140">)</span>&nbsp;<span class="ident" id="4640142">peekNonSpace</span><span class="op" id="4640154">(</span><span class="op" id="4640155">)</span>&nbsp;<span class="op" id="4640157">(</span><span class="ident" id="4640158">token</span>&nbsp;<span class="ident" id="4640164">item</span><span class="op" id="4640168">)</span>&nbsp;<span class="op" id="4640170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640173">for</span>&nbsp;<span class="op" id="4640177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640181">token</span>&nbsp;<span class="op" id="4640187">=</span>&nbsp;<span class="ident" id="4640189">t</span><span class="op" id="4640190">.</span><span class="ident" id="4640191">next</span><span class="op" id="4640195">(</span><span class="op" id="4640196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640200">if</span>&nbsp;<span class="ident" id="4640203">token</span><span class="op" id="4640208">.</span><span class="ident" id="4640209">typ</span>&nbsp;<span class="op" id="4640213">!=</span>&nbsp;<span class="ident" id="4640216">itemSpace</span>&nbsp;<span class="op" id="4640226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640231">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640245">t</span><span class="op" id="4640246">.</span><span class="ident" id="4640247">backup</span><span class="op" id="4640253">(</span><span class="op" id="4640254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640257">return</span>&nbsp;<span class="ident" id="4640264">token</span><br>
<span class="lineno"></span><span class="op" id="4640270">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="4640273">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4640286">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4640341">func</span>&nbsp;<span class="ident" id="4640346">New</span><span class="op" id="4640349">(</span><span class="ident" id="4640350">name</span>&nbsp;<span class="builtintype" id="4640355">string</span><span class="op" id="4640361">,</span>&nbsp;<span class="ident" id="4640363">funcs</span>&nbsp;<span class="op" id="4640369">...</span><span class="keyword" id="4640372">map</span><span class="op" id="4640375">[</span><span class="builtintype" id="4640376">string</span><span class="op" id="4640382">]</span><span class="keyword" id="4640383">interface</span><span class="op" id="4640392">{</span><span class="op" id="4640393">}</span><span class="op" id="4640394">)</span>&nbsp;<span class="op" id="4640396">*</span><span class="ident" id="4640397">Tree</span>&nbsp;<span class="op" id="4640402">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640405">return</span>&nbsp;<span class="op" id="4640412">&amp;</span><span class="ident" id="4640413">Tree</span><span class="op" id="4640417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640421">Name</span><span class="op" id="4640425">:</span>&nbsp;&nbsp;<span class="ident" id="4640428">name</span><span class="op" id="4640432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640436">funcs</span><span class="op" id="4640441">:</span>&nbsp;<span class="ident" id="4640443">funcs</span><span class="op" id="4640448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640451">}</span><br>
<span class="lineno"></span><span class="op" id="4640453">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4640456">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="4640552">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="4640639">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="4640671">func</span>&nbsp;<span class="op" id="4640676">(</span><span class="ident" id="4640677">t</span>&nbsp;<span class="op" id="4640679">*</span><span class="ident" id="4640680">Tree</span><span class="op" id="4640684">)</span>&nbsp;<span class="ident" id="4640686">ErrorContext</span><span class="op" id="4640698">(</span><span class="ident" id="4640699">n</span>&nbsp;<span class="ident" id="4640701">Node</span><span class="op" id="4640705">)</span>&nbsp;<span class="op" id="4640707">(</span><span class="ident" id="4640708">location</span><span class="op" id="4640716">,</span>&nbsp;<span class="ident" id="4640718">context</span>&nbsp;<span class="builtintype" id="4640726">string</span><span class="op" id="4640732">)</span>&nbsp;<span class="op" id="4640734">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640737">pos</span>&nbsp;<span class="op" id="4640741">:=</span>&nbsp;<span class="builtintype" id="4640744">int</span><span class="op" id="4640747">(</span><span class="ident" id="4640748">n</span><span class="op" id="4640749">.</span><span class="ident" id="4640750">Position</span><span class="op" id="4640758">(</span><span class="op" id="4640759">)</span><span class="op" id="4640760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640763">tree</span>&nbsp;<span class="op" id="4640768">:=</span>&nbsp;<span class="ident" id="4640771">n</span><span class="op" id="4640772">.</span><span class="ident" id="4640773">tree</span><span class="op" id="4640777">(</span><span class="op" id="4640778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640781">if</span>&nbsp;<span class="ident" id="4640784">tree</span>&nbsp;<span class="op" id="4640789">==</span>&nbsp;<span class="ident" id="4640792">nil</span>&nbsp;<span class="op" id="4640796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640800">tree</span>&nbsp;<span class="op" id="4640805">=</span>&nbsp;<span class="ident" id="4640807">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640810">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640813">text</span>&nbsp;<span class="op" id="4640818">:=</span>&nbsp;<span class="ident" id="4640821">tree</span><span class="op" id="4640825">.</span><span class="ident" id="4640826">text</span><span class="op" id="4640830">[</span><span class="op" id="4640831">:</span><span class="ident" id="4640832">pos</span><span class="op" id="4640835">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640838">byteNum</span>&nbsp;<span class="op" id="4640846">:=</span>&nbsp;<span class="ident" id="4640849">strings</span><span class="op" id="4640856">.</span><span class="ident" id="4640857">LastIndex</span><span class="op" id="4640866">(</span><span class="ident" id="4640867">text</span><span class="op" id="4640871">,</span>&nbsp;<span class="string" id="4640873">&#34;\n&#34;</span><span class="op" id="4640877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4640880">if</span>&nbsp;<span class="ident" id="4640883">byteNum</span>&nbsp;<span class="op" id="4640891">==</span>&nbsp;<span class="op" id="4640894">-</span><span class="num" id="4640895">1</span>&nbsp;<span class="op" id="4640897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640901">byteNum</span>&nbsp;<span class="op" id="4640909">=</span>&nbsp;<span class="ident" id="4640911">pos</span>&nbsp;<span class="comment" id="4640915">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4640934">}</span>&nbsp;<span class="keyword" id="4640936">else</span>&nbsp;<span class="op" id="4640941">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640945">byteNum</span><span class="op" id="4640952">++</span>&nbsp;<span class="comment" id="4640955">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4640979">byteNum</span>&nbsp;<span class="op" id="4640987">=</span>&nbsp;<span class="ident" id="4640989">pos</span>&nbsp;<span class="op" id="4640993">-</span>&nbsp;<span class="ident" id="4640995">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4641004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641007">lineNum</span>&nbsp;<span class="op" id="4641015">:=</span>&nbsp;<span class="num" id="4641018">1</span>&nbsp;<span class="op" id="4641020">+</span>&nbsp;<span class="ident" id="4641022">strings</span><span class="op" id="4641029">.</span><span class="ident" id="4641030">Count</span><span class="op" id="4641035">(</span><span class="ident" id="4641036">text</span><span class="op" id="4641040">,</span>&nbsp;<span class="string" id="4641042">&#34;\n&#34;</span><span class="op" id="4641046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641049">context</span>&nbsp;<span class="op" id="4641057">=</span>&nbsp;<span class="ident" id="4641059">n</span><span class="op" id="4641060">.</span><span class="ident" id="4641061">String</span><span class="op" id="4641067">(</span><span class="op" id="4641068">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4641071">if</span>&nbsp;<span class="builtinfunc" id="4641074">len</span><span class="op" id="4641077">(</span><span class="ident" id="4641078">context</span><span class="op" id="4641085">)</span>&nbsp;<span class="op" id="4641087">&gt;</span>&nbsp;<span class="num" id="4641089">20</span>&nbsp;<span class="op" id="4641092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641096">context</span>&nbsp;<span class="op" id="4641104">=</span>&nbsp;<span class="ident" id="4641106">fmt</span><span class="op" id="4641109">.</span><span class="ident" id="4641110">Sprintf</span><span class="op" id="4641117">(</span><span class="string" id="4641118">&#34;%.20s...&#34;</span><span class="op" id="4641128">,</span>&nbsp;<span class="ident" id="4641130">context</span><span class="op" id="4641137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4641140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4641143">return</span>&nbsp;<span class="ident" id="4641150">fmt</span><span class="op" id="4641153">.</span><span class="ident" id="4641154">Sprintf</span><span class="op" id="4641161">(</span><span class="string" id="4641162">&#34;%s:%d:%d&#34;</span><span class="op" id="4641172">,</span>&nbsp;<span class="ident" id="4641174">tree</span><span class="op" id="4641178">.</span><span class="ident" id="4641179">ParseName</span><span class="op" id="4641188">,</span>&nbsp;<span class="ident" id="4641190">lineNum</span><span class="op" id="4641197">,</span>&nbsp;<span class="ident" id="4641199">byteNum</span><span class="op" id="4641206">)</span><span class="op" id="4641207">,</span>&nbsp;<span class="ident" id="4641209">context</span><br>
<span class="lineno"></span><span class="op" id="4641217">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4641220">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4641275">func</span>&nbsp;<span class="op" id="4641280">(</span><span class="ident" id="4641281">t</span>&nbsp;<span class="op" id="4641283">*</span><span class="ident" id="4641284">Tree</span><span class="op" id="4641288">)</span>&nbsp;<span class="ident" id="4641290">errorf</span><span class="op" id="4641296">(</span><span class="ident" id="4641297">format</span>&nbsp;<span class="builtintype" id="4641304">string</span><span class="op" id="4641310">,</span>&nbsp;<span class="ident" id="4641312">args</span>&nbsp;<span class="op" id="4641317">...</span><span class="keyword" id="4641320">interface</span><span class="op" id="4641329">{</span><span class="op" id="4641330">}</span><span class="op" id="4641331">)</span>&nbsp;<span class="op" id="4641333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641336">t</span><span class="op" id="4641337">.</span><span class="ident" id="4641338">Root</span>&nbsp;<span class="op" id="4641343">=</span>&nbsp;<span class="ident" id="4641345">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641350">format</span>&nbsp;<span class="op" id="4641357">=</span>&nbsp;<span class="ident" id="4641359">fmt</span><span class="op" id="4641362">.</span><span class="ident" id="4641363">Sprintf</span><span class="op" id="4641370">(</span><span class="string" id="4641371">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="4641392">,</span>&nbsp;<span class="ident" id="4641394">t</span><span class="op" id="4641395">.</span><span class="ident" id="4641396">ParseName</span><span class="op" id="4641405">,</span>&nbsp;<span class="ident" id="4641407">t</span><span class="op" id="4641408">.</span><span class="ident" id="4641409">lex</span><span class="op" id="4641412">.</span><span class="ident" id="4641413">lineNumber</span><span class="op" id="4641423">(</span><span class="op" id="4641424">)</span><span class="op" id="4641425">,</span>&nbsp;<span class="ident" id="4641427">format</span><span class="op" id="4641433">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4641436">panic</span><span class="op" id="4641441">(</span><span class="ident" id="4641442">fmt</span><span class="op" id="4641445">.</span><span class="ident" id="4641446">Errorf</span><span class="op" id="4641452">(</span><span class="ident" id="4641453">format</span><span class="op" id="4641459">,</span>&nbsp;<span class="ident" id="4641461">args</span><span class="op" id="4641465">...</span><span class="op" id="4641468">)</span><span class="op" id="4641469">)</span><br>
<span class="lineno"></span><span class="op" id="4641471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4641474">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4641506">func</span>&nbsp;<span class="op" id="4641511">(</span><span class="ident" id="4641512">t</span>&nbsp;<span class="op" id="4641514">*</span><span class="ident" id="4641515">Tree</span><span class="op" id="4641519">)</span>&nbsp;<span class="builtintype" id="4641521">error</span><span class="op" id="4641526">(</span><span class="ident" id="4641527">err</span>&nbsp;<span class="builtintype" id="4641531">error</span><span class="op" id="4641536">)</span>&nbsp;<span class="op" id="4641538">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641541">t</span><span class="op" id="4641542">.</span><span class="ident" id="4641543">errorf</span><span class="op" id="4641549">(</span><span class="string" id="4641550">&#34;%s&#34;</span><span class="op" id="4641554">,</span>&nbsp;<span class="ident" id="4641556">err</span><span class="op" id="4641559">)</span><br>
<span class="lineno"></span><span class="op" id="4641561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4641564">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4641639">func</span>&nbsp;<span class="op" id="4641644">(</span><span class="ident" id="4641645">t</span>&nbsp;<span class="op" id="4641647">*</span><span class="ident" id="4641648">Tree</span><span class="op" id="4641652">)</span>&nbsp;<span class="ident" id="4641654">expect</span><span class="op" id="4641660">(</span><span class="ident" id="4641661">expected</span>&nbsp;<span class="ident" id="4641670">itemType</span><span class="op" id="4641678">,</span>&nbsp;<span class="ident" id="4641680">context</span>&nbsp;<span class="builtintype" id="4641688">string</span><span class="op" id="4641694">)</span>&nbsp;<span class="ident" id="4641696">item</span>&nbsp;<span class="op" id="4641701">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641704">token</span>&nbsp;<span class="op" id="4641710">:=</span>&nbsp;<span class="ident" id="4641713">t</span><span class="op" id="4641714">.</span><span class="ident" id="4641715">nextNonSpace</span><span class="op" id="4641727">(</span><span class="op" id="4641728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4641731">if</span>&nbsp;<span class="ident" id="4641734">token</span><span class="op" id="4641739">.</span><span class="ident" id="4641740">typ</span>&nbsp;<span class="op" id="4641744">!=</span>&nbsp;<span class="ident" id="4641747">expected</span>&nbsp;<span class="op" id="4641756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641760">t</span><span class="op" id="4641761">.</span><span class="ident" id="4641762">unexpected</span><span class="op" id="4641772">(</span><span class="ident" id="4641773">token</span><span class="op" id="4641778">,</span>&nbsp;<span class="ident" id="4641780">context</span><span class="op" id="4641787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4641790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4641793">return</span>&nbsp;<span class="ident" id="4641800">token</span><br>
<span class="lineno">175</span><span class="op" id="4641806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4641809">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="4641897">func</span>&nbsp;<span class="op" id="4641902">(</span><span class="ident" id="4641903">t</span>&nbsp;<span class="op" id="4641905">*</span><span class="ident" id="4641906">Tree</span><span class="op" id="4641910">)</span>&nbsp;<span class="ident" id="4641912">expectOneOf</span><span class="op" id="4641923">(</span><span class="ident" id="4641924">expected1</span><span class="op" id="4641933">,</span>&nbsp;<span class="ident" id="4641935">expected2</span>&nbsp;<span class="ident" id="4641945">itemType</span><span class="op" id="4641953">,</span>&nbsp;<span class="ident" id="4641955">context</span>&nbsp;<span class="builtintype" id="4641963">string</span><span class="op" id="4641969">)</span>&nbsp;<span class="ident" id="4641971">item</span>&nbsp;<span class="op" id="4641976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4641979">token</span>&nbsp;<span class="op" id="4641985">:=</span>&nbsp;<span class="ident" id="4641988">t</span><span class="op" id="4641989">.</span><span class="ident" id="4641990">nextNonSpace</span><span class="op" id="4642002">(</span><span class="op" id="4642003">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642006">if</span>&nbsp;<span class="ident" id="4642009">token</span><span class="op" id="4642014">.</span><span class="ident" id="4642015">typ</span>&nbsp;<span class="op" id="4642019">!=</span>&nbsp;<span class="ident" id="4642022">expected1</span>&nbsp;<span class="op" id="4642032">&amp;&amp;</span>&nbsp;<span class="ident" id="4642035">token</span><span class="op" id="4642040">.</span><span class="ident" id="4642041">typ</span>&nbsp;<span class="op" id="4642045">!=</span>&nbsp;<span class="ident" id="4642048">expected2</span>&nbsp;<span class="op" id="4642058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642062">t</span><span class="op" id="4642063">.</span><span class="ident" id="4642064">unexpected</span><span class="op" id="4642074">(</span><span class="ident" id="4642075">token</span><span class="op" id="4642080">,</span>&nbsp;<span class="ident" id="4642082">context</span><span class="op" id="4642089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4642092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642095">return</span>&nbsp;<span class="ident" id="4642102">token</span><br>
<span class="lineno"></span><span class="op" id="4642108">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="4642111">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="4642178">func</span>&nbsp;<span class="op" id="4642183">(</span><span class="ident" id="4642184">t</span>&nbsp;<span class="op" id="4642186">*</span><span class="ident" id="4642187">Tree</span><span class="op" id="4642191">)</span>&nbsp;<span class="ident" id="4642193">unexpected</span><span class="op" id="4642203">(</span><span class="ident" id="4642204">token</span>&nbsp;<span class="ident" id="4642210">item</span><span class="op" id="4642214">,</span>&nbsp;<span class="ident" id="4642216">context</span>&nbsp;<span class="builtintype" id="4642224">string</span><span class="op" id="4642230">)</span>&nbsp;<span class="op" id="4642232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642235">t</span><span class="op" id="4642236">.</span><span class="ident" id="4642237">errorf</span><span class="op" id="4642243">(</span><span class="string" id="4642244">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4642265">,</span>&nbsp;<span class="ident" id="4642267">token</span><span class="op" id="4642272">,</span>&nbsp;<span class="ident" id="4642274">context</span><span class="op" id="4642281">)</span><br>
<span class="lineno"></span><span class="op" id="4642283">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4642286">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="4642372">func</span>&nbsp;<span class="op" id="4642377">(</span><span class="ident" id="4642378">t</span>&nbsp;<span class="op" id="4642380">*</span><span class="ident" id="4642381">Tree</span><span class="op" id="4642385">)</span>&nbsp;<span class="builtinfunc" id="4642387">recover</span><span class="op" id="4642394">(</span><span class="ident" id="4642395">errp</span>&nbsp;<span class="op" id="4642400">*</span><span class="builtintype" id="4642401">error</span><span class="op" id="4642406">)</span>&nbsp;<span class="op" id="4642408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642411">e</span>&nbsp;<span class="op" id="4642413">:=</span>&nbsp;<span class="builtinfunc" id="4642416">recover</span><span class="op" id="4642423">(</span><span class="op" id="4642424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642427">if</span>&nbsp;<span class="ident" id="4642430">e</span>&nbsp;<span class="op" id="4642432">!=</span>&nbsp;<span class="ident" id="4642435">nil</span>&nbsp;<span class="op" id="4642439">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642443">if</span>&nbsp;<span class="ident" id="4642446">_</span><span class="op" id="4642447">,</span>&nbsp;<span class="ident" id="4642449">ok</span>&nbsp;<span class="op" id="4642452">:=</span>&nbsp;<span class="ident" id="4642455">e</span><span class="op" id="4642456">.</span><span class="op" id="4642457">(</span><span class="ident" id="4642458">runtime</span><span class="op" id="4642465">.</span><span class="ident" id="4642466">Error</span><span class="op" id="4642471">)</span><span class="op" id="4642472">;</span>&nbsp;<span class="ident" id="4642474">ok</span>&nbsp;<span class="op" id="4642477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4642482">panic</span><span class="op" id="4642487">(</span><span class="ident" id="4642488">e</span><span class="op" id="4642489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4642493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642497">if</span>&nbsp;<span class="ident" id="4642500">t</span>&nbsp;<span class="op" id="4642502">!=</span>&nbsp;<span class="ident" id="4642505">nil</span>&nbsp;<span class="op" id="4642509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642514">t</span><span class="op" id="4642515">.</span><span class="ident" id="4642516">stopParse</span><span class="op" id="4642525">(</span><span class="op" id="4642526">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4642530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4642534">*</span><span class="ident" id="4642535">errp</span>&nbsp;<span class="op" id="4642540">=</span>&nbsp;<span class="ident" id="4642542">e</span><span class="op" id="4642543">.</span><span class="op" id="4642544">(</span><span class="builtintype" id="4642545">error</span><span class="op" id="4642550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4642553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4642556">return</span><br>
<span class="lineno"></span><span class="op" id="4642563">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="4642566">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="4642621">func</span>&nbsp;<span class="op" id="4642626">(</span><span class="ident" id="4642627">t</span>&nbsp;<span class="op" id="4642629">*</span><span class="ident" id="4642630">Tree</span><span class="op" id="4642634">)</span>&nbsp;<span class="ident" id="4642636">startParse</span><span class="op" id="4642646">(</span><span class="ident" id="4642647">funcs</span>&nbsp;<span class="op" id="4642653">[</span><span class="op" id="4642654">]</span><span class="keyword" id="4642655">map</span><span class="op" id="4642658">[</span><span class="builtintype" id="4642659">string</span><span class="op" id="4642665">]</span><span class="keyword" id="4642666">interface</span><span class="op" id="4642675">{</span><span class="op" id="4642676">}</span><span class="op" id="4642677">,</span>&nbsp;<span class="ident" id="4642679">lex</span>&nbsp;<span class="op" id="4642683">*</span><span class="ident" id="4642684">lexer</span><span class="op" id="4642689">)</span>&nbsp;<span class="op" id="4642691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642694">t</span><span class="op" id="4642695">.</span><span class="ident" id="4642696">Root</span>&nbsp;<span class="op" id="4642701">=</span>&nbsp;<span class="ident" id="4642703">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642708">t</span><span class="op" id="4642709">.</span><span class="ident" id="4642710">lex</span>&nbsp;<span class="op" id="4642714">=</span>&nbsp;<span class="ident" id="4642716">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642721">t</span><span class="op" id="4642722">.</span><span class="ident" id="4642723">vars</span>&nbsp;<span class="op" id="4642728">=</span>&nbsp;<span class="op" id="4642730">[</span><span class="op" id="4642731">]</span><span class="builtintype" id="4642732">string</span><span class="op" id="4642738">{</span><span class="string" id="4642739">&#34;$&#34;</span><span class="op" id="4642742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642745">t</span><span class="op" id="4642746">.</span><span class="ident" id="4642747">funcs</span>&nbsp;<span class="op" id="4642753">=</span>&nbsp;<span class="ident" id="4642755">funcs</span><br>
<span class="lineno"></span><span class="op" id="4642761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4642764">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="4642797">func</span>&nbsp;<span class="op" id="4642802">(</span><span class="ident" id="4642803">t</span>&nbsp;<span class="op" id="4642805">*</span><span class="ident" id="4642806">Tree</span><span class="op" id="4642810">)</span>&nbsp;<span class="ident" id="4642812">stopParse</span><span class="op" id="4642821">(</span><span class="op" id="4642822">)</span>&nbsp;<span class="op" id="4642824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642827">t</span><span class="op" id="4642828">.</span><span class="ident" id="4642829">lex</span>&nbsp;<span class="op" id="4642833">=</span>&nbsp;<span class="ident" id="4642835">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642840">t</span><span class="op" id="4642841">.</span><span class="ident" id="4642842">vars</span>&nbsp;<span class="op" id="4642847">=</span>&nbsp;<span class="ident" id="4642849">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4642854">t</span><span class="op" id="4642855">.</span><span class="ident" id="4642856">funcs</span>&nbsp;<span class="op" id="4642862">=</span>&nbsp;<span class="ident" id="4642864">nil</span><br>
<span class="lineno"></span><span class="op" id="4642868">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4642871">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4642951">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4643030">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4643108">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="4643128">func</span>&nbsp;<span class="op" id="4643133">(</span><span class="ident" id="4643134">t</span>&nbsp;<span class="op" id="4643136">*</span><span class="ident" id="4643137">Tree</span><span class="op" id="4643141">)</span>&nbsp;<span class="ident" id="4643143">Parse</span><span class="op" id="4643148">(</span><span class="ident" id="4643149">text</span><span class="op" id="4643153">,</span>&nbsp;<span class="ident" id="4643155">leftDelim</span><span class="op" id="4643164">,</span>&nbsp;<span class="ident" id="4643166">rightDelim</span>&nbsp;<span class="builtintype" id="4643177">string</span><span class="op" id="4643183">,</span>&nbsp;<span class="ident" id="4643185">treeSet</span>&nbsp;<span class="keyword" id="4643193">map</span><span class="op" id="4643196">[</span><span class="builtintype" id="4643197">string</span><span class="op" id="4643203">]</span><span class="op" id="4643204">*</span><span class="ident" id="4643205">Tree</span><span class="op" id="4643209">,</span>&nbsp;<span class="ident" id="4643211">funcs</span>&nbsp;<span class="op" id="4643217">...</span><span class="keyword" id="4643220">map</span><span class="op" id="4643223">[</span><span class="builtintype" id="4643224">string</span><span class="op" id="4643230">]</span><span class="keyword" id="4643231">interface</span><span class="op" id="4643240">{</span><span class="op" id="4643241">}</span><span class="op" id="4643242">)</span>&nbsp;<span class="op" id="4643244">(</span><span class="ident" id="4643245">tree</span>&nbsp;<span class="op" id="4643250">*</span><span class="ident" id="4643251">Tree</span><span class="op" id="4643255">,</span>&nbsp;<span class="ident" id="4643257">err</span>&nbsp;<span class="builtintype" id="4643261">error</span><span class="op" id="4643266">)</span>&nbsp;<span class="op" id="4643268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643271">defer</span>&nbsp;<span class="ident" id="4643277">t</span><span class="op" id="4643278">.</span><span class="builtinfunc" id="4643279">recover</span><span class="op" id="4643286">(</span><span class="op" id="4643287">&amp;</span><span class="ident" id="4643288">err</span><span class="op" id="4643291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643294">t</span><span class="op" id="4643295">.</span><span class="ident" id="4643296">ParseName</span>&nbsp;<span class="op" id="4643306">=</span>&nbsp;<span class="ident" id="4643308">t</span><span class="op" id="4643309">.</span><span class="ident" id="4643310">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643316">t</span><span class="op" id="4643317">.</span><span class="ident" id="4643318">startParse</span><span class="op" id="4643328">(</span><span class="ident" id="4643329">funcs</span><span class="op" id="4643334">,</span>&nbsp;<span class="ident" id="4643336">lex</span><span class="op" id="4643339">(</span><span class="ident" id="4643340">t</span><span class="op" id="4643341">.</span><span class="ident" id="4643342">Name</span><span class="op" id="4643346">,</span>&nbsp;<span class="ident" id="4643348">text</span><span class="op" id="4643352">,</span>&nbsp;<span class="ident" id="4643354">leftDelim</span><span class="op" id="4643363">,</span>&nbsp;<span class="ident" id="4643365">rightDelim</span><span class="op" id="4643375">)</span><span class="op" id="4643376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643379">t</span><span class="op" id="4643380">.</span><span class="ident" id="4643381">text</span>&nbsp;<span class="op" id="4643386">=</span>&nbsp;<span class="ident" id="4643388">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643394">t</span><span class="op" id="4643395">.</span><span class="ident" id="4643396">parse</span><span class="op" id="4643401">(</span><span class="ident" id="4643402">treeSet</span><span class="op" id="4643409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643412">t</span><span class="op" id="4643413">.</span><span class="ident" id="4643414">add</span><span class="op" id="4643417">(</span><span class="ident" id="4643418">treeSet</span><span class="op" id="4643425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643428">t</span><span class="op" id="4643429">.</span><span class="ident" id="4643430">stopParse</span><span class="op" id="4643439">(</span><span class="op" id="4643440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643443">return</span>&nbsp;<span class="ident" id="4643450">t</span><span class="op" id="4643451">,</span>&nbsp;<span class="ident" id="4643453">nil</span><br>
<span class="lineno"></span><span class="op" id="4643457">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4643460">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="4643493">func</span>&nbsp;<span class="op" id="4643498">(</span><span class="ident" id="4643499">t</span>&nbsp;<span class="op" id="4643501">*</span><span class="ident" id="4643502">Tree</span><span class="op" id="4643506">)</span>&nbsp;<span class="ident" id="4643508">add</span><span class="op" id="4643511">(</span><span class="ident" id="4643512">treeSet</span>&nbsp;<span class="keyword" id="4643520">map</span><span class="op" id="4643523">[</span><span class="builtintype" id="4643524">string</span><span class="op" id="4643530">]</span><span class="op" id="4643531">*</span><span class="ident" id="4643532">Tree</span><span class="op" id="4643536">)</span>&nbsp;<span class="op" id="4643538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643541">tree</span>&nbsp;<span class="op" id="4643546">:=</span>&nbsp;<span class="ident" id="4643549">treeSet</span><span class="op" id="4643556">[</span><span class="ident" id="4643557">t</span><span class="op" id="4643558">.</span><span class="ident" id="4643559">Name</span><span class="op" id="4643563">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643566">if</span>&nbsp;<span class="ident" id="4643569">tree</span>&nbsp;<span class="op" id="4643574">==</span>&nbsp;<span class="ident" id="4643577">nil</span>&nbsp;<span class="op" id="4643581">||</span>&nbsp;<span class="ident" id="4643584">IsEmptyTree</span><span class="op" id="4643595">(</span><span class="ident" id="4643596">tree</span><span class="op" id="4643600">.</span><span class="ident" id="4643601">Root</span><span class="op" id="4643605">)</span>&nbsp;<span class="op" id="4643607">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643611">treeSet</span><span class="op" id="4643618">[</span><span class="ident" id="4643619">t</span><span class="op" id="4643620">.</span><span class="ident" id="4643621">Name</span><span class="op" id="4643625">]</span>&nbsp;<span class="op" id="4643627">=</span>&nbsp;<span class="ident" id="4643629">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643633">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4643641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643644">if</span>&nbsp;<span class="op" id="4643647">!</span><span class="ident" id="4643648">IsEmptyTree</span><span class="op" id="4643659">(</span><span class="ident" id="4643660">t</span><span class="op" id="4643661">.</span><span class="ident" id="4643662">Root</span><span class="op" id="4643666">)</span>&nbsp;<span class="op" id="4643668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4643672">t</span><span class="op" id="4643673">.</span><span class="ident" id="4643674">errorf</span><span class="op" id="4643680">(</span><span class="string" id="4643681">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="4643727">,</span>&nbsp;<span class="ident" id="4643729">t</span><span class="op" id="4643730">.</span><span class="ident" id="4643731">Name</span><span class="op" id="4643735">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4643738">}</span><br>
<span class="lineno"></span><span class="op" id="4643740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4643743">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="4643825">func</span>&nbsp;<span class="ident" id="4643830">IsEmptyTree</span><span class="op" id="4643841">(</span><span class="ident" id="4643842">n</span>&nbsp;<span class="ident" id="4643844">Node</span><span class="op" id="4643848">)</span>&nbsp;<span class="builtintype" id="4643850">bool</span>&nbsp;<span class="op" id="4643855">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643858">switch</span>&nbsp;<span class="ident" id="4643865">n</span>&nbsp;<span class="op" id="4643867">:=</span>&nbsp;<span class="ident" id="4643870">n</span><span class="op" id="4643871">.</span><span class="op" id="4643872">(</span><span class="keyword" id="4643873">type</span><span class="op" id="4643877">)</span>&nbsp;<span class="op" id="4643879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643882">case</span>&nbsp;<span class="ident" id="4643887">nil</span><span class="op" id="4643890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643894">return</span>&nbsp;<span class="builtintype" id="4643901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643907">case</span>&nbsp;<span class="op" id="4643912">*</span><span class="ident" id="4643913">ActionNode</span><span class="op" id="4643923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643926">case</span>&nbsp;<span class="op" id="4643931">*</span><span class="ident" id="4643932">IfNode</span><span class="op" id="4643938">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643941">case</span>&nbsp;<span class="op" id="4643946">*</span><span class="ident" id="4643947">ListNode</span><span class="op" id="4643955">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643959">for</span>&nbsp;<span class="ident" id="4643963">_</span><span class="op" id="4643964">,</span>&nbsp;<span class="ident" id="4643966">node</span>&nbsp;<span class="op" id="4643971">:=</span>&nbsp;<span class="keyword" id="4643974">range</span>&nbsp;<span class="ident" id="4643980">n</span><span class="op" id="4643981">.</span><span class="ident" id="4643982">Nodes</span>&nbsp;<span class="op" id="4643988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4643993">if</span>&nbsp;<span class="op" id="4643996">!</span><span class="ident" id="4643997">IsEmptyTree</span><span class="op" id="4644008">(</span><span class="ident" id="4644009">node</span><span class="op" id="4644013">)</span>&nbsp;<span class="op" id="4644015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644021">return</span>&nbsp;<span class="builtintype" id="4644028">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644037">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644045">return</span>&nbsp;<span class="builtintype" id="4644052">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644058">case</span>&nbsp;<span class="op" id="4644063">*</span><span class="ident" id="4644064">RangeNode</span><span class="op" id="4644073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644076">case</span>&nbsp;<span class="op" id="4644081">*</span><span class="ident" id="4644082">TemplateNode</span><span class="op" id="4644094">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644097">case</span>&nbsp;<span class="op" id="4644102">*</span><span class="ident" id="4644103">TextNode</span><span class="op" id="4644111">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644115">return</span>&nbsp;<span class="builtinfunc" id="4644122">len</span><span class="op" id="4644125">(</span><span class="ident" id="4644126">bytes</span><span class="op" id="4644131">.</span><span class="ident" id="4644132">TrimSpace</span><span class="op" id="4644141">(</span><span class="ident" id="4644142">n</span><span class="op" id="4644143">.</span><span class="ident" id="4644144">Text</span><span class="op" id="4644148">)</span><span class="op" id="4644149">)</span>&nbsp;<span class="op" id="4644151">==</span>&nbsp;<span class="num" id="4644154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644157">case</span>&nbsp;<span class="op" id="4644162">*</span><span class="ident" id="4644163">WithNode</span><span class="op" id="4644171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644174">default</span><span class="op" id="4644181">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4644185">panic</span><span class="op" id="4644190">(</span><span class="string" id="4644191">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="4644208">+</span>&nbsp;<span class="ident" id="4644210">n</span><span class="op" id="4644211">.</span><span class="ident" id="4644212">String</span><span class="op" id="4644218">(</span><span class="op" id="4644219">)</span><span class="op" id="4644220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644223">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644226">return</span>&nbsp;<span class="builtintype" id="4644233">false</span><br>
<span class="lineno"></span><span class="op" id="4644239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4644242">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4644312">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="4644369">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="4644388">func</span>&nbsp;<span class="op" id="4644393">(</span><span class="ident" id="4644394">t</span>&nbsp;<span class="op" id="4644396">*</span><span class="ident" id="4644397">Tree</span><span class="op" id="4644401">)</span>&nbsp;<span class="ident" id="4644403">parse</span><span class="op" id="4644408">(</span><span class="ident" id="4644409">treeSet</span>&nbsp;<span class="keyword" id="4644417">map</span><span class="op" id="4644420">[</span><span class="builtintype" id="4644421">string</span><span class="op" id="4644427">]</span><span class="op" id="4644428">*</span><span class="ident" id="4644429">Tree</span><span class="op" id="4644433">)</span>&nbsp;<span class="op" id="4644435">(</span><span class="ident" id="4644436">next</span>&nbsp;<span class="ident" id="4644441">Node</span><span class="op" id="4644445">)</span>&nbsp;<span class="op" id="4644447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644450">t</span><span class="op" id="4644451">.</span><span class="ident" id="4644452">Root</span>&nbsp;<span class="op" id="4644457">=</span>&nbsp;<span class="ident" id="4644459">t</span><span class="op" id="4644460">.</span><span class="ident" id="4644461">newList</span><span class="op" id="4644468">(</span><span class="ident" id="4644469">t</span><span class="op" id="4644470">.</span><span class="ident" id="4644471">peek</span><span class="op" id="4644475">(</span><span class="op" id="4644476">)</span><span class="op" id="4644477">.</span><span class="ident" id="4644478">pos</span><span class="op" id="4644481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644484">for</span>&nbsp;<span class="ident" id="4644488">t</span><span class="op" id="4644489">.</span><span class="ident" id="4644490">peek</span><span class="op" id="4644494">(</span><span class="op" id="4644495">)</span><span class="op" id="4644496">.</span><span class="ident" id="4644497">typ</span>&nbsp;<span class="op" id="4644501">!=</span>&nbsp;<span class="ident" id="4644504">itemEOF</span>&nbsp;<span class="op" id="4644512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644516">if</span>&nbsp;<span class="ident" id="4644519">t</span><span class="op" id="4644520">.</span><span class="ident" id="4644521">peek</span><span class="op" id="4644525">(</span><span class="op" id="4644526">)</span><span class="op" id="4644527">.</span><span class="ident" id="4644528">typ</span>&nbsp;<span class="op" id="4644532">==</span>&nbsp;<span class="ident" id="4644535">itemLeftDelim</span>&nbsp;<span class="op" id="4644549">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644554">delim</span>&nbsp;<span class="op" id="4644560">:=</span>&nbsp;<span class="ident" id="4644563">t</span><span class="op" id="4644564">.</span><span class="ident" id="4644565">next</span><span class="op" id="4644569">(</span><span class="op" id="4644570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644575">if</span>&nbsp;<span class="ident" id="4644578">t</span><span class="op" id="4644579">.</span><span class="ident" id="4644580">nextNonSpace</span><span class="op" id="4644592">(</span><span class="op" id="4644593">)</span><span class="op" id="4644594">.</span><span class="ident" id="4644595">typ</span>&nbsp;<span class="op" id="4644599">==</span>&nbsp;<span class="ident" id="4644602">itemDefine</span>&nbsp;<span class="op" id="4644613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644619">newT</span>&nbsp;<span class="op" id="4644624">:=</span>&nbsp;<span class="ident" id="4644627">New</span><span class="op" id="4644630">(</span><span class="string" id="4644631">&#34;definition&#34;</span><span class="op" id="4644643">)</span>&nbsp;<span class="comment" id="4644645">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644690">newT</span><span class="op" id="4644694">.</span><span class="ident" id="4644695">text</span>&nbsp;<span class="op" id="4644700">=</span>&nbsp;<span class="ident" id="4644702">t</span><span class="op" id="4644703">.</span><span class="ident" id="4644704">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644713">newT</span><span class="op" id="4644717">.</span><span class="ident" id="4644718">ParseName</span>&nbsp;<span class="op" id="4644728">=</span>&nbsp;<span class="ident" id="4644730">t</span><span class="op" id="4644731">.</span><span class="ident" id="4644732">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644746">newT</span><span class="op" id="4644750">.</span><span class="ident" id="4644751">startParse</span><span class="op" id="4644761">(</span><span class="ident" id="4644762">t</span><span class="op" id="4644763">.</span><span class="ident" id="4644764">funcs</span><span class="op" id="4644769">,</span>&nbsp;<span class="ident" id="4644771">t</span><span class="op" id="4644772">.</span><span class="ident" id="4644773">lex</span><span class="op" id="4644776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644782">newT</span><span class="op" id="4644786">.</span><span class="ident" id="4644787">parseDefinition</span><span class="op" id="4644802">(</span><span class="ident" id="4644803">treeSet</span><span class="op" id="4644810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644816">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644833">t</span><span class="op" id="4644834">.</span><span class="ident" id="4644835">backup2</span><span class="op" id="4644842">(</span><span class="ident" id="4644843">delim</span><span class="op" id="4644848">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644856">n</span>&nbsp;<span class="op" id="4644858">:=</span>&nbsp;<span class="ident" id="4644861">t</span><span class="op" id="4644862">.</span><span class="ident" id="4644863">textOrAction</span><span class="op" id="4644875">(</span><span class="op" id="4644876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644880">if</span>&nbsp;<span class="ident" id="4644883">n</span><span class="op" id="4644884">.</span><span class="ident" id="4644885">Type</span><span class="op" id="4644889">(</span><span class="op" id="4644890">)</span>&nbsp;<span class="op" id="4644892">==</span>&nbsp;<span class="ident" id="4644895">nodeEnd</span>&nbsp;<span class="op" id="4644903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644908">t</span><span class="op" id="4644909">.</span><span class="ident" id="4644910">errorf</span><span class="op" id="4644916">(</span><span class="string" id="4644917">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="4644932">,</span>&nbsp;<span class="ident" id="4644934">n</span><span class="op" id="4644935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644939">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4644943">t</span><span class="op" id="4644944">.</span><span class="ident" id="4644945">Root</span><span class="op" id="4644949">.</span><span class="builtinfunc" id="4644950">append</span><span class="op" id="4644956">(</span><span class="ident" id="4644957">n</span><span class="op" id="4644958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4644961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4644964">return</span>&nbsp;<span class="ident" id="4644971">nil</span><br>
<span class="lineno"></span><span class="op" id="4644975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="4644978">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4645054">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="4645135">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="4645152">func</span>&nbsp;<span class="op" id="4645157">(</span><span class="ident" id="4645158">t</span>&nbsp;<span class="op" id="4645160">*</span><span class="ident" id="4645161">Tree</span><span class="op" id="4645165">)</span>&nbsp;<span class="ident" id="4645167">parseDefinition</span><span class="op" id="4645182">(</span><span class="ident" id="4645183">treeSet</span>&nbsp;<span class="keyword" id="4645191">map</span><span class="op" id="4645194">[</span><span class="builtintype" id="4645195">string</span><span class="op" id="4645201">]</span><span class="op" id="4645202">*</span><span class="ident" id="4645203">Tree</span><span class="op" id="4645207">)</span>&nbsp;<span class="op" id="4645209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645212">const</span>&nbsp;<span class="ident" id="4645218">context</span>&nbsp;<span class="op" id="4645226">=</span>&nbsp;<span class="string" id="4645228">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645245">name</span>&nbsp;<span class="op" id="4645250">:=</span>&nbsp;<span class="ident" id="4645253">t</span><span class="op" id="4645254">.</span><span class="ident" id="4645255">expectOneOf</span><span class="op" id="4645266">(</span><span class="ident" id="4645267">itemString</span><span class="op" id="4645277">,</span>&nbsp;<span class="ident" id="4645279">itemRawString</span><span class="op" id="4645292">,</span>&nbsp;<span class="ident" id="4645294">context</span><span class="op" id="4645301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645304">var</span>&nbsp;<span class="ident" id="4645308">err</span>&nbsp;<span class="builtintype" id="4645312">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645319">t</span><span class="op" id="4645320">.</span><span class="ident" id="4645321">Name</span><span class="op" id="4645325">,</span>&nbsp;<span class="ident" id="4645327">err</span>&nbsp;<span class="op" id="4645331">=</span>&nbsp;<span class="ident" id="4645333">strconv</span><span class="op" id="4645340">.</span><span class="ident" id="4645341">Unquote</span><span class="op" id="4645348">(</span><span class="ident" id="4645349">name</span><span class="op" id="4645353">.</span><span class="ident" id="4645354">val</span><span class="op" id="4645357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645360">if</span>&nbsp;<span class="ident" id="4645363">err</span>&nbsp;<span class="op" id="4645367">!=</span>&nbsp;<span class="ident" id="4645370">nil</span>&nbsp;<span class="op" id="4645374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645378">t</span><span class="op" id="4645379">.</span><span class="builtintype" id="4645380">error</span><span class="op" id="4645385">(</span><span class="ident" id="4645386">err</span><span class="op" id="4645389">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645395">t</span><span class="op" id="4645396">.</span><span class="ident" id="4645397">expect</span><span class="op" id="4645403">(</span><span class="ident" id="4645404">itemRightDelim</span><span class="op" id="4645418">,</span>&nbsp;<span class="ident" id="4645420">context</span><span class="op" id="4645427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645430">var</span>&nbsp;<span class="ident" id="4645434">end</span>&nbsp;<span class="ident" id="4645438">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645444">t</span><span class="op" id="4645445">.</span><span class="ident" id="4645446">Root</span><span class="op" id="4645450">,</span>&nbsp;<span class="ident" id="4645452">end</span>&nbsp;<span class="op" id="4645456">=</span>&nbsp;<span class="ident" id="4645458">t</span><span class="op" id="4645459">.</span><span class="ident" id="4645460">itemList</span><span class="op" id="4645468">(</span><span class="op" id="4645469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645472">if</span>&nbsp;<span class="ident" id="4645475">end</span><span class="op" id="4645478">.</span><span class="ident" id="4645479">Type</span><span class="op" id="4645483">(</span><span class="op" id="4645484">)</span>&nbsp;<span class="op" id="4645486">!=</span>&nbsp;<span class="ident" id="4645489">nodeEnd</span>&nbsp;<span class="op" id="4645497">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645501">t</span><span class="op" id="4645502">.</span><span class="ident" id="4645503">errorf</span><span class="op" id="4645509">(</span><span class="string" id="4645510">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4645531">,</span>&nbsp;<span class="ident" id="4645533">end</span><span class="op" id="4645536">,</span>&nbsp;<span class="ident" id="4645538">context</span><span class="op" id="4645545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645551">t</span><span class="op" id="4645552">.</span><span class="ident" id="4645553">add</span><span class="op" id="4645556">(</span><span class="ident" id="4645557">treeSet</span><span class="op" id="4645564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645567">t</span><span class="op" id="4645568">.</span><span class="ident" id="4645569">stopParse</span><span class="op" id="4645578">(</span><span class="op" id="4645579">)</span><br>
<span class="lineno"></span><span class="op" id="4645581">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="4645584">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="4645597">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="4645614">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="4645673">func</span>&nbsp;<span class="op" id="4645678">(</span><span class="ident" id="4645679">t</span>&nbsp;<span class="op" id="4645681">*</span><span class="ident" id="4645682">Tree</span><span class="op" id="4645686">)</span>&nbsp;<span class="ident" id="4645688">itemList</span><span class="op" id="4645696">(</span><span class="op" id="4645697">)</span>&nbsp;<span class="op" id="4645699">(</span><span class="ident" id="4645700">list</span>&nbsp;<span class="op" id="4645705">*</span><span class="ident" id="4645706">ListNode</span><span class="op" id="4645714">,</span>&nbsp;<span class="ident" id="4645716">next</span>&nbsp;<span class="ident" id="4645721">Node</span><span class="op" id="4645725">)</span>&nbsp;<span class="op" id="4645727">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645730">list</span>&nbsp;<span class="op" id="4645735">=</span>&nbsp;<span class="ident" id="4645737">t</span><span class="op" id="4645738">.</span><span class="ident" id="4645739">newList</span><span class="op" id="4645746">(</span><span class="ident" id="4645747">t</span><span class="op" id="4645748">.</span><span class="ident" id="4645749">peekNonSpace</span><span class="op" id="4645761">(</span><span class="op" id="4645762">)</span><span class="op" id="4645763">.</span><span class="ident" id="4645764">pos</span><span class="op" id="4645767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645770">for</span>&nbsp;<span class="ident" id="4645774">t</span><span class="op" id="4645775">.</span><span class="ident" id="4645776">peekNonSpace</span><span class="op" id="4645788">(</span><span class="op" id="4645789">)</span><span class="op" id="4645790">.</span><span class="ident" id="4645791">typ</span>&nbsp;<span class="op" id="4645795">!=</span>&nbsp;<span class="ident" id="4645798">itemEOF</span>&nbsp;<span class="op" id="4645806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645810">n</span>&nbsp;<span class="op" id="4645812">:=</span>&nbsp;<span class="ident" id="4645815">t</span><span class="op" id="4645816">.</span><span class="ident" id="4645817">textOrAction</span><span class="op" id="4645829">(</span><span class="op" id="4645830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645834">switch</span>&nbsp;<span class="ident" id="4645841">n</span><span class="op" id="4645842">.</span><span class="ident" id="4645843">Type</span><span class="op" id="4645847">(</span><span class="op" id="4645848">)</span>&nbsp;<span class="op" id="4645850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645854">case</span>&nbsp;<span class="ident" id="4645859">nodeEnd</span><span class="op" id="4645866">,</span>&nbsp;<span class="ident" id="4645868">nodeElse</span><span class="op" id="4645876">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645881">return</span>&nbsp;<span class="ident" id="4645888">list</span><span class="op" id="4645892">,</span>&nbsp;<span class="ident" id="4645894">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645902">list</span><span class="op" id="4645906">.</span><span class="builtinfunc" id="4645907">append</span><span class="op" id="4645913">(</span><span class="ident" id="4645914">n</span><span class="op" id="4645915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4645918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4645921">t</span><span class="op" id="4645922">.</span><span class="ident" id="4645923">errorf</span><span class="op" id="4645929">(</span><span class="string" id="4645930">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="4645946">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4645949">return</span><br>
<span class="lineno"></span><span class="op" id="4645956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4645959">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="4645976">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="4645993">func</span>&nbsp;<span class="op" id="4645998">(</span><span class="ident" id="4645999">t</span>&nbsp;<span class="op" id="4646001">*</span><span class="ident" id="4646002">Tree</span><span class="op" id="4646006">)</span>&nbsp;<span class="ident" id="4646008">textOrAction</span><span class="op" id="4646020">(</span><span class="op" id="4646021">)</span>&nbsp;<span class="ident" id="4646023">Node</span>&nbsp;<span class="op" id="4646028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646031">switch</span>&nbsp;<span class="ident" id="4646038">token</span>&nbsp;<span class="op" id="4646044">:=</span>&nbsp;<span class="ident" id="4646047">t</span><span class="op" id="4646048">.</span><span class="ident" id="4646049">nextNonSpace</span><span class="op" id="4646061">(</span><span class="op" id="4646062">)</span><span class="op" id="4646063">;</span>&nbsp;<span class="ident" id="4646065">token</span><span class="op" id="4646070">.</span><span class="ident" id="4646071">typ</span>&nbsp;<span class="op" id="4646075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646078">case</span>&nbsp;<span class="ident" id="4646083">itemText</span><span class="op" id="4646091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646095">return</span>&nbsp;<span class="ident" id="4646102">t</span><span class="op" id="4646103">.</span><span class="ident" id="4646104">newText</span><span class="op" id="4646111">(</span><span class="ident" id="4646112">token</span><span class="op" id="4646117">.</span><span class="ident" id="4646118">pos</span><span class="op" id="4646121">,</span>&nbsp;<span class="ident" id="4646123">token</span><span class="op" id="4646128">.</span><span class="ident" id="4646129">val</span><span class="op" id="4646132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646135">case</span>&nbsp;<span class="ident" id="4646140">itemLeftDelim</span><span class="op" id="4646153">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646157">return</span>&nbsp;<span class="ident" id="4646164">t</span><span class="op" id="4646165">.</span><span class="ident" id="4646166">action</span><span class="op" id="4646172">(</span><span class="op" id="4646173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646176">default</span><span class="op" id="4646183">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646187">t</span><span class="op" id="4646188">.</span><span class="ident" id="4646189">unexpected</span><span class="op" id="4646199">(</span><span class="ident" id="4646200">token</span><span class="op" id="4646205">,</span>&nbsp;<span class="string" id="4646207">&#34;input&#34;</span><span class="op" id="4646214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646220">return</span>&nbsp;<span class="ident" id="4646227">nil</span><br>
<span class="lineno">350</span><span class="op" id="4646231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4646234">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="4646245">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="4646256">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="4646282">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="4646322">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="4646370">func</span>&nbsp;<span class="op" id="4646375">(</span><span class="ident" id="4646376">t</span>&nbsp;<span class="op" id="4646378">*</span><span class="ident" id="4646379">Tree</span><span class="op" id="4646383">)</span>&nbsp;<span class="ident" id="4646385">action</span><span class="op" id="4646391">(</span><span class="op" id="4646392">)</span>&nbsp;<span class="op" id="4646394">(</span><span class="ident" id="4646395">n</span>&nbsp;<span class="ident" id="4646397">Node</span><span class="op" id="4646401">)</span>&nbsp;<span class="op" id="4646403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646406">switch</span>&nbsp;<span class="ident" id="4646413">token</span>&nbsp;<span class="op" id="4646419">:=</span>&nbsp;<span class="ident" id="4646422">t</span><span class="op" id="4646423">.</span><span class="ident" id="4646424">nextNonSpace</span><span class="op" id="4646436">(</span><span class="op" id="4646437">)</span><span class="op" id="4646438">;</span>&nbsp;<span class="ident" id="4646440">token</span><span class="op" id="4646445">.</span><span class="ident" id="4646446">typ</span>&nbsp;<span class="op" id="4646450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646453">case</span>&nbsp;<span class="ident" id="4646458">itemElse</span><span class="op" id="4646466">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646470">return</span>&nbsp;<span class="ident" id="4646477">t</span><span class="op" id="4646478">.</span><span class="ident" id="4646479">elseControl</span><span class="op" id="4646490">(</span><span class="op" id="4646491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646494">case</span>&nbsp;<span class="ident" id="4646499">itemEnd</span><span class="op" id="4646506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646510">return</span>&nbsp;<span class="ident" id="4646517">t</span><span class="op" id="4646518">.</span><span class="ident" id="4646519">endControl</span><span class="op" id="4646529">(</span><span class="op" id="4646530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646533">case</span>&nbsp;<span class="ident" id="4646538">itemIf</span><span class="op" id="4646544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646548">return</span>&nbsp;<span class="ident" id="4646555">t</span><span class="op" id="4646556">.</span><span class="ident" id="4646557">ifControl</span><span class="op" id="4646566">(</span><span class="op" id="4646567">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646570">case</span>&nbsp;<span class="ident" id="4646575">itemRange</span><span class="op" id="4646584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646588">return</span>&nbsp;<span class="ident" id="4646595">t</span><span class="op" id="4646596">.</span><span class="ident" id="4646597">rangeControl</span><span class="op" id="4646609">(</span><span class="op" id="4646610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646613">case</span>&nbsp;<span class="ident" id="4646618">itemTemplate</span><span class="op" id="4646630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646634">return</span>&nbsp;<span class="ident" id="4646641">t</span><span class="op" id="4646642">.</span><span class="ident" id="4646643">templateControl</span><span class="op" id="4646658">(</span><span class="op" id="4646659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646662">case</span>&nbsp;<span class="ident" id="4646667">itemWith</span><span class="op" id="4646675">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646679">return</span>&nbsp;<span class="ident" id="4646686">t</span><span class="op" id="4646687">.</span><span class="ident" id="4646688">withControl</span><span class="op" id="4646699">(</span><span class="op" id="4646700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4646703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646706">t</span><span class="op" id="4646707">.</span><span class="ident" id="4646708">backup</span><span class="op" id="4646714">(</span><span class="op" id="4646715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4646718">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646770">return</span>&nbsp;<span class="ident" id="4646777">t</span><span class="op" id="4646778">.</span><span class="ident" id="4646779">newAction</span><span class="op" id="4646788">(</span><span class="ident" id="4646789">t</span><span class="op" id="4646790">.</span><span class="ident" id="4646791">peek</span><span class="op" id="4646795">(</span><span class="op" id="4646796">)</span><span class="op" id="4646797">.</span><span class="ident" id="4646798">pos</span><span class="op" id="4646801">,</span>&nbsp;<span class="ident" id="4646803">t</span><span class="op" id="4646804">.</span><span class="ident" id="4646805">lex</span><span class="op" id="4646808">.</span><span class="ident" id="4646809">lineNumber</span><span class="op" id="4646819">(</span><span class="op" id="4646820">)</span><span class="op" id="4646821">,</span>&nbsp;<span class="ident" id="4646823">t</span><span class="op" id="4646824">.</span><span class="ident" id="4646825">pipeline</span><span class="op" id="4646833">(</span><span class="string" id="4646834">&#34;command&#34;</span><span class="op" id="4646843">)</span><span class="op" id="4646844">)</span><br>
<span class="lineno">375</span><span class="op" id="4646846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4646849">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="4646862">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="4646902">func</span>&nbsp;<span class="op" id="4646907">(</span><span class="ident" id="4646908">t</span>&nbsp;<span class="op" id="4646910">*</span><span class="ident" id="4646911">Tree</span><span class="op" id="4646915">)</span>&nbsp;<span class="ident" id="4646917">pipeline</span><span class="op" id="4646925">(</span><span class="ident" id="4646926">context</span>&nbsp;<span class="builtintype" id="4646934">string</span><span class="op" id="4646940">)</span>&nbsp;<span class="op" id="4646942">(</span><span class="ident" id="4646943">pipe</span>&nbsp;<span class="op" id="4646948">*</span><span class="ident" id="4646949">PipeNode</span><span class="op" id="4646957">)</span>&nbsp;<span class="op" id="4646959">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4646962">var</span>&nbsp;<span class="ident" id="4646966">decl</span>&nbsp;<span class="op" id="4646971">[</span><span class="op" id="4646972">]</span><span class="op" id="4646973">*</span><span class="ident" id="4646974">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4646988">pos</span>&nbsp;<span class="op" id="4646992">:=</span>&nbsp;<span class="ident" id="4646995">t</span><span class="op" id="4646996">.</span><span class="ident" id="4646997">peekNonSpace</span><span class="op" id="4647009">(</span><span class="op" id="4647010">)</span><span class="op" id="4647011">.</span><span class="ident" id="4647012">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647017">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647045">for</span>&nbsp;<span class="op" id="4647049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647053">if</span>&nbsp;<span class="ident" id="4647056">v</span>&nbsp;<span class="op" id="4647058">:=</span>&nbsp;<span class="ident" id="4647061">t</span><span class="op" id="4647062">.</span><span class="ident" id="4647063">peekNonSpace</span><span class="op" id="4647075">(</span><span class="op" id="4647076">)</span><span class="op" id="4647077">;</span>&nbsp;<span class="ident" id="4647079">v</span><span class="op" id="4647080">.</span><span class="ident" id="4647081">typ</span>&nbsp;<span class="op" id="4647085">==</span>&nbsp;<span class="ident" id="4647088">itemVariable</span>&nbsp;<span class="op" id="4647101">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647106">t</span><span class="op" id="4647107">.</span><span class="ident" id="4647108">next</span><span class="op" id="4647112">(</span><span class="op" id="4647113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647118">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647199">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647282">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4647355">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647423">tokenAfterVariable</span>&nbsp;<span class="op" id="4647442">:=</span>&nbsp;<span class="ident" id="4647445">t</span><span class="op" id="4647446">.</span><span class="ident" id="4647447">peek</span><span class="op" id="4647451">(</span><span class="op" id="4647452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647457">if</span>&nbsp;<span class="ident" id="4647460">next</span>&nbsp;<span class="op" id="4647465">:=</span>&nbsp;<span class="ident" id="4647468">t</span><span class="op" id="4647469">.</span><span class="ident" id="4647470">peekNonSpace</span><span class="op" id="4647482">(</span><span class="op" id="4647483">)</span><span class="op" id="4647484">;</span>&nbsp;<span class="ident" id="4647486">next</span><span class="op" id="4647490">.</span><span class="ident" id="4647491">typ</span>&nbsp;<span class="op" id="4647495">==</span>&nbsp;<span class="ident" id="4647498">itemColonEquals</span>&nbsp;<span class="op" id="4647514">||</span>&nbsp;<span class="op" id="4647517">(</span><span class="ident" id="4647518">next</span><span class="op" id="4647522">.</span><span class="ident" id="4647523">typ</span>&nbsp;<span class="op" id="4647527">==</span>&nbsp;<span class="ident" id="4647530">itemChar</span>&nbsp;<span class="op" id="4647539">&amp;&amp;</span>&nbsp;<span class="ident" id="4647542">next</span><span class="op" id="4647546">.</span><span class="ident" id="4647547">val</span>&nbsp;<span class="op" id="4647551">==</span>&nbsp;<span class="string" id="4647554">&#34;,&#34;</span><span class="op" id="4647557">)</span>&nbsp;<span class="op" id="4647559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647565">t</span><span class="op" id="4647566">.</span><span class="ident" id="4647567">nextNonSpace</span><span class="op" id="4647579">(</span><span class="op" id="4647580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647586">variable</span>&nbsp;<span class="op" id="4647595">:=</span>&nbsp;<span class="ident" id="4647598">t</span><span class="op" id="4647599">.</span><span class="ident" id="4647600">newVariable</span><span class="op" id="4647611">(</span><span class="ident" id="4647612">v</span><span class="op" id="4647613">.</span><span class="ident" id="4647614">pos</span><span class="op" id="4647617">,</span>&nbsp;<span class="ident" id="4647619">v</span><span class="op" id="4647620">.</span><span class="ident" id="4647621">val</span><span class="op" id="4647624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647630">decl</span>&nbsp;<span class="op" id="4647635">=</span>&nbsp;<span class="builtinfunc" id="4647637">append</span><span class="op" id="4647643">(</span><span class="ident" id="4647644">decl</span><span class="op" id="4647648">,</span>&nbsp;<span class="ident" id="4647650">variable</span><span class="op" id="4647658">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647664">t</span><span class="op" id="4647665">.</span><span class="ident" id="4647666">vars</span>&nbsp;<span class="op" id="4647671">=</span>&nbsp;<span class="builtinfunc" id="4647673">append</span><span class="op" id="4647679">(</span><span class="ident" id="4647680">t</span><span class="op" id="4647681">.</span><span class="ident" id="4647682">vars</span><span class="op" id="4647686">,</span>&nbsp;<span class="ident" id="4647688">v</span><span class="op" id="4647689">.</span><span class="ident" id="4647690">val</span><span class="op" id="4647693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647699">if</span>&nbsp;<span class="ident" id="4647702">next</span><span class="op" id="4647706">.</span><span class="ident" id="4647707">typ</span>&nbsp;<span class="op" id="4647711">==</span>&nbsp;<span class="ident" id="4647714">itemChar</span>&nbsp;<span class="op" id="4647723">&amp;&amp;</span>&nbsp;<span class="ident" id="4647726">next</span><span class="op" id="4647730">.</span><span class="ident" id="4647731">val</span>&nbsp;<span class="op" id="4647735">==</span>&nbsp;<span class="string" id="4647738">&#34;,&#34;</span>&nbsp;<span class="op" id="4647742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647749">if</span>&nbsp;<span class="ident" id="4647752">context</span>&nbsp;<span class="op" id="4647760">==</span>&nbsp;<span class="string" id="4647763">&#34;range&#34;</span>&nbsp;<span class="op" id="4647771">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4647774">len</span><span class="op" id="4647777">(</span><span class="ident" id="4647778">decl</span><span class="op" id="4647782">)</span>&nbsp;<span class="op" id="4647784">&lt;</span>&nbsp;<span class="num" id="4647786">2</span>&nbsp;<span class="op" id="4647788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4647796">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647810">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647817">t</span><span class="op" id="4647818">.</span><span class="ident" id="4647819">errorf</span><span class="op" id="4647825">(</span><span class="string" id="4647826">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="4647855">,</span>&nbsp;<span class="ident" id="4647857">context</span><span class="op" id="4647864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647875">}</span>&nbsp;<span class="keyword" id="4647877">else</span>&nbsp;<span class="keyword" id="4647882">if</span>&nbsp;<span class="ident" id="4647885">tokenAfterVariable</span><span class="op" id="4647903">.</span><span class="ident" id="4647904">typ</span>&nbsp;<span class="op" id="4647908">==</span>&nbsp;<span class="ident" id="4647911">itemSpace</span>&nbsp;<span class="op" id="4647921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647927">t</span><span class="op" id="4647928">.</span><span class="ident" id="4647929">backup3</span><span class="op" id="4647936">(</span><span class="ident" id="4647937">v</span><span class="op" id="4647938">,</span>&nbsp;<span class="ident" id="4647940">tokenAfterVariable</span><span class="op" id="4647958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647963">}</span>&nbsp;<span class="keyword" id="4647965">else</span>&nbsp;<span class="op" id="4647970">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4647976">t</span><span class="op" id="4647977">.</span><span class="ident" id="4647978">backup2</span><span class="op" id="4647985">(</span><span class="ident" id="4647986">v</span><span class="op" id="4647987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4647996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648000">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648007">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648010">pipe</span>&nbsp;<span class="op" id="4648015">=</span>&nbsp;<span class="ident" id="4648017">t</span><span class="op" id="4648018">.</span><span class="ident" id="4648019">newPipeline</span><span class="op" id="4648030">(</span><span class="ident" id="4648031">pos</span><span class="op" id="4648034">,</span>&nbsp;<span class="ident" id="4648036">t</span><span class="op" id="4648037">.</span><span class="ident" id="4648038">lex</span><span class="op" id="4648041">.</span><span class="ident" id="4648042">lineNumber</span><span class="op" id="4648052">(</span><span class="op" id="4648053">)</span><span class="op" id="4648054">,</span>&nbsp;<span class="ident" id="4648056">decl</span><span class="op" id="4648060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648063">for</span>&nbsp;<span class="op" id="4648067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648071">switch</span>&nbsp;<span class="ident" id="4648078">token</span>&nbsp;<span class="op" id="4648084">:=</span>&nbsp;<span class="ident" id="4648087">t</span><span class="op" id="4648088">.</span><span class="ident" id="4648089">nextNonSpace</span><span class="op" id="4648101">(</span><span class="op" id="4648102">)</span><span class="op" id="4648103">;</span>&nbsp;<span class="ident" id="4648105">token</span><span class="op" id="4648110">.</span><span class="ident" id="4648111">typ</span>&nbsp;<span class="op" id="4648115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648119">case</span>&nbsp;<span class="ident" id="4648124">itemRightDelim</span><span class="op" id="4648138">,</span>&nbsp;<span class="ident" id="4648140">itemRightParen</span><span class="op" id="4648154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648159">if</span>&nbsp;<span class="builtinfunc" id="4648162">len</span><span class="op" id="4648165">(</span><span class="ident" id="4648166">pipe</span><span class="op" id="4648170">.</span><span class="ident" id="4648171">Cmds</span><span class="op" id="4648175">)</span>&nbsp;<span class="op" id="4648177">==</span>&nbsp;<span class="num" id="4648180">0</span>&nbsp;<span class="op" id="4648182">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648188">t</span><span class="op" id="4648189">.</span><span class="ident" id="4648190">errorf</span><span class="op" id="4648196">(</span><span class="string" id="4648197">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4648219">,</span>&nbsp;<span class="ident" id="4648221">context</span><span class="op" id="4648228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648238">if</span>&nbsp;<span class="ident" id="4648241">token</span><span class="op" id="4648246">.</span><span class="ident" id="4648247">typ</span>&nbsp;<span class="op" id="4648251">==</span>&nbsp;<span class="ident" id="4648254">itemRightParen</span>&nbsp;<span class="op" id="4648269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648275">t</span><span class="op" id="4648276">.</span><span class="ident" id="4648277">backup</span><span class="op" id="4648283">(</span><span class="op" id="4648284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648289">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648294">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648303">case</span>&nbsp;<span class="ident" id="4648308">itemBool</span><span class="op" id="4648316">,</span>&nbsp;<span class="ident" id="4648318">itemCharConstant</span><span class="op" id="4648334">,</span>&nbsp;<span class="ident" id="4648336">itemComplex</span><span class="op" id="4648347">,</span>&nbsp;<span class="ident" id="4648349">itemDot</span><span class="op" id="4648356">,</span>&nbsp;<span class="ident" id="4648358">itemField</span><span class="op" id="4648367">,</span>&nbsp;<span class="ident" id="4648369">itemIdentifier</span><span class="op" id="4648383">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648388">itemNumber</span><span class="op" id="4648398">,</span>&nbsp;<span class="ident" id="4648400">itemNil</span><span class="op" id="4648407">,</span>&nbsp;<span class="ident" id="4648409">itemRawString</span><span class="op" id="4648422">,</span>&nbsp;<span class="ident" id="4648424">itemString</span><span class="op" id="4648434">,</span>&nbsp;<span class="ident" id="4648436">itemVariable</span><span class="op" id="4648448">,</span>&nbsp;<span class="ident" id="4648450">itemLeftParen</span><span class="op" id="4648463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648468">t</span><span class="op" id="4648469">.</span><span class="ident" id="4648470">backup</span><span class="op" id="4648476">(</span><span class="op" id="4648477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648482">pipe</span><span class="op" id="4648486">.</span><span class="builtinfunc" id="4648487">append</span><span class="op" id="4648493">(</span><span class="ident" id="4648494">t</span><span class="op" id="4648495">.</span><span class="ident" id="4648496">command</span><span class="op" id="4648503">(</span><span class="op" id="4648504">)</span><span class="op" id="4648505">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648509">default</span><span class="op" id="4648516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648521">t</span><span class="op" id="4648522">.</span><span class="ident" id="4648523">unexpected</span><span class="op" id="4648533">(</span><span class="ident" id="4648534">token</span><span class="op" id="4648539">,</span>&nbsp;<span class="ident" id="4648541">context</span><span class="op" id="4648548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4648555">}</span><br>
<span class="lineno"></span><span class="op" id="4648557">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4648560">func</span>&nbsp;<span class="op" id="4648565">(</span><span class="ident" id="4648566">t</span>&nbsp;<span class="op" id="4648568">*</span><span class="ident" id="4648569">Tree</span><span class="op" id="4648573">)</span>&nbsp;<span class="ident" id="4648575">parseControl</span><span class="op" id="4648587">(</span><span class="ident" id="4648588">allowElseIf</span>&nbsp;<span class="builtintype" id="4648600">bool</span><span class="op" id="4648604">,</span>&nbsp;<span class="ident" id="4648606">context</span>&nbsp;<span class="builtintype" id="4648614">string</span><span class="op" id="4648620">)</span>&nbsp;<span class="op" id="4648622">(</span><span class="ident" id="4648623">pos</span>&nbsp;<span class="ident" id="4648627">Pos</span><span class="op" id="4648630">,</span>&nbsp;<span class="ident" id="4648632">line</span>&nbsp;<span class="builtintype" id="4648637">int</span><span class="op" id="4648640">,</span>&nbsp;<span class="ident" id="4648642">pipe</span>&nbsp;<span class="op" id="4648647">*</span><span class="ident" id="4648648">PipeNode</span><span class="op" id="4648656">,</span>&nbsp;<span class="ident" id="4648658">list</span><span class="op" id="4648662">,</span>&nbsp;<span class="ident" id="4648664">elseList</span>&nbsp;<span class="op" id="4648673">*</span><span class="ident" id="4648674">ListNode</span><span class="op" id="4648682">)</span>&nbsp;<span class="op" id="4648684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648687">defer</span>&nbsp;<span class="ident" id="4648693">t</span><span class="op" id="4648694">.</span><span class="ident" id="4648695">popVars</span><span class="op" id="4648702">(</span><span class="builtinfunc" id="4648703">len</span><span class="op" id="4648706">(</span><span class="ident" id="4648707">t</span><span class="op" id="4648708">.</span><span class="ident" id="4648709">vars</span><span class="op" id="4648713">)</span><span class="op" id="4648714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648717">line</span>&nbsp;<span class="op" id="4648722">=</span>&nbsp;<span class="ident" id="4648724">t</span><span class="op" id="4648725">.</span><span class="ident" id="4648726">lex</span><span class="op" id="4648729">.</span><span class="ident" id="4648730">lineNumber</span><span class="op" id="4648740">(</span><span class="op" id="4648741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648744">pipe</span>&nbsp;<span class="op" id="4648749">=</span>&nbsp;<span class="ident" id="4648751">t</span><span class="op" id="4648752">.</span><span class="ident" id="4648753">pipeline</span><span class="op" id="4648761">(</span><span class="ident" id="4648762">context</span><span class="op" id="4648769">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648772">var</span>&nbsp;<span class="ident" id="4648776">next</span>&nbsp;<span class="ident" id="4648781">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4648787">list</span><span class="op" id="4648791">,</span>&nbsp;<span class="ident" id="4648793">next</span>&nbsp;<span class="op" id="4648798">=</span>&nbsp;<span class="ident" id="4648800">t</span><span class="op" id="4648801">.</span><span class="ident" id="4648802">itemList</span><span class="op" id="4648810">(</span><span class="op" id="4648811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648814">switch</span>&nbsp;<span class="ident" id="4648821">next</span><span class="op" id="4648825">.</span><span class="ident" id="4648826">Type</span><span class="op" id="4648830">(</span><span class="op" id="4648831">)</span>&nbsp;<span class="op" id="4648833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648836">case</span>&nbsp;<span class="ident" id="4648841">nodeEnd</span><span class="op" id="4648848">:</span>&nbsp;<span class="comment" id="4648850">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648858">case</span>&nbsp;<span class="ident" id="4648863">nodeElse</span><span class="op" id="4648871">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4648875">if</span>&nbsp;<span class="ident" id="4648878">allowElseIf</span>&nbsp;<span class="op" id="4648890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4648895">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4648979">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649046">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649083">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649092">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649140">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649226">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649298">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649353">if</span>&nbsp;<span class="ident" id="4649356">t</span><span class="op" id="4649357">.</span><span class="ident" id="4649358">peek</span><span class="op" id="4649362">(</span><span class="op" id="4649363">)</span><span class="op" id="4649364">.</span><span class="ident" id="4649365">typ</span>&nbsp;<span class="op" id="4649369">==</span>&nbsp;<span class="ident" id="4649372">itemIf</span>&nbsp;<span class="op" id="4649379">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649385">t</span><span class="op" id="4649386">.</span><span class="ident" id="4649387">next</span><span class="op" id="4649391">(</span><span class="op" id="4649392">)</span>&nbsp;<span class="comment" id="4649394">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649425">elseList</span>&nbsp;<span class="op" id="4649434">=</span>&nbsp;<span class="ident" id="4649436">t</span><span class="op" id="4649437">.</span><span class="ident" id="4649438">newList</span><span class="op" id="4649445">(</span><span class="ident" id="4649446">next</span><span class="op" id="4649450">.</span><span class="ident" id="4649451">Position</span><span class="op" id="4649459">(</span><span class="op" id="4649460">)</span><span class="op" id="4649461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649467">elseList</span><span class="op" id="4649475">.</span><span class="builtinfunc" id="4649476">append</span><span class="op" id="4649482">(</span><span class="ident" id="4649483">t</span><span class="op" id="4649484">.</span><span class="ident" id="4649485">ifControl</span><span class="op" id="4649494">(</span><span class="op" id="4649495">)</span><span class="op" id="4649496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4649502">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649567">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649584">elseList</span><span class="op" id="4649592">,</span>&nbsp;<span class="ident" id="4649594">next</span>&nbsp;<span class="op" id="4649599">=</span>&nbsp;<span class="ident" id="4649601">t</span><span class="op" id="4649602">.</span><span class="ident" id="4649603">itemList</span><span class="op" id="4649611">(</span><span class="op" id="4649612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649616">if</span>&nbsp;<span class="ident" id="4649619">next</span><span class="op" id="4649623">.</span><span class="ident" id="4649624">Type</span><span class="op" id="4649628">(</span><span class="op" id="4649629">)</span>&nbsp;<span class="op" id="4649631">!=</span>&nbsp;<span class="ident" id="4649634">nodeEnd</span>&nbsp;<span class="op" id="4649642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4649647">t</span><span class="op" id="4649648">.</span><span class="ident" id="4649649">errorf</span><span class="op" id="4649655">(</span><span class="string" id="4649656">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="4649680">,</span>&nbsp;<span class="ident" id="4649682">next</span><span class="op" id="4649686">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4649693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649696">return</span>&nbsp;<span class="ident" id="4649703">pipe</span><span class="op" id="4649707">.</span><span class="ident" id="4649708">Position</span><span class="op" id="4649716">(</span><span class="op" id="4649717">)</span><span class="op" id="4649718">,</span>&nbsp;<span class="ident" id="4649720">line</span><span class="op" id="4649724">,</span>&nbsp;<span class="ident" id="4649726">pipe</span><span class="op" id="4649730">,</span>&nbsp;<span class="ident" id="4649732">list</span><span class="op" id="4649736">,</span>&nbsp;<span class="ident" id="4649738">elseList</span><br>
<span class="lineno"></span><span class="op" id="4649747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="4649750">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="4649757">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4649793">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4649847">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4649870">func</span>&nbsp;<span class="op" id="4649875">(</span><span class="ident" id="4649876">t</span>&nbsp;<span class="op" id="4649878">*</span><span class="ident" id="4649879">Tree</span><span class="op" id="4649883">)</span>&nbsp;<span class="ident" id="4649885">ifControl</span><span class="op" id="4649894">(</span><span class="op" id="4649895">)</span>&nbsp;<span class="ident" id="4649897">Node</span>&nbsp;<span class="op" id="4649902">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4649905">return</span>&nbsp;<span class="ident" id="4649912">t</span><span class="op" id="4649913">.</span><span class="ident" id="4649914">newIf</span><span class="op" id="4649919">(</span><span class="ident" id="4649920">t</span><span class="op" id="4649921">.</span><span class="ident" id="4649922">parseControl</span><span class="op" id="4649934">(</span><span class="builtintype" id="4649935">true</span><span class="op" id="4649939">,</span>&nbsp;<span class="string" id="4649941">&#34;if&#34;</span><span class="op" id="4649945">)</span><span class="op" id="4649946">)</span><br>
<span class="lineno"></span><span class="op" id="4649948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4649951">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="4649961">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="4650000">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4650057">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4650083">func</span>&nbsp;<span class="op" id="4650088">(</span><span class="ident" id="4650089">t</span>&nbsp;<span class="op" id="4650091">*</span><span class="ident" id="4650092">Tree</span><span class="op" id="4650096">)</span>&nbsp;<span class="ident" id="4650098">rangeControl</span><span class="op" id="4650110">(</span><span class="op" id="4650111">)</span>&nbsp;<span class="ident" id="4650113">Node</span>&nbsp;<span class="op" id="4650118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650121">return</span>&nbsp;<span class="ident" id="4650128">t</span><span class="op" id="4650129">.</span><span class="ident" id="4650130">newRange</span><span class="op" id="4650138">(</span><span class="ident" id="4650139">t</span><span class="op" id="4650140">.</span><span class="ident" id="4650141">parseControl</span><span class="op" id="4650153">(</span><span class="builtintype" id="4650154">false</span><span class="op" id="4650159">,</span>&nbsp;<span class="string" id="4650161">&#34;range&#34;</span><span class="op" id="4650168">)</span><span class="op" id="4650169">)</span><br>
<span class="lineno"></span><span class="op" id="4650171">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4650174">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="4650183">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4650221">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4650277">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="4650300">func</span>&nbsp;<span class="op" id="4650305">(</span><span class="ident" id="4650306">t</span>&nbsp;<span class="op" id="4650308">*</span><span class="ident" id="4650309">Tree</span><span class="op" id="4650313">)</span>&nbsp;<span class="ident" id="4650315">withControl</span><span class="op" id="4650326">(</span><span class="op" id="4650327">)</span>&nbsp;<span class="ident" id="4650329">Node</span>&nbsp;<span class="op" id="4650334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650337">return</span>&nbsp;<span class="ident" id="4650344">t</span><span class="op" id="4650345">.</span><span class="ident" id="4650346">newWith</span><span class="op" id="4650353">(</span><span class="ident" id="4650354">t</span><span class="op" id="4650355">.</span><span class="ident" id="4650356">parseControl</span><span class="op" id="4650368">(</span><span class="builtintype" id="4650369">false</span><span class="op" id="4650374">,</span>&nbsp;<span class="string" id="4650376">&#34;with&#34;</span><span class="op" id="4650382">)</span><span class="op" id="4650383">)</span><br>
<span class="lineno"></span><span class="op" id="4650385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4650388">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="4650396">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="4650407">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4650431">func</span>&nbsp;<span class="op" id="4650436">(</span><span class="ident" id="4650437">t</span>&nbsp;<span class="op" id="4650439">*</span><span class="ident" id="4650440">Tree</span><span class="op" id="4650444">)</span>&nbsp;<span class="ident" id="4650446">endControl</span><span class="op" id="4650456">(</span><span class="op" id="4650457">)</span>&nbsp;<span class="ident" id="4650459">Node</span>&nbsp;<span class="op" id="4650464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650467">return</span>&nbsp;<span class="ident" id="4650474">t</span><span class="op" id="4650475">.</span><span class="ident" id="4650476">newEnd</span><span class="op" id="4650482">(</span><span class="ident" id="4650483">t</span><span class="op" id="4650484">.</span><span class="ident" id="4650485">expect</span><span class="op" id="4650491">(</span><span class="ident" id="4650492">itemRightDelim</span><span class="op" id="4650506">,</span>&nbsp;<span class="string" id="4650508">&#34;end&#34;</span><span class="op" id="4650513">)</span><span class="op" id="4650514">.</span><span class="ident" id="4650515">pos</span><span class="op" id="4650518">)</span><br>
<span class="lineno"></span><span class="op" id="4650520">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="4650523">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="4650532">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="4650544">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="4650569">func</span>&nbsp;<span class="op" id="4650574">(</span><span class="ident" id="4650575">t</span>&nbsp;<span class="op" id="4650577">*</span><span class="ident" id="4650578">Tree</span><span class="op" id="4650582">)</span>&nbsp;<span class="ident" id="4650584">elseControl</span><span class="op" id="4650595">(</span><span class="op" id="4650596">)</span>&nbsp;<span class="ident" id="4650598">Node</span>&nbsp;<span class="op" id="4650603">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4650606">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4650638">peek</span>&nbsp;<span class="op" id="4650643">:=</span>&nbsp;<span class="ident" id="4650646">t</span><span class="op" id="4650647">.</span><span class="ident" id="4650648">peekNonSpace</span><span class="op" id="4650660">(</span><span class="op" id="4650661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650664">if</span>&nbsp;<span class="ident" id="4650667">peek</span><span class="op" id="4650671">.</span><span class="ident" id="4650672">typ</span>&nbsp;<span class="op" id="4650676">==</span>&nbsp;<span class="ident" id="4650679">itemIf</span>&nbsp;<span class="op" id="4650686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4650690">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650767">return</span>&nbsp;<span class="ident" id="4650774">t</span><span class="op" id="4650775">.</span><span class="ident" id="4650776">newElse</span><span class="op" id="4650783">(</span><span class="ident" id="4650784">peek</span><span class="op" id="4650788">.</span><span class="ident" id="4650789">pos</span><span class="op" id="4650792">,</span>&nbsp;<span class="ident" id="4650794">t</span><span class="op" id="4650795">.</span><span class="ident" id="4650796">lex</span><span class="op" id="4650799">.</span><span class="ident" id="4650800">lineNumber</span><span class="op" id="4650810">(</span><span class="op" id="4650811">)</span><span class="op" id="4650812">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4650815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4650818">return</span>&nbsp;<span class="ident" id="4650825">t</span><span class="op" id="4650826">.</span><span class="ident" id="4650827">newElse</span><span class="op" id="4650834">(</span><span class="ident" id="4650835">t</span><span class="op" id="4650836">.</span><span class="ident" id="4650837">expect</span><span class="op" id="4650843">(</span><span class="ident" id="4650844">itemRightDelim</span><span class="op" id="4650858">,</span>&nbsp;<span class="string" id="4650860">&#34;else&#34;</span><span class="op" id="4650866">)</span><span class="op" id="4650867">.</span><span class="ident" id="4650868">pos</span><span class="op" id="4650871">,</span>&nbsp;<span class="ident" id="4650873">t</span><span class="op" id="4650874">.</span><span class="ident" id="4650875">lex</span><span class="op" id="4650878">.</span><span class="ident" id="4650879">lineNumber</span><span class="op" id="4650889">(</span><span class="op" id="4650890">)</span><span class="op" id="4650891">)</span><br>
<span class="lineno"></span><span class="op" id="4650893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4650896">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="4650909">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="4650946">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="4651021">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4651037">func</span>&nbsp;<span class="op" id="4651042">(</span><span class="ident" id="4651043">t</span>&nbsp;<span class="op" id="4651045">*</span><span class="ident" id="4651046">Tree</span><span class="op" id="4651050">)</span>&nbsp;<span class="ident" id="4651052">templateControl</span><span class="op" id="4651067">(</span><span class="op" id="4651068">)</span>&nbsp;<span class="ident" id="4651070">Node</span>&nbsp;<span class="op" id="4651075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651078">var</span>&nbsp;<span class="ident" id="4651082">name</span>&nbsp;<span class="builtintype" id="4651087">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651095">token</span>&nbsp;<span class="op" id="4651101">:=</span>&nbsp;<span class="ident" id="4651104">t</span><span class="op" id="4651105">.</span><span class="ident" id="4651106">nextNonSpace</span><span class="op" id="4651118">(</span><span class="op" id="4651119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651122">switch</span>&nbsp;<span class="ident" id="4651129">token</span><span class="op" id="4651134">.</span><span class="ident" id="4651135">typ</span>&nbsp;<span class="op" id="4651139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651142">case</span>&nbsp;<span class="ident" id="4651147">itemString</span><span class="op" id="4651157">,</span>&nbsp;<span class="ident" id="4651159">itemRawString</span><span class="op" id="4651172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651176">s</span><span class="op" id="4651177">,</span>&nbsp;<span class="ident" id="4651179">err</span>&nbsp;<span class="op" id="4651183">:=</span>&nbsp;<span class="ident" id="4651186">strconv</span><span class="op" id="4651193">.</span><span class="ident" id="4651194">Unquote</span><span class="op" id="4651201">(</span><span class="ident" id="4651202">token</span><span class="op" id="4651207">.</span><span class="ident" id="4651208">val</span><span class="op" id="4651211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651215">if</span>&nbsp;<span class="ident" id="4651218">err</span>&nbsp;<span class="op" id="4651222">!=</span>&nbsp;<span class="ident" id="4651225">nil</span>&nbsp;<span class="op" id="4651229">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651234">t</span><span class="op" id="4651235">.</span><span class="builtintype" id="4651236">error</span><span class="op" id="4651241">(</span><span class="ident" id="4651242">err</span><span class="op" id="4651245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4651249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651253">name</span>&nbsp;<span class="op" id="4651258">=</span>&nbsp;<span class="ident" id="4651260">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651263">default</span><span class="op" id="4651270">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651274">t</span><span class="op" id="4651275">.</span><span class="ident" id="4651276">unexpected</span><span class="op" id="4651286">(</span><span class="ident" id="4651287">token</span><span class="op" id="4651292">,</span>&nbsp;<span class="string" id="4651294">&#34;template&nbsp;invocation&#34;</span><span class="op" id="4651315">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4651318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651321">var</span>&nbsp;<span class="ident" id="4651325">pipe</span>&nbsp;<span class="op" id="4651330">*</span><span class="ident" id="4651331">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651341">if</span>&nbsp;<span class="ident" id="4651344">t</span><span class="op" id="4651345">.</span><span class="ident" id="4651346">nextNonSpace</span><span class="op" id="4651358">(</span><span class="op" id="4651359">)</span><span class="op" id="4651360">.</span><span class="ident" id="4651361">typ</span>&nbsp;<span class="op" id="4651365">!=</span>&nbsp;<span class="ident" id="4651368">itemRightDelim</span>&nbsp;<span class="op" id="4651383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651387">t</span><span class="op" id="4651388">.</span><span class="ident" id="4651389">backup</span><span class="op" id="4651395">(</span><span class="op" id="4651396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4651400">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651453">pipe</span>&nbsp;<span class="op" id="4651458">=</span>&nbsp;<span class="ident" id="4651460">t</span><span class="op" id="4651461">.</span><span class="ident" id="4651462">pipeline</span><span class="op" id="4651470">(</span><span class="string" id="4651471">&#34;template&#34;</span><span class="op" id="4651481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4651484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651487">return</span>&nbsp;<span class="ident" id="4651494">t</span><span class="op" id="4651495">.</span><span class="ident" id="4651496">newTemplate</span><span class="op" id="4651507">(</span><span class="ident" id="4651508">token</span><span class="op" id="4651513">.</span><span class="ident" id="4651514">pos</span><span class="op" id="4651517">,</span>&nbsp;<span class="ident" id="4651519">t</span><span class="op" id="4651520">.</span><span class="ident" id="4651521">lex</span><span class="op" id="4651524">.</span><span class="ident" id="4651525">lineNumber</span><span class="op" id="4651535">(</span><span class="op" id="4651536">)</span><span class="op" id="4651537">,</span>&nbsp;<span class="ident" id="4651539">name</span><span class="op" id="4651543">,</span>&nbsp;<span class="ident" id="4651545">pipe</span><span class="op" id="4651549">)</span><br>
<span class="lineno"></span><span class="op" id="4651551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="4651554">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="4651566">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="4651594">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="4651670">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="4651754">func</span>&nbsp;<span class="op" id="4651759">(</span><span class="ident" id="4651760">t</span>&nbsp;<span class="op" id="4651762">*</span><span class="ident" id="4651763">Tree</span><span class="op" id="4651767">)</span>&nbsp;<span class="ident" id="4651769">command</span><span class="op" id="4651776">(</span><span class="op" id="4651777">)</span>&nbsp;<span class="op" id="4651779">*</span><span class="ident" id="4651780">CommandNode</span>&nbsp;<span class="op" id="4651792">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651795">cmd</span>&nbsp;<span class="op" id="4651799">:=</span>&nbsp;<span class="ident" id="4651802">t</span><span class="op" id="4651803">.</span><span class="ident" id="4651804">newCommand</span><span class="op" id="4651814">(</span><span class="ident" id="4651815">t</span><span class="op" id="4651816">.</span><span class="ident" id="4651817">peekNonSpace</span><span class="op" id="4651829">(</span><span class="op" id="4651830">)</span><span class="op" id="4651831">.</span><span class="ident" id="4651832">pos</span><span class="op" id="4651835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651838">for</span>&nbsp;<span class="op" id="4651842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651846">t</span><span class="op" id="4651847">.</span><span class="ident" id="4651848">peekNonSpace</span><span class="op" id="4651860">(</span><span class="op" id="4651861">)</span>&nbsp;<span class="comment" id="4651863">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651889">operand</span>&nbsp;<span class="op" id="4651897">:=</span>&nbsp;<span class="ident" id="4651900">t</span><span class="op" id="4651901">.</span><span class="ident" id="4651902">operand</span><span class="op" id="4651909">(</span><span class="op" id="4651910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651914">if</span>&nbsp;<span class="ident" id="4651917">operand</span>&nbsp;<span class="op" id="4651925">!=</span>&nbsp;<span class="ident" id="4651928">nil</span>&nbsp;<span class="op" id="4651932">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4651937">cmd</span><span class="op" id="4651940">.</span><span class="builtinfunc" id="4651941">append</span><span class="op" id="4651947">(</span><span class="ident" id="4651948">operand</span><span class="op" id="4651955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4651959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4651963">switch</span>&nbsp;<span class="ident" id="4651970">token</span>&nbsp;<span class="op" id="4651976">:=</span>&nbsp;<span class="ident" id="4651979">t</span><span class="op" id="4651980">.</span><span class="ident" id="4651981">next</span><span class="op" id="4651985">(</span><span class="op" id="4651986">)</span><span class="op" id="4651987">;</span>&nbsp;<span class="ident" id="4651989">token</span><span class="op" id="4651994">.</span><span class="ident" id="4651995">typ</span>&nbsp;<span class="op" id="4651999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652003">case</span>&nbsp;<span class="ident" id="4652008">itemSpace</span><span class="op" id="4652017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652022">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652033">case</span>&nbsp;<span class="ident" id="4652038">itemError</span><span class="op" id="4652047">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652052">t</span><span class="op" id="4652053">.</span><span class="ident" id="4652054">errorf</span><span class="op" id="4652060">(</span><span class="string" id="4652061">&#34;%s&#34;</span><span class="op" id="4652065">,</span>&nbsp;<span class="ident" id="4652067">token</span><span class="op" id="4652072">.</span><span class="ident" id="4652073">val</span><span class="op" id="4652076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652080">case</span>&nbsp;<span class="ident" id="4652085">itemRightDelim</span><span class="op" id="4652099">,</span>&nbsp;<span class="ident" id="4652101">itemRightParen</span><span class="op" id="4652115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652120">t</span><span class="op" id="4652121">.</span><span class="ident" id="4652122">backup</span><span class="op" id="4652128">(</span><span class="op" id="4652129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652133">case</span>&nbsp;<span class="ident" id="4652138">itemPipe</span><span class="op" id="4652146">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652150">default</span><span class="op" id="4652157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652162">t</span><span class="op" id="4652163">.</span><span class="ident" id="4652164">errorf</span><span class="op" id="4652170">(</span><span class="string" id="4652171">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="4652213">,</span>&nbsp;<span class="ident" id="4652215">token</span><span class="op" id="4652220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4652224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652228">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4652235">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652238">if</span>&nbsp;<span class="builtinfunc" id="4652241">len</span><span class="op" id="4652244">(</span><span class="ident" id="4652245">cmd</span><span class="op" id="4652248">.</span><span class="ident" id="4652249">Args</span><span class="op" id="4652253">)</span>&nbsp;<span class="op" id="4652255">==</span>&nbsp;<span class="num" id="4652258">0</span>&nbsp;<span class="op" id="4652260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652264">t</span><span class="op" id="4652265">.</span><span class="ident" id="4652266">errorf</span><span class="op" id="4652272">(</span><span class="string" id="4652273">&#34;empty&nbsp;command&#34;</span><span class="op" id="4652288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4652291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652294">return</span>&nbsp;<span class="ident" id="4652301">cmd</span><br>
<span class="lineno"></span><span class="op" id="4652305">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="4652308">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="4652320">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="4652336">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="4652395">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="4652442">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="4652497">func</span>&nbsp;<span class="op" id="4652502">(</span><span class="ident" id="4652503">t</span>&nbsp;<span class="op" id="4652505">*</span><span class="ident" id="4652506">Tree</span><span class="op" id="4652510">)</span>&nbsp;<span class="ident" id="4652512">operand</span><span class="op" id="4652519">(</span><span class="op" id="4652520">)</span>&nbsp;<span class="ident" id="4652522">Node</span>&nbsp;<span class="op" id="4652527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652530">node</span>&nbsp;<span class="op" id="4652535">:=</span>&nbsp;<span class="ident" id="4652538">t</span><span class="op" id="4652539">.</span><span class="ident" id="4652540">term</span><span class="op" id="4652544">(</span><span class="op" id="4652545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652548">if</span>&nbsp;<span class="ident" id="4652551">node</span>&nbsp;<span class="op" id="4652556">==</span>&nbsp;<span class="ident" id="4652559">nil</span>&nbsp;<span class="op" id="4652563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652567">return</span>&nbsp;<span class="ident" id="4652574">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4652579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652582">if</span>&nbsp;<span class="ident" id="4652585">t</span><span class="op" id="4652586">.</span><span class="ident" id="4652587">peek</span><span class="op" id="4652591">(</span><span class="op" id="4652592">)</span><span class="op" id="4652593">.</span><span class="ident" id="4652594">typ</span>&nbsp;<span class="op" id="4652598">==</span>&nbsp;<span class="ident" id="4652601">itemField</span>&nbsp;<span class="op" id="4652611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652615">chain</span>&nbsp;<span class="op" id="4652621">:=</span>&nbsp;<span class="ident" id="4652624">t</span><span class="op" id="4652625">.</span><span class="ident" id="4652626">newChain</span><span class="op" id="4652634">(</span><span class="ident" id="4652635">t</span><span class="op" id="4652636">.</span><span class="ident" id="4652637">peek</span><span class="op" id="4652641">(</span><span class="op" id="4652642">)</span><span class="op" id="4652643">.</span><span class="ident" id="4652644">pos</span><span class="op" id="4652647">,</span>&nbsp;<span class="ident" id="4652649">node</span><span class="op" id="4652653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652657">for</span>&nbsp;<span class="ident" id="4652661">t</span><span class="op" id="4652662">.</span><span class="ident" id="4652663">peek</span><span class="op" id="4652667">(</span><span class="op" id="4652668">)</span><span class="op" id="4652669">.</span><span class="ident" id="4652670">typ</span>&nbsp;<span class="op" id="4652674">==</span>&nbsp;<span class="ident" id="4652677">itemField</span>&nbsp;<span class="op" id="4652687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652692">chain</span><span class="op" id="4652697">.</span><span class="ident" id="4652698">Add</span><span class="op" id="4652701">(</span><span class="ident" id="4652702">t</span><span class="op" id="4652703">.</span><span class="ident" id="4652704">next</span><span class="op" id="4652708">(</span><span class="op" id="4652709">)</span><span class="op" id="4652710">.</span><span class="ident" id="4652711">val</span><span class="op" id="4652714">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4652718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4652722">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4652793">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4652853">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4652890">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652938">switch</span>&nbsp;<span class="ident" id="4652945">node</span><span class="op" id="4652949">.</span><span class="ident" id="4652950">Type</span><span class="op" id="4652954">(</span><span class="op" id="4652955">)</span>&nbsp;<span class="op" id="4652957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4652961">case</span>&nbsp;<span class="ident" id="4652966">NodeField</span><span class="op" id="4652975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4652980">node</span>&nbsp;<span class="op" id="4652985">=</span>&nbsp;<span class="ident" id="4652987">t</span><span class="op" id="4652988">.</span><span class="ident" id="4652989">newField</span><span class="op" id="4652997">(</span><span class="ident" id="4652998">chain</span><span class="op" id="4653003">.</span><span class="ident" id="4653004">Position</span><span class="op" id="4653012">(</span><span class="op" id="4653013">)</span><span class="op" id="4653014">,</span>&nbsp;<span class="ident" id="4653016">chain</span><span class="op" id="4653021">.</span><span class="ident" id="4653022">String</span><span class="op" id="4653028">(</span><span class="op" id="4653029">)</span><span class="op" id="4653030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653034">case</span>&nbsp;<span class="ident" id="4653039">NodeVariable</span><span class="op" id="4653051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4653056">node</span>&nbsp;<span class="op" id="4653061">=</span>&nbsp;<span class="ident" id="4653063">t</span><span class="op" id="4653064">.</span><span class="ident" id="4653065">newVariable</span><span class="op" id="4653076">(</span><span class="ident" id="4653077">chain</span><span class="op" id="4653082">.</span><span class="ident" id="4653083">Position</span><span class="op" id="4653091">(</span><span class="op" id="4653092">)</span><span class="op" id="4653093">,</span>&nbsp;<span class="ident" id="4653095">chain</span><span class="op" id="4653100">.</span><span class="ident" id="4653101">String</span><span class="op" id="4653107">(</span><span class="op" id="4653108">)</span><span class="op" id="4653109">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653113">default</span><span class="op" id="4653120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4653125">node</span>&nbsp;<span class="op" id="4653130">=</span>&nbsp;<span class="ident" id="4653132">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4653140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4653143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653146">return</span>&nbsp;<span class="ident" id="4653153">node</span><br>
<span class="lineno">595</span><span class="op" id="4653158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4653161">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="4653170">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="4653212">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="4653237">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="4653242">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="4653252">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="4653257">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="4653277">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="4653313">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="4653364">func</span>&nbsp;<span class="op" id="4653369">(</span><span class="ident" id="4653370">t</span>&nbsp;<span class="op" id="4653372">*</span><span class="ident" id="4653373">Tree</span><span class="op" id="4653377">)</span>&nbsp;<span class="ident" id="4653379">term</span><span class="op" id="4653383">(</span><span class="op" id="4653384">)</span>&nbsp;<span class="ident" id="4653386">Node</span>&nbsp;<span class="op" id="4653391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653394">switch</span>&nbsp;<span class="ident" id="4653401">token</span>&nbsp;<span class="op" id="4653407">:=</span>&nbsp;<span class="ident" id="4653410">t</span><span class="op" id="4653411">.</span><span class="ident" id="4653412">nextNonSpace</span><span class="op" id="4653424">(</span><span class="op" id="4653425">)</span><span class="op" id="4653426">;</span>&nbsp;<span class="ident" id="4653428">token</span><span class="op" id="4653433">.</span><span class="ident" id="4653434">typ</span>&nbsp;<span class="op" id="4653438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653441">case</span>&nbsp;<span class="ident" id="4653446">itemError</span><span class="op" id="4653455">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4653459">t</span><span class="op" id="4653460">.</span><span class="ident" id="4653461">errorf</span><span class="op" id="4653467">(</span><span class="string" id="4653468">&#34;%s&#34;</span><span class="op" id="4653472">,</span>&nbsp;<span class="ident" id="4653474">token</span><span class="op" id="4653479">.</span><span class="ident" id="4653480">val</span><span class="op" id="4653483">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653486">case</span>&nbsp;<span class="ident" id="4653491">itemIdentifier</span><span class="op" id="4653505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653509">if</span>&nbsp;<span class="op" id="4653512">!</span><span class="ident" id="4653513">t</span><span class="op" id="4653514">.</span><span class="ident" id="4653515">hasFunction</span><span class="op" id="4653526">(</span><span class="ident" id="4653527">token</span><span class="op" id="4653532">.</span><span class="ident" id="4653533">val</span><span class="op" id="4653536">)</span>&nbsp;<span class="op" id="4653538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4653543">t</span><span class="op" id="4653544">.</span><span class="ident" id="4653545">errorf</span><span class="op" id="4653551">(</span><span class="string" id="4653552">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="4653577">,</span>&nbsp;<span class="ident" id="4653579">token</span><span class="op" id="4653584">.</span><span class="ident" id="4653585">val</span><span class="op" id="4653588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4653592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653596">return</span>&nbsp;<span class="ident" id="4653603">NewIdentifier</span><span class="op" id="4653616">(</span><span class="ident" id="4653617">token</span><span class="op" id="4653622">.</span><span class="ident" id="4653623">val</span><span class="op" id="4653626">)</span><span class="op" id="4653627">.</span><span class="ident" id="4653628">SetTree</span><span class="op" id="4653635">(</span><span class="ident" id="4653636">t</span><span class="op" id="4653637">)</span><span class="op" id="4653638">.</span><span class="ident" id="4653639">SetPos</span><span class="op" id="4653645">(</span><span class="ident" id="4653646">token</span><span class="op" id="4653651">.</span><span class="ident" id="4653652">pos</span><span class="op" id="4653655">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653658">case</span>&nbsp;<span class="ident" id="4653663">itemDot</span><span class="op" id="4653670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653674">return</span>&nbsp;<span class="ident" id="4653681">t</span><span class="op" id="4653682">.</span><span class="ident" id="4653683">newDot</span><span class="op" id="4653689">(</span><span class="ident" id="4653690">token</span><span class="op" id="4653695">.</span><span class="ident" id="4653696">pos</span><span class="op" id="4653699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653702">case</span>&nbsp;<span class="ident" id="4653707">itemNil</span><span class="op" id="4653714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653718">return</span>&nbsp;<span class="ident" id="4653725">t</span><span class="op" id="4653726">.</span><span class="ident" id="4653727">newNil</span><span class="op" id="4653733">(</span><span class="ident" id="4653734">token</span><span class="op" id="4653739">.</span><span class="ident" id="4653740">pos</span><span class="op" id="4653743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653746">case</span>&nbsp;<span class="ident" id="4653751">itemVariable</span><span class="op" id="4653763">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653767">return</span>&nbsp;<span class="ident" id="4653774">t</span><span class="op" id="4653775">.</span><span class="ident" id="4653776">useVar</span><span class="op" id="4653782">(</span><span class="ident" id="4653783">token</span><span class="op" id="4653788">.</span><span class="ident" id="4653789">pos</span><span class="op" id="4653792">,</span>&nbsp;<span class="ident" id="4653794">token</span><span class="op" id="4653799">.</span><span class="ident" id="4653800">val</span><span class="op" id="4653803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653806">case</span>&nbsp;<span class="ident" id="4653811">itemField</span><span class="op" id="4653820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653824">return</span>&nbsp;<span class="ident" id="4653831">t</span><span class="op" id="4653832">.</span><span class="ident" id="4653833">newField</span><span class="op" id="4653841">(</span><span class="ident" id="4653842">token</span><span class="op" id="4653847">.</span><span class="ident" id="4653848">pos</span><span class="op" id="4653851">,</span>&nbsp;<span class="ident" id="4653853">token</span><span class="op" id="4653858">.</span><span class="ident" id="4653859">val</span><span class="op" id="4653862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653865">case</span>&nbsp;<span class="ident" id="4653870">itemBool</span><span class="op" id="4653878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653882">return</span>&nbsp;<span class="ident" id="4653889">t</span><span class="op" id="4653890">.</span><span class="ident" id="4653891">newBool</span><span class="op" id="4653898">(</span><span class="ident" id="4653899">token</span><span class="op" id="4653904">.</span><span class="ident" id="4653905">pos</span><span class="op" id="4653908">,</span>&nbsp;<span class="ident" id="4653910">token</span><span class="op" id="4653915">.</span><span class="ident" id="4653916">val</span>&nbsp;<span class="op" id="4653920">==</span>&nbsp;<span class="string" id="4653923">&#34;true&#34;</span><span class="op" id="4653929">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4653932">case</span>&nbsp;<span class="ident" id="4653937">itemCharConstant</span><span class="op" id="4653953">,</span>&nbsp;<span class="ident" id="4653955">itemComplex</span><span class="op" id="4653966">,</span>&nbsp;<span class="ident" id="4653968">itemNumber</span><span class="op" id="4653978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4653982">number</span><span class="op" id="4653988">,</span>&nbsp;<span class="ident" id="4653990">err</span>&nbsp;<span class="op" id="4653994">:=</span>&nbsp;<span class="ident" id="4653997">t</span><span class="op" id="4653998">.</span><span class="ident" id="4653999">newNumber</span><span class="op" id="4654008">(</span><span class="ident" id="4654009">token</span><span class="op" id="4654014">.</span><span class="ident" id="4654015">pos</span><span class="op" id="4654018">,</span>&nbsp;<span class="ident" id="4654020">token</span><span class="op" id="4654025">.</span><span class="ident" id="4654026">val</span><span class="op" id="4654029">,</span>&nbsp;<span class="ident" id="4654031">token</span><span class="op" id="4654036">.</span><span class="ident" id="4654037">typ</span><span class="op" id="4654040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654044">if</span>&nbsp;<span class="ident" id="4654047">err</span>&nbsp;<span class="op" id="4654051">!=</span>&nbsp;<span class="ident" id="4654054">nil</span>&nbsp;<span class="op" id="4654058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654063">t</span><span class="op" id="4654064">.</span><span class="builtintype" id="4654065">error</span><span class="op" id="4654070">(</span><span class="ident" id="4654071">err</span><span class="op" id="4654074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654078">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654082">return</span>&nbsp;<span class="ident" id="4654089">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654097">case</span>&nbsp;<span class="ident" id="4654102">itemLeftParen</span><span class="op" id="4654115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654119">pipe</span>&nbsp;<span class="op" id="4654124">:=</span>&nbsp;<span class="ident" id="4654127">t</span><span class="op" id="4654128">.</span><span class="ident" id="4654129">pipeline</span><span class="op" id="4654137">(</span><span class="string" id="4654138">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="4654162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654166">if</span>&nbsp;<span class="ident" id="4654169">token</span>&nbsp;<span class="op" id="4654175">:=</span>&nbsp;<span class="ident" id="4654178">t</span><span class="op" id="4654179">.</span><span class="ident" id="4654180">next</span><span class="op" id="4654184">(</span><span class="op" id="4654185">)</span><span class="op" id="4654186">;</span>&nbsp;<span class="ident" id="4654188">token</span><span class="op" id="4654193">.</span><span class="ident" id="4654194">typ</span>&nbsp;<span class="op" id="4654198">!=</span>&nbsp;<span class="ident" id="4654201">itemRightParen</span>&nbsp;<span class="op" id="4654216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654221">t</span><span class="op" id="4654222">.</span><span class="ident" id="4654223">errorf</span><span class="op" id="4654229">(</span><span class="string" id="4654230">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="4654267">,</span>&nbsp;<span class="ident" id="4654269">token</span><span class="op" id="4654274">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654282">return</span>&nbsp;<span class="ident" id="4654289">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654295">case</span>&nbsp;<span class="ident" id="4654300">itemString</span><span class="op" id="4654310">,</span>&nbsp;<span class="ident" id="4654312">itemRawString</span><span class="op" id="4654325">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654329">s</span><span class="op" id="4654330">,</span>&nbsp;<span class="ident" id="4654332">err</span>&nbsp;<span class="op" id="4654336">:=</span>&nbsp;<span class="ident" id="4654339">strconv</span><span class="op" id="4654346">.</span><span class="ident" id="4654347">Unquote</span><span class="op" id="4654354">(</span><span class="ident" id="4654355">token</span><span class="op" id="4654360">.</span><span class="ident" id="4654361">val</span><span class="op" id="4654364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654368">if</span>&nbsp;<span class="ident" id="4654371">err</span>&nbsp;<span class="op" id="4654375">!=</span>&nbsp;<span class="ident" id="4654378">nil</span>&nbsp;<span class="op" id="4654382">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654387">t</span><span class="op" id="4654388">.</span><span class="builtintype" id="4654389">error</span><span class="op" id="4654394">(</span><span class="ident" id="4654395">err</span><span class="op" id="4654398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654406">return</span>&nbsp;<span class="ident" id="4654413">t</span><span class="op" id="4654414">.</span><span class="ident" id="4654415">newString</span><span class="op" id="4654424">(</span><span class="ident" id="4654425">token</span><span class="op" id="4654430">.</span><span class="ident" id="4654431">pos</span><span class="op" id="4654434">,</span>&nbsp;<span class="ident" id="4654436">token</span><span class="op" id="4654441">.</span><span class="ident" id="4654442">val</span><span class="op" id="4654445">,</span>&nbsp;<span class="ident" id="4654447">s</span><span class="op" id="4654448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654454">t</span><span class="op" id="4654455">.</span><span class="ident" id="4654456">backup</span><span class="op" id="4654462">(</span><span class="op" id="4654463">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654466">return</span>&nbsp;<span class="ident" id="4654473">nil</span><br>
<span class="lineno"></span><span class="op" id="4654477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4654480">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="4654549">func</span>&nbsp;<span class="op" id="4654554">(</span><span class="ident" id="4654555">t</span>&nbsp;<span class="op" id="4654557">*</span><span class="ident" id="4654558">Tree</span><span class="op" id="4654562">)</span>&nbsp;<span class="ident" id="4654564">hasFunction</span><span class="op" id="4654575">(</span><span class="ident" id="4654576">name</span>&nbsp;<span class="builtintype" id="4654581">string</span><span class="op" id="4654587">)</span>&nbsp;<span class="builtintype" id="4654589">bool</span>&nbsp;<span class="op" id="4654594">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654597">for</span>&nbsp;<span class="ident" id="4654601">_</span><span class="op" id="4654602">,</span>&nbsp;<span class="ident" id="4654604">funcMap</span>&nbsp;<span class="op" id="4654612">:=</span>&nbsp;<span class="keyword" id="4654615">range</span>&nbsp;<span class="ident" id="4654621">t</span><span class="op" id="4654622">.</span><span class="ident" id="4654623">funcs</span>&nbsp;<span class="op" id="4654629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654633">if</span>&nbsp;<span class="ident" id="4654636">funcMap</span>&nbsp;<span class="op" id="4654644">==</span>&nbsp;<span class="ident" id="4654647">nil</span>&nbsp;<span class="op" id="4654651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654656">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654671">if</span>&nbsp;<span class="ident" id="4654674">funcMap</span><span class="op" id="4654681">[</span><span class="ident" id="4654682">name</span><span class="op" id="4654686">]</span>&nbsp;<span class="op" id="4654688">!=</span>&nbsp;<span class="ident" id="4654691">nil</span>&nbsp;<span class="op" id="4654695">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654700">return</span>&nbsp;<span class="builtintype" id="4654707">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4654717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4654720">return</span>&nbsp;<span class="builtintype" id="4654727">false</span><br>
<span class="lineno"></span><span class="op" id="4654733">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="4654736">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="4654795">func</span>&nbsp;<span class="op" id="4654800">(</span><span class="ident" id="4654801">t</span>&nbsp;<span class="op" id="4654803">*</span><span class="ident" id="4654804">Tree</span><span class="op" id="4654808">)</span>&nbsp;<span class="ident" id="4654810">popVars</span><span class="op" id="4654817">(</span><span class="ident" id="4654818">n</span>&nbsp;<span class="builtintype" id="4654820">int</span><span class="op" id="4654823">)</span>&nbsp;<span class="op" id="4654825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654828">t</span><span class="op" id="4654829">.</span><span class="ident" id="4654830">vars</span>&nbsp;<span class="op" id="4654835">=</span>&nbsp;<span class="ident" id="4654837">t</span><span class="op" id="4654838">.</span><span class="ident" id="4654839">vars</span><span class="op" id="4654843">[</span><span class="op" id="4654844">:</span><span class="ident" id="4654845">n</span><span class="op" id="4654846">]</span><br>
<span class="lineno"></span><span class="op" id="4654848">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4654851">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4654919">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="4654947">func</span>&nbsp;<span class="op" id="4654952">(</span><span class="ident" id="4654953">t</span>&nbsp;<span class="op" id="4654955">*</span><span class="ident" id="4654956">Tree</span><span class="op" id="4654960">)</span>&nbsp;<span class="ident" id="4654962">useVar</span><span class="op" id="4654968">(</span><span class="ident" id="4654969">pos</span>&nbsp;<span class="ident" id="4654973">Pos</span><span class="op" id="4654976">,</span>&nbsp;<span class="ident" id="4654978">name</span>&nbsp;<span class="builtintype" id="4654983">string</span><span class="op" id="4654989">)</span>&nbsp;<span class="ident" id="4654991">Node</span>&nbsp;<span class="op" id="4654996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4654999">v</span>&nbsp;<span class="op" id="4655001">:=</span>&nbsp;<span class="ident" id="4655004">t</span><span class="op" id="4655005">.</span><span class="ident" id="4655006">newVariable</span><span class="op" id="4655017">(</span><span class="ident" id="4655018">pos</span><span class="op" id="4655021">,</span>&nbsp;<span class="ident" id="4655023">name</span><span class="op" id="4655027">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655030">for</span>&nbsp;<span class="ident" id="4655034">_</span><span class="op" id="4655035">,</span>&nbsp;<span class="ident" id="4655037">varName</span>&nbsp;<span class="op" id="4655045">:=</span>&nbsp;<span class="keyword" id="4655048">range</span>&nbsp;<span class="ident" id="4655054">t</span><span class="op" id="4655055">.</span><span class="ident" id="4655056">vars</span>&nbsp;<span class="op" id="4655061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655065">if</span>&nbsp;<span class="ident" id="4655068">varName</span>&nbsp;<span class="op" id="4655076">==</span>&nbsp;<span class="ident" id="4655079">v</span><span class="op" id="4655080">.</span><span class="ident" id="4655081">Ident</span><span class="op" id="4655086">[</span><span class="num" id="4655087">0</span><span class="op" id="4655088">]</span>&nbsp;<span class="op" id="4655090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655095">return</span>&nbsp;<span class="ident" id="4655102">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4655106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4655109">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4655112">t</span><span class="op" id="4655113">.</span><span class="ident" id="4655114">errorf</span><span class="op" id="4655120">(</span><span class="string" id="4655121">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="4655144">,</span>&nbsp;<span class="ident" id="4655146">v</span><span class="op" id="4655147">.</span><span class="ident" id="4655148">Ident</span><span class="op" id="4655153">[</span><span class="num" id="4655154">0</span><span class="op" id="4655155">]</span><span class="op" id="4655156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4655159">return</span>&nbsp;<span class="ident" id="4655166">nil</span><br>
<span class="lineno"></span><span class="op" id="4655170">}</span>
</div>
</body>
</html>
